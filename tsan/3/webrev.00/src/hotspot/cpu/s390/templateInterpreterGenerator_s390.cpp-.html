<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/s390/templateInterpreterGenerator_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2016, 2018, SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/abstractInterpreter.hpp&quot;
  30 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;interpreter/interp_masm.hpp&quot;
  34 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  35 #include &quot;interpreter/templateTable.hpp&quot;
  36 #include &quot;oops/arrayOop.hpp&quot;
  37 #include &quot;oops/oop.inline.hpp&quot;
  38 #include &quot;prims/jvmtiExport.hpp&quot;
  39 #include &quot;prims/jvmtiThreadState.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/deoptimization.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;runtime/stubRoutines.hpp&quot;
  45 #include &quot;runtime/synchronizer.hpp&quot;
  46 #include &quot;runtime/timer.hpp&quot;
  47 #include &quot;runtime/vframeArray.hpp&quot;
  48 #include &quot;utilities/debug.hpp&quot;
  49 
  50 
  51 // Size of interpreter code.  Increase if too small.  Interpreter will
  52 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  53 // if too small.
  54 // Run with +PrintInterpreter to get the VM to print out the size.
  55 // Max size with JVMTI
  56 int TemplateInterpreter::InterpreterCodeSize = 320*K;
  57 
  58 #undef  __
  59 #ifdef PRODUCT
  60   #define __ _masm-&gt;
  61 #else
  62   #define __ _masm-&gt;
  63 //  #define __ (Verbose ? (_masm-&gt;block_comment(FILE_AND_LINE),_masm):_masm)-&gt;
  64 #endif
  65 
  66 #define BLOCK_COMMENT(str) __ block_comment(str)
  67 #define BIND(label)        __ bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  68 
  69 #define oop_tmp_offset     _z_ijava_state_neg(oop_tmp)
  70 
  71 //-----------------------------------------------------------------------------
  72 
  73 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  74   //
  75   // New slow_signature handler that respects the z/Architecture
  76   // C calling conventions.
  77   //
  78   // We get called by the native entry code with our output register
  79   // area == 8. First we call InterpreterRuntime::get_result_handler
  80   // to copy the pointer to the signature string temporarily to the
  81   // first C-argument and to return the result_handler in
  82   // Z_RET. Since native_entry will copy the jni-pointer to the
  83   // first C-argument slot later on, it&#39;s OK to occupy this slot
  84   // temporarily. Then we copy the argument list on the java
  85   // expression stack into native varargs format on the native stack
  86   // and load arguments into argument registers. Integer arguments in
  87   // the varargs vector will be sign-extended to 8 bytes.
  88   //
  89   // On entry:
  90   //   Z_ARG1  - intptr_t*       Address of java argument list in memory.
  91   //   Z_state - cppInterpreter* Address of interpreter state for
  92   //                               this method
  93   //   Z_method
  94   //
  95   // On exit (just before return instruction):
  96   //   Z_RET contains the address of the result_handler.
  97   //   Z_ARG2 is not updated for static methods and contains &quot;this&quot; otherwise.
  98   //   Z_ARG3-Z_ARG5 contain the first 3 arguments of types other than float and double.
  99   //   Z_FARG1-Z_FARG4 contain the first 4 arguments of type float or double.
 100 
 101   const int LogSizeOfCase = 3;
 102 
 103   const int max_fp_register_arguments   = Argument::n_float_register_parameters;
 104   const int max_int_register_arguments  = Argument::n_register_parameters - 2;  // First 2 are reserved.
 105 
 106   const Register arg_java       = Z_tmp_2;
 107   const Register arg_c          = Z_tmp_3;
 108   const Register signature      = Z_R1_scratch; // Is a string.
 109   const Register fpcnt          = Z_R0_scratch;
 110   const Register argcnt         = Z_tmp_4;
 111   const Register intSlot        = Z_tmp_1;
 112   const Register sig_end        = Z_tmp_1; // Assumed end of signature (only used in do_object).
 113   const Register target_sp      = Z_tmp_1;
 114   const FloatRegister floatSlot = Z_F1;
 115 
 116   const int d_signature         = _z_abi(gpr6); // Only spill space, register contents not affected.
 117   const int d_fpcnt             = _z_abi(gpr7); // Only spill space, register contents not affected.
 118 
 119   unsigned int entry_offset = __ offset();
 120 
 121   BLOCK_COMMENT(&quot;slow_signature_handler {&quot;);
 122 
 123   // We use target_sp for storing arguments in the C frame.
 124   __ save_return_pc();
 125   __ push_frame_abi160(4*BytesPerWord);                 // Reserve space to save the tmp_[1..4] registers.
 126   __ z_stmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // Save registers only after frame is pushed.
 127 
 128   __ z_lgr(arg_java, Z_ARG1);
 129 
 130   Register   method = Z_ARG2; // Directly load into correct argument register.
 131 
 132   __ get_method(method);
 133   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_signature), Z_thread, method);
 134 
 135   // Move signature to callee saved register.
 136   // Don&#39;t directly write to stack. Frame is used by VM call.
 137   __ z_lgr(Z_tmp_1, Z_RET);
 138 
 139   // Reload method. Register may have been altered by VM call.
 140   __ get_method(method);
 141 
 142   // Get address of result handler.
 143   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_result_handler), Z_thread, method);
 144 
 145   // Save signature address to stack.
 146   __ z_stg(Z_tmp_1, d_signature, Z_SP);
 147 
 148   // Don&#39;t overwrite return value (Z_RET, Z_ARG1) in rest of the method !
 149 
 150   {
 151     Label   isStatic;
 152 
 153     // Test if static.
 154     // We can test the bit directly.
 155     // Path is Z_method-&gt;_access_flags._flags.
 156     // We only support flag bits in the least significant byte (assert !).
 157     // Therefore add 3 to address that byte within &quot;_flags&quot;.
 158     // Reload method. VM call above may have destroyed register contents
 159     __ get_method(method);
 160     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 161     method = noreg;  // end of life
 162     __ z_btrue(isStatic);
 163 
 164     // For non-static functions, pass &quot;this&quot; in Z_ARG2 and copy it to 2nd C-arg slot.
 165     // Need to box the Java object here, so we use arg_java
 166     // (address of current Java stack slot) as argument and
 167     // don&#39;t dereference it as in case of ints, floats, etc..
 168     __ z_lgr(Z_ARG2, arg_java);
 169     __ add2reg(arg_java, -BytesPerWord);
 170     __ bind(isStatic);
 171   }
 172 
 173   // argcnt == 0 corresponds to 3rd C argument.
 174   //   arg #1 (result handler) and
 175   //   arg #2 (this, for non-statics), unused else
 176   // are reserved and pre-filled above.
 177   // arg_java points to the corresponding Java argument here. It
 178   // has been decremented by one argument (this) in case of non-static.
 179   __ clear_reg(argcnt, true, false);  // Don&#39;t set CC.
 180   __ z_lg(target_sp, 0, Z_SP);
 181   __ add2reg(arg_c, _z_abi(remaining_cargs), target_sp);
 182   // No floating-point args parsed so far.
 183   __ clear_mem(Address(Z_SP, d_fpcnt), 8);
 184 
 185   NearLabel   move_intSlot_to_ARG, move_floatSlot_to_FARG;
 186   NearLabel   loop_start, loop_start_restore, loop_end;
 187   NearLabel   do_int, do_long, do_float, do_double;
 188   NearLabel   do_dontreachhere, do_object, do_array, do_boxed;
 189 
 190 #ifdef ASSERT
 191   // Signature needs to point to &#39;(&#39; (== 0x28) at entry.
 192   __ z_lg(signature, d_signature, Z_SP);
 193   __ z_cli(0, signature, (int) &#39;(&#39;);
 194   __ z_brne(do_dontreachhere);
 195 #endif
 196 
 197   __ bind(loop_start_restore);
 198   __ z_lg(signature, d_signature, Z_SP);  // Restore signature ptr, destroyed by move_XX_to_ARG.
 199 
 200   BIND(loop_start);
 201   // Advance to next argument type token from the signature.
 202   __ add2reg(signature, 1);
 203 
 204   // Use CLI, works well on all CPU versions.
 205     __ z_cli(0, signature, (int) &#39;)&#39;);
 206     __ z_bre(loop_end);                // end of signature
 207     __ z_cli(0, signature, (int) &#39;L&#39;);
 208     __ z_bre(do_object);               // object     #9
 209     __ z_cli(0, signature, (int) &#39;F&#39;);
 210     __ z_bre(do_float);                // float      #7
 211     __ z_cli(0, signature, (int) &#39;J&#39;);
 212     __ z_bre(do_long);                 // long       #6
 213     __ z_cli(0, signature, (int) &#39;B&#39;);
 214     __ z_bre(do_int);                  // byte       #1
 215     __ z_cli(0, signature, (int) &#39;Z&#39;);
 216     __ z_bre(do_int);                  // boolean    #2
 217     __ z_cli(0, signature, (int) &#39;C&#39;);
 218     __ z_bre(do_int);                  // char       #3
 219     __ z_cli(0, signature, (int) &#39;S&#39;);
 220     __ z_bre(do_int);                  // short      #4
 221     __ z_cli(0, signature, (int) &#39;I&#39;);
 222     __ z_bre(do_int);                  // int        #5
 223     __ z_cli(0, signature, (int) &#39;D&#39;);
 224     __ z_bre(do_double);               // double     #8
 225     __ z_cli(0, signature, (int) &#39;[&#39;);
 226     __ z_bre(do_array);                // array      #10
 227 
 228   __ bind(do_dontreachhere);
 229 
 230   __ unimplemented(&quot;ShouldNotReachHere in slow_signature_handler&quot;, 120);
 231 
 232   // Array argument
 233   BIND(do_array);
 234 
 235   {
 236     Label   start_skip, end_skip;
 237 
 238     __ bind(start_skip);
 239 
 240     // Advance to next type tag from signature.
 241     __ add2reg(signature, 1);
 242 
 243     // Use CLI, works well on all CPU versions.
 244     __ z_cli(0, signature, (int) &#39;[&#39;);
 245     __ z_bre(start_skip);               // Skip further brackets.
 246 
 247     __ z_cli(0, signature, (int) &#39;9&#39;);
 248     __ z_brh(end_skip);                 // no optional size
 249 
 250     __ z_cli(0, signature, (int) &#39;0&#39;);
 251     __ z_brnl(start_skip);              // Skip optional size.
 252 
 253     __ bind(end_skip);
 254 
 255     __ z_cli(0, signature, (int) &#39;L&#39;);
 256     __ z_brne(do_boxed);                // If not array of objects: go directly to do_boxed.
 257   }
 258 
 259   //  OOP argument
 260   BIND(do_object);
 261   // Pass by an object&#39;s type name.
 262   {
 263     Label   L;
 264 
 265     __ add2reg(sig_end, 4095, signature);     // Assume object type name is shorter than 4k.
 266     __ load_const_optimized(Z_R0, (int) &#39;;&#39;); // Type name terminator (must be in Z_R0!).
 267     __ MacroAssembler::search_string(sig_end, signature);
 268     __ z_brl(L);
 269     __ z_illtrap();  // No semicolon found: internal error or object name too long.
 270     __ bind(L);
 271     __ z_lgr(signature, sig_end);
 272     // fallthru to do_boxed
 273   }
 274 
 275   // Need to box the Java object here, so we use arg_java
 276   // (address of current Java stack slot) as argument and
 277   // don&#39;t dereference it as in case of ints, floats, etc..
 278 
 279   // UNBOX argument
 280   // Load reference and check for NULL.
 281   Label  do_int_Entry4Boxed;
 282   __ bind(do_boxed);
 283   {
 284     __ load_and_test_long(intSlot, Address(arg_java));
 285     __ z_bre(do_int_Entry4Boxed);
 286     __ z_lgr(intSlot, arg_java);
 287     __ z_bru(do_int_Entry4Boxed);
 288   }
 289 
 290   // INT argument
 291 
 292   // (also for byte, boolean, char, short)
 293   // Use lgf for load (sign-extend) and stg for store.
 294   BIND(do_int);
 295   __ z_lgf(intSlot, 0, arg_java);
 296 
 297   __ bind(do_int_Entry4Boxed);
 298   __ add2reg(arg_java, -BytesPerWord);
 299   // If argument fits into argument register, go and handle it, otherwise continue.
 300   __ compare32_and_branch(argcnt, max_int_register_arguments,
 301                           Assembler::bcondLow, move_intSlot_to_ARG);
 302   __ z_stg(intSlot, 0, arg_c);
 303   __ add2reg(arg_c, BytesPerWord);
 304   __ z_bru(loop_start);
 305 
 306   // LONG argument
 307 
 308   BIND(do_long);
 309   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 310   __ z_lg(intSlot, BytesPerWord, arg_java);
 311   // If argument fits into argument register, go and handle it, otherwise continue.
 312   __ compare32_and_branch(argcnt, max_int_register_arguments,
 313                           Assembler::bcondLow, move_intSlot_to_ARG);
 314   __ z_stg(intSlot, 0, arg_c);
 315   __ add2reg(arg_c, BytesPerWord);
 316   __ z_bru(loop_start);
 317 
 318   // FLOAT argumen
 319 
 320   BIND(do_float);
 321   __ z_le(floatSlot, 0, arg_java);
 322   __ add2reg(arg_java, -BytesPerWord);
 323   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 324   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 325   __ z_brl(move_floatSlot_to_FARG);
 326   __ z_ste(floatSlot, 4, arg_c);
 327   __ add2reg(arg_c, BytesPerWord);
 328   __ z_bru(loop_start);
 329 
 330   // DOUBLE argument
 331 
 332   BIND(do_double);
 333   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 334   __ z_ld(floatSlot, BytesPerWord, arg_java);
 335   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 336   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 337   __ z_brl(move_floatSlot_to_FARG);
 338   __ z_std(floatSlot, 0, arg_c);
 339   __ add2reg(arg_c, BytesPerWord);
 340   __ z_bru(loop_start);
 341 
 342   // Method exit, all arguments proocessed.
 343   __ bind(loop_end);
 344   __ z_lmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // restore registers before frame is popped.
 345   __ pop_frame();
 346   __ restore_return_pc();
 347   __ z_br(Z_R14);
 348 
 349   // Copy int arguments.
 350 
 351   Label  iarg_caselist;   // Distance between each case has to be a power of 2
 352                           // (= 1 &lt;&lt; LogSizeOfCase).
 353   __ align(16);
 354   BIND(iarg_caselist);
 355   __ z_lgr(Z_ARG3, intSlot);    // 4 bytes
 356   __ z_bru(loop_start_restore); // 4 bytes
 357 
 358   __ z_lgr(Z_ARG4, intSlot);
 359   __ z_bru(loop_start_restore);
 360 
 361   __ z_lgr(Z_ARG5, intSlot);
 362   __ z_bru(loop_start_restore);
 363 
 364   __ align(16);
 365   __ bind(move_intSlot_to_ARG);
 366   __ z_stg(signature, d_signature, Z_SP);       // Spill since signature == Z_R1_scratch.
 367   __ z_larl(Z_R1_scratch, iarg_caselist);
 368   __ z_sllg(Z_R0_scratch, argcnt, LogSizeOfCase);
 369   __ add2reg(argcnt, 1);
 370   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 371   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 372 
 373   // Copy float arguments.
 374 
 375   Label  farg_caselist;   // Distance between each case has to be a power of 2
 376                           // (= 1 &lt;&lt; logSizeOfCase, padded with nop.
 377   __ align(16);
 378   BIND(farg_caselist);
 379   __ z_ldr(Z_FARG1, floatSlot); // 2 bytes
 380   __ z_bru(loop_start_restore); // 4 bytes
 381   __ z_nop();                   // 2 bytes
 382 
 383   __ z_ldr(Z_FARG2, floatSlot);
 384   __ z_bru(loop_start_restore);
 385   __ z_nop();
 386 
 387   __ z_ldr(Z_FARG3, floatSlot);
 388   __ z_bru(loop_start_restore);
 389   __ z_nop();
 390 
 391   __ z_ldr(Z_FARG4, floatSlot);
 392   __ z_bru(loop_start_restore);
 393   __ z_nop();
 394 
 395   __ align(16);
 396   __ bind(move_floatSlot_to_FARG);
 397   __ z_stg(signature, d_signature, Z_SP);        // Spill since signature == Z_R1_scratch.
 398   __ z_lg(Z_R0_scratch, d_fpcnt, Z_SP);          // Need old value for indexing.
 399   __ add2mem_64(Address(Z_SP, d_fpcnt), 1, Z_R1_scratch); // Increment index.
 400   __ z_larl(Z_R1_scratch, farg_caselist);
 401   __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogSizeOfCase);
 402   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 403   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 404 
 405   BLOCK_COMMENT(&quot;} slow_signature_handler&quot;);
 406 
 407   return __ addr_at(entry_offset);
 408 }
 409 
 410 address TemplateInterpreterGenerator::generate_result_handler_for (BasicType type) {
 411   address entry = __ pc();
 412 
 413   assert(Z_tos == Z_RET, &quot;Result handler: must move result!&quot;);
 414   assert(Z_ftos == Z_FRET, &quot;Result handler: must move float result!&quot;);
 415 
 416   switch (type) {
 417     case T_BOOLEAN:
 418       __ c2bool(Z_tos);
 419       break;
 420     case T_CHAR:
 421       __ and_imm(Z_tos, 0xffff);
 422       break;
 423     case T_BYTE:
 424       __ z_lbr(Z_tos, Z_tos);
 425       break;
 426     case T_SHORT:
 427       __ z_lhr(Z_tos, Z_tos);
 428       break;
 429     case T_INT:
 430     case T_LONG:
 431     case T_VOID:
 432     case T_FLOAT:
 433     case T_DOUBLE:
 434       break;
 435     case T_OBJECT:
 436       // Retrieve result from frame...
 437       __ mem2reg_opt(Z_tos, Address(Z_fp, oop_tmp_offset));
 438       // and verify it.
 439       __ verify_oop(Z_tos);
 440       break;
 441     default:
 442       ShouldNotReachHere();
 443   }
 444   __ z_br(Z_R14);      // Return from result handler.
 445   return entry;
 446 }
 447 
 448 // Abstract method entry.
 449 // Attempt to execute abstract method. Throw exception.
 450 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 451   unsigned int entry_offset = __ offset();
 452 
 453   // Caller could be the call_stub or a compiled method (x86 version is wrong!).
 454 
 455   BLOCK_COMMENT(&quot;abstract_entry {&quot;);
 456 
 457   // Implement call of InterpreterRuntime::throw_AbstractMethodError.
 458   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1);
 459   __ save_return_pc();       // Save Z_R14.
 460   __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
 461 
 462   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 463                   Z_thread, Z_method);
 464 
 465   __ pop_frame();
 466   __ restore_return_pc();    // Restore Z_R14.
 467   __ reset_last_Java_frame();
 468 
 469   // Restore caller sp for c2i case.
 470   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 471 
 472   // branch to SharedRuntime::generate_forward_exception() which handles all possible callers,
 473   // i.e. call stub, compiled method, interpreted method.
 474   __ load_absolute_address(Z_tmp_1, StubRoutines::forward_exception_entry());
 475   __ z_br(Z_tmp_1);
 476 
 477   BLOCK_COMMENT(&quot;} abstract_entry&quot;);
 478 
 479   return __ addr_at(entry_offset);
 480 }
 481 
 482 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 483   // Inputs:
 484   //  Z_ARG1 - receiver
 485   //
 486   // What we do:
 487   //  - Load the referent field address.
 488   //  - Load the value in the referent field.
 489   //  - Pass that value to the pre-barrier.
 490   //
 491   // In the case of G1 this will record the value of the
 492   // referent in an SATB buffer if marking is active.
 493   // This will cause concurrent marking to mark the referent
 494   // field as live.
 495 
 496   Register  scratch1 = Z_tmp_2;
 497   Register  scratch2 = Z_tmp_3;
 498   Register  pre_val  = Z_RET;   // return value
 499   // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
 500   Register  Rargp    = Z_esp;
 501 
 502   Label     slow_path;
 503   address   entry = __ pc();
 504 
 505   const int referent_offset = java_lang_ref_Reference::referent_offset;
 506   guarantee(referent_offset &gt; 0, &quot;referent offset not initialized&quot;);
 507 
 508   BLOCK_COMMENT(&quot;Reference_get {&quot;);
 509 
 510   //  If the receiver is null then it is OK to jump to the slow path.
 511   __ load_and_test_long(pre_val, Address(Rargp, Interpreter::stackElementSize)); // Get receiver.
 512   __ z_bre(slow_path);
 513 
 514   //  Load the value of the referent field.
 515   __ load_heap_oop(pre_val, Address(pre_val, referent_offset), scratch1, scratch2, ON_WEAK_OOP_REF);
 516 
 517   // Restore caller sp for c2i case.
 518   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 519   __ z_br(Z_R14);
 520 
 521   // Branch to previously generated regular method entry.
 522   __ bind(slow_path);
 523 
 524   address meth_entry = Interpreter::entry_for_kind(Interpreter::zerolocals);
 525   __ jump_to_entry(meth_entry, Z_R1);
 526 
 527   BLOCK_COMMENT(&quot;} Reference_get&quot;);
 528 
 529   return entry;
 530 }
 531 
 532 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 533   address entry = __ pc();
 534 
 535   DEBUG_ONLY(__ verify_esp(Z_esp, Z_ARG5));
 536 
 537   // Restore bcp under the assumption that the current frame is still
 538   // interpreted.
 539   __ restore_bcp();
 540 
 541   // Expression stack must be empty before entering the VM if an
 542   // exception happened.
 543   __ empty_expression_stack();
 544   // Throw exception.
 545   __ call_VM(noreg,
 546              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_StackOverflowError));
 547   return entry;
 548 }
 549 
 550 //
 551 // Args:
 552 //   Z_ARG2: oop of array
 553 //   Z_ARG3: aberrant index
 554 //
 555 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 556   address entry = __ pc();
 557   address excp = CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException);
 558 
 559   // Expression stack must be empty before entering the VM if an
 560   // exception happened.
 561   __ empty_expression_stack();
 562 
 563   // Setup parameters.
 564   // Pass register with array to create more detailed exceptions.
 565   __ call_VM(noreg, excp, Z_ARG2, Z_ARG3);
 566   return entry;
 567 }
 568 
 569 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 570   address entry = __ pc();
 571 
 572   // Object is at TOS.
 573   __ pop_ptr(Z_ARG2);
 574 
 575   // Expression stack must be empty before entering the VM if an
 576   // exception happened.
 577   __ empty_expression_stack();
 578 
 579   __ call_VM(Z_ARG1,
 580              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException),
 581              Z_ARG2);
 582 
 583   DEBUG_ONLY(__ should_not_reach_here();)
 584 
 585   return entry;
 586 }
 587 
 588 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 589   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 590   address entry = __ pc();
 591 
 592   BLOCK_COMMENT(&quot;exception_handler_common {&quot;);
 593 
 594   // Expression stack must be empty before entering the VM if an
 595   // exception happened.
 596   __ empty_expression_stack();
 597   if (name != NULL) {
 598     __ load_absolute_address(Z_ARG2, (address)name);
 599   } else {
 600     __ clear_reg(Z_ARG2, true, false);
 601   }
 602 
 603   if (pass_oop) {
 604     __ call_VM(Z_tos,
 605                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception),
 606                Z_ARG2, Z_tos /*object (see TT::aastore())*/);
 607   } else {
 608     if (message != NULL) {
 609       __ load_absolute_address(Z_ARG3, (address)message);
 610     } else {
 611       __ clear_reg(Z_ARG3, true, false);
 612     }
 613     __ call_VM(Z_tos,
 614                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 615                Z_ARG2, Z_ARG3);
 616   }
 617   // Throw exception.
 618   __ load_absolute_address(Z_R1_scratch, Interpreter::throw_exception_entry());
 619   __ z_br(Z_R1_scratch);
 620 
 621   BLOCK_COMMENT(&quot;} exception_handler_common&quot;);
 622 
 623   return entry;
 624 }
 625 
 626 address TemplateInterpreterGenerator::generate_return_entry_for (TosState state, int step, size_t index_size) {
 627   address entry = __ pc();
 628 
 629   BLOCK_COMMENT(&quot;return_entry {&quot;);
 630 
 631   // Pop i2c extension or revert top-2-parent-resize done by interpreted callees.
 632   Register sp_before_i2c_extension = Z_bcp;
 633   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 634   __ z_lg(sp_before_i2c_extension, Address(Z_fp, _z_ijava_state_neg(top_frame_sp)));
 635   __ resize_frame_absolute(sp_before_i2c_extension, Z_locals/*tmp*/, true/*load_fp*/);
 636 
 637   // TODO(ZASM): necessary??
 638   //  // and NULL it as marker that esp is now tos until next java call
 639   //  __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 640 
 641   __ restore_bcp();
 642   __ restore_locals();
 643   __ restore_esp();
 644 
 645   if (state == atos) {
 646     __ profile_return_type(Z_tmp_1, Z_tos, Z_tmp_2);
 647   }
 648 
 649   Register cache  = Z_tmp_1;
 650   Register size   = Z_tmp_1;
 651   Register offset = Z_tmp_2;
 652   const int flags_offset = in_bytes(ConstantPoolCache::base_offset() +
 653                                     ConstantPoolCacheEntry::flags_offset());
 654   __ get_cache_and_index_at_bcp(cache, offset, 1, index_size);
 655 
 656   // #args is in rightmost byte of the _flags field.
 657   __ z_llgc(size, Address(cache, offset, flags_offset+(sizeof(size_t)-1)));
 658   __ z_sllg(size, size, Interpreter::logStackElementSize); // Each argument size in bytes.
 659   __ z_agr(Z_esp, size);                                   // Pop arguments.
 660 
 661   __ check_and_handle_popframe(Z_thread);
 662   __ check_and_handle_earlyret(Z_thread);
 663 
 664   __ dispatch_next(state, step);
 665 
 666   BLOCK_COMMENT(&quot;} return_entry&quot;);
 667 
 668   return entry;
 669 }
 670 
 671 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state,
 672                                                                int step,
 673                                                                address continuation) {
 674   address entry = __ pc();
 675 
 676   BLOCK_COMMENT(&quot;deopt_entry {&quot;);
 677 
 678   // TODO(ZASM): necessary? NULL last_sp until next java call
 679   // __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 680   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 681   __ restore_bcp();
 682   __ restore_locals();
 683   __ restore_esp();
 684 
 685   // Handle exceptions.
 686   {
 687     Label L;
 688     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
 689     __ z_bre(L);
 690     __ call_VM(noreg,
 691                CAST_FROM_FN_PTR(address,
 692                                 InterpreterRuntime::throw_pending_exception));
 693     __ should_not_reach_here();
 694     __ bind(L);
 695   }
 696   if (continuation == NULL) {
 697     __ dispatch_next(state, step);
 698   } else {
 699     __ jump_to_entry(continuation, Z_R1_scratch);
 700   }
 701 
 702   BLOCK_COMMENT(&quot;} deopt_entry&quot;);
 703 
 704   return entry;
 705 }
 706 
 707 address TemplateInterpreterGenerator::generate_safept_entry_for (TosState state,
 708                                                                 address runtime_entry) {
 709   address entry = __ pc();
 710   __ push(state);
 711   __ call_VM(noreg, runtime_entry);
 712   __ dispatch_via(vtos, Interpreter::_normal_table.table_for (vtos));
 713   return entry;
 714 }
 715 
 716 //
 717 // Helpers for commoning out cases in the various type of method entries.
 718 //
 719 
 720 // Increment invocation count &amp; check for overflow.
 721 //
 722 // Note: checking for negative value instead of overflow
 723 // so we have a &#39;sticky&#39; overflow test.
 724 //
 725 // Z_ARG2: method (see generate_fixed_frame())
 726 //
 727 void TemplateInterpreterGenerator::generate_counter_incr(Label* overflow, Label* profile_method, Label* profile_method_continue) {
 728   Label done;
 729   Register method = Z_ARG2; // Generate_fixed_frame() copies Z_method into Z_ARG2.
 730   Register m_counters = Z_ARG4;
 731 
 732   BLOCK_COMMENT(&quot;counter_incr {&quot;);
 733 
 734   // Note: In tiered we increment either counters in method or in MDO depending
 735   // if we are profiling or not.
 736   if (TieredCompilation) {
 737     int increment = InvocationCounter::count_increment;
 738     if (ProfileInterpreter) {
 739       NearLabel no_mdo;
 740       Register mdo = m_counters;
 741       // Are we profiling?
 742       __ load_and_test_long(mdo, method2_(method, method_data));
 743       __ branch_optimized(Assembler::bcondZero, no_mdo);
 744       // Increment counter in the MDO.
 745       const Address mdo_invocation_counter(mdo, MethodData::invocation_counter_offset() +
 746                                            InvocationCounter::counter_offset());
 747       const Address mask(mdo, MethodData::invoke_mask_offset());
 748       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask,
 749                                  Z_R1_scratch, false, Assembler::bcondZero,
 750                                  overflow);
 751       __ z_bru(done);
 752       __ bind(no_mdo);
 753     }
 754 
 755     // Increment counter in MethodCounters.
 756     const Address invocation_counter(m_counters,
 757                                      MethodCounters::invocation_counter_offset() +
 758                                      InvocationCounter::counter_offset());
 759     // Get address of MethodCounters object.
 760     __ get_method_counters(method, m_counters, done);
 761     const Address mask(m_counters, MethodCounters::invoke_mask_offset());
 762     __ increment_mask_and_jump(invocation_counter,
 763                                increment, mask,
 764                                Z_R1_scratch, false, Assembler::bcondZero,
 765                                overflow);
 766   } else {
 767     Register counter_sum = Z_ARG3; // The result of this piece of code.
 768     Register tmp         = Z_R1_scratch;
 769 #ifdef ASSERT
 770     {
 771       NearLabel ok;
 772       __ get_method(tmp);
 773       __ compare64_and_branch(method, tmp, Assembler::bcondEqual, ok);
 774       __ z_illtrap(0x66);
 775       __ bind(ok);
 776     }
 777 #endif
 778 
 779     // Get address of MethodCounters object.
 780     __ get_method_counters(method, m_counters, done);
 781     // Update standard invocation counters.
 782     __ increment_invocation_counter(m_counters, counter_sum);
 783     if (ProfileInterpreter) {
 784       __ add2mem_32(Address(m_counters, MethodCounters::interpreter_invocation_counter_offset()), 1, tmp);
 785       if (profile_method != NULL) {
 786         const Address profile_limit(m_counters, MethodCounters::interpreter_profile_limit_offset());
 787         __ z_cl(counter_sum, profile_limit);
 788         __ branch_optimized(Assembler::bcondLow, *profile_method_continue);
 789         // If no method data exists, go to profile_method.
 790         __ test_method_data_pointer(tmp, *profile_method);
 791       }
 792     }
 793 
 794     const Address invocation_limit(m_counters, MethodCounters::interpreter_invocation_limit_offset());
 795     __ z_cl(counter_sum, invocation_limit);
 796     __ branch_optimized(Assembler::bcondNotLow, *overflow);
 797   }
 798 
 799   __ bind(done);
 800 
 801   BLOCK_COMMENT(&quot;} counter_incr&quot;);
 802 }
 803 
 804 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 805   // InterpreterRuntime::frequency_counter_overflow takes two
 806   // arguments, the first (thread) is passed by call_VM, the second
 807   // indicates if the counter overflow occurs at a backwards branch
 808   // (NULL bcp). We pass zero for it. The call returns the address
 809   // of the verified entry point for the method or NULL if the
 810   // compilation did not complete (either went background or bailed
 811   // out).
 812   __ clear_reg(Z_ARG2);
 813   __ call_VM(noreg,
 814              CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow),
 815              Z_ARG2);
 816   __ z_bru(do_continue);
 817 }
 818 
 819 void TemplateInterpreterGenerator::generate_stack_overflow_check(Register frame_size, Register tmp1) {
 820   Register tmp2 = Z_R1_scratch;
 821   const int page_size = os::vm_page_size();
 822   NearLabel after_frame_check;
 823 
 824   BLOCK_COMMENT(&quot;counter_overflow {&quot;);
 825 
 826   assert_different_registers(frame_size, tmp1);
 827 
 828   // Stack banging is sufficient overflow check if frame_size &lt; page_size.
 829   if (Immediate::is_uimm(page_size, 15)) {
 830     __ z_chi(frame_size, page_size);
 831     __ z_brl(after_frame_check);
 832   } else {
 833     __ load_const_optimized(tmp1, page_size);
 834     __ compareU32_and_branch(frame_size, tmp1, Assembler::bcondLow, after_frame_check);
 835   }
 836 
 837   // Get the stack base, and in debug, verify it is non-zero.
 838   __ z_lg(tmp1, thread_(stack_base));
 839 #ifdef ASSERT
 840   address reentry = NULL;
 841   NearLabel base_not_zero;
 842   __ compareU64_and_branch(tmp1, (intptr_t)0L, Assembler::bcondNotEqual, base_not_zero);
 843   reentry = __ stop_chain_static(reentry, &quot;stack base is zero in generate_stack_overflow_check&quot;);
 844   __ bind(base_not_zero);
 845 #endif
 846 
 847   // Get the stack size, and in debug, verify it is non-zero.
 848   assert(sizeof(size_t) == sizeof(intptr_t), &quot;wrong load size&quot;);
 849   __ z_lg(tmp2, thread_(stack_size));
 850 #ifdef ASSERT
 851   NearLabel size_not_zero;
 852   __ compareU64_and_branch(tmp2, (intptr_t)0L, Assembler::bcondNotEqual, size_not_zero);
 853   reentry = __ stop_chain_static(reentry, &quot;stack size is zero in generate_stack_overflow_check&quot;);
 854   __ bind(size_not_zero);
 855 #endif
 856 
 857   // Compute the beginning of the protected zone minus the requested frame size.
 858   __ z_sgr(tmp1, tmp2);
 859   __ add2reg(tmp1, JavaThread::stack_guard_zone_size());
 860 
 861   // Add in the size of the frame (which is the same as subtracting it from the
 862   // SP, which would take another register.
 863   __ z_agr(tmp1, frame_size);
 864 
 865   // The frame is greater than one page in size, so check against
 866   // the bottom of the stack.
 867   __ compareU64_and_branch(Z_SP, tmp1, Assembler::bcondHigh, after_frame_check);
 868 
 869   // The stack will overflow, throw an exception.
 870 
 871   // Restore SP to sender&#39;s sp. This is necessary if the sender&#39;s frame is an
 872   // extended compiled frame (see gen_c2i_adapter()) and safer anyway in case of
 873   // JSR292 adaptations.
 874   __ resize_frame_absolute(Z_R10, tmp1, true/*load_fp*/);
 875 
 876   // Note also that the restored frame is not necessarily interpreted.
 877   // Use the shared runtime version of the StackOverflowError.
 878   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 879   AddressLiteral stub(StubRoutines::throw_StackOverflowError_entry());
 880   __ load_absolute_address(tmp1, StubRoutines::throw_StackOverflowError_entry());
 881   __ z_br(tmp1);
 882 
 883   // If you get to here, then there is enough stack space.
 884   __ bind(after_frame_check);
 885 
 886   BLOCK_COMMENT(&quot;} counter_overflow&quot;);
 887 }
 888 
 889 // Allocate monitor and lock method (asm interpreter).
 890 //
 891 // Args:
 892 //   Z_locals: locals
 893 
 894 void TemplateInterpreterGenerator::lock_method(void) {
 895 
 896   BLOCK_COMMENT(&quot;lock_method {&quot;);
 897 
 898   // Synchronize method.
 899   const Register method = Z_tmp_2;
 900   __ get_method(method);
 901 
 902 #ifdef ASSERT
 903   address reentry = NULL;
 904   {
 905     Label L;
 906     __ testbit(method2_(method, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
 907     __ z_btrue(L);
 908     reentry = __ stop_chain_static(reentry, &quot;method doesn&#39;t need synchronization&quot;);
 909     __ bind(L);
 910   }
 911 #endif // ASSERT
 912 
 913   // Get synchronization object.
 914   const Register object = Z_tmp_2;
 915 
 916   {
 917     Label     done;
 918     Label     static_method;
 919 
 920     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 921     __ z_btrue(static_method);
 922 
 923     // non-static method: Load receiver obj from stack.
 924     __ mem2reg_opt(object, Address(Z_locals, Interpreter::local_offset_in_bytes(0)));
 925     __ z_bru(done);
 926 
 927     __ bind(static_method);
 928 
 929     // Lock the java mirror.
 930     __ load_mirror(object, method);
 931 #ifdef ASSERT
 932     {
 933       NearLabel L;
 934       __ compare64_and_branch(object, (intptr_t) 0, Assembler::bcondNotEqual, L);
 935       reentry = __ stop_chain_static(reentry, &quot;synchronization object is NULL&quot;);
 936       __ bind(L);
 937     }
 938 #endif // ASSERT
 939 
 940     __ bind(done);
 941   }
 942 
 943   __ add_monitor_to_stack(true, Z_ARG3, Z_ARG4, Z_ARG5); // Allocate monitor elem.
 944   // Store object and lock it.
 945   __ get_monitors(Z_tmp_1);
 946   __ reg2mem_opt(object, Address(Z_tmp_1, BasicObjectLock::obj_offset_in_bytes()));
 947   __ lock_object(Z_tmp_1, object);
 948 
 949   BLOCK_COMMENT(&quot;} lock_method&quot;);
 950 }
 951 
 952 // Generate a fixed interpreter frame. This is identical setup for
 953 // interpreted methods and for native methods hence the shared code.
 954 //
 955 // Registers alive
 956 //   Z_thread   - JavaThread*
 957 //   Z_SP       - old stack pointer
 958 //   Z_method   - callee&#39;s method
 959 //   Z_esp      - parameter list (slot &#39;above&#39; last param)
 960 //   Z_R14      - return pc, to be stored in caller&#39;s frame
 961 //   Z_R10      - sender sp, note: Z_tmp_1 is Z_R10!
 962 //
 963 // Registers updated
 964 //   Z_SP       - new stack pointer
 965 //   Z_esp      - callee&#39;s operand stack pointer
 966 //                points to the slot above the value on top
 967 //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
 968 //   Z_bcp      - the bytecode pointer
 969 //   Z_fp       - the frame pointer, thereby killing Z_method
 970 //   Z_ARG2     - copy of Z_method
 971 //
 972 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 973 
 974   //  stack layout
 975   //
 976   //   F1 [TOP_IJAVA_FRAME_ABI]              &lt;-- Z_SP, Z_R10 (see note below)
 977   //      [F1&#39;s operand stack (unused)]
 978   //      [F1&#39;s outgoing Java arguments]     &lt;-- Z_esp
 979   //      [F1&#39;s operand stack (non args)]
 980   //      [monitors]      (optional)
 981   //      [IJAVA_STATE]
 982   //
 983   //   F2 [PARENT_IJAVA_FRAME_ABI]
 984   //      ...
 985   //
 986   //  0x000
 987   //
 988   // Note: Z_R10, the sender sp, will be below Z_SP if F1 was extended by a c2i adapter.
 989 
 990   //=============================================================================
 991   // Allocate space for locals other than the parameters, the
 992   // interpreter state, monitors, and the expression stack.
 993 
 994   const Register local_count     = Z_ARG5;
 995   const Register fp              = Z_tmp_2;
 996 
 997   BLOCK_COMMENT(&quot;generate_fixed_frame {&quot;);
 998 
 999   {
1000   // local registers
1001   const Register top_frame_size  = Z_ARG2;
1002   const Register sp_after_resize = Z_ARG3;
1003   const Register max_stack       = Z_ARG4;
1004 
1005   // local_count = method-&gt;constMethod-&gt;max_locals();
1006   __ z_lg(Z_R1_scratch, Address(Z_method, Method::const_offset()));
1007   __ z_llgh(local_count, Address(Z_R1_scratch, ConstMethod::size_of_locals_offset()));
1008 
1009   if (native_call) {
1010     // If we&#39;re calling a native method, we replace max_stack (which is
1011     // zero) with space for the worst-case signature handler varargs
1012     // vector, which is:
1013     //   max_stack = max(Argument::n_register_parameters, parameter_count+2);
1014     //
1015     // We add two slots to the parameter_count, one for the jni
1016     // environment and one for a possible native mirror. We allocate
1017     // space for at least the number of ABI registers, even though
1018     // InterpreterRuntime::slow_signature_handler won&#39;t write more than
1019     // parameter_count+2 words when it creates the varargs vector at the
1020     // top of the stack. The generated slow signature handler will just
1021     // load trash into registers beyond the necessary number. We&#39;re
1022     // still going to cut the stack back by the ABI register parameter
1023     // count so as to get SP+16 pointing at the ABI outgoing parameter
1024     // area, so we need to allocate at least that much even though we&#39;re
1025     // going to throw it away.
1026     //
1027 
1028     __ z_lg(Z_R1_scratch, Address(Z_method, Method::const_offset()));
1029     __ z_llgh(max_stack,  Address(Z_R1_scratch, ConstMethod::size_of_parameters_offset()));
1030     __ add2reg(max_stack, 2);
1031 
1032     NearLabel passing_args_on_stack;
1033 
1034     // max_stack in bytes
1035     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1036 
1037     int argument_registers_in_bytes = Argument::n_register_parameters &lt;&lt; LogBytesPerWord;
1038     __ compare64_and_branch(max_stack, argument_registers_in_bytes, Assembler::bcondNotLow, passing_args_on_stack);
1039 
1040     __ load_const_optimized(max_stack, argument_registers_in_bytes);
1041 
1042     __ bind(passing_args_on_stack);
1043   } else {
1044     // !native_call
1045     __ z_lg(max_stack, method_(const));
1046 
1047     // Calculate number of non-parameter locals (in slots):
1048     __ z_lg(Z_R1_scratch, Address(Z_method, Method::const_offset()));
1049     __ z_sh(local_count, Address(Z_R1_scratch, ConstMethod::size_of_parameters_offset()));
1050 
1051     // max_stack = method-&gt;max_stack();
1052     __ z_llgh(max_stack, Address(max_stack, ConstMethod::max_stack_offset()));
1053     // max_stack in bytes
1054     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1055   }
1056 
1057   // Resize (i.e. normally shrink) the top frame F1 ...
1058   //   F1      [TOP_IJAVA_FRAME_ABI]          &lt;-- Z_SP, Z_R10
1059   //           F1&#39;s operand stack (free)
1060   //           ...
1061   //           F1&#39;s operand stack (free)      &lt;-- Z_esp
1062   //           F1&#39;s outgoing Java arg m
1063   //           ...
1064   //           F1&#39;s outgoing Java arg 0
1065   //           ...
1066   //
1067   //  ... into a parent frame (Z_R10 holds F1&#39;s SP before any modification, see also above)
1068   //
1069   //           +......................+
1070   //           :                      :        &lt;-- Z_R10, saved below as F0&#39;s z_ijava_state.sender_sp
1071   //           :                      :
1072   //   F1      [PARENT_IJAVA_FRAME_ABI]        &lt;-- Z_SP       \
1073   //           F0&#39;s non arg local                             | = delta
1074   //           ...                                            |
1075   //           F0&#39;s non arg local              &lt;-- Z_esp      /
1076   //           F1&#39;s outgoing Java arg m
1077   //           ...
1078   //           F1&#39;s outgoing Java arg 0
1079   //           ...
1080   //
1081   // then push the new top frame F0.
1082   //
1083   //   F0      [TOP_IJAVA_FRAME_ABI]    = frame::z_top_ijava_frame_abi_size \
1084   //           [operand stack]          = max_stack                          | = top_frame_size
1085   //           [IJAVA_STATE]            = frame::z_ijava_state_size         /
1086 
1087   // sp_after_resize = Z_esp - delta
1088   //
1089   // delta = PARENT_IJAVA_FRAME_ABI + (locals_count - params_count)
1090 
1091   __ add2reg(sp_after_resize, (Interpreter::stackElementSize) - (frame::z_parent_ijava_frame_abi_size), Z_esp);
1092   __ z_sllg(Z_R0_scratch, local_count, LogBytesPerWord); // Params have already been subtracted from local_count.
1093   __ z_slgr(sp_after_resize, Z_R0_scratch);
1094 
1095   // top_frame_size = TOP_IJAVA_FRAME_ABI + max_stack + size of interpreter state
1096   __ add2reg(top_frame_size,
1097              frame::z_top_ijava_frame_abi_size +
1098              frame::z_ijava_state_size +
1099              frame::interpreter_frame_monitor_size() * wordSize,
1100              max_stack);
1101 
1102   if (!native_call) {
1103     // Stack overflow check.
1104     // Native calls don&#39;t need the stack size check since they have no
1105     // expression stack and the arguments are already on the stack and
1106     // we only add a handful of words to the stack.
1107     Register frame_size = max_stack; // Reuse the regiser for max_stack.
1108     __ z_lgr(frame_size, Z_SP);
1109     __ z_sgr(frame_size, sp_after_resize);
1110     __ z_agr(frame_size, top_frame_size);
1111     generate_stack_overflow_check(frame_size, fp/*tmp1*/);
1112   }
1113 
1114   DEBUG_ONLY(__ z_cg(Z_R14, _z_abi16(return_pc), Z_SP));
1115   __ asm_assert_eq(&quot;killed Z_R14&quot;, 0);
1116   __ resize_frame_absolute(sp_after_resize, fp, true);
1117   __ save_return_pc(Z_R14);
1118 
1119   // ... and push the new frame F0.
1120   __ push_frame(top_frame_size, fp, true /*copy_sp*/, false);
1121   }
1122 
1123   //=============================================================================
1124   // Initialize the new frame F0: initialize interpreter state.
1125 
1126   {
1127   // locals
1128   const Register local_addr = Z_ARG4;
1129 
1130   BLOCK_COMMENT(&quot;generate_fixed_frame: initialize interpreter state {&quot;);
1131 
1132 #ifdef ASSERT
1133   // Set the magic number (using local_addr as tmp register).
1134   __ load_const_optimized(local_addr, frame::z_istate_magic_number);
1135   __ z_stg(local_addr, _z_ijava_state_neg(magic), fp);
1136 #endif
1137 
1138   // Save sender SP from F1 (i.e. before it was potentially modified by an
1139   // adapter) into F0&#39;s interpreter state. We us it as well to revert
1140   // resizing the frame above.
1141   __ z_stg(Z_R10, _z_ijava_state_neg(sender_sp), fp);
1142 
1143   // Load cp cache and save it at the and of this block.
1144   __ z_lg(Z_R1_scratch, Address(Z_method,    Method::const_offset()));
1145   __ z_lg(Z_R1_scratch, Address(Z_R1_scratch, ConstMethod::constants_offset()));
1146   __ z_lg(Z_R1_scratch, Address(Z_R1_scratch, ConstantPool::cache_offset_in_bytes()));
1147 
1148   // z_ijava_state-&gt;method = method;
1149   __ z_stg(Z_method, _z_ijava_state_neg(method), fp);
1150 
1151   // Point locals at the first argument. Method&#39;s locals are the
1152   // parameters on top of caller&#39;s expression stack.
1153   // Tos points past last Java argument.
1154 
1155   __ z_lg(Z_locals, Address(Z_method, Method::const_offset()));
1156   __ z_llgh(Z_locals /*parameter_count words*/,
1157             Address(Z_locals, ConstMethod::size_of_parameters_offset()));
1158   __ z_sllg(Z_locals /*parameter_count bytes*/, Z_locals /*parameter_count*/, LogBytesPerWord);
1159   __ z_agr(Z_locals, Z_esp);
1160   // z_ijava_state-&gt;locals - i*BytesPerWord points to i-th Java local (i starts at 0)
1161   // z_ijava_state-&gt;locals = Z_esp + parameter_count bytes
1162   __ z_stg(Z_locals, _z_ijava_state_neg(locals), fp);
1163 
1164   // z_ijava_state-&gt;oop_temp = NULL;
1165   __ store_const(Address(fp, oop_tmp_offset), 0);
1166 
1167   // Initialize z_ijava_state-&gt;mdx.
1168   Register Rmdp = Z_bcp;
1169   // native_call: assert that mdo == NULL
1170   const bool check_for_mdo = !native_call DEBUG_ONLY(|| native_call);
1171   if (ProfileInterpreter &amp;&amp; check_for_mdo) {
1172     Label get_continue;
1173 
1174     __ load_and_test_long(Rmdp, method_(method_data));
1175     __ z_brz(get_continue);
1176     DEBUG_ONLY(if (native_call) __ stop(&quot;native methods don&#39;t have a mdo&quot;));
1177     __ add2reg(Rmdp, in_bytes(MethodData::data_offset()));
1178     __ bind(get_continue);
1179   }
1180   __ z_stg(Rmdp, _z_ijava_state_neg(mdx), fp);
1181 
1182   // Initialize z_ijava_state-&gt;bcp and Z_bcp.
1183   if (native_call) {
1184     __ clear_reg(Z_bcp); // Must initialize. Will get written into frame where GC reads it.
1185   } else {
1186     __ z_lg(Z_bcp, method_(const));
1187     __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset()));
1188   }
1189   __ z_stg(Z_bcp, _z_ijava_state_neg(bcp), fp);
1190 
1191   // no monitors and empty operand stack
1192   // =&gt; z_ijava_state-&gt;monitors points to the top slot in IJAVA_STATE.
1193   // =&gt; Z_ijava_state-&gt;esp points one slot above into the operand stack.
1194   // z_ijava_state-&gt;monitors = fp - frame::z_ijava_state_size - Interpreter::stackElementSize;
1195   // z_ijava_state-&gt;esp = Z_esp = z_ijava_state-&gt;monitors;
1196   __ add2reg(Z_esp, -frame::z_ijava_state_size, fp);
1197   __ z_stg(Z_esp, _z_ijava_state_neg(monitors), fp);
1198   __ add2reg(Z_esp, -Interpreter::stackElementSize);
1199   __ z_stg(Z_esp, _z_ijava_state_neg(esp), fp);
1200 
1201   // z_ijava_state-&gt;cpoolCache = Z_R1_scratch (see load above);
1202   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(cpoolCache), fp);
1203 
1204   // Get mirror and store it in the frame as GC root for this Method*.
1205   __ load_mirror(Z_R1_scratch, Z_method);
1206   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(mirror), fp);
1207 
1208   BLOCK_COMMENT(&quot;} generate_fixed_frame: initialize interpreter state&quot;);
1209 
1210   //=============================================================================
1211   if (!native_call) {
1212     // Fill locals with 0x0s.
1213     NearLabel locals_zeroed;
1214     NearLabel doXC;
1215 
1216     // Local_count is already num_locals_slots - num_param_slots.
1217     __ compare64_and_branch(local_count, (intptr_t)0L, Assembler::bcondNotHigh, locals_zeroed);
1218 
1219     // Advance local_addr to point behind locals (creates positive incr. in loop).
1220     __ z_lg(Z_R1_scratch, Address(Z_method, Method::const_offset()));
1221     __ z_llgh(Z_R0_scratch, Address(Z_R1_scratch, ConstMethod::size_of_locals_offset()));
1222     __ add2reg(Z_R0_scratch, -1);
1223 
1224     __ z_lgr(local_addr/*locals*/, Z_locals);
1225     __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogBytesPerWord);
1226     __ z_sllg(local_count, local_count, LogBytesPerWord); // Local_count are non param locals.
1227     __ z_sgr(local_addr, Z_R0_scratch);
1228 
1229     if (VM_Version::has_Prefetch()) {
1230       __ z_pfd(0x02, 0, Z_R0, local_addr);
1231       __ z_pfd(0x02, 256, Z_R0, local_addr);
1232     }
1233 
1234     // Can&#39;t optimise for Z10 using &quot;compare and branch&quot; (immediate value is too big).
1235     __ z_cghi(local_count, 256);
1236     __ z_brnh(doXC);
1237 
1238     // MVCLE: Initialize if quite a lot locals.
1239     //  __ bind(doMVCLE);
1240     __ z_lgr(Z_R0_scratch, local_addr);
1241     __ z_lgr(Z_R1_scratch, local_count);
1242     __ clear_reg(Z_ARG2);        // Src len of MVCLE is zero.
1243 
1244     __ MacroAssembler::move_long_ext(Z_R0_scratch, Z_ARG1, 0);
1245     __ z_bru(locals_zeroed);
1246 
1247     Label  XC_template;
1248     __ bind(XC_template);
1249     __ z_xc(0, 0, local_addr, 0, local_addr);
1250 
1251     __ bind(doXC);
1252     __ z_bctgr(local_count, Z_R0);                  // Get #bytes-1 for EXECUTE.
1253     if (VM_Version::has_ExecuteExtensions()) {
1254       __ z_exrl(local_count, XC_template);          // Execute XC with variable length.
1255     } else {
1256       __ z_larl(Z_R1_scratch, XC_template);
1257       __ z_ex(local_count, 0, Z_R0, Z_R1_scratch);  // Execute XC with variable length.
1258     }
1259 
1260     __ bind(locals_zeroed);
1261   }
1262 
1263   }
1264   // Finally set the frame pointer, destroying Z_method.
1265   assert(Z_fp == Z_method, &quot;maybe set Z_fp earlier if other register than Z_method&quot;);
1266   // Oprofile analysis suggests to keep a copy in a register to be used by
1267   // generate_counter_incr().
1268   __ z_lgr(Z_ARG2, Z_method);
1269   __ z_lgr(Z_fp, fp);
1270 
1271   BLOCK_COMMENT(&quot;} generate_fixed_frame&quot;);
1272 }
1273 
1274 // Various method entries
1275 
1276 // Math function, frame manager must set up an interpreter state, etc.
1277 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1278 
1279   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1280   bool use_instruction = false;
1281   address runtime_entry = NULL;
1282   int num_args = 1;
1283   bool double_precision = true;
1284 
1285   // s390 specific:
1286   switch (kind) {
1287     case Interpreter::java_lang_math_sqrt:
1288     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
1289     case Interpreter::java_lang_math_fmaF:
1290     case Interpreter::java_lang_math_fmaD: use_instruction = UseFMA; break;
1291     default: break; // Fall back to runtime call.
1292   }
1293 
1294   switch (kind) {
1295     case Interpreter::java_lang_math_sin  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);   break;
1296     case Interpreter::java_lang_math_cos  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);   break;
1297     case Interpreter::java_lang_math_tan  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);   break;
1298     case Interpreter::java_lang_math_abs  : /* run interpreted */ break;
1299     case Interpreter::java_lang_math_sqrt : /* runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsqrt); not available */ break;
1300     case Interpreter::java_lang_math_log  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);   break;
1301     case Interpreter::java_lang_math_log10: runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10); break;
1302     case Interpreter::java_lang_math_pow  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dpow); num_args = 2; break;
1303     case Interpreter::java_lang_math_exp  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);   break;
1304     case Interpreter::java_lang_math_fmaF : /* run interpreted */ num_args = 3; double_precision = false; break;
1305     case Interpreter::java_lang_math_fmaD : /* run interpreted */ num_args = 3; break;
1306     default: ShouldNotReachHere();
1307   }
1308 
1309   // Use normal entry if neither instruction nor runtime call is used.
1310   if (!use_instruction &amp;&amp; runtime_entry == NULL) return NULL;
1311 
1312   address entry = __ pc();
1313 
1314   if (use_instruction) {
1315     switch (kind) {
1316       case Interpreter::java_lang_math_sqrt:
1317         // Can use memory operand directly.
1318         __ z_sqdb(Z_FRET, Interpreter::stackElementSize, Z_esp);
1319         break;
1320       case Interpreter::java_lang_math_abs:
1321         // Load operand from stack.
1322         __ mem2freg_opt(Z_FRET, Address(Z_esp, Interpreter::stackElementSize));
1323         __ z_lpdbr(Z_FRET);
1324         break;
1325       case Interpreter::java_lang_math_fmaF:
1326         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1327         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize)); // arg1
1328         __ z_maeb(Z_FRET, Z_FARG2, Address(Z_esp, 2 * Interpreter::stackElementSize));
1329         break;
1330       case Interpreter::java_lang_math_fmaD:
1331         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1332         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 5 * Interpreter::stackElementSize)); // arg1
1333         __ z_madb(Z_FRET, Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize));
1334         break;
1335       default: ShouldNotReachHere();
1336     }
1337   } else {
1338     // Load arguments
1339     assert(num_args &lt;= 4, &quot;passed in registers&quot;);
1340     if (double_precision) {
1341       int offset = (2 * num_args - 1) * Interpreter::stackElementSize;
1342       for (int i = 0; i &lt; num_args; ++i) {
1343         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1344         offset -= 2 * Interpreter::stackElementSize;
1345       }
1346     } else {
1347       int offset = num_args * Interpreter::stackElementSize;
1348       for (int i = 0; i &lt; num_args; ++i) {
1349         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1350         offset -= Interpreter::stackElementSize;
1351       }
1352     }
1353     // Call runtime
1354     __ save_return_pc();       // Save Z_R14.
1355     __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
1356 
1357     __ call_VM_leaf(runtime_entry);
1358 
1359     __ pop_frame();
1360     __ restore_return_pc();    // Restore Z_R14.
1361   }
1362 
1363   // Pop c2i arguments (if any) off when we return.
1364   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1365 
1366   __ z_br(Z_R14);
1367 
1368   return entry;
1369 }
1370 
1371 // Interpreter stub for calling a native method. (asm interpreter).
1372 // This sets up a somewhat different looking stack for calling the
1373 // native method than the typical interpreter frame setup.
1374 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1375   // Determine code generation flags.
1376   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1377 
1378   // Interpreter entry for ordinary Java methods.
1379   //
1380   // Registers alive
1381   //   Z_SP          - stack pointer
1382   //   Z_thread      - JavaThread*
1383   //   Z_method      - callee&#39;s method (method to be invoked)
1384   //   Z_esp         - operand (or expression) stack pointer of caller. one slot above last arg.
1385   //   Z_R10         - sender sp (before modifications, e.g. by c2i adapter
1386   //                   and as well by generate_fixed_frame below)
1387   //   Z_R14         - return address to caller (call_stub or c2i_adapter)
1388   //
1389   // Registers updated
1390   //   Z_SP          - stack pointer
1391   //   Z_fp          - callee&#39;s framepointer
1392   //   Z_esp         - callee&#39;s operand stack pointer
1393   //                   points to the slot above the value on top
1394   //   Z_locals      - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1395   //   Z_tos         - integer result, if any
1396   //   z_ftos        - floating point result, if any
1397   //
1398   // Stack layout at this point:
1399   //
1400   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1401   //                                                          frame was extended by c2i adapter)
1402   //           [outgoing Java arguments]     &lt;-- Z_esp
1403   //           ...
1404   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1405   //           ...
1406   //
1407 
1408   address entry_point = __ pc();
1409 
1410   // Make sure registers are different!
1411   assert_different_registers(Z_thread, Z_method, Z_esp);
1412 
1413   BLOCK_COMMENT(&quot;native_entry {&quot;);
1414 
1415   // Make sure method is native and not abstract.
1416 #ifdef ASSERT
1417   address reentry = NULL;
1418   { Label L;
1419     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1420     __ z_btrue(L);
1421     reentry = __ stop_chain_static(reentry, &quot;tried to execute non-native method as native&quot;);
1422     __ bind(L);
1423   }
1424   { Label L;
1425     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1426     __ z_bfalse(L);
1427     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1428     __ bind(L);
1429   }
1430 #endif // ASSERT
1431 
1432 #ifdef ASSERT
1433   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1434   __ save_return_pc(Z_R14);
1435 #endif
1436 
1437   // Generate the code to allocate the interpreter stack frame.
1438   generate_fixed_frame(true);
1439 
1440   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1441   // Since at this point in the method invocation the exception handler
1442   // would try to exit the monitor of synchronized methods which hasn&#39;t
1443   // been entered yet, we set the thread local variable
1444   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1445   // runtime, exception handling i.e. unlock_if_synchronized_method will
1446   // check this thread local flag.
1447   __ z_mvi(do_not_unlock_if_synchronized, true);
1448 
1449   // Increment invocation count and check for overflow.
1450   NearLabel invocation_counter_overflow;
1451   if (inc_counter) {
1452     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1453   }
1454 
1455   Label continue_after_compile;
1456   __ bind(continue_after_compile);
1457 
1458   bang_stack_shadow_pages(true);
1459 
1460   // Reset the _do_not_unlock_if_synchronized flag.
1461   __ z_mvi(do_not_unlock_if_synchronized, false);
1462 
1463   // Check for synchronized methods.
1464   // This mst happen AFTER invocation_counter check and stack overflow check,
1465   // so method is not locked if overflows.
1466   if (synchronized) {
1467     lock_method();
1468   } else {
1469     // No synchronization necessary.
1470 #ifdef ASSERT
1471     { Label L;
1472       __ get_method(Z_R1_scratch);
1473       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1474       __ z_bfalse(L);
1475       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1476       __ bind(L);
1477     }
1478 #endif // ASSERT
1479   }
1480 
1481   // start execution
1482 
1483   // jvmti support
1484   __ notify_method_entry();
1485 
1486   //=============================================================================
1487   // Get and call the signature handler.
1488   const Register Rmethod                 = Z_tmp_2;
1489   const Register signature_handler_entry = Z_tmp_1;
1490   const Register Rresult_handler         = Z_tmp_3;
1491   Label call_signature_handler;
1492 
1493   assert_different_registers(Z_fp, Rmethod, signature_handler_entry, Rresult_handler);
1494   assert(Rresult_handler-&gt;is_nonvolatile(), &quot;Rresult_handler must be in a non-volatile register&quot;);
1495 
1496   // Reload method.
1497   __ get_method(Rmethod);
1498 
1499   // Check for signature handler.
1500   __ load_and_test_long(signature_handler_entry, method2_(Rmethod, signature_handler));
1501   __ z_brne(call_signature_handler);
1502 
1503   // Method has never been called. Either generate a specialized
1504   // handler or point to the slow one.
1505   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::prepare_native_call),
1506              Rmethod);
1507 
1508   // Reload method.
1509   __ get_method(Rmethod);
1510 
1511   // Reload signature handler, it must have been created/assigned in the meantime.
1512   __ z_lg(signature_handler_entry, method2_(Rmethod, signature_handler));
1513 
1514   __ bind(call_signature_handler);
1515 
1516   // We have a TOP_IJAVA_FRAME here, which belongs to us.
1517   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1/*tmp*/);
1518 
1519   // Call signature handler and pass locals address in Z_ARG1.
1520   __ z_lgr(Z_ARG1, Z_locals);
1521   __ call_stub(signature_handler_entry);
1522   // Save result handler returned by signature handler.
1523   __ z_lgr(Rresult_handler, Z_RET);
1524 
1525   // Reload method (the slow signature handler may block for GC).
1526   __ get_method(Rmethod);
1527 
1528   // Pass mirror handle if static call.
1529   {
1530     Label method_is_not_static;
1531     __ testbit(method2_(Rmethod, access_flags), JVM_ACC_STATIC_BIT);
1532     __ z_bfalse(method_is_not_static);
1533     // Get mirror.
1534     __ load_mirror(Z_R1, Rmethod);
1535     // z_ijava_state.oop_temp = pool_holder-&gt;klass_part()-&gt;java_mirror();
1536     __ z_stg(Z_R1, oop_tmp_offset, Z_fp);
1537     // Pass handle to mirror as 2nd argument to JNI method.
1538     __ add2reg(Z_ARG2, oop_tmp_offset, Z_fp);
1539     __ bind(method_is_not_static);
1540   }
1541 
1542   // Pass JNIEnv address as first parameter.
1543   __ add2reg(Z_ARG1, in_bytes(JavaThread::jni_environment_offset()), Z_thread);
1544 
1545   // Note: last java frame has been set above already. The pc from there
1546   // is precise enough.
1547 
1548   // Get native function entry point before we change the thread state.
1549   __ z_lg(Z_R1/*native_method_entry*/, method2_(Rmethod, native_function));
1550 
1551   //=============================================================================
1552   // Transition from _thread_in_Java to _thread_in_native. As soon as
1553   // we make this change the safepoint code needs to be certain that
1554   // the last Java frame we established is good. The pc in that frame
1555   // just need to be near here not an actual return address.
1556 #ifdef ASSERT
1557   {
1558     NearLabel L;
1559     __ mem2reg_opt(Z_R14, Address(Z_thread, JavaThread::thread_state_offset()), false /*32 bits*/);
1560     __ compareU32_and_branch(Z_R14, _thread_in_Java, Assembler::bcondEqual, L);
1561     reentry = __ stop_chain_static(reentry, &quot;Wrong thread state in native stub&quot;);
1562     __ bind(L);
1563   }
1564 #endif
1565 
1566   // Memory ordering: Z does not reorder store/load with subsequent load. That&#39;s strong enough.
1567   __ set_thread_state(_thread_in_native);
1568 
1569   //=============================================================================
1570   // Call the native method. Argument registers must not have been
1571   // overwritten since &quot;__ call_stub(signature_handler);&quot; (except for
1572   // ARG1 and ARG2 for static methods).
1573 
1574   __ call_c(Z_R1/*native_method_entry*/);
1575 
1576   // NOTE: frame::interpreter_frame_result() depends on these stores.
1577   __ z_stg(Z_RET, _z_ijava_state_neg(lresult), Z_fp);
1578   __ freg2mem_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1579   const Register Rlresult = signature_handler_entry;
1580   assert(Rlresult-&gt;is_nonvolatile(), &quot;Rlresult must be in a non-volatile register&quot;);
1581   __ z_lgr(Rlresult, Z_RET);
1582 
1583   // Z_method may no longer be valid, because of GC.
1584 
1585   // Block, if necessary, before resuming in _thread_in_Java state.
1586   // In order for GC to work, don&#39;t clear the last_Java_sp until after
1587   // blocking.
1588 
1589   //=============================================================================
1590   // Switch thread to &quot;native transition&quot; state before reading the
1591   // synchronization state. This additional state is necessary
1592   // because reading and testing the synchronization state is not
1593   // atomic w.r.t. GC, as this scenario demonstrates: Java thread A,
1594   // in _thread_in_native state, loads _not_synchronized and is
1595   // preempted. VM thread changes sync state to synchronizing and
1596   // suspends threads for GC. Thread A is resumed to finish this
1597   // native method, but doesn&#39;t block here since it didn&#39;t see any
1598   // synchronization is progress, and escapes.
1599 
1600   __ set_thread_state(_thread_in_native_trans);
1601   __ z_fence();
1602 
1603   // Now before we return to java we must look for a current safepoint
1604   // (a new safepoint can not start since we entered native_trans).
1605   // We must check here because a current safepoint could be modifying
1606   // the callers registers right this moment.
1607 
1608   // Check for safepoint operation in progress and/or pending suspend requests.
1609   {
1610     Label Continue, do_safepoint;
1611     __ safepoint_poll(do_safepoint, Z_R1);
1612     // Check for suspend.
1613     __ load_and_test_int(Z_R0/*suspend_flags*/, thread_(suspend_flags));
1614     __ z_bre(Continue); // 0 -&gt; no flag set -&gt; not suspended
1615     __ bind(do_safepoint);
1616     __ z_lgr(Z_ARG1, Z_thread);
1617     __ call_c(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans));
1618     __ bind(Continue);
1619   }
1620 
1621   //=============================================================================
1622   // Back in Interpreter Frame.
1623 
1624   // We are in thread_in_native_trans here and back in the normal
1625   // interpreter frame. We don&#39;t have to do anything special about
1626   // safepoints and we can switch to Java mode anytime we are ready.
1627 
1628   // Note: frame::interpreter_frame_result has a dependency on how the
1629   // method result is saved across the call to post_method_exit. For
1630   // native methods it assumes that the non-FPU/non-void result is
1631   // saved in z_ijava_state.lresult and a FPU result in z_ijava_state.fresult. If
1632   // this changes then the interpreter_frame_result implementation
1633   // will need to be updated too.
1634 
1635   //=============================================================================
1636   // Back in Java.
1637 
1638   // Memory ordering: Z does not reorder store/load with subsequent
1639   // load. That&#39;s strong enough.
1640   __ set_thread_state(_thread_in_Java);
1641 
1642   __ reset_last_Java_frame();
1643 
1644   // We reset the JNI handle block only after unboxing the result; see below.
1645 
1646   // The method register is junk from after the thread_in_native transition
1647   // until here. Also can&#39;t call_VM until the bcp has been
1648   // restored. Need bcp for throwing exception below so get it now.
1649   __ get_method(Rmethod);
1650 
1651   // Restore Z_bcp to have legal interpreter frame,
1652   // i.e., bci == 0 &lt;=&gt; Z_bcp == code_base().
1653   __ z_lg(Z_bcp, Address(Rmethod, Method::const_offset())); // get constMethod
1654   __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset())); // get codebase
1655 
1656   if (CheckJNICalls) {
1657     // clear_pending_jni_exception_check
1658     __ clear_mem(Address(Z_thread, JavaThread::pending_jni_exception_check_fn_offset()), sizeof(oop));
1659   }
1660 
1661   // Check if the native method returns an oop, and if so, move it
1662   // from the jni handle to z_ijava_state.oop_temp. This is
1663   // necessary, because we reset the jni handle block below.
1664   // NOTE: frame::interpreter_frame_result() depends on this, too.
1665   { NearLabel no_oop_result;
1666   __ load_absolute_address(Z_R1, AbstractInterpreter::result_handler(T_OBJECT));
1667   __ compareU64_and_branch(Z_R1, Rresult_handler, Assembler::bcondNotEqual, no_oop_result);
1668   __ resolve_jobject(Rlresult, /* tmp1 */ Rmethod, /* tmp2 */ Z_R1);
1669   __ z_stg(Rlresult, oop_tmp_offset, Z_fp);
1670   __ bind(no_oop_result);
1671   }
1672 
1673   // Reset handle block.
1674   __ z_lg(Z_R1/*active_handles*/, thread_(active_handles));
1675   __ clear_mem(Address(Z_R1, JNIHandleBlock::top_offset_in_bytes()), 4);
1676 
1677   // Handle exceptions (exception handling will handle unlocking!).
1678   {
1679     Label L;
1680     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
1681     __ z_bre(L);
1682     __ MacroAssembler::call_VM(noreg,
1683                                CAST_FROM_FN_PTR(address,
1684                                InterpreterRuntime::throw_pending_exception));
1685     __ should_not_reach_here();
1686     __ bind(L);
1687   }
1688 
1689   if (synchronized) {
1690     Register Rfirst_monitor = Z_ARG2;
1691     __ add2reg(Rfirst_monitor, -(frame::z_ijava_state_size + (int)sizeof(BasicObjectLock)), Z_fp);
1692 #ifdef ASSERT
1693     NearLabel ok;
1694     __ z_lg(Z_R1, _z_ijava_state_neg(monitors), Z_fp);
1695     __ compareU64_and_branch(Rfirst_monitor, Z_R1, Assembler::bcondEqual, ok);
1696     reentry = __ stop_chain_static(reentry, &quot;native_entry:unlock: inconsistent z_ijava_state.monitors&quot;);
1697     __ bind(ok);
1698 #endif
1699     __ unlock_object(Rfirst_monitor);
1700   }
1701 
1702   // JVMTI support. Result has already been saved above to the frame.
1703   __ notify_method_exit(true/*native_method*/, ilgl, InterpreterMacroAssembler::NotifyJVMTI);
1704 
1705   // Move native method result back into proper registers and return.
1706   __ mem2freg_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1707   __ mem2reg_opt(Z_RET, Address(Z_fp, _z_ijava_state_neg(lresult)));
1708   __ call_stub(Rresult_handler);
1709 
1710   // Pop the native method&#39;s interpreter frame.
1711   __ pop_interpreter_frame(Z_R14 /*return_pc*/, Z_ARG2/*tmp1*/, Z_ARG3/*tmp2*/);
1712 
1713   // Return to caller.
1714   __ z_br(Z_R14);
1715 
1716   if (inc_counter) {
1717     // Handle overflow of counter and compile method.
1718     __ bind(invocation_counter_overflow);
1719     generate_counter_overflow(continue_after_compile);
1720   }
1721 
1722   BLOCK_COMMENT(&quot;} native_entry&quot;);
1723 
1724   return entry_point;
1725 }
1726 
1727 //
1728 // Generic interpreted method entry to template interpreter.
1729 //
1730 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1731   address entry_point = __ pc();
1732 
1733   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1734 
1735   // Interpreter entry for ordinary Java methods.
1736   //
1737   // Registers alive
1738   //   Z_SP       - stack pointer
1739   //   Z_thread   - JavaThread*
1740   //   Z_method   - callee&#39;s method (method to be invoked)
1741   //   Z_esp      - operand (or expression) stack pointer of caller. one slot above last arg.
1742   //   Z_R10      - sender sp (before modifications, e.g. by c2i adapter
1743   //                           and as well by generate_fixed_frame below)
1744   //   Z_R14      - return address to caller (call_stub or c2i_adapter)
1745   //
1746   // Registers updated
1747   //   Z_SP       - stack pointer
1748   //   Z_fp       - callee&#39;s framepointer
1749   //   Z_esp      - callee&#39;s operand stack pointer
1750   //                points to the slot above the value on top
1751   //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1752   //   Z_tos      - integer result, if any
1753   //   z_ftos     - floating point result, if any
1754   //
1755   //
1756   // stack layout at this point:
1757   //
1758   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1759   //                                                          frame was extended by c2i adapter)
1760   //           [outgoing Java arguments]     &lt;-- Z_esp
1761   //           ...
1762   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1763   //           ...
1764   //
1765   // stack layout before dispatching the first bytecode:
1766   //
1767   //   F0      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP
1768   //           [operand stack]               &lt;-- Z_esp
1769   //           monitor (optional, can grow)
1770   //           [IJAVA_STATE]
1771   //   F1      [PARENT_IJAVA_FRAME_ABI]      &lt;-- Z_fp (== *Z_SP)
1772   //           [F0&#39;s locals]                 &lt;-- Z_locals
1773   //           [F1&#39;s operand stack]
1774   //           [F1&#39;s monitors] (optional)
1775   //           [IJAVA_STATE]
1776 
1777   // Make sure registers are different!
1778   assert_different_registers(Z_thread, Z_method, Z_esp);
1779 
1780   BLOCK_COMMENT(&quot;normal_entry {&quot;);
1781 
1782   // Make sure method is not native and not abstract.
1783   // Rethink these assertions - they can be simplified and shared.
1784 #ifdef ASSERT
1785   address reentry = NULL;
1786   { Label L;
1787     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1788     __ z_bfalse(L);
1789     reentry = __ stop_chain_static(reentry, &quot;tried to execute native method as non-native&quot;);
1790     __ bind(L);
1791   }
1792   { Label L;
1793     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1794     __ z_bfalse(L);
1795     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1796     __ bind(L);
1797   }
1798 #endif // ASSERT
1799 
1800 #ifdef ASSERT
1801   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1802   __ save_return_pc(Z_R14);
1803 #endif
1804 
1805   // Generate the code to allocate the interpreter stack frame.
1806   generate_fixed_frame(false);
1807 
1808   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1809   // Since at this point in the method invocation the exception handler
1810   // would try to exit the monitor of synchronized methods which hasn&#39;t
1811   // been entered yet, we set the thread local variable
1812   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1813   // runtime, exception handling i.e. unlock_if_synchronized_method will
1814   // check this thread local flag.
1815   __ z_mvi(do_not_unlock_if_synchronized, true);
1816 
1817   __ profile_parameters_type(Z_tmp_2, Z_ARG3, Z_ARG4);
1818 
1819   // Increment invocation counter and check for overflow.
1820   //
1821   // Note: checking for negative value instead of overflow so we have a &#39;sticky&#39;
1822   // overflow test (may be of importance as soon as we have true MT/MP).
1823   NearLabel invocation_counter_overflow;
1824   NearLabel profile_method;
1825   NearLabel profile_method_continue;
1826   NearLabel Lcontinue;
1827   if (inc_counter) {
1828     generate_counter_incr(&amp;invocation_counter_overflow, &amp;profile_method, &amp;profile_method_continue);
1829     if (ProfileInterpreter) {
1830       __ bind(profile_method_continue);
1831     }
1832   }
1833   __ bind(Lcontinue);
1834 
1835   bang_stack_shadow_pages(false);
1836 
1837   // Reset the _do_not_unlock_if_synchronized flag.
1838   __ z_mvi(do_not_unlock_if_synchronized, false);
1839 
1840   // Check for synchronized methods.
1841   // Must happen AFTER invocation_counter check and stack overflow check,
1842   // so method is not locked if overflows.
1843   if (synchronized) {
1844     // Allocate monitor and lock method.
1845     lock_method();
1846   } else {
1847 #ifdef ASSERT
1848     { Label L;
1849       __ get_method(Z_R1_scratch);
1850       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1851       __ z_bfalse(L);
1852       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1853       __ bind(L);
1854     }
1855 #endif // ASSERT
1856   }
1857 
1858   // start execution
1859 
1860 #ifdef ASSERT
1861   __ verify_esp(Z_esp, Z_R1_scratch);
1862 
1863   __ verify_thread();
1864 #endif
1865 
1866   // jvmti support
1867   __ notify_method_entry();
1868 
1869   // Start executing instructions.
1870   __ dispatch_next(vtos);
1871   // Dispatch_next does not return.
1872   DEBUG_ONLY(__ should_not_reach_here());
1873 
1874   // Invocation counter overflow.
1875   if (inc_counter) {
1876     if (ProfileInterpreter) {
1877       // We have decided to profile this method in the interpreter.
1878       __ bind(profile_method);
1879 
1880       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1881       __ set_method_data_pointer_for_bcp();
1882       __ z_bru(profile_method_continue);
1883     }
1884 
1885     // Handle invocation counter overflow.
1886     __ bind(invocation_counter_overflow);
1887     generate_counter_overflow(Lcontinue);
1888   }
1889 
1890   BLOCK_COMMENT(&quot;} normal_entry&quot;);
1891 
1892   return entry_point;
1893 }
1894 
1895 
1896 /**
1897  * Method entry for static native methods:
1898  *   int java.util.zip.CRC32.update(int crc, int b)
1899  */
1900 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
1901 
1902   if (UseCRC32Intrinsics) {
1903     uint64_t entry_off = __ offset();
1904     Label    slow_path;
1905 
1906     // If we need a safepoint check, generate full interpreter entry.
1907     __ safepoint_poll(slow_path, Z_R1);
1908 
1909     BLOCK_COMMENT(&quot;CRC32_update {&quot;);
1910 
1911     // We don&#39;t generate local frame and don&#39;t align stack because
1912     // we not even call stub code (we generate the code inline)
1913     // and there is no safepoint on this path.
1914 
1915     // Load java parameters.
1916     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1917     const Register argP    = Z_esp;
1918     const Register crc     = Z_ARG1;  // crc value
1919     const Register data    = Z_ARG2;  // address of java byte value (kernel_crc32 needs address)
1920     const Register dataLen = Z_ARG3;  // source data len (1 byte). Not used because calling the single-byte emitter.
1921     const Register table   = Z_ARG4;  // address of crc32 table
1922 
1923     // Arguments are reversed on java expression stack.
1924     __ z_la(data, 3+1*wordSize, argP);  // byte value (stack address).
1925                                         // Being passed as an int, the single byte is at offset +3.
1926     __ z_llgf(crc, 2 * wordSize, argP); // Current crc state, zero extend to 64 bit to have a clean register.
1927 
1928     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
1929     __ kernel_crc32_singleByte(crc, data, dataLen, table, Z_R1, true);
1930 
1931     // Restore caller sp for c2i case.
1932     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1933 
1934     __ z_br(Z_R14);
1935 
1936     BLOCK_COMMENT(&quot;} CRC32_update&quot;);
1937 
1938     // Use a previously generated vanilla native entry as the slow path.
1939     BIND(slow_path);
1940     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
1941     return __ addr_at(entry_off);
1942   }
1943 
1944   return NULL;
1945 }
1946 
1947 
1948 /**
1949  * Method entry for static native methods:
1950  *   int java.util.zip.CRC32.updateBytes(     int crc, byte[] b,  int off, int len)
1951  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long* buf, int off, int len)
1952  */
1953 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1954 
1955   if (UseCRC32Intrinsics) {
1956     uint64_t entry_off = __ offset();
1957     Label    slow_path;
1958 
1959     // If we need a safepoint check, generate full interpreter entry.
1960     __ safepoint_poll(slow_path, Z_R1);
1961 
1962     // We don&#39;t generate local frame and don&#39;t align stack because
1963     // we call stub code and there is no safepoint on this path.
1964 
1965     // Load parameters.
1966     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1967     const Register argP    = Z_esp;
1968     const Register crc     = Z_ARG1;  // crc value
1969     const Register data    = Z_ARG2;  // address of java byte array
1970     const Register dataLen = Z_ARG3;  // source data len
1971     const Register table   = Z_ARG4;  // address of crc32 table
1972     const Register t0      = Z_R10;   // work reg for kernel* emitters
1973     const Register t1      = Z_R11;   // work reg for kernel* emitters
1974     const Register t2      = Z_R12;   // work reg for kernel* emitters
1975     const Register t3      = Z_R13;   // work reg for kernel* emitters
1976 
1977     // Arguments are reversed on java expression stack.
1978     // Calculate address of start element.
1979     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
1980       // crc     @ (SP + 5W) (32bit)
1981       // buf     @ (SP + 3W) (64bit ptr to long array)
1982       // off     @ (SP + 2W) (32bit)
1983       // dataLen @ (SP + 1W) (32bit)
1984       // data = buf + off
1985       BLOCK_COMMENT(&quot;CRC32_updateByteBuffer {&quot;);
1986       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
1987       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1988       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
1989       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
1990     } else {                                                         // Used for &quot;updateBytes update&quot;.
1991       // crc     @ (SP + 4W) (32bit)
1992       // buf     @ (SP + 3W) (64bit ptr to byte array)
1993       // off     @ (SP + 2W) (32bit)
1994       // dataLen @ (SP + 1W) (32bit)
1995       // data = buf + off + base_offset
1996       BLOCK_COMMENT(&quot;CRC32_updateBytes {&quot;);
1997       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
1998       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1999       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2000       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
2001       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
2002     }
2003 
2004     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
2005 
2006     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
2007     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
2008     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, true);
2009     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
2010 
2011     // Restore caller sp for c2i case.
2012     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
2013 
2014     __ z_br(Z_R14);
2015 
2016     BLOCK_COMMENT(&quot;} CRC32_update{Bytes|ByteBuffer}&quot;);
2017 
2018     // Use a previously generated vanilla native entry as the slow path.
2019     BIND(slow_path);
2020     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
2021     return __ addr_at(entry_off);
2022   }
2023 
2024   return NULL;
2025 }
2026 
2027 
2028 /**
2029  * Method entry for intrinsic-candidate (non-native) methods:
2030  *   int java.util.zip.CRC32C.updateBytes(           int crc, byte[] b,  int off, int end)
2031  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long* buf, int off, int end)
2032  * Unlike CRC32, CRC32C does not have any methods marked as native
2033  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
2034  */
2035 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
2036 
2037   if (UseCRC32CIntrinsics) {
2038     uint64_t entry_off = __ offset();
2039 
2040     // We don&#39;t generate local frame and don&#39;t align stack because
2041     // we call stub code and there is no safepoint on this path.
2042 
2043     // Load parameters.
2044     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
2045     const Register argP    = Z_esp;
2046     const Register crc     = Z_ARG1;  // crc value
2047     const Register data    = Z_ARG2;  // address of java byte array
2048     const Register dataLen = Z_ARG3;  // source data len
2049     const Register table   = Z_ARG4;  // address of crc32 table
2050     const Register t0      = Z_R10;   // work reg for kernel* emitters
2051     const Register t1      = Z_R11;   // work reg for kernel* emitters
2052     const Register t2      = Z_R12;   // work reg for kernel* emitters
2053     const Register t3      = Z_R13;   // work reg for kernel* emitters
2054 
2055     // Arguments are reversed on java expression stack.
2056     // Calculate address of start element.
2057     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
2058       // crc     @ (SP + 5W) (32bit)
2059       // buf     @ (SP + 3W) (64bit ptr to long array)
2060       // off     @ (SP + 2W) (32bit)
2061       // dataLen @ (SP + 1W) (32bit)
2062       // data = buf + off
2063       BLOCK_COMMENT(&quot;CRC32C_updateDirectByteBuffer {&quot;);
2064       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
2065       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2066       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2067       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2068       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2069     } else {                                                                // Used for &quot;updateBytes update&quot;.
2070       // crc     @ (SP + 4W) (32bit)
2071       // buf     @ (SP + 3W) (64bit ptr to byte array)
2072       // off     @ (SP + 2W) (32bit)
2073       // dataLen @ (SP + 1W) (32bit)
2074       // data = buf + off + base_offset
2075       BLOCK_COMMENT(&quot;CRC32C_updateBytes {&quot;);
2076       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
2077       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2078       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2079       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2080       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2081       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
2082     }
2083 
2084     StubRoutines::zarch::generate_load_crc32c_table_addr(_masm, table);
2085 
2086     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
2087     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
2088     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, false);
2089     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
2090 
2091     // Restore caller sp for c2i case.
2092     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
2093 
2094     __ z_br(Z_R14);
2095 
2096     BLOCK_COMMENT(&quot;} CRC32C_update{Bytes|DirectByteBuffer}&quot;);
2097     return __ addr_at(entry_off);
2098   }
2099 
2100   return NULL;
2101 }
2102 
2103 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
2104   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
2105   // Note that we do the banging after the frame is setup, since the exception
2106   // handling code expects to find a valid interpreter frame on the stack.
2107   // Doing the banging earlier fails if the caller frame is not an interpreter
2108   // frame.
2109   // (Also, the exception throwing code expects to unlock any synchronized
2110   // method receiver, so do the banging after locking the receiver.)
2111 
2112   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
2113   // an interpreter frame with greater than a page of locals, so each page
2114   // needs to be checked. Only true for non-native. For native, we only bang the last page.
2115   if (UseStackBanging) {
2116     const int page_size      = os::vm_page_size();
2117     const int n_shadow_pages = (int)(JavaThread::stack_shadow_zone_size()/page_size);
2118     const int start_page_num = native_call ? n_shadow_pages : 1;
2119     for (int pages = start_page_num; pages &lt;= n_shadow_pages; pages++) {
2120       __ bang_stack_with_offset(pages*page_size);
2121     }
2122   }
2123 }
2124 
2125 //-----------------------------------------------------------------------------
2126 // Exceptions
2127 
2128 void TemplateInterpreterGenerator::generate_throw_exception() {
2129 
2130   BLOCK_COMMENT(&quot;throw_exception {&quot;);
2131 
2132   // Entry point in previous activation (i.e., if the caller was interpreted).
2133   Interpreter::_rethrow_exception_entry = __ pc();
2134   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Frame accessors use Z_fp.
2135   // Z_ARG1 (==Z_tos): exception
2136   // Z_ARG2          : Return address/pc that threw exception.
2137   __ restore_bcp();    // R13 points to call/send.
2138   __ restore_locals();
2139 
2140   // Fallthrough, no need to restore Z_esp.
2141 
2142   // Entry point for exceptions thrown within interpreter code.
2143   Interpreter::_throw_exception_entry = __ pc();
2144   // Expression stack is undefined here.
2145   // Z_ARG1 (==Z_tos): exception
2146   // Z_bcp: exception bcp
2147   __ verify_oop(Z_ARG1);
2148   __ z_lgr(Z_ARG2, Z_ARG1);
2149 
2150   // Expression stack must be empty before entering the VM in case of
2151   // an exception.
2152   __ empty_expression_stack();
2153   // Find exception handler address and preserve exception oop.
2154   const Register Rpreserved_exc_oop = Z_tmp_1;
2155   __ call_VM(Rpreserved_exc_oop,
2156              CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception),
2157              Z_ARG2);
2158   // Z_RET: exception handler entry point
2159   // Z_bcp: bcp for exception handler
2160   __ push_ptr(Rpreserved_exc_oop); // Push exception which is now the only value on the stack.
2161   __ z_br(Z_RET); // Jump to exception handler (may be _remove_activation_entry!).
2162 
2163   // If the exception is not handled in the current frame the frame is
2164   // removed and the exception is rethrown (i.e. exception
2165   // continuation is _rethrow_exception).
2166   //
2167   // Note: At this point the bci is still the bci for the instruction
2168   // which caused the exception and the expression stack is
2169   // empty. Thus, for any VM calls at this point, GC will find a legal
2170   // oop map (with empty expression stack).
2171 
2172   //
2173   // JVMTI PopFrame support
2174   //
2175 
2176   Interpreter::_remove_activation_preserving_args_entry = __ pc();
2177   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2178   __ empty_expression_stack();
2179   // Set the popframe_processing bit in pending_popframe_condition
2180   // indicating that we are currently handling popframe, so that
2181   // call_VMs that may happen later do not trigger new popframe
2182   // handling cycles.
2183   __ load_sized_value(Z_tmp_1, Address(Z_thread, JavaThread::popframe_condition_offset()), 4, false /*signed*/);
2184   __ z_oill(Z_tmp_1, JavaThread::popframe_processing_bit);
2185   __ z_sty(Z_tmp_1, thread_(popframe_condition));
2186 
2187   {
2188     // Check to see whether we are returning to a deoptimized frame.
2189     // (The PopFrame call ensures that the caller of the popped frame is
2190     // either interpreted or compiled and deoptimizes it if compiled.)
2191     // In this case, we can&#39;t call dispatch_next() after the frame is
2192     // popped, but instead must save the incoming arguments and restore
2193     // them after deoptimization has occurred.
2194     //
2195     // Note that we don&#39;t compare the return PC against the
2196     // deoptimization blob&#39;s unpack entry because of the presence of
2197     // adapter frames in C2.
2198     NearLabel caller_not_deoptimized;
2199     __ z_lg(Z_ARG1, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2200     __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::interpreter_contains), Z_ARG1);
2201     __ compareU64_and_branch(Z_RET, (intptr_t)0, Assembler::bcondNotEqual, caller_not_deoptimized);
2202 
2203     // Compute size of arguments for saving when returning to
2204     // deoptimized caller.
2205     __ get_method(Z_ARG2);
2206     __ z_lg(Z_ARG2, Address(Z_ARG2, Method::const_offset()));
2207     __ z_llgh(Z_ARG2, Address(Z_ARG2, ConstMethod::size_of_parameters_offset()));
2208     __ z_sllg(Z_ARG2, Z_ARG2, Interpreter::logStackElementSize); // slots 2 bytes
2209     __ restore_locals();
2210     // Compute address of args to be saved.
2211     __ z_lgr(Z_ARG3, Z_locals);
2212     __ z_slgr(Z_ARG3, Z_ARG2);
2213     __ add2reg(Z_ARG3, wordSize);
2214     // Save these arguments.
2215     __ call_VM_leaf(CAST_FROM_FN_PTR(address, Deoptimization::popframe_preserve_args),
2216                     Z_thread, Z_ARG2, Z_ARG3);
2217 
2218     __ remove_activation(vtos, Z_R14,
2219                          /* throw_monitor_exception */ false,
2220                          /* install_monitor_exception */ false,
2221                          /* notify_jvmdi */ false);
2222 
2223     // Inform deoptimization that it is responsible for restoring
2224     // these arguments.
2225     __ store_const(thread_(popframe_condition),
2226                    JavaThread::popframe_force_deopt_reexecution_bit,
2227                    Z_tmp_1, false);
2228 
2229     // Continue in deoptimization handler.
2230     __ z_br(Z_R14);
2231 
2232     __ bind(caller_not_deoptimized);
2233   }
2234 
2235   // Clear the popframe condition flag.
2236   __ clear_mem(thread_(popframe_condition), sizeof(int));
2237 
2238   __ remove_activation(vtos,
2239                        noreg,  // Retaddr is not used.
2240                        false,  // throw_monitor_exception
2241                        false,  // install_monitor_exception
2242                        false); // notify_jvmdi
2243   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2244   __ restore_bcp();
2245   __ restore_locals();
2246   __ restore_esp();
2247   // The method data pointer was incremented already during
2248   // call profiling. We have to restore the mdp for the current bcp.
2249   if (ProfileInterpreter) {
2250     __ set_method_data_pointer_for_bcp();
2251   }
2252 #if INCLUDE_JVMTI
2253   {
2254     Label L_done;
2255 
2256     __ z_cli(0, Z_bcp, Bytecodes::_invokestatic);
2257     __ z_brc(Assembler::bcondNotEqual, L_done);
2258 
2259     // The member name argument must be restored if _invokestatic is
2260     // re-executed after a PopFrame call.  Detect such a case in the
2261     // InterpreterRuntime function and return the member name
2262     // argument, or NULL.
2263     __ z_lg(Z_ARG2, Address(Z_locals));
2264     __ get_method(Z_ARG3);
2265     __ call_VM(Z_tmp_1,
2266                CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null),
2267                Z_ARG2, Z_ARG3, Z_bcp);
2268 
2269     __ z_ltgr(Z_tmp_1, Z_tmp_1);
2270     __ z_brc(Assembler::bcondEqual, L_done);
2271 
2272     __ z_stg(Z_tmp_1, Address(Z_esp, wordSize));
2273     __ bind(L_done);
2274   }
2275 #endif // INCLUDE_JVMTI
2276   __ dispatch_next(vtos);
2277   // End of PopFrame support.
2278   Interpreter::_remove_activation_entry = __ pc();
2279 
2280   // In between activations - previous activation type unknown yet
2281   // compute continuation point - the continuation point expects the
2282   // following registers set up:
2283   //
2284   // Z_ARG1 (==Z_tos): exception
2285   // Z_ARG2          : return address/pc that threw exception
2286 
2287   Register return_pc = Z_tmp_1;
2288   Register handler   = Z_tmp_2;
2289    assert(return_pc-&gt;is_nonvolatile(), &quot;use non-volatile reg. to preserve exception pc&quot;);
2290    assert(handler-&gt;is_nonvolatile(),   &quot;use non-volatile reg. to handler pc&quot;);
2291   __ asm_assert_ijava_state_magic(return_pc/*tmp*/); // The top frame should be an interpreter frame.
2292   __ z_lg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2293 
2294   // Moved removing the activation after VM call, because the new top
2295   // frame does not necessarily have the z_abi_160 required for a VM
2296   // call (e.g. if it is compiled).
2297 
2298   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
2299                                          SharedRuntime::exception_handler_for_return_address),
2300                         Z_thread, return_pc);
2301   __ z_lgr(handler, Z_RET); // Save exception handler.
2302 
2303   // Preserve exception over this code sequence.
2304   __ pop_ptr(Z_ARG1);
2305   __ set_vm_result(Z_ARG1);
2306   // Remove the activation (without doing throws on illegalMonitorExceptions).
2307   __ remove_activation(vtos, noreg/*ret.pc already loaded*/, false/*throw exc*/, true/*install exc*/, false/*notify jvmti*/);
2308   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2309 
2310   __ get_vm_result(Z_ARG1);     // Restore exception.
2311   __ verify_oop(Z_ARG1);
2312   __ z_lgr(Z_ARG2, return_pc);  // Restore return address.
2313 
2314 #ifdef ASSERT
2315   // The return_pc in the new top frame is dead... at least that&#39;s my
2316   // current understanding. To assert this I overwrite it.
2317   // Note: for compiled frames the handler is the deopt blob
2318   // which writes Z_ARG2 into the return_pc slot.
2319   __ load_const_optimized(return_pc, 0xb00b1);
2320   __ z_stg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_SP);
2321 #endif
2322 
2323   // Z_ARG1 (==Z_tos): exception
2324   // Z_ARG2          : return address/pc that threw exception
2325 
2326   // Note that an &quot;issuing PC&quot; is actually the next PC after the call.
2327   __ z_br(handler);         // Jump to exception handler of caller.
2328 
2329   BLOCK_COMMENT(&quot;} throw_exception&quot;);
2330 }
2331 
2332 //
2333 // JVMTI ForceEarlyReturn support
2334 //
2335 address TemplateInterpreterGenerator::generate_earlyret_entry_for (TosState state) {
2336   address entry = __ pc();
2337 
2338   BLOCK_COMMENT(&quot;earlyret_entry {&quot;);
2339 
2340   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2341   __ restore_bcp();
2342   __ restore_locals();
2343   __ restore_esp();
2344   __ empty_expression_stack();
2345   __ load_earlyret_value(state);
2346 
2347   Register RjvmtiState = Z_tmp_1;
2348   __ z_lg(RjvmtiState, thread_(jvmti_thread_state));
2349   __ store_const(Address(RjvmtiState, JvmtiThreadState::earlyret_state_offset()),
2350                  JvmtiThreadState::earlyret_inactive, 4, 4, Z_R0_scratch);
2351 
2352   if (state == itos) {
2353     // Narrow result if state is itos but result type is smaller.
2354     // Need to narrow in the return bytecode rather than in generate_return_entry
2355     // since compiled code callers expect the result to already be narrowed.
2356     __ narrow(Z_tos, Z_tmp_1); /* fall through */
2357   }
2358   __ remove_activation(state,
2359                        Z_tmp_1, // retaddr
2360                        false,   // throw_monitor_exception
2361                        false,   // install_monitor_exception
2362                        true);   // notify_jvmdi
2363   __ z_br(Z_tmp_1);
2364 
2365   BLOCK_COMMENT(&quot;} earlyret_entry&quot;);
2366 
2367   return entry;
2368 }
2369 
2370 //-----------------------------------------------------------------------------
2371 // Helper for vtos entry point generation.
2372 
2373 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2374                                                          address&amp; bep,
2375                                                          address&amp; cep,
2376                                                          address&amp; sep,
2377                                                          address&amp; aep,
2378                                                          address&amp; iep,
2379                                                          address&amp; lep,
2380                                                          address&amp; fep,
2381                                                          address&amp; dep,
2382                                                          address&amp; vep) {
2383   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2384   Label L;
2385   aep = __ pc(); __ push_ptr(); __ z_bru(L);
2386   fep = __ pc(); __ push_f();   __ z_bru(L);
2387   dep = __ pc(); __ push_d();   __ z_bru(L);
2388   lep = __ pc(); __ push_l();   __ z_bru(L);
2389   bep = cep = sep =
2390   iep = __ pc(); __ push_i();
2391   vep = __ pc();
2392   __ bind(L);
2393   generate_and_dispatch(t);
2394 }
2395 
2396 //-----------------------------------------------------------------------------
2397 
2398 #ifndef PRODUCT
2399 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2400   address entry = __ pc();
2401   NearLabel counter_below_trace_threshold;
2402 
2403   if (TraceBytecodesAt &gt; 0) {
2404     // Skip runtime call, if the trace threshold is not yet reached.
2405     __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2406     __ load_absolute_address(Z_tmp_2, (address)&amp;TraceBytecodesAt);
2407     __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2408     __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2409     __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, counter_below_trace_threshold);
2410   }
2411 
2412   int offset2 = state == ltos || state == dtos ? 2 : 1;
2413 
2414   __ push(state);
2415   // Preserved return pointer is in Z_R14.
2416   // InterpreterRuntime::trace_bytecode() preserved and returns the value passed as second argument.
2417   __ z_lgr(Z_ARG2, Z_R14);
2418   __ z_lg(Z_ARG3, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)));
2419   if (WizardMode) {
2420     __ z_lgr(Z_ARG4, Z_esp); // Trace Z_esp in WizardMode.
2421   } else {
2422     __ z_lg(Z_ARG4, Address(Z_esp, Interpreter::expr_offset_in_bytes(offset2)));
2423   }
2424   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), Z_ARG2, Z_ARG3, Z_ARG4);
2425   __ z_lgr(Z_R14, Z_RET); // Estore return address (see above).
2426   __ pop(state);
2427 
2428   __ bind(counter_below_trace_threshold);
2429   __ z_br(Z_R14); // return
2430 
2431   return entry;
2432 }
2433 
2434 // Make feasible for old CPUs.
2435 void TemplateInterpreterGenerator::count_bytecode() {
2436   __ load_absolute_address(Z_R1_scratch, (address) &amp;BytecodeCounter::_counter_value);
2437   __ add2mem_32(Address(Z_R1_scratch), 1, Z_R0_scratch);
2438 }
2439 
2440 void TemplateInterpreterGenerator::histogram_bytecode(Template * t) {
2441   __ load_absolute_address(Z_R1_scratch, (address)&amp;BytecodeHistogram::_counters[ t-&gt;bytecode() ]);
2442   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2443 }
2444 
2445 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template * t) {
2446   Address  index_addr(Z_tmp_1, (intptr_t) 0);
2447   Register index = Z_tmp_2;
2448 
2449   // Load previous index.
2450   __ load_absolute_address(Z_tmp_1, (address) &amp;BytecodePairHistogram::_index);
2451   __ mem2reg_opt(index, index_addr, false);
2452 
2453   // Mask with current bytecode and store as new previous index.
2454   __ z_srl(index, BytecodePairHistogram::log2_number_of_codes);
2455   __ load_const_optimized(Z_R0_scratch,
2456                           (int)t-&gt;bytecode() &lt;&lt; BytecodePairHistogram::log2_number_of_codes);
2457   __ z_or(index, Z_R0_scratch);
2458   __ reg2mem_opt(index, index_addr, false);
2459 
2460   // Load counter array&#39;s address.
2461   __ z_lgfr(index, index);   // Sign extend for addressing.
2462   __ z_sllg(index, index, LogBytesPerInt);  // index2bytes
2463   __ load_absolute_address(Z_R1_scratch,
2464                            (address) &amp;BytecodePairHistogram::_counters);
2465   // Add index and increment counter.
2466   __ z_agr(Z_R1_scratch, index);
2467   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2468 }
2469 
2470 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2471   // Call a little run-time stub to avoid blow-up for each bytecode.
2472   // The run-time runtime saves the right registers, depending on
2473   // the tosca in-state for the given template.
2474   address entry = Interpreter::trace_code(t-&gt;tos_in());
2475   guarantee(entry != NULL, &quot;entry must have been generated&quot;);
2476   __ call_stub(entry);
2477 }
2478 
2479 void TemplateInterpreterGenerator::stop_interpreter_at() {
2480   NearLabel L;
2481 
2482   __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2483   __ load_absolute_address(Z_tmp_2, (address)&amp;StopInterpreterAt);
2484   __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2485   __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2486   __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, L);
2487   assert(Z_tmp_1-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_tos&quot;);
2488   assert(Z_F8-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_ftos&quot;);
2489   __ z_lgr(Z_tmp_1, Z_tos);      // Save tos.
2490   __ z_lgr(Z_tmp_2, Z_bytecode); // Save Z_bytecode.
2491   __ z_ldr(Z_F8, Z_ftos);        // Save ftos.
2492   // Use -XX:StopInterpreterAt=&lt;num&gt; to set the limit
2493   // and break at breakpoint().
2494   __ call_VM(noreg, CAST_FROM_FN_PTR(address, breakpoint), false);
2495   __ z_lgr(Z_tos, Z_tmp_1);      // Restore tos.
2496   __ z_lgr(Z_bytecode, Z_tmp_2); // Save Z_bytecode.
2497   __ z_ldr(Z_ftos, Z_F8);        // Restore ftos.
2498   __ bind(L);
2499 }
2500 
2501 #endif // !PRODUCT
    </pre>
  </body>
</html>