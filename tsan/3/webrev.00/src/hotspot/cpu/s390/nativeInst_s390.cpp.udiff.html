<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/cpu/s390/nativeInst_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="methodHandles_s390.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="nativeInst_s390.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/s390/nativeInst_s390.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -473,16 +473,46 @@</span>
  }
  
  // Divided up in set_data_plain() which patches the instruction in the
  // code stream and set_data() which additionally patches the oop pool
  // if necessary.
<span class="udiff-line-modified-removed">- void NativeMovConstReg::set_data(intptr_t src) {</span>
<span class="udiff-line-modified-added">+ void NativeMovConstReg::set_data(intptr_t data, relocInfo::relocType expected_type) {</span>
    // Also store the value into an oop_Relocation cell, if any.
    CodeBlob *cb = CodeCache::find_blob(instruction_address());
<span class="udiff-line-modified-removed">-   address next_address = set_data_plain(src, cb);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   relocInfo::update_oop_pool(instruction_address(), next_address, (address)src, cb);</span>
<span class="udiff-line-modified-added">+   address next_address = set_data_plain(data, cb);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // &#39;RelocIterator&#39; requires an nmethod</span>
<span class="udiff-line-added">+   nmethod* nm = cb ? cb-&gt;as_nmethod_or_null() : NULL;</span>
<span class="udiff-line-added">+   if (nm != NULL) {</span>
<span class="udiff-line-added">+     RelocIterator iter(nm, instruction_address(), next_address);</span>
<span class="udiff-line-added">+     oop* oop_addr = NULL;</span>
<span class="udiff-line-added">+     Metadata** metadata_addr = NULL;</span>
<span class="udiff-line-added">+     while (iter.next()) {</span>
<span class="udiff-line-added">+       if (iter.type() == relocInfo::oop_type) {</span>
<span class="udiff-line-added">+         oop_Relocation *r = iter.oop_reloc();</span>
<span class="udiff-line-added">+         if (oop_addr == NULL) {</span>
<span class="udiff-line-added">+           oop_addr = r-&gt;oop_addr();</span>
<span class="udiff-line-added">+           *oop_addr = cast_to_oop(data);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+           assert(oop_addr == r-&gt;oop_addr(), &quot;must be only one set-oop here&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       if (iter.type() == relocInfo::metadata_type) {</span>
<span class="udiff-line-added">+         metadata_Relocation *r = iter.metadata_reloc();</span>
<span class="udiff-line-added">+         if (metadata_addr == NULL) {</span>
<span class="udiff-line-added">+           metadata_addr = r-&gt;metadata_addr();</span>
<span class="udiff-line-added">+           *metadata_addr = (Metadata*)data;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+           assert(metadata_addr == r-&gt;metadata_addr(), &quot;must be only one set-metadata here&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     assert(expected_type == relocInfo::none ||</span>
<span class="udiff-line-added">+           (expected_type == relocInfo::metadata_type &amp;&amp; metadata_addr != NULL) ||</span>
<span class="udiff-line-added">+           (expected_type == relocInfo::oop_type &amp;&amp; oop_addr != NULL),</span>
<span class="udiff-line-added">+           &quot;%s relocation not found&quot;, expected_type == relocInfo::oop_type ? &quot;oop&quot; : &quot;metadata&quot;);</span>
<span class="udiff-line-added">+   }</span>
  }
  
  void NativeMovConstReg::set_narrow_oop(intptr_t data) {
    const address start = addr_at(0);
    int           range = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -508,11 +538,11 @@</span>
      fatal(&quot;this is not a `NativeMovConstReg::narrow_klass&#39; site&quot;);
    }
    ICache::invalidate_range(start, range);
  }
  
<span class="udiff-line-modified-removed">- void NativeMovConstReg::set_pcrel_addr(intptr_t newTarget, CompiledMethod *passed_nm /* = NULL */, bool copy_back_to_oop_pool) {</span>
<span class="udiff-line-modified-added">+ void NativeMovConstReg::set_pcrel_addr(intptr_t newTarget, CompiledMethod *passed_nm /* = NULL */) {</span>
    address next_address;
    address loc = addr_at(0);
  
    if (MacroAssembler::is_load_addr_pcrel(loc)) {
      address oldTarget = MacroAssembler::get_target_addr_pcrel(loc);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -531,24 +561,13 @@</span>
      next_address = next_instruction_address();
    } else {
      assert(false, &quot;Not a NativeMovConstReg site for set_pcrel_addr&quot;);
      next_address = next_instruction_address(); // Failure should be handled in next_instruction_address().
    }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (copy_back_to_oop_pool) {</span>
<span class="udiff-line-removed">-     if (relocInfo::update_oop_pool(instruction_address(), next_address, (address)newTarget, NULL)) {</span>
<span class="udiff-line-removed">-       ((NativeMovConstReg*)instruction_address())-&gt;dump(64, &quot;NativeMovConstReg::set_pcrel_addr(): found oop reloc for pcrel_addr&quot;);</span>
<span class="udiff-line-removed">- #ifdef LUCY_DBG</span>
<span class="udiff-line-removed">-       VM_Version::z_SIGSEGV();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-       assert(false, &quot;Ooooops: found oop reloc for pcrel_addr&quot;);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
  }
  
<span class="udiff-line-modified-removed">- void NativeMovConstReg::set_pcrel_data(intptr_t newData, CompiledMethod *passed_nm /* = NULL */, bool copy_back_to_oop_pool) {</span>
<span class="udiff-line-modified-added">+ void NativeMovConstReg::set_pcrel_data(intptr_t newData, CompiledMethod *passed_nm /* = NULL */) {</span>
    address  next_address;
    address  loc = addr_at(0);
  
    if (MacroAssembler::is_load_const_from_toc(loc) ) {  // Load constant from TOC.
      // Offset is +/- 2**32 -&gt; use long.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -571,21 +590,10 @@</span>
      next_address = next_instruction_address();
    } else {
      assert(false, &quot;Not a NativeMovConstReg site for set_pcrel_data&quot;);
      next_address = next_instruction_address(); // Failure should be handled in next_instruction_address().
    }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (copy_back_to_oop_pool) {</span>
<span class="udiff-line-removed">-     if (relocInfo::update_oop_pool(instruction_address(), next_address, (address)newData, NULL)) {</span>
<span class="udiff-line-removed">-       ((NativeMovConstReg*)instruction_address())-&gt;dump(64, &quot;NativeMovConstReg::set_pcrel_data(): found oop reloc for pcrel_data&quot;);</span>
<span class="udiff-line-removed">- #ifdef LUCY_DBG</span>
<span class="udiff-line-removed">-       VM_Version::z_SIGSEGV();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-       assert(false, &quot;Ooooops: found oop reloc for pcrel_data&quot;);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
  }
  
  #ifdef COMPILER1
  //--------------------------------
  //  N a t i v e M o v R e g M e m
</pre>
<center><a href="methodHandles_s390.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="nativeInst_s390.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>