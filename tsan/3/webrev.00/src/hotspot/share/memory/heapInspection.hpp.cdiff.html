<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/memory/heapInspection.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="heapInspection.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapShared.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/heapInspection.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 45,143 ***</span>
  //
  // KlassInfoHisto is a growable array of pointers
  // to KlassInfoEntry&#39;s and is used to sort
  // the entries.
  
<span class="line-removed">- #define HEAP_INSPECTION_COLUMNS_DO(f) \</span>
<span class="line-removed">-     f(inst_size, InstSize, \</span>
<span class="line-removed">-         &quot;Size of each object instance of the Java class&quot;) \</span>
<span class="line-removed">-     f(inst_count, InstCount, \</span>
<span class="line-removed">-         &quot;Number of object instances of the Java class&quot;)  \</span>
<span class="line-removed">-     f(inst_bytes, InstBytes, \</span>
<span class="line-removed">-         &quot;This is usually (InstSize * InstNum). The only exception is &quot; \</span>
<span class="line-removed">-         &quot;java.lang.Class, whose InstBytes also includes the slots &quot; \</span>
<span class="line-removed">-         &quot;used to store static fields. InstBytes is not counted in &quot; \</span>
<span class="line-removed">-         &quot;ROAll, RWAll or Total&quot;) \</span>
<span class="line-removed">-     f(mirror_bytes, Mirror, \</span>
<span class="line-removed">-         &quot;Size of the Klass::java_mirror() object&quot;) \</span>
<span class="line-removed">-     f(klass_bytes, KlassBytes, \</span>
<span class="line-removed">-         &quot;Size of the InstanceKlass or ArrayKlass for this class. &quot; \</span>
<span class="line-removed">-         &quot;Note that this includes VTab, ITab, OopMap&quot;) \</span>
<span class="line-removed">-     f(secondary_supers_bytes, K_secondary_supers, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the Klass::secondary_supers() array&quot;) \</span>
<span class="line-removed">-     f(vtab_bytes, VTab, \</span>
<span class="line-removed">-         &quot;Size of the embedded vtable in InstanceKlass&quot;) \</span>
<span class="line-removed">-     f(itab_bytes, ITab, \</span>
<span class="line-removed">-         &quot;Size of the embedded itable in InstanceKlass&quot;) \</span>
<span class="line-removed">-     f(nonstatic_oopmap_bytes, OopMap, \</span>
<span class="line-removed">-         &quot;Size of the embedded nonstatic_oop_map in InstanceKlass&quot;) \</span>
<span class="line-removed">-     f(methods_array_bytes, IK_methods, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::methods() array&quot;) \</span>
<span class="line-removed">-     f(method_ordering_bytes, IK_method_ordering, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::method_ordering() array&quot;) \</span>
<span class="line-removed">-     f(default_methods_array_bytes, IK_default_methods, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::default_methods() array&quot;) \</span>
<span class="line-removed">-     f(default_vtable_indices_bytes, IK_default_vtable_indices, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::default_vtable_indices() array&quot;) \</span>
<span class="line-removed">-     f(local_interfaces_bytes, IK_local_interfaces, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::local_interfaces() array&quot;) \</span>
<span class="line-removed">-     f(transitive_interfaces_bytes, IK_transitive_interfaces, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::transitive_interfaces() array&quot;) \</span>
<span class="line-removed">-     f(fields_bytes, IK_fields, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::fields() array&quot;) \</span>
<span class="line-removed">-     f(inner_classes_bytes, IK_inner_classes, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::inner_classes() array&quot;) \</span>
<span class="line-removed">-     f(nest_members_bytes, IK_nest_members, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::nest_members() array&quot;) \</span>
<span class="line-removed">-     f(signers_bytes, IK_signers, \</span>
<span class="line-removed">-         &quot;Number of bytes used by the InstanceKlass::singers() array&quot;) \</span>
<span class="line-removed">-     f(class_annotations_bytes, class_annotations, \</span>
<span class="line-removed">-         &quot;Size of class annotations&quot;) \</span>
<span class="line-removed">-     f(class_type_annotations_bytes, class_type_annotations, \</span>
<span class="line-removed">-         &quot;Size of class type annotations&quot;) \</span>
<span class="line-removed">-     f(fields_annotations_bytes, fields_annotations, \</span>
<span class="line-removed">-         &quot;Size of field annotations&quot;) \</span>
<span class="line-removed">-     f(fields_type_annotations_bytes, fields_type_annotations, \</span>
<span class="line-removed">-         &quot;Size of field type annotations&quot;) \</span>
<span class="line-removed">-     f(methods_annotations_bytes, methods_annotations, \</span>
<span class="line-removed">-         &quot;Size of method annotations&quot;) \</span>
<span class="line-removed">-     f(methods_parameter_annotations_bytes, methods_parameter_annotations, \</span>
<span class="line-removed">-         &quot;Size of method parameter annotations&quot;) \</span>
<span class="line-removed">-     f(methods_type_annotations_bytes, methods_type_annotations, \</span>
<span class="line-removed">-         &quot;Size of methods type annotations&quot;) \</span>
<span class="line-removed">-     f(methods_default_annotations_bytes, methods_default_annotations, \</span>
<span class="line-removed">-         &quot;Size of methods default annotations&quot;) \</span>
<span class="line-removed">-     f(annotations_bytes, annotations, \</span>
<span class="line-removed">-         &quot;Size of all annotations&quot;) \</span>
<span class="line-removed">-     f(cp_bytes, Cp, \</span>
<span class="line-removed">-         &quot;Size of InstanceKlass::constants()&quot;) \</span>
<span class="line-removed">-     f(cp_tags_bytes, CpTags, \</span>
<span class="line-removed">-         &quot;Size of InstanceKlass::constants()-&gt;tags()&quot;) \</span>
<span class="line-removed">-     f(cp_cache_bytes, CpCache, \</span>
<span class="line-removed">-         &quot;Size of InstanceKlass::constants()-&gt;cache()&quot;) \</span>
<span class="line-removed">-     f(cp_operands_bytes, CpOperands, \</span>
<span class="line-removed">-         &quot;Size of InstanceKlass::constants()-&gt;operands()&quot;) \</span>
<span class="line-removed">-     f(cp_refmap_bytes, CpRefMap, \</span>
<span class="line-removed">-         &quot;Size of InstanceKlass::constants()-&gt;reference_map()&quot;) \</span>
<span class="line-removed">-     f(cp_all_bytes, CpAll, \</span>
<span class="line-removed">-         &quot;Sum of Cp + CpTags + CpCache + CpOperands + CpRefMap&quot;) \</span>
<span class="line-removed">-     f(method_count, MethodCount, \</span>
<span class="line-removed">-         &quot;Number of methods in this class&quot;) \</span>
<span class="line-removed">-     f(method_bytes, MethodBytes, \</span>
<span class="line-removed">-         &quot;Size of the Method object&quot;) \</span>
<span class="line-removed">-     f(const_method_bytes, ConstMethod, \</span>
<span class="line-removed">-         &quot;Size of the ConstMethod object&quot;) \</span>
<span class="line-removed">-     f(method_data_bytes, MethodData, \</span>
<span class="line-removed">-         &quot;Size of the MethodData object&quot;) \</span>
<span class="line-removed">-     f(stackmap_bytes, StackMap, \</span>
<span class="line-removed">-         &quot;Size of the stackmap_data&quot;) \</span>
<span class="line-removed">-     f(bytecode_bytes, Bytecodes, \</span>
<span class="line-removed">-         &quot;Of the MethodBytes column, how much are the space taken up by bytecodes&quot;) \</span>
<span class="line-removed">-     f(method_all_bytes, MethodAll, \</span>
<span class="line-removed">-         &quot;Sum of MethodBytes + Constmethod + Stackmap + Methoddata&quot;) \</span>
<span class="line-removed">-     f(ro_bytes, ROAll, \</span>
<span class="line-removed">-         &quot;Size of all class meta data that could (potentially) be placed &quot; \</span>
<span class="line-removed">-         &quot;in read-only memory. (This could change with CDS design)&quot;) \</span>
<span class="line-removed">-     f(rw_bytes, RWAll, \</span>
<span class="line-removed">-         &quot;Size of all class meta data that must be placed in read/write &quot; \</span>
<span class="line-removed">-         &quot;memory. (This could change with CDS design) &quot;) \</span>
<span class="line-removed">-     f(total_bytes, Total, \</span>
<span class="line-removed">-         &quot;ROAll + RWAll. Note that this does NOT include InstBytes.&quot;)</span>
<span class="line-removed">- </span>
<span class="line-removed">- // Size statistics for a Klass - filled in by Klass::collect_statistics()</span>
<span class="line-removed">- class KlassSizeStats {</span>
<span class="line-removed">- public:</span>
<span class="line-removed">- #define COUNT_KLASS_SIZE_STATS_FIELD(field, name, help)   _index_ ## field,</span>
<span class="line-removed">- #define DECLARE_KLASS_SIZE_STATS_FIELD(field, name, help) julong _ ## field;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   enum {</span>
<span class="line-removed">-     HEAP_INSPECTION_COLUMNS_DO(COUNT_KLASS_SIZE_STATS_FIELD)</span>
<span class="line-removed">-     _num_columns</span>
<span class="line-removed">-   };</span>
<span class="line-removed">- </span>
<span class="line-removed">-   HEAP_INSPECTION_COLUMNS_DO(DECLARE_KLASS_SIZE_STATS_FIELD)</span>
<span class="line-removed">- </span>
<span class="line-removed">-   static int count(oop x);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   static int count_array(objArrayOop x);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   template &lt;class T&gt; static int count(T* x) {</span>
<span class="line-removed">-     return (HeapWordSize * ((x) ? (x)-&gt;size() : 0));</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   template &lt;class T&gt; static int count_array(T* x) {</span>
<span class="line-removed">-     if (x == NULL) {</span>
<span class="line-removed">-       return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     if (x-&gt;length() == 0) {</span>
<span class="line-removed">-       // This is a shared array, e.g., Universe::the_empty_int_array(). Don&#39;t</span>
<span class="line-removed">-       // count it to avoid double-counting.</span>
<span class="line-removed">-       return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return HeapWordSize * x-&gt;size();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
  class KlassInfoEntry: public CHeapObj&lt;mtInternal&gt; {
   private:
    KlassInfoEntry* _next;
    Klass*          _klass;
    long            _instance_count;
<span class="line-new-header">--- 45,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 277,17 ***</span>
    KlassInfoTable *_cit;
    GrowableArray&lt;KlassInfoEntry*&gt;* _elements;
    GrowableArray&lt;KlassInfoEntry*&gt;* elements() const { return _elements; }
    static int sort_helper(KlassInfoEntry** e1, KlassInfoEntry** e2);
    void print_elements(outputStream* st) const;
<span class="line-removed">-   void print_class_stats(outputStream* st, bool csv_format, const char *columns);</span>
<span class="line-removed">-   julong annotations_bytes(Array&lt;AnnotationArray*&gt;* p) const;</span>
<span class="line-removed">-   const char *_selected_columns;</span>
    bool is_selected(const char *col_name);
<span class="line-removed">-   void print_title(outputStream* st, bool csv_format,</span>
<span class="line-removed">-                    bool selected_columns_table[], int width_table[],</span>
<span class="line-removed">-                    const char *name_table[]);</span>
  
    template &lt;class T&gt; static int count_bytes(T* x) {
      return (HeapWordSize * ((x) ? (x)-&gt;size() : 0));
    }
  
<span class="line-new-header">--- 144,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,11 ***</span>
  
   public:
    KlassInfoHisto(KlassInfoTable* cit);
    ~KlassInfoHisto();
    void add(KlassInfoEntry* cie);
<span class="line-modified">!   void print_histo_on(outputStream* st, bool print_class_stats, bool csv_format, const char *columns);</span>
    void sort();
  };
  
  #endif // INCLUDE_SERVICES
  
<span class="line-new-header">--- 196,11 ---</span>
  
   public:
    KlassInfoHisto(KlassInfoTable* cit);
    ~KlassInfoHisto();
    void add(KlassInfoEntry* cie);
<span class="line-modified">!   void print_histo_on(outputStream* st);</span>
    void sort();
  };
  
  #endif // INCLUDE_SERVICES
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,19 ***</span>
  // KlassInfoClosure are guarded by #if INLCUDE_SERVICES
  class KlassInfoTable;
  class KlassInfoClosure;
  
  class HeapInspection : public StackObj {
<span class="line-removed">-   bool _csv_format; // &quot;comma separated values&quot; format for spreadsheet.</span>
<span class="line-removed">-   bool _print_help;</span>
<span class="line-removed">-   bool _print_class_stats;</span>
<span class="line-removed">-   const char* _columns;</span>
   public:
<span class="line-removed">-   HeapInspection(bool csv_format, bool print_help,</span>
<span class="line-removed">-                  bool print_class_stats, const char *columns) :</span>
<span class="line-removed">-       _csv_format(csv_format), _print_help(print_help),</span>
<span class="line-removed">-       _print_class_stats(print_class_stats), _columns(columns) {}</span>
    void heap_inspection(outputStream* st) NOT_SERVICES_RETURN;
    size_t populate_table(KlassInfoTable* cit, BoolObjectClosure* filter = NULL) NOT_SERVICES_RETURN_(0);
    static void find_instances_at_safepoint(Klass* k, GrowableArray&lt;oop&gt;* result) NOT_SERVICES_RETURN;
   private:
    void iterate_over_heap(KlassInfoTable* cit, BoolObjectClosure* filter = NULL);
<span class="line-new-header">--- 208,11 ---</span>
</pre>
<center><a href="heapInspection.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapShared.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>