<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/memory/filemap.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.inline.hpp&quot;
  28 #include &quot;classfile/classLoaderExt.hpp&quot;
  29 #include &quot;classfile/symbolTable.hpp&quot;
  30 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  31 #include &quot;classfile/altHashing.hpp&quot;
  32 #include &quot;logging/log.hpp&quot;
  33 #include &quot;logging/logStream.hpp&quot;
  34 #include &quot;logging/logMessage.hpp&quot;
  35 #include &quot;memory/filemap.hpp&quot;
  36 #include &quot;memory/heapShared.inline.hpp&quot;
  37 #include &quot;memory/iterator.inline.hpp&quot;
  38 #include &quot;memory/metadataFactory.hpp&quot;
  39 #include &quot;memory/metaspaceClosure.hpp&quot;
  40 #include &quot;memory/metaspaceShared.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;oops/compressedOops.inline.hpp&quot;
  43 #include &quot;oops/objArrayOop.hpp&quot;
  44 #include &quot;oops/oop.inline.hpp&quot;
  45 #include &quot;prims/jvmtiExport.hpp&quot;
  46 #include &quot;runtime/arguments.hpp&quot;
  47 #include &quot;runtime/java.hpp&quot;
  48 #include &quot;runtime/mutexLocker.hpp&quot;
  49 #include &quot;runtime/os.inline.hpp&quot;
  50 #include &quot;runtime/vm_version.hpp&quot;
  51 #include &quot;services/memTracker.hpp&quot;
  52 #include &quot;utilities/align.hpp&quot;
  53 #include &quot;utilities/defaultStream.hpp&quot;
  54 #if INCLUDE_G1GC
  55 #include &quot;gc/g1/g1CollectedHeap.hpp&quot;
  56 #include &quot;gc/g1/heapRegion.hpp&quot;
  57 #endif
  58 
  59 # include &lt;sys/stat.h&gt;
  60 # include &lt;errno.h&gt;
  61 
  62 #ifndef O_BINARY       // if defined (Win32) use binary files.
  63 #define O_BINARY 0     // otherwise do nothing.
  64 #endif
  65 
  66 extern address JVM_FunctionAtStart();
  67 extern address JVM_FunctionAtEnd();
  68 
  69 // Complain and stop. All error conditions occurring during the writing of
  70 // an archive file should stop the process.  Unrecoverable errors during
  71 // the reading of the archive file should stop the process.
  72 
  73 static void fail(const char *msg, va_list ap) {
  74   // This occurs very early during initialization: tty is not initialized.
  75   jio_fprintf(defaultStream::error_stream(),
  76               &quot;An error has occurred while processing the&quot;
  77               &quot; shared archive file.\n&quot;);
  78   jio_vfprintf(defaultStream::error_stream(), msg, ap);
  79   jio_fprintf(defaultStream::error_stream(), &quot;\n&quot;);
  80   // Do not change the text of the below message because some tests check for it.
  81   vm_exit_during_initialization(&quot;Unable to use shared archive.&quot;, NULL);
  82 }
  83 
  84 
  85 void FileMapInfo::fail_stop(const char *msg, ...) {
  86         va_list ap;
  87   va_start(ap, msg);
  88   fail(msg, ap);        // Never returns.
  89   va_end(ap);           // for completeness.
  90 }
  91 
  92 
  93 // Complain and continue.  Recoverable errors during the reading of the
  94 // archive file may continue (with sharing disabled).
  95 //
  96 // If we continue, then disable shared spaces and close the file.
  97 
  98 void FileMapInfo::fail_continue(const char *msg, ...) {
  99   va_list ap;
 100   va_start(ap, msg);
 101   MetaspaceShared::set_archive_loading_failed();
 102   if (PrintSharedArchiveAndExit &amp;&amp; _validating_shared_path_table) {
 103     // If we are doing PrintSharedArchiveAndExit and some of the classpath entries
 104     // do not validate, we can still continue &quot;limping&quot; to validate the remaining
 105     // entries. No need to quit.
 106     tty-&gt;print(&quot;[&quot;);
 107     tty-&gt;vprint(msg, ap);
 108     tty-&gt;print_cr(&quot;]&quot;);
 109   } else {
 110     if (RequireSharedSpaces) {
 111       fail(msg, ap);
 112     } else {
 113       if (log_is_enabled(Info, cds)) {
 114         ResourceMark rm;
 115         LogStream ls(Log(cds)::info());
 116         ls.print(&quot;UseSharedSpaces: &quot;);
 117         ls.vprint_cr(msg, ap);
 118       }
 119     }
 120     UseSharedSpaces = false;
 121     assert(current_info() != NULL, &quot;singleton must be registered&quot;);
 122     current_info()-&gt;close();
 123   }
 124   va_end(ap);
 125 }
 126 
 127 // Fill in the fileMapInfo structure with data about this VM instance.
 128 
 129 // This method copies the vm version info into header_version.  If the version is too
 130 // long then a truncated version, which has a hash code appended to it, is copied.
 131 //
 132 // Using a template enables this method to verify that header_version is an array of
 133 // length JVM_IDENT_MAX.  This ensures that the code that writes to the CDS file and
 134 // the code that reads the CDS file will both use the same size buffer.  Hence, will
 135 // use identical truncation.  This is necessary for matching of truncated versions.
 136 template &lt;int N&gt; static void get_header_version(char (&amp;header_version) [N]) {
 137   assert(N == JVM_IDENT_MAX, &quot;Bad header_version size&quot;);
 138 
 139   const char *vm_version = VM_Version::internal_vm_info_string();
 140   const int version_len = (int)strlen(vm_version);
 141 
 142   if (version_len &lt; (JVM_IDENT_MAX-1)) {
 143     strcpy(header_version, vm_version);
 144 
 145   } else {
 146     // Get the hash value.  Use a static seed because the hash needs to return the same
 147     // value over multiple jvm invocations.
 148     unsigned int hash = AltHashing::murmur3_32(8191, (const jbyte*)vm_version, version_len);
 149 
 150     // Truncate the ident, saving room for the 8 hex character hash value.
 151     strncpy(header_version, vm_version, JVM_IDENT_MAX-9);
 152 
 153     // Append the hash code as eight hex digits.
 154     sprintf(&amp;header_version[JVM_IDENT_MAX-9], &quot;%08x&quot;, hash);
 155     header_version[JVM_IDENT_MAX-1] = 0;  // Null terminate.
 156   }
 157 }
 158 
 159 FileMapInfo::FileMapInfo() {
 160   assert(_current_info == NULL, &quot;must be singleton&quot;); // not thread safe
 161   _current_info = this;
 162   memset((void*)this, 0, sizeof(FileMapInfo));
 163   _file_offset = 0;
 164   _file_open = false;
 165   _header = (FileMapHeader*)os::malloc(sizeof(FileMapHeader), mtInternal);
 166   _header-&gt;_version = INVALID_CDS_ARCHIVE_VERSION;
 167   _header-&gt;_has_platform_or_app_classes = true;
 168 }
 169 
 170 FileMapInfo::~FileMapInfo() {
 171   assert(_current_info == this, &quot;must be singleton&quot;); // not thread safe
 172   _current_info = NULL;
 173 }
 174 
 175 void FileMapInfo::populate_header(size_t alignment) {
 176   _header-&gt;populate(this, alignment);
 177 }
 178 
 179 void FileMapHeader::populate(FileMapInfo* mapinfo, size_t alignment) {
 180   _magic = CDS_ARCHIVE_MAGIC;
 181   _version = CURRENT_CDS_ARCHIVE_VERSION;
 182   _alignment = alignment;
 183   _obj_alignment = ObjectAlignmentInBytes;
 184   _compact_strings = CompactStrings;
 185   _narrow_oop_mode = Universe::narrow_oop_mode();
 186   _narrow_oop_base = Universe::narrow_oop_base();
 187   _narrow_oop_shift = Universe::narrow_oop_shift();
 188   _max_heap_size = MaxHeapSize;
 189   _narrow_klass_base = Universe::narrow_klass_base();
 190   _narrow_klass_shift = Universe::narrow_klass_shift();
 191   _shared_path_table_size = mapinfo-&gt;_shared_path_table_size;
 192   _shared_path_table = mapinfo-&gt;_shared_path_table;
 193   _shared_path_entry_size = mapinfo-&gt;_shared_path_entry_size;
 194   if (HeapShared::is_heap_object_archiving_allowed()) {
 195     _heap_reserved = Universe::heap()-&gt;reserved_region();
 196   }
 197 
 198   // The following fields are for sanity checks for whether this archive
 199   // will function correctly with this JVM and the bootclasspath it&#39;s
 200   // invoked with.
 201 
 202   // JVM version string ... changes on each build.
 203   get_header_version(_jvm_ident);
 204 
 205   ClassLoaderExt::finalize_shared_paths_misc_info();
 206   _app_class_paths_start_index = ClassLoaderExt::app_class_paths_start_index();
 207   _app_module_paths_start_index = ClassLoaderExt::app_module_paths_start_index();
 208   _max_used_path_index = ClassLoaderExt::max_used_path_index();
 209 
 210   _verify_local = BytecodeVerificationLocal;
 211   _verify_remote = BytecodeVerificationRemote;
 212   _has_platform_or_app_classes = ClassLoaderExt::has_platform_or_app_classes();
 213   _shared_base_address = SharedBaseAddress;
 214   _allow_archiving_with_java_agent = AllowArchivingWithJavaAgent;
 215 }
 216 
 217 void SharedClassPathEntry::init(const char* name, bool is_modules_image, TRAPS) {
 218   assert(DumpSharedSpaces, &quot;dump time only&quot;);
 219   _timestamp = 0;
 220   _filesize  = 0;
 221 
 222   struct stat st;
 223   if (os::stat(name, &amp;st) == 0) {
 224     if ((st.st_mode &amp; S_IFMT) == S_IFDIR) {
 225       _type = dir_entry;
 226     } else {
 227       // The timestamp of the modules_image is not checked at runtime.
 228       if (is_modules_image) {
 229         _type = modules_image_entry;
 230       } else {
 231         _type = jar_entry;
 232         _timestamp = st.st_mtime;
 233       }
 234       _filesize = st.st_size;
 235     }
 236   } else {
 237     // The file/dir must exist, or it would not have been added
 238     // into ClassLoader::classpath_entry().
 239     //
 240     // If we can&#39;t access a jar file in the boot path, then we can&#39;t
 241     // make assumptions about where classes get loaded from.
 242     FileMapInfo::fail_stop(&quot;Unable to open file %s.&quot;, name);
 243   }
 244 
 245   size_t len = strlen(name) + 1;
 246   _name = MetadataFactory::new_array&lt;char&gt;(ClassLoaderData::the_null_class_loader_data(), (int)len, THREAD);
 247   strcpy(_name-&gt;data(), name);
 248 }
 249 
 250 bool SharedClassPathEntry::validate(bool is_class_path) {
 251   assert(UseSharedSpaces, &quot;runtime only&quot;);
 252 
 253   struct stat st;
 254   const char* name;
 255 
 256   // In order to validate the runtime modules image file size against the archived
 257   // size information, we need to obtain the runtime modules image path. The recorded
 258   // dump time modules image path in the archive may be different from the runtime path
 259   // if the JDK image has beed moved after generating the archive.
 260   if (is_modules_image()) {
 261     name = ClassLoader::get_jrt_entry()-&gt;name();
 262   } else {
 263     name = this-&gt;name();
 264   }
 265 
 266   bool ok = true;
 267   log_info(class, path)(&quot;checking shared classpath entry: %s&quot;, name);
 268   if (os::stat(name, &amp;st) != 0 &amp;&amp; is_class_path) {
 269     // If the archived module path entry does not exist at runtime, it is not fatal
 270     // (no need to invalid the shared archive) because the shared runtime visibility check
 271     // filters out any archived module classes that do not have a matching runtime
 272     // module path location.
 273     FileMapInfo::fail_continue(&quot;Required classpath entry does not exist: %s&quot;, name);
 274     ok = false;
 275   } else if (is_dir()) {
 276     if (!os::dir_is_empty(name)) {
 277       FileMapInfo::fail_continue(&quot;directory is not empty: %s&quot;, name);
 278       ok = false;
 279     }
 280   } else if ((has_timestamp() &amp;&amp; _timestamp != st.st_mtime) ||
 281              _filesize != st.st_size) {
 282     ok = false;
 283     if (PrintSharedArchiveAndExit) {
 284       FileMapInfo::fail_continue(_timestamp != st.st_mtime ?
 285                                  &quot;Timestamp mismatch&quot; :
 286                                  &quot;File size mismatch&quot;);
 287     } else {
 288       FileMapInfo::fail_continue(&quot;A jar file is not the one used while building&quot;
 289                                  &quot; the shared archive file: %s&quot;, name);
 290     }
 291   }
 292 
 293   if (PrintSharedArchiveAndExit &amp;&amp; !ok) {
 294     // If PrintSharedArchiveAndExit is enabled, don&#39;t report failure to the
 295     // caller. Please see above comments for more details.
 296     ok = true;
 297   }
 298   return ok;
 299 }
 300 
 301 void SharedClassPathEntry::metaspace_pointers_do(MetaspaceClosure* it) {
 302   it-&gt;push(&amp;_name);
 303   it-&gt;push(&amp;_manifest);
 304 }
 305 
 306 void FileMapInfo::allocate_shared_path_table() {
 307   assert(DumpSharedSpaces, &quot;Sanity&quot;);
 308 
 309   Thread* THREAD = Thread::current();
 310   ClassLoaderData* loader_data = ClassLoaderData::the_null_class_loader_data();
 311   ClassPathEntry* jrt = ClassLoader::get_jrt_entry();
 312 
 313   assert(jrt != NULL,
 314          &quot;No modular java runtime image present when allocating the CDS classpath entry table&quot;);
 315 
 316   size_t entry_size = sizeof(SharedClassPathEntry); // assert ( should be 8 byte aligned??)
 317   int num_boot_classpath_entries = ClassLoader::num_boot_classpath_entries();
 318   int num_app_classpath_entries = ClassLoader::num_app_classpath_entries();
 319   int num_module_path_entries = ClassLoader::num_module_path_entries();
 320   int num_entries = num_boot_classpath_entries + num_app_classpath_entries + num_module_path_entries;
 321   size_t bytes = entry_size * num_entries;
 322 
 323   _shared_path_table = MetadataFactory::new_array&lt;u8&gt;(loader_data, (int)(bytes + 7 / 8), THREAD);
 324   _shared_path_table_size = num_entries;
 325   _shared_path_entry_size = entry_size;
 326 
 327   // 1. boot class path
 328   int i = 0;
 329   ClassPathEntry* cpe = jrt;
 330   while (cpe != NULL) {
 331     bool is_jrt = (cpe == jrt);
 332     const char* type = (is_jrt ? &quot;jrt&quot; : (cpe-&gt;is_jar_file() ? &quot;jar&quot; : &quot;dir&quot;));
 333     log_info(class, path)(&quot;add main shared path (%s) %s&quot;, type, cpe-&gt;name());
 334     SharedClassPathEntry* ent = shared_path(i);
 335     ent-&gt;init(cpe-&gt;name(), is_jrt, THREAD);
 336     if (!is_jrt) {    // No need to do the modules image.
 337       EXCEPTION_MARK; // The following call should never throw, but would exit VM on error.
 338       update_shared_classpath(cpe, ent, THREAD);
 339     }
 340     cpe = ClassLoader::get_next_boot_classpath_entry(cpe);
 341     i++;
 342   }
 343   assert(i == num_boot_classpath_entries,
 344          &quot;number of boot class path entry mismatch&quot;);
 345 
 346   // 2. app class path
 347   ClassPathEntry *acpe = ClassLoader::app_classpath_entries();
 348   while (acpe != NULL) {
 349     log_info(class, path)(&quot;add app shared path %s&quot;, acpe-&gt;name());
 350     SharedClassPathEntry* ent = shared_path(i);
 351     ent-&gt;init(acpe-&gt;name(), false, THREAD);
 352     EXCEPTION_MARK;
 353     update_shared_classpath(acpe, ent, THREAD);
 354     acpe = acpe-&gt;next();
 355     i++;
 356   }
 357 
 358   // 3. module path
 359   ClassPathEntry *mpe = ClassLoader::module_path_entries();
 360   while (mpe != NULL) {
 361     log_info(class, path)(&quot;add module path %s&quot;,mpe-&gt;name());
 362     SharedClassPathEntry* ent = shared_path(i);
 363     ent-&gt;init(mpe-&gt;name(), false, THREAD);
 364     EXCEPTION_MARK;
 365     update_shared_classpath(mpe, ent, THREAD);
 366     mpe = mpe-&gt;next();
 367     i++;
 368   }
 369   assert(i == num_entries, &quot;number of shared path entry mismatch&quot;);
 370 }
 371 
 372 void FileMapInfo::check_nonempty_dir_in_shared_path_table() {
 373   assert(DumpSharedSpaces, &quot;dump time only&quot;);
 374 
 375   bool has_nonempty_dir = false;
 376 
 377   int last = _shared_path_table_size - 1;
 378   if (last &gt; ClassLoaderExt::max_used_path_index()) {
 379      // no need to check any path beyond max_used_path_index
 380      last = ClassLoaderExt::max_used_path_index();
 381   }
 382 
 383   for (int i = 0; i &lt;= last; i++) {
 384     SharedClassPathEntry *e = shared_path(i);
 385     if (e-&gt;is_dir()) {
 386       const char* path = e-&gt;name();
 387       if (!os::dir_is_empty(path)) {
 388         tty-&gt;print_cr(&quot;Error: non-empty directory &#39;%s&#39;&quot;, path);
 389         has_nonempty_dir = true;
 390       }
 391     }
 392   }
 393 
 394   if (has_nonempty_dir) {
 395     ClassLoader::exit_with_path_failure(&quot;Cannot have non-empty directory in paths&quot;, NULL);
 396   }
 397 }
 398 
 399 class ManifestStream: public ResourceObj {
 400   private:
 401   u1*   _buffer_start; // Buffer bottom
 402   u1*   _buffer_end;   // Buffer top (one past last element)
 403   u1*   _current;      // Current buffer position
 404 
 405  public:
 406   // Constructor
 407   ManifestStream(u1* buffer, int length) : _buffer_start(buffer),
 408                                            _current(buffer) {
 409     _buffer_end = buffer + length;
 410   }
 411 
 412   static bool is_attr(u1* attr, const char* name) {
 413     return strncmp((const char*)attr, name, strlen(name)) == 0;
 414   }
 415 
 416   static char* copy_attr(u1* value, size_t len) {
 417     char* buf = NEW_RESOURCE_ARRAY(char, len + 1);
 418     strncpy(buf, (char*)value, len);
 419     buf[len] = 0;
 420     return buf;
 421   }
 422 
 423   // The return value indicates if the JAR is signed or not
 424   bool check_is_signed() {
 425     u1* attr = _current;
 426     bool isSigned = false;
 427     while (_current &lt; _buffer_end) {
 428       if (*_current == &#39;\n&#39;) {
 429         *_current = &#39;\0&#39;;
 430         u1* value = (u1*)strchr((char*)attr, &#39;:&#39;);
 431         if (value != NULL) {
 432           assert(*(value+1) == &#39; &#39;, &quot;Unrecognized format&quot; );
 433           if (strstr((char*)attr, &quot;-Digest&quot;) != NULL) {
 434             isSigned = true;
 435             break;
 436           }
 437         }
 438         *_current = &#39;\n&#39;; // restore
 439         attr = _current + 1;
 440       }
 441       _current ++;
 442     }
 443     return isSigned;
 444   }
 445 };
 446 
 447 void FileMapInfo::update_shared_classpath(ClassPathEntry *cpe, SharedClassPathEntry* ent, TRAPS) {
 448   ClassLoaderData* loader_data = ClassLoaderData::the_null_class_loader_data();
 449   ResourceMark rm(THREAD);
 450   jint manifest_size;
 451 
 452   if (cpe-&gt;is_jar_file()) {
 453     assert(ent-&gt;is_jar(), &quot;the shared class path entry is not a JAR file&quot;);
 454     char* manifest = ClassLoaderExt::read_manifest(cpe, &amp;manifest_size, CHECK);
 455     if (manifest != NULL) {
 456       ManifestStream* stream = new ManifestStream((u1*)manifest,
 457                                                   manifest_size);
 458       if (stream-&gt;check_is_signed()) {
 459         ent-&gt;set_is_signed();
 460       } else {
 461         // Copy the manifest into the shared archive
 462         manifest = ClassLoaderExt::read_raw_manifest(cpe, &amp;manifest_size, CHECK);
 463         Array&lt;u1&gt;* buf = MetadataFactory::new_array&lt;u1&gt;(loader_data,
 464                                                         manifest_size,
 465                                                         THREAD);
 466         char* p = (char*)(buf-&gt;data());
 467         memcpy(p, manifest, manifest_size);
 468         ent-&gt;set_manifest(buf);
 469       }
 470     }
 471   }
 472 }
 473 
 474 
 475 bool FileMapInfo::validate_shared_path_table() {
 476   assert(UseSharedSpaces, &quot;runtime only&quot;);
 477 
 478   _validating_shared_path_table = true;
 479   _shared_path_table = _header-&gt;_shared_path_table;
 480   _shared_path_entry_size = _header-&gt;_shared_path_entry_size;
 481   _shared_path_table_size = _header-&gt;_shared_path_table_size;
 482 
 483   int module_paths_start_index = _header-&gt;_app_module_paths_start_index;
 484 
 485   // validate the path entries up to the _max_used_path_index
 486   for (int i=0; i &lt; _header-&gt;_max_used_path_index + 1; i++) {
 487     if (i &lt; module_paths_start_index) {
 488       if (shared_path(i)-&gt;validate()) {
 489         log_info(class, path)(&quot;ok&quot;);
 490       } else {
 491         assert(!UseSharedSpaces, &quot;UseSharedSpaces should be disabled&quot;);
 492         return false;
 493       }
 494     } else if (i &gt;= module_paths_start_index) {
 495       if (shared_path(i)-&gt;validate(false /* not a class path entry */)) {
 496         log_info(class, path)(&quot;ok&quot;);
 497       } else {
 498         assert(!UseSharedSpaces, &quot;UseSharedSpaces should be disabled&quot;);
 499         return false;
 500       }
 501     }
 502   }
 503 
 504   _validating_shared_path_table = false;
 505 
 506 #if INCLUDE_JVMTI
 507   if (_classpath_entries_for_jvmti != NULL) {
 508     os::free(_classpath_entries_for_jvmti);
 509   }
 510   size_t sz = sizeof(ClassPathEntry*) *  _shared_path_table_size;
 511   _classpath_entries_for_jvmti = (ClassPathEntry**)os::malloc(sz, mtClass);
 512   memset(_classpath_entries_for_jvmti, 0, sz);
 513 #endif
 514 
 515   return true;
 516 }
 517 
 518 // Read the FileMapInfo information from the file.
 519 
 520 bool FileMapInfo::init_from_file(int fd) {
 521   size_t sz = sizeof(FileMapHeader);
 522   size_t n = os::read(fd, _header, (unsigned int)sz);
 523   if (n != sz) {
 524     fail_continue(&quot;Unable to read the file header.&quot;);
 525     return false;
 526   }
 527   if (_header-&gt;_version != CURRENT_CDS_ARCHIVE_VERSION) {
 528     fail_continue(&quot;The shared archive file has the wrong version.&quot;);
 529     return false;
 530   }
 531   _file_offset = (long)n;
 532 
 533   size_t info_size = _header-&gt;_paths_misc_info_size;
 534   _paths_misc_info = NEW_C_HEAP_ARRAY_RETURN_NULL(char, info_size, mtClass);
 535   if (_paths_misc_info == NULL) {
 536     fail_continue(&quot;Unable to read the file header.&quot;);
 537     return false;
 538   }
 539   n = os::read(fd, _paths_misc_info, (unsigned int)info_size);
 540   if (n != info_size) {
 541     fail_continue(&quot;Unable to read the shared path info header.&quot;);
 542     FREE_C_HEAP_ARRAY(char, _paths_misc_info);
 543     _paths_misc_info = NULL;
 544     return false;
 545   }
 546 
 547   size_t len = lseek(fd, 0, SEEK_END);
 548   CDSFileMapRegion* si = space_at(MetaspaceShared::last_valid_region);
 549   // The last space might be empty
 550   if (si-&gt;_file_offset &gt; len || len - si-&gt;_file_offset &lt; si-&gt;_used) {
 551     fail_continue(&quot;The shared archive file has been truncated.&quot;);
 552     return false;
 553   }
 554 
 555   _file_offset += (long)n;
 556   SharedBaseAddress = _header-&gt;_shared_base_address;
 557   return true;
 558 }
 559 
 560 
 561 // Read the FileMapInfo information from the file.
 562 bool FileMapInfo::open_for_read() {
 563   _full_path = Arguments::GetSharedArchivePath();
 564   int fd = os::open(_full_path, O_RDONLY | O_BINARY, 0);
 565   if (fd &lt; 0) {
 566     if (errno == ENOENT) {
 567       // Not locating the shared archive is ok.
 568       fail_continue(&quot;Specified shared archive not found.&quot;);
 569     } else {
 570       fail_continue(&quot;Failed to open shared archive file (%s).&quot;,
 571                     os::strerror(errno));
 572     }
 573     return false;
 574   }
 575 
 576   _fd = fd;
 577   _file_open = true;
 578   return true;
 579 }
 580 
 581 
 582 // Write the FileMapInfo information to the file.
 583 
 584 void FileMapInfo::open_for_write() {
 585   _full_path = Arguments::GetSharedArchivePath();
 586   LogMessage(cds) msg;
 587   if (msg.is_info()) {
 588     msg.info(&quot;Dumping shared data to file: &quot;);
 589     msg.info(&quot;   %s&quot;, _full_path);
 590   }
 591 
 592 #ifdef _WINDOWS  // On Windows, need WRITE permission to remove the file.
 593   chmod(_full_path, _S_IREAD | _S_IWRITE);
 594 #endif
 595 
 596   // Use remove() to delete the existing file because, on Unix, this will
 597   // allow processes that have it open continued access to the file.
 598   remove(_full_path);
 599   int fd = os::open(_full_path, O_RDWR | O_CREAT | O_TRUNC | O_BINARY, 0444);
 600   if (fd &lt; 0) {
 601     fail_stop(&quot;Unable to create shared archive file %s: (%s).&quot;, _full_path,
 602               os::strerror(errno));
 603   }
 604   _fd = fd;
 605   _file_offset = 0;
 606   _file_open = true;
 607 }
 608 
 609 
 610 // Write the header to the file, seek to the next allocation boundary.
 611 
 612 void FileMapInfo::write_header() {
 613   int info_size = ClassLoader::get_shared_paths_misc_info_size();
 614 
 615   _header-&gt;_paths_misc_info_size = info_size;
 616 
 617   align_file_position();
 618   write_bytes(_header, sizeof(FileMapHeader));
 619   write_bytes(ClassLoader::get_shared_paths_misc_info(), (size_t)info_size);
 620   align_file_position();
 621 }
 622 
 623 
 624 // Dump region to file.
 625 
 626 void FileMapInfo::write_region(int region, char* base, size_t size,
 627                                bool read_only, bool allow_exec) {
 628   CDSFileMapRegion* si = space_at(region);
 629 
 630   if (_file_open) {
 631     guarantee(si-&gt;_file_offset == _file_offset, &quot;file offset mismatch.&quot;);
 632     log_info(cds)(&quot;Shared file region %d: &quot; SIZE_FORMAT_HEX_W(08)
 633                   &quot; bytes, addr &quot; INTPTR_FORMAT &quot; file offset &quot; SIZE_FORMAT_HEX_W(08),
 634                   region, size, p2i(base), _file_offset);
 635   } else {
 636     si-&gt;_file_offset = _file_offset;
 637   }
 638   if (HeapShared::is_heap_region(region)) {
 639     assert((base - (char*)Universe::narrow_oop_base()) % HeapWordSize == 0, &quot;Sanity&quot;);
 640     if (base != NULL) {
 641       si-&gt;_addr._offset = (intx)CompressedOops::encode_not_null((oop)base);
 642     } else {
 643       si-&gt;_addr._offset = 0;
 644     }
 645   } else {
 646     si-&gt;_addr._base = base;
 647   }
 648   si-&gt;_used = size;
 649   si-&gt;_read_only = read_only;
 650   si-&gt;_allow_exec = allow_exec;
 651   si-&gt;_crc = ClassLoader::crc32(0, base, (jint)size);
 652   if (base != NULL) {
 653     write_bytes_aligned(base, size);
 654   }
 655 }
 656 
 657 // Write out the given archive heap memory regions.  GC code combines multiple
 658 // consecutive archive GC regions into one MemRegion whenever possible and
 659 // produces the &#39;heap_mem&#39; array.
 660 //
 661 // If the archive heap memory size is smaller than a single dump time GC region
 662 // size, there is only one MemRegion in the array.
 663 //
 664 // If the archive heap memory size is bigger than one dump time GC region size,
 665 // the &#39;heap_mem&#39; array may contain more than one consolidated MemRegions. When
 666 // the first/bottom archive GC region is a partial GC region (with the empty
 667 // portion at the higher address within the region), one MemRegion is used for
 668 // the bottom partial archive GC region. The rest of the consecutive archive
 669 // GC regions are combined into another MemRegion.
 670 //
 671 // Here&#39;s the mapping from (archive heap GC regions) -&gt; (GrowableArray&lt;MemRegion&gt; *regions).
 672 //   + We have 1 or more archive heap regions: ah0, ah1, ah2 ..... ahn
 673 //   + We have 1 or 2 consolidated heap memory regions: r0 and r1
 674 //
 675 // If there&#39;s a single archive GC region (ah0), then r0 == ah0, and r1 is empty.
 676 // Otherwise:
 677 //
 678 // &quot;X&quot; represented space that&#39;s occupied by heap objects.
 679 // &quot;_&quot; represented unused spaced in the heap region.
 680 //
 681 //
 682 //    |ah0       | ah1 | ah2| ...... | ahn|
 683 //    |XXXXXX|__ |XXXXX|XXXX|XXXXXXXX|XXXX|
 684 //    |&lt;-r0-&gt;|   |&lt;- r1 -----------------&gt;|
 685 //            ^^^
 686 //             |
 687 //             +-- gap
 688 size_t FileMapInfo::write_archive_heap_regions(GrowableArray&lt;MemRegion&gt; *heap_mem,
 689                                                GrowableArray&lt;ArchiveHeapOopmapInfo&gt; *oopmaps,
 690                                                int first_region_id, int max_num_regions,
 691                                                bool print_log) {
 692   assert(max_num_regions &lt;= 2, &quot;Only support maximum 2 memory regions&quot;);
 693 
 694   int arr_len = heap_mem == NULL ? 0 : heap_mem-&gt;length();
 695   if(arr_len &gt; max_num_regions) {
 696     fail_stop(&quot;Unable to write archive heap memory regions: &quot;
 697               &quot;number of memory regions exceeds maximum due to fragmentation. &quot;
 698               &quot;Please increase java heap size &quot;
 699               &quot;(current MaxHeapSize is &quot; SIZE_FORMAT &quot;, InitialHeapSize is &quot; SIZE_FORMAT &quot;).&quot;,
 700               MaxHeapSize, InitialHeapSize);
 701   }
 702 
 703   size_t total_size = 0;
 704   for (int i = first_region_id, arr_idx = 0;
 705            i &lt; first_region_id + max_num_regions;
 706            i++, arr_idx++) {
 707     char* start = NULL;
 708     size_t size = 0;
 709     if (arr_idx &lt; arr_len) {
 710       start = (char*)heap_mem-&gt;at(arr_idx).start();
 711       size = heap_mem-&gt;at(arr_idx).byte_size();
 712       total_size += size;
 713     }
 714 
 715     if (print_log) {
 716       log_info(cds)(&quot;Archive heap region %d &quot; INTPTR_FORMAT &quot; - &quot; INTPTR_FORMAT &quot; = &quot; SIZE_FORMAT_W(8) &quot; bytes&quot;,
 717                     i, p2i(start), p2i(start + size), size);
 718     }
 719     write_region(i, start, size, false, false);
 720     if (size &gt; 0) {
 721       space_at(i)-&gt;_oopmap = oopmaps-&gt;at(arr_idx)._oopmap;
 722       space_at(i)-&gt;_oopmap_size_in_bits = oopmaps-&gt;at(arr_idx)._oopmap_size_in_bits;
 723     }
 724   }
 725   return total_size;
 726 }
 727 
 728 // Dump bytes to file -- at the current file position.
 729 
 730 void FileMapInfo::write_bytes(const void* buffer, size_t nbytes) {
 731   if (_file_open) {
 732     size_t n = os::write(_fd, buffer, (unsigned int)nbytes);
 733     if (n != nbytes) {
 734       // It is dangerous to leave the corrupted shared archive file around,
 735       // close and remove the file. See bug 6372906.
 736       close();
 737       remove(_full_path);
 738       fail_stop(&quot;Unable to write to shared archive file.&quot;);
 739     }
 740   }
 741   _file_offset += nbytes;
 742 }
 743 
 744 
 745 // Align file position to an allocation unit boundary.
 746 
 747 void FileMapInfo::align_file_position() {
 748   size_t new_file_offset = align_up(_file_offset,
 749                                          os::vm_allocation_granularity());
 750   if (new_file_offset != _file_offset) {
 751     _file_offset = new_file_offset;
 752     if (_file_open) {
 753       // Seek one byte back from the target and write a byte to insure
 754       // that the written file is the correct length.
 755       _file_offset -= 1;
 756       if (lseek(_fd, (long)_file_offset, SEEK_SET) &lt; 0) {
 757         fail_stop(&quot;Unable to seek.&quot;);
 758       }
 759       char zero = 0;
 760       write_bytes(&amp;zero, 1);
 761     }
 762   }
 763 }
 764 
 765 
 766 // Dump bytes to file -- at the current file position.
 767 
 768 void FileMapInfo::write_bytes_aligned(const void* buffer, size_t nbytes) {
 769   align_file_position();
 770   write_bytes(buffer, nbytes);
 771   align_file_position();
 772 }
 773 
 774 
 775 // Close the shared archive file.  This does NOT unmap mapped regions.
 776 
 777 void FileMapInfo::close() {
 778   if (_file_open) {
 779     if (::close(_fd) &lt; 0) {
 780       fail_stop(&quot;Unable to close the shared archive file.&quot;);
 781     }
 782     _file_open = false;
 783     _fd = -1;
 784   }
 785 }
 786 
 787 
 788 // JVM/TI RedefineClasses() support:
 789 // Remap the shared readonly space to shared readwrite, private.
 790 bool FileMapInfo::remap_shared_readonly_as_readwrite() {
 791   int idx = MetaspaceShared::ro;
 792   CDSFileMapRegion* si = space_at(idx);
 793   if (!si-&gt;_read_only) {
 794     // the space is already readwrite so we are done
 795     return true;
 796   }
 797   size_t used = si-&gt;_used;
 798   size_t size = align_up(used, os::vm_allocation_granularity());
 799   if (!open_for_read()) {
 800     return false;
 801   }
 802   char *addr = region_addr(idx);
 803   char *base = os::remap_memory(_fd, _full_path, si-&gt;_file_offset,
 804                                 addr, size, false /* !read_only */,
 805                                 si-&gt;_allow_exec);
 806   close();
 807   if (base == NULL) {
 808     fail_continue(&quot;Unable to remap shared readonly space (errno=%d).&quot;, errno);
 809     return false;
 810   }
 811   if (base != addr) {
 812     fail_continue(&quot;Unable to remap shared readonly space at required address.&quot;);
 813     return false;
 814   }
 815   si-&gt;_read_only = false;
 816   return true;
 817 }
 818 
 819 // Map the whole region at once, assumed to be allocated contiguously.
 820 ReservedSpace FileMapInfo::reserve_shared_memory() {
 821   char* requested_addr = region_addr(0);
 822   size_t size = FileMapInfo::core_spaces_size();
 823 
 824   // Reserve the space first, then map otherwise map will go right over some
 825   // other reserved memory (like the code cache).
 826   ReservedSpace rs(size, os::vm_allocation_granularity(), false, requested_addr);
 827   if (!rs.is_reserved()) {
 828     fail_continue(&quot;Unable to reserve shared space at required address &quot;
 829                   INTPTR_FORMAT, p2i(requested_addr));
 830     return rs;
 831   }
 832   // the reserved virtual memory is for mapping class data sharing archive
 833   MemTracker::record_virtual_memory_type((address)rs.base(), mtClassShared);
 834 
 835   return rs;
 836 }
 837 
 838 // Memory map a region in the address space.
 839 static const char* shared_region_name[] = { &quot;MiscData&quot;, &quot;ReadWrite&quot;, &quot;ReadOnly&quot;, &quot;MiscCode&quot;, &quot;OptionalData&quot;,
 840                                             &quot;String1&quot;, &quot;String2&quot;, &quot;OpenArchive1&quot;, &quot;OpenArchive2&quot; };
 841 
 842 char* FileMapInfo::map_region(int i, char** top_ret) {
 843   assert(!HeapShared::is_heap_region(i), &quot;sanity&quot;);
 844   CDSFileMapRegion* si = space_at(i);
 845   size_t used = si-&gt;_used;
 846   size_t alignment = os::vm_allocation_granularity();
 847   size_t size = align_up(used, alignment);
 848   char *requested_addr = region_addr(i);
 849 
 850   // If a tool agent is in use (debugging enabled), we must map the address space RW
 851   if (JvmtiExport::can_modify_any_class() || JvmtiExport::can_walk_any_space()) {
 852     si-&gt;_read_only = false;
 853   }
 854 
 855   // map the contents of the CDS archive in this memory
 856   char *base = os::map_memory(_fd, _full_path, si-&gt;_file_offset,
 857                               requested_addr, size, si-&gt;_read_only,
 858                               si-&gt;_allow_exec);
 859   if (base == NULL || base != requested_addr) {
 860     fail_continue(&quot;Unable to map %s shared space at required address.&quot;, shared_region_name[i]);
 861     return NULL;
 862   }
 863 #ifdef _WINDOWS
 864   // This call is Windows-only because the memory_type gets recorded for the other platforms
 865   // in method FileMapInfo::reserve_shared_memory(), which is not called on Windows.
 866   MemTracker::record_virtual_memory_type((address)base, mtClassShared);
 867 #endif
 868 
 869 
 870   if (!verify_region_checksum(i)) {
 871     return NULL;
 872   }
 873 
 874   *top_ret = base + size;
 875   return base;
 876 }
 877 
 878 address FileMapInfo::decode_start_address(CDSFileMapRegion* spc, bool with_current_oop_encoding_mode) {
 879   if (with_current_oop_encoding_mode) {
 880     return (address)CompressedOops::decode_not_null(offset_of_space(spc));
 881   } else {
 882     return (address)HeapShared::decode_from_archive(offset_of_space(spc));
 883   }
 884 }
 885 
 886 static MemRegion *closed_archive_heap_ranges = NULL;
 887 static MemRegion *open_archive_heap_ranges = NULL;
 888 static int num_closed_archive_heap_ranges = 0;
 889 static int num_open_archive_heap_ranges = 0;
 890 
 891 #if INCLUDE_CDS_JAVA_HEAP
 892 bool FileMapInfo::has_heap_regions() {
 893   return (_header-&gt;_space[MetaspaceShared::first_closed_archive_heap_region]._used &gt; 0);
 894 }
 895 
 896 // Returns the address range of the archived heap regions computed using the
 897 // current oop encoding mode. This range may be different than the one seen at
 898 // dump time due to encoding mode differences. The result is used in determining
 899 // if/how these regions should be relocated at run time.
 900 MemRegion FileMapInfo::get_heap_regions_range_with_current_oop_encoding_mode() {
 901   address start = (address) max_uintx;
 902   address end   = NULL;
 903 
 904   for (int i = MetaspaceShared::first_closed_archive_heap_region;
 905            i &lt;= MetaspaceShared::last_valid_region;
 906            i++) {
 907     CDSFileMapRegion* si = space_at(i);
 908     size_t size = si-&gt;_used;
 909     if (size &gt; 0) {
 910       address s = start_address_as_decoded_with_current_oop_encoding_mode(si);
 911       address e = s + size;
 912       if (start &gt; s) {
 913         start = s;
 914       }
 915       if (end &lt; e) {
 916         end = e;
 917       }
 918     }
 919   }
 920   assert(end != NULL, &quot;must have at least one used heap region&quot;);
 921   return MemRegion((HeapWord*)start, (HeapWord*)end);
 922 }
 923 
 924 //
 925 // Map the closed and open archive heap objects to the runtime java heap.
 926 //
 927 // The shared objects are mapped at (or close to ) the java heap top in
 928 // closed archive regions. The mapped objects contain no out-going
 929 // references to any other java heap regions. GC does not write into the
 930 // mapped closed archive heap region.
 931 //
 932 // The open archive heap objects are mapped below the shared objects in
 933 // the runtime java heap. The mapped open archive heap data only contains
 934 // references to the shared objects and open archive objects initially.
 935 // During runtime execution, out-going references to any other java heap
 936 // regions may be added. GC may mark and update references in the mapped
 937 // open archive objects.
 938 void FileMapInfo::map_heap_regions_impl() {
 939   if (!HeapShared::is_heap_object_archiving_allowed()) {
 940     log_info(cds)(&quot;CDS heap data is being ignored. UseG1GC, &quot;
 941                   &quot;UseCompressedOops and UseCompressedClassPointers are required.&quot;);
 942     return;
 943   }
 944 
 945   if (JvmtiExport::should_post_class_file_load_hook() &amp;&amp; JvmtiExport::has_early_class_hook_env()) {
 946     ShouldNotReachHere(); // CDS should have been disabled.
 947     // The archived objects are mapped at JVM start-up, but we don&#39;t know if
 948     // j.l.String or j.l.Class might be replaced by the ClassFileLoadHook,
 949     // which would make the archived String or mirror objects invalid. Let&#39;s be safe and not
 950     // use the archived objects. These 2 classes are loaded during the JVMTI &quot;early&quot; stage.
 951     //
 952     // If JvmtiExport::has_early_class_hook_env() is false, the classes of some objects
 953     // in the archived subgraphs may be replaced by the ClassFileLoadHook. But that&#39;s OK
 954     // because we won&#39;t install an archived object subgraph if the klass of any of the
 955     // referenced objects are replaced. See HeapShared::initialize_from_archived_subgraph().
 956   }
 957 
 958   MemRegion heap_reserved = Universe::heap()-&gt;reserved_region();
 959 
 960   log_info(cds)(&quot;CDS archive was created with max heap size = &quot; SIZE_FORMAT &quot;M, and the following configuration:&quot;,
 961                 max_heap_size()/M);
 962   log_info(cds)(&quot;    narrow_klass_base = &quot; PTR_FORMAT &quot;, narrow_klass_shift = %d&quot;,
 963                 p2i(narrow_klass_base()), narrow_klass_shift());
 964   log_info(cds)(&quot;    narrow_oop_mode = %d, narrow_oop_base = &quot; PTR_FORMAT &quot;, narrow_oop_shift = %d&quot;,
 965                 narrow_oop_mode(), p2i(narrow_oop_base()), narrow_oop_shift());
 966 
 967   log_info(cds)(&quot;The current max heap size = &quot; SIZE_FORMAT &quot;M, HeapRegion::GrainBytes = &quot; SIZE_FORMAT,
 968                 heap_reserved.byte_size()/M, HeapRegion::GrainBytes);
 969   log_info(cds)(&quot;    narrow_klass_base = &quot; PTR_FORMAT &quot;, narrow_klass_shift = %d&quot;,
 970                 p2i(Universe::narrow_klass_base()), Universe::narrow_klass_shift());
 971   log_info(cds)(&quot;    narrow_oop_mode = %d, narrow_oop_base = &quot; PTR_FORMAT &quot;, narrow_oop_shift = %d&quot;,
 972                 Universe::narrow_oop_mode(), p2i(Universe::narrow_oop_base()), Universe::narrow_oop_shift());
 973 
 974   if (narrow_klass_base() != Universe::narrow_klass_base() ||
 975       narrow_klass_shift() != Universe::narrow_klass_shift()) {
 976     log_info(cds)(&quot;CDS heap data cannot be used because the archive was created with an incompatible narrow klass encoding mode.&quot;);
 977     return;
 978   }
 979 
 980   if (narrow_oop_mode() != Universe::narrow_oop_mode() ||
 981       narrow_oop_base() != Universe::narrow_oop_base() ||
 982       narrow_oop_shift() != Universe::narrow_oop_shift()) {
 983     log_info(cds)(&quot;CDS heap data need to be relocated because the archive was created with an incompatible oop encoding mode.&quot;);
 984     _heap_pointers_need_patching = true;
 985   } else {
 986     MemRegion range = get_heap_regions_range_with_current_oop_encoding_mode();
 987     if (!heap_reserved.contains(range)) {
 988       log_info(cds)(&quot;CDS heap data need to be relocated because&quot;);
 989       log_info(cds)(&quot;the desired range &quot; PTR_FORMAT &quot; - &quot;  PTR_FORMAT, p2i(range.start()), p2i(range.end()));
 990       log_info(cds)(&quot;is outside of the heap &quot; PTR_FORMAT &quot; - &quot;  PTR_FORMAT, p2i(heap_reserved.start()), p2i(heap_reserved.end()));
 991       _heap_pointers_need_patching = true;
 992     }
 993   }
 994 
 995   ptrdiff_t delta = 0;
 996   if (_heap_pointers_need_patching) {
 997     //   dumptime heap end  ------------v
 998     //   [      |archived heap regions| ]         runtime heap end ------v
 999     //                                       [   |archived heap regions| ]
1000     //                                  |&lt;-----delta--------------------&gt;|
1001     //
1002     // At dump time, the archived heap regions were near the top of the heap.
1003     // At run time, they may not be inside the heap, so we move them so
1004     // that they are now near the top of the runtime time. This can be done by
1005     // the simple math of adding the delta as shown above.
1006     address dumptime_heap_end = (address)_header-&gt;_heap_reserved.end();
1007     address runtime_heap_end = (address)heap_reserved.end();
1008     delta = runtime_heap_end - dumptime_heap_end;
1009   }
1010 
1011   log_info(cds)(&quot;CDS heap data relocation delta = &quot; INTX_FORMAT &quot; bytes&quot;, delta);
1012   HeapShared::init_narrow_oop_decoding(narrow_oop_base() + delta, narrow_oop_shift());
1013 
1014   CDSFileMapRegion* si = space_at(MetaspaceShared::first_closed_archive_heap_region);
1015   address relocated_closed_heap_region_bottom = start_address_as_decoded_from_archive(si);
1016   if (!is_aligned(relocated_closed_heap_region_bottom, HeapRegion::GrainBytes)) {
1017     // Align the bottom of the closed archive heap regions at G1 region boundary.
1018     // This will avoid the situation where the highest open region and the lowest
1019     // closed region sharing the same G1 region. Otherwise we will fail to map the
1020     // open regions.
1021     size_t align = size_t(relocated_closed_heap_region_bottom) % HeapRegion::GrainBytes;
1022     delta -= align;
1023     log_info(cds)(&quot;CDS heap data need to be relocated lower by a further &quot; SIZE_FORMAT
1024                   &quot; bytes to &quot; INTX_FORMAT &quot; to be aligned with HeapRegion::GrainBytes&quot;,
1025                   align, delta);
1026     HeapShared::init_narrow_oop_decoding(narrow_oop_base() + delta, narrow_oop_shift());
1027     _heap_pointers_need_patching = true;
1028     relocated_closed_heap_region_bottom = start_address_as_decoded_from_archive(si);
1029   }
1030   assert(is_aligned(relocated_closed_heap_region_bottom, HeapRegion::GrainBytes),
1031          &quot;must be&quot;);
1032 
1033   // Map the closed_archive_heap regions, GC does not write into the regions.
1034   if (map_heap_data(&amp;closed_archive_heap_ranges,
1035                     MetaspaceShared::first_closed_archive_heap_region,
1036                     MetaspaceShared::max_closed_archive_heap_region,
1037                     &amp;num_closed_archive_heap_ranges)) {
1038     HeapShared::set_closed_archive_heap_region_mapped();
1039 
1040     // Now, map open_archive heap regions, GC can write into the regions.
1041     if (map_heap_data(&amp;open_archive_heap_ranges,
1042                       MetaspaceShared::first_open_archive_heap_region,
1043                       MetaspaceShared::max_open_archive_heap_region,
1044                       &amp;num_open_archive_heap_ranges,
1045                       true /* open */)) {
1046       HeapShared::set_open_archive_heap_region_mapped();
1047     }
1048   }
1049 }
1050 
1051 void FileMapInfo::map_heap_regions() {
1052   if (has_heap_regions()) {
1053     map_heap_regions_impl();
1054   }
1055 
1056   if (!HeapShared::closed_archive_heap_region_mapped()) {
1057     assert(closed_archive_heap_ranges == NULL &amp;&amp;
1058            num_closed_archive_heap_ranges == 0, &quot;sanity&quot;);
1059   }
1060 
1061   if (!HeapShared::open_archive_heap_region_mapped()) {
1062     assert(open_archive_heap_ranges == NULL &amp;&amp; num_open_archive_heap_ranges == 0, &quot;sanity&quot;);
1063   }
1064 }
1065 
1066 bool FileMapInfo::map_heap_data(MemRegion **heap_mem, int first,
1067                                 int max, int* num, bool is_open_archive) {
1068   MemRegion * regions = new MemRegion[max];
1069   CDSFileMapRegion* si;
1070   int region_num = 0;
1071 
1072   for (int i = first;
1073            i &lt; first + max; i++) {
1074     si = space_at(i);
1075     size_t size = si-&gt;_used;
1076     if (size &gt; 0) {
1077       HeapWord* start = (HeapWord*)start_address_as_decoded_from_archive(si);
1078       regions[region_num] = MemRegion(start, size / HeapWordSize);
1079       region_num ++;
1080       log_info(cds)(&quot;Trying to map heap data: region[%d] at &quot; INTPTR_FORMAT &quot;, size = &quot; SIZE_FORMAT_W(8) &quot; bytes&quot;,
1081                     i, p2i(start), size);
1082     }
1083   }
1084 
1085   if (region_num == 0) {
1086     return false; // no archived java heap data
1087   }
1088 
1089   // Check that ranges are within the java heap
1090   if (!G1CollectedHeap::heap()-&gt;check_archive_addresses(regions, region_num)) {
1091     log_info(cds)(&quot;UseSharedSpaces: Unable to allocate region, range is not within java heap.&quot;);
1092     return false;
1093   }
1094 
1095   // allocate from java heap
1096   if (!G1CollectedHeap::heap()-&gt;alloc_archive_regions(
1097              regions, region_num, is_open_archive)) {
1098     log_info(cds)(&quot;UseSharedSpaces: Unable to allocate region, java heap range is already in use.&quot;);
1099     return false;
1100   }
1101 
1102   // Map the archived heap data. No need to call MemTracker::record_virtual_memory_type()
1103   // for mapped regions as they are part of the reserved java heap, which is
1104   // already recorded.
1105   for (int i = 0; i &lt; region_num; i++) {
1106     si = space_at(first + i);
1107     char* addr = (char*)regions[i].start();
1108     char* base = os::map_memory(_fd, _full_path, si-&gt;_file_offset,
1109                                 addr, regions[i].byte_size(), si-&gt;_read_only,
1110                                 si-&gt;_allow_exec);
1111     if (base == NULL || base != addr) {
1112       // dealloc the regions from java heap
1113       dealloc_archive_heap_regions(regions, region_num, is_open_archive);
1114       log_info(cds)(&quot;UseSharedSpaces: Unable to map at required address in java heap. &quot;
1115                     INTPTR_FORMAT &quot;, size = &quot; SIZE_FORMAT &quot; bytes&quot;,
1116                     p2i(addr), regions[i].byte_size());
1117       return false;
1118     }
1119   }
1120 
1121   if (!verify_mapped_heap_regions(first, region_num)) {
1122     // dealloc the regions from java heap
1123     dealloc_archive_heap_regions(regions, region_num, is_open_archive);
1124     log_info(cds)(&quot;UseSharedSpaces: mapped heap regions are corrupt&quot;);
1125     return false;
1126   }
1127 
1128   // the shared heap data is mapped successfully
1129   *heap_mem = regions;
1130   *num = region_num;
1131   return true;
1132 }
1133 
1134 bool FileMapInfo::verify_mapped_heap_regions(int first, int num) {
1135   assert(num &gt; 0, &quot;sanity&quot;);
1136   for (int i = first; i &lt; first + num; i++) {
1137     if (!verify_region_checksum(i)) {
1138       return false;
1139     }
1140   }
1141   return true;
1142 }
1143 
1144 void FileMapInfo::patch_archived_heap_embedded_pointers() {
1145   if (!_heap_pointers_need_patching) {
1146     return;
1147   }
1148 
1149   patch_archived_heap_embedded_pointers(closed_archive_heap_ranges,
1150                                         num_closed_archive_heap_ranges,
1151                                         MetaspaceShared::first_closed_archive_heap_region);
1152 
1153   patch_archived_heap_embedded_pointers(open_archive_heap_ranges,
1154                                         num_open_archive_heap_ranges,
1155                                         MetaspaceShared::first_open_archive_heap_region);
1156 }
1157 
1158 void FileMapInfo::patch_archived_heap_embedded_pointers(MemRegion* ranges, int num_ranges,
1159                                                         int first_region_idx) {
1160   for (int i=0; i&lt;num_ranges; i++) {
1161     CDSFileMapRegion* si = space_at(i + first_region_idx);
1162     HeapShared::patch_archived_heap_embedded_pointers(ranges[i], (address)si-&gt;_oopmap,
1163                                                       si-&gt;_oopmap_size_in_bits);
1164   }
1165 }
1166 
1167 // This internally allocates objects using SystemDictionary::Object_klass(), so it
1168 // must be called after the well-known classes are resolved.
1169 void FileMapInfo::fixup_mapped_heap_regions() {
1170   // If any closed regions were found, call the fill routine to make them parseable.
1171   // Note that closed_archive_heap_ranges may be non-NULL even if no ranges were found.
1172   if (num_closed_archive_heap_ranges != 0) {
1173     assert(closed_archive_heap_ranges != NULL,
1174            &quot;Null closed_archive_heap_ranges array with non-zero count&quot;);
1175     G1CollectedHeap::heap()-&gt;fill_archive_regions(closed_archive_heap_ranges,
1176                                                   num_closed_archive_heap_ranges);
1177   }
1178 
1179   // do the same for mapped open archive heap regions
1180   if (num_open_archive_heap_ranges != 0) {
1181     assert(open_archive_heap_ranges != NULL, &quot;NULL open_archive_heap_ranges array with non-zero count&quot;);
1182     G1CollectedHeap::heap()-&gt;fill_archive_regions(open_archive_heap_ranges,
1183                                                   num_open_archive_heap_ranges);
1184   }
1185 }
1186 
1187 // dealloc the archive regions from java heap
1188 void FileMapInfo::dealloc_archive_heap_regions(MemRegion* regions, int num, bool is_open) {
1189   if (num &gt; 0) {
1190     assert(regions != NULL, &quot;Null archive ranges array with non-zero count&quot;);
1191     G1CollectedHeap::heap()-&gt;dealloc_archive_regions(regions, num, is_open);
1192   }
1193 }
1194 #endif // INCLUDE_CDS_JAVA_HEAP
1195 
1196 bool FileMapInfo::verify_region_checksum(int i) {
1197   if (!VerifySharedSpaces) {
1198     return true;
1199   }
1200 
1201   size_t sz = space_at(i)-&gt;_used;
1202 
1203   if (sz == 0) {
1204     return true; // no data
1205   }
1206   if ((HeapShared::is_closed_archive_heap_region(i) &amp;&amp;
1207        !HeapShared::closed_archive_heap_region_mapped()) ||
1208       (HeapShared::is_open_archive_heap_region(i) &amp;&amp;
1209        !HeapShared::open_archive_heap_region_mapped())) {
1210     return true; // archived heap data is not mapped
1211   }
1212   const char* buf = region_addr(i);
1213   int crc = ClassLoader::crc32(0, buf, (jint)sz);
1214   if (crc != space_at(i)-&gt;_crc) {
1215     fail_continue(&quot;Checksum verification failed.&quot;);
1216     return false;
1217   }
1218   return true;
1219 }
1220 
1221 // Unmap a memory region in the address space.
1222 
1223 void FileMapInfo::unmap_region(int i) {
1224   assert(!HeapShared::is_heap_region(i), &quot;sanity&quot;);
1225   CDSFileMapRegion* si = space_at(i);
1226   size_t used = si-&gt;_used;
1227   size_t size = align_up(used, os::vm_allocation_granularity());
1228 
1229   if (used == 0) {
1230     return;
1231   }
1232 
1233   char* addr = region_addr(i);
1234   if (!os::unmap_memory(addr, size)) {
1235     fail_stop(&quot;Unable to unmap shared space.&quot;);
1236   }
1237 }
1238 
1239 void FileMapInfo::assert_mark(bool check) {
1240   if (!check) {
1241     fail_stop(&quot;Mark mismatch while restoring from shared file.&quot;);
1242   }
1243 }
1244 
1245 void FileMapInfo::metaspace_pointers_do(MetaspaceClosure* it) {
1246   it-&gt;push(&amp;_shared_path_table);
1247   for (int i=0; i&lt;_shared_path_table_size; i++) {
1248     shared_path(i)-&gt;metaspace_pointers_do(it);
1249   }
1250 }
1251 
1252 
1253 FileMapInfo* FileMapInfo::_current_info = NULL;
1254 bool FileMapInfo::_heap_pointers_need_patching = false;
1255 Array&lt;u8&gt;* FileMapInfo::_shared_path_table = NULL;
1256 int FileMapInfo::_shared_path_table_size = 0;
1257 size_t FileMapInfo::_shared_path_entry_size = 0x1234baad;
1258 bool FileMapInfo::_validating_shared_path_table = false;
1259 
1260 // Open the shared archive file, read and validate the header
1261 // information (version, boot classpath, etc.).  If initialization
1262 // fails, shared spaces are disabled and the file is closed. [See
1263 // fail_continue.]
1264 //
1265 // Validation of the archive is done in two steps:
1266 //
1267 // [1] validate_header() - done here. This checks the header, including _paths_misc_info.
1268 // [2] validate_shared_path_table - this is done later, because the table is in the RW
1269 //     region of the archive, which is not mapped yet.
1270 bool FileMapInfo::initialize() {
1271   assert(UseSharedSpaces, &quot;UseSharedSpaces expected.&quot;);
1272 
1273   if (JvmtiExport::should_post_class_file_load_hook() &amp;&amp; JvmtiExport::has_early_class_hook_env()) {
1274     // CDS assumes that no classes resolved in SystemDictionary::resolve_well_known_classes
1275     // are replaced at runtime by JVMTI ClassFileLoadHook. All of those classes are resolved
1276     // during the JVMTI &quot;early&quot; stage, so we can still use CDS if
1277     // JvmtiExport::has_early_class_hook_env() is false.
1278     FileMapInfo::fail_continue(&quot;CDS is disabled because early JVMTI ClassFileLoadHook is in use.&quot;);
1279     return false;
1280   }
1281 
1282   if (!open_for_read()) {
1283     return false;
1284   }
1285 
1286   init_from_file(_fd);
1287   if (!validate_header()) {
1288     return false;
1289   }
1290   return true;
1291 }
1292 
1293 char* FileMapInfo::region_addr(int idx) {
1294   CDSFileMapRegion* si = space_at(idx);
1295   if (HeapShared::is_heap_region(idx)) {
1296     assert(DumpSharedSpaces, &quot;The following doesn&#39;t work at runtime&quot;);
1297     return si-&gt;_used &gt; 0 ?
1298           (char*)start_address_as_decoded_with_current_oop_encoding_mode(si) : NULL;
1299   } else {
1300     return si-&gt;_addr._base;
1301   }
1302 }
1303 
1304 int FileMapHeader::compute_crc() {
1305   char* start = (char*)this;
1306   // start computing from the field after _crc
1307   char* buf = (char*)&amp;_crc + sizeof(_crc);
1308   size_t sz = sizeof(FileMapHeader) - (buf - start);
1309   int crc = ClassLoader::crc32(0, buf, (jint)sz);
1310   return crc;
1311 }
1312 
1313 // This function should only be called during run time with UseSharedSpaces enabled.
1314 bool FileMapHeader::validate() {
1315   if (VerifySharedSpaces &amp;&amp; compute_crc() != _crc) {
1316     FileMapInfo::fail_continue(&quot;Header checksum verification failed.&quot;);
1317     return false;
1318   }
1319 
1320   if (!Arguments::has_jimage()) {
1321     FileMapInfo::fail_continue(&quot;The shared archive file cannot be used with an exploded module build.&quot;);
1322     return false;
1323   }
1324 
1325   if (_version != CURRENT_CDS_ARCHIVE_VERSION) {
1326     FileMapInfo::fail_continue(&quot;The shared archive file is the wrong version.&quot;);
1327     return false;
1328   }
1329   if (_magic != CDS_ARCHIVE_MAGIC) {
1330     FileMapInfo::fail_continue(&quot;The shared archive file has a bad magic number.&quot;);
1331     return false;
1332   }
1333   char header_version[JVM_IDENT_MAX];
1334   get_header_version(header_version);
1335   if (strncmp(_jvm_ident, header_version, JVM_IDENT_MAX-1) != 0) {
1336     log_info(class, path)(&quot;expected: %s&quot;, header_version);
1337     log_info(class, path)(&quot;actual:   %s&quot;, _jvm_ident);
1338     FileMapInfo::fail_continue(&quot;The shared archive file was created by a different&quot;
1339                   &quot; version or build of HotSpot&quot;);
1340     return false;
1341   }
1342   if (_obj_alignment != ObjectAlignmentInBytes) {
1343     FileMapInfo::fail_continue(&quot;The shared archive file&#39;s ObjectAlignmentInBytes of %d&quot;
1344                   &quot; does not equal the current ObjectAlignmentInBytes of &quot; INTX_FORMAT &quot;.&quot;,
1345                   _obj_alignment, ObjectAlignmentInBytes);
1346     return false;
1347   }
1348   if (_compact_strings != CompactStrings) {
1349     FileMapInfo::fail_continue(&quot;The shared archive file&#39;s CompactStrings setting (%s)&quot;
1350                   &quot; does not equal the current CompactStrings setting (%s).&quot;,
1351                   _compact_strings ? &quot;enabled&quot; : &quot;disabled&quot;,
1352                   CompactStrings   ? &quot;enabled&quot; : &quot;disabled&quot;);
1353     return false;
1354   }
1355 
1356   // This must be done after header validation because it might change the
1357   // header data
1358   const char* prop = Arguments::get_property(&quot;java.system.class.loader&quot;);
1359   if (prop != NULL) {
1360     warning(&quot;Archived non-system classes are disabled because the &quot;
1361             &quot;java.system.class.loader property is specified (value = \&quot;%s\&quot;). &quot;
1362             &quot;To use archived non-system classes, this property must not be set&quot;, prop);
1363     _has_platform_or_app_classes = false;
1364   }
1365 
1366   // For backwards compatibility, we don&#39;t check the verification setting
1367   // if the archive only contains system classes.
1368   if (_has_platform_or_app_classes &amp;&amp;
1369       ((!_verify_local &amp;&amp; BytecodeVerificationLocal) ||
1370        (!_verify_remote &amp;&amp; BytecodeVerificationRemote))) {
1371     FileMapInfo::fail_continue(&quot;The shared archive file was created with less restrictive &quot;
1372                   &quot;verification setting than the current setting.&quot;);
1373     return false;
1374   }
1375 
1376   // Java agents are allowed during run time. Therefore, the following condition is not
1377   // checked: (!_allow_archiving_with_java_agent &amp;&amp; AllowArchivingWithJavaAgent)
1378   // Note: _allow_archiving_with_java_agent is set in the shared archive during dump time
1379   // while AllowArchivingWithJavaAgent is set during the current run.
1380   if (_allow_archiving_with_java_agent &amp;&amp; !AllowArchivingWithJavaAgent) {
1381     FileMapInfo::fail_continue(&quot;The setting of the AllowArchivingWithJavaAgent is different &quot;
1382                                &quot;from the setting in the shared archive.&quot;);
1383     return false;
1384   }
1385 
1386   if (_allow_archiving_with_java_agent) {
1387     warning(&quot;This archive was created with AllowArchivingWithJavaAgent. It should be used &quot;
1388             &quot;for testing purposes only and should not be used in a production environment&quot;);
1389   }
1390 
1391   return true;
1392 }
1393 
1394 bool FileMapInfo::validate_header() {
1395   bool status = _header-&gt;validate();
1396 
1397   if (status) {
1398     if (!ClassLoader::check_shared_paths_misc_info(_paths_misc_info, _header-&gt;_paths_misc_info_size)) {
1399       if (!PrintSharedArchiveAndExit) {
1400         fail_continue(&quot;shared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)&quot;);
1401         status = false;
1402       }
1403     }
1404   }
1405 
1406   if (_paths_misc_info != NULL) {
1407     FREE_C_HEAP_ARRAY(char, _paths_misc_info);
1408     _paths_misc_info = NULL;
1409   }
1410   return status;
1411 }
1412 
1413 // Check if a given address is within one of the shared regions
1414 bool FileMapInfo::is_in_shared_region(const void* p, int idx) {
1415   assert(idx == MetaspaceShared::ro ||
1416          idx == MetaspaceShared::rw ||
1417          idx == MetaspaceShared::mc ||
1418          idx == MetaspaceShared::md, &quot;invalid region index&quot;);
1419   char* base = region_addr(idx);
1420   if (p &gt;= base &amp;&amp; p &lt; base + space_at(idx)-&gt;_used) {
1421     return true;
1422   }
1423   return false;
1424 }
1425 
1426 // Unmap mapped regions of shared space.
1427 void FileMapInfo::stop_sharing_and_unmap(const char* msg) {
1428   MetaspaceObj::set_shared_metaspace_range(NULL, NULL);
1429 
1430   FileMapInfo *map_info = FileMapInfo::current_info();
1431   if (map_info) {
1432     map_info-&gt;fail_continue(&quot;%s&quot;, msg);
1433     for (int i = 0; i &lt; MetaspaceShared::num_non_heap_spaces; i++) {
1434       if (!HeapShared::is_heap_region(i)) {
1435         char *addr = map_info-&gt;region_addr(i);
1436         if (addr != NULL) {
1437           map_info-&gt;unmap_region(i);
1438           map_info-&gt;space_at(i)-&gt;_addr._base = NULL;
1439         }
1440       }
1441     }
1442     // Dealloc the archive heap regions only without unmapping. The regions are part
1443     // of the java heap. Unmapping of the heap regions are managed by GC.
1444     map_info-&gt;dealloc_archive_heap_regions(open_archive_heap_ranges,
1445                                            num_open_archive_heap_ranges,
1446                                            true);
1447     map_info-&gt;dealloc_archive_heap_regions(closed_archive_heap_ranges,
1448                                            num_closed_archive_heap_ranges,
1449                                            false);
1450   } else if (DumpSharedSpaces) {
1451     fail_stop(&quot;%s&quot;, msg);
1452   }
1453 }
1454 
1455 #if INCLUDE_JVMTI
1456 ClassPathEntry** FileMapInfo::_classpath_entries_for_jvmti = NULL;
1457 
1458 ClassPathEntry* FileMapInfo::get_classpath_entry_for_jvmti(int i, TRAPS) {
1459   ClassPathEntry* ent = _classpath_entries_for_jvmti[i];
1460   if (ent == NULL) {
1461     if (i == 0) {
1462       ent = ClassLoader:: get_jrt_entry();
1463       assert(ent != NULL, &quot;must be&quot;);
1464     } else {
1465       SharedClassPathEntry* scpe = shared_path(i);
1466       assert(scpe-&gt;is_jar(), &quot;must be&quot;); // other types of scpe will not produce archived classes
1467 
1468       const char* path = scpe-&gt;name();
1469       struct stat st;
1470       if (os::stat(path, &amp;st) != 0) {
1471         char *msg = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, strlen(path) + 128); ;
1472         jio_snprintf(msg, strlen(path) + 127, &quot;error in opening JAR file %s&quot;, path);
1473         THROW_MSG_(vmSymbols::java_io_IOException(), msg, NULL);
1474       } else {
1475         ent = ClassLoader::create_class_path_entry(path, &amp;st, /*throw_exception=*/true, false, CHECK_NULL);
1476       }
1477     }
1478 
1479     MutexLocker mu(CDSClassFileStream_lock, THREAD);
1480     if (_classpath_entries_for_jvmti[i] == NULL) {
1481       _classpath_entries_for_jvmti[i] = ent;
1482     } else {
1483       // Another thread has beat me to creating this entry
1484       delete ent;
1485       ent = _classpath_entries_for_jvmti[i];
1486     }
1487   }
1488 
1489   return ent;
1490 }
1491 
1492 ClassFileStream* FileMapInfo::open_stream_for_jvmti(InstanceKlass* ik, TRAPS) {
1493   int path_index = ik-&gt;shared_classpath_index();
1494   assert(path_index &gt;= 0, &quot;should be called for shared built-in classes only&quot;);
1495   assert(path_index &lt; (int)_shared_path_table_size, &quot;sanity&quot;);
1496 
1497   ClassPathEntry* cpe = get_classpath_entry_for_jvmti(path_index, CHECK_NULL);
1498   assert(cpe != NULL, &quot;must be&quot;);
1499 
1500   Symbol* name = ik-&gt;name();
1501   const char* const class_name = name-&gt;as_C_string();
1502   const char* const file_name = ClassLoader::file_name_for_class_name(class_name,
1503                                                                       name-&gt;utf8_length());
1504   return cpe-&gt;open_stream(file_name, THREAD);
1505 }
1506 
1507 #endif
    </pre>
  </body>
</html>