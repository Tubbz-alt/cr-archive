<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/memory/heapInspection.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="heap.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapInspection.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/heapInspection.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,29 +26,24 @@</span>
  #include &quot;classfile/classLoaderData.inline.hpp&quot;
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;classfile/moduleEntry.hpp&quot;
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;gc/shared/collectedHeap.hpp&quot;
<span class="udiff-line-added">+ #include &quot;logging/log.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;logging/logTag.hpp&quot;</span>
  #include &quot;memory/heapInspection.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;oops/reflectionAccessorImplKlassHelper.hpp&quot;
  #include &quot;runtime/os.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  #include &quot;utilities/stack.inline.hpp&quot;
  
  // HeapInspection
  
<span class="udiff-line-removed">- int KlassSizeStats::count(oop x) {</span>
<span class="udiff-line-removed">-   return (HeapWordSize * (((x) != NULL) ? (x)-&gt;size() : 0));</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- int KlassSizeStats::count_array(objArrayOop x) {</span>
<span class="udiff-line-removed">-   return (HeapWordSize * (((x) != NULL) ? (x)-&gt;size() : 0));</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  inline KlassInfoEntry::~KlassInfoEntry() {
    if (_subclasses != NULL) {
      delete _subclasses;
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,12 +64,12 @@</span>
    // Sort alphabetically, note &#39;Z&#39; &lt; &#39;[&#39; &lt; &#39;a&#39;, but it&#39;s better to group
    // the array classes before all the instance classes.
    ResourceMark rm;
    const char* name1 = e1-&gt;klass()-&gt;external_name();
    const char* name2 = e2-&gt;klass()-&gt;external_name();
<span class="udiff-line-modified-removed">-   bool d1 = (name1[0] == &#39;[&#39;);</span>
<span class="udiff-line-modified-removed">-   bool d2 = (name2[0] == &#39;[&#39;);</span>
<span class="udiff-line-modified-added">+   bool d1 = (name1[0] == JVM_SIGNATURE_ARRAY);</span>
<span class="udiff-line-modified-added">+   bool d2 = (name2[0] == JVM_SIGNATURE_ARRAY);</span>
    if (d1 &amp;&amp; !d2) {
      return -1;
    } else if (d2 &amp;&amp; !d1) {
      return 1;
    } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,10 +114,15 @@</span>
                   name());
    }
  }
  
  KlassInfoEntry* KlassInfoBucket::lookup(Klass* const k) {
<span class="udiff-line-added">+   // Can happen if k is an archived class that we haven&#39;t loaded yet.</span>
<span class="udiff-line-added">+   if (k-&gt;java_mirror_no_keepalive() == NULL) {</span>
<span class="udiff-line-added">+     return NULL;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    KlassInfoEntry* elt = _list;
    while (elt != NULL) {
      if (elt-&gt;is_equal(k)) {
        return elt;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -200,11 +200,12 @@</span>
  KlassInfoEntry* KlassInfoTable::lookup(Klass* k) {
    uint         idx = hash(k) % _num_buckets;
    assert(_buckets != NULL, &quot;Allocation failure should have been caught&quot;);
    KlassInfoEntry*  e   = _buckets[idx].lookup(k);
    // Lookup may fail if this is a new klass for which we
<span class="udiff-line-modified-removed">-   // could not allocate space for an new entry.</span>
<span class="udiff-line-modified-added">+   // could not allocate space for an new entry, or if it&#39;s</span>
<span class="udiff-line-added">+   // an archived class that we haven&#39;t loaded yet.</span>
    assert(e == NULL || k == e-&gt;klass(), &quot;must be equal&quot;);
    return e;
  }
  
  // Return false if the entry could not be recorded on account
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -268,71 +269,10 @@</span>
    }
    st-&gt;print_cr(&quot;Total &quot; INT64_FORMAT_W(13) &quot;  &quot; UINT64_FORMAT_W(13),
                 total, totalw * HeapWordSize);
  }
  
<span class="udiff-line-removed">- #define MAKE_COL_NAME(field, name, help)     #name,</span>
<span class="udiff-line-removed">- #define MAKE_COL_HELP(field, name, help)     help,</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const char *name_table[] = {</span>
<span class="udiff-line-removed">-   HEAP_INSPECTION_COLUMNS_DO(MAKE_COL_NAME)</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const char *help_table[] = {</span>
<span class="udiff-line-removed">-   HEAP_INSPECTION_COLUMNS_DO(MAKE_COL_HELP)</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool KlassInfoHisto::is_selected(const char *col_name) {</span>
<span class="udiff-line-removed">-   if (_selected_columns == NULL) {</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (strcmp(_selected_columns, col_name) == 0) {</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   const char *start = strstr(_selected_columns, col_name);</span>
<span class="udiff-line-removed">-   if (start == NULL) {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // The following must be true, because _selected_columns != col_name</span>
<span class="udiff-line-removed">-   if (start &gt; _selected_columns &amp;&amp; start[-1] != &#39;,&#39;) {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   char x = start[strlen(col_name)];</span>
<span class="udiff-line-removed">-   if (x != &#39;,&#39; &amp;&amp; x != &#39;\0&#39;) {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void KlassInfoHisto::print_title(outputStream* st, bool csv_format,</span>
<span class="udiff-line-removed">-                                  bool selected[], int width_table[],</span>
<span class="udiff-line-removed">-                                  const char *name_table[]) {</span>
<span class="udiff-line-removed">-   if (csv_format) {</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;Index,Super&quot;);</span>
<span class="udiff-line-removed">-     for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-        if (selected[c]) {st-&gt;print(&quot;,%s&quot;, name_table[c]);}</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;,ClassName&quot;);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;Index Super&quot;);</span>
<span class="udiff-line-removed">-     for (int c = 0; c &lt; KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-       if (selected[c]) {</span>
<span class="udiff-line-removed">-         st-&gt;print(&quot;%*s&quot;, width_table[c], name_table[c]);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot; ClassName&quot;);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (is_selected(&quot;ClassLoader&quot;)) {</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;,ClassLoader&quot;);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   st-&gt;cr();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  class HierarchyClosure : public KlassInfoClosure {
  private:
    GrowableArray&lt;KlassInfoEntry*&gt; *_elements;
  public:
    HierarchyClosure(GrowableArray&lt;KlassInfoEntry*&gt; *_elements) : _elements(_elements) {}
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -519,159 +459,14 @@</span>
        }
      }
    }
  }
  
<span class="udiff-line-modified-removed">- void KlassInfoHisto::print_class_stats(outputStream* st,</span>
<span class="udiff-line-modified-removed">-                                       bool csv_format, const char *columns) {</span>
<span class="udiff-line-modified-removed">-   ResourceMark rm;</span>
<span class="udiff-line-modified-removed">-   KlassSizeStats sz, sz_sum;</span>
<span class="udiff-line-removed">-   int i;</span>
<span class="udiff-line-removed">-   julong *col_table = (julong*)(&amp;sz);</span>
<span class="udiff-line-removed">-   julong *colsum_table = (julong*)(&amp;sz_sum);</span>
<span class="udiff-line-removed">-   int width_table[KlassSizeStats::_num_columns];</span>
<span class="udiff-line-removed">-   bool selected[KlassSizeStats::_num_columns];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   _selected_columns = columns;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   memset(&amp;sz_sum, 0, sizeof(sz_sum));</span>
<span class="udiff-line-removed">-   for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-     selected[c] = is_selected(name_table[c]);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   for(i=0; i &lt; elements()-&gt;length(); i++) {</span>
<span class="udiff-line-removed">-     elements()-&gt;at(i)-&gt;set_index(i+1);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // First iteration is for accumulating stats totals in colsum_table[].</span>
<span class="udiff-line-removed">-   // Second iteration is for printing stats for each class.</span>
<span class="udiff-line-removed">-   for (int pass=1; pass&lt;=2; pass++) {</span>
<span class="udiff-line-removed">-     if (pass == 2) {</span>
<span class="udiff-line-removed">-       print_title(st, csv_format, selected, width_table, name_table);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     for(i=0; i &lt; elements()-&gt;length(); i++) {</span>
<span class="udiff-line-removed">-       KlassInfoEntry* e = (KlassInfoEntry*)elements()-&gt;at(i);</span>
<span class="udiff-line-removed">-       const Klass* k = e-&gt;klass();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       // Get the stats for this class.</span>
<span class="udiff-line-removed">-       memset(&amp;sz, 0, sizeof(sz));</span>
<span class="udiff-line-removed">-       sz._inst_count = e-&gt;count();</span>
<span class="udiff-line-removed">-       sz._inst_bytes = HeapWordSize * e-&gt;words();</span>
<span class="udiff-line-removed">-       k-&gt;collect_statistics(&amp;sz);</span>
<span class="udiff-line-removed">-       sz._total_bytes = sz._ro_bytes + sz._rw_bytes;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (pass == 1) {</span>
<span class="udiff-line-removed">-         // Add the stats for this class to the overall totals.</span>
<span class="udiff-line-removed">-         for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-           colsum_table[c] += col_table[c];</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       } else {</span>
<span class="udiff-line-removed">-         int super_index = -1;</span>
<span class="udiff-line-removed">-         // Print the stats for this class.</span>
<span class="udiff-line-removed">-         if (k-&gt;is_instance_klass()) {</span>
<span class="udiff-line-removed">-           Klass* super = k-&gt;super();</span>
<span class="udiff-line-removed">-           if (super) {</span>
<span class="udiff-line-removed">-             KlassInfoEntry* super_e = _cit-&gt;lookup(super);</span>
<span class="udiff-line-removed">-             if (super_e) {</span>
<span class="udiff-line-removed">-               super_index = super_e-&gt;index();</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (csv_format) {</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;%ld,%d&quot;, e-&gt;index(), super_index);</span>
<span class="udiff-line-removed">-           for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-             if (selected[c]) {st-&gt;print(&quot;,&quot; JULONG_FORMAT, col_table[c]);}</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;,%s&quot;,e-&gt;name());</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;%5ld %5d&quot;, e-&gt;index(), super_index);</span>
<span class="udiff-line-removed">-           for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-             if (selected[c]) {print_julong(st, width_table[c], col_table[c]);}</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot; %s&quot;, e-&gt;name());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (is_selected(&quot;ClassLoader&quot;)) {</span>
<span class="udiff-line-removed">-           ClassLoaderData* loader_data = k-&gt;class_loader_data();</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;,&quot;);</span>
<span class="udiff-line-removed">-           loader_data-&gt;print_value_on(st);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         st-&gt;cr();</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (pass == 1) {</span>
<span class="udiff-line-removed">-       // Calculate the minimum width needed for the column by accounting for the</span>
<span class="udiff-line-removed">-       // column header width and the width of the largest value in the column.</span>
<span class="udiff-line-removed">-       for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-         width_table[c] = col_width(colsum_table[c], name_table[c]);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   sz_sum._inst_size = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Print the column totals.</span>
<span class="udiff-line-removed">-   if (csv_format) {</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;,&quot;);</span>
<span class="udiff-line-removed">-     for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-       if (selected[c]) {st-&gt;print(&quot;,&quot; JULONG_FORMAT, colsum_table[c]);}</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot;           &quot;);</span>
<span class="udiff-line-removed">-     for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-       if (selected[c]) {print_julong(st, width_table[c], colsum_table[c]);}</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     st-&gt;print(&quot; Total&quot;);</span>
<span class="udiff-line-removed">-     if (sz_sum._total_bytes &gt; 0) {</span>
<span class="udiff-line-removed">-       st-&gt;cr();</span>
<span class="udiff-line-removed">-       st-&gt;print(&quot;           &quot;);</span>
<span class="udiff-line-removed">-       for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-         if (selected[c]) {</span>
<span class="udiff-line-removed">-           switch (c) {</span>
<span class="udiff-line-removed">-           case KlassSizeStats::_index_inst_size:</span>
<span class="udiff-line-removed">-           case KlassSizeStats::_index_inst_count:</span>
<span class="udiff-line-removed">-           case KlassSizeStats::_index_method_count:</span>
<span class="udiff-line-removed">-             st-&gt;print(&quot;%*s&quot;, width_table[c], &quot;-&quot;);</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-           default:</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-               double perc = (double)(100) * (double)(colsum_table[c]) / (double)sz_sum._total_bytes;</span>
<span class="udiff-line-removed">-               st-&gt;print(&quot;%*.1f%%&quot;, width_table[c]-1, perc);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   st-&gt;cr();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (!csv_format) {</span>
<span class="udiff-line-removed">-     print_title(st, csv_format, selected, width_table, name_table);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- julong KlassInfoHisto::annotations_bytes(Array&lt;AnnotationArray*&gt;* p) const {</span>
<span class="udiff-line-removed">-   julong bytes = 0;</span>
<span class="udiff-line-removed">-   if (p != NULL) {</span>
<span class="udiff-line-removed">-     for (int i = 0; i &lt; p-&gt;length(); i++) {</span>
<span class="udiff-line-removed">-       bytes += count_bytes_array(p-&gt;at(i));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     bytes += count_bytes_array(p);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return bytes;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void KlassInfoHisto::print_histo_on(outputStream* st, bool print_stats,</span>
<span class="udiff-line-removed">-                                     bool csv_format, const char *columns) {</span>
<span class="udiff-line-removed">-   if (print_stats) {</span>
<span class="udiff-line-removed">-     print_class_stats(st, csv_format, columns);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     st-&gt;print_cr(&quot; num     #instances         #bytes  class name (module)&quot;);</span>
<span class="udiff-line-removed">-     st-&gt;print_cr(&quot;-------------------------------------------------------&quot;);</span>
<span class="udiff-line-removed">-     print_elements(st);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ void KlassInfoHisto::print_histo_on(outputStream* st) {</span>
<span class="udiff-line-modified-added">+   st-&gt;print_cr(&quot; num     #instances         #bytes  class name (module)&quot;);</span>
<span class="udiff-line-modified-added">+   st-&gt;print_cr(&quot;-------------------------------------------------------&quot;);</span>
<span class="udiff-line-modified-added">+   print_elements(st);</span>
  }
  
  class HistoClosure : public KlassInfoClosure {
   private:
    KlassInfoHisto* _cih;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -717,46 +512,28 @@</span>
  }
  
  void HeapInspection::heap_inspection(outputStream* st) {
    ResourceMark rm;
  
<span class="udiff-line-modified-removed">-   if (_print_help) {</span>
<span class="udiff-line-removed">-     for (int c=0; c&lt;KlassSizeStats::_num_columns; c++) {</span>
<span class="udiff-line-removed">-       st-&gt;print(&quot;%s:\n\t&quot;, name_table[c]);</span>
<span class="udiff-line-removed">-       const int max_col = 60;</span>
<span class="udiff-line-removed">-       int col = 0;</span>
<span class="udiff-line-removed">-       for (const char *p = help_table[c]; *p; p++,col++) {</span>
<span class="udiff-line-removed">-         if (col &gt;= max_col &amp;&amp; *p == &#39; &#39;) {</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;\n\t&quot;);</span>
<span class="udiff-line-removed">-           col = 0;</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-           st-&gt;print(&quot;%c&quot;, *p);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-       st-&gt;print_cr(&quot;.\n&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   KlassInfoTable cit(_print_class_stats);</span>
<span class="udiff-line-modified-added">+   KlassInfoTable cit(false);</span>
    if (!cit.allocation_failed()) {
      // populate table with object allocation info
      size_t missed_count = populate_table(&amp;cit);
      if (missed_count != 0) {
<span class="udiff-line-modified-removed">-       st-&gt;print_cr(&quot;WARNING: Ran out of C-heap; undercounted &quot; SIZE_FORMAT</span>
<span class="udiff-line-modified-removed">-                    &quot; total instances in data below&quot;,</span>
<span class="udiff-line-modified-removed">-                    missed_count);</span>
<span class="udiff-line-modified-added">+       log_info(gc, classhisto)(&quot;WARNING: Ran out of C-heap; undercounted &quot; SIZE_FORMAT</span>
<span class="udiff-line-modified-added">+                                &quot; total instances in data below&quot;,</span>
<span class="udiff-line-modified-added">+                                missed_count);</span>
      }
  
      // Sort and print klass instance info
      KlassInfoHisto histo(&amp;cit);
      HistoClosure hc(&amp;histo);
  
      cit.iterate(&amp;hc);
  
      histo.sort();
<span class="udiff-line-modified-removed">-     histo.print_histo_on(st, _print_class_stats, _csv_format, _columns);</span>
<span class="udiff-line-modified-added">+     histo.print_histo_on(st);</span>
    } else {
      st-&gt;print_cr(&quot;ERROR: Ran out of C-heap; histogram not generated&quot;);
    }
    st-&gt;flush();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -769,10 +546,14 @@</span>
   public:
    FindInstanceClosure(Klass* k, GrowableArray&lt;oop&gt;* result) : _klass(k), _result(result) {};
  
    void do_object(oop obj) {
      if (obj-&gt;is_a(_klass)) {
<span class="udiff-line-added">+       // obj was read with AS_NO_KEEPALIVE, or equivalent.</span>
<span class="udiff-line-added">+       // The object needs to be kept alive when it is published.</span>
<span class="udiff-line-added">+       Universe::heap()-&gt;keep_alive(obj);</span>
<span class="udiff-line-added">+ </span>
        _result-&gt;append(obj);
      }
    }
  };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -783,10 +564,7 @@</span>
    // Ensure that the heap is parsable
    Universe::heap()-&gt;ensure_parsability(false);  // no need to retire TALBs
  
    // Iterate over objects in the heap
    FindInstanceClosure fic(k, result);
<span class="udiff-line-removed">-   // If this operation encounters a bad object when using CMS,</span>
<span class="udiff-line-removed">-   // consider using safe_object_iterate() which avoids metadata</span>
<span class="udiff-line-removed">-   // objects that may contain bad references.</span>
    Universe::heap()-&gt;object_iterate(&amp;fic);
  }
</pre>
<center><a href="heap.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapInspection.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>