<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/memory/metaspace/virtualSpaceList.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="spaceManager.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="virtualSpaceList.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/metaspace/virtualSpaceList.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,10 +30,11 @@</span>
  #include &quot;memory/metaspace/chunkManager.hpp&quot;
  #include &quot;memory/metaspace/metachunk.hpp&quot;
  #include &quot;memory/metaspace/metaspaceCommon.hpp&quot;
  #include &quot;memory/metaspace/virtualSpaceList.hpp&quot;
  #include &quot;memory/metaspace/virtualSpaceNode.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;runtime/orderAccess.hpp&quot;
  #include &quot;runtime/mutexLocker.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  
  namespace metaspace {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,13 +91,13 @@</span>
  // the node from their respective freelists.
  void VirtualSpaceList::purge(ChunkManager* chunk_manager) {
    assert_lock_strong(MetaspaceExpand_lock);
    // Don&#39;t use a VirtualSpaceListIterator because this
    // list is being changed and a straightforward use of an iterator is not safe.
<span class="udiff-line-removed">-   VirtualSpaceNode* purged_vsl = NULL;</span>
    VirtualSpaceNode* prev_vsl = virtual_space_list();
    VirtualSpaceNode* next_vsl = prev_vsl;
<span class="udiff-line-added">+   int num_purged_nodes = 0;</span>
    while (next_vsl != NULL) {
      VirtualSpaceNode* vsl = next_vsl;
      DEBUG_ONLY(vsl-&gt;verify(false);)
      next_vsl = vsl-&gt;next();
      // Don&#39;t free the current virtual space since it will likely
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,24 +117,21 @@</span>
  
        vsl-&gt;purge(chunk_manager);
        dec_reserved_words(vsl-&gt;reserved_words());
        dec_committed_words(vsl-&gt;committed_words());
        dec_virtual_space_count();
<span class="udiff-line-removed">-       purged_vsl = vsl;</span>
        delete vsl;
<span class="udiff-line-added">+       num_purged_nodes ++;</span>
      } else {
        prev_vsl = vsl;
      }
    }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Verify list</span>
  #ifdef ASSERT
<span class="udiff-line-modified-removed">-   if (purged_vsl != NULL) {</span>
<span class="udiff-line-modified-removed">-     // List should be stable enough to use an iterator here.</span>
<span class="udiff-line-removed">-     VirtualSpaceListIterator iter(virtual_space_list());</span>
<span class="udiff-line-removed">-     while (iter.repeat()) {</span>
<span class="udiff-line-removed">-       VirtualSpaceNode* vsl = iter.get_next();</span>
<span class="udiff-line-removed">-       assert(vsl != purged_vsl, &quot;Purge of vsl failed&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+   if (num_purged_nodes &gt; 0) {</span>
<span class="udiff-line-modified-added">+     verify(false);</span>
    }
  #endif
  }
  
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,15 +139,17 @@</span>
  // The chunks are added with store ordering and not deleted except for at
  // unloading time during a safepoint.
  VirtualSpaceNode* VirtualSpaceList::find_enclosing_space(const void* ptr) {
    // List should be stable enough to use an iterator here because removing virtual
    // space nodes is only allowed at a safepoint.
<span class="udiff-line-modified-removed">-   VirtualSpaceListIterator iter(virtual_space_list());</span>
<span class="udiff-line-modified-removed">-   while (iter.repeat()) {</span>
<span class="udiff-line-modified-removed">-     VirtualSpaceNode* vsn = iter.get_next();</span>
<span class="udiff-line-modified-removed">-     if (vsn-&gt;contains(ptr)) {</span>
<span class="udiff-line-modified-removed">-       return vsn;</span>
<span class="udiff-line-modified-added">+   if (is_within_envelope((address)ptr)) {</span>
<span class="udiff-line-modified-added">+     VirtualSpaceListIterator iter(virtual_space_list());</span>
<span class="udiff-line-modified-added">+     while (iter.repeat()) {</span>
<span class="udiff-line-modified-added">+       VirtualSpaceNode* vsn = iter.get_next();</span>
<span class="udiff-line-modified-added">+       if (vsn-&gt;contains(ptr)) {</span>
<span class="udiff-line-added">+         return vsn;</span>
<span class="udiff-line-added">+       }</span>
      }
    }
    return NULL;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -168,28 +168,33 @@</span>
                                     _virtual_space_list(NULL),
                                     _current_virtual_space(NULL),
                                     _is_class(false),
                                     _reserved_words(0),
                                     _committed_words(0),
<span class="udiff-line-modified-removed">-                                    _virtual_space_count(0) {</span>
<span class="udiff-line-modified-removed">-   MutexLockerEx cl(MetaspaceExpand_lock,</span>
<span class="udiff-line-modified-removed">-                    Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+                                    _virtual_space_count(0),</span>
<span class="udiff-line-modified-added">+                                    _envelope_lo((address)max_uintx),</span>
<span class="udiff-line-modified-added">+                                    _envelope_hi(NULL) {</span>
<span class="udiff-line-added">+   MutexLocker cl(MetaspaceExpand_lock, Mutex::_no_safepoint_check_flag);</span>
    create_new_virtual_space(word_size);
  }
  
  VirtualSpaceList::VirtualSpaceList(ReservedSpace rs) :
                                     _virtual_space_list(NULL),
                                     _current_virtual_space(NULL),
                                     _is_class(true),
                                     _reserved_words(0),
                                     _committed_words(0),
<span class="udiff-line-modified-removed">-                                    _virtual_space_count(0) {</span>
<span class="udiff-line-modified-removed">-   MutexLockerEx cl(MetaspaceExpand_lock,</span>
<span class="udiff-line-modified-removed">-                    Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+                                    _virtual_space_count(0),</span>
<span class="udiff-line-modified-added">+                                    _envelope_lo((address)max_uintx),</span>
<span class="udiff-line-modified-added">+                                    _envelope_hi(NULL) {</span>
<span class="udiff-line-added">+   MutexLocker cl(MetaspaceExpand_lock, Mutex::_no_safepoint_check_flag);</span>
    VirtualSpaceNode* class_entry = new VirtualSpaceNode(is_class(), rs);
    bool succeeded = class_entry-&gt;initialize();
    if (succeeded) {
<span class="udiff-line-added">+     expand_envelope_to_include_node(class_entry);</span>
<span class="udiff-line-added">+     // ensure lock-free iteration sees fully initialized node</span>
<span class="udiff-line-added">+     OrderAccess::storestore();</span>
      link_vs(class_entry);
    }
  }
  
  size_t VirtualSpaceList::free_bytes() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -222,16 +227,20 @@</span>
      delete new_entry;
      return false;
    } else {
      assert(new_entry-&gt;reserved_words() == vs_word_size,
          &quot;Reserved memory size differs from requested memory size&quot;);
<span class="udiff-line-added">+     expand_envelope_to_include_node(new_entry);</span>
      // ensure lock-free iteration sees fully initialized node
      OrderAccess::storestore();
      link_vs(new_entry);
      DEBUG_ONLY(Atomic::inc(&amp;g_internal_statistics.num_vsnodes_created));
      return true;
    }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   DEBUG_ONLY(verify(false);)</span>
<span class="udiff-line-added">+ </span>
  }
  
  void VirtualSpaceList::link_vs(VirtualSpaceNode* new_entry) {
    if (virtual_space_list() == NULL) {
        set_virtual_space_list(new_entry);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -397,7 +406,42 @@</span>
      node-&gt;print_map(st, this-&gt;is_class());
      i ++;
    }
  }
  
<span class="udiff-line-modified-removed">- } // namespace metaspace</span>
<span class="udiff-line-modified-added">+ // Given a node, expand range such that it includes the node.</span>
<span class="udiff-line-added">+ void VirtualSpaceList::expand_envelope_to_include_node(const VirtualSpaceNode* node) {</span>
<span class="udiff-line-added">+   _envelope_lo = MIN2(_envelope_lo, (address)node-&gt;low_boundary());</span>
<span class="udiff-line-added">+   _envelope_hi = MAX2(_envelope_hi, (address)node-&gt;high_boundary());</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef ASSERT</span>
<span class="udiff-line-added">+ void VirtualSpaceList::verify(bool slow) {</span>
<span class="udiff-line-added">+   VirtualSpaceNode* list = virtual_space_list();</span>
<span class="udiff-line-added">+   VirtualSpaceListIterator iter(list);</span>
<span class="udiff-line-added">+   size_t reserved = 0;</span>
<span class="udiff-line-added">+   size_t committed = 0;</span>
<span class="udiff-line-added">+   size_t node_count = 0;</span>
<span class="udiff-line-added">+   while (iter.repeat()) {</span>
<span class="udiff-line-added">+     VirtualSpaceNode* node = iter.get_next();</span>
<span class="udiff-line-added">+     if (slow) {</span>
<span class="udiff-line-added">+       node-&gt;verify(true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     // Check that the node resides fully within our envelope.</span>
<span class="udiff-line-added">+     assert((address)node-&gt;low_boundary() &gt;= _envelope_lo &amp;&amp; (address)node-&gt;high_boundary() &lt;= _envelope_hi,</span>
<span class="udiff-line-added">+            &quot;Node &quot; SIZE_FORMAT &quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) outside envelope [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;).&quot;,</span>
<span class="udiff-line-added">+            node_count, p2i(node-&gt;low_boundary()), p2i(node-&gt;high_boundary()), p2i(_envelope_lo), p2i(_envelope_hi));</span>
<span class="udiff-line-added">+     reserved += node-&gt;reserved_words();</span>
<span class="udiff-line-added">+     committed += node-&gt;committed_words();</span>
<span class="udiff-line-added">+     node_count ++;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   assert(reserved == reserved_words() &amp;&amp; committed == committed_words() &amp;&amp; node_count == _virtual_space_count,</span>
<span class="udiff-line-added">+       &quot;Mismatch: reserved real: &quot; SIZE_FORMAT &quot; expected: &quot; SIZE_FORMAT</span>
<span class="udiff-line-added">+       &quot;, committed real: &quot; SIZE_FORMAT &quot; expected: &quot; SIZE_FORMAT</span>
<span class="udiff-line-added">+       &quot;, node count real: &quot; SIZE_FORMAT &quot; expected: &quot; SIZE_FORMAT &quot;.&quot;,</span>
<span class="udiff-line-added">+       reserved, reserved_words(), committed, committed_words(),</span>
<span class="udiff-line-added">+       node_count, _virtual_space_count);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif // ASSERT</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ } // namespace metaspace</span>
</pre>
<center><a href="spaceManager.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="virtualSpaceList.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>