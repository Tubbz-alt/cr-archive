<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/memory/metaspace/printCLDMetaspaceInfoClosure.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="metaspaceCommon.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="printCLDMetaspaceInfoClosure.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/metaspace/printCLDMetaspaceInfoClosure.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,11 ---</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/classLoaderData.inline.hpp&quot;
  #include &quot;classfile/javaClasses.hpp&quot;
  #include &quot;memory/metaspace/printCLDMetaspaceInfoClosure.hpp&quot;
  #include &quot;memory/metaspace/printMetaspaceInfoKlassClosure.hpp&quot;
<span class="line-added">+ #include &quot;memory/metaspaceShared.hpp&quot;</span>
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  #include &quot;utilities/ostream.hpp&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,17 ***</span>
  PrintCLDMetaspaceInfoClosure::PrintCLDMetaspaceInfoClosure(outputStream* out, size_t scale, bool do_print,
      bool do_print_classes, bool break_down_by_chunktype)
  : _out(out), _scale(scale), _do_print(do_print), _do_print_classes(do_print_classes)
  , _break_down_by_chunktype(break_down_by_chunktype)
  , _num_loaders(0), _num_loaders_without_metaspace(0), _num_loaders_unloading(0)
  {
    memset(_num_loaders_by_spacetype, 0, sizeof(_num_loaders_by_spacetype));
  }
  
<span class="line-modified">! static const char* classes_plural(uintx num) {</span>
<span class="line-modified">!   return num == 1 ? &quot;&quot; : &quot;es&quot;;</span>
<span class="line-modified">! }</span>
  
  void PrintCLDMetaspaceInfoClosure::do_cld(ClassLoaderData* cld) {
  
    assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
  
<span class="line-new-header">--- 38,33 ---</span>
  PrintCLDMetaspaceInfoClosure::PrintCLDMetaspaceInfoClosure(outputStream* out, size_t scale, bool do_print,
      bool do_print_classes, bool break_down_by_chunktype)
  : _out(out), _scale(scale), _do_print(do_print), _do_print_classes(do_print_classes)
  , _break_down_by_chunktype(break_down_by_chunktype)
  , _num_loaders(0), _num_loaders_without_metaspace(0), _num_loaders_unloading(0)
<span class="line-added">+ ,  _num_classes(0), _num_classes_shared(0)</span>
  {
    memset(_num_loaders_by_spacetype, 0, sizeof(_num_loaders_by_spacetype));
<span class="line-added">+   memset(_num_classes_by_spacetype, 0, sizeof(_num_classes_by_spacetype));</span>
<span class="line-added">+   memset(_num_classes_shared_by_spacetype, 0, sizeof(_num_classes_shared_by_spacetype));</span>
  }
  
<span class="line-modified">! // A closure just to count classes</span>
<span class="line-modified">! class CountKlassClosure : public KlassClosure {</span>
<span class="line-modified">! public:</span>
<span class="line-added">+ </span>
<span class="line-added">+   uintx _num_classes;</span>
<span class="line-added">+   uintx _num_classes_shared;</span>
<span class="line-added">+ </span>
<span class="line-added">+   CountKlassClosure() : _num_classes(0), _num_classes_shared(0) {}</span>
<span class="line-added">+   void do_klass(Klass* k) {</span>
<span class="line-added">+     _num_classes ++;</span>
<span class="line-added">+     if (k-&gt;is_shared()) {</span>
<span class="line-added">+       _num_classes_shared ++;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+ }; // end: PrintKlassInfoClosure</span>
  
  void PrintCLDMetaspaceInfoClosure::do_cld(ClassLoaderData* cld) {
  
    assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,11 ***</span>
    _stats_total.add(this_cld_stat);
    _num_loaders ++;
    _stats_by_spacetype[msp-&gt;space_type()].add(this_cld_stat);
    _num_loaders_by_spacetype[msp-&gt;space_type()] ++;
  
<span class="line-modified">!   // Optionally, print.</span>
    if (_do_print) {
  
      _out-&gt;print(UINTX_FORMAT_W(4) &quot;: &quot;, _num_loaders);
  
      // Print &quot;CLD for [&lt;loader name&gt;,] instance of &lt;loader class name&gt;&quot;
<span class="line-new-header">--- 87,20 ---</span>
    _stats_total.add(this_cld_stat);
    _num_loaders ++;
    _stats_by_spacetype[msp-&gt;space_type()].add(this_cld_stat);
    _num_loaders_by_spacetype[msp-&gt;space_type()] ++;
  
<span class="line-modified">!   // Count classes loaded by this CLD.</span>
<span class="line-added">+   CountKlassClosure ckc;</span>
<span class="line-added">+   cld-&gt;classes_do(&amp;ckc);</span>
<span class="line-added">+   // accumulate.</span>
<span class="line-added">+   _num_classes += ckc._num_classes;</span>
<span class="line-added">+   _num_classes_by_spacetype[msp-&gt;space_type()] += ckc._num_classes;</span>
<span class="line-added">+   _num_classes_shared += ckc._num_classes_shared;</span>
<span class="line-added">+   _num_classes_shared_by_spacetype[msp-&gt;space_type()] += ckc._num_classes_shared;</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Optionally, print</span>
    if (_do_print) {
  
      _out-&gt;print(UINTX_FORMAT_W(4) &quot;: &quot;, _num_loaders);
  
      // Print &quot;CLD for [&lt;loader name&gt;,] instance of &lt;loader class name&gt;&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 111,40 ***</span>
      if (class_name != NULL) {
        _out-&gt;print(&quot; instance of %s&quot;, class_name);
      }
  
      if (_do_print_classes) {
        streamIndentor sti(_out, 6);
        _out-&gt;cr_indent();
<span class="line-modified">!       _out-&gt;print(&quot;Loaded classes: &quot;);</span>
        PrintMetaspaceInfoKlassClosure pkic(_out, true);
        cld-&gt;classes_do(&amp;pkic);
        _out-&gt;cr_indent();
        _out-&gt;print(&quot;-total-: &quot;);
<span class="line-modified">!       _out-&gt;print(UINTX_FORMAT &quot; class%s&quot;, pkic._num_classes, classes_plural(pkic._num_classes));</span>
<span class="line-modified">!       if (pkic._num_instance_classes &gt; 0 || pkic._num_array_classes &gt; 0) {</span>
<span class="line-modified">!         _out-&gt;print(&quot; (&quot;);</span>
<span class="line-modified">!         if (pkic._num_instance_classes &gt; 0) {</span>
<span class="line-modified">!           _out-&gt;print(UINTX_FORMAT &quot; instance class%s&quot;, pkic._num_instance_classes,</span>
<span class="line-removed">-               classes_plural(pkic._num_instance_classes));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (pkic._num_array_classes &gt; 0) {</span>
<span class="line-removed">-           if (pkic._num_instance_classes &gt; 0) {</span>
<span class="line-removed">-             _out-&gt;print(&quot;, &quot;);</span>
<span class="line-removed">-           }</span>
<span class="line-removed">-           _out-&gt;print(UINTX_FORMAT &quot; array class%s&quot;, pkic._num_array_classes,</span>
<span class="line-removed">-               classes_plural(pkic._num_array_classes));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         _out-&gt;print(&quot;).&quot;);</span>
<span class="line-removed">-       }</span>
      }
  
<span class="line-removed">-     _out-&gt;cr();</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-     _out-&gt;cr();</span>
<span class="line-removed">- </span>
      // Print statistics
      this_cld_stat.print_on(_out, _scale, _break_down_by_chunktype);
      _out-&gt;cr();
  
    }
<span class="line-new-header">--- 137,29 ---</span>
      if (class_name != NULL) {
        _out-&gt;print(&quot; instance of %s&quot;, class_name);
      }
  
      if (_do_print_classes) {
<span class="line-added">+       // Print a detailed description of all loaded classes.</span>
        streamIndentor sti(_out, 6);
        _out-&gt;cr_indent();
<span class="line-modified">!       _out-&gt;print(&quot;Loaded classes&quot;);</span>
<span class="line-added">+       if (ckc._num_classes_shared &gt; 0) {</span>
<span class="line-added">+         _out-&gt;print(&quot;(&#39;s&#39; = shared)&quot;);</span>
<span class="line-added">+       }</span>
<span class="line-added">+       _out-&gt;print(&quot;:&quot;);</span>
        PrintMetaspaceInfoKlassClosure pkic(_out, true);
        cld-&gt;classes_do(&amp;pkic);
        _out-&gt;cr_indent();
        _out-&gt;print(&quot;-total-: &quot;);
<span class="line-modified">!       print_number_of_classes(_out, ckc._num_classes, ckc._num_classes_shared);</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!       // Just print a summary about how many classes have been loaded.</span>
<span class="line-modified">!       _out-&gt;print(&quot;, &quot;);</span>
<span class="line-modified">!       print_number_of_classes(_out, ckc._num_classes, ckc._num_classes_shared);</span>
      }
  
      // Print statistics
      this_cld_stat.print_on(_out, _scale, _break_down_by_chunktype);
      _out-&gt;cr();
  
    }
</pre>
<center><a href="metaspaceCommon.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="printCLDMetaspaceInfoClosure.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>