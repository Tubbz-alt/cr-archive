<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/memory/metaspace/virtualSpaceNode.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="virtualSpaceList.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="virtualSpaceNode.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/metaspace/virtualSpaceNode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 
 27 #include &quot;logging/log.hpp&quot;
 28 #include &quot;logging/logStream.hpp&quot;
 29 #include &quot;memory/metaspace/metachunk.hpp&quot;
 30 #include &quot;memory/metaspace.hpp&quot;
 31 #include &quot;memory/metaspace/chunkManager.hpp&quot;
 32 #include &quot;memory/metaspace/metaDebug.hpp&quot;
 33 #include &quot;memory/metaspace/metaspaceCommon.hpp&quot;
 34 #include &quot;memory/metaspace/occupancyMap.hpp&quot;
 35 #include &quot;memory/metaspace/virtualSpaceNode.hpp&quot;
 36 #include &quot;memory/virtualspace.hpp&quot;

 37 #include &quot;runtime/os.hpp&quot;
 38 #include &quot;services/memTracker.hpp&quot;
 39 #include &quot;utilities/copy.hpp&quot;
 40 #include &quot;utilities/debug.hpp&quot;
 41 #include &quot;utilities/globalDefinitions.hpp&quot;
 42 
 43 namespace metaspace {
 44 
 45 // Decide if large pages should be committed when the memory is reserved.
 46 static bool should_commit_large_pages_when_reserving(size_t bytes) {
 47   if (UseLargePages &amp;&amp; UseLargePagesInMetaspace &amp;&amp; !os::can_commit_large_page_memory()) {
 48     size_t words = bytes / BytesPerWord;
 49     bool is_class = false; // We never reserve large pages for the class space.
 50     if (MetaspaceGC::can_expand(words, is_class) &amp;&amp;
 51         MetaspaceGC::allowed_expansion() &gt;= words) {
 52       return true;
 53     }
 54   }
 55 
 56   return false;
</pre>
<hr />
<pre>
568     size_t chunk_size = chunk_manager-&gt;size_by_index(index);
569 
570     while (free_words_in_vs() &gt;= chunk_size) {
571       Metachunk* chunk = get_chunk_vs(chunk_size);
572       // Chunk will be allocated aligned, so allocation may require
573       // additional padding chunks. That may cause above allocation to
574       // fail. Just ignore the failed allocation and continue with the
575       // next smaller chunk size. As the VirtualSpaceNode comitted
576       // size should be a multiple of the smallest chunk size, we
577       // should always be able to fill the VirtualSpace completely.
578       if (chunk == NULL) {
579         break;
580       }
581       chunk_manager-&gt;return_single_chunk(chunk);
582     }
583   }
584   assert(free_words_in_vs() == 0, &quot;should be empty now&quot;);
585 }
586 
587 } // namespace metaspace
<span class="line-removed">588 </span>
</pre>
</td>
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 
 27 #include &quot;logging/log.hpp&quot;
 28 #include &quot;logging/logStream.hpp&quot;
 29 #include &quot;memory/metaspace/metachunk.hpp&quot;
 30 #include &quot;memory/metaspace.hpp&quot;
 31 #include &quot;memory/metaspace/chunkManager.hpp&quot;
 32 #include &quot;memory/metaspace/metaDebug.hpp&quot;
 33 #include &quot;memory/metaspace/metaspaceCommon.hpp&quot;
 34 #include &quot;memory/metaspace/occupancyMap.hpp&quot;
 35 #include &quot;memory/metaspace/virtualSpaceNode.hpp&quot;
 36 #include &quot;memory/virtualspace.hpp&quot;
<span class="line-added"> 37 #include &quot;runtime/atomic.hpp&quot;</span>
 38 #include &quot;runtime/os.hpp&quot;
 39 #include &quot;services/memTracker.hpp&quot;
 40 #include &quot;utilities/copy.hpp&quot;
 41 #include &quot;utilities/debug.hpp&quot;
 42 #include &quot;utilities/globalDefinitions.hpp&quot;
 43 
 44 namespace metaspace {
 45 
 46 // Decide if large pages should be committed when the memory is reserved.
 47 static bool should_commit_large_pages_when_reserving(size_t bytes) {
 48   if (UseLargePages &amp;&amp; UseLargePagesInMetaspace &amp;&amp; !os::can_commit_large_page_memory()) {
 49     size_t words = bytes / BytesPerWord;
 50     bool is_class = false; // We never reserve large pages for the class space.
 51     if (MetaspaceGC::can_expand(words, is_class) &amp;&amp;
 52         MetaspaceGC::allowed_expansion() &gt;= words) {
 53       return true;
 54     }
 55   }
 56 
 57   return false;
</pre>
<hr />
<pre>
569     size_t chunk_size = chunk_manager-&gt;size_by_index(index);
570 
571     while (free_words_in_vs() &gt;= chunk_size) {
572       Metachunk* chunk = get_chunk_vs(chunk_size);
573       // Chunk will be allocated aligned, so allocation may require
574       // additional padding chunks. That may cause above allocation to
575       // fail. Just ignore the failed allocation and continue with the
576       // next smaller chunk size. As the VirtualSpaceNode comitted
577       // size should be a multiple of the smallest chunk size, we
578       // should always be able to fill the VirtualSpace completely.
579       if (chunk == NULL) {
580         break;
581       }
582       chunk_manager-&gt;return_single_chunk(chunk);
583     }
584   }
585   assert(free_words_in_vs() == 0, &quot;should be empty now&quot;);
586 }
587 
588 } // namespace metaspace

</pre>
</td>
</tr>
</table>
<center><a href="virtualSpaceList.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="virtualSpaceNode.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>