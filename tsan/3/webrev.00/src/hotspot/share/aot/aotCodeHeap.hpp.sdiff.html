<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/aot/aotCodeHeap.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="aotCodeHeap.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="aotCompiledMethod.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/aot/aotCodeHeap.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 75   int _compiled_methods_offset;
 76   int _dependent_methods_offset;
 77   uint64_t _fingerprint;
 78 } AOTKlassData;
 79 
 80 typedef struct {
 81   int _version;
 82   int _class_count;
 83   int _method_count;
 84   int _klasses_got_size;
 85   int _metadata_got_size;
 86   int _oop_got_size;
 87   int _jvm_version_offset;
 88 
 89   enum {
 90     AOT_SHARED_VERSION = 1
 91   };
 92 } AOTHeader;
 93 
 94 typedef struct {
<span class="line-modified"> 95   enum { CONFIG_SIZE = 8 * jintSize + 11 };</span>
<span class="line-modified"> 96   // 8 int values</span>
 97   int _config_size;
 98   int _narrowOopShift;
 99   int _narrowKlassShift;
100   int _contendedPaddingWidth;
<span class="line-removed">101   int _fieldsAllocationStyle;</span>
102   int _objectAlignment;
103   int _codeSegmentSize;
104   int _gc;
<span class="line-modified">105   // byte[11] array map to boolean values here</span>
106   bool _debug_VM;
107   bool _useCompressedOops;
108   bool _useCompressedClassPointers;
<span class="line-removed">109   bool _compactFields;</span>
110   bool _useTLAB;
111   bool _useBiasedLocking;
112   bool _tieredAOT;
113   bool _enableContended;
114   bool _restrictContended;
115   bool _omitAssertions;
<span class="line-removed">116   bool _threadLocalHandshakes;</span>
117 } AOTConfiguration;
118 
119 class AOTLib : public CHeapObj&lt;mtCode&gt; {
120   static bool _narrow_oop_shift_initialized;
121   static int _narrow_oop_shift;
122   static int _narrow_klass_shift;
123 
124   bool _valid;
125   void* _dl_handle;
126   const int _dso_id;
127   const char* _name;
128   // VM configuration during AOT compilation
129   AOTConfiguration* _config;
130   AOTHeader* _header;
131 
132   void handle_config_error(const char* format, ...) ATTRIBUTE_PRINTF(2, 3);
133 public:
134   AOTLib(void* handle, const char* name, int dso_id);
135   virtual ~AOTLib();
136   static int  narrow_oop_shift() { return _narrow_oop_shift; }
</pre>
<hr />
<pre>
235   AOTCompiledMethod* find_aot(address p) const;
236 
237   virtual void* find_start(void* p)     const;
238   virtual CodeBlob* find_blob_unsafe(void* start) const;
239   virtual void* first() const;
240   virtual void* next(void *p) const;
241 
242   AOTKlassData* find_klass(InstanceKlass* ik);
243   bool load_klass_data(InstanceKlass* ik, Thread* thread);
244   Klass* get_klass_from_got(const char* klass_name, int klass_len, const Method* method);
245 
246   bool is_dependent_method(Klass* dependee, AOTCompiledMethod* aot);
247   void mark_evol_dependent_methods(InstanceKlass* dependee);
248 
249   const char* get_name_at(int offset) {
250     return _metaspace_names + offset;
251   }
252 
253 
254   void oops_do(OopClosure* f);
<span class="line-modified">255   void metadata_do(void f(Metadata*));</span>
<span class="line-modified">256   void got_metadata_do(void f(Metadata*));</span>
257 
258 #ifdef ASSERT
259   bool got_contains(Metadata **p) {
260     return (p &gt;= &amp;_metadata_got[0] &amp;&amp; p &lt; &amp;_metadata_got[_metadata_got_size]) ||
261            (p &gt;= &amp;_klasses_got[0] &amp;&amp; p &lt; &amp;_klasses_got[_klasses_got_size]);
262   }
263 #endif
264 
265   int dso_id() const { return _lib-&gt;id(); }
266   int aot_id() const { return _aot_id; }
267 
268   int method_count() { return _method_count; }
269 
270   AOTCompiledMethod* get_code_desc_at_index(int index) {
271     if (index &lt; _method_count &amp;&amp; _code_to_aot[index]._state == in_use) {
272         AOTCompiledMethod* m = _code_to_aot[index]._aot;
273         assert(m != NULL, &quot;AOT method should be set&quot;);
274         if (!m-&gt;is_runtime_stub()) {
275           return m;
276         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 75   int _compiled_methods_offset;
 76   int _dependent_methods_offset;
 77   uint64_t _fingerprint;
 78 } AOTKlassData;
 79 
 80 typedef struct {
 81   int _version;
 82   int _class_count;
 83   int _method_count;
 84   int _klasses_got_size;
 85   int _metadata_got_size;
 86   int _oop_got_size;
 87   int _jvm_version_offset;
 88 
 89   enum {
 90     AOT_SHARED_VERSION = 1
 91   };
 92 } AOTHeader;
 93 
 94 typedef struct {
<span class="line-modified"> 95   enum { CONFIG_SIZE = 7 * jintSize + 9 };</span>
<span class="line-modified"> 96   // 7 int values</span>
 97   int _config_size;
 98   int _narrowOopShift;
 99   int _narrowKlassShift;
100   int _contendedPaddingWidth;

101   int _objectAlignment;
102   int _codeSegmentSize;
103   int _gc;
<span class="line-modified">104   // byte[9] array map to boolean values here</span>
105   bool _debug_VM;
106   bool _useCompressedOops;
107   bool _useCompressedClassPointers;

108   bool _useTLAB;
109   bool _useBiasedLocking;
110   bool _tieredAOT;
111   bool _enableContended;
112   bool _restrictContended;
113   bool _omitAssertions;

114 } AOTConfiguration;
115 
116 class AOTLib : public CHeapObj&lt;mtCode&gt; {
117   static bool _narrow_oop_shift_initialized;
118   static int _narrow_oop_shift;
119   static int _narrow_klass_shift;
120 
121   bool _valid;
122   void* _dl_handle;
123   const int _dso_id;
124   const char* _name;
125   // VM configuration during AOT compilation
126   AOTConfiguration* _config;
127   AOTHeader* _header;
128 
129   void handle_config_error(const char* format, ...) ATTRIBUTE_PRINTF(2, 3);
130 public:
131   AOTLib(void* handle, const char* name, int dso_id);
132   virtual ~AOTLib();
133   static int  narrow_oop_shift() { return _narrow_oop_shift; }
</pre>
<hr />
<pre>
232   AOTCompiledMethod* find_aot(address p) const;
233 
234   virtual void* find_start(void* p)     const;
235   virtual CodeBlob* find_blob_unsafe(void* start) const;
236   virtual void* first() const;
237   virtual void* next(void *p) const;
238 
239   AOTKlassData* find_klass(InstanceKlass* ik);
240   bool load_klass_data(InstanceKlass* ik, Thread* thread);
241   Klass* get_klass_from_got(const char* klass_name, int klass_len, const Method* method);
242 
243   bool is_dependent_method(Klass* dependee, AOTCompiledMethod* aot);
244   void mark_evol_dependent_methods(InstanceKlass* dependee);
245 
246   const char* get_name_at(int offset) {
247     return _metaspace_names + offset;
248   }
249 
250 
251   void oops_do(OopClosure* f);
<span class="line-modified">252   void metadata_do(MetadataClosure* f);</span>
<span class="line-modified">253   void got_metadata_do(MetadataClosure* f);</span>
254 
255 #ifdef ASSERT
256   bool got_contains(Metadata **p) {
257     return (p &gt;= &amp;_metadata_got[0] &amp;&amp; p &lt; &amp;_metadata_got[_metadata_got_size]) ||
258            (p &gt;= &amp;_klasses_got[0] &amp;&amp; p &lt; &amp;_klasses_got[_klasses_got_size]);
259   }
260 #endif
261 
262   int dso_id() const { return _lib-&gt;id(); }
263   int aot_id() const { return _aot_id; }
264 
265   int method_count() { return _method_count; }
266 
267   AOTCompiledMethod* get_code_desc_at_index(int index) {
268     if (index &lt; _method_count &amp;&amp; _code_to_aot[index]._state == in_use) {
269         AOTCompiledMethod* m = _code_to_aot[index]._aot;
270         assert(m != NULL, &quot;AOT method should be set&quot;);
271         if (!m-&gt;is_runtime_stub()) {
272           return m;
273         }
</pre>
</td>
</tr>
</table>
<center><a href="aotCodeHeap.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="aotCompiledMethod.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>