<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/aot/aotLoader.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="aotCompiledMethod.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="aotLoader.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/aot/aotLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 20,16 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="line-removed">- #include &quot;jvm.h&quot;</span>
<span class="line-removed">- </span>
  #include &quot;aot/aotCodeHeap.hpp&quot;
  #include &quot;aot/aotLoader.inline.hpp&quot;
<span class="line-modified">! #include &quot;jvmci/jvmciRuntime.hpp&quot;</span>
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;oops/method.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/os.inline.hpp&quot;
  #include &quot;runtime/timerTrace.hpp&quot;
  
<span class="line-new-header">--- 20,17 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;aot/aotCodeHeap.hpp&quot;
  #include &quot;aot/aotLoader.inline.hpp&quot;
<span class="line-modified">! #include &quot;classfile/javaClasses.hpp&quot;</span>
<span class="line-added">+ #include &quot;jvm.h&quot;</span>
  #include &quot;memory/allocation.inline.hpp&quot;
<span class="line-added">+ #include &quot;memory/resourceArea.hpp&quot;</span>
<span class="line-added">+ #include &quot;oops/compressedOops.hpp&quot;</span>
  #include &quot;oops/method.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/os.inline.hpp&quot;
  #include &quot;runtime/timerTrace.hpp&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 76,11 ***</span>
        (*heap)-&gt;oops_do(f);
      }
    }
  }
  
<span class="line-modified">! void AOTLoader::metadata_do(void f(Metadata*)) {</span>
    if (UseAOT) {
      FOR_ALL_AOT_HEAPS(heap) {
        (*heap)-&gt;metadata_do(f);
      }
    }
<span class="line-new-header">--- 77,11 ---</span>
        (*heap)-&gt;oops_do(f);
      }
    }
  }
  
<span class="line-modified">! void AOTLoader::metadata_do(MetadataClosure* f) {</span>
    if (UseAOT) {
      FOR_ALL_AOT_HEAPS(heap) {
        (*heap)-&gt;metadata_do(f);
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,21 ***</span>
  
      // Scan the AOTLibrary option.
      if (AOTLibrary != NULL) {
        const int len = (int)strlen(AOTLibrary);
        char* cp  = NEW_C_HEAP_ARRAY(char, len+1, mtCode);
<span class="line-modified">!       if (cp != NULL) { // No memory?</span>
<span class="line-modified">!         memcpy(cp, AOTLibrary, len);</span>
<span class="line-modified">!         cp[len] = &#39;\0&#39;;</span>
<span class="line-modified">!         char* end = cp + len;</span>
<span class="line-modified">!         while (cp &lt; end) {</span>
<span class="line-modified">!           const char* name = cp;</span>
<span class="line-modified">!           while ((*cp) != &#39;\0&#39; &amp;&amp; (*cp) != &#39;\n&#39; &amp;&amp; (*cp) != &#39;,&#39; &amp;&amp; (*cp) != pathSep) cp++;</span>
<span class="line-modified">!           cp[0] = &#39;\0&#39;;  // Terminate name</span>
<span class="line-modified">!           cp++;</span>
<span class="line-removed">-           load_library(name, true);</span>
<span class="line-removed">-         }</span>
        }
      }
  
      // Load well-know AOT libraries from Java installation directory.
      const char* home = Arguments::get_java_home();
<span class="line-new-header">--- 149,19 ---</span>
  
      // Scan the AOTLibrary option.
      if (AOTLibrary != NULL) {
        const int len = (int)strlen(AOTLibrary);
        char* cp  = NEW_C_HEAP_ARRAY(char, len+1, mtCode);
<span class="line-modified">!       memcpy(cp, AOTLibrary, len);</span>
<span class="line-modified">!       cp[len] = &#39;\0&#39;;</span>
<span class="line-modified">!       char* end = cp + len;</span>
<span class="line-modified">!       while (cp &lt; end) {</span>
<span class="line-modified">!         const char* name = cp;</span>
<span class="line-modified">!         while ((*cp) != &#39;\0&#39; &amp;&amp; (*cp) != &#39;\n&#39; &amp;&amp; (*cp) != &#39;,&#39; &amp;&amp; (*cp) != pathSep) cp++;</span>
<span class="line-modified">!         cp[0] = &#39;\0&#39;;  // Terminate name</span>
<span class="line-modified">!         cp++;</span>
<span class="line-modified">!         load_library(name, true);</span>
        }
      }
  
      // Load well-know AOT libraries from Java installation directory.
      const char* home = Arguments::get_java_home();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 182,27 ***</span>
      // AOT libs are loaded before heap initialized so shift values are not set.
      // It is okay since ObjectAlignmentInBytes flag which defines shifts value is set before AOT libs are loaded.
      // AOT sets shift values during heap and metaspace initialization.
      // Check shifts value to make sure thay did not change.
      if (UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized()) {
<span class="line-modified">!       int oop_shift = Universe::narrow_oop_shift();</span>
        FOR_ALL_AOT_LIBRARIES(lib) {
<span class="line-modified">!         (*lib)-&gt;verify_flag((*lib)-&gt;config()-&gt;_narrowOopShift, oop_shift, &quot;Universe::narrow_oop_shift&quot;);</span>
        }
        if (UseCompressedClassPointers) { // It is set only if UseCompressedOops is set
<span class="line-modified">!         int klass_shift = Universe::narrow_klass_shift();</span>
          FOR_ALL_AOT_LIBRARIES(lib) {
<span class="line-modified">!           (*lib)-&gt;verify_flag((*lib)-&gt;config()-&gt;_narrowKlassShift, klass_shift, &quot;Universe::narrow_klass_shift&quot;);</span>
          }
        }
      }
      // Create heaps for all valid libraries
      FOR_ALL_AOT_LIBRARIES(lib) {
        if ((*lib)-&gt;is_valid()) {
          AOTCodeHeap* heap = new AOTCodeHeap(*lib);
          {
<span class="line-modified">!           MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
            add_heap(heap);
            CodeCache::add_heap(heap);
          }
        } else {
          // Unload invalid libraries
<span class="line-new-header">--- 181,27 ---</span>
      // AOT libs are loaded before heap initialized so shift values are not set.
      // It is okay since ObjectAlignmentInBytes flag which defines shifts value is set before AOT libs are loaded.
      // AOT sets shift values during heap and metaspace initialization.
      // Check shifts value to make sure thay did not change.
      if (UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized()) {
<span class="line-modified">!       int oop_shift = CompressedOops::shift();</span>
        FOR_ALL_AOT_LIBRARIES(lib) {
<span class="line-modified">!         (*lib)-&gt;verify_flag((*lib)-&gt;config()-&gt;_narrowOopShift, oop_shift, &quot;CompressedOops::shift&quot;);</span>
        }
        if (UseCompressedClassPointers) { // It is set only if UseCompressedOops is set
<span class="line-modified">!         int klass_shift = CompressedKlassPointers::shift();</span>
          FOR_ALL_AOT_LIBRARIES(lib) {
<span class="line-modified">!           (*lib)-&gt;verify_flag((*lib)-&gt;config()-&gt;_narrowKlassShift, klass_shift, &quot;CompressedKlassPointers::shift&quot;);</span>
          }
        }
      }
      // Create heaps for all valid libraries
      FOR_ALL_AOT_LIBRARIES(lib) {
        if ((*lib)-&gt;is_valid()) {
          AOTCodeHeap* heap = new AOTCodeHeap(*lib);
          {
<span class="line-modified">!           MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
            add_heap(heap);
            CodeCache::add_heap(heap);
          }
        } else {
          // Unload invalid libraries
</pre>
<hr />
<pre>
<span class="line-old-header">*** 223,25 ***</span>
  
  void AOTLoader::set_narrow_oop_shift() {
    // This method is called from Universe::initialize_heap().
    if (UseAOT &amp;&amp; libraries_count() &gt; 0 &amp;&amp;
        UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized()) {
<span class="line-modified">!     if (Universe::narrow_oop_shift() == 0) {</span>
        // 0 is valid shift value for small heap but we can safely increase it
        // at this point when nobody used it yet.
<span class="line-modified">!       Universe::set_narrow_oop_shift(AOTLib::narrow_oop_shift());</span>
      }
    }
  }
  
  void AOTLoader::set_narrow_klass_shift() {
    // This method is called from Metaspace::set_narrow_klass_base_and_shift().
    if (UseAOT &amp;&amp; libraries_count() &gt; 0 &amp;&amp;
        UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized() &amp;&amp;
        UseCompressedClassPointers) {
<span class="line-modified">!     if (Universe::narrow_klass_shift() == 0) {</span>
<span class="line-modified">!       Universe::set_narrow_klass_shift(AOTLib::narrow_klass_shift());</span>
      }
    }
  }
  
  void AOTLoader::load_library(const char* name, bool exit_on_error) {
<span class="line-new-header">--- 222,25 ---</span>
  
  void AOTLoader::set_narrow_oop_shift() {
    // This method is called from Universe::initialize_heap().
    if (UseAOT &amp;&amp; libraries_count() &gt; 0 &amp;&amp;
        UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized()) {
<span class="line-modified">!     if (CompressedOops::shift() == 0) {</span>
        // 0 is valid shift value for small heap but we can safely increase it
        // at this point when nobody used it yet.
<span class="line-modified">!       CompressedOops::set_shift(AOTLib::narrow_oop_shift());</span>
      }
    }
  }
  
  void AOTLoader::set_narrow_klass_shift() {
    // This method is called from Metaspace::set_narrow_klass_base_and_shift().
    if (UseAOT &amp;&amp; libraries_count() &gt; 0 &amp;&amp;
        UseCompressedOops &amp;&amp; AOTLib::narrow_oop_shift_initialized() &amp;&amp;
        UseCompressedClassPointers) {
<span class="line-modified">!     if (CompressedKlassPointers::shift() == 0) {</span>
<span class="line-modified">!       CompressedKlassPointers::set_shift(AOTLib::narrow_klass_shift());</span>
      }
    }
  }
  
  void AOTLoader::load_library(const char* name, bool exit_on_error) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 317,5 ***</span>
<span class="line-new-header">--- 316,26 ---</span>
    guarantee(caller_heap != NULL, &quot;CodeHeap not found&quot;);
    bool success = caller_heap-&gt;reconcile_dynamic_invoke(aot, holder, index, adapter_method, appendix_klass);
    vmassert(success || thread-&gt;last_frame().sender(&amp;map).is_deoptimized_frame(), &quot;caller not deoptimized on failure&quot;);
    return success;
  }
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ // This should be called very early during startup before any of the AOTed methods that use boxes can deoptimize.</span>
<span class="line-added">+ // Deoptimization machinery expects the caches to be present and populated.</span>
<span class="line-added">+ void AOTLoader::initialize_box_caches(TRAPS) {</span>
<span class="line-added">+   if (!UseAOT || libraries_count() == 0) {</span>
<span class="line-added">+     return;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   TraceTime timer(&quot;AOT initialization of box caches&quot;, TRACETIME_LOG(Info, aot, startuptime));</span>
<span class="line-added">+   Symbol* box_classes[] = { java_lang_Boolean::symbol(), java_lang_Byte_ByteCache::symbol(),</span>
<span class="line-added">+     java_lang_Short_ShortCache::symbol(), java_lang_Character_CharacterCache::symbol(),</span>
<span class="line-added">+     java_lang_Integer_IntegerCache::symbol(), java_lang_Long_LongCache::symbol() };</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (unsigned i = 0; i &lt; sizeof(box_classes) / sizeof(Symbol*); i++) {</span>
<span class="line-added">+     Klass* k = SystemDictionary::resolve_or_fail(box_classes[i], true, CHECK);</span>
<span class="line-added">+     InstanceKlass* ik = InstanceKlass::cast(k);</span>
<span class="line-added">+     if (ik-&gt;is_not_initialized()) {</span>
<span class="line-added">+       ik-&gt;initialize(CHECK);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="aotCompiledMethod.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="aotLoader.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>