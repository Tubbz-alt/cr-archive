<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/code/vtableStubs.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="vmreg.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vtableStubs.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/code/vtableStubs.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -36,10 +36,11 @@</span>
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/mutexLocker.hpp&quot;
  #include &quot;runtime/sharedRuntime.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/powerOfTwo.hpp&quot;</span>
  #ifdef COMPILER2
  #include &quot;opto/matcher.hpp&quot;
  #endif
  
  // -----------------------------------------------------------------------------------------
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,14 +79,15 @@</span>
   return res;
  }
  
  
  void VtableStub::print_on(outputStream* st) const {
<span class="udiff-line-modified-removed">-   st-&gt;print(&quot;vtable stub (index = %d, receiver_location = &quot; INTX_FORMAT &quot;, code = [&quot; INTPTR_FORMAT &quot;, &quot; INTPTR_FORMAT &quot;[)&quot;,</span>
<span class="udiff-line-modified-added">+   st-&gt;print(&quot;vtable stub (index = %d, receiver_location = &quot; INTX_FORMAT &quot;, code = [&quot; INTPTR_FORMAT &quot;, &quot; INTPTR_FORMAT &quot;])&quot;,</span>
               index(), p2i(receiver_location()), p2i(code_begin()), p2i(code_end()));
  }
  
<span class="udiff-line-added">+ void VtableStub::print() const { print_on(tty); }</span>
  
  // -----------------------------------------------------------------------------------------
  // Implementation of VtableStubs
  //
  // For each hash value there&#39;s a linked list of vtable stubs (with that
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,13 +125,13 @@</span>
  
  
  void VtableStubs::initialize() {
    VtableStub::_receiver_location = SharedRuntime::name_for_receiver();
    {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MutexLocker ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
      assert(_number_of_vtable_stubs == 0, &quot;potential performance bug: VtableStubs initialized more than once&quot;);
<span class="udiff-line-modified-removed">-     assert(is_power_of_2(N), &quot;N must be a power of 2&quot;);</span>
<span class="udiff-line-modified-added">+     assert(is_power_of_2(int(N)), &quot;N must be a power of 2&quot;);</span>
      for (int i = 0; i &lt; N; i++) {
        _table[i] = NULL;
      }
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -209,12 +211,12 @@</span>
  address VtableStubs::find_stub(bool is_vtable_stub, int vtable_index) {
    assert(vtable_index &gt;= 0, &quot;must be positive&quot;);
  
    VtableStub* s;
    {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-removed">-     s = ShareVtableStubs ? lookup(is_vtable_stub, vtable_index) : NULL;</span>
<span class="udiff-line-modified-added">+     MutexLocker ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     s = lookup(is_vtable_stub, vtable_index);</span>
      if (s == NULL) {
        if (is_vtable_stub) {
          s = create_vtable_stub(vtable_index);
        } else {
          s = create_itable_stub(vtable_index);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,11 +233,12 @@</span>
                        is_vtable_stub? &quot;vtbl&quot;: &quot;itbl&quot;, vtable_index, p2i(VtableStub::receiver_location()));
          Disassembler::decode(s-&gt;code_begin(), s-&gt;code_end());
        }
        // Notify JVMTI about this stub. The event will be recorded by the enclosing
        // JvmtiDynamicCodeEventCollector and posted when this thread has released
<span class="udiff-line-modified-removed">-       // all locks.</span>
<span class="udiff-line-modified-added">+       // all locks. Only post this event if a new state is not required. Creating a new state would</span>
<span class="udiff-line-added">+       // cause a safepoint and the caller of this code has a NoSafepointVerifier.</span>
        if (JvmtiExport::should_post_dynamic_code_generated()) {
          JvmtiExport::post_dynamic_code_generated_while_holding_locks(is_vtable_stub? &quot;vtable stub&quot;: &quot;itable stub&quot;,
                                                                       s-&gt;code_begin(), s-&gt;code_end());
        }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -269,11 +272,11 @@</span>
    _table[h] = s;
    _number_of_vtable_stubs++;
  }
  
  VtableStub* VtableStubs::entry_point(address pc) {
<span class="udiff-line-modified-removed">-   MutexLockerEx ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker ml(VtableStubs_lock, Mutex::_no_safepoint_check_flag);</span>
    VtableStub* stub = (VtableStub*)(pc - VtableStub::entry_offset());
    uint hash = VtableStubs::hash(stub-&gt;is_vtable_stub(), stub-&gt;index());
    VtableStub* s;
    for (s = _table[hash]; s != NULL &amp;&amp; s != stub; s = s-&gt;next()) {}
    return (s == stub) ? s : NULL;
</pre>
<center><a href="vmreg.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vtableStubs.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>