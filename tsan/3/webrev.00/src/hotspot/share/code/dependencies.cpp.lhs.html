<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/code/dependencies.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciArrayKlass.hpp&quot;
  27 #include &quot;ci/ciEnv.hpp&quot;
  28 #include &quot;ci/ciKlass.hpp&quot;
  29 #include &quot;ci/ciMethod.hpp&quot;
  30 #include &quot;classfile/javaClasses.inline.hpp&quot;
  31 #include &quot;code/dependencies.hpp&quot;
  32 #include &quot;compiler/compileLog.hpp&quot;
  33 #include &quot;compiler/compileBroker.hpp&quot;
  34 #include &quot;compiler/compileTask.hpp&quot;
  35 #include &quot;memory/resourceArea.hpp&quot;
  36 #include &quot;oops/klass.hpp&quot;
  37 #include &quot;oops/oop.inline.hpp&quot;
  38 #include &quot;oops/objArrayKlass.hpp&quot;
  39 #include &quot;runtime/flags/flagSetting.hpp&quot;
  40 #include &quot;runtime/handles.hpp&quot;
  41 #include &quot;runtime/handles.inline.hpp&quot;
  42 #include &quot;runtime/jniHandles.inline.hpp&quot;
  43 #include &quot;runtime/thread.inline.hpp&quot;
  44 #include &quot;utilities/copy.hpp&quot;
  45 
  46 
  47 #ifdef ASSERT
  48 static bool must_be_in_vm() {
  49   Thread* thread = Thread::current();
  50   if (thread-&gt;is_Java_thread())
  51     return ((JavaThread*)thread)-&gt;thread_state() == _thread_in_vm;
  52   else
  53     return true;  //something like this: thread-&gt;is_VM_thread();
  54 }
  55 #endif //ASSERT
  56 
  57 void Dependencies::initialize(ciEnv* env) {
  58   Arena* arena = env-&gt;arena();
  59   _oop_recorder = env-&gt;oop_recorder();
  60   _log = env-&gt;log();
  61   _dep_seen = new(arena) GrowableArray&lt;int&gt;(arena, 500, 0, 0);
  62 #if INCLUDE_JVMCI
  63   _using_dep_values = false;
  64 #endif
  65   DEBUG_ONLY(_deps[end_marker] = NULL);
  66   for (int i = (int)FIRST_TYPE; i &lt; (int)TYPE_LIMIT; i++) {
  67     _deps[i] = new(arena) GrowableArray&lt;ciBaseObject*&gt;(arena, 10, 0, 0);
  68   }
  69   _content_bytes = NULL;
  70   _size_in_bytes = (size_t)-1;
  71 
  72   assert(TYPE_LIMIT &lt;= (1&lt;&lt;LG2_TYPE_LIMIT), &quot;sanity&quot;);
  73 }
  74 
  75 void Dependencies::assert_evol_method(ciMethod* m) {
  76   assert_common_1(evol_method, m);
  77 }
  78 
  79 void Dependencies::assert_leaf_type(ciKlass* ctxk) {
  80   if (ctxk-&gt;is_array_klass()) {
  81     // As a special case, support this assertion on an array type,
  82     // which reduces to an assertion on its element type.
  83     // Note that this cannot be done with assertions that
  84     // relate to concreteness or abstractness.
  85     ciType* elemt = ctxk-&gt;as_array_klass()-&gt;base_element_type();
  86     if (!elemt-&gt;is_instance_klass())  return;   // Ex:  int[][]
  87     ctxk = elemt-&gt;as_instance_klass();
  88     //if (ctxk-&gt;is_final())  return;            // Ex:  String[][]
  89   }
  90   check_ctxk(ctxk);
  91   assert_common_1(leaf_type, ctxk);
  92 }
  93 
  94 void Dependencies::assert_abstract_with_unique_concrete_subtype(ciKlass* ctxk, ciKlass* conck) {
  95   check_ctxk_abstract(ctxk);
  96   assert_common_2(abstract_with_unique_concrete_subtype, ctxk, conck);
  97 }
  98 
  99 void Dependencies::assert_abstract_with_no_concrete_subtype(ciKlass* ctxk) {
 100   check_ctxk_abstract(ctxk);
 101   assert_common_1(abstract_with_no_concrete_subtype, ctxk);
 102 }
 103 
 104 void Dependencies::assert_concrete_with_no_concrete_subtype(ciKlass* ctxk) {
 105   check_ctxk_concrete(ctxk);
 106   assert_common_1(concrete_with_no_concrete_subtype, ctxk);
 107 }
 108 
 109 void Dependencies::assert_unique_concrete_method(ciKlass* ctxk, ciMethod* uniqm) {
 110   check_ctxk(ctxk);
<a name="2" id="anc2"></a>
 111   assert_common_2(unique_concrete_method, ctxk, uniqm);
 112 }
 113 
 114 void Dependencies::assert_abstract_with_exclusive_concrete_subtypes(ciKlass* ctxk, ciKlass* k1, ciKlass* k2) {
 115   check_ctxk(ctxk);
 116   assert_common_3(abstract_with_exclusive_concrete_subtypes_2, ctxk, k1, k2);
 117 }
 118 
 119 void Dependencies::assert_exclusive_concrete_methods(ciKlass* ctxk, ciMethod* m1, ciMethod* m2) {
 120   check_ctxk(ctxk);
 121   assert_common_3(exclusive_concrete_methods_2, ctxk, m1, m2);
 122 }
 123 
 124 void Dependencies::assert_has_no_finalizable_subclasses(ciKlass* ctxk) {
 125   check_ctxk(ctxk);
 126   assert_common_1(no_finalizable_subclasses, ctxk);
 127 }
 128 
 129 void Dependencies::assert_call_site_target_value(ciCallSite* call_site, ciMethodHandle* method_handle) {
 130   assert_common_2(call_site_target_value, call_site, method_handle);
 131 }
 132 
 133 #if INCLUDE_JVMCI
 134 
 135 Dependencies::Dependencies(Arena* arena, OopRecorder* oop_recorder, CompileLog* log) {
 136   _oop_recorder = oop_recorder;
 137   _log = log;
 138   _dep_seen = new(arena) GrowableArray&lt;int&gt;(arena, 500, 0, 0);
 139   _using_dep_values = true;
 140   DEBUG_ONLY(_dep_values[end_marker] = NULL);
 141   for (int i = (int)FIRST_TYPE; i &lt; (int)TYPE_LIMIT; i++) {
 142     _dep_values[i] = new(arena) GrowableArray&lt;DepValue&gt;(arena, 10, 0, DepValue());
 143   }
 144   _content_bytes = NULL;
 145   _size_in_bytes = (size_t)-1;
 146 
 147   assert(TYPE_LIMIT &lt;= (1&lt;&lt;LG2_TYPE_LIMIT), &quot;sanity&quot;);
 148 }
 149 
 150 void Dependencies::assert_evol_method(Method* m) {
 151   assert_common_1(evol_method, DepValue(_oop_recorder, m));
 152 }
 153 
 154 void Dependencies::assert_has_no_finalizable_subclasses(Klass* ctxk) {
 155   check_ctxk(ctxk);
 156   assert_common_1(no_finalizable_subclasses, DepValue(_oop_recorder, ctxk));
 157 }
 158 
 159 void Dependencies::assert_leaf_type(Klass* ctxk) {
 160   if (ctxk-&gt;is_array_klass()) {
 161     // As a special case, support this assertion on an array type,
 162     // which reduces to an assertion on its element type.
 163     // Note that this cannot be done with assertions that
 164     // relate to concreteness or abstractness.
 165     BasicType elemt = ArrayKlass::cast(ctxk)-&gt;element_type();
 166     if (is_java_primitive(elemt))  return;   // Ex:  int[][]
 167     ctxk = ObjArrayKlass::cast(ctxk)-&gt;bottom_klass();
 168     //if (ctxk-&gt;is_final())  return;            // Ex:  String[][]
 169   }
 170   check_ctxk(ctxk);
 171   assert_common_1(leaf_type, DepValue(_oop_recorder, ctxk));
 172 }
 173 
 174 void Dependencies::assert_abstract_with_unique_concrete_subtype(Klass* ctxk, Klass* conck) {
 175   check_ctxk_abstract(ctxk);
 176   DepValue ctxk_dv(_oop_recorder, ctxk);
 177   DepValue conck_dv(_oop_recorder, conck, &amp;ctxk_dv);
 178   assert_common_2(abstract_with_unique_concrete_subtype, ctxk_dv, conck_dv);
 179 }
 180 
 181 void Dependencies::assert_unique_concrete_method(Klass* ctxk, Method* uniqm) {
 182   check_ctxk(ctxk);
<a name="3" id="anc3"></a>
 183   assert_common_2(unique_concrete_method, DepValue(_oop_recorder, ctxk), DepValue(_oop_recorder, uniqm));
 184 }
 185 
 186 void Dependencies::assert_call_site_target_value(oop call_site, oop method_handle) {
 187   assert_common_2(call_site_target_value, DepValue(_oop_recorder, JNIHandles::make_local(call_site)), DepValue(_oop_recorder, JNIHandles::make_local(method_handle)));
 188 }
 189 
 190 #endif // INCLUDE_JVMCI
 191 
 192 
 193 // Helper function.  If we are adding a new dep. under ctxk2,
 194 // try to find an old dep. under a broader* ctxk1.  If there is
 195 //
 196 bool Dependencies::maybe_merge_ctxk(GrowableArray&lt;ciBaseObject*&gt;* deps,
 197                                     int ctxk_i, ciKlass* ctxk2) {
 198   ciKlass* ctxk1 = deps-&gt;at(ctxk_i)-&gt;as_metadata()-&gt;as_klass();
 199   if (ctxk2-&gt;is_subtype_of(ctxk1)) {
 200     return true;  // success, and no need to change
 201   } else if (ctxk1-&gt;is_subtype_of(ctxk2)) {
 202     // new context class fully subsumes previous one
 203     deps-&gt;at_put(ctxk_i, ctxk2);
 204     return true;
 205   } else {
 206     return false;
 207   }
 208 }
 209 
 210 void Dependencies::assert_common_1(DepType dept, ciBaseObject* x) {
 211   assert(dep_args(dept) == 1, &quot;sanity&quot;);
 212   log_dependency(dept, x);
 213   GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 214 
 215   // see if the same (or a similar) dep is already recorded
 216   if (note_dep_seen(dept, x)) {
 217     assert(deps-&gt;find(x) &gt;= 0, &quot;sanity&quot;);
 218   } else {
 219     deps-&gt;append(x);
 220   }
 221 }
 222 
 223 void Dependencies::assert_common_2(DepType dept,
 224                                    ciBaseObject* x0, ciBaseObject* x1) {
 225   assert(dep_args(dept) == 2, &quot;sanity&quot;);
 226   log_dependency(dept, x0, x1);
 227   GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 228 
 229   // see if the same (or a similar) dep is already recorded
 230   bool has_ctxk = has_explicit_context_arg(dept);
 231   if (has_ctxk) {
 232     assert(dep_context_arg(dept) == 0, &quot;sanity&quot;);
 233     if (note_dep_seen(dept, x1)) {
 234       // look in this bucket for redundant assertions
 235       const int stride = 2;
 236       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 237         ciBaseObject* y1 = deps-&gt;at(i+1);
 238         if (x1 == y1) {  // same subject; check the context
 239           if (maybe_merge_ctxk(deps, i+0, x0-&gt;as_metadata()-&gt;as_klass())) {
 240             return;
 241           }
 242         }
 243       }
 244     }
 245   } else {
 246     if (note_dep_seen(dept, x0) &amp;&amp; note_dep_seen(dept, x1)) {
 247       // look in this bucket for redundant assertions
 248       const int stride = 2;
 249       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 250         ciBaseObject* y0 = deps-&gt;at(i+0);
 251         ciBaseObject* y1 = deps-&gt;at(i+1);
 252         if (x0 == y0 &amp;&amp; x1 == y1) {
 253           return;
 254         }
 255       }
 256     }
 257   }
 258 
 259   // append the assertion in the correct bucket:
 260   deps-&gt;append(x0);
 261   deps-&gt;append(x1);
 262 }
 263 
 264 void Dependencies::assert_common_3(DepType dept,
 265                                    ciKlass* ctxk, ciBaseObject* x, ciBaseObject* x2) {
 266   assert(dep_context_arg(dept) == 0, &quot;sanity&quot;);
 267   assert(dep_args(dept) == 3, &quot;sanity&quot;);
 268   log_dependency(dept, ctxk, x, x2);
 269   GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 270 
 271   // try to normalize an unordered pair:
 272   bool swap = false;
 273   switch (dept) {
 274   case abstract_with_exclusive_concrete_subtypes_2:
 275     swap = (x-&gt;ident() &gt; x2-&gt;ident() &amp;&amp; x-&gt;as_metadata()-&gt;as_klass() != ctxk);
 276     break;
 277   case exclusive_concrete_methods_2:
 278     swap = (x-&gt;ident() &gt; x2-&gt;ident() &amp;&amp; x-&gt;as_metadata()-&gt;as_method()-&gt;holder() != ctxk);
 279     break;
 280   default:
 281     break;
 282   }
 283   if (swap) { ciBaseObject* t = x; x = x2; x2 = t; }
 284 
 285   // see if the same (or a similar) dep is already recorded
 286   if (note_dep_seen(dept, x) &amp;&amp; note_dep_seen(dept, x2)) {
 287     // look in this bucket for redundant assertions
 288     const int stride = 3;
 289     for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 290       ciBaseObject* y  = deps-&gt;at(i+1);
 291       ciBaseObject* y2 = deps-&gt;at(i+2);
 292       if (x == y &amp;&amp; x2 == y2) {  // same subjects; check the context
 293         if (maybe_merge_ctxk(deps, i+0, ctxk)) {
 294           return;
 295         }
 296       }
 297     }
 298   }
 299   // append the assertion in the correct bucket:
 300   deps-&gt;append(ctxk);
 301   deps-&gt;append(x);
 302   deps-&gt;append(x2);
 303 }
 304 
 305 #if INCLUDE_JVMCI
 306 bool Dependencies::maybe_merge_ctxk(GrowableArray&lt;DepValue&gt;* deps,
 307                                     int ctxk_i, DepValue ctxk2_dv) {
 308   Klass* ctxk1 = deps-&gt;at(ctxk_i).as_klass(_oop_recorder);
 309   Klass* ctxk2 = ctxk2_dv.as_klass(_oop_recorder);
 310   if (ctxk2-&gt;is_subtype_of(ctxk1)) {
 311     return true;  // success, and no need to change
 312   } else if (ctxk1-&gt;is_subtype_of(ctxk2)) {
 313     // new context class fully subsumes previous one
 314     deps-&gt;at_put(ctxk_i, ctxk2_dv);
 315     return true;
 316   } else {
 317     return false;
 318   }
 319 }
 320 
 321 void Dependencies::assert_common_1(DepType dept, DepValue x) {
 322   assert(dep_args(dept) == 1, &quot;sanity&quot;);
 323   //log_dependency(dept, x);
 324   GrowableArray&lt;DepValue&gt;* deps = _dep_values[dept];
 325 
 326   // see if the same (or a similar) dep is already recorded
 327   if (note_dep_seen(dept, x)) {
 328     assert(deps-&gt;find(x) &gt;= 0, &quot;sanity&quot;);
 329   } else {
 330     deps-&gt;append(x);
 331   }
 332 }
 333 
 334 void Dependencies::assert_common_2(DepType dept,
 335                                    DepValue x0, DepValue x1) {
 336   assert(dep_args(dept) == 2, &quot;sanity&quot;);
 337   //log_dependency(dept, x0, x1);
 338   GrowableArray&lt;DepValue&gt;* deps = _dep_values[dept];
 339 
 340   // see if the same (or a similar) dep is already recorded
 341   bool has_ctxk = has_explicit_context_arg(dept);
 342   if (has_ctxk) {
 343     assert(dep_context_arg(dept) == 0, &quot;sanity&quot;);
 344     if (note_dep_seen(dept, x1)) {
 345       // look in this bucket for redundant assertions
 346       const int stride = 2;
 347       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 348         DepValue y1 = deps-&gt;at(i+1);
 349         if (x1 == y1) {  // same subject; check the context
 350           if (maybe_merge_ctxk(deps, i+0, x0)) {
 351             return;
 352           }
 353         }
 354       }
 355     }
 356   } else {
 357     if (note_dep_seen(dept, x0) &amp;&amp; note_dep_seen(dept, x1)) {
 358       // look in this bucket for redundant assertions
 359       const int stride = 2;
 360       for (int i = deps-&gt;length(); (i -= stride) &gt;= 0; ) {
 361         DepValue y0 = deps-&gt;at(i+0);
 362         DepValue y1 = deps-&gt;at(i+1);
 363         if (x0 == y0 &amp;&amp; x1 == y1) {
 364           return;
 365         }
 366       }
 367     }
 368   }
 369 
 370   // append the assertion in the correct bucket:
 371   deps-&gt;append(x0);
 372   deps-&gt;append(x1);
 373 }
 374 #endif // INCLUDE_JVMCI
 375 
 376 /// Support for encoding dependencies into an nmethod:
 377 
 378 void Dependencies::copy_to(nmethod* nm) {
 379   address beg = nm-&gt;dependencies_begin();
 380   address end = nm-&gt;dependencies_end();
 381   guarantee(end - beg &gt;= (ptrdiff_t) size_in_bytes(), &quot;bad sizing&quot;);
 382   Copy::disjoint_words((HeapWord*) content_bytes(),
 383                        (HeapWord*) beg,
 384                        size_in_bytes() / sizeof(HeapWord));
 385   assert(size_in_bytes() % sizeof(HeapWord) == 0, &quot;copy by words&quot;);
 386 }
 387 
 388 static int sort_dep(ciBaseObject** p1, ciBaseObject** p2, int narg) {
 389   for (int i = 0; i &lt; narg; i++) {
 390     int diff = p1[i]-&gt;ident() - p2[i]-&gt;ident();
 391     if (diff != 0)  return diff;
 392   }
 393   return 0;
 394 }
 395 static int sort_dep_arg_1(ciBaseObject** p1, ciBaseObject** p2)
 396 { return sort_dep(p1, p2, 1); }
 397 static int sort_dep_arg_2(ciBaseObject** p1, ciBaseObject** p2)
 398 { return sort_dep(p1, p2, 2); }
 399 static int sort_dep_arg_3(ciBaseObject** p1, ciBaseObject** p2)
 400 { return sort_dep(p1, p2, 3); }
 401 
 402 #if INCLUDE_JVMCI
 403 // metadata deps are sorted before object deps
 404 static int sort_dep_value(Dependencies::DepValue* p1, Dependencies::DepValue* p2, int narg) {
 405   for (int i = 0; i &lt; narg; i++) {
 406     int diff = p1[i].sort_key() - p2[i].sort_key();
 407     if (diff != 0)  return diff;
 408   }
 409   return 0;
 410 }
 411 static int sort_dep_value_arg_1(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 412 { return sort_dep_value(p1, p2, 1); }
 413 static int sort_dep_value_arg_2(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 414 { return sort_dep_value(p1, p2, 2); }
 415 static int sort_dep_value_arg_3(Dependencies::DepValue* p1, Dependencies::DepValue* p2)
 416 { return sort_dep_value(p1, p2, 3); }
 417 #endif // INCLUDE_JVMCI
 418 
 419 void Dependencies::sort_all_deps() {
 420 #if INCLUDE_JVMCI
 421   if (_using_dep_values) {
 422     for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 423       DepType dept = (DepType)deptv;
 424       GrowableArray&lt;DepValue&gt;* deps = _dep_values[dept];
 425       if (deps-&gt;length() &lt;= 1)  continue;
 426       switch (dep_args(dept)) {
 427       case 1: deps-&gt;sort(sort_dep_value_arg_1, 1); break;
 428       case 2: deps-&gt;sort(sort_dep_value_arg_2, 2); break;
 429       case 3: deps-&gt;sort(sort_dep_value_arg_3, 3); break;
 430       default: ShouldNotReachHere(); break;
 431       }
 432     }
 433     return;
 434   }
 435 #endif // INCLUDE_JVMCI
 436   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 437     DepType dept = (DepType)deptv;
 438     GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 439     if (deps-&gt;length() &lt;= 1)  continue;
 440     switch (dep_args(dept)) {
 441     case 1: deps-&gt;sort(sort_dep_arg_1, 1); break;
 442     case 2: deps-&gt;sort(sort_dep_arg_2, 2); break;
 443     case 3: deps-&gt;sort(sort_dep_arg_3, 3); break;
 444     default: ShouldNotReachHere(); break;
 445     }
 446   }
 447 }
 448 
 449 size_t Dependencies::estimate_size_in_bytes() {
 450   size_t est_size = 100;
 451 #if INCLUDE_JVMCI
 452   if (_using_dep_values) {
 453     for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 454       DepType dept = (DepType)deptv;
 455       GrowableArray&lt;DepValue&gt;* deps = _dep_values[dept];
 456       est_size += deps-&gt;length() * 2;  // tags and argument(s)
 457     }
 458     return est_size;
 459   }
 460 #endif // INCLUDE_JVMCI
 461   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 462     DepType dept = (DepType)deptv;
 463     GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 464     est_size += deps-&gt;length()*2;  // tags and argument(s)
 465   }
 466   return est_size;
 467 }
 468 
 469 ciKlass* Dependencies::ctxk_encoded_as_null(DepType dept, ciBaseObject* x) {
 470   switch (dept) {
 471   case abstract_with_exclusive_concrete_subtypes_2:
 472     return x-&gt;as_metadata()-&gt;as_klass();
 473   case unique_concrete_method:
 474   case exclusive_concrete_methods_2:
 475     return x-&gt;as_metadata()-&gt;as_method()-&gt;holder();
 476   default:
 477     return NULL;  // let NULL be NULL
 478   }
 479 }
 480 
 481 Klass* Dependencies::ctxk_encoded_as_null(DepType dept, Metadata* x) {
 482   assert(must_be_in_vm(), &quot;raw oops here&quot;);
 483   switch (dept) {
 484   case abstract_with_exclusive_concrete_subtypes_2:
 485     assert(x-&gt;is_klass(), &quot;sanity&quot;);
 486     return (Klass*) x;
 487   case unique_concrete_method:
 488   case exclusive_concrete_methods_2:
 489     assert(x-&gt;is_method(), &quot;sanity&quot;);
 490     return ((Method*)x)-&gt;method_holder();
 491   default:
 492     return NULL;  // let NULL be NULL
 493   }
 494 }
 495 
 496 void Dependencies::encode_content_bytes() {
 497   sort_all_deps();
 498 
 499   // cast is safe, no deps can overflow INT_MAX
 500   CompressedWriteStream bytes((int)estimate_size_in_bytes());
 501 
 502 #if INCLUDE_JVMCI
 503   if (_using_dep_values) {
 504     for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 505       DepType dept = (DepType)deptv;
 506       GrowableArray&lt;DepValue&gt;* deps = _dep_values[dept];
 507       if (deps-&gt;length() == 0)  continue;
 508       int stride = dep_args(dept);
 509       int ctxkj  = dep_context_arg(dept);  // -1 if no context arg
 510       assert(stride &gt; 0, &quot;sanity&quot;);
 511       for (int i = 0; i &lt; deps-&gt;length(); i += stride) {
 512         jbyte code_byte = (jbyte)dept;
 513         int skipj = -1;
 514         if (ctxkj &gt;= 0 &amp;&amp; ctxkj+1 &lt; stride) {
 515           Klass*  ctxk = deps-&gt;at(i+ctxkj+0).as_klass(_oop_recorder);
 516           DepValue x = deps-&gt;at(i+ctxkj+1);  // following argument
 517           if (ctxk == ctxk_encoded_as_null(dept, x.as_metadata(_oop_recorder))) {
 518             skipj = ctxkj;  // we win:  maybe one less oop to keep track of
 519             code_byte |= default_context_type_bit;
 520           }
 521         }
 522         bytes.write_byte(code_byte);
 523         for (int j = 0; j &lt; stride; j++) {
 524           if (j == skipj)  continue;
 525           DepValue v = deps-&gt;at(i+j);
 526           int idx = v.index();
 527           bytes.write_int(idx);
 528         }
 529       }
 530     }
 531   } else {
 532 #endif // INCLUDE_JVMCI
 533   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 534     DepType dept = (DepType)deptv;
 535     GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 536     if (deps-&gt;length() == 0)  continue;
 537     int stride = dep_args(dept);
 538     int ctxkj  = dep_context_arg(dept);  // -1 if no context arg
 539     assert(stride &gt; 0, &quot;sanity&quot;);
 540     for (int i = 0; i &lt; deps-&gt;length(); i += stride) {
 541       jbyte code_byte = (jbyte)dept;
 542       int skipj = -1;
 543       if (ctxkj &gt;= 0 &amp;&amp; ctxkj+1 &lt; stride) {
 544         ciKlass*  ctxk = deps-&gt;at(i+ctxkj+0)-&gt;as_metadata()-&gt;as_klass();
 545         ciBaseObject* x     = deps-&gt;at(i+ctxkj+1);  // following argument
 546         if (ctxk == ctxk_encoded_as_null(dept, x)) {
 547           skipj = ctxkj;  // we win:  maybe one less oop to keep track of
 548           code_byte |= default_context_type_bit;
 549         }
 550       }
 551       bytes.write_byte(code_byte);
 552       for (int j = 0; j &lt; stride; j++) {
 553         if (j == skipj)  continue;
 554         ciBaseObject* v = deps-&gt;at(i+j);
 555         int idx;
 556         if (v-&gt;is_object()) {
 557           idx = _oop_recorder-&gt;find_index(v-&gt;as_object()-&gt;constant_encoding());
 558         } else {
 559           ciMetadata* meta = v-&gt;as_metadata();
 560           idx = _oop_recorder-&gt;find_index(meta-&gt;constant_encoding());
 561         }
 562         bytes.write_int(idx);
 563       }
 564     }
 565   }
 566 #if INCLUDE_JVMCI
 567   }
 568 #endif
 569 
 570   // write a sentinel byte to mark the end
 571   bytes.write_byte(end_marker);
 572 
 573   // round it out to a word boundary
 574   while (bytes.position() % sizeof(HeapWord) != 0) {
 575     bytes.write_byte(end_marker);
 576   }
 577 
 578   // check whether the dept byte encoding really works
 579   assert((jbyte)default_context_type_bit != 0, &quot;byte overflow&quot;);
 580 
 581   _content_bytes = bytes.buffer();
 582   _size_in_bytes = bytes.position();
 583 }
 584 
 585 
 586 const char* Dependencies::_dep_name[TYPE_LIMIT] = {
 587   &quot;end_marker&quot;,
 588   &quot;evol_method&quot;,
 589   &quot;leaf_type&quot;,
 590   &quot;abstract_with_unique_concrete_subtype&quot;,
 591   &quot;abstract_with_no_concrete_subtype&quot;,
 592   &quot;concrete_with_no_concrete_subtype&quot;,
 593   &quot;unique_concrete_method&quot;,
 594   &quot;abstract_with_exclusive_concrete_subtypes_2&quot;,
 595   &quot;exclusive_concrete_methods_2&quot;,
 596   &quot;no_finalizable_subclasses&quot;,
 597   &quot;call_site_target_value&quot;
 598 };
 599 
 600 int Dependencies::_dep_args[TYPE_LIMIT] = {
 601   -1,// end_marker
 602   1, // evol_method m
 603   1, // leaf_type ctxk
 604   2, // abstract_with_unique_concrete_subtype ctxk, k
 605   1, // abstract_with_no_concrete_subtype ctxk
 606   1, // concrete_with_no_concrete_subtype ctxk
 607   2, // unique_concrete_method ctxk, m
 608   3, // unique_concrete_subtypes_2 ctxk, k1, k2
 609   3, // unique_concrete_methods_2 ctxk, m1, m2
 610   1, // no_finalizable_subclasses ctxk
 611   2  // call_site_target_value call_site, method_handle
 612 };
 613 
 614 const char* Dependencies::dep_name(Dependencies::DepType dept) {
 615   if (!dept_in_mask(dept, all_types))  return &quot;?bad-dep?&quot;;
 616   return _dep_name[dept];
 617 }
 618 
 619 int Dependencies::dep_args(Dependencies::DepType dept) {
 620   if (!dept_in_mask(dept, all_types))  return -1;
 621   return _dep_args[dept];
 622 }
 623 
 624 void Dependencies::check_valid_dependency_type(DepType dept) {
 625   guarantee(FIRST_TYPE &lt;= dept &amp;&amp; dept &lt; TYPE_LIMIT, &quot;invalid dependency type: %d&quot;, (int) dept);
 626 }
 627 
<a name="4" id="anc4"></a><span class="line-modified"> 628 Dependencies::DepType Dependencies::validate_dependencies(CompileTask* task, bool counter_changed, char** failure_detail) {</span>
<span class="line-removed"> 629   // First, check non-klass dependencies as we might return early and</span>
<span class="line-removed"> 630   // not check klass dependencies if the system dictionary</span>
<span class="line-removed"> 631   // modification counter hasn&#39;t changed (see below).</span>
<span class="line-removed"> 632   for (Dependencies::DepStream deps(this); deps.next(); ) {</span>
<span class="line-removed"> 633     if (deps.is_klass_type())  continue;  // skip klass dependencies</span>
<span class="line-removed"> 634     Klass* witness = deps.check_dependency();</span>
<span class="line-removed"> 635     if (witness != NULL) {</span>
<span class="line-removed"> 636       return deps.type();</span>
<span class="line-removed"> 637     }</span>
<span class="line-removed"> 638   }</span>
<span class="line-removed"> 639 </span>
<span class="line-removed"> 640   // Klass dependencies must be checked when the system dictionary</span>
<span class="line-removed"> 641   // changes.  If logging is enabled all violated dependences will be</span>
<span class="line-removed"> 642   // recorded in the log.  In debug mode check dependencies even if</span>
<span class="line-removed"> 643   // the system dictionary hasn&#39;t changed to verify that no invalid</span>
<span class="line-removed"> 644   // dependencies were inserted.  Any violated dependences in this</span>
<span class="line-removed"> 645   // case are dumped to the tty.</span>
<span class="line-removed"> 646   if (!counter_changed &amp;&amp; !trueInDebug) {</span>
<span class="line-removed"> 647     return end_marker;</span>
<span class="line-removed"> 648   }</span>
<span class="line-removed"> 649 </span>
 650   int klass_violations = 0;
 651   DepType result = end_marker;
 652   for (Dependencies::DepStream deps(this); deps.next(); ) {
<a name="5" id="anc5"></a><span class="line-removed"> 653     if (!deps.is_klass_type())  continue;  // skip non-klass dependencies</span>
 654     Klass* witness = deps.check_dependency();
 655     if (witness != NULL) {
 656       if (klass_violations == 0) {
 657         result = deps.type();
 658         if (failure_detail != NULL &amp;&amp; klass_violations == 0) {
 659           // Use a fixed size buffer to prevent the string stream from
 660           // resizing in the context of an inner resource mark.
 661           char* buffer = NEW_RESOURCE_ARRAY(char, O_BUFLEN);
 662           stringStream st(buffer, O_BUFLEN);
 663           deps.print_dependency(witness, true, &amp;st);
 664           *failure_detail = st.as_string();
 665         }
 666       }
 667       klass_violations++;
<a name="6" id="anc6"></a><span class="line-modified"> 668       if (!counter_changed) {</span>
<span class="line-removed"> 669         // Dependence failed but counter didn&#39;t change.  Log a message</span>
<span class="line-removed"> 670         // describing what failed and allow the assert at the end to</span>
<span class="line-removed"> 671         // trigger.</span>
<span class="line-removed"> 672         deps.print_dependency(witness);</span>
<span class="line-removed"> 673       } else if (xtty == NULL) {</span>
 674         // If we&#39;re not logging then a single violation is sufficient,
 675         // otherwise we want to log all the dependences which were
 676         // violated.
 677         break;
 678       }
 679     }
 680   }
 681 
<a name="7" id="anc7"></a><span class="line-removed"> 682   if (klass_violations != 0) {</span>
<span class="line-removed"> 683 #ifdef ASSERT</span>
<span class="line-removed"> 684     if (task != NULL &amp;&amp; !counter_changed &amp;&amp; !PrintCompilation) {</span>
<span class="line-removed"> 685       // Print out the compile task that failed</span>
<span class="line-removed"> 686       task-&gt;print_tty();</span>
<span class="line-removed"> 687     }</span>
<span class="line-removed"> 688 #endif</span>
<span class="line-removed"> 689     assert(counter_changed, &quot;failed dependencies, but counter didn&#39;t change&quot;);</span>
<span class="line-removed"> 690   }</span>
 691   return result;
 692 }
 693 
 694 // for the sake of the compiler log, print out current dependencies:
 695 void Dependencies::log_all_dependencies() {
 696   if (log() == NULL)  return;
 697   ResourceMark rm;
 698   for (int deptv = (int)FIRST_TYPE; deptv &lt; (int)TYPE_LIMIT; deptv++) {
 699     DepType dept = (DepType)deptv;
 700     GrowableArray&lt;ciBaseObject*&gt;* deps = _deps[dept];
 701     int deplen = deps-&gt;length();
 702     if (deplen == 0) {
 703       continue;
 704     }
 705     int stride = dep_args(dept);
 706     GrowableArray&lt;ciBaseObject*&gt;* ciargs = new GrowableArray&lt;ciBaseObject*&gt;(stride);
 707     for (int i = 0; i &lt; deps-&gt;length(); i += stride) {
 708       for (int j = 0; j &lt; stride; j++) {
 709         // flush out the identities before printing
 710         ciargs-&gt;push(deps-&gt;at(i+j));
 711       }
 712       write_dependency_to(log(), dept, ciargs);
 713       ciargs-&gt;clear();
 714     }
 715     guarantee(deplen == deps-&gt;length(), &quot;deps array cannot grow inside nested ResoureMark scope&quot;);
 716   }
 717 }
 718 
 719 void Dependencies::write_dependency_to(CompileLog* log,
 720                                        DepType dept,
 721                                        GrowableArray&lt;DepArgument&gt;* args,
 722                                        Klass* witness) {
 723   if (log == NULL) {
 724     return;
 725   }
 726   ResourceMark rm;
 727   ciEnv* env = ciEnv::current();
 728   GrowableArray&lt;ciBaseObject*&gt;* ciargs = new GrowableArray&lt;ciBaseObject*&gt;(args-&gt;length());
 729   for (GrowableArrayIterator&lt;DepArgument&gt; it = args-&gt;begin(); it != args-&gt;end(); ++it) {
 730     DepArgument arg = *it;
 731     if (arg.is_oop()) {
 732       ciargs-&gt;push(env-&gt;get_object(arg.oop_value()));
 733     } else {
 734       ciargs-&gt;push(env-&gt;get_metadata(arg.metadata_value()));
 735     }
 736   }
 737   int argslen = ciargs-&gt;length();
 738   Dependencies::write_dependency_to(log, dept, ciargs, witness);
 739   guarantee(argslen == ciargs-&gt;length(), &quot;ciargs array cannot grow inside nested ResoureMark scope&quot;);
 740 }
 741 
 742 void Dependencies::write_dependency_to(CompileLog* log,
 743                                        DepType dept,
 744                                        GrowableArray&lt;ciBaseObject*&gt;* args,
 745                                        Klass* witness) {
 746   if (log == NULL) {
 747     return;
 748   }
 749   ResourceMark rm;
 750   GrowableArray&lt;int&gt;* argids = new GrowableArray&lt;int&gt;(args-&gt;length());
 751   for (GrowableArrayIterator&lt;ciBaseObject*&gt; it = args-&gt;begin(); it != args-&gt;end(); ++it) {
 752     ciBaseObject* obj = *it;
 753     if (obj-&gt;is_object()) {
 754       argids-&gt;push(log-&gt;identify(obj-&gt;as_object()));
 755     } else {
 756       argids-&gt;push(log-&gt;identify(obj-&gt;as_metadata()));
 757     }
 758   }
 759   if (witness != NULL) {
 760     log-&gt;begin_elem(&quot;dependency_failed&quot;);
 761   } else {
 762     log-&gt;begin_elem(&quot;dependency&quot;);
 763   }
 764   log-&gt;print(&quot; type=&#39;%s&#39;&quot;, dep_name(dept));
 765   const int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 766   if (ctxkj &gt;= 0 &amp;&amp; ctxkj &lt; argids-&gt;length()) {
 767     log-&gt;print(&quot; ctxk=&#39;%d&#39;&quot;, argids-&gt;at(ctxkj));
 768   }
 769   // write remaining arguments, if any.
 770   for (int j = 0; j &lt; argids-&gt;length(); j++) {
 771     if (j == ctxkj)  continue;  // already logged
 772     if (j == 1) {
 773       log-&gt;print(  &quot; x=&#39;%d&#39;&quot;,    argids-&gt;at(j));
 774     } else {
 775       log-&gt;print(&quot; x%d=&#39;%d&#39;&quot;, j, argids-&gt;at(j));
 776     }
 777   }
 778   if (witness != NULL) {
 779     log-&gt;object(&quot;witness&quot;, witness);
 780     log-&gt;stamp();
 781   }
 782   log-&gt;end_elem();
 783 }
 784 
 785 void Dependencies::write_dependency_to(xmlStream* xtty,
 786                                        DepType dept,
 787                                        GrowableArray&lt;DepArgument&gt;* args,
 788                                        Klass* witness) {
 789   if (xtty == NULL) {
 790     return;
 791   }
 792   Thread* thread = Thread::current();
 793   HandleMark rm(thread);
 794   ttyLocker ttyl;
 795   int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 796   if (witness != NULL) {
 797     xtty-&gt;begin_elem(&quot;dependency_failed&quot;);
 798   } else {
 799     xtty-&gt;begin_elem(&quot;dependency&quot;);
 800   }
 801   xtty-&gt;print(&quot; type=&#39;%s&#39;&quot;, dep_name(dept));
 802   if (ctxkj &gt;= 0) {
 803     xtty-&gt;object(&quot;ctxk&quot;, args-&gt;at(ctxkj).metadata_value());
 804   }
 805   // write remaining arguments, if any.
 806   for (int j = 0; j &lt; args-&gt;length(); j++) {
 807     if (j == ctxkj)  continue;  // already logged
 808     DepArgument arg = args-&gt;at(j);
 809     if (j == 1) {
 810       if (arg.is_oop()) {
 811         xtty-&gt;object(&quot;x&quot;, Handle(thread, arg.oop_value()));
 812       } else {
 813         xtty-&gt;object(&quot;x&quot;, arg.metadata_value());
 814       }
 815     } else {
 816       char xn[12]; sprintf(xn, &quot;x%d&quot;, j);
 817       if (arg.is_oop()) {
 818         xtty-&gt;object(xn, Handle(thread, arg.oop_value()));
 819       } else {
 820         xtty-&gt;object(xn, arg.metadata_value());
 821       }
 822     }
 823   }
 824   if (witness != NULL) {
 825     xtty-&gt;object(&quot;witness&quot;, witness);
 826     xtty-&gt;stamp();
 827   }
 828   xtty-&gt;end_elem();
 829 }
 830 
 831 void Dependencies::print_dependency(DepType dept, GrowableArray&lt;DepArgument&gt;* args,
 832                                     Klass* witness, outputStream* st) {
 833   ResourceMark rm;
 834   ttyLocker ttyl;   // keep the following output all in one block
 835   st-&gt;print_cr(&quot;%s of type %s&quot;,
 836                 (witness == NULL)? &quot;Dependency&quot;: &quot;Failed dependency&quot;,
 837                 dep_name(dept));
 838   // print arguments
 839   int ctxkj = dep_context_arg(dept);  // -1 if no context arg
 840   for (int j = 0; j &lt; args-&gt;length(); j++) {
 841     DepArgument arg = args-&gt;at(j);
 842     bool put_star = false;
 843     if (arg.is_null())  continue;
 844     const char* what;
 845     if (j == ctxkj) {
 846       assert(arg.is_metadata(), &quot;must be&quot;);
 847       what = &quot;context&quot;;
 848       put_star = !Dependencies::is_concrete_klass((Klass*)arg.metadata_value());
 849     } else if (arg.is_method()) {
 850       what = &quot;method &quot;;
 851       put_star = !Dependencies::is_concrete_method((Method*)arg.metadata_value(), NULL);
 852     } else if (arg.is_klass()) {
 853       what = &quot;class  &quot;;
 854     } else {
 855       what = &quot;object &quot;;
 856     }
 857     st-&gt;print(&quot;  %s = %s&quot;, what, (put_star? &quot;*&quot;: &quot;&quot;));
 858     if (arg.is_klass()) {
 859       st-&gt;print(&quot;%s&quot;, ((Klass*)arg.metadata_value())-&gt;external_name());
 860     } else if (arg.is_method()) {
 861       ((Method*)arg.metadata_value())-&gt;print_value_on(st);
 862     } else if (arg.is_oop()) {
 863       arg.oop_value()-&gt;print_value_on(st);
 864     } else {
 865       ShouldNotReachHere(); // Provide impl for this type.
 866     }
 867 
 868     st-&gt;cr();
 869   }
 870   if (witness != NULL) {
 871     bool put_star = !Dependencies::is_concrete_klass(witness);
 872     st-&gt;print_cr(&quot;  witness = %s%s&quot;,
 873                   (put_star? &quot;*&quot;: &quot;&quot;),
 874                   witness-&gt;external_name());
 875   }
 876 }
 877 
 878 void Dependencies::DepStream::log_dependency(Klass* witness) {
 879   if (_deps == NULL &amp;&amp; xtty == NULL)  return;  // fast cutout for runtime
 880   ResourceMark rm;
 881   const int nargs = argument_count();
 882   GrowableArray&lt;DepArgument&gt;* args = new GrowableArray&lt;DepArgument&gt;(nargs);
 883   for (int j = 0; j &lt; nargs; j++) {
 884     if (is_oop_argument(j)) {
 885       args-&gt;push(argument_oop(j));
 886     } else {
 887       args-&gt;push(argument(j));
 888     }
 889   }
 890   int argslen = args-&gt;length();
 891   if (_deps != NULL &amp;&amp; _deps-&gt;log() != NULL) {
 892     if (ciEnv::current() != NULL) {
 893       Dependencies::write_dependency_to(_deps-&gt;log(), type(), args, witness);
 894     } else {
 895       // Treat the CompileLog as an xmlstream instead
 896       Dependencies::write_dependency_to((xmlStream*)_deps-&gt;log(), type(), args, witness);
 897     }
 898   } else {
 899     Dependencies::write_dependency_to(xtty, type(), args, witness);
 900   }
 901   guarantee(argslen == args-&gt;length(), &quot;args array cannot grow inside nested ResoureMark scope&quot;);
 902 }
 903 
 904 void Dependencies::DepStream::print_dependency(Klass* witness, bool verbose, outputStream* st) {
 905   ResourceMark rm;
 906   int nargs = argument_count();
 907   GrowableArray&lt;DepArgument&gt;* args = new GrowableArray&lt;DepArgument&gt;(nargs);
 908   for (int j = 0; j &lt; nargs; j++) {
 909     if (is_oop_argument(j)) {
 910       args-&gt;push(argument_oop(j));
 911     } else {
 912       args-&gt;push(argument(j));
 913     }
 914   }
 915   int argslen = args-&gt;length();
 916   Dependencies::print_dependency(type(), args, witness, st);
 917   if (verbose) {
 918     if (_code != NULL) {
 919       st-&gt;print(&quot;  code: &quot;);
 920       _code-&gt;print_value_on(st);
 921       st-&gt;cr();
 922     }
 923   }
 924   guarantee(argslen == args-&gt;length(), &quot;args array cannot grow inside nested ResoureMark scope&quot;);
 925 }
 926 
 927 
 928 /// Dependency stream support (decodes dependencies from an nmethod):
 929 
 930 #ifdef ASSERT
 931 void Dependencies::DepStream::initial_asserts(size_t byte_limit) {
 932   assert(must_be_in_vm(), &quot;raw oops here&quot;);
 933   _byte_limit = byte_limit;
 934   _type       = (DepType)(end_marker-1);  // defeat &quot;already at end&quot; assert
 935   assert((_code!=NULL) + (_deps!=NULL) == 1, &quot;one or t&#39;other&quot;);
 936 }
 937 #endif //ASSERT
 938 
 939 bool Dependencies::DepStream::next() {
 940   assert(_type != end_marker, &quot;already at end&quot;);
 941   if (_bytes.position() == 0 &amp;&amp; _code != NULL
 942       &amp;&amp; _code-&gt;dependencies_size() == 0) {
 943     // Method has no dependencies at all.
 944     return false;
 945   }
 946   int code_byte = (_bytes.read_byte() &amp; 0xFF);
 947   if (code_byte == end_marker) {
 948     DEBUG_ONLY(_type = end_marker);
 949     return false;
 950   } else {
 951     int ctxk_bit = (code_byte &amp; Dependencies::default_context_type_bit);
 952     code_byte -= ctxk_bit;
 953     DepType dept = (DepType)code_byte;
 954     _type = dept;
 955     Dependencies::check_valid_dependency_type(dept);
 956     int stride = _dep_args[dept];
 957     assert(stride == dep_args(dept), &quot;sanity&quot;);
 958     int skipj = -1;
 959     if (ctxk_bit != 0) {
 960       skipj = 0;  // currently the only context argument is at zero
 961       assert(skipj == dep_context_arg(dept), &quot;zero arg always ctxk&quot;);
 962     }
 963     for (int j = 0; j &lt; stride; j++) {
 964       _xi[j] = (j == skipj)? 0: _bytes.read_int();
 965     }
 966     DEBUG_ONLY(_xi[stride] = -1);   // help detect overruns
 967     return true;
 968   }
 969 }
 970 
 971 inline Metadata* Dependencies::DepStream::recorded_metadata_at(int i) {
 972   Metadata* o = NULL;
 973   if (_code != NULL) {
 974     o = _code-&gt;metadata_at(i);
 975   } else {
 976     o = _deps-&gt;oop_recorder()-&gt;metadata_at(i);
 977   }
 978   return o;
 979 }
 980 
 981 inline oop Dependencies::DepStream::recorded_oop_at(int i) {
 982   return (_code != NULL)
 983          ? _code-&gt;oop_at(i)
 984     : JNIHandles::resolve(_deps-&gt;oop_recorder()-&gt;oop_at(i));
 985 }
 986 
 987 Metadata* Dependencies::DepStream::argument(int i) {
 988   Metadata* result = recorded_metadata_at(argument_index(i));
 989 
 990   if (result == NULL) { // Explicit context argument can be compressed
 991     int ctxkj = dep_context_arg(type());  // -1 if no explicit context arg
 992     if (ctxkj &gt;= 0 &amp;&amp; i == ctxkj &amp;&amp; ctxkj+1 &lt; argument_count()) {
 993       result = ctxk_encoded_as_null(type(), argument(ctxkj+1));
 994     }
 995   }
 996 
 997   assert(result == NULL || result-&gt;is_klass() || result-&gt;is_method(), &quot;must be&quot;);
 998   return result;
 999 }
1000 
1001 /**
1002  * Returns a unique identifier for each dependency argument.
1003  */
1004 uintptr_t Dependencies::DepStream::get_identifier(int i) {
1005   if (is_oop_argument(i)) {
1006     return (uintptr_t)(oopDesc*)argument_oop(i);
1007   } else {
1008     return (uintptr_t)argument(i);
1009   }
1010 }
1011 
1012 oop Dependencies::DepStream::argument_oop(int i) {
1013   oop result = recorded_oop_at(argument_index(i));
1014   assert(oopDesc::is_oop_or_null(result), &quot;must be&quot;);
1015   return result;
1016 }
1017 
1018 Klass* Dependencies::DepStream::context_type() {
1019   assert(must_be_in_vm(), &quot;raw oops here&quot;);
1020 
1021   // Most dependencies have an explicit context type argument.
1022   {
1023     int ctxkj = dep_context_arg(type());  // -1 if no explicit context arg
1024     if (ctxkj &gt;= 0) {
1025       Metadata* k = argument(ctxkj);
1026       assert(k != NULL &amp;&amp; k-&gt;is_klass(), &quot;type check&quot;);
1027       return (Klass*)k;
1028     }
1029   }
1030 
1031   // Some dependencies are using the klass of the first object
1032   // argument as implicit context type.
1033   {
1034     int ctxkj = dep_implicit_context_arg(type());
1035     if (ctxkj &gt;= 0) {
1036       Klass* k = argument_oop(ctxkj)-&gt;klass();
1037       assert(k != NULL &amp;&amp; k-&gt;is_klass(), &quot;type check&quot;);
1038       return (Klass*) k;
1039     }
1040   }
1041 
1042   // And some dependencies don&#39;t have a context type at all,
1043   // e.g. evol_method.
1044   return NULL;
1045 }
1046 
1047 // ----------------- DependencySignature --------------------------------------
1048 bool DependencySignature::equals(DependencySignature const&amp; s1, DependencySignature const&amp; s2) {
1049   if ((s1.type() != s2.type()) || (s1.args_count() != s2.args_count())) {
1050     return false;
1051   }
1052 
1053   for (int i = 0; i &lt; s1.args_count(); i++) {
1054     if (s1.arg(i) != s2.arg(i)) {
1055       return false;
1056     }
1057   }
1058   return true;
1059 }
1060 
1061 /// Checking dependencies:
1062 
1063 // This hierarchy walker inspects subtypes of a given type,
1064 // trying to find a &quot;bad&quot; class which breaks a dependency.
1065 // Such a class is called a &quot;witness&quot; to the broken dependency.
1066 // While searching around, we ignore &quot;participants&quot;, which
1067 // are already known to the dependency.
1068 class ClassHierarchyWalker {
1069  public:
1070   enum { PARTICIPANT_LIMIT = 3 };
1071 
1072  private:
1073   // optional method descriptor to check for:
1074   Symbol* _name;
1075   Symbol* _signature;
1076 
1077   // special classes which are not allowed to be witnesses:
1078   Klass*    _participants[PARTICIPANT_LIMIT+1];
1079   int       _num_participants;
1080 
1081   // cache of method lookups
1082   Method* _found_methods[PARTICIPANT_LIMIT+1];
1083 
1084   // if non-zero, tells how many witnesses to convert to participants
1085   int       _record_witnesses;
1086 
1087   void initialize(Klass* participant) {
1088     _record_witnesses = 0;
1089     _participants[0]  = participant;
1090     _found_methods[0] = NULL;
1091     _num_participants = 0;
1092     if (participant != NULL) {
1093       // Terminating NULL.
1094       _participants[1] = NULL;
1095       _found_methods[1] = NULL;
1096       _num_participants = 1;
1097     }
1098   }
1099 
1100   void initialize_from_method(Method* m) {
1101     assert(m != NULL &amp;&amp; m-&gt;is_method(), &quot;sanity&quot;);
1102     _name      = m-&gt;name();
1103     _signature = m-&gt;signature();
1104   }
1105 
1106  public:
1107   // The walker is initialized to recognize certain methods and/or types
1108   // as friendly participants.
1109   ClassHierarchyWalker(Klass* participant, Method* m) {
1110     initialize_from_method(m);
1111     initialize(participant);
1112   }
1113   ClassHierarchyWalker(Method* m) {
1114     initialize_from_method(m);
1115     initialize(NULL);
1116   }
1117   ClassHierarchyWalker(Klass* participant = NULL) {
1118     _name      = NULL;
1119     _signature = NULL;
1120     initialize(participant);
1121   }
1122   ClassHierarchyWalker(Klass* participants[], int num_participants) {
1123     _name      = NULL;
1124     _signature = NULL;
1125     initialize(NULL);
1126     for (int i = 0; i &lt; num_participants; ++i) {
1127       add_participant(participants[i]);
1128     }
1129   }
1130 
1131   // This is common code for two searches:  One for concrete subtypes,
1132   // the other for concrete method implementations and overrides.
1133   bool doing_subtype_search() {
1134     return _name == NULL;
1135   }
1136 
1137   int num_participants() { return _num_participants; }
1138   Klass* participant(int n) {
1139     assert((uint)n &lt;= (uint)_num_participants, &quot;oob&quot;);
1140     return _participants[n];
1141   }
1142 
1143   // Note:  If n==num_participants, returns NULL.
1144   Method* found_method(int n) {
1145     assert((uint)n &lt;= (uint)_num_participants, &quot;oob&quot;);
1146     Method* fm = _found_methods[n];
1147     assert(n == _num_participants || fm != NULL, &quot;proper usage&quot;);
1148     if (fm != NULL &amp;&amp; fm-&gt;method_holder() != _participants[n]) {
1149       // Default methods from interfaces can be added to classes. In
1150       // that case the holder of the method is not the class but the
1151       // interface where it&#39;s defined.
1152       assert(fm-&gt;is_default_method(), &quot;sanity&quot;);
1153       return NULL;
1154     }
1155     return fm;
1156   }
1157 
1158 #ifdef ASSERT
1159   // Assert that m is inherited into ctxk, without intervening overrides.
1160   // (May return true even if this is not true, in corner cases where we punt.)
1161   bool check_method_context(Klass* ctxk, Method* m) {
1162     if (m-&gt;method_holder() == ctxk)
1163       return true;  // Quick win.
1164     if (m-&gt;is_private())
1165       return false; // Quick lose.  Should not happen.
1166     if (!(m-&gt;is_public() || m-&gt;is_protected()))
1167       // The override story is complex when packages get involved.
1168       return true;  // Must punt the assertion to true.
1169     Method* lm = ctxk-&gt;lookup_method(m-&gt;name(), m-&gt;signature());
1170     if (lm == NULL &amp;&amp; ctxk-&gt;is_instance_klass()) {
1171       // It might be an interface method
1172       lm = InstanceKlass::cast(ctxk)-&gt;lookup_method_in_ordered_interfaces(m-&gt;name(),
1173                                                                           m-&gt;signature());
1174     }
1175     if (lm == m)
1176       // Method m is inherited into ctxk.
1177       return true;
1178     if (lm != NULL) {
1179       if (!(lm-&gt;is_public() || lm-&gt;is_protected())) {
1180         // Method is [package-]private, so the override story is complex.
1181         return true;  // Must punt the assertion to true.
1182       }
1183       if (lm-&gt;is_static()) {
1184         // Static methods don&#39;t override non-static so punt
1185         return true;
1186       }
1187       if (!Dependencies::is_concrete_method(lm, ctxk) &amp;&amp;
1188           !Dependencies::is_concrete_method(m, ctxk)) {
1189         // They are both non-concrete
1190         if (lm-&gt;method_holder()-&gt;is_subtype_of(m-&gt;method_holder())) {
1191           // Method m is overridden by lm, but both are non-concrete.
1192           return true;
1193         }
1194         if (lm-&gt;method_holder()-&gt;is_interface() &amp;&amp; m-&gt;method_holder()-&gt;is_interface() &amp;&amp;
1195             ctxk-&gt;is_subtype_of(m-&gt;method_holder()) &amp;&amp; ctxk-&gt;is_subtype_of(lm-&gt;method_holder())) {
1196           // Interface method defined in multiple super interfaces
1197           return true;
1198         }
1199       }
1200     }
1201     ResourceMark rm;
1202     tty-&gt;print_cr(&quot;Dependency method not found in the associated context:&quot;);
1203     tty-&gt;print_cr(&quot;  context = %s&quot;, ctxk-&gt;external_name());
1204     tty-&gt;print(   &quot;  method = &quot;); m-&gt;print_short_name(tty); tty-&gt;cr();
1205     if (lm != NULL) {
1206       tty-&gt;print( &quot;  found = &quot;); lm-&gt;print_short_name(tty); tty-&gt;cr();
1207     }
1208     return false;
1209   }
1210 #endif
1211 
1212   void add_participant(Klass* participant) {
1213     assert(_num_participants + _record_witnesses &lt; PARTICIPANT_LIMIT, &quot;oob&quot;);
1214     int np = _num_participants++;
1215     _participants[np] = participant;
1216     _participants[np+1] = NULL;
1217     _found_methods[np+1] = NULL;
1218   }
1219 
1220   void record_witnesses(int add) {
1221     if (add &gt; PARTICIPANT_LIMIT)  add = PARTICIPANT_LIMIT;
1222     assert(_num_participants + add &lt; PARTICIPANT_LIMIT, &quot;oob&quot;);
1223     _record_witnesses = add;
1224   }
1225 
1226   bool is_witness(Klass* k) {
1227     if (doing_subtype_search()) {
1228       return Dependencies::is_concrete_klass(k);
1229     } else if (!k-&gt;is_instance_klass()) {
1230       return false; // no methods to find in an array type
1231     } else {
1232       // Search class hierarchy first, skipping private implementations
1233       // as they never override any inherited methods
1234       Method* m = InstanceKlass::cast(k)-&gt;find_instance_method(_name, _signature, Klass::skip_private);
1235       if (!Dependencies::is_concrete_method(m, k)) {
1236         // Check for re-abstraction of method
1237         if (!k-&gt;is_interface() &amp;&amp; m != NULL &amp;&amp; m-&gt;is_abstract()) {
1238           // Found a matching abstract method &#39;m&#39; in the class hierarchy.
1239           // This is fine iff &#39;k&#39; is an abstract class and all concrete subtypes
1240           // of &#39;k&#39; override &#39;m&#39; and are participates of the current search.
1241           ClassHierarchyWalker wf(_participants, _num_participants);
1242           Klass* w = wf.find_witness_subtype(k);
1243           if (w != NULL) {
1244             Method* wm = InstanceKlass::cast(w)-&gt;find_instance_method(_name, _signature);
1245             if (!Dependencies::is_concrete_method(wm, w)) {
1246               // Found a concrete subtype &#39;w&#39; which does not override abstract method &#39;m&#39;.
1247               // Bail out because &#39;m&#39; could be called with &#39;w&#39; as receiver (leading to an
1248               // AbstractMethodError) and thus the method we are looking for is not unique.
1249               _found_methods[_num_participants] = m;
1250               return true;
1251             }
1252           }
1253         }
1254         // Check interface defaults also, if any exist.
1255         Array&lt;Method*&gt;* default_methods = InstanceKlass::cast(k)-&gt;default_methods();
1256         if (default_methods == NULL)
1257             return false;
1258         m = InstanceKlass::cast(k)-&gt;find_method(default_methods, _name, _signature);
1259         if (!Dependencies::is_concrete_method(m, NULL))
1260             return false;
1261       }
1262       _found_methods[_num_participants] = m;
1263       // Note:  If add_participant(k) is called,
1264       // the method m will already be memoized for it.
1265       return true;
1266     }
1267   }
1268 
1269   bool is_participant(Klass* k) {
1270     if (k == _participants[0]) {
1271       return true;
1272     } else if (_num_participants &lt;= 1) {
1273       return false;
1274     } else {
1275       return in_list(k, &amp;_participants[1]);
1276     }
1277   }
1278   bool ignore_witness(Klass* witness) {
1279     if (_record_witnesses == 0) {
1280       return false;
1281     } else {
1282       --_record_witnesses;
1283       add_participant(witness);
1284       return true;
1285     }
1286   }
1287   static bool in_list(Klass* x, Klass** list) {
1288     for (int i = 0; ; i++) {
1289       Klass* y = list[i];
1290       if (y == NULL)  break;
1291       if (y == x)  return true;
1292     }
1293     return false;  // not in list
1294   }
1295 
1296  private:
1297   // the actual search method:
1298   Klass* find_witness_anywhere(Klass* context_type,
1299                                  bool participants_hide_witnesses,
1300                                  bool top_level_call = true);
1301   // the spot-checking version:
1302   Klass* find_witness_in(KlassDepChange&amp; changes,
1303                          Klass* context_type,
1304                            bool participants_hide_witnesses);
1305  public:
1306   Klass* find_witness_subtype(Klass* context_type, KlassDepChange* changes = NULL) {
1307     assert(doing_subtype_search(), &quot;must set up a subtype search&quot;);
1308     // When looking for unexpected concrete types,
1309     // do not look beneath expected ones.
1310     const bool participants_hide_witnesses = true;
1311     // CX &gt; CC &gt; C&#39; is OK, even if C&#39; is new.
1312     // CX &gt; { CC,  C&#39; } is not OK if C&#39; is new, and C&#39; is the witness.
1313     if (changes != NULL) {
1314       return find_witness_in(*changes, context_type, participants_hide_witnesses);
1315     } else {
1316       return find_witness_anywhere(context_type, participants_hide_witnesses);
1317     }
1318   }
1319   Klass* find_witness_definer(Klass* context_type, KlassDepChange* changes = NULL) {
1320     assert(!doing_subtype_search(), &quot;must set up a method definer search&quot;);
1321     // When looking for unexpected concrete methods,
1322     // look beneath expected ones, to see if there are overrides.
1323     const bool participants_hide_witnesses = true;
1324     // CX.m &gt; CC.m &gt; C&#39;.m is not OK, if C&#39;.m is new, and C&#39; is the witness.
1325     if (changes != NULL) {
1326       return find_witness_in(*changes, context_type, !participants_hide_witnesses);
1327     } else {
1328       return find_witness_anywhere(context_type, !participants_hide_witnesses);
1329     }
1330   }
1331 };
1332 
1333 #ifndef PRODUCT
1334 static int deps_find_witness_calls = 0;
1335 static int deps_find_witness_steps = 0;
1336 static int deps_find_witness_recursions = 0;
1337 static int deps_find_witness_singles = 0;
1338 static int deps_find_witness_print = 0; // set to -1 to force a final print
1339 static bool count_find_witness_calls() {
1340   if (TraceDependencies || LogCompilation) {
1341     int pcount = deps_find_witness_print + 1;
1342     bool final_stats      = (pcount == 0);
1343     bool initial_call     = (pcount == 1);
1344     bool occasional_print = ((pcount &amp; ((1&lt;&lt;10) - 1)) == 0);
1345     if (pcount &lt; 0)  pcount = 1; // crude overflow protection
1346     deps_find_witness_print = pcount;
1347     if (VerifyDependencies &amp;&amp; initial_call) {
1348       tty-&gt;print_cr(&quot;Warning:  TraceDependencies results may be inflated by VerifyDependencies&quot;);
1349     }
1350     if (occasional_print || final_stats) {
1351       // Every now and then dump a little info about dependency searching.
1352       if (xtty != NULL) {
1353        ttyLocker ttyl;
1354        xtty-&gt;elem(&quot;deps_find_witness calls=&#39;%d&#39; steps=&#39;%d&#39; recursions=&#39;%d&#39; singles=&#39;%d&#39;&quot;,
1355                    deps_find_witness_calls,
1356                    deps_find_witness_steps,
1357                    deps_find_witness_recursions,
1358                    deps_find_witness_singles);
1359       }
1360       if (final_stats || (TraceDependencies &amp;&amp; WizardMode)) {
1361         ttyLocker ttyl;
1362         tty-&gt;print_cr(&quot;Dependency check (find_witness) &quot;
1363                       &quot;calls=%d, steps=%d (avg=%.1f), recursions=%d, singles=%d&quot;,
1364                       deps_find_witness_calls,
1365                       deps_find_witness_steps,
1366                       (double)deps_find_witness_steps / deps_find_witness_calls,
1367                       deps_find_witness_recursions,
1368                       deps_find_witness_singles);
1369       }
1370     }
1371     return true;
1372   }
1373   return false;
1374 }
1375 #else
1376 #define count_find_witness_calls() (0)
1377 #endif //PRODUCT
1378 
1379 
1380 Klass* ClassHierarchyWalker::find_witness_in(KlassDepChange&amp; changes,
1381                                                Klass* context_type,
1382                                                bool participants_hide_witnesses) {
1383   assert(changes.involves_context(context_type), &quot;irrelevant dependency&quot;);
1384   Klass* new_type = changes.new_type();
1385 
1386   (void)count_find_witness_calls();
1387   NOT_PRODUCT(deps_find_witness_singles++);
1388 
1389   // Current thread must be in VM (not native mode, as in CI):
1390   assert(must_be_in_vm(), &quot;raw oops here&quot;);
1391   // Must not move the class hierarchy during this check:
1392   assert_locked_or_safepoint(Compile_lock);
1393 
1394   int nof_impls = InstanceKlass::cast(context_type)-&gt;nof_implementors();
1395   if (nof_impls &gt; 1) {
1396     // Avoid this case: *I.m &gt; { A.m, C }; B.m &gt; C
1397     // %%% Until this is fixed more systematically, bail out.
1398     // See corresponding comment in find_witness_anywhere.
1399     return context_type;
1400   }
1401 
1402   assert(!is_participant(new_type), &quot;only old classes are participants&quot;);
1403   if (participants_hide_witnesses) {
1404     // If the new type is a subtype of a participant, we are done.
1405     for (int i = 0; i &lt; num_participants(); i++) {
1406       Klass* part = participant(i);
1407       if (part == NULL)  continue;
1408       assert(changes.involves_context(part) == new_type-&gt;is_subtype_of(part),
1409              &quot;correct marking of participants, b/c new_type is unique&quot;);
1410       if (changes.involves_context(part)) {
1411         // new guy is protected from this check by previous participant
1412         return NULL;
1413       }
1414     }
1415   }
1416 
1417   if (is_witness(new_type) &amp;&amp;
1418       !ignore_witness(new_type)) {
1419     return new_type;
1420   }
1421 
1422   return NULL;
1423 }
1424 
1425 
1426 // Walk hierarchy under a context type, looking for unexpected types.
1427 // Do not report participant types, and recursively walk beneath
1428 // them only if participants_hide_witnesses is false.
1429 // If top_level_call is false, skip testing the context type,
1430 // because the caller has already considered it.
1431 Klass* ClassHierarchyWalker::find_witness_anywhere(Klass* context_type,
1432                                                      bool participants_hide_witnesses,
1433                                                      bool top_level_call) {
1434   // Current thread must be in VM (not native mode, as in CI):
1435   assert(must_be_in_vm(), &quot;raw oops here&quot;);
1436   // Must not move the class hierarchy during this check:
1437   assert_locked_or_safepoint(Compile_lock);
1438 
1439   bool do_counts = count_find_witness_calls();
1440 
1441   // Check the root of the sub-hierarchy first.
1442   if (top_level_call) {
1443     if (do_counts) {
1444       NOT_PRODUCT(deps_find_witness_calls++);
1445       NOT_PRODUCT(deps_find_witness_steps++);
1446     }
1447     if (is_participant(context_type)) {
1448       if (participants_hide_witnesses)  return NULL;
1449       // else fall through to search loop...
1450     } else if (is_witness(context_type) &amp;&amp; !ignore_witness(context_type)) {
1451       // The context is an abstract class or interface, to start with.
1452       return context_type;
1453     }
1454   }
1455 
1456   // Now we must check each implementor and each subclass.
1457   // Use a short worklist to avoid blowing the stack.
1458   // Each worklist entry is a *chain* of subklass siblings to process.
1459   const int CHAINMAX = 100;  // &gt;= 1 + InstanceKlass::implementors_limit
1460   Klass* chains[CHAINMAX];
1461   int    chaini = 0;  // index into worklist
1462   Klass* chain;       // scratch variable
1463 #define ADD_SUBCLASS_CHAIN(k)                     {  \
1464     assert(chaini &lt; CHAINMAX, &quot;oob&quot;);                \
1465     chain = k-&gt;subklass();                           \
1466     if (chain != NULL)  chains[chaini++] = chain;    }
1467 
1468   // Look for non-abstract subclasses.
1469   // (Note:  Interfaces do not have subclasses.)
1470   ADD_SUBCLASS_CHAIN(context_type);
1471 
1472   // If it is an interface, search its direct implementors.
1473   // (Their subclasses are additional indirect implementors.
1474   // See InstanceKlass::add_implementor.)
1475   // (Note:  nof_implementors is always zero for non-interfaces.)
1476   if (top_level_call) {
1477     int nof_impls = InstanceKlass::cast(context_type)-&gt;nof_implementors();
1478     if (nof_impls &gt; 1) {
1479       // Avoid this case: *I.m &gt; { A.m, C }; B.m &gt; C
1480       // Here, I.m has 2 concrete implementations, but m appears unique
1481       // as A.m, because the search misses B.m when checking C.
1482       // The inherited method B.m was getting missed by the walker
1483       // when interface &#39;I&#39; was the starting point.
1484       // %%% Until this is fixed more systematically, bail out.
1485       // (Old CHA had the same limitation.)
1486       return context_type;
1487     }
1488     if (nof_impls &gt; 0) {
1489       Klass* impl = InstanceKlass::cast(context_type)-&gt;implementor();
1490       assert(impl != NULL, &quot;just checking&quot;);
1491       // If impl is the same as the context_type, then more than one
1492       // implementor has seen. No exact info in this case.
1493       if (impl == context_type) {
1494         return context_type;  // report an inexact witness to this sad affair
1495       }
1496       if (do_counts)
1497         { NOT_PRODUCT(deps_find_witness_steps++); }
1498       if (is_participant(impl)) {
1499         if (!participants_hide_witnesses) {
1500           ADD_SUBCLASS_CHAIN(impl);
1501         }
1502       } else if (is_witness(impl) &amp;&amp; !ignore_witness(impl)) {
1503         return impl;
1504       } else {
1505         ADD_SUBCLASS_CHAIN(impl);
1506       }
1507     }
1508   }
1509 
1510   // Recursively process each non-trivial sibling chain.
1511   while (chaini &gt; 0) {
1512     Klass* chain = chains[--chaini];
1513     for (Klass* sub = chain; sub != NULL; sub = sub-&gt;next_sibling()) {
1514       if (do_counts) { NOT_PRODUCT(deps_find_witness_steps++); }
1515       if (is_participant(sub)) {
1516         if (participants_hide_witnesses)  continue;
1517         // else fall through to process this guy&#39;s subclasses
1518       } else if (is_witness(sub) &amp;&amp; !ignore_witness(sub)) {
1519         return sub;
1520       }
1521       if (chaini &lt; (VerifyDependencies? 2: CHAINMAX)) {
1522         // Fast path.  (Partially disabled if VerifyDependencies.)
1523         ADD_SUBCLASS_CHAIN(sub);
1524       } else {
1525         // Worklist overflow.  Do a recursive call.  Should be rare.
1526         // The recursive call will have its own worklist, of course.
1527         // (Note that sub has already been tested, so that there is
1528         // no need for the recursive call to re-test.  That&#39;s handy,
1529         // since the recursive call sees sub as the context_type.)
1530         if (do_counts) { NOT_PRODUCT(deps_find_witness_recursions++); }
1531         Klass* witness = find_witness_anywhere(sub,
1532                                                  participants_hide_witnesses,
1533                                                  /*top_level_call=*/ false);
1534         if (witness != NULL)  return witness;
1535       }
1536     }
1537   }
1538 
1539   // No witness found.  The dependency remains unbroken.
1540   return NULL;
1541 #undef ADD_SUBCLASS_CHAIN
1542 }
1543 
1544 
1545 bool Dependencies::is_concrete_klass(Klass* k) {
1546   if (k-&gt;is_abstract())  return false;
1547   // %%% We could treat classes which are concrete but
1548   // have not yet been instantiated as virtually abstract.
1549   // This would require a deoptimization barrier on first instantiation.
1550   //if (k-&gt;is_not_instantiated())  return false;
1551   return true;
1552 }
1553 
1554 bool Dependencies::is_concrete_method(Method* m, Klass * k) {
1555   // NULL is not a concrete method,
1556   // statics are irrelevant to virtual call sites,
1557   // abstract methods are not concrete,
1558   // overpass (error) methods are not concrete if k is abstract
1559   //
1560   // note &quot;true&quot; is conservative answer --
1561   //     overpass clause is false if k == NULL, implies return true if
1562   //     answer depends on overpass clause.
1563   return ! ( m == NULL || m -&gt; is_static() || m -&gt; is_abstract() ||
1564              (m-&gt;is_overpass() &amp;&amp; k != NULL &amp;&amp; k -&gt; is_abstract()) );
1565 }
1566 
1567 
1568 Klass* Dependencies::find_finalizable_subclass(Klass* k) {
1569   if (k-&gt;is_interface())  return NULL;
1570   if (k-&gt;has_finalizer()) return k;
1571   k = k-&gt;subklass();
1572   while (k != NULL) {
1573     Klass* result = find_finalizable_subclass(k);
1574     if (result != NULL) return result;
1575     k = k-&gt;next_sibling();
1576   }
1577   return NULL;
1578 }
1579 
1580 
1581 bool Dependencies::is_concrete_klass(ciInstanceKlass* k) {
1582   if (k-&gt;is_abstract())  return false;
1583   // We could also return false if k does not yet appear to be
1584   // instantiated, if the VM version supports this distinction also.
1585   //if (k-&gt;is_not_instantiated())  return false;
1586   return true;
1587 }
1588 
1589 bool Dependencies::has_finalizable_subclass(ciInstanceKlass* k) {
1590   return k-&gt;has_finalizable_subclass();
1591 }
1592 
1593 
1594 // Any use of the contents (bytecodes) of a method must be
1595 // marked by an &quot;evol_method&quot; dependency, if those contents
1596 // can change.  (Note: A method is always dependent on itself.)
1597 Klass* Dependencies::check_evol_method(Method* m) {
1598   assert(must_be_in_vm(), &quot;raw oops here&quot;);
1599   // Did somebody do a JVMTI RedefineClasses while our backs were turned?
1600   // Or is there a now a breakpoint?
1601   // (Assumes compiled code cannot handle bkpts; change if UseFastBreakpoints.)
1602   if (m-&gt;is_old()
1603       || m-&gt;number_of_breakpoints() &gt; 0) {
1604     return m-&gt;method_holder();
1605   } else {
1606     return NULL;
1607   }
1608 }
1609 
1610 // This is a strong assertion:  It is that the given type
1611 // has no subtypes whatever.  It is most useful for
1612 // optimizing checks on reflected types or on array types.
1613 // (Checks on types which are derived from real instances
1614 // can be optimized more strongly than this, because we
1615 // know that the checked type comes from a concrete type,
1616 // and therefore we can disregard abstract types.)
1617 Klass* Dependencies::check_leaf_type(Klass* ctxk) {
1618   assert(must_be_in_vm(), &quot;raw oops here&quot;);
1619   assert_locked_or_safepoint(Compile_lock);
1620   InstanceKlass* ctx = InstanceKlass::cast(ctxk);
1621   Klass* sub = ctx-&gt;subklass();
1622   if (sub != NULL) {
1623     return sub;
1624   } else if (ctx-&gt;nof_implementors() != 0) {
1625     // if it is an interface, it must be unimplemented
1626     // (if it is not an interface, nof_implementors is always zero)
1627     Klass* impl = ctx-&gt;implementor();
1628     assert(impl != NULL, &quot;must be set&quot;);
1629     return impl;
1630   } else {
1631     return NULL;
1632   }
1633 }
1634 
1635 // Test the assertion that conck is the only concrete subtype* of ctxk.
1636 // The type conck itself is allowed to have have further concrete subtypes.
1637 // This allows the compiler to narrow occurrences of ctxk by conck,
1638 // when dealing with the types of actual instances.
1639 Klass* Dependencies::check_abstract_with_unique_concrete_subtype(Klass* ctxk,
1640                                                                    Klass* conck,
1641                                                                    KlassDepChange* changes) {
1642   ClassHierarchyWalker wf(conck);
1643   return wf.find_witness_subtype(ctxk, changes);
1644 }
1645 
1646 // If a non-concrete class has no concrete subtypes, it is not (yet)
1647 // instantiatable.  This can allow the compiler to make some paths go
1648 // dead, if they are gated by a test of the type.
1649 Klass* Dependencies::check_abstract_with_no_concrete_subtype(Klass* ctxk,
1650                                                                KlassDepChange* changes) {
1651   // Find any concrete subtype, with no participants:
1652   ClassHierarchyWalker wf;
1653   return wf.find_witness_subtype(ctxk, changes);
1654 }
1655 
1656 
1657 // If a concrete class has no concrete subtypes, it can always be
1658 // exactly typed.  This allows the use of a cheaper type test.
1659 Klass* Dependencies::check_concrete_with_no_concrete_subtype(Klass* ctxk,
1660                                                                KlassDepChange* changes) {
1661   // Find any concrete subtype, with only the ctxk as participant:
1662   ClassHierarchyWalker wf(ctxk);
1663   return wf.find_witness_subtype(ctxk, changes);
1664 }
1665 
1666 
1667 // Find the unique concrete proper subtype of ctxk, or NULL if there
1668 // is more than one concrete proper subtype.  If there are no concrete
1669 // proper subtypes, return ctxk itself, whether it is concrete or not.
1670 // The returned subtype is allowed to have have further concrete subtypes.
1671 // That is, return CC1 for CX &gt; CC1 &gt; CC2, but NULL for CX &gt; { CC1, CC2 }.
1672 Klass* Dependencies::find_unique_concrete_subtype(Klass* ctxk) {
1673   ClassHierarchyWalker wf(ctxk);   // Ignore ctxk when walking.
1674   wf.record_witnesses(1);          // Record one other witness when walking.
1675   Klass* wit = wf.find_witness_subtype(ctxk);
1676   if (wit != NULL)  return NULL;   // Too many witnesses.
1677   Klass* conck = wf.participant(0);
1678   if (conck == NULL) {
1679 #ifndef PRODUCT
1680     // Make sure the dependency mechanism will pass this discovery:
1681     if (VerifyDependencies) {
1682       // Turn off dependency tracing while actually testing deps.
1683       FlagSetting fs(TraceDependencies, false);
1684       if (!Dependencies::is_concrete_klass(ctxk)) {
1685         guarantee(NULL ==
1686                   (void *)check_abstract_with_no_concrete_subtype(ctxk),
1687                   &quot;verify dep.&quot;);
1688       } else {
1689         guarantee(NULL ==
1690                   (void *)check_concrete_with_no_concrete_subtype(ctxk),
1691                   &quot;verify dep.&quot;);
1692       }
1693     }
1694 #endif //PRODUCT
1695     return ctxk;                   // Return ctxk as a flag for &quot;no subtypes&quot;.
1696   } else {
1697 #ifndef PRODUCT
1698     // Make sure the dependency mechanism will pass this discovery:
1699     if (VerifyDependencies) {
1700       // Turn off dependency tracing while actually testing deps.
1701       FlagSetting fs(TraceDependencies, false);
1702       if (!Dependencies::is_concrete_klass(ctxk)) {
1703         guarantee(NULL == (void *)
1704                   check_abstract_with_unique_concrete_subtype(ctxk, conck),
1705                   &quot;verify dep.&quot;);
1706       }
1707     }
1708 #endif //PRODUCT
1709     return conck;
1710   }
1711 }
1712 
1713 // Test the assertion that the k[12] are the only concrete subtypes of ctxk,
1714 // except possibly for further subtypes of k[12] themselves.
1715 // The context type must be abstract.  The types k1 and k2 are themselves
1716 // allowed to have further concrete subtypes.
1717 Klass* Dependencies::check_abstract_with_exclusive_concrete_subtypes(
1718                                                 Klass* ctxk,
1719                                                 Klass* k1,
1720                                                 Klass* k2,
1721                                                 KlassDepChange* changes) {
1722   ClassHierarchyWalker wf;
1723   wf.add_participant(k1);
1724   wf.add_participant(k2);
1725   return wf.find_witness_subtype(ctxk, changes);
1726 }
1727 
1728 // Search ctxk for concrete implementations.  If there are klen or fewer,
1729 // pack them into the given array and return the number.
1730 // Otherwise, return -1, meaning the given array would overflow.
1731 // (Note that a return of 0 means there are exactly no concrete subtypes.)
1732 // In this search, if ctxk is concrete, it will be reported alone.
1733 // For any type CC reported, no proper subtypes of CC will be reported.
1734 int Dependencies::find_exclusive_concrete_subtypes(Klass* ctxk,
1735                                                    int klen,
1736                                                    Klass* karray[]) {
1737   ClassHierarchyWalker wf;
1738   wf.record_witnesses(klen);
1739   Klass* wit = wf.find_witness_subtype(ctxk);
1740   if (wit != NULL)  return -1;  // Too many witnesses.
1741   int num = wf.num_participants();
1742   assert(num &lt;= klen, &quot;oob&quot;);
1743   // Pack the result array with the good news.
1744   for (int i = 0; i &lt; num; i++)
1745     karray[i] = wf.participant(i);
1746 #ifndef PRODUCT
1747   // Make sure the dependency mechanism will pass this discovery:
1748   if (VerifyDependencies) {
1749     // Turn off dependency tracing while actually testing deps.
1750     FlagSetting fs(TraceDependencies, false);
1751     switch (Dependencies::is_concrete_klass(ctxk)? -1: num) {
1752     case -1: // ctxk was itself concrete
1753       guarantee(num == 1 &amp;&amp; karray[0] == ctxk, &quot;verify dep.&quot;);
1754       break;
1755     case 0:
1756       guarantee(NULL == (void *)check_abstract_with_no_concrete_subtype(ctxk),
1757                 &quot;verify dep.&quot;);
1758       break;
1759     case 1:
1760       guarantee(NULL == (void *)
1761                 check_abstract_with_unique_concrete_subtype(ctxk, karray[0]),
1762                 &quot;verify dep.&quot;);
1763       break;
1764     case 2:
1765       guarantee(NULL == (void *)
1766                 check_abstract_with_exclusive_concrete_subtypes(ctxk,
1767                                                                 karray[0],
1768                                                                 karray[1]),
1769                 &quot;verify dep.&quot;);
1770       break;
1771     default:
1772       ShouldNotReachHere();  // klen &gt; 2 yet supported
1773     }
1774   }
1775 #endif //PRODUCT
1776   return num;
1777 }
1778 
1779 // If a class (or interface) has a unique concrete method uniqm, return NULL.
1780 // Otherwise, return a class that contains an interfering method.
1781 Klass* Dependencies::check_unique_concrete_method(Klass* ctxk, Method* uniqm,
1782                                                     KlassDepChange* changes) {
1783   // Here is a missing optimization:  If uniqm-&gt;is_final(),
1784   // we don&#39;t really need to search beneath it for overrides.
1785   // This is probably not important, since we don&#39;t use dependencies
1786   // to track final methods.  (They can&#39;t be &quot;definalized&quot;.)
1787   ClassHierarchyWalker wf(uniqm-&gt;method_holder(), uniqm);
1788   return wf.find_witness_definer(ctxk, changes);
1789 }
1790 
1791 // Find the set of all non-abstract methods under ctxk that match m.
1792 // (The method m must be defined or inherited in ctxk.)
1793 // Include m itself in the set, unless it is abstract.
1794 // If this set has exactly one element, return that element.
1795 Method* Dependencies::find_unique_concrete_method(Klass* ctxk, Method* m) {
1796   // Return NULL if m is marked old; must have been a redefined method.
1797   if (m-&gt;is_old()) {
1798     return NULL;
1799   }
1800   ClassHierarchyWalker wf(m);
1801   assert(wf.check_method_context(ctxk, m), &quot;proper context&quot;);
1802   wf.record_witnesses(1);
1803   Klass* wit = wf.find_witness_definer(ctxk);
1804   if (wit != NULL)  return NULL;  // Too many witnesses.
1805   Method* fm = wf.found_method(0);  // Will be NULL if num_parts == 0.
1806   if (Dependencies::is_concrete_method(m, ctxk)) {
1807     if (fm == NULL) {
1808       // It turns out that m was always the only implementation.
1809       fm = m;
1810     } else if (fm != m) {
1811       // Two conflicting implementations after all.
1812       // (This can happen if m is inherited into ctxk and fm overrides it.)
1813       return NULL;
1814     }
1815   }
1816 #ifndef PRODUCT
1817   // Make sure the dependency mechanism will pass this discovery:
1818   if (VerifyDependencies &amp;&amp; fm != NULL) {
1819     guarantee(NULL == (void *)check_unique_concrete_method(ctxk, fm),
1820               &quot;verify dep.&quot;);
1821   }
1822 #endif //PRODUCT
1823   return fm;
1824 }
1825 
1826 Klass* Dependencies::check_exclusive_concrete_methods(Klass* ctxk,
1827                                                         Method* m1,
1828                                                         Method* m2,
1829                                                         KlassDepChange* changes) {
1830   ClassHierarchyWalker wf(m1);
1831   wf.add_participant(m1-&gt;method_holder());
1832   wf.add_participant(m2-&gt;method_holder());
1833   return wf.find_witness_definer(ctxk, changes);
1834 }
1835 
1836 Klass* Dependencies::check_has_no_finalizable_subclasses(Klass* ctxk, KlassDepChange* changes) {
1837   Klass* search_at = ctxk;
1838   if (changes != NULL)
1839     search_at = changes-&gt;new_type(); // just look at the new bit
1840   return find_finalizable_subclass(search_at);
1841 }
1842 
1843 Klass* Dependencies::check_call_site_target_value(oop call_site, oop method_handle, CallSiteDepChange* changes) {
1844   assert(call_site != NULL, &quot;sanity&quot;);
1845   assert(method_handle != NULL, &quot;sanity&quot;);
1846   assert(call_site-&gt;is_a(SystemDictionary::CallSite_klass()),     &quot;sanity&quot;);
1847 
1848   if (changes == NULL) {
1849     // Validate all CallSites
<a name="8" id="anc8"></a><span class="line-modified">1850     if (!oopDesc::equals(java_lang_invoke_CallSite::target(call_site), method_handle))</span>
1851       return call_site-&gt;klass();  // assertion failed
1852   } else {
1853     // Validate the given CallSite
<a name="9" id="anc9"></a><span class="line-modified">1854     if (oopDesc::equals(call_site, changes-&gt;call_site()) &amp;&amp; !oopDesc::equals(java_lang_invoke_CallSite::target(call_site), changes-&gt;method_handle())) {</span>
<span class="line-modified">1855       assert(!oopDesc::equals(method_handle, changes-&gt;method_handle()), &quot;must be&quot;);</span>
1856       return call_site-&gt;klass();  // assertion failed
1857     }
1858   }
1859   return NULL;  // assertion still valid
1860 }
1861 
1862 void Dependencies::DepStream::trace_and_log_witness(Klass* witness) {
1863   if (witness != NULL) {
1864     if (TraceDependencies) {
1865       print_dependency(witness, /*verbose=*/ true);
1866     }
1867     // The following is a no-op unless logging is enabled:
1868     log_dependency(witness);
1869   }
1870 }
1871 
1872 
1873 Klass* Dependencies::DepStream::check_klass_dependency(KlassDepChange* changes) {
1874   assert_locked_or_safepoint(Compile_lock);
1875   Dependencies::check_valid_dependency_type(type());
1876 
1877   Klass* witness = NULL;
1878   switch (type()) {
1879   case evol_method:
1880     witness = check_evol_method(method_argument(0));
1881     break;
1882   case leaf_type:
1883     witness = check_leaf_type(context_type());
1884     break;
1885   case abstract_with_unique_concrete_subtype:
1886     witness = check_abstract_with_unique_concrete_subtype(context_type(), type_argument(1), changes);
1887     break;
1888   case abstract_with_no_concrete_subtype:
1889     witness = check_abstract_with_no_concrete_subtype(context_type(), changes);
1890     break;
1891   case concrete_with_no_concrete_subtype:
1892     witness = check_concrete_with_no_concrete_subtype(context_type(), changes);
1893     break;
1894   case unique_concrete_method:
1895     witness = check_unique_concrete_method(context_type(), method_argument(1), changes);
1896     break;
1897   case abstract_with_exclusive_concrete_subtypes_2:
1898     witness = check_abstract_with_exclusive_concrete_subtypes(context_type(), type_argument(1), type_argument(2), changes);
1899     break;
1900   case exclusive_concrete_methods_2:
1901     witness = check_exclusive_concrete_methods(context_type(), method_argument(1), method_argument(2), changes);
1902     break;
1903   case no_finalizable_subclasses:
1904     witness = check_has_no_finalizable_subclasses(context_type(), changes);
1905     break;
1906   default:
1907     witness = NULL;
1908     break;
1909   }
1910   trace_and_log_witness(witness);
1911   return witness;
1912 }
1913 
1914 
1915 Klass* Dependencies::DepStream::check_call_site_dependency(CallSiteDepChange* changes) {
1916   assert_locked_or_safepoint(Compile_lock);
1917   Dependencies::check_valid_dependency_type(type());
1918 
1919   Klass* witness = NULL;
1920   switch (type()) {
1921   case call_site_target_value:
1922     witness = check_call_site_target_value(argument_oop(0), argument_oop(1), changes);
1923     break;
1924   default:
1925     witness = NULL;
1926     break;
1927   }
1928   trace_and_log_witness(witness);
1929   return witness;
1930 }
1931 
1932 
1933 Klass* Dependencies::DepStream::spot_check_dependency_at(DepChange&amp; changes) {
1934   // Handle klass dependency
1935   if (changes.is_klass_change() &amp;&amp; changes.as_klass_change()-&gt;involves_context(context_type()))
1936     return check_klass_dependency(changes.as_klass_change());
1937 
1938   // Handle CallSite dependency
1939   if (changes.is_call_site_change())
1940     return check_call_site_dependency(changes.as_call_site_change());
1941 
1942   // irrelevant dependency; skip it
1943   return NULL;
1944 }
1945 
1946 
1947 void DepChange::print() {
1948   int nsup = 0, nint = 0;
1949   for (ContextStream str(*this); str.next(); ) {
1950     Klass* k = str.klass();
1951     switch (str.change_type()) {
1952     case Change_new_type:
1953       tty-&gt;print_cr(&quot;  dependee = %s&quot;, k-&gt;external_name());
1954       break;
1955     case Change_new_sub:
1956       if (!WizardMode) {
1957         ++nsup;
1958       } else {
1959         tty-&gt;print_cr(&quot;  context super = %s&quot;, k-&gt;external_name());
1960       }
1961       break;
1962     case Change_new_impl:
1963       if (!WizardMode) {
1964         ++nint;
1965       } else {
1966         tty-&gt;print_cr(&quot;  context interface = %s&quot;, k-&gt;external_name());
1967       }
1968       break;
1969     default:
1970       break;
1971     }
1972   }
1973   if (nsup + nint != 0) {
1974     tty-&gt;print_cr(&quot;  context supers = %d, interfaces = %d&quot;, nsup, nint);
1975   }
1976 }
1977 
1978 void DepChange::ContextStream::start() {
1979   Klass* new_type = _changes.is_klass_change() ? _changes.as_klass_change()-&gt;new_type() : (Klass*) NULL;
1980   _change_type = (new_type == NULL ? NO_CHANGE : Start_Klass);
1981   _klass = new_type;
1982   _ti_base = NULL;
1983   _ti_index = 0;
1984   _ti_limit = 0;
1985 }
1986 
1987 bool DepChange::ContextStream::next() {
1988   switch (_change_type) {
1989   case Start_Klass:             // initial state; _klass is the new type
1990     _ti_base = InstanceKlass::cast(_klass)-&gt;transitive_interfaces();
1991     _ti_index = 0;
1992     _change_type = Change_new_type;
1993     return true;
1994   case Change_new_type:
1995     // fall through:
1996     _change_type = Change_new_sub;
1997   case Change_new_sub:
1998     // 6598190: brackets workaround Sun Studio C++ compiler bug 6629277
1999     {
2000       _klass = _klass-&gt;super();
2001       if (_klass != NULL) {
2002         return true;
2003       }
2004     }
2005     // else set up _ti_limit and fall through:
2006     _ti_limit = (_ti_base == NULL) ? 0 : _ti_base-&gt;length();
2007     _change_type = Change_new_impl;
2008   case Change_new_impl:
2009     if (_ti_index &lt; _ti_limit) {
2010       _klass = _ti_base-&gt;at(_ti_index++);
2011       return true;
2012     }
2013     // fall through:
2014     _change_type = NO_CHANGE;  // iterator is exhausted
2015   case NO_CHANGE:
2016     break;
2017   default:
2018     ShouldNotReachHere();
2019   }
2020   return false;
2021 }
2022 
2023 void KlassDepChange::initialize() {
2024   // entire transaction must be under this lock:
2025   assert_lock_strong(Compile_lock);
2026 
2027   // Mark all dependee and all its superclasses
2028   // Mark transitive interfaces
2029   for (ContextStream str(*this); str.next(); ) {
2030     Klass* d = str.klass();
2031     assert(!InstanceKlass::cast(d)-&gt;is_marked_dependent(), &quot;checking&quot;);
2032     InstanceKlass::cast(d)-&gt;set_is_marked_dependent(true);
2033   }
2034 }
2035 
2036 KlassDepChange::~KlassDepChange() {
2037   // Unmark all dependee and all its superclasses
2038   // Unmark transitive interfaces
2039   for (ContextStream str(*this); str.next(); ) {
2040     Klass* d = str.klass();
2041     InstanceKlass::cast(d)-&gt;set_is_marked_dependent(false);
2042   }
2043 }
2044 
2045 bool KlassDepChange::involves_context(Klass* k) {
2046   if (k == NULL || !k-&gt;is_instance_klass()) {
2047     return false;
2048   }
2049   InstanceKlass* ik = InstanceKlass::cast(k);
2050   bool is_contained = ik-&gt;is_marked_dependent();
2051   assert(is_contained == new_type()-&gt;is_subtype_of(k),
2052          &quot;correct marking of potential context types&quot;);
2053   return is_contained;
2054 }
2055 
2056 #ifndef PRODUCT
2057 void Dependencies::print_statistics() {
2058   if (deps_find_witness_print != 0) {
2059     // Call one final time, to flush out the data.
2060     deps_find_witness_print = -1;
2061     count_find_witness_calls();
2062   }
2063 }
2064 #endif
2065 
2066 CallSiteDepChange::CallSiteDepChange(Handle call_site, Handle method_handle) :
2067   _call_site(call_site),
2068   _method_handle(method_handle) {
2069   assert(_call_site()-&gt;is_a(SystemDictionary::CallSite_klass()), &quot;must be&quot;);
2070   assert(_method_handle.is_null() || _method_handle()-&gt;is_a(SystemDictionary::MethodHandle_klass()), &quot;must be&quot;);
2071 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>