<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/code/codeBlob.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../classfile/vmSymbols.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="codeBlob.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/code/codeBlob.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,10 ***</span>
<span class="line-new-header">--- 29,11 ---</span>
  #include &quot;code/icBuffer.hpp&quot;
  #include &quot;code/relocInfo.hpp&quot;
  #include &quot;code/vtableStubs.hpp&quot;
  #include &quot;compiler/disassembler.hpp&quot;
  #include &quot;interpreter/bytecode.hpp&quot;
<span class="line-added">+ #include &quot;interpreter/interpreter.hpp&quot;</span>
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/heap.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;prims/forte.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 152,14 ***</span>
  ) : CodeBlob(name, compiler_none, CodeBlobLayout((address) this, size, header_size, cb), cb, frame_complete, frame_size, oop_maps, caller_must_gc_arguments) {
    cb-&gt;copy_code_and_locs_to(this);
  }
  
  void CodeBlob::flush() {
<span class="line-modified">!   if (_oop_maps) {</span>
<span class="line-modified">!     FREE_C_HEAP_ARRAY(unsigned char, _oop_maps);</span>
<span class="line-removed">-     _oop_maps = NULL;</span>
<span class="line-removed">-   }</span>
    _strings.free();
  }
  
  void CodeBlob::set_oop_maps(OopMapSet* p) {
    // Danger Will Robinson! This method allocates a big
<span class="line-new-header">--- 153,12 ---</span>
  ) : CodeBlob(name, compiler_none, CodeBlobLayout((address) this, size, header_size, cb), cb, frame_complete, frame_size, oop_maps, caller_must_gc_arguments) {
    cb-&gt;copy_code_and_locs_to(this);
  }
  
  void CodeBlob::flush() {
<span class="line-modified">!   FREE_C_HEAP_ARRAY(unsigned char, _oop_maps);</span>
<span class="line-modified">!   _oop_maps = NULL;</span>
    _strings.free();
  }
  
  void CodeBlob::set_oop_maps(OopMapSet* p) {
    // Danger Will Robinson! This method allocates a big
</pre>
<hr />
<pre>
<span class="line-old-header">*** 180,12 ***</span>
      char stub_id[256];
      assert(strlen(name1) + strlen(name2) &lt; sizeof(stub_id), &quot;&quot;);
      jio_snprintf(stub_id, sizeof(stub_id), &quot;%s%s&quot;, name1, name2);
      if (PrintStubCode) {
        ttyLocker ttyl;
        tty-&gt;print_cr(&quot;Decoding %s &quot; INTPTR_FORMAT, stub_id, (intptr_t) stub);
<span class="line-modified">!       Disassembler::decode(stub-&gt;code_begin(), stub-&gt;code_end());</span>
        tty-&gt;cr();
      }
      Forte::register_stub(stub_id, stub-&gt;code_begin(), stub-&gt;code_end());
  
      if (JvmtiExport::should_post_dynamic_code_generated()) {
<span class="line-new-header">--- 179,18 ---</span>
      char stub_id[256];
      assert(strlen(name1) + strlen(name2) &lt; sizeof(stub_id), &quot;&quot;);
      jio_snprintf(stub_id, sizeof(stub_id), &quot;%s%s&quot;, name1, name2);
      if (PrintStubCode) {
        ttyLocker ttyl;
<span class="line-added">+       tty-&gt;print_cr(&quot;- - - [BEGIN] - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&quot;);</span>
        tty-&gt;print_cr(&quot;Decoding %s &quot; INTPTR_FORMAT, stub_id, (intptr_t) stub);
<span class="line-modified">!       Disassembler::decode(stub-&gt;code_begin(), stub-&gt;code_end(), tty);</span>
<span class="line-added">+       if ((stub-&gt;oop_maps() != NULL) &amp;&amp; AbstractDisassembler::show_structs()) {</span>
<span class="line-added">+         tty-&gt;print_cr(&quot;- - - [OOP MAPS]- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&quot;);</span>
<span class="line-added">+         stub-&gt;oop_maps()-&gt;print();</span>
<span class="line-added">+       }</span>
<span class="line-added">+       tty-&gt;print_cr(&quot;- - - [END] - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&quot;);</span>
        tty-&gt;cr();
      }
      Forte::register_stub(stub_id, stub-&gt;code_begin(), stub-&gt;code_end());
  
      if (JvmtiExport::should_post_dynamic_code_generated()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 225,11 ***</span>
    // align the size to CodeEntryAlignment
    size = CodeBlob::align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) BufferBlob(name, size);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
<span class="line-new-header">--- 230,11 ---</span>
    // align the size to CodeEntryAlignment
    size = CodeBlob::align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) BufferBlob(name, size);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 246,11 ***</span>
  
    BufferBlob* blob = NULL;
    unsigned int size = CodeBlob::allocation_size(cb, sizeof(BufferBlob));
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) BufferBlob(name, size, cb);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
<span class="line-new-header">--- 251,11 ---</span>
  
    BufferBlob* blob = NULL;
    unsigned int size = CodeBlob::allocation_size(cb, sizeof(BufferBlob));
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) BufferBlob(name, size, cb);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 260,14 ***</span>
  void* BufferBlob::operator new(size_t s, unsigned size) throw() {
    return CodeCache::allocate(size, CodeBlobType::NonNMethod);
  }
  
  void BufferBlob::free(BufferBlob *blob) {
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    blob-&gt;flush();
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      CodeCache::free((RuntimeBlob*)blob);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  }
<span class="line-new-header">--- 265,15 ---</span>
  void* BufferBlob::operator new(size_t s, unsigned size) throw() {
    return CodeCache::allocate(size, CodeBlobType::NonNMethod);
  }
  
  void BufferBlob::free(BufferBlob *blob) {
<span class="line-added">+   assert(blob != NULL, &quot;caller must check for NULL&quot;);</span>
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    blob-&gt;flush();
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      CodeCache::free((RuntimeBlob*)blob);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 285,11 ***</span>
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
  
    AdapterBlob* blob = NULL;
    unsigned int size = CodeBlob::allocation_size(cb, sizeof(AdapterBlob));
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) AdapterBlob(size, cb);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
<span class="line-new-header">--- 291,11 ---</span>
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
  
    AdapterBlob* blob = NULL;
    unsigned int size = CodeBlob::allocation_size(cb, sizeof(AdapterBlob));
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) AdapterBlob(size, cb);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 308,11 ***</span>
    // align the size to CodeEntryAlignment
    size = align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) VtableBlob(name, size);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
<span class="line-new-header">--- 314,11 ---</span>
    // align the size to CodeEntryAlignment
    size = align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    assert(name != NULL, &quot;must provide a name&quot;);
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) VtableBlob(name, size);
    }
    // Track memory usage statistic after releasing CodeCache_lock
    MemoryService::track_code_cache_memory_usage();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 329,11 ***</span>
    unsigned int size = sizeof(MethodHandlesAdapterBlob);
    // align the size to CodeEntryAlignment
    size = CodeBlob::align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) MethodHandlesAdapterBlob(size);
      if (blob == NULL) {
        vm_exit_out_of_memory(size, OOM_MALLOC_ERROR, &quot;CodeCache: no room for method handle adapter blob&quot;);
      }
    }
<span class="line-new-header">--- 335,11 ---</span>
    unsigned int size = sizeof(MethodHandlesAdapterBlob);
    // align the size to CodeEntryAlignment
    size = CodeBlob::align_code_offset(size);
    size += align_up(buffer_size, oopSize);
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      blob = new (size) MethodHandlesAdapterBlob(size);
      if (blob == NULL) {
        vm_exit_out_of_memory(size, OOM_MALLOC_ERROR, &quot;CodeCache: no room for method handle adapter blob&quot;);
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 367,11 ***</span>
                                             bool caller_must_gc_arguments)
  {
    RuntimeStub* stub = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(RuntimeStub));
      stub = new (size) RuntimeStub(stub_name, cb, size, frame_complete, frame_size, oop_maps, caller_must_gc_arguments);
    }
  
    trace_new_stub(stub, &quot;RuntimeStub - &quot;, stub_name);
<span class="line-new-header">--- 373,11 ---</span>
                                             bool caller_must_gc_arguments)
  {
    RuntimeStub* stub = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(RuntimeStub));
      stub = new (size) RuntimeStub(stub_name, cb, size, frame_complete, frame_size, oop_maps, caller_must_gc_arguments);
    }
  
    trace_new_stub(stub, &quot;RuntimeStub - &quot;, stub_name);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 426,11 ***</span>
    int        frame_size)
  {
    DeoptimizationBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(DeoptimizationBlob));
      blob = new (size) DeoptimizationBlob(cb,
                                           size,
                                           oop_maps,
                                           unpack_offset,
<span class="line-new-header">--- 432,11 ---</span>
    int        frame_size)
  {
    DeoptimizationBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(DeoptimizationBlob));
      blob = new (size) DeoptimizationBlob(cb,
                                           size,
                                           oop_maps,
                                           unpack_offset,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 465,11 ***</span>
    int        frame_size)
  {
    UncommonTrapBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(UncommonTrapBlob));
      blob = new (size) UncommonTrapBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;UncommonTrapBlob&quot;);
<span class="line-new-header">--- 471,11 ---</span>
    int        frame_size)
  {
    UncommonTrapBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(UncommonTrapBlob));
      blob = new (size) UncommonTrapBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;UncommonTrapBlob&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 501,11 ***</span>
    int         frame_size)
  {
    ExceptionBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(ExceptionBlob));
      blob = new (size) ExceptionBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;ExceptionBlob&quot;);
<span class="line-new-header">--- 507,11 ---</span>
    int         frame_size)
  {
    ExceptionBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(ExceptionBlob));
      blob = new (size) ExceptionBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;ExceptionBlob&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 536,11 ***</span>
    int         frame_size)
  {
    SafepointBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(SafepointBlob));
      blob = new (size) SafepointBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;SafepointBlob&quot;);
<span class="line-new-header">--- 542,11 ---</span>
    int         frame_size)
  {
    SafepointBlob* blob = NULL;
    ThreadInVMfromUnknown __tiv;  // get to VM state in case we block on CodeCache_lock
    {
<span class="line-modified">!     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      unsigned int size = CodeBlob::allocation_size(cb, sizeof(SafepointBlob));
      blob = new (size) SafepointBlob(cb, size, oop_maps, frame_size);
    }
  
    trace_new_stub(blob, &quot;SafepointBlob&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 555,10 ***</span>
<span class="line-new-header">--- 561,12 ---</span>
  void CodeBlob::print_on(outputStream* st) const {
    st-&gt;print_cr(&quot;[CodeBlob (&quot; INTPTR_FORMAT &quot;)]&quot;, p2i(this));
    st-&gt;print_cr(&quot;Framesize: %d&quot;, _frame_size);
  }
  
<span class="line-added">+ void CodeBlob::print() const { print_on(tty); }</span>
<span class="line-added">+ </span>
  void CodeBlob::print_value_on(outputStream* st) const {
    st-&gt;print_cr(&quot;[CodeBlob]&quot;);
  }
  
  void CodeBlob::dump_for_addr(address addr, outputStream* st, bool verbose) const {
</pre>
<center><a href="../classfile/vmSymbols.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="codeBlob.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>