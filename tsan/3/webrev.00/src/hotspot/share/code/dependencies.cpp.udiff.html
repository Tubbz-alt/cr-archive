<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/code/dependencies.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="debugInfo.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="dependencies.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/code/dependencies.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,10 +106,11 @@</span>
    assert_common_1(concrete_with_no_concrete_subtype, ctxk);
  }
  
  void Dependencies::assert_unique_concrete_method(ciKlass* ctxk, ciMethod* uniqm) {
    check_ctxk(ctxk);
<span class="udiff-line-added">+   check_unique_method(ctxk, uniqm);</span>
    assert_common_2(unique_concrete_method, ctxk, uniqm);
  }
  
  void Dependencies::assert_abstract_with_exclusive_concrete_subtypes(ciKlass* ctxk, ciKlass* k1, ciKlass* k2) {
    check_ctxk(ctxk);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -178,10 +179,11 @@</span>
    assert_common_2(abstract_with_unique_concrete_subtype, ctxk_dv, conck_dv);
  }
  
  void Dependencies::assert_unique_concrete_method(Klass* ctxk, Method* uniqm) {
    check_ctxk(ctxk);
<span class="udiff-line-added">+   check_unique_method(ctxk, uniqm);</span>
    assert_common_2(unique_concrete_method, DepValue(_oop_recorder, ctxk), DepValue(_oop_recorder, uniqm));
  }
  
  void Dependencies::assert_call_site_target_value(oop call_site, oop method_handle) {
    assert_common_2(call_site_target_value, DepValue(_oop_recorder, JNIHandles::make_local(call_site)), DepValue(_oop_recorder, JNIHandles::make_local(method_handle)));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -623,36 +625,14 @@</span>
  
  void Dependencies::check_valid_dependency_type(DepType dept) {
    guarantee(FIRST_TYPE &lt;= dept &amp;&amp; dept &lt; TYPE_LIMIT, &quot;invalid dependency type: %d&quot;, (int) dept);
  }
  
<span class="udiff-line-modified-removed">- Dependencies::DepType Dependencies::validate_dependencies(CompileTask* task, bool counter_changed, char** failure_detail) {</span>
<span class="udiff-line-removed">-   // First, check non-klass dependencies as we might return early and</span>
<span class="udiff-line-removed">-   // not check klass dependencies if the system dictionary</span>
<span class="udiff-line-removed">-   // modification counter hasn&#39;t changed (see below).</span>
<span class="udiff-line-removed">-   for (Dependencies::DepStream deps(this); deps.next(); ) {</span>
<span class="udiff-line-removed">-     if (deps.is_klass_type())  continue;  // skip klass dependencies</span>
<span class="udiff-line-removed">-     Klass* witness = deps.check_dependency();</span>
<span class="udiff-line-removed">-     if (witness != NULL) {</span>
<span class="udiff-line-removed">-       return deps.type();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Klass dependencies must be checked when the system dictionary</span>
<span class="udiff-line-removed">-   // changes.  If logging is enabled all violated dependences will be</span>
<span class="udiff-line-removed">-   // recorded in the log.  In debug mode check dependencies even if</span>
<span class="udiff-line-removed">-   // the system dictionary hasn&#39;t changed to verify that no invalid</span>
<span class="udiff-line-removed">-   // dependencies were inserted.  Any violated dependences in this</span>
<span class="udiff-line-removed">-   // case are dumped to the tty.</span>
<span class="udiff-line-removed">-   if (!counter_changed &amp;&amp; !trueInDebug) {</span>
<span class="udiff-line-removed">-     return end_marker;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+ Dependencies::DepType Dependencies::validate_dependencies(CompileTask* task, char** failure_detail) {</span>
    int klass_violations = 0;
    DepType result = end_marker;
    for (Dependencies::DepStream deps(this); deps.next(); ) {
<span class="udiff-line-removed">-     if (!deps.is_klass_type())  continue;  // skip non-klass dependencies</span>
      Klass* witness = deps.check_dependency();
      if (witness != NULL) {
        if (klass_violations == 0) {
          result = deps.type();
          if (failure_detail != NULL &amp;&amp; klass_violations == 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -663,33 +643,19 @@</span>
            deps.print_dependency(witness, true, &amp;st);
            *failure_detail = st.as_string();
          }
        }
        klass_violations++;
<span class="udiff-line-modified-removed">-       if (!counter_changed) {</span>
<span class="udiff-line-removed">-         // Dependence failed but counter didn&#39;t change.  Log a message</span>
<span class="udiff-line-removed">-         // describing what failed and allow the assert at the end to</span>
<span class="udiff-line-removed">-         // trigger.</span>
<span class="udiff-line-removed">-         deps.print_dependency(witness);</span>
<span class="udiff-line-removed">-       } else if (xtty == NULL) {</span>
<span class="udiff-line-modified-added">+       if (xtty == NULL) {</span>
          // If we&#39;re not logging then a single violation is sufficient,
          // otherwise we want to log all the dependences which were
          // violated.
          break;
        }
      }
    }
  
<span class="udiff-line-removed">-   if (klass_violations != 0) {</span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">-     if (task != NULL &amp;&amp; !counter_changed &amp;&amp; !PrintCompilation) {</span>
<span class="udiff-line-removed">-       // Print out the compile task that failed</span>
<span class="udiff-line-removed">-       task-&gt;print_tty();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-     assert(counter_changed, &quot;failed dependencies, but counter didn&#39;t change&quot;);</span>
<span class="udiff-line-removed">-   }</span>
    return result;
  }
  
  // for the sake of the compiler log, print out current dependencies:
  void Dependencies::log_all_dependencies() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1845,16 +1811,16 @@</span>
    assert(method_handle != NULL, &quot;sanity&quot;);
    assert(call_site-&gt;is_a(SystemDictionary::CallSite_klass()),     &quot;sanity&quot;);
  
    if (changes == NULL) {
      // Validate all CallSites
<span class="udiff-line-modified-removed">-     if (!oopDesc::equals(java_lang_invoke_CallSite::target(call_site), method_handle))</span>
<span class="udiff-line-modified-added">+     if (java_lang_invoke_CallSite::target(call_site) != method_handle)</span>
        return call_site-&gt;klass();  // assertion failed
    } else {
      // Validate the given CallSite
<span class="udiff-line-modified-removed">-     if (oopDesc::equals(call_site, changes-&gt;call_site()) &amp;&amp; !oopDesc::equals(java_lang_invoke_CallSite::target(call_site), changes-&gt;method_handle())) {</span>
<span class="udiff-line-modified-removed">-       assert(!oopDesc::equals(method_handle, changes-&gt;method_handle()), &quot;must be&quot;);</span>
<span class="udiff-line-modified-added">+     if (call_site == changes-&gt;call_site() &amp;&amp; java_lang_invoke_CallSite::target(call_site) != changes-&gt;method_handle()) {</span>
<span class="udiff-line-modified-added">+       assert(method_handle != changes-&gt;method_handle(), &quot;must be&quot;);</span>
        return call_site-&gt;klass();  // assertion failed
      }
    }
    return NULL;  // assertion still valid
  }
</pre>
<center><a href="debugInfo.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="dependencies.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>