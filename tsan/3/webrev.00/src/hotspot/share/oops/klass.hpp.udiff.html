<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/oops/klass.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="klass.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.inline.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/klass.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  #define SHARE_OOPS_KLASS_HPP
  
  #include &quot;classfile/classLoaderData.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;memory/memRegion.hpp&quot;
<span class="udiff-line-added">+ #include &quot;oops/markWord.hpp&quot;</span>
  #include &quot;oops/metadata.hpp&quot;
  #include &quot;oops/oop.hpp&quot;
  #include &quot;oops/oopHandle.hpp&quot;
  #include &quot;utilities/accessFlags.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,11 +66,10 @@</span>
  
  // Forward declarations.
  template &lt;class T&gt; class Array;
  template &lt;class T&gt; class GrowableArray;
  class fieldDescriptor;
<span class="udiff-line-removed">- class KlassSizeStats;</span>
  class klassVtable;
  class ModuleEntry;
  class PackageEntry;
  class ParCompactionManager;
  class PSPromotionManager;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -157,11 +157,11 @@</span>
    JFR_ONLY(DEFINE_TRACE_ID_FIELD;)
  
    // Biased locking implementation and statistics
    // (the 64-bit chunk goes first, to avoid some fragmentation)
    jlong    _last_biased_lock_bulk_revocation_time;
<span class="udiff-line-modified-removed">-   markOop  _prototype_header;   // Used when biased locking is both enabled and disabled for this type</span>
<span class="udiff-line-modified-added">+   markWord _prototype_header;   // Used when biased locking is both enabled and disabled for this type</span>
    jint     _biased_lock_revocation_count;
  
    // vtable length
    int _vtable_len;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -331,28 +331,27 @@</span>
    static ByteSize super_check_offset_offset()    { return in_ByteSize(offset_of(Klass, _super_check_offset)); }
    static ByteSize primary_supers_offset()        { return in_ByteSize(offset_of(Klass, _primary_supers)); }
    static ByteSize secondary_super_cache_offset() { return in_ByteSize(offset_of(Klass, _secondary_super_cache)); }
    static ByteSize secondary_supers_offset()      { return in_ByteSize(offset_of(Klass, _secondary_supers)); }
    static ByteSize java_mirror_offset()           { return in_ByteSize(offset_of(Klass, _java_mirror)); }
<span class="udiff-line-added">+   static ByteSize class_loader_data_offset()     { return in_ByteSize(offset_of(Klass, _class_loader_data)); }</span>
    static ByteSize modifier_flags_offset()        { return in_ByteSize(offset_of(Klass, _modifier_flags)); }
    static ByteSize layout_helper_offset()         { return in_ByteSize(offset_of(Klass, _layout_helper)); }
    static ByteSize access_flags_offset()          { return in_ByteSize(offset_of(Klass, _access_flags)); }
  
    // Unpacking layout_helper:
<span class="udiff-line-modified-removed">-   enum {</span>
<span class="udiff-line-modified-removed">-     _lh_neutral_value           = 0,  // neutral non-array non-instance value</span>
<span class="udiff-line-modified-removed">-     _lh_instance_slow_path_bit  = 0x01,</span>
<span class="udiff-line-modified-removed">-     _lh_log2_element_size_shift = BitsPerByte*0,</span>
<span class="udiff-line-modified-removed">-     _lh_log2_element_size_mask  = BitsPerLong-1,</span>
<span class="udiff-line-modified-removed">-     _lh_element_type_shift      = BitsPerByte*1,</span>
<span class="udiff-line-modified-removed">-     _lh_element_type_mask       = right_n_bits(BitsPerByte),  // shifted mask</span>
<span class="udiff-line-modified-removed">-     _lh_header_size_shift       = BitsPerByte*2,</span>
<span class="udiff-line-modified-removed">-     _lh_header_size_mask        = right_n_bits(BitsPerByte),  // shifted mask</span>
<span class="udiff-line-modified-removed">-     _lh_array_tag_bits          = 2,</span>
<span class="udiff-line-modified-removed">-     _lh_array_tag_shift         = BitsPerInt - _lh_array_tag_bits,</span>
<span class="udiff-line-removed">-     _lh_array_tag_obj_value     = ~0x01   // 0x80000000 &gt;&gt; 30</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-modified-added">+   static const int _lh_neutral_value           = 0;  // neutral non-array non-instance value</span>
<span class="udiff-line-modified-added">+   static const int _lh_instance_slow_path_bit  = 0x01;</span>
<span class="udiff-line-modified-added">+   static const int _lh_log2_element_size_shift = BitsPerByte*0;</span>
<span class="udiff-line-modified-added">+   static const int _lh_log2_element_size_mask  = BitsPerLong-1;</span>
<span class="udiff-line-modified-added">+   static const int _lh_element_type_shift      = BitsPerByte*1;</span>
<span class="udiff-line-modified-added">+   static const int _lh_element_type_mask       = right_n_bits(BitsPerByte);  // shifted mask</span>
<span class="udiff-line-modified-added">+   static const int _lh_header_size_shift       = BitsPerByte*2;</span>
<span class="udiff-line-modified-added">+   static const int _lh_header_size_mask        = right_n_bits(BitsPerByte);  // shifted mask</span>
<span class="udiff-line-modified-added">+   static const int _lh_array_tag_bits          = 2;</span>
<span class="udiff-line-modified-added">+   static const int _lh_array_tag_shift         = BitsPerInt - _lh_array_tag_bits;</span>
<span class="udiff-line-modified-added">+   static const int _lh_array_tag_obj_value     = ~0x01;   // 0x80000000 &gt;&gt; 30</span>
  
    static const unsigned int _lh_array_tag_type_value = 0Xffffffff; // ~0x00,  // 0xC0000000 &gt;&gt; 30
  
    static int layout_helper_size_in_bytes(jint lh) {
      assert(lh &gt; (jint)_lh_neutral_value, &quot;must be instance&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -465,12 +464,10 @@</span>
  
    // tells if the class should be initialized
    virtual bool should_be_initialized() const    { return false; }
    // initializes the klass
    virtual void initialize(TRAPS);
<span class="udiff-line-removed">-   // lookup operation for MethodLookupCache</span>
<span class="udiff-line-removed">-   friend class MethodLookupCache;</span>
    virtual Klass* find_field(Symbol* name, Symbol* signature, fieldDescriptor* fd) const;
    virtual Method* uncached_lookup_method(const Symbol* name, const Symbol* signature,
                                           OverpassLookupMode overpass_mode,
                                           PrivateLookupMode = find_private) const;
   public:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -520,25 +517,31 @@</span>
    // CDS support - remove and restore oops from metadata. Oops are not shared.
    virtual void remove_unshareable_info();
    virtual void remove_java_mirror();
    virtual void restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS);
  
<span class="udiff-line-modified-removed">-  public:</span>
<span class="udiff-line-modified-removed">-   // subclass accessor (here for convenience; undefined for non-klass objects)</span>
<span class="udiff-line-modified-removed">-   virtual bool is_leaf_class() const { fatal(&quot;not a class&quot;); return false; }</span>
<span class="udiff-line-modified-added">+   bool is_unshareable_info_restored() const {</span>
<span class="udiff-line-modified-added">+     assert(is_shared(), &quot;use this for shared classes only&quot;);</span>
<span class="udiff-line-modified-added">+     if (has_raw_archived_mirror()) {</span>
<span class="udiff-line-added">+       // _java_mirror is not a valid OopHandle but rather an encoded reference in the shared heap</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     } else if (_java_mirror.ptr_raw() == NULL) {</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+       return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
   public:
    // ALL FUNCTIONS BELOW THIS POINT ARE DISPATCHED FROM AN OOP
    // These functions describe behavior for the oop not the KLASS.
  
    // actual oop size of obj in memory
    virtual int oop_size(oop obj) const = 0;
  
    // Size of klass in word size.
    virtual int size() const = 0;
<span class="udiff-line-removed">- #if INCLUDE_SERVICES</span>
<span class="udiff-line-removed">-   virtual void collect_statistics(KlassSizeStats *sz) const;</span>
<span class="udiff-line-removed">- #endif</span>
  
    // Returns the Java name for a class (Resource allocated)
    // For arrays, this returns the name of the element with a leading &#39;[&#39;.
    // For classes, this returns the name with the package separators
    //     turned into &#39;.&#39;s.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -616,22 +619,22 @@</span>
    bool is_cloneable() const;
    void set_is_cloneable();
  
    // Biased locking support
    // Note: the prototype header is always set up to be at least the
<span class="udiff-line-modified-removed">-   // prototype markOop. If biased locking is enabled it may further be</span>
<span class="udiff-line-modified-added">+   // prototype markWord. If biased locking is enabled it may further be</span>
    // biasable and have an epoch.
<span class="udiff-line-modified-removed">-   markOop prototype_header() const      { return _prototype_header; }</span>
<span class="udiff-line-modified-added">+   markWord prototype_header() const      { return _prototype_header; }</span>
    // NOTE: once instances of this klass are floating around in the
    // system, this header must only be updated at a safepoint.
    // NOTE 2: currently we only ever set the prototype header to the
    // biasable prototype for instanceKlasses. There is no technical
    // reason why it could not be done for arrayKlasses aside from
    // wanting to reduce the initial scope of this optimization. There
    // are potential problems in setting the bias pattern for
    // JVM-internal oops.
<span class="udiff-line-modified-removed">-   inline void set_prototype_header(markOop header);</span>
<span class="udiff-line-modified-added">+   inline void set_prototype_header(markWord header);</span>
    static ByteSize prototype_header_offset() { return in_ByteSize(offset_of(Klass, _prototype_header)); }
  
    int  biased_lock_revocation_count() const { return (int) _biased_lock_revocation_count; }
    // Atomically increments biased_lock_revocation_count and returns updated value
    int atomic_incr_biased_lock_revocation_count();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -690,20 +693,9 @@</span>
  #endif
  
    virtual void oop_verify_on(oop obj, outputStream* st);
  
    // for error reporting
<span class="udiff-line-removed">-   static Klass* decode_klass_raw(narrowKlass narrow_klass);</span>
    static bool is_valid(Klass* k);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   static bool is_null(narrowKlass obj);</span>
<span class="udiff-line-removed">-   static bool is_null(Klass* obj);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // klass encoding for klass pointer in objects.</span>
<span class="udiff-line-removed">-   static narrowKlass encode_klass_not_null(Klass* v);</span>
<span class="udiff-line-removed">-   static narrowKlass encode_klass(Klass* v);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   static Klass* decode_klass_not_null(narrowKlass v);</span>
<span class="udiff-line-removed">-   static Klass* decode_klass(narrowKlass v);</span>
  };
  
  #endif // SHARE_OOPS_KLASS_HPP
</pre>
<center><a href="klass.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.inline.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>