<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/oops/klass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="instanceRefKlass.inline.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/klass.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/classLoaderData.inline.hpp&quot;
 27 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
 28 #include &quot;classfile/dictionary.hpp&quot;
 29 #include &quot;classfile/javaClasses.hpp&quot;

 30 #include &quot;classfile/systemDictionary.hpp&quot;
 31 #include &quot;classfile/vmSymbols.hpp&quot;
 32 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
 33 #include &quot;logging/log.hpp&quot;
<span class="line-removed"> 34 #include &quot;memory/heapInspection.hpp&quot;</span>
 35 #include &quot;memory/heapShared.hpp&quot;
 36 #include &quot;memory/metadataFactory.hpp&quot;
 37 #include &quot;memory/metaspaceClosure.hpp&quot;
 38 #include &quot;memory/metaspaceShared.hpp&quot;
 39 #include &quot;memory/oopFactory.hpp&quot;
 40 #include &quot;memory/resourceArea.hpp&quot;

 41 #include &quot;oops/compressedOops.inline.hpp&quot;
 42 #include &quot;oops/instanceKlass.hpp&quot;
 43 #include &quot;oops/klass.inline.hpp&quot;
 44 #include &quot;oops/oop.inline.hpp&quot;
 45 #include &quot;oops/oopHandle.inline.hpp&quot;
 46 #include &quot;runtime/atomic.hpp&quot;
 47 #include &quot;runtime/handles.inline.hpp&quot;
<span class="line-removed"> 48 #include &quot;runtime/orderAccess.hpp&quot;</span>
 49 #include &quot;utilities/macros.hpp&quot;

 50 #include &quot;utilities/stack.inline.hpp&quot;
 51 
 52 void Klass::set_java_mirror(Handle m) {
 53   assert(!m.is_null(), &quot;New mirror should never be null.&quot;);
 54   assert(_java_mirror.resolve() == NULL, &quot;should only be used to initialize mirror&quot;);
 55   _java_mirror = class_loader_data()-&gt;add_handle(m);
 56 }
 57 
<span class="line-removed"> 58 oop Klass::java_mirror() const {</span>
<span class="line-removed"> 59   return _java_mirror.resolve();</span>
<span class="line-removed"> 60 }</span>
<span class="line-removed"> 61 </span>
 62 oop Klass::java_mirror_no_keepalive() const {
 63   return _java_mirror.peek();
 64 }
 65 
 66 bool Klass::is_cloneable() const {
 67   return _access_flags.is_cloneable_fast() ||
 68          is_subtype_of(SystemDictionary::Cloneable_klass());
 69 }
 70 
 71 void Klass::set_is_cloneable() {
 72   if (name() == vmSymbols::java_lang_invoke_MemberName()) {
 73     assert(is_final(), &quot;no subclasses allowed&quot;);
 74     // MemberName cloning should not be intrinsified and always happen in JVM_Clone.
 75   } else if (is_instance_klass() &amp;&amp; InstanceKlass::cast(this)-&gt;reference_type() != REF_NONE) {
 76     // Reference cloning should not be intrinsified and always happen in JVM_Clone.
 77   } else {
 78     _access_flags.set_is_cloneable_fast();
 79   }
 80 }
 81 
</pre>
<hr />
<pre>
176   tty-&gt;print_cr(&quot;Error: uncached_lookup_method called on a klass oop.&quot;
177                 &quot; Likely error: reflection method does not correctly&quot;
178                 &quot; wrap return value in a mirror object.&quot;);
179 #endif
180   ShouldNotReachHere();
181   return NULL;
182 }
183 
184 void* Klass::operator new(size_t size, ClassLoaderData* loader_data, size_t word_size, TRAPS) throw() {
185   return Metaspace::allocate(loader_data, word_size, MetaspaceObj::ClassType, THREAD);
186 }
187 
188 // &quot;Normal&quot; instantiation is preceeded by a MetaspaceObj allocation
189 // which zeros out memory - calloc equivalent.
190 // The constructor is also used from CppVtableCloner,
191 // which doesn&#39;t zero out the memory before calling the constructor.
192 // Need to set the _java_mirror field explicitly to not hit an assert that the field
193 // should be NULL before setting it.
194 Klass::Klass(KlassID id) : _id(id),
195                            _java_mirror(NULL),
<span class="line-modified">196                            _prototype_header(markOopDesc::prototype()),</span>
197                            _shared_class_path_index(-1) {
198   CDS_ONLY(_shared_class_flags = 0;)
199   CDS_JAVA_HEAP_ONLY(_archived_mirror = 0;)
200   _primary_supers[0] = this;
201   set_super_check_offset(in_bytes(primary_supers_offset()));
202 }
203 
204 jint Klass::array_layout_helper(BasicType etype) {
205   assert(etype &gt;= T_BOOLEAN &amp;&amp; etype &lt;= T_OBJECT, &quot;valid etype&quot;);
206   // Note that T_ARRAY is not allowed here.
207   int  hsize = arrayOopDesc::base_offset_in_bytes(etype);
208   int  esize = type2aelembytes(etype);
209   bool isobj = (etype == T_OBJECT);
210   int  tag   =  isobj ? _lh_array_tag_obj_value : _lh_array_tag_type_value;
211   int lh = array_layout_helper(tag, hsize, etype, exact_log2(esize));
212 
213   assert(lh &lt; (int)_lh_neutral_value, &quot;must look like an array layout&quot;);
214   assert(layout_helper_is_array(lh), &quot;correct kind&quot;);
215   assert(layout_helper_is_objArray(lh) == isobj, &quot;correct kind&quot;);
216   assert(layout_helper_is_typeArray(lh) == !isobj, &quot;correct kind&quot;);
</pre>
<hr />
<pre>
347                                                        Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
348   assert(num_extra_slots == 0, &quot;override for complex klasses&quot;);
349   assert(transitive_interfaces == NULL, &quot;sanity&quot;);
350   set_secondary_supers(Universe::the_empty_klass_array());
351   return NULL;
352 }
353 
354 
355 // superklass links
356 InstanceKlass* Klass::superklass() const {
357   assert(super() == NULL || super()-&gt;is_instance_klass(), &quot;must be instance klass&quot;);
358   return _super == NULL ? NULL : InstanceKlass::cast(_super);
359 }
360 
361 // subklass links.  Used by the compiler (and vtable initialization)
362 // May be cleaned concurrently, so must use the Compile_lock.
363 // The log parameter is for clean_weak_klass_links to report unlinked classes.
364 Klass* Klass::subklass(bool log) const {
365   // Need load_acquire on the _subklass, because it races with inserts that
366   // publishes freshly initialized data.
<span class="line-modified">367   for (Klass* chain = OrderAccess::load_acquire(&amp;_subklass);</span>
368        chain != NULL;
369        // Do not need load_acquire on _next_sibling, because inserts never
370        // create _next_sibling edges to dead data.
371        chain = Atomic::load(&amp;chain-&gt;_next_sibling))
372   {
373     if (chain-&gt;is_loader_alive()) {
374       return chain;
375     } else if (log) {
376       if (log_is_enabled(Trace, class, unload)) {
377         ResourceMark rm;
378         log_trace(class, unload)(&quot;unlinking class (subclass): %s&quot;, chain-&gt;external_name());
379       }
380     }
381   }
382   return NULL;
383 }
384 
385 Klass* Klass::next_sibling(bool log) const {
386   // Do not need load_acquire on _next_sibling, because inserts never
387   // create _next_sibling edges to dead data.
388   for (Klass* chain = Atomic::load(&amp;_next_sibling);
389        chain != NULL;
390        chain = Atomic::load(&amp;chain-&gt;_next_sibling)) {
391     // Only return alive klass, there may be stale klass
392     // in this chain if cleaned concurrently.
393     if (chain-&gt;is_loader_alive()) {
394       return chain;
395     } else if (log) {
396       if (log_is_enabled(Trace, class, unload)) {
397         ResourceMark rm;
398         log_trace(class, unload)(&quot;unlinking class (sibling): %s&quot;, chain-&gt;external_name());
399       }
400     }
401   }
402   return NULL;
403 }
404 
405 void Klass::set_subklass(Klass* s) {
406   assert(s != this, &quot;sanity check&quot;);
<span class="line-modified">407   OrderAccess::release_store(&amp;_subklass, s);</span>
408 }
409 
410 void Klass::set_next_sibling(Klass* s) {
411   assert(s != this, &quot;sanity check&quot;);
412   // Does not need release semantics. If used by cleanup, it will link to
413   // already safely published data, and if used by inserts, will be published
414   // safely using cmpxchg.
<span class="line-modified">415   Atomic::store(s, &amp;_next_sibling);</span>
416 }
417 
418 void Klass::append_to_sibling_list() {
419   assert_locked_or_safepoint(Compile_lock);
420   debug_only(verify();)
421   // add ourselves to superklass&#39; subklass list
422   InstanceKlass* super = superklass();
423   if (super == NULL) return;        // special case: class Object
424   assert((!super-&gt;is_interface()    // interfaces cannot be supers
425           &amp;&amp; (super-&gt;superklass() == NULL || !is_interface())),
426          &quot;an interface can only be a subklass of Object&quot;);
427 
428   // Make sure there is no stale subklass head
429   super-&gt;clean_subklass();
430 
431   for (;;) {
<span class="line-modified">432     Klass* prev_first_subklass = OrderAccess::load_acquire(&amp;_super-&gt;_subklass);</span>
433     if (prev_first_subklass != NULL) {
434       // set our sibling to be the superklass&#39; previous first subklass
435       assert(prev_first_subklass-&gt;is_loader_alive(), &quot;May not attach not alive klasses&quot;);
436       set_next_sibling(prev_first_subklass);
437     }
438     // Note that the prev_first_subklass is always alive, meaning no sibling_next links
439     // are ever created to not alive klasses. This is an important invariant of the lock-free
440     // cleaning protocol, that allows us to safely unlink dead klasses from the sibling list.
<span class="line-modified">441     if (Atomic::cmpxchg(this, &amp;super-&gt;_subklass, prev_first_subklass) == prev_first_subklass) {</span>
442       return;
443     }
444   }
445   debug_only(verify();)
446 }
447 
448 void Klass::clean_subklass() {
449   for (;;) {
450     // Need load_acquire, due to contending with concurrent inserts
<span class="line-modified">451     Klass* subklass = OrderAccess::load_acquire(&amp;_subklass);</span>
452     if (subklass == NULL || subklass-&gt;is_loader_alive()) {
453       return;
454     }
455     // Try to fix _subklass until it points at something not dead.
<span class="line-modified">456     Atomic::cmpxchg(subklass-&gt;next_sibling(), &amp;_subklass, subklass);</span>
457   }
458 }
459 
460 void Klass::clean_weak_klass_links(bool unloading_occurred, bool clean_alive_klasses) {
461   if (!ClassUnloading || !unloading_occurred) {
462     return;
463   }
464 
465   Klass* root = SystemDictionary::Object_klass();
466   Stack&lt;Klass*, mtGC&gt; stack;
467 
468   stack.push(root);
469   while (!stack.is_empty()) {
470     Klass* current = stack.pop();
471 
472     assert(current-&gt;is_loader_alive(), &quot;just checking, this should be live&quot;);
473 
474     // Find and set the first alive subklass
475     Klass* sub = current-&gt;subklass(true);
476     current-&gt;clean_subklass();
</pre>
<hr />
<pre>
506   }
507 
508   it-&gt;push(&amp;_name);
509   it-&gt;push(&amp;_secondary_super_cache);
510   it-&gt;push(&amp;_secondary_supers);
511   for (int i = 0; i &lt; _primary_super_limit; i++) {
512     it-&gt;push(&amp;_primary_supers[i]);
513   }
514   it-&gt;push(&amp;_super);
515   it-&gt;push((Klass**)&amp;_subklass);
516   it-&gt;push((Klass**)&amp;_next_sibling);
517   it-&gt;push(&amp;_next_link);
518 
519   vtableEntry* vt = start_of_vtable();
520   for (int i=0; i&lt;vtable_length(); i++) {
521     it-&gt;push(vt[i].method_addr());
522   }
523 }
524 
525 void Klass::remove_unshareable_info() {
<span class="line-modified">526   assert (DumpSharedSpaces, &quot;only called for DumpSharedSpaces&quot;);</span>

527   JFR_ONLY(REMOVE_ID(this);)
528   if (log_is_enabled(Trace, cds, unshareable)) {
529     ResourceMark rm;
530     log_trace(cds, unshareable)(&quot;remove: %s&quot;, external_name());
531   }
532 
533   set_subklass(NULL);
534   set_next_sibling(NULL);
535   set_next_link(NULL);
536 
537   // Null out class_loader_data because we don&#39;t share that yet.
538   set_class_loader_data(NULL);
539   set_is_shared();
540 }
541 
542 void Klass::remove_java_mirror() {
<span class="line-modified">543   assert (DumpSharedSpaces, &quot;only called for DumpSharedSpaces&quot;);</span>
544   if (log_is_enabled(Trace, cds, unshareable)) {
545     ResourceMark rm;
546     log_trace(cds, unshareable)(&quot;remove java_mirror: %s&quot;, external_name());
547   }
548   // Just null out the mirror.  The class_loader_data() no longer exists.
549   _java_mirror = NULL;
550 }
551 
552 void Klass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS) {
553   assert(is_klass(), &quot;ensure C++ vtable is restored&quot;);
554   assert(is_shared(), &quot;must be set&quot;);
555   JFR_ONLY(RESTORE_ID(this);)
556   if (log_is_enabled(Trace, cds, unshareable)) {
<span class="line-modified">557     ResourceMark rm;</span>
558     log_trace(cds, unshareable)(&quot;restore: %s&quot;, external_name());
559   }
560 
561   // If an exception happened during CDS restore, some of these fields may already be
562   // set.  We leave the class on the CLD list, even if incomplete so that we don&#39;t
563   // modify the CLD list outside a safepoint.
564   if (class_loader_data() == NULL) {
565     // Restore class_loader_data to the null class loader data
566     set_class_loader_data(loader_data);
567 
568     // Add to null class loader list first before creating the mirror
569     // (same order as class file parsing)
570     loader_data-&gt;add_class(this);
571   }
572 
573   Handle loader(THREAD, loader_data-&gt;class_loader());
574   ModuleEntry* module_entry = NULL;
575   Klass* k = this;
576   if (k-&gt;is_objArray_klass()) {
577     k = ObjArrayKlass::cast(k)-&gt;bottom_klass();
578   }
579   // Obtain klass&#39; module.
580   if (k-&gt;is_instance_klass()) {
581     InstanceKlass* ik = (InstanceKlass*) k;
582     module_entry = ik-&gt;module();
583   } else {
584     module_entry = ModuleEntryTable::javabase_moduleEntry();
585   }
586   // Obtain java.lang.Module, if available
587   Handle module_handle(THREAD, ((module_entry != NULL) ? module_entry-&gt;module() : (oop)NULL));
588 
589   if (this-&gt;has_raw_archived_mirror()) {
<span class="line-modified">590     ResourceMark rm;</span>
591     log_debug(cds, mirror)(&quot;%s has raw archived mirror&quot;, external_name());
592     if (HeapShared::open_archive_heap_region_mapped()) {
593       bool present = java_lang_Class::restore_archived_mirror(this, loader, module_handle,
594                                                               protection_domain,
595                                                               CHECK);
596       if (present) {
597         return;
598       }
599     }
600 
601     // No archived mirror data
602     log_debug(cds, mirror)(&quot;No archived mirror data for %s&quot;, external_name());
603     _java_mirror = NULL;
604     this-&gt;clear_has_raw_archived_mirror();
605   }
606 
607   // Only recreate it if not present.  A previous attempt to restore may have
608   // gotten an OOM later but keep the mirror if it was created.
609   if (java_mirror() == NULL) {
610     log_trace(cds, mirror)(&quot;Recreate mirror for %s&quot;, external_name());
</pre>
<hr />
<pre>
655 
656 Klass* Klass::array_klass_impl(bool or_null, TRAPS) {
657   fatal(&quot;array_klass should be dispatched to InstanceKlass, ObjArrayKlass or TypeArrayKlass&quot;);
658   return NULL;
659 }
660 
661 void Klass::check_array_allocation_length(int length, int max_length, TRAPS) {
662   if (length &gt; max_length) {
663     if (!THREAD-&gt;in_retryable_allocation()) {
664       report_java_out_of_memory(&quot;Requested array size exceeds VM limit&quot;);
665       JvmtiExport::post_array_size_exhausted();
666       THROW_OOP(Universe::out_of_memory_error_array_size());
667     } else {
668       THROW_OOP(Universe::out_of_memory_error_retry());
669     }
670   } else if (length &lt; 0) {
671     THROW_MSG(vmSymbols::java_lang_NegativeArraySizeException(), err_msg(&quot;%d&quot;, length));
672   }
673 }
674 
<span class="line-removed">675 oop Klass::class_loader() const { return class_loader_data()-&gt;class_loader(); }</span>
<span class="line-removed">676 </span>
677 // In product mode, this function doesn&#39;t have virtual function calls so
678 // there might be some performance advantage to handling InstanceKlass here.
679 const char* Klass::external_name() const {
680   if (is_instance_klass()) {
681     const InstanceKlass* ik = static_cast&lt;const InstanceKlass*&gt;(this);
682     if (ik-&gt;is_unsafe_anonymous()) {
683       char addr_buf[20];
684       jio_snprintf(addr_buf, 20, &quot;/&quot; INTPTR_FORMAT, p2i(ik));
685       size_t addr_len = strlen(addr_buf);
686       size_t name_len = name()-&gt;utf8_length();
687       char*  result   = NEW_RESOURCE_ARRAY(char, name_len + addr_len + 1);
688       name()-&gt;as_klass_external_name(result, (int) name_len + 1);
689       assert(strlen(result) == name_len, &quot;&quot;);
690       strcpy(result + name_len, addr_buf);
691       assert(strlen(result) == name_len + addr_len, &quot;&quot;);
692       return result;
693     }
694   }
695   if (name() == NULL)  return &quot;&lt;unknown&gt;&quot;;
696   return name()-&gt;as_klass_external_name();
697 }
698 
699 const char* Klass::signature_name() const {
700   if (name() == NULL)  return &quot;&lt;unknown&gt;&quot;;
701   return name()-&gt;as_C_string();
702 }
703 
704 const char* Klass::external_kind() const {
705   if (is_interface()) return &quot;interface&quot;;
706   if (is_abstract()) return &quot;abstract class&quot;;
707   return &quot;class&quot;;
708 }
709 
710 // Unless overridden, modifier_flags is 0.
711 jint Klass::compute_modifier_flags(TRAPS) const {
712   return 0;
713 }
714 
715 int Klass::atomic_incr_biased_lock_revocation_count() {
<span class="line-modified">716   return (int) Atomic::add(1, &amp;_biased_lock_revocation_count);</span>
717 }
718 
719 // Unless overridden, jvmti_class_status has no flags set.
720 jint Klass::jvmti_class_status() const {
721   return 0;
722 }
723 
724 
725 // Printing
726 
727 void Klass::print_on(outputStream* st) const {
728   ResourceMark rm;
729   // print title
730   st-&gt;print(&quot;%s&quot;, internal_name());
731   print_address_on(st);
732   st-&gt;cr();
733 }
734 


735 void Klass::oop_print_on(oop obj, outputStream* st) {
<span class="line-removed">736   ResourceMark rm;</span>
737   // print title
738   st-&gt;print_cr(&quot;%s &quot;, internal_name());
739   obj-&gt;print_address_on(st);
740 
741   if (WizardMode) {
742      // print header
<span class="line-modified">743      obj-&gt;mark()-&gt;print_on(st);</span>



744   }
745 
746   // print class
<span class="line-modified">747   st-&gt;print(&quot; - klass: &quot;);</span>
748   obj-&gt;klass()-&gt;print_value_on(st);
749   st-&gt;cr();
750 }
751 
752 void Klass::oop_print_value_on(oop obj, outputStream* st) {
753   // print title
754   ResourceMark rm;              // Cannot print in debug mode without this
755   st-&gt;print(&quot;%s&quot;, internal_name());
756   obj-&gt;print_address_on(st);
757 }
758 
<span class="line-removed">759 #if INCLUDE_SERVICES</span>
<span class="line-removed">760 // Size Statistics</span>
<span class="line-removed">761 void Klass::collect_statistics(KlassSizeStats *sz) const {</span>
<span class="line-removed">762   sz-&gt;_klass_bytes = sz-&gt;count(this);</span>
<span class="line-removed">763   sz-&gt;_mirror_bytes = sz-&gt;count(java_mirror());</span>
<span class="line-removed">764   sz-&gt;_secondary_supers_bytes = sz-&gt;count_array(secondary_supers());</span>
<span class="line-removed">765 </span>
<span class="line-removed">766   sz-&gt;_ro_bytes += sz-&gt;_secondary_supers_bytes;</span>
<span class="line-removed">767   sz-&gt;_rw_bytes += sz-&gt;_klass_bytes + sz-&gt;_mirror_bytes;</span>
<span class="line-removed">768 }</span>
<span class="line-removed">769 #endif // INCLUDE_SERVICES</span>
<span class="line-removed">770 </span>
771 // Verification
772 
773 void Klass::verify_on(outputStream* st) {
774 
775   // This can be expensive, but it is worth checking that this klass is actually
776   // in the CLD graph but not in production.
777   assert(Metaspace::contains((address)this), &quot;Should be&quot;);
778 
779   guarantee(this-&gt;is_klass(),&quot;should be klass&quot;);
780 
781   if (super() != NULL) {
782     guarantee(super()-&gt;is_klass(), &quot;should be klass&quot;);
783   }
784   if (secondary_super_cache() != NULL) {
785     Klass* ko = secondary_super_cache();
786     guarantee(ko-&gt;is_klass(), &quot;should be klass&quot;);
787   }
788   for ( uint i = 0; i &lt; primary_super_limit(); i++ ) {
789     Klass* ko = _primary_supers[i];
790     if (ko != NULL) {
791       guarantee(ko-&gt;is_klass(), &quot;should be klass&quot;);
792     }
793   }
794 
795   if (java_mirror_no_keepalive() != NULL) {
796     guarantee(oopDesc::is_oop(java_mirror_no_keepalive()), &quot;should be instance&quot;);
797   }
798 }
799 
800 void Klass::oop_verify_on(oop obj, outputStream* st) {
801   guarantee(oopDesc::is_oop(obj),  &quot;should be oop&quot;);
802   guarantee(obj-&gt;klass()-&gt;is_klass(), &quot;klass field is not a klass&quot;);
803 }
804 
<span class="line-removed">805 Klass* Klass::decode_klass_raw(narrowKlass narrow_klass) {</span>
<span class="line-removed">806   return (Klass*)(void*)( (uintptr_t)Universe::narrow_klass_base() +</span>
<span class="line-removed">807                          ((uintptr_t)narrow_klass &lt;&lt; Universe::narrow_klass_shift()));</span>
<span class="line-removed">808 }</span>
<span class="line-removed">809 </span>
810 bool Klass::is_valid(Klass* k) {
811   if (!is_aligned(k, sizeof(MetaWord))) return false;
812   if ((size_t)k &lt; os::min_page_size()) return false;
813 
814   if (!os::is_readable_range(k, k + 1)) return false;
<span class="line-modified">815   if (!MetaspaceUtils::is_range_in_committed(k, k + 1)) return false;</span>
816 
817   if (!Symbol::is_valid(k-&gt;name())) return false;
818   return ClassLoaderDataGraph::is_valid(k-&gt;class_loader_data());
819 }
820 
<span class="line-removed">821 klassVtable Klass::vtable() const {</span>
<span class="line-removed">822   return klassVtable(const_cast&lt;Klass*&gt;(this), start_of_vtable(), vtable_length() / vtableEntry::size());</span>
<span class="line-removed">823 }</span>
<span class="line-removed">824 </span>
<span class="line-removed">825 vtableEntry* Klass::start_of_vtable() const {</span>
<span class="line-removed">826   return (vtableEntry*) ((address)this + in_bytes(vtable_start_offset()));</span>
<span class="line-removed">827 }</span>
<span class="line-removed">828 </span>
829 Method* Klass::method_at_vtable(int index)  {
830 #ifndef PRODUCT
831   assert(index &gt;= 0, &quot;valid vtable index&quot;);
832   if (DebugVtables) {
833     verify_vtable_index(index);
834   }
835 #endif
836   return start_of_vtable()[index].method();
837 }
838 
<span class="line-removed">839 ByteSize Klass::vtable_start_offset() {</span>
<span class="line-removed">840   return in_ByteSize(InstanceKlass::header_size() * wordSize);</span>
<span class="line-removed">841 }</span>
842 
843 #ifndef PRODUCT
844 
845 bool Klass::verify_vtable_index(int i) {
846   int limit = vtable_length()/vtableEntry::size();
847   assert(i &gt;= 0 &amp;&amp; i &lt; limit, &quot;index %d out of bounds %d&quot;, i, limit);
848   return true;
849 }
850 
851 #endif // PRODUCT
852 
853 // Caller needs ResourceMark
854 // joint_in_module_of_loader provides an optimization if 2 classes are in
855 // the same module to succinctly print out relevant information about their
856 // module name and class loader&#39;s name_and_id for error messages.
857 // Format:
858 //   &lt;fully-qualified-external-class-name1&gt; and &lt;fully-qualified-external-class-name2&gt;
859 //                      are in module &lt;module-name&gt;[@&lt;version&gt;]
860 //                      of loader &lt;loader-name_and_id&gt;[, parent loader &lt;parent-loader-name_and_id&gt;]
861 const char* Klass::joint_in_module_of_loader(const Klass* class2, bool include_parent_loader) const {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/classLoaderData.inline.hpp&quot;
 27 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
 28 #include &quot;classfile/dictionary.hpp&quot;
 29 #include &quot;classfile/javaClasses.hpp&quot;
<span class="line-added"> 30 #include &quot;classfile/moduleEntry.hpp&quot;</span>
 31 #include &quot;classfile/systemDictionary.hpp&quot;
 32 #include &quot;classfile/vmSymbols.hpp&quot;
 33 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
 34 #include &quot;logging/log.hpp&quot;

 35 #include &quot;memory/heapShared.hpp&quot;
 36 #include &quot;memory/metadataFactory.hpp&quot;
 37 #include &quot;memory/metaspaceClosure.hpp&quot;
 38 #include &quot;memory/metaspaceShared.hpp&quot;
 39 #include &quot;memory/oopFactory.hpp&quot;
 40 #include &quot;memory/resourceArea.hpp&quot;
<span class="line-added"> 41 #include &quot;memory/universe.hpp&quot;</span>
 42 #include &quot;oops/compressedOops.inline.hpp&quot;
 43 #include &quot;oops/instanceKlass.hpp&quot;
 44 #include &quot;oops/klass.inline.hpp&quot;
 45 #include &quot;oops/oop.inline.hpp&quot;
 46 #include &quot;oops/oopHandle.inline.hpp&quot;
 47 #include &quot;runtime/atomic.hpp&quot;
 48 #include &quot;runtime/handles.inline.hpp&quot;

 49 #include &quot;utilities/macros.hpp&quot;
<span class="line-added"> 50 #include &quot;utilities/powerOfTwo.hpp&quot;</span>
 51 #include &quot;utilities/stack.inline.hpp&quot;
 52 
 53 void Klass::set_java_mirror(Handle m) {
 54   assert(!m.is_null(), &quot;New mirror should never be null.&quot;);
 55   assert(_java_mirror.resolve() == NULL, &quot;should only be used to initialize mirror&quot;);
 56   _java_mirror = class_loader_data()-&gt;add_handle(m);
 57 }
 58 




 59 oop Klass::java_mirror_no_keepalive() const {
 60   return _java_mirror.peek();
 61 }
 62 
 63 bool Klass::is_cloneable() const {
 64   return _access_flags.is_cloneable_fast() ||
 65          is_subtype_of(SystemDictionary::Cloneable_klass());
 66 }
 67 
 68 void Klass::set_is_cloneable() {
 69   if (name() == vmSymbols::java_lang_invoke_MemberName()) {
 70     assert(is_final(), &quot;no subclasses allowed&quot;);
 71     // MemberName cloning should not be intrinsified and always happen in JVM_Clone.
 72   } else if (is_instance_klass() &amp;&amp; InstanceKlass::cast(this)-&gt;reference_type() != REF_NONE) {
 73     // Reference cloning should not be intrinsified and always happen in JVM_Clone.
 74   } else {
 75     _access_flags.set_is_cloneable_fast();
 76   }
 77 }
 78 
</pre>
<hr />
<pre>
173   tty-&gt;print_cr(&quot;Error: uncached_lookup_method called on a klass oop.&quot;
174                 &quot; Likely error: reflection method does not correctly&quot;
175                 &quot; wrap return value in a mirror object.&quot;);
176 #endif
177   ShouldNotReachHere();
178   return NULL;
179 }
180 
181 void* Klass::operator new(size_t size, ClassLoaderData* loader_data, size_t word_size, TRAPS) throw() {
182   return Metaspace::allocate(loader_data, word_size, MetaspaceObj::ClassType, THREAD);
183 }
184 
185 // &quot;Normal&quot; instantiation is preceeded by a MetaspaceObj allocation
186 // which zeros out memory - calloc equivalent.
187 // The constructor is also used from CppVtableCloner,
188 // which doesn&#39;t zero out the memory before calling the constructor.
189 // Need to set the _java_mirror field explicitly to not hit an assert that the field
190 // should be NULL before setting it.
191 Klass::Klass(KlassID id) : _id(id),
192                            _java_mirror(NULL),
<span class="line-modified">193                            _prototype_header(markWord::prototype()),</span>
194                            _shared_class_path_index(-1) {
195   CDS_ONLY(_shared_class_flags = 0;)
196   CDS_JAVA_HEAP_ONLY(_archived_mirror = 0;)
197   _primary_supers[0] = this;
198   set_super_check_offset(in_bytes(primary_supers_offset()));
199 }
200 
201 jint Klass::array_layout_helper(BasicType etype) {
202   assert(etype &gt;= T_BOOLEAN &amp;&amp; etype &lt;= T_OBJECT, &quot;valid etype&quot;);
203   // Note that T_ARRAY is not allowed here.
204   int  hsize = arrayOopDesc::base_offset_in_bytes(etype);
205   int  esize = type2aelembytes(etype);
206   bool isobj = (etype == T_OBJECT);
207   int  tag   =  isobj ? _lh_array_tag_obj_value : _lh_array_tag_type_value;
208   int lh = array_layout_helper(tag, hsize, etype, exact_log2(esize));
209 
210   assert(lh &lt; (int)_lh_neutral_value, &quot;must look like an array layout&quot;);
211   assert(layout_helper_is_array(lh), &quot;correct kind&quot;);
212   assert(layout_helper_is_objArray(lh) == isobj, &quot;correct kind&quot;);
213   assert(layout_helper_is_typeArray(lh) == !isobj, &quot;correct kind&quot;);
</pre>
<hr />
<pre>
344                                                        Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
345   assert(num_extra_slots == 0, &quot;override for complex klasses&quot;);
346   assert(transitive_interfaces == NULL, &quot;sanity&quot;);
347   set_secondary_supers(Universe::the_empty_klass_array());
348   return NULL;
349 }
350 
351 
352 // superklass links
353 InstanceKlass* Klass::superklass() const {
354   assert(super() == NULL || super()-&gt;is_instance_klass(), &quot;must be instance klass&quot;);
355   return _super == NULL ? NULL : InstanceKlass::cast(_super);
356 }
357 
358 // subklass links.  Used by the compiler (and vtable initialization)
359 // May be cleaned concurrently, so must use the Compile_lock.
360 // The log parameter is for clean_weak_klass_links to report unlinked classes.
361 Klass* Klass::subklass(bool log) const {
362   // Need load_acquire on the _subklass, because it races with inserts that
363   // publishes freshly initialized data.
<span class="line-modified">364   for (Klass* chain = Atomic::load_acquire(&amp;_subklass);</span>
365        chain != NULL;
366        // Do not need load_acquire on _next_sibling, because inserts never
367        // create _next_sibling edges to dead data.
368        chain = Atomic::load(&amp;chain-&gt;_next_sibling))
369   {
370     if (chain-&gt;is_loader_alive()) {
371       return chain;
372     } else if (log) {
373       if (log_is_enabled(Trace, class, unload)) {
374         ResourceMark rm;
375         log_trace(class, unload)(&quot;unlinking class (subclass): %s&quot;, chain-&gt;external_name());
376       }
377     }
378   }
379   return NULL;
380 }
381 
382 Klass* Klass::next_sibling(bool log) const {
383   // Do not need load_acquire on _next_sibling, because inserts never
384   // create _next_sibling edges to dead data.
385   for (Klass* chain = Atomic::load(&amp;_next_sibling);
386        chain != NULL;
387        chain = Atomic::load(&amp;chain-&gt;_next_sibling)) {
388     // Only return alive klass, there may be stale klass
389     // in this chain if cleaned concurrently.
390     if (chain-&gt;is_loader_alive()) {
391       return chain;
392     } else if (log) {
393       if (log_is_enabled(Trace, class, unload)) {
394         ResourceMark rm;
395         log_trace(class, unload)(&quot;unlinking class (sibling): %s&quot;, chain-&gt;external_name());
396       }
397     }
398   }
399   return NULL;
400 }
401 
402 void Klass::set_subklass(Klass* s) {
403   assert(s != this, &quot;sanity check&quot;);
<span class="line-modified">404   Atomic::release_store(&amp;_subklass, s);</span>
405 }
406 
407 void Klass::set_next_sibling(Klass* s) {
408   assert(s != this, &quot;sanity check&quot;);
409   // Does not need release semantics. If used by cleanup, it will link to
410   // already safely published data, and if used by inserts, will be published
411   // safely using cmpxchg.
<span class="line-modified">412   Atomic::store(&amp;_next_sibling, s);</span>
413 }
414 
415 void Klass::append_to_sibling_list() {
416   assert_locked_or_safepoint(Compile_lock);
417   debug_only(verify();)
418   // add ourselves to superklass&#39; subklass list
419   InstanceKlass* super = superklass();
420   if (super == NULL) return;        // special case: class Object
421   assert((!super-&gt;is_interface()    // interfaces cannot be supers
422           &amp;&amp; (super-&gt;superklass() == NULL || !is_interface())),
423          &quot;an interface can only be a subklass of Object&quot;);
424 
425   // Make sure there is no stale subklass head
426   super-&gt;clean_subklass();
427 
428   for (;;) {
<span class="line-modified">429     Klass* prev_first_subklass = Atomic::load_acquire(&amp;_super-&gt;_subklass);</span>
430     if (prev_first_subklass != NULL) {
431       // set our sibling to be the superklass&#39; previous first subklass
432       assert(prev_first_subklass-&gt;is_loader_alive(), &quot;May not attach not alive klasses&quot;);
433       set_next_sibling(prev_first_subklass);
434     }
435     // Note that the prev_first_subklass is always alive, meaning no sibling_next links
436     // are ever created to not alive klasses. This is an important invariant of the lock-free
437     // cleaning protocol, that allows us to safely unlink dead klasses from the sibling list.
<span class="line-modified">438     if (Atomic::cmpxchg(&amp;super-&gt;_subklass, prev_first_subklass, this) == prev_first_subklass) {</span>
439       return;
440     }
441   }
442   debug_only(verify();)
443 }
444 
445 void Klass::clean_subklass() {
446   for (;;) {
447     // Need load_acquire, due to contending with concurrent inserts
<span class="line-modified">448     Klass* subklass = Atomic::load_acquire(&amp;_subklass);</span>
449     if (subklass == NULL || subklass-&gt;is_loader_alive()) {
450       return;
451     }
452     // Try to fix _subklass until it points at something not dead.
<span class="line-modified">453     Atomic::cmpxchg(&amp;_subklass, subklass, subklass-&gt;next_sibling());</span>
454   }
455 }
456 
457 void Klass::clean_weak_klass_links(bool unloading_occurred, bool clean_alive_klasses) {
458   if (!ClassUnloading || !unloading_occurred) {
459     return;
460   }
461 
462   Klass* root = SystemDictionary::Object_klass();
463   Stack&lt;Klass*, mtGC&gt; stack;
464 
465   stack.push(root);
466   while (!stack.is_empty()) {
467     Klass* current = stack.pop();
468 
469     assert(current-&gt;is_loader_alive(), &quot;just checking, this should be live&quot;);
470 
471     // Find and set the first alive subklass
472     Klass* sub = current-&gt;subklass(true);
473     current-&gt;clean_subklass();
</pre>
<hr />
<pre>
503   }
504 
505   it-&gt;push(&amp;_name);
506   it-&gt;push(&amp;_secondary_super_cache);
507   it-&gt;push(&amp;_secondary_supers);
508   for (int i = 0; i &lt; _primary_super_limit; i++) {
509     it-&gt;push(&amp;_primary_supers[i]);
510   }
511   it-&gt;push(&amp;_super);
512   it-&gt;push((Klass**)&amp;_subklass);
513   it-&gt;push((Klass**)&amp;_next_sibling);
514   it-&gt;push(&amp;_next_link);
515 
516   vtableEntry* vt = start_of_vtable();
517   for (int i=0; i&lt;vtable_length(); i++) {
518     it-&gt;push(vt[i].method_addr());
519   }
520 }
521 
522 void Klass::remove_unshareable_info() {
<span class="line-modified">523   assert (Arguments::is_dumping_archive(),</span>
<span class="line-added">524           &quot;only called during CDS dump time&quot;);</span>
525   JFR_ONLY(REMOVE_ID(this);)
526   if (log_is_enabled(Trace, cds, unshareable)) {
527     ResourceMark rm;
528     log_trace(cds, unshareable)(&quot;remove: %s&quot;, external_name());
529   }
530 
531   set_subklass(NULL);
532   set_next_sibling(NULL);
533   set_next_link(NULL);
534 
535   // Null out class_loader_data because we don&#39;t share that yet.
536   set_class_loader_data(NULL);
537   set_is_shared();
538 }
539 
540 void Klass::remove_java_mirror() {
<span class="line-modified">541   Arguments::assert_is_dumping_archive();</span>
542   if (log_is_enabled(Trace, cds, unshareable)) {
543     ResourceMark rm;
544     log_trace(cds, unshareable)(&quot;remove java_mirror: %s&quot;, external_name());
545   }
546   // Just null out the mirror.  The class_loader_data() no longer exists.
547   _java_mirror = NULL;
548 }
549 
550 void Klass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS) {
551   assert(is_klass(), &quot;ensure C++ vtable is restored&quot;);
552   assert(is_shared(), &quot;must be set&quot;);
553   JFR_ONLY(RESTORE_ID(this);)
554   if (log_is_enabled(Trace, cds, unshareable)) {
<span class="line-modified">555     ResourceMark rm(THREAD);</span>
556     log_trace(cds, unshareable)(&quot;restore: %s&quot;, external_name());
557   }
558 
559   // If an exception happened during CDS restore, some of these fields may already be
560   // set.  We leave the class on the CLD list, even if incomplete so that we don&#39;t
561   // modify the CLD list outside a safepoint.
562   if (class_loader_data() == NULL) {
563     // Restore class_loader_data to the null class loader data
564     set_class_loader_data(loader_data);
565 
566     // Add to null class loader list first before creating the mirror
567     // (same order as class file parsing)
568     loader_data-&gt;add_class(this);
569   }
570 
571   Handle loader(THREAD, loader_data-&gt;class_loader());
572   ModuleEntry* module_entry = NULL;
573   Klass* k = this;
574   if (k-&gt;is_objArray_klass()) {
575     k = ObjArrayKlass::cast(k)-&gt;bottom_klass();
576   }
577   // Obtain klass&#39; module.
578   if (k-&gt;is_instance_klass()) {
579     InstanceKlass* ik = (InstanceKlass*) k;
580     module_entry = ik-&gt;module();
581   } else {
582     module_entry = ModuleEntryTable::javabase_moduleEntry();
583   }
584   // Obtain java.lang.Module, if available
585   Handle module_handle(THREAD, ((module_entry != NULL) ? module_entry-&gt;module() : (oop)NULL));
586 
587   if (this-&gt;has_raw_archived_mirror()) {
<span class="line-modified">588     ResourceMark rm(THREAD);</span>
589     log_debug(cds, mirror)(&quot;%s has raw archived mirror&quot;, external_name());
590     if (HeapShared::open_archive_heap_region_mapped()) {
591       bool present = java_lang_Class::restore_archived_mirror(this, loader, module_handle,
592                                                               protection_domain,
593                                                               CHECK);
594       if (present) {
595         return;
596       }
597     }
598 
599     // No archived mirror data
600     log_debug(cds, mirror)(&quot;No archived mirror data for %s&quot;, external_name());
601     _java_mirror = NULL;
602     this-&gt;clear_has_raw_archived_mirror();
603   }
604 
605   // Only recreate it if not present.  A previous attempt to restore may have
606   // gotten an OOM later but keep the mirror if it was created.
607   if (java_mirror() == NULL) {
608     log_trace(cds, mirror)(&quot;Recreate mirror for %s&quot;, external_name());
</pre>
<hr />
<pre>
653 
654 Klass* Klass::array_klass_impl(bool or_null, TRAPS) {
655   fatal(&quot;array_klass should be dispatched to InstanceKlass, ObjArrayKlass or TypeArrayKlass&quot;);
656   return NULL;
657 }
658 
659 void Klass::check_array_allocation_length(int length, int max_length, TRAPS) {
660   if (length &gt; max_length) {
661     if (!THREAD-&gt;in_retryable_allocation()) {
662       report_java_out_of_memory(&quot;Requested array size exceeds VM limit&quot;);
663       JvmtiExport::post_array_size_exhausted();
664       THROW_OOP(Universe::out_of_memory_error_array_size());
665     } else {
666       THROW_OOP(Universe::out_of_memory_error_retry());
667     }
668   } else if (length &lt; 0) {
669     THROW_MSG(vmSymbols::java_lang_NegativeArraySizeException(), err_msg(&quot;%d&quot;, length));
670   }
671 }
672 


673 // In product mode, this function doesn&#39;t have virtual function calls so
674 // there might be some performance advantage to handling InstanceKlass here.
675 const char* Klass::external_name() const {
676   if (is_instance_klass()) {
677     const InstanceKlass* ik = static_cast&lt;const InstanceKlass*&gt;(this);
678     if (ik-&gt;is_unsafe_anonymous()) {
679       char addr_buf[20];
680       jio_snprintf(addr_buf, 20, &quot;/&quot; INTPTR_FORMAT, p2i(ik));
681       size_t addr_len = strlen(addr_buf);
682       size_t name_len = name()-&gt;utf8_length();
683       char*  result   = NEW_RESOURCE_ARRAY(char, name_len + addr_len + 1);
684       name()-&gt;as_klass_external_name(result, (int) name_len + 1);
685       assert(strlen(result) == name_len, &quot;&quot;);
686       strcpy(result + name_len, addr_buf);
687       assert(strlen(result) == name_len + addr_len, &quot;&quot;);
688       return result;
689     }
690   }
691   if (name() == NULL)  return &quot;&lt;unknown&gt;&quot;;
692   return name()-&gt;as_klass_external_name();
693 }
694 
695 const char* Klass::signature_name() const {
696   if (name() == NULL)  return &quot;&lt;unknown&gt;&quot;;
697   return name()-&gt;as_C_string();
698 }
699 
700 const char* Klass::external_kind() const {
701   if (is_interface()) return &quot;interface&quot;;
702   if (is_abstract()) return &quot;abstract class&quot;;
703   return &quot;class&quot;;
704 }
705 
706 // Unless overridden, modifier_flags is 0.
707 jint Klass::compute_modifier_flags(TRAPS) const {
708   return 0;
709 }
710 
711 int Klass::atomic_incr_biased_lock_revocation_count() {
<span class="line-modified">712   return (int) Atomic::add(&amp;_biased_lock_revocation_count, 1);</span>
713 }
714 
715 // Unless overridden, jvmti_class_status has no flags set.
716 jint Klass::jvmti_class_status() const {
717   return 0;
718 }
719 
720 
721 // Printing
722 
723 void Klass::print_on(outputStream* st) const {
724   ResourceMark rm;
725   // print title
726   st-&gt;print(&quot;%s&quot;, internal_name());
727   print_address_on(st);
728   st-&gt;cr();
729 }
730 
<span class="line-added">731 #define BULLET  &quot; - &quot;</span>
<span class="line-added">732 </span>
733 void Klass::oop_print_on(oop obj, outputStream* st) {

734   // print title
735   st-&gt;print_cr(&quot;%s &quot;, internal_name());
736   obj-&gt;print_address_on(st);
737 
738   if (WizardMode) {
739      // print header
<span class="line-modified">740      obj-&gt;mark().print_on(st);</span>
<span class="line-added">741      st-&gt;cr();</span>
<span class="line-added">742      st-&gt;print(BULLET&quot;prototype_header: &quot; INTPTR_FORMAT, _prototype_header.value());</span>
<span class="line-added">743      st-&gt;cr();</span>
744   }
745 
746   // print class
<span class="line-modified">747   st-&gt;print(BULLET&quot;klass: &quot;);</span>
748   obj-&gt;klass()-&gt;print_value_on(st);
749   st-&gt;cr();
750 }
751 
752 void Klass::oop_print_value_on(oop obj, outputStream* st) {
753   // print title
754   ResourceMark rm;              // Cannot print in debug mode without this
755   st-&gt;print(&quot;%s&quot;, internal_name());
756   obj-&gt;print_address_on(st);
757 }
758 












759 // Verification
760 
761 void Klass::verify_on(outputStream* st) {
762 
763   // This can be expensive, but it is worth checking that this klass is actually
764   // in the CLD graph but not in production.
765   assert(Metaspace::contains((address)this), &quot;Should be&quot;);
766 
767   guarantee(this-&gt;is_klass(),&quot;should be klass&quot;);
768 
769   if (super() != NULL) {
770     guarantee(super()-&gt;is_klass(), &quot;should be klass&quot;);
771   }
772   if (secondary_super_cache() != NULL) {
773     Klass* ko = secondary_super_cache();
774     guarantee(ko-&gt;is_klass(), &quot;should be klass&quot;);
775   }
776   for ( uint i = 0; i &lt; primary_super_limit(); i++ ) {
777     Klass* ko = _primary_supers[i];
778     if (ko != NULL) {
779       guarantee(ko-&gt;is_klass(), &quot;should be klass&quot;);
780     }
781   }
782 
783   if (java_mirror_no_keepalive() != NULL) {
784     guarantee(oopDesc::is_oop(java_mirror_no_keepalive()), &quot;should be instance&quot;);
785   }
786 }
787 
788 void Klass::oop_verify_on(oop obj, outputStream* st) {
789   guarantee(oopDesc::is_oop(obj),  &quot;should be oop&quot;);
790   guarantee(obj-&gt;klass()-&gt;is_klass(), &quot;klass field is not a klass&quot;);
791 }
792 





793 bool Klass::is_valid(Klass* k) {
794   if (!is_aligned(k, sizeof(MetaWord))) return false;
795   if ((size_t)k &lt; os::min_page_size()) return false;
796 
797   if (!os::is_readable_range(k, k + 1)) return false;
<span class="line-modified">798   if (!Metaspace::contains(k)) return false;</span>
799 
800   if (!Symbol::is_valid(k-&gt;name())) return false;
801   return ClassLoaderDataGraph::is_valid(k-&gt;class_loader_data());
802 }
803 








804 Method* Klass::method_at_vtable(int index)  {
805 #ifndef PRODUCT
806   assert(index &gt;= 0, &quot;valid vtable index&quot;);
807   if (DebugVtables) {
808     verify_vtable_index(index);
809   }
810 #endif
811   return start_of_vtable()[index].method();
812 }
813 



814 
815 #ifndef PRODUCT
816 
817 bool Klass::verify_vtable_index(int i) {
818   int limit = vtable_length()/vtableEntry::size();
819   assert(i &gt;= 0 &amp;&amp; i &lt; limit, &quot;index %d out of bounds %d&quot;, i, limit);
820   return true;
821 }
822 
823 #endif // PRODUCT
824 
825 // Caller needs ResourceMark
826 // joint_in_module_of_loader provides an optimization if 2 classes are in
827 // the same module to succinctly print out relevant information about their
828 // module name and class loader&#39;s name_and_id for error messages.
829 // Format:
830 //   &lt;fully-qualified-external-class-name1&gt; and &lt;fully-qualified-external-class-name2&gt;
831 //                      are in module &lt;module-name&gt;[@&lt;version&gt;]
832 //                      of loader &lt;loader-name_and_id&gt;[, parent loader &lt;parent-loader-name_and_id&gt;]
833 const char* Klass::joint_in_module_of_loader(const Klass* class2, bool include_parent_loader) const {
</pre>
</td>
</tr>
</table>
<center><a href="instanceRefKlass.inline.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>