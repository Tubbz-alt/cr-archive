<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/oops/klass.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="klass.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/klass.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_OOPS_KLASS_HPP
 26 #define SHARE_OOPS_KLASS_HPP
 27 
 28 #include &quot;classfile/classLoaderData.hpp&quot;
 29 #include &quot;memory/iterator.hpp&quot;
 30 #include &quot;memory/memRegion.hpp&quot;

 31 #include &quot;oops/metadata.hpp&quot;
 32 #include &quot;oops/oop.hpp&quot;
 33 #include &quot;oops/oopHandle.hpp&quot;
 34 #include &quot;utilities/accessFlags.hpp&quot;
 35 #include &quot;utilities/macros.hpp&quot;
 36 #if INCLUDE_JFR
 37 #include &quot;jfr/support/jfrTraceIdExtension.hpp&quot;
 38 #endif
 39 
 40 // Klass IDs for all subclasses of Klass
 41 enum KlassID {
 42   InstanceKlassID,
 43   InstanceRefKlassID,
 44   InstanceMirrorKlassID,
 45   InstanceClassLoaderKlassID,
 46   TypeArrayKlassID,
 47   ObjArrayKlassID
 48 };
 49 
 50 const uint KLASS_ID_COUNT = 6;
 51 
 52 //
 53 // A Klass provides:
 54 //  1: language level class object (method dictionary etc.)
 55 //  2: provide vm dispatch behavior for the object
 56 // Both functions are combined into one C++ class.
 57 
 58 // One reason for the oop/klass dichotomy in the implementation is
 59 // that we don&#39;t want a C++ vtbl pointer in every object.  Thus,
 60 // normal oops don&#39;t have any virtual functions.  Instead, they
 61 // forward all &quot;virtual&quot; functions to their klass, which does have
 62 // a vtbl and does the C++ dispatch depending on the object&#39;s
 63 // actual type.  (See oop.inline.hpp for some of the forwarding code.)
 64 // ALL FUNCTIONS IMPLEMENTING THIS DISPATCH ARE PREFIXED WITH &quot;oop_&quot;!
 65 
 66 // Forward declarations.
 67 template &lt;class T&gt; class Array;
 68 template &lt;class T&gt; class GrowableArray;
 69 class fieldDescriptor;
<span class="line-removed"> 70 class KlassSizeStats;</span>
 71 class klassVtable;
 72 class ModuleEntry;
 73 class PackageEntry;
 74 class ParCompactionManager;
 75 class PSPromotionManager;
 76 class vtableEntry;
 77 
 78 class Klass : public Metadata {
 79   friend class VMStructs;
 80   friend class JVMCIVMStructs;
 81  protected:
 82   // If you add a new field that points to any metaspace object, you
 83   // must add this field to Klass::metaspace_pointers_do().
 84 
 85   // note: put frequently-used fields together at start of klass structure
 86   // for better cache behavior (may not make much of a difference but sure won&#39;t hurt)
 87   enum { _primary_super_limit = 8 };
 88 
 89   // The &quot;layout helper&quot; is a combined descriptor of object layout.
 90   // For klasses which are neither instance nor array, the value is zero.
</pre>
<hr />
<pre>
142   // First subclass (NULL if none); _subklass-&gt;next_sibling() is next one
143   Klass* volatile _subklass;
144   // Sibling link (or NULL); links all subklasses of a klass
145   Klass* volatile _next_sibling;
146 
147   // All klasses loaded by a class loader are chained through these links
148   Klass*      _next_link;
149 
150   // The VM&#39;s representation of the ClassLoader used to load this class.
151   // Provide access the corresponding instance java.lang.ClassLoader.
152   ClassLoaderData* _class_loader_data;
153 
154   jint        _modifier_flags;  // Processed access flags, for use by Class.getModifiers.
155   AccessFlags _access_flags;    // Access flags. The class/interface distinction is stored here.
156 
157   JFR_ONLY(DEFINE_TRACE_ID_FIELD;)
158 
159   // Biased locking implementation and statistics
160   // (the 64-bit chunk goes first, to avoid some fragmentation)
161   jlong    _last_biased_lock_bulk_revocation_time;
<span class="line-modified">162   markOop  _prototype_header;   // Used when biased locking is both enabled and disabled for this type</span>
163   jint     _biased_lock_revocation_count;
164 
165   // vtable length
166   int _vtable_len;
167 
168 private:
169   // This is an index into FileMapHeader::_shared_path_table[], to
170   // associate this class with the JAR file where it&#39;s loaded from during
171   // dump time. If a class is not loaded from the shared archive, this field is
172   // -1.
173   jshort _shared_class_path_index;
174 
175 #if INCLUDE_CDS
176   // Flags of the current shared class.
177   u2     _shared_class_flags;
178   enum {
179     _has_raw_archived_mirror = 1
180   };
181 #endif
182   // The _archived_mirror is set at CDS dump time pointing to the cached mirror
</pre>
<hr />
<pre>
316     NOT_CDS(return false;)
317   }
318 
319   // Obtain the module or package for this class
320   virtual ModuleEntry* module() const = 0;
321   virtual PackageEntry* package() const = 0;
322 
323  protected:                                // internal accessors
324   void     set_subklass(Klass* s);
325   void     set_next_sibling(Klass* s);
326 
327  public:
328 
329   // Compiler support
330   static ByteSize super_offset()                 { return in_ByteSize(offset_of(Klass, _super)); }
331   static ByteSize super_check_offset_offset()    { return in_ByteSize(offset_of(Klass, _super_check_offset)); }
332   static ByteSize primary_supers_offset()        { return in_ByteSize(offset_of(Klass, _primary_supers)); }
333   static ByteSize secondary_super_cache_offset() { return in_ByteSize(offset_of(Klass, _secondary_super_cache)); }
334   static ByteSize secondary_supers_offset()      { return in_ByteSize(offset_of(Klass, _secondary_supers)); }
335   static ByteSize java_mirror_offset()           { return in_ByteSize(offset_of(Klass, _java_mirror)); }

336   static ByteSize modifier_flags_offset()        { return in_ByteSize(offset_of(Klass, _modifier_flags)); }
337   static ByteSize layout_helper_offset()         { return in_ByteSize(offset_of(Klass, _layout_helper)); }
338   static ByteSize access_flags_offset()          { return in_ByteSize(offset_of(Klass, _access_flags)); }
339 
340   // Unpacking layout_helper:
<span class="line-modified">341   enum {</span>
<span class="line-modified">342     _lh_neutral_value           = 0,  // neutral non-array non-instance value</span>
<span class="line-modified">343     _lh_instance_slow_path_bit  = 0x01,</span>
<span class="line-modified">344     _lh_log2_element_size_shift = BitsPerByte*0,</span>
<span class="line-modified">345     _lh_log2_element_size_mask  = BitsPerLong-1,</span>
<span class="line-modified">346     _lh_element_type_shift      = BitsPerByte*1,</span>
<span class="line-modified">347     _lh_element_type_mask       = right_n_bits(BitsPerByte),  // shifted mask</span>
<span class="line-modified">348     _lh_header_size_shift       = BitsPerByte*2,</span>
<span class="line-modified">349     _lh_header_size_mask        = right_n_bits(BitsPerByte),  // shifted mask</span>
<span class="line-modified">350     _lh_array_tag_bits          = 2,</span>
<span class="line-modified">351     _lh_array_tag_shift         = BitsPerInt - _lh_array_tag_bits,</span>
<span class="line-removed">352     _lh_array_tag_obj_value     = ~0x01   // 0x80000000 &gt;&gt; 30</span>
<span class="line-removed">353   };</span>
354 
355   static const unsigned int _lh_array_tag_type_value = 0Xffffffff; // ~0x00,  // 0xC0000000 &gt;&gt; 30
356 
357   static int layout_helper_size_in_bytes(jint lh) {
358     assert(lh &gt; (jint)_lh_neutral_value, &quot;must be instance&quot;);
359     return (int) lh &amp; ~_lh_instance_slow_path_bit;
360   }
361   static bool layout_helper_needs_slow_path(jint lh) {
362     assert(lh &gt; (jint)_lh_neutral_value, &quot;must be instance&quot;);
363     return (lh &amp; _lh_instance_slow_path_bit) != 0;
364   }
365   static bool layout_helper_is_instance(jint lh) {
366     return (jint)lh &gt; (jint)_lh_neutral_value;
367   }
368   static bool layout_helper_is_array(jint lh) {
369     return (jint)lh &lt; (jint)_lh_neutral_value;
370   }
371   static bool layout_helper_is_typeArray(jint lh) {
372     // _lh_array_tag_type_value == (lh &gt;&gt; _lh_array_tag_shift);
373     return (juint)lh &gt;= (juint)(_lh_array_tag_type_value &lt;&lt; _lh_array_tag_shift);
</pre>
<hr />
<pre>
450       return search_secondary_supers(k);
451     }
452   }
453 
454   bool search_secondary_supers(Klass* k) const;
455 
456   // Find LCA in class hierarchy
457   Klass *LCA( Klass *k );
458 
459   // Check whether reflection/jni/jvm code is allowed to instantiate this class;
460   // if not, throw either an Error or an Exception.
461   virtual void check_valid_for_instantiation(bool throwError, TRAPS);
462 
463   // array copying
464   virtual void  copy_array(arrayOop s, int src_pos, arrayOop d, int dst_pos, int length, TRAPS);
465 
466   // tells if the class should be initialized
467   virtual bool should_be_initialized() const    { return false; }
468   // initializes the klass
469   virtual void initialize(TRAPS);
<span class="line-removed">470   // lookup operation for MethodLookupCache</span>
<span class="line-removed">471   friend class MethodLookupCache;</span>
472   virtual Klass* find_field(Symbol* name, Symbol* signature, fieldDescriptor* fd) const;
473   virtual Method* uncached_lookup_method(const Symbol* name, const Symbol* signature,
474                                          OverpassLookupMode overpass_mode,
475                                          PrivateLookupMode = find_private) const;
476  public:
477   Method* lookup_method(const Symbol* name, const Symbol* signature) const {
478     return uncached_lookup_method(name, signature, find_overpass);
479   }
480 
481   // array class with specific rank
482   Klass* array_klass(int rank, TRAPS)         {  return array_klass_impl(false, rank, THREAD); }
483 
484   // array class with this klass as element type
485   Klass* array_klass(TRAPS)                   {  return array_klass_impl(false, THREAD); }
486 
487   // These will return NULL instead of allocating on the heap:
488   // NB: these can block for a mutex, like other functions with TRAPS arg.
489   Klass* array_klass_or_null(int rank);
490   Klass* array_klass_or_null();
491 
</pre>
<hr />
<pre>
505 
506   // Error handling when length &gt; max_length or length &lt; 0
507   static void check_array_allocation_length(int length, int max_length, TRAPS);
508 
509   void set_vtable_length(int len) { _vtable_len= len; }
510 
511   vtableEntry* start_of_vtable() const;
512  public:
513   Method* method_at_vtable(int index);
514 
515   static ByteSize vtable_start_offset();
516   static ByteSize vtable_length_offset() {
517     return byte_offset_of(Klass, _vtable_len);
518   }
519 
520   // CDS support - remove and restore oops from metadata. Oops are not shared.
521   virtual void remove_unshareable_info();
522   virtual void remove_java_mirror();
523   virtual void restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS);
524 
<span class="line-modified">525  public:</span>
<span class="line-modified">526   // subclass accessor (here for convenience; undefined for non-klass objects)</span>
<span class="line-modified">527   virtual bool is_leaf_class() const { fatal(&quot;not a class&quot;); return false; }</span>









528  public:
529   // ALL FUNCTIONS BELOW THIS POINT ARE DISPATCHED FROM AN OOP
530   // These functions describe behavior for the oop not the KLASS.
531 
532   // actual oop size of obj in memory
533   virtual int oop_size(oop obj) const = 0;
534 
535   // Size of klass in word size.
536   virtual int size() const = 0;
<span class="line-removed">537 #if INCLUDE_SERVICES</span>
<span class="line-removed">538   virtual void collect_statistics(KlassSizeStats *sz) const;</span>
<span class="line-removed">539 #endif</span>
540 
541   // Returns the Java name for a class (Resource allocated)
542   // For arrays, this returns the name of the element with a leading &#39;[&#39;.
543   // For classes, this returns the name with the package separators
544   //     turned into &#39;.&#39;s.
545   const char* external_name() const;
546   // Returns the name for a class (Resource allocated) as the class
547   // would appear in a signature.
548   // For arrays, this returns the name of the element with a leading &#39;[&#39;.
549   // For classes, this returns the name with a leading &#39;L&#39; and a trailing &#39;;&#39;
550   //     and the package separators as &#39;/&#39;.
551   virtual const char* signature_name() const;
552 
553   const char* joint_in_module_of_loader(const Klass* class2, bool include_parent_loader = false) const;
554   const char* class_in_module_of_loader(bool use_are = false, bool include_parent_loader = false) const;
555 
556   // Returns &quot;interface&quot;, &quot;abstract class&quot; or &quot;class&quot;.
557   const char* external_kind() const;
558 
559   // type testing operations
</pre>
<hr />
<pre>
601   bool is_abstract() const              { return _access_flags.is_abstract(); }
602   bool is_super() const                 { return _access_flags.is_super(); }
603   bool is_synthetic() const             { return _access_flags.is_synthetic(); }
604   void set_is_synthetic()               { _access_flags.set_is_synthetic(); }
605   bool has_finalizer() const            { return _access_flags.has_finalizer(); }
606   bool has_final_method() const         { return _access_flags.has_final_method(); }
607   void set_has_finalizer()              { _access_flags.set_has_finalizer(); }
608   void set_has_final_method()           { _access_flags.set_has_final_method(); }
609   bool has_vanilla_constructor() const  { return _access_flags.has_vanilla_constructor(); }
610   void set_has_vanilla_constructor()    { _access_flags.set_has_vanilla_constructor(); }
611   bool has_miranda_methods () const     { return access_flags().has_miranda_methods(); }
612   void set_has_miranda_methods()        { _access_flags.set_has_miranda_methods(); }
613   bool is_shared() const                { return access_flags().is_shared_class(); } // shadows MetaspaceObj::is_shared)()
614   void set_is_shared()                  { _access_flags.set_is_shared_class(); }
615 
616   bool is_cloneable() const;
617   void set_is_cloneable();
618 
619   // Biased locking support
620   // Note: the prototype header is always set up to be at least the
<span class="line-modified">621   // prototype markOop. If biased locking is enabled it may further be</span>
622   // biasable and have an epoch.
<span class="line-modified">623   markOop prototype_header() const      { return _prototype_header; }</span>
624   // NOTE: once instances of this klass are floating around in the
625   // system, this header must only be updated at a safepoint.
626   // NOTE 2: currently we only ever set the prototype header to the
627   // biasable prototype for instanceKlasses. There is no technical
628   // reason why it could not be done for arrayKlasses aside from
629   // wanting to reduce the initial scope of this optimization. There
630   // are potential problems in setting the bias pattern for
631   // JVM-internal oops.
<span class="line-modified">632   inline void set_prototype_header(markOop header);</span>
633   static ByteSize prototype_header_offset() { return in_ByteSize(offset_of(Klass, _prototype_header)); }
634 
635   int  biased_lock_revocation_count() const { return (int) _biased_lock_revocation_count; }
636   // Atomically increments biased_lock_revocation_count and returns updated value
637   int atomic_incr_biased_lock_revocation_count();
638   void set_biased_lock_revocation_count(int val) { _biased_lock_revocation_count = (jint) val; }
639   jlong last_biased_lock_bulk_revocation_time() { return _last_biased_lock_bulk_revocation_time; }
640   void  set_last_biased_lock_bulk_revocation_time(jlong cur_time) { _last_biased_lock_bulk_revocation_time = cur_time; }
641 
642   JFR_ONLY(DEFINE_TRACE_ID_METHODS;)
643 
644   virtual void metaspace_pointers_do(MetaspaceClosure* iter);
645   virtual MetaspaceObj::Type type() const { return ClassType; }
646 
647   // Iff the class loader (or mirror for unsafe anonymous classes) is alive the
648   // Klass is considered alive. This is safe to call before the CLD is marked as
649   // unloading, and hence during concurrent class unloading.
650   bool is_loader_alive() const { return class_loader_data()-&gt;is_alive(); }
651 
652   void clean_subklass();
</pre>
<hr />
<pre>
675 
676   // Printing
677   virtual void print_on(outputStream* st) const;
678 
679   virtual void oop_print_value_on(oop obj, outputStream* st);
680   virtual void oop_print_on      (oop obj, outputStream* st);
681 
682   virtual const char* internal_name() const = 0;
683 
684   // Verification
685   virtual void verify_on(outputStream* st);
686   void verify() { verify_on(tty); }
687 
688 #ifndef PRODUCT
689   bool verify_vtable_index(int index);
690 #endif
691 
692   virtual void oop_verify_on(oop obj, outputStream* st);
693 
694   // for error reporting
<span class="line-removed">695   static Klass* decode_klass_raw(narrowKlass narrow_klass);</span>
696   static bool is_valid(Klass* k);
<span class="line-removed">697 </span>
<span class="line-removed">698   static bool is_null(narrowKlass obj);</span>
<span class="line-removed">699   static bool is_null(Klass* obj);</span>
<span class="line-removed">700 </span>
<span class="line-removed">701   // klass encoding for klass pointer in objects.</span>
<span class="line-removed">702   static narrowKlass encode_klass_not_null(Klass* v);</span>
<span class="line-removed">703   static narrowKlass encode_klass(Klass* v);</span>
<span class="line-removed">704 </span>
<span class="line-removed">705   static Klass* decode_klass_not_null(narrowKlass v);</span>
<span class="line-removed">706   static Klass* decode_klass(narrowKlass v);</span>
707 };
708 
709 #endif // SHARE_OOPS_KLASS_HPP
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_OOPS_KLASS_HPP
 26 #define SHARE_OOPS_KLASS_HPP
 27 
 28 #include &quot;classfile/classLoaderData.hpp&quot;
 29 #include &quot;memory/iterator.hpp&quot;
 30 #include &quot;memory/memRegion.hpp&quot;
<span class="line-added"> 31 #include &quot;oops/markWord.hpp&quot;</span>
 32 #include &quot;oops/metadata.hpp&quot;
 33 #include &quot;oops/oop.hpp&quot;
 34 #include &quot;oops/oopHandle.hpp&quot;
 35 #include &quot;utilities/accessFlags.hpp&quot;
 36 #include &quot;utilities/macros.hpp&quot;
 37 #if INCLUDE_JFR
 38 #include &quot;jfr/support/jfrTraceIdExtension.hpp&quot;
 39 #endif
 40 
 41 // Klass IDs for all subclasses of Klass
 42 enum KlassID {
 43   InstanceKlassID,
 44   InstanceRefKlassID,
 45   InstanceMirrorKlassID,
 46   InstanceClassLoaderKlassID,
 47   TypeArrayKlassID,
 48   ObjArrayKlassID
 49 };
 50 
 51 const uint KLASS_ID_COUNT = 6;
 52 
 53 //
 54 // A Klass provides:
 55 //  1: language level class object (method dictionary etc.)
 56 //  2: provide vm dispatch behavior for the object
 57 // Both functions are combined into one C++ class.
 58 
 59 // One reason for the oop/klass dichotomy in the implementation is
 60 // that we don&#39;t want a C++ vtbl pointer in every object.  Thus,
 61 // normal oops don&#39;t have any virtual functions.  Instead, they
 62 // forward all &quot;virtual&quot; functions to their klass, which does have
 63 // a vtbl and does the C++ dispatch depending on the object&#39;s
 64 // actual type.  (See oop.inline.hpp for some of the forwarding code.)
 65 // ALL FUNCTIONS IMPLEMENTING THIS DISPATCH ARE PREFIXED WITH &quot;oop_&quot;!
 66 
 67 // Forward declarations.
 68 template &lt;class T&gt; class Array;
 69 template &lt;class T&gt; class GrowableArray;
 70 class fieldDescriptor;

 71 class klassVtable;
 72 class ModuleEntry;
 73 class PackageEntry;
 74 class ParCompactionManager;
 75 class PSPromotionManager;
 76 class vtableEntry;
 77 
 78 class Klass : public Metadata {
 79   friend class VMStructs;
 80   friend class JVMCIVMStructs;
 81  protected:
 82   // If you add a new field that points to any metaspace object, you
 83   // must add this field to Klass::metaspace_pointers_do().
 84 
 85   // note: put frequently-used fields together at start of klass structure
 86   // for better cache behavior (may not make much of a difference but sure won&#39;t hurt)
 87   enum { _primary_super_limit = 8 };
 88 
 89   // The &quot;layout helper&quot; is a combined descriptor of object layout.
 90   // For klasses which are neither instance nor array, the value is zero.
</pre>
<hr />
<pre>
142   // First subclass (NULL if none); _subklass-&gt;next_sibling() is next one
143   Klass* volatile _subklass;
144   // Sibling link (or NULL); links all subklasses of a klass
145   Klass* volatile _next_sibling;
146 
147   // All klasses loaded by a class loader are chained through these links
148   Klass*      _next_link;
149 
150   // The VM&#39;s representation of the ClassLoader used to load this class.
151   // Provide access the corresponding instance java.lang.ClassLoader.
152   ClassLoaderData* _class_loader_data;
153 
154   jint        _modifier_flags;  // Processed access flags, for use by Class.getModifiers.
155   AccessFlags _access_flags;    // Access flags. The class/interface distinction is stored here.
156 
157   JFR_ONLY(DEFINE_TRACE_ID_FIELD;)
158 
159   // Biased locking implementation and statistics
160   // (the 64-bit chunk goes first, to avoid some fragmentation)
161   jlong    _last_biased_lock_bulk_revocation_time;
<span class="line-modified">162   markWord _prototype_header;   // Used when biased locking is both enabled and disabled for this type</span>
163   jint     _biased_lock_revocation_count;
164 
165   // vtable length
166   int _vtable_len;
167 
168 private:
169   // This is an index into FileMapHeader::_shared_path_table[], to
170   // associate this class with the JAR file where it&#39;s loaded from during
171   // dump time. If a class is not loaded from the shared archive, this field is
172   // -1.
173   jshort _shared_class_path_index;
174 
175 #if INCLUDE_CDS
176   // Flags of the current shared class.
177   u2     _shared_class_flags;
178   enum {
179     _has_raw_archived_mirror = 1
180   };
181 #endif
182   // The _archived_mirror is set at CDS dump time pointing to the cached mirror
</pre>
<hr />
<pre>
316     NOT_CDS(return false;)
317   }
318 
319   // Obtain the module or package for this class
320   virtual ModuleEntry* module() const = 0;
321   virtual PackageEntry* package() const = 0;
322 
323  protected:                                // internal accessors
324   void     set_subklass(Klass* s);
325   void     set_next_sibling(Klass* s);
326 
327  public:
328 
329   // Compiler support
330   static ByteSize super_offset()                 { return in_ByteSize(offset_of(Klass, _super)); }
331   static ByteSize super_check_offset_offset()    { return in_ByteSize(offset_of(Klass, _super_check_offset)); }
332   static ByteSize primary_supers_offset()        { return in_ByteSize(offset_of(Klass, _primary_supers)); }
333   static ByteSize secondary_super_cache_offset() { return in_ByteSize(offset_of(Klass, _secondary_super_cache)); }
334   static ByteSize secondary_supers_offset()      { return in_ByteSize(offset_of(Klass, _secondary_supers)); }
335   static ByteSize java_mirror_offset()           { return in_ByteSize(offset_of(Klass, _java_mirror)); }
<span class="line-added">336   static ByteSize class_loader_data_offset()     { return in_ByteSize(offset_of(Klass, _class_loader_data)); }</span>
337   static ByteSize modifier_flags_offset()        { return in_ByteSize(offset_of(Klass, _modifier_flags)); }
338   static ByteSize layout_helper_offset()         { return in_ByteSize(offset_of(Klass, _layout_helper)); }
339   static ByteSize access_flags_offset()          { return in_ByteSize(offset_of(Klass, _access_flags)); }
340 
341   // Unpacking layout_helper:
<span class="line-modified">342   static const int _lh_neutral_value           = 0;  // neutral non-array non-instance value</span>
<span class="line-modified">343   static const int _lh_instance_slow_path_bit  = 0x01;</span>
<span class="line-modified">344   static const int _lh_log2_element_size_shift = BitsPerByte*0;</span>
<span class="line-modified">345   static const int _lh_log2_element_size_mask  = BitsPerLong-1;</span>
<span class="line-modified">346   static const int _lh_element_type_shift      = BitsPerByte*1;</span>
<span class="line-modified">347   static const int _lh_element_type_mask       = right_n_bits(BitsPerByte);  // shifted mask</span>
<span class="line-modified">348   static const int _lh_header_size_shift       = BitsPerByte*2;</span>
<span class="line-modified">349   static const int _lh_header_size_mask        = right_n_bits(BitsPerByte);  // shifted mask</span>
<span class="line-modified">350   static const int _lh_array_tag_bits          = 2;</span>
<span class="line-modified">351   static const int _lh_array_tag_shift         = BitsPerInt - _lh_array_tag_bits;</span>
<span class="line-modified">352   static const int _lh_array_tag_obj_value     = ~0x01;   // 0x80000000 &gt;&gt; 30</span>


353 
354   static const unsigned int _lh_array_tag_type_value = 0Xffffffff; // ~0x00,  // 0xC0000000 &gt;&gt; 30
355 
356   static int layout_helper_size_in_bytes(jint lh) {
357     assert(lh &gt; (jint)_lh_neutral_value, &quot;must be instance&quot;);
358     return (int) lh &amp; ~_lh_instance_slow_path_bit;
359   }
360   static bool layout_helper_needs_slow_path(jint lh) {
361     assert(lh &gt; (jint)_lh_neutral_value, &quot;must be instance&quot;);
362     return (lh &amp; _lh_instance_slow_path_bit) != 0;
363   }
364   static bool layout_helper_is_instance(jint lh) {
365     return (jint)lh &gt; (jint)_lh_neutral_value;
366   }
367   static bool layout_helper_is_array(jint lh) {
368     return (jint)lh &lt; (jint)_lh_neutral_value;
369   }
370   static bool layout_helper_is_typeArray(jint lh) {
371     // _lh_array_tag_type_value == (lh &gt;&gt; _lh_array_tag_shift);
372     return (juint)lh &gt;= (juint)(_lh_array_tag_type_value &lt;&lt; _lh_array_tag_shift);
</pre>
<hr />
<pre>
449       return search_secondary_supers(k);
450     }
451   }
452 
453   bool search_secondary_supers(Klass* k) const;
454 
455   // Find LCA in class hierarchy
456   Klass *LCA( Klass *k );
457 
458   // Check whether reflection/jni/jvm code is allowed to instantiate this class;
459   // if not, throw either an Error or an Exception.
460   virtual void check_valid_for_instantiation(bool throwError, TRAPS);
461 
462   // array copying
463   virtual void  copy_array(arrayOop s, int src_pos, arrayOop d, int dst_pos, int length, TRAPS);
464 
465   // tells if the class should be initialized
466   virtual bool should_be_initialized() const    { return false; }
467   // initializes the klass
468   virtual void initialize(TRAPS);


469   virtual Klass* find_field(Symbol* name, Symbol* signature, fieldDescriptor* fd) const;
470   virtual Method* uncached_lookup_method(const Symbol* name, const Symbol* signature,
471                                          OverpassLookupMode overpass_mode,
472                                          PrivateLookupMode = find_private) const;
473  public:
474   Method* lookup_method(const Symbol* name, const Symbol* signature) const {
475     return uncached_lookup_method(name, signature, find_overpass);
476   }
477 
478   // array class with specific rank
479   Klass* array_klass(int rank, TRAPS)         {  return array_klass_impl(false, rank, THREAD); }
480 
481   // array class with this klass as element type
482   Klass* array_klass(TRAPS)                   {  return array_klass_impl(false, THREAD); }
483 
484   // These will return NULL instead of allocating on the heap:
485   // NB: these can block for a mutex, like other functions with TRAPS arg.
486   Klass* array_klass_or_null(int rank);
487   Klass* array_klass_or_null();
488 
</pre>
<hr />
<pre>
502 
503   // Error handling when length &gt; max_length or length &lt; 0
504   static void check_array_allocation_length(int length, int max_length, TRAPS);
505 
506   void set_vtable_length(int len) { _vtable_len= len; }
507 
508   vtableEntry* start_of_vtable() const;
509  public:
510   Method* method_at_vtable(int index);
511 
512   static ByteSize vtable_start_offset();
513   static ByteSize vtable_length_offset() {
514     return byte_offset_of(Klass, _vtable_len);
515   }
516 
517   // CDS support - remove and restore oops from metadata. Oops are not shared.
518   virtual void remove_unshareable_info();
519   virtual void remove_java_mirror();
520   virtual void restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS);
521 
<span class="line-modified">522   bool is_unshareable_info_restored() const {</span>
<span class="line-modified">523     assert(is_shared(), &quot;use this for shared classes only&quot;);</span>
<span class="line-modified">524     if (has_raw_archived_mirror()) {</span>
<span class="line-added">525       // _java_mirror is not a valid OopHandle but rather an encoded reference in the shared heap</span>
<span class="line-added">526       return false;</span>
<span class="line-added">527     } else if (_java_mirror.ptr_raw() == NULL) {</span>
<span class="line-added">528       return false;</span>
<span class="line-added">529     } else {</span>
<span class="line-added">530       return true;</span>
<span class="line-added">531     }</span>
<span class="line-added">532   }</span>
<span class="line-added">533 </span>
534  public:
535   // ALL FUNCTIONS BELOW THIS POINT ARE DISPATCHED FROM AN OOP
536   // These functions describe behavior for the oop not the KLASS.
537 
538   // actual oop size of obj in memory
539   virtual int oop_size(oop obj) const = 0;
540 
541   // Size of klass in word size.
542   virtual int size() const = 0;



543 
544   // Returns the Java name for a class (Resource allocated)
545   // For arrays, this returns the name of the element with a leading &#39;[&#39;.
546   // For classes, this returns the name with the package separators
547   //     turned into &#39;.&#39;s.
548   const char* external_name() const;
549   // Returns the name for a class (Resource allocated) as the class
550   // would appear in a signature.
551   // For arrays, this returns the name of the element with a leading &#39;[&#39;.
552   // For classes, this returns the name with a leading &#39;L&#39; and a trailing &#39;;&#39;
553   //     and the package separators as &#39;/&#39;.
554   virtual const char* signature_name() const;
555 
556   const char* joint_in_module_of_loader(const Klass* class2, bool include_parent_loader = false) const;
557   const char* class_in_module_of_loader(bool use_are = false, bool include_parent_loader = false) const;
558 
559   // Returns &quot;interface&quot;, &quot;abstract class&quot; or &quot;class&quot;.
560   const char* external_kind() const;
561 
562   // type testing operations
</pre>
<hr />
<pre>
604   bool is_abstract() const              { return _access_flags.is_abstract(); }
605   bool is_super() const                 { return _access_flags.is_super(); }
606   bool is_synthetic() const             { return _access_flags.is_synthetic(); }
607   void set_is_synthetic()               { _access_flags.set_is_synthetic(); }
608   bool has_finalizer() const            { return _access_flags.has_finalizer(); }
609   bool has_final_method() const         { return _access_flags.has_final_method(); }
610   void set_has_finalizer()              { _access_flags.set_has_finalizer(); }
611   void set_has_final_method()           { _access_flags.set_has_final_method(); }
612   bool has_vanilla_constructor() const  { return _access_flags.has_vanilla_constructor(); }
613   void set_has_vanilla_constructor()    { _access_flags.set_has_vanilla_constructor(); }
614   bool has_miranda_methods () const     { return access_flags().has_miranda_methods(); }
615   void set_has_miranda_methods()        { _access_flags.set_has_miranda_methods(); }
616   bool is_shared() const                { return access_flags().is_shared_class(); } // shadows MetaspaceObj::is_shared)()
617   void set_is_shared()                  { _access_flags.set_is_shared_class(); }
618 
619   bool is_cloneable() const;
620   void set_is_cloneable();
621 
622   // Biased locking support
623   // Note: the prototype header is always set up to be at least the
<span class="line-modified">624   // prototype markWord. If biased locking is enabled it may further be</span>
625   // biasable and have an epoch.
<span class="line-modified">626   markWord prototype_header() const      { return _prototype_header; }</span>
627   // NOTE: once instances of this klass are floating around in the
628   // system, this header must only be updated at a safepoint.
629   // NOTE 2: currently we only ever set the prototype header to the
630   // biasable prototype for instanceKlasses. There is no technical
631   // reason why it could not be done for arrayKlasses aside from
632   // wanting to reduce the initial scope of this optimization. There
633   // are potential problems in setting the bias pattern for
634   // JVM-internal oops.
<span class="line-modified">635   inline void set_prototype_header(markWord header);</span>
636   static ByteSize prototype_header_offset() { return in_ByteSize(offset_of(Klass, _prototype_header)); }
637 
638   int  biased_lock_revocation_count() const { return (int) _biased_lock_revocation_count; }
639   // Atomically increments biased_lock_revocation_count and returns updated value
640   int atomic_incr_biased_lock_revocation_count();
641   void set_biased_lock_revocation_count(int val) { _biased_lock_revocation_count = (jint) val; }
642   jlong last_biased_lock_bulk_revocation_time() { return _last_biased_lock_bulk_revocation_time; }
643   void  set_last_biased_lock_bulk_revocation_time(jlong cur_time) { _last_biased_lock_bulk_revocation_time = cur_time; }
644 
645   JFR_ONLY(DEFINE_TRACE_ID_METHODS;)
646 
647   virtual void metaspace_pointers_do(MetaspaceClosure* iter);
648   virtual MetaspaceObj::Type type() const { return ClassType; }
649 
650   // Iff the class loader (or mirror for unsafe anonymous classes) is alive the
651   // Klass is considered alive. This is safe to call before the CLD is marked as
652   // unloading, and hence during concurrent class unloading.
653   bool is_loader_alive() const { return class_loader_data()-&gt;is_alive(); }
654 
655   void clean_subklass();
</pre>
<hr />
<pre>
678 
679   // Printing
680   virtual void print_on(outputStream* st) const;
681 
682   virtual void oop_print_value_on(oop obj, outputStream* st);
683   virtual void oop_print_on      (oop obj, outputStream* st);
684 
685   virtual const char* internal_name() const = 0;
686 
687   // Verification
688   virtual void verify_on(outputStream* st);
689   void verify() { verify_on(tty); }
690 
691 #ifndef PRODUCT
692   bool verify_vtable_index(int index);
693 #endif
694 
695   virtual void oop_verify_on(oop obj, outputStream* st);
696 
697   // for error reporting

698   static bool is_valid(Klass* k);










699 };
700 
701 #endif // SHARE_OOPS_KLASS_HPP
</pre>
</td>
</tr>
</table>
<center><a href="klass.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="klass.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>