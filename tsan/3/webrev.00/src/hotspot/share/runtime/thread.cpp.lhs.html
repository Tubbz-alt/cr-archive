<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/thread.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
<a name="2" id="anc2"></a>
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/javaClasses.hpp&quot;
  29 #include &quot;classfile/moduleEntry.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;code/codeCache.hpp&quot;
  33 #include &quot;code/scopeDesc.hpp&quot;
  34 #include &quot;compiler/compileBroker.hpp&quot;
  35 #include &quot;compiler/compileTask.hpp&quot;
  36 #include &quot;gc/shared/barrierSet.hpp&quot;
  37 #include &quot;gc/shared/gcId.hpp&quot;
  38 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  39 #include &quot;gc/shared/workgroup.hpp&quot;
  40 #include &quot;interpreter/interpreter.hpp&quot;
  41 #include &quot;interpreter/linkResolver.hpp&quot;
  42 #include &quot;interpreter/oopMapCache.hpp&quot;
  43 #include &quot;jfr/jfrEvents.hpp&quot;
  44 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;logging/logConfiguration.hpp&quot;
  47 #include &quot;logging/logStream.hpp&quot;
  48 #include &quot;memory/allocation.inline.hpp&quot;
<a name="3" id="anc3"></a>
  49 #include &quot;memory/metaspaceShared.hpp&quot;
  50 #include &quot;memory/oopFactory.hpp&quot;
  51 #include &quot;memory/resourceArea.hpp&quot;
  52 #include &quot;memory/universe.hpp&quot;
  53 #include &quot;oops/access.inline.hpp&quot;
  54 #include &quot;oops/instanceKlass.hpp&quot;
  55 #include &quot;oops/objArrayOop.hpp&quot;
  56 #include &quot;oops/oop.inline.hpp&quot;
  57 #include &quot;oops/symbol.hpp&quot;
  58 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  59 #include &quot;oops/verifyOopClosure.hpp&quot;
  60 #include &quot;prims/jvm_misc.hpp&quot;
  61 #include &quot;prims/jvmtiExport.hpp&quot;
  62 #include &quot;prims/jvmtiThreadState.hpp&quot;
  63 #include &quot;runtime/arguments.hpp&quot;
  64 #include &quot;runtime/atomic.hpp&quot;
  65 #include &quot;runtime/biasedLocking.hpp&quot;
  66 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  67 #include &quot;runtime/flags/jvmFlagConstraintList.hpp&quot;
  68 #include &quot;runtime/flags/jvmFlagRangeList.hpp&quot;
<a name="4" id="anc4"></a><span class="line-removed">  69 #include &quot;runtime/flags/jvmFlagWriteableList.hpp&quot;</span>
  70 #include &quot;runtime/deoptimization.hpp&quot;
  71 #include &quot;runtime/frame.inline.hpp&quot;
  72 #include &quot;runtime/handles.inline.hpp&quot;
  73 #include &quot;runtime/handshake.hpp&quot;
  74 #include &quot;runtime/init.hpp&quot;
  75 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  76 #include &quot;runtime/java.hpp&quot;
  77 #include &quot;runtime/javaCalls.hpp&quot;
  78 #include &quot;runtime/jniHandles.inline.hpp&quot;
  79 #include &quot;runtime/jniPeriodicChecker.hpp&quot;
  80 #include &quot;runtime/memprofiler.hpp&quot;
  81 #include &quot;runtime/mutexLocker.hpp&quot;
  82 #include &quot;runtime/objectMonitor.hpp&quot;
  83 #include &quot;runtime/orderAccess.hpp&quot;
  84 #include &quot;runtime/osThread.hpp&quot;
  85 #include &quot;runtime/prefetch.inline.hpp&quot;
  86 #include &quot;runtime/safepoint.hpp&quot;
  87 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  88 #include &quot;runtime/safepointVerifiers.hpp&quot;
<a name="5" id="anc5"></a>
  89 #include &quot;runtime/sharedRuntime.hpp&quot;
  90 #include &quot;runtime/statSampler.hpp&quot;
  91 #include &quot;runtime/stubRoutines.hpp&quot;
  92 #include &quot;runtime/sweeper.hpp&quot;
  93 #include &quot;runtime/task.hpp&quot;
  94 #include &quot;runtime/thread.inline.hpp&quot;
  95 #include &quot;runtime/threadCritical.hpp&quot;
  96 #include &quot;runtime/threadSMR.inline.hpp&quot;
  97 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
  98 #include &quot;runtime/timer.hpp&quot;
  99 #include &quot;runtime/timerTrace.hpp&quot;
 100 #include &quot;runtime/vframe.inline.hpp&quot;
 101 #include &quot;runtime/vframeArray.hpp&quot;
 102 #include &quot;runtime/vframe_hp.hpp&quot;
 103 #include &quot;runtime/vmThread.hpp&quot;
 104 #include &quot;runtime/vmOperations.hpp&quot;
 105 #include &quot;runtime/vm_version.hpp&quot;
 106 #include &quot;services/attachListener.hpp&quot;
 107 #include &quot;services/management.hpp&quot;
 108 #include &quot;services/memTracker.hpp&quot;
 109 #include &quot;services/threadService.hpp&quot;
 110 #include &quot;utilities/align.hpp&quot;
 111 #include &quot;utilities/copy.hpp&quot;
 112 #include &quot;utilities/defaultStream.hpp&quot;
 113 #include &quot;utilities/dtrace.hpp&quot;
 114 #include &quot;utilities/events.hpp&quot;
 115 #include &quot;utilities/macros.hpp&quot;
 116 #include &quot;utilities/preserveException.hpp&quot;
 117 #include &quot;utilities/singleWriterSynchronizer.hpp&quot;
 118 #include &quot;utilities/vmError.hpp&quot;
 119 #if INCLUDE_JVMCI
<a name="6" id="anc6"></a><span class="line-modified"> 120 #include &quot;jvmci/jvmciCompiler.hpp&quot;</span>
<span class="line-modified"> 121 #include &quot;jvmci/jvmciRuntime.hpp&quot;</span>
<span class="line-removed"> 122 #include &quot;logging/logHandle.hpp&quot;</span>
 123 #endif
 124 #ifdef COMPILER1
 125 #include &quot;c1/c1_Compiler.hpp&quot;
 126 #endif
 127 #ifdef COMPILER2
 128 #include &quot;opto/c2compiler.hpp&quot;
 129 #include &quot;opto/idealGraphPrinter.hpp&quot;
 130 #endif
 131 #if INCLUDE_RTM_OPT
 132 #include &quot;runtime/rtmLocking.hpp&quot;
 133 #endif
 134 #if INCLUDE_JFR
 135 #include &quot;jfr/jfr.hpp&quot;
 136 #endif
 137 
 138 // Initialization after module runtime initialization
 139 void universe_post_module_init();  // must happen after call_initPhase2
 140 
 141 #ifdef DTRACE_ENABLED
 142 
 143 // Only bother with this argument setup if dtrace is available
 144 
 145   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 146   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 147 
 148   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 149     {                                                                      \
 150       ResourceMark rm(this);                                               \
 151       int len = 0;                                                         \
 152       const char* name = (javathread)-&gt;get_thread_name();                  \
 153       len = strlen(name);                                                  \
 154       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 155         (char *) name, len,                                                \
 156         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 157         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 158         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 159     }
 160 
 161 #else //  ndef DTRACE_ENABLED
 162 
 163   #define DTRACE_THREAD_PROBE(probe, javathread)
 164 
 165 #endif // ndef DTRACE_ENABLED
 166 
 167 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 168 // Current thread is maintained as a thread-local variable
<a name="7" id="anc7"></a><span class="line-modified"> 169 THREAD_LOCAL_DECL Thread* Thread::_thr_current = NULL;</span>
 170 #endif
 171 
 172 // ======= Thread ========
 173 // Support for forcing alignment of thread objects for biased locking
 174 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 175   if (UseBiasedLocking) {
<a name="8" id="anc8"></a><span class="line-modified"> 176     const int alignment = markOopDesc::biased_lock_alignment;</span>
 177     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 178     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 179                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 180                                                          AllocFailStrategy::RETURN_NULL);
 181     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 182     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 183            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 184            &quot;JavaThread alignment code overflowed allocated storage&quot;);
 185     if (aligned_addr != real_malloc_addr) {
 186       log_info(biasedlocking)(&quot;Aligned thread &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT,
 187                               p2i(real_malloc_addr),
 188                               p2i(aligned_addr));
 189     }
 190     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 191     return aligned_addr;
 192   } else {
 193     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 194                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 195   }
 196 }
 197 
 198 void Thread::operator delete(void* p) {
 199   if (UseBiasedLocking) {
 200     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 201   } else {
 202     FreeHeap(p);
 203   }
 204 }
 205 
 206 void JavaThread::smr_delete() {
 207   if (_on_thread_list) {
 208     ThreadsSMRSupport::smr_delete(this);
 209   } else {
 210     delete this;
 211   }
 212 }
 213 
 214 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 215 // JavaThread
 216 
 217 DEBUG_ONLY(Thread* Thread::_starting_thread = NULL;)
 218 
 219 Thread::Thread() {
 220 
 221   DEBUG_ONLY(_run_state = PRE_CALL_RUN;)
 222 
 223   // stack and get_thread
 224   set_stack_base(NULL);
 225   set_stack_size(0);
<a name="9" id="anc9"></a><span class="line-removed"> 226   set_self_raw_id(0);</span>
 227   set_lgrp_id(-1);
 228   DEBUG_ONLY(clear_suspendible_thread();)
 229 
 230   // allocated data structures
 231   set_osthread(NULL);
 232   set_resource_area(new (mtThread)ResourceArea());
 233   DEBUG_ONLY(_current_resource_mark = NULL;)
 234   set_handle_area(new (mtThread) HandleArea(NULL));
 235   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 236   set_active_handles(NULL);
 237   set_free_handle_block(NULL);
 238   set_last_handle_mark(NULL);
 239   DEBUG_ONLY(_missed_ic_stub_refill_verifier = NULL);
 240 
<a name="10" id="anc10"></a><span class="line-modified"> 241   // This initial value ==&gt; never claimed.</span>
<span class="line-modified"> 242   _oops_do_parity = 0;</span>
 243   _threads_hazard_ptr = NULL;
 244   _threads_list_ptr = NULL;
 245   _nested_threads_hazard_ptr_cnt = 0;
 246   _rcu_counter = 0;
 247 
 248   // the handle mark links itself to last_handle_mark
 249   new HandleMark(this);
 250 
 251   // plain initialization
 252   debug_only(_owned_locks = NULL;)
<a name="11" id="anc11"></a><span class="line-modified"> 253   debug_only(_allow_allocation_count = 0;)</span>
<span class="line-removed"> 254   NOT_PRODUCT(_allow_safepoint_count = 0;)</span>
 255   NOT_PRODUCT(_skip_gcalot = false;)
 256   _jvmti_env_iteration_count = 0;
 257   set_allocated_bytes(0);
 258   _vm_operation_started_count = 0;
 259   _vm_operation_completed_count = 0;
 260   _current_pending_monitor = NULL;
 261   _current_pending_monitor_is_from_java = true;
 262   _current_waiting_monitor = NULL;
<a name="12" id="anc12"></a>
 263   _num_nested_signal = 0;
<a name="13" id="anc13"></a><span class="line-modified"> 264   omFreeList = NULL;</span>
<span class="line-modified"> 265   omFreeCount = 0;</span>
<span class="line-modified"> 266   omFreeProvision = 32;</span>
<span class="line-modified"> 267   omInUseList = NULL;</span>
<span class="line-modified"> 268   omInUseCount = 0;</span>
 269 
 270 #ifdef ASSERT
 271   _visited_for_critical_count = false;
 272 #endif
 273 
 274   _SR_lock = new Monitor(Mutex::suspend_resume, &quot;SR_lock&quot;, true,
 275                          Monitor::_safepoint_check_sometimes);
 276   _suspend_flags = 0;
 277 
 278   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 279   _hashStateX = os::random();
 280   _hashStateY = 842502087;
 281   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 282   _hashStateW = 273326509;
 283 
 284   _OnTrap   = 0;
 285   _Stalled  = 0;
 286   _TypeTag  = 0x2BAD;
 287 
 288   // Many of the following fields are effectively final - immutable
 289   // Note that nascent threads can&#39;t use the Native Monitor-Mutex
 290   // construct until the _MutexEvent is initialized ...
 291   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 292   // we might instead use a stack of ParkEvents that we could provision on-demand.
 293   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 294   // and ::Release()
 295   _ParkEvent   = ParkEvent::Allocate(this);
<a name="14" id="anc14"></a><span class="line-removed"> 296   _SleepEvent  = ParkEvent::Allocate(this);</span>
 297   _MuxEvent    = ParkEvent::Allocate(this);
 298 
 299 #ifdef CHECK_UNHANDLED_OOPS
 300   if (CheckUnhandledOops) {
 301     _unhandled_oops = new UnhandledOops(this);
 302   }
 303 #endif // CHECK_UNHANDLED_OOPS
 304 #ifdef ASSERT
 305   if (UseBiasedLocking) {
<a name="15" id="anc15"></a><span class="line-modified"> 306     assert((((uintptr_t) this) &amp; (markOopDesc::biased_lock_alignment - 1)) == 0, &quot;forced alignment of thread object failed&quot;);</span>
 307     assert(this == _real_malloc_address ||
<a name="16" id="anc16"></a><span class="line-modified"> 308            this == align_up(_real_malloc_address, (int)markOopDesc::biased_lock_alignment),</span>
 309            &quot;bug in forced alignment of thread objects&quot;);
 310   }
 311 #endif // ASSERT
 312 
 313   // Notify the barrier set that a thread is being created. The initial
 314   // thread is created before the barrier set is available.  The call to
 315   // BarrierSet::on_thread_create() for this thread is therefore deferred
 316   // to BarrierSet::set_barrier_set().
 317   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 318   if (barrier_set != NULL) {
 319     barrier_set-&gt;on_thread_create(this);
 320   } else {
 321     // Only the main thread should be created before the barrier set
 322     // and that happens just before Thread::current is set. No other thread
 323     // can attach as the VM is not created yet, so they can&#39;t execute this code.
 324     // If the main thread creates other threads before the barrier set that is an error.
 325     assert(Thread::current_or_null() == NULL, &quot;creating thread before barrier set&quot;);
 326   }
 327 }
 328 
 329 void Thread::initialize_thread_current() {
 330 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 331   assert(_thr_current == NULL, &quot;Thread::current already initialized&quot;);
 332   _thr_current = this;
 333 #endif
 334   assert(ThreadLocalStorage::thread() == NULL, &quot;ThreadLocalStorage::thread already initialized&quot;);
 335   ThreadLocalStorage::set_thread(this);
 336   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 337 }
 338 
 339 void Thread::clear_thread_current() {
 340   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 341 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 342   _thr_current = NULL;
 343 #endif
 344   ThreadLocalStorage::set_thread(NULL);
 345 }
 346 
 347 void Thread::record_stack_base_and_size() {
 348   // Note: at this point, Thread object is not yet initialized. Do not rely on
 349   // any members being initialized. Do not rely on Thread::current() being set.
 350   // If possible, refrain from doing anything which may crash or assert since
 351   // quite probably those crash dumps will be useless.
 352   set_stack_base(os::current_stack_base());
 353   set_stack_size(os::current_stack_size());
 354 
 355 #ifdef SOLARIS
 356   if (os::is_primordial_thread()) {
 357     os::Solaris::correct_stack_boundaries_for_primordial_thread(this);
 358   }
 359 #endif
 360 
 361   // Set stack limits after thread is initialized.
 362   if (is_Java_thread()) {
 363     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 364     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 365   }
 366 }
 367 
 368 #if INCLUDE_NMT
 369 void Thread::register_thread_stack_with_NMT() {
 370   MemTracker::record_thread_stack(stack_end(), stack_size());
 371 }
 372 #endif // INCLUDE_NMT
 373 
 374 void Thread::call_run() {
 375   DEBUG_ONLY(_run_state = CALL_RUN;)
 376 
 377   // At this point, Thread object should be fully initialized and
 378   // Thread::current() should be set.
 379 
 380   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 381   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 382 
 383   // Perform common initialization actions
 384 
 385   register_thread_stack_with_NMT();
 386 
 387   JFR_ONLY(Jfr::on_thread_start(this);)
 388 
 389   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack dimensions: &quot;
 390     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;k).&quot;,
<a name="17" id="anc17"></a><span class="line-modified"> 391     os::current_thread_id(), p2i(stack_base() - stack_size()),</span>
 392     p2i(stack_base()), stack_size()/1024);
 393 
 394   // Perform &lt;ChildClass&gt; initialization actions
 395   DEBUG_ONLY(_run_state = PRE_RUN;)
 396   this-&gt;pre_run();
 397 
 398   // Invoke &lt;ChildClass&gt;::run()
 399   DEBUG_ONLY(_run_state = RUN;)
 400   this-&gt;run();
 401   // Returned from &lt;ChildClass&gt;::run(). Thread finished.
 402 
 403   // Perform common tear-down actions
 404 
 405   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 406   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 407 
 408   // Perform &lt;ChildClass&gt; tear-down actions
 409   DEBUG_ONLY(_run_state = POST_RUN;)
 410   this-&gt;post_run();
 411 
 412   // Note: at this point the thread object may already have deleted itself,
 413   // so from here on do not dereference *this*. Not all thread types currently
 414   // delete themselves when they terminate. But no thread should ever be deleted
 415   // asynchronously with respect to its termination - that is what _run_state can
 416   // be used to check.
 417 
 418   assert(Thread::current_or_null() == NULL, &quot;current thread still present&quot;);
 419 }
 420 
 421 Thread::~Thread() {
 422 
 423   // Attached threads will remain in PRE_CALL_RUN, as will threads that don&#39;t actually
 424   // get started due to errors etc. Any active thread should at least reach post_run
 425   // before it is deleted (usually in post_run()).
 426   assert(_run_state == PRE_CALL_RUN ||
 427          _run_state == POST_RUN, &quot;Active Thread deleted before post_run(): &quot;
 428          &quot;_run_state=%d&quot;, (int)_run_state);
 429 
 430   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 431   // set might not be available if we encountered errors during bootstrapping.
 432   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 433   if (barrier_set != NULL) {
 434     barrier_set-&gt;on_thread_destroy(this);
 435   }
 436 
 437   // stack_base can be NULL if the thread is never started or exited before
 438   // record_stack_base_and_size called. Although, we would like to ensure
 439   // that all started threads do call record_stack_base_and_size(), there is
 440   // not proper way to enforce that.
 441 #if INCLUDE_NMT
 442   if (_stack_base != NULL) {
 443     MemTracker::release_thread_stack(stack_end(), stack_size());
 444 #ifdef ASSERT
 445     set_stack_base(NULL);
 446 #endif
 447   }
 448 #endif // INCLUDE_NMT
 449 
 450   // deallocate data structures
 451   delete resource_area();
 452   // since the handle marks are using the handle area, we have to deallocated the root
 453   // handle mark before deallocating the thread&#39;s handle area,
 454   assert(last_handle_mark() != NULL, &quot;check we have an element&quot;);
 455   delete last_handle_mark();
 456   assert(last_handle_mark() == NULL, &quot;check we have reached the end&quot;);
 457 
 458   // It&#39;s possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 459   // We NULL out the fields for good hygiene.
 460   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
<a name="18" id="anc18"></a><span class="line-removed"> 461   ParkEvent::Release(_SleepEvent); _SleepEvent  = NULL;</span>
 462   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 463 
 464   delete handle_area();
 465   delete metadata_handles();
 466 
 467   // SR_handler uses this as a termination indicator -
 468   // needs to happen before os::free_thread()
 469   delete _SR_lock;
 470   _SR_lock = NULL;
 471 
 472   // osthread() can be NULL, if creation of thread failed.
 473   if (osthread() != NULL) os::free_thread(osthread());
 474 
 475   // Clear Thread::current if thread is deleting itself and it has not
 476   // already been done. This must be done before the memory is deallocated.
 477   // Needed to ensure JNI correctly detects non-attached threads.
 478   if (this == Thread::current_or_null()) {
 479     Thread::clear_thread_current();
 480   }
 481 
 482   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 483 }
 484 
 485 #ifdef ASSERT
 486 // A JavaThread is considered &quot;dangling&quot; if it is not the current
 487 // thread, has been added the Threads list, the system is not at a
 488 // safepoint and the Thread is not &quot;protected&quot;.
 489 //
 490 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 491   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 492          !((JavaThread *) thread)-&gt;on_thread_list() ||
 493          SafepointSynchronize::is_at_safepoint() ||
 494          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 495          &quot;possibility of dangling Thread pointer&quot;);
 496 }
 497 #endif
 498 
 499 ThreadPriority Thread::get_priority(const Thread* const thread) {
 500   ThreadPriority priority;
 501   // Can return an error!
 502   (void)os::get_priority(thread, priority);
 503   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, &quot;non-Java priority found&quot;);
 504   return priority;
 505 }
 506 
 507 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 508   debug_only(check_for_dangling_thread_pointer(thread);)
 509   // Can return an error!
 510   (void)os::set_priority(thread, priority);
 511 }
 512 
 513 
 514 void Thread::start(Thread* thread) {
 515   // Start is different from resume in that its safety is guaranteed by context or
 516   // being called from a Java method synchronized on the Thread object.
 517   if (!DisableStartThread) {
 518     if (thread-&gt;is_Java_thread()) {
 519       // Initialize the thread state to RUNNABLE before starting this thread.
 520       // Can not set it after the thread started because we do not know the
 521       // exact thread state at that time. It could be in MONITOR_WAIT or
 522       // in SLEEPING or some other state.
 523       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 524                                           java_lang_Thread::RUNNABLE);
 525     }
 526     os::start_thread(thread);
 527   }
 528 }
 529 
<a name="19" id="anc19"></a><span class="line-modified"> 530 // Enqueue a VM_Operation to do the job for us - sometime later</span>













 531 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
<a name="20" id="anc20"></a><span class="line-modified"> 532   VM_ThreadStop* vm_stop = new VM_ThreadStop(java_thread, java_throwable);</span>
<span class="line-modified"> 533   VMThread::execute(vm_stop);</span>


 534 }
 535 
 536 
 537 // Check if an external suspend request has completed (or has been
 538 // cancelled). Returns true if the thread is externally suspended and
 539 // false otherwise.
 540 //
 541 // The bits parameter returns information about the code path through
 542 // the routine. Useful for debugging:
 543 //
 544 // set in is_ext_suspend_completed():
 545 // 0x00000001 - routine was entered
 546 // 0x00000010 - routine return false at end
 547 // 0x00000100 - thread exited (return false)
 548 // 0x00000200 - suspend request cancelled (return false)
 549 // 0x00000400 - thread suspended (return true)
 550 // 0x00001000 - thread is in a suspend equivalent state (return true)
 551 // 0x00002000 - thread is native and walkable (return true)
 552 // 0x00004000 - thread is native_trans and walkable (needed retry)
 553 //
 554 // set in wait_for_ext_suspend_completion():
 555 // 0x00010000 - routine was entered
 556 // 0x00020000 - suspend request cancelled before loop (return false)
 557 // 0x00040000 - thread suspended before loop (return true)
 558 // 0x00080000 - suspend request cancelled in loop (return false)
 559 // 0x00100000 - thread suspended in loop (return true)
 560 // 0x00200000 - suspend not completed during retry loop (return false)
 561 
 562 // Helper class for tracing suspend wait debug bits.
 563 //
 564 // 0x00000100 indicates that the target thread exited before it could
 565 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 566 // 0x00080000 each indicate a cancelled suspend request so they don&#39;t
 567 // count as wait failures either.
 568 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 569 
 570 class TraceSuspendDebugBits : public StackObj {
 571  private:
 572   JavaThread * jt;
 573   bool         is_wait;
 574   bool         called_by_wait;  // meaningful when !is_wait
 575   uint32_t *   bits;
 576 
 577  public:
 578   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 579                         uint32_t *_bits) {
 580     jt             = _jt;
 581     is_wait        = _is_wait;
 582     called_by_wait = _called_by_wait;
 583     bits           = _bits;
 584   }
 585 
 586   ~TraceSuspendDebugBits() {
 587     if (!is_wait) {
 588 #if 1
 589       // By default, don&#39;t trace bits for is_ext_suspend_completed() calls.
 590       // That trace is very chatty.
 591       return;
 592 #else
 593       if (!called_by_wait) {
 594         // If tracing for is_ext_suspend_completed() is enabled, then only
 595         // trace calls to it from wait_for_ext_suspend_completion()
 596         return;
 597       }
 598 #endif
 599     }
 600 
 601     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 602       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 603         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 604         ResourceMark rm;
 605 
 606         tty-&gt;print_cr(
 607                       &quot;Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)&quot;,
 608                       jt-&gt;get_thread_name(), *bits);
 609 
 610         guarantee(!AssertOnSuspendWaitFailure, &quot;external suspend wait failed&quot;);
 611       }
 612     }
 613   }
 614 };
 615 #undef DEBUG_FALSE_BITS
 616 
 617 
 618 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 619                                           uint32_t *bits) {
 620   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 621 
 622   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 623   bool do_trans_retry;           // flag to force the retry
 624 
 625   *bits |= 0x00000001;
 626 
 627   do {
 628     do_trans_retry = false;
 629 
 630     if (is_exiting()) {
 631       // Thread is in the process of exiting. This is always checked
 632       // first to reduce the risk of dereferencing a freed JavaThread.
 633       *bits |= 0x00000100;
 634       return false;
 635     }
 636 
 637     if (!is_external_suspend()) {
 638       // Suspend request is cancelled. This is always checked before
 639       // is_ext_suspended() to reduce the risk of a rogue resume
 640       // confusing the thread that made the suspend request.
 641       *bits |= 0x00000200;
 642       return false;
 643     }
 644 
 645     if (is_ext_suspended()) {
 646       // thread is suspended
 647       *bits |= 0x00000400;
 648       return true;
 649     }
 650 
 651     // Now that we no longer do hard suspends of threads running
 652     // native code, the target thread can be changing thread state
 653     // while we are in this routine:
 654     //
 655     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 656     //
 657     // We save a copy of the thread state as observed at this moment
 658     // and make our decision about suspend completeness based on the
 659     // copy. This closes the race where the thread state is seen as
 660     // _thread_in_native_trans in the if-thread_blocked check, but is
 661     // seen as _thread_blocked in if-thread_in_native_trans check.
 662     JavaThreadState save_state = thread_state();
 663 
 664     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 665       // If the thread&#39;s state is _thread_blocked and this blocking
 666       // condition is known to be equivalent to a suspend, then we can
 667       // consider the thread to be externally suspended. This means that
 668       // the code that sets _thread_blocked has been modified to do
 669       // self-suspension if the blocking condition releases. We also
 670       // used to check for CONDVAR_WAIT here, but that is now covered by
 671       // the _thread_blocked with self-suspension check.
 672       //
 673       // Return true since we wouldn&#39;t be here unless there was still an
 674       // external suspend request.
 675       *bits |= 0x00001000;
 676       return true;
 677     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 678       // Threads running native code will self-suspend on native==&gt;VM/Java
 679       // transitions. If its stack is walkable (should always be the case
 680       // unless this function is called before the actual java_suspend()
 681       // call), then the wait is done.
 682       *bits |= 0x00002000;
 683       return true;
 684     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 685                save_state == _thread_in_native_trans &amp;&amp;
 686                frame_anchor()-&gt;walkable()) {
 687       // The thread is transitioning from thread_in_native to another
 688       // thread state. check_safepoint_and_suspend_for_native_trans()
 689       // will force the thread to self-suspend. If it hasn&#39;t gotten
 690       // there yet we may have caught the thread in-between the native
 691       // code check above and the self-suspend. Lucky us. If we were
 692       // called by wait_for_ext_suspend_completion(), then it
 693       // will be doing the retries so we don&#39;t have to.
 694       //
 695       // Since we use the saved thread state in the if-statement above,
 696       // there is a chance that the thread has already transitioned to
 697       // _thread_blocked by the time we get here. In that case, we will
 698       // make a single unnecessary pass through the logic below. This
 699       // doesn&#39;t hurt anything since we still do the trans retry.
 700 
 701       *bits |= 0x00004000;
 702 
 703       // Once the thread leaves thread_in_native_trans for another
 704       // thread state, we break out of this retry loop. We shouldn&#39;t
 705       // need this flag to prevent us from getting back here, but
 706       // sometimes paranoia is good.
 707       did_trans_retry = true;
 708 
 709       // We wait for the thread to transition to a more usable state.
 710       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 711         // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 712         // that yielding would increase on each retry. However, the parameter
 713         // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 714         // on the SR_lock below provides a much more predictable scale up for
 715         // the delay. It also provides a simple/direct point to check for any
 716         // safepoint requests from the VMThread
 717 
 718         // temporarily drops SR_lock while doing wait with safepoint check
 719         // (if we&#39;re a JavaThread - the WatcherThread can also call this)
 720         // and increase delay with each retry
<a name="21" id="anc21"></a><span class="line-modified"> 721         SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);</span>




 722 
 723         // check the actual thread state instead of what we saved above
 724         if (thread_state() != _thread_in_native_trans) {
 725           // the thread has transitioned to another thread state so
 726           // try all the checks (except this one) one more time.
 727           do_trans_retry = true;
 728           break;
 729         }
 730       } // end retry loop
 731 
 732 
 733     }
 734   } while (do_trans_retry);
 735 
 736   *bits |= 0x00000010;
 737   return false;
 738 }
 739 
 740 // Wait for an external suspend request to complete (or be cancelled).
 741 // Returns true if the thread is externally suspended and false otherwise.
 742 //
 743 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 744                                                  uint32_t *bits) {
 745   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 746                              false /* !called_by_wait */, bits);
 747 
 748   // local flag copies to minimize SR_lock hold time
 749   bool is_suspended;
 750   bool pending;
 751   uint32_t reset_bits;
 752 
 753   // set a marker so is_ext_suspend_completed() knows we are the caller
 754   *bits |= 0x00010000;
 755 
 756   // We use reset_bits to reinitialize the bits value at the top of
 757   // each retry loop. This allows the caller to make use of any
 758   // unused bits for their own marking purposes.
 759   reset_bits = *bits;
 760 
 761   {
<a name="22" id="anc22"></a><span class="line-modified"> 762     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
 763     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 764                                             delay, bits);
 765     pending = is_external_suspend();
 766   }
 767   // must release SR_lock to allow suspension to complete
 768 
 769   if (!pending) {
 770     // A cancelled suspend request is the only false return from
 771     // is_ext_suspend_completed() that keeps us from entering the
 772     // retry loop.
 773     *bits |= 0x00020000;
 774     return false;
 775   }
 776 
 777   if (is_suspended) {
 778     *bits |= 0x00040000;
 779     return true;
 780   }
 781 
 782   for (int i = 1; i &lt;= retries; i++) {
 783     *bits = reset_bits;  // reinit to only track last retry
 784 
 785     // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 786     // that yielding would increase on each retry. However, the parameter
 787     // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 788     // on the SR_lock below provides a much more predictable scale up for
 789     // the delay. It also provides a simple/direct point to check for any
 790     // safepoint requests from the VMThread
 791 
 792     {
<a name="23" id="anc23"></a><span class="line-modified"> 793       MutexLocker ml(SR_lock());</span>


 794       // wait with safepoint check (if we&#39;re a JavaThread - the WatcherThread
 795       // can also call this)  and increase delay with each retry
<a name="24" id="anc24"></a><span class="line-modified"> 796       SR_lock()-&gt;wait(!Thread::current()-&gt;is_Java_thread(), i * delay);</span>
 797 
 798       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 799                                               delay, bits);
 800 
 801       // It is possible for the external suspend request to be cancelled
 802       // (by a resume) before the actual suspend operation is completed.
 803       // Refresh our local copy to see if we still need to wait.
 804       pending = is_external_suspend();
 805     }
 806 
 807     if (!pending) {
 808       // A cancelled suspend request is the only false return from
 809       // is_ext_suspend_completed() that keeps us from staying in the
 810       // retry loop.
 811       *bits |= 0x00080000;
 812       return false;
 813     }
 814 
 815     if (is_suspended) {
 816       *bits |= 0x00100000;
 817       return true;
 818     }
 819   } // end retry loop
 820 
 821   // thread did not suspend after all our retries
 822   *bits |= 0x00200000;
 823   return false;
 824 }
 825 
 826 // Called from API entry points which perform stack walking. If the
 827 // associated JavaThread is the current thread, then wait_for_suspend
 828 // is not used. Otherwise, it determines if we should wait for the
 829 // &quot;other&quot; thread to complete external suspension. (NOTE: in future
 830 // releases the suspension mechanism should be reimplemented so this
 831 // is not necessary.)
 832 //
 833 bool
 834 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 835   if (this != JavaThread::current()) {
 836     // &quot;other&quot; threads require special handling.
 837     if (wait_for_suspend) {
 838       // We are allowed to wait for the external suspend to complete
 839       // so give the other thread a chance to get suspended.
 840       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 841                                            SuspendRetryDelay, bits)) {
 842         // Didn&#39;t make it so let the caller know.
 843         return false;
 844       }
 845     }
 846     // We aren&#39;t allowed to wait for the external suspend to complete
 847     // so if the other thread isn&#39;t externally suspended we need to
 848     // let the caller know.
 849     else if (!is_ext_suspend_completed_with_lock(bits)) {
 850       return false;
 851     }
 852   }
 853 
 854   return true;
 855 }
 856 
<a name="25" id="anc25"></a><span class="line-removed"> 857 #ifndef PRODUCT</span>
<span class="line-removed"> 858 void JavaThread::record_jump(address target, address instr, const char* file,</span>
<span class="line-removed"> 859                              int line) {</span>
<span class="line-removed"> 860 </span>
<span class="line-removed"> 861   // This should not need to be atomic as the only way for simultaneous</span>
<span class="line-removed"> 862   // updates is via interrupts. Even then this should be rare or non-existent</span>
<span class="line-removed"> 863   // and we don&#39;t care that much anyway.</span>
<span class="line-removed"> 864 </span>
<span class="line-removed"> 865   int index = _jmp_ring_index;</span>
<span class="line-removed"> 866   _jmp_ring_index = (index + 1) &amp; (jump_ring_buffer_size - 1);</span>
<span class="line-removed"> 867   _jmp_ring[index]._target = (intptr_t) target;</span>
<span class="line-removed"> 868   _jmp_ring[index]._instruction = (intptr_t) instr;</span>
<span class="line-removed"> 869   _jmp_ring[index]._file = file;</span>
<span class="line-removed"> 870   _jmp_ring[index]._line = line;</span>
<span class="line-removed"> 871 }</span>
<span class="line-removed"> 872 #endif // PRODUCT</span>
<span class="line-removed"> 873 </span>
<span class="line-removed"> 874 void Thread::interrupt(Thread* thread) {</span>
<span class="line-removed"> 875   debug_only(check_for_dangling_thread_pointer(thread);)</span>
<span class="line-removed"> 876   os::interrupt(thread);</span>
<span class="line-removed"> 877 }</span>
<span class="line-removed"> 878 </span>
<span class="line-removed"> 879 bool Thread::is_interrupted(Thread* thread, bool clear_interrupted) {</span>
<span class="line-removed"> 880   debug_only(check_for_dangling_thread_pointer(thread);)</span>
<span class="line-removed"> 881   // Note:  If clear_interrupted==false, this simply fetches and</span>
<span class="line-removed"> 882   // returns the value of the field osthread()-&gt;interrupted().</span>
<span class="line-removed"> 883   return os::is_interrupted(thread, clear_interrupted);</span>
<span class="line-removed"> 884 }</span>
<span class="line-removed"> 885 </span>
<span class="line-removed"> 886 </span>
 887 // GC Support
<a name="26" id="anc26"></a><span class="line-modified"> 888 bool Thread::claim_oops_do_par_case(int strong_roots_parity) {</span>
<span class="line-modified"> 889   int thread_parity = _oops_do_parity;</span>
<span class="line-modified"> 890   if (thread_parity != strong_roots_parity) {</span>
<span class="line-modified"> 891     jint res = Atomic::cmpxchg(strong_roots_parity, &amp;_oops_do_parity, thread_parity);</span>
<span class="line-modified"> 892     if (res == thread_parity) {</span>
 893       return true;
<a name="27" id="anc27"></a><span class="line-removed"> 894     } else {</span>
<span class="line-removed"> 895       guarantee(res == strong_roots_parity, &quot;Or else what?&quot;);</span>
<span class="line-removed"> 896       return false;</span>
 897     }
<a name="28" id="anc28"></a>
 898   }
 899   return false;
 900 }
 901 
 902 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 903   active_handles()-&gt;oops_do(f);
 904   // Do oop for ThreadShadow
 905   f-&gt;do_oop((oop*)&amp;_pending_exception);
 906   handle_area()-&gt;oops_do(f);
 907 
 908   // We scan thread local monitor lists here, and the remaining global
 909   // monitors in ObjectSynchronizer::oops_do().
 910   ObjectSynchronizer::thread_local_used_oops_do(this, f);
 911 }
 912 
 913 void Thread::metadata_handles_do(void f(Metadata*)) {
 914   // Only walk the Handles in Thread.
 915   if (metadata_handles() != NULL) {
 916     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 917       f(metadata_handles()-&gt;at(i));
 918     }
 919   }
 920 }
 921 
 922 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 923   // get_priority assumes osthread initialized
 924   if (osthread() != NULL) {
 925     int os_prio;
 926     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 927       st-&gt;print(&quot;os_prio=%d &quot;, os_prio);
 928     }
 929 
 930     st-&gt;print(&quot;cpu=%.2fms &quot;,
 931               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 932               );
 933     st-&gt;print(&quot;elapsed=%.2fs &quot;,
 934               _statistical_info.getElapsedTime() / 1000.0
 935               );
 936     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 937       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 938       st-&gt;print(&quot;allocated=&quot; SIZE_FORMAT &quot;%s &quot;,
 939                 byte_size_in_proper_unit(allocated_bytes),
 940                 proper_unit_for_byte_size(allocated_bytes)
 941                 );
 942       st-&gt;print(&quot;defined_classes=&quot; INT64_FORMAT &quot; &quot;, _statistical_info.getDefineClassCount());
 943     }
 944 
 945     st-&gt;print(&quot;tid=&quot; INTPTR_FORMAT &quot; &quot;, p2i(this));
 946     osthread()-&gt;print_on(st);
 947   }
 948   ThreadsSMRSupport::print_info_on(this, st);
 949   st-&gt;print(&quot; &quot;);
 950   debug_only(if (WizardMode) print_owned_locks_on(st);)
 951 }
 952 
<a name="29" id="anc29"></a>

 953 // Thread::print_on_error() is called by fatal error handler. Don&#39;t use
 954 // any lock or allocate memory.
 955 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 956   assert(!(is_Compiler_thread() || is_Java_thread()), &quot;Can&#39;t call name() here if it allocates&quot;);
 957 
 958   if (is_VM_thread())                 { st-&gt;print(&quot;VMThread&quot;); }
 959   else if (is_GC_task_thread())       { st-&gt;print(&quot;GCTaskThread&quot;); }
 960   else if (is_Watcher_thread())       { st-&gt;print(&quot;WatcherThread&quot;); }
 961   else if (is_ConcurrentGC_thread())  { st-&gt;print(&quot;ConcurrentGCThread&quot;); }
 962   else                                { st-&gt;print(&quot;Thread&quot;); }
 963 
 964   if (is_Named_thread()) {
 965     st-&gt;print(&quot; \&quot;%s\&quot;&quot;, name());
 966   }
 967 
 968   st-&gt;print(&quot; [stack: &quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;,
 969             p2i(stack_end()), p2i(stack_base()));
 970 
 971   if (osthread()) {
 972     st-&gt;print(&quot; [id=%d]&quot;, osthread()-&gt;thread_id());
 973   }
 974 
 975   ThreadsSMRSupport::print_info_on(this, st);
 976 }
 977 
 978 void Thread::print_value_on(outputStream* st) const {
 979   if (is_Named_thread()) {
 980     st-&gt;print(&quot; \&quot;%s\&quot; &quot;, name());
 981   }
 982   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 983 }
 984 
 985 #ifdef ASSERT
 986 void Thread::print_owned_locks_on(outputStream* st) const {
<a name="30" id="anc30"></a><span class="line-modified"> 987   Monitor *cur = _owned_locks;</span>
 988   if (cur == NULL) {
 989     st-&gt;print(&quot; (no locks) &quot;);
 990   } else {
 991     st-&gt;print_cr(&quot; Locks owned:&quot;);
 992     while (cur) {
 993       cur-&gt;print_on(st);
 994       cur = cur-&gt;next();
 995     }
 996   }
 997 }
 998 
<a name="31" id="anc31"></a><span class="line-modified"> 999 static int ref_use_count  = 0;</span>


1000 
<a name="32" id="anc32"></a><span class="line-modified">1001 bool Thread::owns_locks_but_compiled_lock() const {</span>
<span class="line-modified">1002   for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {</span>
<span class="line-modified">1003     if (cur != Compile_lock) return true;</span>
1004   }
<a name="33" id="anc33"></a><span class="line-modified">1005   return false;</span>



1006 }
1007 
<a name="34" id="anc34"></a>

1008 
<a name="35" id="anc35"></a><span class="line-modified">1009 #endif</span>
<span class="line-modified">1010 </span>
<span class="line-modified">1011 #ifndef PRODUCT</span>

1012 
<a name="36" id="anc36"></a><span class="line-modified">1013 // The flag: potential_vm_operation notifies if this particular safepoint state could potentially</span>
<span class="line-removed">1014 // invoke the vm-thread (e.g., an oop allocation). In that case, we also have to make sure that</span>
<span class="line-removed">1015 // no locks which allow_vm_block&#39;s are held</span>
<span class="line-removed">1016 void Thread::check_for_valid_safepoint_state(bool potential_vm_operation) {</span>
<span class="line-removed">1017   // Check if current thread is allowed to block at a safepoint</span>
<span class="line-removed">1018   if (!(_allow_safepoint_count == 0)) {</span>
<span class="line-removed">1019     fatal(&quot;Possible safepoint reached by thread that does not allow it&quot;);</span>
<span class="line-removed">1020   }</span>
<span class="line-removed">1021   if (is_Java_thread() &amp;&amp; ((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {</span>
1022     fatal(&quot;LEAF method calling lock?&quot;);
1023   }
1024 
<a name="37" id="anc37"></a><span class="line-removed">1025 #ifdef ASSERT</span>
<span class="line-removed">1026   if (potential_vm_operation &amp;&amp; is_Java_thread()</span>
<span class="line-removed">1027       &amp;&amp; !Universe::is_bootstrapping()) {</span>
<span class="line-removed">1028     // Make sure we do not hold any locks that the VM thread also uses.</span>
<span class="line-removed">1029     // This could potentially lead to deadlocks</span>
<span class="line-removed">1030     for (Monitor *cur = _owned_locks; cur; cur = cur-&gt;next()) {</span>
<span class="line-removed">1031       // Threads_lock is special, since the safepoint synchronization will not start before this is</span>
<span class="line-removed">1032       // acquired. Hence, a JavaThread cannot be holding it at a safepoint. So is VMOperationRequest_lock,</span>
<span class="line-removed">1033       // since it is used to transfer control between JavaThreads and the VMThread</span>
<span class="line-removed">1034       // Do not *exclude* any locks unless you are absolutely sure it is correct. Ask someone else first!</span>
<span class="line-removed">1035       if ((cur-&gt;allow_vm_block() &amp;&amp;</span>
<span class="line-removed">1036            cur != Threads_lock &amp;&amp;</span>
<span class="line-removed">1037            cur != Compile_lock &amp;&amp;               // Temporary: should not be necessary when we get separate compilation</span>
<span class="line-removed">1038            cur != VMOperationRequest_lock &amp;&amp;</span>
<span class="line-removed">1039            cur != VMOperationQueue_lock) ||</span>
<span class="line-removed">1040            cur-&gt;rank() == Mutex::special) {</span>
<span class="line-removed">1041         fatal(&quot;Thread holding lock at safepoint that vm can block on: %s&quot;, cur-&gt;name());</span>
<span class="line-removed">1042       }</span>
<span class="line-removed">1043     }</span>
<span class="line-removed">1044   }</span>
<span class="line-removed">1045 </span>
1046   if (GCALotAtAllSafepoints) {
1047     // We could enter a safepoint here and thus have a gc
1048     InterfaceSupport::check_gc_alot();
1049   }
<a name="38" id="anc38"></a><span class="line-removed">1050 #endif</span>
1051 }
<a name="39" id="anc39"></a><span class="line-modified">1052 #endif</span>
1053 
<a name="40" id="anc40"></a>
1054 bool Thread::is_in_stack(address adr) const {
1055   assert(Thread::current() == this, &quot;is_in_stack can only be called from current thread&quot;);
1056   address end = os::current_stack_pointer();
<a name="41" id="anc41"></a><span class="line-modified">1057   // Allow non Java threads to call this without stack_base</span>
<span class="line-removed">1058   if (_stack_base == NULL) return true;</span>
<span class="line-removed">1059   if (stack_base() &gt;= adr &amp;&amp; adr &gt;= end) return true;</span>
<span class="line-removed">1060 </span>
<span class="line-removed">1061   return false;</span>
<span class="line-removed">1062 }</span>
<span class="line-removed">1063 </span>
<span class="line-removed">1064 bool Thread::is_in_usable_stack(address adr) const {</span>
<span class="line-removed">1065   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;</span>
<span class="line-removed">1066   size_t usable_stack_size = _stack_size - stack_guard_size;</span>
<span class="line-removed">1067 </span>
<span class="line-removed">1068   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));</span>
1069 }
1070 
<a name="42" id="anc42"></a><span class="line-removed">1071 </span>
1072 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1073 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1074 // used for compilation in the future. If that change is made, the need for these methods
1075 // should be revisited, and they should be removed if possible.
1076 
1077 bool Thread::is_lock_owned(address adr) const {
1078   return on_local_stack(adr);
1079 }
1080 
1081 bool Thread::set_as_starting_thread() {
1082   assert(_starting_thread == NULL, &quot;already initialized: &quot;
1083          &quot;_starting_thread=&quot; INTPTR_FORMAT, p2i(_starting_thread));
1084   // NOTE: this must be called inside the main thread.
1085   DEBUG_ONLY(_starting_thread = this;)
1086   return os::create_main_thread((JavaThread*)this);
1087 }
1088 
1089 static void initialize_class(Symbol* class_name, TRAPS) {
1090   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1091   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1092 }
1093 
1094 
1095 // Creates the initial ThreadGroup
1096 static Handle create_initial_thread_group(TRAPS) {
1097   Handle system_instance = JavaCalls::construct_new_instance(
1098                             SystemDictionary::ThreadGroup_klass(),
1099                             vmSymbols::void_method_signature(),
1100                             CHECK_NH);
1101   Universe::set_system_thread_group(system_instance());
1102 
1103   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NH);
1104   Handle main_instance = JavaCalls::construct_new_instance(
1105                             SystemDictionary::ThreadGroup_klass(),
1106                             vmSymbols::threadgroup_string_void_signature(),
1107                             system_instance,
1108                             string,
1109                             CHECK_NH);
1110   return main_instance;
1111 }
1112 
1113 // Creates the initial Thread
1114 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1115                                  TRAPS) {
1116   InstanceKlass* ik = SystemDictionary::Thread_klass();
1117   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1118   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1119 
1120   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1121   // constructor calls Thread.current(), which must be set here for the
1122   // initial thread.
1123   java_lang_Thread::set_thread(thread_oop(), thread);
1124   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1125   thread-&gt;set_threadObj(thread_oop());
1126 
1127   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NULL);
1128 
1129   JavaValue result(T_VOID);
1130   JavaCalls::call_special(&amp;result, thread_oop,
1131                           ik,
1132                           vmSymbols::object_initializer_name(),
1133                           vmSymbols::threadgroup_string_void_signature(),
1134                           thread_group,
1135                           string,
1136                           CHECK_NULL);
1137   return thread_oop();
1138 }
1139 
1140 char java_runtime_name[128] = &quot;&quot;;
1141 char java_runtime_version[128] = &quot;&quot;;
<a name="43" id="anc43"></a>

1142 
1143 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1144 static const char* get_java_runtime_name(TRAPS) {
1145   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1146                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1147   fieldDescriptor fd;
1148   bool found = k != NULL &amp;&amp;
1149                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1150                                                         vmSymbols::string_signature(), &amp;fd);
1151   if (found) {
1152     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1153     if (name_oop == NULL) {
1154       return NULL;
1155     }
1156     const char* name = java_lang_String::as_utf8_string(name_oop,
1157                                                         java_runtime_name,
1158                                                         sizeof(java_runtime_name));
1159     return name;
1160   } else {
1161     return NULL;
1162   }
1163 }
1164 
1165 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1166 static const char* get_java_runtime_version(TRAPS) {
1167   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1168                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1169   fieldDescriptor fd;
1170   bool found = k != NULL &amp;&amp;
1171                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1172                                                         vmSymbols::string_signature(), &amp;fd);
1173   if (found) {
1174     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1175     if (name_oop == NULL) {
1176       return NULL;
1177     }
1178     const char* name = java_lang_String::as_utf8_string(name_oop,
1179                                                         java_runtime_version,
1180                                                         sizeof(java_runtime_version));
1181     return name;
1182   } else {
1183     return NULL;
1184   }
1185 }
1186 
<a name="44" id="anc44"></a>











































1187 // General purpose hook into Java code, run once when the VM is initialized.
1188 // The Java library method itself may be changed independently from the VM.
1189 static void call_postVMInitHook(TRAPS) {
1190   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1191   if (klass != NULL) {
1192     JavaValue result(T_VOID);
1193     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1194                            vmSymbols::void_method_signature(),
1195                            CHECK);
1196   }
1197 }
1198 
1199 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1200                                     bool daemon, TRAPS) {
1201   assert(thread_group.not_null(), &quot;thread group should be specified&quot;);
1202   assert(threadObj() == NULL, &quot;should only create Java thread object once&quot;);
1203 
1204   InstanceKlass* ik = SystemDictionary::Thread_klass();
1205   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1206   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1207 
1208   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1209   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1210   // constructor calls Thread.current(), which must be set here.
1211   java_lang_Thread::set_thread(thread_oop(), this);
1212   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1213   set_threadObj(thread_oop());
1214 
1215   JavaValue result(T_VOID);
1216   if (thread_name != NULL) {
1217     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1218     // Thread gets assigned specified name and null target
1219     JavaCalls::call_special(&amp;result,
1220                             thread_oop,
1221                             ik,
1222                             vmSymbols::object_initializer_name(),
1223                             vmSymbols::threadgroup_string_void_signature(),
1224                             thread_group,
1225                             name,
1226                             THREAD);
1227   } else {
1228     // Thread gets assigned name &quot;Thread-nnn&quot; and null target
1229     // (java.lang.Thread doesn&#39;t have a constructor taking only a ThreadGroup argument)
1230     JavaCalls::call_special(&amp;result,
1231                             thread_oop,
1232                             ik,
1233                             vmSymbols::object_initializer_name(),
1234                             vmSymbols::threadgroup_runnable_void_signature(),
1235                             thread_group,
1236                             Handle(),
1237                             THREAD);
1238   }
1239 
1240 
1241   if (daemon) {
1242     java_lang_Thread::set_daemon(thread_oop());
1243   }
1244 
1245   if (HAS_PENDING_EXCEPTION) {
1246     return;
1247   }
1248 
1249   Klass* group =  SystemDictionary::ThreadGroup_klass();
1250   Handle threadObj(THREAD, this-&gt;threadObj());
1251 
1252   JavaCalls::call_special(&amp;result,
1253                           thread_group,
1254                           group,
1255                           vmSymbols::add_method_name(),
1256                           vmSymbols::thread_void_signature(),
1257                           threadObj,          // Arg 1
1258                           THREAD);
1259 }
1260 
1261 // List of all NonJavaThreads and safe iteration over that list.
1262 
1263 class NonJavaThread::List {
1264 public:
1265   NonJavaThread* volatile _head;
1266   SingleWriterSynchronizer _protect;
1267 
1268   List() : _head(NULL), _protect() {}
1269 };
1270 
1271 NonJavaThread::List NonJavaThread::_the_list;
1272 
1273 NonJavaThread::Iterator::Iterator() :
1274   _protect_enter(_the_list._protect.enter()),
<a name="45" id="anc45"></a><span class="line-modified">1275   _current(OrderAccess::load_acquire(&amp;_the_list._head))</span>
1276 {}
1277 
1278 NonJavaThread::Iterator::~Iterator() {
1279   _the_list._protect.exit(_protect_enter);
1280 }
1281 
1282 void NonJavaThread::Iterator::step() {
1283   assert(!end(), &quot;precondition&quot;);
<a name="46" id="anc46"></a><span class="line-modified">1284   _current = OrderAccess::load_acquire(&amp;_current-&gt;_next);</span>
1285 }
1286 
1287 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1288   assert(BarrierSet::barrier_set() != NULL, &quot;NonJavaThread created too soon!&quot;);
1289 }
1290 
1291 NonJavaThread::~NonJavaThread() { }
1292 
1293 void NonJavaThread::add_to_the_list() {
<a name="47" id="anc47"></a><span class="line-modified">1294   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-modified">1295   _next = _the_list._head;</span>
<span class="line-modified">1296   OrderAccess::release_store(&amp;_the_list._head, this);</span>


1297 }
1298 
1299 void NonJavaThread::remove_from_the_list() {
<a name="48" id="anc48"></a><span class="line-modified">1300   MutexLockerEx lock(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-modified">1301   NonJavaThread* volatile* p = &amp;_the_list._head;</span>
<span class="line-modified">1302   for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {</span>
<span class="line-modified">1303     if (t == this) {</span>
<span class="line-modified">1304       *p = this-&gt;_next;</span>
<span class="line-modified">1305       // Wait for any in-progress iterators.  Concurrent synchronize is</span>
<span class="line-modified">1306       // not allowed, so do it while holding the list lock.</span>
<span class="line-modified">1307       _the_list._protect.synchronize();</span>
<span class="line-modified">1308       break;</span>

1309     }
1310   }
<a name="49" id="anc49"></a>





1311 }
1312 
1313 void NonJavaThread::pre_run() {
<a name="50" id="anc50"></a><span class="line-removed">1314   // Initialize BarrierSet-related data before adding to list.</span>
<span class="line-removed">1315   assert(BarrierSet::barrier_set() != NULL, &quot;invariant&quot;);</span>
<span class="line-removed">1316   BarrierSet::barrier_set()-&gt;on_thread_attach(this);</span>
1317   add_to_the_list();
1318 
1319   // This is slightly odd in that NamedThread is a subclass, but
1320   // in fact name() is defined in Thread
1321   assert(this-&gt;name() != NULL, &quot;thread name was not set before it was started&quot;);
1322   this-&gt;set_native_thread_name(this-&gt;name());
1323 }
1324 
1325 void NonJavaThread::post_run() {
1326   JFR_ONLY(Jfr::on_thread_exit(this);)
<a name="51" id="anc51"></a><span class="line-removed">1327   // Clean up BarrierSet data before removing from list.</span>
<span class="line-removed">1328   BarrierSet::barrier_set()-&gt;on_thread_detach(this);</span>
1329   remove_from_the_list();
1330   // Ensure thread-local-storage is cleared before termination.
1331   Thread::clear_thread_current();
1332 }
1333 
1334 // NamedThread --  non-JavaThread subclasses with multiple
1335 // uniquely named instances should derive from this.
1336 NamedThread::NamedThread() :
1337   NonJavaThread(),
1338   _name(NULL),
1339   _processed_thread(NULL),
1340   _gc_id(GCId::undefined())
1341 {}
1342 
1343 NamedThread::~NamedThread() {
<a name="52" id="anc52"></a><span class="line-modified">1344   if (_name != NULL) {</span>
<span class="line-removed">1345     FREE_C_HEAP_ARRAY(char, _name);</span>
<span class="line-removed">1346     _name = NULL;</span>
<span class="line-removed">1347   }</span>
1348 }
1349 
1350 void NamedThread::set_name(const char* format, ...) {
1351   guarantee(_name == NULL, &quot;Only get to set name once.&quot;);
1352   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
<a name="53" id="anc53"></a><span class="line-removed">1353   guarantee(_name != NULL, &quot;alloc failure&quot;);</span>
1354   va_list ap;
1355   va_start(ap, format);
1356   jio_vsnprintf(_name, max_name_len, format, ap);
1357   va_end(ap);
1358 }
1359 
1360 void NamedThread::print_on(outputStream* st) const {
1361   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1362   Thread::print_on(st);
1363   st-&gt;cr();
1364 }
1365 
1366 
1367 // ======= WatcherThread ========
1368 
1369 // The watcher thread exists to simulate timer interrupts.  It should
1370 // be replaced by an abstraction over whatever native support for
1371 // timer interrupts exists on the platform.
1372 
1373 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1374 bool WatcherThread::_startable = false;
1375 volatile bool  WatcherThread::_should_terminate = false;
1376 
1377 WatcherThread::WatcherThread() : NonJavaThread() {
1378   assert(watcher_thread() == NULL, &quot;we can only allocate one WatcherThread&quot;);
1379   if (os::create_thread(this, os::watcher_thread)) {
1380     _watcher_thread = this;
1381 
1382     // Set the watcher thread to the highest OS priority which should not be
1383     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1384     // is created. The only normal thread using this priority is the reference
1385     // handler thread, which runs for very short intervals only.
1386     // If the VMThread&#39;s priority is not lower than the WatcherThread profiling
1387     // will be inaccurate.
1388     os::set_priority(this, MaxPriority);
1389     if (!DisableStartThread) {
1390       os::start_thread(this);
1391     }
1392   }
1393 }
1394 
1395 int WatcherThread::sleep() const {
1396   // The WatcherThread does not participate in the safepoint protocol
1397   // for the PeriodicTask_lock because it is not a JavaThread.
<a name="54" id="anc54"></a><span class="line-modified">1398   MutexLockerEx ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);</span>
1399 
1400   if (_should_terminate) {
1401     // check for termination before we do any housekeeping or wait
1402     return 0;  // we did not sleep.
1403   }
1404 
1405   // remaining will be zero if there are no tasks,
1406   // causing the WatcherThread to sleep until a task is
1407   // enrolled
1408   int remaining = PeriodicTask::time_to_wait();
1409   int time_slept = 0;
1410 
1411   // we expect this to timeout - we only ever get unparked when
1412   // we should terminate or when a new task has been enrolled
1413   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1414 
1415   jlong time_before_loop = os::javaTimeNanos();
1416 
1417   while (true) {
<a name="55" id="anc55"></a><span class="line-modified">1418     bool timedout = PeriodicTask_lock-&gt;wait(Mutex::_no_safepoint_check_flag,</span>
<span class="line-removed">1419                                             remaining);</span>
1420     jlong now = os::javaTimeNanos();
1421 
1422     if (remaining == 0) {
1423       // if we didn&#39;t have any tasks we could have waited for a long time
1424       // consider the time_slept zero and reset time_before_loop
1425       time_slept = 0;
1426       time_before_loop = now;
1427     } else {
1428       // need to recalculate since we might have new tasks in _tasks
1429       time_slept = (int) ((now - time_before_loop) / 1000000);
1430     }
1431 
1432     // Change to task list or spurious wakeup of some kind
1433     if (timedout || _should_terminate) {
1434       break;
1435     }
1436 
1437     remaining = PeriodicTask::time_to_wait();
1438     if (remaining == 0) {
1439       // Last task was just disenrolled so loop around and wait until
1440       // another task gets enrolled
1441       continue;
1442     }
1443 
1444     remaining -= time_slept;
1445     if (remaining &lt;= 0) {
1446       break;
1447     }
1448   }
1449 
1450   return time_slept;
1451 }
1452 
1453 void WatcherThread::run() {
1454   assert(this == watcher_thread(), &quot;just checking&quot;);
1455 
1456   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1457   while (true) {
1458     assert(watcher_thread() == Thread::current(), &quot;thread consistency check&quot;);
1459     assert(watcher_thread() == this, &quot;thread consistency check&quot;);
1460 
1461     // Calculate how long it&#39;ll be until the next PeriodicTask work
1462     // should be done, and sleep that amount of time.
1463     int time_waited = sleep();
1464 
1465     if (VMError::is_error_reported()) {
1466       // A fatal error has happened, the error handler(VMError::report_and_die)
1467       // should abort JVM after creating an error log file. However in some
1468       // rare cases, the error handler itself might deadlock. Here periodically
1469       // check for error reporting timeouts, and if it happens, just proceed to
1470       // abort the VM.
1471 
1472       // This code is in WatcherThread because WatcherThread wakes up
1473       // periodically so the fatal error handler doesn&#39;t need to do anything;
1474       // also because the WatcherThread is less likely to crash than other
1475       // threads.
1476 
1477       for (;;) {
1478         // Note: we use naked sleep in this loop because we want to avoid using
1479         // any kind of VM infrastructure which may be broken at this point.
1480         if (VMError::check_timeout()) {
1481           // We hit error reporting timeout. Error reporting was interrupted and
1482           // will be wrapping things up now (closing files etc). Give it some more
1483           // time, then quit the VM.
1484           os::naked_short_sleep(200);
1485           // Print a message to stderr.
1486           fdStream err(defaultStream::output_fd());
1487           err.print_raw_cr(&quot;# [ timer expired, abort... ]&quot;);
1488           // skip atexit/vm_exit/vm_abort hooks
1489           os::die();
1490         }
1491 
1492         // Wait a second, then recheck for timeout.
1493         os::naked_short_sleep(999);
1494       }
1495     }
1496 
1497     if (_should_terminate) {
1498       // check for termination before posting the next tick
1499       break;
1500     }
1501 
1502     PeriodicTask::real_time_tick(time_waited);
1503   }
1504 
1505   // Signal that it is terminated
1506   {
<a name="56" id="anc56"></a><span class="line-modified">1507     MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);</span>
1508     _watcher_thread = NULL;
<a name="57" id="anc57"></a><span class="line-modified">1509     Terminator_lock-&gt;notify();</span>
1510   }
1511 }
1512 
1513 void WatcherThread::start() {
1514   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1515 
1516   if (watcher_thread() == NULL &amp;&amp; _startable) {
1517     _should_terminate = false;
1518     // Create the single instance of WatcherThread
1519     new WatcherThread();
1520   }
1521 }
1522 
1523 void WatcherThread::make_startable() {
1524   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1525   _startable = true;
1526 }
1527 
1528 void WatcherThread::stop() {
1529   {
1530     // Follow normal safepoint aware lock enter protocol since the
1531     // WatcherThread is stopped by another JavaThread.
1532     MutexLocker ml(PeriodicTask_lock);
1533     _should_terminate = true;
1534 
1535     WatcherThread* watcher = watcher_thread();
1536     if (watcher != NULL) {
1537       // unpark the WatcherThread so it can see that it should terminate
1538       watcher-&gt;unpark();
1539     }
1540   }
1541 
<a name="58" id="anc58"></a><span class="line-modified">1542   MutexLocker mu(Terminator_lock);</span>
1543 
1544   while (watcher_thread() != NULL) {
1545     // This wait should make safepoint checks, wait without a timeout,
1546     // and wait as a suspend-equivalent condition.
<a name="59" id="anc59"></a><span class="line-modified">1547     Terminator_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,</span>
<span class="line-removed">1548                           Mutex::_as_suspend_equivalent_flag);</span>
1549   }
1550 }
1551 
1552 void WatcherThread::unpark() {
1553   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1554   PeriodicTask_lock-&gt;notify();
1555 }
1556 
1557 void WatcherThread::print_on(outputStream* st) const {
1558   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1559   Thread::print_on(st);
1560   st-&gt;cr();
1561 }
1562 
1563 // ======= JavaThread ========
1564 
1565 #if INCLUDE_JVMCI
1566 
1567 jlong* JavaThread::_jvmci_old_thread_counters;
1568 
1569 bool jvmci_counters_include(JavaThread* thread) {
1570   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1571 }
1572 
<a name="60" id="anc60"></a><span class="line-modified">1573 void JavaThread::collect_counters(typeArrayOop array) {</span>
<span class="line-modified">1574   if (JVMCICounterSize &gt; 0) {</span>
<span class="line-modified">1575     JavaThreadIteratorWithHandle jtiwh;</span>
<span class="line-modified">1576     for (int i = 0; i &lt; array-&gt;length(); i++) {</span>
<span class="line-modified">1577       array-&gt;long_at_put(i, _jvmci_old_thread_counters[i]);</span>
<span class="line-modified">1578     }</span>
<span class="line-modified">1579     for (; JavaThread *tp = jtiwh.next(); ) {</span>
<span class="line-modified">1580       if (jvmci_counters_include(tp)) {</span>
<span class="line-modified">1581         for (int i = 0; i &lt; array-&gt;length(); i++) {</span>
<span class="line-removed">1582           array-&gt;long_at_put(i, array-&gt;long_at(i) + tp-&gt;_jvmci_counters[i]);</span>
<span class="line-removed">1583         }</span>
1584       }
1585     }
1586   }
1587 }
1588 
<a name="61" id="anc61"></a>
















































1589 #endif // INCLUDE_JVMCI
1590 
1591 // A JavaThread is a normal Java thread
1592 
1593 void JavaThread::initialize() {
1594   // Initialize fields
1595 
1596   set_saved_exception_pc(NULL);
1597   set_threadObj(NULL);
1598   _anchor.clear();
1599   set_entry_point(NULL);
1600   set_jni_functions(jni_functions());
1601   set_callee_target(NULL);
1602   set_vm_result(NULL);
1603   set_vm_result_2(NULL);
1604   set_vframe_array_head(NULL);
1605   set_vframe_array_last(NULL);
1606   set_deferred_locals(NULL);
1607   set_deopt_mark(NULL);
1608   set_deopt_compiled_method(NULL);
<a name="62" id="anc62"></a><span class="line-removed">1609   clear_must_deopt_id();</span>
1610   set_monitor_chunks(NULL);
<a name="63" id="anc63"></a><span class="line-removed">1611   set_next(NULL);</span>
1612   _on_thread_list = false;
<a name="64" id="anc64"></a><span class="line-modified">1613   set_thread_state(_thread_new);</span>
1614   _terminated = _not_terminated;
1615   _array_for_gc = NULL;
1616   _suspend_equivalent = false;
1617   _in_deopt_handler = 0;
1618   _doing_unsafe_access = false;
1619   _stack_guard_state = stack_guard_unused;
1620 #if INCLUDE_JVMCI
1621   _pending_monitorenter = false;
1622   _pending_deoptimization = -1;
1623   _pending_failed_speculation = 0;
1624   _pending_transfer_to_interpreter = false;
<a name="65" id="anc65"></a><span class="line-removed">1625   _adjusting_comp_level = false;</span>
1626   _in_retryable_allocation = false;
1627   _jvmci._alternate_call_target = NULL;
1628   assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;);
<a name="66" id="anc66"></a>
1629   if (JVMCICounterSize &gt; 0) {
<a name="67" id="anc67"></a><span class="line-modified">1630     _jvmci_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);</span>
<span class="line-removed">1631     memset(_jvmci_counters, 0, sizeof(jlong) * JVMCICounterSize);</span>
<span class="line-removed">1632   } else {</span>
<span class="line-removed">1633     _jvmci_counters = NULL;</span>
1634   }
1635 #endif // INCLUDE_JVMCI
1636   _reserved_stack_activation = NULL;  // stack base not known yet
1637   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1638   _exception_pc  = 0;
1639   _exception_handler_pc = 0;
1640   _is_method_handle_return = 0;
1641   _jvmti_thread_state= NULL;
1642   _should_post_on_exceptions_flag = JNI_FALSE;
1643   _interp_only_mode    = 0;
1644   _special_runtime_exit_condition = _no_async_condition;
1645   _pending_async_exception = NULL;
1646   _thread_stat = NULL;
1647   _thread_stat = new ThreadStatistics();
<a name="68" id="anc68"></a><span class="line-removed">1648   _blocked_on_compilation = false;</span>
1649   _jni_active_critical = 0;
1650   _pending_jni_exception_check_fn = NULL;
1651   _do_not_unlock_if_synchronized = false;
1652   _cached_monitor_info = NULL;
1653   _parker = Parker::Allocate(this);
<a name="69" id="anc69"></a><span class="line-modified">1654 </span>
<span class="line-removed">1655 #ifndef PRODUCT</span>
<span class="line-removed">1656   _jmp_ring_index = 0;</span>
<span class="line-removed">1657   for (int ji = 0; ji &lt; jump_ring_buffer_size; ji++) {</span>
<span class="line-removed">1658     record_jump(NULL, NULL, NULL, 0);</span>
<span class="line-removed">1659   }</span>
<span class="line-removed">1660 #endif // PRODUCT</span>
<span class="line-removed">1661 </span>
1662   // Setup safepoint state info for this thread
1663   ThreadSafepointState::create(this);
1664 
1665   debug_only(_java_call_counter = 0);
1666 
1667   // JVMTI PopFrame support
1668   _popframe_condition = popframe_inactive;
1669   _popframe_preserved_args = NULL;
1670   _popframe_preserved_args_size = 0;
1671   _frames_to_pop_failed_realloc = 0;
1672 
1673   if (SafepointMechanism::uses_thread_local_poll()) {
1674     SafepointMechanism::initialize_header(this);
1675   }
1676 
1677   _class_to_be_initialized = NULL;
1678 
1679   pd_initialize();
1680 }
1681 
1682 JavaThread::JavaThread(bool is_attaching_via_jni) :
1683                        Thread() {
1684   initialize();
1685   if (is_attaching_via_jni) {
1686     _jni_attach_state = _attaching_via_jni;
1687   } else {
1688     _jni_attach_state = _not_attaching_via_jni;
1689   }
1690   assert(deferred_card_mark().is_empty(), &quot;Default MemRegion ctor&quot;);
1691 }
1692 
<a name="70" id="anc70"></a>

























































1693 bool JavaThread::reguard_stack(address cur_sp) {
1694   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1695       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1696     return true; // Stack already guarded or guard pages not needed.
1697   }
1698 
1699   if (register_stack_overflow()) {
1700     // For those architectures which have separate register and
1701     // memory stacks, we must check the register stack to see if
1702     // it has overflowed.
1703     return false;
1704   }
1705 
1706   // Java code never executes within the yellow zone: the latter is only
1707   // there to provoke an exception during stack banging.  If java code
1708   // is executing there, either StackShadowPages should be larger, or
1709   // some exception code in c1, c2 or the interpreter isn&#39;t unwinding
1710   // when it should.
1711   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1712             &quot;not enough space to reguard - increase StackShadowPages&quot;);
1713   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1714     enable_stack_yellow_reserved_zone();
1715     if (reserved_stack_activation() != stack_base()) {
1716       set_reserved_stack_activation(stack_base());
1717     }
1718   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1719     set_reserved_stack_activation(stack_base());
1720     enable_stack_reserved_zone();
1721   }
1722   return true;
1723 }
1724 
1725 bool JavaThread::reguard_stack(void) {
1726   return reguard_stack(os::current_stack_pointer());
1727 }
1728 
1729 
<a name="71" id="anc71"></a>







1730 void JavaThread::block_if_vm_exited() {
1731   if (_terminated == _vm_exited) {
1732     // _vm_exited is set at safepoint, and Threads_lock is never released
<a name="72" id="anc72"></a><span class="line-modified">1733     // we will block here forever</span>
<span class="line-modified">1734     Threads_lock-&gt;lock_without_safepoint_check();</span>



1735     ShouldNotReachHere();
1736   }
1737 }
1738 
1739 
1740 // Remove this ifdef when C1 is ported to the compiler interface.
1741 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1742 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1743 
1744 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1745                        Thread() {
1746   initialize();
1747   _jni_attach_state = _not_attaching_via_jni;
1748   set_entry_point(entry_point);
1749   // Create the native thread itself.
1750   // %note runtime_23
1751   os::ThreadType thr_type = os::java_thread;
1752   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1753                                                      os::java_thread;
1754   os::create_thread(this, thr_type, stack_sz);
1755   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1756   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1757   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1758   // the exception consists of creating the exception object &amp; initializing it, initialization
1759   // will leave the VM via a JavaCall and then all locks must be unlocked).
1760   //
1761   // The thread is still suspended when we reach here. Thread must be explicit started
1762   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1763   // by calling Threads:add. The reason why this is not done here, is because the thread
1764   // object must be fully initialized (take a look at JVM_Start)
1765 }
1766 
1767 JavaThread::~JavaThread() {
1768 
1769   // JSR166 -- return the parker to the free list
1770   Parker::Release(_parker);
1771   _parker = NULL;
1772 
<a name="73" id="anc73"></a>



1773   // Free any remaining  previous UnrollBlock
1774   vframeArray* old_array = vframe_array_last();
1775 
1776   if (old_array != NULL) {
1777     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1778     old_array-&gt;set_unroll_block(NULL);
1779     delete old_info;
1780     delete old_array;
1781   }
1782 
1783   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1784   if (deferred != NULL) {
1785     // This can only happen if thread is destroyed before deoptimization occurs.
1786     assert(deferred-&gt;length() != 0, &quot;empty array!&quot;);
1787     do {
1788       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1789       deferred-&gt;remove_at(0);
1790       // individual jvmtiDeferredLocalVariableSet are CHeapObj&#39;s
1791       delete dlv;
1792     } while (deferred-&gt;length() != 0);
1793     delete deferred;
1794   }
1795 
1796   // All Java related clean up happens in exit
1797   ThreadSafepointState::destroy(this);
1798   if (_thread_stat != NULL) delete _thread_stat;
1799 
1800 #if INCLUDE_JVMCI
1801   if (JVMCICounterSize &gt; 0) {
1802     if (jvmci_counters_include(this)) {
1803       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1804         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1805       }
1806     }
1807     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1808   }
1809 #endif // INCLUDE_JVMCI
1810 }
1811 
1812 
1813 // First JavaThread specific code executed by a new Java thread.
1814 void JavaThread::pre_run() {
1815   // empty - see comments in run()
1816 }
1817 
1818 // The main routine called by a new Java thread. This isn&#39;t overridden
1819 // by subclasses, instead different subclasses define a different &quot;entry_point&quot;
1820 // which defines the actual logic for that kind of thread.
1821 void JavaThread::run() {
1822   // initialize thread-local alloc buffer related fields
1823   this-&gt;initialize_tlab();
1824 
1825   // Used to test validity of stack trace backs.
1826   // This can&#39;t be moved into pre_run() else we invalidate
1827   // the requirement that thread_main_inner is lower on
1828   // the stack. Consequently all the initialization logic
1829   // stays here in run() rather than pre_run().
1830   this-&gt;record_base_of_stack_pointer();
1831 
1832   this-&gt;create_stack_guard_pages();
1833 
1834   this-&gt;cache_global_variables();
1835 
1836   // Thread is now sufficiently initialized to be handled by the safepoint code as being
1837   // in the VM. Change thread state from _thread_new to _thread_in_vm
<a name="74" id="anc74"></a><span class="line-modified">1838   ThreadStateTransition::transition_and_fence(this, _thread_new, _thread_in_vm);</span>




1839 
1840   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1841   assert(!Thread::current()-&gt;owns_locks(), &quot;sanity check&quot;);
1842 
1843   DTRACE_THREAD_PROBE(start, this);
1844 
1845   // This operation might block. We call that after all safepoint checks for a new thread has
1846   // been completed.
1847   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1848 
1849   if (JvmtiExport::should_post_thread_life()) {
1850     JvmtiExport::post_thread_start(this);
1851 
1852   }
1853 
1854   // We call another function to do the rest so we are sure that the stack addresses used
1855   // from there will be lower than the stack base just computed.
1856   thread_main_inner();
1857 }
1858 
1859 void JavaThread::thread_main_inner() {
1860   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1861   assert(this-&gt;threadObj() != NULL, &quot;just checking&quot;);
1862 
1863   // Execute thread entry point unless this thread has a pending exception
1864   // or has been stopped before starting.
1865   // Note: Due to JVM_StopThread we can have pending exceptions already!
1866   if (!this-&gt;has_pending_exception() &amp;&amp;
1867       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1868     {
1869       ResourceMark rm(this);
1870       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1871     }
1872     HandleMark hm(this);
1873     this-&gt;entry_point()(this, this);
1874   }
1875 
1876   DTRACE_THREAD_PROBE(stop, this);
1877 
1878   // Cleanup is handled in post_run()
1879 }
1880 
1881 // Shared teardown for all JavaThreads
1882 void JavaThread::post_run() {
1883   this-&gt;exit(false);
1884   // Defer deletion to here to ensure &#39;this&#39; is still referenceable in call_run
1885   // for any shared tear-down.
1886   this-&gt;smr_delete();
1887 }
1888 
1889 static void ensure_join(JavaThread* thread) {
1890   // We do not need to grab the Threads_lock, since we are operating on ourself.
1891   Handle threadObj(thread, thread-&gt;threadObj());
1892   assert(threadObj.not_null(), &quot;java thread object must exist&quot;);
1893   ObjectLocker lock(threadObj, thread);
1894   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1895   thread-&gt;clear_pending_exception();
1896   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
1897   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
1898   // Clear the native thread instance - this makes isAlive return false and allows the join()
1899   // to complete once we&#39;ve done the notify_all below
1900   java_lang_Thread::set_thread(threadObj(), NULL);
1901   lock.notify_all(thread);
1902   // Ignore pending exception (ThreadDeath), since we are exiting anyway
1903   thread-&gt;clear_pending_exception();
1904 }
1905 
1906 static bool is_daemon(oop threadObj) {
1907   return (threadObj != NULL &amp;&amp; java_lang_Thread::is_daemon(threadObj));
1908 }
1909 
1910 // For any new cleanup additions, please check to see if they need to be applied to
1911 // cleanup_failed_attach_current_thread as well.
1912 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
1913   assert(this == JavaThread::current(), &quot;thread consistency check&quot;);
1914 
1915   elapsedTimer _timer_exit_phase1;
1916   elapsedTimer _timer_exit_phase2;
1917   elapsedTimer _timer_exit_phase3;
1918   elapsedTimer _timer_exit_phase4;
1919 
1920   if (log_is_enabled(Debug, os, thread, timer)) {
1921     _timer_exit_phase1.start();
1922   }
1923 
1924   HandleMark hm(this);
1925   Handle uncaught_exception(this, this-&gt;pending_exception());
1926   this-&gt;clear_pending_exception();
1927   Handle threadObj(this, this-&gt;threadObj());
1928   assert(threadObj.not_null(), &quot;Java thread object should be created&quot;);
1929 
1930   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
1931   {
1932     EXCEPTION_MARK;
1933 
1934     CLEAR_PENDING_EXCEPTION;
1935   }
1936   if (!destroy_vm) {
1937     if (uncaught_exception.not_null()) {
1938       EXCEPTION_MARK;
1939       // Call method Thread.dispatchUncaughtException().
1940       Klass* thread_klass = SystemDictionary::Thread_klass();
1941       JavaValue result(T_VOID);
1942       JavaCalls::call_virtual(&amp;result,
1943                               threadObj, thread_klass,
1944                               vmSymbols::dispatchUncaughtException_name(),
1945                               vmSymbols::throwable_void_signature(),
1946                               uncaught_exception,
1947                               THREAD);
1948       if (HAS_PENDING_EXCEPTION) {
1949         ResourceMark rm(this);
1950         jio_fprintf(defaultStream::error_stream(),
1951                     &quot;\nException: %s thrown from the UncaughtExceptionHandler&quot;
1952                     &quot; in thread \&quot;%s\&quot;\n&quot;,
1953                     pending_exception()-&gt;klass()-&gt;external_name(),
1954                     get_thread_name());
1955         CLEAR_PENDING_EXCEPTION;
1956       }
1957     }
1958     JFR_ONLY(Jfr::on_java_thread_dismantle(this);)
1959 
1960     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
1961     // the execution of the method. If that is not enough, then we don&#39;t really care. Thread.stop
1962     // is deprecated anyhow.
1963     if (!is_Compiler_thread()) {
1964       int count = 3;
1965       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
1966         EXCEPTION_MARK;
1967         JavaValue result(T_VOID);
1968         Klass* thread_klass = SystemDictionary::Thread_klass();
1969         JavaCalls::call_virtual(&amp;result,
1970                                 threadObj, thread_klass,
1971                                 vmSymbols::exit_method_name(),
1972                                 vmSymbols::void_method_signature(),
1973                                 THREAD);
1974         CLEAR_PENDING_EXCEPTION;
1975       }
1976     }
1977     // notify JVMTI
1978     if (JvmtiExport::should_post_thread_life()) {
1979       JvmtiExport::post_thread_end(this);
1980     }
1981 
1982     // We have notified the agents that we are exiting, before we go on,
1983     // we must check for a pending external suspend request and honor it
1984     // in order to not surprise the thread that made the suspend request.
1985     while (true) {
1986       {
<a name="75" id="anc75"></a><span class="line-modified">1987         MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1988         if (!is_external_suspend()) {
1989           set_terminated(_thread_exiting);
1990           ThreadService::current_thread_exiting(this, is_daemon(threadObj()));
1991           break;
1992         }
1993         // Implied else:
1994         // Things get a little tricky here. We have a pending external
1995         // suspend request, but we are holding the SR_lock so we
1996         // can&#39;t just self-suspend. So we temporarily drop the lock
1997         // and then self-suspend.
1998       }
1999 
2000       ThreadBlockInVM tbivm(this);
2001       java_suspend_self();
2002 
2003       // We&#39;re done with this suspend request, but we have to loop around
2004       // and check again. Eventually we will get SR_lock without a pending
2005       // external suspend request and will be able to mark ourselves as
2006       // exiting.
2007     }
2008     // no more external suspends are allowed at this point
2009   } else {
2010     assert(!is_terminated() &amp;&amp; !is_exiting(), &quot;must not be exiting&quot;);
2011     // before_exit() has already posted JVMTI THREAD_END events
2012   }
2013 
2014   if (log_is_enabled(Debug, os, thread, timer)) {
2015     _timer_exit_phase1.stop();
2016     _timer_exit_phase2.start();
2017   }
<a name="76" id="anc76"></a>



2018   // Notify waiters on thread object. This has to be done after exit() is called
2019   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
2020   // group should have the destroyed bit set before waiters are notified).
2021   ensure_join(this);
2022   assert(!this-&gt;has_pending_exception(), &quot;ensure_join should have cleared&quot;);
2023 
2024   if (log_is_enabled(Debug, os, thread, timer)) {
2025     _timer_exit_phase2.stop();
2026     _timer_exit_phase3.start();
2027   }
2028   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
2029   // held by this thread must be released. The spec does not distinguish
2030   // between JNI-acquired and regular Java monitors. We can only see
2031   // regular Java monitors here if monitor enter-exit matching is broken.
2032   //
2033   // ensure_join() ignores IllegalThreadStateExceptions, and so does
2034   // ObjectSynchronizer::release_monitors_owned_by_thread().
2035   if (exit_type == jni_detach) {
2036     // Sanity check even though JNI DetachCurrentThread() would have
2037     // returned JNI_ERR if there was a Java frame. JavaThread exit
2038     // should be done executing Java code by the time we get here.
2039     assert(!this-&gt;has_last_Java_frame(),
2040            &quot;should not have a Java frame when detaching or exiting&quot;);
2041     ObjectSynchronizer::release_monitors_owned_by_thread(this);
2042     assert(!this-&gt;has_pending_exception(), &quot;release_monitors should have cleared&quot;);
2043   }
2044 
2045   // These things needs to be done while we are still a Java Thread. Make sure that thread
2046   // is in a consistent state, in case GC happens
2047   JFR_ONLY(Jfr::on_thread_exit(this);)
2048 
2049   if (active_handles() != NULL) {
2050     JNIHandleBlock* block = active_handles();
2051     set_active_handles(NULL);
2052     JNIHandleBlock::release_block(block);
2053   }
2054 
2055   if (free_handle_block() != NULL) {
2056     JNIHandleBlock* block = free_handle_block();
2057     set_free_handle_block(NULL);
2058     JNIHandleBlock::release_block(block);
2059   }
2060 
2061   // These have to be removed while this is still a valid thread.
2062   remove_stack_guard_pages();
2063 
2064   if (UseTLAB) {
2065     tlab().retire();
2066   }
2067 
2068   if (JvmtiEnv::environments_might_exist()) {
2069     JvmtiExport::cleanup_thread(this);
2070   }
2071 
2072   // We must flush any deferred card marks and other various GC barrier
2073   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
2074   // before removing a thread from the list of active threads.
2075   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2076 
2077   log_info(os, thread)(&quot;JavaThread %s (tid: &quot; UINTX_FORMAT &quot;).&quot;,
2078     exit_type == JavaThread::normal_exit ? &quot;exiting&quot; : &quot;detaching&quot;,
2079     os::current_thread_id());
2080 
2081   if (log_is_enabled(Debug, os, thread, timer)) {
2082     _timer_exit_phase3.stop();
2083     _timer_exit_phase4.start();
2084   }
2085   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
<a name="77" id="anc77"></a><span class="line-modified">2086   Threads::remove(this);</span>
2087 
2088   if (log_is_enabled(Debug, os, thread, timer)) {
2089     _timer_exit_phase4.stop();
2090     ResourceMark rm(this);
2091     log_debug(os, thread, timer)(&quot;name=&#39;%s&#39;&quot;
2092                                  &quot;, exit-phase1=&quot; JLONG_FORMAT
2093                                  &quot;, exit-phase2=&quot; JLONG_FORMAT
2094                                  &quot;, exit-phase3=&quot; JLONG_FORMAT
2095                                  &quot;, exit-phase4=&quot; JLONG_FORMAT,
2096                                  get_thread_name(),
2097                                  _timer_exit_phase1.milliseconds(),
2098                                  _timer_exit_phase2.milliseconds(),
2099                                  _timer_exit_phase3.milliseconds(),
2100                                  _timer_exit_phase4.milliseconds());
2101   }
2102 }
2103 
<a name="78" id="anc78"></a><span class="line-modified">2104 void JavaThread::cleanup_failed_attach_current_thread() {</span>
2105   if (active_handles() != NULL) {
2106     JNIHandleBlock* block = active_handles();
2107     set_active_handles(NULL);
2108     JNIHandleBlock::release_block(block);
2109   }
2110 
2111   if (free_handle_block() != NULL) {
2112     JNIHandleBlock* block = free_handle_block();
2113     set_free_handle_block(NULL);
2114     JNIHandleBlock::release_block(block);
2115   }
2116 
2117   // These have to be removed while this is still a valid thread.
2118   remove_stack_guard_pages();
2119 
2120   if (UseTLAB) {
2121     tlab().retire();
2122   }
2123 
2124   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2125 
<a name="79" id="anc79"></a><span class="line-modified">2126   Threads::remove(this);</span>
2127   this-&gt;smr_delete();
2128 }
2129 
2130 JavaThread* JavaThread::active() {
2131   Thread* thread = Thread::current();
2132   if (thread-&gt;is_Java_thread()) {
2133     return (JavaThread*) thread;
2134   } else {
2135     assert(thread-&gt;is_VM_thread(), &quot;this must be a vm thread&quot;);
2136     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2137     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2138     assert(ret-&gt;is_Java_thread(), &quot;must be a Java thread&quot;);
2139     return ret;
2140   }
2141 }
2142 
2143 bool JavaThread::is_lock_owned(address adr) const {
2144   if (Thread::is_lock_owned(adr)) return true;
2145 
2146   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2147     if (chunk-&gt;contains(adr)) return true;
2148   }
2149 
2150   return false;
2151 }
2152 
2153 
2154 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2155   chunk-&gt;set_next(monitor_chunks());
2156   set_monitor_chunks(chunk);
2157 }
2158 
2159 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2160   guarantee(monitor_chunks() != NULL, &quot;must be non empty&quot;);
2161   if (monitor_chunks() == chunk) {
2162     set_monitor_chunks(chunk-&gt;next());
2163   } else {
2164     MonitorChunk* prev = monitor_chunks();
2165     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2166     prev-&gt;set_next(chunk-&gt;next());
2167   }
2168 }
2169 
2170 // JVM support.
2171 
2172 // Note: this function shouldn&#39;t block if it&#39;s called in
2173 // _thread_in_native_trans state (such as from
2174 // check_special_condition_for_native_trans()).
2175 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2176 
2177   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2178     // If we are at a polling page safepoint (not a poll return)
2179     // then we must defer async exception because live registers
2180     // will be clobbered by the exception path. Poll return is
2181     // ok because the call we a returning from already collides
2182     // with exception handling registers and so there is no issue.
2183     // (The exception handling path kills call result registers but
2184     //  this is ok since the exception kills the result anyway).
2185 
2186     if (is_at_poll_safepoint()) {
2187       // if the code we are returning to has deoptimized we must defer
2188       // the exception otherwise live registers get clobbered on the
2189       // exception path before deoptimization is able to retrieve them.
2190       //
2191       RegisterMap map(this, false);
2192       frame caller_fr = last_frame().sender(&amp;map);
2193       assert(caller_fr.is_compiled_frame(), &quot;what?&quot;);
2194       if (caller_fr.is_deoptimized_frame()) {
2195         log_info(exceptions)(&quot;deferred async exception at compiled safepoint&quot;);
2196         return;
2197       }
2198     }
2199   }
2200 
2201   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2202   if (condition == _no_async_condition) {
2203     // Conditions have changed since has_special_runtime_exit_condition()
2204     // was called:
2205     // - if we were here only because of an external suspend request,
2206     //   then that was taken care of above (or cancelled) so we are done
2207     // - if we were here because of another async request, then it has
2208     //   been cleared between the has_special_runtime_exit_condition()
2209     //   and now so again we are done
2210     return;
2211   }
2212 
2213   // Check for pending async. exception
2214   if (_pending_async_exception != NULL) {
2215     // Only overwrite an already pending exception, if it is not a threadDeath.
2216     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2217 
2218       // We cannot call Exceptions::_throw(...) here because we cannot block
2219       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2220 
2221       LogTarget(Info, exceptions) lt;
2222       if (lt.is_enabled()) {
2223         ResourceMark rm;
2224         LogStream ls(lt);
2225         ls.print(&quot;Async. exception installed at runtime exit (&quot; INTPTR_FORMAT &quot;)&quot;, p2i(this));
2226           if (has_last_Java_frame()) {
2227             frame f = last_frame();
2228            ls.print(&quot; (pc: &quot; INTPTR_FORMAT &quot; sp: &quot; INTPTR_FORMAT &quot; )&quot;, p2i(f.pc()), p2i(f.sp()));
2229           }
2230         ls.print_cr(&quot; of type: %s&quot;, _pending_async_exception-&gt;klass()-&gt;external_name());
2231       }
2232       _pending_async_exception = NULL;
2233       clear_has_async_exception();
2234     }
2235   }
2236 
2237   if (check_unsafe_error &amp;&amp;
2238       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2239     condition = _no_async_condition;  // done
2240     switch (thread_state()) {
2241     case _thread_in_vm: {
2242       JavaThread* THREAD = this;
2243       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2244     }
2245     case _thread_in_native: {
2246       ThreadInVMfromNative tiv(this);
2247       JavaThread* THREAD = this;
2248       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2249     }
2250     case _thread_in_Java: {
2251       ThreadInVMfromJava tiv(this);
2252       JavaThread* THREAD = this;
2253       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in a recent unsafe memory access operation in compiled Java code&quot;);
2254     }
2255     default:
2256       ShouldNotReachHere();
2257     }
2258   }
2259 
2260   assert(condition == _no_async_condition || has_pending_exception() ||
2261          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2262          &quot;must have handled the async condition, if no exception&quot;);
2263 }
2264 
2265 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
<a name="80" id="anc80"></a><span class="line-removed">2266   //</span>
<span class="line-removed">2267   // Check for pending external suspend. Internal suspend requests do</span>
<span class="line-removed">2268   // not use handle_special_runtime_exit_condition().</span>
<span class="line-removed">2269   // If JNIEnv proxies are allowed, don&#39;t self-suspend if the target</span>
<span class="line-removed">2270   // thread is not the current thread. In older versions of jdbx, jdbx</span>
<span class="line-removed">2271   // threads could call into the VM with another thread&#39;s JNIEnv so we</span>
<span class="line-removed">2272   // can be here operating on behalf of a suspended thread (4432884).</span>
<span class="line-removed">2273   bool do_self_suspend = is_external_suspend_with_lock();</span>
<span class="line-removed">2274   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || this == JavaThread::current())) {</span>
<span class="line-removed">2275     //</span>
<span class="line-removed">2276     // Because thread is external suspended the safepoint code will count</span>
<span class="line-removed">2277     // thread as at a safepoint. This can be odd because we can be here</span>
<span class="line-removed">2278     // as _thread_in_Java which would normally transition to _thread_blocked</span>
<span class="line-removed">2279     // at a safepoint. We would like to mark the thread as _thread_blocked</span>
<span class="line-removed">2280     // before calling java_suspend_self like all other callers of it but</span>
<span class="line-removed">2281     // we must then observe proper safepoint protocol. (We can&#39;t leave</span>
<span class="line-removed">2282     // _thread_blocked with a safepoint in progress). However we can be</span>
<span class="line-removed">2283     // here as _thread_in_native_trans so we can&#39;t use a normal transition</span>
<span class="line-removed">2284     // constructor/destructor pair because they assert on that type of</span>
<span class="line-removed">2285     // transition. We could do something like:</span>
<span class="line-removed">2286     //</span>
<span class="line-removed">2287     // JavaThreadState state = thread_state();</span>
<span class="line-removed">2288     // set_thread_state(_thread_in_vm);</span>
<span class="line-removed">2289     // {</span>
<span class="line-removed">2290     //   ThreadBlockInVM tbivm(this);</span>
<span class="line-removed">2291     //   java_suspend_self()</span>
<span class="line-removed">2292     // }</span>
<span class="line-removed">2293     // set_thread_state(_thread_in_vm_trans);</span>
<span class="line-removed">2294     // if (safepoint) block;</span>
<span class="line-removed">2295     // set_thread_state(state);</span>
<span class="line-removed">2296     //</span>
<span class="line-removed">2297     // but that is pretty messy. Instead we just go with the way the</span>
<span class="line-removed">2298     // code has worked before and note that this is the only path to</span>
<span class="line-removed">2299     // java_suspend_self that doesn&#39;t put the thread in _thread_blocked</span>
<span class="line-removed">2300     // mode.</span>
2301 
<a name="81" id="anc81"></a>

2302     frame_anchor()-&gt;make_walkable(this);
<a name="82" id="anc82"></a><span class="line-modified">2303     java_suspend_self();</span>
<span class="line-removed">2304 </span>
<span class="line-removed">2305     // We might be here for reasons in addition to the self-suspend request</span>
<span class="line-removed">2306     // so check for other async requests.</span>
2307   }
2308 
<a name="83" id="anc83"></a>

2309   if (check_asyncs) {
2310     check_and_handle_async_exceptions();
2311   }
2312 
2313   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2314 }
2315 
2316 void JavaThread::send_thread_stop(oop java_throwable)  {
<a name="84" id="anc84"></a><span class="line-modified">2317   assert(Thread::current()-&gt;is_VM_thread(), &quot;should be in the vm thread&quot;);</span>
<span class="line-modified">2318   assert(Threads_lock-&gt;is_locked(), &quot;Threads_lock should be locked by safepoint code&quot;);</span>
<span class="line-removed">2319   assert(SafepointSynchronize::is_at_safepoint(), &quot;all threads are stopped&quot;);</span>
2320 
2321   // Do not throw asynchronous exceptions against the compiler thread
2322   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2323   if (!can_call_java()) return;
2324 
2325   {
2326     // Actually throw the Throwable against the target Thread - however
2327     // only if there is no thread death exception installed already.
2328     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2329       // If the topmost frame is a runtime stub, then we are calling into
2330       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2331       // must deoptimize the caller before continuing, as the compiled  exception handler table
2332       // may not be valid
2333       if (has_last_Java_frame()) {
2334         frame f = last_frame();
2335         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
<a name="85" id="anc85"></a><span class="line-modified">2336           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass</span>
<span class="line-removed">2337           RegisterMap reg_map(this, UseBiasedLocking);</span>
2338           frame compiled_frame = f.sender(&amp;reg_map);
2339           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
<a name="86" id="anc86"></a><span class="line-modified">2340             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);</span>
2341           }
2342         }
2343       }
2344 
2345       // Set async. pending exception in thread.
2346       set_pending_async_exception(java_throwable);
2347 
2348       if (log_is_enabled(Info, exceptions)) {
2349          ResourceMark rm;
2350         log_info(exceptions)(&quot;Pending Async. exception installed of type: %s&quot;,
2351                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2352       }
2353       // for AbortVMOnException flag
2354       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2355     }
2356   }
2357 
2358 
<a name="87" id="anc87"></a><span class="line-modified">2359   // Interrupt thread so it will wake up from a potential wait()</span>
<span class="line-modified">2360   Thread::interrupt(this);</span>

2361 }
2362 
2363 // External suspension mechanism.
2364 //
2365 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2366 // to any VM_locks and it is at a transition
2367 // Self-suspension will happen on the transition out of the vm.
2368 // Catch &quot;this&quot; coming in from JNIEnv pointers when the thread has been freed
2369 //
2370 // Guarantees on return:
2371 //   + Target thread will not execute any new bytecode (that&#39;s why we need to
2372 //     force a safepoint)
2373 //   + Target thread will not enter any new monitors
2374 //
2375 void JavaThread::java_suspend() {
2376   ThreadsListHandle tlh;
2377   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2378     return;
2379   }
2380 
<a name="88" id="anc88"></a><span class="line-modified">2381   { MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
2382     if (!is_external_suspend()) {
2383       // a racing resume has cancelled us; bail out now
2384       return;
2385     }
2386 
2387     // suspend is done
2388     uint32_t debug_bits = 0;
2389     // Warning: is_ext_suspend_completed() may temporarily drop the
2390     // SR_lock to allow the thread to reach a stable thread state if
2391     // it is currently in a transient thread state.
2392     if (is_ext_suspend_completed(false /* !called_by_wait */,
2393                                  SuspendRetryDelay, &amp;debug_bits)) {
2394       return;
2395     }
2396   }
2397 
2398   if (Thread::current() == this) {
2399     // Safely self-suspend.
2400     // If we don&#39;t do this explicitly it will implicitly happen
2401     // before we transition back to Java, and on some other thread-state
2402     // transition paths, but not as we exit a JVM TI SuspendThread call.
2403     // As SuspendThread(current) must not return (until resumed) we must
2404     // self-suspend here.
2405     ThreadBlockInVM tbivm(this);
2406     java_suspend_self();
2407   } else {
2408     VM_ThreadSuspend vm_suspend;
2409     VMThread::execute(&amp;vm_suspend);
2410   }
2411 }
2412 
2413 // Part II of external suspension.
2414 // A JavaThread self suspends when it detects a pending external suspend
2415 // request. This is usually on transitions. It is also done in places
2416 // where continuing to the next transition would surprise the caller,
2417 // e.g., monitor entry.
2418 //
2419 // Returns the number of times that the thread self-suspended.
2420 //
2421 // Note: DO NOT call java_suspend_self() when you just want to block current
2422 //       thread. java_suspend_self() is the second stage of cooperative
2423 //       suspension for external suspend requests and should only be used
2424 //       to complete an external suspend request.
2425 //
2426 int JavaThread::java_suspend_self() {
<a name="89" id="anc89"></a>
2427   int ret = 0;
2428 
2429   // we are in the process of exiting so don&#39;t suspend
2430   if (is_exiting()) {
2431     clear_external_suspend();
2432     return ret;
2433   }
2434 
2435   assert(_anchor.walkable() ||
2436          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2437          &quot;must have walkable stack&quot;);
2438 
<a name="90" id="anc90"></a><span class="line-modified">2439   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
2440 
2441   assert(!this-&gt;is_ext_suspended(),
2442          &quot;a thread trying to self-suspend should not already be suspended&quot;);
2443 
2444   if (this-&gt;is_suspend_equivalent()) {
2445     // If we are self-suspending as a result of the lifting of a
2446     // suspend equivalent condition, then the suspend_equivalent
2447     // flag is not cleared until we set the ext_suspended flag so
2448     // that wait_for_ext_suspend_completion() returns consistent
2449     // results.
2450     this-&gt;clear_suspend_equivalent();
2451   }
2452 
2453   // A racing resume may have cancelled us before we grabbed SR_lock
2454   // above. Or another external suspend request could be waiting for us
2455   // by the time we return from SR_lock()-&gt;wait(). The thread
2456   // that requested the suspension may already be trying to walk our
2457   // stack and if we return now, we can change the stack out from under
2458   // it. This would be a &quot;bad thing (TM)&quot; and cause the stack walker
2459   // to crash. We stay self-suspended until there are no more pending
2460   // external suspend requests.
2461   while (is_external_suspend()) {
2462     ret++;
2463     this-&gt;set_ext_suspended();
2464 
2465     // _ext_suspended flag is cleared by java_resume()
2466     while (is_ext_suspended()) {
<a name="91" id="anc91"></a><span class="line-modified">2467       this-&gt;SR_lock()-&gt;wait(Mutex::_no_safepoint_check_flag);</span>
2468     }
2469   }
<a name="92" id="anc92"></a><span class="line-removed">2470 </span>
2471   return ret;
2472 }
2473 
<a name="93" id="anc93"></a>































2474 #ifdef ASSERT
2475 // Verify the JavaThread has not yet been published in the Threads::list, and
2476 // hence doesn&#39;t need protection from concurrent access at this stage.
2477 void JavaThread::verify_not_published() {
2478   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2479   // since an unpublished JavaThread doesn&#39;t participate in the
2480   // Thread-SMR protocol for keeping a ThreadsList alive.
2481   assert(!on_thread_list(), &quot;JavaThread shouldn&#39;t have been published yet!&quot;);
2482 }
2483 #endif
2484 
2485 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2486 // progress or when _suspend_flags is non-zero.
2487 // Current thread needs to self-suspend if there is a suspend request and/or
2488 // block if a safepoint is in progress.
2489 // Async exception ISN&#39;T checked.
2490 // Note only the ThreadInVMfromNative transition can call this function
2491 // directly and when thread state is _thread_in_native_trans
2492 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2493   assert(thread-&gt;thread_state() == _thread_in_native_trans, &quot;wrong state&quot;);
2494 
<a name="94" id="anc94"></a><span class="line-modified">2495   JavaThread *curJT = JavaThread::current();</span>
<span class="line-modified">2496   bool do_self_suspend = thread-&gt;is_external_suspend();</span>
<span class="line-modified">2497 </span>
<span class="line-modified">2498   assert(!curJT-&gt;has_last_Java_frame() || curJT-&gt;frame_anchor()-&gt;walkable(), &quot;Unwalkable stack in native-&gt;vm transition&quot;);</span>
<span class="line-modified">2499 </span>
<span class="line-modified">2500   // If JNIEnv proxies are allowed, don&#39;t self-suspend if the target</span>
<span class="line-removed">2501   // thread is not the current thread. In older versions of jdbx, jdbx</span>
<span class="line-removed">2502   // threads could call into the VM with another thread&#39;s JNIEnv so we</span>
<span class="line-removed">2503   // can be here operating on behalf of a suspended thread (4432884).</span>
<span class="line-removed">2504   if (do_self_suspend &amp;&amp; (!AllowJNIEnvProxy || curJT == thread)) {</span>
<span class="line-removed">2505     JavaThreadState state = thread-&gt;thread_state();</span>
<span class="line-removed">2506 </span>
<span class="line-removed">2507     // We mark this thread_blocked state as a suspend-equivalent so</span>
<span class="line-removed">2508     // that a caller to is_ext_suspend_completed() won&#39;t be confused.</span>
<span class="line-removed">2509     // The suspend-equivalent state is cleared by java_suspend_self().</span>
<span class="line-removed">2510     thread-&gt;set_suspend_equivalent();</span>
<span class="line-removed">2511 </span>
<span class="line-removed">2512     // If the safepoint code sees the _thread_in_native_trans state, it will</span>
<span class="line-removed">2513     // wait until the thread changes to other thread state. There is no</span>
<span class="line-removed">2514     // guarantee on how soon we can obtain the SR_lock and complete the</span>
<span class="line-removed">2515     // self-suspend request. It would be a bad idea to let safepoint wait for</span>
<span class="line-removed">2516     // too long. Temporarily change the state to _thread_blocked to</span>
<span class="line-removed">2517     // let the VM thread know that this thread is ready for GC. The problem</span>
<span class="line-removed">2518     // of changing thread state is that safepoint could happen just after</span>
<span class="line-removed">2519     // java_suspend_self() returns after being resumed, and VM thread will</span>
<span class="line-removed">2520     // see the _thread_blocked state. We must check for safepoint</span>
<span class="line-removed">2521     // after restoring the state and make sure we won&#39;t leave while a safepoint</span>
<span class="line-removed">2522     // is in progress.</span>
<span class="line-removed">2523     thread-&gt;set_thread_state(_thread_blocked);</span>
<span class="line-removed">2524     thread-&gt;java_suspend_self();</span>
<span class="line-removed">2525     thread-&gt;set_thread_state(state);</span>
<span class="line-removed">2526 </span>
<span class="line-removed">2527     InterfaceSupport::serialize_thread_state_with_handler(thread);</span>
<span class="line-removed">2528   }</span>
<span class="line-removed">2529 </span>
<span class="line-removed">2530   SafepointMechanism::block_if_requested(curJT);</span>
<span class="line-removed">2531 </span>
<span class="line-removed">2532   if (thread-&gt;is_deopt_suspend()) {</span>
<span class="line-removed">2533     thread-&gt;clear_deopt_suspend();</span>
<span class="line-removed">2534     RegisterMap map(thread, false);</span>
<span class="line-removed">2535     frame f = thread-&gt;last_frame();</span>
<span class="line-removed">2536     while (f.id() != thread-&gt;must_deopt_id() &amp;&amp; ! f.is_first_frame()) {</span>
<span class="line-removed">2537       f = f.sender(&amp;map);</span>
<span class="line-removed">2538     }</span>
<span class="line-removed">2539     if (f.id() == thread-&gt;must_deopt_id()) {</span>
<span class="line-removed">2540       thread-&gt;clear_must_deopt_id();</span>
<span class="line-removed">2541       f.deoptimize(thread);</span>
<span class="line-removed">2542     } else {</span>
<span class="line-removed">2543       fatal(&quot;missed deoptimization!&quot;);</span>
<span class="line-removed">2544     }</span>
2545   }
2546 
2547   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2548 }
2549 
2550 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2551 // progress or when _suspend_flags is non-zero.
2552 // Current thread needs to self-suspend if there is a suspend request and/or
2553 // block if a safepoint is in progress.
2554 // Also check for pending async exception (not including unsafe access error).
2555 // Note only the native==&gt;VM/Java barriers can call this function and when
2556 // thread state is _thread_in_native_trans.
2557 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2558   check_safepoint_and_suspend_for_native_trans(thread);
2559 
2560   if (thread-&gt;has_async_exception()) {
2561     // We are in _thread_in_native_trans state, don&#39;t handle unsafe
2562     // access error since that may block.
2563     thread-&gt;check_and_handle_async_exceptions(false);
2564   }
2565 }
2566 
2567 // This is a variant of the normal
2568 // check_special_condition_for_native_trans with slightly different
2569 // semantics for use by critical native wrappers.  It does all the
2570 // normal checks but also performs the transition back into
2571 // thread_in_Java state.  This is required so that critical natives
2572 // can potentially block and perform a GC if they are the last thread
2573 // exiting the GCLocker.
2574 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2575   check_special_condition_for_native_trans(thread);
2576 
2577   // Finish the transition
2578   thread-&gt;set_thread_state(_thread_in_Java);
2579 
2580   if (thread-&gt;do_critical_native_unlock()) {
2581     ThreadInVMfromJavaNoAsyncException tiv(thread);
2582     GCLocker::unlock_critical(thread);
2583     thread-&gt;clear_critical_native_unlock();
2584   }
2585 }
2586 
2587 // We need to guarantee the Threads_lock here, since resumes are not
2588 // allowed during safepoint synchronization
2589 // Can only resume from an external suspension
2590 void JavaThread::java_resume() {
2591   assert_locked_or_safepoint(Threads_lock);
2592 
2593   // Sanity check: thread is gone, has started exiting or the thread
2594   // was not externally suspended.
2595   ThreadsListHandle tlh;
2596   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2597     return;
2598   }
2599 
<a name="95" id="anc95"></a><span class="line-modified">2600   MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
2601 
2602   clear_external_suspend();
2603 
2604   if (is_ext_suspended()) {
2605     clear_ext_suspended();
2606     SR_lock()-&gt;notify_all();
2607   }
2608 }
2609 
2610 size_t JavaThread::_stack_red_zone_size = 0;
2611 size_t JavaThread::_stack_yellow_zone_size = 0;
2612 size_t JavaThread::_stack_reserved_zone_size = 0;
2613 size_t JavaThread::_stack_shadow_zone_size = 0;
2614 
2615 void JavaThread::create_stack_guard_pages() {
2616   if (!os::uses_stack_guard_pages() ||
2617       _stack_guard_state != stack_guard_unused ||
2618       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2619       log_info(os, thread)(&quot;Stack guard page creation for thread &quot;
2620                            UINTX_FORMAT &quot; disabled&quot;, os::current_thread_id());
2621     return;
2622   }
2623   address low_addr = stack_end();
2624   size_t len = stack_guard_zone_size();
2625 
2626   assert(is_aligned(low_addr, os::vm_page_size()), &quot;Stack base should be the start of a page&quot;);
2627   assert(is_aligned(len, os::vm_page_size()), &quot;Stack size should be a multiple of page size&quot;);
2628 
2629   int must_commit = os::must_commit_stack_guard_pages();
2630   // warning(&quot;Guarding at &quot; PTR_FORMAT &quot; for len &quot; SIZE_FORMAT &quot;\n&quot;, low_addr, len);
2631 
2632   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2633     log_warning(os, thread)(&quot;Attempt to allocate stack guard pages failed.&quot;);
2634     return;
2635   }
2636 
2637   if (os::guard_memory((char *) low_addr, len)) {
2638     _stack_guard_state = stack_guard_enabled;
2639   } else {
2640     log_warning(os, thread)(&quot;Attempt to protect stack guard pages failed (&quot;
2641       PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2642     if (os::uncommit_memory((char *) low_addr, len)) {
2643       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed.&quot;);
2644     }
2645     return;
2646   }
2647 
2648   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages activated: &quot;
2649     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2650     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2651 }
2652 
2653 void JavaThread::remove_stack_guard_pages() {
2654   assert(Thread::current() == this, &quot;from different thread&quot;);
2655   if (_stack_guard_state == stack_guard_unused) return;
2656   address low_addr = stack_end();
2657   size_t len = stack_guard_zone_size();
2658 
2659   if (os::must_commit_stack_guard_pages()) {
2660     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2661       _stack_guard_state = stack_guard_unused;
2662     } else {
2663       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed (&quot;
2664         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2665       return;
2666     }
2667   } else {
2668     if (_stack_guard_state == stack_guard_unused) return;
2669     if (os::unguard_memory((char *) low_addr, len)) {
2670       _stack_guard_state = stack_guard_unused;
2671     } else {
2672       log_warning(os, thread)(&quot;Attempt to unprotect stack guard pages failed (&quot;
2673         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2674       return;
2675     }
2676   }
2677 
2678   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages removed: &quot;
2679     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2680     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2681 }
2682 
2683 void JavaThread::enable_stack_reserved_zone() {
2684   assert(_stack_guard_state == stack_guard_reserved_disabled, &quot;inconsistent state&quot;);
2685 
2686   // The base notation is from the stack&#39;s point of view, growing downward.
2687   // We need to adjust it to work correctly with guard_memory()
2688   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2689 
2690   guarantee(base &lt; stack_base(),&quot;Error calculating stack reserved zone&quot;);
2691   guarantee(base &lt; os::current_stack_pointer(),&quot;Error calculating stack reserved zone&quot;);
2692 
2693   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2694     _stack_guard_state = stack_guard_enabled;
2695   } else {
2696     warning(&quot;Attempt to guard stack reserved zone failed.&quot;);
2697   }
2698   enable_register_stack_guard();
2699 }
2700 
2701 void JavaThread::disable_stack_reserved_zone() {
2702   assert(_stack_guard_state == stack_guard_enabled, &quot;inconsistent state&quot;);
2703 
2704   // Simply return if called for a thread that does not use guard pages.
2705   if (_stack_guard_state != stack_guard_enabled) return;
2706 
2707   // The base notation is from the stack&#39;s point of view, growing downward.
2708   // We need to adjust it to work correctly with guard_memory()
2709   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2710 
2711   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2712     _stack_guard_state = stack_guard_reserved_disabled;
2713   } else {
2714     warning(&quot;Attempt to unguard stack reserved zone failed.&quot;);
2715   }
2716   disable_register_stack_guard();
2717 }
2718 
2719 void JavaThread::enable_stack_yellow_reserved_zone() {
2720   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2721   assert(_stack_guard_state != stack_guard_enabled, &quot;already enabled&quot;);
2722 
2723   // The base notation is from the stacks point of view, growing downward.
2724   // We need to adjust it to work correctly with guard_memory()
2725   address base = stack_red_zone_base();
2726 
2727   guarantee(base &lt; stack_base(), &quot;Error calculating stack yellow zone&quot;);
2728   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack yellow zone&quot;);
2729 
2730   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2731     _stack_guard_state = stack_guard_enabled;
2732   } else {
2733     warning(&quot;Attempt to guard stack yellow zone failed.&quot;);
2734   }
2735   enable_register_stack_guard();
2736 }
2737 
2738 void JavaThread::disable_stack_yellow_reserved_zone() {
2739   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2740   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, &quot;already disabled&quot;);
2741 
2742   // Simply return if called for a thread that does not use guard pages.
2743   if (_stack_guard_state == stack_guard_unused) return;
2744 
2745   // The base notation is from the stacks point of view, growing downward.
2746   // We need to adjust it to work correctly with guard_memory()
2747   address base = stack_red_zone_base();
2748 
2749   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2750     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2751   } else {
2752     warning(&quot;Attempt to unguard stack yellow zone failed.&quot;);
2753   }
2754   disable_register_stack_guard();
2755 }
2756 
2757 void JavaThread::enable_stack_red_zone() {
2758   // The base notation is from the stacks point of view, growing downward.
2759   // We need to adjust it to work correctly with guard_memory()
2760   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2761   address base = stack_red_zone_base() - stack_red_zone_size();
2762 
2763   guarantee(base &lt; stack_base(), &quot;Error calculating stack red zone&quot;);
2764   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack red zone&quot;);
2765 
2766   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2767     warning(&quot;Attempt to guard stack red zone failed.&quot;);
2768   }
2769 }
2770 
2771 void JavaThread::disable_stack_red_zone() {
2772   // The base notation is from the stacks point of view, growing downward.
2773   // We need to adjust it to work correctly with guard_memory()
2774   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2775   address base = stack_red_zone_base() - stack_red_zone_size();
2776   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2777     warning(&quot;Attempt to unguard stack red zone failed.&quot;);
2778   }
2779 }
2780 
2781 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2782   // ignore is there is no stack
2783   if (!has_last_Java_frame()) return;
2784   // traverse the stack frames. Starts from top frame.
2785   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2786     frame* fr = fst.current();
2787     f(fr, fst.register_map());
2788   }
2789 }
2790 
2791 
2792 #ifndef PRODUCT
2793 // Deoptimization
2794 // Function for testing deoptimization
2795 void JavaThread::deoptimize() {
<a name="96" id="anc96"></a><span class="line-modified">2796   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass</span>
<span class="line-removed">2797   StackFrameStream fst(this, UseBiasedLocking);</span>
2798   bool deopt = false;           // Dump stack only if a deopt actually happens.
2799   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2800   // Iterate over all frames in the thread and deoptimize
2801   for (; !fst.is_done(); fst.next()) {
2802     if (fst.current()-&gt;can_be_deoptimized()) {
2803 
2804       if (only_at) {
2805         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2806         // consists of comma or carriage return separated numbers so
2807         // search for the current bci in that string.
2808         address pc = fst.current()-&gt;pc();
2809         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2810         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2811         char buffer[8];
2812         jio_snprintf(buffer, sizeof(buffer), &quot;%d&quot;, sd-&gt;bci());
2813         size_t len = strlen(buffer);
2814         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2815         while (found != NULL) {
2816           if ((found[len] == &#39;,&#39; || found[len] == &#39;\n&#39; || found[len] == &#39;\0&#39;) &amp;&amp;
2817               (found == DeoptimizeOnlyAt || found[-1] == &#39;,&#39; || found[-1] == &#39;\n&#39;)) {
2818             // Check that the bci found is bracketed by terminators.
2819             break;
2820           }
2821           found = strstr(found + 1, buffer);
2822         }
2823         if (!found) {
2824           continue;
2825         }
2826       }
2827 
2828       if (DebugDeoptimization &amp;&amp; !deopt) {
2829         deopt = true; // One-time only print before deopt
2830         tty-&gt;print_cr(&quot;[BEFORE Deoptimization]&quot;);
2831         trace_frames();
2832         trace_stack();
2833       }
<a name="97" id="anc97"></a><span class="line-modified">2834       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());</span>
2835     }
2836   }
2837 
2838   if (DebugDeoptimization &amp;&amp; deopt) {
2839     tty-&gt;print_cr(&quot;[AFTER Deoptimization]&quot;);
2840     trace_frames();
2841   }
2842 }
2843 
2844 
2845 // Make zombies
2846 void JavaThread::make_zombies() {
2847   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2848     if (fst.current()-&gt;can_be_deoptimized()) {
2849       // it is a Java nmethod
2850       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2851       nm-&gt;make_not_entrant();
2852     }
2853   }
2854 }
2855 #endif // PRODUCT
2856 
2857 
<a name="98" id="anc98"></a><span class="line-modified">2858 void JavaThread::deoptimized_wrt_marked_nmethods() {</span>
2859   if (!has_last_Java_frame()) return;
<a name="99" id="anc99"></a><span class="line-modified">2860   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass</span>
<span class="line-removed">2861   StackFrameStream fst(this, UseBiasedLocking);</span>
2862   for (; !fst.is_done(); fst.next()) {
2863     if (fst.current()-&gt;should_be_deoptimized()) {
<a name="100" id="anc100"></a><span class="line-modified">2864       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());</span>
2865     }
2866   }
2867 }
2868 
<a name="101" id="anc101"></a><span class="line-removed">2869 </span>
2870 // If the caller is a NamedThread, then remember, in the current scope,
2871 // the given JavaThread in its _processed_thread field.
2872 class RememberProcessedThread: public StackObj {
2873   NamedThread* _cur_thr;
2874  public:
2875   RememberProcessedThread(JavaThread* jthr) {
2876     Thread* thread = Thread::current();
2877     if (thread-&gt;is_Named_thread()) {
2878       _cur_thr = (NamedThread *)thread;
2879       _cur_thr-&gt;set_processed_thread(jthr);
2880     } else {
2881       _cur_thr = NULL;
2882     }
2883   }
2884 
2885   ~RememberProcessedThread() {
2886     if (_cur_thr) {
2887       _cur_thr-&gt;set_processed_thread(NULL);
2888     }
2889   }
2890 };
2891 
2892 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2893   // Verify that the deferred card marks have been flushed.
2894   assert(deferred_card_mark().is_empty(), &quot;Should be empty during GC&quot;);
2895 
2896   // Traverse the GCHandles
2897   Thread::oops_do(f, cf);
2898 
2899   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2900          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), &quot;wrong java_sp info!&quot;);
2901 
2902   if (has_last_Java_frame()) {
2903     // Record JavaThread to GC thread
2904     RememberProcessedThread rpt(this);
2905 
2906     // traverse the registered growable array
2907     if (_array_for_gc != NULL) {
2908       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2909         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2910       }
2911     }
2912 
2913     // Traverse the monitor chunks
2914     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2915       chunk-&gt;oops_do(f);
2916     }
2917 
2918     // Traverse the execution stack
2919     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2920       fst.current()-&gt;oops_do(f, cf, fst.register_map());
2921     }
2922   }
2923 
<a name="102" id="anc102"></a><span class="line-removed">2924   // callee_target is never live across a gc point so NULL it here should</span>
<span class="line-removed">2925   // it still contain a methdOop.</span>
<span class="line-removed">2926 </span>
<span class="line-removed">2927   set_callee_target(NULL);</span>
<span class="line-removed">2928 </span>
2929   assert(vframe_array_head() == NULL, &quot;deopt in progress at a safepoint!&quot;);
2930   // If we have deferred set_locals there might be oops waiting to be
2931   // written
2932   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
2933   if (list != NULL) {
2934     for (int i = 0; i &lt; list-&gt;length(); i++) {
2935       list-&gt;at(i)-&gt;oops_do(f);
2936     }
2937   }
2938 
2939   // Traverse instance variables at the end since the GC may be moving things
2940   // around using this function
2941   f-&gt;do_oop((oop*) &amp;_threadObj);
2942   f-&gt;do_oop((oop*) &amp;_vm_result);
2943   f-&gt;do_oop((oop*) &amp;_exception_oop);
2944   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
2945 
2946   if (jvmti_thread_state() != NULL) {
<a name="103" id="anc103"></a><span class="line-modified">2947     jvmti_thread_state()-&gt;oops_do(f);</span>
2948   }
2949 }
2950 
<a name="104" id="anc104"></a>









2951 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
2952   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
<a name="105" id="anc105"></a><span class="line-modified">2953          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), &quot;wrong java_sp info!&quot;);</span>


2954 
2955   if (has_last_Java_frame()) {
2956     // Traverse the execution stack
2957     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2958       fst.current()-&gt;nmethods_do(cf);
2959     }
2960   }
<a name="106" id="anc106"></a>



2961 }
2962 
<a name="107" id="anc107"></a><span class="line-modified">2963 void JavaThread::metadata_do(void f(Metadata*)) {</span>
2964   if (has_last_Java_frame()) {
2965     // Traverse the execution stack to call f() on the methods in the stack
2966     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2967       fst.current()-&gt;metadata_do(f);
2968     }
2969   } else if (is_Compiler_thread()) {
2970     // need to walk ciMetadata in current compile tasks to keep alive.
2971     CompilerThread* ct = (CompilerThread*)this;
2972     if (ct-&gt;env() != NULL) {
2973       ct-&gt;env()-&gt;metadata_do(f);
2974     }
2975     CompileTask* task = ct-&gt;task();
2976     if (task != NULL) {
2977       task-&gt;metadata_do(f);
2978     }
2979   }
2980 }
2981 
2982 // Printing
2983 const char* _get_thread_state_name(JavaThreadState _thread_state) {
2984   switch (_thread_state) {
2985   case _thread_uninitialized:     return &quot;_thread_uninitialized&quot;;
2986   case _thread_new:               return &quot;_thread_new&quot;;
2987   case _thread_new_trans:         return &quot;_thread_new_trans&quot;;
2988   case _thread_in_native:         return &quot;_thread_in_native&quot;;
2989   case _thread_in_native_trans:   return &quot;_thread_in_native_trans&quot;;
2990   case _thread_in_vm:             return &quot;_thread_in_vm&quot;;
2991   case _thread_in_vm_trans:       return &quot;_thread_in_vm_trans&quot;;
2992   case _thread_in_Java:           return &quot;_thread_in_Java&quot;;
2993   case _thread_in_Java_trans:     return &quot;_thread_in_Java_trans&quot;;
2994   case _thread_blocked:           return &quot;_thread_blocked&quot;;
2995   case _thread_blocked_trans:     return &quot;_thread_blocked_trans&quot;;
2996   default:                        return &quot;unknown thread state&quot;;
2997   }
2998 }
2999 
3000 #ifndef PRODUCT
3001 void JavaThread::print_thread_state_on(outputStream *st) const {
3002   st-&gt;print_cr(&quot;   JavaThread state: %s&quot;, _get_thread_state_name(_thread_state));
3003 };
<a name="108" id="anc108"></a><span class="line-removed">3004 void JavaThread::print_thread_state() const {</span>
<span class="line-removed">3005   print_thread_state_on(tty);</span>
<span class="line-removed">3006 }</span>
3007 #endif // PRODUCT
3008 
3009 // Called by Threads::print() for VM_PrintThreads operation
3010 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
3011   st-&gt;print_raw(&quot;\&quot;&quot;);
3012   st-&gt;print_raw(get_thread_name());
3013   st-&gt;print_raw(&quot;\&quot; &quot;);
3014   oop thread_oop = threadObj();
3015   if (thread_oop != NULL) {
3016     st-&gt;print(&quot;#&quot; INT64_FORMAT &quot; &quot;, (int64_t)java_lang_Thread::thread_id(thread_oop));
3017     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print(&quot;daemon &quot;);
3018     st-&gt;print(&quot;prio=%d &quot;, java_lang_Thread::priority(thread_oop));
3019   }
3020   Thread::print_on(st, print_extended_info);
3021   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
3022   st-&gt;print_cr(&quot;[&quot; INTPTR_FORMAT &quot;]&quot;, (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
3023   if (thread_oop != NULL) {
3024     st-&gt;print_cr(&quot;   java.lang.Thread.State: %s&quot;, java_lang_Thread::thread_status_name(thread_oop));
3025   }
3026 #ifndef PRODUCT
3027   _safepoint_state-&gt;print_on(st);
3028 #endif // PRODUCT
3029   if (is_Compiler_thread()) {
3030     CompileTask *task = ((CompilerThread*)this)-&gt;task();
3031     if (task != NULL) {
3032       st-&gt;print(&quot;   Compiling: &quot;);
3033       task-&gt;print(st, NULL, true, false);
3034     } else {
3035       st-&gt;print(&quot;   No compile task&quot;);
3036     }
3037     st-&gt;cr();
3038   }
3039 }
3040 
<a name="109" id="anc109"></a>

3041 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
3042   st-&gt;print(&quot;%s&quot;, get_thread_name_string(buf, buflen));
3043 }
3044 
3045 // Called by fatal error handler. The difference between this and
3046 // JavaThread::print() is that we can&#39;t grab lock or allocate memory.
3047 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
3048   st-&gt;print(&quot;JavaThread \&quot;%s\&quot;&quot;, get_thread_name_string(buf, buflen));
3049   oop thread_obj = threadObj();
3050   if (thread_obj != NULL) {
3051     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(&quot; daemon&quot;);
3052   }
3053   st-&gt;print(&quot; [&quot;);
3054   st-&gt;print(&quot;%s&quot;, _get_thread_state_name(_thread_state));
3055   if (osthread()) {
3056     st-&gt;print(&quot;, id=%d&quot;, osthread()-&gt;thread_id());
3057   }
3058   st-&gt;print(&quot;, stack(&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;,
3059             p2i(stack_end()), p2i(stack_base()));
3060   st-&gt;print(&quot;]&quot;);
3061 
3062   ThreadsSMRSupport::print_info_on(this, st);
3063   return;
3064 }
3065 
3066 // Verification
3067 
3068 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
3069 
3070 void JavaThread::verify() {
3071   // Verify oops in the thread.
3072   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
3073 
3074   // Verify the stack frames.
3075   frames_do(frame_verify);
3076 }
3077 
3078 // CR 6300358 (sub-CR 2137150)
3079 // Most callers of this method assume that it can&#39;t return NULL but a
3080 // thread may not have a name whilst it is in the process of attaching to
3081 // the VM - see CR 6412693, and there are places where a JavaThread can be
3082 // seen prior to having it&#39;s threadObj set (eg JNI attaching threads and
3083 // if vm exit occurs during initialization). These cases can all be accounted
3084 // for such that this method never returns NULL.
3085 const char* JavaThread::get_thread_name() const {
3086 #ifdef ASSERT
3087   // early safepoints can hit while current thread does not yet have TLS
3088   if (!SafepointSynchronize::is_at_safepoint()) {
3089     Thread *cur = Thread::current();
3090     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3091       // Current JavaThreads are allowed to get their own name without
3092       // the Threads_lock.
<a name="110" id="anc110"></a><span class="line-modified">3093       assert_locked_or_safepoint(Threads_lock);</span>
3094     }
3095   }
3096 #endif // ASSERT
3097   return get_thread_name_string();
3098 }
3099 
3100 // Returns a non-NULL representation of this thread&#39;s name, or a suitable
3101 // descriptive string if there is no set name
3102 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3103   const char* name_str;
3104   oop thread_obj = threadObj();
3105   if (thread_obj != NULL) {
3106     oop name = java_lang_Thread::name(thread_obj);
3107     if (name != NULL) {
3108       if (buf == NULL) {
3109         name_str = java_lang_String::as_utf8_string(name);
3110       } else {
3111         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3112       }
3113     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3114       name_str = &quot;&lt;no-name - thread is attaching&gt;&quot;;
3115     } else {
3116       name_str = Thread::name();
3117     }
3118   } else {
3119     name_str = Thread::name();
3120   }
3121   assert(name_str != NULL, &quot;unexpected NULL thread name&quot;);
3122   return name_str;
3123 }
3124 
<a name="111" id="anc111"></a><span class="line-removed">3125 </span>
<span class="line-removed">3126 const char* JavaThread::get_threadgroup_name() const {</span>
<span class="line-removed">3127   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)</span>
<span class="line-removed">3128   oop thread_obj = threadObj();</span>
<span class="line-removed">3129   if (thread_obj != NULL) {</span>
<span class="line-removed">3130     oop thread_group = java_lang_Thread::threadGroup(thread_obj);</span>
<span class="line-removed">3131     if (thread_group != NULL) {</span>
<span class="line-removed">3132       // ThreadGroup.name can be null</span>
<span class="line-removed">3133       return java_lang_ThreadGroup::name(thread_group);</span>
<span class="line-removed">3134     }</span>
<span class="line-removed">3135   }</span>
<span class="line-removed">3136   return NULL;</span>
<span class="line-removed">3137 }</span>
<span class="line-removed">3138 </span>
<span class="line-removed">3139 const char* JavaThread::get_parent_name() const {</span>
<span class="line-removed">3140   debug_only(if (JavaThread::current() != this) assert_locked_or_safepoint(Threads_lock);)</span>
<span class="line-removed">3141   oop thread_obj = threadObj();</span>
<span class="line-removed">3142   if (thread_obj != NULL) {</span>
<span class="line-removed">3143     oop thread_group = java_lang_Thread::threadGroup(thread_obj);</span>
<span class="line-removed">3144     if (thread_group != NULL) {</span>
<span class="line-removed">3145       oop parent = java_lang_ThreadGroup::parent(thread_group);</span>
<span class="line-removed">3146       if (parent != NULL) {</span>
<span class="line-removed">3147         // ThreadGroup.name can be null</span>
<span class="line-removed">3148         return java_lang_ThreadGroup::name(parent);</span>
<span class="line-removed">3149       }</span>
<span class="line-removed">3150     }</span>
<span class="line-removed">3151   }</span>
<span class="line-removed">3152   return NULL;</span>
<span class="line-removed">3153 }</span>
<span class="line-removed">3154 </span>
<span class="line-removed">3155 ThreadPriority JavaThread::java_priority() const {</span>
<span class="line-removed">3156   oop thr_oop = threadObj();</span>
<span class="line-removed">3157   if (thr_oop == NULL) return NormPriority; // Bootstrapping</span>
<span class="line-removed">3158   ThreadPriority priority = java_lang_Thread::priority(thr_oop);</span>
<span class="line-removed">3159   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, &quot;sanity check&quot;);</span>
<span class="line-removed">3160   return priority;</span>
<span class="line-removed">3161 }</span>
<span class="line-removed">3162 </span>
3163 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3164 
3165   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
<a name="112" id="anc112"></a>
3166   // Link Java Thread object &lt;-&gt; C++ Thread
3167 
3168   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3169   // and put it into a new Handle.  The Handle &quot;thread_oop&quot; can then
3170   // be used to pass the C++ thread object to other methods.
3171 
3172   // Set the Java level thread object (jthread) field of the
3173   // new thread (a JavaThread *) to C++ thread object using the
3174   // &quot;thread_oop&quot; handle.
3175 
3176   // Set the thread field (a JavaThread *) of the
3177   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3178 
3179   Handle thread_oop(Thread::current(),
3180                     JNIHandles::resolve_non_null(jni_thread));
3181   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3182          &quot;must be initialized&quot;);
3183   set_threadObj(thread_oop());
3184   java_lang_Thread::set_thread(thread_oop(), this);
3185 
3186   if (prio == NoPriority) {
3187     prio = java_lang_Thread::priority(thread_oop());
3188     assert(prio != NoPriority, &quot;A valid priority should be present&quot;);
3189   }
3190 
3191   // Push the Java priority down to the native thread; needs Threads_lock
3192   Thread::set_priority(this, prio);
3193 
3194   // Add the new thread to the Threads list and set it in motion.
3195   // We must have threads lock in order to call Threads::add.
3196   // It is crucial that we do not block before the thread is
3197   // added to the Threads list for if a GC happens, then the java_thread oop
3198   // will not be visited by GC.
3199   Threads::add(this);
3200 }
3201 
3202 oop JavaThread::current_park_blocker() {
3203   // Support for JSR-166 locks
3204   oop thread_oop = threadObj();
<a name="113" id="anc113"></a><span class="line-modified">3205   if (thread_oop != NULL &amp;&amp;</span>
<span class="line-removed">3206       JDK_Version::current().supports_thread_park_blocker()) {</span>
3207     return java_lang_Thread::park_blocker(thread_oop);
3208   }
3209   return NULL;
3210 }
3211 
3212 
3213 void JavaThread::print_stack_on(outputStream* st) {
3214   if (!has_last_Java_frame()) return;
3215   ResourceMark rm;
3216   HandleMark   hm;
3217 
3218   RegisterMap reg_map(this);
3219   vframe* start_vf = last_java_vframe(&amp;reg_map);
3220   int count = 0;
3221   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3222     if (f-&gt;is_java_frame()) {
3223       javaVFrame* jvf = javaVFrame::cast(f);
3224       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3225 
3226       // Print out lock information
3227       if (JavaMonitorsInStackTrace) {
3228         jvf-&gt;print_lock_info_on(st, count);
3229       }
3230     } else {
3231       // Ignore non-Java frames
3232     }
3233 
3234     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3235     count++;
3236     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3237   }
3238 }
3239 
3240 
3241 // JVMTI PopFrame support
3242 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3243   assert(_popframe_preserved_args == NULL, &quot;should not wipe out old PopFrame preserved arguments&quot;);
3244   if (in_bytes(size_in_bytes) != 0) {
3245     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3246     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3247     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3248   }
3249 }
3250 
3251 void* JavaThread::popframe_preserved_args() {
3252   return _popframe_preserved_args;
3253 }
3254 
3255 ByteSize JavaThread::popframe_preserved_args_size() {
3256   return in_ByteSize(_popframe_preserved_args_size);
3257 }
3258 
3259 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3260   int sz = in_bytes(popframe_preserved_args_size());
3261   assert(sz % wordSize == 0, &quot;argument size must be multiple of wordSize&quot;);
3262   return in_WordSize(sz / wordSize);
3263 }
3264 
3265 void JavaThread::popframe_free_preserved_args() {
3266   assert(_popframe_preserved_args != NULL, &quot;should not free PopFrame preserved arguments twice&quot;);
<a name="114" id="anc114"></a><span class="line-modified">3267   FREE_C_HEAP_ARRAY(char, (char*) _popframe_preserved_args);</span>
3268   _popframe_preserved_args = NULL;
3269   _popframe_preserved_args_size = 0;
3270 }
3271 
3272 #ifndef PRODUCT
3273 
3274 void JavaThread::trace_frames() {
3275   tty-&gt;print_cr(&quot;[Describe stack]&quot;);
3276   int frame_no = 1;
3277   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3278     tty-&gt;print(&quot;  %d. &quot;, frame_no++);
3279     fst.current()-&gt;print_value_on(tty, this);
3280     tty-&gt;cr();
3281   }
3282 }
3283 
3284 class PrintAndVerifyOopClosure: public OopClosure {
3285  protected:
3286   template &lt;class T&gt; inline void do_oop_work(T* p) {
3287     oop obj = RawAccess&lt;&gt;::oop_load(p);
3288     if (obj == NULL) return;
3289     tty-&gt;print(INTPTR_FORMAT &quot;: &quot;, p2i(p));
3290     if (oopDesc::is_oop_or_null(obj)) {
3291       if (obj-&gt;is_objArray()) {
3292         tty-&gt;print_cr(&quot;valid objArray: &quot; INTPTR_FORMAT, p2i(obj));
3293       } else {
3294         obj-&gt;print();
3295       }
3296     } else {
3297       tty-&gt;print_cr(&quot;invalid oop: &quot; INTPTR_FORMAT, p2i(obj));
3298     }
3299     tty-&gt;cr();
3300   }
3301  public:
3302   virtual void do_oop(oop* p) { do_oop_work(p); }
3303   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3304 };
3305 
<a name="115" id="anc115"></a><span class="line-removed">3306 </span>
<span class="line-removed">3307 static void oops_print(frame* f, const RegisterMap *map) {</span>
<span class="line-removed">3308   PrintAndVerifyOopClosure print;</span>
<span class="line-removed">3309   f-&gt;print_value();</span>
<span class="line-removed">3310   f-&gt;oops_do(&amp;print, NULL, (RegisterMap*)map);</span>
<span class="line-removed">3311 }</span>
<span class="line-removed">3312 </span>
<span class="line-removed">3313 // Print our all the locations that contain oops and whether they are</span>
<span class="line-removed">3314 // valid or not.  This useful when trying to find the oldest frame</span>
<span class="line-removed">3315 // where an oop has gone bad since the frame walk is from youngest to</span>
<span class="line-removed">3316 // oldest.</span>
<span class="line-removed">3317 void JavaThread::trace_oops() {</span>
<span class="line-removed">3318   tty-&gt;print_cr(&quot;[Trace oops]&quot;);</span>
<span class="line-removed">3319   frames_do(oops_print);</span>
<span class="line-removed">3320 }</span>
<span class="line-removed">3321 </span>
<span class="line-removed">3322 </span>
3323 #ifdef ASSERT
3324 // Print or validate the layout of stack frames
3325 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3326   ResourceMark rm;
3327   PRESERVE_EXCEPTION_MARK;
3328   FrameValues values;
3329   int frame_no = 0;
3330   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3331     fst.current()-&gt;describe(values, ++frame_no);
3332     if (depth == frame_no) break;
3333   }
3334   if (validate_only) {
3335     values.validate();
3336   } else {
3337     tty-&gt;print_cr(&quot;[Describe stack layout]&quot;);
3338     values.print(this);
3339   }
3340 }
3341 #endif
3342 
3343 void JavaThread::trace_stack_from(vframe* start_vf) {
3344   ResourceMark rm;
3345   int vframe_no = 1;
3346   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3347     if (f-&gt;is_java_frame()) {
3348       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3349     } else {
3350       f-&gt;print();
3351     }
3352     if (vframe_no &gt; StackPrintLimit) {
3353       tty-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
3354       return;
3355     }
3356   }
3357 }
3358 
3359 
3360 void JavaThread::trace_stack() {
3361   if (!has_last_Java_frame()) return;
3362   ResourceMark rm;
3363   HandleMark   hm;
3364   RegisterMap reg_map(this);
3365   trace_stack_from(last_java_vframe(&amp;reg_map));
3366 }
3367 
3368 
3369 #endif // PRODUCT
3370 
3371 
3372 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3373   assert(reg_map != NULL, &quot;a map must be given&quot;);
3374   frame f = last_frame();
3375   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3376     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3377   }
3378   return NULL;
3379 }
3380 
3381 
3382 Klass* JavaThread::security_get_caller_class(int depth) {
3383   vframeStream vfst(this);
3384   vfst.security_get_caller_frame(depth);
3385   if (!vfst.at_end()) {
3386     return vfst.method()-&gt;method_holder();
3387   }
3388   return NULL;
3389 }
3390 
<a name="116" id="anc116"></a>























































3391 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3392   assert(thread-&gt;is_Compiler_thread(), &quot;must be compiler thread&quot;);
3393   CompileBroker::compiler_thread_loop();
3394 }
3395 
3396 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3397   NMethodSweeper::sweeper_loop();
3398 }
3399 
3400 // Create a CompilerThread
3401 CompilerThread::CompilerThread(CompileQueue* queue,
3402                                CompilerCounters* counters)
3403                                : JavaThread(&amp;compiler_thread_entry) {
3404   _env   = NULL;
3405   _log   = NULL;
3406   _task  = NULL;
3407   _queue = queue;
3408   _counters = counters;
3409   _buffer_blob = NULL;
3410   _compiler = NULL;
3411 
3412   // Compiler uses resource area for compilation, let&#39;s bias it to mtCompiler
3413   resource_area()-&gt;bias_to(mtCompiler);
3414 
3415 #ifndef PRODUCT
3416   _ideal_graph_printer = NULL;
3417 #endif
3418 }
3419 
3420 CompilerThread::~CompilerThread() {
3421   // Delete objects which were allocated on heap.
3422   delete _counters;
3423 }
3424 
3425 bool CompilerThread::can_call_java() const {
3426   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3427 }
3428 
3429 // Create sweeper thread
3430 CodeCacheSweeperThread::CodeCacheSweeperThread()
3431 : JavaThread(&amp;sweeper_thread_entry) {
3432   _scanned_compiled_method = NULL;
3433 }
3434 
3435 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3436   JavaThread::oops_do(f, cf);
3437   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3438     // Safepoints can occur when the sweeper is scanning an nmethod so
3439     // process it here to make sure it isn&#39;t unloaded in the middle of
3440     // a scan.
3441     cf-&gt;do_code_blob(_scanned_compiled_method);
3442   }
3443 }
3444 
3445 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3446   JavaThread::nmethods_do(cf);
3447   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3448     // Safepoints can occur when the sweeper is scanning an nmethod so
3449     // process it here to make sure it isn&#39;t unloaded in the middle of
3450     // a scan.
3451     cf-&gt;do_code_blob(_scanned_compiled_method);
3452   }
3453 }
3454 
3455 
3456 // ======= Threads ========
3457 
3458 // The Threads class links together all active threads, and provides
3459 // operations over all threads. It is protected by the Threads_lock,
3460 // which is also used in other global contexts like safepointing.
3461 // ThreadsListHandles are used to safely perform operations on one
3462 // or more threads without the risk of the thread exiting during the
3463 // operation.
3464 //
3465 // Note: The Threads_lock is currently more widely used than we
3466 // would like. We are actively migrating Threads_lock uses to other
3467 // mechanisms in order to reduce Threads_lock contention.
3468 
<a name="117" id="anc117"></a><span class="line-removed">3469 JavaThread* Threads::_thread_list = NULL;</span>
3470 int         Threads::_number_of_threads = 0;
3471 int         Threads::_number_of_non_daemon_threads = 0;
3472 int         Threads::_return_code = 0;
<a name="118" id="anc118"></a><span class="line-modified">3473 int         Threads::_thread_claim_parity = 0;</span>
3474 size_t      JavaThread::_stack_size_at_create = 0;
3475 
3476 #ifdef ASSERT
3477 bool        Threads::_vm_complete = false;
3478 #endif
3479 
3480 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3481   Prefetch::read((void*)addr, prefetch_interval);
3482   return *addr;
3483 }
3484 
3485 // Possibly the ugliest for loop the world has seen. C++ does not allow
3486 // multiple types in the declaration section of the for loop. In this case
3487 // we are only dealing with pointers and hence can cast them. It looks ugly
3488 // but macros are ugly and therefore it&#39;s fine to make things absurdly ugly.
3489 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3490     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3491              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3492              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3493              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3494              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3495          MACRO_current_p != MACRO_end;                                                                                    \
3496          MACRO_current_p++,                                                                                               \
3497              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3498 
3499 // All JavaThreads
3500 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3501 
3502 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3503 void Threads::non_java_threads_do(ThreadClosure* tc) {
<a name="119" id="anc119"></a><span class="line-modified">3504   NoSafepointVerifier nsv(!SafepointSynchronize::is_at_safepoint(), false);</span>
3505   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3506     tc-&gt;do_thread(njti.current());
3507   }
3508 }
3509 
3510 // All JavaThreads
3511 void Threads::java_threads_do(ThreadClosure* tc) {
3512   assert_locked_or_safepoint(Threads_lock);
3513   // ALL_JAVA_THREADS iterates through all JavaThreads.
3514   ALL_JAVA_THREADS(p) {
3515     tc-&gt;do_thread(p);
3516   }
3517 }
3518 
3519 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3520   assert_locked_or_safepoint(Threads_lock);
3521   java_threads_do(tc);
3522   tc-&gt;do_thread(VMThread::vm_thread());
3523 }
3524 
3525 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3526 void Threads::threads_do(ThreadClosure* tc) {
3527   assert_locked_or_safepoint(Threads_lock);
3528   java_threads_do(tc);
3529   non_java_threads_do(tc);
3530 }
3531 
3532 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
<a name="120" id="anc120"></a><span class="line-modified">3533   int cp = Threads::thread_claim_parity();</span>
3534   ALL_JAVA_THREADS(p) {
<a name="121" id="anc121"></a><span class="line-modified">3535     if (p-&gt;claim_oops_do(is_par, cp)) {</span>
3536       tc-&gt;do_thread(p);
3537     }
3538   }
3539   VMThread* vmt = VMThread::vm_thread();
<a name="122" id="anc122"></a><span class="line-modified">3540   if (vmt-&gt;claim_oops_do(is_par, cp)) {</span>
3541     tc-&gt;do_thread(vmt);
3542   }
3543 }
3544 
3545 // The system initialization in the library has three phases.
3546 //
3547 // Phase 1: java.lang.System class initialization
3548 //     java.lang.System is a primordial class loaded and initialized
3549 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3550 //     only does registerNatives and keeps the rest of the class
3551 //     initialization work later until thread initialization completes.
3552 //
3553 //     System.initPhase1 initializes the system properties, the static
3554 //     fields in, out, and err. Set up java signal handlers, OS-specific
3555 //     system settings, and thread group of the main thread.
3556 static void call_initPhase1(TRAPS) {
3557   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3558   JavaValue result(T_VOID);
3559   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3560                                          vmSymbols::void_method_signature(), CHECK);
3561 }
3562 
3563 // Phase 2. Module system initialization
3564 //     This will initialize the module system.  Only java.base classes
3565 //     can be loaded until phase 2 completes.
3566 //
3567 //     Call System.initPhase2 after the compiler initialization and jsr292
3568 //     classes get initialized because module initialization runs a lot of java
3569 //     code, that for performance reasons, should be compiled.  Also, this will
3570 //     enable the startup code to use lambda and other language features in this
3571 //     phase and onward.
3572 //
3573 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3574 static void call_initPhase2(TRAPS) {
3575   TraceTime timer(&quot;Initialize module system&quot;, TRACETIME_LOG(Info, startuptime));
3576 
3577   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3578 
3579   JavaValue result(T_INT);
3580   JavaCallArguments args;
3581   args.push_int(DisplayVMOutputToStderr);
3582   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3583   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3584                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3585   if (result.get_jint() != JNI_OK) {
3586     vm_exit_during_initialization(); // no message or exception
3587   }
3588 
3589   universe_post_module_init();
3590 }
3591 
3592 // Phase 3. final setup - set security manager, system class loader and TCCL
3593 //
3594 //     This will instantiate and set the security manager, set the system class
3595 //     loader as well as the thread context class loader.  The security manager
3596 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3597 //     other modules or the application&#39;s classpath.
3598 static void call_initPhase3(TRAPS) {
3599   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3600   JavaValue result(T_VOID);
3601   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3602                                          vmSymbols::void_method_signature(), CHECK);
3603 }
3604 
3605 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3606   TraceTime timer(&quot;Initialize java.lang classes&quot;, TRACETIME_LOG(Info, startuptime));
3607 
3608   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3609     create_vm_init_libraries();
3610   }
3611 
3612   initialize_class(vmSymbols::java_lang_String(), CHECK);
3613 
3614   // Inject CompactStrings value after the static initializers for String ran.
3615   java_lang_String::set_compact_strings(CompactStrings);
3616 
3617   // Initialize java_lang.System (needed before creating the thread)
3618   initialize_class(vmSymbols::java_lang_System(), CHECK);
3619   // The VM creates &amp; returns objects of this class. Make sure it&#39;s initialized.
3620   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3621   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3622   Handle thread_group = create_initial_thread_group(CHECK);
3623   Universe::set_main_thread_group(thread_group());
3624   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3625   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3626   main_thread-&gt;set_threadObj(thread_object);
<a name="123" id="anc123"></a>
3627   // Set thread status to running since main thread has
3628   // been started and running.
3629   java_lang_Thread::set_thread_status(thread_object,
3630                                       java_lang_Thread::RUNNABLE);
3631 
3632   // The VM creates objects of this class.
3633   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3634 
<a name="124" id="anc124"></a>








3635   // The VM preresolves methods to these classes. Make sure that they get initialized
3636   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3637   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3638 
3639   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3640   call_initPhase1(CHECK);
3641 
<a name="125" id="anc125"></a><span class="line-modified">3642   // get the Java runtime name after java.lang.System is initialized</span>
3643   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3644   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
<a name="126" id="anc126"></a>

3645 
3646   // an instance of OutOfMemory exception has been allocated earlier
3647   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3648   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3649   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3650   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3651   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3652   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3653   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3654   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
<a name="127" id="anc127"></a>


3655 }
3656 
3657 void Threads::initialize_jsr292_core_classes(TRAPS) {
3658   TraceTime timer(&quot;Initialize java.lang.invoke classes&quot;, TRACETIME_LOG(Info, startuptime));
3659 
3660   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3661   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3662   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3663   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3664 }
3665 
3666 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3667   extern void JDK_Version_init();
3668 
3669   // Preinitialize version info.
3670   VM_Version::early_initialize();
3671 
3672   // Check version
3673   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3674 
3675   // Initialize library-based TLS
3676   ThreadLocalStorage::init();
3677 
3678   // Initialize the output stream module
3679   ostream_init();
3680 
3681   // Process java launcher properties.
3682   Arguments::process_sun_java_launcher_properties(args);
3683 
3684   // Initialize the os module
3685   os::init();
3686 
3687   // Record VM creation timing statistics
3688   TraceVmCreationTime create_vm_timer;
3689   create_vm_timer.start();
3690 
3691   // Initialize system properties.
3692   Arguments::init_system_properties();
3693 
3694   // So that JDK version can be used as a discriminator when parsing arguments
3695   JDK_Version_init();
3696 
3697   // Update/Initialize System properties after JDK version number is known
3698   Arguments::init_version_specific_system_properties();
3699 
3700   // Make sure to initialize log configuration *before* parsing arguments
3701   LogConfiguration::initialize(create_vm_timer.begin_time());
3702 
3703   // Parse arguments
3704   // Note: this internally calls os::init_container_support()
3705   jint parse_result = Arguments::parse(args);
3706   if (parse_result != JNI_OK) return parse_result;
3707 
3708   os::init_before_ergo();
3709 
3710   jint ergo_result = Arguments::apply_ergo();
3711   if (ergo_result != JNI_OK) return ergo_result;
3712 
3713   // Final check of all ranges after ergonomics which may change values.
3714   if (!JVMFlagRangeList::check_ranges()) {
3715     return JNI_EINVAL;
3716   }
3717 
3718   // Final check of all &#39;AfterErgo&#39; constraints after ergonomics which may change values.
3719   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3720   if (!constraint_result) {
3721     return JNI_EINVAL;
3722   }
3723 
<a name="128" id="anc128"></a><span class="line-removed">3724   JVMFlagWriteableList::mark_startup();</span>
<span class="line-removed">3725 </span>
3726   if (PauseAtStartup) {
3727     os::pause();
3728   }
3729 
3730   HOTSPOT_VM_INIT_BEGIN();
3731 
3732   // Timing (must come after argument parsing)
3733   TraceTime timer(&quot;Create VM&quot;, TRACETIME_LOG(Info, startuptime));
3734 
3735   // Initialize the os module after parsing the args
3736   jint os_init_2_result = os::init_2();
3737   if (os_init_2_result != JNI_OK) return os_init_2_result;
3738 
3739 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3740   // Initialize assert poison page mechanism.
3741   if (ShowRegistersOnAssert) {
3742     initialize_assert_poison();
3743   }
3744 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3745 
3746   SafepointMechanism::initialize();
3747 
3748   jint adjust_after_os_result = Arguments::adjust_after_os();
3749   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3750 
3751   // Initialize output stream logging
3752   ostream_init_log();
3753 
3754   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3755   // Must be before create_vm_init_agents()
3756   if (Arguments::init_libraries_at_startup()) {
3757     convert_vm_init_libraries_to_agents();
3758   }
3759 
3760   // Launch -agentlib/-agentpath and converted -Xrun agents
3761   if (Arguments::init_agents_at_startup()) {
3762     create_vm_init_agents();
3763   }
3764 
3765   // Initialize Threads state
<a name="129" id="anc129"></a><span class="line-removed">3766   _thread_list = NULL;</span>
3767   _number_of_threads = 0;
3768   _number_of_non_daemon_threads = 0;
3769 
3770   // Initialize global data structures and create system classes in heap
3771   vm_init_globals();
3772 
3773 #if INCLUDE_JVMCI
3774   if (JVMCICounterSize &gt; 0) {
<a name="130" id="anc130"></a><span class="line-modified">3775     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtInternal);</span>
3776     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3777   } else {
3778     JavaThread::_jvmci_old_thread_counters = NULL;
3779   }
3780 #endif // INCLUDE_JVMCI
3781 
3782   // Attach the main thread to this os thread
3783   JavaThread* main_thread = new JavaThread();
3784   main_thread-&gt;set_thread_state(_thread_in_vm);
3785   main_thread-&gt;initialize_thread_current();
3786   // must do this before set_active_handles
3787   main_thread-&gt;record_stack_base_and_size();
3788   main_thread-&gt;register_thread_stack_with_NMT();
3789   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3790 
3791   if (!main_thread-&gt;set_as_starting_thread()) {
3792     vm_shutdown_during_initialization(
3793                                       &quot;Failed necessary internal allocation. Out of swap space&quot;);
3794     main_thread-&gt;smr_delete();
3795     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3796     return JNI_ENOMEM;
3797   }
3798 
3799   // Enable guard page *after* os::create_main_thread(), otherwise it would
3800   // crash Linux VM, see notes in os_linux.cpp.
3801   main_thread-&gt;create_stack_guard_pages();
3802 
3803   // Initialize Java-Level synchronization subsystem
3804   ObjectMonitor::Initialize();
3805 
3806   // Initialize global modules
3807   jint status = init_globals();
3808   if (status != JNI_OK) {
3809     main_thread-&gt;smr_delete();
3810     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3811     return status;
3812   }
3813 
<a name="131" id="anc131"></a><span class="line-modified">3814   JFR_ONLY(Jfr::on_vm_init();)</span>
3815 
3816   // Should be done after the heap is fully created
3817   main_thread-&gt;cache_global_variables();
3818 
3819   HandleMark hm;
3820 
3821   { MutexLocker mu(Threads_lock);
3822     Threads::add(main_thread);
3823   }
3824 
3825   // Any JVMTI raw monitors entered in onload will transition into
3826   // real raw monitor. VM is setup enough here for raw monitor enter.
3827   JvmtiExport::transition_pending_onload_raw_monitors();
3828 
3829   // Create the VMThread
3830   { TraceTime timer(&quot;Start VMThread&quot;, TRACETIME_LOG(Info, startuptime));
3831 
<a name="132" id="anc132"></a><span class="line-modified">3832   VMThread::create();</span>
3833     Thread* vmthread = VMThread::vm_thread();
3834 
3835     if (!os::create_thread(vmthread, os::vm_thread)) {
3836       vm_exit_during_initialization(&quot;Cannot create VM thread. &quot;
3837                                     &quot;Out of system resources.&quot;);
3838     }
3839 
3840     // Wait for the VM thread to become ready, and VMThread::run to initialize
3841     // Monitors can have spurious returns, must always check another state flag
3842     {
<a name="133" id="anc133"></a><span class="line-modified">3843       MutexLocker ml(Notify_lock);</span>
3844       os::start_thread(vmthread);
3845       while (vmthread-&gt;active_handles() == NULL) {
<a name="134" id="anc134"></a><span class="line-modified">3846         Notify_lock-&gt;wait();</span>
3847       }
3848     }
3849   }
3850 
3851   assert(Universe::is_fully_initialized(), &quot;not initialized&quot;);
3852   if (VerifyDuringStartup) {
3853     // Make sure we&#39;re starting with a clean slate.
3854     VM_Verify verify_op;
3855     VMThread::execute(&amp;verify_op);
3856   }
3857 
3858   // We need this to update the java.vm.info property in case any flags used
3859   // to initially define it have been changed. This is needed for both CDS and
3860   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3861   // is initially computed. See Abstract_VM_Version::vm_info_string().
3862   // This update must happen before we initialize the java classes, but
3863   // after any initialization logic that might modify the flags.
3864   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3865 
3866   Thread* THREAD = Thread::current();
3867 
3868   // Always call even when there are not JVMTI environments yet, since environments
3869   // may be attached late and JVMTI must track phases of VM execution
3870   JvmtiExport::enter_early_start_phase();
3871 
3872   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3873   JvmtiExport::post_early_vm_start();
3874 
3875   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3876 
3877   quicken_jni_functions();
3878 
3879   // No more stub generation allowed after that point.
3880   StubCodeDesc::freeze();
3881 
3882   // Set flag that basic initialization has completed. Used by exceptions and various
3883   // debug stuff, that does not work until all basic classes have been initialized.
3884   set_init_completed();
3885 
3886   LogConfiguration::post_initialize();
3887   Metaspace::post_initialize();
3888 
3889   HOTSPOT_VM_INIT_END();
3890 
3891   // record VM initialization completion time
3892 #if INCLUDE_MANAGEMENT
3893   Management::record_vm_init_completed();
3894 #endif // INCLUDE_MANAGEMENT
3895 
3896   // Signal Dispatcher needs to be started before VMInit event is posted
3897   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
3898 
3899   // Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily
3900   if (!DisableAttachMechanism) {
3901     AttachListener::vm_start();
3902     if (StartAttachListener || AttachListener::init_at_startup()) {
3903       AttachListener::init();
3904     }
3905   }
3906 
3907   // Launch -Xrun agents
3908   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
3909   // back-end can launch with -Xdebug -Xrunjdwp.
3910   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3911     create_vm_init_libraries();
3912   }
3913 
3914   if (CleanChunkPoolAsync) {
3915     Chunk::start_chunk_pool_cleaner_task();
3916   }
3917 
<a name="135" id="anc135"></a>




3918   // initialize compiler(s)
3919 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
3920 #if INCLUDE_JVMCI
3921   bool force_JVMCI_intialization = false;
3922   if (EnableJVMCI) {
3923     // Initialize JVMCI eagerly when it is explicitly requested.
<a name="136" id="anc136"></a><span class="line-modified">3924     // Or when JVMCIPrintProperties is enabled.</span>
<span class="line-modified">3925     // The JVMCI Java initialization code will read this flag and</span>
<span class="line-removed">3926     // do the printing if it&#39;s set.</span>
<span class="line-removed">3927     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties;</span>
3928 
3929     if (!force_JVMCI_intialization) {
3930       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
3931       // compilations via JVMCI will not actually block until JVMCI is initialized.
3932       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
3933     }
3934   }
3935 #endif
3936   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
3937   // Postpone completion of compiler initialization to after JVMCI
3938   // is initialized to avoid timeouts of blocking compilations.
3939   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
3940     CompileBroker::compilation_init_phase2();
3941   }
3942 #endif
3943 
3944   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
3945   // It is done after compilers are initialized, because otherwise compilations of
3946   // signature polymorphic MH intrinsics can be missed
3947   // (see SystemDictionary::find_method_handle_intrinsic).
3948   initialize_jsr292_core_classes(CHECK_JNI_ERR);
3949 
3950   // This will initialize the module system.  Only java.base classes can be
3951   // loaded until phase 2 completes
3952   call_initPhase2(CHECK_JNI_ERR);
3953 
<a name="137" id="anc137"></a>

3954   // Always call even when there are not JVMTI environments yet, since environments
3955   // may be attached late and JVMTI must track phases of VM execution
3956   JvmtiExport::enter_start_phase();
3957 
3958   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3959   JvmtiExport::post_vm_start();
3960 
3961   // Final system initialization including security manager and system class loader
3962   call_initPhase3(CHECK_JNI_ERR);
3963 
3964   // cache the system and platform class loaders
3965   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
3966 
3967 #if INCLUDE_CDS
<a name="138" id="anc138"></a><span class="line-modified">3968   if (DumpSharedSpaces) {</span>
<span class="line-modified">3969     // capture the module path info from the ModuleEntryTable</span>
<span class="line-removed">3970     ClassLoader::initialize_module_path(THREAD);</span>
<span class="line-removed">3971   }</span>
3972 #endif
3973 
3974 #if INCLUDE_JVMCI
3975   if (force_JVMCI_intialization) {
<a name="139" id="anc139"></a><span class="line-modified">3976     JVMCIRuntime::force_initialization(CHECK_JNI_ERR);</span>
3977     CompileBroker::compilation_init_phase2();
3978   }
3979 #endif
3980 
3981   // Always call even when there are not JVMTI environments yet, since environments
3982   // may be attached late and JVMTI must track phases of VM execution
3983   JvmtiExport::enter_live_phase();
3984 
3985   // Make perfmemory accessible
3986   PerfMemory::set_accessible(true);
3987 
3988   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
3989   JvmtiExport::post_vm_initialized();
3990 
<a name="140" id="anc140"></a><span class="line-modified">3991   JFR_ONLY(Jfr::on_vm_start();)</span>
3992 
3993 #if INCLUDE_MANAGEMENT
3994   Management::initialize(THREAD);
3995 
3996   if (HAS_PENDING_EXCEPTION) {
3997     // management agent fails to start possibly due to
3998     // configuration problem and is responsible for printing
3999     // stack trace if appropriate. Simply exit VM.
4000     vm_exit(1);
4001   }
4002 #endif // INCLUDE_MANAGEMENT
4003 
4004   if (MemProfiling)                   MemProfiler::engage();
4005   StatSampler::engage();
4006   if (CheckJNICalls)                  JniPeriodicChecker::engage();
4007 
4008   BiasedLocking::init();
4009 
4010 #if INCLUDE_RTM_OPT
4011   RTMLockingCounters::init();
4012 #endif
4013 
<a name="141" id="anc141"></a><span class="line-modified">4014   if (JDK_Version::current().post_vm_init_hook_enabled()) {</span>
<span class="line-modified">4015     call_postVMInitHook(THREAD);</span>
<span class="line-modified">4016     // The Java side of PostVMInitHook.run must deal with all</span>
<span class="line-modified">4017     // exceptions and provide means of diagnosis.</span>
<span class="line-modified">4018     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-removed">4019       CLEAR_PENDING_EXCEPTION;</span>
<span class="line-removed">4020     }</span>
4021   }
4022 
4023   {
4024     MutexLocker ml(PeriodicTask_lock);
4025     // Make sure the WatcherThread can be started by WatcherThread::start()
4026     // or by dynamic enrollment.
4027     WatcherThread::make_startable();
4028     // Start up the WatcherThread if there are any periodic tasks
4029     // NOTE:  All PeriodicTasks should be registered by now. If they
4030     //   aren&#39;t, late joiners might appear to start slowly (we might
4031     //   take a while to process their first tick).
4032     if (PeriodicTask::num_tasks() &gt; 0) {
4033       WatcherThread::start();
4034     }
4035   }
4036 
4037   create_vm_timer.end();
4038 #ifdef ASSERT
4039   _vm_complete = true;
4040 #endif
4041 
4042   if (DumpSharedSpaces) {
4043     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
4044     ShouldNotReachHere();
4045   }
4046 
4047   return JNI_OK;
4048 }
4049 
4050 // type for the Agent_OnLoad and JVM_OnLoad entry points
4051 extern &quot;C&quot; {
4052   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
4053 }
4054 // Find a command line agent library and return its entry point for
4055 //         -agentlib:  -agentpath:   -Xrun
4056 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
4057 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
4058                                     const char *on_load_symbols[],
4059                                     size_t num_symbol_entries) {
4060   OnLoadEntry_t on_load_entry = NULL;
4061   void *library = NULL;
4062 
4063   if (!agent-&gt;valid()) {
4064     char buffer[JVM_MAXPATHLEN];
4065     char ebuf[1024] = &quot;&quot;;
4066     const char *name = agent-&gt;name();
4067     const char *msg = &quot;Could not find agent library &quot;;
4068 
4069     // First check to see if agent is statically linked into executable
4070     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
4071       library = agent-&gt;os_lib();
4072     } else if (agent-&gt;is_absolute_path()) {
4073       library = os::dll_load(name, ebuf, sizeof ebuf);
4074       if (library == NULL) {
4075         const char *sub_msg = &quot; in absolute path, with error: &quot;;
4076         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
4077         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4078         jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4079         // If we can&#39;t find the agent, exit.
4080         vm_exit_during_initialization(buf, NULL);
4081         FREE_C_HEAP_ARRAY(char, buf);
4082       }
4083     } else {
4084       // Try to load the agent from the standard dll directory
4085       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4086                              name)) {
4087         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4088       }
4089       if (library == NULL) { // Try the library path directory.
4090         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4091           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4092         }
4093         if (library == NULL) {
4094           const char *sub_msg = &quot; on the library path, with error: &quot;;
4095           const char *sub_msg2 = &quot;\nModule java.instrument may be missing from runtime image.&quot;;
4096 
4097           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4098                        strlen(ebuf) + strlen(sub_msg2) + 1;
4099           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4100           if (!agent-&gt;is_instrument_lib()) {
4101             jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4102           } else {
4103             jio_snprintf(buf, len, &quot;%s%s%s%s%s&quot;, msg, name, sub_msg, ebuf, sub_msg2);
4104           }
4105           // If we can&#39;t find the agent, exit.
4106           vm_exit_during_initialization(buf, NULL);
4107           FREE_C_HEAP_ARRAY(char, buf);
4108         }
4109       }
4110     }
4111     agent-&gt;set_os_lib(library);
4112     agent-&gt;set_valid();
4113   }
4114 
4115   // Find the OnLoad function.
4116   on_load_entry =
4117     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4118                                                           false,
4119                                                           on_load_symbols,
4120                                                           num_symbol_entries));
4121   return on_load_entry;
4122 }
4123 
4124 // Find the JVM_OnLoad entry point
4125 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4126   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4127   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4128 }
4129 
4130 // Find the Agent_OnLoad entry point
4131 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4132   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4133   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4134 }
4135 
4136 // For backwards compatibility with -Xrun
4137 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4138 // treated like -agentpath:
4139 // Must be called before agent libraries are created
4140 void Threads::convert_vm_init_libraries_to_agents() {
4141   AgentLibrary* agent;
4142   AgentLibrary* next;
4143 
4144   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4145     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4146     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4147 
4148     // If there is an JVM_OnLoad function it will get called later,
4149     // otherwise see if there is an Agent_OnLoad
4150     if (on_load_entry == NULL) {
4151       on_load_entry = lookup_agent_on_load(agent);
4152       if (on_load_entry != NULL) {
4153         // switch it to the agent list -- so that Agent_OnLoad will be called,
4154         // JVM_OnLoad won&#39;t be attempted and Agent_OnUnload will
4155         Arguments::convert_library_to_agent(agent);
4156       } else {
4157         vm_exit_during_initialization(&quot;Could not find JVM_OnLoad or Agent_OnLoad function in the library&quot;, agent-&gt;name());
4158       }
4159     }
4160   }
4161 }
4162 
4163 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4164 // Invokes Agent_OnLoad
4165 // Called very early -- before JavaThreads exist
4166 void Threads::create_vm_init_agents() {
4167   extern struct JavaVM_ main_vm;
4168   AgentLibrary* agent;
4169 
4170   JvmtiExport::enter_onload_phase();
4171 
4172   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4173     // CDS dumping does not support native JVMTI agent.
4174     // CDS dumping supports Java agent if the AllowArchivingWithJavaAgent diagnostic option is specified.
<a name="142" id="anc142"></a><span class="line-modified">4175     if (DumpSharedSpaces) {</span>
4176       if(!agent-&gt;is_instrument_lib()) {
4177         vm_exit_during_cds_dumping(&quot;CDS dumping does not support native JVMTI agent, name&quot;, agent-&gt;name());
4178       } else if (!AllowArchivingWithJavaAgent) {
4179         vm_exit_during_cds_dumping(
4180           &quot;Must enable AllowArchivingWithJavaAgent in order to run Java agent during CDS dumping&quot;);
4181       }
4182     }
4183 
4184     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4185 
4186     if (on_load_entry != NULL) {
4187       // Invoke the Agent_OnLoad function
4188       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4189       if (err != JNI_OK) {
4190         vm_exit_during_initialization(&quot;agent library failed to init&quot;, agent-&gt;name());
4191       }
4192     } else {
4193       vm_exit_during_initialization(&quot;Could not find Agent_OnLoad function in the agent library&quot;, agent-&gt;name());
4194     }
4195   }
4196 
4197   JvmtiExport::enter_primordial_phase();
4198 }
4199 
4200 extern &quot;C&quot; {
4201   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4202 }
4203 
4204 void Threads::shutdown_vm_agents() {
4205   // Send any Agent_OnUnload notifications
4206   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4207   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4208   extern struct JavaVM_ main_vm;
4209   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4210 
4211     // Find the Agent_OnUnload function.
4212     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4213                                                    os::find_agent_function(agent,
4214                                                    false,
4215                                                    on_unload_symbols,
4216                                                    num_symbol_entries));
4217 
4218     // Invoke the Agent_OnUnload function
4219     if (unload_entry != NULL) {
4220       JavaThread* thread = JavaThread::current();
4221       ThreadToNativeFromVM ttn(thread);
4222       HandleMark hm(thread);
4223       (*unload_entry)(&amp;main_vm);
4224     }
4225   }
4226 }
4227 
4228 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4229 // Invokes JVM_OnLoad
4230 void Threads::create_vm_init_libraries() {
4231   extern struct JavaVM_ main_vm;
4232   AgentLibrary* agent;
4233 
4234   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4235     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4236 
4237     if (on_load_entry != NULL) {
4238       // Invoke the JVM_OnLoad function
4239       JavaThread* thread = JavaThread::current();
4240       ThreadToNativeFromVM ttn(thread);
4241       HandleMark hm(thread);
4242       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4243       if (err != JNI_OK) {
4244         vm_exit_during_initialization(&quot;-Xrun library failed to init&quot;, agent-&gt;name());
4245       }
4246     } else {
4247       vm_exit_during_initialization(&quot;Could not find JVM_OnLoad function in -Xrun library&quot;, agent-&gt;name());
4248     }
4249   }
4250 }
4251 
4252 
4253 // Last thread running calls java.lang.Shutdown.shutdown()
4254 void JavaThread::invoke_shutdown_hooks() {
4255   HandleMark hm(this);
4256 
4257   // We could get here with a pending exception, if so clear it now.
4258   if (this-&gt;has_pending_exception()) {
4259     this-&gt;clear_pending_exception();
4260   }
4261 
4262   EXCEPTION_MARK;
4263   Klass* shutdown_klass =
4264     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4265                                       THREAD);
4266   if (shutdown_klass != NULL) {
4267     // SystemDictionary::resolve_or_null will return null if there was
4268     // an exception.  If we cannot load the Shutdown class, just don&#39;t
4269     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4270     // won&#39;t be run.  Note that if a shutdown hook was registered,
4271     // the Shutdown class would have already been loaded
4272     // (Runtime.addShutdownHook will load it).
4273     JavaValue result(T_VOID);
4274     JavaCalls::call_static(&amp;result,
4275                            shutdown_klass,
<a name="143" id="anc143"></a><span class="line-modified">4276                            vmSymbols::shutdown_method_name(),</span>
4277                            vmSymbols::void_method_signature(),
4278                            THREAD);
4279   }
4280   CLEAR_PENDING_EXCEPTION;
4281 }
4282 
4283 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4284 // the program falls off the end of main(). Another VM exit path is through
4285 // vm_exit() when the program calls System.exit() to return a value or when
4286 // there is a serious error in VM. The two shutdown paths are not exactly
4287 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4288 // and VM_Exit op at VM level.
4289 //
4290 // Shutdown sequence:
4291 //   + Shutdown native memory tracking if it is on
4292 //   + Wait until we are the last non-daemon thread to execute
4293 //     &lt;-- every thing is still working at this moment --&gt;
4294 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4295 //        shutdown hooks
4296 //   + Call before_exit(), prepare for VM exit
4297 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4298 //        currently the only user of this mechanism is File.deleteOnExit())
<a name="144" id="anc144"></a><span class="line-modified">4299 //      &gt; stop StatSampler, watcher thread, CMS threads,</span>
4300 //        post thread end and vm death events to JVMTI,
4301 //        stop signal thread
4302 //   + Call JavaThread::exit(), it will:
4303 //      &gt; release JNI handle blocks, remove stack guard pages
4304 //      &gt; remove this thread from Threads list
4305 //     &lt;-- no more Java code from this thread after this point --&gt;
4306 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4307 //     the compiler threads at safepoint
4308 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4309 //   + Disable tracing at JNI/JVM barriers
4310 //   + Set _vm_exited flag for threads that are still running native code
4311 //   + Call exit_globals()
4312 //      &gt; deletes tty
4313 //      &gt; deletes PerfMemory resources
4314 //   + Delete this thread
4315 //   + Return to caller
4316 
4317 bool Threads::destroy_vm() {
4318   JavaThread* thread = JavaThread::current();
4319 
4320 #ifdef ASSERT
4321   _vm_complete = false;
4322 #endif
4323   // Wait until we are the last non-daemon thread to execute
<a name="145" id="anc145"></a><span class="line-modified">4324   { MutexLocker nu(Threads_lock);</span>
4325     while (Threads::number_of_non_daemon_threads() &gt; 1)
4326       // This wait should make safepoint checks, wait without a timeout,
4327       // and wait as a suspend-equivalent condition.
<a name="146" id="anc146"></a><span class="line-modified">4328       Threads_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 0,</span>
<span class="line-removed">4329                          Mutex::_as_suspend_equivalent_flag);</span>
4330   }
4331 
4332   EventShutdown e;
4333   if (e.should_commit()) {
4334     e.set_reason(&quot;No remaining non-daemon Java threads&quot;);
4335     e.commit();
4336   }
4337 
4338   // Hang forever on exit if we are reporting an error.
4339   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4340     os::infinite_sleep();
4341   }
4342   os::wait_for_keypress_at_exit();
4343 
4344   // run Java level shutdown hooks
4345   thread-&gt;invoke_shutdown_hooks();
4346 
4347   before_exit(thread);
4348 
4349   thread-&gt;exit(true);
4350 
4351   // Stop VM thread.
4352   {
4353     // 4945125 The vm thread comes to a safepoint during exit.
4354     // GC vm_operations can get caught at the safepoint, and the
4355     // heap is unparseable if they are caught. Grab the Heap_lock
4356     // to prevent this. The GC vm_operations will not be able to
4357     // queue until after the vm thread is dead. After this point,
4358     // we&#39;ll never emerge out of the safepoint before the VM exits.
4359 
<a name="147" id="anc147"></a><span class="line-modified">4360     MutexLockerEx ml(Heap_lock, Mutex::_no_safepoint_check_flag);</span>
4361 
4362     VMThread::wait_for_vm_thread_exit();
4363     assert(SafepointSynchronize::is_at_safepoint(), &quot;VM thread should exit at Safepoint&quot;);
4364     VMThread::destroy();
4365   }
4366 
4367   // Now, all Java threads are gone except daemon threads. Daemon threads
4368   // running Java code or in VM are stopped by the Safepoint. However,
4369   // daemon threads executing native code are still running.  But they
4370   // will be stopped at native=&gt;Java/VM barriers. Note that we can&#39;t
4371   // simply kill or suspend them, as it is inherently deadlock-prone.
4372 
4373   VM_Exit::set_vm_exited();
4374 
4375   // Clean up ideal graph printers after the VMThread has started
4376   // the final safepoint which will block all the Compiler threads.
4377   // Note that this Thread has already logically exited so the
4378   // clean_up() function&#39;s use of a JavaThreadIteratorWithHandle
4379   // would be a problem except set_vm_exited() has remembered the
4380   // shutdown thread which is granted a policy exception.
4381 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4382   IdealGraphPrinter::clean_up();
4383 #endif
4384 
4385   notify_vm_shutdown();
4386 
4387   // exit_globals() will delete tty
4388   exit_globals();
4389 
4390   // We are after VM_Exit::set_vm_exited() so we can&#39;t call
4391   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4392   // Deleting the shutdown thread here is safe because another
4393   // JavaThread cannot have an active ThreadsListHandle for
4394   // this JavaThread.
4395   delete thread;
4396 
4397 #if INCLUDE_JVMCI
4398   if (JVMCICounterSize &gt; 0) {
4399     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4400   }
4401 #endif
4402 
4403   LogConfiguration::finalize();
4404 
4405   return true;
4406 }
4407 
4408 
4409 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4410   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4411   return is_supported_jni_version(version);
4412 }
4413 
4414 
4415 jboolean Threads::is_supported_jni_version(jint version) {
4416   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4417   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4418   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4419   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4420   if (version == JNI_VERSION_9) return JNI_TRUE;
4421   if (version == JNI_VERSION_10) return JNI_TRUE;
4422   return JNI_FALSE;
4423 }
4424 
4425 
4426 void Threads::add(JavaThread* p, bool force_daemon) {
4427   // The threads lock must be owned at this point
4428   assert(Threads_lock-&gt;owned_by_self(), &quot;must have threads lock&quot;);
4429 
4430   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4431 
<a name="148" id="anc148"></a><span class="line-removed">4432   p-&gt;set_next(_thread_list);</span>
<span class="line-removed">4433   _thread_list = p;</span>
<span class="line-removed">4434 </span>
4435   // Once a JavaThread is added to the Threads list, smr_delete() has
4436   // to be used to delete it. Otherwise we can just delete it directly.
4437   p-&gt;set_on_thread_list();
4438 
4439   _number_of_threads++;
4440   oop threadObj = p-&gt;threadObj();
4441   bool daemon = true;
4442   // Bootstrapping problem: threadObj can be null for initial
4443   // JavaThread (or for threads attached via JNI)
4444   if ((!force_daemon) &amp;&amp; !is_daemon((threadObj))) {
4445     _number_of_non_daemon_threads++;
4446     daemon = false;
4447   }
4448 
4449   ThreadService::add_thread(p, daemon);
4450 
4451   // Maintain fast thread list
4452   ThreadsSMRSupport::add_thread(p);
4453 
4454   // Possible GC point.
4455   Events::log(p, &quot;Thread added: &quot; INTPTR_FORMAT, p2i(p));
4456 }
4457 
<a name="149" id="anc149"></a><span class="line-modified">4458 void Threads::remove(JavaThread* p) {</span>
4459 
<a name="150" id="anc150"></a><span class="line-modified">4460   // Reclaim the objectmonitors from the omInUseList and omFreeList of the moribund thread.</span>
<span class="line-modified">4461   ObjectSynchronizer::omFlush(p);</span>
4462 
4463   // Extra scope needed for Thread_lock, so we can check
4464   // that we do not remove thread without safepoint code notice
<a name="151" id="anc151"></a><span class="line-modified">4465   { MutexLocker ml(Threads_lock);</span>
4466 
4467     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), &quot;p must be present&quot;);
4468 
4469     // Maintain fast thread list
4470     ThreadsSMRSupport::remove_thread(p);
4471 
<a name="152" id="anc152"></a><span class="line-removed">4472     JavaThread* current = _thread_list;</span>
<span class="line-removed">4473     JavaThread* prev    = NULL;</span>
<span class="line-removed">4474 </span>
<span class="line-removed">4475     while (current != p) {</span>
<span class="line-removed">4476       prev    = current;</span>
<span class="line-removed">4477       current = current-&gt;next();</span>
<span class="line-removed">4478     }</span>
<span class="line-removed">4479 </span>
<span class="line-removed">4480     if (prev) {</span>
<span class="line-removed">4481       prev-&gt;set_next(current-&gt;next());</span>
<span class="line-removed">4482     } else {</span>
<span class="line-removed">4483       _thread_list = p-&gt;next();</span>
<span class="line-removed">4484     }</span>
<span class="line-removed">4485 </span>
4486     _number_of_threads--;
<a name="153" id="anc153"></a><span class="line-modified">4487     oop threadObj = p-&gt;threadObj();</span>
<span class="line-removed">4488     bool daemon = true;</span>
<span class="line-removed">4489     if (!is_daemon(threadObj)) {</span>
4490       _number_of_non_daemon_threads--;
<a name="154" id="anc154"></a><span class="line-removed">4491       daemon = false;</span>
4492 
4493       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4494       // on destroy_vm will wake up.
4495       if (number_of_non_daemon_threads() == 1) {
<a name="155" id="anc155"></a><span class="line-modified">4496         Threads_lock-&gt;notify_all();</span>
4497       }
4498     }
<a name="156" id="anc156"></a><span class="line-modified">4499     ThreadService::remove_thread(p, daemon);</span>
4500 
4501     // Make sure that safepoint code disregard this thread. This is needed since
4502     // the thread might mess around with locks after this point. This can cause it
4503     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4504     // of this thread since it is removed from the queue.
4505     p-&gt;set_terminated_value();
4506   } // unlock Threads_lock
4507 
4508   // Since Events::log uses a lock, we grab it outside the Threads_lock
4509   Events::log(p, &quot;Thread exited: &quot; INTPTR_FORMAT, p2i(p));
4510 }
4511 
4512 // Operations on the Threads list for GC.  These are not explicitly locked,
4513 // but the garbage collector must provide a safe context for them to run.
4514 // In particular, these things should never be called when the Threads_lock
4515 // is held by some other thread. (Note: the Safepoint abstraction also
4516 // uses the Threads_lock to guarantee this property. It also makes sure that
4517 // all threads gets blocked when exiting or starting).
4518 
4519 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4520   ALL_JAVA_THREADS(p) {
4521     p-&gt;oops_do(f, cf);
4522   }
4523   VMThread::vm_thread()-&gt;oops_do(f, cf);
4524 }
4525 
<a name="157" id="anc157"></a><span class="line-modified">4526 void Threads::change_thread_claim_parity() {</span>
<span class="line-modified">4527   // Set the new claim parity.</span>
<span class="line-modified">4528   assert(_thread_claim_parity &gt;= 0 &amp;&amp; _thread_claim_parity &lt;= 2,</span>
<span class="line-modified">4529          &quot;Not in range.&quot;);</span>
<span class="line-modified">4530   _thread_claim_parity++;</span>
<span class="line-modified">4531   if (_thread_claim_parity == 3) _thread_claim_parity = 1;</span>
<span class="line-modified">4532   assert(_thread_claim_parity &gt;= 1 &amp;&amp; _thread_claim_parity &lt;= 2,</span>
<span class="line-modified">4533          &quot;Not in range.&quot;);</span>










4534 }
4535 
4536 #ifdef ASSERT
<a name="158" id="anc158"></a>






4537 void Threads::assert_all_threads_claimed() {
4538   ALL_JAVA_THREADS(p) {
<a name="159" id="anc159"></a><span class="line-modified">4539     const int thread_parity = p-&gt;oops_do_parity();</span>
<span class="line-removed">4540     assert((thread_parity == _thread_claim_parity),</span>
<span class="line-removed">4541            &quot;Thread &quot; PTR_FORMAT &quot; has incorrect parity %d != %d&quot;, p2i(p), thread_parity, _thread_claim_parity);</span>
4542   }
<a name="160" id="anc160"></a><span class="line-modified">4543   VMThread* vmt = VMThread::vm_thread();</span>
<span class="line-removed">4544   const int thread_parity = vmt-&gt;oops_do_parity();</span>
<span class="line-removed">4545   assert((thread_parity == _thread_claim_parity),</span>
<span class="line-removed">4546          &quot;VMThread &quot; PTR_FORMAT &quot; has incorrect parity %d != %d&quot;, p2i(vmt), thread_parity, _thread_claim_parity);</span>
4547 }
4548 #endif // ASSERT
4549 
4550 class ParallelOopsDoThreadClosure : public ThreadClosure {
4551 private:
4552   OopClosure* _f;
4553   CodeBlobClosure* _cf;
4554 public:
4555   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4556   void do_thread(Thread* t) {
4557     t-&gt;oops_do(_f, _cf);
4558   }
4559 };
4560 
4561 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4562   ParallelOopsDoThreadClosure tc(f, cf);
4563   possibly_parallel_threads_do(is_par, &amp;tc);
4564 }
4565 
4566 void Threads::nmethods_do(CodeBlobClosure* cf) {
4567   ALL_JAVA_THREADS(p) {
4568     // This is used by the code cache sweeper to mark nmethods that are active
4569     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4570     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4571     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4572       p-&gt;nmethods_do(cf);
4573     }
4574   }
4575 }
4576 
<a name="161" id="anc161"></a><span class="line-modified">4577 void Threads::metadata_do(void f(Metadata*)) {</span>
4578   ALL_JAVA_THREADS(p) {
4579     p-&gt;metadata_do(f);
4580   }
4581 }
4582 
4583 class ThreadHandlesClosure : public ThreadClosure {
4584   void (*_f)(Metadata*);
4585  public:
4586   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4587   virtual void do_thread(Thread* thread) {
4588     thread-&gt;metadata_handles_do(_f);
4589   }
4590 };
4591 
4592 void Threads::metadata_handles_do(void f(Metadata*)) {
4593   // Only walk the Handles in Thread.
4594   ThreadHandlesClosure handles_closure(f);
4595   threads_do(&amp;handles_closure);
4596 }
4597 
<a name="162" id="anc162"></a><span class="line-removed">4598 void Threads::deoptimized_wrt_marked_nmethods() {</span>
<span class="line-removed">4599   ALL_JAVA_THREADS(p) {</span>
<span class="line-removed">4600     p-&gt;deoptimized_wrt_marked_nmethods();</span>
<span class="line-removed">4601   }</span>
<span class="line-removed">4602 }</span>
<span class="line-removed">4603 </span>
<span class="line-removed">4604 </span>
4605 // Get count Java threads that are waiting to enter the specified monitor.
4606 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4607                                                          int count,
4608                                                          address monitor) {
4609   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4610 
4611   int i = 0;
4612   DO_JAVA_THREADS(t_list, p) {
4613     if (!p-&gt;can_call_java()) continue;
4614 
4615     address pending = (address)p-&gt;current_pending_monitor();
4616     if (pending == monitor) {             // found a match
4617       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4618       i++;
4619     }
4620   }
4621 
4622   return result;
4623 }
4624 
4625 
4626 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4627                                                       address owner) {
4628   // NULL owner means not locked so we can skip the search
4629   if (owner == NULL) return NULL;
4630 
4631   DO_JAVA_THREADS(t_list, p) {
4632     // first, see if owner is the address of a Java thread
4633     if (owner == (address)p) return p;
4634   }
4635 
4636   // Cannot assert on lack of success here since this function may be
4637   // used by code that is trying to report useful problem information
4638   // like deadlock detection.
4639   if (UseHeavyMonitors) return NULL;
4640 
4641   // If we didn&#39;t find a matching Java thread and we didn&#39;t force use of
4642   // heavyweight monitors, then the owner is the stack address of the
4643   // Lock Word in the owning Java thread&#39;s stack.
4644   //
4645   JavaThread* the_owner = NULL;
4646   DO_JAVA_THREADS(t_list, q) {
4647     if (q-&gt;is_lock_owned(owner)) {
4648       the_owner = q;
4649       break;
4650     }
4651   }
4652 
4653   // cannot assert on lack of success here; see above comment
4654   return the_owner;
4655 }
4656 
4657 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4658 void Threads::print_on(outputStream* st, bool print_stacks,
4659                        bool internal_format, bool print_concurrent_locks,
4660                        bool print_extended_info) {
4661   char buf[32];
4662   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4663 
4664   st-&gt;print_cr(&quot;Full thread dump %s (%s %s):&quot;,
4665                VM_Version::vm_name(),
4666                VM_Version::vm_release(),
4667                VM_Version::vm_info_string());
4668   st-&gt;cr();
4669 
4670 #if INCLUDE_SERVICES
4671   // Dump concurrent locks
4672   ConcurrentLocksDump concurrent_locks;
4673   if (print_concurrent_locks) {
4674     concurrent_locks.dump_at_safepoint();
4675   }
4676 #endif // INCLUDE_SERVICES
4677 
4678   ThreadsSMRSupport::print_info_on(st);
4679   st-&gt;cr();
4680 
4681   ALL_JAVA_THREADS(p) {
4682     ResourceMark rm;
4683     p-&gt;print_on(st, print_extended_info);
4684     if (print_stacks) {
4685       if (internal_format) {
4686         p-&gt;trace_stack();
4687       } else {
4688         p-&gt;print_stack_on(st);
4689       }
4690     }
4691     st-&gt;cr();
4692 #if INCLUDE_SERVICES
4693     if (print_concurrent_locks) {
4694       concurrent_locks.print_locks_on(p, st);
4695     }
4696 #endif // INCLUDE_SERVICES
4697   }
4698 
4699   VMThread::vm_thread()-&gt;print_on(st);
4700   st-&gt;cr();
4701   Universe::heap()-&gt;print_gc_threads_on(st);
4702   WatcherThread* wt = WatcherThread::watcher_thread();
4703   if (wt != NULL) {
4704     wt-&gt;print_on(st);
4705     st-&gt;cr();
4706   }
4707 
4708   st-&gt;flush();
4709 }
4710 
4711 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4712                              int buflen, bool* found_current) {
4713   if (this_thread != NULL) {
4714     bool is_current = (current == this_thread);
4715     *found_current = *found_current || is_current;
4716     st-&gt;print(&quot;%s&quot;, is_current ? &quot;=&gt;&quot; : &quot;  &quot;);
4717 
4718     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4719     st-&gt;print(&quot; &quot;);
4720     this_thread-&gt;print_on_error(st, buf, buflen);
4721     st-&gt;cr();
4722   }
4723 }
4724 
4725 class PrintOnErrorClosure : public ThreadClosure {
4726   outputStream* _st;
4727   Thread* _current;
4728   char* _buf;
4729   int _buflen;
4730   bool* _found_current;
4731  public:
4732   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4733                       int buflen, bool* found_current) :
4734    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4735 
4736   virtual void do_thread(Thread* thread) {
4737     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4738   }
4739 };
4740 
4741 // Threads::print_on_error() is called by fatal error handler. It&#39;s possible
4742 // that VM is not at safepoint and/or current thread is inside signal handler.
4743 // Don&#39;t print stack trace, as the stack may not be walkable. Don&#39;t allocate
4744 // memory (even in resource area), it might deadlock the error handler.
4745 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4746                              int buflen) {
4747   ThreadsSMRSupport::print_info_on(st);
4748   st-&gt;cr();
4749 
4750   bool found_current = false;
4751   st-&gt;print_cr(&quot;Java Threads: ( =&gt; current thread )&quot;);
4752   ALL_JAVA_THREADS(thread) {
4753     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4754   }
4755   st-&gt;cr();
4756 
4757   st-&gt;print_cr(&quot;Other Threads:&quot;);
4758   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4759   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4760 
4761   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4762   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4763 
4764   if (!found_current) {
4765     st-&gt;cr();
4766     st-&gt;print(&quot;=&gt;&quot; PTR_FORMAT &quot; (exited) &quot;, p2i(current));
4767     current-&gt;print_on_error(st, buf, buflen);
4768     st-&gt;cr();
4769   }
4770   st-&gt;cr();
4771 
4772   st-&gt;print_cr(&quot;Threads with active compile tasks:&quot;);
4773   print_threads_compiling(st, buf, buflen);
4774 }
4775 
4776 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form) {
4777   ALL_JAVA_THREADS(thread) {
4778     if (thread-&gt;is_Compiler_thread()) {
4779       CompilerThread* ct = (CompilerThread*) thread;
4780 
4781       // Keep task in local variable for NULL check.
4782       // ct-&gt;_task might be set to NULL by concurring compiler thread
4783       // because it completed the compilation. The task is never freed,
4784       // though, just returned to a free list.
4785       CompileTask* task = ct-&gt;task();
4786       if (task != NULL) {
4787         thread-&gt;print_name_on_error(st, buf, buflen);
4788         st-&gt;print(&quot;  &quot;);
4789         task-&gt;print(st, NULL, short_form, true);
4790       }
4791     }
4792   }
4793 }
4794 
4795 
4796 // Internal SpinLock and Mutex
4797 // Based on ParkEvent
4798 
4799 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4800 //
4801 // We employ SpinLocks _only for low-contention, fixed-length
4802 // short-duration critical sections where we&#39;re concerned
4803 // about native mutex_t or HotSpot Mutex:: latency.
4804 // The mux construct provides a spin-then-block mutual exclusion
4805 // mechanism.
4806 //
4807 // Testing has shown that contention on the ListLock guarding gFreeList
4808 // is common.  If we implement ListLock as a simple SpinLock it&#39;s common
4809 // for the JVM to devolve to yielding with little progress.  This is true
4810 // despite the fact that the critical sections protected by ListLock are
4811 // extremely short.
4812 //
4813 // TODO-FIXME: ListLock should be of type SpinLock.
4814 // We should make this a 1st-class type, integrated into the lock
4815 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4816 // should have sufficient padding to avoid false-sharing and excessive
4817 // cache-coherency traffic.
4818 
4819 
4820 typedef volatile int SpinLockT;
4821 
4822 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
<a name="163" id="anc163"></a><span class="line-modified">4823   if (Atomic::cmpxchg (1, adr, 0) == 0) {</span>
4824     return;   // normal fast-path return
4825   }
4826 
4827   // Slow-path : We&#39;ve encountered contention -- Spin/Yield/Block strategy.
4828   int ctr = 0;
4829   int Yields = 0;
4830   for (;;) {
4831     while (*adr != 0) {
4832       ++ctr;
4833       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4834         if (Yields &gt; 5) {
4835           os::naked_short_sleep(1);
4836         } else {
4837           os::naked_yield();
4838           ++Yields;
4839         }
4840       } else {
4841         SpinPause();
4842       }
4843     }
<a name="164" id="anc164"></a><span class="line-modified">4844     if (Atomic::cmpxchg(1, adr, 0) == 0) return;</span>
4845   }
4846 }
4847 
4848 void Thread::SpinRelease(volatile int * adr) {
4849   assert(*adr != 0, &quot;invariant&quot;);
4850   OrderAccess::fence();      // guarantee at least release consistency.
4851   // Roach-motel semantics.
4852   // It&#39;s safe if subsequent LDs and STs float &quot;up&quot; into the critical section,
4853   // but prior LDs and STs within the critical section can&#39;t be allowed
4854   // to reorder or float past the ST that releases the lock.
4855   // Loads and stores in the critical section - which appear in program
4856   // order before the store that releases the lock - must also appear
4857   // before the store that releases the lock in memory visibility order.
4858   // Conceptually we need a #loadstore|#storestore &quot;release&quot; MEMBAR before
4859   // the ST of 0 into the lock-word which releases the lock, so fence
4860   // more than covers this on all platforms.
4861   *adr = 0;
4862 }
4863 
4864 // muxAcquire and muxRelease:
4865 //
4866 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4867 //    The LSB of the word is set IFF the lock is held.
4868 //    The remainder of the word points to the head of a singly-linked list
4869 //    of threads blocked on the lock.
4870 //
4871 // *  The current implementation of muxAcquire-muxRelease uses its own
4872 //    dedicated Thread._MuxEvent instance.  If we&#39;re interested in
4873 //    minimizing the peak number of extant ParkEvent instances then
4874 //    we could eliminate _MuxEvent and &quot;borrow&quot; _ParkEvent as long
4875 //    as certain invariants were satisfied.  Specifically, care would need
4876 //    to be taken with regards to consuming unpark() &quot;permits&quot;.
4877 //    A safe rule of thumb is that a thread would never call muxAcquire()
4878 //    if it&#39;s enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4879 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4880 //    consume an unpark() permit intended for monitorenter, for instance.
4881 //    One way around this would be to widen the restricted-range semaphore
4882 //    implemented in park().  Another alternative would be to provide
4883 //    multiple instances of the PlatformEvent() for each thread.  One
4884 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4885 //
4886 // *  Usage:
4887 //    -- Only as leaf locks
4888 //    -- for short-term locking only as muxAcquire does not perform
4889 //       thread state transitions.
4890 //
4891 // Alternatives:
4892 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
4893 //    but with parking or spin-then-park instead of pure spinning.
4894 // *  Use Taura-Oyama-Yonenzawa locks.
4895 // *  It&#39;s possible to construct a 1-0 lock if we encode the lockword as
4896 //    (List,LockByte).  Acquire will CAS the full lockword while Release
4897 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
4898 //    acquiring threads use timers (ParkTimed) to detect and recover from
4899 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
4900 //    boundaries by using placement-new.
4901 // *  Augment MCS with advisory back-link fields maintained with CAS().
4902 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
4903 //    The validity of the backlinks must be ratified before we trust the value.
4904 //    If the backlinks are invalid the exiting thread must back-track through the
4905 //    the forward links, which are always trustworthy.
4906 // *  Add a successor indication.  The LockWord is currently encoded as
4907 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
4908 //    to provide the usual futile-wakeup optimization.
4909 //    See RTStt for details.
4910 //
4911 
4912 
4913 const intptr_t LOCKBIT = 1;
4914 
4915 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
<a name="165" id="anc165"></a><span class="line-modified">4916   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);</span>
4917   if (w == 0) return;
<a name="166" id="anc166"></a><span class="line-modified">4918   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
4919     return;
4920   }
4921 
4922   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
4923   assert((intptr_t(Self) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
4924   for (;;) {
4925     int its = (os::is_MP() ? 100 : 0) + 1;
4926 
4927     // Optional spin phase: spin-then-park strategy
4928     while (--its &gt;= 0) {
4929       w = *Lock;
<a name="167" id="anc167"></a><span class="line-modified">4930       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
4931         return;
4932       }
4933     }
4934 
4935     Self-&gt;reset();
4936     Self-&gt;OnList = intptr_t(Lock);
4937     // The following fence() isn&#39;t _strictly necessary as the subsequent
4938     // CAS() both serializes execution and ratifies the fetched *Lock value.
4939     OrderAccess::fence();
4940     for (;;) {
4941       w = *Lock;
4942       if ((w &amp; LOCKBIT) == 0) {
<a name="168" id="anc168"></a><span class="line-modified">4943         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
4944           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
4945           return;
4946         }
4947         continue;      // Interference -- *Lock changed -- Just retry
4948       }
4949       assert(w &amp; LOCKBIT, &quot;invariant&quot;);
4950       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
<a name="169" id="anc169"></a><span class="line-modified">4951       if (Atomic::cmpxchg(intptr_t(Self)|LOCKBIT, Lock, w) == w) break;</span>
4952     }
4953 
4954     while (Self-&gt;OnList != 0) {
4955       Self-&gt;park();
4956     }
4957   }
4958 }
4959 
<a name="170" id="anc170"></a><span class="line-removed">4960 void Thread::muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev) {</span>
<span class="line-removed">4961   intptr_t w = Atomic::cmpxchg(LOCKBIT, Lock, (intptr_t)0);</span>
<span class="line-removed">4962   if (w == 0) return;</span>
<span class="line-removed">4963   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
<span class="line-removed">4964     return;</span>
<span class="line-removed">4965   }</span>
<span class="line-removed">4966 </span>
<span class="line-removed">4967   ParkEvent * ReleaseAfter = NULL;</span>
<span class="line-removed">4968   if (ev == NULL) {</span>
<span class="line-removed">4969     ev = ReleaseAfter = ParkEvent::Allocate(NULL);</span>
<span class="line-removed">4970   }</span>
<span class="line-removed">4971   assert((intptr_t(ev) &amp; LOCKBIT) == 0, &quot;invariant&quot;);</span>
<span class="line-removed">4972   for (;;) {</span>
<span class="line-removed">4973     guarantee(ev-&gt;OnList == 0, &quot;invariant&quot;);</span>
<span class="line-removed">4974     int its = (os::is_MP() ? 100 : 0) + 1;</span>
<span class="line-removed">4975 </span>
<span class="line-removed">4976     // Optional spin phase: spin-then-park strategy</span>
<span class="line-removed">4977     while (--its &gt;= 0) {</span>
<span class="line-removed">4978       w = *Lock;</span>
<span class="line-removed">4979       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
<span class="line-removed">4980         if (ReleaseAfter != NULL) {</span>
<span class="line-removed">4981           ParkEvent::Release(ReleaseAfter);</span>
<span class="line-removed">4982         }</span>
<span class="line-removed">4983         return;</span>
<span class="line-removed">4984       }</span>
<span class="line-removed">4985     }</span>
<span class="line-removed">4986 </span>
<span class="line-removed">4987     ev-&gt;reset();</span>
<span class="line-removed">4988     ev-&gt;OnList = intptr_t(Lock);</span>
<span class="line-removed">4989     // The following fence() isn&#39;t _strictly necessary as the subsequent</span>
<span class="line-removed">4990     // CAS() both serializes execution and ratifies the fetched *Lock value.</span>
<span class="line-removed">4991     OrderAccess::fence();</span>
<span class="line-removed">4992     for (;;) {</span>
<span class="line-removed">4993       w = *Lock;</span>
<span class="line-removed">4994       if ((w &amp; LOCKBIT) == 0) {</span>
<span class="line-removed">4995         if (Atomic::cmpxchg(w|LOCKBIT, Lock, w) == w) {</span>
<span class="line-removed">4996           ev-&gt;OnList = 0;</span>
<span class="line-removed">4997           // We call ::Release while holding the outer lock, thus</span>
<span class="line-removed">4998           // artificially lengthening the critical section.</span>
<span class="line-removed">4999           // Consider deferring the ::Release() until the subsequent unlock(),</span>
<span class="line-removed">5000           // after we&#39;ve dropped the outer lock.</span>
<span class="line-removed">5001           if (ReleaseAfter != NULL) {</span>
<span class="line-removed">5002             ParkEvent::Release(ReleaseAfter);</span>
<span class="line-removed">5003           }</span>
<span class="line-removed">5004           return;</span>
<span class="line-removed">5005         }</span>
<span class="line-removed">5006         continue;      // Interference -- *Lock changed -- Just retry</span>
<span class="line-removed">5007       }</span>
<span class="line-removed">5008       assert(w &amp; LOCKBIT, &quot;invariant&quot;);</span>
<span class="line-removed">5009       ev-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);</span>
<span class="line-removed">5010       if (Atomic::cmpxchg(intptr_t(ev)|LOCKBIT, Lock, w) == w) break;</span>
<span class="line-removed">5011     }</span>
<span class="line-removed">5012 </span>
<span class="line-removed">5013     while (ev-&gt;OnList != 0) {</span>
<span class="line-removed">5014       ev-&gt;park();</span>
<span class="line-removed">5015     }</span>
<span class="line-removed">5016   }</span>
<span class="line-removed">5017 }</span>
<span class="line-removed">5018 </span>
5019 // Release() must extract a successor from the list and then wake that thread.
5020 // It can &quot;pop&quot; the front of the list or use a detach-modify-reattach (DMR) scheme
5021 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
5022 // Release() would :
5023 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
5024 // (B) Extract a successor from the private list &quot;in-hand&quot;
5025 // (C) attempt to CAS() the residual back into *Lock over null.
5026 //     If there were any newly arrived threads and the CAS() would fail.
5027 //     In that case Release() would detach the RATs, re-merge the list in-hand
5028 //     with the RATs and repeat as needed.  Alternately, Release() might
5029 //     detach and extract a successor, but then pass the residual list to the wakee.
5030 //     The wakee would be responsible for reattaching and remerging before it
5031 //     competed for the lock.
5032 //
5033 // Both &quot;pop&quot; and DMR are immune from ABA corruption -- there can be
5034 // multiple concurrent pushers, but only one popper or detacher.
5035 // This implementation pops from the head of the list.  This is unfair,
5036 // but tends to provide excellent throughput as hot threads remain hot.
5037 // (We wake recently run threads first).
5038 //
5039 // All paths through muxRelease() will execute a CAS.
5040 // Release consistency -- We depend on the CAS in muxRelease() to provide full
5041 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
5042 // executed within the critical section are complete and globally visible before the
5043 // store (CAS) to the lock-word that releases the lock becomes globally visible.
5044 void Thread::muxRelease(volatile intptr_t * Lock)  {
5045   for (;;) {
<a name="171" id="anc171"></a><span class="line-modified">5046     const intptr_t w = Atomic::cmpxchg((intptr_t)0, Lock, LOCKBIT);</span>
5047     assert(w &amp; LOCKBIT, &quot;invariant&quot;);
5048     if (w == LOCKBIT) return;
5049     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
5050     assert(List != NULL, &quot;invariant&quot;);
5051     assert(List-&gt;OnList == intptr_t(Lock), &quot;invariant&quot;);
5052     ParkEvent * const nxt = List-&gt;ListNext;
5053     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
5054 
5055     // The following CAS() releases the lock and pops the head element.
5056     // The CAS() also ratifies the previously fetched lock-word value.
<a name="172" id="anc172"></a><span class="line-modified">5057     if (Atomic::cmpxchg(intptr_t(nxt), Lock, w) != w) {</span>
5058       continue;
5059     }
5060     List-&gt;OnList = 0;
5061     OrderAccess::fence();
5062     List-&gt;unpark();
5063     return;
5064   }
5065 }
5066 
5067 
5068 void Threads::verify() {
5069   ALL_JAVA_THREADS(p) {
5070     p-&gt;verify();
5071   }
5072   VMThread* thread = VMThread::vm_thread();
5073   if (thread != NULL) thread-&gt;verify();
5074 }
<a name="173" id="anc173"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="173" type="hidden" />
</body>
</html>