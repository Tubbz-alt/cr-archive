<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;oops/markOop.hpp&quot;
  35 #include &quot;oops/oop.inline.hpp&quot;
  36 #include &quot;runtime/atomic.hpp&quot;
  37 #include &quot;runtime/biasedLocking.hpp&quot;
  38 #include &quot;runtime/handles.inline.hpp&quot;
  39 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  40 #include &quot;runtime/mutexLocker.hpp&quot;
  41 #include &quot;runtime/objectMonitor.hpp&quot;
  42 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  43 #include &quot;runtime/osThread.hpp&quot;
  44 #include &quot;runtime/safepointVerifiers.hpp&quot;
  45 #include &quot;runtime/sharedRuntime.hpp&quot;
  46 #include &quot;runtime/stubRoutines.hpp&quot;
  47 #include &quot;runtime/synchronizer.hpp&quot;
  48 #include &quot;runtime/thread.inline.hpp&quot;
  49 #include &quot;runtime/timer.hpp&quot;
  50 #include &quot;runtime/vframe.hpp&quot;
  51 #include &quot;runtime/vmThread.hpp&quot;
  52 #include &quot;utilities/align.hpp&quot;
  53 #include &quot;utilities/dtrace.hpp&quot;
  54 #include &quot;utilities/events.hpp&quot;
  55 #include &quot;utilities/preserveException.hpp&quot;
  56 
  57 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  58 // The interpreter and compilers contain specialized transliterated
  59 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  60 // for instance.  If you make changes here, make sure to modify the
  61 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  62 //
  63 // -----------------------------------------------------------------------------
  64 
  65 #ifdef DTRACE_ENABLED
  66 
  67 // Only bother with this argument setup if dtrace is available
  68 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  69 
  70 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  71   char* bytes = NULL;                                                      \
  72   int len = 0;                                                             \
  73   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  74   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  75   if (klassname != NULL) {                                                 \
  76     bytes = (char*)klassname-&gt;bytes();                                     \
  77     len = klassname-&gt;utf8_length();                                        \
  78   }
  79 
  80 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  81   {                                                                        \
  82     if (DTraceMonitorProbes) {                                             \
  83       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  84       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  85                            (uintptr_t)(monitor), bytes, len, (millis));    \
  86     }                                                                      \
  87   }
  88 
  89 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  90 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  91 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  92 
  93 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  94   {                                                                        \
  95     if (DTraceMonitorProbes) {                                             \
  96       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  97       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
  98                                     (uintptr_t)(monitor), bytes, len);     \
  99     }                                                                      \
 100   }
 101 
 102 #else //  ndef DTRACE_ENABLED
 103 
 104 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 105 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 106 
 107 #endif // ndef DTRACE_ENABLED
 108 
 109 // This exists only as a workaround of dtrace bug 6254741
 110 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 111   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 112   return 0;
 113 }
 114 
 115 #define NINFLATIONLOCKS 256
 116 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 117 
 118 // global list of blocks of monitors
 119 PaddedEnd&lt;ObjectMonitor&gt; * volatile ObjectSynchronizer::gBlockList = NULL;
 120 // global monitor free list
 121 ObjectMonitor * volatile ObjectSynchronizer::gFreeList  = NULL;
 122 // global monitor in-use list, for moribund threads,
 123 // monitors they inflated need to be scanned for deflation
 124 ObjectMonitor * volatile ObjectSynchronizer::gOmInUseList  = NULL;
 125 // count of entries in gOmInUseList
 126 int ObjectSynchronizer::gOmInUseCount = 0;
 127 
 128 static volatile intptr_t gListLock = 0;      // protects global monitor lists
 129 static volatile int gMonitorFreeCount  = 0;  // # on gFreeList
 130 static volatile int gMonitorPopulation = 0;  // # Extant -- in circulation
 131 
 132 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 133 
 134 
 135 // =====================&gt; Quick functions
 136 
 137 // The quick_* forms are special fast-path variants used to improve
 138 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 139 // simply return false, in which case the caller will perform the necessary
 140 // state transitions and call the slow-path form.
 141 // The fast-path is designed to handle frequently arising cases in an efficient
 142 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 143 // returns true  -- to indicate the call was satisfied.
 144 // returns false -- to indicate the call needs the services of the slow-path.
 145 // A no-loitering ordinance is in effect for code in the quick_* family
 146 // operators: safepoints or indefinite blocking (blocking that might span a
 147 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 148 // entry.
 149 //
 150 // Consider: An interesting optimization is to have the JIT recognize the
 151 // following common idiom:
 152 //   synchronized (someobj) { .... ; notify(); }
 153 // That is, we find a notify() or notifyAll() call that immediately precedes
 154 // the monitorexit operation.  In that case the JIT could fuse the operations
 155 // into a single notifyAndExit() runtime primitive.
 156 
 157 bool ObjectSynchronizer::quick_notify(oopDesc * obj, Thread * self, bool all) {
 158   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 159   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 160   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 161   NoSafepointVerifier nsv;
 162   if (obj == NULL) return false;  // slow-path for invalid obj
 163   const markOop mark = obj-&gt;mark();
 164 
 165   if (mark-&gt;has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark-&gt;locker())) {
 166     // Degenerate notify
 167     // stack-locked by caller so by definition the implied waitset is empty.
 168     return true;
 169   }
 170 
 171   if (mark-&gt;has_monitor()) {
 172     ObjectMonitor * const mon = mark-&gt;monitor();
 173     assert(oopDesc::equals((oop) mon-&gt;object(), obj), &quot;invariant&quot;);
 174     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 175 
 176     if (mon-&gt;first_waiter() != NULL) {
 177       // We have one or more waiters. Since this is an inflated monitor
 178       // that we own, we can transfer one or more threads from the waitset
 179       // to the entrylist here and now, avoiding the slow-path.
 180       if (all) {
 181         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 182       } else {
 183         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 184       }
 185       int tally = 0;
 186       do {
 187         mon-&gt;INotify(self);
 188         ++tally;
 189       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 190       OM_PERFDATA_OP(Notifications, inc(tally));
 191     }
 192     return true;
 193   }
 194 
 195   // biased locking and any other IMS exception states take the slow-path
 196   return false;
 197 }
 198 
 199 
 200 // The LockNode emitted directly at the synchronization site would have
 201 // been too big if it were to have included support for the cases of inflated
 202 // recursive enter and exit, so they go here instead.
 203 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 204 // quick_enter() as our thread state remains _in_Java.
 205 
 206 bool ObjectSynchronizer::quick_enter(oop obj, Thread * Self,
 207                                      BasicLock * lock) {
 208   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 209   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 210   assert(((JavaThread *) Self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 211   NoSafepointVerifier nsv;
 212   if (obj == NULL) return false;       // Need to throw NPE
 213   const markOop mark = obj-&gt;mark();
 214 
 215   if (mark-&gt;has_monitor()) {
 216     ObjectMonitor * const m = mark-&gt;monitor();
 217     assert(oopDesc::equals((oop) m-&gt;object(), obj), &quot;invariant&quot;);
 218     Thread * const owner = (Thread *) m-&gt;_owner;
 219 
 220     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 221     // and observability
 222     // Case: light contention possibly amenable to TLE
 223     // Case: TLE inimical operations such as nested/recursive synchronization
 224 
 225     if (owner == Self) {
 226       m-&gt;_recursions++;
 227       return true;
 228     }
 229 
 230     // This Java Monitor is inflated so obj&#39;s header will never be
 231     // displaced to this thread&#39;s BasicLock. Make the displaced header
 232     // non-NULL so this BasicLock is not seen as recursive nor as
 233     // being locked. We do this unconditionally so that this thread&#39;s
 234     // BasicLock cannot be mis-interpreted by any stack walkers. For
 235     // performance reasons, stack walkers generally first check for
 236     // Biased Locking in the object&#39;s header, the second check is for
 237     // stack-locking in the object&#39;s header, the third check is for
 238     // recursive stack-locking in the displaced header in the BasicLock,
 239     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 240     lock-&gt;set_displaced_header(markOopDesc::unused_mark());
 241 
 242     if (owner == NULL &amp;&amp; Atomic::replace_if_null(Self, &amp;(m-&gt;_owner))) {
 243       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 244       assert(m-&gt;_owner == Self, &quot;invariant&quot;);
 245       return true;
 246     }
 247   }
 248 
 249   // Note that we could inflate in quick_enter.
 250   // This is likely a useful optimization
 251   // Critically, in quick_enter() we must not:
 252   // -- perform bias revocation, or
 253   // -- block indefinitely, or
 254   // -- reach a safepoint
 255 
 256   return false;        // revert to slow-path
 257 }
 258 
 259 // -----------------------------------------------------------------------------
 260 //  Fast Monitor Enter/Exit
 261 // This the fast monitor enter. The interpreter and compiler use
 262 // some assembly copies of this code. Make sure update those code
 263 // if the following function is changed. The implementation is
 264 // extremely sensitive to race condition. Be careful.
 265 
 266 void ObjectSynchronizer::fast_enter(Handle obj, BasicLock* lock,
 267                                     bool attempt_rebias, TRAPS) {
 268   if (UseBiasedLocking) {
 269     if (!SafepointSynchronize::is_at_safepoint()) {
 270       BiasedLocking::Condition cond = BiasedLocking::revoke_and_rebias(obj, attempt_rebias, THREAD);
 271       if (cond == BiasedLocking::BIAS_REVOKED_AND_REBIASED) {
 272         return;
 273       }
 274     } else {
 275       assert(!attempt_rebias, &quot;can not rebias toward VM thread&quot;);
 276       BiasedLocking::revoke_at_safepoint(obj);
 277     }
 278     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 279   }
 280 
 281   slow_enter(obj, lock, THREAD);
 282 }
 283 
 284 void ObjectSynchronizer::fast_exit(oop object, BasicLock* lock, TRAPS) {
 285   markOop mark = object-&gt;mark();
 286   // We cannot check for Biased Locking if we are racing an inflation.
 287   assert(mark == markOopDesc::INFLATING() ||
 288          !mark-&gt;has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 289 
 290   markOop dhw = lock-&gt;displaced_header();
 291   if (dhw == NULL) {
 292     // If the displaced header is NULL, then this exit matches up with
 293     // a recursive enter. No real work to do here except for diagnostics.
 294 #ifndef PRODUCT
 295     if (mark != markOopDesc::INFLATING()) {
 296       // Only do diagnostics if we are not racing an inflation. Simply
 297       // exiting a recursive enter of a Java Monitor that is being
 298       // inflated is safe; see the has_monitor() comment below.
 299       assert(!mark-&gt;is_neutral(), &quot;invariant&quot;);
 300       assert(!mark-&gt;has_locker() ||
 301              THREAD-&gt;is_lock_owned((address)mark-&gt;locker()), &quot;invariant&quot;);
 302       if (mark-&gt;has_monitor()) {
 303         // The BasicLock&#39;s displaced_header is marked as a recursive
 304         // enter and we have an inflated Java Monitor (ObjectMonitor).
 305         // This is a special case where the Java Monitor was inflated
 306         // after this thread entered the stack-lock recursively. When a
 307         // Java Monitor is inflated, we cannot safely walk the Java
 308         // Monitor owner&#39;s stack and update the BasicLocks because a
 309         // Java Monitor can be asynchronously inflated by a thread that
 310         // does not own the Java Monitor.
 311         ObjectMonitor * m = mark-&gt;monitor();
 312         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 313         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 314       }
 315     }
 316 #endif
 317     return;
 318   }
 319 
 320   if (mark == (markOop) lock) {
 321     // If the object is stack-locked by the current thread, try to
 322     // swing the displaced header from the BasicLock back to the mark.
 323     assert(dhw-&gt;is_neutral(), &quot;invariant&quot;);
 324     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 325       return;
 326     }
 327   }
 328 
 329   // We have to take the slow-path of possible inflation and then exit.
 330   inflate(THREAD, object, inflate_cause_vm_internal)-&gt;exit(true, THREAD);
 331 }
 332 
 333 // -----------------------------------------------------------------------------
 334 // Interpreter/Compiler Slow Case
 335 // This routine is used to handle interpreter/compiler slow case
 336 // We don&#39;t need to use fast path here, because it must have been
 337 // failed in the interpreter/compiler code.
 338 void ObjectSynchronizer::slow_enter(Handle obj, BasicLock* lock, TRAPS) {
 339   markOop mark = obj-&gt;mark();
 340   assert(!mark-&gt;has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 341 
 342   if (mark-&gt;is_neutral()) {
 343     // Anticipate successful CAS -- the ST of the displaced mark must
 344     // be visible &lt;= the ST performed by the CAS.
 345     lock-&gt;set_displaced_header(mark);
 346     if (mark == obj()-&gt;cas_set_mark((markOop) lock, mark)) {
 347       return;
 348     }
 349     // Fall through to inflate() ...
 350   } else if (mark-&gt;has_locker() &amp;&amp;
 351              THREAD-&gt;is_lock_owned((address)mark-&gt;locker())) {
 352     assert(lock != mark-&gt;locker(), &quot;must not re-lock the same lock&quot;);
 353     assert(lock != (BasicLock*)obj-&gt;mark(), &quot;don&#39;t relock with same BasicLock&quot;);
 354     lock-&gt;set_displaced_header(NULL);
 355     return;
 356   }
 357 
 358   // The object header will never be displaced to this lock,
 359   // so it does not matter what the value is, except that it
 360   // must be non-zero to avoid looking like a re-entrant lock,
 361   // and must not look locked either.
 362   lock-&gt;set_displaced_header(markOopDesc::unused_mark());
 363   inflate(THREAD, obj(), inflate_cause_monitor_enter)-&gt;enter(THREAD);
 364 }
 365 
 366 // This routine is used to handle interpreter/compiler slow case
 367 // We don&#39;t need to use fast path here, because it must have
 368 // failed in the interpreter/compiler code. Simply use the heavy
 369 // weight monitor should be ok, unless someone find otherwise.
 370 void ObjectSynchronizer::slow_exit(oop object, BasicLock* lock, TRAPS) {
 371   fast_exit(object, lock, THREAD);
 372 }
 373 
 374 // -----------------------------------------------------------------------------
 375 // Class Loader  support to workaround deadlocks on the class loader lock objects
 376 // Also used by GC
 377 // complete_exit()/reenter() are used to wait on a nested lock
 378 // i.e. to give up an outer lock completely and then re-enter
 379 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 380 //  1) complete_exit lock1 - saving recursion count
 381 //  2) wait on lock2
 382 //  3) when notified on lock2, unlock lock2
 383 //  4) reenter lock1 with original recursion count
 384 //  5) lock lock2
 385 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 386 // NOTE(TSAN): We cannot instrument complete_exit/reenter in ObjectSynchronizer
 387 //             in a manner similar to wait and waitUninterruptibly, because
 388 //             (1) recursion count stored by inflated monitor is different from
 389 //             the absolute recursion count tracked by Tsan, and (2) in the
 390 //             general case, we cannot merely store Tsan&#39;s recursion count
 391 //             once: we must track it for *each invocation* of complete_exit.
 392 //             Hence, the best place to instrument for Tsan is at the call site
 393 //             for complete_exit/reenter. Luckily, there is only one call site.
 394 intptr_t ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
 395   if (UseBiasedLocking) {
 396     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 397     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 398   }
 399 
 400   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 401 
 402   return monitor-&gt;complete_exit(THREAD);
 403 }
 404 
 405 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 406 void ObjectSynchronizer::reenter(Handle obj, intptr_t recursion, TRAPS) {
 407   if (UseBiasedLocking) {
 408     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 409     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 410   }
 411 
 412   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 413 
 414   monitor-&gt;reenter(recursion, THREAD);
 415 }
 416 // -----------------------------------------------------------------------------
 417 // JNI locks on java objects
 418 // NOTE: must use heavy weight monitor to handle jni monitor enter
 419 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 420   // the current locking is from JNI instead of Java code
 421   if (UseBiasedLocking) {
 422     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 423     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 424   }
 425   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 426   inflate(THREAD, obj(), inflate_cause_jni_enter)-&gt;enter(THREAD);
 427   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 428   TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_lock(THREAD, obj()));
 429 }
 430 
 431 // NOTE: must use heavy weight monitor to handle jni monitor exit
 432 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
 433   if (UseBiasedLocking) {
 434     Handle h_obj(THREAD, obj);
 435     BiasedLocking::revoke_and_rebias(h_obj, false, THREAD);
 436     obj = h_obj();
 437   }
 438   assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 439 
 440   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 441   // If this thread has locked the object, exit the monitor.  Note:  can&#39;t use
 442   // monitor-&gt;check(CHECK); must exit even if an exception is pending.
 443   if (monitor-&gt;check(THREAD)) {
 444     TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_unlock(THREAD, obj));
 445     monitor-&gt;exit(true, THREAD);
 446   }
 447 }
 448 
 449 // -----------------------------------------------------------------------------
 450 // Internal VM locks on java objects
 451 // standard constructor, allows locking failures
 452 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool doLock) {
 453   _dolock = doLock;
 454   _thread = thread;
 455   debug_only(if (StrictSafepointChecks) _thread-&gt;check_for_valid_safepoint_state(false);)
 456   _obj = obj;
 457 
 458   if (_dolock) {
 459     ObjectSynchronizer::fast_enter(_obj, &amp;_lock, false, _thread);
 460     TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_lock(_thread, _obj()));
 461   }
 462 }
 463 
 464 ObjectLocker::~ObjectLocker() {
 465   if (_dolock) {
 466     TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_unlock(_thread, _obj()));
 467     ObjectSynchronizer::fast_exit(_obj(), &amp;_lock, _thread);
 468   }
 469 }
 470 
 471 
 472 // -----------------------------------------------------------------------------
 473 //  Wait/Notify/NotifyAll
 474 // NOTE: must use heavy weight monitor to handle wait()
 475 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
 476   if (UseBiasedLocking) {
 477     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 478     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 479   }
 480   if (millis &lt; 0) {
 481     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 482   }
 483   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 484 
 485   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 486 
 487   TSAN_ONLY(int tsan_rec = 0;)
 488   TSAN_RUNTIME_ONLY(
 489     tsan_rec = SharedRuntime::tsan_oop_rec_unlock(THREAD, obj());
 490     assert(tsan_rec &gt; 0, &quot;tsan: unlocking unlocked mutex&quot;);
 491   );
 492 
 493   monitor-&gt;wait(millis, true, THREAD);
 494 
 495   TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_rec_lock(THREAD, obj(), tsan_rec));
 496 
 497   // This dummy call is in place to get around dtrace bug 6254741.  Once
 498   // that&#39;s fixed we can uncomment the following line, remove the call
 499   // and change this function back into a &quot;void&quot; func.
 500   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 501   return dtrace_waited_probe(monitor, obj, THREAD);
 502 }
 503 
 504 void ObjectSynchronizer::waitUninterruptibly(Handle obj, jlong millis, TRAPS) {
 505   if (UseBiasedLocking) {
 506     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 507     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 508   }
 509   if (millis &lt; 0) {
 510     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 511   }
 512   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 513   TSAN_ONLY(int tsan_rec;)
 514   TSAN_RUNTIME_ONLY(
 515     tsan_rec = SharedRuntime::tsan_oop_rec_unlock(THREAD, obj());
 516     assert(tsan_rec &gt; 0, &quot;tsan: unlocking unlocked mutex&quot;);
 517   );
 518   monitor-&gt;wait(millis, false, THREAD);
 519   TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_rec_lock(THREAD, obj(), tsan_rec));
 520 }
 521 
 522 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
 523   if (UseBiasedLocking) {
 524     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 525     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 526   }
 527 
 528   markOop mark = obj-&gt;mark();
 529   if (mark-&gt;has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark-&gt;locker())) {
 530     return;
 531   }
 532   inflate(THREAD, obj(), inflate_cause_notify)-&gt;notify(THREAD);
 533 }
 534 
 535 // NOTE: see comment of notify()
 536 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
 537   if (UseBiasedLocking) {
 538     BiasedLocking::revoke_and_rebias(obj, false, THREAD);
 539     assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 540   }
 541 
 542   markOop mark = obj-&gt;mark();
 543   if (mark-&gt;has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark-&gt;locker())) {
 544     return;
 545   }
 546   inflate(THREAD, obj(), inflate_cause_notify)-&gt;notifyAll(THREAD);
 547 }
 548 
 549 // -----------------------------------------------------------------------------
 550 // Hash Code handling
 551 //
 552 // Performance concern:
 553 // OrderAccess::storestore() calls release() which at one time stored 0
 554 // into the global volatile OrderAccess::dummy variable. This store was
 555 // unnecessary for correctness. Many threads storing into a common location
 556 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 557 // As such, I avoided using OrderAccess::storestore(). In some cases
 558 // OrderAccess::fence() -- which incurs local latency on the executing
 559 // processor -- is a better choice as it scales on SMP systems.
 560 //
 561 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 562 // a discussion of coherency costs. Note that all our current reference
 563 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 564 // x64, and SPARC.
 565 //
 566 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 567 // and explicit fences (barriers) to control for architectural reordering
 568 // performed by the CPU(s) or platform.
 569 
 570 struct SharedGlobals {
 571   char         _pad_prefix[DEFAULT_CACHE_LINE_SIZE];
 572   // These are highly shared mostly-read variables.
 573   // To avoid false-sharing they need to be the sole occupants of a cache line.
 574   volatile int stwRandom;
 575   volatile int stwCycle;
 576   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 577   // Hot RW variable -- Sequester to avoid false-sharing
 578   volatile int hcSequence;
 579   DEFINE_PAD_MINUS_SIZE(2, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));
 580 };
 581 
 582 static SharedGlobals GVars;
 583 static int MonitorScavengeThreshold = 1000000;
 584 static volatile int ForceMonitorScavenge = 0; // Scavenge required and pending
 585 
 586 static markOop ReadStableMark(oop obj) {
 587   markOop mark = obj-&gt;mark();
 588   if (!mark-&gt;is_being_inflated()) {
 589     return mark;       // normal fast-path return
 590   }
 591 
 592   int its = 0;
 593   for (;;) {
 594     markOop mark = obj-&gt;mark();
 595     if (!mark-&gt;is_being_inflated()) {
 596       return mark;    // normal fast-path return
 597     }
 598 
 599     // The object is being inflated by some other thread.
 600     // The caller of ReadStableMark() must wait for inflation to complete.
 601     // Avoid live-lock
 602     // TODO: consider calling SafepointSynchronize::do_call_back() while
 603     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 604     // yielding or blocking would be appropriate.  Avoid spinning while
 605     // there is a safepoint pending.
 606     // TODO: add inflation contention performance counters.
 607     // TODO: restrict the aggregate number of spinners.
 608 
 609     ++its;
 610     if (its &gt; 10000 || !os::is_MP()) {
 611       if (its &amp; 1) {
 612         os::naked_yield();
 613       } else {
 614         // Note that the following code attenuates the livelock problem but is not
 615         // a complete remedy.  A more complete solution would require that the inflating
 616         // thread hold the associated inflation lock.  The following code simply restricts
 617         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 618         // on the inflationlock, 1 thread holding the inflation lock and using
 619         // a yield/park strategy, and 1 thread in the midst of inflation.
 620         // A more refined approach would be to change the encoding of INFLATING
 621         // to allow encapsulation of a native thread pointer.  Threads waiting for
 622         // inflation to complete would use CAS to push themselves onto a singly linked
 623         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 624         // and calling park().  When inflation was complete the thread that accomplished inflation
 625         // would detach the list and set the markword to inflated with a single CAS and
 626         // then for each thread on the list, set the flag and unpark() the thread.
 627         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 628         // wakes at most one thread whereas we need to wake the entire list.
 629         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 630         int YieldThenBlock = 0;
 631         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 632         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 633         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 634         while (obj-&gt;mark() == markOopDesc::INFLATING()) {
 635           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 636           // so we periodically call Self-&gt;_ParkEvent-&gt;park(1).
 637           // We use a mixed spin/yield/block mechanism.
 638           if ((YieldThenBlock++) &gt;= 16) {
 639             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 640           } else {
 641             os::naked_yield();
 642           }
 643         }
 644         Thread::muxRelease(gInflationLocks + ix);
 645       }
 646     } else {
 647       SpinPause();       // SMP-polite spinning
 648     }
 649   }
 650 }
 651 
 652 // hashCode() generation :
 653 //
 654 // Possibilities:
 655 // * MD5Digest of {obj,stwRandom}
 656 // * CRC32 of {obj,stwRandom} or any linear-feedback shift register function.
 657 // * A DES- or AES-style SBox[] mechanism
 658 // * One of the Phi-based schemes, such as:
 659 //   2654435761 = 2^32 * Phi (golden ratio)
 660 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stwRandom ;
 661 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 662 // * (obj ^ stwRandom) is appealing, but can result
 663 //   in undesirable regularity in the hashCode values of adjacent objects
 664 //   (objects allocated back-to-back, in particular).  This could potentially
 665 //   result in hashtable collisions and reduced hashtable efficiency.
 666 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 667 //   generated hashCode values:
 668 
 669 static inline intptr_t get_next_hash(Thread * Self, oop obj) {
 670   intptr_t value = 0;
 671   if (hashCode == 0) {
 672     // This form uses global Park-Miller RNG.
 673     // On MP system we&#39;ll have lots of RW access to a global, so the
 674     // mechanism induces lots of coherency traffic.
 675     value = os::random();
 676   } else if (hashCode == 1) {
 677     // This variation has the property of being stable (idempotent)
 678     // between STW operations.  This can be useful in some of the 1-0
 679     // synchronization schemes.
 680     intptr_t addrBits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 681     value = addrBits ^ (addrBits &gt;&gt; 5) ^ GVars.stwRandom;
 682   } else if (hashCode == 2) {
 683     value = 1;            // for sensitivity testing
 684   } else if (hashCode == 3) {
 685     value = ++GVars.hcSequence;
 686   } else if (hashCode == 4) {
 687     value = cast_from_oop&lt;intptr_t&gt;(obj);
 688   } else {
 689     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 690     // This is probably the best overall implementation -- we&#39;ll
 691     // likely make this the default in future releases.
 692     unsigned t = Self-&gt;_hashStateX;
 693     t ^= (t &lt;&lt; 11);
 694     Self-&gt;_hashStateX = Self-&gt;_hashStateY;
 695     Self-&gt;_hashStateY = Self-&gt;_hashStateZ;
 696     Self-&gt;_hashStateZ = Self-&gt;_hashStateW;
 697     unsigned v = Self-&gt;_hashStateW;
 698     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
 699     Self-&gt;_hashStateW = v;
 700     value = v;
 701   }
 702 
 703   value &amp;= markOopDesc::hash_mask;
 704   if (value == 0) value = 0xBAD;
 705   assert(value != markOopDesc::no_hash, &quot;invariant&quot;);
 706   return value;
 707 }
 708 
 709 intptr_t ObjectSynchronizer::FastHashCode(Thread * Self, oop obj) {
 710   if (UseBiasedLocking) {
 711     // NOTE: many places throughout the JVM do not expect a safepoint
 712     // to be taken here, in particular most operations on perm gen
 713     // objects. However, we only ever bias Java instances and all of
 714     // the call sites of identity_hash that might revoke biases have
 715     // been checked to make sure they can handle a safepoint. The
 716     // added check of the bias pattern is to avoid useless calls to
 717     // thread-local storage.
 718     if (obj-&gt;mark()-&gt;has_bias_pattern()) {
 719       // Handle for oop obj in case of STW safepoint
 720       Handle hobj(Self, obj);
 721       // Relaxing assertion for bug 6320749.
 722       assert(Universe::verify_in_progress() ||
 723              !SafepointSynchronize::is_at_safepoint(),
 724              &quot;biases should not be seen by VM thread here&quot;);
 725       BiasedLocking::revoke_and_rebias(hobj, false, JavaThread::current());
 726       obj = hobj();
 727       assert(!obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 728     }
 729   }
 730 
 731   // hashCode() is a heap mutator ...
 732   // Relaxing assertion for bug 6320749.
 733   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 734          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 735   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 736          Self-&gt;is_Java_thread() , &quot;invariant&quot;);
 737   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 738          ((JavaThread *)Self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 739 
 740   ObjectMonitor* monitor = NULL;
 741   markOop temp, test;
 742   intptr_t hash;
 743   markOop mark = ReadStableMark(obj);
 744 
 745   // object should remain ineligible for biased locking
 746   assert(!mark-&gt;has_bias_pattern(), &quot;invariant&quot;);
 747 
 748   if (mark-&gt;is_neutral()) {
 749     hash = mark-&gt;hash();              // this is a normal header
 750     if (hash != 0) {                  // if it has hash, just return it
 751       return hash;
 752     }
 753     hash = get_next_hash(Self, obj);  // allocate a new hash code
 754     temp = mark-&gt;copy_set_hash(hash); // merge the hash code into header
 755     // use (machine word version) atomic operation to install the hash
 756     test = obj-&gt;cas_set_mark(temp, mark);
 757     if (test == mark) {
 758       return hash;
 759     }
 760     // If atomic operation failed, we must inflate the header
 761     // into heavy weight monitor. We could add more code here
 762     // for fast path, but it does not worth the complexity.
 763   } else if (mark-&gt;has_monitor()) {
 764     monitor = mark-&gt;monitor();
 765     temp = monitor-&gt;header();
 766     assert(temp-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)temp));
 767     hash = temp-&gt;hash();
 768     if (hash != 0) {
 769       return hash;
 770     }
 771     // Skip to the following code to reduce code size
 772   } else if (Self-&gt;is_lock_owned((address)mark-&gt;locker())) {
 773     temp = mark-&gt;displaced_mark_helper(); // this is a lightweight monitor owned
 774     assert(temp-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)temp));
 775     hash = temp-&gt;hash();              // by current thread, check if the displaced
 776     if (hash != 0) {                  // header contains hash code
 777       return hash;
 778     }
 779     // WARNING:
 780     //   The displaced header is strictly immutable.
 781     // It can NOT be changed in ANY cases. So we have
 782     // to inflate the header into heavyweight monitor
 783     // even the current thread owns the lock. The reason
 784     // is the BasicLock (stack slot) will be asynchronously
 785     // read by other threads during the inflate() function.
 786     // Any change to stack may not propagate to other threads
 787     // correctly.
 788   }
 789 
 790   // Inflate the monitor to set hash code
 791   monitor = inflate(Self, obj, inflate_cause_hash_code);
 792   // Load displaced header and check it has hash code
 793   mark = monitor-&gt;header();
 794   assert(mark-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)mark));
 795   hash = mark-&gt;hash();
 796   if (hash == 0) {
 797     hash = get_next_hash(Self, obj);
 798     temp = mark-&gt;copy_set_hash(hash); // merge hash code into header
 799     assert(temp-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)temp));
 800     test = Atomic::cmpxchg(temp, monitor-&gt;header_addr(), mark);
 801     if (test != mark) {
 802       // The only update to the header in the monitor (outside GC)
 803       // is install the hash code. If someone add new usage of
 804       // displaced header, please update this code
 805       hash = test-&gt;hash();
 806       assert(test-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)test));
 807       assert(hash != 0, &quot;Trivial unexpected object/monitor header usage.&quot;);
 808     }
 809   }
 810   // We finally get the hash
 811   return hash;
 812 }
 813 
 814 // Deprecated -- use FastHashCode() instead.
 815 
 816 intptr_t ObjectSynchronizer::identity_hash_value_for(Handle obj) {
 817   return FastHashCode(Thread::current(), obj());
 818 }
 819 
 820 
 821 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
 822                                                    Handle h_obj) {
 823   if (UseBiasedLocking) {
 824     BiasedLocking::revoke_and_rebias(h_obj, false, thread);
 825     assert(!h_obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 826   }
 827 
 828   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
 829   oop obj = h_obj();
 830 
 831   markOop mark = ReadStableMark(obj);
 832 
 833   // Uncontended case, header points to stack
 834   if (mark-&gt;has_locker()) {
 835     return thread-&gt;is_lock_owned((address)mark-&gt;locker());
 836   }
 837   // Contended case, header points to ObjectMonitor (tagged pointer)
 838   if (mark-&gt;has_monitor()) {
 839     ObjectMonitor* monitor = mark-&gt;monitor();
 840     return monitor-&gt;is_entered(thread) != 0;
 841   }
 842   // Unlocked case, header in place
 843   assert(mark-&gt;is_neutral(), &quot;sanity check&quot;);
 844   return false;
 845 }
 846 
 847 // Be aware of this method could revoke bias of the lock object.
 848 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
 849 // If the current thread owns the lock, it returns owner_self. If no
 850 // thread owns the lock, it returns owner_none. Otherwise, it will return
 851 // owner_other.
 852 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
 853 (JavaThread *self, Handle h_obj) {
 854   // The caller must beware this method can revoke bias, and
 855   // revocation can result in a safepoint.
 856   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 857   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 858 
 859   // Possible mark states: neutral, biased, stack-locked, inflated
 860 
 861   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark()-&gt;has_bias_pattern()) {
 862     // CASE: biased
 863     BiasedLocking::revoke_and_rebias(h_obj, false, self);
 864     assert(!h_obj-&gt;mark()-&gt;has_bias_pattern(),
 865            &quot;biases should be revoked by now&quot;);
 866   }
 867 
 868   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
 869   oop obj = h_obj();
 870   markOop mark = ReadStableMark(obj);
 871 
 872   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
 873   if (mark-&gt;has_locker()) {
 874     return self-&gt;is_lock_owned((address)mark-&gt;locker()) ?
 875       owner_self : owner_other;
 876   }
 877 
 878   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
 879   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
 880   // not at a safepoint.
 881   if (mark-&gt;has_monitor()) {
 882     void * owner = mark-&gt;monitor()-&gt;_owner;
 883     if (owner == NULL) return owner_none;
 884     return (owner == self ||
 885             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
 886   }
 887 
 888   // CASE: neutral
 889   assert(mark-&gt;is_neutral(), &quot;sanity check&quot;);
 890   return owner_none;           // it&#39;s unlocked
 891 }
 892 
 893 // FIXME: jvmti should call this
 894 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
 895   if (UseBiasedLocking) {
 896     if (SafepointSynchronize::is_at_safepoint()) {
 897       BiasedLocking::revoke_at_safepoint(h_obj);
 898     } else {
 899       BiasedLocking::revoke_and_rebias(h_obj, false, JavaThread::current());
 900     }
 901     assert(!h_obj-&gt;mark()-&gt;has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 902   }
 903 
 904   oop obj = h_obj();
 905   address owner = NULL;
 906 
 907   markOop mark = ReadStableMark(obj);
 908 
 909   // Uncontended case, header points to stack
 910   if (mark-&gt;has_locker()) {
 911     owner = (address) mark-&gt;locker();
 912   }
 913 
 914   // Contended case, header points to ObjectMonitor (tagged pointer)
 915   else if (mark-&gt;has_monitor()) {
 916     ObjectMonitor* monitor = mark-&gt;monitor();
 917     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
 918     owner = (address) monitor-&gt;owner();
 919   }
 920 
 921   if (owner != NULL) {
 922     // owning_thread_from_monitor_owner() may also return NULL here
 923     return Threads::owning_thread_from_monitor_owner(t_list, owner);
 924   }
 925 
 926   // Unlocked case, header in place
 927   // Cannot have assertion since this object may have been
 928   // locked by another thread when reaching here.
 929   // assert(mark-&gt;is_neutral(), &quot;sanity check&quot;);
 930 
 931   return NULL;
 932 }
 933 
 934 // Visitors ...
 935 
 936 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
 937   PaddedEnd&lt;ObjectMonitor&gt; * block = OrderAccess::load_acquire(&amp;gBlockList);
 938   while (block != NULL) {
 939     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
 940     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
 941       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
 942       oop object = (oop)mid-&gt;object();
 943       if (object != NULL) {
 944         closure-&gt;do_monitor(mid);
 945       }
 946     }
 947     block = (PaddedEnd&lt;ObjectMonitor&gt; *)block-&gt;FreeNext;
 948   }
 949 }
 950 
 951 // Get the next block in the block list.
 952 static inline PaddedEnd&lt;ObjectMonitor&gt;* next(PaddedEnd&lt;ObjectMonitor&gt;* block) {
 953   assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
 954   block = (PaddedEnd&lt;ObjectMonitor&gt;*) block-&gt;FreeNext;
 955   assert(block == NULL || block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
 956   return block;
 957 }
 958 
 959 static bool monitors_used_above_threshold() {
 960   if (gMonitorPopulation == 0) {
 961     return false;
 962   }
 963   int monitors_used = gMonitorPopulation - gMonitorFreeCount;
 964   int monitor_usage = (monitors_used * 100LL) / gMonitorPopulation;
 965   return monitor_usage &gt; MonitorUsedDeflationThreshold;
 966 }
 967 
 968 bool ObjectSynchronizer::is_cleanup_needed() {
 969   if (MonitorUsedDeflationThreshold &gt; 0) {
 970     return monitors_used_above_threshold();
 971   }
 972   return false;
 973 }
 974 
 975 void ObjectSynchronizer::oops_do(OopClosure* f) {
 976   // We only scan the global used list here (for moribund threads), and
 977   // the thread-local monitors in Thread::oops_do().
 978   global_used_oops_do(f);
 979 }
 980 
 981 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
 982   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
 983   list_oops_do(gOmInUseList, f);
 984 }
 985 
 986 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
 987   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
 988   list_oops_do(thread-&gt;omInUseList, f);
 989 }
 990 
 991 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
 992   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
 993   ObjectMonitor* mid;
 994   for (mid = list; mid != NULL; mid = mid-&gt;FreeNext) {
 995     if (mid-&gt;object() != NULL) {
 996       f-&gt;do_oop((oop*)mid-&gt;object_addr());
 997     }
 998   }
 999 }
1000 
1001 
1002 // -----------------------------------------------------------------------------
1003 // ObjectMonitor Lifecycle
1004 // -----------------------
1005 // Inflation unlinks monitors from the global gFreeList and
1006 // associates them with objects.  Deflation -- which occurs at
1007 // STW-time -- disassociates idle monitors from objects.  Such
1008 // scavenged monitors are returned to the gFreeList.
1009 //
1010 // The global list is protected by gListLock.  All the critical sections
1011 // are short and operate in constant-time.
1012 //
1013 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1014 //
1015 // Lifecycle:
1016 // --   unassigned and on the global free list
1017 // --   unassigned and on a thread&#39;s private omFreeList
1018 // --   assigned to an object.  The object is inflated and the mark refers
1019 //      to the objectmonitor.
1020 
1021 
1022 // Constraining monitor pool growth via MonitorBound ...
1023 //
1024 // The monitor pool is grow-only.  We scavenge at STW safepoint-time, but the
1025 // the rate of scavenging is driven primarily by GC.  As such,  we can find
1026 // an inordinate number of monitors in circulation.
1027 // To avoid that scenario we can artificially induce a STW safepoint
1028 // if the pool appears to be growing past some reasonable bound.
1029 // Generally we favor time in space-time tradeoffs, but as there&#39;s no
1030 // natural back-pressure on the # of extant monitors we need to impose some
1031 // type of limit.  Beware that if MonitorBound is set to too low a value
1032 // we could just loop. In addition, if MonitorBound is set to a low value
1033 // we&#39;ll incur more safepoints, which are harmful to performance.
1034 // See also: GuaranteedSafepointInterval
1035 //
1036 // The current implementation uses asynchronous VM operations.
1037 
1038 static void InduceScavenge(Thread * Self, const char * Whence) {
1039   // Induce STW safepoint to trim monitors
1040   // Ultimately, this results in a call to deflate_idle_monitors() in the near future.
1041   // More precisely, trigger an asynchronous STW safepoint as the number
1042   // of active monitors passes the specified threshold.
1043   // TODO: assert thread state is reasonable
1044 
1045   if (ForceMonitorScavenge == 0 &amp;&amp; Atomic::xchg (1, &amp;ForceMonitorScavenge) == 0) {
1046     // Induce a &#39;null&#39; safepoint to scavenge monitors
1047     // Must VM_Operation instance be heap allocated as the op will be enqueue and posted
1048     // to the VMthread and have a lifespan longer than that of this activation record.
1049     // The VMThread will delete the op when completed.
1050     VMThread::execute(new VM_ScavengeMonitors());
1051   }
1052 }
1053 
1054 ObjectMonitor* ObjectSynchronizer::omAlloc(Thread * Self) {
1055   // A large MAXPRIVATE value reduces both list lock contention
1056   // and list coherency traffic, but also tends to increase the
1057   // number of objectMonitors in circulation as well as the STW
1058   // scavenge costs.  As usual, we lean toward time in space-time
1059   // tradeoffs.
1060   const int MAXPRIVATE = 1024;
1061   for (;;) {
1062     ObjectMonitor * m;
1063 
1064     // 1: try to allocate from the thread&#39;s local omFreeList.
1065     // Threads will attempt to allocate first from their local list, then
1066     // from the global list, and only after those attempts fail will the thread
1067     // attempt to instantiate new monitors.   Thread-local free lists take
1068     // heat off the gListLock and improve allocation latency, as well as reducing
1069     // coherency traffic on the shared global list.
1070     m = Self-&gt;omFreeList;
1071     if (m != NULL) {
1072       Self-&gt;omFreeList = m-&gt;FreeNext;
1073       Self-&gt;omFreeCount--;
1074       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1075       m-&gt;FreeNext = Self-&gt;omInUseList;
1076       Self-&gt;omInUseList = m;
1077       Self-&gt;omInUseCount++;
1078       return m;
1079     }
1080 
1081     // 2: try to allocate from the global gFreeList
1082     // CONSIDER: use muxTry() instead of muxAcquire().
1083     // If the muxTry() fails then drop immediately into case 3.
1084     // If we&#39;re using thread-local free lists then try
1085     // to reprovision the caller&#39;s free list.
1086     if (gFreeList != NULL) {
1087       // Reprovision the thread&#39;s omFreeList.
1088       // Use bulk transfers to reduce the allocation rate and heat
1089       // on various locks.
1090       Thread::muxAcquire(&amp;gListLock, &quot;omAlloc(1)&quot;);
1091       for (int i = Self-&gt;omFreeProvision; --i &gt;= 0 &amp;&amp; gFreeList != NULL;) {
1092         gMonitorFreeCount--;
1093         ObjectMonitor * take = gFreeList;
1094         gFreeList = take-&gt;FreeNext;
1095         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1096         guarantee(!take-&gt;is_busy(), &quot;invariant&quot;);
1097         take-&gt;Recycle();
1098         omRelease(Self, take, false);
1099       }
1100       Thread::muxRelease(&amp;gListLock);
1101       Self-&gt;omFreeProvision += 1 + (Self-&gt;omFreeProvision/2);
1102       if (Self-&gt;omFreeProvision &gt; MAXPRIVATE) Self-&gt;omFreeProvision = MAXPRIVATE;
1103 
1104       const int mx = MonitorBound;
1105       if (mx &gt; 0 &amp;&amp; (gMonitorPopulation-gMonitorFreeCount) &gt; mx) {
1106         // We can&#39;t safely induce a STW safepoint from omAlloc() as our thread
1107         // state may not be appropriate for such activities and callers may hold
1108         // naked oops, so instead we defer the action.
1109         InduceScavenge(Self, &quot;omAlloc&quot;);
1110       }
1111       continue;
1112     }
1113 
1114     // 3: allocate a block of new ObjectMonitors
1115     // Both the local and global free lists are empty -- resort to malloc().
1116     // In the current implementation objectMonitors are TSM - immortal.
1117     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1118     // each ObjectMonitor to start at the beginning of a cache line,
1119     // so we use align_up().
1120     // A better solution would be to use C++ placement-new.
1121     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1122     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1123     size_t neededsize = sizeof(PaddedEnd&lt;ObjectMonitor&gt;) * _BLOCKSIZE;
1124     PaddedEnd&lt;ObjectMonitor&gt; * temp;
1125     size_t aligned_size = neededsize + (DEFAULT_CACHE_LINE_SIZE - 1);
1126     void* real_malloc_addr = (void *)NEW_C_HEAP_ARRAY(char, aligned_size,
1127                                                       mtInternal);
1128     temp = (PaddedEnd&lt;ObjectMonitor&gt; *)
1129              align_up(real_malloc_addr, DEFAULT_CACHE_LINE_SIZE);
1130 
1131     // NOTE: (almost) no way to recover if allocation failed.
1132     // We might be able to induce a STW safepoint and scavenge enough
1133     // objectMonitors to permit progress.
1134     if (temp == NULL) {
1135       vm_exit_out_of_memory(neededsize, OOM_MALLOC_ERROR,
1136                             &quot;Allocate ObjectMonitors&quot;);
1137     }
1138     (void)memset((void *) temp, 0, neededsize);
1139 
1140     // Format the block.
1141     // initialize the linked list, each monitor points to its next
1142     // forming the single linked free list, the very first monitor
1143     // will points to next block, which forms the block list.
1144     // The trick of using the 1st element in the block as gBlockList
1145     // linkage should be reconsidered.  A better implementation would
1146     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1147 
1148     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1149       temp[i].FreeNext = (ObjectMonitor *)&amp;temp[i+1];
1150     }
1151 
1152     // terminate the last monitor as the end of list
1153     temp[_BLOCKSIZE - 1].FreeNext = NULL;
1154 
1155     // Element [0] is reserved for global list linkage
1156     temp[0].set_object(CHAINMARKER);
1157 
1158     // Consider carving out this thread&#39;s current request from the
1159     // block in hand.  This avoids some lock traffic and redundant
1160     // list activity.
1161 
1162     // Acquire the gListLock to manipulate gBlockList and gFreeList.
1163     // An Oyama-Taura-Yonezawa scheme might be more efficient.
1164     Thread::muxAcquire(&amp;gListLock, &quot;omAlloc(2)&quot;);
1165     gMonitorPopulation += _BLOCKSIZE-1;
1166     gMonitorFreeCount += _BLOCKSIZE-1;
1167 
1168     // Add the new block to the list of extant blocks (gBlockList).
1169     // The very first objectMonitor in a block is reserved and dedicated.
1170     // It serves as blocklist &quot;next&quot; linkage.
1171     temp[0].FreeNext = gBlockList;
1172     // There are lock-free uses of gBlockList so make sure that
1173     // the previous stores happen before we update gBlockList.
1174     OrderAccess::release_store(&amp;gBlockList, temp);
1175 
1176     // Add the new string of objectMonitors to the global free list
1177     temp[_BLOCKSIZE - 1].FreeNext = gFreeList;
1178     gFreeList = temp + 1;
1179     Thread::muxRelease(&amp;gListLock);
1180   }
1181 }
1182 
1183 // Place &quot;m&quot; on the caller&#39;s private per-thread omFreeList.
1184 // In practice there&#39;s no need to clamp or limit the number of
1185 // monitors on a thread&#39;s omFreeList as the only time we&#39;ll call
1186 // omRelease is to return a monitor to the free list after a CAS
1187 // attempt failed.  This doesn&#39;t allow unbounded #s of monitors to
1188 // accumulate on a thread&#39;s free list.
1189 //
1190 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1191 // free list must have their object field set to null. This prevents the
1192 // scavenger -- deflate_monitor_list() -- from reclaiming them.
1193 
1194 void ObjectSynchronizer::omRelease(Thread * Self, ObjectMonitor * m,
1195                                    bool fromPerThreadAlloc) {
1196   guarantee(m-&gt;header() == NULL, &quot;invariant&quot;);
1197   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1198   guarantee(((m-&gt;is_busy()|m-&gt;_recursions) == 0), &quot;freeing in-use monitor&quot;);
1199   // Remove from omInUseList
1200   if (fromPerThreadAlloc) {
1201     ObjectMonitor* cur_mid_in_use = NULL;
1202     bool extracted = false;
1203     for (ObjectMonitor* mid = Self-&gt;omInUseList; mid != NULL; cur_mid_in_use = mid, mid = mid-&gt;FreeNext) {
1204       if (m == mid) {
1205         // extract from per-thread in-use list
1206         if (mid == Self-&gt;omInUseList) {
1207           Self-&gt;omInUseList = mid-&gt;FreeNext;
1208         } else if (cur_mid_in_use != NULL) {
1209           cur_mid_in_use-&gt;FreeNext = mid-&gt;FreeNext; // maintain the current thread in-use list
1210         }
1211         extracted = true;
1212         Self-&gt;omInUseCount--;
1213         break;
1214       }
1215     }
1216     assert(extracted, &quot;Should have extracted from in-use list&quot;);
1217   }
1218 
1219   // FreeNext is used for both omInUseList and omFreeList, so clear old before setting new
1220   m-&gt;FreeNext = Self-&gt;omFreeList;
1221   Self-&gt;omFreeList = m;
1222   Self-&gt;omFreeCount++;
1223 }
1224 
1225 // Return the monitors of a moribund thread&#39;s local free list to
1226 // the global free list.  Typically a thread calls omFlush() when
1227 // it&#39;s dying.  We could also consider having the VM thread steal
1228 // monitors from threads that have not run java code over a few
1229 // consecutive STW safepoints.  Relatedly, we might decay
1230 // omFreeProvision at STW safepoints.
1231 //
1232 // Also return the monitors of a moribund thread&#39;s omInUseList to
1233 // a global gOmInUseList under the global list lock so these
1234 // will continue to be scanned.
1235 //
1236 // We currently call omFlush() from Threads::remove() _before the thread
1237 // has been excised from the thread list and is no longer a mutator.
1238 // This means that omFlush() cannot run concurrently with a safepoint and
1239 // interleave with the deflate_idle_monitors scavenge operator. In particular,
1240 // this ensures that the thread&#39;s monitors are scanned by a GC safepoint,
1241 // either via Thread::oops_do() (if safepoint happens before omFlush()) or via
1242 // ObjectSynchronizer::oops_do() (if it happens after omFlush() and the thread&#39;s
1243 // monitors have been transferred to the global in-use list).
1244 
1245 void ObjectSynchronizer::omFlush(Thread * Self) {
1246   ObjectMonitor * list = Self-&gt;omFreeList;  // Null-terminated SLL
1247   ObjectMonitor * tail = NULL;
1248   int tally = 0;
1249   if (list != NULL) {
1250     ObjectMonitor * s;
1251     // The thread is going away, the per-thread free monitors
1252     // are freed via set_owner(NULL)
1253     // Link them to tail, which will be linked into the global free list
1254     // gFreeList below, under the gListLock
1255     for (s = list; s != NULL; s = s-&gt;FreeNext) {
1256       tally++;
1257       tail = s;
1258       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1259       guarantee(!s-&gt;is_busy(), &quot;invariant&quot;);
1260       s-&gt;set_owner(NULL);   // redundant but good hygiene
1261     }
1262     guarantee(tail != NULL, &quot;invariant&quot;);
1263     assert(Self-&gt;omFreeCount == tally, &quot;free-count off&quot;);
1264     Self-&gt;omFreeList = NULL;
1265     Self-&gt;omFreeCount = 0;
1266   }
1267 
1268   ObjectMonitor * inUseList = Self-&gt;omInUseList;
1269   ObjectMonitor * inUseTail = NULL;
1270   int inUseTally = 0;
1271   if (inUseList != NULL) {
1272     ObjectMonitor *cur_om;
1273     // The thread is going away, however the omInUseList inflated
1274     // monitors may still be in-use by other threads.
1275     // Link them to inUseTail, which will be linked into the global in-use list
1276     // gOmInUseList below, under the gListLock
1277     for (cur_om = inUseList; cur_om != NULL; cur_om = cur_om-&gt;FreeNext) {
1278       inUseTail = cur_om;
1279       inUseTally++;
1280     }
1281     guarantee(inUseTail != NULL, &quot;invariant&quot;);
1282     assert(Self-&gt;omInUseCount == inUseTally, &quot;in-use count off&quot;);
1283     Self-&gt;omInUseList = NULL;
1284     Self-&gt;omInUseCount = 0;
1285   }
1286 
1287   Thread::muxAcquire(&amp;gListLock, &quot;omFlush&quot;);
1288   if (tail != NULL) {
1289     tail-&gt;FreeNext = gFreeList;
1290     gFreeList = list;
1291     gMonitorFreeCount += tally;
1292   }
1293 
1294   if (inUseTail != NULL) {
1295     inUseTail-&gt;FreeNext = gOmInUseList;
1296     gOmInUseList = inUseList;
1297     gOmInUseCount += inUseTally;
1298   }
1299 
1300   Thread::muxRelease(&amp;gListLock);
1301 }
1302 
1303 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1304                                        const oop obj,
1305                                        ObjectSynchronizer::InflateCause cause) {
1306   assert(event != NULL, &quot;invariant&quot;);
1307   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1308   event-&gt;set_monitorClass(obj-&gt;klass());
1309   event-&gt;set_address((uintptr_t)(void*)obj);
1310   event-&gt;set_cause((u1)cause);
1311   event-&gt;commit();
1312 }
1313 
1314 // Fast path code shared by multiple functions
1315 void ObjectSynchronizer::inflate_helper(oop obj) {
1316   markOop mark = obj-&gt;mark();
1317   if (mark-&gt;has_monitor()) {
1318     assert(ObjectSynchronizer::verify_objmon_isinpool(mark-&gt;monitor()), &quot;monitor is invalid&quot;);
1319     assert(mark-&gt;monitor()-&gt;header()-&gt;is_neutral(), &quot;monitor must record a good object header&quot;);
1320     return;
1321   }
1322   inflate(Thread::current(), obj, inflate_cause_vm_internal);
1323 }
1324 
1325 ObjectMonitor* ObjectSynchronizer::inflate(Thread * Self,
1326                                            oop object,
1327                                            const InflateCause cause) {
1328   // Inflate mutates the heap ...
1329   // Relaxing assertion for bug 6320749.
1330   assert(Universe::verify_in_progress() ||
1331          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1332 
1333   EventJavaMonitorInflate event;
1334 
1335   for (;;) {
1336     const markOop mark = object-&gt;mark();
1337     assert(!mark-&gt;has_bias_pattern(), &quot;invariant&quot;);
1338 
1339     // The mark can be in one of the following states:
1340     // *  Inflated     - just return
1341     // *  Stack-locked - coerce it to inflated
1342     // *  INFLATING    - busy wait for conversion to complete
1343     // *  Neutral      - aggressively inflate the object.
1344     // *  BIASED       - Illegal.  We should never see this
1345 
1346     // CASE: inflated
1347     if (mark-&gt;has_monitor()) {
1348       ObjectMonitor * inf = mark-&gt;monitor();
1349       markOop dmw = inf-&gt;header();
1350       assert(dmw-&gt;is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, p2i((address)dmw));
1351       assert(oopDesc::equals((oop) inf-&gt;object(), object), &quot;invariant&quot;);
1352       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1353       return inf;
1354     }
1355 
1356     // CASE: inflation in progress - inflating over a stack-lock.
1357     // Some other thread is converting from stack-locked to inflated.
1358     // Only that thread can complete inflation -- other threads must wait.
1359     // The INFLATING value is transient.
1360     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1361     // We could always eliminate polling by parking the thread on some auxiliary list.
1362     if (mark == markOopDesc::INFLATING()) {
1363       ReadStableMark(object);
1364       continue;
1365     }
1366 
1367     // CASE: stack-locked
1368     // Could be stack-locked either by this thread or by some other thread.
1369     //
1370     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1371     // to install INFLATING into the mark word.  We originally installed INFLATING,
1372     // allocated the objectmonitor, and then finally STed the address of the
1373     // objectmonitor into the mark.  This was correct, but artificially lengthened
1374     // the interval in which INFLATED appeared in the mark, thus increasing
1375     // the odds of inflation contention.
1376     //
1377     // We now use per-thread private objectmonitor free lists.
1378     // These list are reprovisioned from the global free list outside the
1379     // critical INFLATING...ST interval.  A thread can transfer
1380     // multiple objectmonitors en-mass from the global free list to its local free list.
1381     // This reduces coherency traffic and lock contention on the global free list.
1382     // Using such local free lists, it doesn&#39;t matter if the omAlloc() call appears
1383     // before or after the CAS(INFLATING) operation.
1384     // See the comments in omAlloc().
1385 
1386     LogStreamHandle(Trace, monitorinflation) lsh;
1387 
1388     if (mark-&gt;has_locker()) {
1389       ObjectMonitor * m = omAlloc(Self);
1390       // Optimistically prepare the objectmonitor - anticipate successful CAS
1391       // We do this before the CAS in order to minimize the length of time
1392       // in which INFLATING appears in the mark.
1393       m-&gt;Recycle();
1394       m-&gt;_Responsible  = NULL;
1395       m-&gt;_recursions   = 0;
1396       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1397 
1398       markOop cmp = object-&gt;cas_set_mark(markOopDesc::INFLATING(), mark);
1399       if (cmp != mark) {
1400         omRelease(Self, m, true);
1401         continue;       // Interference -- just retry
1402       }
1403 
1404       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1405       // This is the only case where 0 will appear in a mark-word.
1406       // Only the singular thread that successfully swings the mark-word
1407       // to 0 can perform (or more precisely, complete) inflation.
1408       //
1409       // Why do we CAS a 0 into the mark-word instead of just CASing the
1410       // mark-word from the stack-locked value directly to the new inflated state?
1411       // Consider what happens when a thread unlocks a stack-locked object.
1412       // It attempts to use CAS to swing the displaced header value from the
1413       // on-stack basiclock back into the object header.  Recall also that the
1414       // header value (hashcode, etc) can reside in (a) the object header, or
1415       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1416       // header in an objectMonitor.  The inflate() routine must copy the header
1417       // value from the basiclock on the owner&#39;s stack to the objectMonitor, all
1418       // the while preserving the hashCode stability invariants.  If the owner
1419       // decides to release the lock while the value is 0, the unlock will fail
1420       // and control will eventually pass from slow_exit() to inflate.  The owner
1421       // will then spin, waiting for the 0 value to disappear.   Put another way,
1422       // the 0 causes the owner to stall if the owner happens to try to
1423       // drop the lock (restoring the header from the basiclock to the object)
1424       // while inflation is in-progress.  This protocol avoids races that might
1425       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1426       // Critically, while object-&gt;mark is 0 mark-&gt;displaced_mark_helper() is stable.
1427       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1428 
1429 
1430       // fetch the displaced mark from the owner&#39;s stack.
1431       // The owner can&#39;t die or unwind past the lock while our INFLATING
1432       // object is in the mark.  Furthermore the owner can&#39;t complete
1433       // an unlock on the object, either.
1434       markOop dmw = mark-&gt;displaced_mark_helper();
1435       assert(dmw-&gt;is_neutral(), &quot;invariant&quot;);
1436 
1437       // Setup monitor fields to proper values -- prepare the monitor
1438       m-&gt;set_header(dmw);
1439 
1440       // Optimization: if the mark-&gt;locker stack address is associated
1441       // with this thread we could simply set m-&gt;_owner = Self.
1442       // Note that a thread can inflate an object
1443       // that it has stack-locked -- as might happen in wait() -- directly
1444       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1445       m-&gt;set_owner(mark-&gt;locker());
1446       m-&gt;set_object(object);
1447       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1448 
1449       // Must preserve store ordering. The monitor state must
1450       // be stable at the time of publishing the monitor address.
1451       guarantee(object-&gt;mark() == markOopDesc::INFLATING(), &quot;invariant&quot;);
1452       object-&gt;release_set_mark(markOopDesc::encode(m));
1453 
1454       // Hopefully the performance counters are allocated on distinct cache lines
1455       // to avoid false sharing on MP systems ...
1456       OM_PERFDATA_OP(Inflations, inc());
1457       if (log_is_enabled(Trace, monitorinflation)) {
1458         ResourceMark rm(Self);
1459         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1460                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1461                      p2i(object-&gt;mark()), object-&gt;klass()-&gt;external_name());
1462       }
1463       if (event.should_commit()) {
1464         post_monitor_inflate_event(&amp;event, object, cause);
1465       }
1466       return m;
1467     }
1468 
1469     // CASE: neutral
1470     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1471     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1472     // pre-locked objectMonitor pointer into the object header.   A successful
1473     // CAS inflates the object *and* confers ownership to the inflating thread.
1474     // In the current implementation we use a 2-step mechanism where we CAS()
1475     // to inflate and then CAS() again to try to swing _owner from NULL to Self.
1476     // An inflateTry() method that we could call from fast_enter() and slow_enter()
1477     // would be useful.
1478 
1479     assert(mark-&gt;is_neutral(), &quot;invariant&quot;);
1480     ObjectMonitor * m = omAlloc(Self);
1481     // prepare m for installation - set monitor to initial state
1482     m-&gt;Recycle();
1483     m-&gt;set_header(mark);
1484     m-&gt;set_owner(NULL);
1485     m-&gt;set_object(object);
1486     m-&gt;_recursions   = 0;
1487     m-&gt;_Responsible  = NULL;
1488     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
1489 
1490     if (object-&gt;cas_set_mark(markOopDesc::encode(m), mark) != mark) {
1491       m-&gt;set_header(NULL);
1492       m-&gt;set_object(NULL);
1493       m-&gt;Recycle();
1494       omRelease(Self, m, true);
1495       m = NULL;
1496       continue;
1497       // interference - the markword changed - just retry.
1498       // The state-transitions are one-way, so there&#39;s no chance of
1499       // live-lock -- &quot;Inflated&quot; is an absorbing state.
1500     }
1501 
1502     // Hopefully the performance counters are allocated on distinct
1503     // cache lines to avoid false sharing on MP systems ...
1504     OM_PERFDATA_OP(Inflations, inc());
1505     if (log_is_enabled(Trace, monitorinflation)) {
1506       ResourceMark rm(Self);
1507       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1508                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1509                    p2i(object-&gt;mark()), object-&gt;klass()-&gt;external_name());
1510     }
1511     if (event.should_commit()) {
1512       post_monitor_inflate_event(&amp;event, object, cause);
1513     }
1514     return m;
1515   }
1516 }
1517 
1518 
1519 // We create a list of in-use monitors for each thread.
1520 //
1521 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
1522 // deflate_idle_monitors() scans only a global list of in-use monitors which
1523 // is populated only as a thread dies (see omFlush()).
1524 //
1525 // These operations are called at all safepoints, immediately after mutators
1526 // are stopped, but before any objects have moved. Collectively they traverse
1527 // the population of in-use monitors, deflating where possible. The scavenged
1528 // monitors are returned to the monitor free list.
1529 //
1530 // Beware that we scavenge at *every* stop-the-world point. Having a large
1531 // number of monitors in-use could negatively impact performance. We also want
1532 // to minimize the total # of monitors in circulation, as they incur a small
1533 // footprint penalty.
1534 //
1535 // Perversely, the heap size -- and thus the STW safepoint rate --
1536 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
1537 // which in turn can mean large(r) numbers of objectmonitors in circulation.
1538 // This is an unfortunate aspect of this design.
1539 
1540 // Deflate a single monitor if not in-use
1541 // Return true if deflated, false if in-use
1542 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
1543                                          ObjectMonitor** freeHeadp,
1544                                          ObjectMonitor** freeTailp) {
1545   bool deflated;
1546   // Normal case ... The monitor is associated with obj.
1547   guarantee(obj-&gt;mark() == markOopDesc::encode(mid), &quot;invariant&quot;);
1548   guarantee(mid == obj-&gt;mark()-&gt;monitor(), &quot;invariant&quot;);
1549   guarantee(mid-&gt;header()-&gt;is_neutral(), &quot;invariant&quot;);
1550 
1551   if (mid-&gt;is_busy()) {
1552     deflated = false;
1553   } else {
1554     // Deflate the monitor if it is no longer being used
1555     // It&#39;s idle - scavenge and return to the global free list
1556     // plain old deflation ...
1557     if (log_is_enabled(Trace, monitorinflation)) {
1558       ResourceMark rm;
1559       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
1560                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;,
1561                                   p2i(obj), p2i(obj-&gt;mark()),
1562                                   obj-&gt;klass()-&gt;external_name());
1563     }
1564 
1565     // Restore the header back to obj
1566     obj-&gt;release_set_mark(mid-&gt;header());
1567     mid-&gt;clear();
1568 
1569     assert(mid-&gt;object() == NULL, &quot;invariant&quot;);
1570 
1571     // Move the object to the working free list defined by freeHeadp, freeTailp
1572     if (*freeHeadp == NULL) *freeHeadp = mid;
1573     if (*freeTailp != NULL) {
1574       ObjectMonitor * prevtail = *freeTailp;
1575       assert(prevtail-&gt;FreeNext == NULL, &quot;cleaned up deflated?&quot;);
1576       prevtail-&gt;FreeNext = mid;
1577     }
1578     *freeTailp = mid;
1579     deflated = true;
1580   }
1581   return deflated;
1582 }
1583 
1584 // Walk a given monitor list, and deflate idle monitors
1585 // The given list could be a per-thread list or a global list
1586 // Caller acquires gListLock as needed.
1587 //
1588 // In the case of parallel processing of thread local monitor lists,
1589 // work is done by Threads::parallel_threads_do() which ensures that
1590 // each Java thread is processed by exactly one worker thread, and
1591 // thus avoid conflicts that would arise when worker threads would
1592 // process the same monitor lists concurrently.
1593 //
1594 // See also ParallelSPCleanupTask and
1595 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
1596 // Threads::parallel_java_threads_do() in thread.cpp.
1597 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** listHeadp,
1598                                              ObjectMonitor** freeHeadp,
1599                                              ObjectMonitor** freeTailp) {
1600   ObjectMonitor* mid;
1601   ObjectMonitor* next;
1602   ObjectMonitor* cur_mid_in_use = NULL;
1603   int deflated_count = 0;
1604 
1605   for (mid = *listHeadp; mid != NULL;) {
1606     oop obj = (oop) mid-&gt;object();
1607     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, freeHeadp, freeTailp)) {
1608       // if deflate_monitor succeeded,
1609       // extract from per-thread in-use list
1610       if (mid == *listHeadp) {
1611         *listHeadp = mid-&gt;FreeNext;
1612       } else if (cur_mid_in_use != NULL) {
1613         cur_mid_in_use-&gt;FreeNext = mid-&gt;FreeNext; // maintain the current thread in-use list
1614       }
1615       next = mid-&gt;FreeNext;
1616       mid-&gt;FreeNext = NULL;  // This mid is current tail in the freeHeadp list
1617       mid = next;
1618       deflated_count++;
1619     } else {
1620       cur_mid_in_use = mid;
1621       mid = mid-&gt;FreeNext;
1622     }
1623   }
1624   return deflated_count;
1625 }
1626 
1627 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
1628   counters-&gt;nInuse = 0;              // currently associated with objects
1629   counters-&gt;nInCirculation = 0;      // extant
1630   counters-&gt;nScavenged = 0;          // reclaimed (global and per-thread)
1631   counters-&gt;perThreadScavenged = 0;  // per-thread scavenge total
1632   counters-&gt;perThreadTimes = 0.0;    // per-thread scavenge times
1633 }
1634 
1635 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
1636   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1637   bool deflated = false;
1638 
1639   ObjectMonitor * freeHeadp = NULL;  // Local SLL of scavenged monitors
1640   ObjectMonitor * freeTailp = NULL;
1641   elapsedTimer timer;
1642 
1643   if (log_is_enabled(Info, monitorinflation)) {
1644     timer.start();
1645   }
1646 
1647   // Prevent omFlush from changing mids in Thread dtor&#39;s during deflation
1648   // And in case the vm thread is acquiring a lock during a safepoint
1649   // See e.g. 6320749
1650   Thread::muxAcquire(&amp;gListLock, &quot;deflate_idle_monitors&quot;);
1651 
1652   // Note: the thread-local monitors lists get deflated in
1653   // a separate pass. See deflate_thread_local_monitors().
1654 
1655   // For moribund threads, scan gOmInUseList
1656   int deflated_count = 0;
1657   if (gOmInUseList) {
1658     counters-&gt;nInCirculation += gOmInUseCount;
1659     deflated_count = deflate_monitor_list((ObjectMonitor **)&amp;gOmInUseList, &amp;freeHeadp, &amp;freeTailp);
1660     gOmInUseCount -= deflated_count;
1661     counters-&gt;nScavenged += deflated_count;
1662     counters-&gt;nInuse += gOmInUseCount;
1663   }
1664 
1665   // Move the scavenged monitors back to the global free list.
1666   if (freeHeadp != NULL) {
1667     guarantee(freeTailp != NULL &amp;&amp; counters-&gt;nScavenged &gt; 0, &quot;invariant&quot;);
1668     assert(freeTailp-&gt;FreeNext == NULL, &quot;invariant&quot;);
1669     // constant-time list splice - prepend scavenged segment to gFreeList
1670     freeTailp-&gt;FreeNext = gFreeList;
1671     gFreeList = freeHeadp;
1672   }
1673   Thread::muxRelease(&amp;gListLock);
1674   timer.stop();
1675 
1676   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1677   LogStreamHandle(Info, monitorinflation) lsh_info;
1678   LogStream * ls = NULL;
1679   if (log_is_enabled(Debug, monitorinflation)) {
1680     ls = &amp;lsh_debug;
1681   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
1682     ls = &amp;lsh_info;
1683   }
1684   if (ls != NULL) {
1685     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
1686   }
1687 }
1688 
1689 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
1690   // Report the cumulative time for deflating each thread&#39;s idle
1691   // monitors. Note: if the work is split among more than one
1692   // worker thread, then the reported time will likely be more
1693   // than a beginning to end measurement of the phase.
1694   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;perThreadTimes, counters-&gt;perThreadScavenged);
1695 
1696   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1697   LogStreamHandle(Info, monitorinflation) lsh_info;
1698   LogStream * ls = NULL;
1699   if (log_is_enabled(Debug, monitorinflation)) {
1700     ls = &amp;lsh_debug;
1701   } else if (counters-&gt;perThreadScavenged != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
1702     ls = &amp;lsh_info;
1703   }
1704   if (ls != NULL) {
1705     ls-&gt;print_cr(&quot;deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, counters-&gt;perThreadTimes, counters-&gt;perThreadScavenged);
1706   }
1707 
1708   gMonitorFreeCount += counters-&gt;nScavenged;
1709 
1710   if (log_is_enabled(Debug, monitorinflation)) {
1711     // exit_globals()&#39;s call to audit_and_print_stats() is done
1712     // at the Info level.
1713     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
1714   }
1715 
1716   ForceMonitorScavenge = 0;    // Reset
1717 
1718   OM_PERFDATA_OP(Deflations, inc(counters-&gt;nScavenged));
1719   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;nInCirculation));
1720 
1721   GVars.stwRandom = os::random();
1722   GVars.stwCycle++;
1723 }
1724 
1725 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
1726   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1727 
1728   ObjectMonitor * freeHeadp = NULL;  // Local SLL of scavenged monitors
1729   ObjectMonitor * freeTailp = NULL;
1730   elapsedTimer timer;
1731 
1732   if (log_is_enabled(Info, safepoint, cleanup) ||
1733       log_is_enabled(Info, monitorinflation)) {
1734     timer.start();
1735   }
1736 
1737   int deflated_count = deflate_monitor_list(thread-&gt;omInUseList_addr(), &amp;freeHeadp, &amp;freeTailp);
1738 
1739   timer.stop();
1740 
1741   Thread::muxAcquire(&amp;gListLock, &quot;deflate_thread_local_monitors&quot;);
1742 
1743   // Adjust counters
1744   counters-&gt;nInCirculation += thread-&gt;omInUseCount;
1745   thread-&gt;omInUseCount -= deflated_count;
1746   counters-&gt;nScavenged += deflated_count;
1747   counters-&gt;nInuse += thread-&gt;omInUseCount;
1748   counters-&gt;perThreadScavenged += deflated_count;
1749   // For now, we only care about cumulative per-thread deflation time.
1750   counters-&gt;perThreadTimes += timer.seconds();
1751 
1752   // Move the scavenged monitors back to the global free list.
1753   if (freeHeadp != NULL) {
1754     guarantee(freeTailp != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
1755     assert(freeTailp-&gt;FreeNext == NULL, &quot;invariant&quot;);
1756 
1757     // constant-time list splice - prepend scavenged segment to gFreeList
1758     freeTailp-&gt;FreeNext = gFreeList;
1759     gFreeList = freeHeadp;
1760   }
1761   Thread::muxRelease(&amp;gListLock);
1762 }
1763 
1764 // Monitor cleanup on JavaThread::exit
1765 
1766 // Iterate through monitor cache and attempt to release thread&#39;s monitors
1767 // Gives up on a particular monitor if an exception occurs, but continues
1768 // the overall iteration, swallowing the exception.
1769 class ReleaseJavaMonitorsClosure: public MonitorClosure {
1770  private:
1771   TRAPS;
1772 
1773  public:
1774   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
1775   void do_monitor(ObjectMonitor* mid) {
1776     if (mid-&gt;owner() == THREAD) {
1777       // Note well -- this occurs ONLY on thread exit, and is a last ditch
1778       // effort to release all locks. Hence, we don&#39;t need to record tsan&#39;s
1779       // recursion count -- it will never be locked again.
1780       TSAN_RUNTIME_ONLY(SharedRuntime::tsan_oop_rec_unlock(THREAD, (oop)mid-&gt;object()));
1781       (void)mid-&gt;complete_exit(CHECK);
1782     }
1783   }
1784 };
1785 
1786 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
1787 // ignored.  This is meant to be called during JNI thread detach which assumes
1788 // all remaining monitors are heavyweight.  All exceptions are swallowed.
1789 // Scanning the extant monitor list can be time consuming.
1790 // A simple optimization is to add a per-thread flag that indicates a thread
1791 // called jni_monitorenter() during its lifetime.
1792 //
1793 // Instead of No_Savepoint_Verifier it might be cheaper to
1794 // use an idiom of the form:
1795 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
1796 //   &lt;code that must not run at safepoint&gt;
1797 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
1798 // Since the tests are extremely cheap we could leave them enabled
1799 // for normal product builds.
1800 
1801 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
1802   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
1803   NoSafepointVerifier nsv;
1804   ReleaseJavaMonitorsClosure rjmc(THREAD);
1805   Thread::muxAcquire(&amp;gListLock, &quot;release_monitors_owned_by_thread&quot;);
1806   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
1807   Thread::muxRelease(&amp;gListLock);
1808   THREAD-&gt;clear_pending_exception();
1809 }
1810 
1811 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
1812   switch (cause) {
1813     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
1814     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
1815     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
1816     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
1817     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
1818     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
1819     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
1820     default:
1821       ShouldNotReachHere();
1822   }
1823   return &quot;Unknown&quot;;
1824 }
1825 
1826 //------------------------------------------------------------------------------
1827 // Debugging code
1828 
1829 u_char* ObjectSynchronizer::get_gvars_addr() {
1830   return (u_char*)&amp;GVars;
1831 }
1832 
1833 u_char* ObjectSynchronizer::get_gvars_hcSequence_addr() {
1834   return (u_char*)&amp;GVars.hcSequence;
1835 }
1836 
1837 size_t ObjectSynchronizer::get_gvars_size() {
1838   return sizeof(SharedGlobals);
1839 }
1840 
1841 u_char* ObjectSynchronizer::get_gvars_stwRandom_addr() {
1842   return (u_char*)&amp;GVars.stwRandom;
1843 }
1844 
1845 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
1846   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1847 
1848   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1849   LogStreamHandle(Info, monitorinflation) lsh_info;
1850   LogStreamHandle(Trace, monitorinflation) lsh_trace;
1851   LogStream * ls = NULL;
1852   if (log_is_enabled(Trace, monitorinflation)) {
1853     ls = &amp;lsh_trace;
1854   } else if (log_is_enabled(Debug, monitorinflation)) {
1855     ls = &amp;lsh_debug;
1856   } else if (log_is_enabled(Info, monitorinflation)) {
1857     ls = &amp;lsh_info;
1858   }
1859   assert(ls != NULL, &quot;sanity check&quot;);
1860 
1861   if (!on_exit) {
1862     // Not at VM exit so grab the global list lock.
1863     Thread::muxAcquire(&amp;gListLock, &quot;audit_and_print_stats&quot;);
1864   }
1865 
1866   // Log counts for the global and per-thread monitor lists:
1867   int chkMonitorPopulation = log_monitor_list_counts(ls);
1868   int error_cnt = 0;
1869 
1870   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
1871 
1872   // Check gMonitorPopulation:
1873   if (gMonitorPopulation == chkMonitorPopulation) {
1874      ls-&gt;print_cr(&quot;gMonitorPopulation=%d equals chkMonitorPopulation=%d&quot;,
1875                   gMonitorPopulation, chkMonitorPopulation);
1876   } else {
1877      ls-&gt;print_cr(&quot;ERROR: gMonitorPopulation=%d is not equal to &quot;
1878                   &quot;chkMonitorPopulation=%d&quot;, gMonitorPopulation,
1879                   chkMonitorPopulation);
1880      error_cnt++;
1881   }
1882 
1883   // Check gOmInUseList and gOmInUseCount:
1884   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
1885 
1886   // Check gFreeList and gMonitorFreeCount:
1887   chk_global_free_list_and_count(ls, &amp;error_cnt);
1888 
1889   if (!on_exit) {
1890     Thread::muxRelease(&amp;gListLock);
1891   }
1892 
1893   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
1894 
1895   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
1896     // Check omInUseList and omInUseCount:
1897     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
1898 
1899     // Check omFreeList and omFreeCount:
1900     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
1901   }
1902 
1903   if (error_cnt == 0) {
1904     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
1905   } else {
1906     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
1907   }
1908 
1909   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
1910       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
1911     // When exiting this log output is at the Info level. When called
1912     // at a safepoint, this log output is at the Trace level since
1913     // there can be a lot of it.
1914     log_in_use_monitor_details(ls, on_exit);
1915   }
1916 
1917   ls-&gt;flush();
1918 
1919   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
1920 }
1921 
1922 // Check a free monitor entry; log any errors.
1923 void ObjectSynchronizer::chk_free_entry(JavaThread * jt, ObjectMonitor * n,
1924                                         outputStream * out, int *error_cnt_p) {
1925   if (n-&gt;is_busy()) {
1926     if (jt != NULL) {
1927       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
1928                     &quot;: free per-thread monitor must not be busy.&quot;, p2i(jt),
1929                     p2i(n));
1930     } else {
1931       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
1932                     &quot;must not be busy.&quot;, p2i(n));
1933     }
1934     *error_cnt_p = *error_cnt_p + 1;
1935   }
1936   if (n-&gt;header() != NULL) {
1937     if (jt != NULL) {
1938       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
1939                     &quot;: free per-thread monitor must have NULL _header &quot;
1940                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
1941                     p2i(n-&gt;header()));
1942     } else {
1943       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
1944                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
1945                     p2i(n), p2i(n-&gt;header()));
1946     }
1947     *error_cnt_p = *error_cnt_p + 1;
1948   }
1949   if (n-&gt;object() != NULL) {
1950     if (jt != NULL) {
1951       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
1952                     &quot;: free per-thread monitor must have NULL _object &quot;
1953                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
1954                     p2i(n-&gt;object()));
1955     } else {
1956       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
1957                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
1958                     p2i(n), p2i(n-&gt;object()));
1959     }
1960     *error_cnt_p = *error_cnt_p + 1;
1961   }
1962 }
1963 
1964 // Check the global free list and count; log the results of the checks.
1965 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
1966                                                         int *error_cnt_p) {
1967   int chkMonitorFreeCount = 0;
1968   for (ObjectMonitor * n = gFreeList; n != NULL; n = n-&gt;FreeNext) {
1969     chk_free_entry(NULL /* jt */, n, out, error_cnt_p);
1970     chkMonitorFreeCount++;
1971   }
1972   if (gMonitorFreeCount == chkMonitorFreeCount) {
1973     out-&gt;print_cr(&quot;gMonitorFreeCount=%d equals chkMonitorFreeCount=%d&quot;,
1974                   gMonitorFreeCount, chkMonitorFreeCount);
1975   } else {
1976     out-&gt;print_cr(&quot;ERROR: gMonitorFreeCount=%d is not equal to &quot;
1977                   &quot;chkMonitorFreeCount=%d&quot;, gMonitorFreeCount,
1978                   chkMonitorFreeCount);
1979     *error_cnt_p = *error_cnt_p + 1;
1980   }
1981 }
1982 
1983 // Check the global in-use list and count; log the results of the checks.
1984 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
1985                                                           int *error_cnt_p) {
1986   int chkOmInUseCount = 0;
1987   for (ObjectMonitor * n = gOmInUseList; n != NULL; n = n-&gt;FreeNext) {
1988     chk_in_use_entry(NULL /* jt */, n, out, error_cnt_p);
1989     chkOmInUseCount++;
1990   }
1991   if (gOmInUseCount == chkOmInUseCount) {
1992     out-&gt;print_cr(&quot;gOmInUseCount=%d equals chkOmInUseCount=%d&quot;, gOmInUseCount,
1993                   chkOmInUseCount);
1994   } else {
1995     out-&gt;print_cr(&quot;ERROR: gOmInUseCount=%d is not equal to chkOmInUseCount=%d&quot;,
1996                   gOmInUseCount, chkOmInUseCount);
1997     *error_cnt_p = *error_cnt_p + 1;
1998   }
1999 }
2000 
2001 // Check an in-use monitor entry; log any errors.
2002 void ObjectSynchronizer::chk_in_use_entry(JavaThread * jt, ObjectMonitor * n,
2003                                           outputStream * out, int *error_cnt_p) {
2004   if (n-&gt;header() == NULL) {
2005     if (jt != NULL) {
2006       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2007                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
2008                     &quot;field.&quot;, p2i(jt), p2i(n));
2009     } else {
2010       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
2011                     &quot;must have non-NULL _header field.&quot;, p2i(n));
2012     }
2013     *error_cnt_p = *error_cnt_p + 1;
2014   }
2015   if (n-&gt;object() == NULL) {
2016     if (jt != NULL) {
2017       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2018                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
2019                     &quot;field.&quot;, p2i(jt), p2i(n));
2020     } else {
2021       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
2022                     &quot;must have non-NULL _object field.&quot;, p2i(n));
2023     }
2024     *error_cnt_p = *error_cnt_p + 1;
2025   }
2026   const oop obj = (oop)n-&gt;object();
2027   const markOop mark = obj-&gt;mark();
2028   if (!mark-&gt;has_monitor()) {
2029     if (jt != NULL) {
2030       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2031                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
2032                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2033                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i((address)obj),
2034                     p2i((address)mark));
2035     } else {
2036       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
2037                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
2038                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
2039                     p2i((address)obj), p2i((address)mark));
2040     }
2041     *error_cnt_p = *error_cnt_p + 1;
2042   }
2043   ObjectMonitor * const obj_mon = mark-&gt;monitor();
2044   if (n != obj_mon) {
2045     if (jt != NULL) {
2046       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2047                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
2048                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2049                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
2050                     p2i(n), p2i((address)obj), p2i((address)mark),
2051                     p2i((address)obj_mon));
2052     } else {
2053       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
2054                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
2055                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
2056                     INTPTR_FORMAT, p2i(n), p2i((address)obj),
2057                     p2i((address)mark), p2i((address)obj_mon));
2058     }
2059     *error_cnt_p = *error_cnt_p + 1;
2060   }
2061 }
2062 
2063 // Check the thread&#39;s free list and count; log the results of the checks.
2064 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
2065                                                             outputStream * out,
2066                                                             int *error_cnt_p) {
2067   int chkOmFreeCount = 0;
2068   for (ObjectMonitor * n = jt-&gt;omFreeList; n != NULL; n = n-&gt;FreeNext) {
2069     chk_free_entry(jt, n, out, error_cnt_p);
2070     chkOmFreeCount++;
2071   }
2072   if (jt-&gt;omFreeCount == chkOmFreeCount) {
2073     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: omFreeCount=%d equals &quot;
2074                   &quot;chkOmFreeCount=%d&quot;, p2i(jt), jt-&gt;omFreeCount, chkOmFreeCount);
2075   } else {
2076     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: omFreeCount=%d is not &quot;
2077                   &quot;equal to chkOmFreeCount=%d&quot;, p2i(jt), jt-&gt;omFreeCount,
2078                   chkOmFreeCount);
2079     *error_cnt_p = *error_cnt_p + 1;
2080   }
2081 }
2082 
2083 // Check the thread&#39;s in-use list and count; log the results of the checks.
2084 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
2085                                                               outputStream * out,
2086                                                               int *error_cnt_p) {
2087   int chkOmInUseCount = 0;
2088   for (ObjectMonitor * n = jt-&gt;omInUseList; n != NULL; n = n-&gt;FreeNext) {
2089     chk_in_use_entry(jt, n, out, error_cnt_p);
2090     chkOmInUseCount++;
2091   }
2092   if (jt-&gt;omInUseCount == chkOmInUseCount) {
2093     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: omInUseCount=%d equals &quot;
2094                   &quot;chkOmInUseCount=%d&quot;, p2i(jt), jt-&gt;omInUseCount,
2095                   chkOmInUseCount);
2096   } else {
2097     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: omInUseCount=%d is not &quot;
2098                   &quot;equal to chkOmInUseCount=%d&quot;, p2i(jt), jt-&gt;omInUseCount,
2099                   chkOmInUseCount);
2100     *error_cnt_p = *error_cnt_p + 1;
2101   }
2102 }
2103 
2104 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
2105 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
2106 // indicate the associated object and its type.
2107 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out,
2108                                                     bool on_exit) {
2109   if (!on_exit) {
2110     // Not at VM exit so grab the global list lock.
2111     Thread::muxAcquire(&amp;gListLock, &quot;log_in_use_monitor_details&quot;);
2112   }
2113 
2114   if (gOmInUseCount &gt; 0) {
2115     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
2116     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hashcode, L -&gt; lock status)&quot;);
2117     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
2118                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
2119     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
2120     for (ObjectMonitor * n = gOmInUseList; n != NULL; n = n-&gt;FreeNext) {
2121       const oop obj = (oop) n-&gt;object();
2122       const markOop mark = n-&gt;header();
2123       ResourceMark rm;
2124       out-&gt;print_cr(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(n),
2125                     n-&gt;is_busy() != 0, mark-&gt;hash() != 0, n-&gt;owner() != NULL,
2126                     p2i(obj), obj-&gt;klass()-&gt;external_name());
2127     }
2128   }
2129 
2130   if (!on_exit) {
2131     Thread::muxRelease(&amp;gListLock);
2132   }
2133 
2134   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
2135   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hashcode, L -&gt; lock status)&quot;);
2136   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
2137                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
2138   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
2139   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2140     for (ObjectMonitor * n = jt-&gt;omInUseList; n != NULL; n = n-&gt;FreeNext) {
2141       const oop obj = (oop) n-&gt;object();
2142       const markOop mark = n-&gt;header();
2143       ResourceMark rm;
2144       out-&gt;print_cr(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
2145                     &quot;  %s&quot;, p2i(jt), p2i(n), n-&gt;is_busy() != 0,
2146                     mark-&gt;hash() != 0, n-&gt;owner() != NULL, p2i(obj),
2147                     obj-&gt;klass()-&gt;external_name());
2148     }
2149   }
2150 
2151   out-&gt;flush();
2152 }
2153 
2154 // Log counts for the global and per-thread monitor lists and return
2155 // the population count.
2156 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
2157   int popCount = 0;
2158   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
2159                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Total&quot;);
2160   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
2161   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d&quot;, &quot;&quot;,
2162                 gOmInUseCount, gMonitorFreeCount, gMonitorPopulation);
2163   popCount += gOmInUseCount + gMonitorFreeCount;
2164 
2165   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
2166                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
2167   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
2168 
2169   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2170     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
2171                   jt-&gt;omInUseCount, jt-&gt;omFreeCount, jt-&gt;omFreeProvision);
2172     popCount += jt-&gt;omInUseCount + jt-&gt;omFreeCount;
2173   }
2174   return popCount;
2175 }
2176 
2177 #ifndef PRODUCT
2178 
2179 // Check if monitor belongs to the monitor cache
2180 // The list is grow-only so it&#39;s *relatively* safe to traverse
2181 // the list of extant blocks without taking a lock.
2182 
2183 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
2184   PaddedEnd&lt;ObjectMonitor&gt; * block = OrderAccess::load_acquire(&amp;gBlockList);
2185   while (block != NULL) {
2186     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
2187     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
2188       address mon = (address)monitor;
2189       address blk = (address)block;
2190       size_t diff = mon - blk;
2191       assert((diff % sizeof(PaddedEnd&lt;ObjectMonitor&gt;)) == 0, &quot;must be aligned&quot;);
2192       return 1;
2193     }
2194     block = (PaddedEnd&lt;ObjectMonitor&gt; *)block-&gt;FreeNext;
2195   }
2196   return 0;
2197 }
2198 
2199 #endif
    </pre>
  </body>
</html>