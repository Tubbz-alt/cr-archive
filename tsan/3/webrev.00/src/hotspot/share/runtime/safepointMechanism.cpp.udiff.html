<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/safepointMechanism.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="safepoint.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepointMechanism.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepointMechanism.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,22 +23,21 @@</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;runtime/globals.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/orderAccess.hpp&quot;</span>
  #include &quot;runtime/os.hpp&quot;
  #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  #include &quot;services/memTracker.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  
<span class="udiff-line-removed">- SafepointMechanism::PollingType SafepointMechanism::_polling_type = SafepointMechanism::_global_page_poll;</span>
  void* SafepointMechanism::_poll_armed_value;
  void* SafepointMechanism::_poll_disarmed_value;
  
  void SafepointMechanism::default_initialize() {
<span class="udiff-line-modified-removed">-   if (ThreadLocalHandshakes) {</span>
<span class="udiff-line-removed">-     set_uses_thread_local_poll();</span>
<span class="udiff-line-modified-added">+   if (uses_thread_local_poll()) {</span>
  
      // Poll bit values
      intptr_t poll_armed_value = poll_bit();
      intptr_t poll_disarmed_value = 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -81,21 +80,41 @@</span>
      log_info(os)(&quot;SafePoint Polling address: &quot; INTPTR_FORMAT, p2i(polling_page));
      os::set_polling_page((address)(polling_page));
    }
  }
  
<span class="udiff-line-modified-removed">- void SafepointMechanism::block_if_requested_slow(JavaThread *thread) {</span>
<span class="udiff-line-removed">-   // local poll already checked, if used.</span>
<span class="udiff-line-modified-added">+ void SafepointMechanism::block_or_handshake(JavaThread *thread) {</span>
    if (global_poll()) {
      // Any load in ::block must not pass the global poll load.
      // Otherwise we might load an old safepoint counter (for example).
      OrderAccess::loadload();
      SafepointSynchronize::block(thread);
    }
    if (uses_thread_local_poll() &amp;&amp; thread-&gt;has_handshake()) {
<span class="udiff-line-modified-removed">-       thread-&gt;handshake_process_by_self();</span>
<span class="udiff-line-modified-added">+     thread-&gt;handshake_process_by_self();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void SafepointMechanism::block_if_requested_slow(JavaThread *thread) {</span>
<span class="udiff-line-added">+   // Read global poll and has_handshake after local poll</span>
<span class="udiff-line-added">+   OrderAccess::loadload();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // local poll already checked, if used.</span>
<span class="udiff-line-added">+   block_or_handshake(thread);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   OrderAccess::loadload();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (uses_thread_local_poll() &amp;&amp; local_poll_armed(thread)) {</span>
<span class="udiff-line-added">+     disarm_local_poll_release(thread);</span>
<span class="udiff-line-added">+     // We might have disarmed next safepoint/handshake</span>
<span class="udiff-line-added">+     OrderAccess::storeload();</span>
<span class="udiff-line-added">+     if (global_poll() || thread-&gt;has_handshake()) {</span>
<span class="udiff-line-added">+       arm_local_poll(thread);</span>
<span class="udiff-line-added">+     }</span>
    }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   OrderAccess::cross_modify_fence();</span>
  }
  
  void SafepointMechanism::initialize_header(JavaThread* thread) {
    disarm_local_poll(thread);
  }
</pre>
<center><a href="safepoint.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepointMechanism.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>