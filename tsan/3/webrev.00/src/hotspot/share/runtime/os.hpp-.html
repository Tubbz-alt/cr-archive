<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/os.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_RUNTIME_OS_HPP
  26 #define SHARE_RUNTIME_OS_HPP
  27 
  28 #include &quot;jvm.h&quot;
  29 #include &quot;jvmtifiles/jvmti.h&quot;
  30 #include &quot;metaprogramming/isRegisteredEnum.hpp&quot;
  31 #include &quot;metaprogramming/integralConstant.hpp&quot;
  32 #include &quot;runtime/extendedPC.hpp&quot;
  33 #include &quot;utilities/exceptions.hpp&quot;
  34 #include &quot;utilities/ostream.hpp&quot;
  35 #include &quot;utilities/macros.hpp&quot;
  36 #ifndef _WINDOWS
  37 # include &lt;setjmp.h&gt;
  38 #endif
  39 #ifdef __APPLE__
  40 # include &lt;mach/mach_time.h&gt;
  41 #endif
  42 
  43 class AgentLibrary;
  44 class frame;
  45 
  46 // os defines the interface to operating system; this includes traditional
  47 // OS services (time, I/O) as well as other functionality with system-
  48 // dependent code.
  49 
  50 typedef void (*dll_func)(...);
  51 
  52 class Thread;
  53 class JavaThread;
  54 class NativeCallStack;
  55 class methodHandle;
  56 class OSThread;
  57 class Mutex;
  58 
  59 template&lt;class E&gt; class GrowableArray;
  60 
  61 // %%%%% Moved ThreadState, START_FN, OSThread to new osThread.hpp. -- Rose
  62 
  63 // Platform-independent error return values from OS functions
  64 enum OSReturn {
  65   OS_OK         =  0,        // Operation was successful
  66   OS_ERR        = -1,        // Operation failed
  67   OS_INTRPT     = -2,        // Operation was interrupted
  68   OS_TIMEOUT    = -3,        // Operation timed out
  69   OS_NOMEM      = -5,        // Operation failed for lack of memory
  70   OS_NORESOURCE = -6         // Operation failed for lack of nonmemory resource
  71 };
  72 
  73 enum ThreadPriority {        // JLS 20.20.1-3
  74   NoPriority       = -1,     // Initial non-priority value
  75   MinPriority      =  1,     // Minimum priority
  76   NormPriority     =  5,     // Normal (non-daemon) priority
  77   NearMaxPriority  =  9,     // High priority, used for VMThread
  78   MaxPriority      = 10,     // Highest priority, used for WatcherThread
  79                              // ensures that VMThread doesn&#39;t starve profiler
  80   CriticalPriority = 11      // Critical thread priority
  81 };
  82 
  83 // Executable parameter flag for os::commit_memory() and
  84 // os::commit_memory_or_exit().
  85 const bool ExecMem = true;
  86 
  87 // Typedef for structured exception handling support
  88 typedef void (*java_call_t)(JavaValue* value, const methodHandle&amp; method, JavaCallArguments* args, Thread* thread);
  89 
  90 class MallocTracker;
  91 
  92 class os: AllStatic {
  93   friend class VMStructs;
  94   friend class JVMCIVMStructs;
  95   friend class MallocTracker;
  96 
  97 #ifdef ASSERT
  98  private:
  99   static bool _mutex_init_done;
 100  public:
 101   static void set_mutex_init_done() { _mutex_init_done = true; }
 102   static bool mutex_init_done() { return _mutex_init_done; }
 103 #endif
 104 
 105  public:
 106   enum { page_sizes_max = 9 }; // Size of _page_sizes array (8 plus a sentinel)
 107 
 108  private:
 109   static OSThread*          _starting_thread;
 110   static address            _polling_page;
 111  public:
 112   static size_t             _page_sizes[page_sizes_max];
 113 
 114  private:
 115   static void init_page_sizes(size_t default_page_size) {
 116     _page_sizes[0] = default_page_size;
 117     _page_sizes[1] = 0; // sentinel
 118   }
 119 
 120   static char*  pd_reserve_memory(size_t bytes, char* addr = 0,
 121                                   size_t alignment_hint = 0);
 122   static char*  pd_attempt_reserve_memory_at(size_t bytes, char* addr);
 123   static char*  pd_attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc);
 124   static void   pd_split_reserved_memory(char *base, size_t size,
 125                                       size_t split, bool realloc);
 126   static bool   pd_commit_memory(char* addr, size_t bytes, bool executable);
 127   static bool   pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
 128                                  bool executable);
 129   // Same as pd_commit_memory() that either succeeds or calls
 130   // vm_exit_out_of_memory() with the specified mesg.
 131   static void   pd_commit_memory_or_exit(char* addr, size_t bytes,
 132                                          bool executable, const char* mesg);
 133   static void   pd_commit_memory_or_exit(char* addr, size_t size,
 134                                          size_t alignment_hint,
 135                                          bool executable, const char* mesg);
 136   static bool   pd_uncommit_memory(char* addr, size_t bytes);
 137   static bool   pd_release_memory(char* addr, size_t bytes);
 138 
 139   static char*  pd_map_memory(int fd, const char* file_name, size_t file_offset,
 140                            char *addr, size_t bytes, bool read_only = false,
 141                            bool allow_exec = false);
 142   static char*  pd_remap_memory(int fd, const char* file_name, size_t file_offset,
 143                              char *addr, size_t bytes, bool read_only,
 144                              bool allow_exec);
 145   static bool   pd_unmap_memory(char *addr, size_t bytes);
 146   static void   pd_free_memory(char *addr, size_t bytes, size_t alignment_hint);
 147   static void   pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint);
 148 
 149   static size_t page_size_for_region(size_t region_size, size_t min_pages, bool must_be_aligned);
 150 
 151   // Get summary strings for system information in buffer provided
 152   static void  get_summary_cpu_info(char* buf, size_t buflen);
 153   static void  get_summary_os_info(char* buf, size_t buflen);
 154 
 155   static void initialize_initial_active_processor_count();
 156 
 157   LINUX_ONLY(static void pd_init_container_support();)
 158 
 159  public:
 160   static void init(void);                      // Called before command line parsing
 161 
 162   static void init_container_support() {       // Called during command line parsing.
 163      LINUX_ONLY(pd_init_container_support();)
 164   }
 165 
 166   static void init_before_ergo(void);          // Called after command line parsing
 167                                                // before VM ergonomics processing.
 168   static jint init_2(void);                    // Called after command line parsing
 169                                                // and VM ergonomics processing
 170   static void init_globals(void) {             // Called from init_globals() in init.cpp
 171     init_globals_ext();
 172   }
 173 
 174   // File names are case-insensitive on windows only
 175   // Override me as needed
 176   static int    file_name_strncmp(const char* s1, const char* s2, size_t num);
 177 
 178   // unset environment variable
 179   static bool unsetenv(const char* name);
 180 
 181   static bool have_special_privileges();
 182 
 183   static jlong  javaTimeMillis();
 184   static jlong  javaTimeNanos();
 185   static void   javaTimeNanos_info(jvmtiTimerInfo *info_ptr);
 186   static void   javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos);
 187   static void   run_periodic_checks();
 188   static bool   supports_monotonic_clock();
 189 
 190   // Returns the elapsed time in seconds since the vm started.
 191   static double elapsedTime();
 192 
 193   // Returns real time in seconds since an arbitrary point
 194   // in the past.
 195   static bool getTimesSecs(double* process_real_time,
 196                            double* process_user_time,
 197                            double* process_system_time);
 198 
 199   // Interface to the performance counter
 200   static jlong elapsed_counter();
 201   static jlong elapsed_frequency();
 202 
 203   // The &quot;virtual time&quot; of a thread is the amount of time a thread has
 204   // actually run.  The first function indicates whether the OS supports
 205   // this functionality for the current thread, and if so:
 206   //   * the second enables vtime tracking (if that is required).
 207   //   * the third tells whether vtime is enabled.
 208   //   * the fourth returns the elapsed virtual time for the current
 209   //     thread.
 210   static bool supports_vtime();
 211   static bool enable_vtime();
 212   static bool vtime_enabled();
 213   static double elapsedVTime();
 214 
 215   // Return current local time in a string (YYYY-MM-DD HH:MM:SS).
 216   // It is MT safe, but not async-safe, as reading time zone
 217   // information may require a lock on some platforms.
 218   static char*      local_time_string(char *buf, size_t buflen);
 219   static struct tm* localtime_pd     (const time_t* clock, struct tm*  res);
 220   static struct tm* gmtime_pd        (const time_t* clock, struct tm*  res);
 221   // Fill in buffer with current local time as an ISO-8601 string.
 222   // E.g., YYYY-MM-DDThh:mm:ss.mmm+zzzz.
 223   // Returns buffer, or NULL if it failed.
 224   static char* iso8601_time(char* buffer, size_t buffer_length, bool utc = false);
 225 
 226   // Interface for detecting multiprocessor system
 227   static inline bool is_MP() {
 228     // During bootstrap if _processor_count is not yet initialized
 229     // we claim to be MP as that is safest. If any platform has a
 230     // stub generator that might be triggered in this phase and for
 231     // which being declared MP when in fact not, is a problem - then
 232     // the bootstrap routine for the stub generator needs to check
 233     // the processor count directly and leave the bootstrap routine
 234     // in place until called after initialization has ocurred.
 235     return (_processor_count != 1);
 236   }
 237 
 238   static julong available_memory();
 239   static julong physical_memory();
 240   static bool has_allocatable_memory_limit(julong* limit);
 241   static bool is_server_class_machine();
 242 
 243   // Returns the id of the processor on which the calling thread is currently executing.
 244   // The returned value is guaranteed to be between 0 and (os::processor_count() - 1).
 245   static uint processor_id();
 246 
 247   // number of CPUs
 248   static int processor_count() {
 249     return _processor_count;
 250   }
 251   static void set_processor_count(int count) { _processor_count = count; }
 252 
 253   // Returns the number of CPUs this process is currently allowed to run on.
 254   // Note that on some OSes this can change dynamically.
 255   static int active_processor_count();
 256 
 257   // At startup the number of active CPUs this process is allowed to run on.
 258   // This value does not change dynamically. May be different from active_processor_count().
 259   static int initial_active_processor_count() {
 260     assert(_initial_active_processor_count &gt; 0, &quot;Initial active processor count not set yet.&quot;);
 261     return _initial_active_processor_count;
 262   }
 263 
 264   // Bind processes to processors.
 265   //     This is a two step procedure:
 266   //     first you generate a distribution of processes to processors,
 267   //     then you bind processes according to that distribution.
 268   // Compute a distribution for number of processes to processors.
 269   //    Stores the processor id&#39;s into the distribution array argument.
 270   //    Returns true if it worked, false if it didn&#39;t.
 271   static bool distribute_processes(uint length, uint* distribution);
 272   // Binds the current process to a processor.
 273   //    Returns true if it worked, false if it didn&#39;t.
 274   static bool bind_to_processor(uint processor_id);
 275 
 276   // Give a name to the current thread.
 277   static void set_native_thread_name(const char *name);
 278 
 279   // Interface for stack banging (predetect possible stack overflow for
 280   // exception processing)  There are guard pages, and above that shadow
 281   // pages for stack overflow checking.
 282   static bool uses_stack_guard_pages();
 283   static bool must_commit_stack_guard_pages();
 284   static void map_stack_shadow_pages(address sp);
 285   static bool stack_shadow_pages_available(Thread *thread, const methodHandle&amp; method, address sp);
 286 
 287   // Find committed memory region within specified range (start, start + size),
 288   // return true if found any
 289   static bool committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size);
 290 
 291   // OS interface to Virtual Memory
 292 
 293   // Return the default page size.
 294   static int    vm_page_size();
 295 
 296   // Returns the page size to use for a region of memory.
 297   // region_size / min_pages will always be greater than or equal to the
 298   // returned value. The returned value will divide region_size.
 299   static size_t page_size_for_region_aligned(size_t region_size, size_t min_pages);
 300 
 301   // Returns the page size to use for a region of memory.
 302   // region_size / min_pages will always be greater than or equal to the
 303   // returned value. The returned value might not divide region_size.
 304   static size_t page_size_for_region_unaligned(size_t region_size, size_t min_pages);
 305 
 306   // Return the largest page size that can be used
 307   static size_t max_page_size() {
 308     // The _page_sizes array is sorted in descending order.
 309     return _page_sizes[0];
 310   }
 311 
 312   // Return a lower bound for page sizes. Also works before os::init completed.
 313   static size_t min_page_size() { return 4 * K; }
 314 
 315   // Methods for tracing page sizes returned by the above method.
 316   // The region_{min,max}_size parameters should be the values
 317   // passed to page_size_for_region() and page_size should be the result of that
 318   // call.  The (optional) base and size parameters should come from the
 319   // ReservedSpace base() and size() methods.
 320   static void trace_page_sizes(const char* str, const size_t* page_sizes, int count);
 321   static void trace_page_sizes(const char* str,
 322                                const size_t region_min_size,
 323                                const size_t region_max_size,
 324                                const size_t page_size,
 325                                const char* base,
 326                                const size_t size);
 327   static void trace_page_sizes_for_requested_size(const char* str,
 328                                                   const size_t requested_size,
 329                                                   const size_t page_size,
 330                                                   const size_t alignment,
 331                                                   const char* base,
 332                                                   const size_t size);
 333 
 334   static int    vm_allocation_granularity();
 335   static char*  reserve_memory(size_t bytes, char* addr = 0,
 336                                size_t alignment_hint = 0, int file_desc = -1);
 337   static char*  reserve_memory(size_t bytes, char* addr,
 338                                size_t alignment_hint, MEMFLAGS flags);
 339   static char*  reserve_memory_aligned(size_t size, size_t alignment, int file_desc = -1);
 340   static char*  attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc = -1);
 341   static void   split_reserved_memory(char *base, size_t size,
 342                                       size_t split, bool realloc);
 343   static bool   commit_memory(char* addr, size_t bytes, bool executable);
 344   static bool   commit_memory(char* addr, size_t size, size_t alignment_hint,
 345                               bool executable);
 346   // Same as commit_memory() that either succeeds or calls
 347   // vm_exit_out_of_memory() with the specified mesg.
 348   static void   commit_memory_or_exit(char* addr, size_t bytes,
 349                                       bool executable, const char* mesg);
 350   static void   commit_memory_or_exit(char* addr, size_t size,
 351                                       size_t alignment_hint,
 352                                       bool executable, const char* mesg);
 353   static bool   uncommit_memory(char* addr, size_t bytes);
 354   static bool   release_memory(char* addr, size_t bytes);
 355 
 356   // Touch memory pages that cover the memory range from start to end (exclusive)
 357   // to make the OS back the memory range with actual memory.
 358   // Current implementation may not touch the last page if unaligned addresses
 359   // are passed.
 360   static void   pretouch_memory(void* start, void* end, size_t page_size = vm_page_size());
 361 
 362   enum ProtType { MEM_PROT_NONE, MEM_PROT_READ, MEM_PROT_RW, MEM_PROT_RWX };
 363   static bool   protect_memory(char* addr, size_t bytes, ProtType prot,
 364                                bool is_committed = true);
 365 
 366   static bool   guard_memory(char* addr, size_t bytes);
 367   static bool   unguard_memory(char* addr, size_t bytes);
 368   static bool   create_stack_guard_pages(char* addr, size_t bytes);
 369   static bool   pd_create_stack_guard_pages(char* addr, size_t bytes);
 370   static bool   remove_stack_guard_pages(char* addr, size_t bytes);
 371   // Helper function to create a new file with template jvmheap.XXXXXX.
 372   // Returns a valid fd on success or else returns -1
 373   static int create_file_for_heap(const char* dir);
 374   // Map memory to the file referred by fd. This function is slightly different from map_memory()
 375   // and is added to be used for implementation of -XX:AllocateHeapAt
 376   static char* map_memory_to_file(char* base, size_t size, int fd);
 377   // Replace existing reserved memory with file mapping
 378   static char* replace_existing_mapping_with_file_mapping(char* base, size_t size, int fd);
 379 
 380   static char*  map_memory(int fd, const char* file_name, size_t file_offset,
 381                            char *addr, size_t bytes, bool read_only = false,
 382                            bool allow_exec = false);
 383   static char*  remap_memory(int fd, const char* file_name, size_t file_offset,
 384                              char *addr, size_t bytes, bool read_only,
 385                              bool allow_exec);
 386   static bool   unmap_memory(char *addr, size_t bytes);
 387   static void   free_memory(char *addr, size_t bytes, size_t alignment_hint);
 388   static void   realign_memory(char *addr, size_t bytes, size_t alignment_hint);
 389 
 390   // NUMA-specific interface
 391   static bool   numa_has_static_binding();
 392   static bool   numa_has_group_homing();
 393   static void   numa_make_local(char *addr, size_t bytes, int lgrp_hint);
 394   static void   numa_make_global(char *addr, size_t bytes);
 395   static size_t numa_get_groups_num();
 396   static size_t numa_get_leaf_groups(int *ids, size_t size);
 397   static bool   numa_topology_changed();
 398   static int    numa_get_group_id();
 399 
 400   // Page manipulation
 401   struct page_info {
 402     size_t size;
 403     int lgrp_id;
 404   };
 405   static bool   get_page_info(char *start, page_info* info);
 406   static char*  scan_pages(char *start, char* end, page_info* page_expected, page_info* page_found);
 407 
 408   static char*  non_memory_address_word();
 409   // reserve, commit and pin the entire memory region
 410   static char*  reserve_memory_special(size_t size, size_t alignment,
 411                                        char* addr, bool executable);
 412   static bool   release_memory_special(char* addr, size_t bytes);
 413   static void   large_page_init();
 414   static size_t large_page_size();
 415   static bool   can_commit_large_page_memory();
 416   static bool   can_execute_large_page_memory();
 417 
 418   // OS interface to polling page
 419   static address get_polling_page()             { return _polling_page; }
 420   static void    set_polling_page(address page) { _polling_page = page; }
 421   static bool    is_poll_address(address addr)  { return addr &gt;= _polling_page &amp;&amp; addr &lt; (_polling_page + os::vm_page_size()); }
 422   static void    make_polling_page_unreadable();
 423   static void    make_polling_page_readable();
 424 
 425   // Check if pointer points to readable memory (by 4-byte read access)
 426   static bool    is_readable_pointer(const void* p);
 427   static bool    is_readable_range(const void* from, const void* to);
 428 
 429   // threads
 430 
 431   enum ThreadType {
 432     vm_thread,
 433     cgc_thread,        // Concurrent GC thread
 434     pgc_thread,        // Parallel GC thread
 435     java_thread,       // Java, CodeCacheSweeper, JVMTIAgent and Service threads.
 436     compiler_thread,
 437     watcher_thread,
 438     os_thread
 439   };
 440 
 441   static bool create_thread(Thread* thread,
 442                             ThreadType thr_type,
 443                             size_t req_stack_size = 0);
 444 
 445   // The &quot;main thread&quot;, also known as &quot;starting thread&quot;, is the thread
 446   // that loads/creates the JVM via JNI_CreateJavaVM.
 447   static bool create_main_thread(JavaThread* thread);
 448 
 449   // The primordial thread is the initial process thread. The java
 450   // launcher never uses the primordial thread as the main thread, but
 451   // applications that host the JVM directly may do so. Some platforms
 452   // need special-case handling of the primordial thread if it attaches
 453   // to the VM.
 454   static bool is_primordial_thread(void)
 455 #if defined(_WINDOWS) || defined(BSD)
 456     // No way to identify the primordial thread.
 457     { return false; }
 458 #else
 459   ;
 460 #endif
 461 
 462   static bool create_attached_thread(JavaThread* thread);
 463   static void pd_start_thread(Thread* thread);
 464   static void start_thread(Thread* thread);
 465 
 466   // Returns true if successful.
 467   static bool signal_thread(Thread* thread, int sig, const char* reason);
 468 
 469   static void free_thread(OSThread* osthread);
 470 
 471   // thread id on Linux/64bit is 64bit, on Windows and Solaris, it&#39;s 32bit
 472   static intx current_thread_id();
 473   static int current_process_id();
 474   static int sleep(Thread* thread, jlong ms, bool interruptable);
 475   // Short standalone OS sleep suitable for slow path spin loop.
 476   // Ignores Thread.interrupt() (so keep it short).
 477   // ms = 0, will sleep for the least amount of time allowed by the OS.
 478   static void naked_short_sleep(jlong ms);
 479   static void naked_short_nanosleep(jlong ns);
 480   static void infinite_sleep(); // never returns, use with CAUTION
 481   static void naked_yield () ;
 482   static OSReturn set_priority(Thread* thread, ThreadPriority priority);
 483   static OSReturn get_priority(const Thread* const thread, ThreadPriority&amp; priority);
 484 
 485   static void interrupt(Thread* thread);
 486   static bool is_interrupted(Thread* thread, bool clear_interrupted);
 487 
 488   static int pd_self_suspend_thread(Thread* thread);
 489 
 490   static ExtendedPC fetch_frame_from_context(const void* ucVoid, intptr_t** sp, intptr_t** fp);
 491   static frame      fetch_frame_from_context(const void* ucVoid);
 492   static frame      fetch_frame_from_ucontext(Thread* thread, void* ucVoid);
 493 
 494   static void breakpoint();
 495   static bool start_debugging(char *buf, int buflen);
 496 
 497   static address current_stack_pointer();
 498   static address current_stack_base();
 499   static size_t current_stack_size();
 500 
 501   static void verify_stack_alignment() PRODUCT_RETURN;
 502 
 503   static bool message_box(const char* title, const char* message);
 504   static char* do_you_want_to_debug(const char* message);
 505 
 506   // run cmd in a separate process and return its exit code; or -1 on failures
 507   static int fork_and_exec(char *cmd, bool use_vfork_if_available = false);
 508 
 509   // Call ::exit() on all platforms but Windows
 510   static void exit(int num);
 511 
 512   // Terminate the VM, but don&#39;t exit the process
 513   static void shutdown();
 514 
 515   // Terminate with an error.  Default is to generate a core file on platforms
 516   // that support such things.  This calls shutdown() and then aborts.
 517   static void abort(bool dump_core, void *siginfo, const void *context);
 518   static void abort(bool dump_core = true);
 519 
 520   // Die immediately, no exit hook, no abort hook, no cleanup.
 521   static void die();
 522 
 523   // File i/o operations
 524   static const int default_file_open_flags();
 525   static int open(const char *path, int oflag, int mode);
 526   static FILE* open(int fd, const char* mode);
 527   static FILE* fopen(const char* path, const char* mode);
 528   static int close(int fd);
 529   static jlong lseek(int fd, jlong offset, int whence);
 530   // This function, on Windows, canonicalizes a given path (see os_windows.cpp for details).
 531   // On Posix, this function is a noop: it does not change anything and just returns
 532   // the input pointer.
 533   static char* native_path(char *path);
 534   static int ftruncate(int fd, jlong length);
 535   static int fsync(int fd);
 536   static int available(int fd, jlong *bytes);
 537   static int get_fileno(FILE* fp);
 538   static void flockfile(FILE* fp);
 539   static void funlockfile(FILE* fp);
 540 
 541   static int compare_file_modified_times(const char* file1, const char* file2);
 542 
 543   //File i/o operations
 544 
 545   static ssize_t read(int fd, void *buf, unsigned int nBytes);
 546   static ssize_t read_at(int fd, void *buf, unsigned int nBytes, jlong offset);
 547   static size_t write(int fd, const void *buf, unsigned int nBytes);
 548 
 549   // Reading directories.
 550   static DIR*           opendir(const char* dirname);
 551   static struct dirent* readdir(DIR* dirp);
 552   static int            closedir(DIR* dirp);
 553 
 554   // Dynamic library extension
 555   static const char*    dll_file_extension();
 556 
 557   static const char*    get_temp_directory();
 558   static const char*    get_current_directory(char *buf, size_t buflen);
 559 
 560   // Builds the platform-specific name of a library.
 561   // Returns false if the buffer is too small.
 562   static bool           dll_build_name(char* buffer, size_t size,
 563                                        const char* fname);
 564 
 565   // Builds a platform-specific full library path given an ld path and
 566   // unadorned library name. Returns true if the buffer contains a full
 567   // path to an existing file, false otherwise. If pathname is empty,
 568   // uses the path to the current directory.
 569   static bool           dll_locate_lib(char* buffer, size_t size,
 570                                        const char* pathname, const char* fname);
 571 
 572   // Symbol lookup, find nearest function name; basically it implements
 573   // dladdr() for all platforms. Name of the nearest function is copied
 574   // to buf. Distance from its base address is optionally returned as offset.
 575   // If function name is not found, buf[0] is set to &#39;\0&#39; and offset is
 576   // set to -1 (if offset is non-NULL).
 577   static bool dll_address_to_function_name(address addr, char* buf,
 578                                            int buflen, int* offset,
 579                                            bool demangle = true);
 580 
 581   // Locate DLL/DSO. On success, full path of the library is copied to
 582   // buf, and offset is optionally set to be the distance between addr
 583   // and the library&#39;s base address. On failure, buf[0] is set to &#39;\0&#39;
 584   // and offset is set to -1 (if offset is non-NULL).
 585   static bool dll_address_to_library_name(address addr, char* buf,
 586                                           int buflen, int* offset);
 587 
 588   // Find out whether the pc is in the static code for jvm.dll/libjvm.so.
 589   static bool address_is_in_vm(address addr);
 590 
 591   // Loads .dll/.so and
 592   // in case of error it checks if .dll/.so was built for the
 593   // same architecture as HotSpot is running on
 594   static void* dll_load(const char *name, char *ebuf, int ebuflen);
 595 
 596   // lookup symbol in a shared library
 597   static void* dll_lookup(void* handle, const char* name);
 598 
 599   // Unload library
 600   static void  dll_unload(void *lib);
 601 
 602   // Callback for loaded module information
 603   // Input parameters:
 604   //    char*     module_file_name,
 605   //    address   module_base_addr,
 606   //    address   module_top_addr,
 607   //    void*     param
 608   typedef int (*LoadedModulesCallbackFunc)(const char *, address, address, void *);
 609 
 610   static int get_loaded_modules_info(LoadedModulesCallbackFunc callback, void *param);
 611 
 612   // Return the handle of this process
 613   static void* get_default_process_handle();
 614 
 615   // Check for static linked agent library
 616   static bool find_builtin_agent(AgentLibrary *agent_lib, const char *syms[],
 617                                  size_t syms_len);
 618 
 619   // Find agent entry point
 620   static void *find_agent_function(AgentLibrary *agent_lib, bool check_lib,
 621                                    const char *syms[], size_t syms_len);
 622 
 623   // Provide C99 compliant versions of these functions, since some versions
 624   // of some platforms don&#39;t.
 625   static int vsnprintf(char* buf, size_t len, const char* fmt, va_list args) ATTRIBUTE_PRINTF(3, 0);
 626   static int snprintf(char* buf, size_t len, const char* fmt, ...) ATTRIBUTE_PRINTF(3, 4);
 627 
 628   // Get host name in buffer provided
 629   static bool get_host_name(char* buf, size_t buflen);
 630 
 631   // Print out system information; they are called by fatal error handler.
 632   // Output format may be different on different platforms.
 633   static void print_os_info(outputStream* st);
 634   static void print_os_info_brief(outputStream* st);
 635   static void print_cpu_info(outputStream* st, char* buf, size_t buflen);
 636   static void pd_print_cpu_info(outputStream* st, char* buf, size_t buflen);
 637   static void print_summary_info(outputStream* st, char* buf, size_t buflen);
 638   static void print_memory_info(outputStream* st);
 639   static void print_dll_info(outputStream* st);
 640   static void print_environment_variables(outputStream* st, const char** env_list);
 641   static void print_context(outputStream* st, const void* context);
 642   static void print_register_info(outputStream* st, const void* context);
 643   static bool signal_sent_by_kill(const void* siginfo);
 644   static void print_siginfo(outputStream* st, const void* siginfo);
 645   static void print_signal_handlers(outputStream* st, char* buf, size_t buflen);
 646   static void print_date_and_time(outputStream* st, char* buf, size_t buflen);
 647   static void print_instructions(outputStream* st, address pc, int unitsize);
 648 
 649   static void print_location(outputStream* st, intptr_t x, bool verbose = false);
 650   static size_t lasterror(char *buf, size_t len);
 651   static int get_last_error();
 652 
 653   // Replacement for strerror().
 654   // Will return the english description of the error (e.g. &quot;File not found&quot;, as
 655   //  suggested in the POSIX standard.
 656   // Will return &quot;Unknown error&quot; for an unknown errno value.
 657   // Will not attempt to localize the returned string.
 658   // Will always return a valid string which is a static constant.
 659   // Will not change the value of errno.
 660   static const char* strerror(int e);
 661 
 662   // Will return the literalized version of the given errno (e.g. &quot;EINVAL&quot;
 663   //  for EINVAL).
 664   // Will return &quot;Unknown error&quot; for an unknown errno value.
 665   // Will always return a valid string which is a static constant.
 666   // Will not change the value of errno.
 667   static const char* errno_name(int e);
 668 
 669   // Determines whether the calling process is being debugged by a user-mode debugger.
 670   static bool is_debugger_attached();
 671 
 672   // wait for a key press if PauseAtExit is set
 673   static void wait_for_keypress_at_exit(void);
 674 
 675   // The following two functions are used by fatal error handler to trace
 676   // native (C) frames. They are not part of frame.hpp/frame.cpp because
 677   // frame.hpp/cpp assume thread is JavaThread, and also because different
 678   // OS/compiler may have different convention or provide different API to
 679   // walk C frames.
 680   //
 681   // We don&#39;t attempt to become a debugger, so we only follow frames if that
 682   // does not require a lookup in the unwind table, which is part of the binary
 683   // file but may be unsafe to read after a fatal error. So on x86, we can
 684   // only walk stack if %ebp is used as frame pointer; on ia64, it&#39;s not
 685   // possible to walk C stack without having the unwind table.
 686   static bool is_first_C_frame(frame *fr);
 687   static frame get_sender_for_C_frame(frame *fr);
 688 
 689   // return current frame. pc() and sp() are set to NULL on failure.
 690   static frame      current_frame();
 691 
 692   static void print_hex_dump(outputStream* st, address start, address end, int unitsize);
 693 
 694   // returns a string to describe the exception/signal;
 695   // returns NULL if exception_code is not an OS exception/signal.
 696   static const char* exception_name(int exception_code, char* buf, size_t buflen);
 697 
 698   // Returns the signal number (e.g. 11) for a given signal name (SIGSEGV).
 699   static int get_signal_number(const char* signal_name);
 700 
 701   // Returns native Java library, loads if necessary
 702   static void*    native_java_library();
 703 
 704   // Fills in path to jvm.dll/libjvm.so (used by the Disassembler)
 705   static void     jvm_path(char *buf, jint buflen);
 706 
 707   // JNI names
 708   static void     print_jni_name_prefix_on(outputStream* st, int args_size);
 709   static void     print_jni_name_suffix_on(outputStream* st, int args_size);
 710 
 711   // Init os specific system properties values
 712   static void init_system_properties_values();
 713 
 714   // IO operations, non-JVM_ version.
 715   static int stat(const char* path, struct stat* sbuf);
 716   static bool dir_is_empty(const char* path);
 717 
 718   // IO operations on binary files
 719   static int create_binary_file(const char* path, bool rewrite_existing);
 720   static jlong current_file_offset(int fd);
 721   static jlong seek_to_file_offset(int fd, jlong offset);
 722 
 723   // Retrieve native stack frames.
 724   // Parameter:
 725   //   stack:  an array to storage stack pointers.
 726   //   frames: size of above array.
 727   //   toSkip: number of stack frames to skip at the beginning.
 728   // Return: number of stack frames captured.
 729   static int get_native_stack(address* stack, int size, int toSkip = 0);
 730 
 731   // General allocation (must be MT-safe)
 732   static void* malloc  (size_t size, MEMFLAGS flags, const NativeCallStack&amp; stack);
 733   static void* malloc  (size_t size, MEMFLAGS flags);
 734   static void* realloc (void *memblock, size_t size, MEMFLAGS flag, const NativeCallStack&amp; stack);
 735   static void* realloc (void *memblock, size_t size, MEMFLAGS flag);
 736 
 737   static void  free    (void *memblock);
 738   static char* strdup(const char *, MEMFLAGS flags = mtInternal);  // Like strdup
 739   // Like strdup, but exit VM when strdup() returns NULL
 740   static char* strdup_check_oom(const char*, MEMFLAGS flags = mtInternal);
 741 
 742 #ifndef PRODUCT
 743   static julong num_mallocs;         // # of calls to malloc/realloc
 744   static julong alloc_bytes;         // # of bytes allocated
 745   static julong num_frees;           // # of calls to free
 746   static julong free_bytes;          // # of bytes freed
 747 #endif
 748 
 749   // SocketInterface (ex HPI SocketInterface )
 750   static int socket(int domain, int type, int protocol);
 751   static int socket_close(int fd);
 752   static int recv(int fd, char* buf, size_t nBytes, uint flags);
 753   static int send(int fd, char* buf, size_t nBytes, uint flags);
 754   static int raw_send(int fd, char* buf, size_t nBytes, uint flags);
 755   static int connect(int fd, struct sockaddr* him, socklen_t len);
 756   static struct hostent* get_host_by_name(char* name);
 757 
 758   // Support for signals (see JVM_RaiseSignal, JVM_RegisterSignal)
 759   static void  initialize_jdk_signal_support(TRAPS);
 760   static void  signal_notify(int signal_number);
 761   static void* signal(int signal_number, void* handler);
 762   static void  signal_raise(int signal_number);
 763   static int   signal_wait();
 764   static void* user_handler();
 765   static void  terminate_signal_thread();
 766   static int   sigexitnum_pd();
 767 
 768   // random number generation
 769   static int random();                     // return 32bit pseudorandom number
 770   static void init_random(unsigned int initval);    // initialize random sequence
 771 
 772   // Structured OS Exception support
 773   static void os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method, JavaCallArguments* args, Thread* thread);
 774 
 775   // On Posix compatible OS it will simply check core dump limits while on Windows
 776   // it will check if dump file can be created. Check or prepare a core dump to be
 777   // taken at a later point in the same thread in os::abort(). Use the caller
 778   // provided buffer as a scratch buffer. The status message which will be written
 779   // into the error log either is file location or a short error message, depending
 780   // on the checking result.
 781   static void check_dump_limit(char* buffer, size_t bufferSize);
 782 
 783   // Get the default path to the core file
 784   // Returns the length of the string
 785   static int get_core_path(char* buffer, size_t bufferSize);
 786 
 787   // JVMTI &amp; JVM monitoring and management support
 788   // The thread_cpu_time() and current_thread_cpu_time() are only
 789   // supported if is_thread_cpu_time_supported() returns true.
 790   // They are not supported on Solaris T1.
 791 
 792   // Thread CPU Time - return the fast estimate on a platform
 793   // On Solaris - call gethrvtime (fast) - user time only
 794   // On Linux   - fast clock_gettime where available - user+sys
 795   //            - otherwise: very slow /proc fs - user+sys
 796   // On Windows - GetThreadTimes - user+sys
 797   static jlong current_thread_cpu_time();
 798   static jlong thread_cpu_time(Thread* t);
 799 
 800   // Thread CPU Time with user_sys_cpu_time parameter.
 801   //
 802   // If user_sys_cpu_time is true, user+sys time is returned.
 803   // Otherwise, only user time is returned
 804   static jlong current_thread_cpu_time(bool user_sys_cpu_time);
 805   static jlong thread_cpu_time(Thread* t, bool user_sys_cpu_time);
 806 
 807   // Return a bunch of info about the timers.
 808   // Note that the returned info for these two functions may be different
 809   // on some platforms
 810   static void current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr);
 811   static void thread_cpu_time_info(jvmtiTimerInfo *info_ptr);
 812 
 813   static bool is_thread_cpu_time_supported();
 814 
 815   // System loadavg support.  Returns -1 if load average cannot be obtained.
 816   static int loadavg(double loadavg[], int nelem);
 817 
 818   // Amount beyond the callee frame size that we bang the stack.
 819   static int extra_bang_size_in_bytes();
 820 
 821   static char** split_path(const char* path, int* n);
 822 
 823   // Extensions
 824 #include &quot;runtime/os_ext.hpp&quot;
 825 
 826  public:
 827   class CrashProtectionCallback : public StackObj {
 828   public:
 829     virtual void call() = 0;
 830   };
 831 
 832   // Platform dependent stuff
 833 #ifndef _WINDOWS
 834 # include &quot;os_posix.hpp&quot;
 835 #endif
 836 #include OS_CPU_HEADER(os)
 837 #include OS_HEADER(os)
 838 
 839 #ifndef OS_NATIVE_THREAD_CREATION_FAILED_MSG
 840 #define OS_NATIVE_THREAD_CREATION_FAILED_MSG &quot;unable to create native thread: possibly out of memory or process/resource limits reached&quot;
 841 #endif
 842 
 843  public:
 844 #ifndef PLATFORM_PRINT_NATIVE_STACK
 845   // No platform-specific code for printing the native stack.
 846   static bool platform_print_native_stack(outputStream* st, const void* context,
 847                                           char *buf, int buf_size) {
 848     return false;
 849   }
 850 #endif
 851 
 852   // debugging support (mostly used by debug.cpp but also fatal error handler)
 853   static bool find(address pc, outputStream* st = tty); // OS specific function to make sense out of an address
 854 
 855   static bool dont_yield();                     // when true, JVM_Yield() is nop
 856   static void print_statistics();
 857 
 858   // Thread priority helpers (implemented in OS-specific part)
 859   static OSReturn set_native_priority(Thread* thread, int native_prio);
 860   static OSReturn get_native_priority(const Thread* const thread, int* priority_ptr);
 861   static int java_to_os_priority[CriticalPriority + 1];
 862   // Hint to the underlying OS that a task switch would not be good.
 863   // Void return because it&#39;s a hint and can fail.
 864   static const char* native_thread_creation_failed_msg() {
 865     return OS_NATIVE_THREAD_CREATION_FAILED_MSG;
 866   }
 867 
 868   // Used at creation if requested by the diagnostic flag PauseAtStartup.
 869   // Causes the VM to wait until an external stimulus has been applied
 870   // (for Unix, that stimulus is a signal, for Windows, an external
 871   // ResumeThread call)
 872   static void pause();
 873 
 874   // Builds a platform dependent Agent_OnLoad_&lt;libname&gt; function name
 875   // which is used to find statically linked in agents.
 876   static char*  build_agent_function_name(const char *sym, const char *cname,
 877                                           bool is_absolute_path);
 878 
 879   class SuspendedThreadTaskContext {
 880   public:
 881     SuspendedThreadTaskContext(Thread* thread, void *ucontext) : _thread(thread), _ucontext(ucontext) {}
 882     Thread* thread() const { return _thread; }
 883     void* ucontext() const { return _ucontext; }
 884   private:
 885     Thread* _thread;
 886     void* _ucontext;
 887   };
 888 
 889   class SuspendedThreadTask {
 890   public:
 891     SuspendedThreadTask(Thread* thread) : _thread(thread), _done(false) {}
 892     void run();
 893     bool is_done() { return _done; }
 894     virtual void do_task(const SuspendedThreadTaskContext&amp; context) = 0;
 895   protected:
 896     ~SuspendedThreadTask() {}
 897   private:
 898     void internal_do_task();
 899     Thread* _thread;
 900     bool _done;
 901   };
 902 
 903 #ifndef _WINDOWS
 904   // Suspend/resume support
 905   // Protocol:
 906   //
 907   // a thread starts in SR_RUNNING
 908   //
 909   // SR_RUNNING can go to
 910   //   * SR_SUSPEND_REQUEST when the WatcherThread wants to suspend it
 911   // SR_SUSPEND_REQUEST can go to
 912   //   * SR_RUNNING if WatcherThread decides it waited for SR_SUSPENDED too long (timeout)
 913   //   * SR_SUSPENDED if the stopped thread receives the signal and switches state
 914   // SR_SUSPENDED can go to
 915   //   * SR_WAKEUP_REQUEST when the WatcherThread has done the work and wants to resume
 916   // SR_WAKEUP_REQUEST can go to
 917   //   * SR_RUNNING when the stopped thread receives the signal
 918   //   * SR_WAKEUP_REQUEST on timeout (resend the signal and try again)
 919   class SuspendResume {
 920    public:
 921     enum State {
 922       SR_RUNNING,
 923       SR_SUSPEND_REQUEST,
 924       SR_SUSPENDED,
 925       SR_WAKEUP_REQUEST
 926     };
 927 
 928   private:
 929     volatile State _state;
 930 
 931   private:
 932     /* try to switch state from state &quot;from&quot; to state &quot;to&quot;
 933      * returns the state set after the method is complete
 934      */
 935     State switch_state(State from, State to);
 936 
 937   public:
 938     SuspendResume() : _state(SR_RUNNING) { }
 939 
 940     State state() const { return _state; }
 941 
 942     State request_suspend() {
 943       return switch_state(SR_RUNNING, SR_SUSPEND_REQUEST);
 944     }
 945 
 946     State cancel_suspend() {
 947       return switch_state(SR_SUSPEND_REQUEST, SR_RUNNING);
 948     }
 949 
 950     State suspended() {
 951       return switch_state(SR_SUSPEND_REQUEST, SR_SUSPENDED);
 952     }
 953 
 954     State request_wakeup() {
 955       return switch_state(SR_SUSPENDED, SR_WAKEUP_REQUEST);
 956     }
 957 
 958     State running() {
 959       return switch_state(SR_WAKEUP_REQUEST, SR_RUNNING);
 960     }
 961 
 962     bool is_running() const {
 963       return _state == SR_RUNNING;
 964     }
 965 
 966     bool is_suspend_request() const {
 967       return _state == SR_SUSPEND_REQUEST;
 968     }
 969 
 970     bool is_suspended() const {
 971       return _state == SR_SUSPENDED;
 972     }
 973   };
 974 #endif // !WINDOWS
 975 
 976 
 977  protected:
 978   static volatile unsigned int _rand_seed;    // seed for random number generator
 979   static int _processor_count;                // number of processors
 980   static int _initial_active_processor_count; // number of active processors during initialization.
 981 
 982   static char* format_boot_path(const char* format_string,
 983                                 const char* home,
 984                                 int home_len,
 985                                 char fileSep,
 986                                 char pathSep);
 987   static bool set_boot_path(char fileSep, char pathSep);
 988 
 989 };
 990 
 991 #ifndef _WINDOWS
 992 template&lt;&gt; struct IsRegisteredEnum&lt;os::SuspendResume::State&gt; : public TrueType {};
 993 #endif // !_WINDOWS
 994 
 995 // Note that &quot;PAUSE&quot; is almost always used with synchronization
 996 // so arguably we should provide Atomic::SpinPause() instead
 997 // of the global SpinPause() with C linkage.
 998 // It&#39;d also be eligible for inlining on many platforms.
 999 
1000 extern &quot;C&quot; int SpinPause();
1001 
1002 #endif // SHARE_RUNTIME_OS_HPP
    </pre>
  </body>
</html>