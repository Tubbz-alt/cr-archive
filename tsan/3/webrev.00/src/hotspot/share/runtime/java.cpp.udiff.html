<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/java.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="interfaceSupport.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="java.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/java.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,25 +26,26 @@</span>
  #include &quot;jvm.h&quot;
  #include &quot;aot/aotLoader.hpp&quot;
  #include &quot;classfile/classLoader.hpp&quot;
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
<span class="udiff-line-added">+ #include &quot;classfile/symbolTable.hpp&quot;</span>
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;compiler/compileBroker.hpp&quot;
  #include &quot;compiler/compilerOracle.hpp&quot;
  #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  #include &quot;jfr/jfrEvents.hpp&quot;
  #include &quot;jfr/support/jfrThreadId.hpp&quot;
  #if INCLUDE_JVMCI
<span class="udiff-line-modified-removed">- #include &quot;jvmci/jvmciCompiler.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;jvmci/jvmciRuntime.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;jvmci/jvmci.hpp&quot;</span>
  #endif
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;memory/oopFactory.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/dynamicArchive.hpp&quot;</span>
  #include &quot;memory/universe.hpp&quot;
  #include &quot;oops/constantPool.hpp&quot;
  #include &quot;oops/generateOopMap.hpp&quot;
  #include &quot;oops/instanceKlass.hpp&quot;
  #include &quot;oops/instanceOop.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,11 +54,10 @@</span>
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;oops/symbol.hpp&quot;
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;runtime/arguments.hpp&quot;
  #include &quot;runtime/biasedLocking.hpp&quot;
<span class="udiff-line-removed">- #include &quot;runtime/compilationPolicy.hpp&quot;</span>
  #include &quot;runtime/deoptimization.hpp&quot;
  #include &quot;runtime/flags/flagSetting.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/init.hpp&quot;
  #include &quot;runtime/interfaceSupport.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -200,13 +200,10 @@</span>
    if (CountBytecodes || TraceBytecodes || StopInterpreterAt) {
      tty-&gt;print_cr(&quot;[BytecodeCounter::counter_value = %d]&quot;, BytecodeCounter::counter_value());
    }
  }
  
<span class="udiff-line-removed">- AllocStats alloc_stats;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  
  // General statistics printing (profiling ...)
  void print_statistics() {
  #ifdef ASSERT
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -300,24 +297,24 @@</span>
    if (PrintBytecodePairHistogram) {
      BytecodePairHistogram::print();
    }
  
    if (PrintCodeCache) {
<span class="udiff-line-modified-removed">-     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      CodeCache::print();
    }
  
    // CodeHeap State Analytics.
    // Does also call NMethodSweeper::print(tty)
    if (PrintCodeHeapAnalytics) {
<span class="udiff-line-modified-removed">-     CompileBroker::print_heapinfo(NULL, &quot;all&quot;, &quot;4096&quot;); // details</span>
<span class="udiff-line-modified-added">+     CompileBroker::print_heapinfo(NULL, &quot;all&quot;, 4096); // details</span>
    } else if (PrintMethodFlushingStatistics) {
      NMethodSweeper::print(tty);
    }
  
    if (PrintCodeCache2) {
<span class="udiff-line-modified-removed">-     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      CodeCache::print_internals();
    }
  
    if (PrintVtableStats) {
      klassVtable::print_statistics();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -326,15 +323,10 @@</span>
    if (VerifyOops &amp;&amp; Verbose) {
      tty-&gt;print_cr(&quot;+VerifyOops count: %d&quot;, StubRoutines::verify_oop_count());
    }
  
    print_bytecode_count();
<span class="udiff-line-removed">-   if (PrintMallocStatistics) {</span>
<span class="udiff-line-removed">-     tty-&gt;print(&quot;allocation stats: &quot;);</span>
<span class="udiff-line-removed">-     alloc_stats.print();</span>
<span class="udiff-line-removed">-     tty-&gt;cr();</span>
<span class="udiff-line-removed">-   }</span>
  
    if (PrintSystemDictionaryAtExit) {
      ResourceMark rm;
      MutexLocker mcld(ClassLoaderDataGraph_lock);
      SystemDictionary::print();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -368,18 +360,18 @@</span>
    if (CITime) {
      CompileBroker::print_times();
    }
  
    if (PrintCodeCache) {
<span class="udiff-line-modified-removed">-     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
      CodeCache::print();
    }
  
    // CodeHeap State Analytics.
    // Does also call NMethodSweeper::print(tty)
    if (PrintCodeHeapAnalytics) {
<span class="udiff-line-modified-removed">-     CompileBroker::print_heapinfo(NULL, &quot;all&quot;, &quot;4096&quot;); // details</span>
<span class="udiff-line-modified-added">+     CompileBroker::print_heapinfo(NULL, &quot;all&quot;, 4096); // details</span>
    } else if (PrintMethodFlushingStatistics) {
      NMethodSweeper::print(tty);
    }
  
  #ifdef COMPILER2
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -417,18 +409,18 @@</span>
    // Note: don&#39;t use a Mutex to guard the entire before_exit(), as
    // JVMTI post_thread_end_event and post_vm_death_event will run native code.
    // A CAS or OSMutex would work just fine but then we need to manipulate
    // thread state for Safepoint. Here we use Monitor wait() and notify_all()
    // for synchronization.
<span class="udiff-line-modified-removed">-   { MutexLocker ml(BeforeExit_lock);</span>
<span class="udiff-line-modified-added">+   { MonitorLocker ml(BeforeExit_lock);</span>
      switch (_before_exit_status) {
      case BEFORE_EXIT_NOT_RUN:
        _before_exit_status = BEFORE_EXIT_RUNNING;
        break;
      case BEFORE_EXIT_RUNNING:
        while (_before_exit_status == BEFORE_EXIT_RUNNING) {
<span class="udiff-line-modified-removed">-         BeforeExit_lock-&gt;wait();</span>
<span class="udiff-line-modified-added">+         ml.wait();</span>
        }
        assert(_before_exit_status == BEFORE_EXIT_DONE, &quot;invalid state&quot;);
        return;
      case BEFORE_EXIT_DONE:
        // need block to avoid SS compiler bug
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -437,19 +429,11 @@</span>
        }
      }
    }
  
  #if INCLUDE_JVMCI
<span class="udiff-line-modified-removed">-   // We are not using CATCH here because we want the exit to continue normally.</span>
<span class="udiff-line-removed">-   Thread* THREAD = thread;</span>
<span class="udiff-line-removed">-   JVMCIRuntime::shutdown(THREAD);</span>
<span class="udiff-line-removed">-   if (HAS_PENDING_EXCEPTION) {</span>
<span class="udiff-line-removed">-     HandleMark hm(THREAD);</span>
<span class="udiff-line-removed">-     Handle exception(THREAD, PENDING_EXCEPTION);</span>
<span class="udiff-line-removed">-     CLEAR_PENDING_EXCEPTION;</span>
<span class="udiff-line-removed">-     java_lang_Throwable::java_printStackTrace(exception, THREAD);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   JVMCI::shutdown();</span>
  #endif
  
    // Hang forever on exit if we&#39;re reporting an error.
    if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
      os::infinite_sleep();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -504,10 +488,16 @@</span>
  
    // Terminate the signal thread
    // Note: we don&#39;t wait until it actually dies.
    os::terminate_signal_thread();
  
<span class="udiff-line-added">+ #if INCLUDE_CDS</span>
<span class="udiff-line-added">+   if (DynamicDumpSharedSpaces) {</span>
<span class="udiff-line-added">+     DynamicArchive::dump();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
    print_statistics();
    Universe::heap()-&gt;print_tracing_info();
  
    { MutexLocker ml(BeforeExit_lock);
      _before_exit_status = BEFORE_EXIT_DONE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -533,15 +523,35 @@</span>
    if (thread == NULL) {
      // very early initialization failure -- just exit
      vm_direct_exit(code);
    }
  
<span class="udiff-line-added">+   // We&#39;d like to add an entry to the XML log to show that the VM is</span>
<span class="udiff-line-added">+   // terminating, but we can&#39;t safely do that here. The logic to make</span>
<span class="udiff-line-added">+   // XML termination logging safe is tied to the termination of the</span>
<span class="udiff-line-added">+   // VMThread, and it doesn&#39;t terminate on this exit path. See 8222534.</span>
<span class="udiff-line-added">+ </span>
    if (VMThread::vm_thread() != NULL) {
<span class="udiff-line-added">+     if (thread-&gt;is_Java_thread()) {</span>
<span class="udiff-line-added">+       // We must be &quot;in_vm&quot; for the code below to work correctly.</span>
<span class="udiff-line-added">+       // Historically there must have been some exit path for which</span>
<span class="udiff-line-added">+       // that was not the case and so we set it explicitly - even</span>
<span class="udiff-line-added">+       // though we no longer know what that path may be.</span>
<span class="udiff-line-added">+       ((JavaThread*)thread)-&gt;set_thread_state(_thread_in_vm);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // Fire off a VM_Exit operation to bring VM to a safepoint and exit
      VM_Exit op(code);
<span class="udiff-line-modified-removed">-     if (thread-&gt;is_Java_thread())</span>
<span class="udiff-line-modified-removed">-       ((JavaThread*)thread)-&gt;set_thread_state(_thread_in_vm);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // 4945125 The vm thread comes to a safepoint during exit.</span>
<span class="udiff-line-added">+     // GC vm_operations can get caught at the safepoint, and the</span>
<span class="udiff-line-added">+     // heap is unparseable if they are caught. Grab the Heap_lock</span>
<span class="udiff-line-added">+     // to prevent this. The GC vm_operations will not be able to</span>
<span class="udiff-line-added">+     // queue until after we release it, but we never do that as we</span>
<span class="udiff-line-added">+     // are terminating the VM process.</span>
<span class="udiff-line-added">+     MutexLocker ml(Heap_lock);</span>
<span class="udiff-line-added">+ </span>
      VMThread::execute(&amp;op);
      // should never reach here; but in case something wrong with VM Thread.
      vm_direct_exit(code);
    } else {
      // VM thread is gone, just exit
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -678,36 +688,22 @@</span>
  }
  
  JDK_Version JDK_Version::_current;
  const char* JDK_Version::_runtime_name;
  const char* JDK_Version::_runtime_version;
<span class="udiff-line-added">+ const char* JDK_Version::_runtime_vendor_version;</span>
<span class="udiff-line-added">+ const char* JDK_Version::_runtime_vendor_vm_bug_url;</span>
  
  void JDK_Version::initialize() {
<span class="udiff-line-removed">-   jdk_version_info info;</span>
    assert(!_current.is_valid(), &quot;Don&#39;t initialize twice&quot;);
  
<span class="udiff-line-modified-removed">-   void *lib_handle = os::native_java_library();</span>
<span class="udiff-line-modified-removed">-   jdk_version_info_fn_t func = CAST_TO_FN_PTR(jdk_version_info_fn_t,</span>
<span class="udiff-line-modified-removed">-      os::dll_lookup(lib_handle, &quot;JDK_GetVersionInfo0&quot;));</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   assert(func != NULL, &quot;Support for JDK 1.5 or older has been removed after JEP-223&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-   (*func)(&amp;info, sizeof(info));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   int major = JDK_VERSION_MAJOR(info.jdk_version);</span>
<span class="udiff-line-removed">-   int minor = JDK_VERSION_MINOR(info.jdk_version);</span>
<span class="udiff-line-removed">-   int security = JDK_VERSION_SECURITY(info.jdk_version);</span>
<span class="udiff-line-removed">-   int build = JDK_VERSION_BUILD(info.jdk_version);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Incompatible with pre-4243978 JDK.</span>
<span class="udiff-line-removed">-   if (info.pending_list_uses_discovered_field == 0) {</span>
<span class="udiff-line-removed">-     vm_exit_during_initialization(</span>
<span class="udiff-line-removed">-       &quot;Incompatible JDK is not using Reference.discovered field for pending list&quot;);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   _current = JDK_Version(major, minor, security, info.patch_version, build,</span>
<span class="udiff-line-removed">-                          info.thread_park_blocker == 1,</span>
<span class="udiff-line-removed">-                          info.post_vm_init_hook_enabled == 1);</span>
<span class="udiff-line-modified-added">+   int major = VM_Version::vm_major_version();</span>
<span class="udiff-line-modified-added">+   int minor = VM_Version::vm_minor_version();</span>
<span class="udiff-line-modified-added">+   int security = VM_Version::vm_security_version();</span>
<span class="udiff-line-modified-added">+   int build = VM_Version::vm_build_number();</span>
<span class="udiff-line-modified-added">+   int patch = VM_Version::vm_patch_version();</span>
<span class="udiff-line-modified-added">+   _current = JDK_Version(major, minor, security, patch, build);</span>
  }
  
  void JDK_Version_init() {
    JDK_Version::initialize();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -726,10 +722,11 @@</span>
    uint64_t e = encode_jdk_version(*this);
    uint64_t o = encode_jdk_version(other);
    return (e &gt; o) ? 1 : ((e == o) ? 0 : -1);
  }
  
<span class="udiff-line-added">+ /* See JEP 223 */</span>
  void JDK_Version::to_string(char* buffer, size_t buflen) const {
    assert(buffer &amp;&amp; buflen &gt; 0, &quot;call with useful buffer&quot;);
    size_t index = 0;
  
    if (!is_valid()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -737,17 +734,16 @@</span>
    } else {
      int rc = jio_snprintf(
          &amp;buffer[index], buflen - index, &quot;%d.%d&quot;, _major, _minor);
      if (rc == -1) return;
      index += rc;
<span class="udiff-line-modified-removed">-     if (_security &gt; 0) {</span>
<span class="udiff-line-modified-removed">-       rc = jio_snprintf(&amp;buffer[index], buflen - index, &quot;.%d&quot;, _security);</span>
<span class="udiff-line-modified-added">+     if (_patch &gt; 0) {</span>
<span class="udiff-line-modified-added">+       rc = jio_snprintf(&amp;buffer[index], buflen - index, &quot;.%d.%d&quot;, _security, _patch);</span>
        if (rc == -1) return;
        index += rc;
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if (_patch &gt; 0) {</span>
<span class="udiff-line-removed">-       rc = jio_snprintf(&amp;buffer[index], buflen - index, &quot;.%d&quot;, _patch);</span>
<span class="udiff-line-modified-added">+     } else if (_security &gt; 0) {</span>
<span class="udiff-line-modified-added">+       rc = jio_snprintf(&amp;buffer[index], buflen - index, &quot;.%d&quot;, _security);</span>
        if (rc == -1) return;
        index += rc;
      }
      if (_build &gt; 0) {
        rc = jio_snprintf(&amp;buffer[index], buflen - index, &quot;+%d&quot;, _build);
</pre>
<center><a href="interfaceSupport.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="java.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>