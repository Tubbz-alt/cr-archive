<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/safepointVerifiers.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="safepointVerifiers.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="semaphore.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepointVerifiers.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
 26 #define SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
 27 
 28 #include &quot;memory/allocation.hpp&quot;
 29 #include &quot;runtime/thread.hpp&quot;
 30 
<span class="line-removed"> 31 // A NoGCVerifier object can be placed in methods where one assumes that</span>
<span class="line-removed"> 32 // no garbage collection will occur. The destructor will verify this property</span>
<span class="line-removed"> 33 // unless the constructor is called with argument false (not verifygc).</span>
<span class="line-removed"> 34 //</span>
<span class="line-removed"> 35 // The check will only be done in debug mode and if verifygc true.</span>
<span class="line-removed"> 36 </span>
<span class="line-removed"> 37 class NoGCVerifier: public StackObj {</span>
<span class="line-removed"> 38  friend class PauseNoGCVerifier;</span>
<span class="line-removed"> 39 </span>
<span class="line-removed"> 40  protected:</span>
<span class="line-removed"> 41   bool _verifygc;</span>
<span class="line-removed"> 42   unsigned int _old_invocations;</span>
<span class="line-removed"> 43 </span>
<span class="line-removed"> 44  public:</span>
<span class="line-removed"> 45 #ifdef ASSERT</span>
<span class="line-removed"> 46   NoGCVerifier(bool verifygc = true);</span>
<span class="line-removed"> 47   ~NoGCVerifier();</span>
<span class="line-removed"> 48 #else</span>
<span class="line-removed"> 49   NoGCVerifier(bool verifygc = true) {}</span>
<span class="line-removed"> 50   ~NoGCVerifier() {}</span>
<span class="line-removed"> 51 #endif</span>
<span class="line-removed"> 52 };</span>
<span class="line-removed"> 53 </span>
<span class="line-removed"> 54 // A PauseNoGCVerifier is used to temporarily pause the behavior</span>
<span class="line-removed"> 55 // of a NoGCVerifier object. If we are not in debug mode or if the</span>
<span class="line-removed"> 56 // NoGCVerifier object has a _verifygc value of false, then there</span>
<span class="line-removed"> 57 // is nothing to do.</span>
<span class="line-removed"> 58 </span>
<span class="line-removed"> 59 class PauseNoGCVerifier: public StackObj {</span>
<span class="line-removed"> 60  private:</span>
<span class="line-removed"> 61   NoGCVerifier * _ngcv;</span>
<span class="line-removed"> 62 </span>
<span class="line-removed"> 63  public:</span>
<span class="line-removed"> 64 #ifdef ASSERT</span>
<span class="line-removed"> 65   PauseNoGCVerifier(NoGCVerifier * ngcv);</span>
<span class="line-removed"> 66   ~PauseNoGCVerifier();</span>
<span class="line-removed"> 67 #else</span>
<span class="line-removed"> 68   PauseNoGCVerifier(NoGCVerifier * ngcv) {}</span>
<span class="line-removed"> 69   ~PauseNoGCVerifier() {}</span>
<span class="line-removed"> 70 #endif</span>
<span class="line-removed"> 71 };</span>
<span class="line-removed"> 72 </span>
<span class="line-removed"> 73 </span>
 74 // A NoSafepointVerifier object will throw an assertion failure if
 75 // the current thread passes a possible safepoint while this object is
 76 // instantiated. A safepoint, will either be: an oop allocation, blocking
 77 // on a Mutex or JavaLock, or executing a VM operation.
 78 //
<span class="line-modified"> 79 // If StrictSafepointChecks is turned off, it degrades into a NoGCVerifier</span>
<span class="line-removed"> 80 //</span>
<span class="line-removed"> 81 class NoSafepointVerifier : public NoGCVerifier {</span>
 82  friend class PauseNoSafepointVerifier;
 83 
 84  private:
<span class="line-removed"> 85   bool _activated;</span>
 86   Thread *_thread;
 87  public:
<span class="line-modified"> 88 #ifdef ASSERT</span>
<span class="line-modified"> 89   NoSafepointVerifier(bool activated = true, bool verifygc = true ) :</span>
<span class="line-removed"> 90     NoGCVerifier(verifygc),</span>
<span class="line-removed"> 91     _activated(activated) {</span>
<span class="line-removed"> 92     _thread = Thread::current();</span>
<span class="line-removed"> 93     if (_activated) {</span>
<span class="line-removed"> 94       _thread-&gt;_allow_allocation_count++;</span>
<span class="line-removed"> 95       _thread-&gt;_allow_safepoint_count++;</span>
<span class="line-removed"> 96     }</span>
<span class="line-removed"> 97   }</span>
<span class="line-removed"> 98 </span>
<span class="line-removed"> 99   ~NoSafepointVerifier() {</span>
<span class="line-removed">100     if (_activated) {</span>
<span class="line-removed">101       _thread-&gt;_allow_allocation_count--;</span>
<span class="line-removed">102       _thread-&gt;_allow_safepoint_count--;</span>
<span class="line-removed">103     }</span>
<span class="line-removed">104   }</span>
<span class="line-removed">105 #else</span>
<span class="line-removed">106   NoSafepointVerifier(bool activated = true, bool verifygc = true) : NoGCVerifier(verifygc){}</span>
<span class="line-removed">107   ~NoSafepointVerifier() {}</span>
<span class="line-removed">108 #endif</span>
109 };
110 
111 // A PauseNoSafepointVerifier is used to temporarily pause the
<span class="line-modified">112 // behavior of a NoSafepointVerifier object. If we are not in debug</span>
<span class="line-removed">113 // mode then there is nothing to do. If the NoSafepointVerifier</span>
<span class="line-removed">114 // object has an _activated value of false, then there is nothing to</span>
<span class="line-removed">115 // do for safepoint and allocation checking, but there may still be</span>
<span class="line-removed">116 // something to do for the underlying NoGCVerifier object.</span>
117 
<span class="line-modified">118 class PauseNoSafepointVerifier : public PauseNoGCVerifier {</span>
119  private:
<span class="line-modified">120   NoSafepointVerifier * _nsv;</span>
121 
122  public:
<span class="line-modified">123 #ifdef ASSERT</span>
<span class="line-modified">124   PauseNoSafepointVerifier(NoSafepointVerifier * nsv)</span>
<span class="line-removed">125     : PauseNoGCVerifier(nsv) {</span>
<span class="line-removed">126 </span>
<span class="line-removed">127     _nsv = nsv;</span>
<span class="line-removed">128     if (_nsv-&gt;_activated) {</span>
<span class="line-removed">129       _nsv-&gt;_thread-&gt;_allow_allocation_count--;</span>
<span class="line-removed">130       _nsv-&gt;_thread-&gt;_allow_safepoint_count--;</span>
<span class="line-removed">131     }</span>
<span class="line-removed">132   }</span>
<span class="line-removed">133 </span>
<span class="line-removed">134   ~PauseNoSafepointVerifier() {</span>
<span class="line-removed">135     if (_nsv-&gt;_activated) {</span>
<span class="line-removed">136       _nsv-&gt;_thread-&gt;_allow_allocation_count++;</span>
<span class="line-removed">137       _nsv-&gt;_thread-&gt;_allow_safepoint_count++;</span>
<span class="line-removed">138     }</span>
<span class="line-removed">139   }</span>
<span class="line-removed">140 #else</span>
<span class="line-removed">141   PauseNoSafepointVerifier(NoSafepointVerifier * nsv)</span>
<span class="line-removed">142     : PauseNoGCVerifier(nsv) {}</span>
<span class="line-removed">143   ~PauseNoSafepointVerifier() {}</span>
<span class="line-removed">144 #endif</span>
<span class="line-removed">145 };</span>
<span class="line-removed">146 </span>
<span class="line-removed">147 // A NoAllocVerifier object can be placed in methods where one assumes that</span>
<span class="line-removed">148 // no allocation will occur. The destructor will verify this property</span>
<span class="line-removed">149 // unless the constructor is called with argument false (not activated).</span>
<span class="line-removed">150 //</span>
<span class="line-removed">151 // The check will only be done in debug mode and if activated.</span>
<span class="line-removed">152 // Note: this only makes sense at safepoints (otherwise, other threads may</span>
<span class="line-removed">153 // allocate concurrently.)</span>
<span class="line-removed">154 </span>
<span class="line-removed">155 class NoAllocVerifier : public StackObj {</span>
<span class="line-removed">156  private:</span>
<span class="line-removed">157   bool  _activated;</span>
<span class="line-removed">158 </span>
<span class="line-removed">159  public:</span>
<span class="line-removed">160 #ifdef ASSERT</span>
<span class="line-removed">161   NoAllocVerifier(bool activated = true) {</span>
<span class="line-removed">162     _activated = activated;</span>
<span class="line-removed">163     if (_activated) Thread::current()-&gt;_allow_allocation_count++;</span>
<span class="line-removed">164   }</span>
<span class="line-removed">165 </span>
<span class="line-removed">166   ~NoAllocVerifier() {</span>
<span class="line-removed">167     if (_activated) Thread::current()-&gt;_allow_allocation_count--;</span>
<span class="line-removed">168   }</span>
<span class="line-removed">169 #else</span>
<span class="line-removed">170   NoAllocVerifier(bool activated = true) {}</span>
<span class="line-removed">171   ~NoAllocVerifier() {}</span>
<span class="line-removed">172 #endif</span>
173 };
174 
175 #endif // SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
</pre>
</td>
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
 26 #define SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
 27 
 28 #include &quot;memory/allocation.hpp&quot;
 29 #include &quot;runtime/thread.hpp&quot;
 30 











































 31 // A NoSafepointVerifier object will throw an assertion failure if
 32 // the current thread passes a possible safepoint while this object is
 33 // instantiated. A safepoint, will either be: an oop allocation, blocking
 34 // on a Mutex or JavaLock, or executing a VM operation.
 35 //
<span class="line-modified"> 36 class NoSafepointVerifier : public StackObj {</span>


 37  friend class PauseNoSafepointVerifier;
 38 
 39  private:

 40   Thread *_thread;
 41  public:
<span class="line-modified"> 42   NoSafepointVerifier()  NOT_DEBUG_RETURN;</span>
<span class="line-modified"> 43   ~NoSafepointVerifier() NOT_DEBUG_RETURN;</span>



















 44 };
 45 
 46 // A PauseNoSafepointVerifier is used to temporarily pause the
<span class="line-modified"> 47 // behavior of a NoSafepointVerifier object.</span>




 48 
<span class="line-modified"> 49 class PauseNoSafepointVerifier : public StackObj {</span>
 50  private:
<span class="line-modified"> 51   NoSafepointVerifier* _nsv;</span>
 52 
 53  public:
<span class="line-modified"> 54   PauseNoSafepointVerifier(NoSafepointVerifier* nsv) NOT_DEBUG_RETURN;</span>
<span class="line-modified"> 55   ~PauseNoSafepointVerifier() NOT_DEBUG_RETURN;</span>
















































 56 };
 57 
 58 #endif // SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
</pre>
</td>
</tr>
</table>
<center><a href="safepointVerifiers.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="semaphore.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>