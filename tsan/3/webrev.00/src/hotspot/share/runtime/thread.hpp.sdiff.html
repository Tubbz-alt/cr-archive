<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/thread.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="thread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="thread.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/thread.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
</pre>
<hr />
<pre>
  31 #include &quot;gc/shared/threadLocalAllocBuffer.hpp&quot;
  32 #include &quot;memory/allocation.hpp&quot;
  33 #include &quot;oops/oop.hpp&quot;
  34 #include &quot;prims/jvmtiExport.hpp&quot;
  35 #include &quot;runtime/frame.hpp&quot;
  36 #include &quot;runtime/globals.hpp&quot;
  37 #include &quot;runtime/handshake.hpp&quot;
  38 #include &quot;runtime/javaFrameAnchor.hpp&quot;
  39 #include &quot;runtime/jniHandles.hpp&quot;
  40 #include &quot;runtime/mutexLocker.hpp&quot;
  41 #include &quot;runtime/os.hpp&quot;
  42 #include &quot;runtime/osThread.hpp&quot;
  43 #include &quot;runtime/park.hpp&quot;
  44 #include &quot;runtime/stubRoutines.hpp&quot;
  45 #include &quot;runtime/threadHeapSampler.hpp&quot;
  46 #include &quot;runtime/threadLocalStorage.hpp&quot;
  47 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
  48 #include &quot;runtime/unhandledOops.hpp&quot;
  49 #include &quot;utilities/align.hpp&quot;
  50 #include &quot;utilities/exceptions.hpp&quot;

  51 #include &quot;utilities/macros.hpp&quot;
  52 #ifdef ZERO
  53 # include &quot;stack_zero.hpp&quot;
  54 #endif
  55 #if INCLUDE_JFR
  56 #include &quot;jfr/support/jfrThreadExtension.hpp&quot;
  57 #endif
  58 
  59 
  60 class SafeThreadsListPtr;
  61 class ThreadSafepointState;
  62 class ThreadsList;
  63 class ThreadsSMRSupport;
  64 

  65 class JvmtiThreadState;
  66 class ThreadStatistics;
  67 class ConcurrentLocksDump;
  68 class ParkEvent;
  69 class Parker;
  70 class MonitorInfo;
  71 
  72 class ciEnv;
  73 class CompileThread;
  74 class CompileLog;
  75 class CompileTask;
  76 class CompileQueue;
  77 class CompilerCounters;
  78 
  79 class vframeArray;
  80 class vframe;
  81 class javaVFrame;
  82 
  83 class DeoptResourceMark;
  84 class jvmtiDeferredLocalVariableSet;
  85 
<span class="line-removed">  86 class GCTaskQueue;</span>
  87 class ThreadClosure;
  88 class ICRefillVerifier;
  89 class IdealGraphPrinter;
  90 



  91 class Metadata;
  92 class ResourceArea;
  93 
  94 DEBUG_ONLY(class ResourceMark;)
  95 
  96 class WorkerThread;
  97 
  98 // Class hierarchy
  99 // - Thread
 100 //   - JavaThread
 101 //     - various subclasses eg CompilerThread, ServiceThread
 102 //   - NonJavaThread
 103 //     - NamedThread
 104 //       - VMThread
 105 //       - ConcurrentGCThread
 106 //       - WorkerThread
 107 //         - GangWorker
<span class="line-removed"> 108 //         - GCTaskThread</span>
 109 //     - WatcherThread
 110 //     - JfrThreadSampler
 111 //
 112 // All Thread subclasses must be either JavaThread or NonJavaThread.
 113 // This means !t-&gt;is_Java_thread() iff t is a NonJavaThread, or t is
 114 // a partially constructed/destroyed Thread.
 115 
 116 // Thread execution sequence and actions:
 117 // All threads:
 118 //  - thread_native_entry  // per-OS native entry point
 119 //    - stack initialization
 120 //    - other OS-level initialization (signal masks etc)
 121 //    - handshake with creating thread (if not started suspended)
 122 //    - this-&gt;call_run()  // common shared entry point
 123 //      - shared common initialization
 124 //      - this-&gt;pre_run()  // virtual per-thread-type initialization
 125 //      - this-&gt;run()      // virtual per-thread-type &quot;main&quot; logic
 126 //      - shared common tear-down
 127 //      - this-&gt;post_run()  // virtual per-thread-type tear-down
 128 //      - // &#39;this&#39; no longer referenceable
 129 //    - OS-level tear-down (minimal)
 130 //    - final logging
 131 //
 132 // For JavaThread:
 133 //   - this-&gt;run()  // virtual but not normally overridden
 134 //     - this-&gt;thread_main_inner()  // extra call level to ensure correct stack calculations
 135 //       - this-&gt;entry_point()  // set differently for each kind of JavaThread
 136 
 137 class Thread: public ThreadShadow {
 138   friend class VMStructs;
 139   friend class JVMCIVMStructs;
 140  private:
 141 
 142 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 143   // Current thread is maintained as a thread-local variable
<span class="line-modified"> 144   static THREAD_LOCAL_DECL Thread* _thr_current;</span>
 145 #endif
 146 
 147   // Thread local data area available to the GC. The internal
 148   // structure and contents of this data area is GC-specific.
 149   // Only GC and GC barrier code should access this data area.
 150   GCThreadLocalData _gc_data;
 151 
 152  public:
 153   static ByteSize gc_data_offset() {
 154     return byte_offset_of(Thread, _gc_data);
 155   }
 156 
 157   template &lt;typename T&gt; T* gc_data() {
 158     STATIC_ASSERT(sizeof(T) &lt;= sizeof(_gc_data));
 159     return reinterpret_cast&lt;T*&gt;(&amp;_gc_data);
 160   }
 161 
 162   // Exception handling
 163   // (Note: _pending_exception and friends are in ThreadShadow)
 164   //oop       _pending_exception;                // pending exception for current thread
</pre>
<hr />
<pre>
 269   // Notes:
 270   // 1. The suspend/resume logic no longer uses ThreadState in OSThread
 271   // but we still update its value to keep other part of the system (mainly
 272   // JVMTI) happy. ThreadState is legacy code (see notes in
 273   // osThread.hpp).
 274   //
 275   // 2. It would be more natural if set_external_suspend() is private and
 276   // part of java_suspend(), but that probably would affect the suspend/query
 277   // performance. Need more investigation on this.
 278 
 279   // suspend/resume lock: used for self-suspend
 280   Monitor* _SR_lock;
 281 
 282  protected:
 283   enum SuspendFlags {
 284     // NOTE: avoid using the sign-bit as cc generates different test code
 285     //       when the sign-bit is used, and sometimes incorrectly - see CR 6398077
 286 
 287     _external_suspend       = 0x20000000U, // thread is asked to self suspend
 288     _ext_suspended          = 0x40000000U, // thread has self-suspended
<span class="line-removed"> 289     _deopt_suspend          = 0x10000000U, // thread needs to self suspend for deopt</span>
 290 
 291     _has_async_exception    = 0x00000001U, // there is a pending async exception
 292     _critical_native_unlock = 0x00000002U, // Must call back to unlock JNI critical lock
 293 
 294     _trace_flag             = 0x00000004U  // call tracing backend
 295   };
 296 
 297   // various suspension related flags - atomically updated
 298   // overloaded for async exception checking in check_special_condition_for_native_trans.
 299   volatile uint32_t _suspend_flags;
 300 
 301  private:
 302   int _num_nested_signal;
 303 
 304   DEBUG_ONLY(bool _suspendible_thread;)
 305 
 306  public:
 307   void enter_signal_handler() { _num_nested_signal++; }
 308   void leave_signal_handler() { _num_nested_signal--; }
 309   bool is_inside_signal_handler() const { return _num_nested_signal &gt; 0; }
</pre>
<hr />
<pre>
 321     _suspendible_thread = true;
 322   }
 323 
 324   void clear_suspendible_thread() {
 325     _suspendible_thread = false;
 326   }
 327 
 328   bool is_suspendible_thread() { return _suspendible_thread; }
 329 #endif
 330 
 331  private:
 332   // Active_handles points to a block of handles
 333   JNIHandleBlock* _active_handles;
 334 
 335   // One-element thread local free list
 336   JNIHandleBlock* _free_handle_block;
 337 
 338   // Point to the last handle mark
 339   HandleMark* _last_handle_mark;
 340 
<span class="line-modified"> 341   // The parity of the last strong_roots iteration in which this thread was</span>
<span class="line-modified"> 342   // claimed as a task.</span>
<span class="line-removed"> 343   int _oops_do_parity;</span>
 344 
 345   // Support for GlobalCounter
 346  private:
 347   volatile uintx _rcu_counter;
 348  public:
 349   volatile uintx* get_rcu_counter() {
 350     return &amp;_rcu_counter;
 351   }
 352 
 353  public:
 354   void set_last_handle_mark(HandleMark* mark)   { _last_handle_mark = mark; }
 355   HandleMark* last_handle_mark() const          { return _last_handle_mark; }
 356  private:
 357 
 358 #ifdef ASSERT
 359   ICRefillVerifier* _missed_ic_stub_refill_verifier;
 360 
 361  public:
 362   ICRefillVerifier* missed_ic_stub_refill_verifier() {
 363     return _missed_ic_stub_refill_verifier;
 364   }
 365 
 366   void set_missed_ic_stub_refill_verifier(ICRefillVerifier* verifier) {
 367     _missed_ic_stub_refill_verifier = verifier;
 368   }
<span class="line-modified"> 369 #endif</span>
 370 
 371  private:
 372 
<span class="line-modified"> 373   // debug support for checking if code does allow safepoints or not</span>
<span class="line-modified"> 374   // GC points in the VM can happen because of allocation, invoking a VM operation, or blocking on</span>
 375   // mutex, or blocking on an object synchronizer (Java locking).
<span class="line-modified"> 376   // If !allow_safepoint(), then an assertion failure will happen in any of the above cases</span>
<span class="line-modified"> 377   // If !allow_allocation(), then an assertion failure will happen during allocation</span>
<span class="line-removed"> 378   // (Hence, !allow_safepoint() =&gt; !allow_allocation()).</span>
 379   //
<span class="line-modified"> 380   // The two classes NoSafepointVerifier and No_Allocation_Verifier are used to set these counters.</span>
 381   //
<span class="line-modified"> 382   NOT_PRODUCT(int _allow_safepoint_count;)      // If 0, thread allow a safepoint to happen</span>
<span class="line-removed"> 383   debug_only(int _allow_allocation_count;)     // If 0, the thread is allowed to allocate oops.</span>
 384 

 385   // Used by SkipGCALot class.
 386   NOT_PRODUCT(bool _skip_gcalot;)               // Should we elide gc-a-lot?
 387 
<span class="line-modified"> 388   friend class NoAllocVerifier;</span>
 389   friend class NoSafepointVerifier;
 390   friend class PauseNoSafepointVerifier;
<span class="line-removed"> 391   friend class GCLocker;</span>
 392 
 393   volatile void* _polling_page;                 // Thread local polling page
 394 
 395   ThreadLocalAllocBuffer _tlab;                 // Thread-local eden
 396   jlong _allocated_bytes;                       // Cumulative number of bytes allocated on
 397                                                 // the Java heap
 398   ThreadHeapSampler _heap_sampler;              // For use when sampling the memory.
 399 
 400   ThreadStatisticalInfo _statistical_info;      // Statistics about the thread
 401 
 402   JFR_ONLY(DEFINE_THREAD_LOCAL_FIELD_JFR;)      // Thread-local data for jfr
 403 
 404   int   _vm_operation_started_count;            // VM_Operation support
 405   int   _vm_operation_completed_count;          // VM_Operation support
 406 
 407   ObjectMonitor* _current_pending_monitor;      // ObjectMonitor this thread
 408                                                 // is waiting to lock
 409   bool _current_pending_monitor_is_from_java;   // locking is from Java code



 410 
 411   // ObjectMonitor on which this thread called Object.wait()
 412   ObjectMonitor* _current_waiting_monitor;
 413 
<span class="line-modified"> 414   // Private thread-local objectmonitor list - a simple cache organized as a SLL.</span>
 415  public:
<span class="line-modified"> 416   ObjectMonitor* omFreeList;</span>
<span class="line-modified"> 417   int omFreeCount;                              // length of omFreeList</span>
<span class="line-modified"> 418   int omFreeProvision;                          // reload chunk size</span>
<span class="line-modified"> 419   ObjectMonitor* omInUseList;                   // SLL to track monitors in circulation</span>
<span class="line-modified"> 420   int omInUseCount;                             // length of omInUseList</span>
 421 
 422 #ifdef ASSERT
 423  private:
 424   volatile uint64_t _visited_for_critical_count;
 425 
 426  public:
 427   void set_visited_for_critical_count(uint64_t safepoint_id) {
 428     assert(_visited_for_critical_count == 0, &quot;Must be reset before set&quot;);
 429     assert((safepoint_id &amp; 0x1) == 1, &quot;Must be odd&quot;);
 430     _visited_for_critical_count = safepoint_id;
 431   }
 432   void reset_visited_for_critical_count(uint64_t safepoint_id) {
 433     assert(_visited_for_critical_count == safepoint_id, &quot;Was not visited&quot;);
 434     _visited_for_critical_count = 0;
 435   }
 436   bool was_visited_for_critical_count(uint64_t safepoint_id) const {
 437     return _visited_for_critical_count == safepoint_id;
 438   }
 439 #endif
 440 
</pre>
<hr />
<pre>
 462     PRE_CALL_RUN,
 463     CALL_RUN,
 464     PRE_RUN,
 465     RUN,
 466     POST_RUN
 467     // POST_CALL_RUN - can&#39;t define this one as &#39;this&#39; may be deleted when we want to set it
 468   };
 469   RunState _run_state;  // for lifecycle checks
 470 #endif
 471 
 472 
 473  public:
 474   // invokes &lt;ChildThreadClass&gt;::run(), with common preparations and cleanups.
 475   void call_run();
 476 
 477   // Testers
 478   virtual bool is_VM_thread()       const            { return false; }
 479   virtual bool is_Java_thread()     const            { return false; }
 480   virtual bool is_Compiler_thread() const            { return false; }
 481   virtual bool is_Code_cache_sweeper_thread() const  { return false; }

 482   virtual bool is_hidden_from_external_view() const  { return false; }
 483   virtual bool is_jvmti_agent_thread() const         { return false; }
 484   // True iff the thread can perform GC operations at a safepoint.
 485   // Generally will be true only of VM thread and parallel GC WorkGang
 486   // threads.
 487   virtual bool is_GC_task_thread() const             { return false; }
 488   virtual bool is_Watcher_thread() const             { return false; }
 489   virtual bool is_ConcurrentGC_thread() const        { return false; }
 490   virtual bool is_Named_thread() const               { return false; }
 491   virtual bool is_Worker_thread() const              { return false; }
 492 
 493   // Can this thread make Java upcalls
 494   virtual bool can_call_java() const                 { return false; }
 495 




 496   // Casts
 497   virtual WorkerThread* as_Worker_thread() const     { return NULL; }
 498 
 499   virtual char* name() const { return (char*)&quot;Unknown thread&quot;; }
 500 
 501   // Returns the current thread (ASSERTS if NULL)
 502   static inline Thread* current();
 503   // Returns the current thread, or NULL if not attached
 504   static inline Thread* current_or_null();
 505   // Returns the current thread, or NULL if not attached, and is
 506   // safe for use from signal-handlers
 507   static inline Thread* current_or_null_safe();
 508 
 509   // Common thread operations
 510 #ifdef ASSERT
 511   static void check_for_dangling_thread_pointer(Thread *thread);
 512 #endif
 513   static void set_priority(Thread* thread, ThreadPriority priority);
 514   static ThreadPriority get_priority(const Thread* const thread);
 515   static void start(Thread* thread);
<span class="line-removed"> 516   static void interrupt(Thread* thr);</span>
<span class="line-removed"> 517   static bool is_interrupted(Thread* thr, bool clear_interrupted);</span>
 518 
 519   void set_native_thread_name(const char *name) {
 520     assert(Thread::current() == this, &quot;set_native_thread_name can only be called on the current thread&quot;);
 521     os::set_native_thread_name(name);
 522   }
 523 
<span class="line-removed"> 524   ObjectMonitor** omInUseList_addr()             { return (ObjectMonitor **)&amp;omInUseList; }</span>
 525   Monitor* SR_lock() const                       { return _SR_lock; }
 526 
 527   bool has_async_exception() const { return (_suspend_flags &amp; _has_async_exception) != 0; }
 528 
 529   inline void set_suspend_flag(SuspendFlags f);
 530   inline void clear_suspend_flag(SuspendFlags f);
 531 
 532   inline void set_has_async_exception();
 533   inline void clear_has_async_exception();
 534 
 535   bool do_critical_native_unlock() const { return (_suspend_flags &amp; _critical_native_unlock) != 0; }
 536 
 537   inline void set_critical_native_unlock();
 538   inline void clear_critical_native_unlock();
 539 
 540   inline void set_trace_flag();
 541   inline void clear_trace_flag();
 542 
 543   // Support for Unhandled Oop detection
 544   // Add the field for both, fastdebug and debug, builds to keep
</pre>
<hr />
<pre>
 624     return _current_pending_monitor;
 625   }
 626   void set_current_pending_monitor(ObjectMonitor* monitor) {
 627     _current_pending_monitor = monitor;
 628   }
 629   void set_current_pending_monitor_is_from_java(bool from_java) {
 630     _current_pending_monitor_is_from_java = from_java;
 631   }
 632   bool current_pending_monitor_is_from_java() {
 633     return _current_pending_monitor_is_from_java;
 634   }
 635 
 636   // For tracking the ObjectMonitor on which this thread called Object.wait()
 637   ObjectMonitor* current_waiting_monitor() {
 638     return _current_waiting_monitor;
 639   }
 640   void set_current_waiting_monitor(ObjectMonitor* monitor) {
 641     _current_waiting_monitor = monitor;
 642   }
 643 








 644   // GC support
 645   // Apply &quot;f-&gt;do_oop&quot; to all root oops in &quot;this&quot;.
 646   //   Used by JavaThread::oops_do.
 647   // Apply &quot;cf-&gt;do_code_blob&quot; (if !NULL) to all code blobs active in frames
 648   virtual void oops_do(OopClosure* f, CodeBlobClosure* cf);
 649 
<span class="line-modified"> 650   // Handles the parallel case for the method below.</span>
 651  private:
<span class="line-modified"> 652   bool claim_oops_do_par_case(int collection_parity);</span>
 653  public:
<span class="line-modified"> 654   // Requires that &quot;collection_parity&quot; is that of the current roots</span>
<span class="line-modified"> 655   // iteration.  If &quot;is_par&quot; is false, sets the parity of &quot;this&quot; to</span>
<span class="line-modified"> 656   // &quot;collection_parity&quot;, and returns &quot;true&quot;.  If &quot;is_par&quot; is true,</span>
<span class="line-modified"> 657   // uses an atomic instruction to set the current threads parity to</span>
<span class="line-modified"> 658   // &quot;collection_parity&quot;, if it is not already.  Returns &quot;true&quot; iff the</span>
 659   // calling thread does the update, this indicates that the calling thread
<span class="line-modified"> 660   // has claimed the thread&#39;s stack as a root group in the current</span>
<span class="line-modified"> 661   // collection.</span>
<span class="line-removed"> 662   bool claim_oops_do(bool is_par, int collection_parity) {</span>
 663     if (!is_par) {
<span class="line-modified"> 664       _oops_do_parity = collection_parity;</span>
 665       return true;
 666     } else {
<span class="line-modified"> 667       return claim_oops_do_par_case(collection_parity);</span>
 668     }
 669   }
 670 


 671   // jvmtiRedefineClasses support
 672   void metadata_handles_do(void f(Metadata*));
 673 
 674   // Used by fast lock support
 675   virtual bool is_lock_owned(address adr) const;
 676 
<span class="line-modified"> 677   // Check if address is in the stack of the thread (not just for locks).</span>
<span class="line-modified"> 678   // Warning: the method can only be used on the running thread</span>
 679   bool is_in_stack(address adr) const;
<span class="line-modified"> 680   // Check if address is in the usable part of the stack (excludes protected</span>
<span class="line-modified"> 681   // guard pages)</span>
<span class="line-modified"> 682   bool is_in_usable_stack(address adr) const;</span>



 683 
 684   // Sets this thread as starting thread. Returns failure if thread
 685   // creation fails due to lack of memory, too many threads etc.
 686   bool set_as_starting_thread();
 687 
 688 protected:
 689   // OS data associated with the thread
 690   OSThread* _osthread;  // Platform-specific thread information
 691 
 692   // Thread local resource area for temporary allocation within the VM
 693   ResourceArea* _resource_area;
 694 
 695   DEBUG_ONLY(ResourceMark* _current_resource_mark;)
 696 
 697   // Thread local handle area for allocation of handles within the VM
 698   HandleArea* _handle_area;
 699   GrowableArray&lt;Metadata*&gt;* _metadata_handles;
 700 
 701   // Support for stack overflow handling, get_thread, etc.
 702   address          _stack_base;
 703   size_t           _stack_size;
<span class="line-removed"> 704   uintptr_t        _self_raw_id;      // used by get_thread (mutable)</span>
 705   int              _lgrp_id;
 706 
 707   volatile void** polling_page_addr() { return &amp;_polling_page; }
 708 
 709  public:
 710   // Stack overflow support
 711   address stack_base() const           { assert(_stack_base != NULL,&quot;Sanity check&quot;); return _stack_base; }
 712   void    set_stack_base(address base) { _stack_base = base; }
 713   size_t  stack_size() const           { return _stack_size; }
 714   void    set_stack_size(size_t size)  { _stack_size = size; }
 715   address stack_end()  const           { return stack_base() - stack_size(); }
 716   void    record_stack_base_and_size();
 717   void    register_thread_stack_with_NMT() NOT_NMT_RETURN;
 718 
<span class="line-removed"> 719   bool    on_local_stack(address adr) const {</span>
<span class="line-removed"> 720     // QQQ this has knowledge of direction, ought to be a stack method</span>
<span class="line-removed"> 721     return (_stack_base &gt;= adr &amp;&amp; adr &gt;= stack_end());</span>
<span class="line-removed"> 722   }</span>
<span class="line-removed"> 723 </span>
<span class="line-removed"> 724   uintptr_t self_raw_id()                    { return _self_raw_id; }</span>
<span class="line-removed"> 725   void      set_self_raw_id(uintptr_t value) { _self_raw_id = value; }</span>
<span class="line-removed"> 726 </span>
 727   int     lgrp_id() const        { return _lgrp_id; }
 728   void    set_lgrp_id(int value) { _lgrp_id = value; }
 729 
 730   // Printing
 731   void print_on(outputStream* st, bool print_extended_info) const;
 732   virtual void print_on(outputStream* st) const { print_on(st, false); }
<span class="line-modified"> 733   void print() const { print_on(tty); }</span>
 734   virtual void print_on_error(outputStream* st, char* buf, int buflen) const;
 735   void print_value_on(outputStream* st) const;
 736 
 737   // Debug-only code
 738 #ifdef ASSERT
 739  private:
 740   // Deadlock detection support for Mutex locks. List of locks own by thread.
<span class="line-modified"> 741   Monitor* _owned_locks;</span>
 742   // Mutex::set_owner_implementation is the only place where _owned_locks is modified,
 743   // thus the friendship
 744   friend class Mutex;
 745   friend class Monitor;
 746 
 747  public:
 748   void print_owned_locks_on(outputStream* st) const;
 749   void print_owned_locks() const                 { print_owned_locks_on(tty);    }
<span class="line-modified"> 750   Monitor* owned_locks() const                   { return _owned_locks;          }</span>
 751   bool owns_locks() const                        { return owned_locks() != NULL; }
<span class="line-removed"> 752   bool owns_locks_but_compiled_lock() const;</span>
<span class="line-removed"> 753   int oops_do_parity() const                     { return _oops_do_parity; }</span>
 754 
 755   // Deadlock detection
<span class="line-removed"> 756   bool allow_allocation()                        { return _allow_allocation_count == 0; }</span>
 757   ResourceMark* current_resource_mark()          { return _current_resource_mark; }
 758   void set_current_resource_mark(ResourceMark* rm) { _current_resource_mark = rm; }
<span class="line-modified"> 759 #endif</span>
 760 
<span class="line-modified"> 761   void check_for_valid_safepoint_state(bool potential_vm_operation) PRODUCT_RETURN;</span>



 762 
 763  private:
 764   volatile int _jvmti_env_iteration_count;
 765 
 766  public:
 767   void entering_jvmti_env_iteration()            { ++_jvmti_env_iteration_count; }
 768   void leaving_jvmti_env_iteration()             { --_jvmti_env_iteration_count; }
 769   bool is_inside_jvmti_env_iteration()           { return _jvmti_env_iteration_count &gt; 0; }
 770 
 771   // Code generation
 772   static ByteSize exception_file_offset()        { return byte_offset_of(Thread, _exception_file); }
 773   static ByteSize exception_line_offset()        { return byte_offset_of(Thread, _exception_line); }
 774   static ByteSize active_handles_offset()        { return byte_offset_of(Thread, _active_handles); }
 775 
 776   static ByteSize stack_base_offset()            { return byte_offset_of(Thread, _stack_base); }
 777   static ByteSize stack_size_offset()            { return byte_offset_of(Thread, _stack_size); }
 778 
 779   static ByteSize polling_page_offset()          { return byte_offset_of(Thread, _polling_page); }
 780 
 781   static ByteSize tlab_start_offset()            { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::start_offset(); }
 782   static ByteSize tlab_end_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::end_offset(); }
 783   static ByteSize tlab_top_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::top_offset(); }
 784   static ByteSize tlab_pf_top_offset()           { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::pf_top_offset(); }
 785 
 786   static ByteSize allocated_bytes_offset()       { return byte_offset_of(Thread, _allocated_bytes); }
 787 
 788   JFR_ONLY(DEFINE_THREAD_LOCAL_OFFSET_JFR;)
 789 
 790  public:
 791   volatile intptr_t _Stalled;
 792   volatile int _TypeTag;
<span class="line-modified"> 793   ParkEvent * _ParkEvent;                     // for synchronized()</span>
<span class="line-removed"> 794   ParkEvent * _SleepEvent;                    // for Thread.sleep</span>
 795   ParkEvent * _MuxEvent;                      // for low-level muxAcquire-muxRelease
 796   int NativeSyncRecursion;                    // diagnostic
 797 
 798   volatile int _OnTrap;                       // Resume-at IP delta
 799   jint _hashStateW;                           // Marsaglia Shift-XOR thread-local RNG
 800   jint _hashStateX;                           // thread-specific hashCode generator state
 801   jint _hashStateY;
 802   jint _hashStateZ;
 803 
 804   // Low-level leaf-lock primitives used to implement synchronization
 805   // and native monitor-mutex infrastructure.
 806   // Not for general synchronization use.
 807   static void SpinAcquire(volatile int * Lock, const char * Name);
 808   static void SpinRelease(volatile int * Lock);
 809   static void muxAcquire(volatile intptr_t * Lock, const char * Name);
<span class="line-removed"> 810   static void muxAcquireW(volatile intptr_t * Lock, ParkEvent * ev);</span>
 811   static void muxRelease(volatile intptr_t * Lock);
 812 };
 813 
 814 // Inline implementation of Thread::current()
 815 inline Thread* Thread::current() {
 816   Thread* current = current_or_null();
 817   assert(current != NULL, &quot;Thread::current() called on detached thread&quot;);
 818   return current;
 819 }
 820 
 821 inline Thread* Thread::current_or_null() {
 822 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 823   return _thr_current;
 824 #else
 825   if (ThreadLocalStorage::is_initialized()) {
 826     return ThreadLocalStorage::thread();
 827   }
 828   return NULL;
 829 #endif
 830 }
</pre>
<hr />
<pre>
 851   virtual void pre_run();
 852   virtual void post_run();
 853 
 854  public:
 855   NonJavaThread();
 856   ~NonJavaThread();
 857 
 858   class Iterator;
 859 };
 860 
 861 // Provides iteration over the list of NonJavaThreads.
 862 // List addition occurs in pre_run(), and removal occurs in post_run(),
 863 // so that only live fully-initialized threads can be found in the list.
 864 // Threads created after an iterator is constructed will not be visited
 865 // by the iterator. The scope of an iterator is a critical section; there
 866 // must be no safepoint checks in that scope.
 867 class NonJavaThread::Iterator : public StackObj {
 868   uint _protect_enter;
 869   NonJavaThread* _current;
 870 
<span class="line-modified"> 871   // Noncopyable.</span>
<span class="line-removed"> 872   Iterator(const Iterator&amp;);</span>
<span class="line-removed"> 873   Iterator&amp; operator=(const Iterator&amp;);</span>
 874 
 875 public:
 876   Iterator();
 877   ~Iterator();
 878 
 879   bool end() const { return _current == NULL; }
 880   NonJavaThread* current() const { return _current; }
 881   void step();
 882 };
 883 
 884 // Name support for threads.  non-JavaThread subclasses with multiple
 885 // uniquely named instances should derive from this.
 886 class NamedThread: public NonJavaThread {
 887   friend class VMStructs;
 888   enum {
 889     max_name_len = 64
 890   };
 891  private:
 892   char* _name;
 893   // log JavaThread being processed by oops_do
</pre>
<hr />
<pre>
 965   // Create and start the single instance of WatcherThread, or stop it on shutdown
 966   static void start();
 967   static void stop();
 968   // Only allow start once the VM is sufficiently initialized
 969   // Otherwise the first task to enroll will trigger the start
 970   static void make_startable();
 971  private:
 972   int sleep() const;
 973 };
 974 
 975 
 976 class CompilerThread;
 977 
 978 typedef void (*ThreadFunction)(JavaThread*, TRAPS);
 979 
 980 class JavaThread: public Thread {
 981   friend class VMStructs;
 982   friend class JVMCIVMStructs;
 983   friend class WhiteBox;
 984  private:
<span class="line-removed"> 985   JavaThread*    _next;                          // The next thread in the Threads list</span>
 986   bool           _on_thread_list;                // Is set when this JavaThread is added to the Threads list
 987   oop            _threadObj;                     // The Java level thread object
 988 
 989 #ifdef ASSERT
 990  private:
 991   int _java_call_counter;
 992 
 993  public:
 994   int  java_call_counter()                       { return _java_call_counter; }
 995   void inc_java_call_counter()                   { _java_call_counter++; }
 996   void dec_java_call_counter() {
 997     assert(_java_call_counter &gt; 0, &quot;Invalid nesting of JavaCallWrapper&quot;);
 998     _java_call_counter--;
 999   }
1000  private:  // restore original namespace restriction
1001 #endif  // ifdef ASSERT
1002 
1003 #ifndef PRODUCT
1004  public:
1005   enum {
1006     jump_ring_buffer_size = 16
1007   };
1008  private:  // restore original namespace restriction
1009 #endif
1010 
1011   JavaFrameAnchor _anchor;                       // Encapsulation of current java frame and it state
1012 
1013   ThreadFunction _entry_point;
1014 
1015   JNIEnv        _jni_environment;
1016 
1017   // Deopt support
1018   DeoptResourceMark*  _deopt_mark;               // Holds special ResourceMark for deoptimization
1019 
<span class="line-removed">1020   intptr_t*      _must_deopt_id;                 // id of frame that needs to be deopted once we</span>
<span class="line-removed">1021                                                  // transition out of native</span>
1022   CompiledMethod*       _deopt_nmethod;         // CompiledMethod that is currently being deoptimized
1023   vframeArray*  _vframe_array_head;              // Holds the heap of the active vframeArrays
1024   vframeArray*  _vframe_array_last;              // Holds last vFrameArray we popped
1025   // Because deoptimization is lazy we must save jvmti requests to set locals
1026   // in compiled frames until we deoptimize and we have an interpreter frame.
1027   // This holds the pointer to array (yeah like there might be more than one) of
1028   // description of compiled vframes that have locals that need to be updated.
1029   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* _deferred_locals_updates;
1030 
1031   // Handshake value for fixing 6243940. We need a place for the i2c
1032   // adapter to store the callee Method*. This value is NEVER live
1033   // across a gc point so it does NOT have to be gc&#39;d
1034   // The handshake is open ended since we can&#39;t be certain that it will
1035   // be NULLed. This is because we rarely ever see the race and end up
1036   // in handle_wrong_method which is the backend of the handshake. See
1037   // code in i2c adapters and handle_wrong_method.
1038 
1039   Method*       _callee_target;
1040 
1041   // Used to pass back results to the interpreter or generated code running Java code.
</pre>
<hr />
<pre>
1111     stack_guard_yellow_reserved_disabled,// disabled (temporarily) after stack overflow
1112     stack_guard_enabled         // enabled
1113   };
1114 
1115  private:
1116 
1117 #if INCLUDE_JVMCI
1118   // The _pending_* fields below are used to communicate extra information
1119   // from an uncommon trap in JVMCI compiled code to the uncommon trap handler.
1120 
1121   // Communicates the DeoptReason and DeoptAction of the uncommon trap
1122   int       _pending_deoptimization;
1123 
1124   // Specifies whether the uncommon trap is to bci 0 of a synchronized method
1125   // before the monitor has been acquired.
1126   bool      _pending_monitorenter;
1127 
1128   // Specifies if the DeoptReason for the last uncommon trap was Reason_transfer_to_interpreter
1129   bool      _pending_transfer_to_interpreter;
1130 
<span class="line-removed">1131   // Guard for re-entrant call to JVMCIRuntime::adjust_comp_level</span>
<span class="line-removed">1132   bool      _adjusting_comp_level;</span>
<span class="line-removed">1133 </span>
1134   // True if in a runtime call from compiled code that will deoptimize
1135   // and re-execute a failed heap allocation in the interpreter.
1136   bool      _in_retryable_allocation;
1137 
1138   // An id of a speculation that JVMCI compiled code can use to further describe and
1139   // uniquely identify the  speculative optimization guarded by the uncommon trap
<span class="line-modified">1140   long       _pending_failed_speculation;</span>
1141 
1142   // These fields are mutually exclusive in terms of live ranges.
1143   union {
1144     // Communicates the pc at which the most recent implicit exception occurred
1145     // from the signal handler to a deoptimization stub.
1146     address   _implicit_exception_pc;
1147 
1148     // Communicates an alternative call target to an i2c stub from a JavaCall .
1149     address   _alternate_call_target;
1150   } _jvmci;
1151 
1152   // Support for high precision, thread sensitive counters in JVMCI compiled code.
1153   jlong*    _jvmci_counters;
1154 
1155  public:
1156   static jlong* _jvmci_old_thread_counters;
<span class="line-modified">1157   static void collect_counters(typeArrayOop array);</span>



1158  private:
1159 #endif // INCLUDE_JVMCI
1160 
1161   StackGuardState  _stack_guard_state;
1162 
1163   // Precompute the limit of the stack as used in stack overflow checks.
1164   // We load it from here to simplify the stack overflow check in assembly.
1165   address          _stack_overflow_limit;
1166   address          _reserved_stack_activation;
1167 
1168   // Compiler exception handling (NOTE: The _exception_oop is *NOT* the same as _pending_exception. It is
1169   // used to temp. parsing values into and out of the runtime system during exception handling for compiled
1170   // code)
1171   volatile oop     _exception_oop;               // Exception thrown in compiled code
1172   volatile address _exception_pc;                // PC where exception happened
1173   volatile address _exception_handler_pc;        // PC for handler of exception
1174   volatile int     _is_method_handle_return;     // true (== 1) if the current exception PC is a MethodHandle call site.
1175 
1176  private:
1177   // support for JNI critical regions
1178   jint    _jni_active_critical;                  // count of entries into JNI critical region
1179 
1180   // Checked JNI: function name requires exception check
1181   char* _pending_jni_exception_check_fn;
1182 
1183   // For deadlock detection.
1184   int _depth_first_number;
1185 
1186   // JVMTI PopFrame support
1187   // This is set to popframe_pending to signal that top Java frame should be popped immediately
1188   int _popframe_condition;
1189 
1190   // If reallocation of scalar replaced objects fails, we throw OOM
1191   // and during exception propagation, pop the top
1192   // _frames_to_pop_failed_realloc frames, the ones that reference
1193   // failed reallocations.
1194   int _frames_to_pop_failed_realloc;
1195 
<span class="line-removed">1196 #ifndef PRODUCT</span>
<span class="line-removed">1197   int _jmp_ring_index;</span>
<span class="line-removed">1198   struct {</span>
<span class="line-removed">1199     // We use intptr_t instead of address so debugger doesn&#39;t try and display strings</span>
<span class="line-removed">1200     intptr_t _target;</span>
<span class="line-removed">1201     intptr_t _instruction;</span>
<span class="line-removed">1202     const char*  _file;</span>
<span class="line-removed">1203     int _line;</span>
<span class="line-removed">1204   }   _jmp_ring[jump_ring_buffer_size];</span>
<span class="line-removed">1205 #endif // PRODUCT</span>
<span class="line-removed">1206 </span>
1207   friend class VMThread;
1208   friend class ThreadWaitTransition;
1209   friend class VM_Exit;
1210 
1211   void initialize();                             // Initialized the instance variables
1212 
1213  public:
1214   // Constructor
1215   JavaThread(bool is_attaching_via_jni = false); // for main thread and JNI attached threads
1216   JavaThread(ThreadFunction entry_point, size_t stack_size = 0);
1217   ~JavaThread();
1218 
1219 #ifdef ASSERT
1220   // verify this JavaThread hasn&#39;t be published in the Threads::list yet
1221   void verify_not_published();
<span class="line-modified">1222 #endif</span>
1223 
1224   //JNI functiontable getter/setter for JVMTI jni function table interception API.
1225   void set_jni_functions(struct JNINativeInterface_* functionTable) {
1226     _jni_environment.functions = functionTable;
1227   }
1228   struct JNINativeInterface_* get_jni_functions() {
1229     return (struct JNINativeInterface_ *)_jni_environment.functions;
1230   }
1231 
1232   // This function is called at thread creation to allow
1233   // platform specific thread variables to be initialized.
1234   void cache_global_variables();
1235 
1236   // Executes Shutdown.shutdown()
1237   void invoke_shutdown_hooks();
1238 
1239   // Cleanup on thread exit
1240   enum ExitType {
1241     normal_exit,
1242     jni_detach
1243   };
1244   void exit(bool destroy_vm, ExitType exit_type = normal_exit);
1245 
<span class="line-modified">1246   void cleanup_failed_attach_current_thread();</span>
1247 
1248   // Testers
1249   virtual bool is_Java_thread() const            { return true;  }
1250   virtual bool can_call_java() const             { return true; }
1251 
<span class="line-modified">1252   // Thread chain operations</span>
<span class="line-modified">1253   JavaThread* next() const                       { return _next; }</span>
<span class="line-modified">1254   void set_next(JavaThread* p)                   { _next = p; }</span>
1255 
1256   // Thread oop. threadObj() can be NULL for initial JavaThread
1257   // (or for threads attached via JNI)
1258   oop threadObj() const                          { return _threadObj; }
1259   void set_threadObj(oop p)                      { _threadObj = p; }
1260 
<span class="line-removed">1261   ThreadPriority java_priority() const;          // Read from threadObj()</span>
<span class="line-removed">1262 </span>
1263   // Prepare thread and add to priority queue.  If a priority is
1264   // not specified, use the priority of the thread object. Threads_lock
1265   // must be held while this function is called.
1266   void prepare(jobject jni_thread, ThreadPriority prio=NoPriority);
1267 
1268   void set_saved_exception_pc(address pc)        { _saved_exception_pc = pc; }
1269   address saved_exception_pc()                   { return _saved_exception_pc; }
1270 
1271 
1272   ThreadFunction entry_point() const             { return _entry_point; }
1273 
1274   // Allocates a new Java level thread object for this thread. thread_name may be NULL.
1275   void allocate_threadObj(Handle thread_group, const char* thread_name, bool daemon, TRAPS);
1276 
1277   // Last frame anchor routines
1278 
1279   JavaFrameAnchor* frame_anchor(void)            { return &amp;_anchor; }
1280 
1281   // last_Java_sp
1282   bool has_last_Java_frame() const               { return _anchor.has_last_Java_frame(); }
1283   intptr_t* last_Java_sp() const                 { return _anchor.last_Java_sp(); }
1284 
1285   // last_Java_pc
1286 
1287   address last_Java_pc(void)                     { return _anchor.last_Java_pc(); }
1288 
1289   // Safepoint support
1290   inline JavaThreadState thread_state() const;
1291   inline void set_thread_state(JavaThreadState s);

1292   inline ThreadSafepointState* safepoint_state() const;
1293   inline void set_safepoint_state(ThreadSafepointState* state);
1294   inline bool is_at_poll_safepoint();
1295 
1296   // JavaThread termination and lifecycle support:
1297   void smr_delete();
1298   bool on_thread_list() const { return _on_thread_list; }
1299   void set_on_thread_list() { _on_thread_list = true; }
1300 
1301   // thread has called JavaThread::exit() or is terminated
1302   bool is_exiting() const;
1303   // thread is terminated (no longer on the threads list); we compare
1304   // against the two non-terminated values so that a freed JavaThread
1305   // will also be considered terminated.
1306   bool check_is_terminated(TerminatedTypes l_terminated) const {
1307     return l_terminated != _not_terminated &amp;&amp; l_terminated != _thread_exiting;
1308   }
1309   bool is_terminated() const;
1310   void set_terminated(TerminatedTypes t);
1311   // special for Threads::remove() which is static:
</pre>
<hr />
<pre>
1321   inline void set_polling_page_release(void* poll_value);
1322   inline void set_polling_page(void* poll_value);
1323   inline volatile void* get_polling_page();
1324 
1325  private:
1326   // Support for thread handshake operations
1327   HandshakeState _handshake;
1328  public:
1329   void set_handshake_operation(HandshakeOperation* op) {
1330     _handshake.set_operation(this, op);
1331   }
1332 
1333   bool has_handshake() const {
1334     return _handshake.has_operation();
1335   }
1336 
1337   void handshake_process_by_self() {
1338     _handshake.process_by_self(this);
1339   }
1340 
<span class="line-modified">1341   void handshake_process_by_vmthread() {</span>
<span class="line-modified">1342     _handshake.process_by_vmthread(this);</span>





1343   }

1344 
1345   // Suspend/resume support for JavaThread
1346  private:
1347   inline void set_ext_suspended();
1348   inline void clear_ext_suspended();
1349 
1350  public:
<span class="line-modified">1351   void java_suspend();</span>
<span class="line-modified">1352   void java_resume();</span>
<span class="line-modified">1353   int  java_suspend_self();</span>





1354 

1355   void check_and_wait_while_suspended() {
1356     assert(JavaThread::current() == this, &quot;sanity check&quot;);
1357 
1358     bool do_self_suspend;
1359     do {
1360       // were we externally suspended while we were waiting?
1361       do_self_suspend = handle_special_suspend_equivalent_condition();
1362       if (do_self_suspend) {
1363         // don&#39;t surprise the thread that suspended us by returning
1364         java_suspend_self();
1365         set_suspend_equivalent();
1366       }
1367     } while (do_self_suspend);
1368   }
1369   static void check_safepoint_and_suspend_for_native_trans(JavaThread *thread);
1370   // Check for async exception in addition to safepoint and suspend request.
1371   static void check_special_condition_for_native_trans(JavaThread *thread);
1372 
1373   // Same as check_special_condition_for_native_trans but finishes the
1374   // transition into thread_in_Java mode so that it can potentially
1375   // block.
1376   static void check_special_condition_for_native_trans_and_transition(JavaThread *thread);
1377 
1378   bool is_ext_suspend_completed(bool called_by_wait, int delay, uint32_t *bits);
1379   bool is_ext_suspend_completed_with_lock(uint32_t *bits) {
<span class="line-modified">1380     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1381     // Warning: is_ext_suspend_completed() may temporarily drop the
1382     // SR_lock to allow the thread to reach a stable thread state if
1383     // it is currently in a transient thread state.
1384     return is_ext_suspend_completed(false /* !called_by_wait */,
1385                                     SuspendRetryDelay, bits);
1386   }
1387 
1388   // We cannot allow wait_for_ext_suspend_completion() to run forever or
1389   // we could hang. SuspendRetryCount and SuspendRetryDelay are normally
1390   // passed as the count and delay parameters. Experiments with specific
1391   // calls to wait_for_ext_suspend_completion() can be done by passing
1392   // other values in the code. Experiments with all calls can be done
1393   // via the appropriate -XX options.
1394   bool wait_for_ext_suspend_completion(int count, int delay, uint32_t *bits);
1395 
1396   // test for suspend - most (all?) of these should go away
1397   bool is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits);
1398 
1399   inline void set_external_suspend();
1400   inline void clear_external_suspend();
1401 
<span class="line-removed">1402   inline void set_deopt_suspend();</span>
<span class="line-removed">1403   inline void clear_deopt_suspend();</span>
<span class="line-removed">1404   bool is_deopt_suspend()         { return (_suspend_flags &amp; _deopt_suspend) != 0; }</span>
<span class="line-removed">1405 </span>
1406   bool is_external_suspend() const {
1407     return (_suspend_flags &amp; _external_suspend) != 0;
1408   }
1409   // Whenever a thread transitions from native to vm/java it must suspend
1410   // if external|deopt suspend is present.
1411   bool is_suspend_after_native() const {
<span class="line-modified">1412     return (_suspend_flags &amp; (_external_suspend | _deopt_suspend)) != 0;</span>
1413   }
1414 
1415   // external suspend request is completed
1416   bool is_ext_suspended() const {
1417     return (_suspend_flags &amp; _ext_suspended) != 0;
1418   }
1419 
1420   bool is_external_suspend_with_lock() const {
<span class="line-modified">1421     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1422     return is_external_suspend();
1423   }
1424 
1425   // Special method to handle a pending external suspend request
1426   // when a suspend equivalent condition lifts.
1427   bool handle_special_suspend_equivalent_condition() {
1428     assert(is_suspend_equivalent(),
1429            &quot;should only be called in a suspend equivalence condition&quot;);
<span class="line-modified">1430     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1431     bool ret = is_external_suspend();
1432     if (!ret) {
1433       // not about to self-suspend so clear suspend equivalence
1434       clear_suspend_equivalent();
1435     }
1436     // implied else:
1437     // We have a pending external suspend request so we leave the
1438     // suspend_equivalent flag set until java_suspend_self() sets
1439     // the ext_suspended flag and clears the suspend_equivalent
1440     // flag. This insures that wait_for_ext_suspend_completion()
1441     // will return consistent values.
1442     return ret;
1443   }
1444 
1445   // utility methods to see if we are doing some kind of suspension
1446   bool is_being_ext_suspended() const            {
<span class="line-modified">1447     MutexLockerEx ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1448     return is_ext_suspended() || is_external_suspend();
1449   }
1450 
1451   bool is_suspend_equivalent() const             { return _suspend_equivalent; }
1452 
1453   void set_suspend_equivalent()                  { _suspend_equivalent = true; }
1454   void clear_suspend_equivalent()                { _suspend_equivalent = false; }
1455 
1456   // Thread.stop support
1457   void send_thread_stop(oop throwable);
1458   AsyncRequests clear_special_runtime_exit_condition() {
1459     AsyncRequests x = _special_runtime_exit_condition;
1460     _special_runtime_exit_condition = _no_async_condition;
1461     return x;
1462   }
1463 
1464   // Are any async conditions present?
1465   bool has_async_condition() { return (_special_runtime_exit_condition != _no_async_condition); }
1466 
1467   void check_and_handle_async_exceptions(bool check_unsafe_error = true);
</pre>
<hr />
<pre>
1495   // Accessors for vframe array top
1496   // The linked list of vframe arrays are sorted on sp. This means when we
1497   // unpack the head must contain the vframe array to unpack.
1498   void set_vframe_array_head(vframeArray* value) { _vframe_array_head = value; }
1499   vframeArray* vframe_array_head() const         { return _vframe_array_head;  }
1500 
1501   // Side structure for deferring update of java frame locals until deopt occurs
1502   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred_locals() const { return _deferred_locals_updates; }
1503   void set_deferred_locals(GrowableArray&lt;jvmtiDeferredLocalVariableSet *&gt;* vf) { _deferred_locals_updates = vf; }
1504 
1505   // These only really exist to make debugging deopt problems simpler
1506 
1507   void set_vframe_array_last(vframeArray* value) { _vframe_array_last = value; }
1508   vframeArray* vframe_array_last() const         { return _vframe_array_last;  }
1509 
1510   // The special resourceMark used during deoptimization
1511 
1512   void set_deopt_mark(DeoptResourceMark* value)  { _deopt_mark = value; }
1513   DeoptResourceMark* deopt_mark(void)            { return _deopt_mark; }
1514 
<span class="line-removed">1515   intptr_t* must_deopt_id()                      { return _must_deopt_id; }</span>
<span class="line-removed">1516   void     set_must_deopt_id(intptr_t* id)       { _must_deopt_id = id; }</span>
<span class="line-removed">1517   void     clear_must_deopt_id()                 { _must_deopt_id = NULL; }</span>
<span class="line-removed">1518 </span>
1519   void set_deopt_compiled_method(CompiledMethod* nm)  { _deopt_nmethod = nm; }
1520   CompiledMethod* deopt_compiled_method()        { return _deopt_nmethod; }
1521 
1522   Method*    callee_target() const               { return _callee_target; }
1523   void set_callee_target  (Method* x)          { _callee_target   = x; }
1524 
1525   // Oop results of vm runtime calls
1526   oop  vm_result() const                         { return _vm_result; }
1527   void set_vm_result  (oop x)                    { _vm_result   = x; }
1528 
1529   Metadata*    vm_result_2() const               { return _vm_result_2; }
1530   void set_vm_result_2  (Metadata* x)          { _vm_result_2   = x; }
1531 
1532   MemRegion deferred_card_mark() const           { return _deferred_card_mark; }
1533   void set_deferred_card_mark(MemRegion mr)      { _deferred_card_mark = mr;   }
1534 
1535 #if INCLUDE_JVMCI
1536   int  pending_deoptimization() const             { return _pending_deoptimization; }
<span class="line-modified">1537   long pending_failed_speculation() const         { return _pending_failed_speculation; }</span>
<span class="line-removed">1538   bool adjusting_comp_level() const               { return _adjusting_comp_level; }</span>
<span class="line-removed">1539   void set_adjusting_comp_level(bool b)           { _adjusting_comp_level = b; }</span>
1540   bool has_pending_monitorenter() const           { return _pending_monitorenter; }
1541   void set_pending_monitorenter(bool b)           { _pending_monitorenter = b; }
1542   void set_pending_deoptimization(int reason)     { _pending_deoptimization = reason; }
<span class="line-modified">1543   void set_pending_failed_speculation(long failed_speculation) { _pending_failed_speculation = failed_speculation; }</span>
1544   void set_pending_transfer_to_interpreter(bool b) { _pending_transfer_to_interpreter = b; }
1545   void set_jvmci_alternate_call_target(address a) { assert(_jvmci._alternate_call_target == NULL, &quot;must be&quot;); _jvmci._alternate_call_target = a; }
1546   void set_jvmci_implicit_exception_pc(address a) { assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;); _jvmci._implicit_exception_pc = a; }
1547 
1548   virtual bool in_retryable_allocation() const    { return _in_retryable_allocation; }
1549   void set_in_retryable_allocation(bool b)        { _in_retryable_allocation = b; }
1550 #endif // INCLUDE_JVMCI
1551 
1552   // Exception handling for compiled methods
1553   oop      exception_oop() const                 { return _exception_oop; }
1554   address  exception_pc() const                  { return _exception_pc; }
1555   address  exception_handler_pc() const          { return _exception_handler_pc; }
1556   bool     is_method_handle_return() const       { return _is_method_handle_return == 1; }
1557 
1558   void set_exception_oop(oop o)                  { (void)const_cast&lt;oop&amp;&gt;(_exception_oop = o); }
1559   void set_exception_pc(address a)               { _exception_pc = a; }
1560   void set_exception_handler_pc(address a)       { _exception_handler_pc = a; }
1561   void set_is_method_handle_return(bool value)   { _is_method_handle_return = value ? 1 : 0; }
1562 
1563   void clear_exception_oop_and_pc() {
</pre>
<hr />
<pre>
1723     _reserved_stack_activation = addr;
1724   }
1725 
1726   // Attempt to reguard the stack after a stack overflow may have occurred.
1727   // Returns true if (a) guard pages are not needed on this thread, (b) the
1728   // pages are already guarded, or (c) the pages were successfully reguarded.
1729   // Returns false if there is not enough stack space to reguard the pages, in
1730   // which case the caller should unwind a frame and try again.  The argument
1731   // should be the caller&#39;s (approximate) sp.
1732   bool reguard_stack(address cur_sp);
1733   // Similar to above but see if current stackpoint is out of the guard area
1734   // and reguard if possible.
1735   bool reguard_stack(void);
1736 
1737   address stack_overflow_limit() { return _stack_overflow_limit; }
1738   void set_stack_overflow_limit() {
1739     _stack_overflow_limit =
1740       stack_end() + MAX2(JavaThread::stack_guard_zone_size(), JavaThread::stack_shadow_zone_size());
1741   }
1742 





1743   // Misc. accessors/mutators
1744   void set_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = true; }
1745   void clr_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = false; }
1746   bool do_not_unlock(void)                       { return _do_not_unlock_if_synchronized; }
1747 
<span class="line-removed">1748 #ifndef PRODUCT</span>
<span class="line-removed">1749   void record_jump(address target, address instr, const char* file, int line);</span>
<span class="line-removed">1750 #endif // PRODUCT</span>
<span class="line-removed">1751 </span>
1752   // For assembly stub generation
1753   static ByteSize threadObj_offset()             { return byte_offset_of(JavaThread, _threadObj); }
<span class="line-removed">1754 #ifndef PRODUCT</span>
<span class="line-removed">1755   static ByteSize jmp_ring_index_offset()        { return byte_offset_of(JavaThread, _jmp_ring_index); }</span>
<span class="line-removed">1756   static ByteSize jmp_ring_offset()              { return byte_offset_of(JavaThread, _jmp_ring); }</span>
<span class="line-removed">1757 #endif // PRODUCT</span>
1758   static ByteSize jni_environment_offset()       { return byte_offset_of(JavaThread, _jni_environment); }
1759   static ByteSize pending_jni_exception_check_fn_offset() {
1760     return byte_offset_of(JavaThread, _pending_jni_exception_check_fn);
1761   }
1762   static ByteSize last_Java_sp_offset() {
1763     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_sp_offset();
1764   }
1765   static ByteSize last_Java_pc_offset() {
1766     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_pc_offset();
1767   }
1768   static ByteSize frame_anchor_offset() {
1769     return byte_offset_of(JavaThread, _anchor);
1770   }
1771   static ByteSize callee_target_offset()         { return byte_offset_of(JavaThread, _callee_target); }
1772   static ByteSize vm_result_offset()             { return byte_offset_of(JavaThread, _vm_result); }
1773   static ByteSize vm_result_2_offset()           { return byte_offset_of(JavaThread, _vm_result_2); }
1774   static ByteSize thread_state_offset()          { return byte_offset_of(JavaThread, _thread_state); }
1775   static ByteSize saved_exception_pc_offset()    { return byte_offset_of(JavaThread, _saved_exception_pc); }
1776   static ByteSize osthread_offset()              { return byte_offset_of(JavaThread, _osthread); }
1777 #if INCLUDE_JVMCI
1778   static ByteSize pending_deoptimization_offset() { return byte_offset_of(JavaThread, _pending_deoptimization); }
1779   static ByteSize pending_monitorenter_offset()  { return byte_offset_of(JavaThread, _pending_monitorenter); }
1780   static ByteSize pending_failed_speculation_offset() { return byte_offset_of(JavaThread, _pending_failed_speculation); }
1781   static ByteSize jvmci_alternate_call_target_offset() { return byte_offset_of(JavaThread, _jvmci._alternate_call_target); }
1782   static ByteSize jvmci_implicit_exception_pc_offset() { return byte_offset_of(JavaThread, _jvmci._implicit_exception_pc); }
1783   static ByteSize jvmci_counters_offset()        { return byte_offset_of(JavaThread, _jvmci_counters); }
1784 #endif // INCLUDE_JVMCI
1785   static ByteSize exception_oop_offset()         { return byte_offset_of(JavaThread, _exception_oop); }
1786   static ByteSize exception_pc_offset()          { return byte_offset_of(JavaThread, _exception_pc); }
1787   static ByteSize exception_handler_pc_offset()  { return byte_offset_of(JavaThread, _exception_handler_pc); }
1788   static ByteSize stack_overflow_limit_offset()  { return byte_offset_of(JavaThread, _stack_overflow_limit); }
1789   static ByteSize is_method_handle_return_offset() { return byte_offset_of(JavaThread, _is_method_handle_return); }
1790   static ByteSize stack_guard_state_offset()     { return byte_offset_of(JavaThread, _stack_guard_state); }
1791   static ByteSize reserved_stack_activation_offset() { return byte_offset_of(JavaThread, _reserved_stack_activation); }
1792   static ByteSize suspend_flags_offset()         { return byte_offset_of(JavaThread, _suspend_flags); }
1793 
1794   static ByteSize do_not_unlock_if_synchronized_offset() { return byte_offset_of(JavaThread, _do_not_unlock_if_synchronized); }
1795   static ByteSize should_post_on_exceptions_flag_offset() {
1796     return byte_offset_of(JavaThread, _should_post_on_exceptions_flag);
1797   }

1798 
1799   // Returns the jni environment for this thread
1800   JNIEnv* jni_environment()                      { return &amp;_jni_environment; }
1801 
1802   static JavaThread* thread_from_jni_environment(JNIEnv* env) {
1803     JavaThread *thread_from_jni_env = (JavaThread*)((intptr_t)env - in_bytes(jni_environment_offset()));
1804     // Only return NULL if thread is off the thread list; starting to
1805     // exit should not return NULL.
1806     if (thread_from_jni_env-&gt;is_terminated()) {
1807       thread_from_jni_env-&gt;block_if_vm_exited();
1808       return NULL;
1809     } else {
1810       return thread_from_jni_env;
1811     }
1812   }
1813 
1814   // JNI critical regions. These can nest.
1815   bool in_critical()    { return _jni_active_critical &gt; 0; }
1816   bool in_last_critical()  { return _jni_active_critical == 1; }
1817   inline void enter_critical();
</pre>
<hr />
<pre>
1849     if (_in_deopt_handler &gt; 0) { // robustness
1850       _in_deopt_handler--;
1851     }
1852   }
1853 
1854  private:
1855   void set_entry_point(ThreadFunction entry_point) { _entry_point = entry_point; }
1856 
1857  public:
1858 
1859   // Frame iteration; calls the function f for all frames on the stack
1860   void frames_do(void f(frame*, const RegisterMap*));
1861 
1862   // Memory operations
1863   void oops_do(OopClosure* f, CodeBlobClosure* cf);
1864 
1865   // Sweeper operations
1866   virtual void nmethods_do(CodeBlobClosure* cf);
1867 
1868   // RedefineClasses Support
<span class="line-modified">1869   void metadata_do(void f(Metadata*));</span>



1870 
1871   // Misc. operations
1872   char* name() const { return (char*)get_thread_name(); }
1873   void print_on(outputStream* st, bool print_extended_info) const;
1874   void print_on(outputStream* st) const { print_on(st, false); }
<span class="line-modified">1875   void print_value();</span>
1876   void print_thread_state_on(outputStream*) const      PRODUCT_RETURN;
<span class="line-removed">1877   void print_thread_state() const                      PRODUCT_RETURN;</span>
1878   void print_on_error(outputStream* st, char* buf, int buflen) const;
1879   void print_name_on_error(outputStream* st, char* buf, int buflen) const;
1880   void verify();
1881   const char* get_thread_name() const;
1882  protected:
1883   // factor out low-level mechanics for use in both normal and error cases
1884   virtual const char* get_thread_name_string(char* buf = NULL, int buflen = 0) const;
1885  public:
<span class="line-removed">1886   const char* get_threadgroup_name() const;</span>
<span class="line-removed">1887   const char* get_parent_name() const;</span>
<span class="line-removed">1888 </span>
1889   // Accessing frames
1890   frame last_frame() {
1891     _anchor.make_walkable(this);
1892     return pd_last_frame();
1893   }
1894   javaVFrame* last_java_vframe(RegisterMap* reg_map);
1895 
1896   // Returns method at &#39;depth&#39; java or native frames down the stack
1897   // Used for security checks
1898   Klass* security_get_caller_class(int depth);
1899 
1900   // Print stack trace in external format
1901   void print_stack_on(outputStream* st);
1902   void print_stack() { print_stack_on(tty); }
1903 
1904   // Print stack traces in various internal formats
1905   void trace_stack()                             PRODUCT_RETURN;
1906   void trace_stack_from(vframe* start_vf)        PRODUCT_RETURN;
1907   void trace_frames()                            PRODUCT_RETURN;
<span class="line-removed">1908   void trace_oops()                              PRODUCT_RETURN;</span>
1909 
1910   // Print an annotated view of the stack frames
1911   void print_frame_layout(int depth = 0, bool validate_only = false) NOT_DEBUG_RETURN;
1912   void validate_frame_layout() {
1913     print_frame_layout(0, true);
1914   }
1915 
<span class="line-removed">1916   // Returns the number of stack frames on the stack</span>
<span class="line-removed">1917   int depth() const;</span>
<span class="line-removed">1918 </span>
1919   // Function for testing deoptimization
1920   void deoptimize();
1921   void make_zombies();
1922 
<span class="line-modified">1923   void deoptimized_wrt_marked_nmethods();</span>
1924 
1925  public:
1926   // Returns the running thread as a JavaThread
1927   static inline JavaThread* current();
1928 
1929   // Returns the active Java thread.  Do not use this if you know you are calling
1930   // from a JavaThread, as it&#39;s slower than JavaThread::current.  If called from
1931   // the VMThread, it also returns the JavaThread that instigated the VMThread&#39;s
1932   // operation.  You may not want that either.
1933   static JavaThread* active();
1934 
1935   inline CompilerThread* as_CompilerThread();
1936 
1937  protected:
1938   virtual void pre_run();
1939   virtual void run();
1940   void thread_main_inner();
1941   virtual void post_run();
1942 
1943 
</pre>
<hr />
<pre>
2042  public:
2043   ThreadStatistics* get_thread_stat() const    { return _thread_stat; }
2044 
2045   // Return a blocker object for which this thread is blocked parking.
2046   oop current_park_blocker();
2047 
2048  private:
2049   static size_t _stack_size_at_create;
2050 
2051  public:
2052   static inline size_t stack_size_at_create(void) {
2053     return _stack_size_at_create;
2054   }
2055   static inline void set_stack_size_at_create(size_t value) {
2056     _stack_size_at_create = value;
2057   }
2058 
2059   // Machine dependent stuff
2060 #include OS_CPU_HEADER(thread)
2061 
<span class="line-removed">2062  public:</span>
<span class="line-removed">2063   void set_blocked_on_compilation(bool value) {</span>
<span class="line-removed">2064     _blocked_on_compilation = value;</span>
<span class="line-removed">2065   }</span>
<span class="line-removed">2066 </span>
<span class="line-removed">2067   bool blocked_on_compilation() {</span>
<span class="line-removed">2068     return _blocked_on_compilation;</span>
<span class="line-removed">2069   }</span>
<span class="line-removed">2070  protected:</span>
<span class="line-removed">2071   bool         _blocked_on_compilation;</span>
<span class="line-removed">2072 </span>
<span class="line-removed">2073 </span>
2074   // JSR166 per-thread parker
2075  private:
2076   Parker*    _parker;
2077  public:
2078   Parker*     parker() { return _parker; }
2079 
2080   // Biased locking support
2081  private:
2082   GrowableArray&lt;MonitorInfo*&gt;* _cached_monitor_info;
2083  public:
2084   GrowableArray&lt;MonitorInfo*&gt;* cached_monitor_info() { return _cached_monitor_info; }
2085   void set_cached_monitor_info(GrowableArray&lt;MonitorInfo*&gt;* info) { _cached_monitor_info = info; }
2086 
2087   // clearing/querying jni attach status
2088   bool is_attaching_via_jni() const { return _jni_attach_state == _attaching_via_jni; }
2089   bool has_attached_via_jni() const { return is_attaching_via_jni() || _jni_attach_state == _attached_via_jni; }
2090   inline void set_done_attaching_via_jni();
2091 
2092   // Stack dump assistance:
2093   // Track the class we want to initialize but for which we have to wait
2094   // on its init_lock() because it is already being initialized.
2095   void set_class_to_be_initialized(InstanceKlass* k);
2096   InstanceKlass* class_to_be_initialized() const;
2097 
2098 private:
2099   InstanceKlass* _class_to_be_initialized;
2100 









2101 };
2102 
2103 // Inline implementation of JavaThread::current
2104 inline JavaThread* JavaThread::current() {
2105   Thread* thread = Thread::current();
2106   assert(thread-&gt;is_Java_thread(), &quot;just checking&quot;);
2107   return (JavaThread*)thread;
2108 }
2109 
2110 inline CompilerThread* JavaThread::as_CompilerThread() {
2111   assert(is_Compiler_thread(), &quot;just checking&quot;);
2112   return (CompilerThread*)this;
2113 }
2114 
2115 // Dedicated thread to sweep the code cache
2116 class CodeCacheSweeperThread : public JavaThread {
2117   CompiledMethod*       _scanned_compiled_method; // nmethod being scanned by the sweeper
2118  public:
2119   CodeCacheSweeperThread();
2120   // Track the nmethod currently being scanned by the sweeper
</pre>
<hr />
<pre>
2193   IdealGraphPrinter *_ideal_graph_printer;
2194  public:
2195   IdealGraphPrinter *ideal_graph_printer()           { return _ideal_graph_printer; }
2196   void set_ideal_graph_printer(IdealGraphPrinter *n) { _ideal_graph_printer = n; }
2197 #endif
2198 
2199   // Get/set the thread&#39;s current task
2200   CompileTask* task()                      { return _task; }
2201   void         set_task(CompileTask* task) { _task = task; }
2202 };
2203 
2204 inline CompilerThread* CompilerThread::current() {
2205   return JavaThread::current()-&gt;as_CompilerThread();
2206 }
2207 
2208 // The active thread queue. It also keeps track of the current used
2209 // thread priorities.
2210 class Threads: AllStatic {
2211   friend class VMStructs;
2212  private:
<span class="line-removed">2213   static JavaThread* _thread_list;</span>
2214   static int         _number_of_threads;
2215   static int         _number_of_non_daemon_threads;
2216   static int         _return_code;
<span class="line-modified">2217   static int         _thread_claim_parity;</span>
2218 #ifdef ASSERT
2219   static bool        _vm_complete;
2220 #endif
2221 
2222   static void initialize_java_lang_classes(JavaThread* main_thread, TRAPS);
2223   static void initialize_jsr292_core_classes(TRAPS);
2224 
2225  public:
2226   // Thread management
2227   // force_daemon is a concession to JNI, where we may need to add a
2228   // thread to the thread list before allocating its thread object
2229   static void add(JavaThread* p, bool force_daemon = false);
<span class="line-modified">2230   static void remove(JavaThread* p);</span>
2231   static void non_java_threads_do(ThreadClosure* tc);
2232   static void java_threads_do(ThreadClosure* tc);
2233   static void java_threads_and_vm_thread_do(ThreadClosure* tc);
2234   static void threads_do(ThreadClosure* tc);
2235   static void possibly_parallel_threads_do(bool is_par, ThreadClosure* tc);
2236 
2237   // Initializes the vm and creates the vm thread
2238   static jint create_vm(JavaVMInitArgs* args, bool* canTryAgain);
2239   static void convert_vm_init_libraries_to_agents();
2240   static void create_vm_init_libraries();
2241   static void create_vm_init_agents();
2242   static void shutdown_vm_agents();
2243   static bool destroy_vm();
2244   // Supported VM versions via JNI
2245   // Includes JNI_VERSION_1_1
2246   static jboolean is_supported_jni_version_including_1_1(jint version);
2247   // Does not include JNI_VERSION_1_1
2248   static jboolean is_supported_jni_version(jint version);
2249 
<span class="line-modified">2250   // The &quot;thread claim parity&quot; provides a way for threads to be claimed</span>
2251   // by parallel worker tasks.
2252   //
<span class="line-modified">2253   // Each thread contains a &quot;parity&quot; field. A task will claim the</span>
<span class="line-modified">2254   // thread only if its parity field is the same as the global parity,</span>
<span class="line-modified">2255   // which is updated by calling change_thread_claim_parity().</span>


2256   //
<span class="line-modified">2257   // For this to work change_thread_claim_parity() needs to be called</span>
2258   // exactly once in sequential code before starting parallel tasks
2259   // that should claim threads.
2260   //
<span class="line-modified">2261   // New threads get their parity set to 0 and change_thread_claim_parity()</span>
<span class="line-modified">2262   // never sets the global parity to 0.</span>
<span class="line-modified">2263   static int thread_claim_parity() { return _thread_claim_parity; }</span>
<span class="line-modified">2264   static void change_thread_claim_parity();</span>
2265   static void assert_all_threads_claimed() NOT_DEBUG_RETURN;
2266 
2267   // Apply &quot;f-&gt;do_oop&quot; to all root oops in all threads.
2268   // This version may only be called by sequential code.
2269   static void oops_do(OopClosure* f, CodeBlobClosure* cf);
2270   // This version may be called by sequential or parallel code.
2271   static void possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf);
2272 
<span class="line-removed">2273   // Apply &quot;f-&gt;do_oop&quot; to roots in all threads that</span>
<span class="line-removed">2274   // are part of compiled frames</span>
<span class="line-removed">2275   static void compiled_frame_oops_do(OopClosure* f, CodeBlobClosure* cf);</span>
<span class="line-removed">2276 </span>
<span class="line-removed">2277   static void convert_hcode_pointers();</span>
<span class="line-removed">2278   static void restore_hcode_pointers();</span>
<span class="line-removed">2279 </span>
2280   // Sweeper
2281   static void nmethods_do(CodeBlobClosure* cf);
2282 
2283   // RedefineClasses support
<span class="line-modified">2284   static void metadata_do(void f(Metadata*));</span>
2285   static void metadata_handles_do(void f(Metadata*));
2286 
2287 #ifdef ASSERT
2288   static bool is_vm_complete() { return _vm_complete; }
2289 #endif // ASSERT
2290 
2291   // Verification
2292   static void verify();
2293   static void print_on(outputStream* st, bool print_stacks, bool internal_format, bool print_concurrent_locks, bool print_extended_info);
2294   static void print(bool print_stacks, bool internal_format) {
2295     // this function is only used by debug.cpp
2296     print_on(tty, print_stacks, internal_format, false /* no concurrent lock printed */, false /* simple format */);
2297   }
2298   static void print_on_error(outputStream* st, Thread* current, char* buf, int buflen);
2299   static void print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
2300                              int buflen, bool* found_current);
2301   static void print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form = false);
2302 
2303   // Get Java threads that are waiting to enter a monitor.
2304   static GrowableArray&lt;JavaThread*&gt;* get_pending_threads(ThreadsList * t_list,
2305                                                          int count, address monitor);
2306 
2307   // Get owning Java thread from the monitor&#39;s owner field.
2308   static JavaThread *owning_thread_from_monitor_owner(ThreadsList * t_list,
2309                                                       address owner);
2310 
2311   // Number of threads on the active threads list
2312   static int number_of_threads()                 { return _number_of_threads; }
2313   // Number of non-daemon threads on the active threads list
2314   static int number_of_non_daemon_threads()      { return _number_of_non_daemon_threads; }
2315 
2316   // Deoptimizes all frames tied to marked nmethods
2317   static void deoptimized_wrt_marked_nmethods();
<span class="line-removed">2318 };</span>
<span class="line-removed">2319 </span>
2320 
<span class="line-modified">2321 // Thread iterator</span>
<span class="line-removed">2322 class ThreadClosure: public StackObj {</span>
<span class="line-removed">2323  public:</span>
<span class="line-removed">2324   virtual void do_thread(Thread* thread) = 0;</span>
2325 };
2326 
2327 class SignalHandlerMark: public StackObj {
2328  private:
2329   Thread* _thread;
2330  public:
2331   SignalHandlerMark(Thread* t) {
2332     _thread = t;
2333     if (_thread) _thread-&gt;enter_signal_handler();
2334   }
2335   ~SignalHandlerMark() {
2336     if (_thread) _thread-&gt;leave_signal_handler();
2337     _thread = NULL;
2338   }
2339 };
2340 
2341 
2342 #endif // SHARE_RUNTIME_THREAD_HPP
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
</pre>
<hr />
<pre>
  31 #include &quot;gc/shared/threadLocalAllocBuffer.hpp&quot;
  32 #include &quot;memory/allocation.hpp&quot;
  33 #include &quot;oops/oop.hpp&quot;
  34 #include &quot;prims/jvmtiExport.hpp&quot;
  35 #include &quot;runtime/frame.hpp&quot;
  36 #include &quot;runtime/globals.hpp&quot;
  37 #include &quot;runtime/handshake.hpp&quot;
  38 #include &quot;runtime/javaFrameAnchor.hpp&quot;
  39 #include &quot;runtime/jniHandles.hpp&quot;
  40 #include &quot;runtime/mutexLocker.hpp&quot;
  41 #include &quot;runtime/os.hpp&quot;
  42 #include &quot;runtime/osThread.hpp&quot;
  43 #include &quot;runtime/park.hpp&quot;
  44 #include &quot;runtime/stubRoutines.hpp&quot;
  45 #include &quot;runtime/threadHeapSampler.hpp&quot;
  46 #include &quot;runtime/threadLocalStorage.hpp&quot;
  47 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
  48 #include &quot;runtime/unhandledOops.hpp&quot;
  49 #include &quot;utilities/align.hpp&quot;
  50 #include &quot;utilities/exceptions.hpp&quot;
<span class="line-added">  51 #include &quot;utilities/globalDefinitions.hpp&quot;</span>
  52 #include &quot;utilities/macros.hpp&quot;
  53 #ifdef ZERO
  54 # include &quot;stack_zero.hpp&quot;
  55 #endif
  56 #if INCLUDE_JFR
  57 #include &quot;jfr/support/jfrThreadExtension.hpp&quot;
  58 #endif
  59 
  60 
  61 class SafeThreadsListPtr;
  62 class ThreadSafepointState;
  63 class ThreadsList;
  64 class ThreadsSMRSupport;
  65 
<span class="line-added">  66 class JvmtiRawMonitor;</span>
  67 class JvmtiThreadState;
  68 class ThreadStatistics;
  69 class ConcurrentLocksDump;
  70 class ParkEvent;
  71 class Parker;
  72 class MonitorInfo;
  73 
  74 class ciEnv;
  75 class CompileThread;
  76 class CompileLog;
  77 class CompileTask;
  78 class CompileQueue;
  79 class CompilerCounters;
  80 
  81 class vframeArray;
  82 class vframe;
  83 class javaVFrame;
  84 
  85 class DeoptResourceMark;
  86 class jvmtiDeferredLocalVariableSet;
  87 

  88 class ThreadClosure;
  89 class ICRefillVerifier;
  90 class IdealGraphPrinter;
  91 
<span class="line-added">  92 class JVMCIEnv;</span>
<span class="line-added">  93 class JVMCIPrimitiveArray;</span>
<span class="line-added">  94 </span>
  95 class Metadata;
  96 class ResourceArea;
  97 
  98 DEBUG_ONLY(class ResourceMark;)
  99 
 100 class WorkerThread;
 101 
 102 // Class hierarchy
 103 // - Thread
 104 //   - JavaThread
 105 //     - various subclasses eg CompilerThread, ServiceThread
 106 //   - NonJavaThread
 107 //     - NamedThread
 108 //       - VMThread
 109 //       - ConcurrentGCThread
 110 //       - WorkerThread
 111 //         - GangWorker

 112 //     - WatcherThread
 113 //     - JfrThreadSampler
 114 //
 115 // All Thread subclasses must be either JavaThread or NonJavaThread.
 116 // This means !t-&gt;is_Java_thread() iff t is a NonJavaThread, or t is
 117 // a partially constructed/destroyed Thread.
 118 
 119 // Thread execution sequence and actions:
 120 // All threads:
 121 //  - thread_native_entry  // per-OS native entry point
 122 //    - stack initialization
 123 //    - other OS-level initialization (signal masks etc)
 124 //    - handshake with creating thread (if not started suspended)
 125 //    - this-&gt;call_run()  // common shared entry point
 126 //      - shared common initialization
 127 //      - this-&gt;pre_run()  // virtual per-thread-type initialization
 128 //      - this-&gt;run()      // virtual per-thread-type &quot;main&quot; logic
 129 //      - shared common tear-down
 130 //      - this-&gt;post_run()  // virtual per-thread-type tear-down
 131 //      - // &#39;this&#39; no longer referenceable
 132 //    - OS-level tear-down (minimal)
 133 //    - final logging
 134 //
 135 // For JavaThread:
 136 //   - this-&gt;run()  // virtual but not normally overridden
 137 //     - this-&gt;thread_main_inner()  // extra call level to ensure correct stack calculations
 138 //       - this-&gt;entry_point()  // set differently for each kind of JavaThread
 139 
 140 class Thread: public ThreadShadow {
 141   friend class VMStructs;
 142   friend class JVMCIVMStructs;
 143  private:
 144 
 145 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 146   // Current thread is maintained as a thread-local variable
<span class="line-modified"> 147   static THREAD_LOCAL Thread* _thr_current;</span>
 148 #endif
 149 
 150   // Thread local data area available to the GC. The internal
 151   // structure and contents of this data area is GC-specific.
 152   // Only GC and GC barrier code should access this data area.
 153   GCThreadLocalData _gc_data;
 154 
 155  public:
 156   static ByteSize gc_data_offset() {
 157     return byte_offset_of(Thread, _gc_data);
 158   }
 159 
 160   template &lt;typename T&gt; T* gc_data() {
 161     STATIC_ASSERT(sizeof(T) &lt;= sizeof(_gc_data));
 162     return reinterpret_cast&lt;T*&gt;(&amp;_gc_data);
 163   }
 164 
 165   // Exception handling
 166   // (Note: _pending_exception and friends are in ThreadShadow)
 167   //oop       _pending_exception;                // pending exception for current thread
</pre>
<hr />
<pre>
 272   // Notes:
 273   // 1. The suspend/resume logic no longer uses ThreadState in OSThread
 274   // but we still update its value to keep other part of the system (mainly
 275   // JVMTI) happy. ThreadState is legacy code (see notes in
 276   // osThread.hpp).
 277   //
 278   // 2. It would be more natural if set_external_suspend() is private and
 279   // part of java_suspend(), but that probably would affect the suspend/query
 280   // performance. Need more investigation on this.
 281 
 282   // suspend/resume lock: used for self-suspend
 283   Monitor* _SR_lock;
 284 
 285  protected:
 286   enum SuspendFlags {
 287     // NOTE: avoid using the sign-bit as cc generates different test code
 288     //       when the sign-bit is used, and sometimes incorrectly - see CR 6398077
 289 
 290     _external_suspend       = 0x20000000U, // thread is asked to self suspend
 291     _ext_suspended          = 0x40000000U, // thread has self-suspended

 292 
 293     _has_async_exception    = 0x00000001U, // there is a pending async exception
 294     _critical_native_unlock = 0x00000002U, // Must call back to unlock JNI critical lock
 295 
 296     _trace_flag             = 0x00000004U  // call tracing backend
 297   };
 298 
 299   // various suspension related flags - atomically updated
 300   // overloaded for async exception checking in check_special_condition_for_native_trans.
 301   volatile uint32_t _suspend_flags;
 302 
 303  private:
 304   int _num_nested_signal;
 305 
 306   DEBUG_ONLY(bool _suspendible_thread;)
 307 
 308  public:
 309   void enter_signal_handler() { _num_nested_signal++; }
 310   void leave_signal_handler() { _num_nested_signal--; }
 311   bool is_inside_signal_handler() const { return _num_nested_signal &gt; 0; }
</pre>
<hr />
<pre>
 323     _suspendible_thread = true;
 324   }
 325 
 326   void clear_suspendible_thread() {
 327     _suspendible_thread = false;
 328   }
 329 
 330   bool is_suspendible_thread() { return _suspendible_thread; }
 331 #endif
 332 
 333  private:
 334   // Active_handles points to a block of handles
 335   JNIHandleBlock* _active_handles;
 336 
 337   // One-element thread local free list
 338   JNIHandleBlock* _free_handle_block;
 339 
 340   // Point to the last handle mark
 341   HandleMark* _last_handle_mark;
 342 
<span class="line-modified"> 343   // Claim value for parallel iteration over threads.</span>
<span class="line-modified"> 344   uintx _threads_do_token;</span>

 345 
 346   // Support for GlobalCounter
 347  private:
 348   volatile uintx _rcu_counter;
 349  public:
 350   volatile uintx* get_rcu_counter() {
 351     return &amp;_rcu_counter;
 352   }
 353 
 354  public:
 355   void set_last_handle_mark(HandleMark* mark)   { _last_handle_mark = mark; }
 356   HandleMark* last_handle_mark() const          { return _last_handle_mark; }
 357  private:
 358 
 359 #ifdef ASSERT
 360   ICRefillVerifier* _missed_ic_stub_refill_verifier;
 361 
 362  public:
 363   ICRefillVerifier* missed_ic_stub_refill_verifier() {
 364     return _missed_ic_stub_refill_verifier;
 365   }
 366 
 367   void set_missed_ic_stub_refill_verifier(ICRefillVerifier* verifier) {
 368     _missed_ic_stub_refill_verifier = verifier;
 369   }
<span class="line-modified"> 370 #endif // ASSERT</span>
 371 
 372  private:
 373 
<span class="line-modified"> 374   // Debug support for checking if code allows safepoints or not.</span>
<span class="line-modified"> 375   // Safepoints in the VM can happen because of allocation, invoking a VM operation, or blocking on</span>
 376   // mutex, or blocking on an object synchronizer (Java locking).
<span class="line-modified"> 377   // If _no_safepoint_count is non-zero, then an assertion failure will happen in any of</span>
<span class="line-modified"> 378   // the above cases.</span>

 379   //
<span class="line-modified"> 380   // The class NoSafepointVerifier is used to set this counter.</span>
 381   //
<span class="line-modified"> 382   NOT_PRODUCT(int _no_safepoint_count;)         // If 0, thread allow a safepoint to happen</span>

 383 
<span class="line-added"> 384  private:</span>
 385   // Used by SkipGCALot class.
 386   NOT_PRODUCT(bool _skip_gcalot;)               // Should we elide gc-a-lot?
 387 
<span class="line-modified"> 388   friend class GCLocker;</span>
 389   friend class NoSafepointVerifier;
 390   friend class PauseNoSafepointVerifier;

 391 
 392   volatile void* _polling_page;                 // Thread local polling page
 393 
 394   ThreadLocalAllocBuffer _tlab;                 // Thread-local eden
 395   jlong _allocated_bytes;                       // Cumulative number of bytes allocated on
 396                                                 // the Java heap
 397   ThreadHeapSampler _heap_sampler;              // For use when sampling the memory.
 398 
 399   ThreadStatisticalInfo _statistical_info;      // Statistics about the thread
 400 
 401   JFR_ONLY(DEFINE_THREAD_LOCAL_FIELD_JFR;)      // Thread-local data for jfr
 402 
 403   int   _vm_operation_started_count;            // VM_Operation support
 404   int   _vm_operation_completed_count;          // VM_Operation support
 405 
 406   ObjectMonitor* _current_pending_monitor;      // ObjectMonitor this thread
 407                                                 // is waiting to lock
 408   bool _current_pending_monitor_is_from_java;   // locking is from Java code
<span class="line-added"> 409   JvmtiRawMonitor* _current_pending_raw_monitor; // JvmtiRawMonitor this thread</span>
<span class="line-added"> 410                                                  // is waiting to lock</span>
<span class="line-added"> 411 </span>
 412 
 413   // ObjectMonitor on which this thread called Object.wait()
 414   ObjectMonitor* _current_waiting_monitor;
 415 
<span class="line-modified"> 416   // Per-thread ObjectMonitor lists:</span>
 417  public:
<span class="line-modified"> 418   ObjectMonitor* om_free_list;                  // SLL of free ObjectMonitors</span>
<span class="line-modified"> 419   int om_free_count;                            // # on om_free_list</span>
<span class="line-modified"> 420   int om_free_provision;                        // # to try to allocate next</span>
<span class="line-modified"> 421   ObjectMonitor* om_in_use_list;                // SLL of in-use ObjectMonitors</span>
<span class="line-modified"> 422   int om_in_use_count;                          // # on om_in_use_list</span>
 423 
 424 #ifdef ASSERT
 425  private:
 426   volatile uint64_t _visited_for_critical_count;
 427 
 428  public:
 429   void set_visited_for_critical_count(uint64_t safepoint_id) {
 430     assert(_visited_for_critical_count == 0, &quot;Must be reset before set&quot;);
 431     assert((safepoint_id &amp; 0x1) == 1, &quot;Must be odd&quot;);
 432     _visited_for_critical_count = safepoint_id;
 433   }
 434   void reset_visited_for_critical_count(uint64_t safepoint_id) {
 435     assert(_visited_for_critical_count == safepoint_id, &quot;Was not visited&quot;);
 436     _visited_for_critical_count = 0;
 437   }
 438   bool was_visited_for_critical_count(uint64_t safepoint_id) const {
 439     return _visited_for_critical_count == safepoint_id;
 440   }
 441 #endif
 442 
</pre>
<hr />
<pre>
 464     PRE_CALL_RUN,
 465     CALL_RUN,
 466     PRE_RUN,
 467     RUN,
 468     POST_RUN
 469     // POST_CALL_RUN - can&#39;t define this one as &#39;this&#39; may be deleted when we want to set it
 470   };
 471   RunState _run_state;  // for lifecycle checks
 472 #endif
 473 
 474 
 475  public:
 476   // invokes &lt;ChildThreadClass&gt;::run(), with common preparations and cleanups.
 477   void call_run();
 478 
 479   // Testers
 480   virtual bool is_VM_thread()       const            { return false; }
 481   virtual bool is_Java_thread()     const            { return false; }
 482   virtual bool is_Compiler_thread() const            { return false; }
 483   virtual bool is_Code_cache_sweeper_thread() const  { return false; }
<span class="line-added"> 484   virtual bool is_service_thread() const             { return false; }</span>
 485   virtual bool is_hidden_from_external_view() const  { return false; }
 486   virtual bool is_jvmti_agent_thread() const         { return false; }
 487   // True iff the thread can perform GC operations at a safepoint.
 488   // Generally will be true only of VM thread and parallel GC WorkGang
 489   // threads.
 490   virtual bool is_GC_task_thread() const             { return false; }
 491   virtual bool is_Watcher_thread() const             { return false; }
 492   virtual bool is_ConcurrentGC_thread() const        { return false; }
 493   virtual bool is_Named_thread() const               { return false; }
 494   virtual bool is_Worker_thread() const              { return false; }
 495 
 496   // Can this thread make Java upcalls
 497   virtual bool can_call_java() const                 { return false; }
 498 
<span class="line-added"> 499   // Is this a JavaThread that is on the VM&#39;s current ThreadsList?</span>
<span class="line-added"> 500   // If so it must participate in the safepoint protocol.</span>
<span class="line-added"> 501   virtual bool is_active_Java_thread() const         { return false; }</span>
<span class="line-added"> 502 </span>
 503   // Casts
 504   virtual WorkerThread* as_Worker_thread() const     { return NULL; }
 505 
 506   virtual char* name() const { return (char*)&quot;Unknown thread&quot;; }
 507 
 508   // Returns the current thread (ASSERTS if NULL)
 509   static inline Thread* current();
 510   // Returns the current thread, or NULL if not attached
 511   static inline Thread* current_or_null();
 512   // Returns the current thread, or NULL if not attached, and is
 513   // safe for use from signal-handlers
 514   static inline Thread* current_or_null_safe();
 515 
 516   // Common thread operations
 517 #ifdef ASSERT
 518   static void check_for_dangling_thread_pointer(Thread *thread);
 519 #endif
 520   static void set_priority(Thread* thread, ThreadPriority priority);
 521   static ThreadPriority get_priority(const Thread* const thread);
 522   static void start(Thread* thread);


 523 
 524   void set_native_thread_name(const char *name) {
 525     assert(Thread::current() == this, &quot;set_native_thread_name can only be called on the current thread&quot;);
 526     os::set_native_thread_name(name);
 527   }
 528 

 529   Monitor* SR_lock() const                       { return _SR_lock; }
 530 
 531   bool has_async_exception() const { return (_suspend_flags &amp; _has_async_exception) != 0; }
 532 
 533   inline void set_suspend_flag(SuspendFlags f);
 534   inline void clear_suspend_flag(SuspendFlags f);
 535 
 536   inline void set_has_async_exception();
 537   inline void clear_has_async_exception();
 538 
 539   bool do_critical_native_unlock() const { return (_suspend_flags &amp; _critical_native_unlock) != 0; }
 540 
 541   inline void set_critical_native_unlock();
 542   inline void clear_critical_native_unlock();
 543 
 544   inline void set_trace_flag();
 545   inline void clear_trace_flag();
 546 
 547   // Support for Unhandled Oop detection
 548   // Add the field for both, fastdebug and debug, builds to keep
</pre>
<hr />
<pre>
 628     return _current_pending_monitor;
 629   }
 630   void set_current_pending_monitor(ObjectMonitor* monitor) {
 631     _current_pending_monitor = monitor;
 632   }
 633   void set_current_pending_monitor_is_from_java(bool from_java) {
 634     _current_pending_monitor_is_from_java = from_java;
 635   }
 636   bool current_pending_monitor_is_from_java() {
 637     return _current_pending_monitor_is_from_java;
 638   }
 639 
 640   // For tracking the ObjectMonitor on which this thread called Object.wait()
 641   ObjectMonitor* current_waiting_monitor() {
 642     return _current_waiting_monitor;
 643   }
 644   void set_current_waiting_monitor(ObjectMonitor* monitor) {
 645     _current_waiting_monitor = monitor;
 646   }
 647 
<span class="line-added"> 648   // For tracking the Jvmti raw monitor the thread is pending on.</span>
<span class="line-added"> 649   JvmtiRawMonitor* current_pending_raw_monitor() {</span>
<span class="line-added"> 650     return _current_pending_raw_monitor;</span>
<span class="line-added"> 651   }</span>
<span class="line-added"> 652   void set_current_pending_raw_monitor(JvmtiRawMonitor* monitor) {</span>
<span class="line-added"> 653     _current_pending_raw_monitor = monitor;</span>
<span class="line-added"> 654   }</span>
<span class="line-added"> 655 </span>
 656   // GC support
 657   // Apply &quot;f-&gt;do_oop&quot; to all root oops in &quot;this&quot;.
 658   //   Used by JavaThread::oops_do.
 659   // Apply &quot;cf-&gt;do_code_blob&quot; (if !NULL) to all code blobs active in frames
 660   virtual void oops_do(OopClosure* f, CodeBlobClosure* cf);
 661 
<span class="line-modified"> 662   // Handles the parallel case for claim_threads_do.</span>
 663  private:
<span class="line-modified"> 664   bool claim_par_threads_do(uintx claim_token);</span>
 665  public:
<span class="line-modified"> 666   // Requires that &quot;claim_token&quot; is that of the current iteration.</span>
<span class="line-modified"> 667   // If &quot;is_par&quot; is false, sets the token of &quot;this&quot; to</span>
<span class="line-modified"> 668   // &quot;claim_token&quot;, and returns &quot;true&quot;.  If &quot;is_par&quot; is true,</span>
<span class="line-modified"> 669   // uses an atomic instruction to set the current thread&#39;s token to</span>
<span class="line-modified"> 670   // &quot;claim_token&quot;, if it is not already.  Returns &quot;true&quot; iff the</span>
 671   // calling thread does the update, this indicates that the calling thread
<span class="line-modified"> 672   // has claimed the thread in the current iteration.</span>
<span class="line-modified"> 673   bool claim_threads_do(bool is_par, uintx claim_token) {</span>

 674     if (!is_par) {
<span class="line-modified"> 675       _threads_do_token = claim_token;</span>
 676       return true;
 677     } else {
<span class="line-modified"> 678       return claim_par_threads_do(claim_token);</span>
 679     }
 680   }
 681 
<span class="line-added"> 682   uintx threads_do_token() const { return _threads_do_token; }</span>
<span class="line-added"> 683 </span>
 684   // jvmtiRedefineClasses support
 685   void metadata_handles_do(void f(Metadata*));
 686 
 687   // Used by fast lock support
 688   virtual bool is_lock_owned(address adr) const;
 689 
<span class="line-modified"> 690   // Check if address is in the live stack of this thread (not just for locks).</span>
<span class="line-modified"> 691   // Warning: can only be called by the current thread on itself.</span>
 692   bool is_in_stack(address adr) const;
<span class="line-modified"> 693 </span>
<span class="line-modified"> 694   // Check if address in the stack mapped to this thread. Used mainly in</span>
<span class="line-modified"> 695   // error reporting (so has to include guard zone) and frame printing.</span>
<span class="line-added"> 696   bool on_local_stack(address adr) const {</span>
<span class="line-added"> 697     return (_stack_base &gt; adr &amp;&amp; adr &gt;= stack_end());</span>
<span class="line-added"> 698   }</span>
 699 
 700   // Sets this thread as starting thread. Returns failure if thread
 701   // creation fails due to lack of memory, too many threads etc.
 702   bool set_as_starting_thread();
 703 
 704 protected:
 705   // OS data associated with the thread
 706   OSThread* _osthread;  // Platform-specific thread information
 707 
 708   // Thread local resource area for temporary allocation within the VM
 709   ResourceArea* _resource_area;
 710 
 711   DEBUG_ONLY(ResourceMark* _current_resource_mark;)
 712 
 713   // Thread local handle area for allocation of handles within the VM
 714   HandleArea* _handle_area;
 715   GrowableArray&lt;Metadata*&gt;* _metadata_handles;
 716 
 717   // Support for stack overflow handling, get_thread, etc.
 718   address          _stack_base;
 719   size_t           _stack_size;

 720   int              _lgrp_id;
 721 
 722   volatile void** polling_page_addr() { return &amp;_polling_page; }
 723 
 724  public:
 725   // Stack overflow support
 726   address stack_base() const           { assert(_stack_base != NULL,&quot;Sanity check&quot;); return _stack_base; }
 727   void    set_stack_base(address base) { _stack_base = base; }
 728   size_t  stack_size() const           { return _stack_size; }
 729   void    set_stack_size(size_t size)  { _stack_size = size; }
 730   address stack_end()  const           { return stack_base() - stack_size(); }
 731   void    record_stack_base_and_size();
 732   void    register_thread_stack_with_NMT() NOT_NMT_RETURN;
 733 








 734   int     lgrp_id() const        { return _lgrp_id; }
 735   void    set_lgrp_id(int value) { _lgrp_id = value; }
 736 
 737   // Printing
 738   void print_on(outputStream* st, bool print_extended_info) const;
 739   virtual void print_on(outputStream* st) const { print_on(st, false); }
<span class="line-modified"> 740   void print() const;</span>
 741   virtual void print_on_error(outputStream* st, char* buf, int buflen) const;
 742   void print_value_on(outputStream* st) const;
 743 
 744   // Debug-only code
 745 #ifdef ASSERT
 746  private:
 747   // Deadlock detection support for Mutex locks. List of locks own by thread.
<span class="line-modified"> 748   Mutex* _owned_locks;</span>
 749   // Mutex::set_owner_implementation is the only place where _owned_locks is modified,
 750   // thus the friendship
 751   friend class Mutex;
 752   friend class Monitor;
 753 
 754  public:
 755   void print_owned_locks_on(outputStream* st) const;
 756   void print_owned_locks() const                 { print_owned_locks_on(tty);    }
<span class="line-modified"> 757   Mutex* owned_locks() const                     { return _owned_locks;          }</span>
 758   bool owns_locks() const                        { return owned_locks() != NULL; }


 759 
 760   // Deadlock detection

 761   ResourceMark* current_resource_mark()          { return _current_resource_mark; }
 762   void set_current_resource_mark(ResourceMark* rm) { _current_resource_mark = rm; }
<span class="line-modified"> 763 #endif // ASSERT</span>
 764 
<span class="line-modified"> 765   // These functions check conditions on a JavaThread before possibly going to a safepoint,</span>
<span class="line-added"> 766   // including NoSafepointVerifier.</span>
<span class="line-added"> 767   void check_for_valid_safepoint_state() NOT_DEBUG_RETURN;</span>
<span class="line-added"> 768   void check_possible_safepoint() NOT_DEBUG_RETURN;</span>
 769 
 770  private:
 771   volatile int _jvmti_env_iteration_count;
 772 
 773  public:
 774   void entering_jvmti_env_iteration()            { ++_jvmti_env_iteration_count; }
 775   void leaving_jvmti_env_iteration()             { --_jvmti_env_iteration_count; }
 776   bool is_inside_jvmti_env_iteration()           { return _jvmti_env_iteration_count &gt; 0; }
 777 
 778   // Code generation
 779   static ByteSize exception_file_offset()        { return byte_offset_of(Thread, _exception_file); }
 780   static ByteSize exception_line_offset()        { return byte_offset_of(Thread, _exception_line); }
 781   static ByteSize active_handles_offset()        { return byte_offset_of(Thread, _active_handles); }
 782 
 783   static ByteSize stack_base_offset()            { return byte_offset_of(Thread, _stack_base); }
 784   static ByteSize stack_size_offset()            { return byte_offset_of(Thread, _stack_size); }
 785 
 786   static ByteSize polling_page_offset()          { return byte_offset_of(Thread, _polling_page); }
 787 
 788   static ByteSize tlab_start_offset()            { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::start_offset(); }
 789   static ByteSize tlab_end_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::end_offset(); }
 790   static ByteSize tlab_top_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::top_offset(); }
 791   static ByteSize tlab_pf_top_offset()           { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::pf_top_offset(); }
 792 
 793   static ByteSize allocated_bytes_offset()       { return byte_offset_of(Thread, _allocated_bytes); }
 794 
 795   JFR_ONLY(DEFINE_THREAD_LOCAL_OFFSET_JFR;)
 796 
 797  public:
 798   volatile intptr_t _Stalled;
 799   volatile int _TypeTag;
<span class="line-modified"> 800   ParkEvent * _ParkEvent;                     // for Object monitors and JVMTI raw monitors</span>

 801   ParkEvent * _MuxEvent;                      // for low-level muxAcquire-muxRelease
 802   int NativeSyncRecursion;                    // diagnostic
 803 
 804   volatile int _OnTrap;                       // Resume-at IP delta
 805   jint _hashStateW;                           // Marsaglia Shift-XOR thread-local RNG
 806   jint _hashStateX;                           // thread-specific hashCode generator state
 807   jint _hashStateY;
 808   jint _hashStateZ;
 809 
 810   // Low-level leaf-lock primitives used to implement synchronization
 811   // and native monitor-mutex infrastructure.
 812   // Not for general synchronization use.
 813   static void SpinAcquire(volatile int * Lock, const char * Name);
 814   static void SpinRelease(volatile int * Lock);
 815   static void muxAcquire(volatile intptr_t * Lock, const char * Name);

 816   static void muxRelease(volatile intptr_t * Lock);
 817 };
 818 
 819 // Inline implementation of Thread::current()
 820 inline Thread* Thread::current() {
 821   Thread* current = current_or_null();
 822   assert(current != NULL, &quot;Thread::current() called on detached thread&quot;);
 823   return current;
 824 }
 825 
 826 inline Thread* Thread::current_or_null() {
 827 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 828   return _thr_current;
 829 #else
 830   if (ThreadLocalStorage::is_initialized()) {
 831     return ThreadLocalStorage::thread();
 832   }
 833   return NULL;
 834 #endif
 835 }
</pre>
<hr />
<pre>
 856   virtual void pre_run();
 857   virtual void post_run();
 858 
 859  public:
 860   NonJavaThread();
 861   ~NonJavaThread();
 862 
 863   class Iterator;
 864 };
 865 
 866 // Provides iteration over the list of NonJavaThreads.
 867 // List addition occurs in pre_run(), and removal occurs in post_run(),
 868 // so that only live fully-initialized threads can be found in the list.
 869 // Threads created after an iterator is constructed will not be visited
 870 // by the iterator. The scope of an iterator is a critical section; there
 871 // must be no safepoint checks in that scope.
 872 class NonJavaThread::Iterator : public StackObj {
 873   uint _protect_enter;
 874   NonJavaThread* _current;
 875 
<span class="line-modified"> 876   NONCOPYABLE(Iterator);</span>


 877 
 878 public:
 879   Iterator();
 880   ~Iterator();
 881 
 882   bool end() const { return _current == NULL; }
 883   NonJavaThread* current() const { return _current; }
 884   void step();
 885 };
 886 
 887 // Name support for threads.  non-JavaThread subclasses with multiple
 888 // uniquely named instances should derive from this.
 889 class NamedThread: public NonJavaThread {
 890   friend class VMStructs;
 891   enum {
 892     max_name_len = 64
 893   };
 894  private:
 895   char* _name;
 896   // log JavaThread being processed by oops_do
</pre>
<hr />
<pre>
 968   // Create and start the single instance of WatcherThread, or stop it on shutdown
 969   static void start();
 970   static void stop();
 971   // Only allow start once the VM is sufficiently initialized
 972   // Otherwise the first task to enroll will trigger the start
 973   static void make_startable();
 974  private:
 975   int sleep() const;
 976 };
 977 
 978 
 979 class CompilerThread;
 980 
 981 typedef void (*ThreadFunction)(JavaThread*, TRAPS);
 982 
 983 class JavaThread: public Thread {
 984   friend class VMStructs;
 985   friend class JVMCIVMStructs;
 986   friend class WhiteBox;
 987  private:

 988   bool           _on_thread_list;                // Is set when this JavaThread is added to the Threads list
 989   oop            _threadObj;                     // The Java level thread object
 990 
 991 #ifdef ASSERT
 992  private:
 993   int _java_call_counter;
 994 
 995  public:
 996   int  java_call_counter()                       { return _java_call_counter; }
 997   void inc_java_call_counter()                   { _java_call_counter++; }
 998   void dec_java_call_counter() {
 999     assert(_java_call_counter &gt; 0, &quot;Invalid nesting of JavaCallWrapper&quot;);
1000     _java_call_counter--;
1001   }
1002  private:  // restore original namespace restriction
1003 #endif  // ifdef ASSERT
1004 
1005 #ifndef PRODUCT
1006  public:
1007   enum {
1008     jump_ring_buffer_size = 16
1009   };
1010  private:  // restore original namespace restriction
1011 #endif
1012 
1013   JavaFrameAnchor _anchor;                       // Encapsulation of current java frame and it state
1014 
1015   ThreadFunction _entry_point;
1016 
1017   JNIEnv        _jni_environment;
1018 
1019   // Deopt support
1020   DeoptResourceMark*  _deopt_mark;               // Holds special ResourceMark for deoptimization
1021 


1022   CompiledMethod*       _deopt_nmethod;         // CompiledMethod that is currently being deoptimized
1023   vframeArray*  _vframe_array_head;              // Holds the heap of the active vframeArrays
1024   vframeArray*  _vframe_array_last;              // Holds last vFrameArray we popped
1025   // Because deoptimization is lazy we must save jvmti requests to set locals
1026   // in compiled frames until we deoptimize and we have an interpreter frame.
1027   // This holds the pointer to array (yeah like there might be more than one) of
1028   // description of compiled vframes that have locals that need to be updated.
1029   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* _deferred_locals_updates;
1030 
1031   // Handshake value for fixing 6243940. We need a place for the i2c
1032   // adapter to store the callee Method*. This value is NEVER live
1033   // across a gc point so it does NOT have to be gc&#39;d
1034   // The handshake is open ended since we can&#39;t be certain that it will
1035   // be NULLed. This is because we rarely ever see the race and end up
1036   // in handle_wrong_method which is the backend of the handshake. See
1037   // code in i2c adapters and handle_wrong_method.
1038 
1039   Method*       _callee_target;
1040 
1041   // Used to pass back results to the interpreter or generated code running Java code.
</pre>
<hr />
<pre>
1111     stack_guard_yellow_reserved_disabled,// disabled (temporarily) after stack overflow
1112     stack_guard_enabled         // enabled
1113   };
1114 
1115  private:
1116 
1117 #if INCLUDE_JVMCI
1118   // The _pending_* fields below are used to communicate extra information
1119   // from an uncommon trap in JVMCI compiled code to the uncommon trap handler.
1120 
1121   // Communicates the DeoptReason and DeoptAction of the uncommon trap
1122   int       _pending_deoptimization;
1123 
1124   // Specifies whether the uncommon trap is to bci 0 of a synchronized method
1125   // before the monitor has been acquired.
1126   bool      _pending_monitorenter;
1127 
1128   // Specifies if the DeoptReason for the last uncommon trap was Reason_transfer_to_interpreter
1129   bool      _pending_transfer_to_interpreter;
1130 



1131   // True if in a runtime call from compiled code that will deoptimize
1132   // and re-execute a failed heap allocation in the interpreter.
1133   bool      _in_retryable_allocation;
1134 
1135   // An id of a speculation that JVMCI compiled code can use to further describe and
1136   // uniquely identify the  speculative optimization guarded by the uncommon trap
<span class="line-modified">1137   jlong     _pending_failed_speculation;</span>
1138 
1139   // These fields are mutually exclusive in terms of live ranges.
1140   union {
1141     // Communicates the pc at which the most recent implicit exception occurred
1142     // from the signal handler to a deoptimization stub.
1143     address   _implicit_exception_pc;
1144 
1145     // Communicates an alternative call target to an i2c stub from a JavaCall .
1146     address   _alternate_call_target;
1147   } _jvmci;
1148 
1149   // Support for high precision, thread sensitive counters in JVMCI compiled code.
1150   jlong*    _jvmci_counters;
1151 
1152  public:
1153   static jlong* _jvmci_old_thread_counters;
<span class="line-modified">1154   static void collect_counters(jlong* array, int length);</span>
<span class="line-added">1155   void resize_counters(int current_size, int new_size);</span>
<span class="line-added">1156   static void resize_all_jvmci_counters(int new_size);</span>
<span class="line-added">1157 </span>
1158  private:
1159 #endif // INCLUDE_JVMCI
1160 
1161   StackGuardState  _stack_guard_state;
1162 
1163   // Precompute the limit of the stack as used in stack overflow checks.
1164   // We load it from here to simplify the stack overflow check in assembly.
1165   address          _stack_overflow_limit;
1166   address          _reserved_stack_activation;
1167 
1168   // Compiler exception handling (NOTE: The _exception_oop is *NOT* the same as _pending_exception. It is
1169   // used to temp. parsing values into and out of the runtime system during exception handling for compiled
1170   // code)
1171   volatile oop     _exception_oop;               // Exception thrown in compiled code
1172   volatile address _exception_pc;                // PC where exception happened
1173   volatile address _exception_handler_pc;        // PC for handler of exception
1174   volatile int     _is_method_handle_return;     // true (== 1) if the current exception PC is a MethodHandle call site.
1175 
1176  private:
1177   // support for JNI critical regions
1178   jint    _jni_active_critical;                  // count of entries into JNI critical region
1179 
1180   // Checked JNI: function name requires exception check
1181   char* _pending_jni_exception_check_fn;
1182 
1183   // For deadlock detection.
1184   int _depth_first_number;
1185 
1186   // JVMTI PopFrame support
1187   // This is set to popframe_pending to signal that top Java frame should be popped immediately
1188   int _popframe_condition;
1189 
1190   // If reallocation of scalar replaced objects fails, we throw OOM
1191   // and during exception propagation, pop the top
1192   // _frames_to_pop_failed_realloc frames, the ones that reference
1193   // failed reallocations.
1194   int _frames_to_pop_failed_realloc;
1195 











1196   friend class VMThread;
1197   friend class ThreadWaitTransition;
1198   friend class VM_Exit;
1199 
1200   void initialize();                             // Initialized the instance variables
1201 
1202  public:
1203   // Constructor
1204   JavaThread(bool is_attaching_via_jni = false); // for main thread and JNI attached threads
1205   JavaThread(ThreadFunction entry_point, size_t stack_size = 0);
1206   ~JavaThread();
1207 
1208 #ifdef ASSERT
1209   // verify this JavaThread hasn&#39;t be published in the Threads::list yet
1210   void verify_not_published();
<span class="line-modified">1211 #endif // ASSERT</span>
1212 
1213   //JNI functiontable getter/setter for JVMTI jni function table interception API.
1214   void set_jni_functions(struct JNINativeInterface_* functionTable) {
1215     _jni_environment.functions = functionTable;
1216   }
1217   struct JNINativeInterface_* get_jni_functions() {
1218     return (struct JNINativeInterface_ *)_jni_environment.functions;
1219   }
1220 
1221   // This function is called at thread creation to allow
1222   // platform specific thread variables to be initialized.
1223   void cache_global_variables();
1224 
1225   // Executes Shutdown.shutdown()
1226   void invoke_shutdown_hooks();
1227 
1228   // Cleanup on thread exit
1229   enum ExitType {
1230     normal_exit,
1231     jni_detach
1232   };
1233   void exit(bool destroy_vm, ExitType exit_type = normal_exit);
1234 
<span class="line-modified">1235   void cleanup_failed_attach_current_thread(bool is_daemon);</span>
1236 
1237   // Testers
1238   virtual bool is_Java_thread() const            { return true;  }
1239   virtual bool can_call_java() const             { return true; }
1240 
<span class="line-modified">1241   virtual bool is_active_Java_thread() const {</span>
<span class="line-modified">1242     return on_thread_list() &amp;&amp; !is_terminated();</span>
<span class="line-modified">1243   }</span>
1244 
1245   // Thread oop. threadObj() can be NULL for initial JavaThread
1246   // (or for threads attached via JNI)
1247   oop threadObj() const                          { return _threadObj; }
1248   void set_threadObj(oop p)                      { _threadObj = p; }
1249 


1250   // Prepare thread and add to priority queue.  If a priority is
1251   // not specified, use the priority of the thread object. Threads_lock
1252   // must be held while this function is called.
1253   void prepare(jobject jni_thread, ThreadPriority prio=NoPriority);
1254 
1255   void set_saved_exception_pc(address pc)        { _saved_exception_pc = pc; }
1256   address saved_exception_pc()                   { return _saved_exception_pc; }
1257 
1258 
1259   ThreadFunction entry_point() const             { return _entry_point; }
1260 
1261   // Allocates a new Java level thread object for this thread. thread_name may be NULL.
1262   void allocate_threadObj(Handle thread_group, const char* thread_name, bool daemon, TRAPS);
1263 
1264   // Last frame anchor routines
1265 
1266   JavaFrameAnchor* frame_anchor(void)            { return &amp;_anchor; }
1267 
1268   // last_Java_sp
1269   bool has_last_Java_frame() const               { return _anchor.has_last_Java_frame(); }
1270   intptr_t* last_Java_sp() const                 { return _anchor.last_Java_sp(); }
1271 
1272   // last_Java_pc
1273 
1274   address last_Java_pc(void)                     { return _anchor.last_Java_pc(); }
1275 
1276   // Safepoint support
1277   inline JavaThreadState thread_state() const;
1278   inline void set_thread_state(JavaThreadState s);
<span class="line-added">1279   inline void set_thread_state_fence(JavaThreadState s);  // fence after setting thread state</span>
1280   inline ThreadSafepointState* safepoint_state() const;
1281   inline void set_safepoint_state(ThreadSafepointState* state);
1282   inline bool is_at_poll_safepoint();
1283 
1284   // JavaThread termination and lifecycle support:
1285   void smr_delete();
1286   bool on_thread_list() const { return _on_thread_list; }
1287   void set_on_thread_list() { _on_thread_list = true; }
1288 
1289   // thread has called JavaThread::exit() or is terminated
1290   bool is_exiting() const;
1291   // thread is terminated (no longer on the threads list); we compare
1292   // against the two non-terminated values so that a freed JavaThread
1293   // will also be considered terminated.
1294   bool check_is_terminated(TerminatedTypes l_terminated) const {
1295     return l_terminated != _not_terminated &amp;&amp; l_terminated != _thread_exiting;
1296   }
1297   bool is_terminated() const;
1298   void set_terminated(TerminatedTypes t);
1299   // special for Threads::remove() which is static:
</pre>
<hr />
<pre>
1309   inline void set_polling_page_release(void* poll_value);
1310   inline void set_polling_page(void* poll_value);
1311   inline volatile void* get_polling_page();
1312 
1313  private:
1314   // Support for thread handshake operations
1315   HandshakeState _handshake;
1316  public:
1317   void set_handshake_operation(HandshakeOperation* op) {
1318     _handshake.set_operation(this, op);
1319   }
1320 
1321   bool has_handshake() const {
1322     return _handshake.has_operation();
1323   }
1324 
1325   void handshake_process_by_self() {
1326     _handshake.process_by_self(this);
1327   }
1328 
<span class="line-modified">1329   bool handshake_try_process_by_vmThread() {</span>
<span class="line-modified">1330     return _handshake.try_process_by_vmThread(this);</span>
<span class="line-added">1331   }</span>
<span class="line-added">1332 </span>
<span class="line-added">1333 #ifdef ASSERT</span>
<span class="line-added">1334   bool is_vmthread_processing_handshake() const {</span>
<span class="line-added">1335     return _handshake.is_vmthread_processing_handshake();</span>
1336   }
<span class="line-added">1337 #endif</span>
1338 
1339   // Suspend/resume support for JavaThread
1340  private:
1341   inline void set_ext_suspended();
1342   inline void clear_ext_suspended();
1343 
1344  public:
<span class="line-modified">1345   void java_suspend(); // higher-level suspension logic called by the public APIs</span>
<span class="line-modified">1346   void java_resume();  // higher-level resume logic called by the public APIs</span>
<span class="line-modified">1347   int  java_suspend_self(); // low-level self-suspension mechanics</span>
<span class="line-added">1348 </span>
<span class="line-added">1349  private:</span>
<span class="line-added">1350   // mid-level wrapper around java_suspend_self to set up correct state and</span>
<span class="line-added">1351   // check for a pending safepoint at the end</span>
<span class="line-added">1352   void java_suspend_self_with_safepoint_check();</span>
1353 
<span class="line-added">1354  public:</span>
1355   void check_and_wait_while_suspended() {
1356     assert(JavaThread::current() == this, &quot;sanity check&quot;);
1357 
1358     bool do_self_suspend;
1359     do {
1360       // were we externally suspended while we were waiting?
1361       do_self_suspend = handle_special_suspend_equivalent_condition();
1362       if (do_self_suspend) {
1363         // don&#39;t surprise the thread that suspended us by returning
1364         java_suspend_self();
1365         set_suspend_equivalent();
1366       }
1367     } while (do_self_suspend);
1368   }
1369   static void check_safepoint_and_suspend_for_native_trans(JavaThread *thread);
1370   // Check for async exception in addition to safepoint and suspend request.
1371   static void check_special_condition_for_native_trans(JavaThread *thread);
1372 
1373   // Same as check_special_condition_for_native_trans but finishes the
1374   // transition into thread_in_Java mode so that it can potentially
1375   // block.
1376   static void check_special_condition_for_native_trans_and_transition(JavaThread *thread);
1377 
1378   bool is_ext_suspend_completed(bool called_by_wait, int delay, uint32_t *bits);
1379   bool is_ext_suspend_completed_with_lock(uint32_t *bits) {
<span class="line-modified">1380     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1381     // Warning: is_ext_suspend_completed() may temporarily drop the
1382     // SR_lock to allow the thread to reach a stable thread state if
1383     // it is currently in a transient thread state.
1384     return is_ext_suspend_completed(false /* !called_by_wait */,
1385                                     SuspendRetryDelay, bits);
1386   }
1387 
1388   // We cannot allow wait_for_ext_suspend_completion() to run forever or
1389   // we could hang. SuspendRetryCount and SuspendRetryDelay are normally
1390   // passed as the count and delay parameters. Experiments with specific
1391   // calls to wait_for_ext_suspend_completion() can be done by passing
1392   // other values in the code. Experiments with all calls can be done
1393   // via the appropriate -XX options.
1394   bool wait_for_ext_suspend_completion(int count, int delay, uint32_t *bits);
1395 
1396   // test for suspend - most (all?) of these should go away
1397   bool is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits);
1398 
1399   inline void set_external_suspend();
1400   inline void clear_external_suspend();
1401 




1402   bool is_external_suspend() const {
1403     return (_suspend_flags &amp; _external_suspend) != 0;
1404   }
1405   // Whenever a thread transitions from native to vm/java it must suspend
1406   // if external|deopt suspend is present.
1407   bool is_suspend_after_native() const {
<span class="line-modified">1408     return (_suspend_flags &amp; (_external_suspend JFR_ONLY(| _trace_flag))) != 0;</span>
1409   }
1410 
1411   // external suspend request is completed
1412   bool is_ext_suspended() const {
1413     return (_suspend_flags &amp; _ext_suspended) != 0;
1414   }
1415 
1416   bool is_external_suspend_with_lock() const {
<span class="line-modified">1417     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1418     return is_external_suspend();
1419   }
1420 
1421   // Special method to handle a pending external suspend request
1422   // when a suspend equivalent condition lifts.
1423   bool handle_special_suspend_equivalent_condition() {
1424     assert(is_suspend_equivalent(),
1425            &quot;should only be called in a suspend equivalence condition&quot;);
<span class="line-modified">1426     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1427     bool ret = is_external_suspend();
1428     if (!ret) {
1429       // not about to self-suspend so clear suspend equivalence
1430       clear_suspend_equivalent();
1431     }
1432     // implied else:
1433     // We have a pending external suspend request so we leave the
1434     // suspend_equivalent flag set until java_suspend_self() sets
1435     // the ext_suspended flag and clears the suspend_equivalent
1436     // flag. This insures that wait_for_ext_suspend_completion()
1437     // will return consistent values.
1438     return ret;
1439   }
1440 
1441   // utility methods to see if we are doing some kind of suspension
1442   bool is_being_ext_suspended() const            {
<span class="line-modified">1443     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);</span>
1444     return is_ext_suspended() || is_external_suspend();
1445   }
1446 
1447   bool is_suspend_equivalent() const             { return _suspend_equivalent; }
1448 
1449   void set_suspend_equivalent()                  { _suspend_equivalent = true; }
1450   void clear_suspend_equivalent()                { _suspend_equivalent = false; }
1451 
1452   // Thread.stop support
1453   void send_thread_stop(oop throwable);
1454   AsyncRequests clear_special_runtime_exit_condition() {
1455     AsyncRequests x = _special_runtime_exit_condition;
1456     _special_runtime_exit_condition = _no_async_condition;
1457     return x;
1458   }
1459 
1460   // Are any async conditions present?
1461   bool has_async_condition() { return (_special_runtime_exit_condition != _no_async_condition); }
1462 
1463   void check_and_handle_async_exceptions(bool check_unsafe_error = true);
</pre>
<hr />
<pre>
1491   // Accessors for vframe array top
1492   // The linked list of vframe arrays are sorted on sp. This means when we
1493   // unpack the head must contain the vframe array to unpack.
1494   void set_vframe_array_head(vframeArray* value) { _vframe_array_head = value; }
1495   vframeArray* vframe_array_head() const         { return _vframe_array_head;  }
1496 
1497   // Side structure for deferring update of java frame locals until deopt occurs
1498   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred_locals() const { return _deferred_locals_updates; }
1499   void set_deferred_locals(GrowableArray&lt;jvmtiDeferredLocalVariableSet *&gt;* vf) { _deferred_locals_updates = vf; }
1500 
1501   // These only really exist to make debugging deopt problems simpler
1502 
1503   void set_vframe_array_last(vframeArray* value) { _vframe_array_last = value; }
1504   vframeArray* vframe_array_last() const         { return _vframe_array_last;  }
1505 
1506   // The special resourceMark used during deoptimization
1507 
1508   void set_deopt_mark(DeoptResourceMark* value)  { _deopt_mark = value; }
1509   DeoptResourceMark* deopt_mark(void)            { return _deopt_mark; }
1510 




1511   void set_deopt_compiled_method(CompiledMethod* nm)  { _deopt_nmethod = nm; }
1512   CompiledMethod* deopt_compiled_method()        { return _deopt_nmethod; }
1513 
1514   Method*    callee_target() const               { return _callee_target; }
1515   void set_callee_target  (Method* x)          { _callee_target   = x; }
1516 
1517   // Oop results of vm runtime calls
1518   oop  vm_result() const                         { return _vm_result; }
1519   void set_vm_result  (oop x)                    { _vm_result   = x; }
1520 
1521   Metadata*    vm_result_2() const               { return _vm_result_2; }
1522   void set_vm_result_2  (Metadata* x)          { _vm_result_2   = x; }
1523 
1524   MemRegion deferred_card_mark() const           { return _deferred_card_mark; }
1525   void set_deferred_card_mark(MemRegion mr)      { _deferred_card_mark = mr;   }
1526 
1527 #if INCLUDE_JVMCI
1528   int  pending_deoptimization() const             { return _pending_deoptimization; }
<span class="line-modified">1529   jlong pending_failed_speculation() const        { return _pending_failed_speculation; }</span>


1530   bool has_pending_monitorenter() const           { return _pending_monitorenter; }
1531   void set_pending_monitorenter(bool b)           { _pending_monitorenter = b; }
1532   void set_pending_deoptimization(int reason)     { _pending_deoptimization = reason; }
<span class="line-modified">1533   void set_pending_failed_speculation(jlong failed_speculation) { _pending_failed_speculation = failed_speculation; }</span>
1534   void set_pending_transfer_to_interpreter(bool b) { _pending_transfer_to_interpreter = b; }
1535   void set_jvmci_alternate_call_target(address a) { assert(_jvmci._alternate_call_target == NULL, &quot;must be&quot;); _jvmci._alternate_call_target = a; }
1536   void set_jvmci_implicit_exception_pc(address a) { assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;); _jvmci._implicit_exception_pc = a; }
1537 
1538   virtual bool in_retryable_allocation() const    { return _in_retryable_allocation; }
1539   void set_in_retryable_allocation(bool b)        { _in_retryable_allocation = b; }
1540 #endif // INCLUDE_JVMCI
1541 
1542   // Exception handling for compiled methods
1543   oop      exception_oop() const                 { return _exception_oop; }
1544   address  exception_pc() const                  { return _exception_pc; }
1545   address  exception_handler_pc() const          { return _exception_handler_pc; }
1546   bool     is_method_handle_return() const       { return _is_method_handle_return == 1; }
1547 
1548   void set_exception_oop(oop o)                  { (void)const_cast&lt;oop&amp;&gt;(_exception_oop = o); }
1549   void set_exception_pc(address a)               { _exception_pc = a; }
1550   void set_exception_handler_pc(address a)       { _exception_handler_pc = a; }
1551   void set_is_method_handle_return(bool value)   { _is_method_handle_return = value ? 1 : 0; }
1552 
1553   void clear_exception_oop_and_pc() {
</pre>
<hr />
<pre>
1713     _reserved_stack_activation = addr;
1714   }
1715 
1716   // Attempt to reguard the stack after a stack overflow may have occurred.
1717   // Returns true if (a) guard pages are not needed on this thread, (b) the
1718   // pages are already guarded, or (c) the pages were successfully reguarded.
1719   // Returns false if there is not enough stack space to reguard the pages, in
1720   // which case the caller should unwind a frame and try again.  The argument
1721   // should be the caller&#39;s (approximate) sp.
1722   bool reguard_stack(address cur_sp);
1723   // Similar to above but see if current stackpoint is out of the guard area
1724   // and reguard if possible.
1725   bool reguard_stack(void);
1726 
1727   address stack_overflow_limit() { return _stack_overflow_limit; }
1728   void set_stack_overflow_limit() {
1729     _stack_overflow_limit =
1730       stack_end() + MAX2(JavaThread::stack_guard_zone_size(), JavaThread::stack_shadow_zone_size());
1731   }
1732 
<span class="line-added">1733   // Check if address is in the usable part of the stack (excludes protected</span>
<span class="line-added">1734   // guard pages). Can be applied to any thread and is an approximation for</span>
<span class="line-added">1735   // using is_in_stack when the query has to happen from another thread.</span>
<span class="line-added">1736   bool is_in_usable_stack(address adr) const;</span>
<span class="line-added">1737 </span>
1738   // Misc. accessors/mutators
1739   void set_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = true; }
1740   void clr_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = false; }
1741   bool do_not_unlock(void)                       { return _do_not_unlock_if_synchronized; }
1742 




1743   // For assembly stub generation
1744   static ByteSize threadObj_offset()             { return byte_offset_of(JavaThread, _threadObj); }




1745   static ByteSize jni_environment_offset()       { return byte_offset_of(JavaThread, _jni_environment); }
1746   static ByteSize pending_jni_exception_check_fn_offset() {
1747     return byte_offset_of(JavaThread, _pending_jni_exception_check_fn);
1748   }
1749   static ByteSize last_Java_sp_offset() {
1750     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_sp_offset();
1751   }
1752   static ByteSize last_Java_pc_offset() {
1753     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_pc_offset();
1754   }
1755   static ByteSize frame_anchor_offset() {
1756     return byte_offset_of(JavaThread, _anchor);
1757   }
1758   static ByteSize callee_target_offset()         { return byte_offset_of(JavaThread, _callee_target); }
1759   static ByteSize vm_result_offset()             { return byte_offset_of(JavaThread, _vm_result); }
1760   static ByteSize vm_result_2_offset()           { return byte_offset_of(JavaThread, _vm_result_2); }
1761   static ByteSize thread_state_offset()          { return byte_offset_of(JavaThread, _thread_state); }
1762   static ByteSize saved_exception_pc_offset()    { return byte_offset_of(JavaThread, _saved_exception_pc); }
1763   static ByteSize osthread_offset()              { return byte_offset_of(JavaThread, _osthread); }
1764 #if INCLUDE_JVMCI
1765   static ByteSize pending_deoptimization_offset() { return byte_offset_of(JavaThread, _pending_deoptimization); }
1766   static ByteSize pending_monitorenter_offset()  { return byte_offset_of(JavaThread, _pending_monitorenter); }
1767   static ByteSize pending_failed_speculation_offset() { return byte_offset_of(JavaThread, _pending_failed_speculation); }
1768   static ByteSize jvmci_alternate_call_target_offset() { return byte_offset_of(JavaThread, _jvmci._alternate_call_target); }
1769   static ByteSize jvmci_implicit_exception_pc_offset() { return byte_offset_of(JavaThread, _jvmci._implicit_exception_pc); }
1770   static ByteSize jvmci_counters_offset()        { return byte_offset_of(JavaThread, _jvmci_counters); }
1771 #endif // INCLUDE_JVMCI
1772   static ByteSize exception_oop_offset()         { return byte_offset_of(JavaThread, _exception_oop); }
1773   static ByteSize exception_pc_offset()          { return byte_offset_of(JavaThread, _exception_pc); }
1774   static ByteSize exception_handler_pc_offset()  { return byte_offset_of(JavaThread, _exception_handler_pc); }
1775   static ByteSize stack_overflow_limit_offset()  { return byte_offset_of(JavaThread, _stack_overflow_limit); }
1776   static ByteSize is_method_handle_return_offset() { return byte_offset_of(JavaThread, _is_method_handle_return); }
1777   static ByteSize stack_guard_state_offset()     { return byte_offset_of(JavaThread, _stack_guard_state); }
1778   static ByteSize reserved_stack_activation_offset() { return byte_offset_of(JavaThread, _reserved_stack_activation); }
1779   static ByteSize suspend_flags_offset()         { return byte_offset_of(JavaThread, _suspend_flags); }
1780 
1781   static ByteSize do_not_unlock_if_synchronized_offset() { return byte_offset_of(JavaThread, _do_not_unlock_if_synchronized); }
1782   static ByteSize should_post_on_exceptions_flag_offset() {
1783     return byte_offset_of(JavaThread, _should_post_on_exceptions_flag);
1784   }
<span class="line-added">1785   static ByteSize doing_unsafe_access_offset() { return byte_offset_of(JavaThread, _doing_unsafe_access); }</span>
1786 
1787   // Returns the jni environment for this thread
1788   JNIEnv* jni_environment()                      { return &amp;_jni_environment; }
1789 
1790   static JavaThread* thread_from_jni_environment(JNIEnv* env) {
1791     JavaThread *thread_from_jni_env = (JavaThread*)((intptr_t)env - in_bytes(jni_environment_offset()));
1792     // Only return NULL if thread is off the thread list; starting to
1793     // exit should not return NULL.
1794     if (thread_from_jni_env-&gt;is_terminated()) {
1795       thread_from_jni_env-&gt;block_if_vm_exited();
1796       return NULL;
1797     } else {
1798       return thread_from_jni_env;
1799     }
1800   }
1801 
1802   // JNI critical regions. These can nest.
1803   bool in_critical()    { return _jni_active_critical &gt; 0; }
1804   bool in_last_critical()  { return _jni_active_critical == 1; }
1805   inline void enter_critical();
</pre>
<hr />
<pre>
1837     if (_in_deopt_handler &gt; 0) { // robustness
1838       _in_deopt_handler--;
1839     }
1840   }
1841 
1842  private:
1843   void set_entry_point(ThreadFunction entry_point) { _entry_point = entry_point; }
1844 
1845  public:
1846 
1847   // Frame iteration; calls the function f for all frames on the stack
1848   void frames_do(void f(frame*, const RegisterMap*));
1849 
1850   // Memory operations
1851   void oops_do(OopClosure* f, CodeBlobClosure* cf);
1852 
1853   // Sweeper operations
1854   virtual void nmethods_do(CodeBlobClosure* cf);
1855 
1856   // RedefineClasses Support
<span class="line-modified">1857   void metadata_do(MetadataClosure* f);</span>
<span class="line-added">1858 </span>
<span class="line-added">1859   // Debug method asserting thread states are correct during a handshake operation.</span>
<span class="line-added">1860   DEBUG_ONLY(void verify_states_for_handshake();)</span>
1861 
1862   // Misc. operations
1863   char* name() const { return (char*)get_thread_name(); }
1864   void print_on(outputStream* st, bool print_extended_info) const;
1865   void print_on(outputStream* st) const { print_on(st, false); }
<span class="line-modified">1866   void print() const;</span>
1867   void print_thread_state_on(outputStream*) const      PRODUCT_RETURN;

1868   void print_on_error(outputStream* st, char* buf, int buflen) const;
1869   void print_name_on_error(outputStream* st, char* buf, int buflen) const;
1870   void verify();
1871   const char* get_thread_name() const;
1872  protected:
1873   // factor out low-level mechanics for use in both normal and error cases
1874   virtual const char* get_thread_name_string(char* buf = NULL, int buflen = 0) const;
1875  public:



1876   // Accessing frames
1877   frame last_frame() {
1878     _anchor.make_walkable(this);
1879     return pd_last_frame();
1880   }
1881   javaVFrame* last_java_vframe(RegisterMap* reg_map);
1882 
1883   // Returns method at &#39;depth&#39; java or native frames down the stack
1884   // Used for security checks
1885   Klass* security_get_caller_class(int depth);
1886 
1887   // Print stack trace in external format
1888   void print_stack_on(outputStream* st);
1889   void print_stack() { print_stack_on(tty); }
1890 
1891   // Print stack traces in various internal formats
1892   void trace_stack()                             PRODUCT_RETURN;
1893   void trace_stack_from(vframe* start_vf)        PRODUCT_RETURN;
1894   void trace_frames()                            PRODUCT_RETURN;

1895 
1896   // Print an annotated view of the stack frames
1897   void print_frame_layout(int depth = 0, bool validate_only = false) NOT_DEBUG_RETURN;
1898   void validate_frame_layout() {
1899     print_frame_layout(0, true);
1900   }
1901 



1902   // Function for testing deoptimization
1903   void deoptimize();
1904   void make_zombies();
1905 
<span class="line-modified">1906   void deoptimize_marked_methods();</span>
1907 
1908  public:
1909   // Returns the running thread as a JavaThread
1910   static inline JavaThread* current();
1911 
1912   // Returns the active Java thread.  Do not use this if you know you are calling
1913   // from a JavaThread, as it&#39;s slower than JavaThread::current.  If called from
1914   // the VMThread, it also returns the JavaThread that instigated the VMThread&#39;s
1915   // operation.  You may not want that either.
1916   static JavaThread* active();
1917 
1918   inline CompilerThread* as_CompilerThread();
1919 
1920  protected:
1921   virtual void pre_run();
1922   virtual void run();
1923   void thread_main_inner();
1924   virtual void post_run();
1925 
1926 
</pre>
<hr />
<pre>
2025  public:
2026   ThreadStatistics* get_thread_stat() const    { return _thread_stat; }
2027 
2028   // Return a blocker object for which this thread is blocked parking.
2029   oop current_park_blocker();
2030 
2031  private:
2032   static size_t _stack_size_at_create;
2033 
2034  public:
2035   static inline size_t stack_size_at_create(void) {
2036     return _stack_size_at_create;
2037   }
2038   static inline void set_stack_size_at_create(size_t value) {
2039     _stack_size_at_create = value;
2040   }
2041 
2042   // Machine dependent stuff
2043 #include OS_CPU_HEADER(thread)
2044 












2045   // JSR166 per-thread parker
2046  private:
2047   Parker*    _parker;
2048  public:
2049   Parker*     parker() { return _parker; }
2050 
2051   // Biased locking support
2052  private:
2053   GrowableArray&lt;MonitorInfo*&gt;* _cached_monitor_info;
2054  public:
2055   GrowableArray&lt;MonitorInfo*&gt;* cached_monitor_info() { return _cached_monitor_info; }
2056   void set_cached_monitor_info(GrowableArray&lt;MonitorInfo*&gt;* info) { _cached_monitor_info = info; }
2057 
2058   // clearing/querying jni attach status
2059   bool is_attaching_via_jni() const { return _jni_attach_state == _attaching_via_jni; }
2060   bool has_attached_via_jni() const { return is_attaching_via_jni() || _jni_attach_state == _attached_via_jni; }
2061   inline void set_done_attaching_via_jni();
2062 
2063   // Stack dump assistance:
2064   // Track the class we want to initialize but for which we have to wait
2065   // on its init_lock() because it is already being initialized.
2066   void set_class_to_be_initialized(InstanceKlass* k);
2067   InstanceKlass* class_to_be_initialized() const;
2068 
2069 private:
2070   InstanceKlass* _class_to_be_initialized;
2071 
<span class="line-added">2072   // java.lang.Thread.sleep support</span>
<span class="line-added">2073   ParkEvent * _SleepEvent;</span>
<span class="line-added">2074 public:</span>
<span class="line-added">2075   bool sleep(jlong millis);</span>
<span class="line-added">2076 </span>
<span class="line-added">2077   // java.lang.Thread interruption support</span>
<span class="line-added">2078   void interrupt();</span>
<span class="line-added">2079   bool is_interrupted(bool clear_interrupted);</span>
<span class="line-added">2080 </span>
2081 };
2082 
2083 // Inline implementation of JavaThread::current
2084 inline JavaThread* JavaThread::current() {
2085   Thread* thread = Thread::current();
2086   assert(thread-&gt;is_Java_thread(), &quot;just checking&quot;);
2087   return (JavaThread*)thread;
2088 }
2089 
2090 inline CompilerThread* JavaThread::as_CompilerThread() {
2091   assert(is_Compiler_thread(), &quot;just checking&quot;);
2092   return (CompilerThread*)this;
2093 }
2094 
2095 // Dedicated thread to sweep the code cache
2096 class CodeCacheSweeperThread : public JavaThread {
2097   CompiledMethod*       _scanned_compiled_method; // nmethod being scanned by the sweeper
2098  public:
2099   CodeCacheSweeperThread();
2100   // Track the nmethod currently being scanned by the sweeper
</pre>
<hr />
<pre>
2173   IdealGraphPrinter *_ideal_graph_printer;
2174  public:
2175   IdealGraphPrinter *ideal_graph_printer()           { return _ideal_graph_printer; }
2176   void set_ideal_graph_printer(IdealGraphPrinter *n) { _ideal_graph_printer = n; }
2177 #endif
2178 
2179   // Get/set the thread&#39;s current task
2180   CompileTask* task()                      { return _task; }
2181   void         set_task(CompileTask* task) { _task = task; }
2182 };
2183 
2184 inline CompilerThread* CompilerThread::current() {
2185   return JavaThread::current()-&gt;as_CompilerThread();
2186 }
2187 
2188 // The active thread queue. It also keeps track of the current used
2189 // thread priorities.
2190 class Threads: AllStatic {
2191   friend class VMStructs;
2192  private:

2193   static int         _number_of_threads;
2194   static int         _number_of_non_daemon_threads;
2195   static int         _return_code;
<span class="line-modified">2196   static uintx       _thread_claim_token;</span>
2197 #ifdef ASSERT
2198   static bool        _vm_complete;
2199 #endif
2200 
2201   static void initialize_java_lang_classes(JavaThread* main_thread, TRAPS);
2202   static void initialize_jsr292_core_classes(TRAPS);
2203 
2204  public:
2205   // Thread management
2206   // force_daemon is a concession to JNI, where we may need to add a
2207   // thread to the thread list before allocating its thread object
2208   static void add(JavaThread* p, bool force_daemon = false);
<span class="line-modified">2209   static void remove(JavaThread* p, bool is_daemon);</span>
2210   static void non_java_threads_do(ThreadClosure* tc);
2211   static void java_threads_do(ThreadClosure* tc);
2212   static void java_threads_and_vm_thread_do(ThreadClosure* tc);
2213   static void threads_do(ThreadClosure* tc);
2214   static void possibly_parallel_threads_do(bool is_par, ThreadClosure* tc);
2215 
2216   // Initializes the vm and creates the vm thread
2217   static jint create_vm(JavaVMInitArgs* args, bool* canTryAgain);
2218   static void convert_vm_init_libraries_to_agents();
2219   static void create_vm_init_libraries();
2220   static void create_vm_init_agents();
2221   static void shutdown_vm_agents();
2222   static bool destroy_vm();
2223   // Supported VM versions via JNI
2224   // Includes JNI_VERSION_1_1
2225   static jboolean is_supported_jni_version_including_1_1(jint version);
2226   // Does not include JNI_VERSION_1_1
2227   static jboolean is_supported_jni_version(jint version);
2228 
<span class="line-modified">2229   // The &quot;thread claim token&quot; provides a way for threads to be claimed</span>
2230   // by parallel worker tasks.
2231   //
<span class="line-modified">2232   // Each thread contains a &quot;token&quot; field. A task will claim the</span>
<span class="line-modified">2233   // thread only if its token is different from the global token,</span>
<span class="line-modified">2234   // which is updated by calling change_thread_claim_token().  When</span>
<span class="line-added">2235   // a thread is claimed, it&#39;s token is set to the global token value</span>
<span class="line-added">2236   // so other threads in the same iteration pass won&#39;t claim it.</span>
2237   //
<span class="line-modified">2238   // For this to work change_thread_claim_token() needs to be called</span>
2239   // exactly once in sequential code before starting parallel tasks
2240   // that should claim threads.
2241   //
<span class="line-modified">2242   // New threads get their token set to 0 and change_thread_claim_token()</span>
<span class="line-modified">2243   // never sets the global token to 0.</span>
<span class="line-modified">2244   static uintx thread_claim_token() { return _thread_claim_token; }</span>
<span class="line-modified">2245   static void change_thread_claim_token();</span>
2246   static void assert_all_threads_claimed() NOT_DEBUG_RETURN;
2247 
2248   // Apply &quot;f-&gt;do_oop&quot; to all root oops in all threads.
2249   // This version may only be called by sequential code.
2250   static void oops_do(OopClosure* f, CodeBlobClosure* cf);
2251   // This version may be called by sequential or parallel code.
2252   static void possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf);
2253 







2254   // Sweeper
2255   static void nmethods_do(CodeBlobClosure* cf);
2256 
2257   // RedefineClasses support
<span class="line-modified">2258   static void metadata_do(MetadataClosure* f);</span>
2259   static void metadata_handles_do(void f(Metadata*));
2260 
2261 #ifdef ASSERT
2262   static bool is_vm_complete() { return _vm_complete; }
2263 #endif // ASSERT
2264 
2265   // Verification
2266   static void verify();
2267   static void print_on(outputStream* st, bool print_stacks, bool internal_format, bool print_concurrent_locks, bool print_extended_info);
2268   static void print(bool print_stacks, bool internal_format) {
2269     // this function is only used by debug.cpp
2270     print_on(tty, print_stacks, internal_format, false /* no concurrent lock printed */, false /* simple format */);
2271   }
2272   static void print_on_error(outputStream* st, Thread* current, char* buf, int buflen);
2273   static void print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
2274                              int buflen, bool* found_current);
2275   static void print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form = false);
2276 
2277   // Get Java threads that are waiting to enter a monitor.
2278   static GrowableArray&lt;JavaThread*&gt;* get_pending_threads(ThreadsList * t_list,
2279                                                          int count, address monitor);
2280 
2281   // Get owning Java thread from the monitor&#39;s owner field.
2282   static JavaThread *owning_thread_from_monitor_owner(ThreadsList * t_list,
2283                                                       address owner);
2284 
2285   // Number of threads on the active threads list
2286   static int number_of_threads()                 { return _number_of_threads; }
2287   // Number of non-daemon threads on the active threads list
2288   static int number_of_non_daemon_threads()      { return _number_of_non_daemon_threads; }
2289 
2290   // Deoptimizes all frames tied to marked nmethods
2291   static void deoptimized_wrt_marked_nmethods();


2292 
<span class="line-modified">2293   struct Test;                  // For private gtest access.</span>



2294 };
2295 
2296 class SignalHandlerMark: public StackObj {
2297  private:
2298   Thread* _thread;
2299  public:
2300   SignalHandlerMark(Thread* t) {
2301     _thread = t;
2302     if (_thread) _thread-&gt;enter_signal_handler();
2303   }
2304   ~SignalHandlerMark() {
2305     if (_thread) _thread-&gt;leave_signal_handler();
2306     _thread = NULL;
2307   }
2308 };
2309 
2310 
2311 #endif // SHARE_RUNTIME_THREAD_HPP
</pre>
</td>
</tr>
</table>
<center><a href="thread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="thread.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>