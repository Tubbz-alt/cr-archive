<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/interfaceSupport.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="init.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="interfaceSupport.inline.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/interfaceSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,16 +25,16 @@</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/shared/collectedHeap.hpp&quot;
  #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;runtime/atomic.hpp&quot;
  #include &quot;runtime/frame.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/init.hpp&quot;
  #include &quot;runtime/interfaceSupport.inline.hpp&quot;
<span class="udiff-line-removed">- #include &quot;runtime/orderAccess.hpp&quot;</span>
  #include &quot;runtime/os.inline.hpp&quot;
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;runtime/safepointVerifiers.hpp&quot;
  #include &quot;runtime/vframe.hpp&quot;
  #include &quot;runtime/vmThread.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,16 +52,10 @@</span>
  VMEntryWrapper::~VMEntryWrapper() {
    InterfaceSupport::check_gc_alot();
    if (WalkStackALot) {
      InterfaceSupport::walk_stack();
    }
<span class="udiff-line-removed">- #ifdef COMPILER2</span>
<span class="udiff-line-removed">-   // This option is not used by Compiler 1</span>
<span class="udiff-line-removed">-   if (StressDerivedPointers) {</span>
<span class="udiff-line-removed">-     InterfaceSupport::stress_derived_pointers();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #endif</span>
    if (DeoptimizeALot || DeoptimizeRandom) {
      InterfaceSupport::deoptimizeAll();
    }
    if (ZombieALot) {
      InterfaceSupport::zombieAll();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,10 +64,18 @@</span>
    if (VerifyStack) {
      InterfaceSupport::verify_stack();
    }
  }
  
<span class="udiff-line-added">+ VMNativeEntryWrapper::VMNativeEntryWrapper() {</span>
<span class="udiff-line-added">+   if (GCALotAtAllSafepoints) InterfaceSupport::check_gc_alot();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ VMNativeEntryWrapper::~VMNativeEntryWrapper() {</span>
<span class="udiff-line-added">+   if (GCALotAtAllSafepoints) InterfaceSupport::check_gc_alot();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  long InterfaceSupport::_number_of_calls       = 0;
  long InterfaceSupport::_scavenge_alot_counter = 1;
  long InterfaceSupport::_fullgc_alot_counter   = 1;
  long InterfaceSupport::_fullgc_alot_invocation = 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,12 +84,12 @@</span>
  RuntimeHistogramElement::RuntimeHistogramElement(const char* elementName) {
    static volatile int RuntimeHistogram_lock = 0;
    _name = elementName;
    uintx count = 0;
  
<span class="udiff-line-modified-removed">-   while (Atomic::cmpxchg(1, &amp;RuntimeHistogram_lock, 0) != 0) {</span>
<span class="udiff-line-modified-removed">-     while (OrderAccess::load_acquire(&amp;RuntimeHistogram_lock) != 0) {</span>
<span class="udiff-line-modified-added">+   while (Atomic::cmpxchg(&amp;RuntimeHistogram_lock, 0, 1) != 0) {</span>
<span class="udiff-line-modified-added">+     while (Atomic::load_acquire(&amp;RuntimeHistogram_lock) != 0) {</span>
        count +=1;
        if ( (WarnOnStalledSpinLock &gt; 0)
          &amp;&amp; (count % WarnOnStalledSpinLock == 0)) {
          warning(&quot;RuntimeHistogram_lock seems to be stalled&quot;);
        }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,35 +225,10 @@</span>
    }
    deoptimizeAllCounter++;
  }
  
  
<span class="udiff-line-removed">- void InterfaceSupport::stress_derived_pointers() {</span>
<span class="udiff-line-removed">- #ifdef COMPILER2</span>
<span class="udiff-line-removed">-   JavaThread *thread = JavaThread::current();</span>
<span class="udiff-line-removed">-   if (!is_init_completed()) return;</span>
<span class="udiff-line-removed">-   ResourceMark rm(thread);</span>
<span class="udiff-line-removed">-   bool found = false;</span>
<span class="udiff-line-removed">-   for (StackFrameStream sfs(thread); !sfs.is_done() &amp;&amp; !found; sfs.next()) {</span>
<span class="udiff-line-removed">-     CodeBlob* cb = sfs.current()-&gt;cb();</span>
<span class="udiff-line-removed">-     if (cb != NULL &amp;&amp; cb-&gt;oop_maps() ) {</span>
<span class="udiff-line-removed">-       // Find oopmap for current method</span>
<span class="udiff-line-removed">-       const ImmutableOopMap* map = cb-&gt;oop_map_for_return_address(sfs.current()-&gt;pc());</span>
<span class="udiff-line-removed">-       assert(map != NULL, &quot;no oopmap found for pc&quot;);</span>
<span class="udiff-line-removed">-       found = map-&gt;has_derived_pointer();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (found) {</span>
<span class="udiff-line-removed">-     // $$$ Not sure what to do here.</span>
<span class="udiff-line-removed">-     /*</span>
<span class="udiff-line-removed">-     Scavenge::invoke(0);</span>
<span class="udiff-line-removed">-     */</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  void InterfaceSupport::verify_stack() {
    JavaThread* thread = JavaThread::current();
    ResourceMark rm(thread);
    // disabled because it throws warnings that oop maps should only be accessed
    // in VM thread or during debugging
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -289,42 +266,5 @@</span>
    if (ScavengeALot || FullGCALot) {
      srand(ScavengeALotInterval * FullGCALotInterval);
    }
  #endif
  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">- // JRT_LEAF rules:</span>
<span class="udiff-line-removed">- // A JRT_LEAF method may not interfere with safepointing by</span>
<span class="udiff-line-removed">- //   1) acquiring or blocking on a Mutex or JavaLock - checked</span>
<span class="udiff-line-removed">- //   2) allocating heap memory - checked</span>
<span class="udiff-line-removed">- //   3) executing a VM operation - checked</span>
<span class="udiff-line-removed">- //   4) executing a system call (including malloc) that could block or grab a lock</span>
<span class="udiff-line-removed">- //   5) invoking GC</span>
<span class="udiff-line-removed">- //   6) reaching a safepoint</span>
<span class="udiff-line-removed">- //   7) running too long</span>
<span class="udiff-line-removed">- // Nor may any method it calls.</span>
<span class="udiff-line-removed">- JRTLeafVerifier::JRTLeafVerifier()</span>
<span class="udiff-line-removed">-   : NoSafepointVerifier(true, JRTLeafVerifier::should_verify_GC())</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- JRTLeafVerifier::~JRTLeafVerifier()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool JRTLeafVerifier::should_verify_GC() {</span>
<span class="udiff-line-removed">-   switch (JavaThread::current()-&gt;thread_state()) {</span>
<span class="udiff-line-removed">-   case _thread_in_Java:</span>
<span class="udiff-line-removed">-     // is in a leaf routine, there must be no safepoint.</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   case _thread_in_native:</span>
<span class="udiff-line-removed">-     // A native thread is not subject to safepoints.</span>
<span class="udiff-line-removed">-     // Even while it is in a leaf routine, GC is ok</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   default:</span>
<span class="udiff-line-removed">-     // Leaf routines cannot be called from other contexts.</span>
<span class="udiff-line-removed">-     ShouldNotReachHere();</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #endif // ASSERT</span>
</pre>
<center><a href="init.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="interfaceSupport.inline.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>