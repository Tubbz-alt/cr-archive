<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/os.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="orderAccess.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="os.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/os.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/javaClasses.hpp&quot;
  29 #include &quot;classfile/moduleEntry.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;code/codeCache.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/vtableStubs.hpp&quot;
  35 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;logging/logStream.hpp&quot;
  40 #include &quot;memory/allocation.inline.hpp&quot;
<span class="line-removed">  41 #ifdef ASSERT</span>
  42 #include &quot;memory/guardedMemory.hpp&quot;
<span class="line-removed">  43 #endif</span>
  44 #include &quot;memory/resourceArea.hpp&quot;


  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;prims/jvm_misc.hpp&quot;
  47 #include &quot;runtime/arguments.hpp&quot;
  48 #include &quot;runtime/atomic.hpp&quot;
  49 #include &quot;runtime/frame.inline.hpp&quot;
  50 #include &quot;runtime/handles.inline.hpp&quot;
  51 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/os.inline.hpp&quot;
  56 #include &quot;runtime/sharedRuntime.hpp&quot;
  57 #include &quot;runtime/stubRoutines.hpp&quot;
  58 #include &quot;runtime/thread.inline.hpp&quot;
  59 #include &quot;runtime/threadSMR.hpp&quot;
  60 #include &quot;runtime/vm_version.hpp&quot;
  61 #include &quot;services/attachListener.hpp&quot;
  62 #include &quot;services/mallocTracker.hpp&quot;
  63 #include &quot;services/memTracker.hpp&quot;
  64 #include &quot;services/nmtCommon.hpp&quot;
</pre>
<hr />
<pre>
  71 # include &lt;errno.h&gt;
  72 
  73 OSThread*         os::_starting_thread    = NULL;
  74 address           os::_polling_page       = NULL;
  75 volatile unsigned int os::_rand_seed      = 1;
  76 int               os::_processor_count    = 0;
  77 int               os::_initial_active_processor_count = 0;
  78 size_t            os::_page_sizes[os::page_sizes_max];
  79 
  80 #ifndef PRODUCT
  81 julong os::num_mallocs = 0;         // # of calls to malloc/realloc
  82 julong os::alloc_bytes = 0;         // # of bytes allocated
  83 julong os::num_frees = 0;           // # of calls to free
  84 julong os::free_bytes = 0;          // # of bytes freed
  85 #endif
  86 
  87 static size_t cur_malloc_words = 0;  // current size for MallocMaxTestWords
  88 
  89 DEBUG_ONLY(bool os::_mutex_init_done = false;)
  90 
<span class="line-removed">  91 void os_init_globals() {</span>
<span class="line-removed">  92   // Called from init_globals().</span>
<span class="line-removed">  93   // See Threads::create_vm() in thread.cpp, and init.cpp.</span>
<span class="line-removed">  94   os::init_globals();</span>
<span class="line-removed">  95 }</span>
<span class="line-removed">  96 </span>
  97 static time_t get_timezone(const struct tm* time_struct) {
  98 #if defined(_ALLBSD_SOURCE)
  99   return time_struct-&gt;tm_gmtoff;
 100 #elif defined(_WINDOWS)
 101   long zone;
 102   _get_timezone(&amp;zone);
 103   return static_cast&lt;time_t&gt;(zone);
 104 #else
 105   return timezone;
 106 #endif
 107 }
 108 
 109 int os::snprintf(char* buf, size_t len, const char* fmt, ...) {
 110   va_list args;
 111   va_start(args, fmt);
 112   int result = os::vsnprintf(buf, len, fmt, args);
 113   va_end(args);
 114   return result;
 115 }
 116 
</pre>
<hr />
<pre>
 262 
 263 // Helper for dll_locate_lib.
 264 // Pass buffer and printbuffer as we already printed the path to buffer
 265 // when we called get_current_directory. This way we avoid another buffer
 266 // of size MAX_PATH.
 267 static bool conc_path_file_and_check(char *buffer, char *printbuffer, size_t printbuflen,
 268                                      const char* pname, char lastchar, const char* fname) {
 269 
 270   // Concatenate path and file name, but don&#39;t print double path separators.
 271   const char *filesep = (WINDOWS_ONLY(lastchar == &#39;:&#39; ||) lastchar == os::file_separator()[0]) ?
 272                         &quot;&quot; : os::file_separator();
 273   int ret = jio_snprintf(printbuffer, printbuflen, &quot;%s%s%s&quot;, pname, filesep, fname);
 274   // Check whether file exists.
 275   if (ret != -1) {
 276     struct stat statbuf;
 277     return os::stat(buffer, &amp;statbuf) == 0;
 278   }
 279   return false;
 280 }
 281 













 282 bool os::dll_locate_lib(char *buffer, size_t buflen,
 283                         const char* pname, const char* fname) {
 284   bool retval = false;
 285 
 286   size_t fullfnamelen = strlen(JNI_LIB_PREFIX) + strlen(fname) + strlen(JNI_LIB_SUFFIX);
<span class="line-modified"> 287   char* fullfname = (char*)NEW_C_HEAP_ARRAY(char, fullfnamelen + 1, mtInternal);</span>
 288   if (dll_build_name(fullfname, fullfnamelen + 1, fname)) {
 289     const size_t pnamelen = pname ? strlen(pname) : 0;
 290 
 291     if (pnamelen == 0) {
 292       // If no path given, use current working directory.
 293       const char* p = get_current_directory(buffer, buflen);
 294       if (p != NULL) {
 295         const size_t plen = strlen(buffer);
 296         const char lastchar = buffer[plen - 1];
 297         retval = conc_path_file_and_check(buffer, &amp;buffer[plen], buflen - plen,
 298                                           &quot;&quot;, lastchar, fullfname);
 299       }
 300     } else if (strchr(pname, *os::path_separator()) != NULL) {
 301       // A list of paths. Search for the path that contains the library.
<span class="line-modified"> 302       int n;</span>
<span class="line-modified"> 303       char** pelements = split_path(pname, &amp;n);</span>
 304       if (pelements != NULL) {
<span class="line-modified"> 305         for (int i = 0; i &lt; n; i++) {</span>
 306           char* path = pelements[i];
 307           // Really shouldn&#39;t be NULL, but check can&#39;t hurt.
 308           size_t plen = (path == NULL) ? 0 : strlen(path);
 309           if (plen == 0) {
 310             continue; // Skip the empty path values.
 311           }
 312           const char lastchar = path[plen - 1];
 313           retval = conc_path_file_and_check(buffer, buffer, buflen, path, lastchar, fullfname);
 314           if (retval) break;
 315         }
 316         // Release the storage allocated by split_path.
<span class="line-modified"> 317         for (int i = 0; i &lt; n; i++) {</span>
<span class="line-removed"> 318           if (pelements[i] != NULL) {</span>
<span class="line-removed"> 319             FREE_C_HEAP_ARRAY(char, pelements[i]);</span>
<span class="line-removed"> 320           }</span>
<span class="line-removed"> 321         }</span>
<span class="line-removed"> 322         FREE_C_HEAP_ARRAY(char*, pelements);</span>
 323       }
 324     } else {
 325       // A definite path.
 326       const char lastchar = pname[pnamelen-1];
 327       retval = conc_path_file_and_check(buffer, buffer, buflen, pname, lastchar, fullfname);
 328     }
 329   }
 330 
 331   FREE_C_HEAP_ARRAY(char*, fullfname);
 332   return retval;
 333 }
 334 
 335 // --------------------- sun.misc.Signal (optional) ---------------------
 336 
 337 
 338 // SIGBREAK is sent by the keyboard to query the VM state
 339 #ifndef SIGBREAK
 340 #define SIGBREAK SIGQUIT
 341 #endif
 342 
 343 // sigexitnum_pd is a platform-specific special signal used for terminating the Signal thread.
 344 
 345 
 346 static void signal_thread_entry(JavaThread* thread, TRAPS) {
 347   os::set_priority(thread, NearMaxPriority);
 348   while (true) {
 349     int sig;
 350     {
 351       // FIXME : Currently we have not decided what should be the status
 352       //         for this java thread blocked here. Once we decide about
 353       //         that we should fix this.
 354       sig = os::signal_wait();
 355     }
 356     if (sig == os::sigexitnum_pd()) {
 357        // Terminate the signal thread
 358        return;
 359     }
 360 
 361     switch (sig) {
 362       case SIGBREAK: {

 363         // Check if the signal is a trigger to start the Attach Listener - in that
 364         // case don&#39;t print stack traces.
<span class="line-modified"> 365         if (!DisableAttachMechanism &amp;&amp; AttachListener::is_init_trigger()) {</span>
<span class="line-modified"> 366           continue;</span>




















 367         }

 368         // Print stack traces
 369         // Any SIGBREAK operations added here should make sure to flush
 370         // the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.
 371         // Each module also prints an extra carriage return after its output.
 372         VM_PrintThreads op;
 373         VMThread::execute(&amp;op);
 374         VM_PrintJNI jni_op;
 375         VMThread::execute(&amp;jni_op);
 376         VM_FindDeadlocks op1(tty);
 377         VMThread::execute(&amp;op1);
 378         Universe::print_heap_at_SIGBREAK();
 379         if (PrintClassHistogram) {
 380           VM_GC_HeapInspection op1(tty, true /* force full GC before heap inspection */);
 381           VMThread::execute(&amp;op1);
 382         }
 383         if (JvmtiExport::should_post_data_dump()) {
 384           JvmtiExport::post_data_dump();
 385         }
 386         break;
 387       }
</pre>
<hr />
<pre>
 451     Handle string = java_lang_String::create_from_str(thread_name, CHECK);
 452 
 453     // Initialize thread_oop to put it into the system threadGroup
 454     Handle thread_group (THREAD, Universe::system_thread_group());
 455     Handle thread_oop = JavaCalls::construct_new_instance(SystemDictionary::Thread_klass(),
 456                            vmSymbols::threadgroup_string_void_signature(),
 457                            thread_group,
 458                            string,
 459                            CHECK);
 460 
 461     Klass* group = SystemDictionary::ThreadGroup_klass();
 462     JavaValue result(T_VOID);
 463     JavaCalls::call_special(&amp;result,
 464                             thread_group,
 465                             group,
 466                             vmSymbols::add_method_name(),
 467                             vmSymbols::thread_void_signature(),
 468                             thread_oop,
 469                             CHECK);
 470 
<span class="line-modified"> 471     { MutexLocker mu(Threads_lock);</span>
 472       JavaThread* signal_thread = new JavaThread(&amp;signal_thread_entry);
 473 
 474       // At this point it may be possible that no osthread was created for the
 475       // JavaThread due to lack of memory. We would have to throw an exception
 476       // in that case. However, since this must work and we do not allow
 477       // exceptions anyway, check and abort if this fails.
 478       if (signal_thread == NULL || signal_thread-&gt;osthread() == NULL) {
 479         vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 480                                       os::native_thread_creation_failed_msg());
 481       }
 482 
 483       java_lang_Thread::set_thread(thread_oop(), signal_thread);
 484       java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 485       java_lang_Thread::set_daemon(thread_oop());
 486 
 487       signal_thread-&gt;set_threadObj(thread_oop());
 488       Threads::add(signal_thread);
 489       Thread::start(signal_thread);
 490     }
 491     // Handle ^BREAK
</pre>
<hr />
<pre>
 495 
 496 
 497 void os::terminate_signal_thread() {
 498   if (!ReduceSignalUsage)
 499     signal_notify(sigexitnum_pd());
 500 }
 501 
 502 
 503 // --------------------- loading libraries ---------------------
 504 
 505 typedef jint (JNICALL *JNI_OnLoad_t)(JavaVM *, void *);
 506 extern struct JavaVM_ main_vm;
 507 
 508 static void* _native_java_library = NULL;
 509 
 510 void* os::native_java_library() {
 511   if (_native_java_library == NULL) {
 512     char buffer[JVM_MAXPATHLEN];
 513     char ebuf[1024];
 514 
<span class="line-removed"> 515     // Try to load verify dll first. In 1.3 java dll depends on it and is not</span>
<span class="line-removed"> 516     // always able to find it when the loading executable is outside the JDK.</span>
<span class="line-removed"> 517     // In order to keep working with 1.2 we ignore any loading errors.</span>
<span class="line-removed"> 518     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),</span>
<span class="line-removed"> 519                        &quot;verify&quot;)) {</span>
<span class="line-removed"> 520       dll_load(buffer, ebuf, sizeof(ebuf));</span>
<span class="line-removed"> 521     }</span>
<span class="line-removed"> 522 </span>
 523     // Load java dll
 524     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 525                        &quot;java&quot;)) {
 526       _native_java_library = dll_load(buffer, ebuf, sizeof(ebuf));
 527     }
 528     if (_native_java_library == NULL) {
 529       vm_exit_during_initialization(&quot;Unable to load native library&quot;, ebuf);
 530     }
 531 
 532 #if defined(__OpenBSD__)
 533     // Work-around OpenBSD&#39;s lack of $ORIGIN support by pre-loading libnet.so
 534     // ignore errors
 535     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 536                        &quot;net&quot;)) {
 537       dll_load(buffer, ebuf, sizeof(ebuf));
 538     }
 539 #endif
 540   }
 541   return _native_java_library;
 542 }
</pre>
<hr />
<pre>
 635     ls.print_cr(&quot;## nof_mallocs = &quot; UINT64_FORMAT &quot;, nof_frees = &quot; UINT64_FORMAT, os::num_mallocs, os::num_frees);
 636     ls.print_cr(&quot;## memory stomp:&quot;);
 637     guarded.print_on(&amp;ls);
 638     fatal(&quot;memory stomping error&quot;);
 639   }
 640 }
 641 
 642 #endif
 643 
 644 //
 645 // This function supports testing of the malloc out of memory
 646 // condition without really running the system out of memory.
 647 //
 648 static bool has_reached_max_malloc_test_peak(size_t alloc_size) {
 649   if (MallocMaxTestWords &gt; 0) {
 650     size_t words = (alloc_size / BytesPerWord);
 651 
 652     if ((cur_malloc_words + words) &gt; MallocMaxTestWords) {
 653       return true;
 654     }
<span class="line-modified"> 655     Atomic::add(words, &amp;cur_malloc_words);</span>
 656   }
 657   return false;
 658 }
 659 
 660 void* os::malloc(size_t size, MEMFLAGS flags) {
 661   return os::malloc(size, flags, CALLER_PC);
 662 }
 663 
 664 void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 665   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 666   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 667 
 668   // Since os::malloc can be called when the libjvm.{dll,so} is
 669   // first loaded and we don&#39;t have a thread yet we must accept NULL also here.
 670   assert(!os::ThreadCrashProtection::is_crash_protected(Thread::current_or_null()),
 671          &quot;malloc() not allowed when crash protection is set&quot;);
 672 
 673   if (size == 0) {
 674     // return a valid pointer if size is zero
 675     // if NULL is returned the calling functions assume out of memory.
</pre>
<hr />
<pre>
 687   if (size + nmt_header_size &gt; alloc_size) { // Check for rollover.
 688     return NULL;
 689   }
 690 #endif
 691 
 692   // For the test flag -XX:MallocMaxTestWords
 693   if (has_reached_max_malloc_test_peak(size)) {
 694     return NULL;
 695   }
 696 
 697   u_char* ptr;
 698   ptr = (u_char*)::malloc(alloc_size);
 699 
 700 #ifdef ASSERT
 701   if (ptr == NULL) {
 702     return NULL;
 703   }
 704   // Wrap memory with guard
 705   GuardedMemory guarded(ptr, size + nmt_header_size);
 706   ptr = guarded.get_user_ptr();
<span class="line-modified"> 707 #endif</span>
 708   if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {
 709     log_warning(malloc, free)(&quot;os::malloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));
 710     breakpoint();
 711   }
<span class="line-modified"> 712   debug_only(if (paranoid) verify_memory(ptr));</span>



 713 
 714   // we do not track guard memory
 715   return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);
 716 }
 717 
 718 void* os::realloc(void *memblock, size_t size, MEMFLAGS flags) {
 719   return os::realloc(memblock, size, flags, CALLER_PC);
 720 }
 721 
 722 void* os::realloc(void *memblock, size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 723 
 724   // For the test flag -XX:MallocMaxTestWords
 725   if (has_reached_max_malloc_test_peak(size)) {
 726     return NULL;
 727   }
 728 
 729   if (size == 0) {
 730     // return a valid pointer if size is zero
 731     // if NULL is returned the calling functions assume out of memory.
 732     size = 1;
 733   }
 734 
 735 #ifndef ASSERT
 736   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 737   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 738    // NMT support
<span class="line-removed"> 739   void* membase = MemTracker::record_free(memblock);</span>
 740   NMT_TrackingLevel level = MemTracker::tracking_level();

 741   size_t  nmt_header_size = MemTracker::malloc_header_size(level);
 742   void* ptr = ::realloc(membase, size + nmt_header_size);
 743   return MemTracker::record_malloc(ptr, size, memflags, stack, level);
 744 #else
 745   if (memblock == NULL) {
 746     return os::malloc(size, memflags, stack);
 747   }
 748   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 749     log_warning(malloc, free)(&quot;os::realloc caught &quot; PTR_FORMAT, p2i(memblock));
 750     breakpoint();
 751   }
 752   // NMT support
 753   void* membase = MemTracker::malloc_base(memblock);
 754   verify_memory(membase);
 755   // always move the block
 756   void* ptr = os::malloc(size, memflags, stack);
 757   // Copy to new memory if malloc didn&#39;t fail
 758   if (ptr != NULL ) {
 759     GuardedMemory guarded(MemTracker::malloc_base(memblock));
 760     // Guard&#39;s user data contains NMT header
 761     size_t memblock_size = guarded.get_user_size() - MemTracker::malloc_header_size(memblock);
 762     memcpy(ptr, memblock, MIN2(size, memblock_size));
<span class="line-modified"> 763     if (paranoid) verify_memory(MemTracker::malloc_base(ptr));</span>
<span class="line-modified"> 764     if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {</span>
<span class="line-removed"> 765       log_warning(malloc, free)(&quot;os::realloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));</span>
<span class="line-removed"> 766       breakpoint();</span>
 767     }
 768     os::free(memblock);
 769   }
 770   return ptr;
 771 #endif
 772 }
 773 
<span class="line-modified"> 774 </span>
 775 void  os::free(void *memblock) {
 776   NOT_PRODUCT(inc_stat_counter(&amp;num_frees, 1));
 777 #ifdef ASSERT
 778   if (memblock == NULL) return;
 779   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 780     log_warning(malloc, free)(&quot;os::free caught &quot; PTR_FORMAT, p2i(memblock));
 781     breakpoint();
 782   }
<span class="line-modified"> 783   void* membase = MemTracker::record_free(memblock);</span>
 784   verify_memory(membase);
 785 
 786   GuardedMemory guarded(membase);
 787   size_t size = guarded.get_user_size();
 788   inc_stat_counter(&amp;free_bytes, size);
 789   membase = guarded.release_for_freeing();
 790   ::free(membase);
 791 #else
<span class="line-modified"> 792   void* membase = MemTracker::record_free(memblock);</span>
 793   ::free(membase);
 794 #endif
 795 }
 796 
 797 void os::init_random(unsigned int initval) {
 798   _rand_seed = initval;
 799 }
 800 
 801 
 802 static int random_helper(unsigned int rand_seed) {
 803   /* standard, well-known linear congruential random generator with
 804    * next_rand = (16807*seed) mod (2**31-1)
 805    * see
 806    * (1) &quot;Random Number Generators: Good Ones Are Hard to Find&quot;,
 807    *      S.K. Park and K.W. Miller, Communications of the ACM 31:10 (Oct 1988),
 808    * (2) &quot;Two Fast Implementations of the &#39;Minimal Standard&#39; Random
 809    *     Number Generator&quot;, David G. Carta, Comm. ACM 33, 1 (Jan 1990), pp. 87-88.
 810   */
 811   const unsigned int a = 16807;
 812   const unsigned int m = 2147483647;
</pre>
<hr />
<pre>
 821   // if q overflowed, ignore the overflow and increment q
 822   if (lo &gt; m) {
 823     lo &amp;= m;
 824     ++lo;
 825   }
 826   lo += hi &gt;&gt; 15;
 827 
 828   // if (p+q) overflowed, ignore the overflow and increment (p+q)
 829   if (lo &gt; m) {
 830     lo &amp;= m;
 831     ++lo;
 832   }
 833   return lo;
 834 }
 835 
 836 int os::random() {
 837   // Make updating the random seed thread safe.
 838   while (true) {
 839     unsigned int seed = _rand_seed;
 840     unsigned int rand = random_helper(seed);
<span class="line-modified"> 841     if (Atomic::cmpxchg(rand, &amp;_rand_seed, seed) == seed) {</span>
 842       return static_cast&lt;int&gt;(rand);
 843     }
 844   }
 845 }
 846 
 847 // The INITIALIZED state is distinguished from the SUSPENDED state because the
 848 // conditions in which a thread is first started are different from those in which
 849 // a suspension is resumed.  These differences make it hard for us to apply the
 850 // tougher checks when starting threads that we want to do when resuming them.
 851 // However, when start_thread is called as a result of Thread.start, on a Java
 852 // thread, the operation is synchronized on the Java Thread object.  So there
 853 // cannot be a race to start the thread and hence for the thread to exit while
 854 // we are working on it.  Non-Java threads that start Java threads either have
 855 // to do so in a context in which races are impossible, or should do appropriate
 856 // locking.
 857 
 858 void os::start_thread(Thread* thread) {
 859   // guard suspend/resume
<span class="line-modified"> 860   MutexLockerEx ml(thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);</span>
 861   OSThread* osthread = thread-&gt;osthread();
 862   osthread-&gt;set_state(RUNNABLE);
 863   pd_start_thread(thread);
 864 }
 865 
 866 void os::abort(bool dump_core) {
 867   abort(dump_core &amp;&amp; CreateCoredumpOnCrash, NULL, NULL);
 868 }
 869 
 870 //---------------------------------------------------------------------------
 871 // Helper functions for fatal error handler
 872 
 873 void os::print_hex_dump(outputStream* st, address start, address end, int unitsize) {
 874   assert(unitsize == 1 || unitsize == 2 || unitsize == 4 || unitsize == 8, &quot;just checking&quot;);
 875 
 876   start = align_down(start, unitsize);
 877 
 878   int cols = 0;
 879   int cols_per_line = 0;
 880   switch (unitsize) {
</pre>
<hr />
<pre>
 894         case 2: st-&gt;print(&quot;%04x&quot;, *(u2*)p); break;
 895         case 4: st-&gt;print(&quot;%08x&quot;, *(u4*)p); break;
 896         case 8: st-&gt;print(&quot;%016&quot; FORMAT64_MODIFIER &quot;x&quot;, *(u8*)p); break;
 897       }
 898     } else {
 899       st-&gt;print(&quot;%*.*s&quot;, 2*unitsize, 2*unitsize, &quot;????????????????&quot;);
 900     }
 901     p += unitsize;
 902     cols++;
 903     if (cols &gt;= cols_per_line &amp;&amp; p &lt; end) {
 904        cols = 0;
 905        st-&gt;cr();
 906        st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(p));
 907     } else {
 908        st-&gt;print(&quot; &quot;);
 909     }
 910   }
 911   st-&gt;cr();
 912 }
 913 








 914 void os::print_instructions(outputStream* st, address pc, int unitsize) {
 915   st-&gt;print_cr(&quot;Instructions: (pc=&quot; PTR_FORMAT &quot;)&quot;, p2i(pc));
 916   print_hex_dump(st, pc - 256, pc + 256, unitsize);
 917 }
 918 
 919 void os::print_environment_variables(outputStream* st, const char** env_list) {
 920   if (env_list) {
 921     st-&gt;print_cr(&quot;Environment Variables:&quot;);
 922 
 923     for (int i = 0; env_list[i] != NULL; i++) {
 924       char *envvar = ::getenv(env_list[i]);
 925       if (envvar != NULL) {
 926         st-&gt;print(&quot;%s&quot;, env_list[i]);
 927         st-&gt;print(&quot;=&quot;);
 928         st-&gt;print_cr(&quot;%s&quot;, envvar);
 929       }
 930     }
 931   }
 932 }
 933 
</pre>
<hr />
<pre>
1006   int elsecs = (eltime - day_secs - hour_secs - minute_secs);
1007   st-&gt;print_cr(&quot; elapsed time: %d seconds (%dd %dh %dm %ds)&quot;, eltime, eldays, elhours, elmins, elsecs);
1008 }
1009 
1010 
1011 // Check if pointer can be read from (4-byte read access).
1012 // Helps to prove validity of a not-NULL pointer.
1013 // Returns true in very early stages of VM life when stub is not yet generated.
1014 #define SAFEFETCH_DEFAULT true
1015 bool os::is_readable_pointer(const void* p) {
1016   if (!CanUseSafeFetch32()) {
1017     return SAFEFETCH_DEFAULT;
1018   }
1019   int* const aligned = (int*) align_down((intptr_t)p, 4);
1020   int cafebabe = 0xcafebabe;  // tester value 1
1021   int deadbeef = 0xdeadbeef;  // tester value 2
1022   return (SafeFetch32(aligned, cafebabe) != cafebabe) || (SafeFetch32(aligned, deadbeef) != deadbeef);
1023 }
1024 
1025 bool os::is_readable_range(const void* from, const void* to) {
<span class="line-modified">1026   for (address p = align_down((address)from, min_page_size()); p &lt; to; p += min_page_size()) {</span>
<span class="line-modified">1027     if (!is_readable_pointer(p)) {</span>

1028       return false;
1029     }
1030   }
1031   return true;
1032 }
1033 
1034 
1035 // moved from debug.cpp (used to be find()) but still called from there
1036 // The verbose parameter is only set by the debug code in one case
1037 void os::print_location(outputStream* st, intptr_t x, bool verbose) {
1038   address addr = (address)x;
1039   // Handle NULL first, so later checks don&#39;t need to protect against it.
1040   if (addr == NULL) {
1041     st-&gt;print_cr(&quot;0x0 is NULL&quot;);
1042     return;
1043   }
1044 
1045   // Check if addr points into a code blob.
1046   CodeBlob* b = CodeCache::find_blob_unsafe(addr);
1047   if (b != NULL) {
1048     b-&gt;dump_for_addr(addr, st, verbose);
1049     return;
1050   }
1051 
1052   // Check if addr points into Java heap.
<span class="line-modified">1053   if (Universe::heap()-&gt;is_in(addr)) {</span>
<span class="line-removed">1054     oop o = oopDesc::oop_or_null(addr);</span>
<span class="line-removed">1055     if (o != NULL) {</span>
<span class="line-removed">1056       if ((HeapWord*)o == (HeapWord*)addr) {</span>
<span class="line-removed">1057         st-&gt;print(INTPTR_FORMAT &quot; is an oop: &quot;, p2i(addr));</span>
<span class="line-removed">1058       } else {</span>
<span class="line-removed">1059         st-&gt;print(INTPTR_FORMAT &quot; is pointing into object: &quot; , p2i(addr));</span>
<span class="line-removed">1060       }</span>
<span class="line-removed">1061       o-&gt;print_on(st);</span>
<span class="line-removed">1062       return;</span>
<span class="line-removed">1063     }</span>
<span class="line-removed">1064   } else if (Universe::heap()-&gt;is_in_reserved(addr)) {</span>
<span class="line-removed">1065     st-&gt;print_cr(INTPTR_FORMAT &quot; is an unallocated location in the heap&quot;, p2i(addr));</span>
1066     return;
1067   }
1068 
<span class="line-removed">1069   // Compressed oop needs to be decoded first.</span>
<span class="line-removed">1070 #ifdef _LP64</span>
<span class="line-removed">1071   if (UseCompressedOops &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {</span>
<span class="line-removed">1072     narrowOop narrow_oop = (narrowOop)(uintptr_t)addr;</span>
<span class="line-removed">1073     oop o = oopDesc::decode_oop_raw(narrow_oop);</span>
<span class="line-removed">1074 </span>
<span class="line-removed">1075     if (oopDesc::is_valid(o)) {</span>
<span class="line-removed">1076       st-&gt;print(UINT32_FORMAT &quot; is a compressed pointer to object: &quot;, narrow_oop);</span>
<span class="line-removed">1077       o-&gt;print_on(st);</span>
<span class="line-removed">1078       return;</span>
<span class="line-removed">1079     }</span>
<span class="line-removed">1080   }</span>
<span class="line-removed">1081 #endif</span>
<span class="line-removed">1082 </span>
1083   bool accessible = is_readable_pointer(addr);
1084 
1085   // Check if addr is a JNI handle.
1086   if (align_down((intptr_t)addr, sizeof(intptr_t)) != 0 &amp;&amp; accessible) {
1087     if (JNIHandles::is_global_handle((jobject) addr)) {
1088       st-&gt;print_cr(INTPTR_FORMAT &quot; is a global jni handle&quot;, p2i(addr));
1089       return;
1090     }
1091     if (JNIHandles::is_weak_global_handle((jobject) addr)) {
1092       st-&gt;print_cr(INTPTR_FORMAT &quot; is a weak global jni handle&quot;, p2i(addr));
1093       return;
1094     }
1095 #ifndef PRODUCT
1096     // we don&#39;t keep the block list in product mode
1097     if (JNIHandles::is_local_handle((jobject) addr)) {
1098       st-&gt;print_cr(INTPTR_FORMAT &quot; is a local jni handle&quot;, p2i(addr));
1099       return;
1100     }
1101 #endif
1102   }
</pre>
<hr />
<pre>
1124 
1125   // Check if in metaspace and print types that have vptrs
1126   if (Metaspace::contains(addr)) {
1127     if (Klass::is_valid((Klass*)addr)) {
1128       st-&gt;print_cr(INTPTR_FORMAT &quot; is a pointer to class: &quot;, p2i(addr));
1129       ((Klass*)addr)-&gt;print_on(st);
1130     } else if (Method::is_valid_method((const Method*)addr)) {
1131       ((Method*)addr)-&gt;print_value_on(st);
1132       st-&gt;cr();
1133     } else {
1134       // Use addr-&gt;print() from the debugger instead (not here)
1135       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into metadata&quot;, p2i(addr));
1136     }
1137     return;
1138   }
1139 
1140   // Compressed klass needs to be decoded first.
1141 #ifdef _LP64
1142   if (UseCompressedClassPointers &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {
1143     narrowKlass narrow_klass = (narrowKlass)(uintptr_t)addr;
<span class="line-modified">1144     Klass* k = Klass::decode_klass_raw(narrow_klass);</span>
1145 
1146     if (Klass::is_valid(k)) {
1147       st-&gt;print_cr(UINT32_FORMAT &quot; is a compressed pointer to class: &quot; INTPTR_FORMAT, narrow_klass, p2i((HeapWord*)k));
1148       k-&gt;print_on(st);
1149       return;
1150     }
1151   }
1152 #endif
1153 
1154   // Try an OS specific find
1155   if (os::find(addr, st)) {
1156     return;
1157   }
1158 
1159   if (accessible) {
1160     st-&gt;print(INTPTR_FORMAT &quot; points into unknown readable memory:&quot;, p2i(addr));
1161     for (address p = addr; p &lt; align_up(addr + 1, sizeof(intptr_t)); ++p) {
1162       st-&gt;print(&quot; %02x&quot;, *(u1*)p);
1163     }
1164     st-&gt;cr();
</pre>
<hr />
<pre>
1207 // Set up the boot classpath.
1208 
1209 char* os::format_boot_path(const char* format_string,
1210                            const char* home,
1211                            int home_len,
1212                            char fileSep,
1213                            char pathSep) {
1214     assert((fileSep == &#39;/&#39; &amp;&amp; pathSep == &#39;:&#39;) ||
1215            (fileSep == &#39;\\&#39; &amp;&amp; pathSep == &#39;;&#39;), &quot;unexpected separator chars&quot;);
1216 
1217     // Scan the format string to determine the length of the actual
1218     // boot classpath, and handle platform dependencies as well.
1219     int formatted_path_len = 0;
1220     const char* p;
1221     for (p = format_string; *p != 0; ++p) {
1222         if (*p == &#39;%&#39;) formatted_path_len += home_len - 1;
1223         ++formatted_path_len;
1224     }
1225 
1226     char* formatted_path = NEW_C_HEAP_ARRAY(char, formatted_path_len + 1, mtInternal);
<span class="line-removed">1227     if (formatted_path == NULL) {</span>
<span class="line-removed">1228         return NULL;</span>
<span class="line-removed">1229     }</span>
1230 
1231     // Create boot classpath from format, substituting separator chars and
1232     // java home directory.
1233     char* q = formatted_path;
1234     for (p = format_string; *p != 0; ++p) {
1235         switch (*p) {
1236         case &#39;%&#39;:
1237             strcpy(q, home);
1238             q += home_len;
1239             break;
1240         case &#39;/&#39;:
1241             *q++ = fileSep;
1242             break;
1243         case &#39;:&#39;:
1244             *q++ = pathSep;
1245             break;
1246         default:
1247             *q++ = *p;
1248         }
1249     }
</pre>
<hr />
<pre>
1293   if (has_jimage) {
1294     Arguments::set_sysclasspath(jimage, true);
1295     FREE_C_HEAP_ARRAY(char, jimage);
1296     return true;
1297   }
1298   FREE_C_HEAP_ARRAY(char, jimage);
1299 
1300   // check if developer build with exploded modules
1301   char* base_classes = format_boot_path(&quot;%/modules/&quot; JAVA_BASE_NAME, home, home_len, fileSep, pathSep);
1302   if (base_classes == NULL) return false;
1303   if (os::stat(base_classes, &amp;st) == 0) {
1304     Arguments::set_sysclasspath(base_classes, false);
1305     FREE_C_HEAP_ARRAY(char, base_classes);
1306     return true;
1307   }
1308   FREE_C_HEAP_ARRAY(char, base_classes);
1309 
1310   return false;
1311 }
1312 
<span class="line-modified">1313 /*</span>
<span class="line-modified">1314  * Splits a path, based on its separator, the number of</span>
<span class="line-modified">1315  * elements is returned back in n.</span>
<span class="line-modified">1316  * It is the callers responsibility to:</span>
<span class="line-modified">1317  *   a&gt; check the value of n, and n may be 0.</span>
<span class="line-modified">1318  *   b&gt; ignore any empty path elements</span>
<span class="line-modified">1319  *   c&gt; free up the data.</span>
<span class="line-modified">1320  */</span>
<span class="line-modified">1321 char** os::split_path(const char* path, int* n) {</span>
<span class="line-modified">1322   *n = 0;</span>
<span class="line-modified">1323   if (path == NULL || strlen(path) == 0) {</span>





1324     return NULL;
1325   }
1326   const char psepchar = *os::path_separator();
<span class="line-modified">1327   char* inpath = (char*)NEW_C_HEAP_ARRAY(char, strlen(path) + 1, mtInternal);</span>
<span class="line-removed">1328   if (inpath == NULL) {</span>
<span class="line-removed">1329     return NULL;</span>
<span class="line-removed">1330   }</span>
1331   strcpy(inpath, path);
<span class="line-modified">1332   int count = 1;</span>
1333   char* p = strchr(inpath, psepchar);
1334   // Get a count of elements to allocate memory
1335   while (p != NULL) {
1336     count++;
1337     p++;
1338     p = strchr(p, psepchar);
1339   }
<span class="line-modified">1340   char** opath = (char**) NEW_C_HEAP_ARRAY(char*, count, mtInternal);</span>
<span class="line-modified">1341   if (opath == NULL) {</span>
<span class="line-removed">1342     return NULL;</span>
<span class="line-removed">1343   }</span>
1344 
1345   // do the actual splitting
1346   p = inpath;
<span class="line-modified">1347   for (int i = 0 ; i &lt; count ; i++) {</span>
1348     size_t len = strcspn(p, os::path_separator());
<span class="line-modified">1349     if (len &gt; JVM_MAXPATHLEN) {</span>
<span class="line-modified">1350       return NULL;</span>




1351     }
1352     // allocate the string and add terminator storage
<span class="line-modified">1353     char* s  = (char*)NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);</span>
<span class="line-removed">1354     if (s == NULL) {</span>
<span class="line-removed">1355       return NULL;</span>
<span class="line-removed">1356     }</span>
1357     strncpy(s, p, len);
1358     s[len] = &#39;\0&#39;;
1359     opath[i] = s;
1360     p += len + 1;
1361   }
1362   FREE_C_HEAP_ARRAY(char, inpath);
<span class="line-modified">1363   *n = count;</span>
1364   return opath;
1365 }
1366 
1367 // Returns true if the current stack pointer is above the stack shadow
1368 // pages, false otherwise.
1369 bool os::stack_shadow_pages_available(Thread *thread, const methodHandle&amp; method, address sp) {
1370   if (!thread-&gt;is_Java_thread()) return false;
1371   // Check if we have StackShadowPages above the yellow zone.  This parameter
1372   // is dependent on the depth of the maximum VM call stack possible from
1373   // the handler for stack overflow.  &#39;instanceof&#39; in the stack overflow
1374   // handler or a println uses at least 8k stack of VM and native code
1375   // respectively.
1376   const int framesize_in_bytes =
1377     Interpreter::size_top_interpreter_activation(method()) * wordSize;
1378 
1379   address limit = ((JavaThread*)thread)-&gt;stack_end() +
1380                   (JavaThread::stack_guard_zone_size() + JavaThread::stack_shadow_zone_size());
1381 
1382   return sp &gt; (limit + framesize_in_bytes);
1383 }
</pre>
<hr />
<pre>
1797     result = pd_unmap_memory(addr, bytes);
1798   }
1799   return result;
1800 }
1801 
1802 void os::free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1803   pd_free_memory(addr, bytes, alignment_hint);
1804 }
1805 
1806 void os::realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1807   pd_realign_memory(addr, bytes, alignment_hint);
1808 }
1809 
1810 #ifndef _WINDOWS
1811 /* try to switch state from state &quot;from&quot; to state &quot;to&quot;
1812  * returns the state set after the method is complete
1813  */
1814 os::SuspendResume::State os::SuspendResume::switch_state(os::SuspendResume::State from,
1815                                                          os::SuspendResume::State to)
1816 {
<span class="line-modified">1817   os::SuspendResume::State result = Atomic::cmpxchg(to, &amp;_state, from);</span>
1818   if (result == from) {
1819     // success
1820     return to;
1821   }
1822   return result;
1823 }
1824 #endif












</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/javaClasses.hpp&quot;
  29 #include &quot;classfile/moduleEntry.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;code/codeCache.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/vtableStubs.hpp&quot;
  35 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;logging/logStream.hpp&quot;
  40 #include &quot;memory/allocation.inline.hpp&quot;

  41 #include &quot;memory/guardedMemory.hpp&quot;

  42 #include &quot;memory/resourceArea.hpp&quot;
<span class="line-added">  43 #include &quot;memory/universe.hpp&quot;</span>
<span class="line-added">  44 #include &quot;oops/compressedOops.inline.hpp&quot;</span>
  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;prims/jvm_misc.hpp&quot;
  47 #include &quot;runtime/arguments.hpp&quot;
  48 #include &quot;runtime/atomic.hpp&quot;
  49 #include &quot;runtime/frame.inline.hpp&quot;
  50 #include &quot;runtime/handles.inline.hpp&quot;
  51 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/os.inline.hpp&quot;
  56 #include &quot;runtime/sharedRuntime.hpp&quot;
  57 #include &quot;runtime/stubRoutines.hpp&quot;
  58 #include &quot;runtime/thread.inline.hpp&quot;
  59 #include &quot;runtime/threadSMR.hpp&quot;
  60 #include &quot;runtime/vm_version.hpp&quot;
  61 #include &quot;services/attachListener.hpp&quot;
  62 #include &quot;services/mallocTracker.hpp&quot;
  63 #include &quot;services/memTracker.hpp&quot;
  64 #include &quot;services/nmtCommon.hpp&quot;
</pre>
<hr />
<pre>
  71 # include &lt;errno.h&gt;
  72 
  73 OSThread*         os::_starting_thread    = NULL;
  74 address           os::_polling_page       = NULL;
  75 volatile unsigned int os::_rand_seed      = 1;
  76 int               os::_processor_count    = 0;
  77 int               os::_initial_active_processor_count = 0;
  78 size_t            os::_page_sizes[os::page_sizes_max];
  79 
  80 #ifndef PRODUCT
  81 julong os::num_mallocs = 0;         // # of calls to malloc/realloc
  82 julong os::alloc_bytes = 0;         // # of bytes allocated
  83 julong os::num_frees = 0;           // # of calls to free
  84 julong os::free_bytes = 0;          // # of bytes freed
  85 #endif
  86 
  87 static size_t cur_malloc_words = 0;  // current size for MallocMaxTestWords
  88 
  89 DEBUG_ONLY(bool os::_mutex_init_done = false;)
  90 






  91 static time_t get_timezone(const struct tm* time_struct) {
  92 #if defined(_ALLBSD_SOURCE)
  93   return time_struct-&gt;tm_gmtoff;
  94 #elif defined(_WINDOWS)
  95   long zone;
  96   _get_timezone(&amp;zone);
  97   return static_cast&lt;time_t&gt;(zone);
  98 #else
  99   return timezone;
 100 #endif
 101 }
 102 
 103 int os::snprintf(char* buf, size_t len, const char* fmt, ...) {
 104   va_list args;
 105   va_start(args, fmt);
 106   int result = os::vsnprintf(buf, len, fmt, args);
 107   va_end(args);
 108   return result;
 109 }
 110 
</pre>
<hr />
<pre>
 256 
 257 // Helper for dll_locate_lib.
 258 // Pass buffer and printbuffer as we already printed the path to buffer
 259 // when we called get_current_directory. This way we avoid another buffer
 260 // of size MAX_PATH.
 261 static bool conc_path_file_and_check(char *buffer, char *printbuffer, size_t printbuflen,
 262                                      const char* pname, char lastchar, const char* fname) {
 263 
 264   // Concatenate path and file name, but don&#39;t print double path separators.
 265   const char *filesep = (WINDOWS_ONLY(lastchar == &#39;:&#39; ||) lastchar == os::file_separator()[0]) ?
 266                         &quot;&quot; : os::file_separator();
 267   int ret = jio_snprintf(printbuffer, printbuflen, &quot;%s%s%s&quot;, pname, filesep, fname);
 268   // Check whether file exists.
 269   if (ret != -1) {
 270     struct stat statbuf;
 271     return os::stat(buffer, &amp;statbuf) == 0;
 272   }
 273   return false;
 274 }
 275 
<span class="line-added"> 276 // Frees all memory allocated on the heap for the</span>
<span class="line-added"> 277 // supplied array of arrays of chars (a), where n</span>
<span class="line-added"> 278 // is the number of elements in the array.</span>
<span class="line-added"> 279 static void free_array_of_char_arrays(char** a, size_t n) {</span>
<span class="line-added"> 280       while (n &gt; 0) {</span>
<span class="line-added"> 281           n--;</span>
<span class="line-added"> 282           if (a[n] != NULL) {</span>
<span class="line-added"> 283             FREE_C_HEAP_ARRAY(char, a[n]);</span>
<span class="line-added"> 284           }</span>
<span class="line-added"> 285       }</span>
<span class="line-added"> 286       FREE_C_HEAP_ARRAY(char*, a);</span>
<span class="line-added"> 287 }</span>
<span class="line-added"> 288 </span>
 289 bool os::dll_locate_lib(char *buffer, size_t buflen,
 290                         const char* pname, const char* fname) {
 291   bool retval = false;
 292 
 293   size_t fullfnamelen = strlen(JNI_LIB_PREFIX) + strlen(fname) + strlen(JNI_LIB_SUFFIX);
<span class="line-modified"> 294   char* fullfname = NEW_C_HEAP_ARRAY(char, fullfnamelen + 1, mtInternal);</span>
 295   if (dll_build_name(fullfname, fullfnamelen + 1, fname)) {
 296     const size_t pnamelen = pname ? strlen(pname) : 0;
 297 
 298     if (pnamelen == 0) {
 299       // If no path given, use current working directory.
 300       const char* p = get_current_directory(buffer, buflen);
 301       if (p != NULL) {
 302         const size_t plen = strlen(buffer);
 303         const char lastchar = buffer[plen - 1];
 304         retval = conc_path_file_and_check(buffer, &amp;buffer[plen], buflen - plen,
 305                                           &quot;&quot;, lastchar, fullfname);
 306       }
 307     } else if (strchr(pname, *os::path_separator()) != NULL) {
 308       // A list of paths. Search for the path that contains the library.
<span class="line-modified"> 309       size_t n;</span>
<span class="line-modified"> 310       char** pelements = split_path(pname, &amp;n, fullfnamelen);</span>
 311       if (pelements != NULL) {
<span class="line-modified"> 312         for (size_t i = 0; i &lt; n; i++) {</span>
 313           char* path = pelements[i];
 314           // Really shouldn&#39;t be NULL, but check can&#39;t hurt.
 315           size_t plen = (path == NULL) ? 0 : strlen(path);
 316           if (plen == 0) {
 317             continue; // Skip the empty path values.
 318           }
 319           const char lastchar = path[plen - 1];
 320           retval = conc_path_file_and_check(buffer, buffer, buflen, path, lastchar, fullfname);
 321           if (retval) break;
 322         }
 323         // Release the storage allocated by split_path.
<span class="line-modified"> 324         free_array_of_char_arrays(pelements, n);</span>





 325       }
 326     } else {
 327       // A definite path.
 328       const char lastchar = pname[pnamelen-1];
 329       retval = conc_path_file_and_check(buffer, buffer, buflen, pname, lastchar, fullfname);
 330     }
 331   }
 332 
 333   FREE_C_HEAP_ARRAY(char*, fullfname);
 334   return retval;
 335 }
 336 
 337 // --------------------- sun.misc.Signal (optional) ---------------------
 338 
 339 
 340 // SIGBREAK is sent by the keyboard to query the VM state
 341 #ifndef SIGBREAK
 342 #define SIGBREAK SIGQUIT
 343 #endif
 344 
 345 // sigexitnum_pd is a platform-specific special signal used for terminating the Signal thread.
 346 
 347 
 348 static void signal_thread_entry(JavaThread* thread, TRAPS) {
 349   os::set_priority(thread, NearMaxPriority);
 350   while (true) {
 351     int sig;
 352     {
 353       // FIXME : Currently we have not decided what should be the status
 354       //         for this java thread blocked here. Once we decide about
 355       //         that we should fix this.
 356       sig = os::signal_wait();
 357     }
 358     if (sig == os::sigexitnum_pd()) {
 359        // Terminate the signal thread
 360        return;
 361     }
 362 
 363     switch (sig) {
 364       case SIGBREAK: {
<span class="line-added"> 365 #if INCLUDE_SERVICES</span>
 366         // Check if the signal is a trigger to start the Attach Listener - in that
 367         // case don&#39;t print stack traces.
<span class="line-modified"> 368         if (!DisableAttachMechanism) {</span>
<span class="line-modified"> 369           // Attempt to transit state to AL_INITIALIZING.</span>
<span class="line-added"> 370           AttachListenerState cur_state = AttachListener::transit_state(AL_INITIALIZING, AL_NOT_INITIALIZED);</span>
<span class="line-added"> 371           if (cur_state == AL_INITIALIZING) {</span>
<span class="line-added"> 372             // Attach Listener has been started to initialize. Ignore this signal.</span>
<span class="line-added"> 373             continue;</span>
<span class="line-added"> 374           } else if (cur_state == AL_NOT_INITIALIZED) {</span>
<span class="line-added"> 375             // Start to initialize.</span>
<span class="line-added"> 376             if (AttachListener::is_init_trigger()) {</span>
<span class="line-added"> 377               // Attach Listener has been initialized.</span>
<span class="line-added"> 378               // Accept subsequent request.</span>
<span class="line-added"> 379               continue;</span>
<span class="line-added"> 380             } else {</span>
<span class="line-added"> 381               // Attach Listener could not be started.</span>
<span class="line-added"> 382               // So we need to transit the state to AL_NOT_INITIALIZED.</span>
<span class="line-added"> 383               AttachListener::set_state(AL_NOT_INITIALIZED);</span>
<span class="line-added"> 384             }</span>
<span class="line-added"> 385           } else if (AttachListener::check_socket_file()) {</span>
<span class="line-added"> 386             // Attach Listener has been started, but unix domain socket file</span>
<span class="line-added"> 387             // does not exist. So restart Attach Listener.</span>
<span class="line-added"> 388             continue;</span>
<span class="line-added"> 389           }</span>
 390         }
<span class="line-added"> 391 #endif</span>
 392         // Print stack traces
 393         // Any SIGBREAK operations added here should make sure to flush
 394         // the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.
 395         // Each module also prints an extra carriage return after its output.
 396         VM_PrintThreads op;
 397         VMThread::execute(&amp;op);
 398         VM_PrintJNI jni_op;
 399         VMThread::execute(&amp;jni_op);
 400         VM_FindDeadlocks op1(tty);
 401         VMThread::execute(&amp;op1);
 402         Universe::print_heap_at_SIGBREAK();
 403         if (PrintClassHistogram) {
 404           VM_GC_HeapInspection op1(tty, true /* force full GC before heap inspection */);
 405           VMThread::execute(&amp;op1);
 406         }
 407         if (JvmtiExport::should_post_data_dump()) {
 408           JvmtiExport::post_data_dump();
 409         }
 410         break;
 411       }
</pre>
<hr />
<pre>
 475     Handle string = java_lang_String::create_from_str(thread_name, CHECK);
 476 
 477     // Initialize thread_oop to put it into the system threadGroup
 478     Handle thread_group (THREAD, Universe::system_thread_group());
 479     Handle thread_oop = JavaCalls::construct_new_instance(SystemDictionary::Thread_klass(),
 480                            vmSymbols::threadgroup_string_void_signature(),
 481                            thread_group,
 482                            string,
 483                            CHECK);
 484 
 485     Klass* group = SystemDictionary::ThreadGroup_klass();
 486     JavaValue result(T_VOID);
 487     JavaCalls::call_special(&amp;result,
 488                             thread_group,
 489                             group,
 490                             vmSymbols::add_method_name(),
 491                             vmSymbols::thread_void_signature(),
 492                             thread_oop,
 493                             CHECK);
 494 
<span class="line-modified"> 495     { MutexLocker mu(THREAD, Threads_lock);</span>
 496       JavaThread* signal_thread = new JavaThread(&amp;signal_thread_entry);
 497 
 498       // At this point it may be possible that no osthread was created for the
 499       // JavaThread due to lack of memory. We would have to throw an exception
 500       // in that case. However, since this must work and we do not allow
 501       // exceptions anyway, check and abort if this fails.
 502       if (signal_thread == NULL || signal_thread-&gt;osthread() == NULL) {
 503         vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 504                                       os::native_thread_creation_failed_msg());
 505       }
 506 
 507       java_lang_Thread::set_thread(thread_oop(), signal_thread);
 508       java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 509       java_lang_Thread::set_daemon(thread_oop());
 510 
 511       signal_thread-&gt;set_threadObj(thread_oop());
 512       Threads::add(signal_thread);
 513       Thread::start(signal_thread);
 514     }
 515     // Handle ^BREAK
</pre>
<hr />
<pre>
 519 
 520 
 521 void os::terminate_signal_thread() {
 522   if (!ReduceSignalUsage)
 523     signal_notify(sigexitnum_pd());
 524 }
 525 
 526 
 527 // --------------------- loading libraries ---------------------
 528 
 529 typedef jint (JNICALL *JNI_OnLoad_t)(JavaVM *, void *);
 530 extern struct JavaVM_ main_vm;
 531 
 532 static void* _native_java_library = NULL;
 533 
 534 void* os::native_java_library() {
 535   if (_native_java_library == NULL) {
 536     char buffer[JVM_MAXPATHLEN];
 537     char ebuf[1024];
 538 








 539     // Load java dll
 540     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 541                        &quot;java&quot;)) {
 542       _native_java_library = dll_load(buffer, ebuf, sizeof(ebuf));
 543     }
 544     if (_native_java_library == NULL) {
 545       vm_exit_during_initialization(&quot;Unable to load native library&quot;, ebuf);
 546     }
 547 
 548 #if defined(__OpenBSD__)
 549     // Work-around OpenBSD&#39;s lack of $ORIGIN support by pre-loading libnet.so
 550     // ignore errors
 551     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 552                        &quot;net&quot;)) {
 553       dll_load(buffer, ebuf, sizeof(ebuf));
 554     }
 555 #endif
 556   }
 557   return _native_java_library;
 558 }
</pre>
<hr />
<pre>
 651     ls.print_cr(&quot;## nof_mallocs = &quot; UINT64_FORMAT &quot;, nof_frees = &quot; UINT64_FORMAT, os::num_mallocs, os::num_frees);
 652     ls.print_cr(&quot;## memory stomp:&quot;);
 653     guarded.print_on(&amp;ls);
 654     fatal(&quot;memory stomping error&quot;);
 655   }
 656 }
 657 
 658 #endif
 659 
 660 //
 661 // This function supports testing of the malloc out of memory
 662 // condition without really running the system out of memory.
 663 //
 664 static bool has_reached_max_malloc_test_peak(size_t alloc_size) {
 665   if (MallocMaxTestWords &gt; 0) {
 666     size_t words = (alloc_size / BytesPerWord);
 667 
 668     if ((cur_malloc_words + words) &gt; MallocMaxTestWords) {
 669       return true;
 670     }
<span class="line-modified"> 671     Atomic::add(&amp;cur_malloc_words, words);</span>
 672   }
 673   return false;
 674 }
 675 
 676 void* os::malloc(size_t size, MEMFLAGS flags) {
 677   return os::malloc(size, flags, CALLER_PC);
 678 }
 679 
 680 void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 681   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 682   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 683 
 684   // Since os::malloc can be called when the libjvm.{dll,so} is
 685   // first loaded and we don&#39;t have a thread yet we must accept NULL also here.
 686   assert(!os::ThreadCrashProtection::is_crash_protected(Thread::current_or_null()),
 687          &quot;malloc() not allowed when crash protection is set&quot;);
 688 
 689   if (size == 0) {
 690     // return a valid pointer if size is zero
 691     // if NULL is returned the calling functions assume out of memory.
</pre>
<hr />
<pre>
 703   if (size + nmt_header_size &gt; alloc_size) { // Check for rollover.
 704     return NULL;
 705   }
 706 #endif
 707 
 708   // For the test flag -XX:MallocMaxTestWords
 709   if (has_reached_max_malloc_test_peak(size)) {
 710     return NULL;
 711   }
 712 
 713   u_char* ptr;
 714   ptr = (u_char*)::malloc(alloc_size);
 715 
 716 #ifdef ASSERT
 717   if (ptr == NULL) {
 718     return NULL;
 719   }
 720   // Wrap memory with guard
 721   GuardedMemory guarded(ptr, size + nmt_header_size);
 722   ptr = guarded.get_user_ptr();
<span class="line-modified"> 723 </span>
 724   if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {
 725     log_warning(malloc, free)(&quot;os::malloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));
 726     breakpoint();
 727   }
<span class="line-modified"> 728   if (paranoid) {</span>
<span class="line-added"> 729     verify_memory(ptr);</span>
<span class="line-added"> 730   }</span>
<span class="line-added"> 731 #endif</span>
 732 
 733   // we do not track guard memory
 734   return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);
 735 }
 736 
 737 void* os::realloc(void *memblock, size_t size, MEMFLAGS flags) {
 738   return os::realloc(memblock, size, flags, CALLER_PC);
 739 }
 740 
 741 void* os::realloc(void *memblock, size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 742 
 743   // For the test flag -XX:MallocMaxTestWords
 744   if (has_reached_max_malloc_test_peak(size)) {
 745     return NULL;
 746   }
 747 
 748   if (size == 0) {
 749     // return a valid pointer if size is zero
 750     // if NULL is returned the calling functions assume out of memory.
 751     size = 1;
 752   }
 753 
 754 #ifndef ASSERT
 755   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 756   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 757    // NMT support

 758   NMT_TrackingLevel level = MemTracker::tracking_level();
<span class="line-added"> 759   void* membase = MemTracker::record_free(memblock, level);</span>
 760   size_t  nmt_header_size = MemTracker::malloc_header_size(level);
 761   void* ptr = ::realloc(membase, size + nmt_header_size);
 762   return MemTracker::record_malloc(ptr, size, memflags, stack, level);
 763 #else
 764   if (memblock == NULL) {
 765     return os::malloc(size, memflags, stack);
 766   }
 767   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 768     log_warning(malloc, free)(&quot;os::realloc caught &quot; PTR_FORMAT, p2i(memblock));
 769     breakpoint();
 770   }
 771   // NMT support
 772   void* membase = MemTracker::malloc_base(memblock);
 773   verify_memory(membase);
 774   // always move the block
 775   void* ptr = os::malloc(size, memflags, stack);
 776   // Copy to new memory if malloc didn&#39;t fail
 777   if (ptr != NULL ) {
 778     GuardedMemory guarded(MemTracker::malloc_base(memblock));
 779     // Guard&#39;s user data contains NMT header
 780     size_t memblock_size = guarded.get_user_size() - MemTracker::malloc_header_size(memblock);
 781     memcpy(ptr, memblock, MIN2(size, memblock_size));
<span class="line-modified"> 782     if (paranoid) {</span>
<span class="line-modified"> 783       verify_memory(MemTracker::malloc_base(ptr));</span>


 784     }
 785     os::free(memblock);
 786   }
 787   return ptr;
 788 #endif
 789 }
 790 
<span class="line-modified"> 791 // handles NULL pointers</span>
 792 void  os::free(void *memblock) {
 793   NOT_PRODUCT(inc_stat_counter(&amp;num_frees, 1));
 794 #ifdef ASSERT
 795   if (memblock == NULL) return;
 796   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 797     log_warning(malloc, free)(&quot;os::free caught &quot; PTR_FORMAT, p2i(memblock));
 798     breakpoint();
 799   }
<span class="line-modified"> 800   void* membase = MemTracker::record_free(memblock, MemTracker::tracking_level());</span>
 801   verify_memory(membase);
 802 
 803   GuardedMemory guarded(membase);
 804   size_t size = guarded.get_user_size();
 805   inc_stat_counter(&amp;free_bytes, size);
 806   membase = guarded.release_for_freeing();
 807   ::free(membase);
 808 #else
<span class="line-modified"> 809   void* membase = MemTracker::record_free(memblock, MemTracker::tracking_level());</span>
 810   ::free(membase);
 811 #endif
 812 }
 813 
 814 void os::init_random(unsigned int initval) {
 815   _rand_seed = initval;
 816 }
 817 
 818 
 819 static int random_helper(unsigned int rand_seed) {
 820   /* standard, well-known linear congruential random generator with
 821    * next_rand = (16807*seed) mod (2**31-1)
 822    * see
 823    * (1) &quot;Random Number Generators: Good Ones Are Hard to Find&quot;,
 824    *      S.K. Park and K.W. Miller, Communications of the ACM 31:10 (Oct 1988),
 825    * (2) &quot;Two Fast Implementations of the &#39;Minimal Standard&#39; Random
 826    *     Number Generator&quot;, David G. Carta, Comm. ACM 33, 1 (Jan 1990), pp. 87-88.
 827   */
 828   const unsigned int a = 16807;
 829   const unsigned int m = 2147483647;
</pre>
<hr />
<pre>
 838   // if q overflowed, ignore the overflow and increment q
 839   if (lo &gt; m) {
 840     lo &amp;= m;
 841     ++lo;
 842   }
 843   lo += hi &gt;&gt; 15;
 844 
 845   // if (p+q) overflowed, ignore the overflow and increment (p+q)
 846   if (lo &gt; m) {
 847     lo &amp;= m;
 848     ++lo;
 849   }
 850   return lo;
 851 }
 852 
 853 int os::random() {
 854   // Make updating the random seed thread safe.
 855   while (true) {
 856     unsigned int seed = _rand_seed;
 857     unsigned int rand = random_helper(seed);
<span class="line-modified"> 858     if (Atomic::cmpxchg(&amp;_rand_seed, seed, rand) == seed) {</span>
 859       return static_cast&lt;int&gt;(rand);
 860     }
 861   }
 862 }
 863 
 864 // The INITIALIZED state is distinguished from the SUSPENDED state because the
 865 // conditions in which a thread is first started are different from those in which
 866 // a suspension is resumed.  These differences make it hard for us to apply the
 867 // tougher checks when starting threads that we want to do when resuming them.
 868 // However, when start_thread is called as a result of Thread.start, on a Java
 869 // thread, the operation is synchronized on the Java Thread object.  So there
 870 // cannot be a race to start the thread and hence for the thread to exit while
 871 // we are working on it.  Non-Java threads that start Java threads either have
 872 // to do so in a context in which races are impossible, or should do appropriate
 873 // locking.
 874 
 875 void os::start_thread(Thread* thread) {
 876   // guard suspend/resume
<span class="line-modified"> 877   MutexLocker ml(thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);</span>
 878   OSThread* osthread = thread-&gt;osthread();
 879   osthread-&gt;set_state(RUNNABLE);
 880   pd_start_thread(thread);
 881 }
 882 
 883 void os::abort(bool dump_core) {
 884   abort(dump_core &amp;&amp; CreateCoredumpOnCrash, NULL, NULL);
 885 }
 886 
 887 //---------------------------------------------------------------------------
 888 // Helper functions for fatal error handler
 889 
 890 void os::print_hex_dump(outputStream* st, address start, address end, int unitsize) {
 891   assert(unitsize == 1 || unitsize == 2 || unitsize == 4 || unitsize == 8, &quot;just checking&quot;);
 892 
 893   start = align_down(start, unitsize);
 894 
 895   int cols = 0;
 896   int cols_per_line = 0;
 897   switch (unitsize) {
</pre>
<hr />
<pre>
 911         case 2: st-&gt;print(&quot;%04x&quot;, *(u2*)p); break;
 912         case 4: st-&gt;print(&quot;%08x&quot;, *(u4*)p); break;
 913         case 8: st-&gt;print(&quot;%016&quot; FORMAT64_MODIFIER &quot;x&quot;, *(u8*)p); break;
 914       }
 915     } else {
 916       st-&gt;print(&quot;%*.*s&quot;, 2*unitsize, 2*unitsize, &quot;????????????????&quot;);
 917     }
 918     p += unitsize;
 919     cols++;
 920     if (cols &gt;= cols_per_line &amp;&amp; p &lt; end) {
 921        cols = 0;
 922        st-&gt;cr();
 923        st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(p));
 924     } else {
 925        st-&gt;print(&quot; &quot;);
 926     }
 927   }
 928   st-&gt;cr();
 929 }
 930 
<span class="line-added"> 931 void os::print_dhm(outputStream* st, const char* startStr, long sec) {</span>
<span class="line-added"> 932   long days    = sec/86400;</span>
<span class="line-added"> 933   long hours   = (sec/3600) - (days * 24);</span>
<span class="line-added"> 934   long minutes = (sec/60) - (days * 1440) - (hours * 60);</span>
<span class="line-added"> 935   if (startStr == NULL) startStr = &quot;&quot;;</span>
<span class="line-added"> 936   st-&gt;print_cr(&quot;%s %ld days %ld:%02ld hours&quot;, startStr, days, hours, minutes);</span>
<span class="line-added"> 937 }</span>
<span class="line-added"> 938 </span>
 939 void os::print_instructions(outputStream* st, address pc, int unitsize) {
 940   st-&gt;print_cr(&quot;Instructions: (pc=&quot; PTR_FORMAT &quot;)&quot;, p2i(pc));
 941   print_hex_dump(st, pc - 256, pc + 256, unitsize);
 942 }
 943 
 944 void os::print_environment_variables(outputStream* st, const char** env_list) {
 945   if (env_list) {
 946     st-&gt;print_cr(&quot;Environment Variables:&quot;);
 947 
 948     for (int i = 0; env_list[i] != NULL; i++) {
 949       char *envvar = ::getenv(env_list[i]);
 950       if (envvar != NULL) {
 951         st-&gt;print(&quot;%s&quot;, env_list[i]);
 952         st-&gt;print(&quot;=&quot;);
 953         st-&gt;print_cr(&quot;%s&quot;, envvar);
 954       }
 955     }
 956   }
 957 }
 958 
</pre>
<hr />
<pre>
1031   int elsecs = (eltime - day_secs - hour_secs - minute_secs);
1032   st-&gt;print_cr(&quot; elapsed time: %d seconds (%dd %dh %dm %ds)&quot;, eltime, eldays, elhours, elmins, elsecs);
1033 }
1034 
1035 
1036 // Check if pointer can be read from (4-byte read access).
1037 // Helps to prove validity of a not-NULL pointer.
1038 // Returns true in very early stages of VM life when stub is not yet generated.
1039 #define SAFEFETCH_DEFAULT true
1040 bool os::is_readable_pointer(const void* p) {
1041   if (!CanUseSafeFetch32()) {
1042     return SAFEFETCH_DEFAULT;
1043   }
1044   int* const aligned = (int*) align_down((intptr_t)p, 4);
1045   int cafebabe = 0xcafebabe;  // tester value 1
1046   int deadbeef = 0xdeadbeef;  // tester value 2
1047   return (SafeFetch32(aligned, cafebabe) != cafebabe) || (SafeFetch32(aligned, deadbeef) != deadbeef);
1048 }
1049 
1050 bool os::is_readable_range(const void* from, const void* to) {
<span class="line-modified">1051   if ((uintptr_t)from &gt;= (uintptr_t)to) return false;</span>
<span class="line-modified">1052   for (uintptr_t p = align_down((uintptr_t)from, min_page_size()); p &lt; (uintptr_t)to; p += min_page_size()) {</span>
<span class="line-added">1053     if (!is_readable_pointer((const void*)p)) {</span>
1054       return false;
1055     }
1056   }
1057   return true;
1058 }
1059 
1060 
1061 // moved from debug.cpp (used to be find()) but still called from there
1062 // The verbose parameter is only set by the debug code in one case
1063 void os::print_location(outputStream* st, intptr_t x, bool verbose) {
1064   address addr = (address)x;
1065   // Handle NULL first, so later checks don&#39;t need to protect against it.
1066   if (addr == NULL) {
1067     st-&gt;print_cr(&quot;0x0 is NULL&quot;);
1068     return;
1069   }
1070 
1071   // Check if addr points into a code blob.
1072   CodeBlob* b = CodeCache::find_blob_unsafe(addr);
1073   if (b != NULL) {
1074     b-&gt;dump_for_addr(addr, st, verbose);
1075     return;
1076   }
1077 
1078   // Check if addr points into Java heap.
<span class="line-modified">1079   if (Universe::heap()-&gt;print_location(st, addr)) {</span>












1080     return;
1081   }
1082 














1083   bool accessible = is_readable_pointer(addr);
1084 
1085   // Check if addr is a JNI handle.
1086   if (align_down((intptr_t)addr, sizeof(intptr_t)) != 0 &amp;&amp; accessible) {
1087     if (JNIHandles::is_global_handle((jobject) addr)) {
1088       st-&gt;print_cr(INTPTR_FORMAT &quot; is a global jni handle&quot;, p2i(addr));
1089       return;
1090     }
1091     if (JNIHandles::is_weak_global_handle((jobject) addr)) {
1092       st-&gt;print_cr(INTPTR_FORMAT &quot; is a weak global jni handle&quot;, p2i(addr));
1093       return;
1094     }
1095 #ifndef PRODUCT
1096     // we don&#39;t keep the block list in product mode
1097     if (JNIHandles::is_local_handle((jobject) addr)) {
1098       st-&gt;print_cr(INTPTR_FORMAT &quot; is a local jni handle&quot;, p2i(addr));
1099       return;
1100     }
1101 #endif
1102   }
</pre>
<hr />
<pre>
1124 
1125   // Check if in metaspace and print types that have vptrs
1126   if (Metaspace::contains(addr)) {
1127     if (Klass::is_valid((Klass*)addr)) {
1128       st-&gt;print_cr(INTPTR_FORMAT &quot; is a pointer to class: &quot;, p2i(addr));
1129       ((Klass*)addr)-&gt;print_on(st);
1130     } else if (Method::is_valid_method((const Method*)addr)) {
1131       ((Method*)addr)-&gt;print_value_on(st);
1132       st-&gt;cr();
1133     } else {
1134       // Use addr-&gt;print() from the debugger instead (not here)
1135       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into metadata&quot;, p2i(addr));
1136     }
1137     return;
1138   }
1139 
1140   // Compressed klass needs to be decoded first.
1141 #ifdef _LP64
1142   if (UseCompressedClassPointers &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {
1143     narrowKlass narrow_klass = (narrowKlass)(uintptr_t)addr;
<span class="line-modified">1144     Klass* k = CompressedKlassPointers::decode_raw(narrow_klass);</span>
1145 
1146     if (Klass::is_valid(k)) {
1147       st-&gt;print_cr(UINT32_FORMAT &quot; is a compressed pointer to class: &quot; INTPTR_FORMAT, narrow_klass, p2i((HeapWord*)k));
1148       k-&gt;print_on(st);
1149       return;
1150     }
1151   }
1152 #endif
1153 
1154   // Try an OS specific find
1155   if (os::find(addr, st)) {
1156     return;
1157   }
1158 
1159   if (accessible) {
1160     st-&gt;print(INTPTR_FORMAT &quot; points into unknown readable memory:&quot;, p2i(addr));
1161     for (address p = addr; p &lt; align_up(addr + 1, sizeof(intptr_t)); ++p) {
1162       st-&gt;print(&quot; %02x&quot;, *(u1*)p);
1163     }
1164     st-&gt;cr();
</pre>
<hr />
<pre>
1207 // Set up the boot classpath.
1208 
1209 char* os::format_boot_path(const char* format_string,
1210                            const char* home,
1211                            int home_len,
1212                            char fileSep,
1213                            char pathSep) {
1214     assert((fileSep == &#39;/&#39; &amp;&amp; pathSep == &#39;:&#39;) ||
1215            (fileSep == &#39;\\&#39; &amp;&amp; pathSep == &#39;;&#39;), &quot;unexpected separator chars&quot;);
1216 
1217     // Scan the format string to determine the length of the actual
1218     // boot classpath, and handle platform dependencies as well.
1219     int formatted_path_len = 0;
1220     const char* p;
1221     for (p = format_string; *p != 0; ++p) {
1222         if (*p == &#39;%&#39;) formatted_path_len += home_len - 1;
1223         ++formatted_path_len;
1224     }
1225 
1226     char* formatted_path = NEW_C_HEAP_ARRAY(char, formatted_path_len + 1, mtInternal);



1227 
1228     // Create boot classpath from format, substituting separator chars and
1229     // java home directory.
1230     char* q = formatted_path;
1231     for (p = format_string; *p != 0; ++p) {
1232         switch (*p) {
1233         case &#39;%&#39;:
1234             strcpy(q, home);
1235             q += home_len;
1236             break;
1237         case &#39;/&#39;:
1238             *q++ = fileSep;
1239             break;
1240         case &#39;:&#39;:
1241             *q++ = pathSep;
1242             break;
1243         default:
1244             *q++ = *p;
1245         }
1246     }
</pre>
<hr />
<pre>
1290   if (has_jimage) {
1291     Arguments::set_sysclasspath(jimage, true);
1292     FREE_C_HEAP_ARRAY(char, jimage);
1293     return true;
1294   }
1295   FREE_C_HEAP_ARRAY(char, jimage);
1296 
1297   // check if developer build with exploded modules
1298   char* base_classes = format_boot_path(&quot;%/modules/&quot; JAVA_BASE_NAME, home, home_len, fileSep, pathSep);
1299   if (base_classes == NULL) return false;
1300   if (os::stat(base_classes, &amp;st) == 0) {
1301     Arguments::set_sysclasspath(base_classes, false);
1302     FREE_C_HEAP_ARRAY(char, base_classes);
1303     return true;
1304   }
1305   FREE_C_HEAP_ARRAY(char, base_classes);
1306 
1307   return false;
1308 }
1309 
<span class="line-modified">1310 // Splits a path, based on its separator, the number of</span>
<span class="line-modified">1311 // elements is returned back in &quot;elements&quot;.</span>
<span class="line-modified">1312 // file_name_length is used as a modifier for each path&#39;s</span>
<span class="line-modified">1313 // length when compared to JVM_MAXPATHLEN. So if you know</span>
<span class="line-modified">1314 // each returned path will have something appended when</span>
<span class="line-modified">1315 // in use, you can pass the length of that in</span>
<span class="line-modified">1316 // file_name_length, to ensure we detect if any path</span>
<span class="line-modified">1317 // exceeds the maximum path length once prepended onto</span>
<span class="line-modified">1318 // the sub-path/file name.</span>
<span class="line-modified">1319 // It is the callers responsibility to:</span>
<span class="line-modified">1320 //   a&gt; check the value of &quot;elements&quot;, which may be 0.</span>
<span class="line-added">1321 //   b&gt; ignore any empty path elements</span>
<span class="line-added">1322 //   c&gt; free up the data.</span>
<span class="line-added">1323 char** os::split_path(const char* path, size_t* elements, size_t file_name_length) {</span>
<span class="line-added">1324   *elements = (size_t)0;</span>
<span class="line-added">1325   if (path == NULL || strlen(path) == 0 || file_name_length == (size_t)NULL) {</span>
1326     return NULL;
1327   }
1328   const char psepchar = *os::path_separator();
<span class="line-modified">1329   char* inpath = NEW_C_HEAP_ARRAY(char, strlen(path) + 1, mtInternal);</span>



1330   strcpy(inpath, path);
<span class="line-modified">1331   size_t count = 1;</span>
1332   char* p = strchr(inpath, psepchar);
1333   // Get a count of elements to allocate memory
1334   while (p != NULL) {
1335     count++;
1336     p++;
1337     p = strchr(p, psepchar);
1338   }
<span class="line-modified">1339 </span>
<span class="line-modified">1340   char** opath = NEW_C_HEAP_ARRAY(char*, count, mtInternal);</span>


1341 
1342   // do the actual splitting
1343   p = inpath;
<span class="line-modified">1344   for (size_t i = 0 ; i &lt; count ; i++) {</span>
1345     size_t len = strcspn(p, os::path_separator());
<span class="line-modified">1346     if (len + file_name_length &gt; JVM_MAXPATHLEN) {</span>
<span class="line-modified">1347       // release allocated storage before exiting the vm</span>
<span class="line-added">1348       free_array_of_char_arrays(opath, i++);</span>
<span class="line-added">1349       vm_exit_during_initialization(&quot;The VM tried to use a path that exceeds the maximum path length for &quot;</span>
<span class="line-added">1350                                     &quot;this system. Review path-containing parameters and properties, such as &quot;</span>
<span class="line-added">1351                                     &quot;sun.boot.library.path, to identify potential sources for this path.&quot;);</span>
1352     }
1353     // allocate the string and add terminator storage
<span class="line-modified">1354     char* s = NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);</span>



1355     strncpy(s, p, len);
1356     s[len] = &#39;\0&#39;;
1357     opath[i] = s;
1358     p += len + 1;
1359   }
1360   FREE_C_HEAP_ARRAY(char, inpath);
<span class="line-modified">1361   *elements = count;</span>
1362   return opath;
1363 }
1364 
1365 // Returns true if the current stack pointer is above the stack shadow
1366 // pages, false otherwise.
1367 bool os::stack_shadow_pages_available(Thread *thread, const methodHandle&amp; method, address sp) {
1368   if (!thread-&gt;is_Java_thread()) return false;
1369   // Check if we have StackShadowPages above the yellow zone.  This parameter
1370   // is dependent on the depth of the maximum VM call stack possible from
1371   // the handler for stack overflow.  &#39;instanceof&#39; in the stack overflow
1372   // handler or a println uses at least 8k stack of VM and native code
1373   // respectively.
1374   const int framesize_in_bytes =
1375     Interpreter::size_top_interpreter_activation(method()) * wordSize;
1376 
1377   address limit = ((JavaThread*)thread)-&gt;stack_end() +
1378                   (JavaThread::stack_guard_zone_size() + JavaThread::stack_shadow_zone_size());
1379 
1380   return sp &gt; (limit + framesize_in_bytes);
1381 }
</pre>
<hr />
<pre>
1795     result = pd_unmap_memory(addr, bytes);
1796   }
1797   return result;
1798 }
1799 
1800 void os::free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1801   pd_free_memory(addr, bytes, alignment_hint);
1802 }
1803 
1804 void os::realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1805   pd_realign_memory(addr, bytes, alignment_hint);
1806 }
1807 
1808 #ifndef _WINDOWS
1809 /* try to switch state from state &quot;from&quot; to state &quot;to&quot;
1810  * returns the state set after the method is complete
1811  */
1812 os::SuspendResume::State os::SuspendResume::switch_state(os::SuspendResume::State from,
1813                                                          os::SuspendResume::State to)
1814 {
<span class="line-modified">1815   os::SuspendResume::State result = Atomic::cmpxchg(&amp;_state, from, to);</span>
1816   if (result == from) {
1817     // success
1818     return to;
1819   }
1820   return result;
1821 }
1822 #endif
<span class="line-added">1823 </span>
<span class="line-added">1824 // Convenience wrapper around naked_short_sleep to allow for longer sleep</span>
<span class="line-added">1825 // times. Only for use by non-JavaThreads.</span>
<span class="line-added">1826 void os::naked_sleep(jlong millis) {</span>
<span class="line-added">1827   assert(!Thread::current()-&gt;is_Java_thread(), &quot;not for use by JavaThreads&quot;);</span>
<span class="line-added">1828   const jlong limit = 999;</span>
<span class="line-added">1829   while (millis &gt; limit) {</span>
<span class="line-added">1830     naked_short_sleep(limit);</span>
<span class="line-added">1831     millis -= limit;</span>
<span class="line-added">1832   }</span>
<span class="line-added">1833   naked_short_sleep(millis);</span>
<span class="line-added">1834 }</span>
</pre>
</td>
</tr>
</table>
<center><a href="orderAccess.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="os.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>