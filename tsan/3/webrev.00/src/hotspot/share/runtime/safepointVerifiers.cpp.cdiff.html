<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/runtime/safepointVerifiers.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="safepointMechanism.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepointVerifiers.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepointVerifiers.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,58 ***</span>
   * questions.
   *
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="line-removed">- #include &quot;runtime/safepointVerifiers.hpp&quot;</span>
  #include &quot;gc/shared/collectedHeap.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  
<span class="line-removed">- // Implementation of NoGCVerifier</span>
<span class="line-removed">- </span>
  #ifdef ASSERT
  
<span class="line-modified">! NoGCVerifier::NoGCVerifier(bool verifygc) {</span>
<span class="line-modified">!   _verifygc = verifygc;</span>
<span class="line-removed">-   if (_verifygc) {</span>
<span class="line-removed">-     CollectedHeap* h = Universe::heap();</span>
<span class="line-removed">-     assert(!h-&gt;is_gc_active(), &quot;GC active during NoGCVerifier&quot;);</span>
<span class="line-removed">-     _old_invocations = h-&gt;total_collections();</span>
<span class="line-removed">-   }</span>
  }
  
<span class="line-modified">! </span>
<span class="line-modified">! NoGCVerifier::~NoGCVerifier() {</span>
<span class="line-removed">-   if (_verifygc) {</span>
<span class="line-removed">-     CollectedHeap* h = Universe::heap();</span>
<span class="line-removed">-     assert(!h-&gt;is_gc_active(), &quot;GC active during NoGCVerifier&quot;);</span>
<span class="line-removed">-     if (_old_invocations != h-&gt;total_collections()) {</span>
<span class="line-removed">-       fatal(&quot;collection in a NoGCVerifier secured function&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-   }</span>
  }
  
<span class="line-modified">! PauseNoGCVerifier::PauseNoGCVerifier(NoGCVerifier * ngcv) {</span>
<span class="line-modified">!   _ngcv = ngcv;</span>
<span class="line-modified">!   if (_ngcv-&gt;_verifygc) {</span>
<span class="line-modified">!     // if we were verifying, then make sure that nothing is</span>
<span class="line-removed">-     // wrong before we &quot;pause&quot; verification</span>
<span class="line-removed">-     CollectedHeap* h = Universe::heap();</span>
<span class="line-removed">-     assert(!h-&gt;is_gc_active(), &quot;GC active during NoGCVerifier&quot;);</span>
<span class="line-removed">-     if (_ngcv-&gt;_old_invocations != h-&gt;total_collections()) {</span>
<span class="line-removed">-       fatal(&quot;collection in a NoGCVerifier secured function&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-   }</span>
  }
  
<span class="line-modified">! </span>
<span class="line-modified">! PauseNoGCVerifier::~PauseNoGCVerifier() {</span>
<span class="line-removed">-   if (_ngcv-&gt;_verifygc) {</span>
<span class="line-removed">-     // if we were verifying before, then reenable verification</span>
<span class="line-removed">-     CollectedHeap* h = Universe::heap();</span>
<span class="line-removed">-     assert(!h-&gt;is_gc_active(), &quot;GC active during NoGCVerifier&quot;);</span>
<span class="line-removed">-     _ngcv-&gt;_old_invocations = h-&gt;total_collections();</span>
<span class="line-removed">-   }</span>
  }
<span class="line-modified">! </span>
<span class="line-removed">- #endif</span>
<span class="line-new-header">--- 21,31 ---</span>
   * questions.
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/shared/collectedHeap.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
<span class="line-added">+ #include &quot;runtime/safepoint.hpp&quot;</span>
<span class="line-added">+ #include &quot;runtime/safepointVerifiers.hpp&quot;</span>
  #include &quot;utilities/debug.hpp&quot;
  
  #ifdef ASSERT
  
<span class="line-modified">! NoSafepointVerifier::NoSafepointVerifier() : _thread(Thread::current()) {</span>
<span class="line-modified">!   _thread-&gt;_no_safepoint_count++;</span>
  }
  
<span class="line-modified">! NoSafepointVerifier::~NoSafepointVerifier() {</span>
<span class="line-modified">!   _thread-&gt;_no_safepoint_count--;</span>
  }
  
<span class="line-modified">! PauseNoSafepointVerifier::PauseNoSafepointVerifier(NoSafepointVerifier* nsv)</span>
<span class="line-modified">!     : _nsv(nsv) {</span>
<span class="line-modified">!   assert(_nsv-&gt;_thread == Thread::current(), &quot;must be&quot;);</span>
<span class="line-modified">!   _nsv-&gt;_thread-&gt;_no_safepoint_count--;</span>
  }
  
<span class="line-modified">! PauseNoSafepointVerifier::~PauseNoSafepointVerifier() {</span>
<span class="line-modified">!   _nsv-&gt;_thread-&gt;_no_safepoint_count++;</span>
  }
<span class="line-modified">! #endif // ASSERT</span>
</pre>
<center><a href="safepointMechanism.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepointVerifiers.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>