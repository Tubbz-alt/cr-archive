<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/os.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/javaClasses.hpp&quot;
  29 #include &quot;classfile/moduleEntry.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;code/codeCache.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/vtableStubs.hpp&quot;
  35 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;logging/logStream.hpp&quot;
  40 #include &quot;memory/allocation.inline.hpp&quot;
  41 #ifdef ASSERT
  42 #include &quot;memory/guardedMemory.hpp&quot;
  43 #endif
  44 #include &quot;memory/resourceArea.hpp&quot;
  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;prims/jvm_misc.hpp&quot;
  47 #include &quot;runtime/arguments.hpp&quot;
  48 #include &quot;runtime/atomic.hpp&quot;
  49 #include &quot;runtime/frame.inline.hpp&quot;
  50 #include &quot;runtime/handles.inline.hpp&quot;
  51 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/os.inline.hpp&quot;
  56 #include &quot;runtime/sharedRuntime.hpp&quot;
  57 #include &quot;runtime/stubRoutines.hpp&quot;
  58 #include &quot;runtime/thread.inline.hpp&quot;
  59 #include &quot;runtime/threadSMR.hpp&quot;
  60 #include &quot;runtime/vm_version.hpp&quot;
  61 #include &quot;services/attachListener.hpp&quot;
  62 #include &quot;services/mallocTracker.hpp&quot;
  63 #include &quot;services/memTracker.hpp&quot;
  64 #include &quot;services/nmtCommon.hpp&quot;
  65 #include &quot;services/threadService.hpp&quot;
  66 #include &quot;utilities/align.hpp&quot;
  67 #include &quot;utilities/defaultStream.hpp&quot;
  68 #include &quot;utilities/events.hpp&quot;
  69 
  70 # include &lt;signal.h&gt;
  71 # include &lt;errno.h&gt;
  72 
  73 OSThread*         os::_starting_thread    = NULL;
  74 address           os::_polling_page       = NULL;
  75 volatile unsigned int os::_rand_seed      = 1;
  76 int               os::_processor_count    = 0;
  77 int               os::_initial_active_processor_count = 0;
  78 size_t            os::_page_sizes[os::page_sizes_max];
  79 
  80 #ifndef PRODUCT
  81 julong os::num_mallocs = 0;         // # of calls to malloc/realloc
  82 julong os::alloc_bytes = 0;         // # of bytes allocated
  83 julong os::num_frees = 0;           // # of calls to free
  84 julong os::free_bytes = 0;          // # of bytes freed
  85 #endif
  86 
  87 static size_t cur_malloc_words = 0;  // current size for MallocMaxTestWords
  88 
  89 DEBUG_ONLY(bool os::_mutex_init_done = false;)
  90 
  91 void os_init_globals() {
  92   // Called from init_globals().
  93   // See Threads::create_vm() in thread.cpp, and init.cpp.
  94   os::init_globals();
  95 }
  96 
  97 static time_t get_timezone(const struct tm* time_struct) {
  98 #if defined(_ALLBSD_SOURCE)
  99   return time_struct-&gt;tm_gmtoff;
 100 #elif defined(_WINDOWS)
 101   long zone;
 102   _get_timezone(&amp;zone);
 103   return static_cast&lt;time_t&gt;(zone);
 104 #else
 105   return timezone;
 106 #endif
 107 }
 108 
 109 int os::snprintf(char* buf, size_t len, const char* fmt, ...) {
 110   va_list args;
 111   va_start(args, fmt);
 112   int result = os::vsnprintf(buf, len, fmt, args);
 113   va_end(args);
 114   return result;
 115 }
 116 
 117 // Fill in buffer with current local time as an ISO-8601 string.
 118 // E.g., yyyy-mm-ddThh:mm:ss-zzzz.
 119 // Returns buffer, or NULL if it failed.
 120 // This would mostly be a call to
 121 //     strftime(...., &quot;%Y-%m-%d&quot; &quot;T&quot; &quot;%H:%M:%S&quot; &quot;%z&quot;, ....)
 122 // except that on Windows the %z behaves badly, so we do it ourselves.
 123 // Also, people wanted milliseconds on there,
 124 // and strftime doesn&#39;t do milliseconds.
 125 char* os::iso8601_time(char* buffer, size_t buffer_length, bool utc) {
 126   // Output will be of the form &quot;YYYY-MM-DDThh:mm:ss.mmm+zzzz\0&quot;
 127   //                                      1         2
 128   //                             12345678901234567890123456789
 129   // format string: &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03d%c%02d%02d&quot;
 130   static const size_t needed_buffer = 29;
 131 
 132   // Sanity check the arguments
 133   if (buffer == NULL) {
 134     assert(false, &quot;NULL buffer&quot;);
 135     return NULL;
 136   }
 137   if (buffer_length &lt; needed_buffer) {
 138     assert(false, &quot;buffer_length too small&quot;);
 139     return NULL;
 140   }
 141   // Get the current time
 142   jlong milliseconds_since_19700101 = javaTimeMillis();
 143   const int milliseconds_per_microsecond = 1000;
 144   const time_t seconds_since_19700101 =
 145     milliseconds_since_19700101 / milliseconds_per_microsecond;
 146   const int milliseconds_after_second =
 147     milliseconds_since_19700101 % milliseconds_per_microsecond;
 148   // Convert the time value to a tm and timezone variable
 149   struct tm time_struct;
 150   if (utc) {
 151     if (gmtime_pd(&amp;seconds_since_19700101, &amp;time_struct) == NULL) {
 152       assert(false, &quot;Failed gmtime_pd&quot;);
 153       return NULL;
 154     }
 155   } else {
 156     if (localtime_pd(&amp;seconds_since_19700101, &amp;time_struct) == NULL) {
 157       assert(false, &quot;Failed localtime_pd&quot;);
 158       return NULL;
 159     }
 160   }
 161   const time_t zone = get_timezone(&amp;time_struct);
 162 
 163   // If daylight savings time is in effect,
 164   // we are 1 hour East of our time zone
 165   const time_t seconds_per_minute = 60;
 166   const time_t minutes_per_hour = 60;
 167   const time_t seconds_per_hour = seconds_per_minute * minutes_per_hour;
 168   time_t UTC_to_local = zone;
 169   if (time_struct.tm_isdst &gt; 0) {
 170     UTC_to_local = UTC_to_local - seconds_per_hour;
 171   }
 172 
 173   // No offset when dealing with UTC
 174   if (utc) {
 175     UTC_to_local = 0;
 176   }
 177 
 178   // Compute the time zone offset.
 179   //    localtime_pd() sets timezone to the difference (in seconds)
 180   //    between UTC and and local time.
 181   //    ISO 8601 says we need the difference between local time and UTC,
 182   //    we change the sign of the localtime_pd() result.
 183   const time_t local_to_UTC = -(UTC_to_local);
 184   // Then we have to figure out if if we are ahead (+) or behind (-) UTC.
 185   char sign_local_to_UTC = &#39;+&#39;;
 186   time_t abs_local_to_UTC = local_to_UTC;
 187   if (local_to_UTC &lt; 0) {
 188     sign_local_to_UTC = &#39;-&#39;;
 189     abs_local_to_UTC = -(abs_local_to_UTC);
 190   }
 191   // Convert time zone offset seconds to hours and minutes.
 192   const time_t zone_hours = (abs_local_to_UTC / seconds_per_hour);
 193   const time_t zone_min =
 194     ((abs_local_to_UTC % seconds_per_hour) / seconds_per_minute);
 195 
 196   // Print an ISO 8601 date and time stamp into the buffer
 197   const int year = 1900 + time_struct.tm_year;
 198   const int month = 1 + time_struct.tm_mon;
 199   const int printed = jio_snprintf(buffer, buffer_length,
 200                                    &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03d%c%02d%02d&quot;,
 201                                    year,
 202                                    month,
 203                                    time_struct.tm_mday,
 204                                    time_struct.tm_hour,
 205                                    time_struct.tm_min,
 206                                    time_struct.tm_sec,
 207                                    milliseconds_after_second,
 208                                    sign_local_to_UTC,
 209                                    zone_hours,
 210                                    zone_min);
 211   if (printed == 0) {
 212     assert(false, &quot;Failed jio_printf&quot;);
 213     return NULL;
 214   }
 215   return buffer;
 216 }
 217 
 218 OSReturn os::set_priority(Thread* thread, ThreadPriority p) {
 219   debug_only(Thread::check_for_dangling_thread_pointer(thread);)
 220 
 221   if ((p &gt;= MinPriority &amp;&amp; p &lt;= MaxPriority) ||
 222       (p == CriticalPriority &amp;&amp; thread-&gt;is_ConcurrentGC_thread())) {
 223     int priority = java_to_os_priority[p];
 224     return set_native_priority(thread, priority);
 225   } else {
 226     assert(false, &quot;Should not happen&quot;);
 227     return OS_ERR;
 228   }
 229 }
 230 
 231 // The mapping from OS priority back to Java priority may be inexact because
 232 // Java priorities can map M:1 with native priorities. If you want the definite
 233 // Java priority then use JavaThread::java_priority()
 234 OSReturn os::get_priority(const Thread* const thread, ThreadPriority&amp; priority) {
 235   int p;
 236   int os_prio;
 237   OSReturn ret = get_native_priority(thread, &amp;os_prio);
 238   if (ret != OS_OK) return ret;
 239 
 240   if (java_to_os_priority[MaxPriority] &gt; java_to_os_priority[MinPriority]) {
 241     for (p = MaxPriority; p &gt; MinPriority &amp;&amp; java_to_os_priority[p] &gt; os_prio; p--) ;
 242   } else {
 243     // niceness values are in reverse order
 244     for (p = MaxPriority; p &gt; MinPriority &amp;&amp; java_to_os_priority[p] &lt; os_prio; p--) ;
 245   }
 246   priority = (ThreadPriority)p;
 247   return OS_OK;
 248 }
 249 
 250 bool os::dll_build_name(char* buffer, size_t size, const char* fname) {
 251   int n = jio_snprintf(buffer, size, &quot;%s%s%s&quot;, JNI_LIB_PREFIX, fname, JNI_LIB_SUFFIX);
 252   return (n != -1);
 253 }
 254 
 255 #if !defined(LINUX) &amp;&amp; !defined(_WINDOWS)
 256 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
 257   committed_start = start;
 258   committed_size = size;
 259   return true;
 260 }
 261 #endif
 262 
 263 // Helper for dll_locate_lib.
 264 // Pass buffer and printbuffer as we already printed the path to buffer
 265 // when we called get_current_directory. This way we avoid another buffer
 266 // of size MAX_PATH.
 267 static bool conc_path_file_and_check(char *buffer, char *printbuffer, size_t printbuflen,
 268                                      const char* pname, char lastchar, const char* fname) {
 269 
 270   // Concatenate path and file name, but don&#39;t print double path separators.
 271   const char *filesep = (WINDOWS_ONLY(lastchar == &#39;:&#39; ||) lastchar == os::file_separator()[0]) ?
 272                         &quot;&quot; : os::file_separator();
 273   int ret = jio_snprintf(printbuffer, printbuflen, &quot;%s%s%s&quot;, pname, filesep, fname);
 274   // Check whether file exists.
 275   if (ret != -1) {
 276     struct stat statbuf;
 277     return os::stat(buffer, &amp;statbuf) == 0;
 278   }
 279   return false;
 280 }
 281 
 282 bool os::dll_locate_lib(char *buffer, size_t buflen,
 283                         const char* pname, const char* fname) {
 284   bool retval = false;
 285 
 286   size_t fullfnamelen = strlen(JNI_LIB_PREFIX) + strlen(fname) + strlen(JNI_LIB_SUFFIX);
 287   char* fullfname = (char*)NEW_C_HEAP_ARRAY(char, fullfnamelen + 1, mtInternal);
 288   if (dll_build_name(fullfname, fullfnamelen + 1, fname)) {
 289     const size_t pnamelen = pname ? strlen(pname) : 0;
 290 
 291     if (pnamelen == 0) {
 292       // If no path given, use current working directory.
 293       const char* p = get_current_directory(buffer, buflen);
 294       if (p != NULL) {
 295         const size_t plen = strlen(buffer);
 296         const char lastchar = buffer[plen - 1];
 297         retval = conc_path_file_and_check(buffer, &amp;buffer[plen], buflen - plen,
 298                                           &quot;&quot;, lastchar, fullfname);
 299       }
 300     } else if (strchr(pname, *os::path_separator()) != NULL) {
 301       // A list of paths. Search for the path that contains the library.
 302       int n;
 303       char** pelements = split_path(pname, &amp;n);
 304       if (pelements != NULL) {
 305         for (int i = 0; i &lt; n; i++) {
 306           char* path = pelements[i];
 307           // Really shouldn&#39;t be NULL, but check can&#39;t hurt.
 308           size_t plen = (path == NULL) ? 0 : strlen(path);
 309           if (plen == 0) {
 310             continue; // Skip the empty path values.
 311           }
 312           const char lastchar = path[plen - 1];
 313           retval = conc_path_file_and_check(buffer, buffer, buflen, path, lastchar, fullfname);
 314           if (retval) break;
 315         }
 316         // Release the storage allocated by split_path.
 317         for (int i = 0; i &lt; n; i++) {
 318           if (pelements[i] != NULL) {
 319             FREE_C_HEAP_ARRAY(char, pelements[i]);
 320           }
 321         }
 322         FREE_C_HEAP_ARRAY(char*, pelements);
 323       }
 324     } else {
 325       // A definite path.
 326       const char lastchar = pname[pnamelen-1];
 327       retval = conc_path_file_and_check(buffer, buffer, buflen, pname, lastchar, fullfname);
 328     }
 329   }
 330 
 331   FREE_C_HEAP_ARRAY(char*, fullfname);
 332   return retval;
 333 }
 334 
 335 // --------------------- sun.misc.Signal (optional) ---------------------
 336 
 337 
 338 // SIGBREAK is sent by the keyboard to query the VM state
 339 #ifndef SIGBREAK
 340 #define SIGBREAK SIGQUIT
 341 #endif
 342 
 343 // sigexitnum_pd is a platform-specific special signal used for terminating the Signal thread.
 344 
 345 
 346 static void signal_thread_entry(JavaThread* thread, TRAPS) {
 347   os::set_priority(thread, NearMaxPriority);
 348   while (true) {
 349     int sig;
 350     {
 351       // FIXME : Currently we have not decided what should be the status
 352       //         for this java thread blocked here. Once we decide about
 353       //         that we should fix this.
 354       sig = os::signal_wait();
 355     }
 356     if (sig == os::sigexitnum_pd()) {
 357        // Terminate the signal thread
 358        return;
 359     }
 360 
 361     switch (sig) {
 362       case SIGBREAK: {
 363         // Check if the signal is a trigger to start the Attach Listener - in that
 364         // case don&#39;t print stack traces.
 365         if (!DisableAttachMechanism &amp;&amp; AttachListener::is_init_trigger()) {
 366           continue;
 367         }
 368         // Print stack traces
 369         // Any SIGBREAK operations added here should make sure to flush
 370         // the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.
 371         // Each module also prints an extra carriage return after its output.
 372         VM_PrintThreads op;
 373         VMThread::execute(&amp;op);
 374         VM_PrintJNI jni_op;
 375         VMThread::execute(&amp;jni_op);
 376         VM_FindDeadlocks op1(tty);
 377         VMThread::execute(&amp;op1);
 378         Universe::print_heap_at_SIGBREAK();
 379         if (PrintClassHistogram) {
 380           VM_GC_HeapInspection op1(tty, true /* force full GC before heap inspection */);
 381           VMThread::execute(&amp;op1);
 382         }
 383         if (JvmtiExport::should_post_data_dump()) {
 384           JvmtiExport::post_data_dump();
 385         }
 386         break;
 387       }
 388       default: {
 389         // Dispatch the signal to java
 390         HandleMark hm(THREAD);
 391         Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_misc_Signal(), THREAD);
 392         if (klass != NULL) {
 393           JavaValue result(T_VOID);
 394           JavaCallArguments args;
 395           args.push_int(sig);
 396           JavaCalls::call_static(
 397             &amp;result,
 398             klass,
 399             vmSymbols::dispatch_name(),
 400             vmSymbols::int_void_signature(),
 401             &amp;args,
 402             THREAD
 403           );
 404         }
 405         if (HAS_PENDING_EXCEPTION) {
 406           // tty is initialized early so we don&#39;t expect it to be null, but
 407           // if it is we can&#39;t risk doing an initialization that might
 408           // trigger additional out-of-memory conditions
 409           if (tty != NULL) {
 410             char klass_name[256];
 411             char tmp_sig_name[16];
 412             const char* sig_name = &quot;UNKNOWN&quot;;
 413             InstanceKlass::cast(PENDING_EXCEPTION-&gt;klass())-&gt;
 414               name()-&gt;as_klass_external_name(klass_name, 256);
 415             if (os::exception_name(sig, tmp_sig_name, 16) != NULL)
 416               sig_name = tmp_sig_name;
 417             warning(&quot;Exception %s occurred dispatching signal %s to handler&quot;
 418                     &quot;- the VM may need to be forcibly terminated&quot;,
 419                     klass_name, sig_name );
 420           }
 421           CLEAR_PENDING_EXCEPTION;
 422         }
 423       }
 424     }
 425   }
 426 }
 427 
 428 void os::init_before_ergo() {
 429   initialize_initial_active_processor_count();
 430   // We need to initialize large page support here because ergonomics takes some
 431   // decisions depending on large page support and the calculated large page size.
 432   large_page_init();
 433 
 434   // We need to adapt the configured number of stack protection pages given
 435   // in 4K pages to the actual os page size. We must do this before setting
 436   // up minimal stack sizes etc. in os::init_2().
 437   JavaThread::set_stack_red_zone_size     (align_up(StackRedPages      * 4 * K, vm_page_size()));
 438   JavaThread::set_stack_yellow_zone_size  (align_up(StackYellowPages   * 4 * K, vm_page_size()));
 439   JavaThread::set_stack_reserved_zone_size(align_up(StackReservedPages * 4 * K, vm_page_size()));
 440   JavaThread::set_stack_shadow_zone_size  (align_up(StackShadowPages   * 4 * K, vm_page_size()));
 441 
 442   // VM version initialization identifies some characteristics of the
 443   // platform that are used during ergonomic decisions.
 444   VM_Version::init_before_ergo();
 445 }
 446 
 447 void os::initialize_jdk_signal_support(TRAPS) {
 448   if (!ReduceSignalUsage) {
 449     // Setup JavaThread for processing signals
 450     const char thread_name[] = &quot;Signal Dispatcher&quot;;
 451     Handle string = java_lang_String::create_from_str(thread_name, CHECK);
 452 
 453     // Initialize thread_oop to put it into the system threadGroup
 454     Handle thread_group (THREAD, Universe::system_thread_group());
 455     Handle thread_oop = JavaCalls::construct_new_instance(SystemDictionary::Thread_klass(),
 456                            vmSymbols::threadgroup_string_void_signature(),
 457                            thread_group,
 458                            string,
 459                            CHECK);
 460 
 461     Klass* group = SystemDictionary::ThreadGroup_klass();
 462     JavaValue result(T_VOID);
 463     JavaCalls::call_special(&amp;result,
 464                             thread_group,
 465                             group,
 466                             vmSymbols::add_method_name(),
 467                             vmSymbols::thread_void_signature(),
 468                             thread_oop,
 469                             CHECK);
 470 
 471     { MutexLocker mu(Threads_lock);
 472       JavaThread* signal_thread = new JavaThread(&amp;signal_thread_entry);
 473 
 474       // At this point it may be possible that no osthread was created for the
 475       // JavaThread due to lack of memory. We would have to throw an exception
 476       // in that case. However, since this must work and we do not allow
 477       // exceptions anyway, check and abort if this fails.
 478       if (signal_thread == NULL || signal_thread-&gt;osthread() == NULL) {
 479         vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 480                                       os::native_thread_creation_failed_msg());
 481       }
 482 
 483       java_lang_Thread::set_thread(thread_oop(), signal_thread);
 484       java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 485       java_lang_Thread::set_daemon(thread_oop());
 486 
 487       signal_thread-&gt;set_threadObj(thread_oop());
 488       Threads::add(signal_thread);
 489       Thread::start(signal_thread);
 490     }
 491     // Handle ^BREAK
 492     os::signal(SIGBREAK, os::user_handler());
 493   }
 494 }
 495 
 496 
 497 void os::terminate_signal_thread() {
 498   if (!ReduceSignalUsage)
 499     signal_notify(sigexitnum_pd());
 500 }
 501 
 502 
 503 // --------------------- loading libraries ---------------------
 504 
 505 typedef jint (JNICALL *JNI_OnLoad_t)(JavaVM *, void *);
 506 extern struct JavaVM_ main_vm;
 507 
 508 static void* _native_java_library = NULL;
 509 
 510 void* os::native_java_library() {
 511   if (_native_java_library == NULL) {
 512     char buffer[JVM_MAXPATHLEN];
 513     char ebuf[1024];
 514 
 515     // Try to load verify dll first. In 1.3 java dll depends on it and is not
 516     // always able to find it when the loading executable is outside the JDK.
 517     // In order to keep working with 1.2 we ignore any loading errors.
 518     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 519                        &quot;verify&quot;)) {
 520       dll_load(buffer, ebuf, sizeof(ebuf));
 521     }
 522 
 523     // Load java dll
 524     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 525                        &quot;java&quot;)) {
 526       _native_java_library = dll_load(buffer, ebuf, sizeof(ebuf));
 527     }
 528     if (_native_java_library == NULL) {
 529       vm_exit_during_initialization(&quot;Unable to load native library&quot;, ebuf);
 530     }
 531 
 532 #if defined(__OpenBSD__)
 533     // Work-around OpenBSD&#39;s lack of $ORIGIN support by pre-loading libnet.so
 534     // ignore errors
 535     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 536                        &quot;net&quot;)) {
 537       dll_load(buffer, ebuf, sizeof(ebuf));
 538     }
 539 #endif
 540   }
 541   return _native_java_library;
 542 }
 543 
 544 /*
 545  * Support for finding Agent_On(Un)Load/Attach&lt;_lib_name&gt; if it exists.
 546  * If check_lib == true then we are looking for an
 547  * Agent_OnLoad_lib_name or Agent_OnAttach_lib_name function to determine if
 548  * this library is statically linked into the image.
 549  * If check_lib == false then we will look for the appropriate symbol in the
 550  * executable if agent_lib-&gt;is_static_lib() == true or in the shared library
 551  * referenced by &#39;handle&#39;.
 552  */
 553 void* os::find_agent_function(AgentLibrary *agent_lib, bool check_lib,
 554                               const char *syms[], size_t syms_len) {
 555   assert(agent_lib != NULL, &quot;sanity check&quot;);
 556   const char *lib_name;
 557   void *handle = agent_lib-&gt;os_lib();
 558   void *entryName = NULL;
 559   char *agent_function_name;
 560   size_t i;
 561 
 562   // If checking then use the agent name otherwise test is_static_lib() to
 563   // see how to process this lookup
 564   lib_name = ((check_lib || agent_lib-&gt;is_static_lib()) ? agent_lib-&gt;name() : NULL);
 565   for (i = 0; i &lt; syms_len; i++) {
 566     agent_function_name = build_agent_function_name(syms[i], lib_name, agent_lib-&gt;is_absolute_path());
 567     if (agent_function_name == NULL) {
 568       break;
 569     }
 570     entryName = dll_lookup(handle, agent_function_name);
 571     FREE_C_HEAP_ARRAY(char, agent_function_name);
 572     if (entryName != NULL) {
 573       break;
 574     }
 575   }
 576   return entryName;
 577 }
 578 
 579 // See if the passed in agent is statically linked into the VM image.
 580 bool os::find_builtin_agent(AgentLibrary *agent_lib, const char *syms[],
 581                             size_t syms_len) {
 582   void *ret;
 583   void *proc_handle;
 584   void *save_handle;
 585 
 586   assert(agent_lib != NULL, &quot;sanity check&quot;);
 587   if (agent_lib-&gt;name() == NULL) {
 588     return false;
 589   }
 590   proc_handle = get_default_process_handle();
 591   // Check for Agent_OnLoad/Attach_lib_name function
 592   save_handle = agent_lib-&gt;os_lib();
 593   // We want to look in this process&#39; symbol table.
 594   agent_lib-&gt;set_os_lib(proc_handle);
 595   ret = find_agent_function(agent_lib, true, syms, syms_len);
 596   if (ret != NULL) {
 597     // Found an entry point like Agent_OnLoad_lib_name so we have a static agent
 598     agent_lib-&gt;set_valid();
 599     agent_lib-&gt;set_static_lib(true);
 600     return true;
 601   }
 602   agent_lib-&gt;set_os_lib(save_handle);
 603   return false;
 604 }
 605 
 606 // --------------------- heap allocation utilities ---------------------
 607 
 608 char *os::strdup(const char *str, MEMFLAGS flags) {
 609   size_t size = strlen(str);
 610   char *dup_str = (char *)malloc(size + 1, flags);
 611   if (dup_str == NULL) return NULL;
 612   strcpy(dup_str, str);
 613   return dup_str;
 614 }
 615 
 616 char* os::strdup_check_oom(const char* str, MEMFLAGS flags) {
 617   char* p = os::strdup(str, flags);
 618   if (p == NULL) {
 619     vm_exit_out_of_memory(strlen(str) + 1, OOM_MALLOC_ERROR, &quot;os::strdup_check_oom&quot;);
 620   }
 621   return p;
 622 }
 623 
 624 
 625 #define paranoid                 0  /* only set to 1 if you suspect checking code has bug */
 626 
 627 #ifdef ASSERT
 628 
 629 static void verify_memory(void* ptr) {
 630   GuardedMemory guarded(ptr);
 631   if (!guarded.verify_guards()) {
 632     LogTarget(Warning, malloc, free) lt;
 633     ResourceMark rm;
 634     LogStream ls(lt);
 635     ls.print_cr(&quot;## nof_mallocs = &quot; UINT64_FORMAT &quot;, nof_frees = &quot; UINT64_FORMAT, os::num_mallocs, os::num_frees);
 636     ls.print_cr(&quot;## memory stomp:&quot;);
 637     guarded.print_on(&amp;ls);
 638     fatal(&quot;memory stomping error&quot;);
 639   }
 640 }
 641 
 642 #endif
 643 
 644 //
 645 // This function supports testing of the malloc out of memory
 646 // condition without really running the system out of memory.
 647 //
 648 static bool has_reached_max_malloc_test_peak(size_t alloc_size) {
 649   if (MallocMaxTestWords &gt; 0) {
 650     size_t words = (alloc_size / BytesPerWord);
 651 
 652     if ((cur_malloc_words + words) &gt; MallocMaxTestWords) {
 653       return true;
 654     }
 655     Atomic::add(words, &amp;cur_malloc_words);
 656   }
 657   return false;
 658 }
 659 
 660 void* os::malloc(size_t size, MEMFLAGS flags) {
 661   return os::malloc(size, flags, CALLER_PC);
 662 }
 663 
 664 void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 665   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 666   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 667 
 668   // Since os::malloc can be called when the libjvm.{dll,so} is
 669   // first loaded and we don&#39;t have a thread yet we must accept NULL also here.
 670   assert(!os::ThreadCrashProtection::is_crash_protected(Thread::current_or_null()),
 671          &quot;malloc() not allowed when crash protection is set&quot;);
 672 
 673   if (size == 0) {
 674     // return a valid pointer if size is zero
 675     // if NULL is returned the calling functions assume out of memory.
 676     size = 1;
 677   }
 678 
 679   // NMT support
 680   NMT_TrackingLevel level = MemTracker::tracking_level();
 681   size_t            nmt_header_size = MemTracker::malloc_header_size(level);
 682 
 683 #ifndef ASSERT
 684   const size_t alloc_size = size + nmt_header_size;
 685 #else
 686   const size_t alloc_size = GuardedMemory::get_total_size(size + nmt_header_size);
 687   if (size + nmt_header_size &gt; alloc_size) { // Check for rollover.
 688     return NULL;
 689   }
 690 #endif
 691 
 692   // For the test flag -XX:MallocMaxTestWords
 693   if (has_reached_max_malloc_test_peak(size)) {
 694     return NULL;
 695   }
 696 
 697   u_char* ptr;
 698   ptr = (u_char*)::malloc(alloc_size);
 699 
 700 #ifdef ASSERT
 701   if (ptr == NULL) {
 702     return NULL;
 703   }
 704   // Wrap memory with guard
 705   GuardedMemory guarded(ptr, size + nmt_header_size);
 706   ptr = guarded.get_user_ptr();
 707 #endif
 708   if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {
 709     log_warning(malloc, free)(&quot;os::malloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));
 710     breakpoint();
 711   }
 712   debug_only(if (paranoid) verify_memory(ptr));
 713 
 714   // we do not track guard memory
 715   return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);
 716 }
 717 
 718 void* os::realloc(void *memblock, size_t size, MEMFLAGS flags) {
 719   return os::realloc(memblock, size, flags, CALLER_PC);
 720 }
 721 
 722 void* os::realloc(void *memblock, size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 723 
 724   // For the test flag -XX:MallocMaxTestWords
 725   if (has_reached_max_malloc_test_peak(size)) {
 726     return NULL;
 727   }
 728 
 729   if (size == 0) {
 730     // return a valid pointer if size is zero
 731     // if NULL is returned the calling functions assume out of memory.
 732     size = 1;
 733   }
 734 
 735 #ifndef ASSERT
 736   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 737   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 738    // NMT support
 739   void* membase = MemTracker::record_free(memblock);
 740   NMT_TrackingLevel level = MemTracker::tracking_level();
 741   size_t  nmt_header_size = MemTracker::malloc_header_size(level);
 742   void* ptr = ::realloc(membase, size + nmt_header_size);
 743   return MemTracker::record_malloc(ptr, size, memflags, stack, level);
 744 #else
 745   if (memblock == NULL) {
 746     return os::malloc(size, memflags, stack);
 747   }
 748   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 749     log_warning(malloc, free)(&quot;os::realloc caught &quot; PTR_FORMAT, p2i(memblock));
 750     breakpoint();
 751   }
 752   // NMT support
 753   void* membase = MemTracker::malloc_base(memblock);
 754   verify_memory(membase);
 755   // always move the block
 756   void* ptr = os::malloc(size, memflags, stack);
 757   // Copy to new memory if malloc didn&#39;t fail
 758   if (ptr != NULL ) {
 759     GuardedMemory guarded(MemTracker::malloc_base(memblock));
 760     // Guard&#39;s user data contains NMT header
 761     size_t memblock_size = guarded.get_user_size() - MemTracker::malloc_header_size(memblock);
 762     memcpy(ptr, memblock, MIN2(size, memblock_size));
 763     if (paranoid) verify_memory(MemTracker::malloc_base(ptr));
 764     if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {
 765       log_warning(malloc, free)(&quot;os::realloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));
 766       breakpoint();
 767     }
 768     os::free(memblock);
 769   }
 770   return ptr;
 771 #endif
 772 }
 773 
 774 
 775 void  os::free(void *memblock) {
 776   NOT_PRODUCT(inc_stat_counter(&amp;num_frees, 1));
 777 #ifdef ASSERT
 778   if (memblock == NULL) return;
 779   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 780     log_warning(malloc, free)(&quot;os::free caught &quot; PTR_FORMAT, p2i(memblock));
 781     breakpoint();
 782   }
 783   void* membase = MemTracker::record_free(memblock);
 784   verify_memory(membase);
 785 
 786   GuardedMemory guarded(membase);
 787   size_t size = guarded.get_user_size();
 788   inc_stat_counter(&amp;free_bytes, size);
 789   membase = guarded.release_for_freeing();
 790   ::free(membase);
 791 #else
 792   void* membase = MemTracker::record_free(memblock);
 793   ::free(membase);
 794 #endif
 795 }
 796 
 797 void os::init_random(unsigned int initval) {
 798   _rand_seed = initval;
 799 }
 800 
 801 
 802 static int random_helper(unsigned int rand_seed) {
 803   /* standard, well-known linear congruential random generator with
 804    * next_rand = (16807*seed) mod (2**31-1)
 805    * see
 806    * (1) &quot;Random Number Generators: Good Ones Are Hard to Find&quot;,
 807    *      S.K. Park and K.W. Miller, Communications of the ACM 31:10 (Oct 1988),
 808    * (2) &quot;Two Fast Implementations of the &#39;Minimal Standard&#39; Random
 809    *     Number Generator&quot;, David G. Carta, Comm. ACM 33, 1 (Jan 1990), pp. 87-88.
 810   */
 811   const unsigned int a = 16807;
 812   const unsigned int m = 2147483647;
 813   const int q = m / a;        assert(q == 127773, &quot;weird math&quot;);
 814   const int r = m % a;        assert(r == 2836, &quot;weird math&quot;);
 815 
 816   // compute az=2^31p+q
 817   unsigned int lo = a * (rand_seed &amp; 0xFFFF);
 818   unsigned int hi = a * (rand_seed &gt;&gt; 16);
 819   lo += (hi &amp; 0x7FFF) &lt;&lt; 16;
 820 
 821   // if q overflowed, ignore the overflow and increment q
 822   if (lo &gt; m) {
 823     lo &amp;= m;
 824     ++lo;
 825   }
 826   lo += hi &gt;&gt; 15;
 827 
 828   // if (p+q) overflowed, ignore the overflow and increment (p+q)
 829   if (lo &gt; m) {
 830     lo &amp;= m;
 831     ++lo;
 832   }
 833   return lo;
 834 }
 835 
 836 int os::random() {
 837   // Make updating the random seed thread safe.
 838   while (true) {
 839     unsigned int seed = _rand_seed;
 840     unsigned int rand = random_helper(seed);
 841     if (Atomic::cmpxchg(rand, &amp;_rand_seed, seed) == seed) {
 842       return static_cast&lt;int&gt;(rand);
 843     }
 844   }
 845 }
 846 
 847 // The INITIALIZED state is distinguished from the SUSPENDED state because the
 848 // conditions in which a thread is first started are different from those in which
 849 // a suspension is resumed.  These differences make it hard for us to apply the
 850 // tougher checks when starting threads that we want to do when resuming them.
 851 // However, when start_thread is called as a result of Thread.start, on a Java
 852 // thread, the operation is synchronized on the Java Thread object.  So there
 853 // cannot be a race to start the thread and hence for the thread to exit while
 854 // we are working on it.  Non-Java threads that start Java threads either have
 855 // to do so in a context in which races are impossible, or should do appropriate
 856 // locking.
 857 
 858 void os::start_thread(Thread* thread) {
 859   // guard suspend/resume
 860   MutexLockerEx ml(thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 861   OSThread* osthread = thread-&gt;osthread();
 862   osthread-&gt;set_state(RUNNABLE);
 863   pd_start_thread(thread);
 864 }
 865 
 866 void os::abort(bool dump_core) {
 867   abort(dump_core &amp;&amp; CreateCoredumpOnCrash, NULL, NULL);
 868 }
 869 
 870 //---------------------------------------------------------------------------
 871 // Helper functions for fatal error handler
 872 
 873 void os::print_hex_dump(outputStream* st, address start, address end, int unitsize) {
 874   assert(unitsize == 1 || unitsize == 2 || unitsize == 4 || unitsize == 8, &quot;just checking&quot;);
 875 
 876   start = align_down(start, unitsize);
 877 
 878   int cols = 0;
 879   int cols_per_line = 0;
 880   switch (unitsize) {
 881     case 1: cols_per_line = 16; break;
 882     case 2: cols_per_line = 8;  break;
 883     case 4: cols_per_line = 4;  break;
 884     case 8: cols_per_line = 2;  break;
 885     default: return;
 886   }
 887 
 888   address p = start;
 889   st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(start));
 890   while (p &lt; end) {
 891     if (is_readable_pointer(p)) {
 892       switch (unitsize) {
 893         case 1: st-&gt;print(&quot;%02x&quot;, *(u1*)p); break;
 894         case 2: st-&gt;print(&quot;%04x&quot;, *(u2*)p); break;
 895         case 4: st-&gt;print(&quot;%08x&quot;, *(u4*)p); break;
 896         case 8: st-&gt;print(&quot;%016&quot; FORMAT64_MODIFIER &quot;x&quot;, *(u8*)p); break;
 897       }
 898     } else {
 899       st-&gt;print(&quot;%*.*s&quot;, 2*unitsize, 2*unitsize, &quot;????????????????&quot;);
 900     }
 901     p += unitsize;
 902     cols++;
 903     if (cols &gt;= cols_per_line &amp;&amp; p &lt; end) {
 904        cols = 0;
 905        st-&gt;cr();
 906        st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(p));
 907     } else {
 908        st-&gt;print(&quot; &quot;);
 909     }
 910   }
 911   st-&gt;cr();
 912 }
 913 
 914 void os::print_instructions(outputStream* st, address pc, int unitsize) {
 915   st-&gt;print_cr(&quot;Instructions: (pc=&quot; PTR_FORMAT &quot;)&quot;, p2i(pc));
 916   print_hex_dump(st, pc - 256, pc + 256, unitsize);
 917 }
 918 
 919 void os::print_environment_variables(outputStream* st, const char** env_list) {
 920   if (env_list) {
 921     st-&gt;print_cr(&quot;Environment Variables:&quot;);
 922 
 923     for (int i = 0; env_list[i] != NULL; i++) {
 924       char *envvar = ::getenv(env_list[i]);
 925       if (envvar != NULL) {
 926         st-&gt;print(&quot;%s&quot;, env_list[i]);
 927         st-&gt;print(&quot;=&quot;);
 928         st-&gt;print_cr(&quot;%s&quot;, envvar);
 929       }
 930     }
 931   }
 932 }
 933 
 934 void os::print_cpu_info(outputStream* st, char* buf, size_t buflen) {
 935   // cpu
 936   st-&gt;print(&quot;CPU:&quot;);
 937   st-&gt;print(&quot;total %d&quot;, os::processor_count());
 938   // It&#39;s not safe to query number of active processors after crash
 939   // st-&gt;print(&quot;(active %d)&quot;, os::active_processor_count()); but we can
 940   // print the initial number of active processors.
 941   // We access the raw value here because the assert in the accessor will
 942   // fail if the crash occurs before initialization of this value.
 943   st-&gt;print(&quot; (initial active %d)&quot;, _initial_active_processor_count);
 944   st-&gt;print(&quot; %s&quot;, VM_Version::features_string());
 945   st-&gt;cr();
 946   pd_print_cpu_info(st, buf, buflen);
 947 }
 948 
 949 // Print a one line string summarizing the cpu, number of cores, memory, and operating system version
 950 void os::print_summary_info(outputStream* st, char* buf, size_t buflen) {
 951   st-&gt;print(&quot;Host: &quot;);
 952 #ifndef PRODUCT
 953   if (get_host_name(buf, buflen)) {
 954     st-&gt;print(&quot;%s, &quot;, buf);
 955   }
 956 #endif // PRODUCT
 957   get_summary_cpu_info(buf, buflen);
 958   st-&gt;print(&quot;%s, &quot;, buf);
 959   size_t mem = physical_memory()/G;
 960   if (mem == 0) {  // for low memory systems
 961     mem = physical_memory()/M;
 962     st-&gt;print(&quot;%d cores, &quot; SIZE_FORMAT &quot;M, &quot;, processor_count(), mem);
 963   } else {
 964     st-&gt;print(&quot;%d cores, &quot; SIZE_FORMAT &quot;G, &quot;, processor_count(), mem);
 965   }
 966   get_summary_os_info(buf, buflen);
 967   st-&gt;print_raw(buf);
 968   st-&gt;cr();
 969 }
 970 
 971 void os::print_date_and_time(outputStream *st, char* buf, size_t buflen) {
 972   const int secs_per_day  = 86400;
 973   const int secs_per_hour = 3600;
 974   const int secs_per_min  = 60;
 975 
 976   time_t tloc;
 977   (void)time(&amp;tloc);
 978   char* timestring = ctime(&amp;tloc);  // ctime adds newline.
 979   // edit out the newline
 980   char* nl = strchr(timestring, &#39;\n&#39;);
 981   if (nl != NULL) {
 982     *nl = &#39;\0&#39;;
 983   }
 984 
 985   struct tm tz;
 986   if (localtime_pd(&amp;tloc, &amp;tz) != NULL) {
 987     ::strftime(buf, buflen, &quot;%Z&quot;, &amp;tz);
 988     st-&gt;print(&quot;Time: %s %s&quot;, timestring, buf);
 989   } else {
 990     st-&gt;print(&quot;Time: %s&quot;, timestring);
 991   }
 992 
 993   double t = os::elapsedTime();
 994   // NOTE: It tends to crash after a SEGV if we want to printf(&quot;%f&quot;,...) in
 995   //       Linux. Must be a bug in glibc ? Workaround is to round &quot;t&quot; to int
 996   //       before printf. We lost some precision, but who cares?
 997   int eltime = (int)t;  // elapsed time in seconds
 998 
 999   // print elapsed time in a human-readable format:
1000   int eldays = eltime / secs_per_day;
1001   int day_secs = eldays * secs_per_day;
1002   int elhours = (eltime - day_secs) / secs_per_hour;
1003   int hour_secs = elhours * secs_per_hour;
1004   int elmins = (eltime - day_secs - hour_secs) / secs_per_min;
1005   int minute_secs = elmins * secs_per_min;
1006   int elsecs = (eltime - day_secs - hour_secs - minute_secs);
1007   st-&gt;print_cr(&quot; elapsed time: %d seconds (%dd %dh %dm %ds)&quot;, eltime, eldays, elhours, elmins, elsecs);
1008 }
1009 
1010 
1011 // Check if pointer can be read from (4-byte read access).
1012 // Helps to prove validity of a not-NULL pointer.
1013 // Returns true in very early stages of VM life when stub is not yet generated.
1014 #define SAFEFETCH_DEFAULT true
1015 bool os::is_readable_pointer(const void* p) {
1016   if (!CanUseSafeFetch32()) {
1017     return SAFEFETCH_DEFAULT;
1018   }
1019   int* const aligned = (int*) align_down((intptr_t)p, 4);
1020   int cafebabe = 0xcafebabe;  // tester value 1
1021   int deadbeef = 0xdeadbeef;  // tester value 2
1022   return (SafeFetch32(aligned, cafebabe) != cafebabe) || (SafeFetch32(aligned, deadbeef) != deadbeef);
1023 }
1024 
1025 bool os::is_readable_range(const void* from, const void* to) {
1026   for (address p = align_down((address)from, min_page_size()); p &lt; to; p += min_page_size()) {
1027     if (!is_readable_pointer(p)) {
1028       return false;
1029     }
1030   }
1031   return true;
1032 }
1033 
1034 
1035 // moved from debug.cpp (used to be find()) but still called from there
1036 // The verbose parameter is only set by the debug code in one case
1037 void os::print_location(outputStream* st, intptr_t x, bool verbose) {
1038   address addr = (address)x;
1039   // Handle NULL first, so later checks don&#39;t need to protect against it.
1040   if (addr == NULL) {
1041     st-&gt;print_cr(&quot;0x0 is NULL&quot;);
1042     return;
1043   }
1044 
1045   // Check if addr points into a code blob.
1046   CodeBlob* b = CodeCache::find_blob_unsafe(addr);
1047   if (b != NULL) {
1048     b-&gt;dump_for_addr(addr, st, verbose);
1049     return;
1050   }
1051 
1052   // Check if addr points into Java heap.
1053   if (Universe::heap()-&gt;is_in(addr)) {
1054     oop o = oopDesc::oop_or_null(addr);
1055     if (o != NULL) {
1056       if ((HeapWord*)o == (HeapWord*)addr) {
1057         st-&gt;print(INTPTR_FORMAT &quot; is an oop: &quot;, p2i(addr));
1058       } else {
1059         st-&gt;print(INTPTR_FORMAT &quot; is pointing into object: &quot; , p2i(addr));
1060       }
1061       o-&gt;print_on(st);
1062       return;
1063     }
1064   } else if (Universe::heap()-&gt;is_in_reserved(addr)) {
1065     st-&gt;print_cr(INTPTR_FORMAT &quot; is an unallocated location in the heap&quot;, p2i(addr));
1066     return;
1067   }
1068 
1069   // Compressed oop needs to be decoded first.
1070 #ifdef _LP64
1071   if (UseCompressedOops &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {
1072     narrowOop narrow_oop = (narrowOop)(uintptr_t)addr;
1073     oop o = oopDesc::decode_oop_raw(narrow_oop);
1074 
1075     if (oopDesc::is_valid(o)) {
1076       st-&gt;print(UINT32_FORMAT &quot; is a compressed pointer to object: &quot;, narrow_oop);
1077       o-&gt;print_on(st);
1078       return;
1079     }
1080   }
1081 #endif
1082 
1083   bool accessible = is_readable_pointer(addr);
1084 
1085   // Check if addr is a JNI handle.
1086   if (align_down((intptr_t)addr, sizeof(intptr_t)) != 0 &amp;&amp; accessible) {
1087     if (JNIHandles::is_global_handle((jobject) addr)) {
1088       st-&gt;print_cr(INTPTR_FORMAT &quot; is a global jni handle&quot;, p2i(addr));
1089       return;
1090     }
1091     if (JNIHandles::is_weak_global_handle((jobject) addr)) {
1092       st-&gt;print_cr(INTPTR_FORMAT &quot; is a weak global jni handle&quot;, p2i(addr));
1093       return;
1094     }
1095 #ifndef PRODUCT
1096     // we don&#39;t keep the block list in product mode
1097     if (JNIHandles::is_local_handle((jobject) addr)) {
1098       st-&gt;print_cr(INTPTR_FORMAT &quot; is a local jni handle&quot;, p2i(addr));
1099       return;
1100     }
1101 #endif
1102   }
1103 
1104   // Check if addr belongs to a Java thread.
1105   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *thread = jtiwh.next(); ) {
1106     // If the addr is a java thread print information about that.
1107     if (addr == (address)thread) {
1108       if (verbose) {
1109         thread-&gt;print_on(st);
1110       } else {
1111         st-&gt;print_cr(INTPTR_FORMAT &quot; is a thread&quot;, p2i(addr));
1112       }
1113       return;
1114     }
1115     // If the addr is in the stack region for this thread then report that
1116     // and print thread info
1117     if (thread-&gt;on_local_stack(addr)) {
1118       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into the stack for thread: &quot;
1119                    INTPTR_FORMAT, p2i(addr), p2i(thread));
1120       if (verbose) thread-&gt;print_on(st);
1121       return;
1122     }
1123   }
1124 
1125   // Check if in metaspace and print types that have vptrs
1126   if (Metaspace::contains(addr)) {
1127     if (Klass::is_valid((Klass*)addr)) {
1128       st-&gt;print_cr(INTPTR_FORMAT &quot; is a pointer to class: &quot;, p2i(addr));
1129       ((Klass*)addr)-&gt;print_on(st);
1130     } else if (Method::is_valid_method((const Method*)addr)) {
1131       ((Method*)addr)-&gt;print_value_on(st);
1132       st-&gt;cr();
1133     } else {
1134       // Use addr-&gt;print() from the debugger instead (not here)
1135       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into metadata&quot;, p2i(addr));
1136     }
1137     return;
1138   }
1139 
1140   // Compressed klass needs to be decoded first.
1141 #ifdef _LP64
1142   if (UseCompressedClassPointers &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {
1143     narrowKlass narrow_klass = (narrowKlass)(uintptr_t)addr;
1144     Klass* k = Klass::decode_klass_raw(narrow_klass);
1145 
1146     if (Klass::is_valid(k)) {
1147       st-&gt;print_cr(UINT32_FORMAT &quot; is a compressed pointer to class: &quot; INTPTR_FORMAT, narrow_klass, p2i((HeapWord*)k));
1148       k-&gt;print_on(st);
1149       return;
1150     }
1151   }
1152 #endif
1153 
1154   // Try an OS specific find
1155   if (os::find(addr, st)) {
1156     return;
1157   }
1158 
1159   if (accessible) {
1160     st-&gt;print(INTPTR_FORMAT &quot; points into unknown readable memory:&quot;, p2i(addr));
1161     for (address p = addr; p &lt; align_up(addr + 1, sizeof(intptr_t)); ++p) {
1162       st-&gt;print(&quot; %02x&quot;, *(u1*)p);
1163     }
1164     st-&gt;cr();
1165     return;
1166   }
1167 
1168   st-&gt;print_cr(INTPTR_FORMAT &quot; is an unknown value&quot;, p2i(addr));
1169 }
1170 
1171 // Looks like all platforms can use the same function to check if C
1172 // stack is walkable beyond current frame. The check for fp() is not
1173 // necessary on Sparc, but it&#39;s harmless.
1174 bool os::is_first_C_frame(frame* fr) {
1175   // Load up sp, fp, sender sp and sender fp, check for reasonable values.
1176   // Check usp first, because if that&#39;s bad the other accessors may fault
1177   // on some architectures.  Ditto ufp second, etc.
1178   uintptr_t fp_align_mask = (uintptr_t)(sizeof(address)-1);
1179   // sp on amd can be 32 bit aligned.
1180   uintptr_t sp_align_mask = (uintptr_t)(sizeof(int)-1);
1181 
1182   uintptr_t usp    = (uintptr_t)fr-&gt;sp();
1183   if ((usp &amp; sp_align_mask) != 0) return true;
1184 
1185   uintptr_t ufp    = (uintptr_t)fr-&gt;fp();
1186   if ((ufp &amp; fp_align_mask) != 0) return true;
1187 
1188   uintptr_t old_sp = (uintptr_t)fr-&gt;sender_sp();
1189   if ((old_sp &amp; sp_align_mask) != 0) return true;
1190   if (old_sp == 0 || old_sp == (uintptr_t)-1) return true;
1191 
1192   uintptr_t old_fp = (uintptr_t)fr-&gt;link();
1193   if ((old_fp &amp; fp_align_mask) != 0) return true;
1194   if (old_fp == 0 || old_fp == (uintptr_t)-1 || old_fp == ufp) return true;
1195 
1196   // stack grows downwards; if old_fp is below current fp or if the stack
1197   // frame is too large, either the stack is corrupted or fp is not saved
1198   // on stack (i.e. on x86, ebp may be used as general register). The stack
1199   // is not walkable beyond current frame.
1200   if (old_fp &lt; ufp) return true;
1201   if (old_fp - ufp &gt; 64 * K) return true;
1202 
1203   return false;
1204 }
1205 
1206 
1207 // Set up the boot classpath.
1208 
1209 char* os::format_boot_path(const char* format_string,
1210                            const char* home,
1211                            int home_len,
1212                            char fileSep,
1213                            char pathSep) {
1214     assert((fileSep == &#39;/&#39; &amp;&amp; pathSep == &#39;:&#39;) ||
1215            (fileSep == &#39;\\&#39; &amp;&amp; pathSep == &#39;;&#39;), &quot;unexpected separator chars&quot;);
1216 
1217     // Scan the format string to determine the length of the actual
1218     // boot classpath, and handle platform dependencies as well.
1219     int formatted_path_len = 0;
1220     const char* p;
1221     for (p = format_string; *p != 0; ++p) {
1222         if (*p == &#39;%&#39;) formatted_path_len += home_len - 1;
1223         ++formatted_path_len;
1224     }
1225 
1226     char* formatted_path = NEW_C_HEAP_ARRAY(char, formatted_path_len + 1, mtInternal);
1227     if (formatted_path == NULL) {
1228         return NULL;
1229     }
1230 
1231     // Create boot classpath from format, substituting separator chars and
1232     // java home directory.
1233     char* q = formatted_path;
1234     for (p = format_string; *p != 0; ++p) {
1235         switch (*p) {
1236         case &#39;%&#39;:
1237             strcpy(q, home);
1238             q += home_len;
1239             break;
1240         case &#39;/&#39;:
1241             *q++ = fileSep;
1242             break;
1243         case &#39;:&#39;:
1244             *q++ = pathSep;
1245             break;
1246         default:
1247             *q++ = *p;
1248         }
1249     }
1250     *q = &#39;\0&#39;;
1251 
1252     assert((q - formatted_path) == formatted_path_len, &quot;formatted_path size botched&quot;);
1253     return formatted_path;
1254 }
1255 
1256 // This function is a proxy to fopen, it tries to add a non standard flag (&#39;e&#39; or &#39;N&#39;)
1257 // that ensures automatic closing of the file on exec. If it can not find support in
1258 // the underlying c library, it will make an extra system call (fcntl) to ensure automatic
1259 // closing of the file on exec.
1260 FILE* os::fopen(const char* path, const char* mode) {
1261   char modified_mode[20];
1262   assert(strlen(mode) + 1 &lt; sizeof(modified_mode), &quot;mode chars plus one extra must fit in buffer&quot;);
1263   sprintf(modified_mode, &quot;%s&quot; LINUX_ONLY(&quot;e&quot;) BSD_ONLY(&quot;e&quot;) WINDOWS_ONLY(&quot;N&quot;), mode);
1264   FILE* file = ::fopen(path, modified_mode);
1265 
1266 #if !(defined LINUX || defined BSD || defined _WINDOWS)
1267   // assume fcntl FD_CLOEXEC support as a backup solution when &#39;e&#39; or &#39;N&#39;
1268   // is not supported as mode in fopen
1269   if (file != NULL) {
1270     int fd = fileno(file);
1271     if (fd != -1) {
1272       int fd_flags = fcntl(fd, F_GETFD);
1273       if (fd_flags != -1) {
1274         fcntl(fd, F_SETFD, fd_flags | FD_CLOEXEC);
1275       }
1276     }
1277   }
1278 #endif
1279 
1280   return file;
1281 }
1282 
1283 bool os::set_boot_path(char fileSep, char pathSep) {
1284   const char* home = Arguments::get_java_home();
1285   int home_len = (int)strlen(home);
1286 
1287   struct stat st;
1288 
1289   // modular image if &quot;modules&quot; jimage exists
1290   char* jimage = format_boot_path(&quot;%/lib/&quot; MODULES_IMAGE_NAME, home, home_len, fileSep, pathSep);
1291   if (jimage == NULL) return false;
1292   bool has_jimage = (os::stat(jimage, &amp;st) == 0);
1293   if (has_jimage) {
1294     Arguments::set_sysclasspath(jimage, true);
1295     FREE_C_HEAP_ARRAY(char, jimage);
1296     return true;
1297   }
1298   FREE_C_HEAP_ARRAY(char, jimage);
1299 
1300   // check if developer build with exploded modules
1301   char* base_classes = format_boot_path(&quot;%/modules/&quot; JAVA_BASE_NAME, home, home_len, fileSep, pathSep);
1302   if (base_classes == NULL) return false;
1303   if (os::stat(base_classes, &amp;st) == 0) {
1304     Arguments::set_sysclasspath(base_classes, false);
1305     FREE_C_HEAP_ARRAY(char, base_classes);
1306     return true;
1307   }
1308   FREE_C_HEAP_ARRAY(char, base_classes);
1309 
1310   return false;
1311 }
1312 
1313 /*
1314  * Splits a path, based on its separator, the number of
1315  * elements is returned back in n.
1316  * It is the callers responsibility to:
1317  *   a&gt; check the value of n, and n may be 0.
1318  *   b&gt; ignore any empty path elements
1319  *   c&gt; free up the data.
1320  */
1321 char** os::split_path(const char* path, int* n) {
1322   *n = 0;
1323   if (path == NULL || strlen(path) == 0) {
1324     return NULL;
1325   }
1326   const char psepchar = *os::path_separator();
1327   char* inpath = (char*)NEW_C_HEAP_ARRAY(char, strlen(path) + 1, mtInternal);
1328   if (inpath == NULL) {
1329     return NULL;
1330   }
1331   strcpy(inpath, path);
1332   int count = 1;
1333   char* p = strchr(inpath, psepchar);
1334   // Get a count of elements to allocate memory
1335   while (p != NULL) {
1336     count++;
1337     p++;
1338     p = strchr(p, psepchar);
1339   }
1340   char** opath = (char**) NEW_C_HEAP_ARRAY(char*, count, mtInternal);
1341   if (opath == NULL) {
1342     return NULL;
1343   }
1344 
1345   // do the actual splitting
1346   p = inpath;
1347   for (int i = 0 ; i &lt; count ; i++) {
1348     size_t len = strcspn(p, os::path_separator());
1349     if (len &gt; JVM_MAXPATHLEN) {
1350       return NULL;
1351     }
1352     // allocate the string and add terminator storage
1353     char* s  = (char*)NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);
1354     if (s == NULL) {
1355       return NULL;
1356     }
1357     strncpy(s, p, len);
1358     s[len] = &#39;\0&#39;;
1359     opath[i] = s;
1360     p += len + 1;
1361   }
1362   FREE_C_HEAP_ARRAY(char, inpath);
1363   *n = count;
1364   return opath;
1365 }
1366 
1367 // Returns true if the current stack pointer is above the stack shadow
1368 // pages, false otherwise.
1369 bool os::stack_shadow_pages_available(Thread *thread, const methodHandle&amp; method, address sp) {
1370   if (!thread-&gt;is_Java_thread()) return false;
1371   // Check if we have StackShadowPages above the yellow zone.  This parameter
1372   // is dependent on the depth of the maximum VM call stack possible from
1373   // the handler for stack overflow.  &#39;instanceof&#39; in the stack overflow
1374   // handler or a println uses at least 8k stack of VM and native code
1375   // respectively.
1376   const int framesize_in_bytes =
1377     Interpreter::size_top_interpreter_activation(method()) * wordSize;
1378 
1379   address limit = ((JavaThread*)thread)-&gt;stack_end() +
1380                   (JavaThread::stack_guard_zone_size() + JavaThread::stack_shadow_zone_size());
1381 
1382   return sp &gt; (limit + framesize_in_bytes);
1383 }
1384 
1385 size_t os::page_size_for_region(size_t region_size, size_t min_pages, bool must_be_aligned) {
1386   assert(min_pages &gt; 0, &quot;sanity&quot;);
1387   if (UseLargePages) {
1388     const size_t max_page_size = region_size / min_pages;
1389 
1390     for (size_t i = 0; _page_sizes[i] != 0; ++i) {
1391       const size_t page_size = _page_sizes[i];
1392       if (page_size &lt;= max_page_size) {
1393         if (!must_be_aligned || is_aligned(region_size, page_size)) {
1394           return page_size;
1395         }
1396       }
1397     }
1398   }
1399 
1400   return vm_page_size();
1401 }
1402 
1403 size_t os::page_size_for_region_aligned(size_t region_size, size_t min_pages) {
1404   return page_size_for_region(region_size, min_pages, true);
1405 }
1406 
1407 size_t os::page_size_for_region_unaligned(size_t region_size, size_t min_pages) {
1408   return page_size_for_region(region_size, min_pages, false);
1409 }
1410 
1411 static const char* errno_to_string (int e, bool short_text) {
1412   #define ALL_SHARED_ENUMS(X) \
1413     X(E2BIG, &quot;Argument list too long&quot;) \
1414     X(EACCES, &quot;Permission denied&quot;) \
1415     X(EADDRINUSE, &quot;Address in use&quot;) \
1416     X(EADDRNOTAVAIL, &quot;Address not available&quot;) \
1417     X(EAFNOSUPPORT, &quot;Address family not supported&quot;) \
1418     X(EAGAIN, &quot;Resource unavailable, try again&quot;) \
1419     X(EALREADY, &quot;Connection already in progress&quot;) \
1420     X(EBADF, &quot;Bad file descriptor&quot;) \
1421     X(EBADMSG, &quot;Bad message&quot;) \
1422     X(EBUSY, &quot;Device or resource busy&quot;) \
1423     X(ECANCELED, &quot;Operation canceled&quot;) \
1424     X(ECHILD, &quot;No child processes&quot;) \
1425     X(ECONNABORTED, &quot;Connection aborted&quot;) \
1426     X(ECONNREFUSED, &quot;Connection refused&quot;) \
1427     X(ECONNRESET, &quot;Connection reset&quot;) \
1428     X(EDEADLK, &quot;Resource deadlock would occur&quot;) \
1429     X(EDESTADDRREQ, &quot;Destination address required&quot;) \
1430     X(EDOM, &quot;Mathematics argument out of domain of function&quot;) \
1431     X(EEXIST, &quot;File exists&quot;) \
1432     X(EFAULT, &quot;Bad address&quot;) \
1433     X(EFBIG, &quot;File too large&quot;) \
1434     X(EHOSTUNREACH, &quot;Host is unreachable&quot;) \
1435     X(EIDRM, &quot;Identifier removed&quot;) \
1436     X(EILSEQ, &quot;Illegal byte sequence&quot;) \
1437     X(EINPROGRESS, &quot;Operation in progress&quot;) \
1438     X(EINTR, &quot;Interrupted function&quot;) \
1439     X(EINVAL, &quot;Invalid argument&quot;) \
1440     X(EIO, &quot;I/O error&quot;) \
1441     X(EISCONN, &quot;Socket is connected&quot;) \
1442     X(EISDIR, &quot;Is a directory&quot;) \
1443     X(ELOOP, &quot;Too many levels of symbolic links&quot;) \
1444     X(EMFILE, &quot;Too many open files&quot;) \
1445     X(EMLINK, &quot;Too many links&quot;) \
1446     X(EMSGSIZE, &quot;Message too large&quot;) \
1447     X(ENAMETOOLONG, &quot;Filename too long&quot;) \
1448     X(ENETDOWN, &quot;Network is down&quot;) \
1449     X(ENETRESET, &quot;Connection aborted by network&quot;) \
1450     X(ENETUNREACH, &quot;Network unreachable&quot;) \
1451     X(ENFILE, &quot;Too many files open in system&quot;) \
1452     X(ENOBUFS, &quot;No buffer space available&quot;) \
1453     X(ENODATA, &quot;No message is available on the STREAM head read queue&quot;) \
1454     X(ENODEV, &quot;No such device&quot;) \
1455     X(ENOENT, &quot;No such file or directory&quot;) \
1456     X(ENOEXEC, &quot;Executable file format error&quot;) \
1457     X(ENOLCK, &quot;No locks available&quot;) \
1458     X(ENOLINK, &quot;Reserved&quot;) \
1459     X(ENOMEM, &quot;Not enough space&quot;) \
1460     X(ENOMSG, &quot;No message of the desired type&quot;) \
1461     X(ENOPROTOOPT, &quot;Protocol not available&quot;) \
1462     X(ENOSPC, &quot;No space left on device&quot;) \
1463     X(ENOSR, &quot;No STREAM resources&quot;) \
1464     X(ENOSTR, &quot;Not a STREAM&quot;) \
1465     X(ENOSYS, &quot;Function not supported&quot;) \
1466     X(ENOTCONN, &quot;The socket is not connected&quot;) \
1467     X(ENOTDIR, &quot;Not a directory&quot;) \
1468     X(ENOTEMPTY, &quot;Directory not empty&quot;) \
1469     X(ENOTSOCK, &quot;Not a socket&quot;) \
1470     X(ENOTSUP, &quot;Not supported&quot;) \
1471     X(ENOTTY, &quot;Inappropriate I/O control operation&quot;) \
1472     X(ENXIO, &quot;No such device or address&quot;) \
1473     X(EOPNOTSUPP, &quot;Operation not supported on socket&quot;) \
1474     X(EOVERFLOW, &quot;Value too large to be stored in data type&quot;) \
1475     X(EPERM, &quot;Operation not permitted&quot;) \
1476     X(EPIPE, &quot;Broken pipe&quot;) \
1477     X(EPROTO, &quot;Protocol error&quot;) \
1478     X(EPROTONOSUPPORT, &quot;Protocol not supported&quot;) \
1479     X(EPROTOTYPE, &quot;Protocol wrong type for socket&quot;) \
1480     X(ERANGE, &quot;Result too large&quot;) \
1481     X(EROFS, &quot;Read-only file system&quot;) \
1482     X(ESPIPE, &quot;Invalid seek&quot;) \
1483     X(ESRCH, &quot;No such process&quot;) \
1484     X(ETIME, &quot;Stream ioctl() timeout&quot;) \
1485     X(ETIMEDOUT, &quot;Connection timed out&quot;) \
1486     X(ETXTBSY, &quot;Text file busy&quot;) \
1487     X(EWOULDBLOCK, &quot;Operation would block&quot;) \
1488     X(EXDEV, &quot;Cross-device link&quot;)
1489 
1490   #define DEFINE_ENTRY(e, text) { e, #e, text },
1491 
1492   static const struct {
1493     int v;
1494     const char* short_text;
1495     const char* long_text;
1496   } table [] = {
1497 
1498     ALL_SHARED_ENUMS(DEFINE_ENTRY)
1499 
1500     // The following enums are not defined on all platforms.
1501     #ifdef ESTALE
1502     DEFINE_ENTRY(ESTALE, &quot;Reserved&quot;)
1503     #endif
1504     #ifdef EDQUOT
1505     DEFINE_ENTRY(EDQUOT, &quot;Reserved&quot;)
1506     #endif
1507     #ifdef EMULTIHOP
1508     DEFINE_ENTRY(EMULTIHOP, &quot;Reserved&quot;)
1509     #endif
1510 
1511     // End marker.
1512     { -1, &quot;Unknown errno&quot;, &quot;Unknown error&quot; }
1513 
1514   };
1515 
1516   #undef DEFINE_ENTRY
1517   #undef ALL_FLAGS
1518 
1519   int i = 0;
1520   while (table[i].v != -1 &amp;&amp; table[i].v != e) {
1521     i ++;
1522   }
1523 
1524   return short_text ? table[i].short_text : table[i].long_text;
1525 
1526 }
1527 
1528 const char* os::strerror(int e) {
1529   return errno_to_string(e, false);
1530 }
1531 
1532 const char* os::errno_name(int e) {
1533   return errno_to_string(e, true);
1534 }
1535 
1536 void os::trace_page_sizes(const char* str, const size_t* page_sizes, int count) {
1537   LogTarget(Info, pagesize) log;
1538   if (log.is_enabled()) {
1539     LogStream out(log);
1540 
1541     out.print(&quot;%s: &quot;, str);
1542     for (int i = 0; i &lt; count; ++i) {
1543       out.print(&quot; &quot; SIZE_FORMAT, page_sizes[i]);
1544     }
1545     out.cr();
1546   }
1547 }
1548 
1549 #define trace_page_size_params(size) byte_size_in_exact_unit(size), exact_unit_for_byte_size(size)
1550 
1551 void os::trace_page_sizes(const char* str,
1552                           const size_t region_min_size,
1553                           const size_t region_max_size,
1554                           const size_t page_size,
1555                           const char* base,
1556                           const size_t size) {
1557 
1558   log_info(pagesize)(&quot;%s: &quot;
1559                      &quot; min=&quot; SIZE_FORMAT &quot;%s&quot;
1560                      &quot; max=&quot; SIZE_FORMAT &quot;%s&quot;
1561                      &quot; base=&quot; PTR_FORMAT
1562                      &quot; page_size=&quot; SIZE_FORMAT &quot;%s&quot;
1563                      &quot; size=&quot; SIZE_FORMAT &quot;%s&quot;,
1564                      str,
1565                      trace_page_size_params(region_min_size),
1566                      trace_page_size_params(region_max_size),
1567                      p2i(base),
1568                      trace_page_size_params(page_size),
1569                      trace_page_size_params(size));
1570 }
1571 
1572 void os::trace_page_sizes_for_requested_size(const char* str,
1573                                              const size_t requested_size,
1574                                              const size_t page_size,
1575                                              const size_t alignment,
1576                                              const char* base,
1577                                              const size_t size) {
1578 
1579   log_info(pagesize)(&quot;%s:&quot;
1580                      &quot; req_size=&quot; SIZE_FORMAT &quot;%s&quot;
1581                      &quot; base=&quot; PTR_FORMAT
1582                      &quot; page_size=&quot; SIZE_FORMAT &quot;%s&quot;
1583                      &quot; alignment=&quot; SIZE_FORMAT &quot;%s&quot;
1584                      &quot; size=&quot; SIZE_FORMAT &quot;%s&quot;,
1585                      str,
1586                      trace_page_size_params(requested_size),
1587                      p2i(base),
1588                      trace_page_size_params(page_size),
1589                      trace_page_size_params(alignment),
1590                      trace_page_size_params(size));
1591 }
1592 
1593 
1594 // This is the working definition of a server class machine:
1595 // &gt;= 2 physical CPU&#39;s and &gt;=2GB of memory, with some fuzz
1596 // because the graphics memory (?) sometimes masks physical memory.
1597 // If you want to change the definition of a server class machine
1598 // on some OS or platform, e.g., &gt;=4GB on Windows platforms,
1599 // then you&#39;ll have to parameterize this method based on that state,
1600 // as was done for logical processors here, or replicate and
1601 // specialize this method for each platform.  (Or fix os to have
1602 // some inheritance structure and use subclassing.  Sigh.)
1603 // If you want some platform to always or never behave as a server
1604 // class machine, change the setting of AlwaysActAsServerClassMachine
1605 // and NeverActAsServerClassMachine in globals*.hpp.
1606 bool os::is_server_class_machine() {
1607   // First check for the early returns
1608   if (NeverActAsServerClassMachine) {
1609     return false;
1610   }
1611   if (AlwaysActAsServerClassMachine) {
1612     return true;
1613   }
1614   // Then actually look at the machine
1615   bool         result            = false;
1616   const unsigned int    server_processors = 2;
1617   const julong server_memory     = 2UL * G;
1618   // We seem not to get our full complement of memory.
1619   //     We allow some part (1/8?) of the memory to be &quot;missing&quot;,
1620   //     based on the sizes of DIMMs, and maybe graphics cards.
1621   const julong missing_memory   = 256UL * M;
1622 
1623   /* Is this a server class machine? */
1624   if ((os::active_processor_count() &gt;= (int)server_processors) &amp;&amp;
1625       (os::physical_memory() &gt;= (server_memory - missing_memory))) {
1626     const unsigned int logical_processors =
1627       VM_Version::logical_processors_per_package();
1628     if (logical_processors &gt; 1) {
1629       const unsigned int physical_packages =
1630         os::active_processor_count() / logical_processors;
1631       if (physical_packages &gt;= server_processors) {
1632         result = true;
1633       }
1634     } else {
1635       result = true;
1636     }
1637   }
1638   return result;
1639 }
1640 
1641 void os::initialize_initial_active_processor_count() {
1642   assert(_initial_active_processor_count == 0, &quot;Initial active processor count already set.&quot;);
1643   _initial_active_processor_count = active_processor_count();
1644   log_debug(os)(&quot;Initial active processor count set to %d&quot; , _initial_active_processor_count);
1645 }
1646 
1647 void os::SuspendedThreadTask::run() {
1648   internal_do_task();
1649   _done = true;
1650 }
1651 
1652 bool os::create_stack_guard_pages(char* addr, size_t bytes) {
1653   return os::pd_create_stack_guard_pages(addr, bytes);
1654 }
1655 
1656 char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc) {
1657   char* result = NULL;
1658 
1659   if (file_desc != -1) {
1660     // Could have called pd_reserve_memory() followed by replace_existing_mapping_with_file_mapping(),
1661     // but AIX may use SHM in which case its more trouble to detach the segment and remap memory to the file.
1662     result = os::map_memory_to_file(addr, bytes, file_desc);
1663     if (result != NULL) {
1664       MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1665     }
1666   } else {
1667     result = pd_reserve_memory(bytes, addr, alignment_hint);
1668     if (result != NULL) {
1669       MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1670     }
1671   }
1672 
1673   return result;
1674 }
1675 
1676 char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint,
1677    MEMFLAGS flags) {
1678   char* result = pd_reserve_memory(bytes, addr, alignment_hint);
1679   if (result != NULL) {
1680     MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1681     MemTracker::record_virtual_memory_type((address)result, flags);
1682   }
1683 
1684   return result;
1685 }
1686 
1687 char* os::attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc) {
1688   char* result = NULL;
1689   if (file_desc != -1) {
1690     result = pd_attempt_reserve_memory_at(bytes, addr, file_desc);
1691     if (result != NULL) {
1692       MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1693     }
1694   } else {
1695     result = pd_attempt_reserve_memory_at(bytes, addr);
1696     if (result != NULL) {
1697       MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1698     }
1699   }
1700   return result;
1701 }
1702 
1703 void os::split_reserved_memory(char *base, size_t size,
1704                                  size_t split, bool realloc) {
1705   pd_split_reserved_memory(base, size, split, realloc);
1706 }
1707 
1708 bool os::commit_memory(char* addr, size_t bytes, bool executable) {
1709   bool res = pd_commit_memory(addr, bytes, executable);
1710   if (res) {
1711     MemTracker::record_virtual_memory_commit((address)addr, bytes, CALLER_PC);
1712   }
1713   return res;
1714 }
1715 
1716 bool os::commit_memory(char* addr, size_t size, size_t alignment_hint,
1717                               bool executable) {
1718   bool res = os::pd_commit_memory(addr, size, alignment_hint, executable);
1719   if (res) {
1720     MemTracker::record_virtual_memory_commit((address)addr, size, CALLER_PC);
1721   }
1722   return res;
1723 }
1724 
1725 void os::commit_memory_or_exit(char* addr, size_t bytes, bool executable,
1726                                const char* mesg) {
1727   pd_commit_memory_or_exit(addr, bytes, executable, mesg);
1728   MemTracker::record_virtual_memory_commit((address)addr, bytes, CALLER_PC);
1729 }
1730 
1731 void os::commit_memory_or_exit(char* addr, size_t size, size_t alignment_hint,
1732                                bool executable, const char* mesg) {
1733   os::pd_commit_memory_or_exit(addr, size, alignment_hint, executable, mesg);
1734   MemTracker::record_virtual_memory_commit((address)addr, size, CALLER_PC);
1735 }
1736 
1737 bool os::uncommit_memory(char* addr, size_t bytes) {
1738   bool res;
1739   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1740     Tracker tkr(Tracker::uncommit);
1741     res = pd_uncommit_memory(addr, bytes);
1742     if (res) {
1743       tkr.record((address)addr, bytes);
1744     }
1745   } else {
1746     res = pd_uncommit_memory(addr, bytes);
1747   }
1748   return res;
1749 }
1750 
1751 bool os::release_memory(char* addr, size_t bytes) {
1752   bool res;
1753   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1754     Tracker tkr(Tracker::release);
1755     res = pd_release_memory(addr, bytes);
1756     if (res) {
1757       tkr.record((address)addr, bytes);
1758     }
1759   } else {
1760     res = pd_release_memory(addr, bytes);
1761   }
1762   return res;
1763 }
1764 
1765 void os::pretouch_memory(void* start, void* end, size_t page_size) {
1766   for (volatile char *p = (char*)start; p &lt; (char*)end; p += page_size) {
1767     *p = 0;
1768   }
1769 }
1770 
1771 char* os::map_memory(int fd, const char* file_name, size_t file_offset,
1772                            char *addr, size_t bytes, bool read_only,
1773                            bool allow_exec) {
1774   char* result = pd_map_memory(fd, file_name, file_offset, addr, bytes, read_only, allow_exec);
1775   if (result != NULL) {
1776     MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1777   }
1778   return result;
1779 }
1780 
1781 char* os::remap_memory(int fd, const char* file_name, size_t file_offset,
1782                              char *addr, size_t bytes, bool read_only,
1783                              bool allow_exec) {
1784   return pd_remap_memory(fd, file_name, file_offset, addr, bytes,
1785                     read_only, allow_exec);
1786 }
1787 
1788 bool os::unmap_memory(char *addr, size_t bytes) {
1789   bool result;
1790   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1791     Tracker tkr(Tracker::release);
1792     result = pd_unmap_memory(addr, bytes);
1793     if (result) {
1794       tkr.record((address)addr, bytes);
1795     }
1796   } else {
1797     result = pd_unmap_memory(addr, bytes);
1798   }
1799   return result;
1800 }
1801 
1802 void os::free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1803   pd_free_memory(addr, bytes, alignment_hint);
1804 }
1805 
1806 void os::realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1807   pd_realign_memory(addr, bytes, alignment_hint);
1808 }
1809 
1810 #ifndef _WINDOWS
1811 /* try to switch state from state &quot;from&quot; to state &quot;to&quot;
1812  * returns the state set after the method is complete
1813  */
1814 os::SuspendResume::State os::SuspendResume::switch_state(os::SuspendResume::State from,
1815                                                          os::SuspendResume::State to)
1816 {
1817   os::SuspendResume::State result = Atomic::cmpxchg(to, &amp;_state, from);
1818   if (result == from) {
1819     // success
1820     return to;
1821   }
1822   return result;
1823 }
1824 #endif
    </pre>
  </body>
</html>