<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/sharedRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/compiledIC.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/compiledMethod.inline.hpp&quot;
  35 #include &quot;code/scopeDesc.hpp&quot;
  36 #include &quot;code/vtableStubs.hpp&quot;
  37 #include &quot;compiler/abstractCompiler.hpp&quot;
  38 #include &quot;compiler/compileBroker.hpp&quot;
  39 #include &quot;compiler/disassembler.hpp&quot;
  40 #include &quot;gc/shared/barrierSet.hpp&quot;
  41 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  42 #include &quot;interpreter/interpreter.hpp&quot;
  43 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  44 #include &quot;jfr/jfrEvents.hpp&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;memory/metaspaceShared.hpp&quot;
  47 #include &quot;memory/resourceArea.hpp&quot;
  48 #include &quot;memory/universe.hpp&quot;
  49 #include &quot;oops/klass.hpp&quot;
  50 #include &quot;oops/method.inline.hpp&quot;
  51 #include &quot;oops/objArrayKlass.hpp&quot;
  52 #include &quot;oops/oop.inline.hpp&quot;
  53 #include &quot;prims/forte.hpp&quot;
  54 #include &quot;prims/jvmtiExport.hpp&quot;
  55 #include &quot;prims/methodHandles.hpp&quot;
  56 #include &quot;prims/nativeLookup.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/atomic.hpp&quot;
  59 #include &quot;runtime/biasedLocking.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed">  60 #include &quot;runtime/compilationPolicy.hpp&quot;</span>
  61 #include &quot;runtime/frame.inline.hpp&quot;
  62 #include &quot;runtime/handles.inline.hpp&quot;
  63 #include &quot;runtime/init.hpp&quot;
  64 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  65 #include &quot;runtime/java.hpp&quot;
  66 #include &quot;runtime/javaCalls.hpp&quot;
  67 #include &quot;runtime/sharedRuntime.hpp&quot;
  68 #include &quot;runtime/stubRoutines.hpp&quot;
  69 #include &quot;runtime/vframe.inline.hpp&quot;
  70 #include &quot;runtime/vframeArray.hpp&quot;
  71 #include &quot;utilities/copy.hpp&quot;
  72 #include &quot;utilities/dtrace.hpp&quot;
  73 #include &quot;utilities/events.hpp&quot;
  74 #include &quot;utilities/hashtable.inline.hpp&quot;
  75 #include &quot;utilities/macros.hpp&quot;
  76 #include &quot;utilities/xmlstream.hpp&quot;
  77 #ifdef COMPILER1
  78 #include &quot;c1/c1_Runtime1.hpp&quot;
  79 #endif
  80 #if INCLUDE_TSAN
  81 #include &quot;tsan/tsanExternalDecls.hpp&quot;
  82 #include &quot;tsan/tsanOopMap.hpp&quot;
  83 #endif
  84 
  85 // Shared stub locations
  86 RuntimeStub*        SharedRuntime::_wrong_method_blob;
  87 RuntimeStub*        SharedRuntime::_wrong_method_abstract_blob;
  88 RuntimeStub*        SharedRuntime::_ic_miss_blob;
  89 RuntimeStub*        SharedRuntime::_resolve_opt_virtual_call_blob;
  90 RuntimeStub*        SharedRuntime::_resolve_virtual_call_blob;
  91 RuntimeStub*        SharedRuntime::_resolve_static_call_blob;
  92 address             SharedRuntime::_resolve_static_call_entry;
  93 
  94 DeoptimizationBlob* SharedRuntime::_deopt_blob;
  95 SafepointBlob*      SharedRuntime::_polling_page_vectors_safepoint_handler_blob;
  96 SafepointBlob*      SharedRuntime::_polling_page_safepoint_handler_blob;
  97 SafepointBlob*      SharedRuntime::_polling_page_return_handler_blob;
  98 
  99 #ifdef COMPILER2
 100 UncommonTrapBlob*   SharedRuntime::_uncommon_trap_blob;
 101 #endif // COMPILER2
 102 
 103 
 104 //----------------------------generate_stubs-----------------------------------
 105 void SharedRuntime::generate_stubs() {
 106   _wrong_method_blob                   = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method),          &quot;wrong_method_stub&quot;);
 107   _wrong_method_abstract_blob          = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_abstract), &quot;wrong_method_abstract_stub&quot;);
 108   _ic_miss_blob                        = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_ic_miss),  &quot;ic_miss_stub&quot;);
 109   _resolve_opt_virtual_call_blob       = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_opt_virtual_call_C),   &quot;resolve_opt_virtual_call&quot;);
 110   _resolve_virtual_call_blob           = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_virtual_call_C),       &quot;resolve_virtual_call&quot;);
 111   _resolve_static_call_blob            = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_static_call_C),        &quot;resolve_static_call&quot;);
 112   _resolve_static_call_entry           = _resolve_static_call_blob-&gt;entry_point();
 113 
 114 #if COMPILER2_OR_JVMCI
 115   // Vectors are generated only by C2 and JVMCI.
 116   bool support_wide = is_wide_vector(MaxVectorSize);
 117   if (support_wide) {
 118     _polling_page_vectors_safepoint_handler_blob = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_VECTOR_LOOP);
 119   }
 120 #endif // COMPILER2_OR_JVMCI
 121   _polling_page_safepoint_handler_blob = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_LOOP);
 122   _polling_page_return_handler_blob    = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_RETURN);
 123 
 124   generate_deopt_blob();
 125 
 126 #ifdef COMPILER2
 127   generate_uncommon_trap_blob();
 128 #endif // COMPILER2
 129 }
 130 
 131 #include &lt;math.h&gt;
 132 
 133 // Implementation of SharedRuntime
 134 
 135 #ifndef PRODUCT
 136 // For statistics
 137 int SharedRuntime::_ic_miss_ctr = 0;
 138 int SharedRuntime::_wrong_method_ctr = 0;
 139 int SharedRuntime::_resolve_static_ctr = 0;
 140 int SharedRuntime::_resolve_virtual_ctr = 0;
 141 int SharedRuntime::_resolve_opt_virtual_ctr = 0;
 142 int SharedRuntime::_implicit_null_throws = 0;
 143 int SharedRuntime::_implicit_div0_throws = 0;
 144 int SharedRuntime::_throw_null_ctr = 0;
 145 
 146 int SharedRuntime::_nof_normal_calls = 0;
 147 int SharedRuntime::_nof_optimized_calls = 0;
 148 int SharedRuntime::_nof_inlined_calls = 0;
 149 int SharedRuntime::_nof_megamorphic_calls = 0;
 150 int SharedRuntime::_nof_static_calls = 0;
 151 int SharedRuntime::_nof_inlined_static_calls = 0;
 152 int SharedRuntime::_nof_interface_calls = 0;
 153 int SharedRuntime::_nof_optimized_interface_calls = 0;
 154 int SharedRuntime::_nof_inlined_interface_calls = 0;
 155 int SharedRuntime::_nof_megamorphic_interface_calls = 0;
 156 int SharedRuntime::_nof_removable_exceptions = 0;
 157 
 158 int SharedRuntime::_new_instance_ctr=0;
 159 int SharedRuntime::_new_array_ctr=0;
 160 int SharedRuntime::_multi1_ctr=0;
 161 int SharedRuntime::_multi2_ctr=0;
 162 int SharedRuntime::_multi3_ctr=0;
 163 int SharedRuntime::_multi4_ctr=0;
 164 int SharedRuntime::_multi5_ctr=0;
 165 int SharedRuntime::_mon_enter_stub_ctr=0;
 166 int SharedRuntime::_mon_exit_stub_ctr=0;
 167 int SharedRuntime::_mon_enter_ctr=0;
 168 int SharedRuntime::_mon_exit_ctr=0;
 169 int SharedRuntime::_partial_subtype_ctr=0;
 170 int SharedRuntime::_jbyte_array_copy_ctr=0;
 171 int SharedRuntime::_jshort_array_copy_ctr=0;
 172 int SharedRuntime::_jint_array_copy_ctr=0;
 173 int SharedRuntime::_jlong_array_copy_ctr=0;
 174 int SharedRuntime::_oop_array_copy_ctr=0;
 175 int SharedRuntime::_checkcast_array_copy_ctr=0;
 176 int SharedRuntime::_unsafe_array_copy_ctr=0;
 177 int SharedRuntime::_generic_array_copy_ctr=0;
 178 int SharedRuntime::_slow_array_copy_ctr=0;
 179 int SharedRuntime::_find_handler_ctr=0;
 180 int SharedRuntime::_rethrow_ctr=0;
 181 
 182 int     SharedRuntime::_ICmiss_index                    = 0;
 183 int     SharedRuntime::_ICmiss_count[SharedRuntime::maxICmiss_count];
 184 address SharedRuntime::_ICmiss_at[SharedRuntime::maxICmiss_count];
 185 
 186 
 187 void SharedRuntime::trace_ic_miss(address at) {
 188   for (int i = 0; i &lt; _ICmiss_index; i++) {
 189     if (_ICmiss_at[i] == at) {
 190       _ICmiss_count[i]++;
 191       return;
 192     }
 193   }
 194   int index = _ICmiss_index++;
 195   if (_ICmiss_index &gt;= maxICmiss_count) _ICmiss_index = maxICmiss_count - 1;
 196   _ICmiss_at[index] = at;
 197   _ICmiss_count[index] = 1;
 198 }
 199 
 200 void SharedRuntime::print_ic_miss_histogram() {
 201   if (ICMissHistogram) {
 202     tty-&gt;print_cr(&quot;IC Miss Histogram:&quot;);
 203     int tot_misses = 0;
 204     for (int i = 0; i &lt; _ICmiss_index; i++) {
 205       tty-&gt;print_cr(&quot;  at: &quot; INTPTR_FORMAT &quot;  nof: %d&quot;, p2i(_ICmiss_at[i]), _ICmiss_count[i]);
 206       tot_misses += _ICmiss_count[i];
 207     }
 208     tty-&gt;print_cr(&quot;Total IC misses: %7d&quot;, tot_misses);
 209   }
 210 }
 211 #endif // PRODUCT
 212 
 213 
 214 JRT_LEAF(jlong, SharedRuntime::lmul(jlong y, jlong x))
 215   return x * y;
 216 JRT_END
 217 
 218 
 219 JRT_LEAF(jlong, SharedRuntime::ldiv(jlong y, jlong x))
 220   if (x == min_jlong &amp;&amp; y == CONST64(-1)) {
 221     return x;
 222   } else {
 223     return x / y;
 224   }
 225 JRT_END
 226 
 227 
 228 JRT_LEAF(jlong, SharedRuntime::lrem(jlong y, jlong x))
 229   if (x == min_jlong &amp;&amp; y == CONST64(-1)) {
 230     return 0;
 231   } else {
 232     return x % y;
 233   }
 234 JRT_END
 235 
 236 
 237 const juint  float_sign_mask  = 0x7FFFFFFF;
 238 const juint  float_infinity   = 0x7F800000;
 239 const julong double_sign_mask = CONST64(0x7FFFFFFFFFFFFFFF);
 240 const julong double_infinity  = CONST64(0x7FF0000000000000);
 241 
 242 JRT_LEAF(jfloat, SharedRuntime::frem(jfloat  x, jfloat  y))
 243 #ifdef _WIN64
 244   // 64-bit Windows on amd64 returns the wrong values for
 245   // infinity operands.
 246   union { jfloat f; juint i; } xbits, ybits;
 247   xbits.f = x;
 248   ybits.f = y;
 249   // x Mod Infinity == x unless x is infinity
 250   if (((xbits.i &amp; float_sign_mask) != float_infinity) &amp;&amp;
 251        ((ybits.i &amp; float_sign_mask) == float_infinity) ) {
 252     return x;
 253   }
 254   return ((jfloat)fmod_winx64((double)x, (double)y));
 255 #else
 256   return ((jfloat)fmod((double)x,(double)y));
 257 #endif
 258 JRT_END
 259 
 260 
 261 JRT_LEAF(jdouble, SharedRuntime::drem(jdouble x, jdouble y))
 262 #ifdef _WIN64
 263   union { jdouble d; julong l; } xbits, ybits;
 264   xbits.d = x;
 265   ybits.d = y;
 266   // x Mod Infinity == x unless x is infinity
 267   if (((xbits.l &amp; double_sign_mask) != double_infinity) &amp;&amp;
 268        ((ybits.l &amp; double_sign_mask) == double_infinity) ) {
 269     return x;
 270   }
 271   return ((jdouble)fmod_winx64((double)x, (double)y));
 272 #else
 273   return ((jdouble)fmod((double)x,(double)y));
 274 #endif
 275 JRT_END
 276 
 277 #ifdef __SOFTFP__
 278 JRT_LEAF(jfloat, SharedRuntime::fadd(jfloat x, jfloat y))
 279   return x + y;
 280 JRT_END
 281 
 282 JRT_LEAF(jfloat, SharedRuntime::fsub(jfloat x, jfloat y))
 283   return x - y;
 284 JRT_END
 285 
 286 JRT_LEAF(jfloat, SharedRuntime::fmul(jfloat x, jfloat y))
 287   return x * y;
 288 JRT_END
 289 
 290 JRT_LEAF(jfloat, SharedRuntime::fdiv(jfloat x, jfloat y))
 291   return x / y;
 292 JRT_END
 293 
 294 JRT_LEAF(jdouble, SharedRuntime::dadd(jdouble x, jdouble y))
 295   return x + y;
 296 JRT_END
 297 
 298 JRT_LEAF(jdouble, SharedRuntime::dsub(jdouble x, jdouble y))
 299   return x - y;
 300 JRT_END
 301 
 302 JRT_LEAF(jdouble, SharedRuntime::dmul(jdouble x, jdouble y))
 303   return x * y;
 304 JRT_END
 305 
 306 JRT_LEAF(jdouble, SharedRuntime::ddiv(jdouble x, jdouble y))
 307   return x / y;
 308 JRT_END
 309 
 310 JRT_LEAF(jfloat, SharedRuntime::i2f(jint x))
 311   return (jfloat)x;
 312 JRT_END
 313 
 314 JRT_LEAF(jdouble, SharedRuntime::i2d(jint x))
 315   return (jdouble)x;
 316 JRT_END
 317 
 318 JRT_LEAF(jdouble, SharedRuntime::f2d(jfloat x))
 319   return (jdouble)x;
 320 JRT_END
 321 
 322 JRT_LEAF(int,  SharedRuntime::fcmpl(float x, float y))
 323   return x&gt;y ? 1 : (x==y ? 0 : -1);  /* x&lt;y or is_nan*/
 324 JRT_END
 325 
 326 JRT_LEAF(int,  SharedRuntime::fcmpg(float x, float y))
 327   return x&lt;y ? -1 : (x==y ? 0 : 1);  /* x&gt;y or is_nan */
 328 JRT_END
 329 
 330 JRT_LEAF(int,  SharedRuntime::dcmpl(double x, double y))
 331   return x&gt;y ? 1 : (x==y ? 0 : -1); /* x&lt;y or is_nan */
 332 JRT_END
 333 
 334 JRT_LEAF(int,  SharedRuntime::dcmpg(double x, double y))
 335   return x&lt;y ? -1 : (x==y ? 0 : 1);  /* x&gt;y or is_nan */
 336 JRT_END
 337 
 338 // Functions to return the opposite of the aeabi functions for nan.
 339 JRT_LEAF(int, SharedRuntime::unordered_fcmplt(float x, float y))
 340   return (x &lt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 341 JRT_END
 342 
 343 JRT_LEAF(int, SharedRuntime::unordered_dcmplt(double x, double y))
 344   return (x &lt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 345 JRT_END
 346 
 347 JRT_LEAF(int, SharedRuntime::unordered_fcmple(float x, float y))
 348   return (x &lt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 349 JRT_END
 350 
 351 JRT_LEAF(int, SharedRuntime::unordered_dcmple(double x, double y))
 352   return (x &lt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 353 JRT_END
 354 
 355 JRT_LEAF(int, SharedRuntime::unordered_fcmpge(float x, float y))
 356   return (x &gt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 357 JRT_END
 358 
 359 JRT_LEAF(int, SharedRuntime::unordered_dcmpge(double x, double y))
 360   return (x &gt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 361 JRT_END
 362 
 363 JRT_LEAF(int, SharedRuntime::unordered_fcmpgt(float x, float y))
 364   return (x &gt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 365 JRT_END
 366 
 367 JRT_LEAF(int, SharedRuntime::unordered_dcmpgt(double x, double y))
 368   return (x &gt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 369 JRT_END
 370 
 371 // Intrinsics make gcc generate code for these.
 372 float  SharedRuntime::fneg(float f)   {
 373   return -f;
 374 }
 375 
 376 double SharedRuntime::dneg(double f)  {
 377   return -f;
 378 }
 379 
 380 #endif // __SOFTFP__
 381 
 382 #if defined(__SOFTFP__) || defined(E500V2)
 383 // Intrinsics make gcc generate code for these.
 384 double SharedRuntime::dabs(double f)  {
 385   return (f &lt;= (double)0.0) ? (double)0.0 - f : f;
 386 }
 387 
 388 #endif
 389 
 390 #if defined(__SOFTFP__) || defined(PPC)
 391 double SharedRuntime::dsqrt(double f) {
 392   return sqrt(f);
 393 }
 394 #endif
 395 
 396 JRT_LEAF(jint, SharedRuntime::f2i(jfloat  x))
 397   if (g_isnan(x))
 398     return 0;
 399   if (x &gt;= (jfloat) max_jint)
 400     return max_jint;
 401   if (x &lt;= (jfloat) min_jint)
 402     return min_jint;
 403   return (jint) x;
 404 JRT_END
 405 
 406 
 407 JRT_LEAF(jlong, SharedRuntime::f2l(jfloat  x))
 408   if (g_isnan(x))
 409     return 0;
 410   if (x &gt;= (jfloat) max_jlong)
 411     return max_jlong;
 412   if (x &lt;= (jfloat) min_jlong)
 413     return min_jlong;
 414   return (jlong) x;
 415 JRT_END
 416 
 417 
 418 JRT_LEAF(jint, SharedRuntime::d2i(jdouble x))
 419   if (g_isnan(x))
 420     return 0;
 421   if (x &gt;= (jdouble) max_jint)
 422     return max_jint;
 423   if (x &lt;= (jdouble) min_jint)
 424     return min_jint;
 425   return (jint) x;
 426 JRT_END
 427 
 428 
 429 JRT_LEAF(jlong, SharedRuntime::d2l(jdouble x))
 430   if (g_isnan(x))
 431     return 0;
 432   if (x &gt;= (jdouble) max_jlong)
 433     return max_jlong;
 434   if (x &lt;= (jdouble) min_jlong)
 435     return min_jlong;
 436   return (jlong) x;
 437 JRT_END
 438 
 439 
 440 JRT_LEAF(jfloat, SharedRuntime::d2f(jdouble x))
 441   return (jfloat)x;
 442 JRT_END
 443 
 444 
 445 JRT_LEAF(jfloat, SharedRuntime::l2f(jlong x))
 446   return (jfloat)x;
 447 JRT_END
 448 
 449 
 450 JRT_LEAF(jdouble, SharedRuntime::l2d(jlong x))
 451   return (jdouble)x;
 452 JRT_END
 453 
 454 // Exception handling across interpreter/compiler boundaries
 455 //
 456 // exception_handler_for_return_address(...) returns the continuation address.
 457 // The continuation address is the entry point of the exception handler of the
 458 // previous frame depending on the return address.
 459 
 460 address SharedRuntime::raw_exception_handler_for_return_address(JavaThread* thread, address return_address) {
 461   assert(frame::verify_return_pc(return_address), &quot;must be a return address: &quot; INTPTR_FORMAT, p2i(return_address));
 462   assert(thread-&gt;frames_to_pop_failed_realloc() == 0 || Interpreter::contains(return_address), &quot;missed frames to pop?&quot;);
 463 
 464   // Reset method handle flag.
 465   thread-&gt;set_is_method_handle_return(false);
 466 
 467 #if INCLUDE_JVMCI
 468   // JVMCI&#39;s ExceptionHandlerStub expects the thread local exception PC to be clear
 469   // and other exception handler continuations do not read it
 470   thread-&gt;set_exception_pc(NULL);
 471 #endif // INCLUDE_JVMCI
 472 
 473   // The fastest case first
 474   CodeBlob* blob = CodeCache::find_blob(return_address);
 475   CompiledMethod* nm = (blob != NULL) ? blob-&gt;as_compiled_method_or_null() : NULL;
 476   if (nm != NULL) {
 477     // Set flag if return address is a method handle call site.
 478     thread-&gt;set_is_method_handle_return(nm-&gt;is_method_handle_return(return_address));
 479     // native nmethods don&#39;t have exception handlers
 480     assert(!nm-&gt;is_native_method(), &quot;no exception handler&quot;);
 481     assert(nm-&gt;header_begin() != nm-&gt;exception_begin(), &quot;no exception handler&quot;);
 482     if (nm-&gt;is_deopt_pc(return_address)) {
 483       // If we come here because of a stack overflow, the stack may be
 484       // unguarded. Reguard the stack otherwise if we return to the
 485       // deopt blob and the stack bang causes a stack overflow we
 486       // crash.
 487       bool guard_pages_enabled = thread-&gt;stack_guards_enabled();
 488       if (!guard_pages_enabled) guard_pages_enabled = thread-&gt;reguard_stack();
 489       if (thread-&gt;reserved_stack_activation() != thread-&gt;stack_base()) {
 490         thread-&gt;set_reserved_stack_activation(thread-&gt;stack_base());
 491       }
 492       assert(guard_pages_enabled, &quot;stack banging in deopt blob may cause crash&quot;);
 493       return SharedRuntime::deopt_blob()-&gt;unpack_with_exception();
 494     } else {
 495       return nm-&gt;exception_begin();
 496     }
 497   }
 498 
 499   // Entry code
 500   if (StubRoutines::returns_to_call_stub(return_address)) {
 501     return StubRoutines::catch_exception_entry();
 502   }
 503   // Interpreted code
 504   if (Interpreter::contains(return_address)) {
 505     return Interpreter::rethrow_exception_entry();
 506   }
 507 
 508   guarantee(blob == NULL || !blob-&gt;is_runtime_stub(), &quot;caller should have skipped stub&quot;);
 509   guarantee(!VtableStubs::contains(return_address), &quot;NULL exceptions in vtables should have been handled already!&quot;);
 510 
 511 #ifndef PRODUCT
 512   { ResourceMark rm;
 513     tty-&gt;print_cr(&quot;No exception handler found for exception at &quot; INTPTR_FORMAT &quot; - potential problems:&quot;, p2i(return_address));
 514     tty-&gt;print_cr(&quot;a) exception happened in (new?) code stubs/buffers that is not handled here&quot;);
 515     tty-&gt;print_cr(&quot;b) other problem&quot;);
 516   }
 517 #endif // PRODUCT
 518 
 519   ShouldNotReachHere();
 520   return NULL;
 521 }
 522 
 523 
 524 JRT_LEAF(address, SharedRuntime::exception_handler_for_return_address(JavaThread* thread, address return_address))
 525   return raw_exception_handler_for_return_address(thread, return_address);
 526 JRT_END
 527 
 528 
 529 address SharedRuntime::get_poll_stub(address pc) {
 530   address stub;
 531   // Look up the code blob
 532   CodeBlob *cb = CodeCache::find_blob(pc);
 533 
 534   // Should be an nmethod
 535   guarantee(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;safepoint polling: pc must refer to an nmethod&quot;);
 536 
 537   // Look up the relocation information
 538   assert(((CompiledMethod*)cb)-&gt;is_at_poll_or_poll_return(pc),
 539     &quot;safepoint polling: type must be poll&quot;);
 540 
 541 #ifdef ASSERT
 542   if (!((NativeInstruction*)pc)-&gt;is_safepoint_poll()) {
 543     tty-&gt;print_cr(&quot;bad pc: &quot; PTR_FORMAT, p2i(pc));
 544     Disassembler::decode(cb);
 545     fatal(&quot;Only polling locations are used for safepoint&quot;);
 546   }
 547 #endif
 548 
 549   bool at_poll_return = ((CompiledMethod*)cb)-&gt;is_at_poll_return(pc);
 550   bool has_wide_vectors = ((CompiledMethod*)cb)-&gt;has_wide_vectors();
 551   if (at_poll_return) {
 552     assert(SharedRuntime::polling_page_return_handler_blob() != NULL,
 553            &quot;polling page return stub not created yet&quot;);
 554     stub = SharedRuntime::polling_page_return_handler_blob()-&gt;entry_point();
 555   } else if (has_wide_vectors) {
 556     assert(SharedRuntime::polling_page_vectors_safepoint_handler_blob() != NULL,
 557            &quot;polling page vectors safepoint stub not created yet&quot;);
 558     stub = SharedRuntime::polling_page_vectors_safepoint_handler_blob()-&gt;entry_point();
 559   } else {
 560     assert(SharedRuntime::polling_page_safepoint_handler_blob() != NULL,
 561            &quot;polling page safepoint stub not created yet&quot;);
 562     stub = SharedRuntime::polling_page_safepoint_handler_blob()-&gt;entry_point();
 563   }
 564   log_debug(safepoint)(&quot;... found polling page %s exception at pc = &quot;
 565                        INTPTR_FORMAT &quot;, stub =&quot; INTPTR_FORMAT,
 566                        at_poll_return ? &quot;return&quot; : &quot;loop&quot;,
 567                        (intptr_t)pc, (intptr_t)stub);
 568   return stub;
 569 }
 570 
 571 
 572 oop SharedRuntime::retrieve_receiver( Symbol* sig, frame caller ) {
 573   assert(caller.is_interpreted_frame(), &quot;&quot;);
 574   int args_size = ArgumentSizeComputer(sig).size() + 1;
 575   assert(args_size &lt;= caller.interpreter_frame_expression_stack_size(), &quot;receiver must be on interpreter stack&quot;);
 576   oop result = cast_to_oop(*caller.interpreter_frame_tos_at(args_size - 1));
 577   assert(Universe::heap()-&gt;is_in(result) &amp;&amp; oopDesc::is_oop(result), &quot;receiver must be an oop&quot;);
 578   return result;
 579 }
 580 
 581 
 582 void SharedRuntime::throw_and_post_jvmti_exception(JavaThread *thread, Handle h_exception) {
 583   if (JvmtiExport::can_post_on_exceptions()) {
 584     vframeStream vfst(thread, true);
 585     methodHandle method = methodHandle(thread, vfst.method());
 586     address bcp = method()-&gt;bcp_from(vfst.bci());
 587     JvmtiExport::post_exception_throw(thread, method(), bcp, h_exception());
 588   }
 589   Exceptions::_throw(thread, __FILE__, __LINE__, h_exception);
 590 }
 591 
 592 void SharedRuntime::throw_and_post_jvmti_exception(JavaThread *thread, Symbol* name, const char *message) {
 593   Handle h_exception = Exceptions::new_exception(thread, name, message);
 594   throw_and_post_jvmti_exception(thread, h_exception);
 595 }
 596 
 597 // The interpreter code to call this tracing function is only
 598 // called/generated when UL is on for redefine, class and has the right level
 599 // and tags. Since obsolete methods are never compiled, we don&#39;t have
 600 // to modify the compilers to generate calls to this function.
 601 //
 602 JRT_LEAF(int, SharedRuntime::rc_trace_method_entry(
 603     JavaThread* thread, Method* method))
 604   if (method-&gt;is_obsolete()) {
 605     // We are calling an obsolete method, but this is not necessarily
 606     // an error. Our method could have been redefined just after we
 607     // fetched the Method* from the constant pool.
 608     ResourceMark rm;
 609     log_trace(redefine, class, obsolete)(&quot;calling obsolete method &#39;%s&#39;&quot;, method-&gt;name_and_sig_as_C_string());
 610   }
 611   return 0;
 612 JRT_END
 613 
 614 // ret_pc points into caller; we are returning caller&#39;s exception handler
 615 // for given exception
 616 address SharedRuntime::compute_compiled_exc_handler(CompiledMethod* cm, address ret_pc, Handle&amp; exception,
 617                                                     bool force_unwind, bool top_frame_only, bool&amp; recursive_exception_occurred) {
 618   assert(cm != NULL, &quot;must exist&quot;);
 619   ResourceMark rm;
 620 
 621 #if INCLUDE_JVMCI
 622   if (cm-&gt;is_compiled_by_jvmci()) {
 623     // lookup exception handler for this pc
 624     int catch_pco = ret_pc - cm-&gt;code_begin();
 625     ExceptionHandlerTable table(cm);
 626     HandlerTableEntry *t = table.entry_for(catch_pco, -1, 0);
 627     if (t != NULL) {
 628       return cm-&gt;code_begin() + t-&gt;pco();
 629     } else {
 630       return Deoptimization::deoptimize_for_missing_exception_handler(cm);
 631     }
 632   }
 633 #endif // INCLUDE_JVMCI
 634 
 635   nmethod* nm = cm-&gt;as_nmethod();
 636   ScopeDesc* sd = nm-&gt;scope_desc_at(ret_pc);
 637   // determine handler bci, if any
 638   EXCEPTION_MARK;
 639 
 640   int handler_bci = -1;
 641   int scope_depth = 0;
 642   if (!force_unwind) {
 643     int bci = sd-&gt;bci();
 644     bool recursive_exception = false;
 645     do {
 646       bool skip_scope_increment = false;
 647       // exception handler lookup
 648       Klass* ek = exception-&gt;klass();
 649       methodHandle mh(THREAD, sd-&gt;method());
 650       handler_bci = Method::fast_exception_handler_bci_for(mh, ek, bci, THREAD);
 651       if (HAS_PENDING_EXCEPTION) {
 652         recursive_exception = true;
 653         // We threw an exception while trying to find the exception handler.
 654         // Transfer the new exception to the exception handle which will
 655         // be set into thread local storage, and do another lookup for an
 656         // exception handler for this exception, this time starting at the
 657         // BCI of the exception handler which caused the exception to be
 658         // thrown (bugs 4307310 and 4546590). Set &quot;exception&quot; reference
 659         // argument to ensure that the correct exception is thrown (4870175).
 660         recursive_exception_occurred = true;
 661         exception = Handle(THREAD, PENDING_EXCEPTION);
 662         CLEAR_PENDING_EXCEPTION;
 663         if (handler_bci &gt;= 0) {
 664           bci = handler_bci;
 665           handler_bci = -1;
 666           skip_scope_increment = true;
 667         }
 668       }
 669       else {
 670         recursive_exception = false;
 671       }
 672       if (!top_frame_only &amp;&amp; handler_bci &lt; 0 &amp;&amp; !skip_scope_increment) {
 673         sd = sd-&gt;sender();
 674         if (sd != NULL) {
 675           bci = sd-&gt;bci();
 676         }
 677         ++scope_depth;
 678       }
 679     } while (recursive_exception || (!top_frame_only &amp;&amp; handler_bci &lt; 0 &amp;&amp; sd != NULL));
 680   }
 681 
 682   // found handling method =&gt; lookup exception handler
 683   int catch_pco = ret_pc - nm-&gt;code_begin();
 684 
 685   ExceptionHandlerTable table(nm);
 686   HandlerTableEntry *t = table.entry_for(catch_pco, handler_bci, scope_depth);
 687   if (t == NULL &amp;&amp; (nm-&gt;is_compiled_by_c1() || handler_bci != -1)) {
 688     // Allow abbreviated catch tables.  The idea is to allow a method
 689     // to materialize its exceptions without committing to the exact
 690     // routing of exceptions.  In particular this is needed for adding
 691     // a synthetic handler to unlock monitors when inlining
 692     // synchronized methods since the unlock path isn&#39;t represented in
 693     // the bytecodes.
 694     t = table.entry_for(catch_pco, -1, 0);
 695   }
 696 
 697 #ifdef COMPILER1
 698   if (t == NULL &amp;&amp; nm-&gt;is_compiled_by_c1()) {
 699     assert(nm-&gt;unwind_handler_begin() != NULL, &quot;&quot;);
 700     return nm-&gt;unwind_handler_begin();
 701   }
 702 #endif
 703 
 704   if (t == NULL) {
 705     ttyLocker ttyl;
 706     tty-&gt;print_cr(&quot;MISSING EXCEPTION HANDLER for pc &quot; INTPTR_FORMAT &quot; and handler bci %d&quot;, p2i(ret_pc), handler_bci);
 707     tty-&gt;print_cr(&quot;   Exception:&quot;);
 708     exception-&gt;print();
 709     tty-&gt;cr();
 710     tty-&gt;print_cr(&quot; Compiled exception table :&quot;);
 711     table.print();
 712     nm-&gt;print_code();
 713     guarantee(false, &quot;missing exception handler&quot;);
 714     return NULL;
 715   }
 716 
 717   return nm-&gt;code_begin() + t-&gt;pco();
 718 }
 719 
 720 JRT_ENTRY(void, SharedRuntime::throw_AbstractMethodError(JavaThread* thread))
 721   // These errors occur only at call sites
 722   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_AbstractMethodError());
 723 JRT_END
 724 
 725 JRT_ENTRY(void, SharedRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))
 726   // These errors occur only at call sites
 727   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_IncompatibleClassChangeError(), &quot;vtable stub&quot;);
 728 JRT_END
 729 
 730 JRT_ENTRY(void, SharedRuntime::throw_ArithmeticException(JavaThread* thread))
 731   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_ArithmeticException(), &quot;/ by zero&quot;);
 732 JRT_END
 733 
 734 JRT_ENTRY(void, SharedRuntime::throw_NullPointerException(JavaThread* thread))
 735   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 736 JRT_END
 737 
 738 JRT_ENTRY(void, SharedRuntime::throw_NullPointerException_at_call(JavaThread* thread))
 739   // This entry point is effectively only used for NullPointerExceptions which occur at inline
 740   // cache sites (when the callee activation is not yet set up) so we are at a call site
 741   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 742 JRT_END
 743 
 744 JRT_ENTRY(void, SharedRuntime::throw_StackOverflowError(JavaThread* thread))
 745   throw_StackOverflowError_common(thread, false);
 746 JRT_END
 747 
 748 JRT_ENTRY(void, SharedRuntime::throw_delayed_StackOverflowError(JavaThread* thread))
 749   throw_StackOverflowError_common(thread, true);
 750 JRT_END
 751 
 752 void SharedRuntime::throw_StackOverflowError_common(JavaThread* thread, bool delayed) {
 753   // We avoid using the normal exception construction in this case because
 754   // it performs an upcall to Java, and we&#39;re already out of stack space.
 755   Thread* THREAD = thread;
 756   Klass* k = SystemDictionary::StackOverflowError_klass();
 757   oop exception_oop = InstanceKlass::cast(k)-&gt;allocate_instance(CHECK);
 758   if (delayed) {
 759     java_lang_Throwable::set_message(exception_oop,
 760                                      Universe::delayed_stack_overflow_error_message());
 761   }
 762   Handle exception (thread, exception_oop);
 763   if (StackTraceInThrowable) {
 764     java_lang_Throwable::fill_in_stack_trace(exception);
 765   }
 766   // Increment counter for hs_err file reporting
 767   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 768   throw_and_post_jvmti_exception(thread, exception);
 769 }
 770 
<a name="3" id="anc3"></a><span class="line-removed"> 771 #if INCLUDE_JVMCI</span>
<span class="line-removed"> 772 address SharedRuntime::deoptimize_for_implicit_exception(JavaThread* thread, address pc, CompiledMethod* nm, int deopt_reason) {</span>
<span class="line-removed"> 773   assert(deopt_reason &gt; Deoptimization::Reason_none &amp;&amp; deopt_reason &lt; Deoptimization::Reason_LIMIT, &quot;invalid deopt reason&quot;);</span>
<span class="line-removed"> 774   thread-&gt;set_jvmci_implicit_exception_pc(pc);</span>
<span class="line-removed"> 775   thread-&gt;set_pending_deoptimization(Deoptimization::make_trap_request((Deoptimization::DeoptReason)deopt_reason, Deoptimization::Action_reinterpret));</span>
<span class="line-removed"> 776   return (SharedRuntime::deopt_blob()-&gt;implicit_exception_uncommon_trap());</span>
<span class="line-removed"> 777 }</span>
<span class="line-removed"> 778 #endif // INCLUDE_JVMCI</span>
<span class="line-removed"> 779 </span>
 780 address SharedRuntime::continuation_for_implicit_exception(JavaThread* thread,
 781                                                            address pc,
<a name="4" id="anc4"></a><span class="line-modified"> 782                                                            SharedRuntime::ImplicitExceptionKind exception_kind)</span>
 783 {
 784   address target_pc = NULL;
 785 
 786   if (Interpreter::contains(pc)) {
 787 #ifdef CC_INTERP
 788     // C++ interpreter doesn&#39;t throw implicit exceptions
 789     ShouldNotReachHere();
 790 #else
 791     switch (exception_kind) {
 792       case IMPLICIT_NULL:           return Interpreter::throw_NullPointerException_entry();
 793       case IMPLICIT_DIVIDE_BY_ZERO: return Interpreter::throw_ArithmeticException_entry();
 794       case STACK_OVERFLOW:          return Interpreter::throw_StackOverflowError_entry();
 795       default:                      ShouldNotReachHere();
 796     }
 797 #endif // !CC_INTERP
 798   } else {
 799     switch (exception_kind) {
 800       case STACK_OVERFLOW: {
 801         // Stack overflow only occurs upon frame setup; the callee is
 802         // going to be unwound. Dispatch to a shared runtime stub
 803         // which will cause the StackOverflowError to be fabricated
 804         // and processed.
 805         // Stack overflow should never occur during deoptimization:
 806         // the compiled method bangs the stack by as much as the
 807         // interpreter would need in case of a deoptimization. The
 808         // deoptimization blob and uncommon trap blob bang the stack
 809         // in a debug VM to verify the correctness of the compiled
 810         // method stack banging.
 811         assert(thread-&gt;deopt_mark() == NULL, &quot;no stack overflow from deopt blob/uncommon trap&quot;);
 812         Events::log_exception(thread, &quot;StackOverflowError at &quot; INTPTR_FORMAT, p2i(pc));
 813         return StubRoutines::throw_StackOverflowError_entry();
 814       }
 815 
 816       case IMPLICIT_NULL: {
 817         if (VtableStubs::contains(pc)) {
 818           // We haven&#39;t yet entered the callee frame. Fabricate an
 819           // exception and begin dispatching it in the caller. Since
 820           // the caller was at a call site, it&#39;s safe to destroy all
 821           // caller-saved registers, as these entry points do.
 822           VtableStub* vt_stub = VtableStubs::stub_containing(pc);
 823 
 824           // If vt_stub is NULL, then return NULL to signal handler to report the SEGV error.
 825           if (vt_stub == NULL) return NULL;
 826 
 827           if (vt_stub-&gt;is_abstract_method_error(pc)) {
 828             assert(!vt_stub-&gt;is_vtable_stub(), &quot;should never see AbstractMethodErrors from vtable-type VtableStubs&quot;);
 829             Events::log_exception(thread, &quot;AbstractMethodError at &quot; INTPTR_FORMAT, p2i(pc));
 830             // Instead of throwing the abstract method error here directly, we re-resolve
 831             // and will throw the AbstractMethodError during resolve. As a result, we&#39;ll
 832             // get a more detailed error message.
 833             return SharedRuntime::get_handle_wrong_method_stub();
 834           } else {
 835             Events::log_exception(thread, &quot;NullPointerException at vtable entry &quot; INTPTR_FORMAT, p2i(pc));
 836             // Assert that the signal comes from the expected location in stub code.
 837             assert(vt_stub-&gt;is_null_pointer_exception(pc),
 838                    &quot;obtained signal from unexpected location in stub code&quot;);
 839             return StubRoutines::throw_NullPointerException_at_call_entry();
 840           }
 841         } else {
 842           CodeBlob* cb = CodeCache::find_blob(pc);
 843 
 844           // If code blob is NULL, then return NULL to signal handler to report the SEGV error.
 845           if (cb == NULL) return NULL;
 846 
 847           // Exception happened in CodeCache. Must be either:
 848           // 1. Inline-cache check in C2I handler blob,
 849           // 2. Inline-cache check in nmethod, or
 850           // 3. Implicit null exception in nmethod
 851 
 852           if (!cb-&gt;is_compiled()) {
 853             bool is_in_blob = cb-&gt;is_adapter_blob() || cb-&gt;is_method_handles_adapter_blob();
 854             if (!is_in_blob) {
 855               // Allow normal crash reporting to handle this
 856               return NULL;
 857             }
 858             Events::log_exception(thread, &quot;NullPointerException in code blob at &quot; INTPTR_FORMAT, p2i(pc));
 859             // There is no handler here, so we will simply unwind.
 860             return StubRoutines::throw_NullPointerException_at_call_entry();
 861           }
 862 
 863           // Otherwise, it&#39;s a compiled method.  Consult its exception handlers.
 864           CompiledMethod* cm = (CompiledMethod*)cb;
 865           if (cm-&gt;inlinecache_check_contains(pc)) {
 866             // exception happened inside inline-cache check code
 867             // =&gt; the nmethod is not yet active (i.e., the frame
 868             // is not set up yet) =&gt; use return address pushed by
 869             // caller =&gt; don&#39;t push another return address
 870             Events::log_exception(thread, &quot;NullPointerException in IC check &quot; INTPTR_FORMAT, p2i(pc));
 871             return StubRoutines::throw_NullPointerException_at_call_entry();
 872           }
 873 
 874           if (cm-&gt;method()-&gt;is_method_handle_intrinsic()) {
 875             // exception happened inside MH dispatch code, similar to a vtable stub
 876             Events::log_exception(thread, &quot;NullPointerException in MH adapter &quot; INTPTR_FORMAT, p2i(pc));
 877             return StubRoutines::throw_NullPointerException_at_call_entry();
 878           }
 879 
 880 #ifndef PRODUCT
 881           _implicit_null_throws++;
 882 #endif
<a name="5" id="anc5"></a><span class="line-modified"> 883 #if INCLUDE_JVMCI</span>
<span class="line-removed"> 884           if (cm-&gt;is_compiled_by_jvmci() &amp;&amp; cm-&gt;pc_desc_at(pc) != NULL) {</span>
<span class="line-removed"> 885             // If there&#39;s no PcDesc then we&#39;ll die way down inside of</span>
<span class="line-removed"> 886             // deopt instead of just getting normal error reporting,</span>
<span class="line-removed"> 887             // so only go there if it will succeed.</span>
<span class="line-removed"> 888             return deoptimize_for_implicit_exception(thread, pc, cm, Deoptimization::Reason_null_check);</span>
<span class="line-removed"> 889           } else {</span>
<span class="line-removed"> 890 #endif // INCLUDE_JVMCI</span>
<span class="line-removed"> 891           assert (cm-&gt;is_nmethod(), &quot;Expect nmethod&quot;);</span>
<span class="line-removed"> 892           target_pc = ((nmethod*)cm)-&gt;continuation_for_implicit_exception(pc);</span>
<span class="line-removed"> 893 #if INCLUDE_JVMCI</span>
<span class="line-removed"> 894           }</span>
<span class="line-removed"> 895 #endif // INCLUDE_JVMCI</span>
 896           // If there&#39;s an unexpected fault, target_pc might be NULL,
 897           // in which case we want to fall through into the normal
 898           // error handling code.
 899         }
 900 
 901         break; // fall through
 902       }
 903 
 904 
 905       case IMPLICIT_DIVIDE_BY_ZERO: {
 906         CompiledMethod* cm = CodeCache::find_compiled(pc);
 907         guarantee(cm != NULL, &quot;must have containing compiled method for implicit division-by-zero exceptions&quot;);
 908 #ifndef PRODUCT
 909         _implicit_div0_throws++;
 910 #endif
<a name="6" id="anc6"></a><span class="line-modified"> 911 #if INCLUDE_JVMCI</span>
<span class="line-removed"> 912         if (cm-&gt;is_compiled_by_jvmci() &amp;&amp; cm-&gt;pc_desc_at(pc) != NULL) {</span>
<span class="line-removed"> 913           return deoptimize_for_implicit_exception(thread, pc, cm, Deoptimization::Reason_div0_check);</span>
<span class="line-removed"> 914         } else {</span>
<span class="line-removed"> 915 #endif // INCLUDE_JVMCI</span>
<span class="line-removed"> 916         target_pc = cm-&gt;continuation_for_implicit_exception(pc);</span>
<span class="line-removed"> 917 #if INCLUDE_JVMCI</span>
<span class="line-removed"> 918         }</span>
<span class="line-removed"> 919 #endif // INCLUDE_JVMCI</span>
 920         // If there&#39;s an unexpected fault, target_pc might be NULL,
 921         // in which case we want to fall through into the normal
 922         // error handling code.
 923         break; // fall through
 924       }
 925 
 926       default: ShouldNotReachHere();
 927     }
 928 
 929     assert(exception_kind == IMPLICIT_NULL || exception_kind == IMPLICIT_DIVIDE_BY_ZERO, &quot;wrong implicit exception kind&quot;);
 930 
 931     if (exception_kind == IMPLICIT_NULL) {
 932 #ifndef PRODUCT
 933       // for AbortVMOnException flag
 934       Exceptions::debug_check_abort(&quot;java.lang.NullPointerException&quot;);
 935 #endif //PRODUCT
 936       Events::log_exception(thread, &quot;Implicit null exception at &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT, p2i(pc), p2i(target_pc));
 937     } else {
 938 #ifndef PRODUCT
 939       // for AbortVMOnException flag
 940       Exceptions::debug_check_abort(&quot;java.lang.ArithmeticException&quot;);
 941 #endif //PRODUCT
 942       Events::log_exception(thread, &quot;Implicit division by zero exception at &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT, p2i(pc), p2i(target_pc));
 943     }
 944     return target_pc;
 945   }
 946 
 947   ShouldNotReachHere();
 948   return NULL;
 949 }
 950 
 951 
 952 /**
 953  * Throws an java/lang/UnsatisfiedLinkError.  The address of this method is
 954  * installed in the native function entry of all native Java methods before
 955  * they get linked to their actual native methods.
 956  *
 957  * \note
 958  * This method actually never gets called!  The reason is because
 959  * the interpreter&#39;s native entries call NativeLookup::lookup() which
 960  * throws the exception when the lookup fails.  The exception is then
 961  * caught and forwarded on the return from NativeLookup::lookup() call
 962  * before the call to the native function.  This might change in the future.
 963  */
 964 JNI_ENTRY(void*, throw_unsatisfied_link_error(JNIEnv* env, ...))
 965 {
 966   // We return a bad value here to make sure that the exception is
 967   // forwarded before we look at the return value.
 968   THROW_(vmSymbols::java_lang_UnsatisfiedLinkError(), (void*)badAddress);
 969 }
 970 JNI_END
 971 
 972 address SharedRuntime::native_method_throw_unsatisfied_link_error_entry() {
 973   return CAST_FROM_FN_PTR(address, &amp;throw_unsatisfied_link_error);
 974 }
 975 
 976 JRT_ENTRY_NO_ASYNC(void, SharedRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))
 977 #if INCLUDE_JVMCI
 978   if (!obj-&gt;klass()-&gt;has_finalizer()) {
 979     return;
 980   }
 981 #endif // INCLUDE_JVMCI
 982   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 983   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 984   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
 985 JRT_END
 986 
 987 
 988 jlong SharedRuntime::get_java_tid(Thread* thread) {
 989   if (thread != NULL) {
 990     if (thread-&gt;is_Java_thread()) {
 991       oop obj = ((JavaThread*)thread)-&gt;threadObj();
 992       return (obj == NULL) ? 0 : java_lang_Thread::thread_id(obj);
 993     }
 994   }
 995   return 0;
 996 }
 997 
 998 /**
 999  * This function ought to be a void function, but cannot be because
1000  * it gets turned into a tail-call on sparc, which runs into dtrace bug
1001  * 6254741.  Once that is fixed we can remove the dummy return value.
1002  */
1003 int SharedRuntime::dtrace_object_alloc(oopDesc* o, int size) {
1004   return dtrace_object_alloc_base(Thread::current(), o, size);
1005 }
1006 
1007 int SharedRuntime::dtrace_object_alloc_base(Thread* thread, oopDesc* o, int size) {
1008   assert(DTraceAllocProbes, &quot;wrong call&quot;);
1009   Klass* klass = o-&gt;klass();
1010   Symbol* name = klass-&gt;name();
1011   HOTSPOT_OBJECT_ALLOC(
1012                    get_java_tid(thread),
1013                    (char *) name-&gt;bytes(), name-&gt;utf8_length(), size * HeapWordSize);
1014   return 0;
1015 }
1016 
1017 JRT_LEAF(int, SharedRuntime::dtrace_method_entry(
1018     JavaThread* thread, Method* method))
1019   assert(DTraceMethodProbes, &quot;wrong call&quot;);
1020   Symbol* kname = method-&gt;klass_name();
1021   Symbol* name = method-&gt;name();
1022   Symbol* sig = method-&gt;signature();
1023   HOTSPOT_METHOD_ENTRY(
1024       get_java_tid(thread),
1025       (char *) kname-&gt;bytes(), kname-&gt;utf8_length(),
1026       (char *) name-&gt;bytes(), name-&gt;utf8_length(),
1027       (char *) sig-&gt;bytes(), sig-&gt;utf8_length());
1028   return 0;
1029 JRT_END
1030 
1031 JRT_LEAF(int, SharedRuntime::dtrace_method_exit(
1032     JavaThread* thread, Method* method))
1033   assert(DTraceMethodProbes, &quot;wrong call&quot;);
1034   Symbol* kname = method-&gt;klass_name();
1035   Symbol* name = method-&gt;name();
1036   Symbol* sig = method-&gt;signature();
1037   HOTSPOT_METHOD_RETURN(
1038       get_java_tid(thread),
1039       (char *) kname-&gt;bytes(), kname-&gt;utf8_length(),
1040       (char *) name-&gt;bytes(), name-&gt;utf8_length(),
1041       (char *) sig-&gt;bytes(), sig-&gt;utf8_length());
1042   return 0;
1043 JRT_END
1044 
1045 #if INCLUDE_TSAN
1046 
1047 JRT_LEAF(void, SharedRuntime::verify_oop_index(oopDesc* obj, int index))
1048   assert(oopDesc::is_oop(obj), &quot;invalid oop&quot;);
1049   assert(index &gt;= 0, &quot;index is less than 0&quot;);
1050   int obj_size_in_bytes = obj-&gt;size() * HeapWordSize;
1051   assert(index &lt; obj_size_in_bytes, &quot;index %d &gt;= obj size %d&quot;, index, obj_size_in_bytes);
1052 JRT_END
1053 
1054 // TSAN: method entry callback from interpreter
1055 // (1) In order to have the line numbers in the call stack, we use the caller
1056 //     address instead of the method that&#39;s being called. This also matches
1057 //     the entry/exit convention that TSAN uses for C++.
1058 // We use JRT_ENTRY since call_VM_leaf doesn&#39;t set _last_Java_sp that we need.
1059 JRT_ENTRY(void, SharedRuntime::tsan_interp_method_entry(JavaThread *thread))
1060   DEBUG_ONLY(NoSafepointVerifier nsv;)
<a name="7" id="anc7"></a><span class="line-removed">1061   DEBUG_ONLY(NoAllocVerifier nav;)</span>
1062   DEBUG_ONLY(NoHandleMark nhm;)
1063   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1064 
1065   RegisterMap unused_reg_map(thread, false);
1066 
1067   // These asserts should be removed once
1068   // we support more than just the interpreter for TSAN.
1069   assert(!thread-&gt;last_frame().is_compiled_frame(),
1070          &quot;Current frame should not be a compiled frame&quot;);
1071   const frame sender = thread-&gt;last_frame().real_sender(&amp;unused_reg_map);
1072   assert(!sender.is_compiled_frame(), &quot;Sender should not be a compiled frame&quot;);
1073 
1074   jmethodID jmethod_id = 0;
1075   u2 bci = 0;
1076   // TODO: is (0, 0) really the best we can do
1077   // when the sender isn&#39;t an interpreted frame?
1078   if (sender.is_interpreted_frame()) {
1079     jmethod_id = sender.interpreter_frame_method()-&gt;find_jmethod_id_or_null();
1080     bci = sender.interpreter_frame_bci();
1081   }
1082   __tsan_func_entry(tsan_code_location(jmethod_id, bci));
1083 JRT_END
1084 
1085 // TSAN: method exit callback from interpreter
1086 JRT_LEAF(void, SharedRuntime::tsan_interp_method_exit())
1087   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1088   __tsan_func_exit();
1089 JRT_END
1090 
1091 void SharedRuntime::tsan_oop_lock(Thread* thread, oop obj) {
1092   DEBUG_ONLY(NoSafepointVerifier nsv;)
1093   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1094   assert(thread != NULL, &quot;null thread&quot;);
1095   assert(obj != NULL, &quot;null oop&quot;);
1096   assert(oopDesc::is_oop(obj), &quot;invalid oop&quot;);
1097 
1098   TsanOopMap::add_oop(obj);
<a name="8" id="anc8"></a><span class="line-modified">1099   __tsan_java_mutex_lock((julong)(address)obj);</span>
1100 }
1101 
1102 void SharedRuntime::tsan_oop_unlock(Thread *thread, oop obj) {
1103   DEBUG_ONLY(NoSafepointVerifier nsv;)
1104   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1105   assert(thread != NULL, &quot;null thread&quot;);
1106   assert(obj != NULL, &quot;null oop&quot;);
1107   assert(oopDesc::is_oop(obj), &quot;invalid oop&quot;);
1108   assert(TsanOopMap::exists(obj), &quot;oop seen in unlock but not tracked&quot;);
1109 
<a name="9" id="anc9"></a><span class="line-modified">1110   __tsan_java_mutex_unlock((julong)(address)obj);</span>
1111 }
1112 
1113 void SharedRuntime::tsan_oop_rec_lock(Thread* thread, oop obj, int rec) {
1114   DEBUG_ONLY(NoSafepointVerifier nsv;)
1115   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1116   assert(thread != NULL, &quot;null thread&quot;);
1117   assert(obj != NULL, &quot;null oop&quot;);
1118   assert(oopDesc::is_oop(obj), &quot;invalid oop&quot;);
1119 
1120   TsanOopMap::add_oop(obj);
<a name="10" id="anc10"></a><span class="line-modified">1121   __tsan_java_mutex_lock_rec((julong)(address)obj, rec);</span>
1122 }
1123 
1124 int SharedRuntime::tsan_oop_rec_unlock(Thread *thread, oop obj) {
1125   DEBUG_ONLY(NoSafepointVerifier nsv;)
1126   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1127   assert(thread != NULL, &quot;null thread&quot;);
1128   assert(obj != NULL, &quot;null oop&quot;);
1129   assert(oopDesc::is_oop(obj), &quot;invalid oop&quot;);
1130   assert(TsanOopMap::exists(obj), &quot;oop seen in unlock but not tracked&quot;);
1131 
<a name="11" id="anc11"></a><span class="line-modified">1132   return __tsan_java_mutex_unlock_rec((julong)(address)obj);</span>
1133 }
1134 
1135 JRT_LEAF(void, SharedRuntime::tsan_interp_lock(JavaThread* thread,
1136                                                BasicObjectLock* elem))
1137   DEBUG_ONLY(thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);)
1138   assert(elem != NULL, &quot;null elem&quot;);
1139 
1140   oop obj = elem-&gt;obj();
1141   tsan_oop_lock(thread, obj);
1142 
1143   assert(obj == elem-&gt;obj(), &quot;oop changed&quot;);
1144   DEBUG_ONLY(thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);)
1145 JRT_END
1146 
1147 JRT_LEAF(void, SharedRuntime::tsan_interp_unlock(JavaThread* thread,
1148                                                  BasicObjectLock* elem))
1149   DEBUG_ONLY(thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);)
1150   assert(elem != NULL, &quot;null elem&quot;);
1151 
1152   oop obj = elem-&gt;obj();
1153   tsan_oop_unlock(thread, obj);
1154 
1155   assert(obj == elem-&gt;obj(), &quot;oop changed&quot;);
1156   DEBUG_ONLY(thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);)
1157 JRT_END
1158 
1159 // Should be JRT_LEAF, but this is called very early during VM startup, so we
1160 // are sometimes in &#39;_thread_in_vm&#39; state.
1161 // NOTE: DO NOT add operations that can safepoint, enter GC, or throw an
1162 // exception!
1163 void SharedRuntime::tsan_track_obj_with_size(oopDesc* obj, int size) {
1164   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1165   assert(oopDesc::is_oop(obj), &quot;Bad oopDesc passed to tsan_track_obj_with_size().&quot;);
1166   TsanOopMap::add_oop_with_size(obj, size);
1167 }
1168 
1169 JRT_LEAF(void, SharedRuntime::tsan_track_obj(oopDesc* obj))
1170   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1171   assert(oopDesc::is_oop(obj), &quot;Bad oopDesc passed to tsan_track_obj().&quot;);
1172   TsanOopMap::add_oop(obj);
1173 JRT_END
1174 
1175 // TODO: Make tsan_acquire/release JRT_LEAF
1176 // Currently it can&#39;t be JRT_LEAF because there are calls from the VM
1177 // (instanceKlass.cpp), and JRT_LEAF only allows calls from Java/native code.
1178 // We need to figure out a better way of being able to call TSAN functions from
1179 // the VM.
1180 void SharedRuntime::tsan_acquire(void* address) {
1181   DEBUG_ONLY(NoSafepointVerifier nsv;)
1182   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1183   assert(address != NULL, &quot;Cannot acquire at address 0&quot;);
1184   __tsan_java_acquire(address);
1185 }
1186 
1187 void SharedRuntime::tsan_release(void* address) {
1188   DEBUG_ONLY(NoSafepointVerifier nsv;)
1189   assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);
1190   assert(address != NULL, &quot;Cannot release at address 0&quot;);
1191   __tsan_java_release(address);
1192 }
1193 
1194 #define TSAN_MEMORY_ACCESS(name)                                               \
1195   JRT_LEAF(void, SharedRuntime::tsan_##name(                                   \
1196       void* addr,                                                              \
1197       Method* method,                                                          \
1198       address bcp))                                                            \
1199     assert(ThreadSanitizer, &quot;Need -XX:+ThreadSanitizer&quot;);                      \
1200     assert(ThreadSanitizerJavaMemory, &quot;Need -XX:+ThreadSanitizerJavaMemory&quot;);  \
1201     jmethodID mid = method-&gt;find_jmethod_id_or_null();                         \
1202     int bci = method-&gt;bci_from(bcp);                                           \
1203     __tsan_##name##_pc(addr, tsan_code_location(mid, bci));                    \
1204   JRT_END
1205 
1206 TSAN_MEMORY_ACCESS(read1)
1207 TSAN_MEMORY_ACCESS(read2)
1208 TSAN_MEMORY_ACCESS(read4)
1209 TSAN_MEMORY_ACCESS(read8)
1210 TSAN_MEMORY_ACCESS(write1)
1211 TSAN_MEMORY_ACCESS(write2)
1212 TSAN_MEMORY_ACCESS(write4)
1213 TSAN_MEMORY_ACCESS(write8)
1214 
1215 #endif // INCLUDE_TSAN
1216 
1217 // Finds receiver, CallInfo (i.e. receiver method), and calling bytecode)
1218 // for a call current in progress, i.e., arguments has been pushed on stack
1219 // put callee has not been invoked yet.  Used by: resolve virtual/static,
1220 // vtable updates, etc.  Caller frame must be compiled.
1221 Handle SharedRuntime::find_callee_info(JavaThread* thread, Bytecodes::Code&amp; bc, CallInfo&amp; callinfo, TRAPS) {
1222   ResourceMark rm(THREAD);
1223 
1224   // last java frame on stack (which includes native call frames)
1225   vframeStream vfst(thread, true);  // Do not skip and javaCalls
1226 
1227   return find_callee_info_helper(thread, vfst, bc, callinfo, THREAD);
1228 }
1229 
<a name="12" id="anc12"></a><span class="line-modified">1230 methodHandle SharedRuntime::extract_attached_method(vframeStream&amp; vfst) {</span>
1231   CompiledMethod* caller = vfst.nm();
1232 
1233   nmethodLocker caller_lock(caller);
1234 
1235   address pc = vfst.frame_pc();
1236   { // Get call instruction under lock because another thread may be busy patching it.
1237     CompiledICLocker ic_locker(caller);
1238     return caller-&gt;attached_method_before_pc(pc);
1239   }
1240   return NULL;
1241 }
1242 
1243 // Finds receiver, CallInfo (i.e. receiver method), and calling bytecode
1244 // for a call current in progress, i.e., arguments has been pushed on stack
1245 // but callee has not been invoked yet.  Caller frame must be compiled.
1246 Handle SharedRuntime::find_callee_info_helper(JavaThread* thread,
1247                                               vframeStream&amp; vfst,
1248                                               Bytecodes::Code&amp; bc,
1249                                               CallInfo&amp; callinfo, TRAPS) {
1250   Handle receiver;
1251   Handle nullHandle;  //create a handy null handle for exception returns
1252 
1253   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
1254 
1255   // Find caller and bci from vframe
1256   methodHandle caller(THREAD, vfst.method());
1257   int          bci   = vfst.bci();
1258 
1259   Bytecode_invoke bytecode(caller, bci);
1260   int bytecode_index = bytecode.index();
1261   bc = bytecode.invoke_code();
1262 
<a name="13" id="anc13"></a><span class="line-modified">1263   methodHandle attached_method = extract_attached_method(vfst);</span>
1264   if (attached_method.not_null()) {
<a name="14" id="anc14"></a><span class="line-modified">1265     methodHandle callee = bytecode.static_target(CHECK_NH);</span>
1266     vmIntrinsics::ID id = callee-&gt;intrinsic_id();
1267     // When VM replaces MH.invokeBasic/linkTo* call with a direct/virtual call,
1268     // it attaches statically resolved method to the call site.
1269     if (MethodHandles::is_signature_polymorphic(id) &amp;&amp;
1270         MethodHandles::is_signature_polymorphic_intrinsic(id)) {
1271       bc = MethodHandles::signature_polymorphic_intrinsic_bytecode(id);
1272 
1273       // Adjust invocation mode according to the attached method.
1274       switch (bc) {
1275         case Bytecodes::_invokevirtual:
1276           if (attached_method-&gt;method_holder()-&gt;is_interface()) {
1277             bc = Bytecodes::_invokeinterface;
1278           }
1279           break;
1280         case Bytecodes::_invokeinterface:
1281           if (!attached_method-&gt;method_holder()-&gt;is_interface()) {
1282             bc = Bytecodes::_invokevirtual;
1283           }
1284           break;
1285         case Bytecodes::_invokehandle:
1286           if (!MethodHandles::is_signature_polymorphic_method(attached_method())) {
1287             bc = attached_method-&gt;is_static() ? Bytecodes::_invokestatic
1288                                               : Bytecodes::_invokevirtual;
1289           }
1290           break;
1291         default:
1292           break;
1293       }
1294     }
1295   }
1296 
1297   assert(bc != Bytecodes::_illegal, &quot;not initialized&quot;);
1298 
1299   bool has_receiver = bc != Bytecodes::_invokestatic &amp;&amp;
1300                       bc != Bytecodes::_invokedynamic &amp;&amp;
1301                       bc != Bytecodes::_invokehandle;
1302 
1303   // Find receiver for non-static call
1304   if (has_receiver) {
1305     // This register map must be update since we need to find the receiver for
1306     // compiled frames. The receiver might be in a register.
1307     RegisterMap reg_map2(thread);
1308     frame stubFrame   = thread-&gt;last_frame();
1309     // Caller-frame is a compiled frame
1310     frame callerFrame = stubFrame.sender(&amp;reg_map2);
1311 
1312     if (attached_method.is_null()) {
<a name="15" id="anc15"></a><span class="line-modified">1313       methodHandle callee = bytecode.static_target(CHECK_NH);</span>
<span class="line-modified">1314       if (callee.is_null()) {</span>
1315         THROW_(vmSymbols::java_lang_NoSuchMethodException(), nullHandle);
1316       }
1317     }
1318 
1319     // Retrieve from a compiled argument list
1320     receiver = Handle(THREAD, callerFrame.retrieve_receiver(&amp;reg_map2));
1321 
1322     if (receiver.is_null()) {
1323       THROW_(vmSymbols::java_lang_NullPointerException(), nullHandle);
1324     }
1325   }
1326 
1327   // Resolve method
1328   if (attached_method.not_null()) {
1329     // Parameterized by attached method.
1330     LinkResolver::resolve_invoke(callinfo, receiver, attached_method, bc, CHECK_NH);
1331   } else {
1332     // Parameterized by bytecode.
1333     constantPoolHandle constants(THREAD, caller-&gt;constants());
1334     LinkResolver::resolve_invoke(callinfo, receiver, constants, bytecode_index, bc, CHECK_NH);
1335   }
1336 
1337 #ifdef ASSERT
1338   // Check that the receiver klass is of the right subtype and that it is initialized for virtual calls
1339   if (has_receiver) {
1340     assert(receiver.not_null(), &quot;should have thrown exception&quot;);
1341     Klass* receiver_klass = receiver-&gt;klass();
1342     Klass* rk = NULL;
1343     if (attached_method.not_null()) {
1344       // In case there&#39;s resolved method attached, use its holder during the check.
1345       rk = attached_method-&gt;method_holder();
1346     } else {
1347       // Klass is already loaded.
1348       constantPoolHandle constants(THREAD, caller-&gt;constants());
1349       rk = constants-&gt;klass_ref_at(bytecode_index, CHECK_NH);
1350     }
1351     Klass* static_receiver_klass = rk;
<a name="16" id="anc16"></a><span class="line-removed">1352     methodHandle callee = callinfo.selected_method();</span>
1353     assert(receiver_klass-&gt;is_subtype_of(static_receiver_klass),
1354            &quot;actual receiver must be subclass of static receiver klass&quot;);
1355     if (receiver_klass-&gt;is_instance_klass()) {
1356       if (InstanceKlass::cast(receiver_klass)-&gt;is_not_initialized()) {
1357         tty-&gt;print_cr(&quot;ERROR: Klass not yet initialized!!&quot;);
1358         receiver_klass-&gt;print();
1359       }
1360       assert(!InstanceKlass::cast(receiver_klass)-&gt;is_not_initialized(), &quot;receiver_klass must be initialized&quot;);
1361     }
1362   }
1363 #endif
1364 
1365   return receiver;
1366 }
1367 
1368 methodHandle SharedRuntime::find_callee_method(JavaThread* thread, TRAPS) {
1369   ResourceMark rm(THREAD);
1370   // We need first to check if any Java activations (compiled, interpreted)
1371   // exist on the stack since last JavaCall.  If not, we need
1372   // to get the target method from the JavaCall wrapper.
1373   vframeStream vfst(thread, true);  // Do not skip any javaCalls
1374   methodHandle callee_method;
1375   if (vfst.at_end()) {
1376     // No Java frames were found on stack since we did the JavaCall.
1377     // Hence the stack can only contain an entry_frame.  We need to
1378     // find the target method from the stub frame.
1379     RegisterMap reg_map(thread, false);
1380     frame fr = thread-&gt;last_frame();
1381     assert(fr.is_runtime_frame(), &quot;must be a runtimeStub&quot;);
1382     fr = fr.sender(&amp;reg_map);
1383     assert(fr.is_entry_frame(), &quot;must be&quot;);
1384     // fr is now pointing to the entry frame.
1385     callee_method = methodHandle(THREAD, fr.entry_frame_call_wrapper()-&gt;callee_method());
1386   } else {
1387     Bytecodes::Code bc;
1388     CallInfo callinfo;
1389     find_callee_info_helper(thread, vfst, bc, callinfo, CHECK_(methodHandle()));
<a name="17" id="anc17"></a><span class="line-modified">1390     callee_method = callinfo.selected_method();</span>
1391   }
1392   assert(callee_method()-&gt;is_method(), &quot;must be&quot;);
1393   return callee_method;
1394 }
1395 
1396 // Resolves a call.
1397 methodHandle SharedRuntime::resolve_helper(JavaThread *thread,
1398                                            bool is_virtual,
1399                                            bool is_optimized, TRAPS) {
1400   methodHandle callee_method;
1401   callee_method = resolve_sub_helper(thread, is_virtual, is_optimized, THREAD);
1402   if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
1403     int retry_count = 0;
1404     while (!HAS_PENDING_EXCEPTION &amp;&amp; callee_method-&gt;is_old() &amp;&amp;
1405            callee_method-&gt;method_holder() != SystemDictionary::Object_klass()) {
1406       // If has a pending exception then there is no need to re-try to
1407       // resolve this method.
1408       // If the method has been redefined, we need to try again.
1409       // Hack: we have no way to update the vtables of arrays, so don&#39;t
1410       // require that java.lang.Object has been updated.
1411 
1412       // It is very unlikely that method is redefined more than 100 times
1413       // in the middle of resolve. If it is looping here more than 100 times
1414       // means then there could be a bug here.
1415       guarantee((retry_count++ &lt; 100),
1416                 &quot;Could not resolve to latest version of redefined method&quot;);
1417       // method is redefined in the middle of resolve so re-try.
1418       callee_method = resolve_sub_helper(thread, is_virtual, is_optimized, THREAD);
1419     }
1420   }
1421   return callee_method;
1422 }
1423 
1424 // This fails if resolution required refilling of IC stubs
1425 bool SharedRuntime::resolve_sub_helper_internal(methodHandle callee_method, const frame&amp; caller_frame,
1426                                                 CompiledMethod* caller_nm, bool is_virtual, bool is_optimized,
1427                                                 Handle receiver, CallInfo&amp; call_info, Bytecodes::Code invoke_code, TRAPS) {
1428   StaticCallInfo static_call_info;
1429   CompiledICInfo virtual_call_info;
1430 
1431   // Make sure the callee nmethod does not get deoptimized and removed before
1432   // we are done patching the code.
1433   CompiledMethod* callee = callee_method-&gt;code();
1434 
1435   if (callee != NULL) {
1436     assert(callee-&gt;is_compiled(), &quot;must be nmethod for patching&quot;);
1437   }
1438 
1439   if (callee != NULL &amp;&amp; !callee-&gt;is_in_use()) {
1440     // Patch call site to C2I adapter if callee nmethod is deoptimized or unloaded.
1441     callee = NULL;
1442   }
1443   nmethodLocker nl_callee(callee);
1444 #ifdef ASSERT
1445   address dest_entry_point = callee == NULL ? 0 : callee-&gt;entry_point(); // used below
1446 #endif
1447 
1448   bool is_nmethod = caller_nm-&gt;is_nmethod();
1449 
1450   if (is_virtual) {
1451     assert(receiver.not_null() || invoke_code == Bytecodes::_invokehandle, &quot;sanity check&quot;);
1452     bool static_bound = call_info.resolved_method()-&gt;can_be_statically_bound();
1453     Klass* klass = invoke_code == Bytecodes::_invokehandle ? NULL : receiver-&gt;klass();
1454     CompiledIC::compute_monomorphic_entry(callee_method, klass,
1455                      is_optimized, static_bound, is_nmethod, virtual_call_info,
1456                      CHECK_false);
1457   } else {
1458     // static call
1459     CompiledStaticCall::compute_entry(callee_method, is_nmethod, static_call_info);
1460   }
1461 
1462   // grab lock, check for deoptimization and potentially patch caller
1463   {
1464     CompiledICLocker ml(caller_nm);
1465 
1466     // Lock blocks for safepoint during which both nmethods can change state.
1467 
1468     // Now that we are ready to patch if the Method* was redefined then
1469     // don&#39;t update call site and let the caller retry.
1470     // Don&#39;t update call site if callee nmethod was unloaded or deoptimized.
1471     // Don&#39;t update call site if callee nmethod was replaced by an other nmethod
1472     // which may happen when multiply alive nmethod (tiered compilation)
1473     // will be supported.
1474     if (!callee_method-&gt;is_old() &amp;&amp;
1475         (callee == NULL || (callee-&gt;is_in_use() &amp;&amp; callee_method-&gt;code() == callee))) {
<a name="18" id="anc18"></a>
1476 #ifdef ASSERT
1477       // We must not try to patch to jump to an already unloaded method.
1478       if (dest_entry_point != 0) {
1479         CodeBlob* cb = CodeCache::find_blob(dest_entry_point);
1480         assert((cb != NULL) &amp;&amp; cb-&gt;is_compiled() &amp;&amp; (((CompiledMethod*)cb) == callee),
1481                &quot;should not call unloaded nmethod&quot;);
1482       }
1483 #endif
1484       if (is_virtual) {
1485         CompiledIC* inline_cache = CompiledIC_before(caller_nm, caller_frame.pc());
1486         if (inline_cache-&gt;is_clean()) {
1487           if (!inline_cache-&gt;set_to_monomorphic(virtual_call_info)) {
1488             return false;
1489           }
1490         }
1491       } else {
<a name="19" id="anc19"></a>





1492         CompiledStaticCall* ssc = caller_nm-&gt;compiledStaticCall_before(caller_frame.pc());
1493         if (ssc-&gt;is_clean()) ssc-&gt;set(static_call_info);
1494       }
1495     }
1496   } // unlock CompiledICLocker
1497   return true;
1498 }
1499 
1500 // Resolves a call.  The compilers generate code for calls that go here
1501 // and are patched with the real destination of the call.
1502 methodHandle SharedRuntime::resolve_sub_helper(JavaThread *thread,
1503                                                bool is_virtual,
1504                                                bool is_optimized, TRAPS) {
1505 
1506   ResourceMark rm(thread);
1507   RegisterMap cbl_map(thread, false);
1508   frame caller_frame = thread-&gt;last_frame().sender(&amp;cbl_map);
1509 
1510   CodeBlob* caller_cb = caller_frame.cb();
1511   guarantee(caller_cb != NULL &amp;&amp; caller_cb-&gt;is_compiled(), &quot;must be called from compiled method&quot;);
1512   CompiledMethod* caller_nm = caller_cb-&gt;as_compiled_method_or_null();
1513 
1514   // make sure caller is not getting deoptimized
1515   // and removed before we are done with it.
1516   // CLEANUP - with lazy deopt shouldn&#39;t need this lock
1517   nmethodLocker caller_lock(caller_nm);
1518 
1519   // determine call info &amp; receiver
1520   // note: a) receiver is NULL for static calls
1521   //       b) an exception is thrown if receiver is NULL for non-static calls
1522   CallInfo call_info;
1523   Bytecodes::Code invoke_code = Bytecodes::_illegal;
1524   Handle receiver = find_callee_info(thread, invoke_code,
1525                                      call_info, CHECK_(methodHandle()));
<a name="20" id="anc20"></a><span class="line-modified">1526   methodHandle callee_method = call_info.selected_method();</span>
1527 
1528   assert((!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokestatic ) ||
1529          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokespecial) ||
1530          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokehandle ) ||
1531          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokedynamic) ||
1532          ( is_virtual &amp;&amp; invoke_code != Bytecodes::_invokestatic ), &quot;inconsistent bytecode&quot;);
1533 
1534   assert(caller_nm-&gt;is_alive() &amp;&amp; !caller_nm-&gt;is_unloading(), &quot;It should be alive&quot;);
1535 
1536 #ifndef PRODUCT
1537   // tracing/debugging/statistics
1538   int *addr = (is_optimized) ? (&amp;_resolve_opt_virtual_ctr) :
1539                 (is_virtual) ? (&amp;_resolve_virtual_ctr) :
1540                                (&amp;_resolve_static_ctr);
1541   Atomic::inc(addr);
1542 
1543   if (TraceCallFixup) {
1544     ResourceMark rm(thread);
1545     tty-&gt;print(&quot;resolving %s%s (%s) call to&quot;,
1546       (is_optimized) ? &quot;optimized &quot; : &quot;&quot;, (is_virtual) ? &quot;virtual&quot; : &quot;static&quot;,
1547       Bytecodes::name(invoke_code));
1548     callee_method-&gt;print_short_name(tty);
1549     tty-&gt;print_cr(&quot; at pc: &quot; INTPTR_FORMAT &quot; to code: &quot; INTPTR_FORMAT,
1550                   p2i(caller_frame.pc()), p2i(callee_method-&gt;code()));
1551   }
1552 #endif
1553 
<a name="21" id="anc21"></a><span class="line-removed">1554   // Do not patch call site for static call to another class</span>
<span class="line-removed">1555   // when the class is not fully initialized.</span>
1556   if (invoke_code == Bytecodes::_invokestatic) {
<a name="22" id="anc22"></a><span class="line-modified">1557     if (!callee_method-&gt;method_holder()-&gt;is_initialized() &amp;&amp;</span>
<span class="line-modified">1558         callee_method-&gt;method_holder() != caller_nm-&gt;method()-&gt;method_holder()) {</span>








1559       assert(callee_method-&gt;method_holder()-&gt;is_linked(), &quot;must be&quot;);
1560       return callee_method;
<a name="23" id="anc23"></a><span class="line-removed">1561     } else {</span>
<span class="line-removed">1562       assert(callee_method-&gt;method_holder()-&gt;is_initialized() ||</span>
<span class="line-removed">1563              callee_method-&gt;method_holder()-&gt;is_reentrant_initialization(thread),</span>
<span class="line-removed">1564              &quot;invalid class initialization state for invoke_static&quot;);</span>
1565     }
1566   }
1567 
1568   // JSR 292 key invariant:
1569   // If the resolved method is a MethodHandle invoke target, the call
1570   // site must be a MethodHandle call site, because the lambda form might tail-call
1571   // leaving the stack in a state unknown to either caller or callee
1572   // TODO detune for now but we might need it again
1573 //  assert(!callee_method-&gt;is_compiled_lambda_form() ||
1574 //         caller_nm-&gt;is_method_handle_return(caller_frame.pc()), &quot;must be MH call site&quot;);
1575 
1576   // Compute entry points. This might require generation of C2I converter
1577   // frames, so we cannot be holding any locks here. Furthermore, the
1578   // computation of the entry points is independent of patching the call.  We
1579   // always return the entry-point, but we only patch the stub if the call has
1580   // not been deoptimized.  Return values: For a virtual call this is an
1581   // (cached_oop, destination address) pair. For a static call/optimized
1582   // virtual this is just a destination address.
1583 
1584   // Patching IC caches may fail if we run out if transition stubs.
1585   // We refill the ic stubs then and try again.
1586   for (;;) {
1587     ICRefillVerifier ic_refill_verifier;
1588     bool successful = resolve_sub_helper_internal(callee_method, caller_frame, caller_nm,
1589                                                   is_virtual, is_optimized, receiver,
1590                                                   call_info, invoke_code, CHECK_(methodHandle()));
1591     if (successful) {
1592       return callee_method;
1593     } else {
1594       InlineCacheBuffer::refill_ic_stubs();
1595     }
1596   }
1597 
1598 }
1599 
1600 
1601 // Inline caches exist only in compiled code
1602 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method_ic_miss(JavaThread* thread))
1603 #ifdef ASSERT
1604   RegisterMap reg_map(thread, false);
1605   frame stub_frame = thread-&gt;last_frame();
1606   assert(stub_frame.is_runtime_frame(), &quot;sanity check&quot;);
1607   frame caller_frame = stub_frame.sender(&amp;reg_map);
1608   assert(!caller_frame.is_interpreted_frame() &amp;&amp; !caller_frame.is_entry_frame(), &quot;unexpected frame&quot;);
1609 #endif /* ASSERT */
1610 
1611   methodHandle callee_method;
1612   JRT_BLOCK
1613     callee_method = SharedRuntime::handle_ic_miss_helper(thread, CHECK_NULL);
1614     // Return Method* through TLS
1615     thread-&gt;set_vm_result_2(callee_method());
1616   JRT_BLOCK_END
1617   // return compiled code entry point after potential safepoints
1618   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1619   return callee_method-&gt;verified_code_entry();
1620 JRT_END
1621 
1622 
1623 // Handle call site that has been made non-entrant
1624 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method(JavaThread* thread))
1625   // 6243940 We might end up in here if the callee is deoptimized
1626   // as we race to call it.  We don&#39;t want to take a safepoint if
1627   // the caller was interpreted because the caller frame will look
1628   // interpreted to the stack walkers and arguments are now
1629   // &quot;compiled&quot; so it is much better to make this transition
1630   // invisible to the stack walking code. The i2c path will
1631   // place the callee method in the callee_target. It is stashed
1632   // there because if we try and find the callee by normal means a
1633   // safepoint is possible and have trouble gc&#39;ing the compiled args.
1634   RegisterMap reg_map(thread, false);
1635   frame stub_frame = thread-&gt;last_frame();
1636   assert(stub_frame.is_runtime_frame(), &quot;sanity check&quot;);
1637   frame caller_frame = stub_frame.sender(&amp;reg_map);
1638 
1639   if (caller_frame.is_interpreted_frame() ||
1640       caller_frame.is_entry_frame()) {
1641     Method* callee = thread-&gt;callee_target();
1642     guarantee(callee != NULL &amp;&amp; callee-&gt;is_method(), &quot;bad handshake&quot;);
1643     thread-&gt;set_vm_result_2(callee);
1644     thread-&gt;set_callee_target(NULL);
<a name="24" id="anc24"></a><span class="line-modified">1645     return callee-&gt;get_c2i_entry();</span>












1646   }
1647 
1648   // Must be compiled to compiled path which is safe to stackwalk
1649   methodHandle callee_method;
1650   JRT_BLOCK
1651     // Force resolving of caller (if we called from compiled frame)
1652     callee_method = SharedRuntime::reresolve_call_site(thread, CHECK_NULL);
1653     thread-&gt;set_vm_result_2(callee_method());
1654   JRT_BLOCK_END
1655   // return compiled code entry point after potential safepoints
1656   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1657   return callee_method-&gt;verified_code_entry();
1658 JRT_END
1659 
1660 // Handle abstract method call
1661 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method_abstract(JavaThread* thread))
1662   // Verbose error message for AbstractMethodError.
1663   // Get the called method from the invoke bytecode.
1664   vframeStream vfst(thread, true);
1665   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
<a name="25" id="anc25"></a><span class="line-modified">1666   methodHandle caller(vfst.method());</span>
1667   Bytecode_invoke invoke(caller, vfst.bci());
1668   DEBUG_ONLY( invoke.verify(); )
1669 
1670   // Find the compiled caller frame.
1671   RegisterMap reg_map(thread);
1672   frame stubFrame = thread-&gt;last_frame();
1673   assert(stubFrame.is_runtime_frame(), &quot;must be&quot;);
1674   frame callerFrame = stubFrame.sender(&amp;reg_map);
1675   assert(callerFrame.is_compiled_frame(), &quot;must be&quot;);
1676 
1677   // Install exception and return forward entry.
1678   address res = StubRoutines::throw_AbstractMethodError_entry();
1679   JRT_BLOCK
<a name="26" id="anc26"></a><span class="line-modified">1680     methodHandle callee = invoke.static_target(thread);</span>
1681     if (!callee.is_null()) {
1682       oop recv = callerFrame.retrieve_receiver(&amp;reg_map);
1683       Klass *recv_klass = (recv != NULL) ? recv-&gt;klass() : NULL;
1684       LinkResolver::throw_abstract_method_error(callee, recv_klass, thread);
1685       res = StubRoutines::forward_exception_entry();
1686     }
1687   JRT_BLOCK_END
1688   return res;
1689 JRT_END
1690 
1691 
1692 // resolve a static call and patch code
1693 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_static_call_C(JavaThread *thread ))
1694   methodHandle callee_method;
1695   JRT_BLOCK
1696     callee_method = SharedRuntime::resolve_helper(thread, false, false, CHECK_NULL);
1697     thread-&gt;set_vm_result_2(callee_method());
1698   JRT_BLOCK_END
1699   // return compiled code entry point after potential safepoints
1700   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1701   return callee_method-&gt;verified_code_entry();
1702 JRT_END
1703 
1704 
1705 // resolve virtual call and update inline cache to monomorphic
1706 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_virtual_call_C(JavaThread *thread ))
1707   methodHandle callee_method;
1708   JRT_BLOCK
1709     callee_method = SharedRuntime::resolve_helper(thread, true, false, CHECK_NULL);
1710     thread-&gt;set_vm_result_2(callee_method());
1711   JRT_BLOCK_END
1712   // return compiled code entry point after potential safepoints
1713   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1714   return callee_method-&gt;verified_code_entry();
1715 JRT_END
1716 
1717 
1718 // Resolve a virtual call that can be statically bound (e.g., always
1719 // monomorphic, so it has no inline cache).  Patch code to resolved target.
1720 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_opt_virtual_call_C(JavaThread *thread))
1721   methodHandle callee_method;
1722   JRT_BLOCK
1723     callee_method = SharedRuntime::resolve_helper(thread, true, true, CHECK_NULL);
1724     thread-&gt;set_vm_result_2(callee_method());
1725   JRT_BLOCK_END
1726   // return compiled code entry point after potential safepoints
1727   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1728   return callee_method-&gt;verified_code_entry();
1729 JRT_END
1730 
1731 // The handle_ic_miss_helper_internal function returns false if it failed due
1732 // to either running out of vtable stubs or ic stubs due to IC transitions
1733 // to transitional states. The needs_ic_stub_refill value will be set if
1734 // the failure was due to running out of IC stubs, in which case handle_ic_miss_helper
1735 // refills the IC stubs and tries again.
1736 bool SharedRuntime::handle_ic_miss_helper_internal(Handle receiver, CompiledMethod* caller_nm,
1737                                                    const frame&amp; caller_frame, methodHandle callee_method,
1738                                                    Bytecodes::Code bc, CallInfo&amp; call_info,
1739                                                    bool&amp; needs_ic_stub_refill, TRAPS) {
1740   CompiledICLocker ml(caller_nm);
1741   CompiledIC* inline_cache = CompiledIC_before(caller_nm, caller_frame.pc());
1742   bool should_be_mono = false;
1743   if (inline_cache-&gt;is_optimized()) {
1744     if (TraceCallFixup) {
1745       ResourceMark rm(THREAD);
1746       tty-&gt;print(&quot;OPTIMIZED IC miss (%s) call to&quot;, Bytecodes::name(bc));
1747       callee_method-&gt;print_short_name(tty);
1748       tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1749     }
1750     should_be_mono = true;
1751   } else if (inline_cache-&gt;is_icholder_call()) {
1752     CompiledICHolder* ic_oop = inline_cache-&gt;cached_icholder();
1753     if (ic_oop != NULL) {
1754       if (!ic_oop-&gt;is_loader_alive()) {
1755         // Deferred IC cleaning due to concurrent class unloading
1756         if (!inline_cache-&gt;set_to_clean()) {
1757           needs_ic_stub_refill = true;
1758           return false;
1759         }
1760       } else if (receiver()-&gt;klass() == ic_oop-&gt;holder_klass()) {
1761         // This isn&#39;t a real miss. We must have seen that compiled code
1762         // is now available and we want the call site converted to a
1763         // monomorphic compiled call site.
1764         // We can&#39;t assert for callee_method-&gt;code() != NULL because it
1765         // could have been deoptimized in the meantime
1766         if (TraceCallFixup) {
1767           ResourceMark rm(THREAD);
1768           tty-&gt;print(&quot;FALSE IC miss (%s) converting to compiled call to&quot;, Bytecodes::name(bc));
1769           callee_method-&gt;print_short_name(tty);
1770           tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1771         }
1772         should_be_mono = true;
1773       }
1774     }
1775   }
1776 
1777   if (should_be_mono) {
1778     // We have a path that was monomorphic but was going interpreted
1779     // and now we have (or had) a compiled entry. We correct the IC
1780     // by using a new icBuffer.
1781     CompiledICInfo info;
1782     Klass* receiver_klass = receiver()-&gt;klass();
1783     inline_cache-&gt;compute_monomorphic_entry(callee_method,
1784                                             receiver_klass,
1785                                             inline_cache-&gt;is_optimized(),
1786                                             false, caller_nm-&gt;is_nmethod(),
1787                                             info, CHECK_false);
1788     if (!inline_cache-&gt;set_to_monomorphic(info)) {
1789       needs_ic_stub_refill = true;
1790       return false;
1791     }
1792   } else if (!inline_cache-&gt;is_megamorphic() &amp;&amp; !inline_cache-&gt;is_clean()) {
1793     // Potential change to megamorphic
1794 
1795     bool successful = inline_cache-&gt;set_to_megamorphic(&amp;call_info, bc, needs_ic_stub_refill, CHECK_false);
1796     if (needs_ic_stub_refill) {
1797       return false;
1798     }
1799     if (!successful) {
1800       if (!inline_cache-&gt;set_to_clean()) {
1801         needs_ic_stub_refill = true;
1802         return false;
1803       }
1804     }
1805   } else {
1806     // Either clean or megamorphic
1807   }
1808   return true;
1809 }
1810 
1811 methodHandle SharedRuntime::handle_ic_miss_helper(JavaThread *thread, TRAPS) {
1812   ResourceMark rm(thread);
1813   CallInfo call_info;
1814   Bytecodes::Code bc;
1815 
1816   // receiver is NULL for static calls. An exception is thrown for NULL
1817   // receivers for non-static calls
1818   Handle receiver = find_callee_info(thread, bc, call_info,
1819                                      CHECK_(methodHandle()));
1820   // Compiler1 can produce virtual call sites that can actually be statically bound
1821   // If we fell thru to below we would think that the site was going megamorphic
1822   // when in fact the site can never miss. Worse because we&#39;d think it was megamorphic
1823   // we&#39;d try and do a vtable dispatch however methods that can be statically bound
1824   // don&#39;t have vtable entries (vtable_index &lt; 0) and we&#39;d blow up. So we force a
1825   // reresolution of the  call site (as if we did a handle_wrong_method and not an
1826   // plain ic_miss) and the site will be converted to an optimized virtual call site
1827   // never to miss again. I don&#39;t believe C2 will produce code like this but if it
1828   // did this would still be the correct thing to do for it too, hence no ifdef.
1829   //
1830   if (call_info.resolved_method()-&gt;can_be_statically_bound()) {
1831     methodHandle callee_method = SharedRuntime::reresolve_call_site(thread, CHECK_(methodHandle()));
1832     if (TraceCallFixup) {
1833       RegisterMap reg_map(thread, false);
1834       frame caller_frame = thread-&gt;last_frame().sender(&amp;reg_map);
1835       ResourceMark rm(thread);
1836       tty-&gt;print(&quot;converting IC miss to reresolve (%s) call to&quot;, Bytecodes::name(bc));
1837       callee_method-&gt;print_short_name(tty);
1838       tty-&gt;print_cr(&quot; from pc: &quot; INTPTR_FORMAT, p2i(caller_frame.pc()));
1839       tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1840     }
1841     return callee_method;
1842   }
1843 
<a name="27" id="anc27"></a><span class="line-modified">1844   methodHandle callee_method = call_info.selected_method();</span>
1845 
1846 #ifndef PRODUCT
1847   Atomic::inc(&amp;_ic_miss_ctr);
1848 
1849   // Statistics &amp; Tracing
1850   if (TraceCallFixup) {
1851     ResourceMark rm(thread);
1852     tty-&gt;print(&quot;IC miss (%s) call to&quot;, Bytecodes::name(bc));
1853     callee_method-&gt;print_short_name(tty);
1854     tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1855   }
1856 
1857   if (ICMissHistogram) {
1858     MutexLocker m(VMStatistic_lock);
1859     RegisterMap reg_map(thread, false);
1860     frame f = thread-&gt;last_frame().real_sender(&amp;reg_map);// skip runtime stub
1861     // produce statistics under the lock
1862     trace_ic_miss(f.pc());
1863   }
1864 #endif
1865 
1866   // install an event collector so that when a vtable stub is created the
1867   // profiler can be notified via a DYNAMIC_CODE_GENERATED event. The
1868   // event can&#39;t be posted when the stub is created as locks are held
1869   // - instead the event will be deferred until the event collector goes
1870   // out of scope.
1871   JvmtiDynamicCodeEventCollector event_collector;
1872 
1873   // Update inline cache to megamorphic. Skip update if we are called from interpreted.
1874   // Transitioning IC caches may require transition stubs. If we run out
1875   // of transition stubs, we have to drop locks and perform a safepoint
1876   // that refills them.
1877   RegisterMap reg_map(thread, false);
1878   frame caller_frame = thread-&gt;last_frame().sender(&amp;reg_map);
1879   CodeBlob* cb = caller_frame.cb();
1880   CompiledMethod* caller_nm = cb-&gt;as_compiled_method();
1881 
1882   for (;;) {
1883     ICRefillVerifier ic_refill_verifier;
1884     bool needs_ic_stub_refill = false;
1885     bool successful = handle_ic_miss_helper_internal(receiver, caller_nm, caller_frame, callee_method,
1886                                                      bc, call_info, needs_ic_stub_refill, CHECK_(methodHandle()));
1887     if (successful || !needs_ic_stub_refill) {
1888       return callee_method;
1889     } else {
1890       InlineCacheBuffer::refill_ic_stubs();
1891     }
1892   }
1893 }
1894 
1895 static bool clear_ic_at_addr(CompiledMethod* caller_nm, address call_addr, bool is_static_call) {
1896   CompiledICLocker ml(caller_nm);
1897   if (is_static_call) {
1898     CompiledStaticCall* ssc = caller_nm-&gt;compiledStaticCall_at(call_addr);
1899     if (!ssc-&gt;is_clean()) {
1900       return ssc-&gt;set_to_clean();
1901     }
1902   } else {
1903     // compiled, dispatched call (which used to call an interpreted method)
1904     CompiledIC* inline_cache = CompiledIC_at(caller_nm, call_addr);
1905     if (!inline_cache-&gt;is_clean()) {
1906       return inline_cache-&gt;set_to_clean();
1907     }
1908   }
1909   return true;
1910 }
1911 
1912 //
1913 // Resets a call-site in compiled code so it will get resolved again.
1914 // This routines handles both virtual call sites, optimized virtual call
1915 // sites, and static call sites. Typically used to change a call sites
1916 // destination from compiled to interpreted.
1917 //
1918 methodHandle SharedRuntime::reresolve_call_site(JavaThread *thread, TRAPS) {
1919   ResourceMark rm(thread);
1920   RegisterMap reg_map(thread, false);
1921   frame stub_frame = thread-&gt;last_frame();
1922   assert(stub_frame.is_runtime_frame(), &quot;must be a runtimeStub&quot;);
1923   frame caller = stub_frame.sender(&amp;reg_map);
1924 
1925   // Do nothing if the frame isn&#39;t a live compiled frame.
1926   // nmethod could be deoptimized by the time we get here
1927   // so no update to the caller is needed.
1928 
1929   if (caller.is_compiled_frame() &amp;&amp; !caller.is_deoptimized_frame()) {
1930 
1931     address pc = caller.pc();
1932 
1933     // Check for static or virtual call
1934     bool is_static_call = false;
1935     CompiledMethod* caller_nm = CodeCache::find_compiled(pc);
1936 
1937     // Default call_addr is the location of the &quot;basic&quot; call.
1938     // Determine the address of the call we a reresolving. With
1939     // Inline Caches we will always find a recognizable call.
1940     // With Inline Caches disabled we may or may not find a
1941     // recognizable call. We will always find a call for static
1942     // calls and for optimized virtual calls. For vanilla virtual
1943     // calls it depends on the state of the UseInlineCaches switch.
1944     //
1945     // With Inline Caches disabled we can get here for a virtual call
1946     // for two reasons:
1947     //   1 - calling an abstract method. The vtable for abstract methods
1948     //       will run us thru handle_wrong_method and we will eventually
1949     //       end up in the interpreter to throw the ame.
1950     //   2 - a racing deoptimization. We could be doing a vanilla vtable
1951     //       call and between the time we fetch the entry address and
1952     //       we jump to it the target gets deoptimized. Similar to 1
1953     //       we will wind up in the interprter (thru a c2i with c2).
1954     //
1955     address call_addr = NULL;
1956     {
1957       // Get call instruction under lock because another thread may be
1958       // busy patching it.
1959       CompiledICLocker ml(caller_nm);
1960       // Location of call instruction
1961       call_addr = caller_nm-&gt;call_instruction_address(pc);
1962     }
1963     // Make sure nmethod doesn&#39;t get deoptimized and removed until
1964     // this is done with it.
1965     // CLEANUP - with lazy deopt shouldn&#39;t need this lock
1966     nmethodLocker nmlock(caller_nm);
1967 
1968     if (call_addr != NULL) {
1969       RelocIterator iter(caller_nm, call_addr, call_addr+1);
1970       int ret = iter.next(); // Get item
1971       if (ret) {
1972         assert(iter.addr() == call_addr, &quot;must find call&quot;);
1973         if (iter.type() == relocInfo::static_call_type) {
1974           is_static_call = true;
1975         } else {
1976           assert(iter.type() == relocInfo::virtual_call_type ||
1977                  iter.type() == relocInfo::opt_virtual_call_type
1978                 , &quot;unexpected relocInfo. type&quot;);
1979         }
1980       } else {
1981         assert(!UseInlineCaches, &quot;relocation info. must exist for this address&quot;);
1982       }
1983 
1984       // Cleaning the inline cache will force a new resolve. This is more robust
1985       // than directly setting it to the new destination, since resolving of calls
1986       // is always done through the same code path. (experience shows that it
1987       // leads to very hard to track down bugs, if an inline cache gets updated
1988       // to a wrong method). It should not be performance critical, since the
1989       // resolve is only done once.
1990 
1991       for (;;) {
1992         ICRefillVerifier ic_refill_verifier;
1993         if (!clear_ic_at_addr(caller_nm, call_addr, is_static_call)) {
1994           InlineCacheBuffer::refill_ic_stubs();
1995         } else {
1996           break;
1997         }
1998       }
1999     }
2000   }
2001 
2002   methodHandle callee_method = find_callee_method(thread, CHECK_(methodHandle()));
2003 
2004 
2005 #ifndef PRODUCT
2006   Atomic::inc(&amp;_wrong_method_ctr);
2007 
2008   if (TraceCallFixup) {
2009     ResourceMark rm(thread);
2010     tty-&gt;print(&quot;handle_wrong_method reresolving call to&quot;);
2011     callee_method-&gt;print_short_name(tty);
2012     tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
2013   }
2014 #endif
2015 
2016   return callee_method;
2017 }
2018 
2019 address SharedRuntime::handle_unsafe_access(JavaThread* thread, address next_pc) {
2020   // The faulting unsafe accesses should be changed to throw the error
2021   // synchronously instead. Meanwhile the faulting instruction will be
2022   // skipped over (effectively turning it into a no-op) and an
2023   // asynchronous exception will be raised which the thread will
2024   // handle at a later point. If the instruction is a load it will
2025   // return garbage.
2026 
2027   // Request an async exception.
2028   thread-&gt;set_pending_unsafe_access_error();
2029 
2030   // Return address of next instruction to execute.
2031   return next_pc;
2032 }
2033 
2034 #ifdef ASSERT
2035 void SharedRuntime::check_member_name_argument_is_last_argument(const methodHandle&amp; method,
2036                                                                 const BasicType* sig_bt,
2037                                                                 const VMRegPair* regs) {
2038   ResourceMark rm;
2039   const int total_args_passed = method-&gt;size_of_parameters();
2040   const VMRegPair*    regs_with_member_name = regs;
2041         VMRegPair* regs_without_member_name = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed - 1);
2042 
2043   const int member_arg_pos = total_args_passed - 1;
2044   assert(member_arg_pos &gt;= 0 &amp;&amp; member_arg_pos &lt; total_args_passed, &quot;oob&quot;);
2045   assert(sig_bt[member_arg_pos] == T_OBJECT, &quot;dispatch argument must be an object&quot;);
2046 
2047   const bool is_outgoing = method-&gt;is_method_handle_intrinsic();
2048   int comp_args_on_stack = java_calling_convention(sig_bt, regs_without_member_name, total_args_passed - 1, is_outgoing);
2049 
2050   for (int i = 0; i &lt; member_arg_pos; i++) {
2051     VMReg a =    regs_with_member_name[i].first();
2052     VMReg b = regs_without_member_name[i].first();
2053     assert(a-&gt;value() == b-&gt;value(), &quot;register allocation mismatch: a=&quot; INTX_FORMAT &quot;, b=&quot; INTX_FORMAT, a-&gt;value(), b-&gt;value());
2054   }
2055   assert(regs_with_member_name[member_arg_pos].first()-&gt;is_valid(), &quot;bad member arg&quot;);
2056 }
2057 #endif
2058 
2059 bool SharedRuntime::should_fixup_call_destination(address destination, address entry_point, address caller_pc, Method* moop, CodeBlob* cb) {
2060   if (destination != entry_point) {
2061     CodeBlob* callee = CodeCache::find_blob(destination);
2062     // callee == cb seems weird. It means calling interpreter thru stub.
2063     if (callee != NULL &amp;&amp; (callee == cb || callee-&gt;is_adapter_blob())) {
2064       // static call or optimized virtual
2065       if (TraceCallFixup) {
2066         tty-&gt;print(&quot;fixup callsite           at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
2067         moop-&gt;print_short_name(tty);
2068         tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
2069       }
2070       return true;
2071     } else {
2072       if (TraceCallFixup) {
2073         tty-&gt;print(&quot;failed to fixup callsite at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
2074         moop-&gt;print_short_name(tty);
2075         tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
2076       }
2077       // assert is too strong could also be resolve destinations.
2078       // assert(InlineCacheBuffer::contains(destination) || VtableStubs::contains(destination), &quot;must be&quot;);
2079     }
2080   } else {
2081     if (TraceCallFixup) {
2082       tty-&gt;print(&quot;already patched callsite at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
2083       moop-&gt;print_short_name(tty);
2084       tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
2085     }
2086   }
2087   return false;
2088 }
2089 
2090 // ---------------------------------------------------------------------------
2091 // We are calling the interpreter via a c2i. Normally this would mean that
2092 // we were called by a compiled method. However we could have lost a race
2093 // where we went int -&gt; i2c -&gt; c2i and so the caller could in fact be
2094 // interpreted. If the caller is compiled we attempt to patch the caller
2095 // so he no longer calls into the interpreter.
<a name="28" id="anc28"></a><span class="line-modified">2096 IRT_LEAF(void, SharedRuntime::fixup_callers_callsite(Method* method, address caller_pc))</span>
2097   Method* moop(method);
2098 
2099   address entry_point = moop-&gt;from_compiled_entry_no_trampoline();
2100 
2101   // It&#39;s possible that deoptimization can occur at a call site which hasn&#39;t
2102   // been resolved yet, in which case this function will be called from
2103   // an nmethod that has been patched for deopt and we can ignore the
2104   // request for a fixup.
2105   // Also it is possible that we lost a race in that from_compiled_entry
2106   // is now back to the i2c in that case we don&#39;t need to patch and if
2107   // we did we&#39;d leap into space because the callsite needs to use
2108   // &quot;to interpreter&quot; stub in order to load up the Method*. Don&#39;t
2109   // ask me how I know this...
2110 
2111   CodeBlob* cb = CodeCache::find_blob(caller_pc);
2112   if (cb == NULL || !cb-&gt;is_compiled() || entry_point == moop-&gt;get_c2i_entry()) {
2113     return;
2114   }
2115 
2116   // The check above makes sure this is a nmethod.
2117   CompiledMethod* nm = cb-&gt;as_compiled_method_or_null();
2118   assert(nm, &quot;must be&quot;);
2119 
2120   // Get the return PC for the passed caller PC.
2121   address return_pc = caller_pc + frame::pc_return_offset;
2122 
2123   // There is a benign race here. We could be attempting to patch to a compiled
2124   // entry point at the same time the callee is being deoptimized. If that is
2125   // the case then entry_point may in fact point to a c2i and we&#39;d patch the
2126   // call site with the same old data. clear_code will set code() to NULL
2127   // at the end of it. If we happen to see that NULL then we can skip trying
2128   // to patch. If we hit the window where the callee has a c2i in the
2129   // from_compiled_entry and the NULL isn&#39;t present yet then we lose the race
2130   // and patch the code with the same old data. Asi es la vida.
2131 
2132   if (moop-&gt;code() == NULL) return;
2133 
2134   if (nm-&gt;is_in_use()) {
2135     // Expect to find a native call there (unless it was no-inline cache vtable dispatch)
2136     CompiledICLocker ic_locker(nm);
2137     if (NativeCall::is_call_before(return_pc)) {
2138       ResourceMark mark;
2139       NativeCallWrapper* call = nm-&gt;call_wrapper_before(return_pc);
2140       //
2141       // bug 6281185. We might get here after resolving a call site to a vanilla
2142       // virtual call. Because the resolvee uses the verified entry it may then
2143       // see compiled code and attempt to patch the site by calling us. This would
2144       // then incorrectly convert the call site to optimized and its downhill from
2145       // there. If you&#39;re lucky you&#39;ll get the assert in the bugid, if not you&#39;ve
2146       // just made a call site that could be megamorphic into a monomorphic site
2147       // for the rest of its life! Just another racing bug in the life of
2148       // fixup_callers_callsite ...
2149       //
2150       RelocIterator iter(nm, call-&gt;instruction_address(), call-&gt;next_instruction_address());
2151       iter.next();
2152       assert(iter.has_current(), &quot;must have a reloc at java call site&quot;);
2153       relocInfo::relocType typ = iter.reloc()-&gt;type();
2154       if (typ != relocInfo::static_call_type &amp;&amp;
2155            typ != relocInfo::opt_virtual_call_type &amp;&amp;
2156            typ != relocInfo::static_stub_type) {
2157         return;
2158       }
2159       address destination = call-&gt;destination();
2160       if (should_fixup_call_destination(destination, entry_point, caller_pc, moop, cb)) {
2161         call-&gt;set_destination_mt_safe(entry_point);
2162       }
2163     }
2164   }
<a name="29" id="anc29"></a><span class="line-modified">2165 IRT_END</span>
2166 
2167 
2168 // same as JVM_Arraycopy, but called directly from compiled code
2169 JRT_ENTRY(void, SharedRuntime::slow_arraycopy_C(oopDesc* src,  jint src_pos,
2170                                                 oopDesc* dest, jint dest_pos,
2171                                                 jint length,
2172                                                 JavaThread* thread)) {
2173 #ifndef PRODUCT
2174   _slow_array_copy_ctr++;
2175 #endif
2176   // Check if we have null pointers
2177   if (src == NULL || dest == NULL) {
2178     THROW(vmSymbols::java_lang_NullPointerException());
2179   }
2180   // Do the copy.  The casts to arrayOop are necessary to the copy_array API,
2181   // even though the copy_array API also performs dynamic checks to ensure
2182   // that src and dest are truly arrays (and are conformable).
2183   // The copy_array mechanism is awkward and could be removed, but
2184   // the compilers don&#39;t call this function except as a last resort,
2185   // so it probably doesn&#39;t matter.
2186   src-&gt;klass()-&gt;copy_array((arrayOopDesc*)src, src_pos,
2187                                         (arrayOopDesc*)dest, dest_pos,
2188                                         length, thread);
2189 }
2190 JRT_END
2191 
2192 // The caller of generate_class_cast_message() (or one of its callers)
2193 // must use a ResourceMark in order to correctly free the result.
2194 char* SharedRuntime::generate_class_cast_message(
2195     JavaThread* thread, Klass* caster_klass) {
2196 
2197   // Get target class name from the checkcast instruction
2198   vframeStream vfst(thread, true);
2199   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
2200   Bytecode_checkcast cc(vfst.method(), vfst.method()-&gt;bcp_from(vfst.bci()));
2201   constantPoolHandle cpool(thread, vfst.method()-&gt;constants());
2202   Klass* target_klass = ConstantPool::klass_at_if_loaded(cpool, cc.index());
2203   Symbol* target_klass_name = NULL;
2204   if (target_klass == NULL) {
2205     // This klass should be resolved, but just in case, get the name in the klass slot.
2206     target_klass_name = cpool-&gt;klass_name_at(cc.index());
2207   }
2208   return generate_class_cast_message(caster_klass, target_klass, target_klass_name);
2209 }
2210 
2211 
2212 // The caller of generate_class_cast_message() (or one of its callers)
2213 // must use a ResourceMark in order to correctly free the result.
2214 char* SharedRuntime::generate_class_cast_message(
2215     Klass* caster_klass, Klass* target_klass, Symbol* target_klass_name) {
2216   const char* caster_name = caster_klass-&gt;external_name();
2217 
2218   assert(target_klass != NULL || target_klass_name != NULL, &quot;one must be provided&quot;);
<a name="30" id="anc30"></a><span class="line-modified">2219   const char* target_name = target_klass == NULL ? target_klass_name-&gt;as_C_string() :</span>
2220                                                    target_klass-&gt;external_name();
2221 
2222   size_t msglen = strlen(caster_name) + strlen(&quot;class &quot;) + strlen(&quot; cannot be cast to class &quot;) + strlen(target_name) + 1;
2223 
2224   const char* caster_klass_description = &quot;&quot;;
2225   const char* target_klass_description = &quot;&quot;;
2226   const char* klass_separator = &quot;&quot;;
2227   if (target_klass != NULL &amp;&amp; caster_klass-&gt;module() == target_klass-&gt;module()) {
2228     caster_klass_description = caster_klass-&gt;joint_in_module_of_loader(target_klass);
2229   } else {
2230     caster_klass_description = caster_klass-&gt;class_in_module_of_loader();
2231     target_klass_description = (target_klass != NULL) ? target_klass-&gt;class_in_module_of_loader() : &quot;&quot;;
2232     klass_separator = (target_klass != NULL) ? &quot;; &quot; : &quot;&quot;;
2233   }
2234 
2235   // add 3 for parenthesis and preceeding space
2236   msglen += strlen(caster_klass_description) + strlen(target_klass_description) + strlen(klass_separator) + 3;
2237 
2238   char* message = NEW_RESOURCE_ARRAY_RETURN_NULL(char, msglen);
2239   if (message == NULL) {
2240     // Shouldn&#39;t happen, but don&#39;t cause even more problems if it does
2241     message = const_cast&lt;char*&gt;(caster_klass-&gt;external_name());
2242   } else {
2243     jio_snprintf(message,
2244                  msglen,
2245                  &quot;class %s cannot be cast to class %s (%s%s%s)&quot;,
2246                  caster_name,
2247                  target_name,
2248                  caster_klass_description,
2249                  klass_separator,
2250                  target_klass_description
2251                  );
2252   }
2253   return message;
2254 }
2255 
2256 JRT_LEAF(void, SharedRuntime::reguard_yellow_pages())
2257   (void) JavaThread::current()-&gt;reguard_stack();
2258 JRT_END
2259 
2260 
2261 // Handles the uncommon case in locking, i.e., contention or an inflated lock.
2262 JRT_BLOCK_ENTRY(void, SharedRuntime::complete_monitor_locking_C(oopDesc* _obj, BasicLock* lock, JavaThread* thread))
2263   if (!SafepointSynchronize::is_synchronizing()) {
2264     // Only try quick_enter() if we&#39;re not trying to reach a safepoint
2265     // so that the calling thread reaches the safepoint more quickly.
2266     if (ObjectSynchronizer::quick_enter(_obj, thread, lock)) return;
2267   }
2268   // NO_ASYNC required because an async exception on the state transition destructor
2269   // would leave you with the lock held and it would never be released.
2270   // The normal monitorenter NullPointerException is thrown without acquiring a lock
2271   // and the model is that an exception implies the method failed.
2272   JRT_BLOCK_NO_ASYNC
2273   oop obj(_obj);
2274   if (PrintBiasedLockingStatistics) {
2275     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
2276   }
2277   Handle h_obj(THREAD, obj);
<a name="31" id="anc31"></a><span class="line-modified">2278   if (UseBiasedLocking) {</span>
<span class="line-removed">2279     // Retry fast entry if bias is revoked to avoid unnecessary inflation</span>
<span class="line-removed">2280     ObjectSynchronizer::fast_enter(h_obj, lock, true, CHECK);</span>
<span class="line-removed">2281   } else {</span>
<span class="line-removed">2282     ObjectSynchronizer::slow_enter(h_obj, lock, CHECK);</span>
<span class="line-removed">2283   }</span>
2284   assert(!HAS_PENDING_EXCEPTION, &quot;Should have no exception here&quot;);
2285   JRT_BLOCK_END
2286 JRT_END
2287 
2288 // Handles the uncommon cases of monitor unlocking in compiled code
2289 JRT_LEAF(void, SharedRuntime::complete_monitor_unlocking_C(oopDesc* _obj, BasicLock* lock, JavaThread * THREAD))
2290    oop obj(_obj);
2291   assert(JavaThread::current() == THREAD, &quot;invariant&quot;);
2292   // I&#39;m not convinced we need the code contained by MIGHT_HAVE_PENDING anymore
2293   // testing was unable to ever fire the assert that guarded it so I have removed it.
2294   assert(!HAS_PENDING_EXCEPTION, &quot;Do we need code below anymore?&quot;);
2295 #undef MIGHT_HAVE_PENDING
2296 #ifdef MIGHT_HAVE_PENDING
2297   // Save and restore any pending_exception around the exception mark.
2298   // While the slow_exit must not throw an exception, we could come into
2299   // this routine with one set.
2300   oop pending_excep = NULL;
2301   const char* pending_file;
2302   int pending_line;
2303   if (HAS_PENDING_EXCEPTION) {
2304     pending_excep = PENDING_EXCEPTION;
2305     pending_file  = THREAD-&gt;exception_file();
2306     pending_line  = THREAD-&gt;exception_line();
2307     CLEAR_PENDING_EXCEPTION;
2308   }
2309 #endif /* MIGHT_HAVE_PENDING */
2310 
2311   {
2312     // Exit must be non-blocking, and therefore no exceptions can be thrown.
2313     EXCEPTION_MARK;
<a name="32" id="anc32"></a><span class="line-modified">2314     ObjectSynchronizer::slow_exit(obj, lock, THREAD);</span>
2315   }
2316 
2317 #ifdef MIGHT_HAVE_PENDING
2318   if (pending_excep != NULL) {
2319     THREAD-&gt;set_pending_exception(pending_excep, pending_file, pending_line);
2320   }
2321 #endif /* MIGHT_HAVE_PENDING */
2322 JRT_END
2323 
2324 #ifndef PRODUCT
2325 
2326 void SharedRuntime::print_statistics() {
2327   ttyLocker ttyl;
2328   if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;SharedRuntime&#39;&quot;);
2329 
2330   if (_throw_null_ctr) tty-&gt;print_cr(&quot;%5d implicit null throw&quot;, _throw_null_ctr);
2331 
2332   SharedRuntime::print_ic_miss_histogram();
2333 
2334   if (CountRemovableExceptions) {
2335     if (_nof_removable_exceptions &gt; 0) {
2336       Unimplemented(); // this counter is not yet incremented
2337       tty-&gt;print_cr(&quot;Removable exceptions: %d&quot;, _nof_removable_exceptions);
2338     }
2339   }
2340 
2341   // Dump the JRT_ENTRY counters
2342   if (_new_instance_ctr) tty-&gt;print_cr(&quot;%5d new instance requires GC&quot;, _new_instance_ctr);
2343   if (_new_array_ctr) tty-&gt;print_cr(&quot;%5d new array requires GC&quot;, _new_array_ctr);
2344   if (_multi1_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 1 dim&quot;, _multi1_ctr);
2345   if (_multi2_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 2 dim&quot;, _multi2_ctr);
2346   if (_multi3_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 3 dim&quot;, _multi3_ctr);
2347   if (_multi4_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 4 dim&quot;, _multi4_ctr);
2348   if (_multi5_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 5 dim&quot;, _multi5_ctr);
2349 
2350   tty-&gt;print_cr(&quot;%5d inline cache miss in compiled&quot;, _ic_miss_ctr);
2351   tty-&gt;print_cr(&quot;%5d wrong method&quot;, _wrong_method_ctr);
2352   tty-&gt;print_cr(&quot;%5d unresolved static call site&quot;, _resolve_static_ctr);
2353   tty-&gt;print_cr(&quot;%5d unresolved virtual call site&quot;, _resolve_virtual_ctr);
2354   tty-&gt;print_cr(&quot;%5d unresolved opt virtual call site&quot;, _resolve_opt_virtual_ctr);
2355 
2356   if (_mon_enter_stub_ctr) tty-&gt;print_cr(&quot;%5d monitor enter stub&quot;, _mon_enter_stub_ctr);
2357   if (_mon_exit_stub_ctr) tty-&gt;print_cr(&quot;%5d monitor exit stub&quot;, _mon_exit_stub_ctr);
2358   if (_mon_enter_ctr) tty-&gt;print_cr(&quot;%5d monitor enter slow&quot;, _mon_enter_ctr);
2359   if (_mon_exit_ctr) tty-&gt;print_cr(&quot;%5d monitor exit slow&quot;, _mon_exit_ctr);
2360   if (_partial_subtype_ctr) tty-&gt;print_cr(&quot;%5d slow partial subtype&quot;, _partial_subtype_ctr);
2361   if (_jbyte_array_copy_ctr) tty-&gt;print_cr(&quot;%5d byte array copies&quot;, _jbyte_array_copy_ctr);
2362   if (_jshort_array_copy_ctr) tty-&gt;print_cr(&quot;%5d short array copies&quot;, _jshort_array_copy_ctr);
2363   if (_jint_array_copy_ctr) tty-&gt;print_cr(&quot;%5d int array copies&quot;, _jint_array_copy_ctr);
2364   if (_jlong_array_copy_ctr) tty-&gt;print_cr(&quot;%5d long array copies&quot;, _jlong_array_copy_ctr);
2365   if (_oop_array_copy_ctr) tty-&gt;print_cr(&quot;%5d oop array copies&quot;, _oop_array_copy_ctr);
2366   if (_checkcast_array_copy_ctr) tty-&gt;print_cr(&quot;%5d checkcast array copies&quot;, _checkcast_array_copy_ctr);
2367   if (_unsafe_array_copy_ctr) tty-&gt;print_cr(&quot;%5d unsafe array copies&quot;, _unsafe_array_copy_ctr);
2368   if (_generic_array_copy_ctr) tty-&gt;print_cr(&quot;%5d generic array copies&quot;, _generic_array_copy_ctr);
2369   if (_slow_array_copy_ctr) tty-&gt;print_cr(&quot;%5d slow array copies&quot;, _slow_array_copy_ctr);
2370   if (_find_handler_ctr) tty-&gt;print_cr(&quot;%5d find exception handler&quot;, _find_handler_ctr);
2371   if (_rethrow_ctr) tty-&gt;print_cr(&quot;%5d rethrow handler&quot;, _rethrow_ctr);
2372 
2373   AdapterHandlerLibrary::print_statistics();
2374 
2375   if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
2376 }
2377 
2378 inline double percent(int x, int y) {
2379   return 100.0 * x / MAX2(y, 1);
2380 }
2381 
2382 class MethodArityHistogram {
2383  public:
2384   enum { MAX_ARITY = 256 };
2385  private:
2386   static int _arity_histogram[MAX_ARITY];     // histogram of #args
2387   static int _size_histogram[MAX_ARITY];      // histogram of arg size in words
2388   static int _max_arity;                      // max. arity seen
2389   static int _max_size;                       // max. arg size seen
2390 
2391   static void add_method_to_histogram(nmethod* nm) {
2392     if (CompiledMethod::nmethod_access_is_safe(nm)) {
2393       Method* method = nm-&gt;method();
2394       ArgumentCount args(method-&gt;signature());
2395       int arity   = args.size() + (method-&gt;is_static() ? 0 : 1);
2396       int argsize = method-&gt;size_of_parameters();
2397       arity   = MIN2(arity, MAX_ARITY-1);
2398       argsize = MIN2(argsize, MAX_ARITY-1);
2399       int count = method-&gt;compiled_invocation_count();
2400       _arity_histogram[arity]  += count;
2401       _size_histogram[argsize] += count;
2402       _max_arity = MAX2(_max_arity, arity);
2403       _max_size  = MAX2(_max_size, argsize);
2404     }
2405   }
2406 
2407   void print_histogram_helper(int n, int* histo, const char* name) {
2408     const int N = MIN2(5, n);
2409     tty-&gt;print_cr(&quot;\nHistogram of call arity (incl. rcvr, calls to compiled methods only):&quot;);
2410     double sum = 0;
2411     double weighted_sum = 0;
2412     int i;
2413     for (i = 0; i &lt;= n; i++) { sum += histo[i]; weighted_sum += i*histo[i]; }
2414     double rest = sum;
2415     double percent = sum / 100;
2416     for (i = 0; i &lt;= N; i++) {
2417       rest -= histo[i];
2418       tty-&gt;print_cr(&quot;%4d: %7d (%5.1f%%)&quot;, i, histo[i], histo[i] / percent);
2419     }
2420     tty-&gt;print_cr(&quot;rest: %7d (%5.1f%%))&quot;, (int)rest, rest / percent);
2421     tty-&gt;print_cr(&quot;(avg. %s = %3.1f, max = %d)&quot;, name, weighted_sum / sum, n);
2422   }
2423 
2424   void print_histogram() {
2425     tty-&gt;print_cr(&quot;\nHistogram of call arity (incl. rcvr, calls to compiled methods only):&quot;);
2426     print_histogram_helper(_max_arity, _arity_histogram, &quot;arity&quot;);
2427     tty-&gt;print_cr(&quot;\nSame for parameter size (in words):&quot;);
2428     print_histogram_helper(_max_size, _size_histogram, &quot;size&quot;);
2429     tty-&gt;cr();
2430   }
2431 
2432  public:
2433   MethodArityHistogram() {
<a name="33" id="anc33"></a><span class="line-modified">2434     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
2435     _max_arity = _max_size = 0;
2436     for (int i = 0; i &lt; MAX_ARITY; i++) _arity_histogram[i] = _size_histogram[i] = 0;
2437     CodeCache::nmethods_do(add_method_to_histogram);
2438     print_histogram();
2439   }
2440 };
2441 
2442 int MethodArityHistogram::_arity_histogram[MethodArityHistogram::MAX_ARITY];
2443 int MethodArityHistogram::_size_histogram[MethodArityHistogram::MAX_ARITY];
2444 int MethodArityHistogram::_max_arity;
2445 int MethodArityHistogram::_max_size;
2446 
2447 void SharedRuntime::print_call_statistics(int comp_total) {
2448   tty-&gt;print_cr(&quot;Calls from compiled code:&quot;);
2449   int total  = _nof_normal_calls + _nof_interface_calls + _nof_static_calls;
2450   int mono_c = _nof_normal_calls - _nof_optimized_calls - _nof_megamorphic_calls;
2451   int mono_i = _nof_interface_calls - _nof_optimized_interface_calls - _nof_megamorphic_interface_calls;
2452   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) total non-inlined   &quot;, total, percent(total, total));
2453   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) virtual calls       &quot;, _nof_normal_calls, percent(_nof_normal_calls, total));
2454   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_calls, percent(_nof_inlined_calls, _nof_normal_calls));
2455   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   optimized        &quot;, _nof_optimized_calls, percent(_nof_optimized_calls, _nof_normal_calls));
2456   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   monomorphic      &quot;, mono_c, percent(mono_c, _nof_normal_calls));
2457   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   megamorphic      &quot;, _nof_megamorphic_calls, percent(_nof_megamorphic_calls, _nof_normal_calls));
2458   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) interface calls     &quot;, _nof_interface_calls, percent(_nof_interface_calls, total));
2459   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_interface_calls, percent(_nof_inlined_interface_calls, _nof_interface_calls));
2460   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   optimized        &quot;, _nof_optimized_interface_calls, percent(_nof_optimized_interface_calls, _nof_interface_calls));
2461   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   monomorphic      &quot;, mono_i, percent(mono_i, _nof_interface_calls));
2462   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   megamorphic      &quot;, _nof_megamorphic_interface_calls, percent(_nof_megamorphic_interface_calls, _nof_interface_calls));
2463   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) static/special calls&quot;, _nof_static_calls, percent(_nof_static_calls, total));
2464   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_static_calls, percent(_nof_inlined_static_calls, _nof_static_calls));
2465   tty-&gt;cr();
2466   tty-&gt;print_cr(&quot;Note 1: counter updates are not MT-safe.&quot;);
2467   tty-&gt;print_cr(&quot;Note 2: %% in major categories are relative to total non-inlined calls;&quot;);
2468   tty-&gt;print_cr(&quot;        %% in nested categories are relative to their category&quot;);
2469   tty-&gt;print_cr(&quot;        (and thus add up to more than 100%% with inlining)&quot;);
2470   tty-&gt;cr();
2471 
2472   MethodArityHistogram h;
2473 }
2474 #endif
2475 
2476 
2477 // A simple wrapper class around the calling convention information
2478 // that allows sharing of adapters for the same calling convention.
2479 class AdapterFingerPrint : public CHeapObj&lt;mtCode&gt; {
2480  private:
2481   enum {
2482     _basic_type_bits = 4,
2483     _basic_type_mask = right_n_bits(_basic_type_bits),
2484     _basic_types_per_int = BitsPerInt / _basic_type_bits,
2485     _compact_int_count = 3
2486   };
2487   // TO DO:  Consider integrating this with a more global scheme for compressing signatures.
2488   // For now, 4 bits per components (plus T_VOID gaps after double/long) is not excessive.
2489 
2490   union {
2491     int  _compact[_compact_int_count];
2492     int* _fingerprint;
2493   } _value;
2494   int _length; // A negative length indicates the fingerprint is in the compact form,
2495                // Otherwise _value._fingerprint is the array.
2496 
2497   // Remap BasicTypes that are handled equivalently by the adapters.
2498   // These are correct for the current system but someday it might be
2499   // necessary to make this mapping platform dependent.
2500   static int adapter_encoding(BasicType in) {
2501     switch (in) {
2502       case T_BOOLEAN:
2503       case T_BYTE:
2504       case T_SHORT:
2505       case T_CHAR:
2506         // There are all promoted to T_INT in the calling convention
2507         return T_INT;
2508 
2509       case T_OBJECT:
2510       case T_ARRAY:
2511         // In other words, we assume that any register good enough for
2512         // an int or long is good enough for a managed pointer.
2513 #ifdef _LP64
2514         return T_LONG;
2515 #else
2516         return T_INT;
2517 #endif
2518 
2519       case T_INT:
2520       case T_LONG:
2521       case T_FLOAT:
2522       case T_DOUBLE:
2523       case T_VOID:
2524         return in;
2525 
2526       default:
2527         ShouldNotReachHere();
2528         return T_CONFLICT;
2529     }
2530   }
2531 
2532  public:
2533   AdapterFingerPrint(int total_args_passed, BasicType* sig_bt) {
2534     // The fingerprint is based on the BasicType signature encoded
2535     // into an array of ints with eight entries per int.
2536     int* ptr;
2537     int len = (total_args_passed + (_basic_types_per_int-1)) / _basic_types_per_int;
2538     if (len &lt;= _compact_int_count) {
2539       assert(_compact_int_count == 3, &quot;else change next line&quot;);
2540       _value._compact[0] = _value._compact[1] = _value._compact[2] = 0;
2541       // Storing the signature encoded as signed chars hits about 98%
2542       // of the time.
2543       _length = -len;
2544       ptr = _value._compact;
2545     } else {
2546       _length = len;
2547       _value._fingerprint = NEW_C_HEAP_ARRAY(int, _length, mtCode);
2548       ptr = _value._fingerprint;
2549     }
2550 
2551     // Now pack the BasicTypes with 8 per int
2552     int sig_index = 0;
2553     for (int index = 0; index &lt; len; index++) {
2554       int value = 0;
2555       for (int byte = 0; byte &lt; _basic_types_per_int; byte++) {
2556         int bt = ((sig_index &lt; total_args_passed)
2557                   ? adapter_encoding(sig_bt[sig_index++])
2558                   : 0);
2559         assert((bt &amp; _basic_type_mask) == bt, &quot;must fit in 4 bits&quot;);
2560         value = (value &lt;&lt; _basic_type_bits) | bt;
2561       }
2562       ptr[index] = value;
2563     }
2564   }
2565 
2566   ~AdapterFingerPrint() {
2567     if (_length &gt; 0) {
2568       FREE_C_HEAP_ARRAY(int, _value._fingerprint);
2569     }
2570   }
2571 
2572   int value(int index) {
2573     if (_length &lt; 0) {
2574       return _value._compact[index];
2575     }
2576     return _value._fingerprint[index];
2577   }
2578   int length() {
2579     if (_length &lt; 0) return -_length;
2580     return _length;
2581   }
2582 
2583   bool is_compact() {
2584     return _length &lt;= 0;
2585   }
2586 
2587   unsigned int compute_hash() {
2588     int hash = 0;
2589     for (int i = 0; i &lt; length(); i++) {
2590       int v = value(i);
2591       hash = (hash &lt;&lt; 8) ^ v ^ (hash &gt;&gt; 5);
2592     }
2593     return (unsigned int)hash;
2594   }
2595 
2596   const char* as_string() {
2597     stringStream st;
2598     st.print(&quot;0x&quot;);
2599     for (int i = 0; i &lt; length(); i++) {
2600       st.print(&quot;%08x&quot;, value(i));
2601     }
2602     return st.as_string();
2603   }
2604 
2605   bool equals(AdapterFingerPrint* other) {
2606     if (other-&gt;_length != _length) {
2607       return false;
2608     }
2609     if (_length &lt; 0) {
2610       assert(_compact_int_count == 3, &quot;else change next line&quot;);
2611       return _value._compact[0] == other-&gt;_value._compact[0] &amp;&amp;
2612              _value._compact[1] == other-&gt;_value._compact[1] &amp;&amp;
2613              _value._compact[2] == other-&gt;_value._compact[2];
2614     } else {
2615       for (int i = 0; i &lt; _length; i++) {
2616         if (_value._fingerprint[i] != other-&gt;_value._fingerprint[i]) {
2617           return false;
2618         }
2619       }
2620     }
2621     return true;
2622   }
2623 };
2624 
2625 
2626 // A hashtable mapping from AdapterFingerPrints to AdapterHandlerEntries
2627 class AdapterHandlerTable : public BasicHashtable&lt;mtCode&gt; {
2628   friend class AdapterHandlerTableIterator;
2629 
2630  private:
2631 
2632 #ifndef PRODUCT
2633   static int _lookups; // number of calls to lookup
2634   static int _buckets; // number of buckets checked
2635   static int _equals;  // number of buckets checked with matching hash
2636   static int _hits;    // number of successful lookups
2637   static int _compact; // number of equals calls with compact signature
2638 #endif
2639 
2640   AdapterHandlerEntry* bucket(int i) {
2641     return (AdapterHandlerEntry*)BasicHashtable&lt;mtCode&gt;::bucket(i);
2642   }
2643 
2644  public:
2645   AdapterHandlerTable()
2646     : BasicHashtable&lt;mtCode&gt;(293, (DumpSharedSpaces ? sizeof(CDSAdapterHandlerEntry) : sizeof(AdapterHandlerEntry))) { }
2647 
2648   // Create a new entry suitable for insertion in the table
<a name="34" id="anc34"></a><span class="line-modified">2649   AdapterHandlerEntry* new_entry(AdapterFingerPrint* fingerprint, address i2c_entry, address c2i_entry, address c2i_unverified_entry) {</span>
2650     AdapterHandlerEntry* entry = (AdapterHandlerEntry*)BasicHashtable&lt;mtCode&gt;::new_entry(fingerprint-&gt;compute_hash());
<a name="35" id="anc35"></a><span class="line-modified">2651     entry-&gt;init(fingerprint, i2c_entry, c2i_entry, c2i_unverified_entry);</span>
2652     if (DumpSharedSpaces) {
2653       ((CDSAdapterHandlerEntry*)entry)-&gt;init();
2654     }
2655     return entry;
2656   }
2657 
2658   // Insert an entry into the table
2659   void add(AdapterHandlerEntry* entry) {
2660     int index = hash_to_index(entry-&gt;hash());
2661     add_entry(index, entry);
2662   }
2663 
2664   void free_entry(AdapterHandlerEntry* entry) {
2665     entry-&gt;deallocate();
2666     BasicHashtable&lt;mtCode&gt;::free_entry(entry);
2667   }
2668 
2669   // Find a entry with the same fingerprint if it exists
2670   AdapterHandlerEntry* lookup(int total_args_passed, BasicType* sig_bt) {
2671     NOT_PRODUCT(_lookups++);
2672     AdapterFingerPrint fp(total_args_passed, sig_bt);
2673     unsigned int hash = fp.compute_hash();
2674     int index = hash_to_index(hash);
2675     for (AdapterHandlerEntry* e = bucket(index); e != NULL; e = e-&gt;next()) {
2676       NOT_PRODUCT(_buckets++);
2677       if (e-&gt;hash() == hash) {
2678         NOT_PRODUCT(_equals++);
2679         if (fp.equals(e-&gt;fingerprint())) {
2680 #ifndef PRODUCT
2681           if (fp.is_compact()) _compact++;
2682           _hits++;
2683 #endif
2684           return e;
2685         }
2686       }
2687     }
2688     return NULL;
2689   }
2690 
2691 #ifndef PRODUCT
2692   void print_statistics() {
2693     ResourceMark rm;
2694     int longest = 0;
2695     int empty = 0;
2696     int total = 0;
2697     int nonempty = 0;
2698     for (int index = 0; index &lt; table_size(); index++) {
2699       int count = 0;
2700       for (AdapterHandlerEntry* e = bucket(index); e != NULL; e = e-&gt;next()) {
2701         count++;
2702       }
2703       if (count != 0) nonempty++;
2704       if (count == 0) empty++;
2705       if (count &gt; longest) longest = count;
2706       total += count;
2707     }
2708     tty-&gt;print_cr(&quot;AdapterHandlerTable: empty %d longest %d total %d average %f&quot;,
2709                   empty, longest, total, total / (double)nonempty);
2710     tty-&gt;print_cr(&quot;AdapterHandlerTable: lookups %d buckets %d equals %d hits %d compact %d&quot;,
2711                   _lookups, _buckets, _equals, _hits, _compact);
2712   }
2713 #endif
2714 };
2715 
2716 
2717 #ifndef PRODUCT
2718 
2719 int AdapterHandlerTable::_lookups;
2720 int AdapterHandlerTable::_buckets;
2721 int AdapterHandlerTable::_equals;
2722 int AdapterHandlerTable::_hits;
2723 int AdapterHandlerTable::_compact;
2724 
2725 #endif
2726 
2727 class AdapterHandlerTableIterator : public StackObj {
2728  private:
2729   AdapterHandlerTable* _table;
2730   int _index;
2731   AdapterHandlerEntry* _current;
2732 
2733   void scan() {
2734     while (_index &lt; _table-&gt;table_size()) {
2735       AdapterHandlerEntry* a = _table-&gt;bucket(_index);
2736       _index++;
2737       if (a != NULL) {
2738         _current = a;
2739         return;
2740       }
2741     }
2742   }
2743 
2744  public:
2745   AdapterHandlerTableIterator(AdapterHandlerTable* table): _table(table), _index(0), _current(NULL) {
2746     scan();
2747   }
2748   bool has_next() {
2749     return _current != NULL;
2750   }
2751   AdapterHandlerEntry* next() {
2752     if (_current != NULL) {
2753       AdapterHandlerEntry* result = _current;
2754       _current = _current-&gt;next();
2755       if (_current == NULL) scan();
2756       return result;
2757     } else {
2758       return NULL;
2759     }
2760   }
2761 };
2762 
2763 
2764 // ---------------------------------------------------------------------------
2765 // Implementation of AdapterHandlerLibrary
2766 AdapterHandlerTable* AdapterHandlerLibrary::_adapters = NULL;
2767 AdapterHandlerEntry* AdapterHandlerLibrary::_abstract_method_handler = NULL;
2768 const int AdapterHandlerLibrary_size = 16*K;
2769 BufferBlob* AdapterHandlerLibrary::_buffer = NULL;
2770 
2771 BufferBlob* AdapterHandlerLibrary::buffer_blob() {
2772   // Should be called only when AdapterHandlerLibrary_lock is active.
2773   if (_buffer == NULL) // Initialize lazily
2774       _buffer = BufferBlob::create(&quot;adapters&quot;, AdapterHandlerLibrary_size);
2775   return _buffer;
2776 }
2777 
2778 extern &quot;C&quot; void unexpected_adapter_call() {
2779   ShouldNotCallThis();
2780 }
2781 
2782 void AdapterHandlerLibrary::initialize() {
2783   if (_adapters != NULL) return;
2784   _adapters = new AdapterHandlerTable();
2785 
2786   // Create a special handler for abstract methods.  Abstract methods
2787   // are never compiled so an i2c entry is somewhat meaningless, but
2788   // throw AbstractMethodError just in case.
2789   // Pass wrong_method_abstract for the c2i transitions to return
2790   // AbstractMethodError for invalid invocations.
2791   address wrong_method_abstract = SharedRuntime::get_handle_wrong_method_abstract_stub();
2792   _abstract_method_handler = AdapterHandlerLibrary::new_entry(new AdapterFingerPrint(0, NULL),
2793                                                               StubRoutines::throw_AbstractMethodError_entry(),
2794                                                               wrong_method_abstract, wrong_method_abstract);
2795 }
2796 
2797 AdapterHandlerEntry* AdapterHandlerLibrary::new_entry(AdapterFingerPrint* fingerprint,
2798                                                       address i2c_entry,
2799                                                       address c2i_entry,
<a name="36" id="anc36"></a><span class="line-modified">2800                                                       address c2i_unverified_entry) {</span>
<span class="line-modified">2801   return _adapters-&gt;new_entry(fingerprint, i2c_entry, c2i_entry, c2i_unverified_entry);</span>

2802 }
2803 
2804 AdapterHandlerEntry* AdapterHandlerLibrary::get_adapter(const methodHandle&amp; method) {
2805   AdapterHandlerEntry* entry = get_adapter0(method);
<a name="37" id="anc37"></a><span class="line-modified">2806   if (method-&gt;is_shared()) {</span>
2807     // See comments around Method::link_method()
2808     MutexLocker mu(AdapterHandlerLibrary_lock);
2809     if (method-&gt;adapter() == NULL) {
2810       method-&gt;update_adapter_trampoline(entry);
2811     }
2812     address trampoline = method-&gt;from_compiled_entry();
2813     if (*(int*)trampoline == 0) {
2814       CodeBuffer buffer(trampoline, (int)SharedRuntime::trampoline_size());
2815       MacroAssembler _masm(&amp;buffer);
2816       SharedRuntime::generate_trampoline(&amp;_masm, entry-&gt;get_c2i_entry());
2817       assert(*(int*)trampoline != 0, &quot;Instruction(s) for trampoline must not be encoded as zeros.&quot;);
<a name="38" id="anc38"></a>
2818 
2819       if (PrintInterpreter) {
2820         Disassembler::decode(buffer.insts_begin(), buffer.insts_end());
2821       }
2822     }
2823   }
2824 
2825   return entry;
2826 }
2827 
2828 AdapterHandlerEntry* AdapterHandlerLibrary::get_adapter0(const methodHandle&amp; method) {
2829   // Use customized signature handler.  Need to lock around updates to
2830   // the AdapterHandlerTable (it is not safe for concurrent readers
2831   // and a single writer: this could be fixed if it becomes a
2832   // problem).
2833 
2834   ResourceMark rm;
2835 
2836   NOT_PRODUCT(int insts_size);
2837   AdapterBlob* new_adapter = NULL;
2838   AdapterHandlerEntry* entry = NULL;
2839   AdapterFingerPrint* fingerprint = NULL;
2840   {
2841     MutexLocker mu(AdapterHandlerLibrary_lock);
2842     // make sure data structure is initialized
2843     initialize();
2844 
2845     if (method-&gt;is_abstract()) {
2846       return _abstract_method_handler;
2847     }
2848 
2849     // Fill in the signature array, for the calling-convention call.
2850     int total_args_passed = method-&gt;size_of_parameters(); // All args on stack
2851 
2852     BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, total_args_passed);
2853     VMRegPair* regs   = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed);
2854     int i = 0;
2855     if (!method-&gt;is_static())  // Pass in receiver first
2856       sig_bt[i++] = T_OBJECT;
2857     for (SignatureStream ss(method-&gt;signature()); !ss.at_return_type(); ss.next()) {
2858       sig_bt[i++] = ss.type();  // Collect remaining bits of signature
2859       if (ss.type() == T_LONG || ss.type() == T_DOUBLE)
2860         sig_bt[i++] = T_VOID;   // Longs &amp; doubles take 2 Java slots
2861     }
2862     assert(i == total_args_passed, &quot;&quot;);
2863 
2864     // Lookup method signature&#39;s fingerprint
2865     entry = _adapters-&gt;lookup(total_args_passed, sig_bt);
2866 
2867 #ifdef ASSERT
2868     AdapterHandlerEntry* shared_entry = NULL;
2869     // Start adapter sharing verification only after the VM is booted.
2870     if (VerifyAdapterSharing &amp;&amp; (entry != NULL)) {
2871       shared_entry = entry;
2872       entry = NULL;
2873     }
2874 #endif
2875 
2876     if (entry != NULL) {
2877       return entry;
2878     }
2879 
2880     // Get a description of the compiled java calling convention and the largest used (VMReg) stack slot usage
2881     int comp_args_on_stack = SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed, false);
2882 
2883     // Make a C heap allocated version of the fingerprint to store in the adapter
2884     fingerprint = new AdapterFingerPrint(total_args_passed, sig_bt);
2885 
2886     // StubRoutines::code2() is initialized after this function can be called. As a result,
2887     // VerifyAdapterCalls and VerifyAdapterSharing can fail if we re-use code that generated
2888     // prior to StubRoutines::code2() being set. Checks refer to checks generated in an I2C
2889     // stub that ensure that an I2C stub is called from an interpreter frame.
2890     bool contains_all_checks = StubRoutines::code2() != NULL;
2891 
2892     // Create I2C &amp; C2I handlers
2893     BufferBlob* buf = buffer_blob(); // the temporary code buffer in CodeCache
2894     if (buf != NULL) {
2895       CodeBuffer buffer(buf);
2896       short buffer_locs[20];
2897       buffer.insts()-&gt;initialize_shared_locs((relocInfo*)buffer_locs,
2898                                              sizeof(buffer_locs)/sizeof(relocInfo));
2899 
2900       MacroAssembler _masm(&amp;buffer);
2901       entry = SharedRuntime::generate_i2c2i_adapters(&amp;_masm,
2902                                                      total_args_passed,
2903                                                      comp_args_on_stack,
2904                                                      sig_bt,
2905                                                      regs,
2906                                                      fingerprint);
2907 #ifdef ASSERT
2908       if (VerifyAdapterSharing) {
2909         if (shared_entry != NULL) {
2910           assert(shared_entry-&gt;compare_code(buf-&gt;code_begin(), buffer.insts_size()), &quot;code must match&quot;);
2911           // Release the one just created and return the original
2912           _adapters-&gt;free_entry(entry);
2913           return shared_entry;
2914         } else  {
2915           entry-&gt;save_code(buf-&gt;code_begin(), buffer.insts_size());
2916         }
2917       }
2918 #endif
2919 
2920       new_adapter = AdapterBlob::create(&amp;buffer);
2921       NOT_PRODUCT(insts_size = buffer.insts_size());
2922     }
2923     if (new_adapter == NULL) {
2924       // CodeCache is full, disable compilation
2925       // Ought to log this but compile log is only per compile thread
2926       // and we&#39;re some non descript Java thread.
2927       return NULL; // Out of CodeCache space
2928     }
2929     entry-&gt;relocate(new_adapter-&gt;content_begin());
2930 #ifndef PRODUCT
2931     // debugging suppport
2932     if (PrintAdapterHandlers || PrintStubCode) {
2933       ttyLocker ttyl;
2934       entry-&gt;print_adapter_on(tty);
2935       tty-&gt;print_cr(&quot;i2c argument handler #%d for: %s %s %s (%d bytes generated)&quot;,
2936                     _adapters-&gt;number_of_entries(), (method-&gt;is_static() ? &quot;static&quot; : &quot;receiver&quot;),
2937                     method-&gt;signature()-&gt;as_C_string(), fingerprint-&gt;as_string(), insts_size);
2938       tty-&gt;print_cr(&quot;c2i argument handler starts at %p&quot;, entry-&gt;get_c2i_entry());
2939       if (Verbose || PrintStubCode) {
2940         address first_pc = entry-&gt;base_address();
2941         if (first_pc != NULL) {
2942           Disassembler::decode(first_pc, first_pc + insts_size);
2943           tty-&gt;cr();
2944         }
2945       }
2946     }
2947 #endif
2948     // Add the entry only if the entry contains all required checks (see sharedRuntime_xxx.cpp)
2949     // The checks are inserted only if -XX:+VerifyAdapterCalls is specified.
2950     if (contains_all_checks || !VerifyAdapterCalls) {
2951       _adapters-&gt;add(entry);
2952     }
2953   }
2954   // Outside of the lock
2955   if (new_adapter != NULL) {
2956     char blob_id[256];
2957     jio_snprintf(blob_id,
2958                  sizeof(blob_id),
2959                  &quot;%s(%s)@&quot; PTR_FORMAT,
2960                  new_adapter-&gt;name(),
2961                  fingerprint-&gt;as_string(),
2962                  new_adapter-&gt;content_begin());
2963     Forte::register_stub(blob_id, new_adapter-&gt;content_begin(), new_adapter-&gt;content_end());
2964 
2965     if (JvmtiExport::should_post_dynamic_code_generated()) {
2966       JvmtiExport::post_dynamic_code_generated(blob_id, new_adapter-&gt;content_begin(), new_adapter-&gt;content_end());
2967     }
2968   }
2969   return entry;
2970 }
2971 
2972 address AdapterHandlerEntry::base_address() {
2973   address base = _i2c_entry;
2974   if (base == NULL)  base = _c2i_entry;
2975   assert(base &lt;= _c2i_entry || _c2i_entry == NULL, &quot;&quot;);
2976   assert(base &lt;= _c2i_unverified_entry || _c2i_unverified_entry == NULL, &quot;&quot;);
<a name="39" id="anc39"></a>
2977   return base;
2978 }
2979 
2980 void AdapterHandlerEntry::relocate(address new_base) {
2981   address old_base = base_address();
2982   assert(old_base != NULL, &quot;&quot;);
2983   ptrdiff_t delta = new_base - old_base;
2984   if (_i2c_entry != NULL)
2985     _i2c_entry += delta;
2986   if (_c2i_entry != NULL)
2987     _c2i_entry += delta;
2988   if (_c2i_unverified_entry != NULL)
2989     _c2i_unverified_entry += delta;
<a name="40" id="anc40"></a>

2990   assert(base_address() == new_base, &quot;&quot;);
2991 }
2992 
2993 
2994 void AdapterHandlerEntry::deallocate() {
2995   delete _fingerprint;
2996 #ifdef ASSERT
<a name="41" id="anc41"></a><span class="line-modified">2997   if (_saved_code) FREE_C_HEAP_ARRAY(unsigned char, _saved_code);</span>
2998 #endif
2999 }
3000 
3001 
3002 #ifdef ASSERT
3003 // Capture the code before relocation so that it can be compared
3004 // against other versions.  If the code is captured after relocation
3005 // then relative instructions won&#39;t be equivalent.
3006 void AdapterHandlerEntry::save_code(unsigned char* buffer, int length) {
3007   _saved_code = NEW_C_HEAP_ARRAY(unsigned char, length, mtCode);
3008   _saved_code_length = length;
3009   memcpy(_saved_code, buffer, length);
3010 }
3011 
3012 
3013 bool AdapterHandlerEntry::compare_code(unsigned char* buffer, int length) {
3014   if (length != _saved_code_length) {
3015     return false;
3016   }
3017 
3018   return (memcmp(buffer, _saved_code, length) == 0) ? true : false;
3019 }
3020 #endif
3021 
3022 
3023 /**
3024  * Create a native wrapper for this native method.  The wrapper converts the
3025  * Java-compiled calling convention to the native convention, handles
3026  * arguments, and transitions to native.  On return from the native we transition
3027  * back to java blocking if a safepoint is in progress.
3028  */
3029 void AdapterHandlerLibrary::create_native_wrapper(const methodHandle&amp; method) {
3030   ResourceMark rm;
3031   nmethod* nm = NULL;
<a name="42" id="anc42"></a>
3032 
3033   assert(method-&gt;is_native(), &quot;must be native&quot;);
3034   assert(method-&gt;is_method_handle_intrinsic() ||
3035          method-&gt;has_native_function(), &quot;must have something valid to call!&quot;);
3036 
<a name="43" id="anc43"></a>




3037   {
3038     // Perform the work while holding the lock, but perform any printing outside the lock
3039     MutexLocker mu(AdapterHandlerLibrary_lock);
3040     // See if somebody beat us to it
3041     if (method-&gt;code() != NULL) {
3042       return;
3043     }
3044 
3045     const int compile_id = CompileBroker::assign_compile_id(method, CompileBroker::standard_entry_bci);
3046     assert(compile_id &gt; 0, &quot;Must generate native wrapper&quot;);
3047 
3048 
3049     ResourceMark rm;
3050     BufferBlob*  buf = buffer_blob(); // the temporary code buffer in CodeCache
3051     if (buf != NULL) {
3052       CodeBuffer buffer(buf);
3053       double locs_buf[20];
3054       buffer.insts()-&gt;initialize_shared_locs((relocInfo*)locs_buf, sizeof(locs_buf) / sizeof(relocInfo));
3055       MacroAssembler _masm(&amp;buffer);
3056 
3057       // Fill in the signature array, for the calling-convention call.
3058       const int total_args_passed = method-&gt;size_of_parameters();
3059 
3060       BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, total_args_passed);
3061       VMRegPair*   regs = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed);
3062       int i=0;
3063       if (!method-&gt;is_static())  // Pass in receiver first
3064         sig_bt[i++] = T_OBJECT;
3065       SignatureStream ss(method-&gt;signature());
3066       for (; !ss.at_return_type(); ss.next()) {
3067         sig_bt[i++] = ss.type();  // Collect remaining bits of signature
3068         if (ss.type() == T_LONG || ss.type() == T_DOUBLE)
3069           sig_bt[i++] = T_VOID;   // Longs &amp; doubles take 2 Java slots
3070       }
3071       assert(i == total_args_passed, &quot;&quot;);
3072       BasicType ret_type = ss.type();
3073 
3074       // Now get the compiled-Java layout as input (or output) arguments.
3075       // NOTE: Stubs for compiled entry points of method handle intrinsics
3076       // are just trampolines so the argument registers must be outgoing ones.
3077       const bool is_outgoing = method-&gt;is_method_handle_intrinsic();
3078       int comp_args_on_stack = SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed, is_outgoing);
3079 
3080       // Generate the compiled-to-native wrapper code
<a name="44" id="anc44"></a><span class="line-modified">3081       nm = SharedRuntime::generate_native_wrapper(&amp;_masm, method, compile_id, sig_bt, regs, ret_type);</span>
3082 
3083       if (nm != NULL) {
<a name="45" id="anc45"></a><span class="line-modified">3084         method-&gt;set_code(method, nm);</span>





3085 
3086         DirectiveSet* directive = DirectivesStack::getDefaultDirective(CompileBroker::compiler(CompLevel_simple));
3087         if (directive-&gt;PrintAssemblyOption) {
3088           nm-&gt;print_code();
3089         }
3090         DirectivesStack::release(directive);
3091       }
3092     }
3093   } // Unlock AdapterHandlerLibrary_lock
3094 
3095 
3096   // Install the generated code.
3097   if (nm != NULL) {
3098     const char *msg = method-&gt;is_static() ? &quot;(static)&quot; : &quot;&quot;;
3099     CompileTask::print_ul(nm, msg);
3100     if (PrintCompilation) {
3101       ttyLocker ttyl;
3102       CompileTask::print(tty, nm, msg);
3103     }
3104     nm-&gt;post_compiled_method_load_event();
3105   }
3106 }
3107 
3108 JRT_ENTRY_NO_ASYNC(void, SharedRuntime::block_for_jni_critical(JavaThread* thread))
3109   assert(thread == JavaThread::current(), &quot;must be&quot;);
3110   // The code is about to enter a JNI lazy critical native method and
3111   // _needs_gc is true, so if this thread is already in a critical
3112   // section then just return, otherwise this thread should block
3113   // until needs_gc has been cleared.
3114   if (thread-&gt;in_critical()) {
3115     return;
3116   }
3117   // Lock and unlock a critical section to give the system a chance to block
3118   GCLocker::lock_critical(thread);
3119   GCLocker::unlock_critical(thread);
3120 JRT_END
3121 
3122 JRT_LEAF(oopDesc*, SharedRuntime::pin_object(JavaThread* thread, oopDesc* obj))
3123   assert(Universe::heap()-&gt;supports_object_pinning(), &quot;Why we are here?&quot;);
3124   assert(obj != NULL, &quot;Should not be null&quot;);
3125   oop o(obj);
3126   o = Universe::heap()-&gt;pin_object(thread, o);
3127   assert(o != NULL, &quot;Should not be null&quot;);
3128   return o;
3129 JRT_END
3130 
3131 JRT_LEAF(void, SharedRuntime::unpin_object(JavaThread* thread, oopDesc* obj))
3132   assert(Universe::heap()-&gt;supports_object_pinning(), &quot;Why we are here?&quot;);
3133   assert(obj != NULL, &quot;Should not be null&quot;);
3134   oop o(obj);
3135   Universe::heap()-&gt;unpin_object(thread, o);
3136 JRT_END
3137 
3138 // -------------------------------------------------------------------------
3139 // Java-Java calling convention
3140 // (what you use when Java calls Java)
3141 
3142 //------------------------------name_for_receiver----------------------------------
3143 // For a given signature, return the VMReg for parameter 0.
3144 VMReg SharedRuntime::name_for_receiver() {
3145   VMRegPair regs;
3146   BasicType sig_bt = T_OBJECT;
3147   (void) java_calling_convention(&amp;sig_bt, &amp;regs, 1, true);
3148   // Return argument 0 register.  In the LP64 build pointers
3149   // take 2 registers, but the VM wants only the &#39;main&#39; name.
3150   return regs.first();
3151 }
3152 
3153 VMRegPair *SharedRuntime::find_callee_arguments(Symbol* sig, bool has_receiver, bool has_appendix, int* arg_size) {
3154   // This method is returning a data structure allocating as a
3155   // ResourceObject, so do not put any ResourceMarks in here.
<a name="46" id="anc46"></a><span class="line-removed">3156   char *s = sig-&gt;as_C_string();</span>
<span class="line-removed">3157   int len = (int)strlen(s);</span>
<span class="line-removed">3158   s++; len--;                   // Skip opening paren</span>
3159 
3160   BasicType *sig_bt = NEW_RESOURCE_ARRAY(BasicType, 256);
3161   VMRegPair *regs = NEW_RESOURCE_ARRAY(VMRegPair, 256);
3162   int cnt = 0;
3163   if (has_receiver) {
3164     sig_bt[cnt++] = T_OBJECT; // Receiver is argument 0; not in signature
3165   }
3166 
<a name="47" id="anc47"></a><span class="line-modified">3167   while (*s != &#39;)&#39;) {          // Find closing right paren</span>
<span class="line-modified">3168     switch (*s++) {            // Switch on signature character</span>
<span class="line-modified">3169     case &#39;B&#39;: sig_bt[cnt++] = T_BYTE;    break;</span>
<span class="line-modified">3170     case &#39;C&#39;: sig_bt[cnt++] = T_CHAR;    break;</span>
<span class="line-modified">3171     case &#39;D&#39;: sig_bt[cnt++] = T_DOUBLE;  sig_bt[cnt++] = T_VOID; break;</span>
<span class="line-removed">3172     case &#39;F&#39;: sig_bt[cnt++] = T_FLOAT;   break;</span>
<span class="line-removed">3173     case &#39;I&#39;: sig_bt[cnt++] = T_INT;     break;</span>
<span class="line-removed">3174     case &#39;J&#39;: sig_bt[cnt++] = T_LONG;    sig_bt[cnt++] = T_VOID; break;</span>
<span class="line-removed">3175     case &#39;S&#39;: sig_bt[cnt++] = T_SHORT;   break;</span>
<span class="line-removed">3176     case &#39;Z&#39;: sig_bt[cnt++] = T_BOOLEAN; break;</span>
<span class="line-removed">3177     case &#39;V&#39;: sig_bt[cnt++] = T_VOID;    break;</span>
<span class="line-removed">3178     case &#39;L&#39;:                   // Oop</span>
<span class="line-removed">3179       while (*s++ != &#39;;&#39;);   // Skip signature</span>
<span class="line-removed">3180       sig_bt[cnt++] = T_OBJECT;</span>
<span class="line-removed">3181       break;</span>
<span class="line-removed">3182     case &#39;[&#39;: {                 // Array</span>
<span class="line-removed">3183       do {                      // Skip optional size</span>
<span class="line-removed">3184         while (*s &gt;= &#39;0&#39; &amp;&amp; *s &lt;= &#39;9&#39;) s++;</span>
<span class="line-removed">3185       } while (*s++ == &#39;[&#39;);   // Nested arrays?</span>
<span class="line-removed">3186       // Skip element type</span>
<span class="line-removed">3187       if (s[-1] == &#39;L&#39;)</span>
<span class="line-removed">3188         while (*s++ != &#39;;&#39;); // Skip signature</span>
<span class="line-removed">3189       sig_bt[cnt++] = T_ARRAY;</span>
<span class="line-removed">3190       break;</span>
<span class="line-removed">3191     }</span>
<span class="line-removed">3192     default : ShouldNotReachHere();</span>
<span class="line-removed">3193     }</span>
3194   }
3195 
3196   if (has_appendix) {
3197     sig_bt[cnt++] = T_OBJECT;
3198   }
3199 
3200   assert(cnt &lt; 256, &quot;grow table size&quot;);
3201 
3202   int comp_args_on_stack;
3203   comp_args_on_stack = java_calling_convention(sig_bt, regs, cnt, true);
3204 
3205   // the calling convention doesn&#39;t count out_preserve_stack_slots so
3206   // we must add that in to get &quot;true&quot; stack offsets.
3207 
3208   if (comp_args_on_stack) {
3209     for (int i = 0; i &lt; cnt; i++) {
3210       VMReg reg1 = regs[i].first();
3211       if (reg1-&gt;is_stack()) {
3212         // Yuck
3213         reg1 = reg1-&gt;bias(out_preserve_stack_slots());
3214       }
3215       VMReg reg2 = regs[i].second();
3216       if (reg2-&gt;is_stack()) {
3217         // Yuck
3218         reg2 = reg2-&gt;bias(out_preserve_stack_slots());
3219       }
3220       regs[i].set_pair(reg2, reg1);
3221     }
3222   }
3223 
3224   // results
3225   *arg_size = cnt;
3226   return regs;
3227 }
3228 
3229 // OSR Migration Code
3230 //
3231 // This code is used convert interpreter frames into compiled frames.  It is
3232 // called from very start of a compiled OSR nmethod.  A temp array is
3233 // allocated to hold the interesting bits of the interpreter frame.  All
3234 // active locks are inflated to allow them to move.  The displaced headers and
3235 // active interpreter locals are copied into the temp buffer.  Then we return
3236 // back to the compiled code.  The compiled code then pops the current
3237 // interpreter frame off the stack and pushes a new compiled frame.  Then it
3238 // copies the interpreter locals and displaced headers where it wants.
3239 // Finally it calls back to free the temp buffer.
3240 //
3241 // All of this is done NOT at any Safepoint, nor is any safepoint or GC allowed.
3242 
3243 JRT_LEAF(intptr_t*, SharedRuntime::OSR_migration_begin( JavaThread *thread) )
3244 
3245   //
3246   // This code is dependent on the memory layout of the interpreter local
3247   // array and the monitors. On all of our platforms the layout is identical
3248   // so this code is shared. If some platform lays the their arrays out
3249   // differently then this code could move to platform specific code or
3250   // the code here could be modified to copy items one at a time using
3251   // frame accessor methods and be platform independent.
3252 
3253   frame fr = thread-&gt;last_frame();
3254   assert(fr.is_interpreted_frame(), &quot;&quot;);
3255   assert(fr.interpreter_frame_expression_stack_size()==0, &quot;only handle empty stacks&quot;);
3256 
3257   // Figure out how many monitors are active.
3258   int active_monitor_count = 0;
3259   for (BasicObjectLock *kptr = fr.interpreter_frame_monitor_end();
3260        kptr &lt; fr.interpreter_frame_monitor_begin();
3261        kptr = fr.next_monitor_in_interpreter_frame(kptr) ) {
3262     if (kptr-&gt;obj() != NULL) active_monitor_count++;
3263   }
3264 
3265   // QQQ we could place number of active monitors in the array so that compiled code
3266   // could double check it.
3267 
3268   Method* moop = fr.interpreter_frame_method();
3269   int max_locals = moop-&gt;max_locals();
3270   // Allocate temp buffer, 1 word per local &amp; 2 per active monitor
3271   int buf_size_words = max_locals + active_monitor_count * BasicObjectLock::size();
3272   intptr_t *buf = NEW_C_HEAP_ARRAY(intptr_t,buf_size_words, mtCode);
3273 
3274   // Copy the locals.  Order is preserved so that loading of longs works.
3275   // Since there&#39;s no GC I can copy the oops blindly.
3276   assert(sizeof(HeapWord)==sizeof(intptr_t), &quot;fix this code&quot;);
3277   Copy::disjoint_words((HeapWord*)fr.interpreter_frame_local_at(max_locals-1),
3278                        (HeapWord*)&amp;buf[0],
3279                        max_locals);
3280 
3281   // Inflate locks.  Copy the displaced headers.  Be careful, there can be holes.
3282   int i = max_locals;
3283   for (BasicObjectLock *kptr2 = fr.interpreter_frame_monitor_end();
3284        kptr2 &lt; fr.interpreter_frame_monitor_begin();
3285        kptr2 = fr.next_monitor_in_interpreter_frame(kptr2) ) {
3286     if (kptr2-&gt;obj() != NULL) {         // Avoid &#39;holes&#39; in the monitor array
3287       BasicLock *lock = kptr2-&gt;lock();
3288       // Inflate so the displaced header becomes position-independent
<a name="48" id="anc48"></a><span class="line-modified">3289       if (lock-&gt;displaced_header()-&gt;is_unlocked())</span>
3290         ObjectSynchronizer::inflate_helper(kptr2-&gt;obj());
3291       // Now the displaced header is free to move
<a name="49" id="anc49"></a><span class="line-modified">3292       buf[i++] = (intptr_t)lock-&gt;displaced_header();</span>
3293       buf[i++] = cast_from_oop&lt;intptr_t&gt;(kptr2-&gt;obj());
3294     }
3295   }
3296   assert(i - max_locals == active_monitor_count*2, &quot;found the expected number of monitors&quot;);
3297 
3298   return buf;
3299 JRT_END
3300 
3301 JRT_LEAF(void, SharedRuntime::OSR_migration_end( intptr_t* buf) )
3302   FREE_C_HEAP_ARRAY(intptr_t, buf);
3303 JRT_END
3304 
3305 bool AdapterHandlerLibrary::contains(const CodeBlob* b) {
3306   AdapterHandlerTableIterator iter(_adapters);
3307   while (iter.has_next()) {
3308     AdapterHandlerEntry* a = iter.next();
3309     if (b == CodeCache::find_blob(a-&gt;get_i2c_entry())) return true;
3310   }
3311   return false;
3312 }
3313 
3314 void AdapterHandlerLibrary::print_handler_on(outputStream* st, const CodeBlob* b) {
3315   AdapterHandlerTableIterator iter(_adapters);
3316   while (iter.has_next()) {
3317     AdapterHandlerEntry* a = iter.next();
3318     if (b == CodeCache::find_blob(a-&gt;get_i2c_entry())) {
3319       st-&gt;print(&quot;Adapter for signature: &quot;);
3320       a-&gt;print_adapter_on(tty);
3321       return;
3322     }
3323   }
3324   assert(false, &quot;Should have found handler&quot;);
3325 }
3326 
3327 void AdapterHandlerEntry::print_adapter_on(outputStream* st) const {
<a name="50" id="anc50"></a><span class="line-modified">3328   st-&gt;print_cr(&quot;AHE@&quot; INTPTR_FORMAT &quot;: %s i2c: &quot; INTPTR_FORMAT &quot; c2i: &quot; INTPTR_FORMAT &quot; c2iUV: &quot; INTPTR_FORMAT,</span>
<span class="line-modified">3329                p2i(this), fingerprint()-&gt;as_string(),</span>
<span class="line-modified">3330                p2i(get_i2c_entry()), p2i(get_c2i_entry()), p2i(get_c2i_unverified_entry()));</span>
<span class="line-modified">3331 </span>










3332 }
3333 
3334 #if INCLUDE_CDS
3335 
3336 void CDSAdapterHandlerEntry::init() {
3337   assert(DumpSharedSpaces, &quot;used during dump time only&quot;);
3338   _c2i_entry_trampoline = (address)MetaspaceShared::misc_code_space_alloc(SharedRuntime::trampoline_size());
3339   _adapter_trampoline = (AdapterHandlerEntry**)MetaspaceShared::misc_code_space_alloc(sizeof(AdapterHandlerEntry*));
3340 };
3341 
3342 #endif // INCLUDE_CDS
3343 
3344 
3345 #ifndef PRODUCT
3346 
3347 void AdapterHandlerLibrary::print_statistics() {
3348   _adapters-&gt;print_statistics();
3349 }
3350 
3351 #endif /* PRODUCT */
3352 
3353 JRT_LEAF(void, SharedRuntime::enable_stack_reserved_zone(JavaThread* thread))
3354   assert(thread-&gt;is_Java_thread(), &quot;Only Java threads have a stack reserved zone&quot;);
3355   if (thread-&gt;stack_reserved_zone_disabled()) {
3356   thread-&gt;enable_stack_reserved_zone();
3357   }
3358   thread-&gt;set_reserved_stack_activation(thread-&gt;stack_base());
3359 JRT_END
3360 
3361 frame SharedRuntime::look_for_reserved_stack_annotated_method(JavaThread* thread, frame fr) {
3362   ResourceMark rm(thread);
3363   frame activation;
3364   CompiledMethod* nm = NULL;
3365   int count = 1;
3366 
3367   assert(fr.is_java_frame(), &quot;Must start on Java frame&quot;);
3368 
3369   while (true) {
3370     Method* method = NULL;
3371     bool found = false;
3372     if (fr.is_interpreted_frame()) {
3373       method = fr.interpreter_frame_method();
3374       if (method != NULL &amp;&amp; method-&gt;has_reserved_stack_access()) {
3375         found = true;
3376       }
3377     } else {
3378       CodeBlob* cb = fr.cb();
3379       if (cb != NULL &amp;&amp; cb-&gt;is_compiled()) {
3380         nm = cb-&gt;as_compiled_method();
3381         method = nm-&gt;method();
3382         // scope_desc_near() must be used, instead of scope_desc_at() because on
3383         // SPARC, the pcDesc can be on the delay slot after the call instruction.
3384         for (ScopeDesc *sd = nm-&gt;scope_desc_near(fr.pc()); sd != NULL; sd = sd-&gt;sender()) {
3385           method = sd-&gt;method();
3386           if (method != NULL &amp;&amp; method-&gt;has_reserved_stack_access()) {
3387             found = true;
3388       }
3389     }
3390       }
3391     }
3392     if (found) {
3393       activation = fr;
3394       warning(&quot;Potentially dangerous stack overflow in &quot;
3395               &quot;ReservedStackAccess annotated method %s [%d]&quot;,
3396               method-&gt;name_and_sig_as_C_string(), count++);
3397       EventReservedStackActivation event;
3398       if (event.should_commit()) {
3399         event.set_method(method);
3400         event.commit();
3401       }
3402     }
3403     if (fr.is_first_java_frame()) {
3404       break;
3405     } else {
3406       fr = fr.java_sender();
3407     }
3408   }
3409   return activation;
3410 }
3411 
3412 void SharedRuntime::on_slowpath_allocation_exit(JavaThread* thread) {
3413   // After any safepoint, just before going back to compiled code,
3414   // we inform the GC that we will be doing initializing writes to
3415   // this object in the future without emitting card-marks, so
3416   // GC may take any compensating steps.
3417 
3418   oop new_obj = thread-&gt;vm_result();
3419   if (new_obj == NULL) return;
3420 
3421   BarrierSet *bs = BarrierSet::barrier_set();
3422   bs-&gt;on_slowpath_allocation_exit(thread, new_obj);
3423 }
<a name="51" id="anc51"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="51" type="hidden" />
</body>
</html>