<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/safepointVerifiers.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="safepointVerifiers.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="semaphore.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepointVerifiers.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,150 +26,33 @@</span>
  #define SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
  
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;runtime/thread.hpp&quot;
  
<span class="udiff-line-removed">- // A NoGCVerifier object can be placed in methods where one assumes that</span>
<span class="udiff-line-removed">- // no garbage collection will occur. The destructor will verify this property</span>
<span class="udiff-line-removed">- // unless the constructor is called with argument false (not verifygc).</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- // The check will only be done in debug mode and if verifygc true.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class NoGCVerifier: public StackObj {</span>
<span class="udiff-line-removed">-  friend class PauseNoGCVerifier;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  protected:</span>
<span class="udiff-line-removed">-   bool _verifygc;</span>
<span class="udiff-line-removed">-   unsigned int _old_invocations;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">-   NoGCVerifier(bool verifygc = true);</span>
<span class="udiff-line-removed">-   ~NoGCVerifier();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   NoGCVerifier(bool verifygc = true) {}</span>
<span class="udiff-line-removed">-   ~NoGCVerifier() {}</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // A PauseNoGCVerifier is used to temporarily pause the behavior</span>
<span class="udiff-line-removed">- // of a NoGCVerifier object. If we are not in debug mode or if the</span>
<span class="udiff-line-removed">- // NoGCVerifier object has a _verifygc value of false, then there</span>
<span class="udiff-line-removed">- // is nothing to do.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class PauseNoGCVerifier: public StackObj {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   NoGCVerifier * _ngcv;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">-   PauseNoGCVerifier(NoGCVerifier * ngcv);</span>
<span class="udiff-line-removed">-   ~PauseNoGCVerifier();</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   PauseNoGCVerifier(NoGCVerifier * ngcv) {}</span>
<span class="udiff-line-removed">-   ~PauseNoGCVerifier() {}</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  // A NoSafepointVerifier object will throw an assertion failure if
  // the current thread passes a possible safepoint while this object is
  // instantiated. A safepoint, will either be: an oop allocation, blocking
  // on a Mutex or JavaLock, or executing a VM operation.
  //
<span class="udiff-line-modified-removed">- // If StrictSafepointChecks is turned off, it degrades into a NoGCVerifier</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- class NoSafepointVerifier : public NoGCVerifier {</span>
<span class="udiff-line-modified-added">+ class NoSafepointVerifier : public StackObj {</span>
   friend class PauseNoSafepointVerifier;
  
   private:
<span class="udiff-line-removed">-   bool _activated;</span>
    Thread *_thread;
   public:
<span class="udiff-line-modified-removed">- #ifdef ASSERT</span>
<span class="udiff-line-modified-removed">-   NoSafepointVerifier(bool activated = true, bool verifygc = true ) :</span>
<span class="udiff-line-removed">-     NoGCVerifier(verifygc),</span>
<span class="udiff-line-removed">-     _activated(activated) {</span>
<span class="udiff-line-removed">-     _thread = Thread::current();</span>
<span class="udiff-line-removed">-     if (_activated) {</span>
<span class="udiff-line-removed">-       _thread-&gt;_allow_allocation_count++;</span>
<span class="udiff-line-removed">-       _thread-&gt;_allow_safepoint_count++;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ~NoSafepointVerifier() {</span>
<span class="udiff-line-removed">-     if (_activated) {</span>
<span class="udiff-line-removed">-       _thread-&gt;_allow_allocation_count--;</span>
<span class="udiff-line-removed">-       _thread-&gt;_allow_safepoint_count--;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   NoSafepointVerifier(bool activated = true, bool verifygc = true) : NoGCVerifier(verifygc){}</span>
<span class="udiff-line-removed">-   ~NoSafepointVerifier() {}</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+   NoSafepointVerifier()  NOT_DEBUG_RETURN;</span>
<span class="udiff-line-modified-added">+   ~NoSafepointVerifier() NOT_DEBUG_RETURN;</span>
  };
  
  // A PauseNoSafepointVerifier is used to temporarily pause the
<span class="udiff-line-modified-removed">- // behavior of a NoSafepointVerifier object. If we are not in debug</span>
<span class="udiff-line-removed">- // mode then there is nothing to do. If the NoSafepointVerifier</span>
<span class="udiff-line-removed">- // object has an _activated value of false, then there is nothing to</span>
<span class="udiff-line-removed">- // do for safepoint and allocation checking, but there may still be</span>
<span class="udiff-line-removed">- // something to do for the underlying NoGCVerifier object.</span>
<span class="udiff-line-modified-added">+ // behavior of a NoSafepointVerifier object.</span>
  
<span class="udiff-line-modified-removed">- class PauseNoSafepointVerifier : public PauseNoGCVerifier {</span>
<span class="udiff-line-modified-added">+ class PauseNoSafepointVerifier : public StackObj {</span>
   private:
<span class="udiff-line-modified-removed">-   NoSafepointVerifier * _nsv;</span>
<span class="udiff-line-modified-added">+   NoSafepointVerifier* _nsv;</span>
  
   public:
<span class="udiff-line-modified-removed">- #ifdef ASSERT</span>
<span class="udiff-line-modified-removed">-   PauseNoSafepointVerifier(NoSafepointVerifier * nsv)</span>
<span class="udiff-line-removed">-     : PauseNoGCVerifier(nsv) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     _nsv = nsv;</span>
<span class="udiff-line-removed">-     if (_nsv-&gt;_activated) {</span>
<span class="udiff-line-removed">-       _nsv-&gt;_thread-&gt;_allow_allocation_count--;</span>
<span class="udiff-line-removed">-       _nsv-&gt;_thread-&gt;_allow_safepoint_count--;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ~PauseNoSafepointVerifier() {</span>
<span class="udiff-line-removed">-     if (_nsv-&gt;_activated) {</span>
<span class="udiff-line-removed">-       _nsv-&gt;_thread-&gt;_allow_allocation_count++;</span>
<span class="udiff-line-removed">-       _nsv-&gt;_thread-&gt;_allow_safepoint_count++;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   PauseNoSafepointVerifier(NoSafepointVerifier * nsv)</span>
<span class="udiff-line-removed">-     : PauseNoGCVerifier(nsv) {}</span>
<span class="udiff-line-removed">-   ~PauseNoSafepointVerifier() {}</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // A NoAllocVerifier object can be placed in methods where one assumes that</span>
<span class="udiff-line-removed">- // no allocation will occur. The destructor will verify this property</span>
<span class="udiff-line-removed">- // unless the constructor is called with argument false (not activated).</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- // The check will only be done in debug mode and if activated.</span>
<span class="udiff-line-removed">- // Note: this only makes sense at safepoints (otherwise, other threads may</span>
<span class="udiff-line-removed">- // allocate concurrently.)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class NoAllocVerifier : public StackObj {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   bool  _activated;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">-   NoAllocVerifier(bool activated = true) {</span>
<span class="udiff-line-removed">-     _activated = activated;</span>
<span class="udiff-line-removed">-     if (_activated) Thread::current()-&gt;_allow_allocation_count++;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ~NoAllocVerifier() {</span>
<span class="udiff-line-removed">-     if (_activated) Thread::current()-&gt;_allow_allocation_count--;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   NoAllocVerifier(bool activated = true) {}</span>
<span class="udiff-line-removed">-   ~NoAllocVerifier() {}</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+   PauseNoSafepointVerifier(NoSafepointVerifier* nsv) NOT_DEBUG_RETURN;</span>
<span class="udiff-line-modified-added">+   ~PauseNoSafepointVerifier() NOT_DEBUG_RETURN;</span>
  };
  
  #endif // SHARE_RUNTIME_SAFEPOINTVERIFIERS_HPP
</pre>
<center><a href="safepointVerifiers.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="semaphore.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>