<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/sharedRuntime.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_RUNTIME_SHAREDRUNTIME_HPP
 26 #define SHARE_RUNTIME_SHAREDRUNTIME_HPP
 27 
 28 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
 29 #include &quot;interpreter/bytecodeTracer.hpp&quot;
 30 #include &quot;interpreter/linkResolver.hpp&quot;
 31 #include &quot;memory/allocation.hpp&quot;
 32 #include &quot;memory/resourceArea.hpp&quot;
 33 #include &quot;utilities/hashtable.hpp&quot;
 34 #include &quot;utilities/macros.hpp&quot;
 35 
 36 class AdapterHandlerEntry;
 37 class AdapterHandlerTable;
 38 class AdapterFingerPrint;
 39 class vframeStream;
 40 
 41 // Runtime is the base class for various runtime interfaces
 42 // (InterpreterRuntime, CompilerRuntime, etc.). It provides
 43 // shared functionality such as exception forwarding (C++ to
 44 // Java exceptions), locking/unlocking mechanisms, statistical
 45 // information, etc.
 46 
 47 class SharedRuntime: AllStatic {
 48   friend class VMStructs;
 49 
 50  private:
 51   static bool resolve_sub_helper_internal(methodHandle callee_method, const frame&amp; caller_frame,
 52                                           CompiledMethod* caller_nm, bool is_virtual, bool is_optimized,
 53                                           Handle receiver, CallInfo&amp; call_info, Bytecodes::Code invoke_code, TRAPS);
 54   static methodHandle resolve_sub_helper(JavaThread *thread,
 55                                          bool is_virtual,
 56                                          bool is_optimized, TRAPS);
 57 
 58   // Shared stub locations
 59 
 60   static RuntimeStub*        _wrong_method_blob;
 61   static RuntimeStub*        _wrong_method_abstract_blob;
 62   static RuntimeStub*        _ic_miss_blob;
 63   static RuntimeStub*        _resolve_opt_virtual_call_blob;
 64   static RuntimeStub*        _resolve_virtual_call_blob;
 65   static RuntimeStub*        _resolve_static_call_blob;
 66   static address             _resolve_static_call_entry;
 67 
 68   static DeoptimizationBlob* _deopt_blob;
 69 
 70   static SafepointBlob*      _polling_page_vectors_safepoint_handler_blob;
 71   static SafepointBlob*      _polling_page_safepoint_handler_blob;
 72   static SafepointBlob*      _polling_page_return_handler_blob;
 73 
 74 #ifdef COMPILER2
 75   static UncommonTrapBlob*   _uncommon_trap_blob;
 76 #endif // COMPILER2
 77 
 78 #ifndef PRODUCT
 79   // Counters
 80   static int     _nof_megamorphic_calls;         // total # of megamorphic calls (through vtable)
 81 #endif // !PRODUCT
 82 
 83  private:
 84   enum { POLL_AT_RETURN,  POLL_AT_LOOP, POLL_AT_VECTOR_LOOP };
 85   static SafepointBlob* generate_handler_blob(address call_ptr, int poll_type);
 86   static RuntimeStub*   generate_resolve_blob(address destination, const char* name);
 87 
 88  public:
 89   static void generate_stubs(void);
 90 
 91   // max bytes for each dtrace string parameter
 92   enum { max_dtrace_string_size = 256 };
 93 
 94   // The following arithmetic routines are used on platforms that do
 95   // not have machine instructions to implement their functionality.
 96   // Do not remove these.
 97 
 98   // long arithmetics
 99   static jlong   lmul(jlong y, jlong x);
100   static jlong   ldiv(jlong y, jlong x);
101   static jlong   lrem(jlong y, jlong x);
102 
103   // float and double remainder
104   static jfloat  frem(jfloat  x, jfloat  y);
105   static jdouble drem(jdouble x, jdouble y);
106 
107 
108 #ifdef _WIN64
109   // Workaround for fmod issue in the Windows x64 CRT
110   static double fmod_winx64(double x, double y);
111 #endif
112 
113 #ifdef __SOFTFP__
114   static jfloat  fadd(jfloat x, jfloat y);
115   static jfloat  fsub(jfloat x, jfloat y);
116   static jfloat  fmul(jfloat x, jfloat y);
117   static jfloat  fdiv(jfloat x, jfloat y);
118 
119   static jdouble dadd(jdouble x, jdouble y);
120   static jdouble dsub(jdouble x, jdouble y);
121   static jdouble dmul(jdouble x, jdouble y);
122   static jdouble ddiv(jdouble x, jdouble y);
123 #endif // __SOFTFP__
124 
125   // float conversion (needs to set appropriate rounding mode)
126   static jint    f2i (jfloat  x);
127   static jlong   f2l (jfloat  x);
128   static jint    d2i (jdouble x);
129   static jlong   d2l (jdouble x);
130   static jfloat  d2f (jdouble x);
131   static jfloat  l2f (jlong   x);
132   static jdouble l2d (jlong   x);
133 
134 #ifdef __SOFTFP__
135   static jfloat  i2f (jint    x);
136   static jdouble i2d (jint    x);
137   static jdouble f2d (jfloat  x);
138 #endif // __SOFTFP__
139 
140   // double trigonometrics and transcendentals
141   static jdouble dsin(jdouble x);
142   static jdouble dcos(jdouble x);
143   static jdouble dtan(jdouble x);
144   static jdouble dlog(jdouble x);
145   static jdouble dlog10(jdouble x);
146   static jdouble dexp(jdouble x);
147   static jdouble dpow(jdouble x, jdouble y);
148 
149 #if defined(__SOFTFP__) || defined(E500V2)
150   static double dabs(double f);
151 #endif
152 
153 #if defined(__SOFTFP__) || defined(PPC)
154   static double dsqrt(double f);
155 #endif
156 
157   // Montgomery multiplication
158   static void montgomery_multiply(jint *a_ints, jint *b_ints, jint *n_ints,
159                                   jint len, jlong inv, jint *m_ints);
160   static void montgomery_square(jint *a_ints, jint *n_ints,
161                                 jint len, jlong inv, jint *m_ints);
162 
163 #ifdef __SOFTFP__
164   // C++ compiler generates soft float instructions as well as passing
165   // float and double in registers.
166   static int  fcmpl(float x, float y);
167   static int  fcmpg(float x, float y);
168   static int  dcmpl(double x, double y);
169   static int  dcmpg(double x, double y);
170 
171   static int unordered_fcmplt(float x, float y);
172   static int unordered_dcmplt(double x, double y);
173   static int unordered_fcmple(float x, float y);
174   static int unordered_dcmple(double x, double y);
175   static int unordered_fcmpge(float x, float y);
176   static int unordered_dcmpge(double x, double y);
177   static int unordered_fcmpgt(float x, float y);
178   static int unordered_dcmpgt(double x, double y);
179 
180   static float  fneg(float f);
181   static double dneg(double f);
182 #endif
183 
184   // exception handling across interpreter/compiler boundaries
185   static address raw_exception_handler_for_return_address(JavaThread* thread, address return_address);
186   static address exception_handler_for_return_address(JavaThread* thread, address return_address);
187 
188   // exception handling and implicit exceptions
189   static address compute_compiled_exc_handler(CompiledMethod* nm, address ret_pc, Handle&amp; exception,
190                                               bool force_unwind, bool top_frame_only, bool&amp; recursive_exception_occurred);
191   enum ImplicitExceptionKind {
192     IMPLICIT_NULL,
193     IMPLICIT_DIVIDE_BY_ZERO,
194     STACK_OVERFLOW
195   };
196   static void    throw_AbstractMethodError(JavaThread* thread);
197   static void    throw_IncompatibleClassChangeError(JavaThread* thread);
198   static void    throw_ArithmeticException(JavaThread* thread);
199   static void    throw_NullPointerException(JavaThread* thread);
200   static void    throw_NullPointerException_at_call(JavaThread* thread);
201   static void    throw_StackOverflowError(JavaThread* thread);
202   static void    throw_delayed_StackOverflowError(JavaThread* thread);
203   static void    throw_StackOverflowError_common(JavaThread* thread, bool delayed);
204   static address continuation_for_implicit_exception(JavaThread* thread,
205                                                      address faulting_pc,
206                                                      ImplicitExceptionKind exception_kind);
<a name="1" id="anc1"></a>


207 
208   // Post-slow-path-allocation, pre-initializing-stores step for
209   // implementing e.g. ReduceInitialCardMarks
210   static void on_slowpath_allocation_exit(JavaThread* thread);
211 
212   static void enable_stack_reserved_zone(JavaThread* thread);
213   static frame look_for_reserved_stack_annotated_method(JavaThread* thread, frame fr);
214 
215   // Shared stub locations
216   static address get_poll_stub(address pc);
217 
218   static address get_ic_miss_stub() {
219     assert(_ic_miss_blob!= NULL, &quot;oops&quot;);
220     return _ic_miss_blob-&gt;entry_point();
221   }
222 
223   static address get_handle_wrong_method_stub() {
224     assert(_wrong_method_blob!= NULL, &quot;oops&quot;);
225     return _wrong_method_blob-&gt;entry_point();
226   }
227 
228   static address get_handle_wrong_method_abstract_stub() {
229     assert(_wrong_method_abstract_blob!= NULL, &quot;oops&quot;);
230     return _wrong_method_abstract_blob-&gt;entry_point();
231   }
232 
233 #ifdef COMPILER2
234   static void generate_uncommon_trap_blob(void);
235   static UncommonTrapBlob* uncommon_trap_blob()                  { return _uncommon_trap_blob; }
236 #endif // COMPILER2
237 
238   static address get_resolve_opt_virtual_call_stub() {
239     assert(_resolve_opt_virtual_call_blob != NULL, &quot;oops&quot;);
240     return _resolve_opt_virtual_call_blob-&gt;entry_point();
241   }
242   static address get_resolve_virtual_call_stub() {
243     assert(_resolve_virtual_call_blob != NULL, &quot;oops&quot;);
244     return _resolve_virtual_call_blob-&gt;entry_point();
245   }
246   static address get_resolve_static_call_stub() {
247     assert(_resolve_static_call_blob != NULL, &quot;oops&quot;);
248     return _resolve_static_call_blob-&gt;entry_point();
249   }
250 
251   static SafepointBlob* polling_page_return_handler_blob()     { return _polling_page_return_handler_blob; }
252   static SafepointBlob* polling_page_safepoint_handler_blob()  { return _polling_page_safepoint_handler_blob; }
253   static SafepointBlob* polling_page_vectors_safepoint_handler_blob()  { return _polling_page_vectors_safepoint_handler_blob; }
254 
255   // Counters
256 #ifndef PRODUCT
257   static address nof_megamorphic_calls_addr() { return (address)&amp;_nof_megamorphic_calls; }
258 #endif // PRODUCT
259 
260   // Helper routine for full-speed JVMTI exception throwing support
261   static void throw_and_post_jvmti_exception(JavaThread *thread, Handle h_exception);
262   static void throw_and_post_jvmti_exception(JavaThread *thread, Symbol* name, const char *message = NULL);
263 
264   // RedefineClasses() tracing support for obsolete method entry
265   static int rc_trace_method_entry(JavaThread* thread, Method* m);
266 
267   // To be used as the entry point for unresolved native methods.
268   static address native_method_throw_unsatisfied_link_error_entry();
269   static address native_method_throw_unsupported_operation_exception_entry();
270 
271   static oop retrieve_receiver(Symbol* sig, frame caller);
272 
273   static void register_finalizer(JavaThread* thread, oopDesc* obj);
274 
275   // dtrace notifications
276   static int dtrace_object_alloc(oopDesc* o, int size);
277   static int dtrace_object_alloc_base(Thread* thread, oopDesc* o, int size);
278   static int dtrace_method_entry(JavaThread* thread, Method* m);
279   static int dtrace_method_exit(JavaThread* thread, Method* m);
280 
281 #if INCLUDE_TSAN
282   // TSAN instrumentation
283 
284   // TSAN uses a 64-bit value to identify code location.
285   // TSAN uses the uppermost 3 bits (63:61) for the internal purposes.
286   // If bit 60 is set, TSAN recognizes that the code location belongs to the
287   // JVM, and will call __tsan_symbolize_external_ex() for symbolization rather
288   // than TSAN&#39;s own symbolizer. See __sanitizer::kExternalPCBit and
289   // __tsan::__tsan_symbolize_external_ex() in TSAN for more details.
290   // The lower 60 bits may contain either a packed bytecode location, or an
291   // instruction address inside the code generated by JIT compiler.
292   // A packed code location has the method ID in bits 59:16 and the bytecode
293   //offset within method in bits 15:0. 44 bits (59:16) are enough to encode any
294   // 47-bit 8-byte-aligned address, which is the maximum address space TSAN
295   // allows. The next 16 bits are used for storing the bci.
296   // | Tsan: 3 | TsanJava: 1 | jmethodID: 44 | BCI: 16 |
297   static const int tsan_method_id_alignment_bits = 3;
298   static const int tsan_bci_bits = 16;
299   static const u8 tsan_bci_mask = right_n_bits(tsan_bci_bits);
300   static const int tsan_method_id_shift = tsan_bci_bits -
301       tsan_method_id_alignment_bits;
302   static const u8 tsan_fake_pc_bit = 1L &lt;&lt; 60;
303   static void * tsan_code_location(jmethodID jmethod_id_ptr, u2 bci) {
304     return (void *)(tsan_fake_pc_bit |
305       (((u8)(jmethod_id_ptr)) &lt;&lt; tsan_method_id_shift) | bci);
306   }
307   static jmethodID tsan_method_id_from_code_location(u8 loc) {
308     return (jmethodID)(
309         (loc &amp; ~(tsan_fake_pc_bit | tsan_bci_mask)) &gt;&gt; tsan_method_id_shift);
310   }
311   static u2 tsan_bci_from_code_location(u8 loc) {
312     return (u2)(loc &amp; tsan_bci_mask);
313   }
314 
315   // These functions are wrappers around TSAN callbacks,
316   // which are listed in tsanExternalDecls.hpp. The VM uses only these
317   // functions to push events to ThreadSanitizer.
318 
319   // Verify that an oop is valid and that the index is within the object size.
320   static void verify_oop_index(oopDesc* obj, int index);
321 
322   // Java method entry/exit from code run by template interpreter
323   static void tsan_interp_method_entry(JavaThread *thread);
324   static void tsan_interp_method_exit();
325 
326   // Monitor acquire/release in VM code
327   // (e.g., generated native method wrapper, JNI heavyweight locks)
328   static void tsan_oop_lock(Thread* thread, oop obj);
329   static void tsan_oop_unlock(Thread* thread, oop obj);
330   // Monitor acquire/release in VM code; recursive lock variant (e.g., wait())
331   static void tsan_oop_rec_lock(Thread* thread, oop obj, int rec);
332   static int tsan_oop_rec_unlock(Thread* thread, oop obj);
333 
334   // Monitor acquire/release from code run by template interpreter
335   static void tsan_interp_lock(JavaThread* thread, BasicObjectLock* elem);
336   static void tsan_interp_unlock(JavaThread* thread, BasicObjectLock* elem);
337 
338   // Address must point to an object in the Java heap.
339   static void tsan_acquire(void* address);
340   static void tsan_release(void* address);
341 
342   // Called whenever an obj is created.
343   static void tsan_track_obj_with_size(oopDesc* obj, int size);
344   static void tsan_track_obj(oopDesc* obj);
345 
346   // Memory reads/writes from code run by template interpreter
347   static void tsan_read1(void* addr, Method* method, address bcp);
348   static void tsan_read2(void* addr, Method* method, address bcp);
349   static void tsan_read4(void* addr, Method* method, address bcp);
350   static void tsan_read8(void* addr, Method* method, address bcp);
351   static void tsan_write1(void* addr, Method* method, address bcp);
352   static void tsan_write2(void* addr, Method* method, address bcp);
353   static void tsan_write4(void* addr, Method* method, address bcp);
354   static void tsan_write8(void* addr, Method* method, address bcp);
355 
356 #endif // INCLUDE_TSAN
357 
358   // Utility method for retrieving the Java thread id, returns 0 if the
359   // thread is not a well formed Java thread.
360   static jlong get_java_tid(Thread* thread);
361 
362 
363   // used by native wrappers to reenable yellow if overflow happened in native code
364   static void reguard_yellow_pages();
365 
366   // Fill in the &quot;X cannot be cast to a Y&quot; message for ClassCastException
367   //
368   // @param thr the current thread
369   // @param caster_klass the class of the object we are casting
370   // @return the dynamically allocated exception message (must be freed
371   // by the caller using a resource mark)
372   //
373   // BCP must refer to the current &#39;checkcast&#39; opcode for the frame
374   // on top of the stack.
375   // The caller (or one of its callers) must use a ResourceMark
376   // in order to correctly free the result.
377   //
378   static char* generate_class_cast_message(JavaThread* thr, Klass* caster_klass);
379 
380   // Fill in the &quot;X cannot be cast to a Y&quot; message for ClassCastException
381   //
382   // @param caster_klass the class of the object we are casting
383   // @param target_klass the target klass attempt
384   // @return the dynamically allocated exception message (must be freed
385   // by the caller using a resource mark)
386   //
387   // This version does not require access the frame, so it can be called
388   // from interpreted code
389   // The caller (or one of it&#39;s callers) must use a ResourceMark
390   // in order to correctly free the result.
391   //
392   static char* generate_class_cast_message(Klass* caster_klass, Klass* target_klass, Symbol* target_klass_name = NULL);
393 
394   // Resolves a call site- may patch in the destination of the call into the
395   // compiled code.
396   static methodHandle resolve_helper(JavaThread *thread,
397                                      bool is_virtual,
398                                      bool is_optimized, TRAPS);
399 
400  private:
401   // deopt blob
402   static void generate_deopt_blob(void);
403 
404   static bool handle_ic_miss_helper_internal(Handle receiver, CompiledMethod* caller_nm, const frame&amp; caller_frame,
405                                              methodHandle callee_method, Bytecodes::Code bc, CallInfo&amp; call_info,
406                                              bool&amp; needs_ic_stub_refill, TRAPS);
407 
408  public:
409   static DeoptimizationBlob* deopt_blob(void)      { return _deopt_blob; }
410 
411   // Resets a call-site in compiled code so it will get resolved again.
412   static methodHandle reresolve_call_site(JavaThread *thread, TRAPS);
413 
414   // In the code prolog, if the klass comparison fails, the inline cache
415   // misses and the call site is patched to megamorphic
416   static methodHandle handle_ic_miss_helper(JavaThread* thread, TRAPS);
417 
418   // Find the method that called us.
419   static methodHandle find_callee_method(JavaThread* thread, TRAPS);
420 
421 
422  private:
423   static Handle find_callee_info(JavaThread* thread,
424                                  Bytecodes::Code&amp; bc,
425                                  CallInfo&amp; callinfo, TRAPS);
426   static Handle find_callee_info_helper(JavaThread* thread,
427                                         vframeStream&amp; vfst,
428                                         Bytecodes::Code&amp; bc,
429                                         CallInfo&amp; callinfo, TRAPS);
430 
<a name="2" id="anc2"></a><span class="line-modified">431   static Method* extract_attached_method(vframeStream&amp; vfst);</span>
432 
433   static address clean_virtual_call_entry();
434   static address clean_opt_virtual_call_entry();
435   static address clean_static_call_entry();
436 
437 #if defined(X86) &amp;&amp; defined(COMPILER1)
438   // For Object.hashCode, System.identityHashCode try to pull hashCode from object header if available.
439   static void inline_check_hashcode_from_object_header(MacroAssembler* masm, const methodHandle&amp; method, Register obj_reg, Register result);
440 #endif // X86 &amp;&amp; COMPILER1
441 
442  public:
443 
444   // Read the array of BasicTypes from a Java signature, and compute where
445   // compiled Java code would like to put the results.  Values in reg_lo and
446   // reg_hi refer to 4-byte quantities.  Values less than SharedInfo::stack0 are
447   // registers, those above refer to 4-byte stack slots.  All stack slots are
448   // based off of the window top.  SharedInfo::stack0 refers to the first usable
449   // slot in the bottom of the frame. SharedInfo::stack0+1 refers to the memory word
450   // 4-bytes higher. So for sparc because the register window save area is at
451   // the bottom of the frame the first 16 words will be skipped and SharedInfo::stack0
452   // will be just above it. (
453   // return value is the maximum number of VMReg stack slots the convention will use.
454   static int java_calling_convention(const BasicType* sig_bt, VMRegPair* regs, int total_args_passed, int is_outgoing);
455 
456   static void check_member_name_argument_is_last_argument(const methodHandle&amp; method,
457                                                           const BasicType* sig_bt,
458                                                           const VMRegPair* regs) NOT_DEBUG_RETURN;
459 
460   // Ditto except for calling C
461   //
462   // C argument in register AND stack slot.
463   // Some architectures require that an argument must be passed in a register
464   // AND in a stack slot. These architectures provide a second VMRegPair array
465   // to be filled by the c_calling_convention method. On other architectures,
466   // NULL is being passed as the second VMRegPair array, so arguments are either
467   // passed in a register OR in a stack slot.
468   static int c_calling_convention(const BasicType *sig_bt, VMRegPair *regs, VMRegPair *regs2,
469                                   int total_args_passed);
470 
471   static size_t trampoline_size();
472 
473   static void generate_trampoline(MacroAssembler *masm, address destination);
474 
475   // Generate I2C and C2I adapters. These adapters are simple argument marshalling
476   // blobs. Unlike adapters in the tiger and earlier releases the code in these
477   // blobs does not create a new frame and are therefore virtually invisible
478   // to the stack walking code. In general these blobs extend the callers stack
479   // as needed for the conversion of argument locations.
480 
481   // When calling a c2i blob the code will always call the interpreter even if
482   // by the time we reach the blob there is compiled code available. This allows
483   // the blob to pass the incoming stack pointer (the sender sp) in a known
484   // location for the interpreter to record. This is used by the frame code
485   // to correct the sender code to match up with the stack pointer when the
486   // thread left the compiled code. In addition it allows the interpreter
487   // to remove the space the c2i adapter allocated to do its argument conversion.
488 
489   // Although a c2i blob will always run interpreted even if compiled code is
490   // present if we see that compiled code is present the compiled call site
491   // will be patched/re-resolved so that later calls will run compiled.
492 
493   // Additionally a c2i blob need to have a unverified entry because it can be reached
494   // in situations where the call site is an inlined cache site and may go megamorphic.
495 
496   // A i2c adapter is simpler than the c2i adapter. This is because it is assumed
497   // that the interpreter before it does any call dispatch will record the current
498   // stack pointer in the interpreter frame. On return it will restore the stack
499   // pointer as needed. This means the i2c adapter code doesn&#39;t need any special
500   // handshaking path with compiled code to keep the stack walking correct.
501 
502   static AdapterHandlerEntry* generate_i2c2i_adapters(MacroAssembler *_masm,
503                                                       int total_args_passed,
504                                                       int max_arg,
505                                                       const BasicType *sig_bt,
506                                                       const VMRegPair *regs,
507                                                       AdapterFingerPrint* fingerprint);
508 
509   static void gen_i2c_adapter(MacroAssembler *_masm,
510                               int total_args_passed,
511                               int comp_args_on_stack,
512                               const BasicType *sig_bt,
513                               const VMRegPair *regs);
514 
515   // OSR support
516 
517   // OSR_migration_begin will extract the jvm state from an interpreter
518   // frame (locals, monitors) and store the data in a piece of C heap
519   // storage. This then allows the interpreter frame to be removed from the
520   // stack and the OSR nmethod to be called. That method is called with a
521   // pointer to the C heap storage. This pointer is the return value from
522   // OSR_migration_begin.
523 
524   static intptr_t* OSR_migration_begin(JavaThread *thread);
525 
526   // OSR_migration_end is a trivial routine. It is called after the compiled
527   // method has extracted the jvm state from the C heap that OSR_migration_begin
528   // created. It&#39;s entire job is to simply free this storage.
529   static void OSR_migration_end(intptr_t* buf);
530 
531   // Convert a sig into a calling convention register layout
532   // and find interesting things about it.
533   static VMRegPair* find_callee_arguments(Symbol* sig, bool has_receiver, bool has_appendix, int *arg_size);
534   static VMReg name_for_receiver();
535 
536   // &quot;Top of Stack&quot; slots that may be unused by the calling convention but must
537   // otherwise be preserved.
538   // On Intel these are not necessary and the value can be zero.
539   // On Sparc this describes the words reserved for storing a register window
540   // when an interrupt occurs.
541   static uint out_preserve_stack_slots();
542 
543   // Is vector&#39;s size (in bytes) bigger than a size saved by default?
544   // For example, on x86 16 bytes XMM registers are saved by default.
545   static bool is_wide_vector(int size);
546 
547   // Save and restore a native result
548   static void    save_native_result(MacroAssembler *_masm, BasicType ret_type, int frame_slots);
549   static void restore_native_result(MacroAssembler *_masm, BasicType ret_type, int frame_slots);
550 
551   // Generate a native wrapper for a given method.  The method takes arguments
552   // in the Java compiled code convention, marshals them to the native
553   // convention (handlizes oops, etc), transitions to native, makes the call,
554   // returns to java state (possibly blocking), unhandlizes any result and
555   // returns.
556   //
557   // The wrapper may contain special-case code if the given method
558   // is a JNI critical method, or a compiled method handle adapter,
559   // such as _invokeBasic, _linkToVirtual, etc.
560   static nmethod* generate_native_wrapper(MacroAssembler* masm,
561                                           const methodHandle&amp; method,
562                                           int compile_id,
563                                           BasicType* sig_bt,
564                                           VMRegPair* regs,
<a name="3" id="anc3"></a><span class="line-modified">565                                           BasicType ret_type,</span>
<span class="line-added">566                                           address critical_entry);</span>
567 
568   // Block before entering a JNI critical method
569   static void block_for_jni_critical(JavaThread* thread);
570 
571   // Pin/Unpin object
572   static oopDesc* pin_object(JavaThread* thread, oopDesc* obj);
573   static void unpin_object(JavaThread* thread, oopDesc* obj);
574 
575   // A compiled caller has just called the interpreter, but compiled code
576   // exists.  Patch the caller so he no longer calls into the interpreter.
577   static void fixup_callers_callsite(Method* moop, address ret_pc);
578   static bool should_fixup_call_destination(address destination, address entry_point, address caller_pc, Method* moop, CodeBlob* cb);
579 
580   // Slow-path Locking and Unlocking
581   static void complete_monitor_locking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread);
582   static void complete_monitor_unlocking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread);
583 
584   // Resolving of calls
585   static address resolve_static_call_C     (JavaThread *thread);
586   static address resolve_virtual_call_C    (JavaThread *thread);
587   static address resolve_opt_virtual_call_C(JavaThread *thread);
588 
589   // arraycopy, the non-leaf version.  (See StubRoutines for all the leaf calls.)
590   static void slow_arraycopy_C(oopDesc* src,  jint src_pos,
591                                oopDesc* dest, jint dest_pos,
592                                jint length, JavaThread* thread);
593 
594   // handle ic miss with caller being compiled code
595   // wrong method handling (inline cache misses, zombie methods)
596   static address handle_wrong_method(JavaThread* thread);
597   static address handle_wrong_method_abstract(JavaThread* thread);
598   static address handle_wrong_method_ic_miss(JavaThread* thread);
599 
600   static address handle_unsafe_access(JavaThread* thread, address next_pc);
601 
602 #ifndef PRODUCT
603 
604   // Collect and print inline cache miss statistics
605  private:
606   enum { maxICmiss_count = 100 };
607   static int     _ICmiss_index;                  // length of IC miss histogram
608   static int     _ICmiss_count[maxICmiss_count]; // miss counts
609   static address _ICmiss_at[maxICmiss_count];    // miss addresses
610   static void trace_ic_miss(address at);
611 
612  public:
613   static int _throw_null_ctr;                    // throwing a null-pointer exception
614   static int _ic_miss_ctr;                       // total # of IC misses
615   static int _wrong_method_ctr;
616   static int _resolve_static_ctr;
617   static int _resolve_virtual_ctr;
618   static int _resolve_opt_virtual_ctr;
619   static int _implicit_null_throws;
620   static int _implicit_div0_throws;
621 
622   static int _jbyte_array_copy_ctr;        // Slow-path byte array copy
623   static int _jshort_array_copy_ctr;       // Slow-path short array copy
624   static int _jint_array_copy_ctr;         // Slow-path int array copy
625   static int _jlong_array_copy_ctr;        // Slow-path long array copy
626   static int _oop_array_copy_ctr;          // Slow-path oop array copy
627   static int _checkcast_array_copy_ctr;    // Slow-path oop array copy, with cast
628   static int _unsafe_array_copy_ctr;       // Slow-path includes alignment checks
629   static int _generic_array_copy_ctr;      // Slow-path includes type decoding
630   static int _slow_array_copy_ctr;         // Slow-path failed out to a method call
631 
632   static int _new_instance_ctr;            // &#39;new&#39; object requires GC
633   static int _new_array_ctr;               // &#39;new&#39; array requires GC
634   static int _multi1_ctr, _multi2_ctr, _multi3_ctr, _multi4_ctr, _multi5_ctr;
635   static int _find_handler_ctr;            // find exception handler
636   static int _rethrow_ctr;                 // rethrow exception
637   static int _mon_enter_stub_ctr;          // monitor enter stub
638   static int _mon_exit_stub_ctr;           // monitor exit stub
639   static int _mon_enter_ctr;               // monitor enter slow
640   static int _mon_exit_ctr;                // monitor exit slow
641   static int _partial_subtype_ctr;         // SubRoutines::partial_subtype_check
642 
643   // Statistics code
644   // stats for &quot;normal&quot; compiled calls (non-interface)
645   static int     _nof_normal_calls;              // total # of calls
646   static int     _nof_optimized_calls;           // total # of statically-bound calls
647   static int     _nof_inlined_calls;             // total # of inlined normal calls
648   static int     _nof_static_calls;              // total # of calls to static methods or super methods (invokespecial)
649   static int     _nof_inlined_static_calls;      // total # of inlined static calls
650   // stats for compiled interface calls
651   static int     _nof_interface_calls;           // total # of compiled calls
652   static int     _nof_optimized_interface_calls; // total # of statically-bound interface calls
653   static int     _nof_inlined_interface_calls;   // total # of inlined interface calls
654   static int     _nof_megamorphic_interface_calls;// total # of megamorphic interface calls
655   // stats for runtime exceptions
656   static int     _nof_removable_exceptions;      // total # of exceptions that could be replaced by branches due to inlining
657 
658  public: // for compiler
659   static address nof_normal_calls_addr()                { return (address)&amp;_nof_normal_calls; }
660   static address nof_optimized_calls_addr()             { return (address)&amp;_nof_optimized_calls; }
661   static address nof_inlined_calls_addr()               { return (address)&amp;_nof_inlined_calls; }
662   static address nof_static_calls_addr()                { return (address)&amp;_nof_static_calls; }
663   static address nof_inlined_static_calls_addr()        { return (address)&amp;_nof_inlined_static_calls; }
664   static address nof_interface_calls_addr()             { return (address)&amp;_nof_interface_calls; }
665   static address nof_optimized_interface_calls_addr()   { return (address)&amp;_nof_optimized_interface_calls; }
666   static address nof_inlined_interface_calls_addr()     { return (address)&amp;_nof_inlined_interface_calls; }
667   static address nof_megamorphic_interface_calls_addr() { return (address)&amp;_nof_megamorphic_interface_calls; }
668   static void print_call_statistics(int comp_total);
669   static void print_statistics();
670   static void print_ic_miss_histogram();
671 
672 #endif // PRODUCT
673 };
674 
675 
676 // ---------------------------------------------------------------------------
677 // Implementation of AdapterHandlerLibrary
678 //
679 // This library manages argument marshaling adapters and native wrappers.
680 // There are 2 flavors of adapters: I2C and C2I.
681 //
682 // The I2C flavor takes a stock interpreted call setup, marshals the
683 // arguments for a Java-compiled call, and jumps to Rmethod-&gt; code()-&gt;
684 // code_begin().  It is broken to call it without an nmethod assigned.
685 // The usual behavior is to lift any register arguments up out of the
686 // stack and possibly re-pack the extra arguments to be contiguous.
687 // I2C adapters will save what the interpreter&#39;s stack pointer will be
688 // after arguments are popped, then adjust the interpreter&#39;s frame
689 // size to force alignment and possibly to repack the arguments.
690 // After re-packing, it jumps to the compiled code start.  There are
691 // no safepoints in this adapter code and a GC cannot happen while
692 // marshaling is in progress.
693 //
694 // The C2I flavor takes a stock compiled call setup plus the target method in
695 // Rmethod, marshals the arguments for an interpreted call and jumps to
696 // Rmethod-&gt;_i2i_entry.  On entry, the interpreted frame has not yet been
697 // setup.  Compiled frames are fixed-size and the args are likely not in the
698 // right place.  Hence all the args will likely be copied into the
699 // interpreter&#39;s frame, forcing that frame to grow.  The compiled frame&#39;s
700 // outgoing stack args will be dead after the copy.
701 //
702 // Native wrappers, like adapters, marshal arguments.  Unlike adapters they
703 // also perform an official frame push &amp; pop.  They have a call to the native
704 // routine in their middles and end in a return (instead of ending in a jump).
705 // The native wrappers are stored in real nmethods instead of the BufferBlobs
706 // used by the adapters.  The code generation happens here because it&#39;s very
707 // similar to what the adapters have to do.
708 
709 class AdapterHandlerEntry : public BasicHashtableEntry&lt;mtCode&gt; {
710   friend class AdapterHandlerTable;
711 
712  private:
713   AdapterFingerPrint* _fingerprint;
714   address _i2c_entry;
715   address _c2i_entry;
716   address _c2i_unverified_entry;
<a name="4" id="anc4"></a><span class="line-added">717   address _c2i_no_clinit_check_entry;</span>
718 
719 #ifdef ASSERT
720   // Captures code and signature used to generate this adapter when
721   // verifying adapter equivalence.
722   unsigned char* _saved_code;
723   int            _saved_code_length;
724 #endif
725 
<a name="5" id="anc5"></a><span class="line-modified">726   void init(AdapterFingerPrint* fingerprint, address i2c_entry, address c2i_entry, address c2i_unverified_entry, address c2i_no_clinit_check_entry) {</span>
727     _fingerprint = fingerprint;
728     _i2c_entry = i2c_entry;
729     _c2i_entry = c2i_entry;
730     _c2i_unverified_entry = c2i_unverified_entry;
<a name="6" id="anc6"></a><span class="line-added">731     _c2i_no_clinit_check_entry = c2i_no_clinit_check_entry;</span>
732 #ifdef ASSERT
733     _saved_code = NULL;
734     _saved_code_length = 0;
735 #endif
736   }
737 
738   void deallocate();
739 
740   // should never be used
741   AdapterHandlerEntry();
742 
743  public:
<a name="7" id="anc7"></a><span class="line-modified">744   address get_i2c_entry()                  const { return _i2c_entry; }</span>
<span class="line-modified">745   address get_c2i_entry()                  const { return _c2i_entry; }</span>
<span class="line-modified">746   address get_c2i_unverified_entry()       const { return _c2i_unverified_entry; }</span>
<span class="line-added">747   address get_c2i_no_clinit_check_entry()  const { return _c2i_no_clinit_check_entry; }</span>
<span class="line-added">748 </span>
749   address base_address();
750   void relocate(address new_base);
751 
752   AdapterFingerPrint* fingerprint() const { return _fingerprint; }
753 
754   AdapterHandlerEntry* next() {
755     return (AdapterHandlerEntry*)BasicHashtableEntry&lt;mtCode&gt;::next();
756   }
757 
758 #ifdef ASSERT
759   // Used to verify that code generated for shared adapters is equivalent
760   void save_code   (unsigned char* code, int length);
761   bool compare_code(unsigned char* code, int length);
762 #endif
763 
764   //virtual void print_on(outputStream* st) const;  DO NOT USE
765   void print_adapter_on(outputStream* st) const;
766 };
767 
768 // This class is used only with DumpSharedSpaces==true. It holds extra information
769 // that&#39;s used only during CDS dump time.
770 // For details, see comments around Method::link_method()
771 class CDSAdapterHandlerEntry: public AdapterHandlerEntry {
772   address               _c2i_entry_trampoline;   // allocated from shared spaces &quot;MC&quot; region
773   AdapterHandlerEntry** _adapter_trampoline;     // allocated from shared spaces &quot;MD&quot; region
774 
775 public:
776   address get_c2i_entry_trampoline()             const { return _c2i_entry_trampoline; }
777   AdapterHandlerEntry** get_adapter_trampoline() const { return _adapter_trampoline; }
778   void init() NOT_CDS_RETURN;
779 };
780 
781 
782 class AdapterHandlerLibrary: public AllStatic {
783  private:
784   static BufferBlob* _buffer; // the temporary code buffer in CodeCache
785   static AdapterHandlerTable* _adapters;
786   static AdapterHandlerEntry* _abstract_method_handler;
787   static BufferBlob* buffer_blob();
788   static void initialize();
789   static AdapterHandlerEntry* get_adapter0(const methodHandle&amp; method);
790 
791  public:
792 
793   static AdapterHandlerEntry* new_entry(AdapterFingerPrint* fingerprint,
<a name="8" id="anc8"></a><span class="line-modified">794                                         address i2c_entry,</span>
<span class="line-added">795                                         address c2i_entry,</span>
<span class="line-added">796                                         address c2i_unverified_entry,</span>
<span class="line-added">797                                         address c2i_no_clinit_check_entry = NULL);</span>
798   static void create_native_wrapper(const methodHandle&amp; method);
799   static AdapterHandlerEntry* get_adapter(const methodHandle&amp; method);
800 
801   static void print_handler(const CodeBlob* b) { print_handler_on(tty, b); }
802   static void print_handler_on(outputStream* st, const CodeBlob* b);
803   static bool contains(const CodeBlob* b);
804 #ifndef PRODUCT
805   static void print_statistics();
806 #endif // PRODUCT
807 
808 };
809 
810 #endif // SHARE_RUNTIME_SHAREDRUNTIME_HPP
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>