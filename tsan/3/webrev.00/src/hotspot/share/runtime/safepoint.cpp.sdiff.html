<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/safepoint.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="rtmLocking.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepoint.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepoint.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;

  27 #include &quot;classfile/stringTable.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/icBuffer.hpp&quot;
  32 #include &quot;code/nmethod.hpp&quot;
  33 #include &quot;code/pcDesc.hpp&quot;
  34 #include &quot;code/scopeDesc.hpp&quot;

  35 #include &quot;gc/shared/collectedHeap.hpp&quot;
  36 #include &quot;gc/shared/gcLocker.hpp&quot;

  37 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  38 #include &quot;gc/shared/workgroup.hpp&quot;
  39 #include &quot;interpreter/interpreter.hpp&quot;
  40 #include &quot;jfr/jfrEvents.hpp&quot;
  41 #include &quot;logging/log.hpp&quot;
  42 #include &quot;logging/logStream.hpp&quot;
  43 #include &quot;memory/resourceArea.hpp&quot;
  44 #include &quot;memory/universe.hpp&quot;
  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;oops/symbol.hpp&quot;
  47 #include &quot;runtime/atomic.hpp&quot;
<span class="line-removed">  48 #include &quot;runtime/compilationPolicy.hpp&quot;</span>
  49 #include &quot;runtime/deoptimization.hpp&quot;
  50 #include &quot;runtime/frame.inline.hpp&quot;
  51 #include &quot;runtime/handles.inline.hpp&quot;
  52 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  53 #include &quot;runtime/mutexLocker.hpp&quot;
  54 #include &quot;runtime/orderAccess.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/safepoint.hpp&quot;
  57 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  58 #include &quot;runtime/signature.hpp&quot;
  59 #include &quot;runtime/stubCodeGenerator.hpp&quot;
  60 #include &quot;runtime/stubRoutines.hpp&quot;
  61 #include &quot;runtime/sweeper.hpp&quot;
  62 #include &quot;runtime/synchronizer.hpp&quot;
  63 #include &quot;runtime/thread.inline.hpp&quot;
  64 #include &quot;runtime/threadSMR.hpp&quot;
  65 #include &quot;runtime/timerTrace.hpp&quot;
  66 #include &quot;services/runtimeService.hpp&quot;
  67 #include &quot;utilities/events.hpp&quot;
  68 #include &quot;utilities/macros.hpp&quot;
<span class="line-removed">  69 #ifdef COMPILER1</span>
<span class="line-removed">  70 #include &quot;c1/c1_globals.hpp&quot;</span>
<span class="line-removed">  71 #endif</span>
  72 
  73 static void post_safepoint_begin_event(EventSafepointBegin&amp; event,
  74                                        uint64_t safepoint_id,
  75                                        int thread_count,
  76                                        int critical_thread_count) {
  77   if (event.should_commit()) {
  78     event.set_safepointId(safepoint_id);
  79     event.set_totalThreadCount(thread_count);
  80     event.set_jniCriticalThreadCount(critical_thread_count);
  81     event.commit();
  82   }
  83 }
  84 
  85 static void post_safepoint_cleanup_event(EventSafepointCleanup&amp; event, uint64_t safepoint_id) {
  86   if (event.should_commit()) {
  87     event.set_safepointId(safepoint_id);
  88     event.commit();
  89   }
  90 }
  91 
</pre>
<hr />
<pre>
 103   }
 104 }
 105 
 106 static void post_safepoint_cleanup_task_event(EventSafepointCleanupTask&amp; event,
 107                                               uint64_t safepoint_id,
 108                                               const char* name) {
 109   if (event.should_commit()) {
 110     event.set_safepointId(safepoint_id);
 111     event.set_name(name);
 112     event.commit();
 113   }
 114 }
 115 
 116 static void post_safepoint_end_event(EventSafepointEnd&amp; event, uint64_t safepoint_id) {
 117   if (event.should_commit()) {
 118     event.set_safepointId(safepoint_id);
 119     event.commit();
 120   }
 121 }
 122 









 123 // --------------------------------------------------------------------------------------------------
 124 // Implementation of Safepoint begin/end
 125 
 126 SafepointSynchronize::SynchronizeState volatile SafepointSynchronize::_state = SafepointSynchronize::_not_synchronized;
 127 int SafepointSynchronize::_waiting_to_block = 0;
 128 volatile uint64_t SafepointSynchronize::_safepoint_counter = 0;

 129 const uint64_t SafepointSynchronize::InactiveSafepointCounter = 0;
 130 int SafepointSynchronize::_current_jni_active_count = 0;
 131 
 132 WaitBarrier* SafepointSynchronize::_wait_barrier;
 133 
 134 static volatile bool PageArmed = false;        // safepoint polling page is RO|RW vs PROT_NONE
 135 static bool timeout_error_printed = false;
 136 
 137 // Statistic related
 138 static jlong _safepoint_begin_time = 0;
 139 static volatile int _nof_threads_hit_polling_page = 0;
 140 
 141 void SafepointSynchronize::init(Thread* vmthread) {
 142   // WaitBarrier should never be destroyed since we will have
 143   // threads waiting on it while exiting.
 144   _wait_barrier = new WaitBarrier(vmthread);
 145   SafepointTracing::init();
 146 }
 147 
 148 void SafepointSynchronize::increment_jni_active_count() {
 149   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may increment&quot;);
 150   ++_current_jni_active_count;
 151 }
 152 
 153 void SafepointSynchronize::decrement_waiting_to_block() {
 154   assert(_waiting_to_block &gt; 0, &quot;sanity check&quot;);
 155   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may decrement&quot;);
 156   --_waiting_to_block;
 157 }
 158 
<span class="line-modified"> 159 static bool thread_not_running(ThreadSafepointState *cur_state) {</span>
 160   if (!cur_state-&gt;is_running()) {
 161     return true;
 162   }
 163   cur_state-&gt;examine_state_of_thread(SafepointSynchronize::safepoint_counter());
 164   if (!cur_state-&gt;is_running()) {
 165     return true;
 166   }
 167   LogTarget(Trace, safepoint) lt;
 168   if (lt.is_enabled()) {
 169     ResourceMark rm;
 170     LogStream ls(lt);
 171     cur_state-&gt;print_on(&amp;ls);
 172   }
 173   return false;
 174 }
 175 
 176 #ifdef ASSERT
 177 static void assert_list_is_valid(const ThreadSafepointState* tss_head, int still_running) {
 178   int a = 0;
 179   const ThreadSafepointState *tmp_tss = tss_head;
 180   while (tmp_tss != NULL) {
 181     ++a;
 182     assert(tmp_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 183     tmp_tss = tmp_tss-&gt;get_next();
 184   }
 185   assert(a == still_running, &quot;Must be the same&quot;);
 186 }
 187 #endif // ASSERT
 188 
<span class="line-modified"> 189 static void back_off(int iteration) {</span>
<span class="line-modified"> 190   // iteration will be 1 the first time we enter this spin back-off.</span>
<span class="line-modified"> 191   // naked_short_nanosleep takes tenths of micros which means that</span>
<span class="line-modified"> 192   // number of nanoseconds is irrelevant if it&#39;s below that. We do</span>
<span class="line-modified"> 193   // 20 1 ns sleeps with a total cost of ~1 ms, then we do 1 ms sleeps.</span>
<span class="line-modified"> 194   jlong sleep_ns = 1;</span>
<span class="line-modified"> 195   if (iteration &gt; 20) {</span>
<span class="line-removed"> 196     sleep_ns = NANOUNITS / MILLIUNITS;  // 1 ms</span>
 197   }
<span class="line-removed"> 198   os::naked_short_nanosleep(sleep_ns);</span>
 199 }
 200 
 201 int SafepointSynchronize::synchronize_threads(jlong safepoint_limit_time, int nof_threads, int* initial_running)
 202 {
 203   JavaThreadIteratorWithHandle jtiwh;
 204 
 205 #ifdef ASSERT
 206   for (; JavaThread *cur = jtiwh.next(); ) {
 207     assert(cur-&gt;safepoint_state()-&gt;is_running(), &quot;Illegal initial state&quot;);
 208   }
 209   jtiwh.rewind();
 210 #endif // ASSERT
 211 
 212   // Iterate through all threads until it has been determined how to stop them all at a safepoint.
 213   int still_running = nof_threads;
 214   ThreadSafepointState *tss_head = NULL;
 215   ThreadSafepointState **p_prev = &amp;tss_head;
 216   for (; JavaThread *cur = jtiwh.next(); ) {
 217     ThreadSafepointState *cur_tss = cur-&gt;safepoint_state();
 218     assert(cur_tss-&gt;get_next() == NULL, &quot;Must be NULL&quot;);
 219     if (thread_not_running(cur_tss)) {
 220       --still_running;
 221     } else {
 222       *p_prev = cur_tss;
 223       p_prev = cur_tss-&gt;next_ptr();
 224     }
 225   }
 226   *p_prev = NULL;
 227 
 228   DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 229 
 230   *initial_running = still_running;
 231 






 232   int iterations = 1; // The first iteration is above.

 233 
<span class="line-modified"> 234   while (still_running &gt; 0) {</span>
 235     // Check if this has taken too long:
 236     if (SafepointTimeout &amp;&amp; safepoint_limit_time &lt; os::javaTimeNanos()) {
 237       print_safepoint_timeout();
 238     }
 239     if (int(iterations) == -1) { // overflow - something is wrong.
 240       // We can only overflow here when we are using global
 241       // polling pages. We keep this guarantee in its original
 242       // form so that searches of the bug database for this
 243       // failure mode find the right bugs.
 244       guarantee (!PageArmed, &quot;invariant&quot;);
 245     }
 246 
 247     p_prev = &amp;tss_head;
 248     ThreadSafepointState *cur_tss = tss_head;
 249     while (cur_tss != NULL) {
 250       assert(cur_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 251       if (thread_not_running(cur_tss)) {
 252         --still_running;
 253         *p_prev = NULL;
 254         ThreadSafepointState *tmp = cur_tss;
 255         cur_tss = cur_tss-&gt;get_next();
 256         tmp-&gt;set_next(NULL);
 257       } else {
 258         *p_prev = cur_tss;
 259         p_prev = cur_tss-&gt;next_ptr();
 260         cur_tss = cur_tss-&gt;get_next();
 261       }
 262     }
 263 
 264     DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 265 
 266     if (still_running &gt; 0) {
<span class="line-modified"> 267       back_off(iterations);</span>
 268     }
 269 
 270     iterations++;
<span class="line-modified"> 271   }</span>
 272 
 273   assert(tss_head == NULL, &quot;Must be empty&quot;);
 274 
 275   return iterations;
 276 }
 277 
 278 void SafepointSynchronize::arm_safepoint() {
 279   // Begin the process of bringing the system to a safepoint.
 280   // Java threads can be in several different states and are
 281   // stopped by different mechanisms:
 282   //
 283   //  1. Running interpreted
 284   //     When executing branching/returning byte codes interpreter
 285   //     checks if the poll is armed, if so blocks in SS::block().
 286   //     When using global polling the interpreter dispatch table
 287   //     is changed to force it to check for a safepoint condition
 288   //     between bytecodes.
 289   //  2. Running in native code
 290   //     When returning from the native code, a Java thread must check
 291   //     the safepoint _state to see if we must block.  If the
</pre>
<hr />
<pre>
 297   //     the VM thread issues a memory barrier instruction.
 298   //  3. Running compiled Code
 299   //     Compiled code reads the local polling page that
 300   //     is set to fault if we are trying to get to a safepoint.
 301   //  4. Blocked
 302   //     A thread which is blocked will not be allowed to return from the
 303   //     block condition until the safepoint operation is complete.
 304   //  5. In VM or Transitioning between states
 305   //     If a Java thread is currently running in the VM or transitioning
 306   //     between states, the safepointing code will poll the thread state
 307   //     until the thread blocks itself when it attempts transitions to a
 308   //     new state or locking a safepoint checked monitor.
 309 
 310   // We must never miss a thread with correct safepoint id, so we must make sure we arm
 311   // the wait barrier for the next safepoint id/counter.
 312   // Arming must be done after resetting _current_jni_active_count, _waiting_to_block.
 313   _wait_barrier-&gt;arm(static_cast&lt;int&gt;(_safepoint_counter + 1));
 314 
 315   assert((_safepoint_counter &amp; 0x1) == 0, &quot;must be even&quot;);
 316   // The store to _safepoint_counter must happen after any stores in arming.
<span class="line-modified"> 317   OrderAccess::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);</span>
 318 
 319   // We are synchronizing
 320   OrderAccess::storestore(); // Ordered with _safepoint_counter
 321   _state = _synchronizing;
 322 
 323   if (SafepointMechanism::uses_thread_local_poll()) {
 324     // Arming the per thread poll while having _state != _not_synchronized means safepointing
 325     log_trace(safepoint)(&quot;Setting thread local yield flag for threads&quot;);
 326     OrderAccess::storestore(); // storestore, global state -&gt; local state
 327     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {
 328       // Make sure the threads start polling, it is time to yield.
 329       SafepointMechanism::arm_local_poll(cur);
 330     }
 331   }
 332   OrderAccess::fence(); // storestore|storeload, global state -&gt; local state
 333 
 334   if (SafepointMechanism::uses_global_page_poll()) {
 335     // Make interpreter safepoint aware
 336     Interpreter::notice_safepoints();
 337 
</pre>
<hr />
<pre>
 388   assert(_waiting_to_block == 0, &quot;No thread should be running&quot;);
 389 
 390 #ifndef PRODUCT
 391   if (safepoint_limit_time != 0) {
 392     jlong current_time = os::javaTimeNanos();
 393     if (safepoint_limit_time &lt; current_time) {
 394       log_warning(safepoint)(&quot;# SafepointSynchronize: Finished after &quot;
 395                     INT64_FORMAT_W(6) &quot; ms&quot;,
 396                     (int64_t)(current_time - SafepointTracing::start_of_safepoint()) / (NANOUNITS / MILLIUNITS));
 397     }
 398   }
 399 #endif
 400 
 401   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 402 
 403   // Record state
 404   _state = _synchronized;
 405 
 406   OrderAccess::fence();
 407 



 408 #ifdef ASSERT
 409   // Make sure all the threads were visited.
 410   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {
 411     assert(cur-&gt;was_visited_for_critical_count(_safepoint_counter), &quot;missed a thread&quot;);
 412   }
 413 #endif // ASSERT
 414 
 415   // Update the count of active JNI critical regions
 416   GCLocker::set_jni_lock_count(_current_jni_active_count);
 417 
 418   post_safepoint_synchronize_event(sync_event,
<span class="line-modified"> 419                                    _safepoint_counter,</span>
 420                                    initial_running,
 421                                    _waiting_to_block, iterations);
 422 
 423   SafepointTracing::synchronized(nof_threads, initial_running, _nof_threads_hit_polling_page);
 424 
 425   // We do the safepoint cleanup first since a GC related safepoint
 426   // needs cleanup to be completed before running the GC op.
 427   EventSafepointCleanup cleanup_event;
 428   do_cleanup_tasks();
<span class="line-modified"> 429   post_safepoint_cleanup_event(cleanup_event, _safepoint_counter);</span>
 430 
<span class="line-modified"> 431   post_safepoint_begin_event(begin_event, _safepoint_counter, nof_threads, _current_jni_active_count);</span>
 432   SafepointTracing::cleanup();
 433 }
 434 
 435 void SafepointSynchronize::disarm_safepoint() {
<span class="line-modified"> 436   uint64_t safepoint_id = _safepoint_counter;</span>
 437   {
 438     JavaThreadIteratorWithHandle jtiwh;
 439 #ifdef ASSERT
 440     // A pending_exception cannot be installed during a safepoint.  The threads
 441     // may install an async exception after they come back from a safepoint into
 442     // pending_exception after they unblock.  But that should happen later.
 443     for (; JavaThread *cur = jtiwh.next(); ) {
 444       assert (!(cur-&gt;has_pending_exception() &amp;&amp;
 445                 cur-&gt;safepoint_state()-&gt;is_at_poll_safepoint()),
 446               &quot;safepoint installed a pending exception&quot;);
 447     }
 448 #endif // ASSERT
 449 
 450     if (SafepointMechanism::uses_global_page_poll()) {
 451       guarantee (PageArmed, &quot;invariant&quot;);
 452       // Make polling safepoint aware
 453       os::make_polling_page_readable();
 454       PageArmed = false;
 455       // Remove safepoint check from interpreter
 456       Interpreter::ignore_safepoints();
 457     }
 458 
 459     OrderAccess::fence(); // keep read and write of _state from floating up
 460     assert(_state == _synchronized, &quot;must be synchronized before ending safepoint synchronization&quot;);
 461 
 462     // Change state first to _not_synchronized.
 463     // No threads should see _synchronized when running.
 464     _state = _not_synchronized;
 465 
 466     // Set the next dormant (even) safepoint id.
 467     assert((_safepoint_counter &amp; 0x1) == 1, &quot;must be odd&quot;);
<span class="line-modified"> 468     OrderAccess::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);</span>
 469 
 470     OrderAccess::fence(); // Keep the local state from floating up.
 471 
 472     jtiwh.rewind();
 473     for (; JavaThread *current = jtiwh.next(); ) {
 474       // Clear the visited flag to ensure that the critical counts are collected properly.
<span class="line-modified"> 475       DEBUG_ONLY(current-&gt;reset_visited_for_critical_count(safepoint_id);)</span>
 476       ThreadSafepointState* cur_state = current-&gt;safepoint_state();
 477       assert(!cur_state-&gt;is_running(), &quot;Thread not suspended at safepoint&quot;);
 478       cur_state-&gt;restart(); // TSS _running
 479       assert(cur_state-&gt;is_running(), &quot;safepoint state has not been reset&quot;);
<span class="line-modified"> 480       SafepointMechanism::disarm_local_poll(current);</span>

 481     }
 482   } // ~JavaThreadIteratorWithHandle
 483 
 484   // Release threads lock, so threads can be created/destroyed again.
 485   Threads_lock-&gt;unlock();
 486 
 487   // Wake threads after local state is correctly set.
 488   _wait_barrier-&gt;disarm();
 489 }
 490 
 491 // Wake up all threads, so they are ready to resume execution after the safepoint
 492 // operation has been carried out
 493 void SafepointSynchronize::end() {
 494   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 495   EventSafepointEnd event;
<span class="line-removed"> 496   uint64_t safepoint_id = _safepoint_counter;</span>
 497   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 498 
 499   disarm_safepoint();
 500 
 501   Universe::heap()-&gt;safepoint_synchronize_end();
 502 
 503   SafepointTracing::end();
 504 
<span class="line-modified"> 505   post_safepoint_end_event(event, safepoint_id);</span>
 506 }
 507 
 508 bool SafepointSynchronize::is_cleanup_needed() {
 509   // Need a safepoint if there are many monitors to deflate.
 510   if (ObjectSynchronizer::is_cleanup_needed()) return true;
 511   // Need a safepoint if some inline cache buffers is non-empty
 512   if (!InlineCacheBuffer::is_empty()) return true;


 513   return false;
 514 }
 515 




 516 class ParallelSPCleanupThreadClosure : public ThreadClosure {
 517 private:
 518   CodeBlobClosure* _nmethod_cl;
 519   DeflateMonitorCounters* _counters;
 520 
 521 public:
 522   ParallelSPCleanupThreadClosure(DeflateMonitorCounters* counters) :
 523     _nmethod_cl(UseCodeAging ? NMethodSweeper::prepare_reset_hotness_counters() : NULL),
 524     _counters(counters) {}
 525 
 526   void do_thread(Thread* thread) {
 527     ObjectSynchronizer::deflate_thread_local_monitors(thread, _counters);
 528     if (_nmethod_cl != NULL &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 529         ! thread-&gt;is_Code_cache_sweeper_thread()) {
 530       JavaThread* jt = (JavaThread*) thread;
 531       jt-&gt;nmethods_do(_nmethod_cl);
 532     }
 533   }
 534 };
 535 
 536 class ParallelSPCleanupTask : public AbstractGangTask {
 537 private:
 538   SubTasksDone _subtasks;
 539   ParallelSPCleanupThreadClosure _cleanup_threads_cl;
 540   uint _num_workers;
 541   DeflateMonitorCounters* _counters;
 542 public:
 543   ParallelSPCleanupTask(uint num_workers, DeflateMonitorCounters* counters) :
 544     AbstractGangTask(&quot;Parallel Safepoint Cleanup&quot;),
 545     _subtasks(SubTasksDone(SafepointSynchronize::SAFEPOINT_CLEANUP_NUM_TASKS)),
 546     _cleanup_threads_cl(ParallelSPCleanupThreadClosure(counters)),
 547     _num_workers(num_workers),
 548     _counters(counters) {}
 549 
 550   void work(uint worker_id) {
<span class="line-modified"> 551     uint64_t safepoint_id = SafepointSynchronize::safepoint_counter();</span>
 552     // All threads deflate monitors and mark nmethods (if necessary).
 553     Threads::possibly_parallel_threads_do(true, &amp;_cleanup_threads_cl);
 554 
 555     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_DEFLATE_MONITORS)) {
 556       const char* name = &quot;deflating global idle monitors&quot;;
 557       EventSafepointCleanupTask event;
 558       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 559       ObjectSynchronizer::deflate_idle_monitors(_counters);
 560 
 561       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 562     }
 563 
 564     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES)) {
 565       const char* name = &quot;updating inline caches&quot;;
 566       EventSafepointCleanupTask event;
 567       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 568       InlineCacheBuffer::update_inline_caches();
 569 
 570       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 571     }
</pre>
<hr />
<pre>
 584         const char* name = &quot;rehashing symbol table&quot;;
 585         EventSafepointCleanupTask event;
 586         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 587         SymbolTable::rehash_table();
 588 
 589         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 590       }
 591     }
 592 
 593     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_STRING_TABLE_REHASH)) {
 594       if (StringTable::needs_rehashing()) {
 595         const char* name = &quot;rehashing string table&quot;;
 596         EventSafepointCleanupTask event;
 597         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 598         StringTable::rehash_table();
 599 
 600         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 601       }
 602     }
 603 
<span class="line-modified"> 604     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_CLD_PURGE)) {</span>
<span class="line-modified"> 605       // CMS delays purging the CLDG until the beginning of the next safepoint and to</span>
<span class="line-modified"> 606       // make sure concurrent sweep is done</span>
<span class="line-modified"> 607       const char* name = &quot;purging class loader data graph&quot;;</span>
<span class="line-modified"> 608       EventSafepointCleanupTask event;</span>
<span class="line-modified"> 609       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));</span>
<span class="line-removed"> 610       ClassLoaderDataGraph::purge_if_needed();</span>
 611 
<span class="line-modified"> 612       post_safepoint_cleanup_task_event(event, safepoint_id, name);</span>

 613     }
 614 
<span class="line-modified"> 615     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_SYSTEM_DICTIONARY_RESIZE)) {</span>
<span class="line-modified"> 616       const char* name = &quot;resizing system dictionaries&quot;;</span>
<span class="line-modified"> 617       EventSafepointCleanupTask event;</span>
<span class="line-modified"> 618       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));</span>
<span class="line-removed"> 619       ClassLoaderDataGraph::resize_if_needed();</span>
<span class="line-removed"> 620 </span>
<span class="line-removed"> 621       post_safepoint_cleanup_task_event(event, safepoint_id, name);</span>
 622     }
 623 
 624     _subtasks.all_tasks_completed(_num_workers);
 625   }
 626 };
 627 
 628 // Various cleaning tasks that should be done periodically at safepoints.
 629 void SafepointSynchronize::do_cleanup_tasks() {
 630 
 631   TraceTime timer(&quot;safepoint cleanup tasks&quot;, TRACETIME_LOG(Info, safepoint, cleanup));
 632 
 633   // Prepare for monitor deflation.
 634   DeflateMonitorCounters deflate_counters;
 635   ObjectSynchronizer::prepare_deflate_idle_monitors(&amp;deflate_counters);
 636 
 637   CollectedHeap* heap = Universe::heap();
 638   assert(heap != NULL, &quot;heap not initialized yet?&quot;);
 639   WorkGang* cleanup_workers = heap-&gt;get_safepoint_workers();
 640   if (cleanup_workers != NULL) {
 641     // Parallel cleanup using GC provided thread pool.
</pre>
<hr />
<pre>
 699 }
 700 
 701 static bool safepoint_safe_with(JavaThread *thread, JavaThreadState state) {
 702   switch(state) {
 703   case _thread_in_native:
 704     // native threads are safe if they have no java stack or have walkable stack
 705     return !thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable();
 706 
 707   case _thread_blocked:
 708     // On wait_barrier or blocked.
 709     // Blocked threads should already have walkable stack.
 710     assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;blocked and not walkable&quot;);
 711     return true;
 712 
 713   default:
 714     return false;
 715   }
 716 }
 717 
 718 bool SafepointSynchronize::handshake_safe(JavaThread *thread) {
<span class="line-modified"> 719   // The polls must be armed otherwise the safe state can change to unsafe at any time.</span>
<span class="line-removed"> 720   assert(SafepointMechanism::should_block(thread), &quot;Must be armed&quot;);</span>
<span class="line-removed"> 721   // This function must be called with the Threads_lock held so an externally</span>
<span class="line-removed"> 722   // suspended thread cannot be resumed thus it is safe.</span>
<span class="line-removed"> 723   assert(Threads_lock-&gt;owned_by_self() &amp;&amp; Thread::current()-&gt;is_VM_thread(),</span>
<span class="line-removed"> 724          &quot;Must hold Threads_lock and be VMThread&quot;);</span>
 725   if (thread-&gt;is_ext_suspended() || thread-&gt;is_terminated()) {
 726     return true;
 727   }
 728   JavaThreadState stable_state;
 729   if (try_stable_load_state(&amp;stable_state, thread, InactiveSafepointCounter)) {
 730     return safepoint_safe_with(thread, stable_state);
 731   }
 732   return false;
 733 }
 734 
 735 // See if the thread is running inside a lazy critical native and
 736 // update the thread critical count if so.  Also set a suspend flag to
 737 // cause the native wrapper to return into the JVM to do the unlock
 738 // once the native finishes.
 739 static void check_for_lazy_critical_native(JavaThread *thread, JavaThreadState state) {
 740   if (state == _thread_in_native &amp;&amp;
 741       thread-&gt;has_last_Java_frame() &amp;&amp;
 742       thread-&gt;frame_anchor()-&gt;walkable()) {
 743     // This thread might be in a critical native nmethod so look at
 744     // the top of the stack and increment the critical count if it
</pre>
<hr />
<pre>
 789   JavaThreadState state = thread-&gt;thread_state();
 790   thread-&gt;frame_anchor()-&gt;make_walkable(thread);
 791 
 792   uint64_t safepoint_id = SafepointSynchronize::safepoint_counter();
 793   // Check that we have a valid thread_state at this point
 794   switch(state) {
 795     case _thread_in_vm_trans:
 796     case _thread_in_Java:        // From compiled code
 797     case _thread_in_native_trans:
 798     case _thread_blocked_trans:
 799     case _thread_new_trans:
 800 
 801       // We have no idea where the VMThread is, it might even be at next safepoint.
 802       // So we can miss this poll, but stop at next.
 803 
 804       // Load dependent store, it must not pass loading of safepoint_id.
 805       thread-&gt;safepoint_state()-&gt;set_safepoint_id(safepoint_id); // Release store
 806 
 807       // This part we can skip if we notice we miss or are in a future safepoint.
 808       OrderAccess::storestore();
<span class="line-modified"> 809       thread-&gt;set_thread_state(_thread_blocked);</span>

 810 
<span class="line-removed"> 811       OrderAccess::fence(); // Load in wait barrier should not float up</span>
 812       _wait_barrier-&gt;wait(static_cast&lt;int&gt;(safepoint_id));
 813       assert(_state != _synchronized, &quot;Can&#39;t be&quot;);
 814 
 815       // If barrier is disarmed stop store from floating above loads in barrier.
 816       OrderAccess::loadstore();
 817       thread-&gt;set_thread_state(state);
 818 
 819       // Then we reset the safepoint id to inactive.
 820       thread-&gt;safepoint_state()-&gt;reset_safepoint_id(); // Release store
 821 
 822       OrderAccess::fence();
 823 
 824       break;
 825 
 826     default:
 827      fatal(&quot;Illegal threadstate encountered: %d&quot;, state);
 828   }
 829   guarantee(thread-&gt;safepoint_state()-&gt;get_safepoint_id() == InactiveSafepointCounter,
 830             &quot;The safepoint id should be set only in block path&quot;);
 831 
</pre>
<hr />
<pre>
 834   // is called last since it grabs a lock and we only want to do that when
 835   // we must.
 836   //
 837   // Note: we never deliver an async exception at a polling point as the
 838   // compiler may not have an exception handler for it. The polling
 839   // code will notice the async and deoptimize and the exception will
 840   // be delivered. (Polling at a return point is ok though). Sure is
 841   // a lot of bother for a deprecated feature...
 842   //
 843   // We don&#39;t deliver an async exception if the thread state is
 844   // _thread_in_native_trans so JNI functions won&#39;t be called with
 845   // a surprising pending exception. If the thread state is going back to java,
 846   // async exception is checked in check_special_condition_for_native_trans().
 847 
 848   if (state != _thread_blocked_trans &amp;&amp;
 849       state != _thread_in_vm_trans &amp;&amp;
 850       thread-&gt;has_special_runtime_exit_condition()) {
 851     thread-&gt;handle_special_runtime_exit_condition(
 852       !thread-&gt;is_at_poll_safepoint() &amp;&amp; (state != _thread_in_native_trans));
 853   }



 854 }
 855 
 856 // ------------------------------------------------------------------------------------------------------
 857 // Exception handlers
 858 
 859 
 860 void SafepointSynchronize::handle_polling_page_exception(JavaThread *thread) {
 861   assert(thread-&gt;is_Java_thread(), &quot;polling reference encountered by VM thread&quot;);
 862   assert(thread-&gt;thread_state() == _thread_in_Java, &quot;should come from Java code&quot;);
<span class="line-modified"> 863   if (!ThreadLocalHandshakes) {</span>
 864     assert(SafepointSynchronize::is_synchronizing(), &quot;polling encountered outside safepoint synchronization&quot;);
 865   }
 866 
 867   if (log_is_enabled(Info, safepoint, stats)) {
 868     Atomic::inc(&amp;_nof_threads_hit_polling_page);
 869   }
 870 
 871   ThreadSafepointState* state = thread-&gt;safepoint_state();
 872 
 873   state-&gt;handle_polling_page_exception();
 874 }
 875 
 876 
 877 void SafepointSynchronize::print_safepoint_timeout() {
 878   if (!timeout_error_printed) {
 879     timeout_error_printed = true;
 880     // Print out the thread info which didn&#39;t reach the safepoint for debugging
 881     // purposes (useful when there are lots of threads in the debugger).
 882     LogTarget(Warning, safepoint) lt;
 883     if (lt.is_enabled()) {
</pre>
<hr />
<pre>
 892         if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 893           ls.print(&quot;# &quot;);
 894           cur_thread-&gt;print_on(&amp;ls);
 895           ls.cr();
 896         }
 897       }
 898       ls.print_cr(&quot;# SafepointSynchronize::begin: (End of list)&quot;);
 899     }
 900   }
 901 
 902   // To debug the long safepoint, specify both AbortVMOnSafepointTimeout &amp;
 903   // ShowMessageBoxOnError.
 904   if (AbortVMOnSafepointTimeout) {
 905     // Send the blocking thread a signal to terminate and write an error file.
 906     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur_thread = jtiwh.next(); ) {
 907       if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 908         if (!os::signal_thread(cur_thread, SIGILL, &quot;blocking a safepoint&quot;)) {
 909           break; // Could not send signal. Report fatal error.
 910         }
 911         // Give cur_thread a chance to report the error and terminate the VM.
<span class="line-modified"> 912         os::sleep(Thread::current(), 3000, false);</span>
 913       }
 914     }
 915     fatal(&quot;Safepoint sync time longer than &quot; INTX_FORMAT &quot;ms detected when executing %s.&quot;,
 916           SafepointTimeoutDelay, VMThread::vm_operation()-&gt;name());
 917   }
 918 }
 919 
 920 // -------------------------------------------------------------------------------------------------------
 921 // Implementation of ThreadSafepointState
 922 
 923 ThreadSafepointState::ThreadSafepointState(JavaThread *thread)
 924   : _at_poll_safepoint(false), _thread(thread), _safepoint_safe(false),
<span class="line-modified"> 925     _safepoint_id(SafepointSynchronize::InactiveSafepointCounter),</span>
<span class="line-removed"> 926     _orig_thread_state(_thread_uninitialized), _next(NULL) {</span>
 927 }
 928 
 929 void ThreadSafepointState::create(JavaThread *thread) {
 930   ThreadSafepointState *state = new ThreadSafepointState(thread);
 931   thread-&gt;set_safepoint_state(state);
 932 }
 933 
 934 void ThreadSafepointState::destroy(JavaThread *thread) {
 935   if (thread-&gt;safepoint_state()) {
 936     delete(thread-&gt;safepoint_state());
 937     thread-&gt;set_safepoint_state(NULL);
 938   }
 939 }
 940 
 941 uint64_t ThreadSafepointState::get_safepoint_id() const {
<span class="line-modified"> 942   return OrderAccess::load_acquire(&amp;_safepoint_id);</span>
 943 }
 944 
 945 void ThreadSafepointState::reset_safepoint_id() {
<span class="line-modified"> 946   OrderAccess::release_store(&amp;_safepoint_id, SafepointSynchronize::InactiveSafepointCounter);</span>
 947 }
 948 
 949 void ThreadSafepointState::set_safepoint_id(uint64_t safepoint_id) {
<span class="line-modified"> 950   OrderAccess::release_store(&amp;_safepoint_id, safepoint_id);</span>
 951 }
 952 
 953 void ThreadSafepointState::examine_state_of_thread(uint64_t safepoint_count) {
 954   assert(is_running(), &quot;better be running or just have hit safepoint poll&quot;);
 955 
 956   JavaThreadState stable_state;
 957   if (!SafepointSynchronize::try_stable_load_state(&amp;stable_state, _thread, safepoint_count)) {
 958     // We could not get stable state of the JavaThread.
 959     // Consider it running and just return.
 960     return;
 961   }
 962 
<span class="line-removed"> 963   // Save the state at the start of safepoint processing.</span>
<span class="line-removed"> 964   _orig_thread_state = stable_state;</span>
<span class="line-removed"> 965 </span>
 966   // Check for a thread that is suspended. Note that thread resume tries
 967   // to grab the Threads_lock which we own here, so a thread cannot be
 968   // resumed during safepoint synchronization.
 969 
 970   // We check to see if this thread is suspended without locking to
 971   // avoid deadlocking with a third thread that is waiting for this
 972   // thread to be suspended. The third thread can notice the safepoint
 973   // that we&#39;re trying to start at the beginning of its SR_lock-&gt;wait()
 974   // call. If that happens, then the third thread will block on the
 975   // safepoint while still holding the underlying SR_lock. We won&#39;t be
 976   // able to get the SR_lock and we&#39;ll deadlock.
 977   //
 978   // We don&#39;t need to grab the SR_lock here for two reasons:
 979   // 1) The suspend flags are both volatile and are set with an
 980   //    Atomic::cmpxchg() call so we should see the suspended
 981   //    state right away.
 982   // 2) We&#39;re being called from the safepoint polling loop; if
 983   //    we don&#39;t see the suspended state on this iteration, then
 984   //    we&#39;ll come around again.
 985   //
</pre>
<hr />
<pre>
1114         // live and will be needed during deoptimization. Defer the
1115         // Async exception should have deferred the exception until the
1116         // next safepoint which will be detected when we get into
1117         // the interpreter so if we have an exception now things
1118         // are messed up.
1119 
1120         fatal(&quot;Exception installed and deoptimization is pending&quot;);
1121       }
1122     }
1123   }
1124 }
1125 
1126 
1127 // -------------------------------------------------------------------------------------------------------
1128 // Implementation of SafepointTracing
1129 
1130 jlong SafepointTracing::_last_safepoint_begin_time_ns = 0;
1131 jlong SafepointTracing::_last_safepoint_sync_time_ns = 0;
1132 jlong SafepointTracing::_last_safepoint_cleanup_time_ns = 0;
1133 jlong SafepointTracing::_last_safepoint_end_time_ns = 0;
<span class="line-removed">1134 jlong SafepointTracing::_last_safepoint_end_time_epoch_ms = 0;</span>
1135 jlong SafepointTracing::_last_app_time_ns = 0;
1136 int SafepointTracing::_nof_threads = 0;
1137 int SafepointTracing::_nof_running = 0;
1138 int SafepointTracing::_page_trap = 0;
1139 VM_Operation::VMOp_Type SafepointTracing::_current_type;
1140 jlong     SafepointTracing::_max_sync_time = 0;
1141 jlong     SafepointTracing::_max_vmop_time = 0;
1142 uint64_t  SafepointTracing::_op_count[VM_Operation::VMOp_Terminating] = {0};
1143 
1144 void SafepointTracing::init() {
1145   // Application start
1146   _last_safepoint_end_time_ns = os::javaTimeNanos();
<span class="line-removed">1147   // amount of time since epoch</span>
<span class="line-removed">1148   _last_safepoint_end_time_epoch_ms = os::javaTimeMillis();</span>
1149 }
1150 
1151 // Helper method to print the header.
1152 static void print_header(outputStream* st) {
1153   // The number of spaces is significant here, and should match the format
1154   // specifiers in print_statistics().
1155 
1156   st-&gt;print(&quot;VM Operation                 &quot;
1157             &quot;[ threads: total initial_running ]&quot;
1158             &quot;[ time:       sync    cleanup       vmop      total ]&quot;);
1159 
1160   st-&gt;print_cr(&quot; page_trap_count&quot;);
1161 }
1162 
1163 // This prints a nice table.  To get the statistics to not shift due to the logging uptime
1164 // decorator, use the option as: -Xlog:safepoint+stats:[outputfile]:none
1165 void SafepointTracing::statistics_log() {
1166   LogTarget(Info, safepoint, stats) lt;
1167   assert (lt.is_enabled(), &quot;should only be called when printing statistics is enabled&quot;);
1168   LogStream ls(lt);
</pre>
<hr />
<pre>
1228   _last_app_time_ns = _last_safepoint_begin_time_ns - _last_safepoint_end_time_ns;
1229   _last_safepoint_end_time_ns = 0;
1230 
1231   RuntimeService::record_safepoint_begin(_last_app_time_ns);
1232 }
1233 
1234 void SafepointTracing::synchronized(int nof_threads, int nof_running, int traps) {
1235   _last_safepoint_sync_time_ns = os::javaTimeNanos();
1236   _nof_threads = nof_threads;
1237   _nof_running = nof_running;
1238   _page_trap   = traps;
1239   RuntimeService::record_safepoint_synchronized(_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns);
1240 }
1241 
1242 void SafepointTracing::cleanup() {
1243   _last_safepoint_cleanup_time_ns = os::javaTimeNanos();
1244 }
1245 
1246 void SafepointTracing::end() {
1247   _last_safepoint_end_time_ns = os::javaTimeNanos();
<span class="line-removed">1248   // amount of time since epoch</span>
<span class="line-removed">1249   _last_safepoint_end_time_epoch_ms = os::javaTimeMillis();</span>
1250 
1251   if (_max_sync_time &lt; (_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns)) {
1252     _max_sync_time = _last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns;
1253   }
1254   if (_max_vmop_time &lt; (_last_safepoint_end_time_ns - _last_safepoint_sync_time_ns)) {
1255     _max_vmop_time = _last_safepoint_end_time_ns - _last_safepoint_sync_time_ns;
1256   }
1257   if (log_is_enabled(Info, safepoint, stats)) {
1258     statistics_log();
1259   }
1260 
1261   log_info(safepoint)(
1262      &quot;Safepoint \&quot;%s\&quot;, &quot;
1263      &quot;Time since last: &quot; JLONG_FORMAT &quot; ns, &quot;
1264      &quot;Reaching safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1265      &quot;At safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1266      &quot;Total: &quot; JLONG_FORMAT &quot; ns&quot;,
1267       VM_Operation::name(_current_type),
1268       _last_app_time_ns,
1269       _last_safepoint_cleanup_time_ns - _last_safepoint_begin_time_ns,
</pre>
</td>
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
<span class="line-added">  27 #include &quot;classfile/dictionary.hpp&quot;</span>
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/symbolTable.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/icBuffer.hpp&quot;
  33 #include &quot;code/nmethod.hpp&quot;
  34 #include &quot;code/pcDesc.hpp&quot;
  35 #include &quot;code/scopeDesc.hpp&quot;
<span class="line-added">  36 #include &quot;compiler/compilationPolicy.hpp&quot;</span>
  37 #include &quot;gc/shared/collectedHeap.hpp&quot;
  38 #include &quot;gc/shared/gcLocker.hpp&quot;
<span class="line-added">  39 #include &quot;gc/shared/oopStorage.hpp&quot;</span>
  40 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  41 #include &quot;gc/shared/workgroup.hpp&quot;
  42 #include &quot;interpreter/interpreter.hpp&quot;
  43 #include &quot;jfr/jfrEvents.hpp&quot;
  44 #include &quot;logging/log.hpp&quot;
  45 #include &quot;logging/logStream.hpp&quot;
  46 #include &quot;memory/resourceArea.hpp&quot;
  47 #include &quot;memory/universe.hpp&quot;
  48 #include &quot;oops/oop.inline.hpp&quot;
  49 #include &quot;oops/symbol.hpp&quot;
  50 #include &quot;runtime/atomic.hpp&quot;

  51 #include &quot;runtime/deoptimization.hpp&quot;
  52 #include &quot;runtime/frame.inline.hpp&quot;
  53 #include &quot;runtime/handles.inline.hpp&quot;
  54 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  55 #include &quot;runtime/mutexLocker.hpp&quot;
  56 #include &quot;runtime/orderAccess.hpp&quot;
  57 #include &quot;runtime/osThread.hpp&quot;
  58 #include &quot;runtime/safepoint.hpp&quot;
  59 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  60 #include &quot;runtime/signature.hpp&quot;
  61 #include &quot;runtime/stubCodeGenerator.hpp&quot;
  62 #include &quot;runtime/stubRoutines.hpp&quot;
  63 #include &quot;runtime/sweeper.hpp&quot;
  64 #include &quot;runtime/synchronizer.hpp&quot;
  65 #include &quot;runtime/thread.inline.hpp&quot;
  66 #include &quot;runtime/threadSMR.hpp&quot;
  67 #include &quot;runtime/timerTrace.hpp&quot;
  68 #include &quot;services/runtimeService.hpp&quot;
  69 #include &quot;utilities/events.hpp&quot;
  70 #include &quot;utilities/macros.hpp&quot;



  71 
  72 static void post_safepoint_begin_event(EventSafepointBegin&amp; event,
  73                                        uint64_t safepoint_id,
  74                                        int thread_count,
  75                                        int critical_thread_count) {
  76   if (event.should_commit()) {
  77     event.set_safepointId(safepoint_id);
  78     event.set_totalThreadCount(thread_count);
  79     event.set_jniCriticalThreadCount(critical_thread_count);
  80     event.commit();
  81   }
  82 }
  83 
  84 static void post_safepoint_cleanup_event(EventSafepointCleanup&amp; event, uint64_t safepoint_id) {
  85   if (event.should_commit()) {
  86     event.set_safepointId(safepoint_id);
  87     event.commit();
  88   }
  89 }
  90 
</pre>
<hr />
<pre>
 102   }
 103 }
 104 
 105 static void post_safepoint_cleanup_task_event(EventSafepointCleanupTask&amp; event,
 106                                               uint64_t safepoint_id,
 107                                               const char* name) {
 108   if (event.should_commit()) {
 109     event.set_safepointId(safepoint_id);
 110     event.set_name(name);
 111     event.commit();
 112   }
 113 }
 114 
 115 static void post_safepoint_end_event(EventSafepointEnd&amp; event, uint64_t safepoint_id) {
 116   if (event.should_commit()) {
 117     event.set_safepointId(safepoint_id);
 118     event.commit();
 119   }
 120 }
 121 
<span class="line-added"> 122 // SafepointCheck</span>
<span class="line-added"> 123 SafepointStateTracker::SafepointStateTracker(uint64_t safepoint_id, bool at_safepoint)</span>
<span class="line-added"> 124   : _safepoint_id(safepoint_id), _at_safepoint(at_safepoint) {}</span>
<span class="line-added"> 125 </span>
<span class="line-added"> 126 bool SafepointStateTracker::safepoint_state_changed() {</span>
<span class="line-added"> 127   return _safepoint_id != SafepointSynchronize::safepoint_id() ||</span>
<span class="line-added"> 128     _at_safepoint != SafepointSynchronize::is_at_safepoint();</span>
<span class="line-added"> 129 }</span>
<span class="line-added"> 130 </span>
 131 // --------------------------------------------------------------------------------------------------
 132 // Implementation of Safepoint begin/end
 133 
 134 SafepointSynchronize::SynchronizeState volatile SafepointSynchronize::_state = SafepointSynchronize::_not_synchronized;
 135 int SafepointSynchronize::_waiting_to_block = 0;
 136 volatile uint64_t SafepointSynchronize::_safepoint_counter = 0;
<span class="line-added"> 137 uint64_t SafepointSynchronize::_safepoint_id = 0;</span>
 138 const uint64_t SafepointSynchronize::InactiveSafepointCounter = 0;
 139 int SafepointSynchronize::_current_jni_active_count = 0;
 140 
 141 WaitBarrier* SafepointSynchronize::_wait_barrier;
 142 
 143 static volatile bool PageArmed = false;        // safepoint polling page is RO|RW vs PROT_NONE
 144 static bool timeout_error_printed = false;
 145 
 146 // Statistic related
 147 static jlong _safepoint_begin_time = 0;
 148 static volatile int _nof_threads_hit_polling_page = 0;
 149 
 150 void SafepointSynchronize::init(Thread* vmthread) {
 151   // WaitBarrier should never be destroyed since we will have
 152   // threads waiting on it while exiting.
 153   _wait_barrier = new WaitBarrier(vmthread);
 154   SafepointTracing::init();
 155 }
 156 
 157 void SafepointSynchronize::increment_jni_active_count() {
 158   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may increment&quot;);
 159   ++_current_jni_active_count;
 160 }
 161 
 162 void SafepointSynchronize::decrement_waiting_to_block() {
 163   assert(_waiting_to_block &gt; 0, &quot;sanity check&quot;);
 164   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may decrement&quot;);
 165   --_waiting_to_block;
 166 }
 167 
<span class="line-modified"> 168 bool SafepointSynchronize::thread_not_running(ThreadSafepointState *cur_state) {</span>
 169   if (!cur_state-&gt;is_running()) {
 170     return true;
 171   }
 172   cur_state-&gt;examine_state_of_thread(SafepointSynchronize::safepoint_counter());
 173   if (!cur_state-&gt;is_running()) {
 174     return true;
 175   }
 176   LogTarget(Trace, safepoint) lt;
 177   if (lt.is_enabled()) {
 178     ResourceMark rm;
 179     LogStream ls(lt);
 180     cur_state-&gt;print_on(&amp;ls);
 181   }
 182   return false;
 183 }
 184 
 185 #ifdef ASSERT
 186 static void assert_list_is_valid(const ThreadSafepointState* tss_head, int still_running) {
 187   int a = 0;
 188   const ThreadSafepointState *tmp_tss = tss_head;
 189   while (tmp_tss != NULL) {
 190     ++a;
 191     assert(tmp_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 192     tmp_tss = tmp_tss-&gt;get_next();
 193   }
 194   assert(a == still_running, &quot;Must be the same&quot;);
 195 }
 196 #endif // ASSERT
 197 
<span class="line-modified"> 198 static void back_off(int64_t start_time) {</span>
<span class="line-modified"> 199   // We start with fine-grained nanosleeping until a millisecond has</span>
<span class="line-modified"> 200   // passed, at which point we resort to plain naked_short_sleep.</span>
<span class="line-modified"> 201   if (os::javaTimeNanos() - start_time &lt; NANOSECS_PER_MILLISEC) {</span>
<span class="line-modified"> 202     os::naked_short_nanosleep(10 * (NANOUNITS / MICROUNITS));</span>
<span class="line-modified"> 203   } else {</span>
<span class="line-modified"> 204     os::naked_short_sleep(1);</span>

 205   }

 206 }
 207 
 208 int SafepointSynchronize::synchronize_threads(jlong safepoint_limit_time, int nof_threads, int* initial_running)
 209 {
 210   JavaThreadIteratorWithHandle jtiwh;
 211 
 212 #ifdef ASSERT
 213   for (; JavaThread *cur = jtiwh.next(); ) {
 214     assert(cur-&gt;safepoint_state()-&gt;is_running(), &quot;Illegal initial state&quot;);
 215   }
 216   jtiwh.rewind();
 217 #endif // ASSERT
 218 
 219   // Iterate through all threads until it has been determined how to stop them all at a safepoint.
 220   int still_running = nof_threads;
 221   ThreadSafepointState *tss_head = NULL;
 222   ThreadSafepointState **p_prev = &amp;tss_head;
 223   for (; JavaThread *cur = jtiwh.next(); ) {
 224     ThreadSafepointState *cur_tss = cur-&gt;safepoint_state();
 225     assert(cur_tss-&gt;get_next() == NULL, &quot;Must be NULL&quot;);
 226     if (thread_not_running(cur_tss)) {
 227       --still_running;
 228     } else {
 229       *p_prev = cur_tss;
 230       p_prev = cur_tss-&gt;next_ptr();
 231     }
 232   }
 233   *p_prev = NULL;
 234 
 235   DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 236 
 237   *initial_running = still_running;
 238 
<span class="line-added"> 239   // If there is no thread still running, we are already done.</span>
<span class="line-added"> 240   if (still_running &lt;= 0) {</span>
<span class="line-added"> 241     assert(tss_head == NULL, &quot;Must be empty&quot;);</span>
<span class="line-added"> 242     return 1;</span>
<span class="line-added"> 243   }</span>
<span class="line-added"> 244 </span>
 245   int iterations = 1; // The first iteration is above.
<span class="line-added"> 246   int64_t start_time = os::javaTimeNanos();</span>
 247 
<span class="line-modified"> 248   do {</span>
 249     // Check if this has taken too long:
 250     if (SafepointTimeout &amp;&amp; safepoint_limit_time &lt; os::javaTimeNanos()) {
 251       print_safepoint_timeout();
 252     }
 253     if (int(iterations) == -1) { // overflow - something is wrong.
 254       // We can only overflow here when we are using global
 255       // polling pages. We keep this guarantee in its original
 256       // form so that searches of the bug database for this
 257       // failure mode find the right bugs.
 258       guarantee (!PageArmed, &quot;invariant&quot;);
 259     }
 260 
 261     p_prev = &amp;tss_head;
 262     ThreadSafepointState *cur_tss = tss_head;
 263     while (cur_tss != NULL) {
 264       assert(cur_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 265       if (thread_not_running(cur_tss)) {
 266         --still_running;
 267         *p_prev = NULL;
 268         ThreadSafepointState *tmp = cur_tss;
 269         cur_tss = cur_tss-&gt;get_next();
 270         tmp-&gt;set_next(NULL);
 271       } else {
 272         *p_prev = cur_tss;
 273         p_prev = cur_tss-&gt;next_ptr();
 274         cur_tss = cur_tss-&gt;get_next();
 275       }
 276     }
 277 
 278     DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 279 
 280     if (still_running &gt; 0) {
<span class="line-modified"> 281       back_off(start_time);</span>
 282     }
 283 
 284     iterations++;
<span class="line-modified"> 285   } while (still_running &gt; 0);</span>
 286 
 287   assert(tss_head == NULL, &quot;Must be empty&quot;);
 288 
 289   return iterations;
 290 }
 291 
 292 void SafepointSynchronize::arm_safepoint() {
 293   // Begin the process of bringing the system to a safepoint.
 294   // Java threads can be in several different states and are
 295   // stopped by different mechanisms:
 296   //
 297   //  1. Running interpreted
 298   //     When executing branching/returning byte codes interpreter
 299   //     checks if the poll is armed, if so blocks in SS::block().
 300   //     When using global polling the interpreter dispatch table
 301   //     is changed to force it to check for a safepoint condition
 302   //     between bytecodes.
 303   //  2. Running in native code
 304   //     When returning from the native code, a Java thread must check
 305   //     the safepoint _state to see if we must block.  If the
</pre>
<hr />
<pre>
 311   //     the VM thread issues a memory barrier instruction.
 312   //  3. Running compiled Code
 313   //     Compiled code reads the local polling page that
 314   //     is set to fault if we are trying to get to a safepoint.
 315   //  4. Blocked
 316   //     A thread which is blocked will not be allowed to return from the
 317   //     block condition until the safepoint operation is complete.
 318   //  5. In VM or Transitioning between states
 319   //     If a Java thread is currently running in the VM or transitioning
 320   //     between states, the safepointing code will poll the thread state
 321   //     until the thread blocks itself when it attempts transitions to a
 322   //     new state or locking a safepoint checked monitor.
 323 
 324   // We must never miss a thread with correct safepoint id, so we must make sure we arm
 325   // the wait barrier for the next safepoint id/counter.
 326   // Arming must be done after resetting _current_jni_active_count, _waiting_to_block.
 327   _wait_barrier-&gt;arm(static_cast&lt;int&gt;(_safepoint_counter + 1));
 328 
 329   assert((_safepoint_counter &amp; 0x1) == 0, &quot;must be even&quot;);
 330   // The store to _safepoint_counter must happen after any stores in arming.
<span class="line-modified"> 331   Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);</span>
 332 
 333   // We are synchronizing
 334   OrderAccess::storestore(); // Ordered with _safepoint_counter
 335   _state = _synchronizing;
 336 
 337   if (SafepointMechanism::uses_thread_local_poll()) {
 338     // Arming the per thread poll while having _state != _not_synchronized means safepointing
 339     log_trace(safepoint)(&quot;Setting thread local yield flag for threads&quot;);
 340     OrderAccess::storestore(); // storestore, global state -&gt; local state
 341     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {
 342       // Make sure the threads start polling, it is time to yield.
 343       SafepointMechanism::arm_local_poll(cur);
 344     }
 345   }
 346   OrderAccess::fence(); // storestore|storeload, global state -&gt; local state
 347 
 348   if (SafepointMechanism::uses_global_page_poll()) {
 349     // Make interpreter safepoint aware
 350     Interpreter::notice_safepoints();
 351 
</pre>
<hr />
<pre>
 402   assert(_waiting_to_block == 0, &quot;No thread should be running&quot;);
 403 
 404 #ifndef PRODUCT
 405   if (safepoint_limit_time != 0) {
 406     jlong current_time = os::javaTimeNanos();
 407     if (safepoint_limit_time &lt; current_time) {
 408       log_warning(safepoint)(&quot;# SafepointSynchronize: Finished after &quot;
 409                     INT64_FORMAT_W(6) &quot; ms&quot;,
 410                     (int64_t)(current_time - SafepointTracing::start_of_safepoint()) / (NANOUNITS / MILLIUNITS));
 411     }
 412   }
 413 #endif
 414 
 415   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 416 
 417   // Record state
 418   _state = _synchronized;
 419 
 420   OrderAccess::fence();
 421 
<span class="line-added"> 422   // Set the new id</span>
<span class="line-added"> 423   ++_safepoint_id;</span>
<span class="line-added"> 424 </span>
 425 #ifdef ASSERT
 426   // Make sure all the threads were visited.
 427   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {
 428     assert(cur-&gt;was_visited_for_critical_count(_safepoint_counter), &quot;missed a thread&quot;);
 429   }
 430 #endif // ASSERT
 431 
 432   // Update the count of active JNI critical regions
 433   GCLocker::set_jni_lock_count(_current_jni_active_count);
 434 
 435   post_safepoint_synchronize_event(sync_event,
<span class="line-modified"> 436                                    _safepoint_id,</span>
 437                                    initial_running,
 438                                    _waiting_to_block, iterations);
 439 
 440   SafepointTracing::synchronized(nof_threads, initial_running, _nof_threads_hit_polling_page);
 441 
 442   // We do the safepoint cleanup first since a GC related safepoint
 443   // needs cleanup to be completed before running the GC op.
 444   EventSafepointCleanup cleanup_event;
 445   do_cleanup_tasks();
<span class="line-modified"> 446   post_safepoint_cleanup_event(cleanup_event, _safepoint_id);</span>
 447 
<span class="line-modified"> 448   post_safepoint_begin_event(begin_event, _safepoint_id, nof_threads, _current_jni_active_count);</span>
 449   SafepointTracing::cleanup();
 450 }
 451 
 452 void SafepointSynchronize::disarm_safepoint() {
<span class="line-modified"> 453   uint64_t active_safepoint_counter = _safepoint_counter;</span>
 454   {
 455     JavaThreadIteratorWithHandle jtiwh;
 456 #ifdef ASSERT
 457     // A pending_exception cannot be installed during a safepoint.  The threads
 458     // may install an async exception after they come back from a safepoint into
 459     // pending_exception after they unblock.  But that should happen later.
 460     for (; JavaThread *cur = jtiwh.next(); ) {
 461       assert (!(cur-&gt;has_pending_exception() &amp;&amp;
 462                 cur-&gt;safepoint_state()-&gt;is_at_poll_safepoint()),
 463               &quot;safepoint installed a pending exception&quot;);
 464     }
 465 #endif // ASSERT
 466 
 467     if (SafepointMechanism::uses_global_page_poll()) {
 468       guarantee (PageArmed, &quot;invariant&quot;);
 469       // Make polling safepoint aware
 470       os::make_polling_page_readable();
 471       PageArmed = false;
 472       // Remove safepoint check from interpreter
 473       Interpreter::ignore_safepoints();
 474     }
 475 
 476     OrderAccess::fence(); // keep read and write of _state from floating up
 477     assert(_state == _synchronized, &quot;must be synchronized before ending safepoint synchronization&quot;);
 478 
 479     // Change state first to _not_synchronized.
 480     // No threads should see _synchronized when running.
 481     _state = _not_synchronized;
 482 
 483     // Set the next dormant (even) safepoint id.
 484     assert((_safepoint_counter &amp; 0x1) == 1, &quot;must be odd&quot;);
<span class="line-modified"> 485     Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);</span>
 486 
 487     OrderAccess::fence(); // Keep the local state from floating up.
 488 
 489     jtiwh.rewind();
 490     for (; JavaThread *current = jtiwh.next(); ) {
 491       // Clear the visited flag to ensure that the critical counts are collected properly.
<span class="line-modified"> 492       DEBUG_ONLY(current-&gt;reset_visited_for_critical_count(active_safepoint_counter);)</span>
 493       ThreadSafepointState* cur_state = current-&gt;safepoint_state();
 494       assert(!cur_state-&gt;is_running(), &quot;Thread not suspended at safepoint&quot;);
 495       cur_state-&gt;restart(); // TSS _running
 496       assert(cur_state-&gt;is_running(), &quot;safepoint state has not been reset&quot;);
<span class="line-modified"> 497 </span>
<span class="line-added"> 498       SafepointMechanism::disarm_if_needed(current, false /* NO release */);</span>
 499     }
 500   } // ~JavaThreadIteratorWithHandle
 501 
 502   // Release threads lock, so threads can be created/destroyed again.
 503   Threads_lock-&gt;unlock();
 504 
 505   // Wake threads after local state is correctly set.
 506   _wait_barrier-&gt;disarm();
 507 }
 508 
 509 // Wake up all threads, so they are ready to resume execution after the safepoint
 510 // operation has been carried out
 511 void SafepointSynchronize::end() {
 512   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 513   EventSafepointEnd event;

 514   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 515 
 516   disarm_safepoint();
 517 
 518   Universe::heap()-&gt;safepoint_synchronize_end();
 519 
 520   SafepointTracing::end();
 521 
<span class="line-modified"> 522   post_safepoint_end_event(event, safepoint_id());</span>
 523 }
 524 
 525 bool SafepointSynchronize::is_cleanup_needed() {
 526   // Need a safepoint if there are many monitors to deflate.
 527   if (ObjectSynchronizer::is_cleanup_needed()) return true;
 528   // Need a safepoint if some inline cache buffers is non-empty
 529   if (!InlineCacheBuffer::is_empty()) return true;
<span class="line-added"> 530   if (StringTable::needs_rehashing()) return true;</span>
<span class="line-added"> 531   if (SymbolTable::needs_rehashing()) return true;</span>
 532   return false;
 533 }
 534 
<span class="line-added"> 535 bool SafepointSynchronize::is_forced_cleanup_needed() {</span>
<span class="line-added"> 536   return ObjectSynchronizer::needs_monitor_scavenge();</span>
<span class="line-added"> 537 }</span>
<span class="line-added"> 538 </span>
 539 class ParallelSPCleanupThreadClosure : public ThreadClosure {
 540 private:
 541   CodeBlobClosure* _nmethod_cl;
 542   DeflateMonitorCounters* _counters;
 543 
 544 public:
 545   ParallelSPCleanupThreadClosure(DeflateMonitorCounters* counters) :
 546     _nmethod_cl(UseCodeAging ? NMethodSweeper::prepare_reset_hotness_counters() : NULL),
 547     _counters(counters) {}
 548 
 549   void do_thread(Thread* thread) {
 550     ObjectSynchronizer::deflate_thread_local_monitors(thread, _counters);
 551     if (_nmethod_cl != NULL &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 552         ! thread-&gt;is_Code_cache_sweeper_thread()) {
 553       JavaThread* jt = (JavaThread*) thread;
 554       jt-&gt;nmethods_do(_nmethod_cl);
 555     }
 556   }
 557 };
 558 
 559 class ParallelSPCleanupTask : public AbstractGangTask {
 560 private:
 561   SubTasksDone _subtasks;
 562   ParallelSPCleanupThreadClosure _cleanup_threads_cl;
 563   uint _num_workers;
 564   DeflateMonitorCounters* _counters;
 565 public:
 566   ParallelSPCleanupTask(uint num_workers, DeflateMonitorCounters* counters) :
 567     AbstractGangTask(&quot;Parallel Safepoint Cleanup&quot;),
 568     _subtasks(SubTasksDone(SafepointSynchronize::SAFEPOINT_CLEANUP_NUM_TASKS)),
 569     _cleanup_threads_cl(ParallelSPCleanupThreadClosure(counters)),
 570     _num_workers(num_workers),
 571     _counters(counters) {}
 572 
 573   void work(uint worker_id) {
<span class="line-modified"> 574     uint64_t safepoint_id = SafepointSynchronize::safepoint_id();</span>
 575     // All threads deflate monitors and mark nmethods (if necessary).
 576     Threads::possibly_parallel_threads_do(true, &amp;_cleanup_threads_cl);
 577 
 578     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_DEFLATE_MONITORS)) {
 579       const char* name = &quot;deflating global idle monitors&quot;;
 580       EventSafepointCleanupTask event;
 581       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 582       ObjectSynchronizer::deflate_idle_monitors(_counters);
 583 
 584       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 585     }
 586 
 587     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES)) {
 588       const char* name = &quot;updating inline caches&quot;;
 589       EventSafepointCleanupTask event;
 590       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 591       InlineCacheBuffer::update_inline_caches();
 592 
 593       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 594     }
</pre>
<hr />
<pre>
 607         const char* name = &quot;rehashing symbol table&quot;;
 608         EventSafepointCleanupTask event;
 609         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 610         SymbolTable::rehash_table();
 611 
 612         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 613       }
 614     }
 615 
 616     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_STRING_TABLE_REHASH)) {
 617       if (StringTable::needs_rehashing()) {
 618         const char* name = &quot;rehashing string table&quot;;
 619         EventSafepointCleanupTask event;
 620         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 621         StringTable::rehash_table();
 622 
 623         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 624       }
 625     }
 626 
<span class="line-modified"> 627     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_SYSTEM_DICTIONARY_RESIZE)) {</span>
<span class="line-modified"> 628       if (Dictionary::does_any_dictionary_needs_resizing()) {</span>
<span class="line-modified"> 629         const char* name = &quot;resizing system dictionaries&quot;;</span>
<span class="line-modified"> 630         EventSafepointCleanupTask event;</span>
<span class="line-modified"> 631         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));</span>
<span class="line-modified"> 632         ClassLoaderDataGraph::resize_dictionaries();</span>

 633 
<span class="line-modified"> 634         post_safepoint_cleanup_task_event(event, safepoint_id, name);</span>
<span class="line-added"> 635       }</span>
 636     }
 637 
<span class="line-modified"> 638     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_REQUEST_OOPSTORAGE_CLEANUP)) {</span>
<span class="line-modified"> 639       // Don&#39;t bother reporting event or time for this very short operation.</span>
<span class="line-modified"> 640       // To have any utility we&#39;d also want to report whether needed.</span>
<span class="line-modified"> 641       OopStorage::trigger_cleanup_if_needed();</span>



 642     }
 643 
 644     _subtasks.all_tasks_completed(_num_workers);
 645   }
 646 };
 647 
 648 // Various cleaning tasks that should be done periodically at safepoints.
 649 void SafepointSynchronize::do_cleanup_tasks() {
 650 
 651   TraceTime timer(&quot;safepoint cleanup tasks&quot;, TRACETIME_LOG(Info, safepoint, cleanup));
 652 
 653   // Prepare for monitor deflation.
 654   DeflateMonitorCounters deflate_counters;
 655   ObjectSynchronizer::prepare_deflate_idle_monitors(&amp;deflate_counters);
 656 
 657   CollectedHeap* heap = Universe::heap();
 658   assert(heap != NULL, &quot;heap not initialized yet?&quot;);
 659   WorkGang* cleanup_workers = heap-&gt;get_safepoint_workers();
 660   if (cleanup_workers != NULL) {
 661     // Parallel cleanup using GC provided thread pool.
</pre>
<hr />
<pre>
 719 }
 720 
 721 static bool safepoint_safe_with(JavaThread *thread, JavaThreadState state) {
 722   switch(state) {
 723   case _thread_in_native:
 724     // native threads are safe if they have no java stack or have walkable stack
 725     return !thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable();
 726 
 727   case _thread_blocked:
 728     // On wait_barrier or blocked.
 729     // Blocked threads should already have walkable stack.
 730     assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;blocked and not walkable&quot;);
 731     return true;
 732 
 733   default:
 734     return false;
 735   }
 736 }
 737 
 738 bool SafepointSynchronize::handshake_safe(JavaThread *thread) {
<span class="line-modified"> 739   assert(Thread::current()-&gt;is_VM_thread(), &quot;Must be VMThread&quot;);</span>





 740   if (thread-&gt;is_ext_suspended() || thread-&gt;is_terminated()) {
 741     return true;
 742   }
 743   JavaThreadState stable_state;
 744   if (try_stable_load_state(&amp;stable_state, thread, InactiveSafepointCounter)) {
 745     return safepoint_safe_with(thread, stable_state);
 746   }
 747   return false;
 748 }
 749 
 750 // See if the thread is running inside a lazy critical native and
 751 // update the thread critical count if so.  Also set a suspend flag to
 752 // cause the native wrapper to return into the JVM to do the unlock
 753 // once the native finishes.
 754 static void check_for_lazy_critical_native(JavaThread *thread, JavaThreadState state) {
 755   if (state == _thread_in_native &amp;&amp;
 756       thread-&gt;has_last_Java_frame() &amp;&amp;
 757       thread-&gt;frame_anchor()-&gt;walkable()) {
 758     // This thread might be in a critical native nmethod so look at
 759     // the top of the stack and increment the critical count if it
</pre>
<hr />
<pre>
 804   JavaThreadState state = thread-&gt;thread_state();
 805   thread-&gt;frame_anchor()-&gt;make_walkable(thread);
 806 
 807   uint64_t safepoint_id = SafepointSynchronize::safepoint_counter();
 808   // Check that we have a valid thread_state at this point
 809   switch(state) {
 810     case _thread_in_vm_trans:
 811     case _thread_in_Java:        // From compiled code
 812     case _thread_in_native_trans:
 813     case _thread_blocked_trans:
 814     case _thread_new_trans:
 815 
 816       // We have no idea where the VMThread is, it might even be at next safepoint.
 817       // So we can miss this poll, but stop at next.
 818 
 819       // Load dependent store, it must not pass loading of safepoint_id.
 820       thread-&gt;safepoint_state()-&gt;set_safepoint_id(safepoint_id); // Release store
 821 
 822       // This part we can skip if we notice we miss or are in a future safepoint.
 823       OrderAccess::storestore();
<span class="line-modified"> 824       // Load in wait barrier should not float up</span>
<span class="line-added"> 825       thread-&gt;set_thread_state_fence(_thread_blocked);</span>
 826 

 827       _wait_barrier-&gt;wait(static_cast&lt;int&gt;(safepoint_id));
 828       assert(_state != _synchronized, &quot;Can&#39;t be&quot;);
 829 
 830       // If barrier is disarmed stop store from floating above loads in barrier.
 831       OrderAccess::loadstore();
 832       thread-&gt;set_thread_state(state);
 833 
 834       // Then we reset the safepoint id to inactive.
 835       thread-&gt;safepoint_state()-&gt;reset_safepoint_id(); // Release store
 836 
 837       OrderAccess::fence();
 838 
 839       break;
 840 
 841     default:
 842      fatal(&quot;Illegal threadstate encountered: %d&quot;, state);
 843   }
 844   guarantee(thread-&gt;safepoint_state()-&gt;get_safepoint_id() == InactiveSafepointCounter,
 845             &quot;The safepoint id should be set only in block path&quot;);
 846 
</pre>
<hr />
<pre>
 849   // is called last since it grabs a lock and we only want to do that when
 850   // we must.
 851   //
 852   // Note: we never deliver an async exception at a polling point as the
 853   // compiler may not have an exception handler for it. The polling
 854   // code will notice the async and deoptimize and the exception will
 855   // be delivered. (Polling at a return point is ok though). Sure is
 856   // a lot of bother for a deprecated feature...
 857   //
 858   // We don&#39;t deliver an async exception if the thread state is
 859   // _thread_in_native_trans so JNI functions won&#39;t be called with
 860   // a surprising pending exception. If the thread state is going back to java,
 861   // async exception is checked in check_special_condition_for_native_trans().
 862 
 863   if (state != _thread_blocked_trans &amp;&amp;
 864       state != _thread_in_vm_trans &amp;&amp;
 865       thread-&gt;has_special_runtime_exit_condition()) {
 866     thread-&gt;handle_special_runtime_exit_condition(
 867       !thread-&gt;is_at_poll_safepoint() &amp;&amp; (state != _thread_in_native_trans));
 868   }
<span class="line-added"> 869 </span>
<span class="line-added"> 870   // cross_modify_fence is done by SafepointMechanism::block_if_requested_slow</span>
<span class="line-added"> 871   // which is the only caller here.</span>
 872 }
 873 
 874 // ------------------------------------------------------------------------------------------------------
 875 // Exception handlers
 876 
 877 
 878 void SafepointSynchronize::handle_polling_page_exception(JavaThread *thread) {
 879   assert(thread-&gt;is_Java_thread(), &quot;polling reference encountered by VM thread&quot;);
 880   assert(thread-&gt;thread_state() == _thread_in_Java, &quot;should come from Java code&quot;);
<span class="line-modified"> 881   if (!SafepointMechanism::uses_thread_local_poll()) {</span>
 882     assert(SafepointSynchronize::is_synchronizing(), &quot;polling encountered outside safepoint synchronization&quot;);
 883   }
 884 
 885   if (log_is_enabled(Info, safepoint, stats)) {
 886     Atomic::inc(&amp;_nof_threads_hit_polling_page);
 887   }
 888 
 889   ThreadSafepointState* state = thread-&gt;safepoint_state();
 890 
 891   state-&gt;handle_polling_page_exception();
 892 }
 893 
 894 
 895 void SafepointSynchronize::print_safepoint_timeout() {
 896   if (!timeout_error_printed) {
 897     timeout_error_printed = true;
 898     // Print out the thread info which didn&#39;t reach the safepoint for debugging
 899     // purposes (useful when there are lots of threads in the debugger).
 900     LogTarget(Warning, safepoint) lt;
 901     if (lt.is_enabled()) {
</pre>
<hr />
<pre>
 910         if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 911           ls.print(&quot;# &quot;);
 912           cur_thread-&gt;print_on(&amp;ls);
 913           ls.cr();
 914         }
 915       }
 916       ls.print_cr(&quot;# SafepointSynchronize::begin: (End of list)&quot;);
 917     }
 918   }
 919 
 920   // To debug the long safepoint, specify both AbortVMOnSafepointTimeout &amp;
 921   // ShowMessageBoxOnError.
 922   if (AbortVMOnSafepointTimeout) {
 923     // Send the blocking thread a signal to terminate and write an error file.
 924     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur_thread = jtiwh.next(); ) {
 925       if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 926         if (!os::signal_thread(cur_thread, SIGILL, &quot;blocking a safepoint&quot;)) {
 927           break; // Could not send signal. Report fatal error.
 928         }
 929         // Give cur_thread a chance to report the error and terminate the VM.
<span class="line-modified"> 930         os::naked_sleep(3000);</span>
 931       }
 932     }
 933     fatal(&quot;Safepoint sync time longer than &quot; INTX_FORMAT &quot;ms detected when executing %s.&quot;,
 934           SafepointTimeoutDelay, VMThread::vm_operation()-&gt;name());
 935   }
 936 }
 937 
 938 // -------------------------------------------------------------------------------------------------------
 939 // Implementation of ThreadSafepointState
 940 
 941 ThreadSafepointState::ThreadSafepointState(JavaThread *thread)
 942   : _at_poll_safepoint(false), _thread(thread), _safepoint_safe(false),
<span class="line-modified"> 943     _safepoint_id(SafepointSynchronize::InactiveSafepointCounter), _next(NULL) {</span>

 944 }
 945 
 946 void ThreadSafepointState::create(JavaThread *thread) {
 947   ThreadSafepointState *state = new ThreadSafepointState(thread);
 948   thread-&gt;set_safepoint_state(state);
 949 }
 950 
 951 void ThreadSafepointState::destroy(JavaThread *thread) {
 952   if (thread-&gt;safepoint_state()) {
 953     delete(thread-&gt;safepoint_state());
 954     thread-&gt;set_safepoint_state(NULL);
 955   }
 956 }
 957 
 958 uint64_t ThreadSafepointState::get_safepoint_id() const {
<span class="line-modified"> 959   return Atomic::load_acquire(&amp;_safepoint_id);</span>
 960 }
 961 
 962 void ThreadSafepointState::reset_safepoint_id() {
<span class="line-modified"> 963   Atomic::release_store(&amp;_safepoint_id, SafepointSynchronize::InactiveSafepointCounter);</span>
 964 }
 965 
 966 void ThreadSafepointState::set_safepoint_id(uint64_t safepoint_id) {
<span class="line-modified"> 967   Atomic::release_store(&amp;_safepoint_id, safepoint_id);</span>
 968 }
 969 
 970 void ThreadSafepointState::examine_state_of_thread(uint64_t safepoint_count) {
 971   assert(is_running(), &quot;better be running or just have hit safepoint poll&quot;);
 972 
 973   JavaThreadState stable_state;
 974   if (!SafepointSynchronize::try_stable_load_state(&amp;stable_state, _thread, safepoint_count)) {
 975     // We could not get stable state of the JavaThread.
 976     // Consider it running and just return.
 977     return;
 978   }
 979 



 980   // Check for a thread that is suspended. Note that thread resume tries
 981   // to grab the Threads_lock which we own here, so a thread cannot be
 982   // resumed during safepoint synchronization.
 983 
 984   // We check to see if this thread is suspended without locking to
 985   // avoid deadlocking with a third thread that is waiting for this
 986   // thread to be suspended. The third thread can notice the safepoint
 987   // that we&#39;re trying to start at the beginning of its SR_lock-&gt;wait()
 988   // call. If that happens, then the third thread will block on the
 989   // safepoint while still holding the underlying SR_lock. We won&#39;t be
 990   // able to get the SR_lock and we&#39;ll deadlock.
 991   //
 992   // We don&#39;t need to grab the SR_lock here for two reasons:
 993   // 1) The suspend flags are both volatile and are set with an
 994   //    Atomic::cmpxchg() call so we should see the suspended
 995   //    state right away.
 996   // 2) We&#39;re being called from the safepoint polling loop; if
 997   //    we don&#39;t see the suspended state on this iteration, then
 998   //    we&#39;ll come around again.
 999   //
</pre>
<hr />
<pre>
1128         // live and will be needed during deoptimization. Defer the
1129         // Async exception should have deferred the exception until the
1130         // next safepoint which will be detected when we get into
1131         // the interpreter so if we have an exception now things
1132         // are messed up.
1133 
1134         fatal(&quot;Exception installed and deoptimization is pending&quot;);
1135       }
1136     }
1137   }
1138 }
1139 
1140 
1141 // -------------------------------------------------------------------------------------------------------
1142 // Implementation of SafepointTracing
1143 
1144 jlong SafepointTracing::_last_safepoint_begin_time_ns = 0;
1145 jlong SafepointTracing::_last_safepoint_sync_time_ns = 0;
1146 jlong SafepointTracing::_last_safepoint_cleanup_time_ns = 0;
1147 jlong SafepointTracing::_last_safepoint_end_time_ns = 0;

1148 jlong SafepointTracing::_last_app_time_ns = 0;
1149 int SafepointTracing::_nof_threads = 0;
1150 int SafepointTracing::_nof_running = 0;
1151 int SafepointTracing::_page_trap = 0;
1152 VM_Operation::VMOp_Type SafepointTracing::_current_type;
1153 jlong     SafepointTracing::_max_sync_time = 0;
1154 jlong     SafepointTracing::_max_vmop_time = 0;
1155 uint64_t  SafepointTracing::_op_count[VM_Operation::VMOp_Terminating] = {0};
1156 
1157 void SafepointTracing::init() {
1158   // Application start
1159   _last_safepoint_end_time_ns = os::javaTimeNanos();


1160 }
1161 
1162 // Helper method to print the header.
1163 static void print_header(outputStream* st) {
1164   // The number of spaces is significant here, and should match the format
1165   // specifiers in print_statistics().
1166 
1167   st-&gt;print(&quot;VM Operation                 &quot;
1168             &quot;[ threads: total initial_running ]&quot;
1169             &quot;[ time:       sync    cleanup       vmop      total ]&quot;);
1170 
1171   st-&gt;print_cr(&quot; page_trap_count&quot;);
1172 }
1173 
1174 // This prints a nice table.  To get the statistics to not shift due to the logging uptime
1175 // decorator, use the option as: -Xlog:safepoint+stats:[outputfile]:none
1176 void SafepointTracing::statistics_log() {
1177   LogTarget(Info, safepoint, stats) lt;
1178   assert (lt.is_enabled(), &quot;should only be called when printing statistics is enabled&quot;);
1179   LogStream ls(lt);
</pre>
<hr />
<pre>
1239   _last_app_time_ns = _last_safepoint_begin_time_ns - _last_safepoint_end_time_ns;
1240   _last_safepoint_end_time_ns = 0;
1241 
1242   RuntimeService::record_safepoint_begin(_last_app_time_ns);
1243 }
1244 
1245 void SafepointTracing::synchronized(int nof_threads, int nof_running, int traps) {
1246   _last_safepoint_sync_time_ns = os::javaTimeNanos();
1247   _nof_threads = nof_threads;
1248   _nof_running = nof_running;
1249   _page_trap   = traps;
1250   RuntimeService::record_safepoint_synchronized(_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns);
1251 }
1252 
1253 void SafepointTracing::cleanup() {
1254   _last_safepoint_cleanup_time_ns = os::javaTimeNanos();
1255 }
1256 
1257 void SafepointTracing::end() {
1258   _last_safepoint_end_time_ns = os::javaTimeNanos();


1259 
1260   if (_max_sync_time &lt; (_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns)) {
1261     _max_sync_time = _last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns;
1262   }
1263   if (_max_vmop_time &lt; (_last_safepoint_end_time_ns - _last_safepoint_sync_time_ns)) {
1264     _max_vmop_time = _last_safepoint_end_time_ns - _last_safepoint_sync_time_ns;
1265   }
1266   if (log_is_enabled(Info, safepoint, stats)) {
1267     statistics_log();
1268   }
1269 
1270   log_info(safepoint)(
1271      &quot;Safepoint \&quot;%s\&quot;, &quot;
1272      &quot;Time since last: &quot; JLONG_FORMAT &quot; ns, &quot;
1273      &quot;Reaching safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1274      &quot;At safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1275      &quot;Total: &quot; JLONG_FORMAT &quot; ns&quot;,
1276       VM_Operation::name(_current_type),
1277       _last_app_time_ns,
1278       _last_safepoint_cleanup_time_ns - _last_safepoint_begin_time_ns,
</pre>
</td>
</tr>
</table>
<center><a href="rtmLocking.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="safepoint.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>