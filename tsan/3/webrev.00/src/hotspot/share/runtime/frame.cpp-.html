<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/frame.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;code/codeCache.hpp&quot;
  27 #include &quot;code/vmreg.inline.hpp&quot;
  28 #include &quot;compiler/abstractCompiler.hpp&quot;
  29 #include &quot;compiler/disassembler.hpp&quot;
  30 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/oopMapCache.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markOop.hpp&quot;
  36 #include &quot;oops/method.hpp&quot;
  37 #include &quot;oops/methodData.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;oops/verifyOopClosure.hpp&quot;
  40 #include &quot;prims/methodHandles.hpp&quot;
  41 #include &quot;runtime/frame.inline.hpp&quot;
  42 #include &quot;runtime/handles.inline.hpp&quot;
  43 #include &quot;runtime/javaCalls.hpp&quot;
  44 #include &quot;runtime/monitorChunk.hpp&quot;
  45 #include &quot;runtime/os.hpp&quot;
  46 #include &quot;runtime/sharedRuntime.hpp&quot;
  47 #include &quot;runtime/signature.hpp&quot;
  48 #include &quot;runtime/stubCodeGenerator.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/thread.inline.hpp&quot;
  51 #include &quot;utilities/debug.hpp&quot;
  52 #include &quot;utilities/decoder.hpp&quot;
  53 #include &quot;utilities/formatBuffer.hpp&quot;
  54 
  55 RegisterMap::RegisterMap(JavaThread *thread, bool update_map) {
  56   _thread         = thread;
  57   _update_map     = update_map;
  58   clear();
  59   debug_only(_update_for_id = NULL;)
  60 #ifndef PRODUCT
  61   for (int i = 0; i &lt; reg_count ; i++ ) _location[i] = NULL;
  62 #endif /* PRODUCT */
  63 }
  64 
  65 RegisterMap::RegisterMap(const RegisterMap* map) {
  66   assert(map != this, &quot;bad initialization parameter&quot;);
  67   assert(map != NULL, &quot;RegisterMap must be present&quot;);
  68   _thread                = map-&gt;thread();
  69   _update_map            = map-&gt;update_map();
  70   _include_argument_oops = map-&gt;include_argument_oops();
  71   debug_only(_update_for_id = map-&gt;_update_for_id;)
  72   pd_initialize_from(map);
  73   if (update_map()) {
  74     for(int i = 0; i &lt; location_valid_size; i++) {
  75       LocationValidType bits = !update_map() ? 0 : map-&gt;_location_valid[i];
  76       _location_valid[i] = bits;
  77       // for whichever bits are set, pull in the corresponding map-&gt;_location
  78       int j = i*location_valid_type_size;
  79       while (bits != 0) {
  80         if ((bits &amp; 1) != 0) {
  81           assert(0 &lt;= j &amp;&amp; j &lt; reg_count, &quot;range check&quot;);
  82           _location[j] = map-&gt;_location[j];
  83         }
  84         bits &gt;&gt;= 1;
  85         j += 1;
  86       }
  87     }
  88   }
  89 }
  90 
  91 void RegisterMap::clear() {
  92   set_include_argument_oops(true);
  93   if (_update_map) {
  94     for(int i = 0; i &lt; location_valid_size; i++) {
  95       _location_valid[i] = 0;
  96     }
  97     pd_clear();
  98   } else {
  99     pd_initialize();
 100   }
 101 }
 102 
 103 #ifndef PRODUCT
 104 
 105 void RegisterMap::print_on(outputStream* st) const {
 106   st-&gt;print_cr(&quot;Register map&quot;);
 107   for(int i = 0; i &lt; reg_count; i++) {
 108 
 109     VMReg r = VMRegImpl::as_VMReg(i);
 110     intptr_t* src = (intptr_t*) location(r);
 111     if (src != NULL) {
 112 
 113       r-&gt;print_on(st);
 114       st-&gt;print(&quot; [&quot; INTPTR_FORMAT &quot;] = &quot;, p2i(src));
 115       if (((uintptr_t)src &amp; (sizeof(*src)-1)) != 0) {
 116         st-&gt;print_cr(&quot;&lt;misaligned&gt;&quot;);
 117       } else {
 118         st-&gt;print_cr(INTPTR_FORMAT, *src);
 119       }
 120     }
 121   }
 122 }
 123 
 124 void RegisterMap::print() const {
 125   print_on(tty);
 126 }
 127 
 128 #endif
 129 // This returns the pc that if you were in the debugger you&#39;d see. Not
 130 // the idealized value in the frame object. This undoes the magic conversion
 131 // that happens for deoptimized frames. In addition it makes the value the
 132 // hardware would want to see in the native frame. The only user (at this point)
 133 // is deoptimization. It likely no one else should ever use it.
 134 
 135 address frame::raw_pc() const {
 136   if (is_deoptimized_frame()) {
 137     CompiledMethod* cm = cb()-&gt;as_compiled_method_or_null();
 138     if (cm-&gt;is_method_handle_return(pc()))
 139       return cm-&gt;deopt_mh_handler_begin() - pc_return_offset;
 140     else
 141       return cm-&gt;deopt_handler_begin() - pc_return_offset;
 142   } else {
 143     return (pc() - pc_return_offset);
 144   }
 145 }
 146 
 147 // Change the pc in a frame object. This does not change the actual pc in
 148 // actual frame. To do that use patch_pc.
 149 //
 150 void frame::set_pc(address   newpc ) {
 151 #ifdef ASSERT
 152   if (_cb != NULL &amp;&amp; _cb-&gt;is_nmethod()) {
 153     assert(!((nmethod*)_cb)-&gt;is_deopt_pc(_pc), &quot;invariant violation&quot;);
 154   }
 155 #endif // ASSERT
 156 
 157   // Unsafe to use the is_deoptimzed tester after changing pc
 158   _deopt_state = unknown;
 159   _pc = newpc;
 160   _cb = CodeCache::find_blob_unsafe(_pc);
 161 
 162 }
 163 
 164 // type testers
 165 bool frame::is_ignored_frame() const {
 166   return false;  // FIXME: some LambdaForm frames should be ignored
 167 }
 168 bool frame::is_deoptimized_frame() const {
 169   assert(_deopt_state != unknown, &quot;not answerable&quot;);
 170   return _deopt_state == is_deoptimized;
 171 }
 172 
 173 bool frame::is_native_frame() const {
 174   return (_cb != NULL &amp;&amp;
 175           _cb-&gt;is_nmethod() &amp;&amp;
 176           ((nmethod*)_cb)-&gt;is_native_method());
 177 }
 178 
 179 bool frame::is_java_frame() const {
 180   if (is_interpreted_frame()) return true;
 181   if (is_compiled_frame())    return true;
 182   return false;
 183 }
 184 
 185 
 186 bool frame::is_compiled_frame() const {
 187   if (_cb != NULL &amp;&amp;
 188       _cb-&gt;is_compiled() &amp;&amp;
 189       ((CompiledMethod*)_cb)-&gt;is_java_method()) {
 190     return true;
 191   }
 192   return false;
 193 }
 194 
 195 
 196 bool frame::is_runtime_frame() const {
 197   return (_cb != NULL &amp;&amp; _cb-&gt;is_runtime_stub());
 198 }
 199 
 200 bool frame::is_safepoint_blob_frame() const {
 201   return (_cb != NULL &amp;&amp; _cb-&gt;is_safepoint_stub());
 202 }
 203 
 204 // testers
 205 
 206 bool frame::is_first_java_frame() const {
 207   RegisterMap map(JavaThread::current(), false); // No update
 208   frame s;
 209   for (s = sender(&amp;map); !(s.is_java_frame() || s.is_first_frame()); s = s.sender(&amp;map));
 210   return s.is_first_frame();
 211 }
 212 
 213 
 214 bool frame::entry_frame_is_first() const {
 215   return entry_frame_call_wrapper()-&gt;is_first_frame();
 216 }
 217 
 218 JavaCallWrapper* frame::entry_frame_call_wrapper_if_safe(JavaThread* thread) const {
 219   JavaCallWrapper** jcw = entry_frame_call_wrapper_addr();
 220   address addr = (address) jcw;
 221 
 222   // addr must be within the usable part of the stack
 223   if (thread-&gt;is_in_usable_stack(addr)) {
 224     return *jcw;
 225   }
 226 
 227   return NULL;
 228 }
 229 
 230 bool frame::is_entry_frame_valid(JavaThread* thread) const {
 231   // Validate the JavaCallWrapper an entry frame must have
 232   address jcw = (address)entry_frame_call_wrapper();
 233   bool jcw_safe = (jcw &lt; thread-&gt;stack_base()) &amp;&amp; (jcw &gt; (address)fp()); // less than stack base
 234   if (!jcw_safe) {
 235     return false;
 236   }
 237 
 238   // Validate sp saved in the java frame anchor
 239   JavaFrameAnchor* jfa = entry_frame_call_wrapper()-&gt;anchor();
 240   return (jfa-&gt;last_Java_sp() &gt; sp());
 241 }
 242 
 243 bool frame::should_be_deoptimized() const {
 244   if (_deopt_state == is_deoptimized ||
 245       !is_compiled_frame() ) return false;
 246   assert(_cb != NULL &amp;&amp; _cb-&gt;is_compiled(), &quot;must be an nmethod&quot;);
 247   CompiledMethod* nm = (CompiledMethod *)_cb;
 248   if (TraceDependencies) {
 249     tty-&gt;print(&quot;checking (%s) &quot;, nm-&gt;is_marked_for_deoptimization() ? &quot;true&quot; : &quot;false&quot;);
 250     nm-&gt;print_value_on(tty);
 251     tty-&gt;cr();
 252   }
 253 
 254   if( !nm-&gt;is_marked_for_deoptimization() )
 255     return false;
 256 
 257   // If at the return point, then the frame has already been popped, and
 258   // only the return needs to be executed. Don&#39;t deoptimize here.
 259   return !nm-&gt;is_at_poll_return(pc());
 260 }
 261 
 262 bool frame::can_be_deoptimized() const {
 263   if (!is_compiled_frame()) return false;
 264   CompiledMethod* nm = (CompiledMethod*)_cb;
 265 
 266   if( !nm-&gt;can_be_deoptimized() )
 267     return false;
 268 
 269   return !nm-&gt;is_at_poll_return(pc());
 270 }
 271 
 272 void frame::deoptimize(JavaThread* thread) {
 273   // Schedule deoptimization of an nmethod activation with this frame.
 274   assert(_cb != NULL &amp;&amp; _cb-&gt;is_compiled(), &quot;must be&quot;);
 275 
 276   // This is a fix for register window patching race
 277   if (NeedsDeoptSuspend &amp;&amp; Thread::current() != thread) {
 278     assert(SafepointSynchronize::is_at_safepoint(),
 279            &quot;patching other threads for deopt may only occur at a safepoint&quot;);
 280 
 281     // It is possible especially with DeoptimizeALot/DeoptimizeRandom that
 282     // we could see the frame again and ask for it to be deoptimized since
 283     // it might move for a long time. That is harmless and we just ignore it.
 284     if (id() == thread-&gt;must_deopt_id()) {
 285       assert(thread-&gt;is_deopt_suspend(), &quot;lost suspension&quot;);
 286       return;
 287     }
 288 
 289     // We are at a safepoint so the target thread can only be
 290     // in 4 states:
 291     //     blocked - no problem
 292     //     blocked_trans - no problem (i.e. could have woken up from blocked
 293     //                                 during a safepoint).
 294     //     native - register window pc patching race
 295     //     native_trans - momentary state
 296     //
 297     // We could just wait out a thread in native_trans to block.
 298     // Then we&#39;d have all the issues that the safepoint code has as to
 299     // whether to spin or block. It isn&#39;t worth it. Just treat it like
 300     // native and be done with it.
 301     //
 302     // Examine the state of the thread at the start of safepoint since
 303     // threads that were in native at the start of the safepoint could
 304     // come to a halt during the safepoint, changing the current value
 305     // of the safepoint_state.
 306     JavaThreadState state = thread-&gt;safepoint_state()-&gt;orig_thread_state();
 307     if (state == _thread_in_native || state == _thread_in_native_trans) {
 308       // Since we are at a safepoint the target thread will stop itself
 309       // before it can return to java as long as we remain at the safepoint.
 310       // Therefore we can put an additional request for the thread to stop
 311       // no matter what no (like a suspend). This will cause the thread
 312       // to notice it needs to do the deopt on its own once it leaves native.
 313       //
 314       // The only reason we must do this is because on machine with register
 315       // windows we have a race with patching the return address and the
 316       // window coming live as the thread returns to the Java code (but still
 317       // in native mode) and then blocks. It is only this top most frame
 318       // that is at risk. So in truth we could add an additional check to
 319       // see if this frame is one that is at risk.
 320       RegisterMap map(thread, false);
 321       frame at_risk =  thread-&gt;last_frame().sender(&amp;map);
 322       if (id() == at_risk.id()) {
 323         thread-&gt;set_must_deopt_id(id());
 324         thread-&gt;set_deopt_suspend();
 325         return;
 326       }
 327     }
 328   } // NeedsDeoptSuspend
 329 
 330 
 331   // If the call site is a MethodHandle call site use the MH deopt
 332   // handler.
 333   CompiledMethod* cm = (CompiledMethod*) _cb;
 334   address deopt = cm-&gt;is_method_handle_return(pc()) ?
 335                         cm-&gt;deopt_mh_handler_begin() :
 336                         cm-&gt;deopt_handler_begin();
 337 
 338   // Save the original pc before we patch in the new one
 339   cm-&gt;set_original_pc(this, pc());
 340   patch_pc(thread, deopt);
 341 
 342 #ifdef ASSERT
 343   {
 344     RegisterMap map(thread, false);
 345     frame check = thread-&gt;last_frame();
 346     while (id() != check.id()) {
 347       check = check.sender(&amp;map);
 348     }
 349     assert(check.is_deoptimized_frame(), &quot;missed deopt&quot;);
 350   }
 351 #endif // ASSERT
 352 }
 353 
 354 frame frame::java_sender() const {
 355   RegisterMap map(JavaThread::current(), false);
 356   frame s;
 357   for (s = sender(&amp;map); !(s.is_java_frame() || s.is_first_frame()); s = s.sender(&amp;map)) ;
 358   guarantee(s.is_java_frame(), &quot;tried to get caller of first java frame&quot;);
 359   return s;
 360 }
 361 
 362 frame frame::real_sender(RegisterMap* map) const {
 363   frame result = sender(map);
 364   while (result.is_runtime_frame() ||
 365          result.is_ignored_frame()) {
 366     result = result.sender(map);
 367   }
 368   return result;
 369 }
 370 
 371 // Interpreter frames
 372 
 373 
 374 void frame::interpreter_frame_set_locals(intptr_t* locs)  {
 375   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 376   *interpreter_frame_locals_addr() = locs;
 377 }
 378 
 379 Method* frame::interpreter_frame_method() const {
 380   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 381   Method* m = *interpreter_frame_method_addr();
 382   assert(m-&gt;is_method(), &quot;not a Method*&quot;);
 383   return m;
 384 }
 385 
 386 void frame::interpreter_frame_set_method(Method* method) {
 387   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 388   *interpreter_frame_method_addr() = method;
 389 }
 390 
 391 void frame::interpreter_frame_set_mirror(oop mirror) {
 392   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 393   *interpreter_frame_mirror_addr() = mirror;
 394 }
 395 
 396 jint frame::interpreter_frame_bci() const {
 397   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 398   address bcp = interpreter_frame_bcp();
 399   return interpreter_frame_method()-&gt;bci_from(bcp);
 400 }
 401 
 402 address frame::interpreter_frame_bcp() const {
 403   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 404   address bcp = (address)*interpreter_frame_bcp_addr();
 405   return interpreter_frame_method()-&gt;bcp_from(bcp);
 406 }
 407 
 408 void frame::interpreter_frame_set_bcp(address bcp) {
 409   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 410   *interpreter_frame_bcp_addr() = (intptr_t)bcp;
 411 }
 412 
 413 address frame::interpreter_frame_mdp() const {
 414   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 415   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 416   return (address)*interpreter_frame_mdp_addr();
 417 }
 418 
 419 void frame::interpreter_frame_set_mdp(address mdp) {
 420   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 421   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 422   *interpreter_frame_mdp_addr() = (intptr_t)mdp;
 423 }
 424 
 425 BasicObjectLock* frame::next_monitor_in_interpreter_frame(BasicObjectLock* current) const {
 426   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 427 #ifdef ASSERT
 428   interpreter_frame_verify_monitor(current);
 429 #endif
 430   BasicObjectLock* next = (BasicObjectLock*) (((intptr_t*) current) + interpreter_frame_monitor_size());
 431   return next;
 432 }
 433 
 434 BasicObjectLock* frame::previous_monitor_in_interpreter_frame(BasicObjectLock* current) const {
 435   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 436 #ifdef ASSERT
 437 //   // This verification needs to be checked before being enabled
 438 //   interpreter_frame_verify_monitor(current);
 439 #endif
 440   BasicObjectLock* previous = (BasicObjectLock*) (((intptr_t*) current) - interpreter_frame_monitor_size());
 441   return previous;
 442 }
 443 
 444 // Interpreter locals and expression stack locations.
 445 
 446 intptr_t* frame::interpreter_frame_local_at(int index) const {
 447   const int n = Interpreter::local_offset_in_bytes(index)/wordSize;
 448   return &amp;((*interpreter_frame_locals_addr())[n]);
 449 }
 450 
 451 intptr_t* frame::interpreter_frame_expression_stack_at(jint offset) const {
 452   const int i = offset * interpreter_frame_expression_stack_direction();
 453   const int n = i * Interpreter::stackElementWords;
 454   return &amp;(interpreter_frame_expression_stack()[n]);
 455 }
 456 
 457 jint frame::interpreter_frame_expression_stack_size() const {
 458   // Number of elements on the interpreter expression stack
 459   // Callers should span by stackElementWords
 460   int element_size = Interpreter::stackElementWords;
 461   size_t stack_size = 0;
 462   if (frame::interpreter_frame_expression_stack_direction() &lt; 0) {
 463     stack_size = (interpreter_frame_expression_stack() -
 464                   interpreter_frame_tos_address() + 1)/element_size;
 465   } else {
 466     stack_size = (interpreter_frame_tos_address() -
 467                   interpreter_frame_expression_stack() + 1)/element_size;
 468   }
 469   assert( stack_size &lt;= (size_t)max_jint, &quot;stack size too big&quot;);
 470   return ((jint)stack_size);
 471 }
 472 
 473 
 474 // (frame::interpreter_frame_sender_sp accessor is in frame_&lt;arch&gt;.cpp)
 475 
 476 const char* frame::print_name() const {
 477   if (is_native_frame())      return &quot;Native&quot;;
 478   if (is_interpreted_frame()) return &quot;Interpreted&quot;;
 479   if (is_compiled_frame()) {
 480     if (is_deoptimized_frame()) return &quot;Deoptimized&quot;;
 481     return &quot;Compiled&quot;;
 482   }
 483   if (sp() == NULL)            return &quot;Empty&quot;;
 484   return &quot;C&quot;;
 485 }
 486 
 487 void frame::print_value_on(outputStream* st, JavaThread *thread) const {
 488   NOT_PRODUCT(address begin = pc()-40;)
 489   NOT_PRODUCT(address end   = NULL;)
 490 
 491   st-&gt;print(&quot;%s frame (sp=&quot; INTPTR_FORMAT &quot; unextended sp=&quot; INTPTR_FORMAT, print_name(), p2i(sp()), p2i(unextended_sp()));
 492   if (sp() != NULL)
 493     st-&gt;print(&quot;, fp=&quot; INTPTR_FORMAT &quot;, real_fp=&quot; INTPTR_FORMAT &quot;, pc=&quot; INTPTR_FORMAT,
 494               p2i(fp()), p2i(real_fp()), p2i(pc()));
 495 
 496   if (StubRoutines::contains(pc())) {
 497     st-&gt;print_cr(&quot;)&quot;);
 498     st-&gt;print(&quot;(&quot;);
 499     StubCodeDesc* desc = StubCodeDesc::desc_for(pc());
 500     st-&gt;print(&quot;~Stub::%s&quot;, desc-&gt;name());
 501     NOT_PRODUCT(begin = desc-&gt;begin(); end = desc-&gt;end();)
 502   } else if (Interpreter::contains(pc())) {
 503     st-&gt;print_cr(&quot;)&quot;);
 504     st-&gt;print(&quot;(&quot;);
 505     InterpreterCodelet* desc = Interpreter::codelet_containing(pc());
 506     if (desc != NULL) {
 507       st-&gt;print(&quot;~&quot;);
 508       desc-&gt;print_on(st);
 509       NOT_PRODUCT(begin = desc-&gt;code_begin(); end = desc-&gt;code_end();)
 510     } else {
 511       st-&gt;print(&quot;~interpreter&quot;);
 512     }
 513   }
 514   st-&gt;print_cr(&quot;)&quot;);
 515 
 516   if (_cb != NULL) {
 517     st-&gt;print(&quot;     &quot;);
 518     _cb-&gt;print_value_on(st);
 519     st-&gt;cr();
 520 #ifndef PRODUCT
 521     if (end == NULL) {
 522       begin = _cb-&gt;code_begin();
 523       end   = _cb-&gt;code_end();
 524     }
 525 #endif
 526   }
 527   NOT_PRODUCT(if (WizardMode &amp;&amp; Verbose) Disassembler::decode(begin, end);)
 528 }
 529 
 530 
 531 void frame::print_on(outputStream* st) const {
 532   print_value_on(st,NULL);
 533   if (is_interpreted_frame()) {
 534     interpreter_frame_print_on(st);
 535   }
 536 }
 537 
 538 
 539 void frame::interpreter_frame_print_on(outputStream* st) const {
 540 #ifndef PRODUCT
 541   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 542   jint i;
 543   for (i = 0; i &lt; interpreter_frame_method()-&gt;max_locals(); i++ ) {
 544     intptr_t x = *interpreter_frame_local_at(i);
 545     st-&gt;print(&quot; - local  [&quot; INTPTR_FORMAT &quot;]&quot;, x);
 546     st-&gt;fill_to(23);
 547     st-&gt;print_cr(&quot;; #%d&quot;, i);
 548   }
 549   for (i = interpreter_frame_expression_stack_size() - 1; i &gt;= 0; --i ) {
 550     intptr_t x = *interpreter_frame_expression_stack_at(i);
 551     st-&gt;print(&quot; - stack  [&quot; INTPTR_FORMAT &quot;]&quot;, x);
 552     st-&gt;fill_to(23);
 553     st-&gt;print_cr(&quot;; #%d&quot;, i);
 554   }
 555   // locks for synchronization
 556   for (BasicObjectLock* current = interpreter_frame_monitor_end();
 557        current &lt; interpreter_frame_monitor_begin();
 558        current = next_monitor_in_interpreter_frame(current)) {
 559     st-&gt;print(&quot; - obj    [&quot;);
 560     current-&gt;obj()-&gt;print_value_on(st);
 561     st-&gt;print_cr(&quot;]&quot;);
 562     st-&gt;print(&quot; - lock   [&quot;);
 563     current-&gt;lock()-&gt;print_on(st);
 564     st-&gt;print_cr(&quot;]&quot;);
 565   }
 566   // monitor
 567   st-&gt;print_cr(&quot; - monitor[&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_monitor_begin()));
 568   // bcp
 569   st-&gt;print(&quot; - bcp    [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_bcp()));
 570   st-&gt;fill_to(23);
 571   st-&gt;print_cr(&quot;; @%d&quot;, interpreter_frame_bci());
 572   // locals
 573   st-&gt;print_cr(&quot; - locals [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_local_at(0)));
 574   // method
 575   st-&gt;print(&quot; - method [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_method()));
 576   st-&gt;fill_to(23);
 577   st-&gt;print(&quot;; &quot;);
 578   interpreter_frame_method()-&gt;print_name(st);
 579   st-&gt;cr();
 580 #endif
 581 }
 582 
 583 // Print whether the frame is in the VM or OS indicating a HotSpot problem.
 584 // Otherwise, it&#39;s likely a bug in the native library that the Java code calls,
 585 // hopefully indicating where to submit bugs.
 586 void frame::print_C_frame(outputStream* st, char* buf, int buflen, address pc) {
 587   // C/C++ frame
 588   bool in_vm = os::address_is_in_vm(pc);
 589   st-&gt;print(in_vm ? &quot;V&quot; : &quot;C&quot;);
 590 
 591   int offset;
 592   bool found;
 593 
 594   // libname
 595   found = os::dll_address_to_library_name(pc, buf, buflen, &amp;offset);
 596   if (found) {
 597     // skip directory names
 598     const char *p1, *p2;
 599     p1 = buf;
 600     int len = (int)strlen(os::file_separator());
 601     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
 602     st-&gt;print(&quot;  [%s+0x%x]&quot;, p1, offset);
 603   } else {
 604     st-&gt;print(&quot;  &quot; PTR_FORMAT, p2i(pc));
 605   }
 606 
 607   found = os::dll_address_to_function_name(pc, buf, buflen, &amp;offset);
 608   if (found) {
 609     st-&gt;print(&quot;  %s+0x%x&quot;, buf, offset);
 610   }
 611 }
 612 
 613 // frame::print_on_error() is called by fatal error handler. Notice that we may
 614 // crash inside this function if stack frame is corrupted. The fatal error
 615 // handler can catch and handle the crash. Here we assume the frame is valid.
 616 //
 617 // First letter indicates type of the frame:
 618 //    J: Java frame (compiled)
 619 //    A: Java frame (aot compiled)
 620 //    j: Java frame (interpreted)
 621 //    V: VM frame (C/C++)
 622 //    v: Other frames running VM generated code (e.g. stubs, adapters, etc.)
 623 //    C: C/C++ frame
 624 //
 625 // We don&#39;t need detailed frame type as that in frame::print_name(). &quot;C&quot;
 626 // suggests the problem is in user lib; everything else is likely a VM bug.
 627 
 628 void frame::print_on_error(outputStream* st, char* buf, int buflen, bool verbose) const {
 629   if (_cb != NULL) {
 630     if (Interpreter::contains(pc())) {
 631       Method* m = this-&gt;interpreter_frame_method();
 632       if (m != NULL) {
 633         m-&gt;name_and_sig_as_C_string(buf, buflen);
 634         st-&gt;print(&quot;j  %s&quot;, buf);
 635         st-&gt;print(&quot;+%d&quot;, this-&gt;interpreter_frame_bci());
 636         ModuleEntry* module = m-&gt;method_holder()-&gt;module();
 637         if (module-&gt;is_named()) {
 638           module-&gt;name()-&gt;as_C_string(buf, buflen);
 639           st-&gt;print(&quot; %s&quot;, buf);
 640           if (module-&gt;version() != NULL) {
 641             module-&gt;version()-&gt;as_C_string(buf, buflen);
 642             st-&gt;print(&quot;@%s&quot;, buf);
 643           }
 644         }
 645       } else {
 646         st-&gt;print(&quot;j  &quot; PTR_FORMAT, p2i(pc()));
 647       }
 648     } else if (StubRoutines::contains(pc())) {
 649       StubCodeDesc* desc = StubCodeDesc::desc_for(pc());
 650       if (desc != NULL) {
 651         st-&gt;print(&quot;v  ~StubRoutines::%s&quot;, desc-&gt;name());
 652       } else {
 653         st-&gt;print(&quot;v  ~StubRoutines::&quot; PTR_FORMAT, p2i(pc()));
 654       }
 655     } else if (_cb-&gt;is_buffer_blob()) {
 656       st-&gt;print(&quot;v  ~BufferBlob::%s&quot;, ((BufferBlob *)_cb)-&gt;name());
 657     } else if (_cb-&gt;is_compiled()) {
 658       CompiledMethod* cm = (CompiledMethod*)_cb;
 659       Method* m = cm-&gt;method();
 660       if (m != NULL) {
 661         if (cm-&gt;is_aot()) {
 662           st-&gt;print(&quot;A %d &quot;, cm-&gt;compile_id());
 663         } else if (cm-&gt;is_nmethod()) {
 664           nmethod* nm = cm-&gt;as_nmethod();
 665           st-&gt;print(&quot;J %d%s&quot;, nm-&gt;compile_id(), (nm-&gt;is_osr_method() ? &quot;%&quot; : &quot;&quot;));
 666           st-&gt;print(&quot; %s&quot;, nm-&gt;compiler_name());
 667         }
 668         m-&gt;name_and_sig_as_C_string(buf, buflen);
 669         st-&gt;print(&quot; %s&quot;, buf);
 670         ModuleEntry* module = m-&gt;method_holder()-&gt;module();
 671         if (module-&gt;is_named()) {
 672           module-&gt;name()-&gt;as_C_string(buf, buflen);
 673           st-&gt;print(&quot; %s&quot;, buf);
 674           if (module-&gt;version() != NULL) {
 675             module-&gt;version()-&gt;as_C_string(buf, buflen);
 676             st-&gt;print(&quot;@%s&quot;, buf);
 677           }
 678         }
 679         st-&gt;print(&quot; (%d bytes) @ &quot; PTR_FORMAT &quot; [&quot; PTR_FORMAT &quot;+&quot; INTPTR_FORMAT &quot;]&quot;,
 680                   m-&gt;code_size(), p2i(_pc), p2i(_cb-&gt;code_begin()), _pc - _cb-&gt;code_begin());
 681 #if INCLUDE_JVMCI
 682         if (cm-&gt;is_nmethod()) {
 683           nmethod* nm = cm-&gt;as_nmethod();
 684           char* jvmciName = nm-&gt;jvmci_installed_code_name(buf, buflen);
 685           if (jvmciName != NULL) {
 686             st-&gt;print(&quot; (%s)&quot;, jvmciName);
 687           }
 688         }
 689 #endif
 690       } else {
 691         st-&gt;print(&quot;J  &quot; PTR_FORMAT, p2i(pc()));
 692       }
 693     } else if (_cb-&gt;is_runtime_stub()) {
 694       st-&gt;print(&quot;v  ~RuntimeStub::%s&quot;, ((RuntimeStub *)_cb)-&gt;name());
 695     } else if (_cb-&gt;is_deoptimization_stub()) {
 696       st-&gt;print(&quot;v  ~DeoptimizationBlob&quot;);
 697     } else if (_cb-&gt;is_exception_stub()) {
 698       st-&gt;print(&quot;v  ~ExceptionBlob&quot;);
 699     } else if (_cb-&gt;is_safepoint_stub()) {
 700       st-&gt;print(&quot;v  ~SafepointBlob&quot;);
 701     } else if (_cb-&gt;is_adapter_blob()) {
 702       st-&gt;print(&quot;v  ~AdapterBlob&quot;);
 703     } else if (_cb-&gt;is_vtable_blob()) {
 704       st-&gt;print(&quot;v  ~VtableBlob&quot;);
 705     } else if (_cb-&gt;is_method_handles_adapter_blob()) {
 706       st-&gt;print(&quot;v  ~MethodHandlesAdapterBlob&quot;);
 707     } else if (_cb-&gt;is_uncommon_trap_stub()) {
 708       st-&gt;print(&quot;v  ~UncommonTrapBlob&quot;);
 709     } else {
 710       st-&gt;print(&quot;v  blob &quot; PTR_FORMAT, p2i(pc()));
 711     }
 712   } else {
 713     print_C_frame(st, buf, buflen, pc());
 714   }
 715 }
 716 
 717 
 718 /*
 719   The interpreter_frame_expression_stack_at method in the case of SPARC needs the
 720   max_stack value of the method in order to compute the expression stack address.
 721   It uses the Method* in order to get the max_stack value but during GC this
 722   Method* value saved on the frame is changed by reverse_and_push and hence cannot
 723   be used. So we save the max_stack value in the FrameClosure object and pass it
 724   down to the interpreter_frame_expression_stack_at method
 725 */
 726 class InterpreterFrameClosure : public OffsetClosure {
 727  private:
 728   frame* _fr;
 729   OopClosure* _f;
 730   int    _max_locals;
 731   int    _max_stack;
 732 
 733  public:
 734   InterpreterFrameClosure(frame* fr, int max_locals, int max_stack,
 735                           OopClosure* f) {
 736     _fr         = fr;
 737     _max_locals = max_locals;
 738     _max_stack  = max_stack;
 739     _f          = f;
 740   }
 741 
 742   void offset_do(int offset) {
 743     oop* addr;
 744     if (offset &lt; _max_locals) {
 745       addr = (oop*) _fr-&gt;interpreter_frame_local_at(offset);
 746       assert((intptr_t*)addr &gt;= _fr-&gt;sp(), &quot;must be inside the frame&quot;);
 747       _f-&gt;do_oop(addr);
 748     } else {
 749       addr = (oop*) _fr-&gt;interpreter_frame_expression_stack_at((offset - _max_locals));
 750       // In case of exceptions, the expression stack is invalid and the esp will be reset to express
 751       // this condition. Therefore, we call f only if addr is &#39;inside&#39; the stack (i.e., addr &gt;= esp for Intel).
 752       bool in_stack;
 753       if (frame::interpreter_frame_expression_stack_direction() &gt; 0) {
 754         in_stack = (intptr_t*)addr &lt;= _fr-&gt;interpreter_frame_tos_address();
 755       } else {
 756         in_stack = (intptr_t*)addr &gt;= _fr-&gt;interpreter_frame_tos_address();
 757       }
 758       if (in_stack) {
 759         _f-&gt;do_oop(addr);
 760       }
 761     }
 762   }
 763 
 764   int max_locals()  { return _max_locals; }
 765   frame* fr()       { return _fr; }
 766 };
 767 
 768 
 769 class InterpretedArgumentOopFinder: public SignatureInfo {
 770  private:
 771   OopClosure* _f;        // Closure to invoke
 772   int    _offset;        // TOS-relative offset, decremented with each argument
 773   bool   _has_receiver;  // true if the callee has a receiver
 774   frame* _fr;
 775 
 776   void set(int size, BasicType type) {
 777     _offset -= size;
 778     if (type == T_OBJECT || type == T_ARRAY) oop_offset_do();
 779   }
 780 
 781   void oop_offset_do() {
 782     oop* addr;
 783     addr = (oop*)_fr-&gt;interpreter_frame_tos_at(_offset);
 784     _f-&gt;do_oop(addr);
 785   }
 786 
 787  public:
 788   InterpretedArgumentOopFinder(Symbol* signature, bool has_receiver, frame* fr, OopClosure* f) : SignatureInfo(signature), _has_receiver(has_receiver) {
 789     // compute size of arguments
 790     int args_size = ArgumentSizeComputer(signature).size() + (has_receiver ? 1 : 0);
 791     assert(!fr-&gt;is_interpreted_frame() ||
 792            args_size &lt;= fr-&gt;interpreter_frame_expression_stack_size(),
 793             &quot;args cannot be on stack anymore&quot;);
 794     // initialize InterpretedArgumentOopFinder
 795     _f         = f;
 796     _fr        = fr;
 797     _offset    = args_size;
 798   }
 799 
 800   void oops_do() {
 801     if (_has_receiver) {
 802       --_offset;
 803       oop_offset_do();
 804     }
 805     iterate_parameters();
 806   }
 807 };
 808 
 809 
 810 // Entry frame has following form (n arguments)
 811 //         +-----------+
 812 //   sp -&gt; |  last arg |
 813 //         +-----------+
 814 //         :    :::    :
 815 //         +-----------+
 816 // (sp+n)-&gt;|  first arg|
 817 //         +-----------+
 818 
 819 
 820 
 821 // visits and GC&#39;s all the arguments in entry frame
 822 class EntryFrameOopFinder: public SignatureInfo {
 823  private:
 824   bool   _is_static;
 825   int    _offset;
 826   frame* _fr;
 827   OopClosure* _f;
 828 
 829   void set(int size, BasicType type) {
 830     assert (_offset &gt;= 0, &quot;illegal offset&quot;);
 831     if (type == T_OBJECT || type == T_ARRAY) oop_at_offset_do(_offset);
 832     _offset -= size;
 833   }
 834 
 835   void oop_at_offset_do(int offset) {
 836     assert (offset &gt;= 0, &quot;illegal offset&quot;);
 837     oop* addr = (oop*) _fr-&gt;entry_frame_argument_at(offset);
 838     _f-&gt;do_oop(addr);
 839   }
 840 
 841  public:
 842    EntryFrameOopFinder(frame* frame, Symbol* signature, bool is_static) : SignatureInfo(signature) {
 843      _f = NULL; // will be set later
 844      _fr = frame;
 845      _is_static = is_static;
 846      _offset = ArgumentSizeComputer(signature).size() - 1; // last parameter is at index 0
 847    }
 848 
 849   void arguments_do(OopClosure* f) {
 850     _f = f;
 851     if (!_is_static) oop_at_offset_do(_offset+1); // do the receiver
 852     iterate_parameters();
 853   }
 854 
 855 };
 856 
 857 oop* frame::interpreter_callee_receiver_addr(Symbol* signature) {
 858   ArgumentSizeComputer asc(signature);
 859   int size = asc.size();
 860   return (oop *)interpreter_frame_tos_at(size);
 861 }
 862 
 863 
 864 void frame::oops_interpreted_do(OopClosure* f, const RegisterMap* map, bool query_oop_map_cache) {
 865   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 866   assert(map != NULL, &quot;map must be set&quot;);
 867   Thread *thread = Thread::current();
 868   methodHandle m (thread, interpreter_frame_method());
 869   jint      bci = interpreter_frame_bci();
 870 
 871   assert(!Universe::heap()-&gt;is_in(m()),
 872           &quot;must be valid oop&quot;);
 873   assert(m-&gt;is_method(), &quot;checking frame value&quot;);
 874   assert((m-&gt;is_native() &amp;&amp; bci == 0)  ||
 875          (!m-&gt;is_native() &amp;&amp; bci &gt;= 0 &amp;&amp; bci &lt; m-&gt;code_size()),
 876          &quot;invalid bci value&quot;);
 877 
 878   // Handle the monitor elements in the activation
 879   for (
 880     BasicObjectLock* current = interpreter_frame_monitor_end();
 881     current &lt; interpreter_frame_monitor_begin();
 882     current = next_monitor_in_interpreter_frame(current)
 883   ) {
 884 #ifdef ASSERT
 885     interpreter_frame_verify_monitor(current);
 886 #endif
 887     current-&gt;oops_do(f);
 888   }
 889 
 890   if (m-&gt;is_native()) {
 891     f-&gt;do_oop(interpreter_frame_temp_oop_addr());
 892   }
 893 
 894   // The method pointer in the frame might be the only path to the method&#39;s
 895   // klass, and the klass needs to be kept alive while executing. The GCs
 896   // don&#39;t trace through method pointers, so the mirror of the method&#39;s klass
 897   // is installed as a GC root.
 898   f-&gt;do_oop(interpreter_frame_mirror_addr());
 899 
 900   int max_locals = m-&gt;is_native() ? m-&gt;size_of_parameters() : m-&gt;max_locals();
 901 
 902   Symbol* signature = NULL;
 903   bool has_receiver = false;
 904 
 905   // Process a callee&#39;s arguments if we are at a call site
 906   // (i.e., if we are at an invoke bytecode)
 907   // This is used sometimes for calling into the VM, not for another
 908   // interpreted or compiled frame.
 909   if (!m-&gt;is_native()) {
 910     Bytecode_invoke call = Bytecode_invoke_check(m, bci);
 911     if (call.is_valid()) {
 912       signature = call.signature();
 913       has_receiver = call.has_receiver();
 914       if (map-&gt;include_argument_oops() &amp;&amp;
 915           interpreter_frame_expression_stack_size() &gt; 0) {
 916         ResourceMark rm(thread);  // is this right ???
 917         // we are at a call site &amp; the expression stack is not empty
 918         // =&gt; process callee&#39;s arguments
 919         //
 920         // Note: The expression stack can be empty if an exception
 921         //       occurred during method resolution/execution. In all
 922         //       cases we empty the expression stack completely be-
 923         //       fore handling the exception (the exception handling
 924         //       code in the interpreter calls a blocking runtime
 925         //       routine which can cause this code to be executed).
 926         //       (was bug gri 7/27/98)
 927         oops_interpreted_arguments_do(signature, has_receiver, f);
 928       }
 929     }
 930   }
 931 
 932   InterpreterFrameClosure blk(this, max_locals, m-&gt;max_stack(), f);
 933 
 934   // process locals &amp; expression stack
 935   InterpreterOopMap mask;
 936   if (query_oop_map_cache) {
 937     m-&gt;mask_for(bci, &amp;mask);
 938   } else {
 939     OopMapCache::compute_one_oop_map(m, bci, &amp;mask);
 940   }
 941   mask.iterate_oop(&amp;blk);
 942 }
 943 
 944 
 945 void frame::oops_interpreted_arguments_do(Symbol* signature, bool has_receiver, OopClosure* f) {
 946   InterpretedArgumentOopFinder finder(signature, has_receiver, this, f);
 947   finder.oops_do();
 948 }
 949 
 950 void frame::oops_code_blob_do(OopClosure* f, CodeBlobClosure* cf, const RegisterMap* reg_map) {
 951   assert(_cb != NULL, &quot;sanity check&quot;);
 952   if (_cb-&gt;oop_maps() != NULL) {
 953     OopMapSet::oops_do(this, reg_map, f);
 954 
 955     // Preserve potential arguments for a callee. We handle this by dispatching
 956     // on the codeblob. For c2i, we do
 957     if (reg_map-&gt;include_argument_oops()) {
 958       _cb-&gt;preserve_callee_argument_oops(*this, reg_map, f);
 959     }
 960   }
 961   // In cases where perm gen is collected, GC will want to mark
 962   // oops referenced from nmethods active on thread stacks so as to
 963   // prevent them from being collected. However, this visit should be
 964   // restricted to certain phases of the collection only. The
 965   // closure decides how it wants nmethods to be traced.
 966   if (cf != NULL)
 967     cf-&gt;do_code_blob(_cb);
 968 }
 969 
 970 class CompiledArgumentOopFinder: public SignatureInfo {
 971  protected:
 972   OopClosure*     _f;
 973   int             _offset;        // the current offset, incremented with each argument
 974   bool            _has_receiver;  // true if the callee has a receiver
 975   bool            _has_appendix;  // true if the call has an appendix
 976   frame           _fr;
 977   RegisterMap*    _reg_map;
 978   int             _arg_size;
 979   VMRegPair*      _regs;        // VMReg list of arguments
 980 
 981   void set(int size, BasicType type) {
 982     if (type == T_OBJECT || type == T_ARRAY) handle_oop_offset();
 983     _offset += size;
 984   }
 985 
 986   virtual void handle_oop_offset() {
 987     // Extract low order register number from register array.
 988     // In LP64-land, the high-order bits are valid but unhelpful.
 989     VMReg reg = _regs[_offset].first();
 990     oop *loc = _fr.oopmapreg_to_location(reg, _reg_map);
 991     _f-&gt;do_oop(loc);
 992   }
 993 
 994  public:
 995   CompiledArgumentOopFinder(Symbol* signature, bool has_receiver, bool has_appendix, OopClosure* f, frame fr,  const RegisterMap* reg_map)
 996     : SignatureInfo(signature) {
 997 
 998     // initialize CompiledArgumentOopFinder
 999     _f         = f;
1000     _offset    = 0;
1001     _has_receiver = has_receiver;
1002     _has_appendix = has_appendix;
1003     _fr        = fr;
1004     _reg_map   = (RegisterMap*)reg_map;
1005     _arg_size  = ArgumentSizeComputer(signature).size() + (has_receiver ? 1 : 0) + (has_appendix ? 1 : 0);
1006 
1007     int arg_size;
1008     _regs = SharedRuntime::find_callee_arguments(signature, has_receiver, has_appendix, &amp;arg_size);
1009     assert(arg_size == _arg_size, &quot;wrong arg size&quot;);
1010   }
1011 
1012   void oops_do() {
1013     if (_has_receiver) {
1014       handle_oop_offset();
1015       _offset++;
1016     }
1017     iterate_parameters();
1018     if (_has_appendix) {
1019       handle_oop_offset();
1020       _offset++;
1021     }
1022   }
1023 };
1024 
1025 void frame::oops_compiled_arguments_do(Symbol* signature, bool has_receiver, bool has_appendix,
1026                                        const RegisterMap* reg_map, OopClosure* f) {
1027   ResourceMark rm;
1028   CompiledArgumentOopFinder finder(signature, has_receiver, has_appendix, f, *this, reg_map);
1029   finder.oops_do();
1030 }
1031 
1032 
1033 // Get receiver out of callers frame, i.e. find parameter 0 in callers
1034 // frame.  Consult ADLC for where parameter 0 is to be found.  Then
1035 // check local reg_map for it being a callee-save register or argument
1036 // register, both of which are saved in the local frame.  If not found
1037 // there, it must be an in-stack argument of the caller.
1038 // Note: caller.sp() points to callee-arguments
1039 oop frame::retrieve_receiver(RegisterMap* reg_map) {
1040   frame caller = *this;
1041 
1042   // First consult the ADLC on where it puts parameter 0 for this signature.
1043   VMReg reg = SharedRuntime::name_for_receiver();
1044   oop* oop_adr = caller.oopmapreg_to_location(reg, reg_map);
1045   if (oop_adr == NULL) {
1046     guarantee(oop_adr != NULL, &quot;bad register save location&quot;);
1047     return NULL;
1048   }
1049   oop r = *oop_adr;
1050   assert(Universe::heap()-&gt;is_in_or_null(r), &quot;bad receiver: &quot; INTPTR_FORMAT &quot; (&quot; INTX_FORMAT &quot;)&quot;, p2i(r), p2i(r));
1051   return r;
1052 }
1053 
1054 
1055 BasicLock* frame::get_native_monitor() {
1056   nmethod* nm = (nmethod*)_cb;
1057   assert(_cb != NULL &amp;&amp; _cb-&gt;is_nmethod() &amp;&amp; nm-&gt;method()-&gt;is_native(),
1058          &quot;Should not call this unless it&#39;s a native nmethod&quot;);
1059   int byte_offset = in_bytes(nm-&gt;native_basic_lock_sp_offset());
1060   assert(byte_offset &gt;= 0, &quot;should not see invalid offset&quot;);
1061   return (BasicLock*) &amp;sp()[byte_offset / wordSize];
1062 }
1063 
1064 oop frame::get_native_receiver() {
1065   nmethod* nm = (nmethod*)_cb;
1066   assert(_cb != NULL &amp;&amp; _cb-&gt;is_nmethod() &amp;&amp; nm-&gt;method()-&gt;is_native(),
1067          &quot;Should not call this unless it&#39;s a native nmethod&quot;);
1068   int byte_offset = in_bytes(nm-&gt;native_receiver_sp_offset());
1069   assert(byte_offset &gt;= 0, &quot;should not see invalid offset&quot;);
1070   oop owner = ((oop*) sp())[byte_offset / wordSize];
1071   assert( Universe::heap()-&gt;is_in(owner), &quot;bad receiver&quot; );
1072   return owner;
1073 }
1074 
1075 void frame::oops_entry_do(OopClosure* f, const RegisterMap* map) {
1076   assert(map != NULL, &quot;map must be set&quot;);
1077   if (map-&gt;include_argument_oops()) {
1078     // must collect argument oops, as nobody else is doing it
1079     Thread *thread = Thread::current();
1080     methodHandle m (thread, entry_frame_call_wrapper()-&gt;callee_method());
1081     EntryFrameOopFinder finder(this, m-&gt;signature(), m-&gt;is_static());
1082     finder.arguments_do(f);
1083   }
1084   // Traverse the Handle Block saved in the entry frame
1085   entry_frame_call_wrapper()-&gt;oops_do(f);
1086 }
1087 
1088 
1089 void frame::oops_do_internal(OopClosure* f, CodeBlobClosure* cf, RegisterMap* map, bool use_interpreter_oop_map_cache) {
1090 #ifndef PRODUCT
1091 #if defined(__SUNPRO_CC) &amp;&amp; __SUNPRO_CC &gt;= 0x5140
1092 #pragma error_messages(off, SEC_NULL_PTR_DEREF)
1093 #endif
1094   // simulate GC crash here to dump java thread in error report
1095   if (CrashGCForDumpingJavaThread) {
1096     char *t = NULL;
1097     *t = &#39;c&#39;;
1098   }
1099 #endif
1100   if (is_interpreted_frame()) {
1101     oops_interpreted_do(f, map, use_interpreter_oop_map_cache);
1102   } else if (is_entry_frame()) {
1103     oops_entry_do(f, map);
1104   } else if (CodeCache::contains(pc())) {
1105     oops_code_blob_do(f, cf, map);
1106   } else {
1107     ShouldNotReachHere();
1108   }
1109 }
1110 
1111 void frame::nmethods_do(CodeBlobClosure* cf) {
1112   if (_cb != NULL &amp;&amp; _cb-&gt;is_nmethod()) {
1113     cf-&gt;do_code_blob(_cb);
1114   }
1115 }
1116 
1117 
1118 // call f() on the interpreted Method*s in the stack.
1119 // Have to walk the entire code cache for the compiled frames Yuck.
1120 void frame::metadata_do(void f(Metadata*)) {
1121   if (is_interpreted_frame()) {
1122     Method* m = this-&gt;interpreter_frame_method();
1123     assert(m != NULL, &quot;expecting a method in this frame&quot;);
1124     f(m);
1125   }
1126 }
1127 
1128 void frame::verify(const RegisterMap* map) {
1129   // for now make sure receiver type is correct
1130   if (is_interpreted_frame()) {
1131     Method* method = interpreter_frame_method();
1132     guarantee(method-&gt;is_method(), &quot;method is wrong in frame::verify&quot;);
1133     if (!method-&gt;is_static()) {
1134       // fetch the receiver
1135       oop* p = (oop*) interpreter_frame_local_at(0);
1136       // make sure we have the right receiver type
1137     }
1138   }
1139 #if COMPILER2_OR_JVMCI
1140   assert(DerivedPointerTable::is_empty(), &quot;must be empty before verify&quot;);
1141 #endif
1142   oops_do_internal(&amp;VerifyOopClosure::verify_oop, NULL, (RegisterMap*)map, false);
1143 }
1144 
1145 
1146 #ifdef ASSERT
1147 bool frame::verify_return_pc(address x) {
1148   if (StubRoutines::returns_to_call_stub(x)) {
1149     return true;
1150   }
1151   if (CodeCache::contains(x)) {
1152     return true;
1153   }
1154   if (Interpreter::contains(x)) {
1155     return true;
1156   }
1157   return false;
1158 }
1159 #endif
1160 
1161 #ifdef ASSERT
1162 void frame::interpreter_frame_verify_monitor(BasicObjectLock* value) const {
1163   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
1164   // verify that the value is in the right part of the frame
1165   address low_mark  = (address) interpreter_frame_monitor_end();
1166   address high_mark = (address) interpreter_frame_monitor_begin();
1167   address current   = (address) value;
1168 
1169   const int monitor_size = frame::interpreter_frame_monitor_size();
1170   guarantee((high_mark - current) % monitor_size  ==  0         , &quot;Misaligned top of BasicObjectLock*&quot;);
1171   guarantee( high_mark &gt; current                                , &quot;Current BasicObjectLock* higher than high_mark&quot;);
1172 
1173   guarantee((current - low_mark) % monitor_size  ==  0         , &quot;Misaligned bottom of BasicObjectLock*&quot;);
1174   guarantee( current &gt;= low_mark                               , &quot;Current BasicObjectLock* below than low_mark&quot;);
1175 }
1176 #endif
1177 
1178 #ifndef PRODUCT
1179 void frame::describe(FrameValues&amp; values, int frame_no) {
1180   // boundaries: sp and the &#39;real&#39; frame pointer
1181   values.describe(-1, sp(), err_msg(&quot;sp for #%d&quot;, frame_no), 1);
1182   intptr_t* frame_pointer = real_fp(); // Note: may differ from fp()
1183 
1184   // print frame info at the highest boundary
1185   intptr_t* info_address = MAX2(sp(), frame_pointer);
1186 
1187   if (info_address != frame_pointer) {
1188     // print frame_pointer explicitly if not marked by the frame info
1189     values.describe(-1, frame_pointer, err_msg(&quot;frame pointer for #%d&quot;, frame_no), 1);
1190   }
1191 
1192   if (is_entry_frame() || is_compiled_frame() || is_interpreted_frame() || is_native_frame()) {
1193     // Label values common to most frames
1194     values.describe(-1, unextended_sp(), err_msg(&quot;unextended_sp for #%d&quot;, frame_no));
1195   }
1196 
1197   if (is_interpreted_frame()) {
1198     Method* m = interpreter_frame_method();
1199     int bci = interpreter_frame_bci();
1200 
1201     // Label the method and current bci
1202     values.describe(-1, info_address,
1203                     FormatBuffer&lt;1024&gt;(&quot;#%d method %s @ %d&quot;, frame_no, m-&gt;name_and_sig_as_C_string(), bci), 2);
1204     values.describe(-1, info_address,
1205                     err_msg(&quot;- %d locals %d max stack&quot;, m-&gt;max_locals(), m-&gt;max_stack()), 1);
1206     if (m-&gt;max_locals() &gt; 0) {
1207       intptr_t* l0 = interpreter_frame_local_at(0);
1208       intptr_t* ln = interpreter_frame_local_at(m-&gt;max_locals() - 1);
1209       values.describe(-1, MAX2(l0, ln), err_msg(&quot;locals for #%d&quot;, frame_no), 1);
1210       // Report each local and mark as owned by this frame
1211       for (int l = 0; l &lt; m-&gt;max_locals(); l++) {
1212         intptr_t* l0 = interpreter_frame_local_at(l);
1213         values.describe(frame_no, l0, err_msg(&quot;local %d&quot;, l));
1214       }
1215     }
1216 
1217     // Compute the actual expression stack size
1218     InterpreterOopMap mask;
1219     OopMapCache::compute_one_oop_map(m, bci, &amp;mask);
1220     intptr_t* tos = NULL;
1221     // Report each stack element and mark as owned by this frame
1222     for (int e = 0; e &lt; mask.expression_stack_size(); e++) {
1223       tos = MAX2(tos, interpreter_frame_expression_stack_at(e));
1224       values.describe(frame_no, interpreter_frame_expression_stack_at(e),
1225                       err_msg(&quot;stack %d&quot;, e));
1226     }
1227     if (tos != NULL) {
1228       values.describe(-1, tos, err_msg(&quot;expression stack for #%d&quot;, frame_no), 1);
1229     }
1230     if (interpreter_frame_monitor_begin() != interpreter_frame_monitor_end()) {
1231       values.describe(frame_no, (intptr_t*)interpreter_frame_monitor_begin(), &quot;monitors begin&quot;);
1232       values.describe(frame_no, (intptr_t*)interpreter_frame_monitor_end(), &quot;monitors end&quot;);
1233     }
1234   } else if (is_entry_frame()) {
1235     // For now just label the frame
1236     values.describe(-1, info_address, err_msg(&quot;#%d entry frame&quot;, frame_no), 2);
1237   } else if (is_compiled_frame()) {
1238     // For now just label the frame
1239     CompiledMethod* cm = (CompiledMethod*)cb();
1240     values.describe(-1, info_address,
1241                     FormatBuffer&lt;1024&gt;(&quot;#%d nmethod &quot; INTPTR_FORMAT &quot; for method %s%s%s&quot;, frame_no,
1242                                        p2i(cm),
1243                                        (cm-&gt;is_aot() ? &quot;A &quot;: &quot;J &quot;),
1244                                        cm-&gt;method()-&gt;name_and_sig_as_C_string(),
1245                                        (_deopt_state == is_deoptimized) ?
1246                                        &quot; (deoptimized)&quot; :
1247                                        ((_deopt_state == unknown) ? &quot; (state unknown)&quot; : &quot;&quot;)),
1248                     2);
1249   } else if (is_native_frame()) {
1250     // For now just label the frame
1251     nmethod* nm = cb()-&gt;as_nmethod_or_null();
1252     values.describe(-1, info_address,
1253                     FormatBuffer&lt;1024&gt;(&quot;#%d nmethod &quot; INTPTR_FORMAT &quot; for native method %s&quot;, frame_no,
1254                                        p2i(nm), nm-&gt;method()-&gt;name_and_sig_as_C_string()), 2);
1255   } else {
1256     // provide default info if not handled before
1257     char *info = (char *) &quot;special frame&quot;;
1258     if ((_cb != NULL) &amp;&amp;
1259         (_cb-&gt;name() != NULL)) {
1260       info = (char *)_cb-&gt;name();
1261     }
1262     values.describe(-1, info_address, err_msg(&quot;#%d &lt;%s&gt;&quot;, frame_no, info), 2);
1263   }
1264 
1265   // platform dependent additional data
1266   describe_pd(values, frame_no);
1267 }
1268 
1269 #endif
1270 
1271 
1272 //-----------------------------------------------------------------------------------
1273 // StackFrameStream implementation
1274 
1275 StackFrameStream::StackFrameStream(JavaThread *thread, bool update) : _reg_map(thread, update) {
1276   assert(thread-&gt;has_last_Java_frame(), &quot;sanity check&quot;);
1277   _fr = thread-&gt;last_frame();
1278   _is_done = false;
1279 }
1280 
1281 
1282 #ifndef PRODUCT
1283 
1284 void FrameValues::describe(int owner, intptr_t* location, const char* description, int priority) {
1285   FrameValue fv;
1286   fv.location = location;
1287   fv.owner = owner;
1288   fv.priority = priority;
1289   fv.description = NEW_RESOURCE_ARRAY(char, strlen(description) + 1);
1290   strcpy(fv.description, description);
1291   _values.append(fv);
1292 }
1293 
1294 
1295 #ifdef ASSERT
1296 void FrameValues::validate() {
1297   _values.sort(compare);
1298   bool error = false;
1299   FrameValue prev;
1300   prev.owner = -1;
1301   for (int i = _values.length() - 1; i &gt;= 0; i--) {
1302     FrameValue fv = _values.at(i);
1303     if (fv.owner == -1) continue;
1304     if (prev.owner == -1) {
1305       prev = fv;
1306       continue;
1307     }
1308     if (prev.location == fv.location) {
1309       if (fv.owner != prev.owner) {
1310         tty-&gt;print_cr(&quot;overlapping storage&quot;);
1311         tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(prev.location), *prev.location, prev.description);
1312         tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(fv.location), *fv.location, fv.description);
1313         error = true;
1314       }
1315     } else {
1316       prev = fv;
1317     }
1318   }
1319   assert(!error, &quot;invalid layout&quot;);
1320 }
1321 #endif // ASSERT
1322 
1323 void FrameValues::print(JavaThread* thread) {
1324   _values.sort(compare);
1325 
1326   // Sometimes values like the fp can be invalid values if the
1327   // register map wasn&#39;t updated during the walk.  Trim out values
1328   // that aren&#39;t actually in the stack of the thread.
1329   int min_index = 0;
1330   int max_index = _values.length() - 1;
1331   intptr_t* v0 = _values.at(min_index).location;
1332   intptr_t* v1 = _values.at(max_index).location;
1333 
1334   if (thread == Thread::current()) {
1335     while (!thread-&gt;is_in_stack((address)v0)) {
1336       v0 = _values.at(++min_index).location;
1337     }
1338     while (!thread-&gt;is_in_stack((address)v1)) {
1339       v1 = _values.at(--max_index).location;
1340     }
1341   } else {
1342     while (!thread-&gt;on_local_stack((address)v0)) {
1343       v0 = _values.at(++min_index).location;
1344     }
1345     while (!thread-&gt;on_local_stack((address)v1)) {
1346       v1 = _values.at(--max_index).location;
1347     }
1348   }
1349   intptr_t* min = MIN2(v0, v1);
1350   intptr_t* max = MAX2(v0, v1);
1351   intptr_t* cur = max;
1352   intptr_t* last = NULL;
1353   for (int i = max_index; i &gt;= min_index; i--) {
1354     FrameValue fv = _values.at(i);
1355     while (cur &gt; fv.location) {
1356       tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT, p2i(cur), *cur);
1357       cur--;
1358     }
1359     if (last == fv.location) {
1360       const char* spacer = &quot;          &quot; LP64_ONLY(&quot;        &quot;);
1361       tty-&gt;print_cr(&quot; %s  %s %s&quot;, spacer, spacer, fv.description);
1362     } else {
1363       tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(fv.location), *fv.location, fv.description);
1364       last = fv.location;
1365       cur--;
1366     }
1367   }
1368 }
1369 
1370 #endif // ndef PRODUCT
    </pre>
  </body>
</html>