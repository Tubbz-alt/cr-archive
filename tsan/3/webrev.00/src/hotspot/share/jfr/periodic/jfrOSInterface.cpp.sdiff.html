<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jfr/periodic/jfrOSInterface.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="jfrNetworkUtilization.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrOSInterface.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/periodic/jfrOSInterface.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 50 
 51 JfrOSInterface* JfrOSInterface::create() {
 52   assert(_instance == NULL, &quot;invariant&quot;);
 53   _instance = new JfrOSInterface();
 54   return _instance;
 55 }
 56 
 57 void JfrOSInterface::destroy() {
 58   JfrNetworkUtilization::destroy();
 59   if (_instance != NULL) {
 60     delete _instance;
 61     _instance = NULL;
 62   }
 63 }
 64 
 65 class JfrOSInterface::JfrOSInterfaceImpl : public JfrCHeapObj {
 66   friend class JfrOSInterface;
 67  private:
 68   CPUInformationInterface* _cpu_info_interface;
 69   CPUPerformanceInterface* _cpu_perf_interface;
<span class="line-modified"> 70   SystemProcessInterface*  _system_process_interface;</span>
 71   NetworkPerformanceInterface* _network_performance_interface;
 72 





 73   JfrOSInterfaceImpl();
 74   bool initialize();
 75   ~JfrOSInterfaceImpl();
 76 
 77   // cpu info
 78   int cpu_information(CPUInformation&amp; cpu_info);
 79   int cpu_load(int which_logical_cpu, double* cpu_load);
 80   int context_switch_rate(double* rate);
 81   int cpu_load_total_process(double* cpu_load);
 82   int cpu_loads_process(double* pjvmUserLoad, double* pjvmKernelLoad, double* psystemTotal);
 83 
 84   // os information
 85   int os_version(char** os_version) const;
 86 
 87   // environment information
 88   void generate_environment_variables_events();
 89 
 90    // system processes information
 91   int system_processes(SystemProcess** system_processes, int* no_of_sys_processes);
 92 
<span class="line-modified"> 93   int network_utilization(NetworkInterface** network_interfaces) const;</span>
 94 };
 95 
 96 JfrOSInterface::JfrOSInterfaceImpl::JfrOSInterfaceImpl() : _cpu_info_interface(NULL),
 97                                                            _cpu_perf_interface(NULL),
<span class="line-modified"> 98                                                            _system_process_interface(NULL) {}</span>














 99 
<span class="line-modified">100 bool JfrOSInterface::JfrOSInterfaceImpl::initialize() {</span>
<span class="line-modified">101   _cpu_info_interface = new CPUInformationInterface();</span>
<span class="line-modified">102   if (!(_cpu_info_interface != NULL &amp;&amp; _cpu_info_interface-&gt;initialize())) {</span>
<span class="line-modified">103     return false;</span>






104   }
<span class="line-modified">105   _cpu_perf_interface = new CPUPerformanceInterface();</span>
<span class="line-modified">106   if (!(_cpu_perf_interface != NULL &amp;&amp; _cpu_perf_interface-&gt;initialize())) {</span>
<span class="line-modified">107     return false;</span>



108   }
<span class="line-modified">109   _system_process_interface = new SystemProcessInterface();</span>
<span class="line-modified">110   if (!(_system_process_interface != NULL &amp;&amp; _system_process_interface-&gt;initialize())) {</span>
<span class="line-modified">111     return false;</span>



112   }
<span class="line-modified">113   _network_performance_interface = new NetworkPerformanceInterface();</span>
<span class="line-modified">114   return _network_performance_interface != NULL &amp;&amp; _network_performance_interface-&gt;initialize();</span>



115 }
116 
117 JfrOSInterface::JfrOSInterfaceImpl::~JfrOSInterfaceImpl(void) {
118   if (_cpu_info_interface != NULL) {
119     delete _cpu_info_interface;
120     _cpu_info_interface = NULL;
121   }
122   if (_cpu_perf_interface != NULL) {
123     delete _cpu_perf_interface;
124     _cpu_perf_interface = NULL;
125   }
126   if (_system_process_interface != NULL) {
127     delete _system_process_interface;
128     _system_process_interface = NULL;
129   }
130   if (_network_performance_interface != NULL) {
131     delete _network_performance_interface;
132     _network_performance_interface = NULL;
133   }
134 }
135 





136 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load(int which_logical_cpu, double* cpu_load) {
<span class="line-modified">137   return _cpu_perf_interface-&gt;cpu_load(which_logical_cpu, cpu_load);</span>

138 }
139 
140 int JfrOSInterface::JfrOSInterfaceImpl::context_switch_rate(double* rate) {
<span class="line-modified">141   return _cpu_perf_interface-&gt;context_switch_rate(rate);</span>

142 }
143 
144 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load_total_process(double* cpu_load) {
<span class="line-modified">145   return _cpu_perf_interface-&gt;cpu_load_total_process(cpu_load);</span>

146 }
147 
148 int JfrOSInterface::JfrOSInterfaceImpl::cpu_loads_process(double* pjvmUserLoad,
149                                                           double* pjvmKernelLoad,
150                                                           double* psystemTotal) {
<span class="line-modified">151   return _cpu_perf_interface-&gt;cpu_loads_process(pjvmUserLoad, pjvmKernelLoad, psystemTotal);</span>
<span class="line-modified">152 }</span>
<span class="line-removed">153 </span>
<span class="line-removed">154 int JfrOSInterface::JfrOSInterfaceImpl::cpu_information(CPUInformation&amp; cpu_info) {</span>
<span class="line-removed">155   return _cpu_info_interface-&gt;cpu_information(cpu_info);</span>
156 }
157 
158 int JfrOSInterface::JfrOSInterfaceImpl::system_processes(SystemProcess** system_processes, int* no_of_sys_processes) {
159   assert(system_processes != NULL, &quot;system_processes pointer is NULL!&quot;);
160   assert(no_of_sys_processes != NULL, &quot;no_of_sys_processes pointer is NULL!&quot;);
<span class="line-modified">161   return _system_process_interface-&gt;system_processes(system_processes, no_of_sys_processes);</span>

162 }
163 
<span class="line-modified">164 int JfrOSInterface::JfrOSInterfaceImpl::network_utilization(NetworkInterface** network_interfaces) const {</span>
<span class="line-modified">165   return _network_performance_interface-&gt;network_utilization(network_interfaces);</span>

166 }
167 
168 // assigned char* is RESOURCE_HEAP_ALLOCATED
169 // caller need to ensure proper ResourceMark placement.
170 int JfrOSInterface::JfrOSInterfaceImpl::os_version(char** os_version) const {
171   assert(os_version != NULL, &quot;os_version pointer is NULL!&quot;);
172   stringStream os_ver_info;
173   os::print_os_info_brief(&amp;os_ver_info);
174   *os_version = os_ver_info.as_string();
175   return OS_OK;
176 }
177 
178 JfrOSInterface::JfrOSInterface() {
179   _impl = NULL;
180 }
181 
182 bool JfrOSInterface::initialize() {
183   _impl = new JfrOSInterface::JfrOSInterfaceImpl();
184   return _impl != NULL &amp;&amp; _impl-&gt;initialize();
185 }
</pre>
<hr />
<pre>
198 int JfrOSInterface::cpu_load(int which_logical_cpu, double* cpu_load) {
199   return instance()._impl-&gt;cpu_load(which_logical_cpu, cpu_load);
200 }
201 
202 int JfrOSInterface::context_switch_rate(double* rate) {
203   return instance()._impl-&gt;context_switch_rate(rate);
204 }
205 
206 int JfrOSInterface::cpu_load_total_process(double* cpu_load) {
207   return instance()._impl-&gt;cpu_load_total_process(cpu_load);
208 }
209 
210 int JfrOSInterface::cpu_loads_process(double* jvm_user_load, double* jvm_kernel_load, double* system_total_load){
211   return instance()._impl-&gt;cpu_loads_process(jvm_user_load, jvm_kernel_load, system_total_load);
212 }
213 
214 int JfrOSInterface::os_version(char** os_version) {
215   return instance()._impl-&gt;os_version(os_version);
216 }
217 





















218 int JfrOSInterface::generate_initial_environment_variable_events() {
219   if (environ == NULL) {
220     return OS_ERR;
221   }
222 
223   if (EventInitialEnvironmentVariable::is_enabled()) {
224     // One time stamp for all events, so they can be grouped together
225     JfrTicks time_stamp = JfrTicks::now();
226     for (char** p = environ; *p != NULL; p++) {
227       char* variable = *p;
228       char* equal_sign = strchr(variable, &#39;=&#39;);
229       if (equal_sign != NULL) {
230         // Extract key/value
231         ResourceMark rm;
232         ptrdiff_t key_length = equal_sign - variable;
233         char* key = NEW_RESOURCE_ARRAY(char, key_length + 1);
234         char* value = equal_sign + 1;
235         strncpy(key, variable, key_length);
236         key[key_length] = &#39;\0&#39;;
237         EventInitialEnvironmentVariable event(UNTIMED);
</pre>
</td>
<td>
<hr />
<pre>
 50 
 51 JfrOSInterface* JfrOSInterface::create() {
 52   assert(_instance == NULL, &quot;invariant&quot;);
 53   _instance = new JfrOSInterface();
 54   return _instance;
 55 }
 56 
 57 void JfrOSInterface::destroy() {
 58   JfrNetworkUtilization::destroy();
 59   if (_instance != NULL) {
 60     delete _instance;
 61     _instance = NULL;
 62   }
 63 }
 64 
 65 class JfrOSInterface::JfrOSInterfaceImpl : public JfrCHeapObj {
 66   friend class JfrOSInterface;
 67  private:
 68   CPUInformationInterface* _cpu_info_interface;
 69   CPUPerformanceInterface* _cpu_perf_interface;
<span class="line-modified"> 70   SystemProcessInterface* _system_process_interface;</span>
 71   NetworkPerformanceInterface* _network_performance_interface;
 72 
<span class="line-added"> 73   CPUInformationInterface* cpu_info_interface();</span>
<span class="line-added"> 74   CPUPerformanceInterface* cpu_perf_interface();</span>
<span class="line-added"> 75   SystemProcessInterface* system_process_interface();</span>
<span class="line-added"> 76   NetworkPerformanceInterface* network_performance_interface();</span>
<span class="line-added"> 77 </span>
 78   JfrOSInterfaceImpl();
 79   bool initialize();
 80   ~JfrOSInterfaceImpl();
 81 
 82   // cpu info
 83   int cpu_information(CPUInformation&amp; cpu_info);
 84   int cpu_load(int which_logical_cpu, double* cpu_load);
 85   int context_switch_rate(double* rate);
 86   int cpu_load_total_process(double* cpu_load);
 87   int cpu_loads_process(double* pjvmUserLoad, double* pjvmKernelLoad, double* psystemTotal);
 88 
 89   // os information
 90   int os_version(char** os_version) const;
 91 
 92   // environment information
 93   void generate_environment_variables_events();
 94 
 95    // system processes information
 96   int system_processes(SystemProcess** system_processes, int* no_of_sys_processes);
 97 
<span class="line-modified"> 98   int network_utilization(NetworkInterface** network_interfaces);</span>
 99 };
100 
101 JfrOSInterface::JfrOSInterfaceImpl::JfrOSInterfaceImpl() : _cpu_info_interface(NULL),
102                                                            _cpu_perf_interface(NULL),
<span class="line-modified">103                                                            _system_process_interface(NULL),</span>
<span class="line-added">104                                                            _network_performance_interface(NULL) {}</span>
<span class="line-added">105 </span>
<span class="line-added">106 template &lt;typename T&gt;</span>
<span class="line-added">107 static T* create_interface() {</span>
<span class="line-added">108   ResourceMark rm;</span>
<span class="line-added">109   T* iface = new T();</span>
<span class="line-added">110   if (iface != NULL) {</span>
<span class="line-added">111     if (!iface-&gt;initialize()) {</span>
<span class="line-added">112       delete iface;</span>
<span class="line-added">113       iface = NULL;</span>
<span class="line-added">114     }</span>
<span class="line-added">115   }</span>
<span class="line-added">116   return iface;</span>
<span class="line-added">117 }</span>
118 
<span class="line-modified">119 CPUInformationInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_info_interface() {</span>
<span class="line-modified">120   if (_cpu_info_interface == NULL) {</span>
<span class="line-modified">121     _cpu_info_interface = create_interface&lt;CPUInformationInterface&gt;();</span>
<span class="line-modified">122   }</span>
<span class="line-added">123   return _cpu_info_interface;</span>
<span class="line-added">124 }</span>
<span class="line-added">125 </span>
<span class="line-added">126 CPUPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_perf_interface() {</span>
<span class="line-added">127   if (_cpu_perf_interface == NULL) {</span>
<span class="line-added">128     _cpu_perf_interface = create_interface&lt;CPUPerformanceInterface&gt;();</span>
129   }
<span class="line-modified">130   return _cpu_perf_interface;</span>
<span class="line-modified">131 }</span>
<span class="line-modified">132 </span>
<span class="line-added">133 SystemProcessInterface* JfrOSInterface::JfrOSInterfaceImpl::system_process_interface() {</span>
<span class="line-added">134   if (_system_process_interface == NULL) {</span>
<span class="line-added">135     _system_process_interface = create_interface&lt;SystemProcessInterface&gt;();</span>
136   }
<span class="line-modified">137   return _system_process_interface;</span>
<span class="line-modified">138 }</span>
<span class="line-modified">139 </span>
<span class="line-added">140 NetworkPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::network_performance_interface() {</span>
<span class="line-added">141   if (_network_performance_interface == NULL) {</span>
<span class="line-added">142     _network_performance_interface = create_interface&lt;NetworkPerformanceInterface&gt;();</span>
143   }
<span class="line-modified">144   return _network_performance_interface;</span>
<span class="line-modified">145 }</span>
<span class="line-added">146 </span>
<span class="line-added">147 bool JfrOSInterface::JfrOSInterfaceImpl::initialize() {</span>
<span class="line-added">148   return true;</span>
149 }
150 
151 JfrOSInterface::JfrOSInterfaceImpl::~JfrOSInterfaceImpl(void) {
152   if (_cpu_info_interface != NULL) {
153     delete _cpu_info_interface;
154     _cpu_info_interface = NULL;
155   }
156   if (_cpu_perf_interface != NULL) {
157     delete _cpu_perf_interface;
158     _cpu_perf_interface = NULL;
159   }
160   if (_system_process_interface != NULL) {
161     delete _system_process_interface;
162     _system_process_interface = NULL;
163   }
164   if (_network_performance_interface != NULL) {
165     delete _network_performance_interface;
166     _network_performance_interface = NULL;
167   }
168 }
169 
<span class="line-added">170 int JfrOSInterface::JfrOSInterfaceImpl::cpu_information(CPUInformation&amp; cpu_info) {</span>
<span class="line-added">171   CPUInformationInterface* const iface = cpu_info_interface();</span>
<span class="line-added">172   return iface == NULL ? OS_ERR : iface-&gt;cpu_information(cpu_info);</span>
<span class="line-added">173 }</span>
<span class="line-added">174 </span>
175 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load(int which_logical_cpu, double* cpu_load) {
<span class="line-modified">176   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">177   return iface == NULL ? OS_ERR : iface-&gt;cpu_load(which_logical_cpu, cpu_load);</span>
178 }
179 
180 int JfrOSInterface::JfrOSInterfaceImpl::context_switch_rate(double* rate) {
<span class="line-modified">181   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">182   return iface == NULL ? OS_ERR : iface-&gt;context_switch_rate(rate);</span>
183 }
184 
185 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load_total_process(double* cpu_load) {
<span class="line-modified">186   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">187   return iface == NULL ? OS_ERR : iface-&gt;cpu_load_total_process(cpu_load);</span>
188 }
189 
190 int JfrOSInterface::JfrOSInterfaceImpl::cpu_loads_process(double* pjvmUserLoad,
191                                                           double* pjvmKernelLoad,
192                                                           double* psystemTotal) {
<span class="line-modified">193   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-modified">194   return iface == NULL ? OS_ERR : iface-&gt;cpu_loads_process(pjvmUserLoad, pjvmKernelLoad, psystemTotal);</span>



195 }
196 
197 int JfrOSInterface::JfrOSInterfaceImpl::system_processes(SystemProcess** system_processes, int* no_of_sys_processes) {
198   assert(system_processes != NULL, &quot;system_processes pointer is NULL!&quot;);
199   assert(no_of_sys_processes != NULL, &quot;no_of_sys_processes pointer is NULL!&quot;);
<span class="line-modified">200   SystemProcessInterface* const iface = system_process_interface();</span>
<span class="line-added">201   return iface == NULL ? OS_ERR : iface-&gt;system_processes(system_processes, no_of_sys_processes);</span>
202 }
203 
<span class="line-modified">204 int JfrOSInterface::JfrOSInterfaceImpl::network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="line-modified">205   NetworkPerformanceInterface* const iface = network_performance_interface();</span>
<span class="line-added">206   return iface == NULL ? OS_ERR : iface-&gt;network_utilization(network_interfaces);</span>
207 }
208 
209 // assigned char* is RESOURCE_HEAP_ALLOCATED
210 // caller need to ensure proper ResourceMark placement.
211 int JfrOSInterface::JfrOSInterfaceImpl::os_version(char** os_version) const {
212   assert(os_version != NULL, &quot;os_version pointer is NULL!&quot;);
213   stringStream os_ver_info;
214   os::print_os_info_brief(&amp;os_ver_info);
215   *os_version = os_ver_info.as_string();
216   return OS_OK;
217 }
218 
219 JfrOSInterface::JfrOSInterface() {
220   _impl = NULL;
221 }
222 
223 bool JfrOSInterface::initialize() {
224   _impl = new JfrOSInterface::JfrOSInterfaceImpl();
225   return _impl != NULL &amp;&amp; _impl-&gt;initialize();
226 }
</pre>
<hr />
<pre>
239 int JfrOSInterface::cpu_load(int which_logical_cpu, double* cpu_load) {
240   return instance()._impl-&gt;cpu_load(which_logical_cpu, cpu_load);
241 }
242 
243 int JfrOSInterface::context_switch_rate(double* rate) {
244   return instance()._impl-&gt;context_switch_rate(rate);
245 }
246 
247 int JfrOSInterface::cpu_load_total_process(double* cpu_load) {
248   return instance()._impl-&gt;cpu_load_total_process(cpu_load);
249 }
250 
251 int JfrOSInterface::cpu_loads_process(double* jvm_user_load, double* jvm_kernel_load, double* system_total_load){
252   return instance()._impl-&gt;cpu_loads_process(jvm_user_load, jvm_kernel_load, system_total_load);
253 }
254 
255 int JfrOSInterface::os_version(char** os_version) {
256   return instance()._impl-&gt;os_version(os_version);
257 }
258 
<span class="line-added">259 const char* JfrOSInterface::virtualization_name() {</span>
<span class="line-added">260   VirtualizationType vrt = VM_Version::get_detected_virtualization();</span>
<span class="line-added">261   if (vrt == XenHVM) {</span>
<span class="line-added">262     return &quot;Xen hardware-assisted virtualization&quot;;</span>
<span class="line-added">263   } else if (vrt == KVM) {</span>
<span class="line-added">264     return &quot;KVM virtualization&quot;;</span>
<span class="line-added">265   } else if (vrt == VMWare) {</span>
<span class="line-added">266     return &quot;VMWare virtualization&quot;;</span>
<span class="line-added">267   } else if (vrt == HyperV) {</span>
<span class="line-added">268     return &quot;HyperV virtualization&quot;;</span>
<span class="line-added">269   } else if (vrt == PowerVM) {</span>
<span class="line-added">270     return &quot;PowerVM virtualization&quot;;</span>
<span class="line-added">271   } else if (vrt == PowerKVM) {</span>
<span class="line-added">272     return &quot;Power KVM virtualization&quot;;</span>
<span class="line-added">273   } else if (vrt == PowerFullPartitionMode) {</span>
<span class="line-added">274     return &quot;Power full partition&quot;;</span>
<span class="line-added">275   }</span>
<span class="line-added">276 </span>
<span class="line-added">277   return &quot;No virtualization detected&quot;;</span>
<span class="line-added">278 }</span>
<span class="line-added">279 </span>
280 int JfrOSInterface::generate_initial_environment_variable_events() {
281   if (environ == NULL) {
282     return OS_ERR;
283   }
284 
285   if (EventInitialEnvironmentVariable::is_enabled()) {
286     // One time stamp for all events, so they can be grouped together
287     JfrTicks time_stamp = JfrTicks::now();
288     for (char** p = environ; *p != NULL; p++) {
289       char* variable = *p;
290       char* equal_sign = strchr(variable, &#39;=&#39;);
291       if (equal_sign != NULL) {
292         // Extract key/value
293         ResourceMark rm;
294         ptrdiff_t key_length = equal_sign - variable;
295         char* key = NEW_RESOURCE_ARRAY(char, key_length + 1);
296         char* value = equal_sign + 1;
297         strncpy(key, variable, key_length);
298         key[key_length] = &#39;\0&#39;;
299         EventInitialEnvironmentVariable event(UNTIMED);
</pre>
</td>
</tr>
</table>
<center><a href="jfrNetworkUtilization.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrOSInterface.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>