<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jfr/periodic/jfrPeriodic.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="jfrOSInterface.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrThreadCPULoadEvent.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/periodic/jfrPeriodic.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 28 #include &quot;classfile/classLoaderStats.hpp&quot;
 29 #include &quot;classfile/javaClasses.hpp&quot;



 30 #include &quot;code/codeCache.hpp&quot;
 31 #include &quot;compiler/compileBroker.hpp&quot;
<span class="line-removed"> 32 #include &quot;gc/g1/g1HeapRegionEventSender.hpp&quot;</span>
 33 #include &quot;gc/shared/gcConfiguration.hpp&quot;
 34 #include &quot;gc/shared/gcTrace.hpp&quot;
 35 #include &quot;gc/shared/gcVMOperations.hpp&quot;
 36 #include &quot;gc/shared/objectCountEventSender.hpp&quot;
 37 #include &quot;jfr/jfrEvents.hpp&quot;
 38 #include &quot;jfr/periodic/jfrModuleEvent.hpp&quot;
 39 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 40 #include &quot;jfr/periodic/jfrThreadCPULoadEvent.hpp&quot;
 41 #include &quot;jfr/periodic/jfrThreadDumpEvent.hpp&quot;
 42 #include &quot;jfr/periodic/jfrNetworkUtilization.hpp&quot;
 43 #include &quot;jfr/recorder/jfrRecorder.hpp&quot;
 44 #include &quot;jfr/support/jfrThreadId.hpp&quot;

 45 #include &quot;jfr/utilities/jfrTime.hpp&quot;
 46 #include &quot;jfrfiles/jfrPeriodic.hpp&quot;
 47 #include &quot;logging/log.hpp&quot;
 48 #include &quot;memory/heapInspection.hpp&quot;
 49 #include &quot;memory/resourceArea.hpp&quot;
 50 #include &quot;oops/oop.inline.hpp&quot;
 51 #include &quot;runtime/arguments.hpp&quot;
 52 #include &quot;runtime/flags/jvmFlag.hpp&quot;
 53 #include &quot;runtime/globals.hpp&quot;
 54 #include &quot;runtime/os.hpp&quot;
 55 #include &quot;runtime/os_perf.hpp&quot;
 56 #include &quot;runtime/thread.inline.hpp&quot;
<span class="line-removed"> 57 #include &quot;runtime/threadSMR.hpp&quot;</span>
 58 #include &quot;runtime/sweeper.hpp&quot;
 59 #include &quot;runtime/vmThread.hpp&quot;
 60 #include &quot;services/classLoadingService.hpp&quot;
 61 #include &quot;services/management.hpp&quot;
 62 #include &quot;services/threadService.hpp&quot;
 63 #include &quot;utilities/exceptions.hpp&quot;
 64 #include &quot;utilities/globalDefinitions.hpp&quot;
<span class="line-modified"> 65 </span>





 66 /**
 67  *  JfrPeriodic class
 68  *  Implementation of declarations in
 69  *  xsl generated traceRequestables.hpp
 70  */
 71 #define TRACE_REQUEST_FUNC(id)    void JfrPeriodicEventSet::request##id(void)
 72 
 73 TRACE_REQUEST_FUNC(JVMInformation) {
 74   ResourceMark rm;
 75   EventJVMInformation event;
 76   event.set_jvmName(VM_Version::vm_name());
 77   event.set_jvmVersion(VM_Version::internal_vm_info_string());
 78   event.set_javaArguments(Arguments::java_command());
 79   event.set_jvmArguments(Arguments::jvm_args());
 80   event.set_jvmFlags(Arguments::jvm_flags());
 81   event.set_jvmStartTime(Management::vm_init_done_time());
 82   event.set_pid(os::current_process_id());
 83   event.commit();
 84  }
 85 
 86 TRACE_REQUEST_FUNC(OSInformation) {
 87   ResourceMark rm;
 88   char* os_name = NEW_RESOURCE_ARRAY(char, 2048);
 89   JfrOSInterface::os_version(&amp;os_name);
 90   EventOSInformation event;
 91   event.set_osVersion(os_name);
 92   event.commit();
 93 }
 94 






 95 TRACE_REQUEST_FUNC(ModuleRequire) {
 96   JfrModuleEvent::generate_module_dependency_events();
 97 }
 98 
 99 TRACE_REQUEST_FUNC(ModuleExport) {
100   JfrModuleEvent::generate_module_export_events();
101 }
102 
103 /*
104  * This is left empty on purpose, having ExecutionSample as a requestable
105  * is a way of getting the period. The period is passed to ThreadSampling::update_period.
106  * Implementation in jfrSamples.cpp
107  */
108 TRACE_REQUEST_FUNC(ExecutionSample) {
109 }
110 TRACE_REQUEST_FUNC(NativeMethodSample) {
111 }
112 
113 TRACE_REQUEST_FUNC(ThreadDump) {
114   ResourceMark rm;
</pre>
<hr />
<pre>
295 
296 TRACE_REQUEST_FUNC(StringFlag) {
297   SEND_FLAGS_OF_TYPE(StringFlag, ccstr);
298 }
299 
300 class VM_GC_SendObjectCountEvent : public VM_GC_HeapInspection {
301  public:
302   VM_GC_SendObjectCountEvent() : VM_GC_HeapInspection(NULL, true) {}
303   virtual void doit() {
304     ObjectCountEventSender::enable_requestable_event();
305     collect();
306     ObjectCountEventSender::disable_requestable_event();
307   }
308 };
309 
310 TRACE_REQUEST_FUNC(ObjectCount) {
311   VM_GC_SendObjectCountEvent op;
312   VMThread::execute(&amp;op);
313 }
314 
<span class="line-removed">315 class VM_G1SendHeapRegionInfoEvents : public VM_Operation {</span>
<span class="line-removed">316   virtual void doit() {</span>
<span class="line-removed">317     G1HeapRegionEventSender::send_events();</span>
<span class="line-removed">318   }</span>
<span class="line-removed">319   virtual VMOp_Type type() const { return VMOp_HeapIterateOperation; }</span>
<span class="line-removed">320 };</span>
<span class="line-removed">321 </span>
322 TRACE_REQUEST_FUNC(G1HeapRegionInformation) {
<span class="line-modified">323   if (UseG1GC) {</span>
<span class="line-removed">324     VM_G1SendHeapRegionInfoEvents op;</span>
<span class="line-removed">325     VMThread::execute(&amp;op);</span>
<span class="line-removed">326   }</span>
327 }
328 
329 // Java Mission Control (JMC) uses (Java) Long.MIN_VALUE to describe that a
330 // long value is undefined.
331 static jlong jmc_undefined_long = min_jlong;
332 
333 TRACE_REQUEST_FUNC(GCConfiguration) {
334   GCConfiguration conf;
335   jlong pause_target = conf.has_pause_target_default_value() ? jmc_undefined_long : conf.pause_target();
336   EventGCConfiguration event;
337   event.set_youngCollector(conf.young_collector());
338   event.set_oldCollector(conf.old_collector());
339   event.set_parallelGCThreads(conf.num_parallel_gc_threads());
340   event.set_concurrentGCThreads(conf.num_concurrent_gc_threads());
341   event.set_usesDynamicGCThreads(conf.uses_dynamic_gc_threads());
342   event.set_isExplicitGCConcurrent(conf.is_explicit_gc_concurrent());
343   event.set_isExplicitGCDisabled(conf.is_explicit_gc_disabled());
344   event.set_gcTimeRatio(conf.gc_time_ratio());
345   event.set_pauseTarget((s8)pause_target);
346   event.commit();
</pre>
<hr />
<pre>
390   SystemProperty* p = Arguments::system_properties();
391   JfrTicks time_stamp = JfrTicks::now();
392   while (p !=  NULL) {
393     if (!p-&gt;internal()) {
394       EventInitialSystemProperty event(UNTIMED);
395       event.set_key(p-&gt;key());
396       event.set_value(p-&gt;value());
397       event.set_endtime(time_stamp);
398       event.commit();
399     }
400     p = p-&gt;next();
401   }
402 }
403 
404 TRACE_REQUEST_FUNC(ThreadAllocationStatistics) {
405   ResourceMark rm;
406   int initial_size = Threads::number_of_threads();
407   GrowableArray&lt;jlong&gt; allocated(initial_size);
408   GrowableArray&lt;traceid&gt; thread_ids(initial_size);
409   JfrTicks time_stamp = JfrTicks::now();
<span class="line-modified">410   {</span>
<span class="line-modified">411     // Collect allocation statistics while holding threads lock</span>
<span class="line-modified">412     MutexLockerEx ml(Threads_lock);</span>
<span class="line-modified">413     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {</span>
<span class="line-modified">414       allocated.append(jt-&gt;cooked_allocated_bytes());</span>
<span class="line-modified">415       thread_ids.append(JFR_THREAD_ID(jt));</span>
<span class="line-removed">416     }</span>
417   }
418 
419   // Write allocation statistics to buffer.
420   for(int i = 0; i &lt; thread_ids.length(); i++) {
421     EventThreadAllocationStatistics event(UNTIMED);
422     event.set_allocated(allocated.at(i));
423     event.set_thread(thread_ids.at(i));
424     event.set_endtime(time_stamp);
425     event.commit();
426   }
427 }
428 
429 /**
430  *  PhysicalMemory event represents:
431  *
432  *  @totalSize == The amount of physical memory (hw) installed and reported by the OS, in bytes.
433  *  @usedSize  == The amount of physical memory currently in use in the system (reserved/committed), in bytes.
434  *
435  *  Both fields are systemwide, i.e. represents the entire OS/HW environment.
436  *  These fields do not include virtual memory.
</pre>
<hr />
<pre>
489     _stats-&gt;iterate(this);
490   }
491 };
492 
493 class JfrClassLoaderStatsVMOperation : public ClassLoaderStatsVMOperation {
494  public:
495   JfrClassLoaderStatsVMOperation() : ClassLoaderStatsVMOperation(NULL) { }
496 
497   void doit() {
498     JfrClassLoaderStatsClosure clsc;
499     ClassLoaderDataGraph::loaded_cld_do(&amp;clsc);
500     clsc.createEvents();
501   }
502 };
503 
504 TRACE_REQUEST_FUNC(ClassLoaderStatistics) {
505   JfrClassLoaderStatsVMOperation op;
506   VMThread::execute(&amp;op);
507 }
508 








































509 TRACE_REQUEST_FUNC(CompilerStatistics) {
510   EventCompilerStatistics event;
511   event.set_compileCount(CompileBroker::get_total_compile_count());
512   event.set_bailoutCount(CompileBroker::get_total_bailout_count());
513   event.set_invalidatedCount(CompileBroker::get_total_invalidated_count());
514   event.set_osrCompileCount(CompileBroker::get_total_osr_compile_count());
515   event.set_standardCompileCount(CompileBroker::get_total_standard_compile_count());
516   event.set_osrBytesCompiled(CompileBroker::get_sum_osr_bytes_compiled());
517   event.set_standardBytesCompiled(CompileBroker::get_sum_standard_bytes_compiled());
<span class="line-modified">518   event.set_nmetodsSize(CompileBroker::get_sum_nmethod_size());</span>
<span class="line-modified">519   event.set_nmetodCodeSize(CompileBroker::get_sum_nmethod_code_size());</span>
520   event.set_peakTimeSpent(CompileBroker::get_peak_compilation_time());
521   event.set_totalTimeSpent(CompileBroker::get_total_compilation_time());
522   event.commit();
523 }
524 
525 TRACE_REQUEST_FUNC(CompilerConfiguration) {
526   EventCompilerConfiguration event;
527   event.set_threadCount(CICompilerCount);
528   event.set_tieredCompilation(TieredCompilation);
529   event.commit();
530 }
531 
532 TRACE_REQUEST_FUNC(CodeCacheStatistics) {
533   // Emit stats for all available code heaps
534   for (int bt = 0; bt &lt; CodeBlobType::NumTypes; ++bt) {
535     if (CodeCache::heap_available(bt)) {
536       EventCodeCacheStatistics event;
537       event.set_codeBlobType((u1)bt);
538       event.set_startAddress((u8)CodeCache::low_bound(bt));
539       event.set_reservedTopAddress((u8)CodeCache::high_bound(bt));
</pre>
<hr />
<pre>
560   event.set_reservedTopAddress((u8)CodeCache::high_bound());
561   event.commit();
562 }
563 
564 TRACE_REQUEST_FUNC(CodeSweeperStatistics) {
565   EventCodeSweeperStatistics event;
566   event.set_sweepCount(NMethodSweeper::traversal_count());
567   event.set_methodReclaimedCount(NMethodSweeper::total_nof_methods_reclaimed());
568   event.set_totalSweepTime(NMethodSweeper::total_time_sweeping());
569   event.set_peakFractionTime(NMethodSweeper::peak_sweep_fraction_time());
570   event.set_peakSweepTime(NMethodSweeper::peak_sweep_time());
571   event.commit();
572 }
573 
574 TRACE_REQUEST_FUNC(CodeSweeperConfiguration) {
575   EventCodeSweeperConfiguration event;
576   event.set_sweeperEnabled(MethodFlushing);
577   event.set_flushingEnabled(UseCodeCacheFlushing);
578   event.commit();
579 }











</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 28 #include &quot;classfile/classLoaderStats.hpp&quot;
 29 #include &quot;classfile/javaClasses.hpp&quot;
<span class="line-added"> 30 #include &quot;classfile/stringTable.hpp&quot;</span>
<span class="line-added"> 31 #include &quot;classfile/symbolTable.hpp&quot;</span>
<span class="line-added"> 32 #include &quot;classfile/systemDictionary.hpp&quot;</span>
 33 #include &quot;code/codeCache.hpp&quot;
 34 #include &quot;compiler/compileBroker.hpp&quot;

 35 #include &quot;gc/shared/gcConfiguration.hpp&quot;
 36 #include &quot;gc/shared/gcTrace.hpp&quot;
 37 #include &quot;gc/shared/gcVMOperations.hpp&quot;
 38 #include &quot;gc/shared/objectCountEventSender.hpp&quot;
 39 #include &quot;jfr/jfrEvents.hpp&quot;
 40 #include &quot;jfr/periodic/jfrModuleEvent.hpp&quot;
 41 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 42 #include &quot;jfr/periodic/jfrThreadCPULoadEvent.hpp&quot;
 43 #include &quot;jfr/periodic/jfrThreadDumpEvent.hpp&quot;
 44 #include &quot;jfr/periodic/jfrNetworkUtilization.hpp&quot;
 45 #include &quot;jfr/recorder/jfrRecorder.hpp&quot;
 46 #include &quot;jfr/support/jfrThreadId.hpp&quot;
<span class="line-added"> 47 #include &quot;jfr/utilities/jfrThreadIterator.hpp&quot;</span>
 48 #include &quot;jfr/utilities/jfrTime.hpp&quot;
 49 #include &quot;jfrfiles/jfrPeriodic.hpp&quot;
 50 #include &quot;logging/log.hpp&quot;
 51 #include &quot;memory/heapInspection.hpp&quot;
 52 #include &quot;memory/resourceArea.hpp&quot;
 53 #include &quot;oops/oop.inline.hpp&quot;
 54 #include &quot;runtime/arguments.hpp&quot;
 55 #include &quot;runtime/flags/jvmFlag.hpp&quot;
 56 #include &quot;runtime/globals.hpp&quot;
 57 #include &quot;runtime/os.hpp&quot;
 58 #include &quot;runtime/os_perf.hpp&quot;
 59 #include &quot;runtime/thread.inline.hpp&quot;

 60 #include &quot;runtime/sweeper.hpp&quot;
 61 #include &quot;runtime/vmThread.hpp&quot;
 62 #include &quot;services/classLoadingService.hpp&quot;
 63 #include &quot;services/management.hpp&quot;
 64 #include &quot;services/threadService.hpp&quot;
 65 #include &quot;utilities/exceptions.hpp&quot;
 66 #include &quot;utilities/globalDefinitions.hpp&quot;
<span class="line-modified"> 67 #if INCLUDE_G1GC</span>
<span class="line-added"> 68 #include &quot;gc/g1/g1HeapRegionEventSender.hpp&quot;</span>
<span class="line-added"> 69 #endif</span>
<span class="line-added"> 70 #if INCLUDE_SHENANDOAHGC</span>
<span class="line-added"> 71 #include &quot;gc/shenandoah/shenandoahJfrSupport.hpp&quot;</span>
<span class="line-added"> 72 #endif</span>
 73 /**
 74  *  JfrPeriodic class
 75  *  Implementation of declarations in
 76  *  xsl generated traceRequestables.hpp
 77  */
 78 #define TRACE_REQUEST_FUNC(id)    void JfrPeriodicEventSet::request##id(void)
 79 
 80 TRACE_REQUEST_FUNC(JVMInformation) {
 81   ResourceMark rm;
 82   EventJVMInformation event;
 83   event.set_jvmName(VM_Version::vm_name());
 84   event.set_jvmVersion(VM_Version::internal_vm_info_string());
 85   event.set_javaArguments(Arguments::java_command());
 86   event.set_jvmArguments(Arguments::jvm_args());
 87   event.set_jvmFlags(Arguments::jvm_flags());
 88   event.set_jvmStartTime(Management::vm_init_done_time());
 89   event.set_pid(os::current_process_id());
 90   event.commit();
 91  }
 92 
 93 TRACE_REQUEST_FUNC(OSInformation) {
 94   ResourceMark rm;
 95   char* os_name = NEW_RESOURCE_ARRAY(char, 2048);
 96   JfrOSInterface::os_version(&amp;os_name);
 97   EventOSInformation event;
 98   event.set_osVersion(os_name);
 99   event.commit();
100 }
101 
<span class="line-added">102 TRACE_REQUEST_FUNC(VirtualizationInformation) {</span>
<span class="line-added">103   EventVirtualizationInformation event;</span>
<span class="line-added">104   event.set_name(JfrOSInterface::virtualization_name());</span>
<span class="line-added">105   event.commit();</span>
<span class="line-added">106 }</span>
<span class="line-added">107 </span>
108 TRACE_REQUEST_FUNC(ModuleRequire) {
109   JfrModuleEvent::generate_module_dependency_events();
110 }
111 
112 TRACE_REQUEST_FUNC(ModuleExport) {
113   JfrModuleEvent::generate_module_export_events();
114 }
115 
116 /*
117  * This is left empty on purpose, having ExecutionSample as a requestable
118  * is a way of getting the period. The period is passed to ThreadSampling::update_period.
119  * Implementation in jfrSamples.cpp
120  */
121 TRACE_REQUEST_FUNC(ExecutionSample) {
122 }
123 TRACE_REQUEST_FUNC(NativeMethodSample) {
124 }
125 
126 TRACE_REQUEST_FUNC(ThreadDump) {
127   ResourceMark rm;
</pre>
<hr />
<pre>
308 
309 TRACE_REQUEST_FUNC(StringFlag) {
310   SEND_FLAGS_OF_TYPE(StringFlag, ccstr);
311 }
312 
313 class VM_GC_SendObjectCountEvent : public VM_GC_HeapInspection {
314  public:
315   VM_GC_SendObjectCountEvent() : VM_GC_HeapInspection(NULL, true) {}
316   virtual void doit() {
317     ObjectCountEventSender::enable_requestable_event();
318     collect();
319     ObjectCountEventSender::disable_requestable_event();
320   }
321 };
322 
323 TRACE_REQUEST_FUNC(ObjectCount) {
324   VM_GC_SendObjectCountEvent op;
325   VMThread::execute(&amp;op);
326 }
327 







328 TRACE_REQUEST_FUNC(G1HeapRegionInformation) {
<span class="line-modified">329   G1GC_ONLY(G1HeapRegionEventSender::send_events());</span>



330 }
331 
332 // Java Mission Control (JMC) uses (Java) Long.MIN_VALUE to describe that a
333 // long value is undefined.
334 static jlong jmc_undefined_long = min_jlong;
335 
336 TRACE_REQUEST_FUNC(GCConfiguration) {
337   GCConfiguration conf;
338   jlong pause_target = conf.has_pause_target_default_value() ? jmc_undefined_long : conf.pause_target();
339   EventGCConfiguration event;
340   event.set_youngCollector(conf.young_collector());
341   event.set_oldCollector(conf.old_collector());
342   event.set_parallelGCThreads(conf.num_parallel_gc_threads());
343   event.set_concurrentGCThreads(conf.num_concurrent_gc_threads());
344   event.set_usesDynamicGCThreads(conf.uses_dynamic_gc_threads());
345   event.set_isExplicitGCConcurrent(conf.is_explicit_gc_concurrent());
346   event.set_isExplicitGCDisabled(conf.is_explicit_gc_disabled());
347   event.set_gcTimeRatio(conf.gc_time_ratio());
348   event.set_pauseTarget((s8)pause_target);
349   event.commit();
</pre>
<hr />
<pre>
393   SystemProperty* p = Arguments::system_properties();
394   JfrTicks time_stamp = JfrTicks::now();
395   while (p !=  NULL) {
396     if (!p-&gt;internal()) {
397       EventInitialSystemProperty event(UNTIMED);
398       event.set_key(p-&gt;key());
399       event.set_value(p-&gt;value());
400       event.set_endtime(time_stamp);
401       event.commit();
402     }
403     p = p-&gt;next();
404   }
405 }
406 
407 TRACE_REQUEST_FUNC(ThreadAllocationStatistics) {
408   ResourceMark rm;
409   int initial_size = Threads::number_of_threads();
410   GrowableArray&lt;jlong&gt; allocated(initial_size);
411   GrowableArray&lt;traceid&gt; thread_ids(initial_size);
412   JfrTicks time_stamp = JfrTicks::now();
<span class="line-modified">413   JfrJavaThreadIterator iter;</span>
<span class="line-modified">414   while (iter.has_next()) {</span>
<span class="line-modified">415     JavaThread* const jt = iter.next();</span>
<span class="line-modified">416     assert(jt != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">417     allocated.append(jt-&gt;cooked_allocated_bytes());</span>
<span class="line-modified">418     thread_ids.append(JFR_THREAD_ID(jt));</span>

419   }
420 
421   // Write allocation statistics to buffer.
422   for(int i = 0; i &lt; thread_ids.length(); i++) {
423     EventThreadAllocationStatistics event(UNTIMED);
424     event.set_allocated(allocated.at(i));
425     event.set_thread(thread_ids.at(i));
426     event.set_endtime(time_stamp);
427     event.commit();
428   }
429 }
430 
431 /**
432  *  PhysicalMemory event represents:
433  *
434  *  @totalSize == The amount of physical memory (hw) installed and reported by the OS, in bytes.
435  *  @usedSize  == The amount of physical memory currently in use in the system (reserved/committed), in bytes.
436  *
437  *  Both fields are systemwide, i.e. represents the entire OS/HW environment.
438  *  These fields do not include virtual memory.
</pre>
<hr />
<pre>
491     _stats-&gt;iterate(this);
492   }
493 };
494 
495 class JfrClassLoaderStatsVMOperation : public ClassLoaderStatsVMOperation {
496  public:
497   JfrClassLoaderStatsVMOperation() : ClassLoaderStatsVMOperation(NULL) { }
498 
499   void doit() {
500     JfrClassLoaderStatsClosure clsc;
501     ClassLoaderDataGraph::loaded_cld_do(&amp;clsc);
502     clsc.createEvents();
503   }
504 };
505 
506 TRACE_REQUEST_FUNC(ClassLoaderStatistics) {
507   JfrClassLoaderStatsVMOperation op;
508   VMThread::execute(&amp;op);
509 }
510 
<span class="line-added">511 template&lt;typename EVENT&gt;</span>
<span class="line-added">512 static void emit_table_statistics(TableStatistics statistics) {</span>
<span class="line-added">513   EVENT event;</span>
<span class="line-added">514   event.set_bucketCount(statistics._number_of_buckets);</span>
<span class="line-added">515   event.set_entryCount(statistics._number_of_entries);</span>
<span class="line-added">516   event.set_totalFootprint(statistics._total_footprint);</span>
<span class="line-added">517   event.set_bucketCountMaximum(statistics._maximum_bucket_size);</span>
<span class="line-added">518   event.set_bucketCountAverage(statistics._average_bucket_size);</span>
<span class="line-added">519   event.set_bucketCountVariance(statistics._variance_of_bucket_size);</span>
<span class="line-added">520   event.set_bucketCountStandardDeviation(statistics._stddev_of_bucket_size);</span>
<span class="line-added">521   event.set_insertionRate(statistics._add_rate);</span>
<span class="line-added">522   event.set_removalRate(statistics._remove_rate);</span>
<span class="line-added">523   event.commit();</span>
<span class="line-added">524 }</span>
<span class="line-added">525 </span>
<span class="line-added">526 TRACE_REQUEST_FUNC(SymbolTableStatistics) {</span>
<span class="line-added">527   TableStatistics statistics = SymbolTable::get_table_statistics();</span>
<span class="line-added">528   emit_table_statistics&lt;EventSymbolTableStatistics&gt;(statistics);</span>
<span class="line-added">529 }</span>
<span class="line-added">530 </span>
<span class="line-added">531 TRACE_REQUEST_FUNC(StringTableStatistics) {</span>
<span class="line-added">532   TableStatistics statistics = StringTable::get_table_statistics();</span>
<span class="line-added">533   emit_table_statistics&lt;EventStringTableStatistics&gt;(statistics);</span>
<span class="line-added">534 }</span>
<span class="line-added">535 </span>
<span class="line-added">536 TRACE_REQUEST_FUNC(PlaceholderTableStatistics) {</span>
<span class="line-added">537   TableStatistics statistics = SystemDictionary::placeholders_statistics();</span>
<span class="line-added">538   emit_table_statistics&lt;EventPlaceholderTableStatistics&gt;(statistics);</span>
<span class="line-added">539 }</span>
<span class="line-added">540 </span>
<span class="line-added">541 TRACE_REQUEST_FUNC(LoaderConstraintsTableStatistics) {</span>
<span class="line-added">542   TableStatistics statistics = SystemDictionary::loader_constraints_statistics();</span>
<span class="line-added">543   emit_table_statistics&lt;EventLoaderConstraintsTableStatistics&gt;(statistics);</span>
<span class="line-added">544 }</span>
<span class="line-added">545 </span>
<span class="line-added">546 TRACE_REQUEST_FUNC(ProtectionDomainCacheTableStatistics) {</span>
<span class="line-added">547   TableStatistics statistics = SystemDictionary::protection_domain_cache_statistics();</span>
<span class="line-added">548   emit_table_statistics&lt;EventProtectionDomainCacheTableStatistics&gt;(statistics);</span>
<span class="line-added">549 }</span>
<span class="line-added">550 </span>
551 TRACE_REQUEST_FUNC(CompilerStatistics) {
552   EventCompilerStatistics event;
553   event.set_compileCount(CompileBroker::get_total_compile_count());
554   event.set_bailoutCount(CompileBroker::get_total_bailout_count());
555   event.set_invalidatedCount(CompileBroker::get_total_invalidated_count());
556   event.set_osrCompileCount(CompileBroker::get_total_osr_compile_count());
557   event.set_standardCompileCount(CompileBroker::get_total_standard_compile_count());
558   event.set_osrBytesCompiled(CompileBroker::get_sum_osr_bytes_compiled());
559   event.set_standardBytesCompiled(CompileBroker::get_sum_standard_bytes_compiled());
<span class="line-modified">560   event.set_nmethodsSize(CompileBroker::get_sum_nmethod_size());</span>
<span class="line-modified">561   event.set_nmethodCodeSize(CompileBroker::get_sum_nmethod_code_size());</span>
562   event.set_peakTimeSpent(CompileBroker::get_peak_compilation_time());
563   event.set_totalTimeSpent(CompileBroker::get_total_compilation_time());
564   event.commit();
565 }
566 
567 TRACE_REQUEST_FUNC(CompilerConfiguration) {
568   EventCompilerConfiguration event;
569   event.set_threadCount(CICompilerCount);
570   event.set_tieredCompilation(TieredCompilation);
571   event.commit();
572 }
573 
574 TRACE_REQUEST_FUNC(CodeCacheStatistics) {
575   // Emit stats for all available code heaps
576   for (int bt = 0; bt &lt; CodeBlobType::NumTypes; ++bt) {
577     if (CodeCache::heap_available(bt)) {
578       EventCodeCacheStatistics event;
579       event.set_codeBlobType((u1)bt);
580       event.set_startAddress((u8)CodeCache::low_bound(bt));
581       event.set_reservedTopAddress((u8)CodeCache::high_bound(bt));
</pre>
<hr />
<pre>
602   event.set_reservedTopAddress((u8)CodeCache::high_bound());
603   event.commit();
604 }
605 
606 TRACE_REQUEST_FUNC(CodeSweeperStatistics) {
607   EventCodeSweeperStatistics event;
608   event.set_sweepCount(NMethodSweeper::traversal_count());
609   event.set_methodReclaimedCount(NMethodSweeper::total_nof_methods_reclaimed());
610   event.set_totalSweepTime(NMethodSweeper::total_time_sweeping());
611   event.set_peakFractionTime(NMethodSweeper::peak_sweep_fraction_time());
612   event.set_peakSweepTime(NMethodSweeper::peak_sweep_time());
613   event.commit();
614 }
615 
616 TRACE_REQUEST_FUNC(CodeSweeperConfiguration) {
617   EventCodeSweeperConfiguration event;
618   event.set_sweeperEnabled(MethodFlushing);
619   event.set_flushingEnabled(UseCodeCacheFlushing);
620   event.commit();
621 }
<span class="line-added">622 </span>
<span class="line-added">623 </span>
<span class="line-added">624 TRACE_REQUEST_FUNC(ShenandoahHeapRegionInformation) {</span>
<span class="line-added">625 #if INCLUDE_SHENANDOAHGC</span>
<span class="line-added">626   if (UseShenandoahGC) {</span>
<span class="line-added">627     VM_ShenandoahSendHeapRegionInfoEvents op;</span>
<span class="line-added">628     VMThread::execute(&amp;op);</span>
<span class="line-added">629   }</span>
<span class="line-added">630 #endif</span>
<span class="line-added">631 }</span>
<span class="line-added">632 </span>
</pre>
</td>
</tr>
</table>
<center><a href="jfrOSInterface.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrThreadCPULoadEvent.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>