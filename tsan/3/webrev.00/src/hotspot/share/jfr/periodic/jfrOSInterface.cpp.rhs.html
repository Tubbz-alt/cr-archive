<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jfr/periodic/jfrOSInterface.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jfr/jfrEvents.hpp&quot;
 27 #include &quot;jfr/periodic/jfrNetworkUtilization.hpp&quot;
 28 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 29 #include &quot;memory/allocation.inline.hpp&quot;
 30 #include &quot;memory/resourceArea.hpp&quot;
 31 #include &quot;runtime/os.hpp&quot;
 32 #include &quot;runtime/os_perf.hpp&quot;
 33 #include &quot;utilities/ostream.hpp&quot;
 34 
 35 #include &lt;stdlib.h&gt; // for environment variables
 36 #ifdef __APPLE__
 37 #include &lt;crt_externs.h&gt;
 38 #define environ (*_NSGetEnviron())
 39 #endif
 40 
 41 #ifndef environ
 42 extern char** environ;
 43 #endif
 44 
 45 static JfrOSInterface* _instance = NULL;
 46 
 47 JfrOSInterface&amp; JfrOSInterface::instance() {
 48   return *_instance;
 49 }
 50 
 51 JfrOSInterface* JfrOSInterface::create() {
 52   assert(_instance == NULL, &quot;invariant&quot;);
 53   _instance = new JfrOSInterface();
 54   return _instance;
 55 }
 56 
 57 void JfrOSInterface::destroy() {
 58   JfrNetworkUtilization::destroy();
 59   if (_instance != NULL) {
 60     delete _instance;
 61     _instance = NULL;
 62   }
 63 }
 64 
 65 class JfrOSInterface::JfrOSInterfaceImpl : public JfrCHeapObj {
 66   friend class JfrOSInterface;
 67  private:
 68   CPUInformationInterface* _cpu_info_interface;
 69   CPUPerformanceInterface* _cpu_perf_interface;
<a name="1" id="anc1"></a><span class="line-modified"> 70   SystemProcessInterface* _system_process_interface;</span>
 71   NetworkPerformanceInterface* _network_performance_interface;
 72 
<a name="2" id="anc2"></a><span class="line-added"> 73   CPUInformationInterface* cpu_info_interface();</span>
<span class="line-added"> 74   CPUPerformanceInterface* cpu_perf_interface();</span>
<span class="line-added"> 75   SystemProcessInterface* system_process_interface();</span>
<span class="line-added"> 76   NetworkPerformanceInterface* network_performance_interface();</span>
<span class="line-added"> 77 </span>
 78   JfrOSInterfaceImpl();
 79   bool initialize();
 80   ~JfrOSInterfaceImpl();
 81 
 82   // cpu info
 83   int cpu_information(CPUInformation&amp; cpu_info);
 84   int cpu_load(int which_logical_cpu, double* cpu_load);
 85   int context_switch_rate(double* rate);
 86   int cpu_load_total_process(double* cpu_load);
 87   int cpu_loads_process(double* pjvmUserLoad, double* pjvmKernelLoad, double* psystemTotal);
 88 
 89   // os information
 90   int os_version(char** os_version) const;
 91 
 92   // environment information
 93   void generate_environment_variables_events();
 94 
 95    // system processes information
 96   int system_processes(SystemProcess** system_processes, int* no_of_sys_processes);
 97 
<a name="3" id="anc3"></a><span class="line-modified"> 98   int network_utilization(NetworkInterface** network_interfaces);</span>
 99 };
100 
101 JfrOSInterface::JfrOSInterfaceImpl::JfrOSInterfaceImpl() : _cpu_info_interface(NULL),
102                                                            _cpu_perf_interface(NULL),
<a name="4" id="anc4"></a><span class="line-modified">103                                                            _system_process_interface(NULL),</span>
<span class="line-added">104                                                            _network_performance_interface(NULL) {}</span>
<span class="line-added">105 </span>
<span class="line-added">106 template &lt;typename T&gt;</span>
<span class="line-added">107 static T* create_interface() {</span>
<span class="line-added">108   ResourceMark rm;</span>
<span class="line-added">109   T* iface = new T();</span>
<span class="line-added">110   if (iface != NULL) {</span>
<span class="line-added">111     if (!iface-&gt;initialize()) {</span>
<span class="line-added">112       delete iface;</span>
<span class="line-added">113       iface = NULL;</span>
<span class="line-added">114     }</span>
<span class="line-added">115   }</span>
<span class="line-added">116   return iface;</span>
<span class="line-added">117 }</span>
118 
<a name="5" id="anc5"></a><span class="line-modified">119 CPUInformationInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_info_interface() {</span>
<span class="line-modified">120   if (_cpu_info_interface == NULL) {</span>
<span class="line-modified">121     _cpu_info_interface = create_interface&lt;CPUInformationInterface&gt;();</span>
<span class="line-modified">122   }</span>
<span class="line-added">123   return _cpu_info_interface;</span>
<span class="line-added">124 }</span>
<span class="line-added">125 </span>
<span class="line-added">126 CPUPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_perf_interface() {</span>
<span class="line-added">127   if (_cpu_perf_interface == NULL) {</span>
<span class="line-added">128     _cpu_perf_interface = create_interface&lt;CPUPerformanceInterface&gt;();</span>
129   }
<a name="6" id="anc6"></a><span class="line-modified">130   return _cpu_perf_interface;</span>
<span class="line-modified">131 }</span>
<span class="line-modified">132 </span>
<span class="line-added">133 SystemProcessInterface* JfrOSInterface::JfrOSInterfaceImpl::system_process_interface() {</span>
<span class="line-added">134   if (_system_process_interface == NULL) {</span>
<span class="line-added">135     _system_process_interface = create_interface&lt;SystemProcessInterface&gt;();</span>
136   }
<a name="7" id="anc7"></a><span class="line-modified">137   return _system_process_interface;</span>
<span class="line-modified">138 }</span>
<span class="line-modified">139 </span>
<span class="line-added">140 NetworkPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::network_performance_interface() {</span>
<span class="line-added">141   if (_network_performance_interface == NULL) {</span>
<span class="line-added">142     _network_performance_interface = create_interface&lt;NetworkPerformanceInterface&gt;();</span>
143   }
<a name="8" id="anc8"></a><span class="line-modified">144   return _network_performance_interface;</span>
<span class="line-modified">145 }</span>
<span class="line-added">146 </span>
<span class="line-added">147 bool JfrOSInterface::JfrOSInterfaceImpl::initialize() {</span>
<span class="line-added">148   return true;</span>
149 }
150 
151 JfrOSInterface::JfrOSInterfaceImpl::~JfrOSInterfaceImpl(void) {
152   if (_cpu_info_interface != NULL) {
153     delete _cpu_info_interface;
154     _cpu_info_interface = NULL;
155   }
156   if (_cpu_perf_interface != NULL) {
157     delete _cpu_perf_interface;
158     _cpu_perf_interface = NULL;
159   }
160   if (_system_process_interface != NULL) {
161     delete _system_process_interface;
162     _system_process_interface = NULL;
163   }
164   if (_network_performance_interface != NULL) {
165     delete _network_performance_interface;
166     _network_performance_interface = NULL;
167   }
168 }
169 
<a name="9" id="anc9"></a><span class="line-added">170 int JfrOSInterface::JfrOSInterfaceImpl::cpu_information(CPUInformation&amp; cpu_info) {</span>
<span class="line-added">171   CPUInformationInterface* const iface = cpu_info_interface();</span>
<span class="line-added">172   return iface == NULL ? OS_ERR : iface-&gt;cpu_information(cpu_info);</span>
<span class="line-added">173 }</span>
<span class="line-added">174 </span>
175 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load(int which_logical_cpu, double* cpu_load) {
<a name="10" id="anc10"></a><span class="line-modified">176   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">177   return iface == NULL ? OS_ERR : iface-&gt;cpu_load(which_logical_cpu, cpu_load);</span>
178 }
179 
180 int JfrOSInterface::JfrOSInterfaceImpl::context_switch_rate(double* rate) {
<a name="11" id="anc11"></a><span class="line-modified">181   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">182   return iface == NULL ? OS_ERR : iface-&gt;context_switch_rate(rate);</span>
183 }
184 
185 int JfrOSInterface::JfrOSInterfaceImpl::cpu_load_total_process(double* cpu_load) {
<a name="12" id="anc12"></a><span class="line-modified">186   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">187   return iface == NULL ? OS_ERR : iface-&gt;cpu_load_total_process(cpu_load);</span>
188 }
189 
190 int JfrOSInterface::JfrOSInterfaceImpl::cpu_loads_process(double* pjvmUserLoad,
191                                                           double* pjvmKernelLoad,
192                                                           double* psystemTotal) {
<a name="13" id="anc13"></a><span class="line-modified">193   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-modified">194   return iface == NULL ? OS_ERR : iface-&gt;cpu_loads_process(pjvmUserLoad, pjvmKernelLoad, psystemTotal);</span>



195 }
196 
197 int JfrOSInterface::JfrOSInterfaceImpl::system_processes(SystemProcess** system_processes, int* no_of_sys_processes) {
198   assert(system_processes != NULL, &quot;system_processes pointer is NULL!&quot;);
199   assert(no_of_sys_processes != NULL, &quot;no_of_sys_processes pointer is NULL!&quot;);
<a name="14" id="anc14"></a><span class="line-modified">200   SystemProcessInterface* const iface = system_process_interface();</span>
<span class="line-added">201   return iface == NULL ? OS_ERR : iface-&gt;system_processes(system_processes, no_of_sys_processes);</span>
202 }
203 
<a name="15" id="anc15"></a><span class="line-modified">204 int JfrOSInterface::JfrOSInterfaceImpl::network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="line-modified">205   NetworkPerformanceInterface* const iface = network_performance_interface();</span>
<span class="line-added">206   return iface == NULL ? OS_ERR : iface-&gt;network_utilization(network_interfaces);</span>
207 }
208 
209 // assigned char* is RESOURCE_HEAP_ALLOCATED
210 // caller need to ensure proper ResourceMark placement.
211 int JfrOSInterface::JfrOSInterfaceImpl::os_version(char** os_version) const {
212   assert(os_version != NULL, &quot;os_version pointer is NULL!&quot;);
213   stringStream os_ver_info;
214   os::print_os_info_brief(&amp;os_ver_info);
215   *os_version = os_ver_info.as_string();
216   return OS_OK;
217 }
218 
219 JfrOSInterface::JfrOSInterface() {
220   _impl = NULL;
221 }
222 
223 bool JfrOSInterface::initialize() {
224   _impl = new JfrOSInterface::JfrOSInterfaceImpl();
225   return _impl != NULL &amp;&amp; _impl-&gt;initialize();
226 }
227 
228 JfrOSInterface::~JfrOSInterface() {
229   if (_impl != NULL) {
230     delete _impl;
231     _impl = NULL;
232   }
233 }
234 
235 int JfrOSInterface::cpu_information(CPUInformation&amp; cpu_info) {
236   return instance()._impl-&gt;cpu_information(cpu_info);
237 }
238 
239 int JfrOSInterface::cpu_load(int which_logical_cpu, double* cpu_load) {
240   return instance()._impl-&gt;cpu_load(which_logical_cpu, cpu_load);
241 }
242 
243 int JfrOSInterface::context_switch_rate(double* rate) {
244   return instance()._impl-&gt;context_switch_rate(rate);
245 }
246 
247 int JfrOSInterface::cpu_load_total_process(double* cpu_load) {
248   return instance()._impl-&gt;cpu_load_total_process(cpu_load);
249 }
250 
251 int JfrOSInterface::cpu_loads_process(double* jvm_user_load, double* jvm_kernel_load, double* system_total_load){
252   return instance()._impl-&gt;cpu_loads_process(jvm_user_load, jvm_kernel_load, system_total_load);
253 }
254 
255 int JfrOSInterface::os_version(char** os_version) {
256   return instance()._impl-&gt;os_version(os_version);
257 }
258 
<a name="16" id="anc16"></a><span class="line-added">259 const char* JfrOSInterface::virtualization_name() {</span>
<span class="line-added">260   VirtualizationType vrt = VM_Version::get_detected_virtualization();</span>
<span class="line-added">261   if (vrt == XenHVM) {</span>
<span class="line-added">262     return &quot;Xen hardware-assisted virtualization&quot;;</span>
<span class="line-added">263   } else if (vrt == KVM) {</span>
<span class="line-added">264     return &quot;KVM virtualization&quot;;</span>
<span class="line-added">265   } else if (vrt == VMWare) {</span>
<span class="line-added">266     return &quot;VMWare virtualization&quot;;</span>
<span class="line-added">267   } else if (vrt == HyperV) {</span>
<span class="line-added">268     return &quot;HyperV virtualization&quot;;</span>
<span class="line-added">269   } else if (vrt == PowerVM) {</span>
<span class="line-added">270     return &quot;PowerVM virtualization&quot;;</span>
<span class="line-added">271   } else if (vrt == PowerKVM) {</span>
<span class="line-added">272     return &quot;Power KVM virtualization&quot;;</span>
<span class="line-added">273   } else if (vrt == PowerFullPartitionMode) {</span>
<span class="line-added">274     return &quot;Power full partition&quot;;</span>
<span class="line-added">275   }</span>
<span class="line-added">276 </span>
<span class="line-added">277   return &quot;No virtualization detected&quot;;</span>
<span class="line-added">278 }</span>
<span class="line-added">279 </span>
280 int JfrOSInterface::generate_initial_environment_variable_events() {
281   if (environ == NULL) {
282     return OS_ERR;
283   }
284 
285   if (EventInitialEnvironmentVariable::is_enabled()) {
286     // One time stamp for all events, so they can be grouped together
287     JfrTicks time_stamp = JfrTicks::now();
288     for (char** p = environ; *p != NULL; p++) {
289       char* variable = *p;
290       char* equal_sign = strchr(variable, &#39;=&#39;);
291       if (equal_sign != NULL) {
292         // Extract key/value
293         ResourceMark rm;
294         ptrdiff_t key_length = equal_sign - variable;
295         char* key = NEW_RESOURCE_ARRAY(char, key_length + 1);
296         char* value = equal_sign + 1;
297         strncpy(key, variable, key_length);
298         key[key_length] = &#39;\0&#39;;
299         EventInitialEnvironmentVariable event(UNTIMED);
300         event.set_endtime(time_stamp);
301         event.set_key(key);
302         event.set_value(value);
303         event.commit();
304       }
305     }
306   }
307   return OS_OK;
308 }
309 
310 int JfrOSInterface::system_processes(SystemProcess** sys_processes, int* no_of_sys_processes) {
311   return instance()._impl-&gt;system_processes(sys_processes, no_of_sys_processes);
312 }
313 
314 int JfrOSInterface::network_utilization(NetworkInterface** network_interfaces) {
315   return instance()._impl-&gt;network_utilization(network_interfaces);
316 }
<a name="17" id="anc17"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="17" type="hidden" />
</body>
</html>