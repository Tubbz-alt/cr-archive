<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/periodic/jfrOSInterface.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="jfrNetworkUtilization.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrOSInterface.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/periodic/jfrOSInterface.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 65,13 ***</span>
  class JfrOSInterface::JfrOSInterfaceImpl : public JfrCHeapObj {
    friend class JfrOSInterface;
   private:
    CPUInformationInterface* _cpu_info_interface;
    CPUPerformanceInterface* _cpu_perf_interface;
<span class="line-modified">!   SystemProcessInterface*  _system_process_interface;</span>
    NetworkPerformanceInterface* _network_performance_interface;
  
    JfrOSInterfaceImpl();
    bool initialize();
    ~JfrOSInterfaceImpl();
  
    // cpu info
<span class="line-new-header">--- 65,18 ---</span>
  class JfrOSInterface::JfrOSInterfaceImpl : public JfrCHeapObj {
    friend class JfrOSInterface;
   private:
    CPUInformationInterface* _cpu_info_interface;
    CPUPerformanceInterface* _cpu_perf_interface;
<span class="line-modified">!   SystemProcessInterface* _system_process_interface;</span>
    NetworkPerformanceInterface* _network_performance_interface;
  
<span class="line-added">+   CPUInformationInterface* cpu_info_interface();</span>
<span class="line-added">+   CPUPerformanceInterface* cpu_perf_interface();</span>
<span class="line-added">+   SystemProcessInterface* system_process_interface();</span>
<span class="line-added">+   NetworkPerformanceInterface* network_performance_interface();</span>
<span class="line-added">+ </span>
    JfrOSInterfaceImpl();
    bool initialize();
    ~JfrOSInterfaceImpl();
  
    // cpu info
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,32 ***</span>
    void generate_environment_variables_events();
  
     // system processes information
    int system_processes(SystemProcess** system_processes, int* no_of_sys_processes);
  
<span class="line-modified">!   int network_utilization(NetworkInterface** network_interfaces) const;</span>
  };
  
  JfrOSInterface::JfrOSInterfaceImpl::JfrOSInterfaceImpl() : _cpu_info_interface(NULL),
                                                             _cpu_perf_interface(NULL),
<span class="line-modified">!                                                            _system_process_interface(NULL) {}</span>
  
<span class="line-modified">! bool JfrOSInterface::JfrOSInterfaceImpl::initialize() {</span>
<span class="line-modified">!   _cpu_info_interface = new CPUInformationInterface();</span>
<span class="line-modified">!   if (!(_cpu_info_interface != NULL &amp;&amp; _cpu_info_interface-&gt;initialize())) {</span>
<span class="line-modified">!     return false;</span>
    }
<span class="line-modified">!   _cpu_perf_interface = new CPUPerformanceInterface();</span>
<span class="line-modified">!   if (!(_cpu_perf_interface != NULL &amp;&amp; _cpu_perf_interface-&gt;initialize())) {</span>
<span class="line-modified">!     return false;</span>
    }
<span class="line-modified">!   _system_process_interface = new SystemProcessInterface();</span>
<span class="line-modified">!   if (!(_system_process_interface != NULL &amp;&amp; _system_process_interface-&gt;initialize())) {</span>
<span class="line-modified">!     return false;</span>
    }
<span class="line-modified">!   _network_performance_interface = new NetworkPerformanceInterface();</span>
<span class="line-modified">!   return _network_performance_interface != NULL &amp;&amp; _network_performance_interface-&gt;initialize();</span>
  }
  
  JfrOSInterface::JfrOSInterfaceImpl::~JfrOSInterfaceImpl(void) {
    if (_cpu_info_interface != NULL) {
      delete _cpu_info_interface;
<span class="line-new-header">--- 93,61 ---</span>
    void generate_environment_variables_events();
  
     // system processes information
    int system_processes(SystemProcess** system_processes, int* no_of_sys_processes);
  
<span class="line-modified">!   int network_utilization(NetworkInterface** network_interfaces);</span>
  };
  
  JfrOSInterface::JfrOSInterfaceImpl::JfrOSInterfaceImpl() : _cpu_info_interface(NULL),
                                                             _cpu_perf_interface(NULL),
<span class="line-modified">!                                                            _system_process_interface(NULL),</span>
<span class="line-added">+                                                            _network_performance_interface(NULL) {}</span>
<span class="line-added">+ </span>
<span class="line-added">+ template &lt;typename T&gt;</span>
<span class="line-added">+ static T* create_interface() {</span>
<span class="line-added">+   ResourceMark rm;</span>
<span class="line-added">+   T* iface = new T();</span>
<span class="line-added">+   if (iface != NULL) {</span>
<span class="line-added">+     if (!iface-&gt;initialize()) {</span>
<span class="line-added">+       delete iface;</span>
<span class="line-added">+       iface = NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+   return iface;</span>
<span class="line-added">+ }</span>
  
<span class="line-modified">! CPUInformationInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_info_interface() {</span>
<span class="line-modified">!   if (_cpu_info_interface == NULL) {</span>
<span class="line-modified">!     _cpu_info_interface = create_interface&lt;CPUInformationInterface&gt;();</span>
<span class="line-modified">!   }</span>
<span class="line-added">+   return _cpu_info_interface;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ CPUPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::cpu_perf_interface() {</span>
<span class="line-added">+   if (_cpu_perf_interface == NULL) {</span>
<span class="line-added">+     _cpu_perf_interface = create_interface&lt;CPUPerformanceInterface&gt;();</span>
    }
<span class="line-modified">!   return _cpu_perf_interface;</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-added">+ SystemProcessInterface* JfrOSInterface::JfrOSInterfaceImpl::system_process_interface() {</span>
<span class="line-added">+   if (_system_process_interface == NULL) {</span>
<span class="line-added">+     _system_process_interface = create_interface&lt;SystemProcessInterface&gt;();</span>
    }
<span class="line-modified">!   return _system_process_interface;</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-added">+ NetworkPerformanceInterface* JfrOSInterface::JfrOSInterfaceImpl::network_performance_interface() {</span>
<span class="line-added">+   if (_network_performance_interface == NULL) {</span>
<span class="line-added">+     _network_performance_interface = create_interface&lt;NetworkPerformanceInterface&gt;();</span>
    }
<span class="line-modified">!   return _network_performance_interface;</span>
<span class="line-modified">! }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool JfrOSInterface::JfrOSInterfaceImpl::initialize() {</span>
<span class="line-added">+   return true;</span>
  }
  
  JfrOSInterface::JfrOSInterfaceImpl::~JfrOSInterfaceImpl(void) {
    if (_cpu_info_interface != NULL) {
      delete _cpu_info_interface;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 131,40 ***</span>
      delete _network_performance_interface;
      _network_performance_interface = NULL;
    }
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_load(int which_logical_cpu, double* cpu_load) {
<span class="line-modified">!   return _cpu_perf_interface-&gt;cpu_load(which_logical_cpu, cpu_load);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::context_switch_rate(double* rate) {
<span class="line-modified">!   return _cpu_perf_interface-&gt;context_switch_rate(rate);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_load_total_process(double* cpu_load) {
<span class="line-modified">!   return _cpu_perf_interface-&gt;cpu_load_total_process(cpu_load);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_loads_process(double* pjvmUserLoad,
                                                            double* pjvmKernelLoad,
                                                            double* psystemTotal) {
<span class="line-modified">!   return _cpu_perf_interface-&gt;cpu_loads_process(pjvmUserLoad, pjvmKernelLoad, psystemTotal);</span>
<span class="line-modified">! }</span>
<span class="line-removed">- </span>
<span class="line-removed">- int JfrOSInterface::JfrOSInterfaceImpl::cpu_information(CPUInformation&amp; cpu_info) {</span>
<span class="line-removed">-   return _cpu_info_interface-&gt;cpu_information(cpu_info);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::system_processes(SystemProcess** system_processes, int* no_of_sys_processes) {
    assert(system_processes != NULL, &quot;system_processes pointer is NULL!&quot;);
    assert(no_of_sys_processes != NULL, &quot;no_of_sys_processes pointer is NULL!&quot;);
<span class="line-modified">!   return _system_process_interface-&gt;system_processes(system_processes, no_of_sys_processes);</span>
  }
  
<span class="line-modified">! int JfrOSInterface::JfrOSInterfaceImpl::network_utilization(NetworkInterface** network_interfaces) const {</span>
<span class="line-modified">!   return _network_performance_interface-&gt;network_utilization(network_interfaces);</span>
  }
  
  // assigned char* is RESOURCE_HEAP_ALLOCATED
  // caller need to ensure proper ResourceMark placement.
  int JfrOSInterface::JfrOSInterfaceImpl::os_version(char** os_version) const {
<span class="line-new-header">--- 165,47 ---</span>
      delete _network_performance_interface;
      _network_performance_interface = NULL;
    }
  }
  
<span class="line-added">+ int JfrOSInterface::JfrOSInterfaceImpl::cpu_information(CPUInformation&amp; cpu_info) {</span>
<span class="line-added">+   CPUInformationInterface* const iface = cpu_info_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;cpu_information(cpu_info);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_load(int which_logical_cpu, double* cpu_load) {
<span class="line-modified">!   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;cpu_load(which_logical_cpu, cpu_load);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::context_switch_rate(double* rate) {
<span class="line-modified">!   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;context_switch_rate(rate);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_load_total_process(double* cpu_load) {
<span class="line-modified">!   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;cpu_load_total_process(cpu_load);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::cpu_loads_process(double* pjvmUserLoad,
                                                            double* pjvmKernelLoad,
                                                            double* psystemTotal) {
<span class="line-modified">!   CPUPerformanceInterface* const iface = cpu_perf_interface();</span>
<span class="line-modified">!   return iface == NULL ? OS_ERR : iface-&gt;cpu_loads_process(pjvmUserLoad, pjvmKernelLoad, psystemTotal);</span>
  }
  
  int JfrOSInterface::JfrOSInterfaceImpl::system_processes(SystemProcess** system_processes, int* no_of_sys_processes) {
    assert(system_processes != NULL, &quot;system_processes pointer is NULL!&quot;);
    assert(no_of_sys_processes != NULL, &quot;no_of_sys_processes pointer is NULL!&quot;);
<span class="line-modified">!   SystemProcessInterface* const iface = system_process_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;system_processes(system_processes, no_of_sys_processes);</span>
  }
  
<span class="line-modified">! int JfrOSInterface::JfrOSInterfaceImpl::network_utilization(NetworkInterface** network_interfaces) {</span>
<span class="line-modified">!   NetworkPerformanceInterface* const iface = network_performance_interface();</span>
<span class="line-added">+   return iface == NULL ? OS_ERR : iface-&gt;network_utilization(network_interfaces);</span>
  }
  
  // assigned char* is RESOURCE_HEAP_ALLOCATED
  // caller need to ensure proper ResourceMark placement.
  int JfrOSInterface::JfrOSInterfaceImpl::os_version(char** os_version) const {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 213,10 ***</span>
<span class="line-new-header">--- 254,31 ---</span>
  
  int JfrOSInterface::os_version(char** os_version) {
    return instance()._impl-&gt;os_version(os_version);
  }
  
<span class="line-added">+ const char* JfrOSInterface::virtualization_name() {</span>
<span class="line-added">+   VirtualizationType vrt = VM_Version::get_detected_virtualization();</span>
<span class="line-added">+   if (vrt == XenHVM) {</span>
<span class="line-added">+     return &quot;Xen hardware-assisted virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == KVM) {</span>
<span class="line-added">+     return &quot;KVM virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == VMWare) {</span>
<span class="line-added">+     return &quot;VMWare virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == HyperV) {</span>
<span class="line-added">+     return &quot;HyperV virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == PowerVM) {</span>
<span class="line-added">+     return &quot;PowerVM virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == PowerKVM) {</span>
<span class="line-added">+     return &quot;Power KVM virtualization&quot;;</span>
<span class="line-added">+   } else if (vrt == PowerFullPartitionMode) {</span>
<span class="line-added">+     return &quot;Power full partition&quot;;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   return &quot;No virtualization detected&quot;;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  int JfrOSInterface::generate_initial_environment_variable_events() {
    if (environ == NULL) {
      return OS_ERR;
    }
  
</pre>
<center><a href="jfrNetworkUtilization.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrOSInterface.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>