<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jfr/recorder/storage/jfrStorage.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre> 1 /*
 2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  *
23  */
24 #ifndef SHARE_JFR_RECORDER_STORAGE_JFRSTORAGE_HPP
25 #define SHARE_JFR_RECORDER_STORAGE_JFRSTORAGE_HPP
26 
27 #include &quot;jfr/recorder/storage/jfrBuffer.hpp&quot;
28 #include &quot;jfr/recorder/storage/jfrMemorySpace.hpp&quot;
29 #include &quot;jfr/recorder/storage/jfrMemorySpaceRetrieval.hpp&quot;
30 
31 class JfrChunkWriter;
32 class JfrPostBox;
33 class JfrStorage;
34 class JfrStorageControl;
35 
36 typedef JfrMemorySpace&lt;JfrBuffer, JfrMspaceAlternatingRetrieval, JfrStorage&gt; JfrStorageMspace;
37 typedef JfrMemorySpace&lt;JfrBuffer, JfrThreadLocalRetrieval, JfrStorage&gt; JfrThreadLocalMspace;
38 typedef JfrMemorySpace&lt;JfrAgeNode, JfrMspaceSequentialRetrieval, JfrStorage&gt; JfrStorageAgeMspace;
39 
40 //
41 // Responsible for providing backing storage for writing events.
42 //
43 class JfrStorage : public JfrCHeapObj {
44  public:
45   typedef JfrStorageMspace::Type Buffer;
46  private:
47   JfrStorageControl* _control;
48   JfrStorageMspace* _global_mspace;
49   JfrThreadLocalMspace* _thread_local_mspace;
50   JfrStorageMspace* _transient_mspace;
51   JfrStorageAgeMspace* _age_mspace;
52   JfrChunkWriter&amp; _chunkwriter;
53   JfrPostBox&amp; _post_box;
54 
55   // mspace callbacks
56   void register_full(Buffer* t, Thread* thread);
57   void lock();
58   void unlock();
59   DEBUG_ONLY(bool is_locked() const;)
60 
61   Buffer* acquire_large(size_t size, Thread* t);
62   Buffer* acquire_transient(size_t size, Thread* thread);
63   bool flush_regular_buffer(Buffer* const buffer, Thread* t);
64   Buffer* flush_regular(Buffer* cur, const u1* cur_pos, size_t used, size_t req, bool native, Thread* t);
65   Buffer* flush_large(Buffer* cur, const u1* cur_pos, size_t used, size_t req, bool native, Thread* t);
66   Buffer* provision_large(Buffer* cur, const u1* cur_pos, size_t used, size_t req, bool native, Thread* t);
67   void release(Buffer* buffer, Thread* t);
68 
69   size_t clear();
70   size_t clear_full();
<a name="1" id="anc1"></a><span class="line-removed">71   size_t write();</span>
72   size_t write_full();
73   size_t write_at_safepoint();
74   size_t scavenge();
75 
76   JfrStorage(JfrChunkWriter&amp; cw, JfrPostBox&amp; post_box);
77   ~JfrStorage();
78 
79   static JfrStorage&amp; instance();
80   static JfrStorage* create(JfrChunkWriter&amp; chunkwriter, JfrPostBox&amp; post_box);
81   bool initialize();
82   static void destroy();
83 
84  public:
85   static Buffer* acquire_thread_local(Thread* t, size_t size = 0);
86   static void release_thread_local(Buffer* buffer, Thread* t);
87   void release_large(Buffer* const buffer, Thread* t);
88   static Buffer* flush(Buffer* cur, size_t used, size_t req, bool native, Thread* t);
89   void discard_oldest(Thread* t);
90   static JfrStorageControl&amp; control();
91 
<a name="2" id="anc2"></a>

92   friend class JfrRecorder;
93   friend class JfrRecorderService;
94   template &lt;typename, template &lt;typename&gt; class, typename&gt;
95   friend class JfrMemorySpace;
96 };
97 
98 #endif // SHARE_JFR_RECORDER_STORAGE_JFRSTORAGE_HPP
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>