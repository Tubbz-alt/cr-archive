<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/recorder/checkpoint/types/jfrThreadState.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrThreadGroup.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="jfrThreadState.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/checkpoint/types/jfrThreadState.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">! * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  *
  * This code is free software; you can redistribute it and/or modify it
  * under the terms of the GNU General Public License version 2 only, as
  * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">! * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  *
  * This code is free software; you can redistribute it and/or modify it
  * under the terms of the GNU General Public License version 2 only, as
  * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,13 ***</span>
<span class="line-new-header">--- 21,17 ---</span>
  * questions.
  *
  */
  
  #include &quot;precompiled.hpp&quot;
<span class="line-added">+ #include &quot;classfile/javaClasses.inline.hpp&quot;</span>
  #include &quot;jfr/recorder/checkpoint/types/jfrThreadState.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/jfrCheckpointWriter.hpp&quot;
<span class="line-added">+ #include &quot;jfr/support/jfrThreadLocal.hpp&quot;</span>
  #include &quot;jvmtifiles/jvmti.h&quot;
<span class="line-added">+ #include &quot;runtime/osThread.hpp&quot;</span>
<span class="line-added">+ #include &quot;runtime/thread.hpp&quot;</span>
  
  struct jvmti_thread_state {
    u8 id;
    const char* description;
  };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,5 ***</span>
<span class="line-new-header">--- 82,49 ---</span>
      writer.write_key(states[i].id);
      writer.write(states[i].description);
    }
  }
  
<span class="line-added">+ traceid JfrThreadId::id(const Thread* t) {</span>
<span class="line-added">+   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="line-added">+   if (!t-&gt;is_Java_thread()) {</span>
<span class="line-added">+     return os_id(t);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   const JavaThread* const jt = (JavaThread*)t;</span>
<span class="line-added">+   const oop thread_obj = jt-&gt;threadObj();</span>
<span class="line-added">+   return thread_obj != NULL ? java_lang_Thread::thread_id(thread_obj) : 0;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ traceid JfrThreadId::os_id(const Thread* t) {</span>
<span class="line-added">+   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="line-added">+   const OSThread* const os_thread = t-&gt;osthread();</span>
<span class="line-added">+   return os_thread != NULL ? os_thread-&gt;thread_id() : 0;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ traceid JfrThreadId::jfr_id(const Thread* t) {</span>
<span class="line-added">+   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="line-added">+   return t-&gt;jfr_thread_local()-&gt;thread_id();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ // caller needs ResourceMark</span>
<span class="line-added">+ const char* get_java_thread_name(const Thread* t) {</span>
<span class="line-added">+   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="line-added">+   assert(t-&gt;is_Java_thread(), &quot;invariant&quot;);</span>
<span class="line-added">+   const JavaThread* const jt = ((JavaThread*)t);</span>
<span class="line-added">+   const char* name_str = &quot;&lt;no-name - thread name unresolved&gt;&quot;;</span>
<span class="line-added">+   const oop thread_obj = jt-&gt;threadObj();</span>
<span class="line-added">+   if (thread_obj != NULL) {</span>
<span class="line-added">+     const oop name = java_lang_Thread::name(thread_obj);</span>
<span class="line-added">+     if (name != NULL) {</span>
<span class="line-added">+       name_str = java_lang_String::as_utf8_string(name);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   } else if (jt-&gt;is_attaching_via_jni()) {</span>
<span class="line-added">+     name_str = &quot;&lt;no-name - thread is attaching&gt;&quot;;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   assert(name_str != NULL, &quot;unexpected NULL thread name&quot;);</span>
<span class="line-added">+   return name_str;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ const char* JfrThreadName::name(const Thread* t) {</span>
<span class="line-added">+   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="line-added">+   return t-&gt;is_Java_thread() ? get_java_thread_name(t) : t-&gt;name();</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="jfrThreadGroup.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="jfrThreadState.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>