<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointWriter.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrCheckpointManager.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrCheckpointWriter.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointWriter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,36 +23,65 @@</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/jfrCheckpointManager.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/jfrCheckpointWriter.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/utilities/jfrBlob.hpp&quot;</span>
  #include &quot;jfr/writers/jfrBigEndianWriter.hpp&quot;
  
  JfrCheckpointFlush::JfrCheckpointFlush(Type* old, size_t used, size_t requested, Thread* t) :
    _result(JfrCheckpointManager::flush(old, used, requested, t)) {}
  
<span class="udiff-line-modified-removed">- JfrCheckpointWriter::JfrCheckpointWriter(bool flushpoint, bool header, Thread* thread) :</span>
<span class="udiff-line-modified-removed">-   JfrCheckpointWriterBase(JfrCheckpointManager::lease_buffer(thread), thread),</span>
<span class="udiff-line-modified-added">+ JfrCheckpointWriter::JfrCheckpointWriter(JfrCheckpointType type /* GENERIC */) :</span>
<span class="udiff-line-modified-added">+   JfrCheckpointWriterBase(JfrCheckpointManager::lease_buffer(Thread::current()), Thread::current()),</span>
    _time(JfrTicks::now()),
    _offset(0),
    _count(0),
<span class="udiff-line-modified-removed">-   _flushpoint(flushpoint),</span>
<span class="udiff-line-modified-added">+   _type(type),</span>
<span class="udiff-line-added">+   _header(true) {</span>
<span class="udiff-line-added">+   assert(this-&gt;is_acquired(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(0 == this-&gt;current_offset(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   if (_header) {</span>
<span class="udiff-line-added">+     reserve(sizeof(JfrCheckpointEntry));</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ JfrCheckpointWriter::JfrCheckpointWriter(Thread* t, bool header /* true */, JfrCheckpointType type /* GENERIC */) :</span>
<span class="udiff-line-added">+   JfrCheckpointWriterBase(JfrCheckpointManager::lease_buffer(t), t),</span>
<span class="udiff-line-added">+   _time(JfrTicks::now()),</span>
<span class="udiff-line-added">+   _offset(0),</span>
<span class="udiff-line-added">+   _count(0),</span>
<span class="udiff-line-added">+   _type(type),</span>
    _header(header) {
    assert(this-&gt;is_acquired(), &quot;invariant&quot;);
    assert(0 == this-&gt;current_offset(), &quot;invariant&quot;);
    if (_header) {
      reserve(sizeof(JfrCheckpointEntry));
    }
  }
  
<span class="udiff-line-modified-removed">- static void write_checkpoint_header(u1* pos, int64_t size, jlong time, bool flushpoint, u4 type_count) {</span>
<span class="udiff-line-modified-added">+ JfrCheckpointWriter::JfrCheckpointWriter(Thread* t, JfrBuffer* buffer, JfrCheckpointType type /* GENERIC */) :</span>
<span class="udiff-line-added">+   JfrCheckpointWriterBase(buffer, t),</span>
<span class="udiff-line-added">+   _time(JfrTicks::now()),</span>
<span class="udiff-line-added">+   _offset(0),</span>
<span class="udiff-line-added">+   _count(0),</span>
<span class="udiff-line-added">+   _type(type),</span>
<span class="udiff-line-added">+   _header(true) {</span>
<span class="udiff-line-added">+   assert(this-&gt;is_acquired(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(0 == this-&gt;current_offset(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   if (_header) {</span>
<span class="udiff-line-added">+     reserve(sizeof(JfrCheckpointEntry));</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static void write_checkpoint_header(u1* pos, int64_t size, jlong time, u4 checkpoint_type, u4 type_count) {</span>
    assert(pos != NULL, &quot;invariant&quot;);
    JfrBigEndianWriter be_writer(pos, sizeof(JfrCheckpointEntry));
    be_writer.write(size);
    be_writer.write(time);
    be_writer.write(JfrTicks::now().value() - time);
<span class="udiff-line-modified-removed">-   be_writer.write(flushpoint ? (u4)1 : (u4)0);</span>
<span class="udiff-line-modified-added">+   be_writer.write(checkpoint_type);</span>
    be_writer.write(type_count);
    assert(be_writer.is_valid(), &quot;invariant&quot;);
  }
  
  JfrCheckpointWriter::~JfrCheckpointWriter() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -71,22 +100,14 @@</span>
    assert(this-&gt;is_valid(), &quot;invariant&quot;);
    assert(count() &gt; 0, &quot;invariant&quot;);
    assert(this-&gt;used_size() &gt; sizeof(JfrCheckpointEntry), &quot;invariant&quot;);
    const int64_t size = this-&gt;current_offset();
    assert(size + this-&gt;start_pos() == this-&gt;current_pos(), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   write_checkpoint_header(const_cast&lt;u1*&gt;(this-&gt;start_pos()), size, _time, is_flushpoint(), count());</span>
<span class="udiff-line-modified-added">+   write_checkpoint_header(const_cast&lt;u1*&gt;(this-&gt;start_pos()), size, _time, (u4)_type, count());</span>
    release();
  }
  
<span class="udiff-line-removed">- void JfrCheckpointWriter::set_flushpoint(bool flushpoint) {</span>
<span class="udiff-line-removed">-   _flushpoint = flushpoint;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool JfrCheckpointWriter::is_flushpoint() const {</span>
<span class="udiff-line-removed">-   return _flushpoint;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  u4 JfrCheckpointWriter::count() const {
    return _count;
  }
  
  void JfrCheckpointWriter::set_count(u4 count) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,11 +145,11 @@</span>
  
  void JfrCheckpointWriter::write_count(u4 nof_entries, int64_t offset) {
    write_padded_at_offset(nof_entries, offset);
  }
  
<span class="udiff-line-modified-removed">- const u1* JfrCheckpointWriter::session_data(size_t* size, const JfrCheckpointContext* ctx /* 0 */) {</span>
<span class="udiff-line-modified-added">+ const u1* JfrCheckpointWriter::session_data(size_t* size, bool move /* false */, const JfrCheckpointContext* ctx /* 0 */) {</span>
    assert(this-&gt;is_acquired(), &quot;wrong state!&quot;);
    if (!this-&gt;is_valid()) {
      *size = 0;
      return NULL;
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -137,13 +158,15 @@</span>
      *size = this-&gt;current_pos() - session_start_pos;
      return session_start_pos;
    }
    *size = this-&gt;used_size();
    assert(this-&gt;start_pos() + *size == this-&gt;current_pos(), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   write_checkpoint_header(const_cast&lt;u1*&gt;(this-&gt;start_pos()), this-&gt;used_offset(), _time, is_flushpoint(), count());</span>
<span class="udiff-line-modified-removed">-   this-&gt;seek(_offset + (_header ? sizeof(JfrCheckpointEntry) : 0));</span>
<span class="udiff-line-modified-removed">-   set_count(0);</span>
<span class="udiff-line-modified-added">+   write_checkpoint_header(const_cast&lt;u1*&gt;(this-&gt;start_pos()), this-&gt;used_offset(), _time, (u4)_type, count());</span>
<span class="udiff-line-modified-added">+   _header = false; // the header was just written</span>
<span class="udiff-line-modified-added">+   if (move) {</span>
<span class="udiff-line-added">+     this-&gt;seek(_offset);</span>
<span class="udiff-line-added">+   }</span>
    return this-&gt;start_pos();
  }
  
  const JfrCheckpointContext JfrCheckpointWriter::context() const {
    JfrCheckpointContext ctx;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -158,28 +181,21 @@</span>
  }
  bool JfrCheckpointWriter::has_data() const {
    return this-&gt;used_size() &gt; sizeof(JfrCheckpointEntry);
  }
  
<span class="udiff-line-modified-removed">- JfrCheckpointBlobHandle JfrCheckpointWriter::checkpoint_blob() {</span>
<span class="udiff-line-modified-added">+ JfrBlobHandle JfrCheckpointWriter::copy(const JfrCheckpointContext* ctx /* 0 */) {</span>
    size_t size = 0;
<span class="udiff-line-modified-removed">-   const u1* data = session_data(&amp;size);</span>
<span class="udiff-line-modified-removed">-   return JfrCheckpointBlob::make(data, size);</span>
<span class="udiff-line-modified-added">+   const u1* data = session_data(&amp;size, false, ctx);</span>
<span class="udiff-line-modified-added">+   return JfrBlob::make(data, size);</span>
  }
  
<span class="udiff-line-modified-removed">- JfrCheckpointBlobHandle JfrCheckpointWriter::copy(const JfrCheckpointContext* ctx /* 0 */) {</span>
<span class="udiff-line-removed">-   if (ctx == NULL) {</span>
<span class="udiff-line-removed">-     return checkpoint_blob();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ JfrBlobHandle JfrCheckpointWriter::move(const JfrCheckpointContext* ctx /* 0 */) {</span>
    size_t size = 0;
<span class="udiff-line-modified-removed">-   const u1* data = session_data(&amp;size, ctx);</span>
<span class="udiff-line-modified-removed">-   return JfrCheckpointBlob::make(data, size);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- JfrCheckpointBlobHandle JfrCheckpointWriter::move(const JfrCheckpointContext* ctx /* 0 */) {</span>
<span class="udiff-line-removed">-   JfrCheckpointBlobHandle data = copy(ctx);</span>
<span class="udiff-line-modified-added">+   const u1* data = session_data(&amp;size, true, ctx);</span>
<span class="udiff-line-modified-added">+   JfrBlobHandle blob = JfrBlob::make(data, size);</span>
    if (ctx != NULL) {
      const_cast&lt;JfrCheckpointContext*&gt;(ctx)-&gt;count = 0;
      set_context(*ctx);
    }
<span class="udiff-line-modified-removed">-   return data;</span>
<span class="udiff-line-modified-added">+   return blob;</span>
  }
</pre>
<center><a href="jfrCheckpointManager.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrCheckpointWriter.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>