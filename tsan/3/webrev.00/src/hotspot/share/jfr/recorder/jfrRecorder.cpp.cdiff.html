<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/recorder/jfrRecorder.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="checkpoint/types/traceid/jfrTraceIdMacros.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrRecorder.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/jfrRecorder.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 44,10 ***</span>
<span class="line-new-header">--- 44,13 ---</span>
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;memory/resourceArea.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/globals_extension.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
<span class="line-added">+ #ifdef ASSERT</span>
<span class="line-added">+ #include &quot;prims/jvmtiEnvBase.hpp&quot;</span>
<span class="line-added">+ #endif</span>
  
  bool JfrRecorder::is_disabled() {
    // True if -XX:-FlightRecorder has been explicitly set on the
    // command line
    return FLAG_IS_CMDLINE(FlightRecorder) ? !FlightRecorder : false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 55,21 ***</span>
  
  static bool _enabled = false;
  
  static bool enable() {
    assert(!_enabled, &quot;invariant&quot;);
<span class="line-modified">!   FLAG_SET_MGMT(bool, FlightRecorder, true);</span>
    _enabled = FlightRecorder;
    assert(_enabled, &quot;invariant&quot;);
    return _enabled;
  }
  
  bool JfrRecorder::is_enabled() {
    return _enabled;
  }
  
<span class="line-modified">! bool JfrRecorder::on_vm_init() {</span>
    if (!is_disabled()) {
      if (FlightRecorder || StartFlightRecording != NULL) {
        enable();
      }
    }
<span class="line-new-header">--- 58,23 ---</span>
  
  static bool _enabled = false;
  
  static bool enable() {
    assert(!_enabled, &quot;invariant&quot;);
<span class="line-modified">!   if (!FlightRecorder) {</span>
<span class="line-added">+     FLAG_SET_MGMT(FlightRecorder, true);</span>
<span class="line-added">+   }</span>
    _enabled = FlightRecorder;
    assert(_enabled, &quot;invariant&quot;);
    return _enabled;
  }
  
  bool JfrRecorder::is_enabled() {
    return _enabled;
  }
  
<span class="line-modified">! bool JfrRecorder::on_create_vm_1() {</span>
    if (!is_disabled()) {
      if (FlightRecorder || StartFlightRecording != NULL) {
        enable();
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,11 ***</span>
    }
  }
  
  static void teardown_startup_support() {
    release_recordings();
<span class="line-modified">!   JfrOptionSet::release_startup_recording_options();</span>
  }
  
  // Parsing options here to detect errors as soon as possible
  static bool parse_recording_options(const char* options, JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
    assert(options != NULL, &quot;invariant&quot;);
<span class="line-new-header">--- 95,11 ---</span>
    }
  }
  
  static void teardown_startup_support() {
    release_recordings();
<span class="line-modified">!   JfrOptionSet::release_start_flight_recording_options();</span>
  }
  
  // Parsing options here to detect errors as soon as possible
  static bool parse_recording_options(const char* options, JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
    assert(options != NULL, &quot;invariant&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,11 ***</span>
    }
    return true;
  }
  
  static bool validate_recording_options(TRAPS) {
<span class="line-modified">!   const GrowableArray&lt;const char*&gt;* options = JfrOptionSet::startup_recording_options();</span>
    if (options == NULL) {
      return true;
    }
    const int length = options-&gt;length();
    assert(length &gt;= 1, &quot;invariant&quot;);
<span class="line-new-header">--- 113,11 ---</span>
    }
    return true;
  }
  
  static bool validate_recording_options(TRAPS) {
<span class="line-modified">!   const GrowableArray&lt;const char*&gt;* options = JfrOptionSet::start_flight_recording_options();</span>
    if (options == NULL) {
      return true;
    }
    const int length = options-&gt;length();
    assert(length &gt;= 1, &quot;invariant&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 141,11 ***</span>
    }
    log_trace(jfr, system)(&quot;Finished starting a recording&quot;);
    return true;
  }
  
<span class="line-modified">! static bool launch_recordings(TRAPS) {</span>
    bool result = true;
    if (dcmd_recordings_array != NULL) {
      const int length = dcmd_recordings_array-&gt;length();
      assert(length &gt;= 1, &quot;invariant&quot;);
      for (int i = 0; i &lt; length; ++i) {
<span class="line-new-header">--- 146,11 ---</span>
    }
    log_trace(jfr, system)(&quot;Finished starting a recording&quot;);
    return true;
  }
  
<span class="line-modified">! static bool launch_command_line_recordings(TRAPS) {</span>
    bool result = true;
    if (dcmd_recordings_array != NULL) {
      const int length = dcmd_recordings_array-&gt;length();
      assert(length &gt;= 1, &quot;invariant&quot;);
      for (int i = 0; i &lt; length; ++i) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,54 ***</span>
    JfrJavaSupport::is_jdk_jfr_module_available(&amp;stream, THREAD);
  }
  
  static bool is_cds_dump_requested() {
    // we will not be able to launch recordings if a cds dump is being requested
<span class="line-modified">!   if (DumpSharedSpaces &amp;&amp; (JfrOptionSet::startup_recording_options() != NULL)) {</span>
      warning(&quot;JFR will be disabled during CDS dumping&quot;);
      teardown_startup_support();
      return true;
    }
    return false;
  }
  
<span class="line-modified">! bool JfrRecorder::on_vm_start() {</span>
    if (is_cds_dump_requested()) {
      return true;
    }
    Thread* const thread = Thread::current();
    if (!JfrOptionSet::initialize(thread)) {
      return false;
    }
    if (!register_jfr_dcmds()) {
      return false;
    }
<span class="line-removed">- </span>
    const bool in_graph = JfrJavaSupport::is_jdk_jfr_module_available();
<span class="line-removed">- </span>
    if (in_graph) {
      if (!validate_recording_options(thread)) {
        return false;
      }
<span class="line-removed">-     if (!JfrJavaEventWriter::initialize()) {</span>
<span class="line-removed">-       return false;</span>
<span class="line-removed">-     }</span>
      if (!JfrOptionSet::configure(thread)) {
        return false;
      }
    }
<span class="line-removed">- </span>
    if (!is_enabled()) {
      return true;
    }
<span class="line-removed">- </span>
    if (!in_graph) {
      log_jdk_jfr_module_resolution_error(thread);
      return false;
    }
  
<span class="line-modified">!   return launch_recordings(thread);</span>
  }
  
  static bool _created = false;
  
  //
<span class="line-new-header">--- 171,51 ---</span>
    JfrJavaSupport::is_jdk_jfr_module_available(&amp;stream, THREAD);
  }
  
  static bool is_cds_dump_requested() {
    // we will not be able to launch recordings if a cds dump is being requested
<span class="line-modified">!   if (Arguments::is_dumping_archive() &amp;&amp; (JfrOptionSet::start_flight_recording_options() != NULL)) {</span>
      warning(&quot;JFR will be disabled during CDS dumping&quot;);
      teardown_startup_support();
      return true;
    }
    return false;
  }
  
<span class="line-modified">! bool JfrRecorder::on_create_vm_2() {</span>
    if (is_cds_dump_requested()) {
      return true;
    }
    Thread* const thread = Thread::current();
    if (!JfrOptionSet::initialize(thread)) {
      return false;
    }
    if (!register_jfr_dcmds()) {
      return false;
    }
    const bool in_graph = JfrJavaSupport::is_jdk_jfr_module_available();
    if (in_graph) {
      if (!validate_recording_options(thread)) {
        return false;
      }
      if (!JfrOptionSet::configure(thread)) {
        return false;
      }
    }
    if (!is_enabled()) {
      return true;
    }
    if (!in_graph) {
      log_jdk_jfr_module_resolution_error(thread);
      return false;
    }
<span class="line-added">+   return true;</span>
<span class="line-added">+ }</span>
  
<span class="line-modified">! bool JfrRecorder::on_create_vm_3() {</span>
<span class="line-added">+   assert(JvmtiEnvBase::get_phase() == JVMTI_PHASE_LIVE, &quot;invalid init sequence&quot;);</span>
<span class="line-added">+   return launch_command_line_recordings(Thread::current());</span>
  }
  
  static bool _created = false;
  
  //
</pre>
<hr />
<pre>
<span class="line-old-header">*** 244,10 ***</span>
<span class="line-new-header">--- 246,13 ---</span>
  
  bool JfrRecorder::create_components() {
    ResourceMark rm;
    HandleMark hm;
  
<span class="line-added">+   if (!create_java_event_writer()) {</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+   }</span>
    if (!create_jvmti_agent()) {
      return false;
    }
    if (!create_post_box()) {
      return false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 275,20 ***</span>
    }
    return true;
  }
  
  // subsystems
<span class="line-removed">- static JfrJvmtiAgent* _jvmti_agent = NULL;</span>
  static JfrPostBox* _post_box = NULL;
  static JfrStorage* _storage = NULL;
  static JfrCheckpointManager* _checkpoint_manager = NULL;
  static JfrRepository* _repository = NULL;
  static JfrStackTraceRepository* _stack_trace_repository;
  static JfrStringPool* _stringpool = NULL;
  static JfrOSInterface* _os_interface = NULL;
  static JfrThreadSampling* _thread_sampling = NULL;
  
  bool JfrRecorder::create_jvmti_agent() {
    return JfrOptionSet::allow_retransforms() ? JfrJvmtiAgent::create() : true;
  }
  
  bool JfrRecorder::create_post_box() {
<span class="line-new-header">--- 280,23 ---</span>
    }
    return true;
  }
  
  // subsystems
  static JfrPostBox* _post_box = NULL;
  static JfrStorage* _storage = NULL;
  static JfrCheckpointManager* _checkpoint_manager = NULL;
  static JfrRepository* _repository = NULL;
  static JfrStackTraceRepository* _stack_trace_repository;
  static JfrStringPool* _stringpool = NULL;
  static JfrOSInterface* _os_interface = NULL;
  static JfrThreadSampling* _thread_sampling = NULL;
  
<span class="line-added">+ bool JfrRecorder::create_java_event_writer() {</span>
<span class="line-added">+   return JfrJavaEventWriter::initialize();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  bool JfrRecorder::create_jvmti_agent() {
    return JfrOptionSet::allow_retransforms() ? JfrJvmtiAgent::create() : true;
  }
  
  bool JfrRecorder::create_post_box() {
</pre>
<center><a href="checkpoint/types/traceid/jfrTraceIdMacros.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrRecorder.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>