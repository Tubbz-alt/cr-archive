<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/jfr/recorder/checkpoint/types/traceid/jfrTraceIdMacros.hpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
 26 #define SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
 27 
 28 #include &quot;jfr/recorder/checkpoint/types/traceid/jfrTraceIdBits.inline.hpp&quot;
 29 #include &quot;jfr/recorder/checkpoint/types/traceid/jfrTraceIdEpoch.hpp&quot;
 30 #include &quot;jfr/support/jfrKlassExtension.hpp&quot;
 31 #include &quot;utilities/globalDefinitions.hpp&quot;
 32 
 33 /**
 34  *
 35  * If a traceid is used, depending on epoch, either the first or the second bit is tagged.
 36  * If a class member (method) is used, either the third or fourth bit is tagged.
 37  * Which bit to set is a function of the epoch. This allows for concurrent tagging.
 38  *
 39  * LeakProfiler subsystem gets its own byte and uses the same tagging scheme but is shifted up 8.
 40  *
 41  * We also tag the individual method by using the TraceFlag field,
 42  * (see jfr/support/jfrTraceIdExtension.hpp for details)
 43  *
 44  */
 45 
 46 // these are defined in jfr/support/jfrKlassExtension.hpp
 47 //
 48 // #define JDK_JFR_EVENT_SUBKLASS  16
 49 // #define JDK_JFR_EVENT_KLASS     32
 50 // #define EVENT_HOST_KLASS        64
 51 
 52 #define IS_JDK_JFR_EVENT_SUBKLASS(ptr) (((ptr)-&gt;trace_id() &amp; (JDK_JFR_EVENT_SUBKLASS)) != 0)
 53 
 54 #define ANY_USED_BITS (USED_EPOCH_2_BIT         | \
 55                        USED_EPOCH_1_BIT         | \
 56                        METHOD_USED_EPOCH_2_BIT  | \
 57                        METHOD_USED_EPOCH_1_BIT  | \
 58                        LEAKP_USED_EPOCH_2_BIT   | \
 59                        LEAKP_USED_EPOCH_1_BIT)
 60 
 61 #define TRACE_ID_META_BITS (EVENT_HOST_KLASS | JDK_JFR_EVENT_KLASS | JDK_JFR_EVENT_SUBKLASS | ANY_USED_BITS)
 62 
 63 #define ANY_EVENT                       (EVENT_HOST_KLASS | JDK_JFR_EVENT_KLASS | JDK_JFR_EVENT_SUBKLASS)
 64 #define IS_JDK_JFR_EVENT_KLASS(ptr)     (((ptr)-&gt;trace_id() &amp; JDK_JFR_EVENT_KLASS) != 0)
 65 #define IS_EVENT_HOST_KLASS(ptr)        (((ptr)-&gt;trace_id() &amp; EVENT_HOST_KLASS) != 0)
 66 #define IS_NOT_AN_EVENT_KLASS(ptr)      (!IS_EVENT_KLASS(ptr))
 67 #define IS_NOT_AN_EVENT_SUB_KLASS(ptr)  (!IS_JDK_JFR_EVENT_SUBKLASS(ptr))
 68 #define IS_NOT_JDK_JFR_EVENT_KLASS(ptr) (!IS_JDK_JFR_EVENT_KLASS(ptr))
 69 #define EVENT_FLAGS_MASK(ptr)           (((ptr)-&gt;trace_id() &amp; ANY_EVENT) != 0)
 70 #define UNEVENT(ptr)                    ((ptr)-&gt;set_trace_id(((ptr)-&gt;trace_id()) &amp; ~ANY_EVENT))
 71 
 72 #define TRACE_ID_SHIFT 16
 73 
 74 #define TRACE_ID_MASKED(id)             (id &amp; ~TRACE_ID_META_BITS)
 75 #define TRACE_ID_VALUE(id)              (TRACE_ID_MASKED(id) &gt;&gt; TRACE_ID_SHIFT)
 76 #define TRACE_ID_MASKED_PTR(ptr)        (TRACE_ID_MASKED((ptr)-&gt;trace_id()))
 77 #define TRACE_ID_RAW(ptr)               ((ptr)-&gt;trace_id())
 78 #define TRACE_ID(ptr)                   (TRACE_ID_MASKED_PTR(ptr) &gt;&gt; TRACE_ID_SHIFT)
 79 #define METHOD_ID(kls, meth)            (TRACE_ID_MASKED_PTR(kls) | (meth)-&gt;method_idnum())
 80 #define SET_TAG(ptr, tag)               (set_traceid_bits(tag, (ptr)-&gt;trace_id_addr()))
 81 #define SET_LEAKP_TAG(ptr, tag)         (set_leakp_traceid_bits(tag, (ptr)-&gt;trace_id_addr()))
 82 #define SET_TAG_CAS(ptr, tag)           (set_traceid_bits_cas(tag, (ptr)-&gt;trace_id_addr()))
 83 #define SET_LEAKP_TAG_CAS(ptr, tag)     (set_leakp_traceid_bits_cas(tag, (ptr)-&gt;trace_id_addr()))
 84 
 85 #define IN_USE_THIS_EPOCH_BIT           (JfrTraceIdEpoch::in_use_this_epoch_bit())
 86 #define IN_USE_PREV_EPOCH_BIT           (JfrTraceIdEpoch::in_use_prev_epoch_bit())
 87 #define LEAKP_IN_USE_THIS_EPOCH_BIT     (JfrTraceIdEpoch::leakp_in_use_this_epoch_bit())
 88 #define LEAKP_IN_USE_PREV_EPOCH_BIT     (JfrTraceIdEpoch::leakp_in_use_prev_epoch_bit())
 89 
 90 #define METHOD_IN_USE_THIS_EPOCH_BIT    (JfrTraceIdEpoch::method_in_use_this_epoch_bit())
 91 #define METHOD_IN_USE_PREV_EPOCH_BIT    (JfrTraceIdEpoch::method_in_use_prev_epoch_bit())
 92 #define METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS (JfrTraceIdEpoch::method_and_class_in_use_this_epoch_bits())
 93 #define METHOD_AND_CLASS_IN_USE_PREV_EPOCH_BITS (JfrTraceIdEpoch::method_and_class_in_use_prev_epoch_bits())
 94 
 95 #define UNUSE_THIS_EPOCH_MASK           (~(IN_USE_THIS_EPOCH_BIT))
 96 #define UNUSE_PREV_EPOCH_MASK           (~(IN_USE_PREV_EPOCH_BIT))
 97 #define LEAKP_UNUSE_THIS_EPOCH_MASK     UNUSE_THIS_EPOCH_MASK
 98 #define LEAKP_UNUSE_PREV_EPOCH_MASK     UNUSE_PREV_EPOCH_MASK
 99 
100 #define UNUSE_METHOD_THIS_EPOCH_MASK    (~(METHOD_IN_USE_THIS_EPOCH_BIT))
101 #define UNUSE_METHOD_PREV_EPOCH_MASK    (~(METHOD_IN_USE_PREV_EPOCH_BIT))
102 #define LEAKP_UNUSE_METHOD_THIS_EPOCH_MASK (~(UNUSE_METHOD_THIS_EPOCH_MASK))
103 #define LEAKP_UNUSE_METHOD_PREV_EPOCH_MASK (~UNUSE_METHOD_PREV_EPOCH_MASK))
104 
105 #define UNUSE_METHOD_AND_CLASS_THIS_EPOCH_MASK (~(METHOD_IN_USE_THIS_EPOCH_BIT | IN_USE_THIS_EPOCH_BIT))
106 #define UNUSE_METHOD_AND_CLASS_PREV_EPOCH_MASK (~(METHOD_IN_USE_PREV_EPOCH_BIT | IN_USE_PREV_EPOCH_BIT))
107 
108 #define SET_USED_THIS_EPOCH(ptr)        (SET_TAG(ptr, IN_USE_THIS_EPOCH_BIT))
109 #define SET_USED_PREV_EPOCH(ptr)        (SET_TAG_CAS(ptr, IN_USE_PREV_EPOCH_BIT))
110 #define SET_LEAKP_USED_THIS_EPOCH(ptr)  (SET_LEAKP_TAG(ptr, IN_USE_THIS_EPOCH_BIT))
111 #define SET_LEAKP_USED_PREV_EPOCH(ptr)  (SET_LEAKP_TAG(ptr, IN_USE_PREV_EPOCH_BIT))
112 #define SET_METHOD_AND_CLASS_USED_THIS_EPOCH(kls) (SET_TAG(kls, METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS))
113 
114 #define USED_THIS_EPOCH(ptr)            (((ptr)-&gt;trace_id() &amp; IN_USE_THIS_EPOCH_BIT) != 0)
115 #define NOT_USED_THIS_EPOCH(ptr)        (!USED_THIS_EPOCH(ptr))
116 #define USED_PREV_EPOCH(ptr)            (((ptr)-&gt;trace_id() &amp; IN_USE_PREV_EPOCH_BIT) != 0)
117 #define NOT_USED_PREV_EPOCH(ptr)        (!USED_PREV_EPOCH(ptr))
118 #define USED_ANY_EPOCH(ptr)             (((ptr)-&gt;trace_id() &amp; (USED_EPOCH_2_BIT | USED_EPOCH_1_BIT)) != 0)
119 #define NOT_USED_ANY_EPOCH(ptr)         (!USED_ANY_EPOCH(ptr))
120 
121 #define LEAKP_USED_THIS_EPOCH(ptr)      (((ptr)-&gt;trace_id() &amp; LEAKP_IN_USE_THIS_EPOCH_BIT) != 0)
122 #define LEAKP_NOT_USED_THIS_EPOCH(ptr)  (!LEAKP_USED_THIS_EPOCH(ptr))
123 #define LEAKP_USED_PREV_EPOCH(ptr)      (((ptr)-&gt;trace_id() &amp; LEAKP_IN_USE_PREV_EPOCH_BIT) != 0)
124 #define LEAKP_NOT_USED_PREV_EPOCH(ptr)  (!LEAKP_USED_PREV_EPOCH(ptr))
125 #define LEAKP_USED_ANY_EPOCH(ptr)       (((ptr)-&gt;trace_id() &amp; (LEAKP_USED_EPOCH_2_BIT | LEAKP_USED_EPOCH_1_BIT)) != 0)
126 #define LEAKP_NOT_USED_ANY_EPOCH(ptr)   (!LEAKP_USED_ANY_EPOCH(ptr))
127 
128 #define ANY_USED_THIS_EPOCH(ptr)        (((ptr)-&gt;trace_id() &amp; (LEAKP_IN_USE_THIS_EPOCH_BIT | IN_USE_THIS_EPOCH_BIT)) != 0)
129 #define ANY_NOT_USED_THIS_EPOCH(ptr)    (!ANY_USED_THIS_EPOCH(ptr))
130 #define ANY_USED_PREV_EPOCH(ptr)        (((ptr)-&gt;trace_id() &amp; (LEAKP_IN_USE_PREV_EPOCH_BIT | IN_USE_PREV_EPOCH_BIT)) != 0)
131 #define ANY_NOT_USED_PREV_EPOCH(ptr)    (!ANY_USED_PREV_EPOCH(ptr))
132 
133 #define METHOD_USED_THIS_EPOCH(kls)     (((kls)-&gt;trace_id() &amp; METHOD_IN_USE_THIS_EPOCH_BIT) != 0)
134 #define METHOD_NOT_USED_THIS_EPOCH(kls) (!METHOD_USED_THIS_EPOCH(kls))
135 #define METHOD_USED_PREV_EPOCH(kls)     (((kls)-&gt;trace_id() &amp; METHOD_IN_USE_PREV_EPOCH_BIT) != 0)
136 #define METHOD_NOT_USED_PREV_EPOCH(kls) (!METHOD_USED_PREV_EPOCH(kls))
137 #define METHOD_USED_ANY_EPOCH(kls)      (((kls)-&gt;trace_id() &amp; (METHOD_IN_USE_PREV_EPOCH_BIT | METHOD_IN_USE_THIS_EPOCH_BIT)) != 0)
138 
139 #define METHOD_NOT_USED_ANY_EPOCH(kls)  (!METHOD_USED_ANY_EPOCH(kls))
140 
141 #define METHOD_AND_CLASS_USED_THIS_EPOCH(kls) ((((kls)-&gt;trace_id() &amp; METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS) == \
142                                                                      METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS) != 0)
143 
144 #define METHOD_AND_CLASS_USED_PREV_EPOCH(kls) ((((kls)-&gt;trace_id() &amp; METHOD_AND_CLASS_IN_USE_PREV_EPOCH_BITS) == \
145                                                                      METHOD_AND_CLASS_IN_USE_PREV_EPOCH_BITS) != 0)
146 
147 #define METHOD_AND_CLASS_USED_ANY_EPOCH(kls)     ((METHOD_USED_ANY_EPOCH(kls) &amp;&amp; USED_ANY_EPOCH(kls)) != 0)
148 #define METHOD_AND_CLASS_NOT_USED_ANY_EPOCH(kls) (!METHOD_AND_CLASS_USED_ANY_EPOCH(kls))
149 
150 #define LEAKP_METHOD_IN_USE_THIS_EPOCH  (LEAKP_IN_USE_THIS_EPOCH_BIT | METHOD_IN_USE_THIS_EPOCH_BIT)
151 #define LEAKP_METHOD_IN_USE_PREV_EPOCH  (LEAKP_IN_USE_PREV_EPOCH_BIT | METHOD_IN_USE_PREV_EPOCH_BIT)
152 #define LEAKP_METHOD_USED_THIS_EPOCH(ptr)  ((((ptr)-&gt;trace_id() &amp; LEAKP_METHOD_IN_USE_THIS_EPOCH) == \
153                                                                   LEAKP_METHOD_IN_USE_THIS_EPOCH) != 0)
154 #define LEAKP_METHOD_NOT_USED_THIS_EPOCH(kls) (!LEAKP_METHOD_USED_THIS_EPOCH(kls))
155 #define LEAKP_METHOD_USED_PREV_EPOCH(ptr)  ((((ptr)-&gt;trace_id() &amp; LEAKP_METHOD_IN_USE_PREV_EPOCH) == \
156                                                                   LEAKP_METHOD_IN_USE_PREV_EPOCH) != 0)
157 #define LEAKP_METHOD_NOT_USED_PREV_EPOCH(kls) (!LEAKP_METHOD_USED_PREV_EPOCH(kls))
158 
159 #define UNUSE_THIS_EPOCH(ptr)           (set_traceid_mask(UNUSE_THIS_EPOCH_MASK, (ptr)-&gt;trace_id_addr()))
160 #define UNUSE_PREV_EPOCH(ptr)           (set_traceid_mask(UNUSE_PREV_EPOCH_MASK, (ptr)-&gt;trace_id_addr()))
161 #define UNUSE_METHOD_THIS_EPOCH(kls)    (set_traceid_mask(UNUSE_METHOD_THIS_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
162 #define UNUSE_METHOD_PREV_EPOCH(kls)    (set_traceid_mask(UNUSE_METHOD_PREV_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
163 
164 #define LEAKP_UNUSE_THIS_EPOCH(ptr)     (set_leakp_traceid_mask(UNUSE_THIS_EPOCH_MASK, (ptr)-&gt;trace_id_addr()))
165 #define LEAKP_UNUSE_PREV_EPOCH(ptr)     (set_leakp_traceid_mask(UNUSE_PREV_EPOCH_MASK, (ptr)-&gt;trace_id_addr()))
166 #define LEAKP_UNUSE_METHOD_THIS_EPOCH(kls) (set_leakp_traceid_mask(UNUSE_METHOD_THIS_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
167 #define LEAKP_UNUSE_METHOD_PREV_EPOCH(kls) (set_leakp_traceid_mask(UNUSE_METHOD_PREV_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
168 
169 #define ANY_USED(ptr)                   (((ptr)-&gt;trace_id() &amp; ANY_USED_BITS) != 0)
170 #define ANY_NOT_USED(ptr)               (!ANY_USED(ptr))
171 
172 #define UNUSE_METHOD_AND_CLASS_THIS_EPOCH(kls) (set_traceid_mask(UNUSE_METHOD_AND_CLASS_THIS_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
173 #define LEAKP_UNUSE_METHOD_AND_CLASS_THIS_EPOCH(kls) (set_leakp_traceid_mask(UNUSE_METHOD_AND_CLASS_THIS_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
174 #define UNUSE_METHOD_AND_CLASS_PREV_EPOCH(kls) (set_traceid_mask(UNUSE_METHOD_AND_CLASS_PREV_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
175 #define LEAKP_UNUSE_METHODS_AND_CLASS_PREV_EPOCH(kls) (set_leakp_traceid_mask(UNUSE_METHOD_AND_CLASS_PREV_EPOCH_MASK, (kls)-&gt;trace_id_addr()))
176 
177 #define METHOD_FLAG_USED_THIS_EPOCH(m)       ((m)-&gt;is_trace_flag_set((jbyte)JfrTraceIdEpoch::in_use_this_epoch_bit()))
178 #define METHOD_FLAG_NOT_USED_THIS_EPOCH(m)   (!METHOD_FLAG_USED_THIS_EPOCH(m))
179 #define SET_METHOD_FLAG_USED_THIS_EPOCH(m)   ((m)-&gt;set_trace_flag((jbyte)JfrTraceIdEpoch::in_use_this_epoch_bit()))
180 #define METHOD_FLAG_USED_PREV_EPOCH(m)       ((m)-&gt;is_trace_flag_set((jbyte)JfrTraceIdEpoch::in_use_prev_epoch_bit()))
181 #define METHOD_FLAG_NOT_USED_PREV_EPOCH(m)   (!METHOD_FLAG_USED_PREV_EPOCH(m))
182 #define METHOD_FLAG_USED_ANY_EPOCH(m)        ((METHOD_FLAG_USED_THIS_EPOCH(m) || METHOD_FLAG_USED_PREV_EPOCH(m)) != 0)
183 #define METHOD_FLAG_NOT_USED_ANY_EPOCH(m)    ((METHOD_FLAG_NOT_USED_THIS_EPOCH(m) &amp;&amp; METHOD_FLAG_NOT_USED_PREV_EPOCH(m)) != 0)
184 #define CLEAR_METHOD_FLAG_USED_THIS_EPOCH(m) (clear_bits_cas((jbyte)JfrTraceIdEpoch::in_use_this_epoch_bit(), (m)-&gt;trace_flags_addr()))
185 #define CLEAR_METHOD_FLAG_USED_PREV_EPOCH(m) (clear_bits_cas((jbyte)JfrTraceIdEpoch::in_use_prev_epoch_bit(), (m)-&gt;trace_flags_addr()))
186 
187 #endif // SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
    </pre>
  </body>
</html>