<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jfr/recorder/storage/jfrBuffer.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jfr/recorder/storage/jfrBuffer.hpp&quot;
<a name="2" id="anc2"></a>

 27 #include &quot;runtime/thread.inline.hpp&quot;
 28 
<a name="3" id="anc3"></a><span class="line-modified"> 29 static const u1* const TOP_CRITICAL_SECTION = NULL;</span>
 30 
 31 JfrBuffer::JfrBuffer() : _next(NULL),
 32                          _prev(NULL),
 33                          _identity(NULL),
 34                          _pos(NULL),
 35                          _top(NULL),
 36                          _flags(0),
 37                          _header_size(0),
 38                          _size(0) {}
 39 
<a name="4" id="anc4"></a><span class="line-modified"> 40 bool JfrBuffer::initialize(size_t header_size, size_t size) {</span>
<span class="line-added"> 41   assert(_next == NULL, &quot;invariant&quot;);</span>
<span class="line-added"> 42   assert(_identity == NULL, &quot;invariant&quot;);</span>
 43   _header_size = (u2)header_size;
 44   _size = (u4)(size / BytesPerWord);
<a name="5" id="anc5"></a>

 45   set_pos(start());
 46   set_top(start());
<a name="6" id="anc6"></a>
 47   assert(free_size() == size, &quot;invariant&quot;);
 48   assert(!transient(), &quot;invariant&quot;);
 49   assert(!lease(), &quot;invariant&quot;);
 50   assert(!retired(), &quot;invariant&quot;);
 51   return true;
 52 }
 53 
<a name="7" id="anc7"></a><span class="line-modified"> 54 void JfrBuffer::reinitialize(bool exclusion /* false */) {</span>
<span class="line-modified"> 55   acquire_critical_section_top();</span>








 56   assert(!lease(), &quot;invariant&quot;);
 57   assert(!transient(), &quot;invariant&quot;);
<a name="8" id="anc8"></a><span class="line-added"> 58   if (exclusion != excluded()) {</span>
<span class="line-added"> 59     // update</span>
<span class="line-added"> 60     if (exclusion) {</span>
<span class="line-added"> 61       set_excluded();</span>
<span class="line-added"> 62     } else {</span>
<span class="line-added"> 63       clear_excluded();</span>
<span class="line-added"> 64     }</span>
<span class="line-added"> 65   }</span>
 66   set_pos(start());
<a name="9" id="anc9"></a><span class="line-modified"> 67   release_critical_section_top(start());</span>
 68   clear_retired();
 69 }
 70 
<a name="10" id="anc10"></a><span class="line-modified"> 71 const u1* JfrBuffer::top() const {</span>
<span class="line-modified"> 72   return Atomic::load_acquire(&amp;_top);</span>


 73 }
 74 
 75 const u1* JfrBuffer::stable_top() const {
 76   const u1* current_top;
 77   do {
<a name="11" id="anc11"></a><span class="line-modified"> 78     current_top = top();</span>
<span class="line-modified"> 79   } while (TOP_CRITICAL_SECTION == current_top);</span>
 80   return current_top;
 81 }
 82 
<a name="12" id="anc12"></a>



 83 void JfrBuffer::set_top(const u1* new_top) {
<a name="13" id="anc13"></a><span class="line-modified"> 84   assert(new_top &lt;= end(), &quot;invariant&quot;);</span>
<span class="line-added"> 85   assert(new_top &gt;= start(), &quot;invariant&quot;);</span>
<span class="line-added"> 86   Atomic::release_store(&amp;_top, new_top);</span>
 87 }
 88 
<a name="14" id="anc14"></a><span class="line-modified"> 89 const u1* JfrBuffer::acquire_critical_section_top() const {</span>
 90   do {
 91     const u1* current_top = stable_top();
<a name="15" id="anc15"></a><span class="line-modified"> 92     assert(current_top != TOP_CRITICAL_SECTION, &quot;invariant&quot;);</span>
<span class="line-added"> 93     if (Atomic::cmpxchg(&amp;_top, current_top, TOP_CRITICAL_SECTION) == current_top) {</span>
 94       return current_top;
 95     }
 96   } while (true);
 97 }
 98 
<a name="16" id="anc16"></a><span class="line-modified"> 99 void JfrBuffer::release_critical_section_top(const u1* new_top) {</span>
<span class="line-modified">100   assert(new_top != TOP_CRITICAL_SECTION, &quot;invariant&quot;);</span>
<span class="line-modified">101   assert(top() == TOP_CRITICAL_SECTION, &quot;invariant&quot;);</span>
<span class="line-modified">102   set_top(new_top);</span>


103 }
104 
<a name="17" id="anc17"></a><span class="line-modified">105 bool JfrBuffer::acquired_by(const void* id) const {</span>
<span class="line-modified">106   return identity() == id;</span>
<span class="line-added">107 }</span>
<span class="line-added">108 </span>
<span class="line-added">109 bool JfrBuffer::acquired_by_self() const {</span>
<span class="line-added">110   return acquired_by(Thread::current());</span>
111 }
112 
113 void JfrBuffer::acquire(const void* id) {
114   assert(id != NULL, &quot;invariant&quot;);
115   const void* current_id;
116   do {
<a name="18" id="anc18"></a><span class="line-modified">117     current_id = identity();</span>
<span class="line-modified">118   } while (current_id != NULL || Atomic::cmpxchg(&amp;_identity, current_id, id) != current_id);</span>
119 }
120 
121 bool JfrBuffer::try_acquire(const void* id) {
122   assert(id != NULL, &quot;invariant&quot;);
<a name="19" id="anc19"></a><span class="line-modified">123   const void* const current_id = identity();</span>
<span class="line-modified">124   return current_id == NULL &amp;&amp; Atomic::cmpxchg(&amp;_identity, current_id, id) == current_id;</span>
125 }
126 
127 void JfrBuffer::release() {
<a name="20" id="anc20"></a><span class="line-modified">128   assert(identity() != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">129   Atomic::release_store(&amp;_identity, (const void*)NULL);</span>



130 }
131 
132 #ifdef ASSERT
133 static bool validate_to(const JfrBuffer* const to, size_t size) {
134   assert(to != NULL, &quot;invariant&quot;);
135   assert(to-&gt;acquired_by_self(), &quot;invariant&quot;);
136   assert(to-&gt;free_size() &gt;= size, &quot;invariant&quot;);
137   return true;
138 }
139 
<a name="21" id="anc21"></a>




140 static bool validate_this(const JfrBuffer* const t, size_t size) {
<a name="22" id="anc22"></a><span class="line-modified">141   assert(t-&gt;acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">142   assert(t-&gt;top() == TOP_CRITICAL_SECTION, &quot;invariant&quot;);</span>
143   return true;
144 }
<a name="23" id="anc23"></a>



145 #endif // ASSERT
146 
147 void JfrBuffer::move(JfrBuffer* const to, size_t size) {
148   assert(validate_to(to, size), &quot;invariant&quot;);
<a name="24" id="anc24"></a><span class="line-added">149   const u1* const current_top = acquire_critical_section_top();</span>
150   assert(validate_this(this, size), &quot;invariant&quot;);
<a name="25" id="anc25"></a><span class="line-modified">151   const size_t actual_size = pos() - current_top;</span>
<span class="line-modified">152   assert(actual_size &lt;= size, &quot;invariant&quot;);</span>
<span class="line-modified">153   if (actual_size &gt; 0) {</span>
<span class="line-modified">154     memcpy(to-&gt;pos(), current_top, actual_size);</span>
<span class="line-added">155     to-&gt;set_pos(actual_size);</span>
<span class="line-added">156   }</span>
157   to-&gt;release();
<a name="26" id="anc26"></a><span class="line-modified">158   set_pos(start());</span>
<span class="line-added">159   release_critical_section_top(start());</span>
160 }
161 
<a name="27" id="anc27"></a><span class="line-modified">162 size_t JfrBuffer::discard() {</span>
<span class="line-modified">163   const u1* const position = pos();</span>
<span class="line-modified">164   // stable_top() provides acquire semantics for pos()</span>
<span class="line-modified">165   const u1* const current_top = stable_top();</span>
<span class="line-modified">166   set_top(position);</span>
<span class="line-modified">167   return position - current_top;</span>
<span class="line-modified">168 }</span>
<span class="line-modified">169 </span>
<span class="line-modified">170 size_t JfrBuffer::unflushed_size() const {</span>
<span class="line-modified">171   const u1* const position = pos();</span>
<span class="line-modified">172   // stable_top() provides acquire semantics for pos()</span>
<span class="line-added">173   return position - stable_top();</span>
174 }
175 
<a name="28" id="anc28"></a>
176 enum FLAG {
177   RETIRED = 1,
178   TRANSIENT = 2,
<a name="29" id="anc29"></a><span class="line-modified">179   LEASE = 4,</span>
<span class="line-added">180   EXCLUDED = 8</span>
181 };
182 
<a name="30" id="anc30"></a><span class="line-added">183 inline u2 load(const volatile u2* flags) {</span>
<span class="line-added">184   assert(flags != NULL, &quot;invariant&quot;);</span>
<span class="line-added">185   return Atomic::load_acquire(flags);</span>
<span class="line-added">186 }</span>
<span class="line-added">187 </span>
<span class="line-added">188 inline void set(u2* flags, FLAG flag) {</span>
<span class="line-added">189   assert(flags != NULL, &quot;invariant&quot;);</span>
<span class="line-added">190   OrderAccess::storestore();</span>
<span class="line-added">191   *flags |= (u1)flag;</span>
<span class="line-added">192 }</span>
<span class="line-added">193 </span>
<span class="line-added">194 inline void clear(u2* flags, FLAG flag) {</span>
<span class="line-added">195   assert(flags != NULL, &quot;invariant&quot;);</span>
<span class="line-added">196   OrderAccess::storestore();</span>
<span class="line-added">197   *flags ^= (u1)flag;</span>
<span class="line-added">198 }</span>
<span class="line-added">199 </span>
<span class="line-added">200 inline bool test(const u2* flags, FLAG flag) {</span>
<span class="line-added">201   return (u1)flag == (load(flags) &amp; (u1)flag);</span>
<span class="line-added">202 }</span>
<span class="line-added">203 </span>
204 bool JfrBuffer::transient() const {
<a name="31" id="anc31"></a><span class="line-modified">205   return test(&amp;_flags, TRANSIENT);</span>
206 }
207 
208 void JfrBuffer::set_transient() {
<a name="32" id="anc32"></a><span class="line-modified">209   assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">210   set(&amp;_flags, TRANSIENT);</span>
211   assert(transient(), &quot;invariant&quot;);
212 }
213 
214 void JfrBuffer::clear_transient() {
215   if (transient()) {
<a name="33" id="anc33"></a><span class="line-modified">216     assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">217     clear(&amp;_flags, TRANSIENT);</span>
218   }
219   assert(!transient(), &quot;invariant&quot;);
220 }
221 
222 bool JfrBuffer::lease() const {
<a name="34" id="anc34"></a><span class="line-modified">223   return test(&amp;_flags, LEASE);</span>
224 }
225 
226 void JfrBuffer::set_lease() {
<a name="35" id="anc35"></a><span class="line-modified">227   assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">228   set(&amp;_flags, LEASE);</span>
229   assert(lease(), &quot;invariant&quot;);
230 }
231 
232 void JfrBuffer::clear_lease() {
233   if (lease()) {
<a name="36" id="anc36"></a><span class="line-modified">234     assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">235     clear(&amp;_flags, LEASE);</span>
236   }
237   assert(!lease(), &quot;invariant&quot;);
238 }
239 
<a name="37" id="anc37"></a><span class="line-modified">240 bool JfrBuffer::excluded() const {</span>
<span class="line-modified">241   return test(&amp;_flags, EXCLUDED);</span>
242 }
243 
<a name="38" id="anc38"></a><span class="line-modified">244 void JfrBuffer::set_excluded() {</span>
<span class="line-modified">245   assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-added">246   set(&amp;_flags, EXCLUDED);</span>
<span class="line-added">247   assert(excluded(), &quot;invariant&quot;);</span>
<span class="line-added">248 }</span>
<span class="line-added">249 </span>
<span class="line-added">250 void JfrBuffer::clear_excluded() {</span>
<span class="line-added">251   if (excluded()) {</span>
<span class="line-added">252     assert(identity() != NULL, &quot;invariant&quot;);</span>
<span class="line-added">253     clear(&amp;_flags, EXCLUDED);</span>
<span class="line-added">254   }</span>
<span class="line-added">255   assert(!excluded(), &quot;invariant&quot;);</span>
256 }
257 
258 bool JfrBuffer::retired() const {
<a name="39" id="anc39"></a><span class="line-modified">259   return test(&amp;_flags, RETIRED);</span>
260 }
261 
262 void JfrBuffer::set_retired() {
<a name="40" id="anc40"></a><span class="line-modified">263   assert(acquired_by_self(), &quot;invariant&quot;);</span>
<span class="line-modified">264   set(&amp;_flags, RETIRED);</span>
265 }
266 
267 void JfrBuffer::clear_retired() {
<a name="41" id="anc41"></a><span class="line-modified">268   if (retired()) {</span>
<span class="line-modified">269     assert(identity() != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">270     clear(&amp;_flags, RETIRED);</span>

271   }
272 }
<a name="42" id="anc42"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="42" type="hidden" />
</body>
</html>