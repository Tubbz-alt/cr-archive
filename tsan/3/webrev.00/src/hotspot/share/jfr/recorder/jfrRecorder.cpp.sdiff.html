<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jfr/recorder/jfrRecorder.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="checkpoint/types/traceid/jfrTraceIdMacros.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrRecorder.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/jfrRecorder.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 29 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 30 #include &quot;jfr/periodic/sampling/jfrThreadSampler.hpp&quot;
 31 #include &quot;jfr/recorder/jfrRecorder.hpp&quot;
 32 #include &quot;jfr/recorder/checkpoint/jfrCheckpointManager.hpp&quot;
 33 #include &quot;jfr/recorder/repository/jfrRepository.hpp&quot;
 34 #include &quot;jfr/recorder/service/jfrOptionSet.hpp&quot;
 35 #include &quot;jfr/recorder/service/jfrPostBox.hpp&quot;
 36 #include &quot;jfr/recorder/service/jfrRecorderService.hpp&quot;
 37 #include &quot;jfr/recorder/service/jfrRecorderThread.hpp&quot;
 38 #include &quot;jfr/recorder/storage/jfrStorage.hpp&quot;
 39 #include &quot;jfr/recorder/stacktrace/jfrStackTraceRepository.hpp&quot;
 40 #include &quot;jfr/recorder/stringpool/jfrStringPool.hpp&quot;
 41 #include &quot;jfr/utilities/jfrTime.hpp&quot;
 42 #include &quot;jfr/writers/jfrJavaEventWriter.hpp&quot;
 43 #include &quot;logging/log.hpp&quot;
 44 #include &quot;logging/logStream.hpp&quot;
 45 #include &quot;memory/resourceArea.inline.hpp&quot;
 46 #include &quot;runtime/handles.inline.hpp&quot;
 47 #include &quot;runtime/globals_extension.hpp&quot;
 48 #include &quot;utilities/growableArray.hpp&quot;



 49 
 50 bool JfrRecorder::is_disabled() {
 51   // True if -XX:-FlightRecorder has been explicitly set on the
 52   // command line
 53   return FLAG_IS_CMDLINE(FlightRecorder) ? !FlightRecorder : false;
 54 }
 55 
 56 static bool _enabled = false;
 57 
 58 static bool enable() {
 59   assert(!_enabled, &quot;invariant&quot;);
<span class="line-modified"> 60   FLAG_SET_MGMT(bool, FlightRecorder, true);</span>


 61   _enabled = FlightRecorder;
 62   assert(_enabled, &quot;invariant&quot;);
 63   return _enabled;
 64 }
 65 
 66 bool JfrRecorder::is_enabled() {
 67   return _enabled;
 68 }
 69 
<span class="line-modified"> 70 bool JfrRecorder::on_vm_init() {</span>
 71   if (!is_disabled()) {
 72     if (FlightRecorder || StartFlightRecording != NULL) {
 73       enable();
 74     }
 75   }
 76   // fast time initialization
 77   return JfrTime::initialize();
 78 }
 79 
 80 static GrowableArray&lt;JfrStartFlightRecordingDCmd*&gt;* dcmd_recordings_array = NULL;
 81 
 82 static void release_recordings() {
 83   if (dcmd_recordings_array != NULL) {
 84     const int length = dcmd_recordings_array-&gt;length();
 85     for (int i = 0; i &lt; length; ++i) {
 86       delete dcmd_recordings_array-&gt;at(i);
 87     }
 88     delete dcmd_recordings_array;
 89     dcmd_recordings_array = NULL;
 90   }
 91 }
 92 
 93 static void teardown_startup_support() {
 94   release_recordings();
<span class="line-modified"> 95   JfrOptionSet::release_startup_recording_options();</span>
 96 }
 97 
 98 // Parsing options here to detect errors as soon as possible
 99 static bool parse_recording_options(const char* options, JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
100   assert(options != NULL, &quot;invariant&quot;);
101   assert(dcmd_recording != NULL, &quot;invariant&quot;);
102   CmdLine cmdline(options, strlen(options), true);
103   dcmd_recording-&gt;parse(&amp;cmdline, &#39;,&#39;, THREAD);
104   if (HAS_PENDING_EXCEPTION) {
105     java_lang_Throwable::print(PENDING_EXCEPTION, tty);
106     CLEAR_PENDING_EXCEPTION;
107     return false;
108   }
109   return true;
110 }
111 
112 static bool validate_recording_options(TRAPS) {
<span class="line-modified">113   const GrowableArray&lt;const char*&gt;* options = JfrOptionSet::startup_recording_options();</span>
114   if (options == NULL) {
115     return true;
116   }
117   const int length = options-&gt;length();
118   assert(length &gt;= 1, &quot;invariant&quot;);
119   assert(dcmd_recordings_array == NULL, &quot;invariant&quot;);
120   dcmd_recordings_array = new (ResourceObj::C_HEAP, mtTracing)GrowableArray&lt;JfrStartFlightRecordingDCmd*&gt;(length, true, mtTracing);
121   assert(dcmd_recordings_array != NULL, &quot;invariant&quot;);
122   for (int i = 0; i &lt; length; ++i) {
123     JfrStartFlightRecordingDCmd* const dcmd_recording = new(ResourceObj::C_HEAP, mtTracing) JfrStartFlightRecordingDCmd(tty, true);
124     assert(dcmd_recording != NULL, &quot;invariant&quot;);
125     dcmd_recordings_array-&gt;append(dcmd_recording);
126     if (!parse_recording_options(options-&gt;at(i), dcmd_recording, THREAD)) {
127       return false;
128     }
129   }
130   return true;
131 }
132 
133 static bool launch_recording(JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
134   assert(dcmd_recording != NULL, &quot;invariant&quot;);
135   log_trace(jfr, system)(&quot;Starting a recording&quot;);
136   dcmd_recording-&gt;execute(DCmd_Source_Internal, THREAD);
137   if (HAS_PENDING_EXCEPTION) {
138     log_debug(jfr, system)(&quot;Exception while starting a recording&quot;);
139     CLEAR_PENDING_EXCEPTION;
140     return false;
141   }
142   log_trace(jfr, system)(&quot;Finished starting a recording&quot;);
143   return true;
144 }
145 
<span class="line-modified">146 static bool launch_recordings(TRAPS) {</span>
147   bool result = true;
148   if (dcmd_recordings_array != NULL) {
149     const int length = dcmd_recordings_array-&gt;length();
150     assert(length &gt;= 1, &quot;invariant&quot;);
151     for (int i = 0; i &lt; length; ++i) {
152       if (!launch_recording(dcmd_recordings_array-&gt;at(i), THREAD)) {
153         result = false;
154         break;
155       }
156     }
157   }
158   teardown_startup_support();
159   return result;
160 }
161 
162 static void log_jdk_jfr_module_resolution_error(TRAPS) {
163   LogTarget(Error, jfr, system) lt_error;
164   LogTargetHandle handle(lt_error);
165   LogStream stream(handle);
166   JfrJavaSupport::is_jdk_jfr_module_available(&amp;stream, THREAD);
167 }
168 
169 static bool is_cds_dump_requested() {
170   // we will not be able to launch recordings if a cds dump is being requested
<span class="line-modified">171   if (DumpSharedSpaces &amp;&amp; (JfrOptionSet::startup_recording_options() != NULL)) {</span>
172     warning(&quot;JFR will be disabled during CDS dumping&quot;);
173     teardown_startup_support();
174     return true;
175   }
176   return false;
177 }
178 
<span class="line-modified">179 bool JfrRecorder::on_vm_start() {</span>
180   if (is_cds_dump_requested()) {
181     return true;
182   }
183   Thread* const thread = Thread::current();
184   if (!JfrOptionSet::initialize(thread)) {
185     return false;
186   }
187   if (!register_jfr_dcmds()) {
188     return false;
189   }
<span class="line-removed">190 </span>
191   const bool in_graph = JfrJavaSupport::is_jdk_jfr_module_available();
<span class="line-removed">192 </span>
193   if (in_graph) {
194     if (!validate_recording_options(thread)) {
195       return false;
196     }
<span class="line-removed">197     if (!JfrJavaEventWriter::initialize()) {</span>
<span class="line-removed">198       return false;</span>
<span class="line-removed">199     }</span>
200     if (!JfrOptionSet::configure(thread)) {
201       return false;
202     }
203   }
<span class="line-removed">204 </span>
205   if (!is_enabled()) {
206     return true;
207   }
<span class="line-removed">208 </span>
209   if (!in_graph) {
210     log_jdk_jfr_module_resolution_error(thread);
211     return false;
212   }


213 
<span class="line-modified">214   return launch_recordings(thread);</span>


215 }
216 
217 static bool _created = false;
218 
219 //
220 // Main entry point for starting Jfr functionality.
221 // Non-protected initializations assume single-threaded setup.
222 //
223 bool JfrRecorder::create(bool simulate_failure) {
224   assert(!is_disabled(), &quot;invariant&quot;);
225   assert(!is_created(), &quot;invariant&quot;);
226   if (!is_enabled()) {
227     enable();
228   }
229   if (!create_components() || simulate_failure) {
230     destroy_components();
231     return false;
232   }
233   if (!create_recorder_thread()) {
234     destroy_components();
235     return false;
236   }
237   _created = true;
238   return true;
239 }
240 
241 bool JfrRecorder::is_created() {
242   return _created;
243 }
244 
245 bool JfrRecorder::create_components() {
246   ResourceMark rm;
247   HandleMark hm;
248 



249   if (!create_jvmti_agent()) {
250     return false;
251   }
252   if (!create_post_box()) {
253     return false;
254   }
255   if (!create_chunk_repository()) {
256     return false;
257   }
258   if (!create_storage()) {
259     return false;
260   }
261   if (!create_checkpoint_manager()) {
262     return false;
263   }
264   if (!create_stacktrace_repository()) {
265     return false;
266   }
267   if (!create_os_interface()) {
268     return false;
269   }
270   if (!create_stringpool()) {
271     return false;
272   }
273   if (!create_thread_sampling()) {
274     return false;
275   }
276   return true;
277 }
278 
279 // subsystems
<span class="line-removed">280 static JfrJvmtiAgent* _jvmti_agent = NULL;</span>
281 static JfrPostBox* _post_box = NULL;
282 static JfrStorage* _storage = NULL;
283 static JfrCheckpointManager* _checkpoint_manager = NULL;
284 static JfrRepository* _repository = NULL;
285 static JfrStackTraceRepository* _stack_trace_repository;
286 static JfrStringPool* _stringpool = NULL;
287 static JfrOSInterface* _os_interface = NULL;
288 static JfrThreadSampling* _thread_sampling = NULL;
289 




290 bool JfrRecorder::create_jvmti_agent() {
291   return JfrOptionSet::allow_retransforms() ? JfrJvmtiAgent::create() : true;
292 }
293 
294 bool JfrRecorder::create_post_box() {
295   assert(_post_box == NULL, &quot;invariant&quot;);
296   _post_box = JfrPostBox::create();
297   return _post_box != NULL;
298 }
299 
300 bool JfrRecorder::create_chunk_repository() {
301   assert(_repository == NULL, &quot;invariant&quot;);
302   assert(_post_box != NULL, &quot;invariant&quot;);
303   _repository = JfrRepository::create(*_post_box);
304   return _repository != NULL &amp;&amp; _repository-&gt;initialize();
305 }
306 
307 bool JfrRecorder::create_os_interface() {
308   assert(_os_interface == NULL, &quot;invariant&quot;);
309   _os_interface = JfrOSInterface::create();
</pre>
</td>
<td>
<hr />
<pre>
 29 #include &quot;jfr/periodic/jfrOSInterface.hpp&quot;
 30 #include &quot;jfr/periodic/sampling/jfrThreadSampler.hpp&quot;
 31 #include &quot;jfr/recorder/jfrRecorder.hpp&quot;
 32 #include &quot;jfr/recorder/checkpoint/jfrCheckpointManager.hpp&quot;
 33 #include &quot;jfr/recorder/repository/jfrRepository.hpp&quot;
 34 #include &quot;jfr/recorder/service/jfrOptionSet.hpp&quot;
 35 #include &quot;jfr/recorder/service/jfrPostBox.hpp&quot;
 36 #include &quot;jfr/recorder/service/jfrRecorderService.hpp&quot;
 37 #include &quot;jfr/recorder/service/jfrRecorderThread.hpp&quot;
 38 #include &quot;jfr/recorder/storage/jfrStorage.hpp&quot;
 39 #include &quot;jfr/recorder/stacktrace/jfrStackTraceRepository.hpp&quot;
 40 #include &quot;jfr/recorder/stringpool/jfrStringPool.hpp&quot;
 41 #include &quot;jfr/utilities/jfrTime.hpp&quot;
 42 #include &quot;jfr/writers/jfrJavaEventWriter.hpp&quot;
 43 #include &quot;logging/log.hpp&quot;
 44 #include &quot;logging/logStream.hpp&quot;
 45 #include &quot;memory/resourceArea.inline.hpp&quot;
 46 #include &quot;runtime/handles.inline.hpp&quot;
 47 #include &quot;runtime/globals_extension.hpp&quot;
 48 #include &quot;utilities/growableArray.hpp&quot;
<span class="line-added"> 49 #ifdef ASSERT</span>
<span class="line-added"> 50 #include &quot;prims/jvmtiEnvBase.hpp&quot;</span>
<span class="line-added"> 51 #endif</span>
 52 
 53 bool JfrRecorder::is_disabled() {
 54   // True if -XX:-FlightRecorder has been explicitly set on the
 55   // command line
 56   return FLAG_IS_CMDLINE(FlightRecorder) ? !FlightRecorder : false;
 57 }
 58 
 59 static bool _enabled = false;
 60 
 61 static bool enable() {
 62   assert(!_enabled, &quot;invariant&quot;);
<span class="line-modified"> 63   if (!FlightRecorder) {</span>
<span class="line-added"> 64     FLAG_SET_MGMT(FlightRecorder, true);</span>
<span class="line-added"> 65   }</span>
 66   _enabled = FlightRecorder;
 67   assert(_enabled, &quot;invariant&quot;);
 68   return _enabled;
 69 }
 70 
 71 bool JfrRecorder::is_enabled() {
 72   return _enabled;
 73 }
 74 
<span class="line-modified"> 75 bool JfrRecorder::on_create_vm_1() {</span>
 76   if (!is_disabled()) {
 77     if (FlightRecorder || StartFlightRecording != NULL) {
 78       enable();
 79     }
 80   }
 81   // fast time initialization
 82   return JfrTime::initialize();
 83 }
 84 
 85 static GrowableArray&lt;JfrStartFlightRecordingDCmd*&gt;* dcmd_recordings_array = NULL;
 86 
 87 static void release_recordings() {
 88   if (dcmd_recordings_array != NULL) {
 89     const int length = dcmd_recordings_array-&gt;length();
 90     for (int i = 0; i &lt; length; ++i) {
 91       delete dcmd_recordings_array-&gt;at(i);
 92     }
 93     delete dcmd_recordings_array;
 94     dcmd_recordings_array = NULL;
 95   }
 96 }
 97 
 98 static void teardown_startup_support() {
 99   release_recordings();
<span class="line-modified">100   JfrOptionSet::release_start_flight_recording_options();</span>
101 }
102 
103 // Parsing options here to detect errors as soon as possible
104 static bool parse_recording_options(const char* options, JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
105   assert(options != NULL, &quot;invariant&quot;);
106   assert(dcmd_recording != NULL, &quot;invariant&quot;);
107   CmdLine cmdline(options, strlen(options), true);
108   dcmd_recording-&gt;parse(&amp;cmdline, &#39;,&#39;, THREAD);
109   if (HAS_PENDING_EXCEPTION) {
110     java_lang_Throwable::print(PENDING_EXCEPTION, tty);
111     CLEAR_PENDING_EXCEPTION;
112     return false;
113   }
114   return true;
115 }
116 
117 static bool validate_recording_options(TRAPS) {
<span class="line-modified">118   const GrowableArray&lt;const char*&gt;* options = JfrOptionSet::start_flight_recording_options();</span>
119   if (options == NULL) {
120     return true;
121   }
122   const int length = options-&gt;length();
123   assert(length &gt;= 1, &quot;invariant&quot;);
124   assert(dcmd_recordings_array == NULL, &quot;invariant&quot;);
125   dcmd_recordings_array = new (ResourceObj::C_HEAP, mtTracing)GrowableArray&lt;JfrStartFlightRecordingDCmd*&gt;(length, true, mtTracing);
126   assert(dcmd_recordings_array != NULL, &quot;invariant&quot;);
127   for (int i = 0; i &lt; length; ++i) {
128     JfrStartFlightRecordingDCmd* const dcmd_recording = new(ResourceObj::C_HEAP, mtTracing) JfrStartFlightRecordingDCmd(tty, true);
129     assert(dcmd_recording != NULL, &quot;invariant&quot;);
130     dcmd_recordings_array-&gt;append(dcmd_recording);
131     if (!parse_recording_options(options-&gt;at(i), dcmd_recording, THREAD)) {
132       return false;
133     }
134   }
135   return true;
136 }
137 
138 static bool launch_recording(JfrStartFlightRecordingDCmd* dcmd_recording, TRAPS) {
139   assert(dcmd_recording != NULL, &quot;invariant&quot;);
140   log_trace(jfr, system)(&quot;Starting a recording&quot;);
141   dcmd_recording-&gt;execute(DCmd_Source_Internal, THREAD);
142   if (HAS_PENDING_EXCEPTION) {
143     log_debug(jfr, system)(&quot;Exception while starting a recording&quot;);
144     CLEAR_PENDING_EXCEPTION;
145     return false;
146   }
147   log_trace(jfr, system)(&quot;Finished starting a recording&quot;);
148   return true;
149 }
150 
<span class="line-modified">151 static bool launch_command_line_recordings(TRAPS) {</span>
152   bool result = true;
153   if (dcmd_recordings_array != NULL) {
154     const int length = dcmd_recordings_array-&gt;length();
155     assert(length &gt;= 1, &quot;invariant&quot;);
156     for (int i = 0; i &lt; length; ++i) {
157       if (!launch_recording(dcmd_recordings_array-&gt;at(i), THREAD)) {
158         result = false;
159         break;
160       }
161     }
162   }
163   teardown_startup_support();
164   return result;
165 }
166 
167 static void log_jdk_jfr_module_resolution_error(TRAPS) {
168   LogTarget(Error, jfr, system) lt_error;
169   LogTargetHandle handle(lt_error);
170   LogStream stream(handle);
171   JfrJavaSupport::is_jdk_jfr_module_available(&amp;stream, THREAD);
172 }
173 
174 static bool is_cds_dump_requested() {
175   // we will not be able to launch recordings if a cds dump is being requested
<span class="line-modified">176   if (Arguments::is_dumping_archive() &amp;&amp; (JfrOptionSet::start_flight_recording_options() != NULL)) {</span>
177     warning(&quot;JFR will be disabled during CDS dumping&quot;);
178     teardown_startup_support();
179     return true;
180   }
181   return false;
182 }
183 
<span class="line-modified">184 bool JfrRecorder::on_create_vm_2() {</span>
185   if (is_cds_dump_requested()) {
186     return true;
187   }
188   Thread* const thread = Thread::current();
189   if (!JfrOptionSet::initialize(thread)) {
190     return false;
191   }
192   if (!register_jfr_dcmds()) {
193     return false;
194   }

195   const bool in_graph = JfrJavaSupport::is_jdk_jfr_module_available();

196   if (in_graph) {
197     if (!validate_recording_options(thread)) {
198       return false;
199     }



200     if (!JfrOptionSet::configure(thread)) {
201       return false;
202     }
203   }

204   if (!is_enabled()) {
205     return true;
206   }

207   if (!in_graph) {
208     log_jdk_jfr_module_resolution_error(thread);
209     return false;
210   }
<span class="line-added">211   return true;</span>
<span class="line-added">212 }</span>
213 
<span class="line-modified">214 bool JfrRecorder::on_create_vm_3() {</span>
<span class="line-added">215   assert(JvmtiEnvBase::get_phase() == JVMTI_PHASE_LIVE, &quot;invalid init sequence&quot;);</span>
<span class="line-added">216   return launch_command_line_recordings(Thread::current());</span>
217 }
218 
219 static bool _created = false;
220 
221 //
222 // Main entry point for starting Jfr functionality.
223 // Non-protected initializations assume single-threaded setup.
224 //
225 bool JfrRecorder::create(bool simulate_failure) {
226   assert(!is_disabled(), &quot;invariant&quot;);
227   assert(!is_created(), &quot;invariant&quot;);
228   if (!is_enabled()) {
229     enable();
230   }
231   if (!create_components() || simulate_failure) {
232     destroy_components();
233     return false;
234   }
235   if (!create_recorder_thread()) {
236     destroy_components();
237     return false;
238   }
239   _created = true;
240   return true;
241 }
242 
243 bool JfrRecorder::is_created() {
244   return _created;
245 }
246 
247 bool JfrRecorder::create_components() {
248   ResourceMark rm;
249   HandleMark hm;
250 
<span class="line-added">251   if (!create_java_event_writer()) {</span>
<span class="line-added">252     return false;</span>
<span class="line-added">253   }</span>
254   if (!create_jvmti_agent()) {
255     return false;
256   }
257   if (!create_post_box()) {
258     return false;
259   }
260   if (!create_chunk_repository()) {
261     return false;
262   }
263   if (!create_storage()) {
264     return false;
265   }
266   if (!create_checkpoint_manager()) {
267     return false;
268   }
269   if (!create_stacktrace_repository()) {
270     return false;
271   }
272   if (!create_os_interface()) {
273     return false;
274   }
275   if (!create_stringpool()) {
276     return false;
277   }
278   if (!create_thread_sampling()) {
279     return false;
280   }
281   return true;
282 }
283 
284 // subsystems

285 static JfrPostBox* _post_box = NULL;
286 static JfrStorage* _storage = NULL;
287 static JfrCheckpointManager* _checkpoint_manager = NULL;
288 static JfrRepository* _repository = NULL;
289 static JfrStackTraceRepository* _stack_trace_repository;
290 static JfrStringPool* _stringpool = NULL;
291 static JfrOSInterface* _os_interface = NULL;
292 static JfrThreadSampling* _thread_sampling = NULL;
293 
<span class="line-added">294 bool JfrRecorder::create_java_event_writer() {</span>
<span class="line-added">295   return JfrJavaEventWriter::initialize();</span>
<span class="line-added">296 }</span>
<span class="line-added">297 </span>
298 bool JfrRecorder::create_jvmti_agent() {
299   return JfrOptionSet::allow_retransforms() ? JfrJvmtiAgent::create() : true;
300 }
301 
302 bool JfrRecorder::create_post_box() {
303   assert(_post_box == NULL, &quot;invariant&quot;);
304   _post_box = JfrPostBox::create();
305   return _post_box != NULL;
306 }
307 
308 bool JfrRecorder::create_chunk_repository() {
309   assert(_repository == NULL, &quot;invariant&quot;);
310   assert(_post_box != NULL, &quot;invariant&quot;);
311   _repository = JfrRepository::create(*_post_box);
312   return _repository != NULL &amp;&amp; _repository-&gt;initialize();
313 }
314 
315 bool JfrRecorder::create_os_interface() {
316   assert(_os_interface == NULL, &quot;invariant&quot;);
317   _os_interface = JfrOSInterface::create();
</pre>
</td>
</tr>
</table>
<center><a href="checkpoint/types/traceid/jfrTraceIdMacros.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrRecorder.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>