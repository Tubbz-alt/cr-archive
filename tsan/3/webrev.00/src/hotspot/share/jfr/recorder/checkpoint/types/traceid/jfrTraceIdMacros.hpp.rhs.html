<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jfr/recorder/checkpoint/types/traceid/jfrTraceIdMacros.hpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
 26 #define SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
 27 
<a name="1" id="anc1"></a>




 28 /**
 29  *
 30  * If a traceid is used, depending on epoch, either the first or the second bit is tagged.
 31  * If a class member (method) is used, either the third or fourth bit is tagged.
 32  * Which bit to set is a function of the epoch. This allows for concurrent tagging.
 33  *
<a name="2" id="anc2"></a><span class="line-modified"> 34  * We also tag individual methods by using the _trace_flags field,</span>


 35  * (see jfr/support/jfrTraceIdExtension.hpp for details)
 36  *
 37  */
 38 
<a name="3" id="anc3"></a><span class="line-modified"> 39 // the following are defined in jfr/support/jfrKlassExtension.hpp</span>
 40 //
<a name="4" id="anc4"></a><span class="line-modified"> 41 // #define JDK_JFR_EVENT_SUBKLASS                 16</span>
<span class="line-modified"> 42 // #define JDK_JFR_EVENT_KLASS                    32</span>
<span class="line-modified"> 43 // #define EVENT_HOST_KLASS                       64</span>
<span class="line-modified"> 44 </span>
<span class="line-modified"> 45 // static bits</span>
<span class="line-modified"> 46 #define META_SHIFT                                8</span>
<span class="line-modified"> 47 #define EPOCH_1_CLEARED_META_BIT                  USED_BIT</span>
<span class="line-modified"> 48 #define EPOCH_1_CLEARED_BIT                       (EPOCH_1_CLEARED_META_BIT &lt;&lt; META_SHIFT)</span>
<span class="line-modified"> 49 #define EPOCH_2_CLEARED_META_BIT                  (USED_BIT &lt;&lt; 1)</span>
<span class="line-modified"> 50 #define EPOCH_2_CLEARED_BIT                       (EPOCH_2_CLEARED_META_BIT &lt;&lt; META_SHIFT)</span>
<span class="line-modified"> 51 #define LEAKP_META_BIT                            (USED_BIT &lt;&lt; 2)</span>
<span class="line-modified"> 52 #define LEAKP_BIT                                 (LEAKP_META_BIT &lt;&lt; META_SHIFT)</span>
<span class="line-modified"> 53 #define TRANSIENT_META_BIT                        (USED_BIT &lt;&lt; 3)</span>
<span class="line-modified"> 54 #define TRANSIENT_BIT                             (TRANSIENT_META_BIT &lt;&lt; META_SHIFT)</span>
<span class="line-modified"> 55 #define SERIALIZED_META_BIT                       (USED_BIT &lt;&lt; 4)</span>
<span class="line-modified"> 56 #define SERIALIZED_BIT                            (SERIALIZED_META_BIT &lt;&lt; META_SHIFT)</span>
<span class="line-modified"> 57 #define TRACE_ID_SHIFT                            16</span>
<span class="line-modified"> 58 #define METHOD_ID_NUM_MASK                        ((1 &lt;&lt; TRACE_ID_SHIFT) - 1)</span>
<span class="line-modified"> 59 #define META_BITS                                 (SERIALIZED_BIT | TRANSIENT_BIT | LEAKP_BIT | EPOCH_2_CLEARED_BIT | EPOCH_1_CLEARED_BIT)</span>
<span class="line-modified"> 60 #define EVENT_BITS                                (EVENT_HOST_KLASS | JDK_JFR_EVENT_KLASS | JDK_JFR_EVENT_SUBKLASS)</span>
<span class="line-modified"> 61 #define USED_BITS                                 (METHOD_USED_EPOCH_2_BIT | METHOD_USED_EPOCH_1_BIT | USED_EPOCH_2_BIT | USED_EPOCH_1_BIT)</span>
<span class="line-modified"> 62 #define ALL_BITS                                  (META_BITS | EVENT_BITS | USED_BITS)</span>
<span class="line-modified"> 63 #define ALL_BITS_MASK                             (~(ALL_BITS))</span>
<span class="line-modified"> 64 </span>
<span class="line-modified"> 65 // epoch relative bits</span>
<span class="line-modified"> 66 #define IN_USE_THIS_EPOCH_BIT                     (JfrTraceIdEpoch::in_use_this_epoch_bit())</span>
<span class="line-modified"> 67 #define IN_USE_PREV_EPOCH_BIT                     (JfrTraceIdEpoch::in_use_prev_epoch_bit())</span>
<span class="line-modified"> 68 #define METHOD_IN_USE_THIS_EPOCH_BIT              (JfrTraceIdEpoch::method_in_use_this_epoch_bit())</span>
<span class="line-modified"> 69 #define METHOD_IN_USE_PREV_EPOCH_BIT              (JfrTraceIdEpoch::method_in_use_prev_epoch_bit())</span>
<span class="line-modified"> 70 #define METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS   (JfrTraceIdEpoch::method_and_class_in_use_this_epoch_bits())</span>
<span class="line-modified"> 71 #define METHOD_AND_CLASS_IN_USE_PREV_EPOCH_BITS   (JfrTraceIdEpoch::method_and_class_in_use_prev_epoch_bits())</span>
<span class="line-modified"> 72 #define METHOD_FLAG_IN_USE_THIS_EPOCH_BIT         ((jbyte)IN_USE_THIS_EPOCH_BIT)</span>
<span class="line-modified"> 73 #define METHOD_FLAG_IN_USE_PREV_EPOCH_BIT         ((jbyte)IN_USE_PREV_EPOCH_BIT)</span>
<span class="line-modified"> 74 </span>
<span class="line-modified"> 75 // operators</span>
<span class="line-modified"> 76 #define TRACE_ID_RAW(ptr)                         ((ptr)-&gt;trace_id())</span>
<span class="line-modified"> 77 #define TRACE_ID(ptr)                             (TRACE_ID_RAW(ptr) &gt;&gt; TRACE_ID_SHIFT)</span>
<span class="line-modified"> 78 #define TRACE_ID_MASKED(ptr)                      (TRACE_ID_RAW(ptr) &amp; ALL_BITS_MASK)</span>
<span class="line-modified"> 79 #define TRACE_ID_PREDICATE(ptr, bits)             ((TRACE_ID_RAW(ptr) &amp; bits) != 0)</span>
<span class="line-modified"> 80 #define TRACE_ID_TAG(ptr, bits)                   (set_traceid_bits(bits, (ptr)-&gt;trace_id_addr()))</span>
<span class="line-modified"> 81 #define TRACE_ID_TAG_CAS(ptr, bits)               (set_traceid_bits_cas(bits, (ptr)-&gt;trace_id_addr()))</span>
<span class="line-modified"> 82 #define TRACE_ID_CLEAR(ptr, bits)                 (set_traceid_mask(bits, (ptr)-&gt;trace_id_addr()))</span>
<span class="line-modified"> 83 #define TRACE_ID_META_TAG(ptr, bits)              (set_traceid_meta_bits(bits, (ptr)-&gt;trace_id_addr()))</span>
<span class="line-modified"> 84 #define TRACE_ID_META_CLEAR(ptr, bits)            (set_traceid_meta_mask(bits, (ptr)-&gt;trace_id_addr()))</span>
<span class="line-modified"> 85 #define METHOD_ID(kls, method)                    (TRACE_ID_MASKED(kls) | (method)-&gt;orig_method_idnum())</span>
<span class="line-modified"> 86 #define METHOD_FLAG_PREDICATE(method, bits)       ((method)-&gt;is_trace_flag_set(bits))</span>
<span class="line-modified"> 87 #define METHOD_FLAG_TAG(method, bits)             (set_bits(bits, (method)-&gt;trace_flags_addr()))</span>
<span class="line-modified"> 88 #define METHOD_META_TAG(method, bits)             (set_meta_bits(bits, (method)-&gt;trace_meta_addr()))</span>
<span class="line-modified"> 89 #define METHOD_FLAG_CLEAR(method, bits)           (clear_bits_cas(bits, (method)-&gt;trace_flags_addr()))</span>
<span class="line-modified"> 90 #define METHOD_META_CLEAR(method, bits)           (set_meta_mask(bits, (method)-&gt;trace_meta_addr()))</span>
<span class="line-modified"> 91 </span>
<span class="line-modified"> 92 // predicates</span>
<span class="line-modified"> 93 #define USED_THIS_EPOCH(ptr)                      (TRACE_ID_PREDICATE(ptr, (TRANSIENT_BIT | IN_USE_THIS_EPOCH_BIT)))</span>
<span class="line-modified"> 94 #define NOT_USED_THIS_EPOCH(ptr)                  (!(USED_THIS_EPOCH(ptr)))</span>
<span class="line-modified"> 95 #define USED_PREV_EPOCH(ptr)                      (TRACE_ID_PREDICATE(ptr, (TRANSIENT_BIT | IN_USE_PREV_EPOCH_BIT)))</span>
<span class="line-modified"> 96 #define USED_ANY_EPOCH(ptr)                       (TRACE_ID_PREDICATE(ptr, (TRANSIENT_BIT | USED_EPOCH_2_BIT | USED_EPOCH_1_BIT)))</span>
<span class="line-modified"> 97 #define METHOD_USED_THIS_EPOCH(kls)               (TRACE_ID_PREDICATE(kls, (METHOD_IN_USE_THIS_EPOCH_BIT)))</span>
<span class="line-modified"> 98 #define METHOD_NOT_USED_THIS_EPOCH(kls)           (!(METHOD_USED_THIS_EPOCH(kls)))</span>
<span class="line-modified"> 99 #define METHOD_USED_PREV_EPOCH(kls)               (TRACE_ID_PREDICATE(kls, (METHOD_IN_USE_PREV_EPOCH_BIT)))</span>
<span class="line-modified">100 #define METHOD_USED_ANY_EPOCH(kls)                (TRACE_ID_PREDICATE(kls, (METHOD_IN_USE_PREV_EPOCH_BIT | METHOD_IN_USE_THIS_EPOCH_BIT)))</span>
<span class="line-modified">101 #define METHOD_AND_CLASS_USED_THIS_EPOCH(kls)     (TRACE_ID_PREDICATE(kls, (METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS)))</span>
<span class="line-modified">102 #define METHOD_AND_CLASS_USED_PREV_EPOCH(kls)     (TRACE_ID_PREDICATE(kls, (METHOD_AND_CLASS_IN_USE_PREV_EPOCH_BITS)))</span>
<span class="line-modified">103 #define METHOD_AND_CLASS_USED_ANY_EPOCH(kls)      (METHOD_USED_ANY_EPOCH(kls) &amp;&amp; USED_ANY_EPOCH(kls))</span>
<span class="line-modified">104 #define METHOD_FLAG_USED_THIS_EPOCH(method)       (METHOD_FLAG_PREDICATE(method, (METHOD_FLAG_IN_USE_THIS_EPOCH_BIT)))</span>
<span class="line-modified">105 #define METHOD_FLAG_NOT_USED_THIS_EPOCH(method)   (!(METHOD_FLAG_USED_THIS_EPOCH(method)))</span>
<span class="line-modified">106 #define METHOD_FLAG_USED_PREV_EPOCH(method)       (METHOD_FLAG_PREDICATE(method, (METHOD_FLAG_IN_USE_PREV_EPOCH_BIT)))</span>
<span class="line-modified">107 </span>
<span class="line-modified">108 // setters</span>
<span class="line-modified">109 #define SET_USED_THIS_EPOCH(ptr)                  (TRACE_ID_TAG(ptr, IN_USE_THIS_EPOCH_BIT))</span>
<span class="line-modified">110 #define SET_METHOD_AND_CLASS_USED_THIS_EPOCH(kls) (TRACE_ID_TAG(kls, METHOD_AND_CLASS_IN_USE_THIS_EPOCH_BITS))</span>
<span class="line-modified">111 #define SET_METHOD_FLAG_USED_THIS_EPOCH(method)   (METHOD_FLAG_TAG(method, METHOD_FLAG_IN_USE_THIS_EPOCH_BIT))</span>
<span class="line-modified">112 #define CLEAR_METHOD_AND_CLASS_PREV_EPOCH_MASK    (~(METHOD_IN_USE_PREV_EPOCH_BIT | IN_USE_PREV_EPOCH_BIT))</span>
<span class="line-modified">113 #define CLEAR_METHOD_AND_CLASS_PREV_EPOCH(kls)    (TRACE_ID_CLEAR(kls, CLEAR_METHOD_AND_CLASS_PREV_EPOCH_MASK))</span>
<span class="line-modified">114 #define CLEAR_METHOD_FLAG_USED_PREV_EPOCH(method) (METHOD_FLAG_CLEAR(method, METHOD_FLAG_IN_USE_PREV_EPOCH_BIT))</span>
<span class="line-modified">115 </span>
<span class="line-modified">116 // types</span>
<span class="line-modified">117 #define IS_JDK_JFR_EVENT_KLASS(kls)               (TRACE_ID_PREDICATE(kls, JDK_JFR_EVENT_KLASS))</span>
<span class="line-modified">118 #define IS_JDK_JFR_EVENT_SUBKLASS(kls)            (TRACE_ID_PREDICATE(kls, JDK_JFR_EVENT_SUBKLASS))</span>
<span class="line-modified">119 #define IS_NOT_AN_EVENT_SUB_KLASS(kls)            (!(IS_JDK_JFR_EVENT_SUBKLASS(kls)))</span>
<span class="line-modified">120 #define IS_EVENT_HOST_KLASS(kls)                  (TRACE_ID_PREDICATE(kls, EVENT_HOST_KLASS))</span>
<span class="line-modified">121 #define SET_JDK_JFR_EVENT_KLASS(kls)              (TRACE_ID_TAG(kls, JDK_JFR_EVENT_KLASS))</span>
<span class="line-modified">122 #define SET_JDK_JFR_EVENT_SUBKLASS(kls)           (TRACE_ID_TAG(kls, JDK_JFR_EVENT_SUBKLASS))</span>
<span class="line-modified">123 #define SET_EVENT_HOST_KLASS(kls)                 (TRACE_ID_TAG(kls, EVENT_HOST_KLASS))</span>
<span class="line-modified">124 #define EVENT_KLASS_MASK(kls)                     (TRACE_ID_RAW(kls) &amp; EVENT_BITS)</span>
<span class="line-modified">125 </span>
<span class="line-modified">126 // meta</span>
<span class="line-modified">127 #define META_MASK                                 (~(SERIALIZED_META_BIT | TRANSIENT_META_BIT | LEAKP_META_BIT))</span>
<span class="line-modified">128 #define SET_LEAKP(ptr)                            (TRACE_ID_META_TAG(ptr, LEAKP_META_BIT))</span>
<span class="line-modified">129 #define IS_LEAKP(ptr)                             (TRACE_ID_PREDICATE(ptr, LEAKP_BIT))</span>
<span class="line-modified">130 #define SET_TRANSIENT(ptr)                        (TRACE_ID_META_TAG(ptr, TRANSIENT_META_BIT))</span>
<span class="line-modified">131 #define IS_SERIALIZED(ptr)                        (TRACE_ID_PREDICATE(ptr, SERIALIZED_BIT))</span>
<span class="line-modified">132 #define IS_NOT_SERIALIZED(ptr)                    (!(IS_SERIALIZED(ptr)))</span>
<span class="line-modified">133 #define SHOULD_TAG(ptr)                           (NOT_USED_THIS_EPOCH(ptr))</span>
<span class="line-modified">134 #define SHOULD_TAG_KLASS_METHOD(ptr)              (METHOD_NOT_USED_THIS_EPOCH(ptr))</span>
<span class="line-modified">135 #define SET_SERIALIZED(ptr)                       (TRACE_ID_META_TAG(ptr, SERIALIZED_META_BIT))</span>
<span class="line-modified">136 #define CLEAR_SERIALIZED(ptr)                     (TRACE_ID_META_CLEAR(ptr, META_MASK))</span>
<span class="line-modified">137 #define SET_PREV_EPOCH_CLEARED_BIT(ptr)           (TRACE_ID_META_TAG(ptr, IN_USE_PREV_EPOCH_BIT))</span>
<span class="line-modified">138 #define IS_METHOD_SERIALIZED(method)              (METHOD_FLAG_PREDICATE(method, SERIALIZED_BIT))</span>
<span class="line-modified">139 #define IS_METHOD_LEAKP_USED(method)              (METHOD_FLAG_PREDICATE(method, LEAKP_BIT))</span>
<span class="line-modified">140 #define METHOD_NOT_SERIALIZED(method)             (!(IS_METHOD_SERIALIZED(method)))</span>
<span class="line-modified">141 #define SET_METHOD_LEAKP(method)                  (METHOD_META_TAG(method, LEAKP_META_BIT))</span>
<span class="line-modified">142 #define SET_METHOD_SERIALIZED(method)             (METHOD_META_TAG(method, SERIALIZED_META_BIT))</span>
<span class="line-modified">143 #define CLEAR_METHOD_SERIALIZED(method)           (METHOD_META_CLEAR(method, META_MASK))</span>
<span class="line-modified">144 #define SET_PREV_EPOCH_METHOD_CLEARED_BIT(ptr)    (METHOD_META_TAG(ptr, IN_USE_PREV_EPOCH_BIT))</span>
<span class="line-modified">145 #define CLEAR_LEAKP(ptr)                          (TRACE_ID_META_CLEAR(ptr, (~(LEAKP_META_BIT))))</span>
<span class="line-modified">146 #define CLEAR_THIS_EPOCH_CLEARED_BIT(ptr)         (TRACE_ID_META_CLEAR(ptr,(~(IN_USE_THIS_EPOCH_BIT))))</span>
<span class="line-modified">147 #define CLEAR_THIS_EPOCH_METHOD_CLEARED_BIT(ptr)  (METHOD_META_CLEAR(ptr,(~(IN_USE_THIS_EPOCH_BIT))))</span>































148 
149 #endif // SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDMACROS_HPP
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>