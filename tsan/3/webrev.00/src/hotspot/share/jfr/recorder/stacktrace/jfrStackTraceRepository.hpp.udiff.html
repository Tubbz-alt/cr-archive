<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/stacktrace/jfrStackTraceRepository.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrStackTraceRepository.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../storage/jfrBuffer.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/stacktrace/jfrStackTraceRepository.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,131 +23,50 @@</span>
   */
  
  #ifndef SHARE_JFR_RECORDER_STACKTRACE_JFRSTACKTRACEREPOSITORY_HPP
  #define SHARE_JFR_RECORDER_STACKTRACE_JFRSTACKTRACEREPOSITORY_HPP
  
<span class="udiff-line-added">+ #include &quot;jfr/recorder/stacktrace/jfrStackTrace.hpp&quot;</span>
  #include &quot;jfr/utilities/jfrAllocation.hpp&quot;
  #include &quot;jfr/utilities/jfrTypes.hpp&quot;
  
<span class="udiff-line-removed">- class frame;</span>
  class JavaThread;
  class JfrCheckpointWriter;
  class JfrChunkWriter;
<span class="udiff-line-removed">- class Method;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class JfrStackFrame {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   const Method* _method;</span>
<span class="udiff-line-removed">-   traceid _methodid;</span>
<span class="udiff-line-removed">-   int _line;</span>
<span class="udiff-line-removed">-   int _bci;</span>
<span class="udiff-line-removed">-   u1 _type;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-   enum {</span>
<span class="udiff-line-removed">-     FRAME_INTERPRETER = 0,</span>
<span class="udiff-line-removed">-     FRAME_JIT,</span>
<span class="udiff-line-removed">-     FRAME_INLINE,</span>
<span class="udiff-line-removed">-     FRAME_NATIVE,</span>
<span class="udiff-line-removed">-     NUM_FRAME_TYPES</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   JfrStackFrame(const traceid&amp; id, int bci, int type, const Method* method) :</span>
<span class="udiff-line-removed">-     _method(method), _methodid(id), _line(0), _bci(bci), _type(type) {}</span>
<span class="udiff-line-removed">-   JfrStackFrame(const traceid&amp; id, int bci, int type, int lineno) :</span>
<span class="udiff-line-removed">-     _method(NULL), _methodid(id), _line(lineno), _bci(bci), _type(type) {}</span>
<span class="udiff-line-removed">-   bool equals(const JfrStackFrame&amp; rhs) const;</span>
<span class="udiff-line-removed">-   void write(JfrChunkWriter&amp; cw) const;</span>
<span class="udiff-line-removed">-   void write(JfrCheckpointWriter&amp; cpw) const;</span>
<span class="udiff-line-removed">-   void resolve_lineno();</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class JfrStackTrace : public StackObj {</span>
<span class="udiff-line-removed">-   friend class JfrStackTraceRepository;</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   JfrStackFrame* _frames;</span>
<span class="udiff-line-removed">-   traceid _id;</span>
<span class="udiff-line-removed">-   u4 _nr_of_frames;</span>
<span class="udiff-line-removed">-   unsigned int _hash;</span>
<span class="udiff-line-removed">-   const u4 _max_frames;</span>
<span class="udiff-line-removed">-   bool _reached_root;</span>
<span class="udiff-line-removed">-   bool _lineno;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-   JfrStackTrace(JfrStackFrame* frames, u4 max_frames) : _frames(frames),</span>
<span class="udiff-line-removed">-                                                         _id(0),</span>
<span class="udiff-line-removed">-                                                         _nr_of_frames(0),</span>
<span class="udiff-line-removed">-                                                         _hash(0),</span>
<span class="udiff-line-removed">-                                                         _max_frames(max_frames),</span>
<span class="udiff-line-removed">-                                                         _reached_root(false),</span>
<span class="udiff-line-removed">-                                                         _lineno(false) {}</span>
<span class="udiff-line-removed">-   bool record_thread(JavaThread&amp; thread, frame&amp; frame);</span>
<span class="udiff-line-removed">-   bool record_safe(JavaThread* thread, int skip, bool leakp = false);</span>
<span class="udiff-line-removed">-   void resolve_linenos();</span>
<span class="udiff-line-removed">-   void set_nr_of_frames(u4 nr_of_frames) { _nr_of_frames = nr_of_frames; }</span>
<span class="udiff-line-removed">-   void set_hash(unsigned int hash) { _hash = hash; }</span>
<span class="udiff-line-removed">-   void set_frame(u4 frame_pos, JfrStackFrame&amp; frame);</span>
<span class="udiff-line-removed">-   void set_reached_root(bool reached_root) { _reached_root = reached_root; }</span>
<span class="udiff-line-removed">-   bool full_stacktrace() const { return _reached_root; }</span>
<span class="udiff-line-removed">-   bool have_lineno() const { return _lineno; }</span>
<span class="udiff-line-removed">- };</span>
  
  class JfrStackTraceRepository : public JfrCHeapObj {
    friend class JfrRecorder;
    friend class JfrRecorderService;
<span class="udiff-line-added">+   friend class JfrThreadSampleClosure;</span>
<span class="udiff-line-added">+   friend class ObjectSampleCheckpoint;</span>
    friend class ObjectSampler;
<span class="udiff-line-modified-removed">-   friend class WriteObjectSampleStacktrace;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-   class StackTrace : public JfrCHeapObj {</span>
<span class="udiff-line-removed">-     friend class JfrStackTrace;</span>
<span class="udiff-line-removed">-     friend class JfrStackTraceRepository;</span>
<span class="udiff-line-removed">-    private:</span>
<span class="udiff-line-removed">-     StackTrace* _next;</span>
<span class="udiff-line-removed">-     JfrStackFrame* _frames;</span>
<span class="udiff-line-removed">-     const traceid _id;</span>
<span class="udiff-line-removed">-     u4 _nr_of_frames;</span>
<span class="udiff-line-removed">-     unsigned int _hash;</span>
<span class="udiff-line-removed">-     bool _reached_root;</span>
<span class="udiff-line-removed">-     mutable bool _written;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     unsigned int hash() const { return _hash; }</span>
<span class="udiff-line-removed">-     bool should_write() const { return !_written; }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-    public:</span>
<span class="udiff-line-removed">-     StackTrace(traceid id, const JfrStackTrace&amp; trace, StackTrace* next);</span>
<span class="udiff-line-removed">-     ~StackTrace();</span>
<span class="udiff-line-removed">-     traceid id() const { return _id; }</span>
<span class="udiff-line-removed">-     StackTrace* next() const { return _next; }</span>
<span class="udiff-line-removed">-     void write(JfrChunkWriter&amp; cw) const;</span>
<span class="udiff-line-removed">-     void write(JfrCheckpointWriter&amp; cpw) const;</span>
<span class="udiff-line-removed">-     bool equals(const JfrStackTrace&amp; rhs) const;</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-modified-added">+   friend class StackTraceBlobInstaller;</span>
<span class="udiff-line-modified-added">+   friend class StackTraceRepository;</span>
  
   private:
    static const u4 TABLE_SIZE = 2053;
<span class="udiff-line-modified-removed">-   StackTrace* _table[TABLE_SIZE];</span>
<span class="udiff-line-modified-added">+   JfrStackTrace* _table[TABLE_SIZE];</span>
    traceid _next_id;
    u4 _entries;
  
<span class="udiff-line-removed">-   size_t write_impl(JfrChunkWriter&amp; cw, bool clear);</span>
<span class="udiff-line-removed">-   traceid record_for(JavaThread* thread, int skip, JfrStackFrame* frames, u4 max_frames);</span>
<span class="udiff-line-removed">-   traceid record_for(JavaThread* thread, int skip, JfrStackFrame* frames, u4 max_frames, unsigned int* hash);</span>
<span class="udiff-line-removed">-   traceid add_trace(const JfrStackTrace&amp; stacktrace);</span>
<span class="udiff-line-removed">-   const StackTrace* resolve_entry(unsigned int hash, traceid id) const;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   static void write_metadata(JfrCheckpointWriter&amp; cpw);</span>
<span class="udiff-line-removed">- </span>
    JfrStackTraceRepository();
    static JfrStackTraceRepository&amp; instance();
<span class="udiff-line-removed">-  public:</span>
    static JfrStackTraceRepository* create();
<span class="udiff-line-removed">-   bool initialize();</span>
    static void destroy();
<span class="udiff-line-modified-removed">-   static traceid add(const JfrStackTrace&amp; stacktrace);</span>
<span class="udiff-line-modified-removed">-   static traceid record(Thread* thread, int skip = 0);</span>
<span class="udiff-line-modified-removed">-   static traceid record(Thread* thread, int skip, unsigned int* hash);</span>
<span class="udiff-line-removed">-   traceid write(JfrCheckpointWriter&amp; cpw, traceid id, unsigned int hash);</span>
<span class="udiff-line-modified-added">+   bool initialize();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool is_modified() const;</span>
    size_t write(JfrChunkWriter&amp; cw, bool clear);
    size_t clear();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   const JfrStackTrace* lookup(unsigned int hash, traceid id) const;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   traceid add_trace(const JfrStackTrace&amp; stacktrace);</span>
<span class="udiff-line-added">+   static traceid add(const JfrStackTrace&amp; stacktrace);</span>
<span class="udiff-line-added">+   traceid record_for(JavaThread* thread, int skip, JfrStackFrame* frames, u4 max_frames);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  public:</span>
<span class="udiff-line-added">+   static traceid record(Thread* thread, int skip = 0);</span>
<span class="udiff-line-added">+   static void record_and_cache(JavaThread* thread, int skip = 0);</span>
  };
  
  #endif // SHARE_JFR_RECORDER_STACKTRACE_JFRSTACKTRACEREPOSITORY_HPP
</pre>
<center><a href="jfrStackTraceRepository.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../storage/jfrBuffer.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>