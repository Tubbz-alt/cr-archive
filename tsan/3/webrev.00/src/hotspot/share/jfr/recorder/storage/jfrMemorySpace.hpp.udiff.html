<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/storage/jfrMemorySpace.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrBuffer.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrMemorySpace.inline.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/storage/jfrMemorySpace.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,14 +25,10 @@</span>
  #define SHARE_JFR_RECORDER_STORAGE_JFRMEMORYSPACE_HPP
  
  #include &quot;jfr/utilities/jfrAllocation.hpp&quot;
  #include &quot;jfr/utilities/jfrDoublyLinkedList.hpp&quot;
  #include &quot;jfr/utilities/jfrIterator.hpp&quot;
<span class="udiff-line-removed">- #include &quot;jfr/utilities/jfrTypes.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;runtime/os.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;utilities/globalDefinitions.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;utilities/macros.hpp&quot;</span>
  
  template &lt;typename T, template &lt;typename&gt; class RetrievalType, typename Callback&gt;
  class JfrMemorySpace : public JfrCHeapObj {
   public:
    typedef T Type;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -101,68 +97,10 @@</span>
    Type* get(size_t size, Thread* thread) { return Retrieval::get(size, this, thread); }
  
    template &lt;typename IteratorCallback, typename IteratorType&gt;
    void iterate(IteratorCallback&amp; callback, bool full = true, jfr_iter_direction direction = forward);
  
<span class="udiff-line-modified-removed">-   debug_only(bool in_full_list(const Type* t) const { return _full.in_list(t); })</span>
<span class="udiff-line-modified-removed">-   debug_only(bool in_free_list(const Type* t) const { return _free.in_list(t); })</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // allocations are even multiples of the mspace min size</span>
<span class="udiff-line-removed">- inline u8 align_allocation_size(u8 requested_size, size_t min_elem_size) {</span>
<span class="udiff-line-removed">-   assert((int)min_elem_size % os::vm_page_size() == 0, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   u8 alloc_size_bytes = min_elem_size;</span>
<span class="udiff-line-removed">-   while (requested_size &gt; alloc_size_bytes) {</span>
<span class="udiff-line-removed">-     alloc_size_bytes &lt;&lt;= 1;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   assert((int)alloc_size_bytes % os::vm_page_size() == 0, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   return alloc_size_bytes;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;typename T, template &lt;typename&gt; class RetrievalType, typename Callback&gt;</span>
<span class="udiff-line-removed">- T* JfrMemorySpace&lt;T, RetrievalType, Callback&gt;::allocate(size_t size) {</span>
<span class="udiff-line-removed">-   const u8 aligned_size_bytes = align_allocation_size(size, _min_elem_size);</span>
<span class="udiff-line-removed">-   void* const allocation = JfrCHeapObj::new_array&lt;u1&gt;(aligned_size_bytes + sizeof(T));</span>
<span class="udiff-line-removed">-   if (allocation == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   T* const t = new (allocation) T;</span>
<span class="udiff-line-removed">-   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   if (!t-&gt;initialize(sizeof(T), aligned_size_bytes)) {</span>
<span class="udiff-line-removed">-     JfrCHeapObj::free(t, aligned_size_bytes + sizeof(T));</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return t;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;typename T, template &lt;typename&gt; class RetrievalType, typename Callback&gt;</span>
<span class="udiff-line-removed">- void JfrMemorySpace&lt;T, RetrievalType, Callback&gt;::deallocate(T* t) {</span>
<span class="udiff-line-removed">-   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(!_free.in_list(t), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(!_full.in_list(t), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(t != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   JfrCHeapObj::free(t, t-&gt;total_size());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;typename Mspace&gt;</span>
<span class="udiff-line-removed">- class MspaceLock {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   Mspace* _mspace;</span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-   MspaceLock(Mspace* mspace) : _mspace(mspace) { _mspace-&gt;lock(); }</span>
<span class="udiff-line-removed">-   ~MspaceLock() { _mspace-&gt;unlock(); }</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- template &lt;typename Mspace&gt;</span>
<span class="udiff-line-removed">- class ReleaseOp : public StackObj {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   Mspace* _mspace;</span>
<span class="udiff-line-removed">-   Thread* _thread;</span>
<span class="udiff-line-removed">-   bool _release_full;</span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-   typedef typename Mspace::Type Type;</span>
<span class="udiff-line-removed">-   ReleaseOp(Mspace* mspace, Thread* thread, bool release_full = true) : _mspace(mspace), _thread(thread), _release_full(release_full) {}</span>
<span class="udiff-line-removed">-   bool process(Type* t);</span>
<span class="udiff-line-removed">-   size_t processed() const { return 0; }</span>
<span class="udiff-line-modified-added">+   bool in_full_list(const Type* t) const { return _full.in_list(t); }</span>
<span class="udiff-line-modified-added">+   bool in_free_list(const Type* t) const { return _free.in_list(t); }</span>
  };
  
  #endif // SHARE_JFR_RECORDER_STORAGE_JFRMEMORYSPACE_HPP
</pre>
<center><a href="jfrBuffer.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrMemorySpace.inline.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>