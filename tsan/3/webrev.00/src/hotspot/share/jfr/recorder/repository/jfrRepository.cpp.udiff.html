<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/repository/jfrRepository.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrEmergencyDump.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrRepository.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/repository/jfrRepository.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,12 +24,12 @@</span>
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;jfr/jfr.hpp&quot;
  #include &quot;jfr/jni/jfrJavaSupport.hpp&quot;
  #include &quot;jfr/recorder/jfrRecorder.hpp&quot;
<span class="udiff-line-removed">- #include &quot;jfr/recorder/repository/jfrChunkState.hpp&quot;</span>
  #include &quot;jfr/recorder/repository/jfrChunkWriter.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/recorder/repository/jfrEmergencyDump.hpp&quot;</span>
  #include &quot;jfr/recorder/repository/jfrRepository.hpp&quot;
  #include &quot;jfr/recorder/service/jfrPostBox.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/mutex.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,24 +42,21 @@</span>
    return *_instance;
  }
  
  static JfrChunkWriter* _chunkwriter = NULL;
  
<span class="udiff-line-removed">- static bool initialize_chunkwriter() {</span>
<span class="udiff-line-removed">-   assert(_chunkwriter == NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   _chunkwriter = new JfrChunkWriter();</span>
<span class="udiff-line-removed">-   return _chunkwriter != NULL &amp;&amp; _chunkwriter-&gt;initialize();</span>
<span class="udiff-line-removed">- }</span>
  
  JfrChunkWriter&amp; JfrRepository::chunkwriter() {
    return *_chunkwriter;
  }
  
  JfrRepository::JfrRepository(JfrPostBox&amp; post_box) : _path(NULL), _post_box(post_box) {}
  
  bool JfrRepository::initialize() {
<span class="udiff-line-modified-removed">-   return initialize_chunkwriter();</span>
<span class="udiff-line-modified-added">+   assert(_chunkwriter == NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   _chunkwriter = new JfrChunkWriter();</span>
<span class="udiff-line-added">+   return _chunkwriter != NULL;</span>
  }
  
  JfrRepository::~JfrRepository() {
    if (_path != NULL) {
      JfrCHeapObj::free(_path, strlen(_path) + 1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,325 +79,16 @@</span>
    assert(_instance != NULL, &quot;invariant&quot;);
    delete _instance;
    _instance = NULL;
  }
  
<span class="udiff-line-removed">- static const char vm_error_filename_fmt[] = &quot;hs_err_pid%p.jfr&quot;;</span>
<span class="udiff-line-removed">- static const char vm_oom_filename_fmt[] = &quot;hs_oom_pid%p.jfr&quot;;</span>
<span class="udiff-line-removed">- static const char vm_soe_filename_fmt[] = &quot;hs_soe_pid%p.jfr&quot;;</span>
<span class="udiff-line-removed">- static const char chunk_file_jfr_ext[] = &quot;.jfr&quot;;</span>
<span class="udiff-line-removed">- static const size_t iso8601_len = 19; // &quot;YYYY-MM-DDTHH:MM:SS&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static fio_fd open_exclusivly(const char* path) {</span>
<span class="udiff-line-removed">-   return os::open(path, O_CREAT | O_WRONLY, S_IREAD | S_IWRITE);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static fio_fd open_existing(const char* path) {</span>
<span class="udiff-line-removed">-   return os::open(path, O_RDWR, S_IREAD | S_IWRITE);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static int file_sort(const char** const file1, const char** file2) {</span>
<span class="udiff-line-removed">-   assert(NULL != *file1 &amp;&amp; NULL != *file2, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   int cmp = strncmp(*file1, *file2, iso8601_len);</span>
<span class="udiff-line-removed">-   if (0 == cmp) {</span>
<span class="udiff-line-removed">-     const char* const dot1 = strchr(*file1, &#39;.&#39;);</span>
<span class="udiff-line-removed">-     assert(NULL != dot1, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     const char* const dot2 = strchr(*file2, &#39;.&#39;);</span>
<span class="udiff-line-removed">-     assert(NULL != dot2, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     ptrdiff_t file1_len = dot1 - *file1;</span>
<span class="udiff-line-removed">-     ptrdiff_t file2_len = dot2 - *file2;</span>
<span class="udiff-line-removed">-     if (file1_len &lt; file2_len) {</span>
<span class="udiff-line-removed">-       return -1;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (file1_len &gt; file2_len) {</span>
<span class="udiff-line-removed">-       return 1;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     assert(file1_len == file2_len, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     cmp = strncmp(*file1, *file2, file1_len);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   assert(cmp != 0, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   return cmp;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static void iso8601_to_date_time(char* iso8601_str) {</span>
<span class="udiff-line-removed">-   assert(iso8601_str != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(strlen(iso8601_str) == iso8601_len, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   // &quot;YYYY-MM-DDTHH:MM:SS&quot;</span>
<span class="udiff-line-removed">-   for (size_t i = 0; i &lt; iso8601_len; ++i) {</span>
<span class="udiff-line-removed">-     switch(iso8601_str[i]) {</span>
<span class="udiff-line-removed">-       case &#39;T&#39; :</span>
<span class="udiff-line-removed">-       case &#39;-&#39; :</span>
<span class="udiff-line-removed">-       case &#39;:&#39; :</span>
<span class="udiff-line-removed">-         iso8601_str[i] = &#39;_&#39;;</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   // &quot;YYYY_MM_DD_HH_MM_SS&quot;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static void date_time(char* buffer, size_t buffer_len) {</span>
<span class="udiff-line-removed">-   assert(buffer != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(buffer_len &gt;= iso8601_len, &quot;buffer too small&quot;);</span>
<span class="udiff-line-removed">-   os::iso8601_time(buffer, buffer_len);</span>
<span class="udiff-line-removed">-   assert(strlen(buffer) &gt;= iso8601_len + 1, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   // &quot;YYYY-MM-DDTHH:MM:SS&quot;</span>
<span class="udiff-line-removed">-   buffer[iso8601_len] = &#39;\0&#39;;</span>
<span class="udiff-line-removed">-   iso8601_to_date_time(buffer);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static int64_t file_size(fio_fd fd) {</span>
<span class="udiff-line-removed">-   assert(fd != invalid_fd, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   const int64_t current_offset = os::current_file_offset(fd);</span>
<span class="udiff-line-removed">-   const int64_t size = os::lseek(fd, 0, SEEK_END);</span>
<span class="udiff-line-removed">-   os::seek_to_file_offset(fd, current_offset);</span>
<span class="udiff-line-removed">-   return size;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class RepositoryIterator : public StackObj {</span>
<span class="udiff-line-removed">-  private:</span>
<span class="udiff-line-removed">-   const char* const _repo;</span>
<span class="udiff-line-removed">-   const size_t _repository_len;</span>
<span class="udiff-line-removed">-   GrowableArray&lt;const char*&gt;* _files;</span>
<span class="udiff-line-removed">-   const char* const fully_qualified(const char* entry) const;</span>
<span class="udiff-line-removed">-   mutable int _iterator;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-    RepositoryIterator(const char* repository, size_t repository_len);</span>
<span class="udiff-line-removed">-    ~RepositoryIterator() {}</span>
<span class="udiff-line-removed">-   debug_only(void print_repository_files() const;)</span>
<span class="udiff-line-removed">-   const char* const filter(const char* entry) const;</span>
<span class="udiff-line-removed">-   bool has_next() const;</span>
<span class="udiff-line-removed">-   const char* const next() const;</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- const char* const RepositoryIterator::fully_qualified(const char* entry) const {</span>
<span class="udiff-line-removed">-   assert(NULL != entry, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   char* file_path_entry = NULL;</span>
<span class="udiff-line-removed">-    // only use files that have content, not placeholders</span>
<span class="udiff-line-removed">-   const char* const file_separator = os::file_separator();</span>
<span class="udiff-line-removed">-   if (NULL != file_separator) {</span>
<span class="udiff-line-removed">-     const size_t entry_len = strlen(entry);</span>
<span class="udiff-line-removed">-     const size_t file_separator_length = strlen(file_separator);</span>
<span class="udiff-line-removed">-     const size_t file_path_entry_length = _repository_len + file_separator_length + entry_len;</span>
<span class="udiff-line-removed">-     file_path_entry = NEW_RESOURCE_ARRAY_RETURN_NULL(char, file_path_entry_length + 1);</span>
<span class="udiff-line-removed">-     if (NULL == file_path_entry) {</span>
<span class="udiff-line-removed">-       return NULL;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     int position = 0;</span>
<span class="udiff-line-removed">-     position += jio_snprintf(&amp;file_path_entry[position], _repository_len + 1, &quot;%s&quot;, _repo);</span>
<span class="udiff-line-removed">-     position += jio_snprintf(&amp;file_path_entry[position], file_separator_length + 1, &quot;%s&quot;, os::file_separator());</span>
<span class="udiff-line-removed">-     position += jio_snprintf(&amp;file_path_entry[position], entry_len + 1, &quot;%s&quot;, entry);</span>
<span class="udiff-line-removed">-     file_path_entry[position] = &#39;\0&#39;;</span>
<span class="udiff-line-removed">-     assert((size_t)position == file_path_entry_length, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     assert(strlen(file_path_entry) == (size_t)position, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return file_path_entry;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- const char* const RepositoryIterator::filter(const char* entry) const {</span>
<span class="udiff-line-removed">-   if (entry == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   const size_t entry_len = strlen(entry);</span>
<span class="udiff-line-removed">-   if (entry_len &lt;= 2) {</span>
<span class="udiff-line-removed">-     // for &quot;.&quot; and &quot;..&quot;</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   char* entry_name = NEW_RESOURCE_ARRAY_RETURN_NULL(char, entry_len + 1);</span>
<span class="udiff-line-removed">-   if (entry_name == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   strncpy(entry_name, entry, entry_len + 1);</span>
<span class="udiff-line-removed">-   const char* const fully_qualified_path_entry = fully_qualified(entry_name);</span>
<span class="udiff-line-removed">-   if (NULL == fully_qualified_path_entry) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   const fio_fd entry_fd = open_existing(fully_qualified_path_entry);</span>
<span class="udiff-line-removed">-   if (invalid_fd == entry_fd) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   const int64_t entry_size = file_size(entry_fd);</span>
<span class="udiff-line-removed">-   os::close(entry_fd);</span>
<span class="udiff-line-removed">-   if (0 == entry_size) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return entry_name;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- RepositoryIterator::RepositoryIterator(const char* repository, size_t repository_len) :</span>
<span class="udiff-line-removed">-   _repo(repository),</span>
<span class="udiff-line-removed">-   _repository_len(repository_len),</span>
<span class="udiff-line-removed">-   _files(NULL),</span>
<span class="udiff-line-removed">-   _iterator(0) {</span>
<span class="udiff-line-removed">-   if (NULL != _repo) {</span>
<span class="udiff-line-removed">-     assert(strlen(_repo) == _repository_len, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     _files = new GrowableArray&lt;const char*&gt;(10);</span>
<span class="udiff-line-removed">-     DIR* dirp = os::opendir(_repo);</span>
<span class="udiff-line-removed">-     if (dirp == NULL) {</span>
<span class="udiff-line-removed">-       log_error(jfr, system)(&quot;Unable to open repository %s&quot;, _repo);</span>
<span class="udiff-line-removed">-       return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     struct dirent* dentry;</span>
<span class="udiff-line-removed">-     while ((dentry = os::readdir(dirp)) != NULL) {</span>
<span class="udiff-line-removed">-       const char* const entry_path = filter(dentry-&gt;d_name);</span>
<span class="udiff-line-removed">-       if (NULL != entry_path) {</span>
<span class="udiff-line-removed">-         _files-&gt;append(entry_path);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     os::closedir(dirp);</span>
<span class="udiff-line-removed">-     if (_files-&gt;length() &gt; 1) {</span>
<span class="udiff-line-removed">-       _files-&gt;sort(file_sort);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">- void RepositoryIterator::print_repository_files() const {</span>
<span class="udiff-line-removed">-   while (has_next()) {</span>
<span class="udiff-line-removed">-     log_error(jfr, system)( &quot;%s&quot;, next());</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool RepositoryIterator::has_next() const {</span>
<span class="udiff-line-removed">-   return (_files != NULL &amp;&amp; _iterator &lt; _files-&gt;length());</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- const char* const RepositoryIterator::next() const {</span>
<span class="udiff-line-removed">-   return _iterator &gt;= _files-&gt;length() ? NULL : fully_qualified(_files-&gt;at(_iterator++));</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static void write_emergency_file(fio_fd emergency_fd, const RepositoryIterator&amp; iterator) {</span>
<span class="udiff-line-removed">-   assert(emergency_fd != invalid_fd, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   const size_t size_of_file_copy_block = 1 * M; // 1 mb</span>
<span class="udiff-line-removed">-   jbyte* const file_copy_block = NEW_RESOURCE_ARRAY_RETURN_NULL(jbyte, size_of_file_copy_block);</span>
<span class="udiff-line-removed">-   if (file_copy_block == NULL) {</span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-  int64_t bytes_written_total = 0;</span>
<span class="udiff-line-removed">-   while (iterator.has_next()) {</span>
<span class="udiff-line-removed">-     fio_fd current_fd = invalid_fd;</span>
<span class="udiff-line-removed">-     const char* const fqn = iterator.next();</span>
<span class="udiff-line-removed">-     if (fqn != NULL) {</span>
<span class="udiff-line-removed">-       current_fd = open_existing(fqn);</span>
<span class="udiff-line-removed">-       if (current_fd != invalid_fd) {</span>
<span class="udiff-line-removed">-         const int64_t current_filesize = file_size(current_fd);</span>
<span class="udiff-line-removed">-         assert(current_filesize &gt; 0, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-         int64_t bytes_read = 0;</span>
<span class="udiff-line-removed">-         int64_t bytes_written = 0;</span>
<span class="udiff-line-removed">-         while (bytes_read &lt; current_filesize) {</span>
<span class="udiff-line-removed">-           const ssize_t read_result = os::read_at(current_fd, file_copy_block, size_of_file_copy_block, bytes_read);</span>
<span class="udiff-line-removed">-           if (-1 == read_result) {</span>
<span class="udiff-line-removed">-             log_info(jfr) ( // For user, should not be &quot;jfr, system&quot;</span>
<span class="udiff-line-removed">-               &quot;Unable to recover JFR data&quot;);</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-           bytes_read += (int64_t)read_result;</span>
<span class="udiff-line-removed">-           assert(bytes_read - bytes_written &lt;= (int64_t)size_of_file_copy_block, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-           bytes_written += (int64_t)os::write(emergency_fd, file_copy_block, bytes_read - bytes_written);</span>
<span class="udiff-line-removed">-           assert(bytes_read == bytes_written, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         os::close(current_fd);</span>
<span class="udiff-line-removed">-         bytes_written_total += bytes_written;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const char* create_emergency_dump_path() {</span>
<span class="udiff-line-removed">-   assert(JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   char* buffer = NEW_RESOURCE_ARRAY_RETURN_NULL(char, O_BUFLEN);</span>
<span class="udiff-line-removed">-   if (NULL == buffer) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   const char* const cwd = os::get_current_directory(buffer, O_BUFLEN);</span>
<span class="udiff-line-removed">-   if (NULL == cwd) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   size_t pos = strlen(cwd);</span>
<span class="udiff-line-removed">-   const int fsep_len = jio_snprintf(&amp;buffer[pos], O_BUFLEN - pos, &quot;%s&quot;, os::file_separator());</span>
<span class="udiff-line-removed">-   const char* filename_fmt = NULL;</span>
<span class="udiff-line-removed">-   // fetch specific error cause</span>
<span class="udiff-line-removed">-   switch (JfrJavaSupport::cause()) {</span>
<span class="udiff-line-removed">-     case JfrJavaSupport::OUT_OF_MEMORY:</span>
<span class="udiff-line-removed">-       filename_fmt = vm_oom_filename_fmt;</span>
<span class="udiff-line-removed">-       break;</span>
<span class="udiff-line-removed">-     case JfrJavaSupport::STACK_OVERFLOW:</span>
<span class="udiff-line-removed">-       filename_fmt = vm_soe_filename_fmt;</span>
<span class="udiff-line-removed">-       break;</span>
<span class="udiff-line-removed">-     default:</span>
<span class="udiff-line-removed">-       filename_fmt = vm_error_filename_fmt;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   char* emergency_dump_path = NULL;</span>
<span class="udiff-line-removed">-   pos += fsep_len;</span>
<span class="udiff-line-removed">-   if (Arguments::copy_expand_pid(filename_fmt, strlen(filename_fmt), &amp;buffer[pos], O_BUFLEN - pos)) {</span>
<span class="udiff-line-removed">-     const size_t emergency_filename_length = strlen(buffer);</span>
<span class="udiff-line-removed">-     emergency_dump_path = NEW_RESOURCE_ARRAY_RETURN_NULL(char, emergency_filename_length + 1);</span>
<span class="udiff-line-removed">-     if (NULL == emergency_dump_path) {</span>
<span class="udiff-line-removed">-       return NULL;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     strncpy(emergency_dump_path, buffer, emergency_filename_length + 1);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return emergency_dump_path;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Caller needs ResourceMark</span>
<span class="udiff-line-removed">- static const char* create_emergency_chunk_path(const char* repository_base, size_t repository_len) {</span>
<span class="udiff-line-removed">-   assert(repository_base != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   // date time</span>
<span class="udiff-line-removed">-   char date_time_buffer[32] = {0};</span>
<span class="udiff-line-removed">-   date_time(date_time_buffer, sizeof(date_time_buffer));</span>
<span class="udiff-line-removed">-   size_t date_time_len = strlen(date_time_buffer);</span>
<span class="udiff-line-removed">-   size_t chunkname_max_len = repository_len               // repository_base</span>
<span class="udiff-line-removed">-                              + 1                          // &quot;/&quot;</span>
<span class="udiff-line-removed">-                              + date_time_len              // date_time</span>
<span class="udiff-line-removed">-                              + strlen(chunk_file_jfr_ext) // .jfr</span>
<span class="udiff-line-removed">-                              + 1;</span>
<span class="udiff-line-removed">-   char* chunk_path = NEW_RESOURCE_ARRAY_RETURN_NULL(char, chunkname_max_len);</span>
<span class="udiff-line-removed">-   if (chunk_path == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   // append the individual substrings</span>
<span class="udiff-line-removed">-   jio_snprintf(chunk_path, chunkname_max_len, &quot;%s%s%s%s&quot;, repository_base, os::file_separator(), date_time_buffer, chunk_file_jfr_ext);</span>
<span class="udiff-line-removed">-   return chunk_path;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static fio_fd emergency_dump_file() {</span>
<span class="udiff-line-removed">-   assert(JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   ResourceMark rm;</span>
<span class="udiff-line-removed">-   const char* const emergency_dump_path = create_emergency_dump_path();</span>
<span class="udiff-line-removed">-   if (emergency_dump_path == NULL) {</span>
<span class="udiff-line-removed">-     return invalid_fd;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   const fio_fd fd = open_exclusivly(emergency_dump_path);</span>
<span class="udiff-line-removed">-   if (fd != invalid_fd) {</span>
<span class="udiff-line-removed">-     log_info(jfr)( // For user, should not be &quot;jfr, system&quot;</span>
<span class="udiff-line-removed">-       &quot;Attempting to recover JFR data, emergency jfr file: %s&quot;, emergency_dump_path);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return fd;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const char* emergency_path(const char* repository, size_t repository_len) {</span>
<span class="udiff-line-removed">-   return repository == NULL ? create_emergency_dump_path() : create_emergency_chunk_path(repository, repository_len);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void JfrRepository::on_vm_error() {
<span class="udiff-line-modified-removed">-   assert(!JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   const char* path = _path;</span>
<span class="udiff-line-removed">-   if (path == NULL) {</span>
<span class="udiff-line-modified-added">+   if (_path == NULL) {</span>
      // completed already
      return;
    }
<span class="udiff-line-modified-removed">-   ResourceMark rm;</span>
<span class="udiff-line-removed">-   MutexLockerEx stream_lock(JfrStream_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-removed">-   const fio_fd emergency_fd = emergency_dump_file();</span>
<span class="udiff-line-removed">-   if (emergency_fd != invalid_fd) {</span>
<span class="udiff-line-removed">-     RepositoryIterator iterator(path, strlen(path));</span>
<span class="udiff-line-removed">-     write_emergency_file(emergency_fd, iterator);</span>
<span class="udiff-line-removed">-     os::close(emergency_fd);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   JfrEmergencyDump::on_vm_error(_path);</span>
  }
  
  bool JfrRepository::set_path(const char* path) {
    assert(path != NULL, &quot;trying to set the repository path with a NULL string!&quot;);
    if (_path != NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,21 +102,29 @@</span>
    }
    strncpy(_path, path, path_len + 1);
    return true;
  }
  
<span class="udiff-line-removed">- void JfrRepository::set_chunk_path(const char* path) {</span>
<span class="udiff-line-removed">-   assert(JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   chunkwriter().set_chunk_path(path);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void JfrRepository::notify_on_new_chunk_path() {
    if (Jfr::is_recording()) {
<span class="udiff-line-added">+     // rotations are synchronous, block until rotation completes</span>
      instance()._post_box.post(MSG_ROTATE);
    }
  }
  
<span class="udiff-line-added">+ void JfrRepository::set_chunk_path(const char* path) {</span>
<span class="udiff-line-added">+   chunkwriter().set_path(path);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void JfrRepository::mark_chunk_final() {</span>
<span class="udiff-line-added">+   chunkwriter().mark_chunk_final();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ jlong JfrRepository::current_chunk_start_nanos() {</span>
<span class="udiff-line-added">+   return chunkwriter().current_chunk_start_nanos();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /**
  * Sets the file where data should be written.
  *
  * Recording  Previous  Current  Action
  * ==============================================
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -441,18 +137,15 @@</span>
  */
  void JfrRepository::set_chunk_path(jstring path, JavaThread* jt) {
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(jt));
    ResourceMark rm(jt);
    const char* const canonical_chunk_path = JfrJavaSupport::c_str(path, jt);
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-modified-removed">-     MutexLockerEx stream_lock(JfrStream_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-removed">-     if (NULL == canonical_chunk_path &amp;&amp; !_chunkwriter-&gt;is_valid()) {</span>
<span class="udiff-line-removed">-       // new output is NULL and current output is NULL</span>
<span class="udiff-line-removed">-       return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     instance().set_chunk_path(canonical_chunk_path);</span>
<span class="udiff-line-modified-added">+   if (NULL == canonical_chunk_path &amp;&amp; !_chunkwriter-&gt;is_valid()) {</span>
<span class="udiff-line-modified-added">+     // new output is NULL and current output is NULL</span>
<span class="udiff-line-modified-added">+     return;</span>
    }
<span class="udiff-line-added">+   instance().set_chunk_path(canonical_chunk_path);</span>
    notify_on_new_chunk_path();
  }
  
  void JfrRepository::set_path(jstring location, JavaThread* jt) {
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(jt));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -462,19 +155,30 @@</span>
      instance().set_path(path);
    }
  }
  
  bool JfrRepository::open_chunk(bool vm_error /* false */) {
<span class="udiff-line-removed">-   assert(JfrStream_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
    if (vm_error) {
      ResourceMark rm;
<span class="udiff-line-modified-removed">-     const char* repository_path = _path;</span>
<span class="udiff-line-removed">-     const size_t repository_path_len = repository_path != NULL ? strlen(repository_path) : 0;</span>
<span class="udiff-line-removed">-     const char* const path = emergency_path(repository_path, repository_path_len);</span>
<span class="udiff-line-removed">-     _chunkwriter-&gt;set_chunk_path(path);</span>
<span class="udiff-line-modified-added">+     _chunkwriter-&gt;set_path(JfrEmergencyDump::build_dump_path(_path));</span>
    }
    return _chunkwriter-&gt;open();
  }
  
<span class="udiff-line-modified-removed">- size_t JfrRepository::close_chunk(int64_t metadata_offset) {</span>
<span class="udiff-line-modified-removed">-   return _chunkwriter-&gt;close(metadata_offset);</span>
<span class="udiff-line-modified-added">+ size_t JfrRepository::close_chunk() {</span>
<span class="udiff-line-modified-added">+   return _chunkwriter-&gt;close();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void JfrRepository::flush(JavaThread* jt) {</span>
<span class="udiff-line-added">+   DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(jt));</span>
<span class="udiff-line-added">+   if (!Jfr::is_recording()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   if (!_chunkwriter-&gt;is_valid()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   instance()._post_box.post(MSG_FLUSHPOINT);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ size_t JfrRepository::flush_chunk() {</span>
<span class="udiff-line-added">+   return _chunkwriter-&gt;flush_chunk(true);</span>
  }
</pre>
<center><a href="jfrEmergencyDump.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrRepository.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>