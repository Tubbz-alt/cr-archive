<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/checkpoint/types/traceid/jfrTraceIdBits.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="jfrTraceId.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="jfrTraceIdEpoch.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/checkpoint/types/traceid/jfrTraceIdBits.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,58 +30,56 @@</span>
  #include &quot;runtime/orderAccess.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  
  #ifdef VM_LITTLE_ENDIAN
  static const int low_offset = 0;
<span class="udiff-line-modified-removed">- static const int leakp_offset = low_offset + 1;</span>
<span class="udiff-line-modified-added">+ static const int meta_offset = low_offset + 1;</span>
  #else
  static const int low_offset = 7;
<span class="udiff-line-modified-removed">- static const int leakp_offset = low_offset - 1;</span>
<span class="udiff-line-modified-added">+ static const int meta_offset = low_offset - 1;</span>
  #endif
  
<span class="udiff-line-modified-removed">- inline void set_bits(jbyte bits, jbyte* const dest) {</span>
<span class="udiff-line-modified-added">+ inline void set_bits(jbyte bits, jbyte volatile* const dest) {</span>
    assert(dest != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   const jbyte current = OrderAccess::load_acquire(dest);</span>
<span class="udiff-line-modified-removed">-   if (bits != (current &amp; bits)) {</span>
<span class="udiff-line-removed">-     *dest |= bits;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   *dest |= bits;</span>
<span class="udiff-line-modified-added">+   OrderAccess::storestore();</span>
  }
  
<span class="udiff-line-modified-removed">- inline void set_mask(jbyte mask, jbyte* const dest) {</span>
<span class="udiff-line-modified-removed">-   assert(dest != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   const jbyte current = OrderAccess::load_acquire(dest);</span>
<span class="udiff-line-removed">-   if (mask != (current &amp; mask)) {</span>
<span class="udiff-line-removed">-     *dest &amp;= mask;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ inline jbyte traceid_and(jbyte current, jbyte bits) {</span>
<span class="udiff-line-modified-added">+   return current &amp; bits;</span>
  }
  
<span class="udiff-line-modified-removed">- inline void set_bits_cas(jbyte bits, jbyte* const dest) {</span>
<span class="udiff-line-modified-added">+ inline jbyte traceid_or(jbyte current, jbyte bits) {</span>
<span class="udiff-line-added">+   return current | bits;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ inline jbyte traceid_xor(jbyte current, jbyte bits) {</span>
<span class="udiff-line-added">+   return current ^ bits;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;jbyte op(jbyte, jbyte)&gt;</span>
<span class="udiff-line-added">+ inline void set_bits_cas_form(jbyte bits, jbyte* const dest) {</span>
    assert(dest != NULL, &quot;invariant&quot;);
    do {
<span class="udiff-line-modified-removed">-     const jbyte current = OrderAccess::load_acquire(dest);</span>
<span class="udiff-line-modified-removed">-     if (bits == (current &amp; bits)) {</span>
<span class="udiff-line-modified-removed">-       return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     const jbyte new_value = current | bits;</span>
<span class="udiff-line-removed">-     if (Atomic::cmpxchg(new_value, dest, current) == current) {</span>
<span class="udiff-line-modified-added">+     const jbyte current = *dest;</span>
<span class="udiff-line-modified-added">+     const jbyte new_value = op(current, bits);</span>
<span class="udiff-line-modified-added">+     if (Atomic::cmpxchg(dest, current, new_value) == current) {</span>
        return;
      }
    } while (true);
  }
  
<span class="udiff-line-added">+ inline void set_bits_cas(jbyte bits, jbyte* const dest) {</span>
<span class="udiff-line-added">+   set_bits_cas_form&lt;traceid_or&gt;(bits, dest);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  inline void clear_bits_cas(jbyte bits, jbyte* const dest) {
<span class="udiff-line-modified-removed">-   assert(dest != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-removed">-   do {</span>
<span class="udiff-line-modified-removed">-     const jbyte current = OrderAccess::load_acquire(dest);</span>
<span class="udiff-line-modified-removed">-     if (bits != (current &amp; bits)) {</span>
<span class="udiff-line-modified-removed">-       return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     const jbyte new_value = current ^ bits;</span>
<span class="udiff-line-removed">-     if (Atomic::cmpxchg(new_value, dest, current) == current) {</span>
<span class="udiff-line-removed">-       return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   } while (true);</span>
<span class="udiff-line-modified-added">+   set_bits_cas_form&lt;traceid_xor&gt;(bits, dest);</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ inline void set_mask(jbyte mask, jbyte* const dest) {</span>
<span class="udiff-line-modified-added">+   set_bits_cas_form&lt;traceid_and&gt;(mask, dest);</span>
  }
  
  inline void set_traceid_bits(jbyte bits, traceid* dest) {
    set_bits(bits, ((jbyte*)dest) + low_offset);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -92,18 +90,30 @@</span>
  
  inline void set_traceid_mask(jbyte mask, traceid* dest) {
    set_mask(mask, ((jbyte*)dest) + low_offset);
  }
  
<span class="udiff-line-modified-removed">- inline void set_leakp_traceid_bits(jbyte bits, traceid* dest) {</span>
<span class="udiff-line-modified-removed">-   set_bits(bits, ((jbyte*)dest) + leakp_offset);</span>
<span class="udiff-line-modified-added">+ inline void set_meta_bits(jbyte bits, jbyte* const dest) {</span>
<span class="udiff-line-modified-added">+   assert(dest != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   *dest |= bits;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ inline void set_traceid_meta_bits(jbyte bits, traceid* dest) {</span>
<span class="udiff-line-added">+   set_meta_bits(bits, ((jbyte*)dest) + meta_offset);</span>
  }
  
<span class="udiff-line-modified-removed">- inline void set_leakp_traceid_bits_cas(jbyte bits, traceid* dest) {</span>
<span class="udiff-line-modified-removed">-   set_bits_cas(bits, ((jbyte*)dest) + leakp_offset);</span>
<span class="udiff-line-modified-added">+ inline void set_meta_mask(jbyte mask, jbyte* const dest) {</span>
<span class="udiff-line-modified-added">+   assert(dest != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   *dest &amp;= mask;</span>
  }
  
<span class="udiff-line-modified-removed">- inline void set_leakp_traceid_mask(jbyte mask, traceid* dest) {</span>
<span class="udiff-line-modified-removed">-   set_mask(mask, ((jbyte*)dest) + leakp_offset);</span>
<span class="udiff-line-modified-added">+ inline void set_traceid_meta_mask(jbyte mask, traceid* dest) {</span>
<span class="udiff-line-modified-added">+   set_meta_mask(mask, ((jbyte*)dest) + meta_offset);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // only used by a single thread with no visibility requirements</span>
<span class="udiff-line-added">+ inline void clear_meta_bits(jbyte bits, jbyte* const dest) {</span>
<span class="udiff-line-added">+   assert(dest != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   *dest ^= bits;</span>
  }
  
  #endif // SHARE_JFR_RECORDER_CHECKPOINT_TYPES_TRACEID_JFRTRACEIDBITS_INLINE_HPP
</pre>
<center><a href="jfrTraceId.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="jfrTraceIdEpoch.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>