<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/utilities/jfrHashtable.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="jfrDoublyLinkedList.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrJavaLog.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/utilities/jfrHashtable.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,26 +23,26 @@</span>
   */
  
  #ifndef SHARE_JFR_UTILITIES_JFRHASHTABLE_HPP
  #define SHARE_JFR_UTILITIES_JFRHASHTABLE_HPP
  
<span class="udiff-line-modified-removed">- #include &quot;memory/allocation.inline.hpp&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;runtime/orderAccess.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;jfr/utilities/jfrAllocation.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- class JfrBasicHashtableEntry {</span>
<span class="udiff-line-modified-added">+ class JfrBasicHashtableEntry : public JfrCHeapObj {</span>
   private:
    typedef JfrBasicHashtableEntry&lt;T&gt; Entry;
    Entry* _next;
    T _literal;          // ref to item in table.
    uintptr_t _hash;
  
   public:
<span class="udiff-line-added">+   JfrBasicHashtableEntry(uintptr_t hash, const T&amp; data) : _next(NULL), _literal(data), _hash(hash) {}</span>
    uintptr_t hash() const { return _hash; }
<span class="udiff-line-removed">-   void set_hash(uintptr_t hash) { _hash = hash; }</span>
    T literal() const { return _literal; }
    T* literal_addr() { return &amp;_literal; }
    void set_literal(T s) { _literal = s; }
    void set_next(Entry* next) { _next = next; }
    Entry* next() const { return _next; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,13 +56,13 @@</span>
   private:
    typedef JfrBasicHashtableEntry&lt;T&gt; TableEntry;
    TableEntry* _entry;
  
    TableEntry* get_entry() const {
<span class="udiff-line-modified-removed">-     return (TableEntry*)OrderAccess::load_acquire(&amp;_entry);</span>
<span class="udiff-line-modified-added">+     return (TableEntry*)Atomic::load_acquire(&amp;_entry);</span>
    }
<span class="udiff-line-modified-removed">-   void set_entry(TableEntry* entry) { OrderAccess::release_store(&amp;_entry, entry);}</span>
<span class="udiff-line-modified-added">+   void set_entry(TableEntry* entry) { Atomic::release_store(&amp;_entry, entry);}</span>
    TableEntry** entry_addr() { return &amp;_entry; }
  };
  
  template &lt;typename T&gt;
  class JfrBasicHashtable : public CHeapObj&lt;mtTracing&gt; {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,14 +90,11 @@</span>
    void unlink_entry(TableEntry* entry) {
      entry-&gt;set_next(NULL);
      --_number_of_entries;
    }
    void free_buckets() {
<span class="udiff-line-modified-removed">-     if (NULL != _buckets) {</span>
<span class="udiff-line-removed">-       FREE_C_HEAP_ARRAY(Bucket, _buckets);</span>
<span class="udiff-line-removed">-       _buckets = NULL;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     FREE_C_HEAP_ARRAY(Bucket, _buckets);</span>
    }
    TableEntry* bucket(size_t i) { return _buckets[i].get_entry();}
    TableEntry** bucket_addr(size_t i) { return _buckets[i].entry_addr(); }
    uintptr_t table_size() const { return _table_size; }
    size_t number_of_entries() const { return _number_of_entries; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -108,72 +105,69 @@</span>
      ++_number_of_entries;
    }
  };
  
  template &lt;typename IdType, typename Entry, typename T&gt;
<span class="udiff-line-modified-removed">- class AscendingId : public CHeapObj&lt;mtTracing&gt;  {</span>
<span class="udiff-line-modified-added">+ class AscendingId : public JfrCHeapObj  {</span>
   private:
    IdType _id;
   public:
    AscendingId() : _id(0) {}
    // callbacks
<span class="udiff-line-modified-removed">-   void assign_id(Entry* entry) {</span>
<span class="udiff-line-modified-added">+   void on_link(Entry* entry) {</span>
      assert(entry != NULL, &quot;invariant&quot;);
      assert(entry-&gt;id() == 0, &quot;invariant&quot;);
      entry-&gt;set_id(++_id);
    }
<span class="udiff-line-modified-removed">-   bool equals(const T&amp; data, uintptr_t hash, const Entry* entry) {</span>
<span class="udiff-line-modified-added">+   bool on_equals(uintptr_t hash, const Entry* entry) {</span>
      assert(entry-&gt;hash() == hash, &quot;invariant&quot;);
      return true;
    }
  };
  
  // IdType must be scalar
  template &lt;typename T, typename IdType&gt;
<span class="udiff-line-modified-removed">- class Entry : public JfrBasicHashtableEntry&lt;T&gt; {</span>
<span class="udiff-line-modified-added">+ class JfrHashtableEntry : public JfrBasicHashtableEntry&lt;T&gt; {</span>
   public:
<span class="udiff-line-added">+   JfrHashtableEntry(uintptr_t hash, const T&amp; data) : JfrBasicHashtableEntry&lt;T&gt;(hash, data), _id(0) {}</span>
    typedef IdType ID;
<span class="udiff-line-removed">-   void init() { _id = 0; }</span>
    ID id() const { return _id; }
<span class="udiff-line-modified-removed">-   void set_id(ID id) { _id = id; }</span>
<span class="udiff-line-modified-removed">-   void set_value(const T&amp; value) { this-&gt;set_literal(value); }</span>
<span class="udiff-line-modified-removed">-   T&amp; value() const { return *const_cast&lt;Entry*&gt;(this)-&gt;literal_addr();}</span>
<span class="udiff-line-removed">-   const T* value_addr() const { return const_cast&lt;Entry*&gt;(this)-&gt;literal_addr(); }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+   void set_id(ID id) const { _id = id; }</span>
<span class="udiff-line-modified-added">+   T&amp; value() const { return *const_cast&lt;JfrHashtableEntry*&gt;(this)-&gt;literal_addr();}</span>
<span class="udiff-line-modified-added">+   const T* value_addr() const { return const_cast&lt;JfrHashtableEntry*&gt;(this)-&gt;literal_addr(); }</span>
   private:
<span class="udiff-line-modified-removed">-   ID _id;</span>
<span class="udiff-line-modified-added">+   mutable ID _id;</span>
  };
  
  template &lt;typename T, typename IdType, template &lt;typename, typename&gt; class Entry,
            typename Callback = AscendingId&lt;IdType, Entry&lt;T, IdType&gt;, T&gt; ,
            size_t TABLE_SIZE = 1009&gt;
  class HashTableHost : public JfrBasicHashtable&lt;T&gt; {
   public:
    typedef Entry&lt;T, IdType&gt; HashEntry;
<span class="udiff-line-modified-removed">-   HashTableHost() : _callback(new Callback()) {}</span>
<span class="udiff-line-modified-removed">-   HashTableHost(Callback* cb) : JfrBasicHashtable&lt;T&gt;(TABLE_SIZE, sizeof(HashEntry)), _callback(cb) {}</span>
<span class="udiff-line-modified-added">+   HashTableHost(size_t size = 0) : JfrBasicHashtable&lt;T&gt;(size == 0 ? TABLE_SIZE : size, sizeof(HashEntry)), _callback(new Callback()) {}</span>
<span class="udiff-line-modified-added">+   HashTableHost(Callback* cb, size_t size = 0) : JfrBasicHashtable&lt;T&gt;(size == 0 ? TABLE_SIZE : size, sizeof(HashEntry)), _callback(cb) {}</span>
    ~HashTableHost() {
      this-&gt;clear_entries();
      this-&gt;free_buckets();
    }
  
    // direct insert assumes non-existing entry
<span class="udiff-line-modified-removed">-   HashEntry&amp; put(const T&amp; data, uintptr_t hash);</span>
<span class="udiff-line-modified-added">+   HashEntry&amp; put(uintptr_t hash, const T&amp; data);</span>
  
    // lookup entry, will put if not found
<span class="udiff-line-modified-removed">-   HashEntry&amp; lookup_put(const T&amp; data, uintptr_t hash) {</span>
<span class="udiff-line-modified-removed">-     HashEntry* entry = lookup_only(data, hash);</span>
<span class="udiff-line-modified-removed">-     return entry == NULL ? put(data, hash) : *entry;</span>
<span class="udiff-line-modified-added">+   HashEntry&amp; lookup_put(uintptr_t hash, const T&amp; data) {</span>
<span class="udiff-line-modified-added">+     HashEntry* entry = lookup_only(hash);</span>
<span class="udiff-line-modified-added">+     return entry == NULL ? put(hash, data) : *entry;</span>
    }
  
<span class="udiff-line-modified-removed">-   // read-only lookup</span>
<span class="udiff-line-removed">-   HashEntry* lookup_only(const T&amp; query, uintptr_t hash);</span>
<span class="udiff-line-modified-added">+   HashEntry* lookup_only(uintptr_t hash);</span>
  
    // id retrieval
<span class="udiff-line-modified-removed">-   IdType id(const T&amp; data, uintptr_t hash) {</span>
<span class="udiff-line-modified-added">+   IdType id(uintptr_t hash, const T&amp; data) {</span>
      assert(data != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-     const HashEntry&amp; entry = lookup_put(data, hash);</span>
<span class="udiff-line-modified-added">+     const HashEntry&amp; entry = lookup_put(hash, data);</span>
      assert(entry.id() &gt; 0, &quot;invariant&quot;);
      return entry.id();
    }
  
    template &lt;typename Functor&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -188,38 +182,39 @@</span>
  
    // removal and deallocation
    void free_entry(HashEntry* entry) {
      assert(entry != NULL, &quot;invariant&quot;);
      JfrBasicHashtable&lt;T&gt;::unlink_entry(entry);
<span class="udiff-line-modified-removed">-     FREE_C_HEAP_ARRAY(char, entry);</span>
<span class="udiff-line-modified-added">+     _callback-&gt;on_unlink(entry);</span>
<span class="udiff-line-added">+     delete entry;</span>
    }
  
   private:
    Callback* _callback;
    size_t index_for(uintptr_t hash) { return this-&gt;hash_to_index(hash); }
<span class="udiff-line-modified-removed">-   HashEntry* new_entry(const T&amp; data, uintptr_t hash);</span>
<span class="udiff-line-modified-added">+   HashEntry* new_entry(uintptr_t hash, const T&amp; data);</span>
    void add_entry(size_t index, HashEntry* new_entry) {
      assert(new_entry != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-     _callback-&gt;assign_id(new_entry);</span>
<span class="udiff-line-modified-added">+     _callback-&gt;on_link(new_entry);</span>
      assert(new_entry-&gt;id() &gt; 0, &quot;invariant&quot;);
      JfrBasicHashtable&lt;T&gt;::add_entry(index, new_entry);
    }
  };
  
  template &lt;typename T, typename IdType, template &lt;typename, typename&gt; class Entry, typename Callback, size_t TABLE_SIZE&gt;
<span class="udiff-line-modified-removed">- Entry&lt;T, IdType&gt;&amp; HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::put(const T&amp; data, uintptr_t hash) {</span>
<span class="udiff-line-modified-removed">-   assert(lookup_only(data, hash) == NULL, &quot;use lookup_put()&quot;);</span>
<span class="udiff-line-modified-removed">-   HashEntry* const entry = new_entry(data, hash);</span>
<span class="udiff-line-modified-added">+ Entry&lt;T, IdType&gt;&amp; HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::put(uintptr_t hash, const T&amp; data) {</span>
<span class="udiff-line-modified-added">+   assert(lookup_only(hash) == NULL, &quot;use lookup_put()&quot;);</span>
<span class="udiff-line-modified-added">+   HashEntry* const entry = new_entry(hash, data);</span>
    add_entry(index_for(hash), entry);
    return *entry;
  }
  
  template &lt;typename T, typename IdType, template &lt;typename, typename&gt; class Entry, typename Callback, size_t TABLE_SIZE&gt;
<span class="udiff-line-modified-removed">- Entry&lt;T, IdType&gt;* HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::lookup_only(const T&amp; query, uintptr_t hash) {</span>
<span class="udiff-line-modified-added">+ Entry&lt;T, IdType&gt;* HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::lookup_only(uintptr_t hash) {</span>
    HashEntry* entry = (HashEntry*)this-&gt;bucket(index_for(hash));
    while (entry != NULL) {
<span class="udiff-line-modified-removed">-     if (entry-&gt;hash() == hash &amp;&amp; _callback-&gt;equals(query, hash, entry)) {</span>
<span class="udiff-line-modified-added">+     if (entry-&gt;hash() == hash &amp;&amp; _callback-&gt;on_equals(hash, entry)) {</span>
        return entry;
      }
      entry = (HashEntry*)entry-&gt;next();
    }
    return NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -267,17 +262,14 @@</span>
    }
    assert(this-&gt;number_of_entries() == 0, &quot;should have removed all entries&quot;);
  }
  
  template &lt;typename T, typename IdType, template &lt;typename, typename&gt; class Entry, typename Callback, size_t TABLE_SIZE&gt;
<span class="udiff-line-modified-removed">- Entry&lt;T, IdType&gt;* HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::new_entry(const T&amp; data, uintptr_t hash) {</span>
<span class="udiff-line-modified-added">+ Entry&lt;T, IdType&gt;* HashTableHost&lt;T, IdType, Entry, Callback, TABLE_SIZE&gt;::new_entry(uintptr_t hash, const T&amp; data) {</span>
    assert(sizeof(HashEntry) == this-&gt;entry_size(), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   HashEntry* const entry = (HashEntry*) NEW_C_HEAP_ARRAY2(char, this-&gt;entry_size(), mtTracing, CURRENT_PC);</span>
<span class="udiff-line-modified-removed">-   entry-&gt;init();</span>
<span class="udiff-line-removed">-   entry-&gt;set_hash(hash);</span>
<span class="udiff-line-removed">-   entry-&gt;set_value(data);</span>
<span class="udiff-line-removed">-   entry-&gt;set_next(NULL);</span>
<span class="udiff-line-modified-added">+   HashEntry* const entry = new HashEntry(hash, data);</span>
<span class="udiff-line-modified-added">+   assert(entry != NULL, &quot;invariant&quot;);</span>
    assert(0 == entry-&gt;id(), &quot;invariant&quot;);
    return entry;
  }
  
  #endif // SHARE_JFR_UTILITIES_JFRHASHTABLE_HPP
</pre>
<center><a href="jfrDoublyLinkedList.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrJavaLog.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>