<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/leakProfiler.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="checkpoint/rootResolver.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="leakProfiler.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/leakProfiler.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,122 +21,91 @@</span>
   * questions.
   *
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="udiff-line-removed">- #include &quot;jfr/leakprofiler/emitEventOperation.hpp&quot;</span>
  #include &quot;jfr/leakprofiler/leakProfiler.hpp&quot;
  #include &quot;jfr/leakprofiler/startOperation.hpp&quot;
  #include &quot;jfr/leakprofiler/stopOperation.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/leakprofiler/checkpoint/eventEmitter.hpp&quot;</span>
  #include &quot;jfr/leakprofiler/sampling/objectSampler.hpp&quot;
  #include &quot;jfr/recorder/service/jfrOptionSet.hpp&quot;
<span class="udiff-line-added">+ #include &quot;logging/log.hpp&quot;</span>
  #include &quot;memory/iterator.hpp&quot;
<span class="udiff-line-removed">- #include &quot;oops/oop.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;runtime/atomic.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;runtime/orderAccess.hpp&quot;</span>
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;runtime/vmThread.hpp&quot;
<span class="udiff-line-removed">- #include &quot;utilities/ostream.hpp&quot;</span>
  
<span class="udiff-line-modified-removed">- // Only to be updated during safepoint</span>
<span class="udiff-line-modified-removed">- ObjectSampler* LeakProfiler::_object_sampler = NULL;</span>
<span class="udiff-line-modified-added">+ bool LeakProfiler::is_running() {</span>
<span class="udiff-line-modified-added">+   return ObjectSampler::is_created();</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">- static volatile jbyte suspended = 0;</span>
<span class="udiff-line-modified-removed">- bool LeakProfiler::start(jint sample_count) {</span>
<span class="udiff-line-modified-removed">-   if (UseZGC) {</span>
<span class="udiff-line-removed">-     log_warning(jfr)(&quot;LeakProfiler is currently not supported in combination with ZGC&quot;);</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-modified-added">+ bool LeakProfiler::start(int sample_count) {</span>
<span class="udiff-line-modified-added">+   if (is_running()) {</span>
<span class="udiff-line-modified-added">+     return true;</span>
    }
  
<span class="udiff-line-modified-removed">-   if (UseShenandoahGC) {</span>
<span class="udiff-line-modified-removed">-     log_warning(jfr)(&quot;LeakProfiler is currently not supported in combination with Shenandoah GC&quot;);</span>
<span class="udiff-line-modified-added">+   // Allows user to disable leak profiler on command line by setting queue size to zero.</span>
<span class="udiff-line-modified-added">+   if (sample_count == 0) {</span>
      return false;
    }
  
<span class="udiff-line-modified-removed">-   if (_object_sampler != NULL) {</span>
<span class="udiff-line-modified-removed">-     // already started</span>
<span class="udiff-line-modified-removed">-     return true;</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-removed">-   // Allows user to disable leak profiler on command line by setting queue size to zero.</span>
<span class="udiff-line-modified-removed">-   if (sample_count &gt; 0) {</span>
<span class="udiff-line-modified-removed">-     StartOperation op(sample_count);</span>
<span class="udiff-line-modified-removed">-     VMThread::execute(&amp;op);</span>
<span class="udiff-line-modified-removed">-     return _object_sampler != NULL;</span>
<span class="udiff-line-modified-added">+   assert(!is_running(), &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+   assert(sample_count &gt; 0, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // schedule the safepoint operation for installing the object sampler</span>
<span class="udiff-line-modified-added">+   StartOperation op(sample_count);</span>
<span class="udiff-line-modified-added">+   VMThread::execute(&amp;op);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (!is_running()) {</span>
<span class="udiff-line-modified-added">+     log_trace(jfr, system)(&quot;Object sampling could not be started because the sampler could not be allocated&quot;);</span>
<span class="udiff-line-added">+     return false;</span>
    }
<span class="udiff-line-modified-removed">-   return false;</span>
<span class="udiff-line-modified-added">+   assert(is_running(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   log_trace(jfr, system)(&quot;Object sampling started&quot;);</span>
<span class="udiff-line-added">+   return true;</span>
  }
  
  bool LeakProfiler::stop() {
<span class="udiff-line-modified-removed">-   if (_object_sampler == NULL) {</span>
<span class="udiff-line-modified-removed">-     // already stopped/not started</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-modified-added">+   if (!is_running()) {</span>
<span class="udiff-line-modified-added">+     return false;</span>
    }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // schedule the safepoint operation for uninstalling and destroying the object sampler</span>
    StopOperation op;
    VMThread::execute(&amp;op);
<span class="udiff-line-modified-removed">-   return _object_sampler == NULL;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   assert(!is_running(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   log_trace(jfr, system)(&quot;Object sampling stopped&quot;);</span>
<span class="udiff-line-added">+   return true;</span>
  }
  
<span class="udiff-line-modified-removed">- void LeakProfiler::emit_events(jlong cutoff_ticks, bool emit_all) {</span>
<span class="udiff-line-modified-added">+ void LeakProfiler::emit_events(int64_t cutoff_ticks, bool emit_all) {</span>
    if (!is_running()) {
      return;
    }
<span class="udiff-line-modified-removed">-   EmitEventOperation op(cutoff_ticks, emit_all);</span>
<span class="udiff-line-modified-removed">-   VMThread::execute(&amp;op);</span>
<span class="udiff-line-modified-added">+   // exclusive access to object sampler instance</span>
<span class="udiff-line-modified-added">+   ObjectSampler* const sampler = ObjectSampler::acquire();</span>
<span class="udiff-line-added">+   assert(sampler != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   EventEmitter::emit(sampler, cutoff_ticks, emit_all);</span>
<span class="udiff-line-added">+   ObjectSampler::release();</span>
  }
  
<span class="udiff-line-modified-removed">- void LeakProfiler::oops_do(BoolObjectClosure* is_alive, OopClosure* f) {</span>
<span class="udiff-line-modified-added">+ void LeakProfiler::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* f) {</span>
    assert(SafepointSynchronize::is_at_safepoint(),
      &quot;Leak Profiler::oops_do(...) may only be called during safepoint&quot;);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   if (_object_sampler != NULL) {</span>
<span class="udiff-line-removed">-     _object_sampler-&gt;oops_do(is_alive, f);</span>
<span class="udiff-line-modified-added">+   if (is_running()) {</span>
<span class="udiff-line-modified-added">+     ObjectSampler::weak_oops_do(is_alive, f);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- void LeakProfiler::sample(HeapWord* object,</span>
<span class="udiff-line-removed">-                           size_t size,</span>
<span class="udiff-line-removed">-                           JavaThread* thread) {</span>
<span class="udiff-line-modified-added">+ void LeakProfiler::sample(HeapWord* object, size_t size, JavaThread* thread) {</span>
    assert(is_running(), &quot;invariant&quot;);
    assert(thread != NULL, &quot;invariant&quot;);
    assert(thread-&gt;thread_state() == _thread_in_vm, &quot;invariant&quot;);
  
    // exclude compiler threads and code sweeper thread
    if (thread-&gt;is_hidden_from_external_view()) {
      return;
    }
  
<span class="udiff-line-modified-removed">-   _object_sampler-&gt;add(object, size, thread);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- ObjectSampler* LeakProfiler::object_sampler() {</span>
<span class="udiff-line-removed">-   assert(is_suspended() || SafepointSynchronize::is_at_safepoint(),</span>
<span class="udiff-line-removed">-     &quot;Leak Profiler::object_sampler() may only be called during safepoint&quot;);</span>
<span class="udiff-line-removed">-   return _object_sampler;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void LeakProfiler::set_object_sampler(ObjectSampler* object_sampler) {</span>
<span class="udiff-line-removed">-   assert(SafepointSynchronize::is_at_safepoint(),</span>
<span class="udiff-line-removed">-     &quot;Leak Profiler::set_object_sampler() may only be called during safepoint&quot;);</span>
<span class="udiff-line-removed">-   _object_sampler = object_sampler;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool LeakProfiler::is_running() {</span>
<span class="udiff-line-removed">-   return _object_sampler != NULL &amp;&amp; !suspended;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool LeakProfiler::is_suspended() {</span>
<span class="udiff-line-removed">-   return _object_sampler != NULL &amp;&amp; suspended;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void LeakProfiler::resume() {</span>
<span class="udiff-line-removed">-   assert(is_suspended(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   OrderAccess::storestore();</span>
<span class="udiff-line-removed">-   Atomic::store((jbyte)0, &amp;suspended);</span>
<span class="udiff-line-removed">-   assert(is_running(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void LeakProfiler::suspend() {</span>
<span class="udiff-line-removed">-   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(_object_sampler != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   assert(!is_suspended(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   suspended = (jbyte)1; // safepoint visible</span>
<span class="udiff-line-modified-added">+   ObjectSampler::sample(object, size, thread);</span>
  }
</pre>
<center><a href="checkpoint/rootResolver.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="leakProfiler.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>