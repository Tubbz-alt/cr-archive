<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jfr/leakprofiler/checkpoint/objectSampleCheckpoint.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jfr/jfrEvents.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed"> 27 #include &quot;jfr/recorder/jfrRecorder.hpp&quot;</span>
<span class="line-removed"> 28 #include &quot;jfr/recorder/checkpoint/jfrCheckpointWriter.hpp&quot;</span>
<span class="line-removed"> 29 #include &quot;jfr/recorder/checkpoint/types/traceid/jfrTraceId.inline.hpp&quot;</span>
<span class="line-removed"> 30 #include &quot;jfr/recorder/stacktrace/jfrStackTraceRepository.hpp&quot;</span>
 31 #include &quot;jfr/leakprofiler/chains/edgeStore.hpp&quot;
 32 #include &quot;jfr/leakprofiler/chains/objectSampleMarker.hpp&quot;
 33 #include &quot;jfr/leakprofiler/checkpoint/objectSampleCheckpoint.hpp&quot;
 34 #include &quot;jfr/leakprofiler/checkpoint/objectSampleWriter.hpp&quot;
 35 #include &quot;jfr/leakprofiler/leakProfiler.hpp&quot;
 36 #include &quot;jfr/leakprofiler/sampling/objectSample.hpp&quot;
 37 #include &quot;jfr/leakprofiler/sampling/objectSampler.hpp&quot;
<a name="3" id="anc3"></a><span class="line-modified"> 38 #include &quot;jfr/leakprofiler/utilities/rootType.hpp&quot;</span>
<span class="line-modified"> 39 #include &quot;jfr/metadata/jfrSerializer.hpp&quot;</span>
<span class="line-modified"> 40 #include &quot;runtime/interfaceSupport.inline.hpp&quot;</span>





 41 #include &quot;runtime/mutexLocker.hpp&quot;
<a name="4" id="anc4"></a><span class="line-modified"> 42 #include &quot;runtime/thread.inline.hpp&quot;</span>


 43 
<a name="5" id="anc5"></a><span class="line-modified"> 44 template &lt;typename SampleProcessor&gt;</span>
<span class="line-modified"> 45 static void do_samples(ObjectSample* sample, const ObjectSample* const end, SampleProcessor&amp; processor) {</span>
<span class="line-modified"> 46   assert(sample != NULL, &quot;invariant&quot;);</span>
<span class="line-modified"> 47   while (sample != end) {</span>
<span class="line-modified"> 48     processor.sample_do(sample);</span>
<span class="line-removed"> 49     sample = sample-&gt;next();</span>
<span class="line-removed"> 50   }</span>
 51 }
 52 
<a name="6" id="anc6"></a><span class="line-modified"> 53 class RootSystemType : public JfrSerializer {</span>
<span class="line-modified"> 54  public:</span>
<span class="line-modified"> 55   void serialize(JfrCheckpointWriter&amp; writer) {</span>
<span class="line-modified"> 56     const u4 nof_root_systems = OldObjectRoot::_number_of_systems;</span>
<span class="line-modified"> 57     writer.write_count(nof_root_systems);</span>
<span class="line-modified"> 58     for (u4 i = 0; i &lt; nof_root_systems; ++i) {</span>
<span class="line-removed"> 59       writer.write_key(i);</span>
<span class="line-removed"> 60       writer.write(OldObjectRoot::system_description((OldObjectRoot::System)i));</span>
<span class="line-removed"> 61     }</span>
 62   }
<a name="7" id="anc7"></a><span class="line-modified"> 63 };</span>

 64 
<a name="8" id="anc8"></a><span class="line-modified"> 65 class RootType : public JfrSerializer {</span>
<span class="line-modified"> 66  public:</span>
<span class="line-modified"> 67   void serialize(JfrCheckpointWriter&amp; writer) {</span>
<span class="line-modified"> 68     const u4 nof_root_types = OldObjectRoot::_number_of_types;</span>
<span class="line-removed"> 69     writer.write_count(nof_root_types);</span>
<span class="line-removed"> 70     for (u4 i = 0; i &lt; nof_root_types; ++i) {</span>
<span class="line-removed"> 71       writer.write_key(i);</span>
<span class="line-removed"> 72       writer.write(OldObjectRoot::type_description((OldObjectRoot::Type)i));</span>
<span class="line-removed"> 73     }</span>
<span class="line-removed"> 74   }</span>
<span class="line-removed"> 75 };</span>
 76 
<a name="9" id="anc9"></a><span class="line-modified"> 77 class CheckpointInstall {</span>
<span class="line-removed"> 78  private:</span>
<span class="line-removed"> 79   const JfrCheckpointBlobHandle&amp; _cp;</span>
<span class="line-removed"> 80  public:</span>
<span class="line-removed"> 81   CheckpointInstall(const JfrCheckpointBlobHandle&amp; cp) : _cp(cp) {}</span>
<span class="line-removed"> 82   void sample_do(ObjectSample* sample) {</span>
<span class="line-removed"> 83     assert(sample != NULL, &quot;invariant&quot;);</span>
<span class="line-removed"> 84     if (!sample-&gt;is_dead()) {</span>
<span class="line-removed"> 85       sample-&gt;set_klass_checkpoint(_cp);</span>
<span class="line-removed"> 86     }</span>
<span class="line-removed"> 87   }</span>
<span class="line-removed"> 88 };</span>
 89 
<a name="10" id="anc10"></a><span class="line-modified"> 90 class CheckpointWrite {</span>







 91  private:
<a name="11" id="anc11"></a><span class="line-modified"> 92   JfrCheckpointWriter&amp; _writer;</span>
<span class="line-removed"> 93   const jlong _last_sweep;</span>
 94  public:
<a name="12" id="anc12"></a><span class="line-modified"> 95   CheckpointWrite(JfrCheckpointWriter&amp; writer, jlong last_sweep) : _writer(writer), _last_sweep(last_sweep) {}</span>
<span class="line-modified"> 96   void sample_do(ObjectSample* sample) {</span>
<span class="line-removed"> 97     assert(sample != NULL, &quot;invariant&quot;);</span>
<span class="line-removed"> 98     if (sample-&gt;is_alive_and_older_than(_last_sweep)) {</span>
<span class="line-removed"> 99       if (sample-&gt;has_thread_checkpoint()) {</span>
<span class="line-removed">100         const JfrCheckpointBlobHandle&amp; thread_cp = sample-&gt;thread_checkpoint();</span>
<span class="line-removed">101         thread_cp-&gt;exclusive_write(_writer);</span>
<span class="line-removed">102       }</span>
<span class="line-removed">103       if (sample-&gt;has_klass_checkpoint()) {</span>
<span class="line-removed">104         const JfrCheckpointBlobHandle&amp; klass_cp = sample-&gt;klass_checkpoint();</span>
<span class="line-removed">105         klass_cp-&gt;exclusive_write(_writer);</span>
<span class="line-removed">106       }</span>
<span class="line-removed">107     }</span>
<span class="line-removed">108   }</span>
109 };
110 
<a name="13" id="anc13"></a><span class="line-modified">111 class CheckpointStateReset {</span>
<span class="line-modified">112  private:</span>
<span class="line-modified">113   const jlong _last_sweep;</span>
<span class="line-modified">114  public:</span>
<span class="line-modified">115   CheckpointStateReset(jlong last_sweep) : _last_sweep(last_sweep) {}</span>
<span class="line-modified">116   void sample_do(ObjectSample* sample) {</span>
<span class="line-modified">117     assert(sample != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">118     if (sample-&gt;is_alive_and_older_than(_last_sweep)) {</span>
<span class="line-modified">119       if (sample-&gt;has_thread_checkpoint()) {</span>
<span class="line-modified">120         const JfrCheckpointBlobHandle&amp; thread_cp = sample-&gt;thread_checkpoint();</span>
<span class="line-modified">121         thread_cp-&gt;reset_write_state();</span>
<span class="line-removed">122       }</span>
<span class="line-removed">123       if (sample-&gt;has_klass_checkpoint()) {</span>
<span class="line-removed">124         const JfrCheckpointBlobHandle&amp; klass_cp = sample-&gt;klass_checkpoint();</span>
<span class="line-removed">125         klass_cp-&gt;reset_write_state();</span>
<span class="line-removed">126       }</span>
<span class="line-removed">127     }</span>
128   }
<a name="14" id="anc14"></a><span class="line-modified">129 };</span>

130 
<a name="15" id="anc15"></a><span class="line-modified">131 class StackTraceWrite {</span>
<span class="line-modified">132  private:</span>
<span class="line-modified">133   JfrStackTraceRepository&amp; _stack_trace_repo;</span>
<span class="line-modified">134   JfrCheckpointWriter&amp; _writer;</span>
<span class="line-removed">135   int _count;</span>
<span class="line-removed">136  public:</span>
<span class="line-removed">137   StackTraceWrite(JfrStackTraceRepository&amp; stack_trace_repo, JfrCheckpointWriter&amp; writer) :</span>
<span class="line-removed">138     _stack_trace_repo(stack_trace_repo), _writer(writer), _count(0) {</span>
<span class="line-removed">139     JfrStacktrace_lock-&gt;lock();</span>
140   }
<a name="16" id="anc16"></a><span class="line-modified">141   ~StackTraceWrite() {</span>
<span class="line-modified">142     assert(JfrStacktrace_lock-&gt;owned_by_self(), &quot;invariant&quot;);</span>
<span class="line-modified">143     JfrStacktrace_lock-&gt;unlock();</span>







144   }
<a name="17" id="anc17"></a>

145 
<a name="18" id="anc18"></a><span class="line-modified">146   void sample_do(ObjectSample* sample) {</span>
<span class="line-modified">147     assert(sample != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">148     if (!sample-&gt;is_dead()) {</span>
<span class="line-modified">149       if (sample-&gt;has_stack_trace()) {</span>
<span class="line-removed">150         JfrTraceId::use(sample-&gt;klass(), true);</span>
<span class="line-removed">151         _stack_trace_repo.write(_writer, sample-&gt;stack_trace_id(), sample-&gt;stack_trace_hash());</span>
<span class="line-removed">152         ++_count;</span>
<span class="line-removed">153       }</span>
<span class="line-removed">154     }</span>
155   }
<a name="19" id="anc19"></a>
156 
<a name="20" id="anc20"></a><span class="line-modified">157   int count() const {</span>
<span class="line-modified">158     return _count;</span>










159   }
<a name="21" id="anc21"></a><span class="line-modified">160 };</span>









161 
<a name="22" id="anc22"></a><span class="line-modified">162 class SampleMark {</span>
163  private:
164   ObjectSampleMarker&amp; _marker;
165   jlong _last_sweep;
166   int _count;
167  public:
<a name="23" id="anc23"></a><span class="line-modified">168   SampleMark(ObjectSampleMarker&amp; marker, jlong last_sweep) : _marker(marker),</span>
<span class="line-removed">169                                                              _last_sweep(last_sweep),</span>
<span class="line-removed">170                                                              _count(0) {}</span>
171   void sample_do(ObjectSample* sample) {
<a name="24" id="anc24"></a><span class="line-removed">172     assert(sample != NULL, &quot;invariant&quot;);</span>
173     if (sample-&gt;is_alive_and_older_than(_last_sweep)) {
174       _marker.mark(sample-&gt;object());
175       ++_count;
176     }
177   }
<a name="25" id="anc25"></a><span class="line-removed">178 </span>
179   int count() const {
180     return _count;
181   }
182 };
183 
<a name="26" id="anc26"></a><span class="line-modified">184 void ObjectSampleCheckpoint::install(JfrCheckpointWriter&amp; writer, bool class_unload, bool resume) {</span>
<span class="line-modified">185   assert(class_unload ? SafepointSynchronize::is_at_safepoint() : LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>






























































186 
<a name="27" id="anc27"></a><span class="line-modified">187   if (!writer.has_data()) {</span>
<span class="line-modified">188     if (!class_unload) {</span>
<span class="line-modified">189       LeakProfiler::resume();</span>













190     }
<a name="28" id="anc28"></a><span class="line-modified">191     assert(LeakProfiler::is_running(), &quot;invariant&quot;);</span>
























192     return;
193   }
<a name="29" id="anc29"></a>









194 
<a name="30" id="anc30"></a><span class="line-modified">195   assert(writer.has_data(), &quot;invariant&quot;);</span>
<span class="line-modified">196   const JfrCheckpointBlobHandle h_cp = writer.checkpoint_blob();</span>






197 
<a name="31" id="anc31"></a><span class="line-modified">198   const ObjectSampler* const object_sampler = LeakProfiler::object_sampler();</span>
<span class="line-modified">199   assert(object_sampler != NULL, &quot;invariant&quot;);</span>







200 
<a name="32" id="anc32"></a><span class="line-modified">201   ObjectSample* const last = const_cast&lt;ObjectSample*&gt;(object_sampler-&gt;last());</span>
<span class="line-modified">202   const ObjectSample* const last_resolved = object_sampler-&gt;last_resolved();</span>
<span class="line-modified">203   CheckpointInstall install(h_cp);</span>

204 
<a name="33" id="anc33"></a><span class="line-modified">205   if (class_unload) {</span>
<span class="line-modified">206     if (last != NULL) {</span>
<span class="line-modified">207       // all samples need the class unload information</span>
<span class="line-modified">208       do_samples(last, NULL, install);</span>
<span class="line-modified">209     }</span>
<span class="line-modified">210     assert(LeakProfiler::is_running(), &quot;invariant&quot;);</span>



211     return;
212   }
<a name="34" id="anc34"></a>


















213 
<a name="35" id="anc35"></a><span class="line-modified">214   // only new samples since last resolved checkpoint</span>
<span class="line-modified">215   if (last != last_resolved) {</span>
<span class="line-modified">216     do_samples(last, last_resolved, install);</span>
<span class="line-modified">217     if (resume) {</span>
<span class="line-modified">218       const_cast&lt;ObjectSampler*&gt;(object_sampler)-&gt;set_last_resolved(last);</span>









































219     }
220   }
<a name="36" id="anc36"></a><span class="line-modified">221   assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-modified">222   if (resume) {</span>
<span class="line-removed">223     LeakProfiler::resume();</span>
<span class="line-removed">224     assert(LeakProfiler::is_running(), &quot;invariant&quot;);</span>
225   }
<a name="37" id="anc37"></a>










226 }
227 
<a name="38" id="anc38"></a><span class="line-modified">228 void ObjectSampleCheckpoint::write(const EdgeStore* edge_store, bool emit_all, Thread* thread) {</span>


229   assert(edge_store != NULL, &quot;invariant&quot;);
230   assert(thread != NULL, &quot;invariant&quot;);
<a name="39" id="anc39"></a><span class="line-modified">231   static bool types_registered = false;</span>
<span class="line-modified">232   if (!types_registered) {</span>
<span class="line-removed">233     JfrSerializer::register_serializer(TYPE_OLDOBJECTROOTSYSTEM, false, true, new RootSystemType());</span>
<span class="line-removed">234     JfrSerializer::register_serializer(TYPE_OLDOBJECTROOTTYPE, false, true, new RootType());</span>
<span class="line-removed">235     types_registered = true;</span>
<span class="line-removed">236   }</span>
<span class="line-removed">237   const ObjectSampler* const object_sampler = LeakProfiler::object_sampler();</span>
<span class="line-removed">238   assert(object_sampler != NULL, &quot;invariant&quot;);</span>
<span class="line-removed">239   const jlong last_sweep = emit_all ? max_jlong : object_sampler-&gt;last_sweep().value();</span>
<span class="line-removed">240   ObjectSample* const last = const_cast&lt;ObjectSample*&gt;(object_sampler-&gt;last());</span>
<span class="line-removed">241   {</span>
<span class="line-removed">242     JfrCheckpointWriter writer(false, false, thread);</span>
<span class="line-removed">243     CheckpointWrite checkpoint_write(writer, last_sweep);</span>
<span class="line-removed">244     do_samples(last, NULL, checkpoint_write);</span>
<span class="line-removed">245   }</span>
<span class="line-removed">246   CheckpointStateReset state_reset(last_sweep);</span>
<span class="line-removed">247   do_samples(last, NULL, state_reset);</span>
248   if (!edge_store-&gt;is_empty()) {
<a name="40" id="anc40"></a><span class="line-modified">249     // java object and chain representations</span>
<span class="line-removed">250     JfrCheckpointWriter writer(false, true, thread);</span>
251     ObjectSampleWriter osw(writer, edge_store);
<a name="41" id="anc41"></a><span class="line-modified">252     edge_store-&gt;iterate_edges(osw);</span>







253   }
254 }
255 
<a name="42" id="anc42"></a><span class="line-modified">256 WriteObjectSampleStacktrace::WriteObjectSampleStacktrace(JfrStackTraceRepository&amp; repo) :</span>
<span class="line-modified">257   _stack_trace_repo(repo) {</span>






258 }
259 
<a name="43" id="anc43"></a><span class="line-modified">260 bool WriteObjectSampleStacktrace::process() {</span>
<span class="line-modified">261   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
<span class="line-modified">262   if (!LeakProfiler::is_running()) {</span>
<span class="line-modified">263     return true;</span>
264   }
<a name="44" id="anc44"></a><span class="line-modified">265   // Suspend the LeakProfiler subsystem</span>
<span class="line-modified">266   // to ensure stable samples even</span>
<span class="line-modified">267   // after we return from the safepoint.</span>
<span class="line-modified">268   LeakProfiler::suspend();</span>
<span class="line-removed">269   assert(!LeakProfiler::is_running(), &quot;invariant&quot;);</span>
<span class="line-removed">270   assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-removed">271 </span>
<span class="line-removed">272   const ObjectSampler* object_sampler = LeakProfiler::object_sampler();</span>
<span class="line-removed">273   assert(object_sampler != NULL, &quot;invariant&quot;);</span>
<span class="line-removed">274   assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-removed">275 </span>
<span class="line-removed">276   ObjectSample* const last = const_cast&lt;ObjectSample*&gt;(object_sampler-&gt;last());</span>
<span class="line-removed">277   const ObjectSample* const last_resolved = object_sampler-&gt;last_resolved();</span>
<span class="line-removed">278   if (last == last_resolved) {</span>
<span class="line-removed">279     assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-removed">280     return true;</span>
281   }
<a name="45" id="anc45"></a>
282 
<a name="46" id="anc46"></a><span class="line-modified">283   JfrCheckpointWriter writer(false, true, Thread::current());</span>
<span class="line-modified">284   const JfrCheckpointContext ctx = writer.context();</span>
<span class="line-modified">285 </span>
<span class="line-modified">286   writer.write_type(TYPE_STACKTRACE);</span>
<span class="line-removed">287   const jlong count_offset = writer.reserve(sizeof(u4));</span>
288 
<a name="47" id="anc47"></a><span class="line-modified">289   int count = 0;</span>
<span class="line-modified">290   {</span>
<span class="line-modified">291     StackTraceWrite stack_trace_write(_stack_trace_repo, writer); // JfrStacktrace_lock</span>
<span class="line-modified">292     do_samples(last, last_resolved, stack_trace_write);</span>
<span class="line-modified">293     count = stack_trace_write.count();</span>
<span class="line-modified">294   }</span>
<span class="line-modified">295   if (count == 0) {</span>
<span class="line-removed">296     writer.set_context(ctx);</span>
<span class="line-removed">297     assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-removed">298     return true;</span>
299   }
<a name="48" id="anc48"></a><span class="line-modified">300   assert(count &gt; 0, &quot;invariant&quot;);</span>
<span class="line-removed">301   writer.write_count((u4)count, count_offset);</span>
<span class="line-removed">302   JfrStackTraceRepository::write_metadata(writer);</span>
303 
<a name="49" id="anc49"></a><span class="line-modified">304   ObjectSampleCheckpoint::install(writer, false, false);</span>
<span class="line-modified">305   assert(LeakProfiler::is_suspended(), &quot;invariant&quot;);</span>
<span class="line-modified">306   return true;</span>





307 }
308 
<a name="50" id="anc50"></a><span class="line-modified">309 int ObjectSampleCheckpoint::mark(ObjectSampleMarker&amp; marker, bool emit_all) {</span>
<span class="line-modified">310   const ObjectSampler* object_sampler = LeakProfiler::object_sampler();</span>
<span class="line-modified">311   assert(object_sampler != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">312   ObjectSample* const last = const_cast&lt;ObjectSample*&gt;(object_sampler-&gt;last());</span>
<span class="line-modified">313   if (last == NULL) {</span>
<span class="line-removed">314     return 0;</span>
315   }
<a name="51" id="anc51"></a><span class="line-removed">316   const jlong last_sweep = emit_all ? max_jlong : object_sampler-&gt;last_sweep().value();</span>
<span class="line-removed">317   SampleMark mark(marker, last_sweep);</span>
<span class="line-removed">318   do_samples(last, NULL, mark);</span>
<span class="line-removed">319   return mark.count();</span>
320 }
<a name="52" id="anc52"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="52" type="hidden" />
</body>
</html>