<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/leakprofiler/utilities/saveRestore.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="rootType.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="saveRestore.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/utilities/saveRestore.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,46 ***</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;jfr/leakprofiler/utilities/saveRestore.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  
<span class="line-modified">! MarkOopContext::MarkOopContext() : _obj(NULL), _mark_oop(NULL) {}</span>
  
<span class="line-modified">! MarkOopContext::MarkOopContext(const oop obj) : _obj(obj), _mark_oop(obj-&gt;mark()) {</span>
<span class="line-modified">!   assert(_obj-&gt;mark() == _mark_oop, &quot;invariant&quot;);</span>
    // now we will &quot;poison&quot; the mark word of the object
    // to the intermediate monitor INFLATING state.
    // This is an &quot;impossible&quot; state during a safepoint,
    // hence we will use it to quickly identify objects
    // during the reachability search from gc roots.
<span class="line-modified">!   assert(NULL == markOopDesc::INFLATING(), &quot;invariant&quot;);</span>
<span class="line-modified">!   _obj-&gt;set_mark(markOopDesc::INFLATING());</span>
<span class="line-modified">!   assert(NULL == obj-&gt;mark(), &quot;invariant&quot;);</span>
  }
  
<span class="line-modified">! MarkOopContext::~MarkOopContext() {</span>
    if (_obj != NULL) {
<span class="line-modified">!     _obj-&gt;set_mark(_mark_oop);</span>
<span class="line-modified">!     assert(_obj-&gt;mark() == _mark_oop, &quot;invariant&quot;);</span>
    }
  }
  
<span class="line-modified">! MarkOopContext::MarkOopContext(const MarkOopContext&amp; rhs) : _obj(NULL), _mark_oop(NULL) {</span>
<span class="line-modified">!   swap(const_cast&lt;MarkOopContext&amp;&gt;(rhs));</span>
  }
  
<span class="line-modified">! void MarkOopContext::operator=(MarkOopContext rhs) {</span>
    swap(rhs);
  }
  
<span class="line-modified">! void MarkOopContext::swap(MarkOopContext&amp; rhs) {</span>
    oop temp_obj = rhs._obj;
<span class="line-modified">!   markOop temp_mark_oop = rhs._mark_oop;</span>
    rhs._obj = _obj;
<span class="line-modified">!   rhs._mark_oop = _mark_oop;</span>
    _obj = temp_obj;
<span class="line-modified">!   _mark_oop = temp_mark_oop;</span>
  }
  
  CLDClaimContext::CLDClaimContext() : _cld(NULL) {}
  
  CLDClaimContext::CLDClaimContext(ClassLoaderData* cld) : _cld(cld) {
<span class="line-new-header">--- 25,46 ---</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;jfr/leakprofiler/utilities/saveRestore.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  
<span class="line-modified">! MarkWordContext::MarkWordContext() : _obj(NULL), _mark_word(markWord::zero()) {}</span>
  
<span class="line-modified">! MarkWordContext::MarkWordContext(const oop obj) : _obj(obj), _mark_word(obj-&gt;mark()) {</span>
<span class="line-modified">!   assert(_obj-&gt;mark() == _mark_word, &quot;invariant&quot;);</span>
    // now we will &quot;poison&quot; the mark word of the object
    // to the intermediate monitor INFLATING state.
    // This is an &quot;impossible&quot; state during a safepoint,
    // hence we will use it to quickly identify objects
    // during the reachability search from gc roots.
<span class="line-modified">!   assert(markWord::zero() == markWord::INFLATING(), &quot;invariant&quot;);</span>
<span class="line-modified">!   _obj-&gt;set_mark(markWord::INFLATING());</span>
<span class="line-modified">!   assert(markWord::zero() == obj-&gt;mark(), &quot;invariant&quot;);</span>
  }
  
<span class="line-modified">! MarkWordContext::~MarkWordContext() {</span>
    if (_obj != NULL) {
<span class="line-modified">!     _obj-&gt;set_mark(_mark_word);</span>
<span class="line-modified">!     assert(_obj-&gt;mark() == _mark_word, &quot;invariant&quot;);</span>
    }
  }
  
<span class="line-modified">! MarkWordContext::MarkWordContext(const MarkWordContext&amp; rhs) : _obj(NULL), _mark_word(markWord::zero()) {</span>
<span class="line-modified">!   swap(const_cast&lt;MarkWordContext&amp;&gt;(rhs));</span>
  }
  
<span class="line-modified">! void MarkWordContext::operator=(MarkWordContext rhs) {</span>
    swap(rhs);
  }
  
<span class="line-modified">! void MarkWordContext::swap(MarkWordContext&amp; rhs) {</span>
    oop temp_obj = rhs._obj;
<span class="line-modified">!   markWord temp_mark_word = rhs._mark_word;</span>
    rhs._obj = _obj;
<span class="line-modified">!   rhs._mark_word = _mark_word;</span>
    _obj = temp_obj;
<span class="line-modified">!   _mark_word = temp_mark_word;</span>
  }
  
  CLDClaimContext::CLDClaimContext() : _cld(NULL) {}
  
  CLDClaimContext::CLDClaimContext(ClassLoaderData* cld) : _cld(cld) {
</pre>
<center><a href="rootType.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="saveRestore.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>