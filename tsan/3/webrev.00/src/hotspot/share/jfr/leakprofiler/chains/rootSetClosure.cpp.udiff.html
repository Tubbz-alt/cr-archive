<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/chains/rootSetClosure.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="objectSampleMarker.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="rootSetClosure.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/chains/rootSetClosure.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,82 +26,61 @@</span>
  #include &quot;aot/aotLoader.hpp&quot;
  #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;gc/shared/strongRootsScope.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/leakprofiler/chains/bfsClosure.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;jfr/leakprofiler/chains/dfsClosure.hpp&quot;</span>
  #include &quot;jfr/leakprofiler/chains/edgeQueue.hpp&quot;
  #include &quot;jfr/leakprofiler/chains/rootSetClosure.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;jfr/leakprofiler/utilities/saveRestore.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;jfr/leakprofiler/utilities/unifiedOop.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;jfr/leakprofiler/utilities/unifiedOopRef.inline.hpp&quot;</span>
  #include &quot;memory/universe.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;oops/oop.inline.hpp&quot;</span>
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;runtime/jniHandles.inline.hpp&quot;
  #include &quot;runtime/synchronizer.hpp&quot;
  #include &quot;runtime/thread.hpp&quot;
  #include &quot;services/management.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
  
<span class="udiff-line-modified-removed">- RootSetClosure::RootSetClosure(EdgeQueue* edge_queue) :</span>
<span class="udiff-line-modified-removed">-   _edge_queue(edge_queue) {</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ template &lt;typename Delegate&gt;</span>
<span class="udiff-line-modified-added">+ RootSetClosure&lt;Delegate&gt;::RootSetClosure(Delegate* delegate) : _delegate(delegate) {}</span>
  
<span class="udiff-line-modified-removed">- void RootSetClosure::do_oop(oop* ref) {</span>
<span class="udiff-line-modified-added">+ template &lt;typename Delegate&gt;</span>
<span class="udiff-line-added">+ void RootSetClosure&lt;Delegate&gt;::do_oop(oop* ref) {</span>
    assert(ref != NULL, &quot;invariant&quot;);
<span class="udiff-line-removed">-   // We discard unaligned root references because</span>
<span class="udiff-line-removed">-   // our reference tagging scheme will use</span>
<span class="udiff-line-removed">-   // the lowest bit in a represented reference</span>
<span class="udiff-line-removed">-   // to indicate the reference is narrow.</span>
<span class="udiff-line-removed">-   // It is mainly roots delivered via nmethods::do_oops()</span>
<span class="udiff-line-removed">-   // that come in unaligned. It should be ok to duck these</span>
<span class="udiff-line-removed">-   // since they are supposedly weak.</span>
<span class="udiff-line-removed">-   if (!is_aligned(ref, HeapWordSize)) {</span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
    assert(is_aligned(ref, HeapWordSize), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   const oop pointee = *ref;</span>
<span class="udiff-line-modified-removed">-   if (pointee != NULL) {</span>
<span class="udiff-line-removed">-     closure_impl(ref, pointee);</span>
<span class="udiff-line-modified-added">+   if (*ref != NULL) {</span>
<span class="udiff-line-modified-added">+     _delegate-&gt;do_root(UnifiedOopRef::encode_in_native(ref));</span>
    }
  }
  
<span class="udiff-line-modified-removed">- void RootSetClosure::do_oop(narrowOop* ref) {</span>
<span class="udiff-line-modified-added">+ template &lt;typename Delegate&gt;</span>
<span class="udiff-line-added">+ void RootSetClosure&lt;Delegate&gt;::do_oop(narrowOop* ref) {</span>
    assert(ref != NULL, &quot;invariant&quot;);
    assert(is_aligned(ref, sizeof(narrowOop)), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   const oop pointee = RawAccess&lt;&gt;::oop_load(ref);</span>
<span class="udiff-line-modified-removed">-   if (pointee != NULL) {</span>
<span class="udiff-line-removed">-     closure_impl(UnifiedOop::encode(ref), pointee);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void RootSetClosure::closure_impl(const oop* reference, const oop pointee) {</span>
<span class="udiff-line-removed">-   if (!_edge_queue-&gt;is_full())  {</span>
<span class="udiff-line-removed">-     _edge_queue-&gt;add(NULL, reference);</span>
<span class="udiff-line-modified-added">+   if (*ref != 0) {</span>
<span class="udiff-line-modified-added">+     _delegate-&gt;do_root(UnifiedOopRef::encode_in_native(ref));</span>
    }
  }
  
<span class="udiff-line-modified-removed">- void RootSetClosure::add_to_queue(EdgeQueue* edge_queue) {</span>
<span class="udiff-line-removed">-   RootSetClosure rs(edge_queue);</span>
<span class="udiff-line-removed">-   process_roots(&amp;rs);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class RootSetClosureMarkScope : public MarkScope {</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-modified-added">+ class RootSetClosureMarkScope : public MarkScope {};</span>
  
<span class="udiff-line-modified-removed">- void RootSetClosure::process_roots(OopClosure* closure) {</span>
<span class="udiff-line-modified-removed">-   SaveRestoreCLDClaimBits save_restore_cld_claim_bits;</span>
<span class="udiff-line-modified-added">+ template &lt;typename Delegate&gt;</span>
<span class="udiff-line-modified-added">+ void RootSetClosure&lt;Delegate&gt;::process() {</span>
    RootSetClosureMarkScope mark_scope;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-   CLDToOopClosure cldt_closure(closure, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-modified-added">+   CLDToOopClosure cldt_closure(this, ClassLoaderData::_claim_none);</span>
    ClassLoaderDataGraph::always_strong_cld_do(&amp;cldt_closure);
<span class="udiff-line-modified-removed">-   CodeBlobToOopClosure blobs(closure, false);</span>
<span class="udiff-line-modified-removed">-   Threads::oops_do(closure, &amp;blobs);</span>
<span class="udiff-line-modified-removed">-   ObjectSynchronizer::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   Universe::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   JNIHandles::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   JvmtiExport::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   SystemDictionary::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   Management::oops_do(closure);</span>
<span class="udiff-line-modified-removed">-   StringTable::oops_do(closure);</span>
<span class="udiff-line-removed">-   AOTLoader::oops_do(closure);</span>
<span class="udiff-line-modified-added">+   // We don&#39;t follow code blob oops, because they have misaligned oops.</span>
<span class="udiff-line-modified-added">+   Threads::oops_do(this, NULL);</span>
<span class="udiff-line-modified-added">+   ObjectSynchronizer::oops_do(this);</span>
<span class="udiff-line-modified-added">+   Universe::oops_do(this);</span>
<span class="udiff-line-modified-added">+   JNIHandles::oops_do(this);</span>
<span class="udiff-line-modified-added">+   JvmtiExport::oops_do(this);</span>
<span class="udiff-line-modified-added">+   SystemDictionary::oops_do(this);</span>
<span class="udiff-line-modified-added">+   Management::oops_do(this);</span>
<span class="udiff-line-modified-added">+   AOTLoader::oops_do(this);</span>
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template class RootSetClosure&lt;BFSClosure&gt;;</span>
<span class="udiff-line-added">+ template class RootSetClosure&lt;DFSClosure&gt;;</span>
</pre>
<center><a href="objectSampleMarker.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="rootSetClosure.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>