<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/sampling/objectSample.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../leakProfiler.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/sampling/objectSample.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,17 +23,18 @@</span>
   */
  
  #ifndef SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  #define SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  
<span class="udiff-line-removed">- #include &quot;jfr/recorder/checkpoint/jfrCheckpointBlob.hpp&quot;</span>
  #include &quot;jfr/utilities/jfrAllocation.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/utilities/jfrBlob.hpp&quot;</span>
  #include &quot;jfr/utilities/jfrTime.hpp&quot;
  #include &quot;jfr/utilities/jfrTypes.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;oops/oop.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
<span class="udiff-line-added">+ </span>
  /*
   * Handle for diagnosing Java memory leaks.
   *
   * The class tracks the time the object was
   * allocated, the thread and the stack trace.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,58 +43,51 @@</span>
    friend class ObjectSampler;
    friend class SampleList;
   private:
    ObjectSample* _next;
    ObjectSample* _previous;
<span class="udiff-line-modified-removed">-   JfrCheckpointBlobHandle _thread_cp;</span>
<span class="udiff-line-modified-removed">-   JfrCheckpointBlobHandle _klass_cp;</span>
<span class="udiff-line-modified-added">+   JfrBlobHandle _stacktrace;</span>
<span class="udiff-line-modified-added">+   JfrBlobHandle _thread;</span>
<span class="udiff-line-added">+   JfrBlobHandle _type_set;</span>
    oop _object;
    Ticks _allocation_time;
    traceid _stack_trace_id;
    traceid _thread_id;
    int _index;
    size_t _span;
    size_t _allocated;
    size_t _heap_used_at_last_gc;
    unsigned int _stack_trace_hash;
<span class="udiff-line-removed">-   bool _dead;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void set_dead() {</span>
<span class="udiff-line-removed">-     _dead = true;</span>
<span class="udiff-line-removed">-   }</span>
  
    void release_references() {
<span class="udiff-line-modified-removed">-     if (_thread_cp.valid()) {</span>
<span class="udiff-line-modified-removed">-       _thread_cp.~JfrCheckpointBlobHandle();</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-removed">-     if (_klass_cp.valid()) {</span>
<span class="udiff-line-removed">-       _klass_cp.~JfrCheckpointBlobHandle();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     _stacktrace.~JfrBlobHandle();</span>
<span class="udiff-line-modified-added">+     _thread.~JfrBlobHandle();</span>
<span class="udiff-line-modified-added">+     _type_set.~JfrBlobHandle();</span>
    }
  
    void reset() {
<span class="udiff-line-added">+     _object = NULL;</span>
      set_stack_trace_id(0);
<span class="udiff-line-modified-removed">-     set_stack_trace_hash(0),</span>
<span class="udiff-line-modified-added">+     set_stack_trace_hash(0);</span>
      release_references();
<span class="udiff-line-removed">-     _dead = false;</span>
    }
  
   public:
    ObjectSample() : _next(NULL),
                     _previous(NULL),
<span class="udiff-line-modified-removed">-                    _thread_cp(),</span>
<span class="udiff-line-modified-removed">-                    _klass_cp(),</span>
<span class="udiff-line-modified-added">+                    _stacktrace(),</span>
<span class="udiff-line-modified-added">+                    _thread(),</span>
<span class="udiff-line-added">+                    _type_set(),</span>
                     _object(NULL),
                     _allocation_time(),
                     _stack_trace_id(0),
                     _thread_id(0),
                     _index(0),
                     _span(0),
                     _allocated(0),
                     _heap_used_at_last_gc(0),
<span class="udiff-line-modified-removed">-                    _stack_trace_hash(0),</span>
<span class="udiff-line-removed">-                    _dead(false) {}</span>
<span class="udiff-line-modified-added">+                    _stack_trace_hash(0) {}</span>
  
    ObjectSample* next() const {
      return _next;
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -108,30 +102,20 @@</span>
    void set_prev(ObjectSample* prev) {
      _previous = prev;
    }
  
    bool is_dead() const {
<span class="udiff-line-modified-removed">-     return _dead;</span>
<span class="udiff-line-modified-added">+     return object() == NULL;</span>
    }
  
<span class="udiff-line-modified-removed">-   const oop object() const {</span>
<span class="udiff-line-modified-removed">-     return _object;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   const oop object() const;</span>
<span class="udiff-line-modified-added">+   void set_object(oop object);</span>
  
    const oop* object_addr() const {
      return &amp;_object;
    }
  
<span class="udiff-line-removed">-   void set_object(oop object) {</span>
<span class="udiff-line-removed">-     _object = object;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   const Klass* klass() const {</span>
<span class="udiff-line-removed">-     assert(_object != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     return _object-&gt;klass();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
    int index() const {
      return _index;
    }
  
    void set_index(int index) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -172,11 +156,11 @@</span>
  
    size_t heap_used_at_last_gc() const {
      return _heap_used_at_last_gc;
    }
  
<span class="udiff-line-modified-removed">-   bool has_stack_trace() const {</span>
<span class="udiff-line-modified-added">+   bool has_stack_trace_id() const {</span>
      return stack_trace_id() != 0;
    }
  
    traceid stack_trace_id() const {
      return _stack_trace_id;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -192,14 +176,10 @@</span>
  
    void set_stack_trace_hash(unsigned int hash) {
      _stack_trace_hash = hash;
    }
  
<span class="udiff-line-removed">-   bool has_thread() const {</span>
<span class="udiff-line-removed">-     return _thread_id != 0;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
    traceid thread_id() const {
      return _thread_id;
    }
  
    void set_thread_id(traceid id) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -209,41 +189,55 @@</span>
    bool is_alive_and_older_than(jlong time_stamp) const {
      return !is_dead() &amp;&amp; (JfrTime::is_ft_enabled() ?
        _allocation_time.ft_value() : _allocation_time.value()) &lt; time_stamp;
    }
  
<span class="udiff-line-modified-removed">-   const JfrCheckpointBlobHandle&amp; thread_checkpoint() const {</span>
<span class="udiff-line-modified-removed">-     return _thread_cp;</span>
<span class="udiff-line-modified-added">+   const JfrBlobHandle&amp; stacktrace() const {</span>
<span class="udiff-line-modified-added">+     return _stacktrace;</span>
    }
  
<span class="udiff-line-modified-removed">-   bool has_thread_checkpoint() const {</span>
<span class="udiff-line-modified-removed">-     return _thread_cp.valid();</span>
<span class="udiff-line-modified-added">+   bool has_stacktrace() const {</span>
<span class="udiff-line-modified-added">+     return _stacktrace.valid();</span>
    }
  
<span class="udiff-line-modified-removed">-   // JfrCheckpointBlobHandle assignment operator</span>
<span class="udiff-line-modified-added">+   // JfrBlobHandle assignment operator</span>
    // maintains proper reference counting
<span class="udiff-line-modified-removed">-   void set_thread_checkpoint(const JfrCheckpointBlobHandle&amp; ref) {</span>
<span class="udiff-line-modified-removed">-     if (_thread_cp != ref) {</span>
<span class="udiff-line-modified-removed">-       _thread_cp = ref;</span>
<span class="udiff-line-modified-added">+   void set_stacktrace(const JfrBlobHandle&amp; ref) {</span>
<span class="udiff-line-modified-added">+     if (_stacktrace != ref) {</span>
<span class="udiff-line-modified-added">+       _stacktrace = ref;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   const JfrBlobHandle&amp; thread() const {</span>
<span class="udiff-line-added">+     return _thread;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool has_thread() const {</span>
<span class="udiff-line-added">+     return _thread.valid();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void set_thread(const JfrBlobHandle&amp; ref) {</span>
<span class="udiff-line-added">+     if (_thread != ref) {</span>
<span class="udiff-line-added">+       _thread = ref;</span>
      }
    }
  
<span class="udiff-line-modified-removed">-   const JfrCheckpointBlobHandle&amp; klass_checkpoint() const {</span>
<span class="udiff-line-modified-removed">-     return _klass_cp;</span>
<span class="udiff-line-modified-added">+   const JfrBlobHandle&amp; type_set() const {</span>
<span class="udiff-line-modified-added">+     return _type_set;</span>
    }
  
<span class="udiff-line-modified-removed">-   bool has_klass_checkpoint() const {</span>
<span class="udiff-line-modified-removed">-     return _klass_cp.valid();</span>
<span class="udiff-line-modified-added">+   bool has_type_set() const {</span>
<span class="udiff-line-modified-added">+     return _type_set.valid();</span>
    }
  
<span class="udiff-line-modified-removed">-   void set_klass_checkpoint(const JfrCheckpointBlobHandle&amp; ref) {</span>
<span class="udiff-line-modified-removed">-     if (_klass_cp != ref) {</span>
<span class="udiff-line-modified-removed">-       if (_klass_cp.valid()) {</span>
<span class="udiff-line-modified-removed">-         _klass_cp-&gt;set_next(ref);</span>
<span class="udiff-line-modified-added">+   void set_type_set(const JfrBlobHandle&amp; ref) {</span>
<span class="udiff-line-modified-added">+     if (_type_set != ref) {</span>
<span class="udiff-line-modified-added">+       if (_type_set.valid()) {</span>
<span class="udiff-line-modified-added">+         _type_set-&gt;set_next(ref);</span>
          return;
        }
<span class="udiff-line-modified-removed">-       _klass_cp = ref;</span>
<span class="udiff-line-modified-added">+       _type_set = ref;</span>
      }
    }
  };
  
  #endif // SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
</pre>
<center><a href="../leakProfiler.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>