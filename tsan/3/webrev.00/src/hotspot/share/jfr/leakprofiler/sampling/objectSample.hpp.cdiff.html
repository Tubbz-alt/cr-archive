<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/leakprofiler/sampling/objectSample.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../leakProfiler.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/sampling/objectSample.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,17 ***</span>
   */
  
  #ifndef SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  #define SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  
<span class="line-removed">- #include &quot;jfr/recorder/checkpoint/jfrCheckpointBlob.hpp&quot;</span>
  #include &quot;jfr/utilities/jfrAllocation.hpp&quot;
  #include &quot;jfr/utilities/jfrTime.hpp&quot;
  #include &quot;jfr/utilities/jfrTypes.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;oops/oop.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
  /*
   * Handle for diagnosing Java memory leaks.
   *
   * The class tracks the time the object was
   * allocated, the thread and the stack trace.
<span class="line-new-header">--- 23,18 ---</span>
   */
  
  #ifndef SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  #define SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
  
  #include &quot;jfr/utilities/jfrAllocation.hpp&quot;
<span class="line-added">+ #include &quot;jfr/utilities/jfrBlob.hpp&quot;</span>
  #include &quot;jfr/utilities/jfrTime.hpp&quot;
  #include &quot;jfr/utilities/jfrTypes.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;oops/oop.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
<span class="line-added">+ </span>
  /*
   * Handle for diagnosing Java memory leaks.
   *
   * The class tracks the time the object was
   * allocated, the thread and the stack trace.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 42,58 ***</span>
    friend class ObjectSampler;
    friend class SampleList;
   private:
    ObjectSample* _next;
    ObjectSample* _previous;
<span class="line-modified">!   JfrCheckpointBlobHandle _thread_cp;</span>
<span class="line-modified">!   JfrCheckpointBlobHandle _klass_cp;</span>
    oop _object;
    Ticks _allocation_time;
    traceid _stack_trace_id;
    traceid _thread_id;
    int _index;
    size_t _span;
    size_t _allocated;
    size_t _heap_used_at_last_gc;
    unsigned int _stack_trace_hash;
<span class="line-removed">-   bool _dead;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   void set_dead() {</span>
<span class="line-removed">-     _dead = true;</span>
<span class="line-removed">-   }</span>
  
    void release_references() {
<span class="line-modified">!     if (_thread_cp.valid()) {</span>
<span class="line-modified">!       _thread_cp.~JfrCheckpointBlobHandle();</span>
<span class="line-modified">!     }</span>
<span class="line-removed">-     if (_klass_cp.valid()) {</span>
<span class="line-removed">-       _klass_cp.~JfrCheckpointBlobHandle();</span>
<span class="line-removed">-     }</span>
    }
  
    void reset() {
      set_stack_trace_id(0);
<span class="line-modified">!     set_stack_trace_hash(0),</span>
      release_references();
<span class="line-removed">-     _dead = false;</span>
    }
  
   public:
    ObjectSample() : _next(NULL),
                     _previous(NULL),
<span class="line-modified">!                    _thread_cp(),</span>
<span class="line-modified">!                    _klass_cp(),</span>
                     _object(NULL),
                     _allocation_time(),
                     _stack_trace_id(0),
                     _thread_id(0),
                     _index(0),
                     _span(0),
                     _allocated(0),
                     _heap_used_at_last_gc(0),
<span class="line-modified">!                    _stack_trace_hash(0),</span>
<span class="line-removed">-                    _dead(false) {}</span>
  
    ObjectSample* next() const {
      return _next;
    }
  
<span class="line-new-header">--- 43,51 ---</span>
    friend class ObjectSampler;
    friend class SampleList;
   private:
    ObjectSample* _next;
    ObjectSample* _previous;
<span class="line-modified">!   JfrBlobHandle _stacktrace;</span>
<span class="line-modified">!   JfrBlobHandle _thread;</span>
<span class="line-added">+   JfrBlobHandle _type_set;</span>
    oop _object;
    Ticks _allocation_time;
    traceid _stack_trace_id;
    traceid _thread_id;
    int _index;
    size_t _span;
    size_t _allocated;
    size_t _heap_used_at_last_gc;
    unsigned int _stack_trace_hash;
  
    void release_references() {
<span class="line-modified">!     _stacktrace.~JfrBlobHandle();</span>
<span class="line-modified">!     _thread.~JfrBlobHandle();</span>
<span class="line-modified">!     _type_set.~JfrBlobHandle();</span>
    }
  
    void reset() {
<span class="line-added">+     _object = NULL;</span>
      set_stack_trace_id(0);
<span class="line-modified">!     set_stack_trace_hash(0);</span>
      release_references();
    }
  
   public:
    ObjectSample() : _next(NULL),
                     _previous(NULL),
<span class="line-modified">!                    _stacktrace(),</span>
<span class="line-modified">!                    _thread(),</span>
<span class="line-added">+                    _type_set(),</span>
                     _object(NULL),
                     _allocation_time(),
                     _stack_trace_id(0),
                     _thread_id(0),
                     _index(0),
                     _span(0),
                     _allocated(0),
                     _heap_used_at_last_gc(0),
<span class="line-modified">!                    _stack_trace_hash(0) {}</span>
  
    ObjectSample* next() const {
      return _next;
    }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,30 ***</span>
    void set_prev(ObjectSample* prev) {
      _previous = prev;
    }
  
    bool is_dead() const {
<span class="line-modified">!     return _dead;</span>
    }
  
<span class="line-modified">!   const oop object() const {</span>
<span class="line-modified">!     return _object;</span>
<span class="line-removed">-   }</span>
  
    const oop* object_addr() const {
      return &amp;_object;
    }
  
<span class="line-removed">-   void set_object(oop object) {</span>
<span class="line-removed">-     _object = object;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   const Klass* klass() const {</span>
<span class="line-removed">-     assert(_object != NULL, &quot;invariant&quot;);</span>
<span class="line-removed">-     return _object-&gt;klass();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
    int index() const {
      return _index;
    }
  
    void set_index(int index) {
<span class="line-new-header">--- 102,20 ---</span>
    void set_prev(ObjectSample* prev) {
      _previous = prev;
    }
  
    bool is_dead() const {
<span class="line-modified">!     return object() == NULL;</span>
    }
  
<span class="line-modified">!   const oop object() const;</span>
<span class="line-modified">!   void set_object(oop object);</span>
  
    const oop* object_addr() const {
      return &amp;_object;
    }
  
    int index() const {
      return _index;
    }
  
    void set_index(int index) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 172,11 ***</span>
  
    size_t heap_used_at_last_gc() const {
      return _heap_used_at_last_gc;
    }
  
<span class="line-modified">!   bool has_stack_trace() const {</span>
      return stack_trace_id() != 0;
    }
  
    traceid stack_trace_id() const {
      return _stack_trace_id;
<span class="line-new-header">--- 156,11 ---</span>
  
    size_t heap_used_at_last_gc() const {
      return _heap_used_at_last_gc;
    }
  
<span class="line-modified">!   bool has_stack_trace_id() const {</span>
      return stack_trace_id() != 0;
    }
  
    traceid stack_trace_id() const {
      return _stack_trace_id;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,14 ***</span>
  
    void set_stack_trace_hash(unsigned int hash) {
      _stack_trace_hash = hash;
    }
  
<span class="line-removed">-   bool has_thread() const {</span>
<span class="line-removed">-     return _thread_id != 0;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
    traceid thread_id() const {
      return _thread_id;
    }
  
    void set_thread_id(traceid id) {
<span class="line-new-header">--- 176,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 209,41 ***</span>
    bool is_alive_and_older_than(jlong time_stamp) const {
      return !is_dead() &amp;&amp; (JfrTime::is_ft_enabled() ?
        _allocation_time.ft_value() : _allocation_time.value()) &lt; time_stamp;
    }
  
<span class="line-modified">!   const JfrCheckpointBlobHandle&amp; thread_checkpoint() const {</span>
<span class="line-modified">!     return _thread_cp;</span>
    }
  
<span class="line-modified">!   bool has_thread_checkpoint() const {</span>
<span class="line-modified">!     return _thread_cp.valid();</span>
    }
  
<span class="line-modified">!   // JfrCheckpointBlobHandle assignment operator</span>
    // maintains proper reference counting
<span class="line-modified">!   void set_thread_checkpoint(const JfrCheckpointBlobHandle&amp; ref) {</span>
<span class="line-modified">!     if (_thread_cp != ref) {</span>
<span class="line-modified">!       _thread_cp = ref;</span>
      }
    }
  
<span class="line-modified">!   const JfrCheckpointBlobHandle&amp; klass_checkpoint() const {</span>
<span class="line-modified">!     return _klass_cp;</span>
    }
  
<span class="line-modified">!   bool has_klass_checkpoint() const {</span>
<span class="line-modified">!     return _klass_cp.valid();</span>
    }
  
<span class="line-modified">!   void set_klass_checkpoint(const JfrCheckpointBlobHandle&amp; ref) {</span>
<span class="line-modified">!     if (_klass_cp != ref) {</span>
<span class="line-modified">!       if (_klass_cp.valid()) {</span>
<span class="line-modified">!         _klass_cp-&gt;set_next(ref);</span>
          return;
        }
<span class="line-modified">!       _klass_cp = ref;</span>
      }
    }
  };
  
  #endif // SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
<span class="line-new-header">--- 189,55 ---</span>
    bool is_alive_and_older_than(jlong time_stamp) const {
      return !is_dead() &amp;&amp; (JfrTime::is_ft_enabled() ?
        _allocation_time.ft_value() : _allocation_time.value()) &lt; time_stamp;
    }
  
<span class="line-modified">!   const JfrBlobHandle&amp; stacktrace() const {</span>
<span class="line-modified">!     return _stacktrace;</span>
    }
  
<span class="line-modified">!   bool has_stacktrace() const {</span>
<span class="line-modified">!     return _stacktrace.valid();</span>
    }
  
<span class="line-modified">!   // JfrBlobHandle assignment operator</span>
    // maintains proper reference counting
<span class="line-modified">!   void set_stacktrace(const JfrBlobHandle&amp; ref) {</span>
<span class="line-modified">!     if (_stacktrace != ref) {</span>
<span class="line-modified">!       _stacktrace = ref;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   const JfrBlobHandle&amp; thread() const {</span>
<span class="line-added">+     return _thread;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   bool has_thread() const {</span>
<span class="line-added">+     return _thread.valid();</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   void set_thread(const JfrBlobHandle&amp; ref) {</span>
<span class="line-added">+     if (_thread != ref) {</span>
<span class="line-added">+       _thread = ref;</span>
      }
    }
  
<span class="line-modified">!   const JfrBlobHandle&amp; type_set() const {</span>
<span class="line-modified">!     return _type_set;</span>
    }
  
<span class="line-modified">!   bool has_type_set() const {</span>
<span class="line-modified">!     return _type_set.valid();</span>
    }
  
<span class="line-modified">!   void set_type_set(const JfrBlobHandle&amp; ref) {</span>
<span class="line-modified">!     if (_type_set != ref) {</span>
<span class="line-modified">!       if (_type_set.valid()) {</span>
<span class="line-modified">!         _type_set-&gt;set_next(ref);</span>
          return;
        }
<span class="line-modified">!       _type_set = ref;</span>
      }
    }
  };
  
  #endif // SHARE_JFR_LEAKPROFILER_SAMPLING_OBJECTSAMPLE_HPP
</pre>
<center><a href="../leakProfiler.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>