<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/chains/bitset.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="bitset.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="dfsClosure.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/chains/bitset.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,56 +24,94 @@</span>
  
  #ifndef SHARE_JFR_LEAKPROFILER_CHAINS_BITSET_HPP
  #define SHARE_JFR_LEAKPROFILER_CHAINS_BITSET_HPP
  
  #include &quot;memory/allocation.hpp&quot;
<span class="udiff-line-added">+ #include &quot;oops/oop.hpp&quot;</span>
  #include &quot;oops/oopsHierarchy.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;utilities/bitMap.inline.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;utilities/bitMap.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;utilities/hashtable.hpp&quot;</span>
  
  class JfrVirtualMemory;
  class MemRegion;
  
  class BitSet : public CHeapObj&lt;mtTracing&gt; {
<span class="udiff-line-modified-removed">-  private:</span>
<span class="udiff-line-modified-removed">-   JfrVirtualMemory* _vmm;</span>
<span class="udiff-line-modified-removed">-   const HeapWord* const _region_start;</span>
<span class="udiff-line-modified-removed">-   BitMapView _bits;</span>
<span class="udiff-line-modified-removed">-   const size_t _region_size;</span>
<span class="udiff-line-modified-added">+   const static size_t _bitmap_granularity_shift = 26; // 64M</span>
<span class="udiff-line-modified-added">+   const static size_t _bitmap_granularity_size = (size_t)1 &lt;&lt; _bitmap_granularity_shift;</span>
<span class="udiff-line-modified-added">+   const static size_t _bitmap_granularity_mask = _bitmap_granularity_size - 1;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   class BitMapFragment;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   class BitMapFragmentTable : public BasicHashtable&lt;mtTracing&gt; {</span>
<span class="udiff-line-added">+     class Entry : public BasicHashtableEntry&lt;mtTracing&gt; {</span>
<span class="udiff-line-added">+     public:</span>
<span class="udiff-line-added">+       uintptr_t _key;</span>
<span class="udiff-line-added">+       CHeapBitMap* _value;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       Entry* next() {</span>
<span class="udiff-line-added">+         return (Entry*)BasicHashtableEntry&lt;mtTracing&gt;::next();</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   protected:</span>
<span class="udiff-line-added">+     Entry* bucket(int i) const;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Entry* new_entry(unsigned int hashValue, uintptr_t key, CHeapBitMap* value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned hash_segment(uintptr_t key) {</span>
<span class="udiff-line-added">+       unsigned hash = (unsigned)key;</span>
<span class="udiff-line-added">+       return hash ^ (hash &gt;&gt; 3);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned hash_to_index(unsigned hash) {</span>
<span class="udiff-line-added">+       return hash &amp; (BasicHashtable&lt;mtTracing&gt;::table_size() - 1);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   public:</span>
<span class="udiff-line-added">+     BitMapFragmentTable(int table_size) : BasicHashtable&lt;mtTracing&gt;(table_size, sizeof(Entry)) {}</span>
<span class="udiff-line-added">+     void add(uintptr_t key, CHeapBitMap* value);</span>
<span class="udiff-line-added">+     CHeapBitMap** lookup(uintptr_t key);</span>
<span class="udiff-line-added">+   };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   CHeapBitMap* get_fragment_bits(uintptr_t addr);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   BitMapFragmentTable _bitmap_fragments;</span>
<span class="udiff-line-added">+   BitMapFragment* _fragment_list;</span>
<span class="udiff-line-added">+   CHeapBitMap* _last_fragment_bits;</span>
<span class="udiff-line-added">+   uintptr_t _last_fragment_granule;</span>
  
   public:
<span class="udiff-line-modified-removed">-   BitSet(const MemRegion&amp; covered_region);</span>
<span class="udiff-line-modified-added">+   BitSet();</span>
    ~BitSet();
  
<span class="udiff-line-modified-removed">-   bool initialize();</span>
<span class="udiff-line-modified-added">+   BitMap::idx_t addr_to_bit(uintptr_t addr) const;</span>
  
<span class="udiff-line-modified-removed">-   BitMap::idx_t mark_obj(const HeapWord* addr) {</span>
<span class="udiff-line-removed">-     const BitMap::idx_t bit = addr_to_bit(addr);</span>
<span class="udiff-line-removed">-     _bits.par_set_bit(bit);</span>
<span class="udiff-line-removed">-     return bit;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   void mark_obj(uintptr_t addr);</span>
  
<span class="udiff-line-modified-removed">-   BitMap::idx_t mark_obj(oop obj) {</span>
<span class="udiff-line-modified-removed">-     return mark_obj((HeapWord*)obj);</span>
<span class="udiff-line-modified-added">+   void mark_obj(oop obj) {</span>
<span class="udiff-line-modified-added">+     return mark_obj(cast_from_oop&lt;uintptr_t&gt;(obj));</span>
    }
  
<span class="udiff-line-modified-removed">-   bool is_marked(const HeapWord* addr) const {</span>
<span class="udiff-line-removed">-     return is_marked(addr_to_bit(addr));</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   bool is_marked(uintptr_t addr);</span>
  
<span class="udiff-line-modified-removed">-   bool is_marked(oop obj) const {</span>
<span class="udiff-line-modified-removed">-     return is_marked((HeapWord*)obj);</span>
<span class="udiff-line-modified-added">+   bool is_marked(oop obj) {</span>
<span class="udiff-line-modified-added">+     return is_marked(cast_from_oop&lt;uintptr_t&gt;(obj));</span>
    }
<span class="udiff-line-added">+ };</span>
  
<span class="udiff-line-modified-removed">-   BitMap::idx_t size() const {</span>
<span class="udiff-line-modified-removed">-     return _bits.size();</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-added">+ class BitSet::BitMapFragment : public CHeapObj&lt;mtTracing&gt; {</span>
<span class="udiff-line-modified-added">+   CHeapBitMap _bits;</span>
<span class="udiff-line-modified-added">+   BitMapFragment* _next;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+   BitMapFragment(uintptr_t granule, BitMapFragment* next);</span>
  
<span class="udiff-line-modified-removed">-   BitMap::idx_t addr_to_bit(const HeapWord* addr) const {</span>
<span class="udiff-line-modified-removed">-     return pointer_delta(addr, _region_start) &gt;&gt; LogMinObjAlignment;</span>
<span class="udiff-line-modified-added">+   BitMapFragment* next() const {</span>
<span class="udiff-line-modified-added">+     return _next;</span>
    }
  
<span class="udiff-line-modified-removed">-   bool is_marked(const BitMap::idx_t bit) const {</span>
<span class="udiff-line-modified-removed">-     return _bits.at(bit);</span>
<span class="udiff-line-modified-added">+   CHeapBitMap* bits() {</span>
<span class="udiff-line-modified-added">+     return &amp;_bits;</span>
    }
  };
  
  #endif // SHARE_JFR_LEAKPROFILER_CHAINS_BITSET_HPP
</pre>
<center><a href="bitset.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="dfsClosure.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>