<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/chains/objectSampleMarker.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="edgeUtils.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="rootSetClosure.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/chains/objectSampleMarker.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -24,58 +24,55 @@</span>
  
  #ifndef SHARE_JFR_LEAKPROFILER_CHAINS_OBJECTSAMPLEMARKER_HPP
  #define SHARE_JFR_LEAKPROFILER_CHAINS_OBJECTSAMPLEMARKER_HPP
  
  #include &quot;memory/allocation.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;oops/markOop.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;oops/markWord.hpp&quot;</span>
  #include &quot;utilities/growableArray.hpp&quot;
  //
  // This class will save the original mark oop of a object sample object.
  // It will then install an &quot;identifier&quot; mark oop to be used for
  // identification purposes in the search for reference chains.
  // The destructor will restore each modified oop with its original mark oop.
  //
  class ObjectSampleMarker : public StackObj {
   private:
<span class="udiff-line-modified-removed">-   class ObjectSampleMarkOop : public ResourceObj {</span>
<span class="udiff-line-modified-added">+   class ObjectSampleMarkWord : public ResourceObj {</span>
      friend class ObjectSampleMarker;
     private:
      oop _obj;
<span class="udiff-line-modified-removed">-     markOop _mark_oop;</span>
<span class="udiff-line-modified-removed">-     ObjectSampleMarkOop(const oop obj,</span>
<span class="udiff-line-modified-removed">-                         const markOop mark_oop) : _obj(obj),</span>
<span class="udiff-line-modified-removed">-                                                   _mark_oop(mark_oop) {}</span>
<span class="udiff-line-modified-added">+     markWord _mark_word;</span>
<span class="udiff-line-modified-added">+     ObjectSampleMarkWord(const oop obj,</span>
<span class="udiff-line-modified-added">+                          const markWord mark_word) : _obj(obj),</span>
<span class="udiff-line-modified-added">+                                                      _mark_word(mark_word) {}</span>
     public:
<span class="udiff-line-modified-removed">-     ObjectSampleMarkOop() : _obj(NULL), _mark_oop(NULL) {}</span>
<span class="udiff-line-modified-added">+     ObjectSampleMarkWord() : _obj(NULL), _mark_word(markWord::zero()) {}</span>
    };
  
<span class="udiff-line-modified-removed">-   GrowableArray&lt;ObjectSampleMarkOop&gt;* _store;</span>
<span class="udiff-line-modified-added">+   GrowableArray&lt;ObjectSampleMarkWord&gt;* _store;</span>
  
   public:
    ObjectSampleMarker() :
<span class="udiff-line-modified-removed">-        _store(new GrowableArray&lt;ObjectSampleMarkOop&gt;(16)) {}</span>
<span class="udiff-line-modified-added">+        _store(new GrowableArray&lt;ObjectSampleMarkWord&gt;(16)) {}</span>
    ~ObjectSampleMarker() {
      assert(_store != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-     // restore the saved, original, markOop for sample objects</span>
<span class="udiff-line-modified-added">+     // restore the saved, original, markWord for sample objects</span>
      while (_store-&gt;is_nonempty()) {
<span class="udiff-line-modified-removed">-       ObjectSampleMarkOop sample_oop = _store-&gt;pop();</span>
<span class="udiff-line-modified-removed">-       sample_oop._obj-&gt;set_mark(sample_oop._mark_oop);</span>
<span class="udiff-line-modified-removed">-       assert(sample_oop._obj-&gt;mark() == sample_oop._mark_oop, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+       ObjectSampleMarkWord sample_oop = _store-&gt;pop();</span>
<span class="udiff-line-modified-added">+       sample_oop._obj-&gt;set_mark(sample_oop._mark_word);</span>
<span class="udiff-line-modified-added">+       assert(sample_oop._obj-&gt;mark() == sample_oop._mark_word, &quot;invariant&quot;);</span>
      }
    }
  
    void mark(oop obj) {
      assert(obj != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-     // save the original markOop</span>
<span class="udiff-line-modified-removed">-     _store-&gt;push(ObjectSampleMarkOop(obj, obj-&gt;mark()));</span>
<span class="udiff-line-modified-removed">-     // now we will &quot;poison&quot; the mark word of the sample object</span>
<span class="udiff-line-modified-removed">-     // to the intermediate monitor INFLATING state.</span>
<span class="udiff-line-modified-removed">-     // This is an &quot;impossible&quot; state during a safepoint,</span>
<span class="udiff-line-modified-removed">-     // hence we will use it to quickly identify sample objects</span>
<span class="udiff-line-modified-removed">-     // during the reachability search from gc roots.</span>
<span class="udiff-line-removed">-     assert(NULL == markOopDesc::INFLATING(), &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-     obj-&gt;set_mark(markOopDesc::INFLATING());</span>
<span class="udiff-line-removed">-     assert(NULL == obj-&gt;mark(), &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+     // save the original markWord</span>
<span class="udiff-line-modified-added">+     _store-&gt;push(ObjectSampleMarkWord(obj, obj-&gt;mark()));</span>
<span class="udiff-line-modified-added">+     // now we will set the mark word to &quot;marked&quot; in order to quickly</span>
<span class="udiff-line-modified-added">+     // identify sample objects during the reachability search from gc roots.</span>
<span class="udiff-line-modified-added">+     assert(!obj-&gt;mark().is_marked(), &quot;should only mark an object once&quot;);</span>
<span class="udiff-line-modified-added">+     obj-&gt;set_mark(markWord::prototype().set_marked());</span>
<span class="udiff-line-modified-added">+     assert(obj-&gt;mark().is_marked(), &quot;invariant&quot;);</span>
    }
  };
  
  #endif // SHARE_JFR_LEAKPROFILER_CHAINS_OBJECTSAMPLEMARKER_HPP
</pre>
<center><a href="edgeUtils.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="rootSetClosure.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>