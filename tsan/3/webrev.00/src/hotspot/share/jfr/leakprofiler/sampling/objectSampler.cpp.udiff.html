<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/leakprofiler/sampling/objectSampler.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="objectSample.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/leakprofiler/sampling/objectSampler.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -19,10 +19,11 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   *
   */
<span class="udiff-line-added">+ </span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;jfr/jfrEvents.hpp&quot;
  #include &quot;jfr/leakprofiler/sampling/objectSample.hpp&quot;
  #include &quot;jfr/leakprofiler/sampling/objectSampler.hpp&quot;
  #include &quot;jfr/leakprofiler/sampling/sampleList.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -33,54 +34,123 @@</span>
  #include &quot;jfr/support/jfrThreadLocal.hpp&quot;
  #include &quot;jfr/utilities/jfrTryLock.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;runtime/orderAccess.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;runtime/safepoint.hpp&quot;</span>
  #include &quot;runtime/thread.hpp&quot;
  
<span class="udiff-line-added">+ static ObjectSampler* _instance = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static ObjectSampler&amp; instance() {</span>
<span class="udiff-line-added">+   assert(_instance != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   return *_instance;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  ObjectSampler::ObjectSampler(size_t size) :
    _priority_queue(new SamplePriorityQueue(size)),
    _list(new SampleList(size)),
    _last_sweep(JfrTicks::now()),
    _total_allocated(0),
    _threshold(0),
    _size(size),
<span class="udiff-line-removed">-   _tryLock(0),</span>
    _dead_samples(false) {}
  
  ObjectSampler::~ObjectSampler() {
    delete _priority_queue;
    _priority_queue = NULL;
    delete _list;
    _list = NULL;
  }
  
<span class="udiff-line-modified-removed">- void ObjectSampler::add(HeapWord* obj, size_t allocated, JavaThread* thread) {</span>
<span class="udiff-line-modified-removed">-   assert(thread != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-removed">-   const traceid thread_id = thread-&gt;threadObj() != NULL ? thread-&gt;jfr_thread_local()-&gt;thread_id() : 0;</span>
<span class="udiff-line-modified-removed">-   if (thread_id == 0) {</span>
<span class="udiff-line-modified-removed">-     return;</span>
<span class="udiff-line-modified-added">+ bool ObjectSampler::create(size_t size) {</span>
<span class="udiff-line-modified-added">+   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+   assert(_instance == NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+   _instance = new ObjectSampler(size);</span>
<span class="udiff-line-modified-added">+   return _instance != NULL;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool ObjectSampler::is_created() {</span>
<span class="udiff-line-added">+   return _instance != NULL;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ObjectSampler* ObjectSampler::sampler() {</span>
<span class="udiff-line-added">+   assert(is_created(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   return _instance;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ObjectSampler::destroy() {</span>
<span class="udiff-line-added">+   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   if (_instance != NULL) {</span>
<span class="udiff-line-added">+     ObjectSampler* const sampler = _instance;</span>
<span class="udiff-line-added">+     _instance = NULL;</span>
<span class="udiff-line-added">+     delete sampler;</span>
    }
<span class="udiff-line-modified-removed">-   assert(thread_id != 0, &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static volatile int _lock = 0;</span>
  
<span class="udiff-line-modified-removed">-   if (!thread-&gt;jfr_thread_local()-&gt;has_thread_checkpoint()) {</span>
<span class="udiff-line-modified-removed">-     JfrCheckpointManager::create_thread_checkpoint(thread);</span>
<span class="udiff-line-modified-removed">-     assert(thread-&gt;jfr_thread_local()-&gt;has_thread_checkpoint(), &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+ ObjectSampler* ObjectSampler::acquire() {</span>
<span class="udiff-line-modified-added">+   assert(is_created(), &quot;invariant&quot;);</span>
<span class="udiff-line-modified-added">+   while (Atomic::cmpxchg(&amp;_lock, 0, 1) == 1) {}</span>
<span class="udiff-line-added">+   return _instance;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ObjectSampler::release() {</span>
<span class="udiff-line-added">+   assert(is_created(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   OrderAccess::fence();</span>
<span class="udiff-line-added">+   _lock = 0;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static traceid get_thread_id(JavaThread* thread) {</span>
<span class="udiff-line-added">+   assert(thread != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   if (thread-&gt;threadObj() == NULL) {</span>
<span class="udiff-line-added">+     return 0;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   const JfrThreadLocal* const tl = thread-&gt;jfr_thread_local();</span>
<span class="udiff-line-added">+   assert(tl != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   if (tl-&gt;is_excluded()) {</span>
<span class="udiff-line-added">+     return 0;</span>
    }
<span class="udiff-line-added">+   if (!tl-&gt;has_thread_blob()) {</span>
<span class="udiff-line-added">+     JfrCheckpointManager::create_thread_blob(thread);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   assert(tl-&gt;has_thread_blob(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   return tl-&gt;thread_id();</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   traceid stack_trace_id = 0;</span>
<span class="udiff-line-modified-removed">-   unsigned int stack_trace_hash = 0;</span>
<span class="udiff-line-modified-added">+ static void record_stacktrace(JavaThread* thread) {</span>
<span class="udiff-line-modified-added">+   assert(thread != NULL, &quot;invariant&quot;);</span>
    if (JfrEventSetting::has_stacktrace(EventOldObjectSample::eventId)) {
<span class="udiff-line-modified-removed">-     stack_trace_id = JfrStackTraceRepository::record(thread, 0, &amp;stack_trace_hash);</span>
<span class="udiff-line-removed">-     thread-&gt;jfr_thread_local()-&gt;set_cached_stack_trace_id(stack_trace_id, stack_trace_hash);</span>
<span class="udiff-line-modified-added">+     JfrStackTraceRepository::record_and_cache(thread);</span>
    }
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-modified-removed">-   JfrTryLock tryLock(&amp;_tryLock);</span>
<span class="udiff-line-modified-added">+ void ObjectSampler::sample(HeapWord* obj, size_t allocated, JavaThread* thread) {</span>
<span class="udiff-line-added">+   assert(thread != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(is_created(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   const traceid thread_id = get_thread_id(thread);</span>
<span class="udiff-line-added">+   if (thread_id == 0) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   record_stacktrace(thread);</span>
<span class="udiff-line-added">+   // try enter critical section</span>
<span class="udiff-line-added">+   JfrTryLock tryLock(&amp;_lock);</span>
    if (!tryLock.has_lock()) {
      log_trace(jfr, oldobject, sampling)(&quot;Skipping old object sample due to lock contention&quot;);
      return;
    }
<span class="udiff-line-added">+   instance().add(obj, allocated, thread_id, thread);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ObjectSampler::add(HeapWord* obj, size_t allocated, traceid thread_id, JavaThread* thread) {</span>
<span class="udiff-line-added">+   assert(obj != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(thread_id != 0, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(thread != NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(thread-&gt;jfr_thread_local()-&gt;has_thread_blob(), &quot;invariant&quot;);</span>
  
    if (_dead_samples) {
      scavenge();
      assert(!_dead_samples, &quot;invariant&quot;);
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -99,85 +169,90 @@</span>
    } else {
      sample = _list-&gt;get();
    }
  
    assert(sample != NULL, &quot;invariant&quot;);
<span class="udiff-line-removed">-   assert(thread_id != 0, &quot;invariant&quot;);</span>
    sample-&gt;set_thread_id(thread_id);
<span class="udiff-line-removed">-   sample-&gt;set_thread_checkpoint(thread-&gt;jfr_thread_local()-&gt;thread_checkpoint());</span>
  
<span class="udiff-line-modified-removed">-   if (stack_trace_id != 0) {</span>
<span class="udiff-line-modified-removed">-     sample-&gt;set_stack_trace_id(stack_trace_id);</span>
<span class="udiff-line-modified-removed">-     sample-&gt;set_stack_trace_hash(stack_trace_hash);</span>
<span class="udiff-line-modified-added">+   const JfrThreadLocal* const tl = thread-&gt;jfr_thread_local();</span>
<span class="udiff-line-modified-added">+   sample-&gt;set_thread(tl-&gt;thread_blob());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   const unsigned int stacktrace_hash = tl-&gt;cached_stack_trace_hash();</span>
<span class="udiff-line-added">+   if (stacktrace_hash != 0) {</span>
<span class="udiff-line-added">+     sample-&gt;set_stack_trace_id(tl-&gt;cached_stack_trace_id());</span>
<span class="udiff-line-added">+     sample-&gt;set_stack_trace_hash(stacktrace_hash);</span>
    }
  
    sample-&gt;set_span(allocated);
    sample-&gt;set_object((oop)obj);
    sample-&gt;set_allocated(allocated);
    sample-&gt;set_allocation_time(JfrTicks::now());
    sample-&gt;set_heap_used_at_last_gc(Universe::get_heap_used_at_last_gc());
    _priority_queue-&gt;push(sample);
  }
  
<span class="udiff-line-modified-removed">- const ObjectSample* ObjectSampler::last() const {</span>
<span class="udiff-line-removed">-   return _list-&gt;last();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- const ObjectSample* ObjectSampler::first() const {</span>
<span class="udiff-line-removed">-   return _list-&gt;first();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- const ObjectSample* ObjectSampler::last_resolved() const {</span>
<span class="udiff-line-removed">-   return _list-&gt;last_resolved();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ObjectSampler::set_last_resolved(const ObjectSample* sample) {</span>
<span class="udiff-line-removed">-   _list-&gt;set_last_resolved(sample);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ObjectSampler::oops_do(BoolObjectClosure* is_alive, OopClosure* f) {</span>
<span class="udiff-line-modified-added">+ void ObjectSampler::scavenge() {</span>
    ObjectSample* current = _list-&gt;last();
    while (current != NULL) {
      ObjectSample* next = current-&gt;next();
<span class="udiff-line-modified-removed">-     if (!current-&gt;is_dead()) {</span>
<span class="udiff-line-modified-removed">-       if (is_alive-&gt;do_object_b(current-&gt;object())) {</span>
<span class="udiff-line-removed">-         // The weakly referenced object is alive, update pointer</span>
<span class="udiff-line-removed">-         f-&gt;do_oop(const_cast&lt;oop*&gt;(current-&gt;object_addr()));</span>
<span class="udiff-line-removed">-       } else {</span>
<span class="udiff-line-removed">-         current-&gt;set_dead();</span>
<span class="udiff-line-removed">-         _dead_samples = true;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-modified-added">+     if (current-&gt;is_dead()) {</span>
<span class="udiff-line-modified-added">+       remove_dead(current);</span>
      }
      current = next;
    }
<span class="udiff-line-modified-removed">-   _last_sweep = JfrTicks::now();</span>
<span class="udiff-line-modified-added">+   _dead_samples = false;</span>
  }
  
  void ObjectSampler::remove_dead(ObjectSample* sample) {
    assert(sample != NULL, &quot;invariant&quot;);
    assert(sample-&gt;is_dead(), &quot;invariant&quot;);
    ObjectSample* const previous = sample-&gt;prev();
<span class="udiff-line-modified-removed">-   // push span on to previous</span>
<span class="udiff-line-modified-added">+   // push span onto previous</span>
    if (previous != NULL) {
      _priority_queue-&gt;remove(previous);
      previous-&gt;add_span(sample-&gt;span());
      _priority_queue-&gt;push(previous);
    }
    _priority_queue-&gt;remove(sample);
    _list-&gt;release(sample);
  }
  
<span class="udiff-line-modified-removed">- void ObjectSampler::scavenge() {</span>
<span class="udiff-line-modified-removed">-   ObjectSample* current = _list-&gt;last();</span>
<span class="udiff-line-modified-added">+ void ObjectSampler::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* f) {</span>
<span class="udiff-line-modified-added">+   assert(is_created(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
<span class="udiff-line-added">+   ObjectSampler&amp; sampler = instance();</span>
<span class="udiff-line-added">+   ObjectSample* current = sampler._list-&gt;last();</span>
    while (current != NULL) {
<span class="udiff-line-modified-removed">-     ObjectSample* next = current-&gt;next();</span>
<span class="udiff-line-modified-removed">-     if (current-&gt;is_dead()) {</span>
<span class="udiff-line-modified-removed">-       remove_dead(current);</span>
<span class="udiff-line-modified-added">+     if (current-&gt;_object != NULL) {</span>
<span class="udiff-line-modified-added">+       if (is_alive-&gt;do_object_b(current-&gt;object())) {</span>
<span class="udiff-line-modified-added">+         // The weakly referenced object is alive, update pointer</span>
<span class="udiff-line-added">+         f-&gt;do_oop(const_cast&lt;oop*&gt;(current-&gt;object_addr()));</span>
<span class="udiff-line-added">+       } else {</span>
<span class="udiff-line-added">+         // clear existing field to assist GC barriers</span>
<span class="udiff-line-added">+         current-&gt;_object = NULL;</span>
<span class="udiff-line-added">+         sampler._dead_samples = true;</span>
<span class="udiff-line-added">+       }</span>
      }
<span class="udiff-line-modified-removed">-     current = next;</span>
<span class="udiff-line-modified-added">+     current = current-&gt;next();</span>
    }
<span class="udiff-line-modified-removed">-   _dead_samples = false;</span>
<span class="udiff-line-modified-added">+   sampler._last_sweep = JfrTicks::now();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ObjectSample* ObjectSampler::last() const {</span>
<span class="udiff-line-added">+   return _list-&gt;last();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ const ObjectSample* ObjectSampler::first() const {</span>
<span class="udiff-line-added">+   return _list-&gt;first();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ const ObjectSample* ObjectSampler::last_resolved() const {</span>
<span class="udiff-line-added">+   return _list-&gt;last_resolved();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ObjectSampler::set_last_resolved(const ObjectSample* sample) {</span>
<span class="udiff-line-added">+   _list-&gt;set_last_resolved(sample);</span>
  }
  
  int ObjectSampler::item_count() const {
    return _priority_queue-&gt;count();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -187,11 +262,11 @@</span>
  }
  
  ObjectSample* ObjectSampler::item_at(int index) {
    return const_cast&lt;ObjectSample*&gt;(
      const_cast&lt;const ObjectSampler*&gt;(this)-&gt;item_at(index)
<span class="udiff-line-modified-removed">-                                    );</span>
<span class="udiff-line-modified-added">+                                   );</span>
  }
  
  const JfrTicks&amp; ObjectSampler::last_sweep() const {
    return _last_sweep;
  }
</pre>
<center><a href="objectSample.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="objectSampler.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>