<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jfr/jni/jfrGetAllEventClasses.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../jfr.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrJavaCall.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/jni/jfrGetAllEventClasses.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 31,25 ***</span>
  #include &quot;oops/instanceKlass.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/mutexLocker.hpp&quot;
<span class="line-removed">- #include &quot;runtime/safepoint.hpp&quot;</span>
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
  #include &quot;utilities/stack.inline.hpp&quot;
  
<span class="line-modified">!  // incremented during class unloading (safepoint) for each unloaded event class</span>
  static jlong unloaded_event_classes = 0;
  
  jlong JfrEventClasses::unloaded_event_classes_count() {
    return unloaded_event_classes;
  }
  
  void JfrEventClasses::increment_unloaded_event_class() {
<span class="line-modified">!   // incremented during class unloading (safepoint) for each unloaded event class</span>
<span class="line-removed">-   assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);</span>
    ++unloaded_event_classes;
  }
  
  static jobject empty_java_util_arraylist = NULL;
  
<span class="line-new-header">--- 31,23 ---</span>
  #include &quot;oops/instanceKlass.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/mutexLocker.hpp&quot;
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
  #include &quot;utilities/stack.inline.hpp&quot;
  
<span class="line-modified">!  // incremented during class unloading for each unloaded event class</span>
  static jlong unloaded_event_classes = 0;
  
  jlong JfrEventClasses::unloaded_event_classes_count() {
    return unloaded_event_classes;
  }
  
  void JfrEventClasses::increment_unloaded_event_class() {
<span class="line-modified">!   assert_locked_or_safepoint(ClassLoaderDataGraph_lock);</span>
    ++unloaded_event_classes;
  }
  
  static jobject empty_java_util_arraylist = NULL;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,11 ***</span>
    assert(event_subklasses.length() == 0, &quot;invariant&quot;);
    assert(event_klass != NULL, &quot;invariant&quot;);
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(thread));
  
    Stack&lt;const Klass*, mtTracing&gt; mark_stack;
<span class="line-modified">!   MutexLocker ml(Compile_lock, thread);</span>
    mark_stack.push(event_klass-&gt;subklass());
  
    while (!mark_stack.is_empty()) {
      const Klass* const current = mark_stack.pop();
      assert(current != NULL, &quot;null element in stack!&quot;);
<span class="line-new-header">--- 86,11 ---</span>
    assert(event_subklasses.length() == 0, &quot;invariant&quot;);
    assert(event_klass != NULL, &quot;invariant&quot;);
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(thread));
  
    Stack&lt;const Klass*, mtTracing&gt; mark_stack;
<span class="line-modified">!   MutexLocker ml(thread, Compile_lock);</span>
    mark_stack.push(event_klass-&gt;subklass());
  
    while (!mark_stack.is_empty()) {
      const Klass* const current = mark_stack.pop();
      assert(current != NULL, &quot;null element in stack!&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,12 ***</span>
  jobject JfrEventClasses::get_all_event_classes(TRAPS) {
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(THREAD));
    initialize(THREAD);
    assert(empty_java_util_arraylist != NULL, &quot;should have been setup already!&quot;);
    static const char jdk_jfr_event_name[] = &quot;jdk/internal/event/Event&quot;;
<span class="line-modified">!   unsigned int unused_hash = 0;</span>
<span class="line-removed">-   Symbol* const event_klass_name = SymbolTable::lookup_only(jdk_jfr_event_name, sizeof jdk_jfr_event_name - 1, unused_hash);</span>
  
    if (NULL == event_klass_name) {
      // not loaded yet
      return empty_java_util_arraylist;
    }
<span class="line-new-header">--- 130,11 ---</span>
  jobject JfrEventClasses::get_all_event_classes(TRAPS) {
    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(THREAD));
    initialize(THREAD);
    assert(empty_java_util_arraylist != NULL, &quot;should have been setup already!&quot;);
    static const char jdk_jfr_event_name[] = &quot;jdk/internal/event/Event&quot;;
<span class="line-modified">!   Symbol* const event_klass_name = SymbolTable::probe(jdk_jfr_event_name, sizeof jdk_jfr_event_name - 1);</span>
  
    if (NULL == event_klass_name) {
      // not loaded yet
      return empty_java_util_arraylist;
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,14 ***</span>
    static const char add_method_name[] = &quot;add&quot;;
    static const char add_method_signature[] = &quot;(Ljava/lang/Object;)Z&quot;;
    const Klass* const array_list_klass = JfrJavaSupport::klass(empty_java_util_arraylist);
    assert(array_list_klass != NULL, &quot;invariant&quot;);
  
<span class="line-modified">!   const Symbol* const add_method_sym = SymbolTable::lookup(add_method_name, sizeof add_method_name - 1, THREAD);</span>
    assert(add_method_sym != NULL, &quot;invariant&quot;);
  
<span class="line-modified">!   const Symbol* const add_method_sig_sym = SymbolTable::lookup(add_method_signature, sizeof add_method_signature - 1, THREAD);</span>
    assert(add_method_signature != NULL, &quot;invariant&quot;);
  
    JavaValue result(T_BOOLEAN);
    for (int i = 0; i &lt; event_subklasses.length(); ++i) {
      const jclass clazz = (const jclass)event_subklasses.at(i);
<span class="line-new-header">--- 163,14 ---</span>
    static const char add_method_name[] = &quot;add&quot;;
    static const char add_method_signature[] = &quot;(Ljava/lang/Object;)Z&quot;;
    const Klass* const array_list_klass = JfrJavaSupport::klass(empty_java_util_arraylist);
    assert(array_list_klass != NULL, &quot;invariant&quot;);
  
<span class="line-modified">!   const Symbol* const add_method_sym = SymbolTable::new_symbol(add_method_name);</span>
    assert(add_method_sym != NULL, &quot;invariant&quot;);
  
<span class="line-modified">!   const Symbol* const add_method_sig_sym = SymbolTable::new_symbol(add_method_signature);</span>
    assert(add_method_signature != NULL, &quot;invariant&quot;);
  
    JavaValue result(T_BOOLEAN);
    for (int i = 0; i &lt; event_subklasses.length(); ++i) {
      const jclass clazz = (const jclass)event_subklasses.at(i);
</pre>
<center><a href="../jfr.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jfrJavaCall.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>