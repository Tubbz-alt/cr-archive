<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/services/memReporter.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="memBaseline.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memTracker.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/memReporter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,10 +24,11 @@</span>
  #include &quot;precompiled.hpp&quot;
  
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;services/mallocTracker.hpp&quot;
  #include &quot;services/memReporter.hpp&quot;
<span class="udiff-line-added">+ #include &quot;services/threadStackTracker.hpp&quot;</span>
  #include &quot;services/virtualMemoryTracker.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  
  size_t MemReporterBase::reserved_total(const MallocMemory* malloc, const VirtualMemory* vm) const {
    return malloc-&gt;malloc_size() + malloc-&gt;arena_size() + vm-&gt;reserved();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -44,15 +45,17 @@</span>
  }
  
  void MemReporterBase::print_malloc(size_t amount, size_t count, MEMFLAGS flag) const {
    const char* scale = current_scale();
    outputStream* out = output();
<span class="udiff-line-added">+   const char* alloc_type = (flag == mtThreadStack) ? &quot;&quot; : &quot;malloc=&quot;;</span>
<span class="udiff-line-added">+ </span>
    if (flag != mtNone) {
<span class="udiff-line-modified-removed">-     out-&gt;print(&quot;(malloc=&quot; SIZE_FORMAT &quot;%s type=%s&quot;,</span>
<span class="udiff-line-modified-added">+     out-&gt;print(&quot;(%s&quot; SIZE_FORMAT &quot;%s type=%s&quot;, alloc_type,</span>
        amount_in_current_scale(amount), scale, NMTUtil::flag_to_name(flag));
    } else {
<span class="udiff-line-modified-removed">-     out-&gt;print(&quot;(malloc=&quot; SIZE_FORMAT &quot;%s&quot;,</span>
<span class="udiff-line-modified-added">+     out-&gt;print(&quot;(%s&quot; SIZE_FORMAT &quot;%s&quot;, alloc_type,</span>
        amount_in_current_scale(amount), scale);
    }
  
    if (count &gt; 0) {
      out-&gt;print(&quot; #&quot; SIZE_FORMAT &quot;&quot;, count);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,14 +127,21 @@</span>
    size_t reserved_amount  = reserved_total (malloc_memory, virtual_memory);
    size_t committed_amount = committed_total(malloc_memory, virtual_memory);
  
    // Count thread&#39;s native stack in &quot;Thread&quot; category
    if (flag == mtThread) {
<span class="udiff-line-modified-removed">-     const VirtualMemory* thread_stack_usage =</span>
<span class="udiff-line-modified-removed">-       (const VirtualMemory*)_vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-modified-removed">-     reserved_amount  += thread_stack_usage-&gt;reserved();</span>
<span class="udiff-line-modified-removed">-     committed_amount += thread_stack_usage-&gt;committed();</span>
<span class="udiff-line-modified-added">+     if (ThreadStackTracker::track_as_vm()) {</span>
<span class="udiff-line-modified-added">+       const VirtualMemory* thread_stack_usage =</span>
<span class="udiff-line-modified-added">+         (const VirtualMemory*)_vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-modified-added">+       reserved_amount  += thread_stack_usage-&gt;reserved();</span>
<span class="udiff-line-added">+       committed_amount += thread_stack_usage-&gt;committed();</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+       const MallocMemory* thread_stack_usage =</span>
<span class="udiff-line-added">+         (const MallocMemory*)_malloc_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-added">+       reserved_amount += thread_stack_usage-&gt;malloc_size();</span>
<span class="udiff-line-added">+       committed_amount += thread_stack_usage-&gt;malloc_size();</span>
<span class="udiff-line-added">+     }</span>
    } else if (flag == mtNMT) {
      // Count malloc headers in &quot;NMT&quot; category
      reserved_amount  += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
      committed_amount += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -148,16 +158,26 @@</span>
        out-&gt;print_cr(&quot;%27s (classes #&quot; SIZE_FORMAT &quot;)&quot;,
          &quot; &quot;, (_instance_class_count + _array_class_count));
        out-&gt;print_cr(&quot;%27s (  instance classes #&quot; SIZE_FORMAT &quot;, array classes #&quot; SIZE_FORMAT &quot;)&quot;,
          &quot; &quot;, _instance_class_count, _array_class_count);
      } else if (flag == mtThread) {
<span class="udiff-line-modified-removed">-       // report thread count</span>
<span class="udiff-line-modified-removed">-       out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, _malloc_snapshot-&gt;thread_count());</span>
<span class="udiff-line-modified-removed">-       const VirtualMemory* thread_stack_usage =</span>
<span class="udiff-line-modified-removed">-        _vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-modified-removed">-       out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);</span>
<span class="udiff-line-modified-removed">-       print_total(thread_stack_usage-&gt;reserved(), thread_stack_usage-&gt;committed());</span>
<span class="udiff-line-modified-added">+       if (ThreadStackTracker::track_as_vm()) {</span>
<span class="udiff-line-modified-added">+         const VirtualMemory* thread_stack_usage =</span>
<span class="udiff-line-modified-added">+          _vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-modified-added">+         // report thread count</span>
<span class="udiff-line-modified-added">+         out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, ThreadStackTracker::thread_count());</span>
<span class="udiff-line-modified-added">+         out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);</span>
<span class="udiff-line-added">+         print_total(thread_stack_usage-&gt;reserved(), thread_stack_usage-&gt;committed());</span>
<span class="udiff-line-added">+       } else {</span>
<span class="udiff-line-added">+         MallocMemory* thread_stack_memory = _malloc_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="udiff-line-added">+         const char* scale = current_scale();</span>
<span class="udiff-line-added">+         // report thread count</span>
<span class="udiff-line-added">+         assert(ThreadStackTracker::thread_count() == 0, &quot;Not used&quot;);</span>
<span class="udiff-line-added">+         out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, thread_stack_memory-&gt;malloc_count());</span>
<span class="udiff-line-added">+         out-&gt;print(&quot;%27s (Stack: &quot; SIZE_FORMAT &quot;%s&quot;, &quot; &quot;,</span>
<span class="udiff-line-added">+           amount_in_current_scale(thread_stack_memory-&gt;malloc_size()), scale);</span>
<span class="udiff-line-added">+       }</span>
        out-&gt;print_cr(&quot;)&quot;);
      }
  
       // report malloc&#39;d memory
      if (amount_in_current_scale(malloc_memory-&gt;malloc_size()) &gt; 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -366,14 +386,15 @@</span>
  
  void MemSummaryDiffReporter::print_malloc_diff(size_t current_amount, size_t current_count,
      size_t early_amount, size_t early_count, MEMFLAGS flags) const {
    const char* scale = current_scale();
    outputStream* out = output();
<span class="udiff-line-added">+   const char* alloc_type = (flags == mtThread) ? &quot;&quot; : &quot;malloc=&quot;;</span>
  
<span class="udiff-line-modified-removed">-   out-&gt;print(&quot;malloc=&quot; SIZE_FORMAT &quot;%s&quot;, amount_in_current_scale(current_amount), scale);</span>
<span class="udiff-line-modified-removed">-   // Report type only if it is valid</span>
<span class="udiff-line-modified-removed">-   if (flags != mtNone) {</span>
<span class="udiff-line-modified-added">+   out-&gt;print(&quot;%s&quot; SIZE_FORMAT &quot;%s&quot;, alloc_type, amount_in_current_scale(current_amount), scale);</span>
<span class="udiff-line-modified-added">+   // Report type only if it is valid and not under &quot;thread&quot; category</span>
<span class="udiff-line-modified-added">+   if (flags != mtNone &amp;&amp; flags != mtThread) {</span>
      out-&gt;print(&quot; type=%s&quot;, NMTUtil::flag_to_name(flags));
    }
  
    long amount_diff = diff_in_current_scale(current_amount, early_amount);
    if (amount_diff != 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -495,19 +516,29 @@</span>
        if (thread_count_diff != 0) {
          out-&gt;print(&quot; %+d&quot;, thread_count_diff);
        }
        out-&gt;print_cr(&quot;)&quot;);
  
<span class="udiff-line-removed">-       // report thread stack</span>
<span class="udiff-line-removed">-       const VirtualMemory* current_thread_stack =</span>
<span class="udiff-line-removed">-           _current_baseline.virtual_memory(mtThreadStack);</span>
<span class="udiff-line-removed">-       const VirtualMemory* early_thread_stack =</span>
<span class="udiff-line-removed">-         _early_baseline.virtual_memory(mtThreadStack);</span>
<span class="udiff-line-removed">- </span>
        out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);
<span class="udiff-line-modified-removed">-       print_virtual_memory_diff(current_thread_stack-&gt;reserved(), current_thread_stack-&gt;committed(),</span>
<span class="udiff-line-modified-removed">-         early_thread_stack-&gt;reserved(), early_thread_stack-&gt;committed());</span>
<span class="udiff-line-modified-added">+       if (ThreadStackTracker::track_as_vm()) {</span>
<span class="udiff-line-modified-added">+         // report thread stack</span>
<span class="udiff-line-added">+         const VirtualMemory* current_thread_stack =</span>
<span class="udiff-line-added">+           _current_baseline.virtual_memory(mtThreadStack);</span>
<span class="udiff-line-added">+         const VirtualMemory* early_thread_stack =</span>
<span class="udiff-line-added">+           _early_baseline.virtual_memory(mtThreadStack);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         print_virtual_memory_diff(current_thread_stack-&gt;reserved(), current_thread_stack-&gt;committed(),</span>
<span class="udiff-line-added">+           early_thread_stack-&gt;reserved(), early_thread_stack-&gt;committed());</span>
<span class="udiff-line-added">+       } else {</span>
<span class="udiff-line-added">+         const MallocMemory* current_thread_stack =</span>
<span class="udiff-line-added">+           _current_baseline.malloc_memory(mtThreadStack);</span>
<span class="udiff-line-added">+         const MallocMemory* early_thread_stack =</span>
<span class="udiff-line-added">+           _early_baseline.malloc_memory(mtThreadStack);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         print_malloc_diff(current_thread_stack-&gt;malloc_size(), current_thread_stack-&gt;malloc_count(),</span>
<span class="udiff-line-added">+           early_thread_stack-&gt;malloc_size(), early_thread_stack-&gt;malloc_count(), flag);</span>
<span class="udiff-line-added">+       }</span>
        out-&gt;print_cr(&quot;)&quot;);
      }
  
      // Report malloc&#39;d memory
      size_t current_malloc_amount = current_malloc-&gt;malloc_size();
</pre>
<center><a href="memBaseline.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memTracker.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>