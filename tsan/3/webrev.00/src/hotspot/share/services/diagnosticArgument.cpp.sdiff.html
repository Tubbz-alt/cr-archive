<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/services/diagnosticArgument.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classLoadingService.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="diagnosticCommand.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/diagnosticArgument.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;memory/allocation.inline.hpp&quot;
 28 #include &quot;memory/resourceArea.hpp&quot;
 29 #include &quot;runtime/thread.hpp&quot;
 30 #include &quot;services/diagnosticArgument.hpp&quot;
 31 
 32 StringArrayArgument::StringArrayArgument() {
 33   _array = new(ResourceObj::C_HEAP, mtInternal)GrowableArray&lt;char *&gt;(32, true);
 34   assert(_array != NULL, &quot;Sanity check&quot;);
 35 }
 36 
 37 StringArrayArgument::~StringArrayArgument() {
 38   for (int i=0; i&lt;_array-&gt;length(); i++) {
<span class="line-modified"> 39     if(_array-&gt;at(i) != NULL) { // Safety check</span>
<span class="line-removed"> 40       FREE_C_HEAP_ARRAY(char, _array-&gt;at(i));</span>
<span class="line-removed"> 41     }</span>
 42   }
 43   delete _array;
 44 }
 45 
 46 void StringArrayArgument::add(const char* str, size_t len) {
 47   if (str != NULL) {
 48     char* ptr = NEW_C_HEAP_ARRAY(char, len+1, mtInternal);
 49     strncpy(ptr, str, len);
 50     ptr[len] = 0;
 51     _array-&gt;append(ptr);
 52   }
 53 }
 54 
 55 void GenDCmdArgument::read_value(const char* str, size_t len, TRAPS) {
 56   /* NOTE:Some argument types doesn&#39;t require a value,
 57    * for instance boolean arguments: &quot;enableFeatureX&quot;. is
 58    * equivalent to &quot;enableFeatureX=true&quot;. In these cases,
 59    * str will be null. This is perfectly valid.
 60    * All argument types must perform null checks on str.
 61    */
</pre>
<hr />
<pre>
136     set_value(0);
137   }
138 }
139 
140 template &lt;&gt; void DCmdArgument&lt;jlong&gt;::destroy_value() { }
141 
142 template &lt;&gt; void DCmdArgument&lt;bool&gt;::parse_value(const char* str,
143                                                  size_t len, TRAPS) {
144   // len is the length of the current token starting at str
145   if (len == 0) {
146     set_value(true);
147   } else {
148     if (len == strlen(&quot;true&quot;) &amp;&amp; strncasecmp(str, &quot;true&quot;, len) == 0) {
149        set_value(true);
150     } else if (len == strlen(&quot;false&quot;) &amp;&amp; strncasecmp(str, &quot;false&quot;, len) == 0) {
151        set_value(false);
152     } else {
153       ResourceMark rm;
154 
155       char* buf = NEW_RESOURCE_ARRAY(char, len + 1);




156       strncpy(buf, str, len);


157       buf[len] = &#39;\0&#39;;
158       Exceptions::fthrow(THREAD_AND_LOCATION, vmSymbols::java_lang_IllegalArgumentException(),
159         &quot;Boolean parsing error in command argument &#39;%s&#39;. Could not parse: %s.\n&quot;, _name, buf);
160     }
161   }
162 }
163 
164 template &lt;&gt; void DCmdArgument&lt;bool&gt;::init_value(TRAPS) {
165   if (has_default()) {
166     this-&gt;parse_value(_default_string, strlen(_default_string), THREAD);
167     if (HAS_PENDING_EXCEPTION) {
168       fatal(&quot;Default string must be parsable&quot;);
169     }
170   } else {
171     set_value(false);
172   }
173 }
174 
175 template &lt;&gt; void DCmdArgument&lt;bool&gt;::destroy_value() { }
176 
</pre>
<hr />
<pre>
180     _value = NULL;
181   } else {
182     _value = NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);
183     int n = os::snprintf(_value, len + 1, &quot;%.*s&quot;, (int)len, str);
184     assert((size_t)n &lt;= len, &quot;Unexpected number of characters in string&quot;);
185   }
186 }
187 
188 template &lt;&gt; void DCmdArgument&lt;char*&gt;::init_value(TRAPS) {
189   if (has_default() &amp;&amp; _default_string != NULL) {
190     this-&gt;parse_value(_default_string, strlen(_default_string), THREAD);
191     if (HAS_PENDING_EXCEPTION) {
192      fatal(&quot;Default string must be parsable&quot;);
193     }
194   } else {
195     set_value(NULL);
196   }
197 }
198 
199 template &lt;&gt; void DCmdArgument&lt;char*&gt;::destroy_value() {
<span class="line-modified">200   if (_value != NULL) {</span>
<span class="line-modified">201     FREE_C_HEAP_ARRAY(char, _value);</span>
<span class="line-removed">202     set_value(NULL);</span>
<span class="line-removed">203   }</span>
204 }
205 
206 template &lt;&gt; void DCmdArgument&lt;NanoTimeArgument&gt;::parse_value(const char* str,
207                                                  size_t len, TRAPS) {
208   if (str == NULL) {
209     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(),
210               &quot;Integer parsing error nanotime value: syntax error, value is null\n&quot;);
211   }
212 
213   int argc = sscanf(str, JLONG_FORMAT, &amp;_value._time);
214   if (argc != 1) {
215     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(),
216               &quot;Integer parsing error nanotime value: syntax error\n&quot;);
217   }
218   size_t idx = 0;
219   while(idx &lt; len &amp;&amp; isdigit(str[idx])) {
220     idx++;
221   }
222   if (idx == len) {
223     // only accept missing unit if the value is 0
</pre>
</td>
<td>
<hr />
<pre>
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;memory/allocation.inline.hpp&quot;
 28 #include &quot;memory/resourceArea.hpp&quot;
 29 #include &quot;runtime/thread.hpp&quot;
 30 #include &quot;services/diagnosticArgument.hpp&quot;
 31 
 32 StringArrayArgument::StringArrayArgument() {
 33   _array = new(ResourceObj::C_HEAP, mtInternal)GrowableArray&lt;char *&gt;(32, true);
 34   assert(_array != NULL, &quot;Sanity check&quot;);
 35 }
 36 
 37 StringArrayArgument::~StringArrayArgument() {
 38   for (int i=0; i&lt;_array-&gt;length(); i++) {
<span class="line-modified"> 39     FREE_C_HEAP_ARRAY(char, _array-&gt;at(i));</span>


 40   }
 41   delete _array;
 42 }
 43 
 44 void StringArrayArgument::add(const char* str, size_t len) {
 45   if (str != NULL) {
 46     char* ptr = NEW_C_HEAP_ARRAY(char, len+1, mtInternal);
 47     strncpy(ptr, str, len);
 48     ptr[len] = 0;
 49     _array-&gt;append(ptr);
 50   }
 51 }
 52 
 53 void GenDCmdArgument::read_value(const char* str, size_t len, TRAPS) {
 54   /* NOTE:Some argument types doesn&#39;t require a value,
 55    * for instance boolean arguments: &quot;enableFeatureX&quot;. is
 56    * equivalent to &quot;enableFeatureX=true&quot;. In these cases,
 57    * str will be null. This is perfectly valid.
 58    * All argument types must perform null checks on str.
 59    */
</pre>
<hr />
<pre>
134     set_value(0);
135   }
136 }
137 
138 template &lt;&gt; void DCmdArgument&lt;jlong&gt;::destroy_value() { }
139 
140 template &lt;&gt; void DCmdArgument&lt;bool&gt;::parse_value(const char* str,
141                                                  size_t len, TRAPS) {
142   // len is the length of the current token starting at str
143   if (len == 0) {
144     set_value(true);
145   } else {
146     if (len == strlen(&quot;true&quot;) &amp;&amp; strncasecmp(str, &quot;true&quot;, len) == 0) {
147        set_value(true);
148     } else if (len == strlen(&quot;false&quot;) &amp;&amp; strncasecmp(str, &quot;false&quot;, len) == 0) {
149        set_value(false);
150     } else {
151       ResourceMark rm;
152 
153       char* buf = NEW_RESOURCE_ARRAY(char, len + 1);
<span class="line-added">154 </span>
<span class="line-added">155 PRAGMA_DIAG_PUSH</span>
<span class="line-added">156 PRAGMA_STRINGOP_TRUNCATION_IGNORED</span>
<span class="line-added">157       // This code can incorrectly cause a &quot;stringop-truncation&quot; warning with gcc</span>
158       strncpy(buf, str, len);
<span class="line-added">159 PRAGMA_DIAG_POP</span>
<span class="line-added">160 </span>
161       buf[len] = &#39;\0&#39;;
162       Exceptions::fthrow(THREAD_AND_LOCATION, vmSymbols::java_lang_IllegalArgumentException(),
163         &quot;Boolean parsing error in command argument &#39;%s&#39;. Could not parse: %s.\n&quot;, _name, buf);
164     }
165   }
166 }
167 
168 template &lt;&gt; void DCmdArgument&lt;bool&gt;::init_value(TRAPS) {
169   if (has_default()) {
170     this-&gt;parse_value(_default_string, strlen(_default_string), THREAD);
171     if (HAS_PENDING_EXCEPTION) {
172       fatal(&quot;Default string must be parsable&quot;);
173     }
174   } else {
175     set_value(false);
176   }
177 }
178 
179 template &lt;&gt; void DCmdArgument&lt;bool&gt;::destroy_value() { }
180 
</pre>
<hr />
<pre>
184     _value = NULL;
185   } else {
186     _value = NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);
187     int n = os::snprintf(_value, len + 1, &quot;%.*s&quot;, (int)len, str);
188     assert((size_t)n &lt;= len, &quot;Unexpected number of characters in string&quot;);
189   }
190 }
191 
192 template &lt;&gt; void DCmdArgument&lt;char*&gt;::init_value(TRAPS) {
193   if (has_default() &amp;&amp; _default_string != NULL) {
194     this-&gt;parse_value(_default_string, strlen(_default_string), THREAD);
195     if (HAS_PENDING_EXCEPTION) {
196      fatal(&quot;Default string must be parsable&quot;);
197     }
198   } else {
199     set_value(NULL);
200   }
201 }
202 
203 template &lt;&gt; void DCmdArgument&lt;char*&gt;::destroy_value() {
<span class="line-modified">204   FREE_C_HEAP_ARRAY(char, _value);</span>
<span class="line-modified">205   set_value(NULL);</span>


206 }
207 
208 template &lt;&gt; void DCmdArgument&lt;NanoTimeArgument&gt;::parse_value(const char* str,
209                                                  size_t len, TRAPS) {
210   if (str == NULL) {
211     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(),
212               &quot;Integer parsing error nanotime value: syntax error, value is null\n&quot;);
213   }
214 
215   int argc = sscanf(str, JLONG_FORMAT, &amp;_value._time);
216   if (argc != 1) {
217     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(),
218               &quot;Integer parsing error nanotime value: syntax error\n&quot;);
219   }
220   size_t idx = 0;
221   while(idx &lt; len &amp;&amp; isdigit(str[idx])) {
222     idx++;
223   }
224   if (idx == len) {
225     // only accept missing unit if the value is 0
</pre>
</td>
</tr>
</table>
<center><a href="classLoadingService.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="diagnosticCommand.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>