<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/services/memReporter.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="memBaseline.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memTracker.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/memReporter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 #include &quot;precompiled.hpp&quot;
 25 
 26 #include &quot;memory/allocation.hpp&quot;
 27 #include &quot;services/mallocTracker.hpp&quot;
 28 #include &quot;services/memReporter.hpp&quot;

 29 #include &quot;services/virtualMemoryTracker.hpp&quot;
 30 #include &quot;utilities/globalDefinitions.hpp&quot;
 31 
 32 size_t MemReporterBase::reserved_total(const MallocMemory* malloc, const VirtualMemory* vm) const {
 33   return malloc-&gt;malloc_size() + malloc-&gt;arena_size() + vm-&gt;reserved();
 34 }
 35 
 36 size_t MemReporterBase::committed_total(const MallocMemory* malloc, const VirtualMemory* vm) const {
 37   return malloc-&gt;malloc_size() + malloc-&gt;arena_size() + vm-&gt;committed();
 38 }
 39 
 40 void MemReporterBase::print_total(size_t reserved, size_t committed) const {
 41   const char* scale = current_scale();
 42   output()-&gt;print(&quot;reserved=&quot; SIZE_FORMAT &quot;%s, committed=&quot; SIZE_FORMAT &quot;%s&quot;,
 43     amount_in_current_scale(reserved), scale, amount_in_current_scale(committed), scale);
 44 }
 45 
 46 void MemReporterBase::print_malloc(size_t amount, size_t count, MEMFLAGS flag) const {
 47   const char* scale = current_scale();
 48   outputStream* out = output();


 49   if (flag != mtNone) {
<span class="line-modified"> 50     out-&gt;print(&quot;(malloc=&quot; SIZE_FORMAT &quot;%s type=%s&quot;,</span>
 51       amount_in_current_scale(amount), scale, NMTUtil::flag_to_name(flag));
 52   } else {
<span class="line-modified"> 53     out-&gt;print(&quot;(malloc=&quot; SIZE_FORMAT &quot;%s&quot;,</span>
 54       amount_in_current_scale(amount), scale);
 55   }
 56 
 57   if (count &gt; 0) {
 58     out-&gt;print(&quot; #&quot; SIZE_FORMAT &quot;&quot;, count);
 59   }
 60 
 61   out-&gt;print(&quot;)&quot;);
 62 }
 63 
 64 void MemReporterBase::print_virtual_memory(size_t reserved, size_t committed) const {
 65   const char* scale = current_scale();
 66   output()-&gt;print(&quot;(mmap: reserved=&quot; SIZE_FORMAT &quot;%s, committed=&quot; SIZE_FORMAT &quot;%s)&quot;,
 67     amount_in_current_scale(reserved), scale, amount_in_current_scale(committed), scale);
 68 }
 69 
 70 void MemReporterBase::print_malloc_line(size_t amount, size_t count) const {
 71   output()-&gt;print(&quot;%28s&quot;, &quot; &quot;);
 72   print_malloc(amount, count);
 73   output()-&gt;print_cr(&quot; &quot;);
</pre>
<hr />
<pre>
109   // Summary by memory type
110   for (int index = 0; index &lt; mt_number_of_types; index ++) {
111     MEMFLAGS flag = NMTUtil::index_to_flag(index);
112     // thread stack is reported as part of thread category
113     if (flag == mtThreadStack) continue;
114     MallocMemory* malloc_memory = _malloc_snapshot-&gt;by_type(flag);
115     VirtualMemory* virtual_memory = _vm_snapshot-&gt;by_type(flag);
116 
117     report_summary_of_type(flag, malloc_memory, virtual_memory);
118   }
119 }
120 
121 void MemSummaryReporter::report_summary_of_type(MEMFLAGS flag,
122   MallocMemory*  malloc_memory, VirtualMemory* virtual_memory) {
123 
124   size_t reserved_amount  = reserved_total (malloc_memory, virtual_memory);
125   size_t committed_amount = committed_total(malloc_memory, virtual_memory);
126 
127   // Count thread&#39;s native stack in &quot;Thread&quot; category
128   if (flag == mtThread) {
<span class="line-modified">129     const VirtualMemory* thread_stack_usage =</span>
<span class="line-modified">130       (const VirtualMemory*)_vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-modified">131     reserved_amount  += thread_stack_usage-&gt;reserved();</span>
<span class="line-modified">132     committed_amount += thread_stack_usage-&gt;committed();</span>







133   } else if (flag == mtNMT) {
134     // Count malloc headers in &quot;NMT&quot; category
135     reserved_amount  += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
136     committed_amount += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
137   }
138 
139   if (amount_in_current_scale(reserved_amount) &gt; 0) {
140     outputStream* out   = output();
141     const char*   scale = current_scale();
142     out-&gt;print(&quot;-%26s (&quot;, NMTUtil::flag_to_name(flag));
143     print_total(reserved_amount, committed_amount);
144     out-&gt;print_cr(&quot;)&quot;);
145 
146     if (flag == mtClass) {
147       // report class count
148       out-&gt;print_cr(&quot;%27s (classes #&quot; SIZE_FORMAT &quot;)&quot;,
149         &quot; &quot;, (_instance_class_count + _array_class_count));
150       out-&gt;print_cr(&quot;%27s (  instance classes #&quot; SIZE_FORMAT &quot;, array classes #&quot; SIZE_FORMAT &quot;)&quot;,
151         &quot; &quot;, _instance_class_count, _array_class_count);
152     } else if (flag == mtThread) {
<span class="line-modified">153       // report thread count</span>
<span class="line-modified">154       out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, _malloc_snapshot-&gt;thread_count());</span>
<span class="line-modified">155       const VirtualMemory* thread_stack_usage =</span>
<span class="line-modified">156        _vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-modified">157       out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);</span>
<span class="line-modified">158       print_total(thread_stack_usage-&gt;reserved(), thread_stack_usage-&gt;committed());</span>










159       out-&gt;print_cr(&quot;)&quot;);
160     }
161 
162      // report malloc&#39;d memory
163     if (amount_in_current_scale(malloc_memory-&gt;malloc_size()) &gt; 0) {
164       // We don&#39;t know how many arena chunks are in used, so don&#39;t report the count
165       size_t count = (flag == mtChunk) ? 0 : malloc_memory-&gt;malloc_count();
166       print_malloc_line(malloc_memory-&gt;malloc_size(), count);
167     }
168 
169     if (amount_in_current_scale(virtual_memory-&gt;reserved()) &gt; 0) {
170       print_virtual_memory_line(virtual_memory-&gt;reserved(), virtual_memory-&gt;committed());
171     }
172 
173     if (amount_in_current_scale(malloc_memory-&gt;arena_size()) &gt; 0) {
174       print_arena_line(malloc_memory-&gt;arena_size(), malloc_memory-&gt;arena_count());
175     }
176 
177     if (flag == mtNMT &amp;&amp;
178       amount_in_current_scale(_malloc_snapshot-&gt;malloc_overhead()-&gt;size()) &gt; 0) {
</pre>
<hr />
<pre>
351 
352   // Summary diff by memory type
353   for (int index = 0; index &lt; mt_number_of_types; index ++) {
354     MEMFLAGS flag = NMTUtil::index_to_flag(index);
355     // thread stack is reported as part of thread category
356     if (flag == mtThreadStack) continue;
357     diff_summary_of_type(flag,
358       _early_baseline.malloc_memory(flag),
359       _early_baseline.virtual_memory(flag),
360       _early_baseline.metaspace_snapshot(),
361       _current_baseline.malloc_memory(flag),
362       _current_baseline.virtual_memory(flag),
363       _current_baseline.metaspace_snapshot());
364   }
365 }
366 
367 void MemSummaryDiffReporter::print_malloc_diff(size_t current_amount, size_t current_count,
368     size_t early_amount, size_t early_count, MEMFLAGS flags) const {
369   const char* scale = current_scale();
370   outputStream* out = output();

371 
<span class="line-modified">372   out-&gt;print(&quot;malloc=&quot; SIZE_FORMAT &quot;%s&quot;, amount_in_current_scale(current_amount), scale);</span>
<span class="line-modified">373   // Report type only if it is valid</span>
<span class="line-modified">374   if (flags != mtNone) {</span>
375     out-&gt;print(&quot; type=%s&quot;, NMTUtil::flag_to_name(flags));
376   }
377 
378   long amount_diff = diff_in_current_scale(current_amount, early_amount);
379   if (amount_diff != 0) {
380     out-&gt;print(&quot; %+ld%s&quot;, amount_diff, scale);
381   }
382   if (current_count &gt; 0) {
383     out-&gt;print(&quot; #&quot; SIZE_FORMAT &quot;&quot;, current_count);
384     if (current_count != early_count) {
385       out-&gt;print(&quot; %+d&quot;, (int)(current_count - early_count));
386     }
387   }
388 }
389 
390 void MemSummaryDiffReporter::print_arena_diff(size_t current_amount, size_t current_count,
391   size_t early_amount, size_t early_count) const {
392   const char* scale = current_scale();
393   outputStream* out = output();
394   out-&gt;print(&quot;arena=&quot; SIZE_FORMAT &quot;%s&quot;, amount_in_current_scale(current_amount), scale);
</pre>
<hr />
<pre>
480       out-&gt;print(&quot;%27s (  instance classes #&quot; SIZE_FORMAT, &quot; &quot;, _current_baseline.instance_class_count());
481       if (_current_baseline.instance_class_count() != _early_baseline.instance_class_count()) {
482         out-&gt;print(&quot; %+d&quot;, (int)(_current_baseline.instance_class_count() - _early_baseline.instance_class_count()));
483       }
484       out-&gt;print(&quot;, array classes #&quot; SIZE_FORMAT, _current_baseline.array_class_count());
485       if (_current_baseline.array_class_count() != _early_baseline.array_class_count()) {
486         out-&gt;print(&quot; %+d&quot;, (int)(_current_baseline.array_class_count() - _early_baseline.array_class_count()));
487       }
488       out-&gt;print_cr(&quot;)&quot;);
489 
490     } else if (flag == mtThread) {
491       // report thread count
492       out-&gt;print(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;&quot;, &quot; &quot;, _current_baseline.thread_count());
493       int thread_count_diff = (int)(_current_baseline.thread_count() -
494           _early_baseline.thread_count());
495       if (thread_count_diff != 0) {
496         out-&gt;print(&quot; %+d&quot;, thread_count_diff);
497       }
498       out-&gt;print_cr(&quot;)&quot;);
499 
<span class="line-removed">500       // report thread stack</span>
<span class="line-removed">501       const VirtualMemory* current_thread_stack =</span>
<span class="line-removed">502           _current_baseline.virtual_memory(mtThreadStack);</span>
<span class="line-removed">503       const VirtualMemory* early_thread_stack =</span>
<span class="line-removed">504         _early_baseline.virtual_memory(mtThreadStack);</span>
<span class="line-removed">505 </span>
506       out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);
<span class="line-modified">507       print_virtual_memory_diff(current_thread_stack-&gt;reserved(), current_thread_stack-&gt;committed(),</span>
<span class="line-modified">508         early_thread_stack-&gt;reserved(), early_thread_stack-&gt;committed());</span>
















509       out-&gt;print_cr(&quot;)&quot;);
510     }
511 
512     // Report malloc&#39;d memory
513     size_t current_malloc_amount = current_malloc-&gt;malloc_size();
514     size_t early_malloc_amount   = early_malloc-&gt;malloc_size();
515     if (amount_in_current_scale(current_malloc_amount) &gt; 0 ||
516         diff_in_current_scale(current_malloc_amount, early_malloc_amount) != 0) {
517       out-&gt;print(&quot;%28s(&quot;, &quot; &quot;);
518       print_malloc_diff(current_malloc_amount, (flag == mtChunk) ? 0 : current_malloc-&gt;malloc_count(),
519         early_malloc_amount, early_malloc-&gt;malloc_count(), mtNone);
520       out-&gt;print_cr(&quot;)&quot;);
521     }
522 
523     // Report virtual memory
524     if (amount_in_current_scale(current_vm-&gt;reserved()) &gt; 0 ||
525         diff_in_current_scale(current_vm-&gt;reserved(), early_vm-&gt;reserved()) != 0) {
526       out-&gt;print(&quot;%27s (mmap: &quot;, &quot; &quot;);
527       print_virtual_memory_diff(current_vm-&gt;reserved(), current_vm-&gt;committed(),
528         early_vm-&gt;reserved(), early_vm-&gt;committed());
</pre>
</td>
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 #include &quot;precompiled.hpp&quot;
 25 
 26 #include &quot;memory/allocation.hpp&quot;
 27 #include &quot;services/mallocTracker.hpp&quot;
 28 #include &quot;services/memReporter.hpp&quot;
<span class="line-added"> 29 #include &quot;services/threadStackTracker.hpp&quot;</span>
 30 #include &quot;services/virtualMemoryTracker.hpp&quot;
 31 #include &quot;utilities/globalDefinitions.hpp&quot;
 32 
 33 size_t MemReporterBase::reserved_total(const MallocMemory* malloc, const VirtualMemory* vm) const {
 34   return malloc-&gt;malloc_size() + malloc-&gt;arena_size() + vm-&gt;reserved();
 35 }
 36 
 37 size_t MemReporterBase::committed_total(const MallocMemory* malloc, const VirtualMemory* vm) const {
 38   return malloc-&gt;malloc_size() + malloc-&gt;arena_size() + vm-&gt;committed();
 39 }
 40 
 41 void MemReporterBase::print_total(size_t reserved, size_t committed) const {
 42   const char* scale = current_scale();
 43   output()-&gt;print(&quot;reserved=&quot; SIZE_FORMAT &quot;%s, committed=&quot; SIZE_FORMAT &quot;%s&quot;,
 44     amount_in_current_scale(reserved), scale, amount_in_current_scale(committed), scale);
 45 }
 46 
 47 void MemReporterBase::print_malloc(size_t amount, size_t count, MEMFLAGS flag) const {
 48   const char* scale = current_scale();
 49   outputStream* out = output();
<span class="line-added"> 50   const char* alloc_type = (flag == mtThreadStack) ? &quot;&quot; : &quot;malloc=&quot;;</span>
<span class="line-added"> 51 </span>
 52   if (flag != mtNone) {
<span class="line-modified"> 53     out-&gt;print(&quot;(%s&quot; SIZE_FORMAT &quot;%s type=%s&quot;, alloc_type,</span>
 54       amount_in_current_scale(amount), scale, NMTUtil::flag_to_name(flag));
 55   } else {
<span class="line-modified"> 56     out-&gt;print(&quot;(%s&quot; SIZE_FORMAT &quot;%s&quot;, alloc_type,</span>
 57       amount_in_current_scale(amount), scale);
 58   }
 59 
 60   if (count &gt; 0) {
 61     out-&gt;print(&quot; #&quot; SIZE_FORMAT &quot;&quot;, count);
 62   }
 63 
 64   out-&gt;print(&quot;)&quot;);
 65 }
 66 
 67 void MemReporterBase::print_virtual_memory(size_t reserved, size_t committed) const {
 68   const char* scale = current_scale();
 69   output()-&gt;print(&quot;(mmap: reserved=&quot; SIZE_FORMAT &quot;%s, committed=&quot; SIZE_FORMAT &quot;%s)&quot;,
 70     amount_in_current_scale(reserved), scale, amount_in_current_scale(committed), scale);
 71 }
 72 
 73 void MemReporterBase::print_malloc_line(size_t amount, size_t count) const {
 74   output()-&gt;print(&quot;%28s&quot;, &quot; &quot;);
 75   print_malloc(amount, count);
 76   output()-&gt;print_cr(&quot; &quot;);
</pre>
<hr />
<pre>
112   // Summary by memory type
113   for (int index = 0; index &lt; mt_number_of_types; index ++) {
114     MEMFLAGS flag = NMTUtil::index_to_flag(index);
115     // thread stack is reported as part of thread category
116     if (flag == mtThreadStack) continue;
117     MallocMemory* malloc_memory = _malloc_snapshot-&gt;by_type(flag);
118     VirtualMemory* virtual_memory = _vm_snapshot-&gt;by_type(flag);
119 
120     report_summary_of_type(flag, malloc_memory, virtual_memory);
121   }
122 }
123 
124 void MemSummaryReporter::report_summary_of_type(MEMFLAGS flag,
125   MallocMemory*  malloc_memory, VirtualMemory* virtual_memory) {
126 
127   size_t reserved_amount  = reserved_total (malloc_memory, virtual_memory);
128   size_t committed_amount = committed_total(malloc_memory, virtual_memory);
129 
130   // Count thread&#39;s native stack in &quot;Thread&quot; category
131   if (flag == mtThread) {
<span class="line-modified">132     if (ThreadStackTracker::track_as_vm()) {</span>
<span class="line-modified">133       const VirtualMemory* thread_stack_usage =</span>
<span class="line-modified">134         (const VirtualMemory*)_vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-modified">135       reserved_amount  += thread_stack_usage-&gt;reserved();</span>
<span class="line-added">136       committed_amount += thread_stack_usage-&gt;committed();</span>
<span class="line-added">137     } else {</span>
<span class="line-added">138       const MallocMemory* thread_stack_usage =</span>
<span class="line-added">139         (const MallocMemory*)_malloc_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-added">140       reserved_amount += thread_stack_usage-&gt;malloc_size();</span>
<span class="line-added">141       committed_amount += thread_stack_usage-&gt;malloc_size();</span>
<span class="line-added">142     }</span>
143   } else if (flag == mtNMT) {
144     // Count malloc headers in &quot;NMT&quot; category
145     reserved_amount  += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
146     committed_amount += _malloc_snapshot-&gt;malloc_overhead()-&gt;size();
147   }
148 
149   if (amount_in_current_scale(reserved_amount) &gt; 0) {
150     outputStream* out   = output();
151     const char*   scale = current_scale();
152     out-&gt;print(&quot;-%26s (&quot;, NMTUtil::flag_to_name(flag));
153     print_total(reserved_amount, committed_amount);
154     out-&gt;print_cr(&quot;)&quot;);
155 
156     if (flag == mtClass) {
157       // report class count
158       out-&gt;print_cr(&quot;%27s (classes #&quot; SIZE_FORMAT &quot;)&quot;,
159         &quot; &quot;, (_instance_class_count + _array_class_count));
160       out-&gt;print_cr(&quot;%27s (  instance classes #&quot; SIZE_FORMAT &quot;, array classes #&quot; SIZE_FORMAT &quot;)&quot;,
161         &quot; &quot;, _instance_class_count, _array_class_count);
162     } else if (flag == mtThread) {
<span class="line-modified">163       if (ThreadStackTracker::track_as_vm()) {</span>
<span class="line-modified">164         const VirtualMemory* thread_stack_usage =</span>
<span class="line-modified">165          _vm_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-modified">166         // report thread count</span>
<span class="line-modified">167         out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, ThreadStackTracker::thread_count());</span>
<span class="line-modified">168         out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);</span>
<span class="line-added">169         print_total(thread_stack_usage-&gt;reserved(), thread_stack_usage-&gt;committed());</span>
<span class="line-added">170       } else {</span>
<span class="line-added">171         MallocMemory* thread_stack_memory = _malloc_snapshot-&gt;by_type(mtThreadStack);</span>
<span class="line-added">172         const char* scale = current_scale();</span>
<span class="line-added">173         // report thread count</span>
<span class="line-added">174         assert(ThreadStackTracker::thread_count() == 0, &quot;Not used&quot;);</span>
<span class="line-added">175         out-&gt;print_cr(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;)&quot;, &quot; &quot;, thread_stack_memory-&gt;malloc_count());</span>
<span class="line-added">176         out-&gt;print(&quot;%27s (Stack: &quot; SIZE_FORMAT &quot;%s&quot;, &quot; &quot;,</span>
<span class="line-added">177           amount_in_current_scale(thread_stack_memory-&gt;malloc_size()), scale);</span>
<span class="line-added">178       }</span>
179       out-&gt;print_cr(&quot;)&quot;);
180     }
181 
182      // report malloc&#39;d memory
183     if (amount_in_current_scale(malloc_memory-&gt;malloc_size()) &gt; 0) {
184       // We don&#39;t know how many arena chunks are in used, so don&#39;t report the count
185       size_t count = (flag == mtChunk) ? 0 : malloc_memory-&gt;malloc_count();
186       print_malloc_line(malloc_memory-&gt;malloc_size(), count);
187     }
188 
189     if (amount_in_current_scale(virtual_memory-&gt;reserved()) &gt; 0) {
190       print_virtual_memory_line(virtual_memory-&gt;reserved(), virtual_memory-&gt;committed());
191     }
192 
193     if (amount_in_current_scale(malloc_memory-&gt;arena_size()) &gt; 0) {
194       print_arena_line(malloc_memory-&gt;arena_size(), malloc_memory-&gt;arena_count());
195     }
196 
197     if (flag == mtNMT &amp;&amp;
198       amount_in_current_scale(_malloc_snapshot-&gt;malloc_overhead()-&gt;size()) &gt; 0) {
</pre>
<hr />
<pre>
371 
372   // Summary diff by memory type
373   for (int index = 0; index &lt; mt_number_of_types; index ++) {
374     MEMFLAGS flag = NMTUtil::index_to_flag(index);
375     // thread stack is reported as part of thread category
376     if (flag == mtThreadStack) continue;
377     diff_summary_of_type(flag,
378       _early_baseline.malloc_memory(flag),
379       _early_baseline.virtual_memory(flag),
380       _early_baseline.metaspace_snapshot(),
381       _current_baseline.malloc_memory(flag),
382       _current_baseline.virtual_memory(flag),
383       _current_baseline.metaspace_snapshot());
384   }
385 }
386 
387 void MemSummaryDiffReporter::print_malloc_diff(size_t current_amount, size_t current_count,
388     size_t early_amount, size_t early_count, MEMFLAGS flags) const {
389   const char* scale = current_scale();
390   outputStream* out = output();
<span class="line-added">391   const char* alloc_type = (flags == mtThread) ? &quot;&quot; : &quot;malloc=&quot;;</span>
392 
<span class="line-modified">393   out-&gt;print(&quot;%s&quot; SIZE_FORMAT &quot;%s&quot;, alloc_type, amount_in_current_scale(current_amount), scale);</span>
<span class="line-modified">394   // Report type only if it is valid and not under &quot;thread&quot; category</span>
<span class="line-modified">395   if (flags != mtNone &amp;&amp; flags != mtThread) {</span>
396     out-&gt;print(&quot; type=%s&quot;, NMTUtil::flag_to_name(flags));
397   }
398 
399   long amount_diff = diff_in_current_scale(current_amount, early_amount);
400   if (amount_diff != 0) {
401     out-&gt;print(&quot; %+ld%s&quot;, amount_diff, scale);
402   }
403   if (current_count &gt; 0) {
404     out-&gt;print(&quot; #&quot; SIZE_FORMAT &quot;&quot;, current_count);
405     if (current_count != early_count) {
406       out-&gt;print(&quot; %+d&quot;, (int)(current_count - early_count));
407     }
408   }
409 }
410 
411 void MemSummaryDiffReporter::print_arena_diff(size_t current_amount, size_t current_count,
412   size_t early_amount, size_t early_count) const {
413   const char* scale = current_scale();
414   outputStream* out = output();
415   out-&gt;print(&quot;arena=&quot; SIZE_FORMAT &quot;%s&quot;, amount_in_current_scale(current_amount), scale);
</pre>
<hr />
<pre>
501       out-&gt;print(&quot;%27s (  instance classes #&quot; SIZE_FORMAT, &quot; &quot;, _current_baseline.instance_class_count());
502       if (_current_baseline.instance_class_count() != _early_baseline.instance_class_count()) {
503         out-&gt;print(&quot; %+d&quot;, (int)(_current_baseline.instance_class_count() - _early_baseline.instance_class_count()));
504       }
505       out-&gt;print(&quot;, array classes #&quot; SIZE_FORMAT, _current_baseline.array_class_count());
506       if (_current_baseline.array_class_count() != _early_baseline.array_class_count()) {
507         out-&gt;print(&quot; %+d&quot;, (int)(_current_baseline.array_class_count() - _early_baseline.array_class_count()));
508       }
509       out-&gt;print_cr(&quot;)&quot;);
510 
511     } else if (flag == mtThread) {
512       // report thread count
513       out-&gt;print(&quot;%27s (thread #&quot; SIZE_FORMAT &quot;&quot;, &quot; &quot;, _current_baseline.thread_count());
514       int thread_count_diff = (int)(_current_baseline.thread_count() -
515           _early_baseline.thread_count());
516       if (thread_count_diff != 0) {
517         out-&gt;print(&quot; %+d&quot;, thread_count_diff);
518       }
519       out-&gt;print_cr(&quot;)&quot;);
520 






521       out-&gt;print(&quot;%27s (stack: &quot;, &quot; &quot;);
<span class="line-modified">522       if (ThreadStackTracker::track_as_vm()) {</span>
<span class="line-modified">523         // report thread stack</span>
<span class="line-added">524         const VirtualMemory* current_thread_stack =</span>
<span class="line-added">525           _current_baseline.virtual_memory(mtThreadStack);</span>
<span class="line-added">526         const VirtualMemory* early_thread_stack =</span>
<span class="line-added">527           _early_baseline.virtual_memory(mtThreadStack);</span>
<span class="line-added">528 </span>
<span class="line-added">529         print_virtual_memory_diff(current_thread_stack-&gt;reserved(), current_thread_stack-&gt;committed(),</span>
<span class="line-added">530           early_thread_stack-&gt;reserved(), early_thread_stack-&gt;committed());</span>
<span class="line-added">531       } else {</span>
<span class="line-added">532         const MallocMemory* current_thread_stack =</span>
<span class="line-added">533           _current_baseline.malloc_memory(mtThreadStack);</span>
<span class="line-added">534         const MallocMemory* early_thread_stack =</span>
<span class="line-added">535           _early_baseline.malloc_memory(mtThreadStack);</span>
<span class="line-added">536 </span>
<span class="line-added">537         print_malloc_diff(current_thread_stack-&gt;malloc_size(), current_thread_stack-&gt;malloc_count(),</span>
<span class="line-added">538           early_thread_stack-&gt;malloc_size(), early_thread_stack-&gt;malloc_count(), flag);</span>
<span class="line-added">539       }</span>
540       out-&gt;print_cr(&quot;)&quot;);
541     }
542 
543     // Report malloc&#39;d memory
544     size_t current_malloc_amount = current_malloc-&gt;malloc_size();
545     size_t early_malloc_amount   = early_malloc-&gt;malloc_size();
546     if (amount_in_current_scale(current_malloc_amount) &gt; 0 ||
547         diff_in_current_scale(current_malloc_amount, early_malloc_amount) != 0) {
548       out-&gt;print(&quot;%28s(&quot;, &quot; &quot;);
549       print_malloc_diff(current_malloc_amount, (flag == mtChunk) ? 0 : current_malloc-&gt;malloc_count(),
550         early_malloc_amount, early_malloc-&gt;malloc_count(), mtNone);
551       out-&gt;print_cr(&quot;)&quot;);
552     }
553 
554     // Report virtual memory
555     if (amount_in_current_scale(current_vm-&gt;reserved()) &gt; 0 ||
556         diff_in_current_scale(current_vm-&gt;reserved(), early_vm-&gt;reserved()) != 0) {
557       out-&gt;print(&quot;%27s (mmap: &quot;, &quot; &quot;);
558       print_virtual_memory_diff(current_vm-&gt;reserved(), current_vm-&gt;committed(),
559         early_vm-&gt;reserved(), early_vm-&gt;committed());
</pre>
</td>
</tr>
</table>
<center><a href="memBaseline.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memTracker.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>