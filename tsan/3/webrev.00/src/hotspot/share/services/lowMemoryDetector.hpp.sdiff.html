<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/services/lowMemoryDetector.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="lowMemoryDetector.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="mallocSiteTable.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/lowMemoryDetector.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_SERVICES_LOWMEMORYDETECTOR_HPP
 26 #define SHARE_SERVICES_LOWMEMORYDETECTOR_HPP
 27 
 28 #include &quot;memory/allocation.hpp&quot;

 29 #include &quot;services/memoryPool.hpp&quot;
 30 #include &quot;services/memoryService.hpp&quot;
 31 #include &quot;services/memoryUsage.hpp&quot;
 32 
 33 // Low Memory Detection Support
 34 // Two memory alarms in the JDK (we called them sensors).
 35 //   - Heap memory sensor
 36 //   - Non-heap memory sensor
 37 // When the VM detects if the memory usage of a memory pool has reached
 38 // or exceeded its threshold, it will trigger the sensor for the type
 39 // of the memory pool (heap or nonheap or both).
 40 //
 41 // If threshold == -1, no low memory detection is supported and
 42 // the threshold value is not allowed to be changed.
 43 // If threshold == 0, no low memory detection is performed for
 44 // that memory pool.  The threshold can be set to any non-negative
 45 // value.
 46 //
 47 // The default threshold of the Hotspot memory pools are:
 48 //   Eden space        -1
 49 //   Survivor space 1  -1
 50 //   Survivor space 2  -1
 51 //   Old generation    0
 52 //   Perm generation   0
 53 //   CodeCache         0
 54 //
 55 // For heap memory, detection will be performed when GC finishes
 56 // and also in the slow path allocation.
 57 // For Code cache, detection will be performed in the allocation
 58 // and deallocation.
 59 //
 60 // May need to deal with hysteresis effect.
 61 //
<span class="line-modified"> 62 // Memory detection code runs in the Service thread (serviceThread.hpp).</span>

 63 
 64 class OopClosure;
 65 class MemoryPool;
 66 
 67 class ThresholdSupport : public CHeapObj&lt;mtInternal&gt; {
 68  private:
 69   bool            _support_high_threshold;
 70   bool            _support_low_threshold;
 71   size_t          _high_threshold;
 72   size_t          _low_threshold;
 73  public:
 74   ThresholdSupport(bool support_high, bool support_low) {
 75     _support_high_threshold = support_high;
 76     _support_low_threshold = support_low;
 77     _high_threshold = 0;
 78     _low_threshold= 0;
 79   }
 80 
 81   size_t      high_threshold() const        { return _high_threshold; }
 82   size_t      low_threshold()  const        { return _low_threshold; }
</pre>
<hr />
<pre>
197   //  (1) the usage is crossing below the low threshold and
198   //      the sensor is currently on; or
199   //  (2) the usage is crossing below the low threshold and
200   //      the sensor will be on (i.e. sensor is currently off
201   //      and has pending trigger requests).
202   //
203   void set_counter_sensor_level(MemoryUsage usage, ThresholdSupport* counter_threshold);
204 
205   void process_pending_requests(TRAPS);
206   void oops_do(OopClosure* f);
207 
208 #ifndef PRODUCT
209   // printing on default output stream;
210   void print();
211 #endif // PRODUCT
212 };
213 
214 class LowMemoryDetector : public AllStatic {
215   friend class LowMemoryDetectorDisabler;
216   friend class ServiceThread;

217 private:
218   // true if any collected heap has low memory detection enabled
219   static volatile bool _enabled_for_collected_pools;
220   // &gt; 0 if temporary disabed
221   static volatile jint _disabled_count;
222 
223   static void check_memory_usage();
224   static bool has_pending_requests();
225   static bool temporary_disabled() { return _disabled_count &gt; 0; }
226   static void disable() { Atomic::inc(&amp;_disabled_count); }
227   static void enable() { Atomic::dec(&amp;_disabled_count); }
228   static void process_sensor_changes(TRAPS);
229 
230 public:
231   static void detect_low_memory();
232   static void detect_low_memory(MemoryPool* pool);
233   static void detect_after_gc_memory(MemoryPool* pool);
234 
235   static bool is_enabled(MemoryPool* pool) {
236     // low memory detection is enabled for collected memory pools
</pre>
</td>
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_SERVICES_LOWMEMORYDETECTOR_HPP
 26 #define SHARE_SERVICES_LOWMEMORYDETECTOR_HPP
 27 
 28 #include &quot;memory/allocation.hpp&quot;
<span class="line-added"> 29 #include &quot;runtime/atomic.hpp&quot;</span>
 30 #include &quot;services/memoryPool.hpp&quot;
 31 #include &quot;services/memoryService.hpp&quot;
 32 #include &quot;services/memoryUsage.hpp&quot;
 33 
 34 // Low Memory Detection Support
 35 // Two memory alarms in the JDK (we called them sensors).
 36 //   - Heap memory sensor
 37 //   - Non-heap memory sensor
 38 // When the VM detects if the memory usage of a memory pool has reached
 39 // or exceeded its threshold, it will trigger the sensor for the type
 40 // of the memory pool (heap or nonheap or both).
 41 //
 42 // If threshold == -1, no low memory detection is supported and
 43 // the threshold value is not allowed to be changed.
 44 // If threshold == 0, no low memory detection is performed for
 45 // that memory pool.  The threshold can be set to any non-negative
 46 // value.
 47 //
 48 // The default threshold of the Hotspot memory pools are:
 49 //   Eden space        -1
 50 //   Survivor space 1  -1
 51 //   Survivor space 2  -1
 52 //   Old generation    0
 53 //   Perm generation   0
 54 //   CodeCache         0
 55 //
 56 // For heap memory, detection will be performed when GC finishes
 57 // and also in the slow path allocation.
 58 // For Code cache, detection will be performed in the allocation
 59 // and deallocation.
 60 //
 61 // May need to deal with hysteresis effect.
 62 //
<span class="line-modified"> 63 // Memory detection code runs in the Notification thread or</span>
<span class="line-added"> 64 // ServiceThread depending on UseNotificationThread flag.</span>
 65 
 66 class OopClosure;
 67 class MemoryPool;
 68 
 69 class ThresholdSupport : public CHeapObj&lt;mtInternal&gt; {
 70  private:
 71   bool            _support_high_threshold;
 72   bool            _support_low_threshold;
 73   size_t          _high_threshold;
 74   size_t          _low_threshold;
 75  public:
 76   ThresholdSupport(bool support_high, bool support_low) {
 77     _support_high_threshold = support_high;
 78     _support_low_threshold = support_low;
 79     _high_threshold = 0;
 80     _low_threshold= 0;
 81   }
 82 
 83   size_t      high_threshold() const        { return _high_threshold; }
 84   size_t      low_threshold()  const        { return _low_threshold; }
</pre>
<hr />
<pre>
199   //  (1) the usage is crossing below the low threshold and
200   //      the sensor is currently on; or
201   //  (2) the usage is crossing below the low threshold and
202   //      the sensor will be on (i.e. sensor is currently off
203   //      and has pending trigger requests).
204   //
205   void set_counter_sensor_level(MemoryUsage usage, ThresholdSupport* counter_threshold);
206 
207   void process_pending_requests(TRAPS);
208   void oops_do(OopClosure* f);
209 
210 #ifndef PRODUCT
211   // printing on default output stream;
212   void print();
213 #endif // PRODUCT
214 };
215 
216 class LowMemoryDetector : public AllStatic {
217   friend class LowMemoryDetectorDisabler;
218   friend class ServiceThread;
<span class="line-added">219   friend class NotificationThread;</span>
220 private:
221   // true if any collected heap has low memory detection enabled
222   static volatile bool _enabled_for_collected_pools;
223   // &gt; 0 if temporary disabed
224   static volatile jint _disabled_count;
225 
226   static void check_memory_usage();
227   static bool has_pending_requests();
228   static bool temporary_disabled() { return _disabled_count &gt; 0; }
229   static void disable() { Atomic::inc(&amp;_disabled_count); }
230   static void enable() { Atomic::dec(&amp;_disabled_count); }
231   static void process_sensor_changes(TRAPS);
232 
233 public:
234   static void detect_low_memory();
235   static void detect_low_memory(MemoryPool* pool);
236   static void detect_after_gc_memory(MemoryPool* pool);
237 
238   static bool is_enabled(MemoryPool* pool) {
239     // low memory detection is enabled for collected memory pools
</pre>
</td>
</tr>
</table>
<center><a href="lowMemoryDetector.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="mallocSiteTable.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>