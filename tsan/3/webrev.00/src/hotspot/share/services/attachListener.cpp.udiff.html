<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/services/attachListener.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../runtime/vm_version.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="attachListener.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/attachListener.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,10 +25,11 @@</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/javaClasses.hpp&quot;
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;gc/shared/gcVMOperations.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;oops/typeArrayOop.inline.hpp&quot;
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;runtime/arguments.hpp&quot;
  #include &quot;runtime/flags/jvmFlag.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,11 +43,11 @@</span>
  #include &quot;services/heapDumper.hpp&quot;
  #include &quot;services/writeableFlags.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/formatBuffer.hpp&quot;
  
<span class="udiff-line-modified-removed">- volatile bool AttachListener::_initialized;</span>
<span class="udiff-line-modified-added">+ volatile AttachListenerState AttachListener::_state = AL_NOT_INITIALIZED;</span>
  
  // Implementation of &quot;properties&quot; command.
  //
  // Invokes VMSupport.serializePropertiesToByteArray to serialize
  // the system properties into a byte array.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -234,23 +235,11 @@</span>
  
      // Request a full GC before heap dump if live_objects_only = true
      // This helps reduces the amount of unreachable objects in the dump
      // and makes it easier to browse.
      HeapDumper dumper(live_objects_only /* request GC */);
<span class="udiff-line-modified-removed">-     int res = dumper.dump(op-&gt;arg(0));</span>
<span class="udiff-line-removed">-     if (res == 0) {</span>
<span class="udiff-line-removed">-       out-&gt;print_cr(&quot;Heap dump file created&quot;);</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-       // heap dump failed</span>
<span class="udiff-line-removed">-       ResourceMark rm;</span>
<span class="udiff-line-removed">-       char* error = dumper.error_as_C_string();</span>
<span class="udiff-line-removed">-       if (error == NULL) {</span>
<span class="udiff-line-removed">-         out-&gt;print_cr(&quot;Dump failed - reason unknown&quot;);</span>
<span class="udiff-line-removed">-       } else {</span>
<span class="udiff-line-removed">-         out-&gt;print_cr(&quot;%s&quot;, error);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     dumper.dump(op-&gt;arg(0), out);</span>
    }
    return JNI_OK;
  }
  
  // Implementation of &quot;inspectheap&quot; command
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -328,11 +317,11 @@</span>
    const char* name = NULL;
    if ((name = op-&gt;arg(0)) == NULL) {
      out-&gt;print_cr(&quot;flag name is missing&quot;);
      return JNI_ERR;
    }
<span class="udiff-line-modified-removed">-   JVMFlag* f = JVMFlag::find_flag((char*)name, strlen(name));</span>
<span class="udiff-line-modified-added">+   JVMFlag* f = JVMFlag::find_flag(name);</span>
    if (f) {
      f-&gt;print_as_flag(out);
      out-&gt;cr();
    } else {
      out-&gt;print_cr(&quot;no such flag &#39;%s&#39;&quot;, name);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -369,17 +358,19 @@</span>
    assert(thread == Thread::current(), &quot;Must be&quot;);
    assert(thread-&gt;stack_base() != NULL &amp;&amp; thread-&gt;stack_size() &gt; 0,
           &quot;Should already be setup&quot;);
  
    if (AttachListener::pd_init() != 0) {
<span class="udiff-line-added">+     AttachListener::set_state(AL_NOT_INITIALIZED);</span>
      return;
    }
    AttachListener::set_initialized();
  
    for (;;) {
      AttachOperation* op = AttachListener::dequeue();
      if (op == NULL) {
<span class="udiff-line-added">+       AttachListener::set_state(AL_NOT_INITIALIZED);</span>
        return;   // dequeue failed or shutdown
      }
  
      ResourceMark rm;
      bufferedStream st;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -419,10 +410,12 @@</span>
      }
  
      // operation complete - send result and output to client
      op-&gt;complete(res, &amp;st);
    }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ShouldNotReachHere();</span>
  }
  
  bool AttachListener::has_init_error(TRAPS) {
    if (HAS_PENDING_EXCEPTION) {
      tty-&gt;print_cr(&quot;Exception in VM (AttachListener::init) : &quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -442,10 +435,11 @@</span>
    EXCEPTION_MARK;
  
    const char thread_name[] = &quot;Attach Listener&quot;;
    Handle string = java_lang_String::create_from_str(thread_name, THREAD);
    if (has_init_error(THREAD)) {
<span class="udiff-line-added">+     set_state(AL_NOT_INITIALIZED);</span>
      return;
    }
  
    // Initialize thread_oop to put it into the system threadGroup
    Handle thread_group (THREAD, Universe::system_thread_group());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -453,10 +447,11 @@</span>
                         vmSymbols::threadgroup_string_void_signature(),
                         thread_group,
                         string,
                         THREAD);
    if (has_init_error(THREAD)) {
<span class="udiff-line-added">+     set_state(AL_NOT_INITIALIZED);</span>
      return;
    }
  
    Klass* group = SystemDictionary::ThreadGroup_klass();
    JavaValue result(T_VOID);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -466,14 +461,15 @@</span>
                          vmSymbols::add_method_name(),
                          vmSymbols::thread_void_signature(),
                          thread_oop,
                          THREAD);
    if (has_init_error(THREAD)) {
<span class="udiff-line-added">+     set_state(AL_NOT_INITIALIZED);</span>
      return;
    }
  
<span class="udiff-line-modified-removed">-   { MutexLocker mu(Threads_lock);</span>
<span class="udiff-line-modified-added">+   { MutexLocker mu(THREAD, Threads_lock);</span>
      JavaThread* listener_thread = new JavaThread(&amp;attach_listener_thread_entry);
  
      // Check that thread and osthread were created
      if (listener_thread == NULL || listener_thread-&gt;osthread() == NULL) {
        vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
</pre>
<center><a href="../runtime/vm_version.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="attachListener.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>