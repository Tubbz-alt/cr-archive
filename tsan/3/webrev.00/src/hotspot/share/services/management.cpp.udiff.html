<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/services/management.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="mallocTracker.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memBaseline.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/management.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,16 +22,18 @@</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;jmm.h&quot;
<span class="udiff-line-added">+ #include &quot;classfile/classLoader.hpp&quot;</span>
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;compiler/compileBroker.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;memory/oopFactory.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/klass.hpp&quot;
  #include &quot;oops/objArrayKlass.hpp&quot;
  #include &quot;oops/objArrayOop.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;oops/typeArrayOop.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,12 +42,12 @@</span>
  #include &quot;runtime/globals.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  #include &quot;runtime/javaCalls.hpp&quot;
  #include &quot;runtime/jniHandles.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/notificationThread.hpp&quot;</span>
  #include &quot;runtime/os.hpp&quot;
<span class="udiff-line-removed">- #include &quot;runtime/serviceThread.hpp&quot;</span>
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;runtime/threadSMR.hpp&quot;
  #include &quot;services/classLoadingService.hpp&quot;
  #include &quot;services/diagnosticCommand.hpp&quot;
  #include &quot;services/diagnosticFramework.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,13 +144,13 @@</span>
                           | DCmd_Source_MBean;
    DCmdFactory::register_DCmdFactory(new DCmdFactoryImpl&lt;NMTDCmd&gt;(full_export, true, false));
  }
  
  void Management::initialize(TRAPS) {
<span class="udiff-line-modified-removed">-   // Start the service thread</span>
<span class="udiff-line-modified-removed">-   ServiceThread::initialize();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+   if (UseNotificationThread) {</span>
<span class="udiff-line-modified-added">+     NotificationThread::initialize();</span>
<span class="udiff-line-modified-added">+   }</span>
    if (ManagementServer) {
      ResourceMark rm(THREAD);
      HandleMark hm(THREAD);
  
      // Load and initialize the jdk.internal.agent.Agent class
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -841,11 +843,11 @@</span>
  }
  
  static jint get_vm_thread_count() {
    VmThreadCountClosure vmtcc;
    {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(Threads_lock);</span>
<span class="udiff-line-modified-added">+     MutexLocker ml(Threads_lock);</span>
      Threads::threads_do(&amp;vmtcc);
    }
  
    return vmtcc.count();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1542,11 +1544,11 @@</span>
          THROW_(vmSymbols::java_lang_NullPointerException(), 0);
        }
  
        Handle sh(THREAD, s);
        char* str = java_lang_String::as_utf8_string(s);
<span class="udiff-line-modified-removed">-       JVMFlag* flag = JVMFlag::find_flag(str, strlen(str));</span>
<span class="udiff-line-modified-added">+       JVMFlag* flag = JVMFlag::find_flag(str);</span>
        if (flag != NULL &amp;&amp;
            add_global_entry(env, sh, &amp;globals[i], flag, THREAD)) {
          num_entries++;
        } else {
          globals[i].name = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1701,11 +1703,11 @@</span>
    typeArrayOop ta = typeArrayOop(JNIHandles::resolve_non_null(times));
    typeArrayHandle times_ah(THREAD, ta);
  
    ThreadTimesClosure ttc(names_ah, times_ah);
    {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(Threads_lock);</span>
<span class="udiff-line-modified-added">+     MutexLocker ml(THREAD, Threads_lock);</span>
      Threads::threads_do(&amp;ttc);
    }
    ttc.do_unlocked();
    return ttc.count();
  JVM_END
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2064,10 +2066,35 @@</span>
    return (jlong)(((double)ticks / (double)os::elapsed_frequency())
                   * (double)1000.0);
  }
  #endif // INCLUDE_MANAGEMENT
  
<span class="udiff-line-added">+ // Gets the amount of memory allocated on the Java heap for a single thread.</span>
<span class="udiff-line-added">+ // Returns -1 if the thread does not exist or has terminated.</span>
<span class="udiff-line-added">+ JVM_ENTRY(jlong, jmm_GetOneThreadAllocatedMemory(JNIEnv *env, jlong thread_id))</span>
<span class="udiff-line-added">+   if (thread_id &lt; 0) {</span>
<span class="udiff-line-added">+     THROW_MSG_(vmSymbols::java_lang_IllegalArgumentException(),</span>
<span class="udiff-line-added">+                &quot;Invalid thread ID&quot;, -1);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (thread_id == 0) {</span>
<span class="udiff-line-added">+     // current thread</span>
<span class="udiff-line-added">+     if (THREAD-&gt;is_Java_thread()) {</span>
<span class="udiff-line-added">+       return ((JavaThread*)THREAD)-&gt;cooked_allocated_bytes();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return -1;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ThreadsListHandle tlh;</span>
<span class="udiff-line-added">+   JavaThread* java_thread = tlh.list()-&gt;find_JavaThread_from_java_tid(thread_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (java_thread != NULL) {</span>
<span class="udiff-line-added">+     return java_thread-&gt;cooked_allocated_bytes();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   return -1;</span>
<span class="udiff-line-added">+ JVM_END</span>
<span class="udiff-line-added">+ </span>
  // Gets an array containing the amount of memory allocated on the Java
  // heap for a set of threads (in bytes).  Each element of the array is
  // the amount of memory allocated for the thread ID specified in the
  // corresponding entry in the given array of thread IDs; or -1 if the
  // thread does not exist or has terminated.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2188,10 +2215,11 @@</span>
    jmm_GetThreadInfo,
    jmm_GetMemoryPools,
    jmm_GetMemoryManagers,
    jmm_GetMemoryPoolUsage,
    jmm_GetPeakMemoryPoolUsage,
<span class="udiff-line-added">+   jmm_GetOneThreadAllocatedMemory,</span>
    jmm_GetThreadAllocatedMemory,
    jmm_GetMemoryUsage,
    jmm_GetLongAttribute,
    jmm_GetBoolAttribute,
    jmm_SetBoolAttribute,
</pre>
<center><a href="mallocTracker.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="memBaseline.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>