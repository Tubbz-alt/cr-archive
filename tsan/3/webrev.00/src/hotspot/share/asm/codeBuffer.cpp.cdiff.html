<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/asm/codeBuffer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="assembler.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="codeBuffer.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/asm/codeBuffer.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 22,17 ***</span>
<span class="line-new-header">--- 22,19 ---</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;asm/codeBuffer.hpp&quot;
<span class="line-added">+ #include &quot;code/oopRecorder.inline.hpp&quot;</span>
  #include &quot;compiler/disassembler.hpp&quot;
  #include &quot;oops/methodData.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/icache.hpp&quot;
  #include &quot;runtime/safepointVerifiers.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
  #include &quot;utilities/copy.hpp&quot;
<span class="line-added">+ #include &quot;utilities/powerOfTwo.hpp&quot;</span>
  #include &quot;utilities/xmlstream.hpp&quot;
  
  // The structure of a CodeSection:
  //
  //    _start -&gt;           +----------------+
</pre>
<hr />
<pre>
<span class="line-old-header">*** 83,11 ***</span>
  typedef CodeBuffer::csize_t csize_t;  // file-local definition
  
  // External buffer, in a predefined CodeBlob.
  // Important: The code_start must be taken exactly, and not realigned.
  CodeBuffer::CodeBuffer(CodeBlob* blob) {
<span class="line-modified">!   initialize_misc(&quot;static buffer&quot;);</span>
    initialize(blob-&gt;content_begin(), blob-&gt;content_size());
    verify_section_allocation();
  }
  
  void CodeBuffer::initialize(csize_t code_size, csize_t locs_size) {
<span class="line-new-header">--- 85,12 ---</span>
  typedef CodeBuffer::csize_t csize_t;  // file-local definition
  
  // External buffer, in a predefined CodeBlob.
  // Important: The code_start must be taken exactly, and not realigned.
  CodeBuffer::CodeBuffer(CodeBlob* blob) {
<span class="line-modified">!   // Provide code buffer with meaningful name</span>
<span class="line-added">+   initialize_misc(blob-&gt;name());</span>
    initialize(blob-&gt;content_begin(), blob-&gt;content_size());
    verify_section_allocation();
  }
  
  void CodeBuffer::initialize(csize_t code_size, csize_t locs_size) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1032,11 ***</span>
  void CodeSection::decode() {
    Disassembler::decode(start(), end());
  }
  
  void CodeBuffer::block_comment(intptr_t offset, const char * comment) {
<span class="line-modified">!   _code_strings.add_comment(offset, comment);</span>
  }
  
  const char* CodeBuffer::code_string(const char* str) {
    return _code_strings.add_string(str);
  }
<span class="line-new-header">--- 1035,13 ---</span>
  void CodeSection::decode() {
    Disassembler::decode(start(), end());
  }
  
  void CodeBuffer::block_comment(intptr_t offset, const char * comment) {
<span class="line-modified">!   if (_collect_comments) {</span>
<span class="line-added">+     _code_strings.add_comment(offset, comment);</span>
<span class="line-added">+   }</span>
  }
  
  const char* CodeBuffer::code_string(const char* str) {
    return _code_strings.add_string(str);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1044,30 ***</span>
  class CodeString: public CHeapObj&lt;mtCode&gt; {
   private:
    friend class CodeStrings;
    const char * _string;
    CodeString*  _next;
    intptr_t     _offset;
  
    ~CodeString() {
<span class="line-modified">!     assert(_next == NULL, &quot;wrong interface for freeing list&quot;);</span>
      os::free((void*)_string);
    }
  
    bool is_comment() const { return _offset &gt;= 0; }
  
   public:
    CodeString(const char * string, intptr_t offset = -1)
<span class="line-modified">!     : _next(NULL), _offset(offset) {</span>
      _string = os::strdup(string, mtCode);
    }
  
    const char * string() const { return _string; }
    intptr_t     offset() const { assert(_offset &gt;= 0, &quot;offset for non comment?&quot;); return _offset;  }
    CodeString* next()    const { return _next; }
  
<span class="line-modified">!   void set_next(CodeString* next) { _next = next; }</span>
  
    CodeString* first_comment() {
      if (is_comment()) {
        return this;
      } else {
<span class="line-new-header">--- 1049,36 ---</span>
  class CodeString: public CHeapObj&lt;mtCode&gt; {
   private:
    friend class CodeStrings;
    const char * _string;
    CodeString*  _next;
<span class="line-added">+   CodeString*  _prev;</span>
    intptr_t     _offset;
  
    ~CodeString() {
<span class="line-modified">!     assert(_next == NULL &amp;&amp; _prev == NULL, &quot;wrong interface for freeing list&quot;);</span>
      os::free((void*)_string);
    }
  
    bool is_comment() const { return _offset &gt;= 0; }
  
   public:
    CodeString(const char * string, intptr_t offset = -1)
<span class="line-modified">!     : _next(NULL), _prev(NULL), _offset(offset) {</span>
      _string = os::strdup(string, mtCode);
    }
  
    const char * string() const { return _string; }
    intptr_t     offset() const { assert(_offset &gt;= 0, &quot;offset for non comment?&quot;); return _offset;  }
    CodeString* next()    const { return _next; }
  
<span class="line-modified">!   void set_next(CodeString* next) {</span>
<span class="line-added">+     _next = next;</span>
<span class="line-added">+     if (next != NULL) {</span>
<span class="line-added">+       next-&gt;_prev = this;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
  
    CodeString* first_comment() {
      if (is_comment()) {
        return this;
      } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1091,16 ***</span>
    return a;
  }
  
  // Convenience for add_comment.
  CodeString* CodeStrings::find_last(intptr_t offset) const {
<span class="line-modified">!   CodeString* a = find(offset);</span>
<span class="line-modified">!   if (a != NULL) {</span>
<span class="line-modified">!     CodeString* c = NULL;</span>
<span class="line-removed">-     while (((c = a-&gt;next_comment()) != NULL) &amp;&amp; (c-&gt;offset() == offset)) {</span>
<span class="line-removed">-       a = c;</span>
<span class="line-removed">-     }</span>
    }
    return a;
  }
  
  void CodeStrings::add_comment(intptr_t offset, const char * comment) {
<span class="line-new-header">--- 1102,13 ---</span>
    return a;
  }
  
  // Convenience for add_comment.
  CodeString* CodeStrings::find_last(intptr_t offset) const {
<span class="line-modified">!   CodeString* a = _strings_last;</span>
<span class="line-modified">!   while (a != NULL &amp;&amp; !(a-&gt;is_comment() &amp;&amp; a-&gt;offset() == offset)) {</span>
<span class="line-modified">!     a = a-&gt;_prev;</span>
    }
    return a;
  }
  
  void CodeStrings::add_comment(intptr_t offset, const char * comment) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1115,16 ***</span>
<span class="line-new-header">--- 1123,20 ---</span>
    } else {
      // no comments with such offset, yet. Insert before anything else.
      c-&gt;set_next(_strings);
      _strings = c;
    }
<span class="line-added">+   if (c-&gt;next() == NULL) {</span>
<span class="line-added">+     _strings_last = c;</span>
<span class="line-added">+   }</span>
  }
  
  void CodeStrings::assign(CodeStrings&amp; other) {
    other.check_valid();
    assert(is_null(), &quot;Cannot assign onto non-empty CodeStrings&quot;);
    _strings = other._strings;
<span class="line-added">+   _strings_last = other._strings_last;</span>
  #ifdef ASSERT
    _defunct = false;
  #endif
    other.set_null_and_invalidate();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1136,28 ***</span>
    other.check_valid();
    check_valid();
    assert(is_null(), &quot;Cannot copy onto non-empty CodeStrings&quot;);
    CodeString* n = other._strings;
    CodeString** ps = &amp;_strings;
    while (n != NULL) {
      *ps = new CodeString(n-&gt;string(),n-&gt;offset());
      ps = &amp;((*ps)-&gt;_next);
      n = n-&gt;next();
    }
  }
  
  const char* CodeStrings::_prefix = &quot; ;; &quot;;  // default: can be changed via set_prefix
  
  void CodeStrings::print_block_comment(outputStream* stream, intptr_t offset) const {
<span class="line-modified">!     check_valid();</span>
<span class="line-modified">!     if (_strings != NULL) {</span>
      CodeString* c = find(offset);
      while (c &amp;&amp; c-&gt;offset() == offset) {
        stream-&gt;bol();
        stream-&gt;print(&quot;%s&quot;, _prefix);
        // Don&#39;t interpret as format strings since it could contain %
<span class="line-modified">!       stream-&gt;print_raw_cr(c-&gt;string());</span>
        c = c-&gt;next_comment();
      }
    }
  }
  
<span class="line-new-header">--- 1148,39 ---</span>
    other.check_valid();
    check_valid();
    assert(is_null(), &quot;Cannot copy onto non-empty CodeStrings&quot;);
    CodeString* n = other._strings;
    CodeString** ps = &amp;_strings;
<span class="line-added">+   CodeString* prev = NULL;</span>
    while (n != NULL) {
      *ps = new CodeString(n-&gt;string(),n-&gt;offset());
<span class="line-added">+     (*ps)-&gt;_prev = prev;</span>
<span class="line-added">+     prev = *ps;</span>
      ps = &amp;((*ps)-&gt;_next);
      n = n-&gt;next();
    }
  }
  
  const char* CodeStrings::_prefix = &quot; ;; &quot;;  // default: can be changed via set_prefix
  
<span class="line-added">+ // Check if any block comments are pending for the given offset.</span>
<span class="line-added">+ bool CodeStrings::has_block_comment(intptr_t offset) const {</span>
<span class="line-added">+   if (_strings == NULL) return false;</span>
<span class="line-added">+   CodeString* c = find(offset);</span>
<span class="line-added">+   return c != NULL;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void CodeStrings::print_block_comment(outputStream* stream, intptr_t offset) const {
<span class="line-modified">!   check_valid();</span>
<span class="line-modified">!   if (_strings != NULL) {</span>
      CodeString* c = find(offset);
      while (c &amp;&amp; c-&gt;offset() == offset) {
        stream-&gt;bol();
        stream-&gt;print(&quot;%s&quot;, _prefix);
        // Don&#39;t interpret as format strings since it could contain %
<span class="line-modified">!       stream-&gt;print_raw(c-&gt;string());</span>
<span class="line-added">+       stream-&gt;bol(); // advance to next line only if string didn&#39;t contain a cr() at the end.</span>
        c = c-&gt;next_comment();
      }
    }
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1166,28 ***</span>
    CodeString* n = _strings;
    while (n) {
      // unlink the node from the list saving a pointer to the next
      CodeString* p = n-&gt;next();
      n-&gt;set_next(NULL);
      delete n;
      n = p;
    }
    set_null_and_invalidate();
  }
  
  const char* CodeStrings::add_string(const char * string) {
    check_valid();
    CodeString* s = new CodeString(string);
    s-&gt;set_next(_strings);
    _strings = s;
    assert(s-&gt;string() != NULL, &quot;should have a string&quot;);
    return s-&gt;string();
  }
  
  void CodeBuffer::decode() {
    ttyLocker ttyl;
<span class="line-modified">!   Disassembler::decode(decode_begin(), insts_end());</span>
    _decode_begin = insts_end();
  }
  
  void CodeSection::print(const char* name) {
    csize_t locs_size = locs_end() - locs_start();
<span class="line-new-header">--- 1189,35 ---</span>
    CodeString* n = _strings;
    while (n) {
      // unlink the node from the list saving a pointer to the next
      CodeString* p = n-&gt;next();
      n-&gt;set_next(NULL);
<span class="line-added">+     if (p != NULL) {</span>
<span class="line-added">+       assert(p-&gt;_prev == n, &quot;missing prev link&quot;);</span>
<span class="line-added">+       p-&gt;_prev = NULL;</span>
<span class="line-added">+     }</span>
      delete n;
      n = p;
    }
    set_null_and_invalidate();
  }
  
  const char* CodeStrings::add_string(const char * string) {
    check_valid();
    CodeString* s = new CodeString(string);
    s-&gt;set_next(_strings);
<span class="line-added">+   if (_strings == NULL) {</span>
<span class="line-added">+     _strings_last = s;</span>
<span class="line-added">+   }</span>
    _strings = s;
    assert(s-&gt;string() != NULL, &quot;should have a string&quot;);
    return s-&gt;string();
  }
  
  void CodeBuffer::decode() {
    ttyLocker ttyl;
<span class="line-modified">!   Disassembler::decode(decode_begin(), insts_end(), tty);</span>
    _decode_begin = insts_end();
  }
  
  void CodeSection::print(const char* name) {
    csize_t locs_size = locs_end() - locs_start();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1214,6 ***</span>
<span class="line-new-header">--- 1244,12 ---</span>
      CodeSection* cs = code_section(n);
      cs-&gt;print(code_section_name(n));
    }
  }
  
<span class="line-added">+ // Directly disassemble code buffer.</span>
<span class="line-added">+ void CodeBuffer::decode(address start, address end) {</span>
<span class="line-added">+   ttyLocker ttyl;</span>
<span class="line-added">+   Disassembler::decode(this, start, end, tty);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #endif // PRODUCT
</pre>
<center><a href="assembler.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="codeBuffer.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>