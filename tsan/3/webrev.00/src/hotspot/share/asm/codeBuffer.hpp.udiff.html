<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/asm/codeBuffer.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="codeBuffer.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../c1/c1_Canonicalizer.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/asm/codeBuffer.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -247,10 +247,11 @@</span>
  class CodeString;
  class CodeStrings {
  private:
  #ifndef PRODUCT
    CodeString* _strings;
<span class="udiff-line-added">+   CodeString* _strings_last;</span>
  #ifdef ASSERT
    // Becomes true after copy-out, forbids further use.
    bool _defunct; // Zero bit pattern is &quot;valid&quot;, see memset call in decode_env::decode_env
  #endif
    static const char* _prefix; // defaults to &quot; ;; &quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -260,20 +261,22 @@</span>
    CodeString* find_last(intptr_t offset) const;
  
    void set_null_and_invalidate() {
  #ifndef PRODUCT
      _strings = NULL;
<span class="udiff-line-added">+     _strings_last = NULL;</span>
  #ifdef ASSERT
      _defunct = true;
  #endif
  #endif
    }
  
  public:
    CodeStrings() {
  #ifndef PRODUCT
      _strings = NULL;
<span class="udiff-line-added">+     _strings_last = NULL;</span>
  #ifdef ASSERT
      _defunct = false;
  #endif
  #endif
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -287,17 +290,19 @@</span>
    }
  
    const char* add_string(const char * string) PRODUCT_RETURN_(return NULL;);
  
    void add_comment(intptr_t offset, const char * comment) PRODUCT_RETURN;
<span class="udiff-line-added">+   bool has_block_comment(intptr_t offset) const;</span>
    void print_block_comment(outputStream* stream, intptr_t offset) const PRODUCT_RETURN;
    // MOVE strings from other to this; invalidate other.
    void assign(CodeStrings&amp; other)  PRODUCT_RETURN;
    // COPY strings from other to this; leave other valid.
    void copy(CodeStrings&amp; other)  PRODUCT_RETURN;
    // FREE strings; invalidate this.
    void free() PRODUCT_RETURN;
<span class="udiff-line-added">+ </span>
    // Guarantee that _strings are used at most once; assign and free invalidate a buffer.
    inline void check_valid() const {
  #ifdef ASSERT
      assert(!_defunct, &quot;Use of invalid CodeStrings&quot;);
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -375,10 +380,11 @@</span>
    address      _total_start;    // first address of combined memory buffer
    csize_t      _total_size;     // size in bytes of combined memory buffer
  
    OopRecorder* _oop_recorder;
    CodeStrings  _code_strings;
<span class="udiff-line-added">+   bool         _collect_comments;      // Indicate if we need to collect block comments at all.</span>
    OopRecorder  _default_oop_recorder;  // override with initialize_oop_recorder
    Arena*       _overflow_arena;
  
    address      _last_insn;      // used to merge consecutive memory barriers, loads or stores.
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -401,10 +407,19 @@</span>
      _code_strings    = CodeStrings();
      _last_insn       = NULL;
  #if INCLUDE_AOT
      _immutable_PIC   = false;
  #endif
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Collect block comments, but restrict collection to cases where a disassembly is output.</span>
<span class="udiff-line-added">+     _collect_comments = ( PrintAssembly</span>
<span class="udiff-line-added">+                        || PrintStubCode</span>
<span class="udiff-line-added">+                        || PrintMethodHandleStubs</span>
<span class="udiff-line-added">+                        || PrintInterpreter</span>
<span class="udiff-line-added">+                        || PrintSignatureHandlers</span>
<span class="udiff-line-added">+                        || UnlockDiagnosticVMOptions</span>
<span class="udiff-line-added">+                         );</span>
    }
  
    void initialize(address code_start, csize_t code_size) {
      _consts.initialize_outer(this,  SECT_CONSTS);
      _insts.initialize_outer(this,   SECT_INSTS);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -602,10 +617,27 @@</span>
      if (!_code_strings.is_null()) {
        _code_strings.free(); // sets _strings Null as a side-effect.
      }
    }
  
<span class="udiff-line-added">+   // Directly disassemble code buffer.</span>
<span class="udiff-line-added">+   // Print the comment associated with offset on stream, if there is one.</span>
<span class="udiff-line-added">+   virtual void print_block_comment(outputStream* stream, address block_begin) {</span>
<span class="udiff-line-added">+ #ifndef PRODUCT</span>
<span class="udiff-line-added">+     intptr_t offset = (intptr_t)(block_begin - _total_start);  // I assume total_start is not correct for all code sections.</span>
<span class="udiff-line-added">+     _code_strings.print_block_comment(stream, offset);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   bool has_block_comment(address block_begin) {</span>
<span class="udiff-line-added">+ #ifndef PRODUCT</span>
<span class="udiff-line-added">+     intptr_t offset = (intptr_t)(block_begin - _total_start);  // I assume total_start is not correct for all code sections.</span>
<span class="udiff-line-added">+     return _code_strings.has_block_comment(offset);</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    // Code generation
    void relocate(address at, RelocationHolder const&amp; rspec, int format = 0) {
      _insts.relocate(at, rspec, format);
    }
    void relocate(address at,    relocInfo::relocType rtype, int format = 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -648,11 +680,12 @@</span>
    // Printing / Decoding
    // decodes from decode_begin() to code_end() and sets decode_begin to end
    void    decode();
    void    print();
  #endif
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+   // Directly disassemble code buffer.</span>
<span class="udiff-line-added">+   void    decode(address start, address end);</span>
  
    // The following header contains architecture-specific implementations
  #include CPU_HEADER(codeBuffer)
  
  };
</pre>
<center><a href="codeBuffer.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../c1/c1_Canonicalizer.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>