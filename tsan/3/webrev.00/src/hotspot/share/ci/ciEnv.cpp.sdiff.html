<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/ci/ciEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ciConstant.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciEnv.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/ci/ciEnv.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;ci/ciConstant.hpp&quot;
  28 #include &quot;ci/ciEnv.hpp&quot;
  29 #include &quot;ci/ciField.hpp&quot;
  30 #include &quot;ci/ciInstance.hpp&quot;
  31 #include &quot;ci/ciInstanceKlass.hpp&quot;
  32 #include &quot;ci/ciMethod.hpp&quot;
  33 #include &quot;ci/ciNullObject.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;

  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;classfile/vmSymbols.hpp&quot;
  38 #include &quot;code/codeCache.hpp&quot;
  39 #include &quot;code/scopeDesc.hpp&quot;
  40 #include &quot;compiler/compileBroker.hpp&quot;
  41 #include &quot;compiler/compileLog.hpp&quot;
  42 #include &quot;compiler/disassembler.hpp&quot;
  43 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  44 #include &quot;interpreter/linkResolver.hpp&quot;
  45 #include &quot;jfr/jfrEvents.hpp&quot;

  46 #include &quot;memory/allocation.inline.hpp&quot;
  47 #include &quot;memory/oopFactory.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/constantPool.inline.hpp&quot;
  51 #include &quot;oops/cpCache.inline.hpp&quot;
  52 #include &quot;oops/method.inline.hpp&quot;
  53 #include &quot;oops/methodData.hpp&quot;
  54 #include &quot;oops/objArrayKlass.hpp&quot;
  55 #include &quot;oops/objArrayOop.inline.hpp&quot;
  56 #include &quot;oops/oop.inline.hpp&quot;
  57 #include &quot;prims/jvmtiExport.hpp&quot;
  58 #include &quot;runtime/handles.inline.hpp&quot;
  59 #include &quot;runtime/init.hpp&quot;
  60 #include &quot;runtime/reflection.hpp&quot;
  61 #include &quot;runtime/jniHandles.inline.hpp&quot;
  62 #include &quot;runtime/safepointVerifiers.hpp&quot;
  63 #include &quot;runtime/sharedRuntime.hpp&quot;
  64 #include &quot;runtime/thread.inline.hpp&quot;
  65 #include &quot;utilities/dtrace.hpp&quot;
</pre>
<hr />
<pre>
  79 ciObject*              ciEnv::_null_object_instance;
  80 
  81 #define WK_KLASS_DEFN(name, ignore_s) ciInstanceKlass* ciEnv::_##name = NULL;
  82 WK_KLASSES_DO(WK_KLASS_DEFN)
  83 #undef WK_KLASS_DEFN
  84 
  85 ciSymbol*        ciEnv::_unloaded_cisymbol = NULL;
  86 ciInstanceKlass* ciEnv::_unloaded_ciinstance_klass = NULL;
  87 ciObjArrayKlass* ciEnv::_unloaded_ciobjarrayklass = NULL;
  88 
  89 jobject ciEnv::_ArrayIndexOutOfBoundsException_handle = NULL;
  90 jobject ciEnv::_ArrayStoreException_handle = NULL;
  91 jobject ciEnv::_ClassCastException_handle = NULL;
  92 
  93 #ifndef PRODUCT
  94 static bool firstEnv = true;
  95 #endif /* PRODUCT */
  96 
  97 // ------------------------------------------------------------------
  98 // ciEnv::ciEnv
<span class="line-modified">  99 ciEnv::ciEnv(CompileTask* task, int system_dictionary_modification_counter)</span>
 100   : _ciEnv_arena(mtCompiler) {
 101   VM_ENTRY_MARK;
 102 
 103   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 104   thread-&gt;set_env(this);
 105   assert(ciEnv::current() == this, &quot;sanity&quot;);
 106 
 107   _oop_recorder = NULL;
 108   _debug_info = NULL;
 109   _dependencies = NULL;
 110   _failure_reason = NULL;
 111   _inc_decompile_count_on_failure = true;
 112   _compilable = MethodCompilable;
 113   _break_at_compile = false;
 114   _compiler_data = NULL;
 115 #ifndef PRODUCT
 116   assert(!firstEnv, &quot;not initialized properly&quot;);
 117 #endif /* !PRODUCT */
 118 
<span class="line-removed"> 119   _system_dictionary_modification_counter = system_dictionary_modification_counter;</span>
 120   _num_inlined_bytecodes = 0;
 121   assert(task == NULL || thread-&gt;task() == task, &quot;sanity&quot;);
 122   if (task != NULL) {
 123     task-&gt;mark_started(os::elapsed_counter());
 124   }
 125   _task = task;
 126   _log = NULL;
 127 
 128   // Temporary buffer for creating symbols and such.
 129   _name_buffer = NULL;
 130   _name_buffer_len = 0;
 131 
 132   _arena   = &amp;_ciEnv_arena;
 133   _factory = new (_arena) ciObjectFactory(_arena, 128);
 134 
 135   // Preload commonly referenced system ciObjects.
 136 
 137   // During VM initialization, these instances have not yet been created.
 138   // Assertions ensure that these instances are not accessed before
 139   // their initialization.
 140 
 141   assert(Universe::is_fully_initialized(), &quot;should be complete&quot;);
 142 
 143   oop o = Universe::null_ptr_exception_instance();
 144   assert(o != NULL, &quot;should have been initialized&quot;);
 145   _NullPointerException_instance = get_object(o)-&gt;as_instance();
 146   o = Universe::arithmetic_exception_instance();
 147   assert(o != NULL, &quot;should have been initialized&quot;);
 148   _ArithmeticException_instance = get_object(o)-&gt;as_instance();
 149 
 150   _ArrayIndexOutOfBoundsException_instance = NULL;
 151   _ArrayStoreException_instance = NULL;
 152   _ClassCastException_instance = NULL;
 153   _the_null_string = NULL;
 154   _the_min_jint_string = NULL;
 155 

 156   _jvmti_can_hotswap_or_post_breakpoint = false;
 157   _jvmti_can_access_local_variables = false;
 158   _jvmti_can_post_on_exceptions = false;
 159   _jvmti_can_pop_frame = false;
 160 }
 161 
 162 ciEnv::ciEnv(Arena* arena) : _ciEnv_arena(mtCompiler) {
 163   ASSERT_IN_VM;
 164 
 165   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 166   CompilerThread* current_thread = CompilerThread::current();
 167   assert(current_thread-&gt;env() == NULL, &quot;must be&quot;);
 168   current_thread-&gt;set_env(this);
 169   assert(ciEnv::current() == this, &quot;sanity&quot;);
 170 
 171   _oop_recorder = NULL;
 172   _debug_info = NULL;
 173   _dependencies = NULL;
 174   _failure_reason = NULL;
 175   _inc_decompile_count_on_failure = true;
 176   _compilable = MethodCompilable_never;
 177   _break_at_compile = false;
 178   _compiler_data = NULL;
 179 #ifndef PRODUCT
 180   assert(firstEnv, &quot;must be first&quot;);
 181   firstEnv = false;
 182 #endif /* !PRODUCT */
 183 
<span class="line-removed"> 184   _system_dictionary_modification_counter = 0;</span>
 185   _num_inlined_bytecodes = 0;
 186   _task = NULL;
 187   _log = NULL;
 188 
 189   // Temporary buffer for creating symbols and such.
 190   _name_buffer = NULL;
 191   _name_buffer_len = 0;
 192 
 193   _arena   = arena;
 194   _factory = new (_arena) ciObjectFactory(_arena, 128);
 195 
 196   // Preload commonly referenced system ciObjects.
 197 
 198   // During VM initialization, these instances have not yet been created.
 199   // Assertions ensure that these instances are not accessed before
 200   // their initialization.
 201 
 202   assert(Universe::is_fully_initialized(), &quot;must be&quot;);
 203 
 204   _NullPointerException_instance = NULL;
 205   _ArithmeticException_instance = NULL;
 206   _ArrayIndexOutOfBoundsException_instance = NULL;
 207   _ArrayStoreException_instance = NULL;
 208   _ClassCastException_instance = NULL;
 209   _the_null_string = NULL;
 210   _the_min_jint_string = NULL;
 211 

 212   _jvmti_can_hotswap_or_post_breakpoint = false;
 213   _jvmti_can_access_local_variables = false;
 214   _jvmti_can_post_on_exceptions = false;
 215   _jvmti_can_pop_frame = false;
 216 }
 217 
 218 ciEnv::~ciEnv() {
 219   GUARDED_VM_ENTRY(
 220       CompilerThread* current_thread = CompilerThread::current();
 221       _factory-&gt;remove_symbols();
 222       // Need safepoint to clear the env on the thread.  RedefineClasses might
 223       // be reading it.
 224       current_thread-&gt;set_env(NULL);
 225   )
 226 }
 227 
 228 // ------------------------------------------------------------------
 229 // Cache Jvmti state
 230 void ciEnv::cache_jvmti_state() {
 231   VM_ENTRY_MARK;
 232   // Get Jvmti capabilities under lock to get consistant values.
 233   MutexLocker mu(JvmtiThreadState_lock);

 234   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint();
 235   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables();
 236   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions();
 237   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame();

 238 }
 239 
 240 bool ciEnv::jvmti_state_changed() const {





 241   if (!_jvmti_can_access_local_variables &amp;&amp;
 242       JvmtiExport::can_access_local_variables()) {
 243     return true;
 244   }
 245   if (!_jvmti_can_hotswap_or_post_breakpoint &amp;&amp;
 246       JvmtiExport::can_hotswap_or_post_breakpoint()) {
 247     return true;
 248   }
 249   if (!_jvmti_can_post_on_exceptions &amp;&amp;
 250       JvmtiExport::can_post_on_exceptions()) {
 251     return true;
 252   }
 253   if (!_jvmti_can_pop_frame &amp;&amp;
 254       JvmtiExport::can_pop_frame()) {
 255     return true;
 256   }





 257   return false;
 258 }
 259 
 260 // ------------------------------------------------------------------
 261 // Cache DTrace flags
 262 void ciEnv::cache_dtrace_flags() {
 263   // Need lock?
 264   _dtrace_extended_probes = ExtendedDTraceProbes;
 265   if (_dtrace_extended_probes) {
 266     _dtrace_monitor_probes  = true;
 267     _dtrace_method_probes   = true;
 268     _dtrace_alloc_probes    = true;
 269   } else {
 270     _dtrace_monitor_probes  = DTraceMonitorProbes;
 271     _dtrace_method_probes   = DTraceMethodProbes;
 272     _dtrace_alloc_probes    = DTraceAllocProbes;
 273   }
 274 }
 275 
 276 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
 382   }
 383   if (resolved_klass-&gt;is_instance_klass()) {
 384     return (Reflection::verify_class_access(accessing_klass-&gt;get_Klass(),
 385                                             InstanceKlass::cast(resolved_klass),
 386                                             true) == Reflection::ACCESS_OK);
 387   }
 388   return true;
 389 }
 390 
 391 // ------------------------------------------------------------------
 392 // ciEnv::get_klass_by_name_impl
 393 ciKlass* ciEnv::get_klass_by_name_impl(ciKlass* accessing_klass,
 394                                        const constantPoolHandle&amp; cpool,
 395                                        ciSymbol* name,
 396                                        bool require_local) {
 397   ASSERT_IN_VM;
 398   EXCEPTION_CONTEXT;
 399 
 400   // Now we need to check the SystemDictionary
 401   Symbol* sym = name-&gt;get_symbol();
<span class="line-modified"> 402   if (sym-&gt;char_at(0) == &#39;L&#39; &amp;&amp;</span>
<span class="line-removed"> 403     sym-&gt;char_at(sym-&gt;utf8_length()-1) == &#39;;&#39;) {</span>
 404     // This is a name from a signature.  Strip off the trimmings.
 405     // Call recursive to keep scope of strippedsym.
<span class="line-modified"> 406     TempNewSymbol strippedsym = SymbolTable::new_symbol(sym-&gt;as_utf8()+1,</span>
<span class="line-removed"> 407                     sym-&gt;utf8_length()-2,</span>
<span class="line-removed"> 408                     KILL_COMPILE_ON_FATAL_(_unloaded_ciinstance_klass));</span>
 409     ciSymbol* strippedname = get_symbol(strippedsym);
 410     return get_klass_by_name_impl(accessing_klass, cpool, strippedname, require_local);
 411   }
 412 
 413   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 414   // can vary over time but the compiler needs consistency.
 415   ciKlass* unloaded_klass = check_get_unloaded_klass(accessing_klass, name);
 416   if (unloaded_klass != NULL) {
 417     if (require_local)  return NULL;
 418     return unloaded_klass;
 419   }
 420 
 421   Handle loader(THREAD, (oop)NULL);
 422   Handle domain(THREAD, (oop)NULL);
 423   if (accessing_klass != NULL) {
 424     loader = Handle(THREAD, accessing_klass-&gt;loader());
 425     domain = Handle(THREAD, accessing_klass-&gt;protection_domain());
 426   }
 427 
 428   // setup up the proper type to return on OOM
 429   ciKlass* fail_type;
<span class="line-modified"> 430   if (sym-&gt;char_at(0) == &#39;[&#39;) {</span>
 431     fail_type = _unloaded_ciobjarrayklass;
 432   } else {
 433     fail_type = _unloaded_ciinstance_klass;
 434   }
 435   Klass* found_klass;
 436   {
 437     ttyUnlocker ttyul;  // release tty lock to avoid ordering problems
 438     MutexLocker ml(Compile_lock);
 439     Klass* kls;
 440     if (!require_local) {
 441       kls = SystemDictionary::find_constrained_instance_or_array_klass(sym, loader,
 442                                                                        KILL_COMPILE_ON_FATAL_(fail_type));
 443     } else {
 444       kls = SystemDictionary::find_instance_or_array_klass(sym, loader, domain,
 445                                                            KILL_COMPILE_ON_FATAL_(fail_type));
 446     }
 447     found_klass = kls;
 448   }
 449 
 450   // If we fail to find an array klass, look again for its element type.
 451   // The element type may be available either locally or via constraints.
 452   // In either case, if we can find the element type in the system dictionary,
 453   // we must build an array type around it.  The CI requires array klasses
 454   // to be loaded if their element klasses are loaded, except when memory
 455   // is exhausted.
<span class="line-modified"> 456   if (sym-&gt;char_at(0) == &#39;[&#39; &amp;&amp;</span>
<span class="line-modified"> 457       (sym-&gt;char_at(1) == &#39;[&#39; || sym-&gt;char_at(1) == &#39;L&#39;)) {</span>
 458     // We have an unloaded array.
 459     // Build it on the fly if the element class exists.
<span class="line-modified"> 460     TempNewSymbol elem_sym = SymbolTable::new_symbol(sym-&gt;as_utf8()+1,</span>
<span class="line-modified"> 461                                                  sym-&gt;utf8_length()-1,</span>
<span class="line-removed"> 462                                                  KILL_COMPILE_ON_FATAL_(fail_type));</span>
<span class="line-removed"> 463 </span>
 464     // Get element ciKlass recursively.
 465     ciKlass* elem_klass =
 466       get_klass_by_name_impl(accessing_klass,
 467                              cpool,
<span class="line-modified"> 468                              get_symbol(elem_sym),</span>
 469                              require_local);
 470     if (elem_klass != NULL &amp;&amp; elem_klass-&gt;is_loaded()) {
 471       // Now make an array for it
 472       return ciObjArrayKlass::make_impl(elem_klass);
 473     }
 474   }
 475 
 476   if (found_klass == NULL &amp;&amp; !cpool.is_null() &amp;&amp; cpool-&gt;has_preresolution()) {
 477     // Look inside the constant pool for pre-resolved class entries.
 478     for (int i = cpool-&gt;length() - 1; i &gt;= 1; i--) {
 479       if (cpool-&gt;tag_at(i).is_klass()) {
 480         Klass* kls = cpool-&gt;resolved_klass_at(i);
 481         if (kls-&gt;name() == sym) {
 482           found_klass = kls;
 483           break;
 484         }
 485       }
 486     }
 487   }
 488 
</pre>
<hr />
<pre>
 524   if (cpool-&gt;tag_at(index).is_symbol()) {
 525     klass_name = cpool-&gt;symbol_at(index);
 526   } else {
 527     // Check if it&#39;s resolved if it&#39;s not a symbol constant pool entry.
 528     klass =  ConstantPool::klass_at_if_loaded(cpool, index);
 529     // Try to look it up by name.
 530     if (klass == NULL) {
 531       klass_name = cpool-&gt;klass_name_at(index);
 532     }
 533   }
 534 
 535   if (klass == NULL) {
 536     // Not found in constant pool.  Use the name to do the lookup.
 537     ciKlass* k = get_klass_by_name_impl(accessor,
 538                                         cpool,
 539                                         get_symbol(klass_name),
 540                                         false);
 541     // Calculate accessibility the hard way.
 542     if (!k-&gt;is_loaded()) {
 543       is_accessible = false;
<span class="line-modified"> 544     } else if (!oopDesc::equals(k-&gt;loader(), accessor-&gt;loader()) &amp;&amp;</span>
 545                get_klass_by_name_impl(accessor, cpool, k-&gt;name(), true) == NULL) {
 546       // Loaded only remotely.  Not linked yet.
 547       is_accessible = false;
 548     } else {
 549       // Linked locally, and we must also check public/private, etc.
 550       is_accessible = check_klass_accessibility(accessor, k-&gt;get_Klass());
 551     }
 552     return k;
 553   }
 554 
 555   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 556   // can vary over time but the compiler needs consistency.
 557   ciSymbol* name = get_symbol(klass-&gt;name());
 558   ciKlass* unloaded_klass = check_get_unloaded_klass(accessor, name);
 559   if (unloaded_klass != NULL) {
 560     is_accessible = false;
 561     return unloaded_klass;
 562   }
 563 
 564   // It is known to be accessible, since it was found in the constant pool.
</pre>
<hr />
<pre>
 575                                    bool&amp; is_accessible,
 576                                    ciInstanceKlass* accessor) {
 577   GUARDED_VM_ENTRY(return get_klass_by_index_impl(cpool, index, is_accessible, accessor);)
 578 }
 579 
 580 // ------------------------------------------------------------------
 581 // ciEnv::get_constant_by_index_impl
 582 //
 583 // Implementation of get_constant_by_index().
 584 ciConstant ciEnv::get_constant_by_index_impl(const constantPoolHandle&amp; cpool,
 585                                              int pool_index, int cache_index,
 586                                              ciInstanceKlass* accessor) {
 587   bool ignore_will_link;
 588   EXCEPTION_CONTEXT;
 589   int index = pool_index;
 590   if (cache_index &gt;= 0) {
 591     assert(index &lt; 0, &quot;only one kind of index at a time&quot;);
 592     index = cpool-&gt;object_to_cp_index(cache_index);
 593     oop obj = cpool-&gt;resolved_references()-&gt;obj_at(cache_index);
 594     if (obj != NULL) {
<span class="line-modified"> 595       if (oopDesc::equals(obj, Universe::the_null_sentinel())) {</span>
 596         return ciConstant(T_OBJECT, get_object(NULL));
 597       }
 598       BasicType bt = T_OBJECT;
 599       if (cpool-&gt;tag_at(index).is_dynamic_constant())
<span class="line-modified"> 600         bt = FieldType::basic_type(cpool-&gt;uncached_signature_ref_at(index));</span>
 601       if (is_reference_type(bt)) {
 602       } else {
 603         // we have to unbox the primitive value
 604         if (!is_java_primitive(bt))  return ciConstant();
 605         jvalue value;
 606         BasicType bt2 = java_lang_boxing_object::get_value(obj, &amp;value);
 607         assert(bt2 == bt, &quot;&quot;);
 608         switch (bt2) {
 609         case T_DOUBLE:  return ciConstant(value.d);
 610         case T_FLOAT:   return ciConstant(value.f);
 611         case T_LONG:    return ciConstant(value.j);
 612         case T_INT:     return ciConstant(bt2, value.i);
 613         case T_SHORT:   return ciConstant(bt2, value.s);
 614         case T_BYTE:    return ciConstant(bt2, value.b);
 615         case T_CHAR:    return ciConstant(bt2, value.c);
 616         case T_BOOLEAN: return ciConstant(bt2, value.z);
 617         default:  return ciConstant();
 618         }
 619       }
 620       ciObject* ciobj = get_object(obj);
</pre>
<hr />
<pre>
 731                                    int index) {
 732   GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)
 733 }
 734 
 735 // ------------------------------------------------------------------
 736 // ciEnv::lookup_method
 737 //
 738 // Perform an appropriate method lookup based on accessor, holder,
 739 // name, signature, and bytecode.
 740 Method* ciEnv::lookup_method(ciInstanceKlass* accessor,
 741                              ciKlass*         holder,
 742                              Symbol*          name,
 743                              Symbol*          sig,
 744                              Bytecodes::Code  bc,
 745                              constantTag      tag) {
 746   // Accessibility checks are performed in ciEnv::get_method_by_index_impl.
 747   assert(check_klass_accessibility(accessor, holder-&gt;get_Klass()), &quot;holder not accessible&quot;);
 748 
 749   InstanceKlass* accessor_klass = accessor-&gt;get_instanceKlass();
 750   Klass* holder_klass = holder-&gt;get_Klass();
<span class="line-modified"> 751   methodHandle dest_method;</span>
 752   LinkInfo link_info(holder_klass, name, sig, accessor_klass, LinkInfo::needs_access_check, tag);
 753   switch (bc) {
 754   case Bytecodes::_invokestatic:
 755     dest_method =
 756       LinkResolver::resolve_static_call_or_null(link_info);
 757     break;
 758   case Bytecodes::_invokespecial:
 759     dest_method =
 760       LinkResolver::resolve_special_call_or_null(link_info);
 761     break;
 762   case Bytecodes::_invokeinterface:
 763     dest_method =
 764       LinkResolver::linktime_resolve_interface_method_or_null(link_info);
 765     break;
 766   case Bytecodes::_invokevirtual:
 767     dest_method =
 768       LinkResolver::linktime_resolve_virtual_method_or_null(link_info);
 769     break;
 770   default: ShouldNotReachHere();
 771   }
 772 
<span class="line-modified"> 773   return dest_method();</span>
 774 }
 775 
 776 
 777 // ------------------------------------------------------------------
 778 // ciEnv::get_method_by_index_impl
 779 ciMethod* ciEnv::get_method_by_index_impl(const constantPoolHandle&amp; cpool,
 780                                           int index, Bytecodes::Code bc,
 781                                           ciInstanceKlass* accessor) {


 782   if (bc == Bytecodes::_invokedynamic) {
 783     ConstantPoolCacheEntry* cpce = cpool-&gt;invokedynamic_cp_cache_entry_at(index);
 784     bool is_resolved = !cpce-&gt;is_f1_null();
 785     // FIXME: code generation could allow for null (unlinked) call site
 786     // The call site could be made patchable as follows:
 787     // Load the appendix argument from the constant pool.
 788     // Test the appendix argument and jump to a known deopt routine if it is null.
 789     // Jump through a patchable call site, which is initially a deopt routine.
 790     // Patch the call site to the nmethod entry point of the static compiled lambda form.
 791     // As with other two-component call sites, both values must be independently verified.
 792 
 793     if (is_resolved) {
 794       // Get the invoker Method* from the constant pool.
 795       // (The appendix argument, if any, will be noted in the method&#39;s signature.)
 796       Method* adapter = cpce-&gt;f1_as_method();
 797       return get_method(adapter);
 798     }
 799 
 800     // Fake a method that is equivalent to a declared method.
 801     ciInstanceKlass* holder    = get_instance_klass(SystemDictionary::MethodHandle_klass());
</pre>
<hr />
<pre>
 902 char *ciEnv::name_buffer(int req_len) {
 903   if (_name_buffer_len &lt; req_len) {
 904     if (_name_buffer == NULL) {
 905       _name_buffer = (char*)arena()-&gt;Amalloc(sizeof(char)*req_len);
 906       _name_buffer_len = req_len;
 907     } else {
 908       _name_buffer =
 909         (char*)arena()-&gt;Arealloc(_name_buffer, _name_buffer_len, req_len);
 910       _name_buffer_len = req_len;
 911     }
 912   }
 913   return _name_buffer;
 914 }
 915 
 916 // ------------------------------------------------------------------
 917 // ciEnv::is_in_vm
 918 bool ciEnv::is_in_vm() {
 919   return JavaThread::current()-&gt;thread_state() == _thread_in_vm;
 920 }
 921 
<span class="line-removed"> 922 bool ciEnv::system_dictionary_modification_counter_changed_locked() {</span>
<span class="line-removed"> 923   assert_locked_or_safepoint(Compile_lock);</span>
<span class="line-removed"> 924   return _system_dictionary_modification_counter != SystemDictionary::number_of_modifications();</span>
<span class="line-removed"> 925 }</span>
<span class="line-removed"> 926 </span>
<span class="line-removed"> 927 bool ciEnv::system_dictionary_modification_counter_changed() {</span>
<span class="line-removed"> 928   VM_ENTRY_MARK;</span>
<span class="line-removed"> 929   MutexLocker ml(Compile_lock, THREAD); // lock with safepoint check</span>
<span class="line-removed"> 930   return system_dictionary_modification_counter_changed_locked();</span>
<span class="line-removed"> 931 }</span>
<span class="line-removed"> 932 </span>
 933 // ------------------------------------------------------------------
 934 // ciEnv::validate_compile_task_dependencies
 935 //
 936 // Check for changes during compilation (e.g. class loads, evolution,
 937 // breakpoints, call site invalidation).
 938 void ciEnv::validate_compile_task_dependencies(ciMethod* target) {
 939   if (failing())  return;  // no need for further checks
 940 
<span class="line-modified"> 941   bool counter_changed = system_dictionary_modification_counter_changed_locked();</span>
<span class="line-removed"> 942   Dependencies::DepType result = dependencies()-&gt;validate_dependencies(_task, counter_changed);</span>
 943   if (result != Dependencies::end_marker) {
 944     if (result == Dependencies::call_site_target_value) {
 945       _inc_decompile_count_on_failure = false;
 946       record_failure(&quot;call site target change&quot;);
 947     } else if (Dependencies::is_klass_type(result)) {
 948       record_failure(&quot;concurrent class loading&quot;);
 949     } else {
 950       record_failure(&quot;invalid non-klass dependency&quot;);
 951     }
 952   }
 953 }
 954 
 955 // ------------------------------------------------------------------
 956 // ciEnv::register_method
 957 void ciEnv::register_method(ciMethod* target,
 958                             int entry_bci,
 959                             CodeOffsets* offsets,
 960                             int orig_pc_offset,
 961                             CodeBuffer* code_buffer,
 962                             int frame_words,
 963                             OopMapSet* oop_map_set,
 964                             ExceptionHandlerTable* handler_table,
 965                             ImplicitExceptionTable* inc_table,
 966                             AbstractCompiler* compiler,
 967                             bool has_unsafe_access,
 968                             bool has_wide_vectors,
 969                             RTMState  rtm_state) {
 970   VM_ENTRY_MARK;
 971   nmethod* nm = NULL;
 972   {
 973     // To prevent compile queue updates.
<span class="line-modified"> 974     MutexLocker locker(MethodCompileQueue_lock, THREAD);</span>
 975 
 976     // Prevent SystemDictionary::add_to_hierarchy from running
 977     // and invalidating our dependencies until we install this method.
 978     // No safepoints are allowed. Otherwise, class redefinition can occur in between.
 979     MutexLocker ml(Compile_lock);
 980     NoSafepointVerifier nsv;
 981 
 982     // Change in Jvmti state may invalidate compilation.
 983     if (!failing() &amp;&amp; jvmti_state_changed()) {
 984       record_failure(&quot;Jvmti state change invalidated dependencies&quot;);
 985     }
 986 
 987     // Change in DTrace flags may invalidate compilation.
 988     if (!failing() &amp;&amp;
 989         ( (!dtrace_extended_probes() &amp;&amp; ExtendedDTraceProbes) ||
 990           (!dtrace_method_probes() &amp;&amp; DTraceMethodProbes) ||
 991           (!dtrace_alloc_probes() &amp;&amp; DTraceAllocProbes) )) {
 992       record_failure(&quot;DTrace flags change invalidated dependencies&quot;);
 993     }
 994 





 995     if (!failing()) {
 996       if (log() != NULL) {
 997         // Log the dependencies which this compilation declares.
 998         dependencies()-&gt;log_all_dependencies();
 999       }
1000 
1001       // Encode the dependencies now, so we can check them right away.
1002       dependencies()-&gt;encode_content_bytes();
1003 
1004       // Check for {class loads, evolution, breakpoints, ...} during compilation
1005       validate_compile_task_dependencies(target);
1006     }
1007 
1008     methodHandle method(THREAD, target-&gt;get_Method());
1009 
1010 #if INCLUDE_RTM_OPT
1011     if (!failing() &amp;&amp; (rtm_state != NoRTM) &amp;&amp;
1012         (method()-&gt;method_data() != NULL) &amp;&amp;
1013         (method()-&gt;method_data()-&gt;rtm_state() != rtm_state)) {
1014       // Preemptive decompile if rtm state was changed.
</pre>
<hr />
<pre>
1055 
1056       // Record successful registration.
1057       // (Put nm into the task handle *before* publishing to the Java heap.)
1058       if (task() != NULL) {
1059         task()-&gt;set_code(nm);
1060       }
1061 
1062       if (entry_bci == InvocationEntryBci) {
1063         if (TieredCompilation) {
1064           // If there is an old version we&#39;re done with it
1065           CompiledMethod* old = method-&gt;code();
1066           if (TraceMethodReplacement &amp;&amp; old != NULL) {
1067             ResourceMark rm;
1068             char *method_name = method-&gt;name_and_sig_as_C_string();
1069             tty-&gt;print_cr(&quot;Replacing method %s&quot;, method_name);
1070           }
1071           if (old != NULL) {
1072             old-&gt;make_not_used();
1073           }
1074         }
<span class="line-modified">1075         if (TraceNMethodInstalls) {</span>


1076           ResourceMark rm;
1077           char *method_name = method-&gt;name_and_sig_as_C_string();
<span class="line-modified">1078           ttyLocker ttyl;</span>
<span class="line-modified">1079           tty-&gt;print_cr(&quot;Installing method (%d) %s &quot;,</span>
<span class="line-removed">1080                         task()-&gt;comp_level(),</span>
<span class="line-removed">1081                         method_name);</span>
1082         }
1083         // Allow the code to be executed
<span class="line-modified">1084         method-&gt;set_code(method, nm);</span>



1085       } else {
<span class="line-modified">1086         if (TraceNMethodInstalls) {</span>

1087           ResourceMark rm;
1088           char *method_name = method-&gt;name_and_sig_as_C_string();
<span class="line-modified">1089           ttyLocker ttyl;</span>
<span class="line-modified">1090           tty-&gt;print_cr(&quot;Installing osr method (%d) %s @ %d&quot;,</span>
<span class="line-modified">1091                         task()-&gt;comp_level(),</span>
<span class="line-modified">1092                         method_name,</span>
<span class="line-modified">1093                         entry_bci);</span>

1094         }
<span class="line-removed">1095         method-&gt;method_holder()-&gt;add_osr_nmethod(nm);</span>
1096       }
<span class="line-removed">1097       nm-&gt;make_in_use();</span>
1098     }
1099   }  // safepoints are allowed again
1100 
1101   if (nm != NULL) {
1102     // JVMTI -- compiled method notification (must be done outside lock)
1103     nm-&gt;post_compiled_method_load_event();
1104   } else {
1105     // The CodeCache is full.
1106     record_failure(&quot;code cache is full&quot;);
1107   }
1108 }
1109 
1110 
1111 // ------------------------------------------------------------------
1112 // ciEnv::find_system_klass
1113 ciKlass* ciEnv::find_system_klass(ciSymbol* klass_name) {
1114   VM_ENTRY_MARK;
1115   return get_klass_by_name_impl(NULL, constantPoolHandle(), klass_name, false);
1116 }
1117 
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;ci/ciConstant.hpp&quot;
  28 #include &quot;ci/ciEnv.hpp&quot;
  29 #include &quot;ci/ciField.hpp&quot;
  30 #include &quot;ci/ciInstance.hpp&quot;
  31 #include &quot;ci/ciInstanceKlass.hpp&quot;
  32 #include &quot;ci/ciMethod.hpp&quot;
  33 #include &quot;ci/ciNullObject.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;
<span class="line-added">  36 #include &quot;classfile/symbolTable.hpp&quot;</span>
  37 #include &quot;classfile/systemDictionary.hpp&quot;
  38 #include &quot;classfile/vmSymbols.hpp&quot;
  39 #include &quot;code/codeCache.hpp&quot;
  40 #include &quot;code/scopeDesc.hpp&quot;
  41 #include &quot;compiler/compileBroker.hpp&quot;
  42 #include &quot;compiler/compileLog.hpp&quot;
  43 #include &quot;compiler/disassembler.hpp&quot;
  44 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  45 #include &quot;interpreter/linkResolver.hpp&quot;
  46 #include &quot;jfr/jfrEvents.hpp&quot;
<span class="line-added">  47 #include &quot;logging/log.hpp&quot;</span>
  48 #include &quot;memory/allocation.inline.hpp&quot;
  49 #include &quot;memory/oopFactory.hpp&quot;
  50 #include &quot;memory/resourceArea.hpp&quot;
  51 #include &quot;memory/universe.hpp&quot;
  52 #include &quot;oops/constantPool.inline.hpp&quot;
  53 #include &quot;oops/cpCache.inline.hpp&quot;
  54 #include &quot;oops/method.inline.hpp&quot;
  55 #include &quot;oops/methodData.hpp&quot;
  56 #include &quot;oops/objArrayKlass.hpp&quot;
  57 #include &quot;oops/objArrayOop.inline.hpp&quot;
  58 #include &quot;oops/oop.inline.hpp&quot;
  59 #include &quot;prims/jvmtiExport.hpp&quot;
  60 #include &quot;runtime/handles.inline.hpp&quot;
  61 #include &quot;runtime/init.hpp&quot;
  62 #include &quot;runtime/reflection.hpp&quot;
  63 #include &quot;runtime/jniHandles.inline.hpp&quot;
  64 #include &quot;runtime/safepointVerifiers.hpp&quot;
  65 #include &quot;runtime/sharedRuntime.hpp&quot;
  66 #include &quot;runtime/thread.inline.hpp&quot;
  67 #include &quot;utilities/dtrace.hpp&quot;
</pre>
<hr />
<pre>
  81 ciObject*              ciEnv::_null_object_instance;
  82 
  83 #define WK_KLASS_DEFN(name, ignore_s) ciInstanceKlass* ciEnv::_##name = NULL;
  84 WK_KLASSES_DO(WK_KLASS_DEFN)
  85 #undef WK_KLASS_DEFN
  86 
  87 ciSymbol*        ciEnv::_unloaded_cisymbol = NULL;
  88 ciInstanceKlass* ciEnv::_unloaded_ciinstance_klass = NULL;
  89 ciObjArrayKlass* ciEnv::_unloaded_ciobjarrayklass = NULL;
  90 
  91 jobject ciEnv::_ArrayIndexOutOfBoundsException_handle = NULL;
  92 jobject ciEnv::_ArrayStoreException_handle = NULL;
  93 jobject ciEnv::_ClassCastException_handle = NULL;
  94 
  95 #ifndef PRODUCT
  96 static bool firstEnv = true;
  97 #endif /* PRODUCT */
  98 
  99 // ------------------------------------------------------------------
 100 // ciEnv::ciEnv
<span class="line-modified"> 101 ciEnv::ciEnv(CompileTask* task)</span>
 102   : _ciEnv_arena(mtCompiler) {
 103   VM_ENTRY_MARK;
 104 
 105   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 106   thread-&gt;set_env(this);
 107   assert(ciEnv::current() == this, &quot;sanity&quot;);
 108 
 109   _oop_recorder = NULL;
 110   _debug_info = NULL;
 111   _dependencies = NULL;
 112   _failure_reason = NULL;
 113   _inc_decompile_count_on_failure = true;
 114   _compilable = MethodCompilable;
 115   _break_at_compile = false;
 116   _compiler_data = NULL;
 117 #ifndef PRODUCT
 118   assert(!firstEnv, &quot;not initialized properly&quot;);
 119 #endif /* !PRODUCT */
 120 

 121   _num_inlined_bytecodes = 0;
 122   assert(task == NULL || thread-&gt;task() == task, &quot;sanity&quot;);
 123   if (task != NULL) {
 124     task-&gt;mark_started(os::elapsed_counter());
 125   }
 126   _task = task;
 127   _log = NULL;
 128 
 129   // Temporary buffer for creating symbols and such.
 130   _name_buffer = NULL;
 131   _name_buffer_len = 0;
 132 
 133   _arena   = &amp;_ciEnv_arena;
 134   _factory = new (_arena) ciObjectFactory(_arena, 128);
 135 
 136   // Preload commonly referenced system ciObjects.
 137 
 138   // During VM initialization, these instances have not yet been created.
 139   // Assertions ensure that these instances are not accessed before
 140   // their initialization.
 141 
 142   assert(Universe::is_fully_initialized(), &quot;should be complete&quot;);
 143 
 144   oop o = Universe::null_ptr_exception_instance();
 145   assert(o != NULL, &quot;should have been initialized&quot;);
 146   _NullPointerException_instance = get_object(o)-&gt;as_instance();
 147   o = Universe::arithmetic_exception_instance();
 148   assert(o != NULL, &quot;should have been initialized&quot;);
 149   _ArithmeticException_instance = get_object(o)-&gt;as_instance();
 150 
 151   _ArrayIndexOutOfBoundsException_instance = NULL;
 152   _ArrayStoreException_instance = NULL;
 153   _ClassCastException_instance = NULL;
 154   _the_null_string = NULL;
 155   _the_min_jint_string = NULL;
 156 
<span class="line-added"> 157   _jvmti_redefinition_count = 0;</span>
 158   _jvmti_can_hotswap_or_post_breakpoint = false;
 159   _jvmti_can_access_local_variables = false;
 160   _jvmti_can_post_on_exceptions = false;
 161   _jvmti_can_pop_frame = false;
 162 }
 163 
 164 ciEnv::ciEnv(Arena* arena) : _ciEnv_arena(mtCompiler) {
 165   ASSERT_IN_VM;
 166 
 167   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 168   CompilerThread* current_thread = CompilerThread::current();
 169   assert(current_thread-&gt;env() == NULL, &quot;must be&quot;);
 170   current_thread-&gt;set_env(this);
 171   assert(ciEnv::current() == this, &quot;sanity&quot;);
 172 
 173   _oop_recorder = NULL;
 174   _debug_info = NULL;
 175   _dependencies = NULL;
 176   _failure_reason = NULL;
 177   _inc_decompile_count_on_failure = true;
 178   _compilable = MethodCompilable_never;
 179   _break_at_compile = false;
 180   _compiler_data = NULL;
 181 #ifndef PRODUCT
 182   assert(firstEnv, &quot;must be first&quot;);
 183   firstEnv = false;
 184 #endif /* !PRODUCT */
 185 

 186   _num_inlined_bytecodes = 0;
 187   _task = NULL;
 188   _log = NULL;
 189 
 190   // Temporary buffer for creating symbols and such.
 191   _name_buffer = NULL;
 192   _name_buffer_len = 0;
 193 
 194   _arena   = arena;
 195   _factory = new (_arena) ciObjectFactory(_arena, 128);
 196 
 197   // Preload commonly referenced system ciObjects.
 198 
 199   // During VM initialization, these instances have not yet been created.
 200   // Assertions ensure that these instances are not accessed before
 201   // their initialization.
 202 
 203   assert(Universe::is_fully_initialized(), &quot;must be&quot;);
 204 
 205   _NullPointerException_instance = NULL;
 206   _ArithmeticException_instance = NULL;
 207   _ArrayIndexOutOfBoundsException_instance = NULL;
 208   _ArrayStoreException_instance = NULL;
 209   _ClassCastException_instance = NULL;
 210   _the_null_string = NULL;
 211   _the_min_jint_string = NULL;
 212 
<span class="line-added"> 213   _jvmti_redefinition_count = 0;</span>
 214   _jvmti_can_hotswap_or_post_breakpoint = false;
 215   _jvmti_can_access_local_variables = false;
 216   _jvmti_can_post_on_exceptions = false;
 217   _jvmti_can_pop_frame = false;
 218 }
 219 
 220 ciEnv::~ciEnv() {
 221   GUARDED_VM_ENTRY(
 222       CompilerThread* current_thread = CompilerThread::current();
 223       _factory-&gt;remove_symbols();
 224       // Need safepoint to clear the env on the thread.  RedefineClasses might
 225       // be reading it.
 226       current_thread-&gt;set_env(NULL);
 227   )
 228 }
 229 
 230 // ------------------------------------------------------------------
 231 // Cache Jvmti state
 232 void ciEnv::cache_jvmti_state() {
 233   VM_ENTRY_MARK;
 234   // Get Jvmti capabilities under lock to get consistant values.
 235   MutexLocker mu(JvmtiThreadState_lock);
<span class="line-added"> 236   _jvmti_redefinition_count             = JvmtiExport::redefinition_count();</span>
 237   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint();
 238   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables();
 239   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions();
 240   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame();
<span class="line-added"> 241   _jvmti_can_get_owned_monitor_info     = JvmtiExport::can_get_owned_monitor_info();</span>
 242 }
 243 
 244 bool ciEnv::jvmti_state_changed() const {
<span class="line-added"> 245   // Some classes were redefined</span>
<span class="line-added"> 246   if (_jvmti_redefinition_count != JvmtiExport::redefinition_count()) {</span>
<span class="line-added"> 247     return true;</span>
<span class="line-added"> 248   }</span>
<span class="line-added"> 249 </span>
 250   if (!_jvmti_can_access_local_variables &amp;&amp;
 251       JvmtiExport::can_access_local_variables()) {
 252     return true;
 253   }
 254   if (!_jvmti_can_hotswap_or_post_breakpoint &amp;&amp;
 255       JvmtiExport::can_hotswap_or_post_breakpoint()) {
 256     return true;
 257   }
 258   if (!_jvmti_can_post_on_exceptions &amp;&amp;
 259       JvmtiExport::can_post_on_exceptions()) {
 260     return true;
 261   }
 262   if (!_jvmti_can_pop_frame &amp;&amp;
 263       JvmtiExport::can_pop_frame()) {
 264     return true;
 265   }
<span class="line-added"> 266   if (!_jvmti_can_get_owned_monitor_info &amp;&amp;</span>
<span class="line-added"> 267       JvmtiExport::can_get_owned_monitor_info()) {</span>
<span class="line-added"> 268     return true;</span>
<span class="line-added"> 269   }</span>
<span class="line-added"> 270 </span>
 271   return false;
 272 }
 273 
 274 // ------------------------------------------------------------------
 275 // Cache DTrace flags
 276 void ciEnv::cache_dtrace_flags() {
 277   // Need lock?
 278   _dtrace_extended_probes = ExtendedDTraceProbes;
 279   if (_dtrace_extended_probes) {
 280     _dtrace_monitor_probes  = true;
 281     _dtrace_method_probes   = true;
 282     _dtrace_alloc_probes    = true;
 283   } else {
 284     _dtrace_monitor_probes  = DTraceMonitorProbes;
 285     _dtrace_method_probes   = DTraceMethodProbes;
 286     _dtrace_alloc_probes    = DTraceAllocProbes;
 287   }
 288 }
 289 
 290 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
 396   }
 397   if (resolved_klass-&gt;is_instance_klass()) {
 398     return (Reflection::verify_class_access(accessing_klass-&gt;get_Klass(),
 399                                             InstanceKlass::cast(resolved_klass),
 400                                             true) == Reflection::ACCESS_OK);
 401   }
 402   return true;
 403 }
 404 
 405 // ------------------------------------------------------------------
 406 // ciEnv::get_klass_by_name_impl
 407 ciKlass* ciEnv::get_klass_by_name_impl(ciKlass* accessing_klass,
 408                                        const constantPoolHandle&amp; cpool,
 409                                        ciSymbol* name,
 410                                        bool require_local) {
 411   ASSERT_IN_VM;
 412   EXCEPTION_CONTEXT;
 413 
 414   // Now we need to check the SystemDictionary
 415   Symbol* sym = name-&gt;get_symbol();
<span class="line-modified"> 416   if (Signature::has_envelope(sym)) {</span>

 417     // This is a name from a signature.  Strip off the trimmings.
 418     // Call recursive to keep scope of strippedsym.
<span class="line-modified"> 419     TempNewSymbol strippedsym = Signature::strip_envelope(sym);</span>


 420     ciSymbol* strippedname = get_symbol(strippedsym);
 421     return get_klass_by_name_impl(accessing_klass, cpool, strippedname, require_local);
 422   }
 423 
 424   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 425   // can vary over time but the compiler needs consistency.
 426   ciKlass* unloaded_klass = check_get_unloaded_klass(accessing_klass, name);
 427   if (unloaded_klass != NULL) {
 428     if (require_local)  return NULL;
 429     return unloaded_klass;
 430   }
 431 
 432   Handle loader(THREAD, (oop)NULL);
 433   Handle domain(THREAD, (oop)NULL);
 434   if (accessing_klass != NULL) {
 435     loader = Handle(THREAD, accessing_klass-&gt;loader());
 436     domain = Handle(THREAD, accessing_klass-&gt;protection_domain());
 437   }
 438 
 439   // setup up the proper type to return on OOM
 440   ciKlass* fail_type;
<span class="line-modified"> 441   if (sym-&gt;char_at(0) == JVM_SIGNATURE_ARRAY) {</span>
 442     fail_type = _unloaded_ciobjarrayklass;
 443   } else {
 444     fail_type = _unloaded_ciinstance_klass;
 445   }
 446   Klass* found_klass;
 447   {
 448     ttyUnlocker ttyul;  // release tty lock to avoid ordering problems
 449     MutexLocker ml(Compile_lock);
 450     Klass* kls;
 451     if (!require_local) {
 452       kls = SystemDictionary::find_constrained_instance_or_array_klass(sym, loader,
 453                                                                        KILL_COMPILE_ON_FATAL_(fail_type));
 454     } else {
 455       kls = SystemDictionary::find_instance_or_array_klass(sym, loader, domain,
 456                                                            KILL_COMPILE_ON_FATAL_(fail_type));
 457     }
 458     found_klass = kls;
 459   }
 460 
 461   // If we fail to find an array klass, look again for its element type.
 462   // The element type may be available either locally or via constraints.
 463   // In either case, if we can find the element type in the system dictionary,
 464   // we must build an array type around it.  The CI requires array klasses
 465   // to be loaded if their element klasses are loaded, except when memory
 466   // is exhausted.
<span class="line-modified"> 467   if (Signature::is_array(sym) &amp;&amp;</span>
<span class="line-modified"> 468       (sym-&gt;char_at(1) == JVM_SIGNATURE_ARRAY || sym-&gt;char_at(1) == JVM_SIGNATURE_CLASS)) {</span>
 469     // We have an unloaded array.
 470     // Build it on the fly if the element class exists.
<span class="line-modified"> 471     SignatureStream ss(sym, false);</span>
<span class="line-modified"> 472     ss.skip_array_prefix(1);</span>


 473     // Get element ciKlass recursively.
 474     ciKlass* elem_klass =
 475       get_klass_by_name_impl(accessing_klass,
 476                              cpool,
<span class="line-modified"> 477                              get_symbol(ss.as_symbol()),</span>
 478                              require_local);
 479     if (elem_klass != NULL &amp;&amp; elem_klass-&gt;is_loaded()) {
 480       // Now make an array for it
 481       return ciObjArrayKlass::make_impl(elem_klass);
 482     }
 483   }
 484 
 485   if (found_klass == NULL &amp;&amp; !cpool.is_null() &amp;&amp; cpool-&gt;has_preresolution()) {
 486     // Look inside the constant pool for pre-resolved class entries.
 487     for (int i = cpool-&gt;length() - 1; i &gt;= 1; i--) {
 488       if (cpool-&gt;tag_at(i).is_klass()) {
 489         Klass* kls = cpool-&gt;resolved_klass_at(i);
 490         if (kls-&gt;name() == sym) {
 491           found_klass = kls;
 492           break;
 493         }
 494       }
 495     }
 496   }
 497 
</pre>
<hr />
<pre>
 533   if (cpool-&gt;tag_at(index).is_symbol()) {
 534     klass_name = cpool-&gt;symbol_at(index);
 535   } else {
 536     // Check if it&#39;s resolved if it&#39;s not a symbol constant pool entry.
 537     klass =  ConstantPool::klass_at_if_loaded(cpool, index);
 538     // Try to look it up by name.
 539     if (klass == NULL) {
 540       klass_name = cpool-&gt;klass_name_at(index);
 541     }
 542   }
 543 
 544   if (klass == NULL) {
 545     // Not found in constant pool.  Use the name to do the lookup.
 546     ciKlass* k = get_klass_by_name_impl(accessor,
 547                                         cpool,
 548                                         get_symbol(klass_name),
 549                                         false);
 550     // Calculate accessibility the hard way.
 551     if (!k-&gt;is_loaded()) {
 552       is_accessible = false;
<span class="line-modified"> 553     } else if (k-&gt;loader() != accessor-&gt;loader() &amp;&amp;</span>
 554                get_klass_by_name_impl(accessor, cpool, k-&gt;name(), true) == NULL) {
 555       // Loaded only remotely.  Not linked yet.
 556       is_accessible = false;
 557     } else {
 558       // Linked locally, and we must also check public/private, etc.
 559       is_accessible = check_klass_accessibility(accessor, k-&gt;get_Klass());
 560     }
 561     return k;
 562   }
 563 
 564   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 565   // can vary over time but the compiler needs consistency.
 566   ciSymbol* name = get_symbol(klass-&gt;name());
 567   ciKlass* unloaded_klass = check_get_unloaded_klass(accessor, name);
 568   if (unloaded_klass != NULL) {
 569     is_accessible = false;
 570     return unloaded_klass;
 571   }
 572 
 573   // It is known to be accessible, since it was found in the constant pool.
</pre>
<hr />
<pre>
 584                                    bool&amp; is_accessible,
 585                                    ciInstanceKlass* accessor) {
 586   GUARDED_VM_ENTRY(return get_klass_by_index_impl(cpool, index, is_accessible, accessor);)
 587 }
 588 
 589 // ------------------------------------------------------------------
 590 // ciEnv::get_constant_by_index_impl
 591 //
 592 // Implementation of get_constant_by_index().
 593 ciConstant ciEnv::get_constant_by_index_impl(const constantPoolHandle&amp; cpool,
 594                                              int pool_index, int cache_index,
 595                                              ciInstanceKlass* accessor) {
 596   bool ignore_will_link;
 597   EXCEPTION_CONTEXT;
 598   int index = pool_index;
 599   if (cache_index &gt;= 0) {
 600     assert(index &lt; 0, &quot;only one kind of index at a time&quot;);
 601     index = cpool-&gt;object_to_cp_index(cache_index);
 602     oop obj = cpool-&gt;resolved_references()-&gt;obj_at(cache_index);
 603     if (obj != NULL) {
<span class="line-modified"> 604       if (obj == Universe::the_null_sentinel()) {</span>
 605         return ciConstant(T_OBJECT, get_object(NULL));
 606       }
 607       BasicType bt = T_OBJECT;
 608       if (cpool-&gt;tag_at(index).is_dynamic_constant())
<span class="line-modified"> 609         bt = Signature::basic_type(cpool-&gt;uncached_signature_ref_at(index));</span>
 610       if (is_reference_type(bt)) {
 611       } else {
 612         // we have to unbox the primitive value
 613         if (!is_java_primitive(bt))  return ciConstant();
 614         jvalue value;
 615         BasicType bt2 = java_lang_boxing_object::get_value(obj, &amp;value);
 616         assert(bt2 == bt, &quot;&quot;);
 617         switch (bt2) {
 618         case T_DOUBLE:  return ciConstant(value.d);
 619         case T_FLOAT:   return ciConstant(value.f);
 620         case T_LONG:    return ciConstant(value.j);
 621         case T_INT:     return ciConstant(bt2, value.i);
 622         case T_SHORT:   return ciConstant(bt2, value.s);
 623         case T_BYTE:    return ciConstant(bt2, value.b);
 624         case T_CHAR:    return ciConstant(bt2, value.c);
 625         case T_BOOLEAN: return ciConstant(bt2, value.z);
 626         default:  return ciConstant();
 627         }
 628       }
 629       ciObject* ciobj = get_object(obj);
</pre>
<hr />
<pre>
 740                                    int index) {
 741   GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)
 742 }
 743 
 744 // ------------------------------------------------------------------
 745 // ciEnv::lookup_method
 746 //
 747 // Perform an appropriate method lookup based on accessor, holder,
 748 // name, signature, and bytecode.
 749 Method* ciEnv::lookup_method(ciInstanceKlass* accessor,
 750                              ciKlass*         holder,
 751                              Symbol*          name,
 752                              Symbol*          sig,
 753                              Bytecodes::Code  bc,
 754                              constantTag      tag) {
 755   // Accessibility checks are performed in ciEnv::get_method_by_index_impl.
 756   assert(check_klass_accessibility(accessor, holder-&gt;get_Klass()), &quot;holder not accessible&quot;);
 757 
 758   InstanceKlass* accessor_klass = accessor-&gt;get_instanceKlass();
 759   Klass* holder_klass = holder-&gt;get_Klass();
<span class="line-modified"> 760   Method* dest_method;</span>
 761   LinkInfo link_info(holder_klass, name, sig, accessor_klass, LinkInfo::needs_access_check, tag);
 762   switch (bc) {
 763   case Bytecodes::_invokestatic:
 764     dest_method =
 765       LinkResolver::resolve_static_call_or_null(link_info);
 766     break;
 767   case Bytecodes::_invokespecial:
 768     dest_method =
 769       LinkResolver::resolve_special_call_or_null(link_info);
 770     break;
 771   case Bytecodes::_invokeinterface:
 772     dest_method =
 773       LinkResolver::linktime_resolve_interface_method_or_null(link_info);
 774     break;
 775   case Bytecodes::_invokevirtual:
 776     dest_method =
 777       LinkResolver::linktime_resolve_virtual_method_or_null(link_info);
 778     break;
 779   default: ShouldNotReachHere();
 780   }
 781 
<span class="line-modified"> 782   return dest_method;</span>
 783 }
 784 
 785 
 786 // ------------------------------------------------------------------
 787 // ciEnv::get_method_by_index_impl
 788 ciMethod* ciEnv::get_method_by_index_impl(const constantPoolHandle&amp; cpool,
 789                                           int index, Bytecodes::Code bc,
 790                                           ciInstanceKlass* accessor) {
<span class="line-added"> 791   assert(cpool.not_null(), &quot;need constant pool&quot;);</span>
<span class="line-added"> 792   assert(accessor != NULL, &quot;need origin of access&quot;);</span>
 793   if (bc == Bytecodes::_invokedynamic) {
 794     ConstantPoolCacheEntry* cpce = cpool-&gt;invokedynamic_cp_cache_entry_at(index);
 795     bool is_resolved = !cpce-&gt;is_f1_null();
 796     // FIXME: code generation could allow for null (unlinked) call site
 797     // The call site could be made patchable as follows:
 798     // Load the appendix argument from the constant pool.
 799     // Test the appendix argument and jump to a known deopt routine if it is null.
 800     // Jump through a patchable call site, which is initially a deopt routine.
 801     // Patch the call site to the nmethod entry point of the static compiled lambda form.
 802     // As with other two-component call sites, both values must be independently verified.
 803 
 804     if (is_resolved) {
 805       // Get the invoker Method* from the constant pool.
 806       // (The appendix argument, if any, will be noted in the method&#39;s signature.)
 807       Method* adapter = cpce-&gt;f1_as_method();
 808       return get_method(adapter);
 809     }
 810 
 811     // Fake a method that is equivalent to a declared method.
 812     ciInstanceKlass* holder    = get_instance_klass(SystemDictionary::MethodHandle_klass());
</pre>
<hr />
<pre>
 913 char *ciEnv::name_buffer(int req_len) {
 914   if (_name_buffer_len &lt; req_len) {
 915     if (_name_buffer == NULL) {
 916       _name_buffer = (char*)arena()-&gt;Amalloc(sizeof(char)*req_len);
 917       _name_buffer_len = req_len;
 918     } else {
 919       _name_buffer =
 920         (char*)arena()-&gt;Arealloc(_name_buffer, _name_buffer_len, req_len);
 921       _name_buffer_len = req_len;
 922     }
 923   }
 924   return _name_buffer;
 925 }
 926 
 927 // ------------------------------------------------------------------
 928 // ciEnv::is_in_vm
 929 bool ciEnv::is_in_vm() {
 930   return JavaThread::current()-&gt;thread_state() == _thread_in_vm;
 931 }
 932 











 933 // ------------------------------------------------------------------
 934 // ciEnv::validate_compile_task_dependencies
 935 //
 936 // Check for changes during compilation (e.g. class loads, evolution,
 937 // breakpoints, call site invalidation).
 938 void ciEnv::validate_compile_task_dependencies(ciMethod* target) {
 939   if (failing())  return;  // no need for further checks
 940 
<span class="line-modified"> 941   Dependencies::DepType result = dependencies()-&gt;validate_dependencies(_task);</span>

 942   if (result != Dependencies::end_marker) {
 943     if (result == Dependencies::call_site_target_value) {
 944       _inc_decompile_count_on_failure = false;
 945       record_failure(&quot;call site target change&quot;);
 946     } else if (Dependencies::is_klass_type(result)) {
 947       record_failure(&quot;concurrent class loading&quot;);
 948     } else {
 949       record_failure(&quot;invalid non-klass dependency&quot;);
 950     }
 951   }
 952 }
 953 
 954 // ------------------------------------------------------------------
 955 // ciEnv::register_method
 956 void ciEnv::register_method(ciMethod* target,
 957                             int entry_bci,
 958                             CodeOffsets* offsets,
 959                             int orig_pc_offset,
 960                             CodeBuffer* code_buffer,
 961                             int frame_words,
 962                             OopMapSet* oop_map_set,
 963                             ExceptionHandlerTable* handler_table,
 964                             ImplicitExceptionTable* inc_table,
 965                             AbstractCompiler* compiler,
 966                             bool has_unsafe_access,
 967                             bool has_wide_vectors,
 968                             RTMState  rtm_state) {
 969   VM_ENTRY_MARK;
 970   nmethod* nm = NULL;
 971   {
 972     // To prevent compile queue updates.
<span class="line-modified"> 973     MutexLocker locker(THREAD, MethodCompileQueue_lock);</span>
 974 
 975     // Prevent SystemDictionary::add_to_hierarchy from running
 976     // and invalidating our dependencies until we install this method.
 977     // No safepoints are allowed. Otherwise, class redefinition can occur in between.
 978     MutexLocker ml(Compile_lock);
 979     NoSafepointVerifier nsv;
 980 
 981     // Change in Jvmti state may invalidate compilation.
 982     if (!failing() &amp;&amp; jvmti_state_changed()) {
 983       record_failure(&quot;Jvmti state change invalidated dependencies&quot;);
 984     }
 985 
 986     // Change in DTrace flags may invalidate compilation.
 987     if (!failing() &amp;&amp;
 988         ( (!dtrace_extended_probes() &amp;&amp; ExtendedDTraceProbes) ||
 989           (!dtrace_method_probes() &amp;&amp; DTraceMethodProbes) ||
 990           (!dtrace_alloc_probes() &amp;&amp; DTraceAllocProbes) )) {
 991       record_failure(&quot;DTrace flags change invalidated dependencies&quot;);
 992     }
 993 
<span class="line-added"> 994     if (!failing() &amp;&amp; target-&gt;needs_clinit_barrier() &amp;&amp;</span>
<span class="line-added"> 995         target-&gt;holder()-&gt;is_in_error_state()) {</span>
<span class="line-added"> 996       record_failure(&quot;method holder is in error state&quot;);</span>
<span class="line-added"> 997     }</span>
<span class="line-added"> 998 </span>
 999     if (!failing()) {
1000       if (log() != NULL) {
1001         // Log the dependencies which this compilation declares.
1002         dependencies()-&gt;log_all_dependencies();
1003       }
1004 
1005       // Encode the dependencies now, so we can check them right away.
1006       dependencies()-&gt;encode_content_bytes();
1007 
1008       // Check for {class loads, evolution, breakpoints, ...} during compilation
1009       validate_compile_task_dependencies(target);
1010     }
1011 
1012     methodHandle method(THREAD, target-&gt;get_Method());
1013 
1014 #if INCLUDE_RTM_OPT
1015     if (!failing() &amp;&amp; (rtm_state != NoRTM) &amp;&amp;
1016         (method()-&gt;method_data() != NULL) &amp;&amp;
1017         (method()-&gt;method_data()-&gt;rtm_state() != rtm_state)) {
1018       // Preemptive decompile if rtm state was changed.
</pre>
<hr />
<pre>
1059 
1060       // Record successful registration.
1061       // (Put nm into the task handle *before* publishing to the Java heap.)
1062       if (task() != NULL) {
1063         task()-&gt;set_code(nm);
1064       }
1065 
1066       if (entry_bci == InvocationEntryBci) {
1067         if (TieredCompilation) {
1068           // If there is an old version we&#39;re done with it
1069           CompiledMethod* old = method-&gt;code();
1070           if (TraceMethodReplacement &amp;&amp; old != NULL) {
1071             ResourceMark rm;
1072             char *method_name = method-&gt;name_and_sig_as_C_string();
1073             tty-&gt;print_cr(&quot;Replacing method %s&quot;, method_name);
1074           }
1075           if (old != NULL) {
1076             old-&gt;make_not_used();
1077           }
1078         }
<span class="line-modified">1079 </span>
<span class="line-added">1080         LogTarget(Info, nmethod, install) lt;</span>
<span class="line-added">1081         if (lt.is_enabled()) {</span>
1082           ResourceMark rm;
1083           char *method_name = method-&gt;name_and_sig_as_C_string();
<span class="line-modified">1084           lt.print(&quot;Installing method (%d) %s &quot;,</span>
<span class="line-modified">1085                     task()-&gt;comp_level(), method_name);</span>


1086         }
1087         // Allow the code to be executed
<span class="line-modified">1088         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-added">1089         if (nm-&gt;make_in_use()) {</span>
<span class="line-added">1090           method-&gt;set_code(method, nm);</span>
<span class="line-added">1091         }</span>
1092       } else {
<span class="line-modified">1093         LogTarget(Info, nmethod, install) lt;</span>
<span class="line-added">1094         if (lt.is_enabled()) {</span>
1095           ResourceMark rm;
1096           char *method_name = method-&gt;name_and_sig_as_C_string();
<span class="line-modified">1097           lt.print(&quot;Installing osr method (%d) %s @ %d&quot;,</span>
<span class="line-modified">1098                     task()-&gt;comp_level(), method_name, entry_bci);</span>
<span class="line-modified">1099         }</span>
<span class="line-modified">1100         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-modified">1101         if (nm-&gt;make_in_use()) {</span>
<span class="line-added">1102           method-&gt;method_holder()-&gt;add_osr_nmethod(nm);</span>
1103         }

1104       }

1105     }
1106   }  // safepoints are allowed again
1107 
1108   if (nm != NULL) {
1109     // JVMTI -- compiled method notification (must be done outside lock)
1110     nm-&gt;post_compiled_method_load_event();
1111   } else {
1112     // The CodeCache is full.
1113     record_failure(&quot;code cache is full&quot;);
1114   }
1115 }
1116 
1117 
1118 // ------------------------------------------------------------------
1119 // ciEnv::find_system_klass
1120 ciKlass* ciEnv::find_system_klass(ciSymbol* klass_name) {
1121   VM_ENTRY_MARK;
1122   return get_klass_by_name_impl(NULL, constantPoolHandle(), klass_name, false);
1123 }
1124 
</pre>
</td>
</tr>
</table>
<center><a href="ciConstant.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciEnv.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>