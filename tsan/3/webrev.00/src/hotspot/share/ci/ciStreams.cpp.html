<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/ci/ciStreams.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;ci/ciCallSite.hpp&quot;
 27 #include &quot;ci/ciConstant.hpp&quot;
 28 #include &quot;ci/ciField.hpp&quot;
 29 #include &quot;ci/ciStreams.hpp&quot;
 30 #include &quot;ci/ciUtilities.inline.hpp&quot;
 31 #include &quot;runtime/handles.inline.hpp&quot;
 32 
 33 // ciExceptionHandlerStream
 34 //
 35 // Walk over some selected set of a methods exception handlers.
 36 
 37 // ------------------------------------------------------------------
 38 // ciExceptionHandlerStream::count
 39 //
 40 // How many exception handlers are there in this stream?
 41 //
 42 // Implementation note: Compiler2 needs this functionality, so I had
 43 int ciExceptionHandlerStream::count() {
 44   int save_pos = _pos;
 45   int save_end = _end;
 46 
 47   int count = 0;
 48 
 49   _pos = -1;
 50   _end = _method-&gt;_handler_count;
 51 
 52 
 53   next();
 54   while (!is_done()) {
 55     count++;
 56     next();
 57   }
 58 
 59   _pos = save_pos;
 60   _end = save_end;
 61 
 62   return count;
 63 }
 64 
 65 int ciExceptionHandlerStream::count_remaining() {
 66   int save_pos = _pos;
 67   int save_end = _end;
 68 
 69   int count = 0;
 70 
 71   while (!is_done()) {
 72     count++;
 73     next();
 74   }
 75 
 76   _pos = save_pos;
 77   _end = save_end;
 78 
 79   return count;
 80 }
 81 
 82 // ciBytecodeStream
 83 //
 84 // The class is used to iterate over the bytecodes of a method.
 85 // It hides the details of constant pool structure/access by
 86 // providing accessors for constant pool items.
 87 
 88 // ------------------------------------------------------------------
 89 // ciBytecodeStream::next_wide_or_table
 90 //
 91 // Special handling for switch ops
 92 Bytecodes::Code ciBytecodeStream::next_wide_or_table(Bytecodes::Code bc) {
 93   switch (bc) {                // Check for special bytecode handling
 94   case Bytecodes::_wide:
 95     // Special handling for the wide bytcode
 96     // Get following bytecode; do not return wide
 97     assert(Bytecodes::Code(_pc[0]) == Bytecodes::_wide, &quot;&quot;);
 98     bc = Bytecodes::java_code(_raw_bc = (Bytecodes::Code)_pc[1]);
 99     assert(Bytecodes::wide_length_for(bc) &gt; 2, &quot;must make progress&quot;);
100     _pc += Bytecodes::wide_length_for(bc);
101     _was_wide = _pc;              // Flag last wide bytecode found
102     assert(is_wide(), &quot;accessor works right&quot;);
103     break;
104 
105   case Bytecodes::_lookupswitch:
106     _pc++;                      // Skip wide bytecode
107     _pc += (_start-_pc)&amp;3;      // Word align
108     _table_base = (jint*)_pc;   // Capture for later usage
109                                 // table_base[0] is default far_dest
110     // Table has 2 lead elements (default, length), then pairs of u4 values.
111     // So load table length, and compute address at end of table
112     _pc = (address)&amp;_table_base[2+ 2*Bytes::get_Java_u4((address)&amp;_table_base[1])];
113     break;
114 
115   case Bytecodes::_tableswitch: {
116     _pc++;                      // Skip wide bytecode
117     _pc += (_start-_pc)&amp;3;      // Word align
118     _table_base = (jint*)_pc;   // Capture for later usage
119                                 // table_base[0] is default far_dest
120     int lo = Bytes::get_Java_u4((address)&amp;_table_base[1]);// Low bound
121     int hi = Bytes::get_Java_u4((address)&amp;_table_base[2]);// High bound
122     int len = hi - lo + 1;      // Dense table size
123     _pc = (address)&amp;_table_base[3+len]; // Skip past table
124     break;
125   }
126 
127   default:
128     fatal(&quot;unhandled bytecode&quot;);
129   }
130   return bc;
131 }
132 
133 // ------------------------------------------------------------------
134 // ciBytecodeStream::reset_to_bci
135 void ciBytecodeStream::reset_to_bci( int bci ) {
136   _bc_start=_was_wide=0;
137   _pc = _start+bci;
138 }
139 
140 // ------------------------------------------------------------------
141 // ciBytecodeStream::force_bci
142 void ciBytecodeStream::force_bci(int bci) {
143   if (bci &lt; 0) {
144     reset_to_bci(0);
145     _bc_start = _start + bci;
146     _bc = EOBC();
147   } else {
148     reset_to_bci(bci);
149     next();
150   }
151 }
152 
153 
154 // ------------------------------------------------------------------
155 // Constant pool access
156 // ------------------------------------------------------------------
157 
158 // ------------------------------------------------------------------
159 // ciBytecodeStream::get_klass_index
160 //
161 // If this bytecodes references a klass, return the index of the
162 // referenced klass.
163 int ciBytecodeStream::get_klass_index() const {
164   switch(cur_bc()) {
165   case Bytecodes::_ldc:
166     return get_index_u1();
167   case Bytecodes::_ldc_w:
168   case Bytecodes::_ldc2_w:
169   case Bytecodes::_checkcast:
170   case Bytecodes::_instanceof:
171   case Bytecodes::_anewarray:
172   case Bytecodes::_multianewarray:
173   case Bytecodes::_new:
174   case Bytecodes::_newarray:
175     return get_index_u2();
176   default:
177     ShouldNotReachHere();
178     return 0;
179   }
180 }
181 
182 // ------------------------------------------------------------------
183 // ciBytecodeStream::get_klass
184 //
185 // If this bytecode is a new, newarray, multianewarray, instanceof,
186 // or checkcast, get the referenced klass.
187 ciKlass* ciBytecodeStream::get_klass(bool&amp; will_link) {
188   VM_ENTRY_MARK;
189   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
190   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_klass_index(), will_link, _holder);
191 }
192 
193 // ------------------------------------------------------------------
194 // ciBytecodeStream::get_constant_raw_index
195 //
196 // If this bytecode is one of the ldc variants, get the index of the
197 // referenced constant.
198 int ciBytecodeStream::get_constant_raw_index() const {
199   // work-alike for Bytecode_loadconstant::raw_index()
200   switch (cur_bc()) {
201   case Bytecodes::_ldc:
202     return get_index_u1();
203   case Bytecodes::_ldc_w:
204   case Bytecodes::_ldc2_w:
205     return get_index_u2();
206   default:
207     ShouldNotReachHere();
208     return 0;
209   }
210 }
211 
212 // ------------------------------------------------------------------
213 // ciBytecodeStream::get_constant_pool_index
214 // Decode any reference index into a regular pool index.
215 int ciBytecodeStream::get_constant_pool_index() const {
216   // work-alike for Bytecode_loadconstant::pool_index()
217   int index = get_constant_raw_index();
218   if (has_cache_index()) {
219     VM_ENTRY_MARK;
220     constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
221     return cpool-&gt;object_to_cp_index(index);
222   }
223   return index;
224 }
225 
226 // ------------------------------------------------------------------
227 // ciBytecodeStream::get_constant
228 //
229 // If this bytecode is one of the ldc variants, get the referenced
230 // constant.
231 ciConstant ciBytecodeStream::get_constant() {
232   int pool_index = get_constant_raw_index();
233   int cache_index = -1;
234   if (has_cache_index()) {
235     cache_index = pool_index;
236     pool_index = -1;
237   }
238   VM_ENTRY_MARK;
239   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
240   return CURRENT_ENV-&gt;get_constant_by_index(cpool, pool_index, cache_index, _holder);
241 }
242 
243 // ------------------------------------------------------------------
244 // ciBytecodeStream::get_constant_pool_tag
245 //
246 // If this bytecode is one of the ldc variants, get the referenced
247 // constant.
248 constantTag ciBytecodeStream::get_constant_pool_tag(int index) const {
249   VM_ENTRY_MARK;
250   return _method-&gt;get_Method()-&gt;constants()-&gt;constant_tag_at(index);
251 }
252 
253 // ------------------------------------------------------------------
254 // ciBytecodeStream::get_field_index
255 //
256 // If this is a field access bytecode, get the constant pool
257 // index of the referenced field.
258 int ciBytecodeStream::get_field_index() {
259   assert(cur_bc() == Bytecodes::_getfield ||
260          cur_bc() == Bytecodes::_putfield ||
261          cur_bc() == Bytecodes::_getstatic ||
262          cur_bc() == Bytecodes::_putstatic, &quot;wrong bc&quot;);
263   return get_index_u2_cpcache();
264 }
265 
266 
267 // ------------------------------------------------------------------
268 // ciBytecodeStream::get_field
269 //
270 // If this bytecode is one of get_field, get_static, put_field,
271 // or put_static, get the referenced field.
272 ciField* ciBytecodeStream::get_field(bool&amp; will_link) {
273   ciField* f = CURRENT_ENV-&gt;get_field_by_index(_holder, get_field_index());
274   will_link = f-&gt;will_link(_method, _bc);
275   return f;
276 }
277 
278 
279 // ------------------------------------------------------------------
280 // ciBytecodeStream::get_declared_field_holder
281 //
282 // Get the declared holder of the currently referenced field.
283 //
284 // Usage note: the holder() of a ciField class returns the canonical
285 // holder of the field, rather than the holder declared in the
286 // bytecodes.
287 //
288 // There is no &quot;will_link&quot; result passed back.  The user is responsible
289 // for checking linkability when retrieving the associated field.
290 ciInstanceKlass* ciBytecodeStream::get_declared_field_holder() {
291   VM_ENTRY_MARK;
292   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
293   int holder_index = get_field_holder_index();
294   bool ignore;
295   return CURRENT_ENV-&gt;get_klass_by_index(cpool, holder_index, ignore, _holder)
296       -&gt;as_instance_klass();
297 }
298 
299 // ------------------------------------------------------------------
300 // ciBytecodeStream::get_field_holder_index
301 //
302 // Get the constant pool index of the declared holder of the field
303 // referenced by the current bytecode.  Used for generating
304 // deoptimization information.
305 int ciBytecodeStream::get_field_holder_index() {
306   GUARDED_VM_ENTRY(
307     ConstantPool* cpool = _holder-&gt;get_instanceKlass()-&gt;constants();
308     return cpool-&gt;klass_ref_index_at(get_field_index());
309   )
310 }
311 
312 // ------------------------------------------------------------------
313 // ciBytecodeStream::get_method_index
314 //
315 // If this is a method invocation bytecode, get the constant pool
316 // index of the invoked method.
317 int ciBytecodeStream::get_method_index() {
318   assert(Bytecodes::is_invoke(cur_bc()), &quot;invalid bytecode: %s&quot;, Bytecodes::name(cur_bc()));
319   if (has_index_u4())
320     return get_index_u4();  // invokedynamic
321   return get_index_u2_cpcache();
322 }
323 
324 // ------------------------------------------------------------------
325 // ciBytecodeStream::get_method
326 //
327 // If this is a method invocation bytecode, get the invoked method.
328 // Additionally return the declared signature to get more concrete
329 // type information if required (Cf. invokedynamic and invokehandle).
330 ciMethod* ciBytecodeStream::get_method(bool&amp; will_link, ciSignature* *declared_signature_result) {
331   VM_ENTRY_MARK;
332   ciEnv* env = CURRENT_ENV;
333   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
334   ciMethod* m = env-&gt;get_method_by_index(cpool, get_method_index(), cur_bc(), _holder);
335   will_link = m-&gt;is_loaded();
336 
337   // Use the signature stored in the CP cache to create a signature
338   // with correct types (in respect to class loaders).
339   //
340   // In classic Java (before Java 7) there is never the slightest
341   // difference between the signature at the call site and that of the
342   // method.  Such a difference would have been a type error in the
343   // JVM.
344   //
345   // Now there are a few circumstances where the signature of a call
346   // site (which controls the outgoing stacked arguments) can differ
347   // from the signature of the method (which controls the receipt of
348   // those arguments at the method entry point).
349   //
350   // A. The signatures can differ if the callee is a static method and
351   // the caller thinks it is calling a non-static method (VH.get).
352   // This requires the method signature to have an explicit leading
353   // argument for the implicit &#39;this&#39;, not present at the call site.
354   //
355   // B. The call site can have less specific parameter types than the
356   // method, allowing loosely-typed code to handle strongly-typed
357   // methods.  This happens with linkToStatic and related linker
358   // commands.  Obviously the loosely-typed code has to ensure that
359   // the strongly typed method&#39;s invariants are respected, and this is
360   // done by issuing dynamic casts.
361   //
362   // C. The call site can have more specific parameter types than the
363   // method, allowing loosely-typed methods to handle strongly-typed
364   // requests.
365   //
366   // D. There are corresponding effects with return values, such as
367   // boolean method returning an int to an int-receiving call site,
368   // even though the method thought it returned just a boolean.
369   //
370   // E. The calling sequence at a particular call site may add an
371   // &quot;appendix&quot; argument not mentioned in the call site signature.  It
372   // is expected by the method signature, though, and this adds to the
373   // method&#39;s arity, even after &#39;this&#39; parameter effects (A) are
374   // discounted.  Appendixes are used by invokehandle and
375   // invokedynamic instructions.
376   //
377   // F. A linker method (linkToStatic, etc.) can also take an extra
378   // argument, a MemberName which routes the call to a concrete
379   // strongly-typed method.  In this case the linker method may also
380   // differ in any of the ways A-D.  The eventual method will ignore
381   // the presence of the extra argument.
382   //
383   // None of these changes to calling sequences requires an argument
384   // to be moved or reformatted in any way.  This works because all
385   // references look alike to the JVM, as do all primitives (except
386   // float/long/double).  Another required property of the JVM is
387   // that, if a trailing argument is added or dropped, the placement
388   // of other arguments does not change.  This allows cases E and F to
389   // work smoothly, against without any moving or reformatting,
390   // despite the arity change.
391   //
392   if (has_local_signature()) {
393     Symbol* local_signature = cpool-&gt;symbol_at(get_method_signature_index(cpool));
394     ciSymbol* sig_sym  = env-&gt;get_symbol(local_signature);
395     ciKlass* pool_holder = env-&gt;get_klass(cpool-&gt;pool_holder());
396     ciSignature* call_site_sig = new (env-&gt;arena()) ciSignature(pool_holder, cpool, sig_sym);
397     // Examples of how the call site signature can differ from the method&#39;s own signature:
398     //
399     //  meth = static jboolean java.lang.invoke.VarHandleGuards.guard_LII_Z(jobject, jobject, jint, jint, jobject)
400     //  msig = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;IILjava/lang/invoke/VarHandle$AccessDescriptor;)Z
401     //  call = (Ljava/util/concurrent/locks/AbstractQueuedSynchronizer;II)Z
402     //
403     //  meth = static jobject java.lang.invoke.LambdaForm$MH/0x0000000800066840.linkToTargetMethod(jobject, jobject)
404     //  msig = (Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
405     //  call = (Ljava/lang/String;)Ljava/util/function/Predicate;
406     //
407     (*declared_signature_result) = call_site_sig;
408 
409   } else {
410     // We can just use the method&#39;s own signature.  It may differ from the call site, but not by much.
411     //
412     // Examples of how the call site signature can differ from the method&#39;s signature:
413     //
414     // meth = static final native jint java.lang.invoke.MethodHandle.linkToStatic(jobject, jobject, jint, jint, jobject)
415     // msig = (Ljava/lang/Object;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)I
416     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)Z
417     //
418     // meth = final native jint java.lang.invoke.MethodHandle.invokeBasic(jobject, jobject, jint, jint)
419     // msig = (Ljava/lang/Object;Ljava/lang/Object;II)I
420     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;II)Z
421     //
422     (*declared_signature_result) = m-&gt;signature();
423   }
424   return m;
425 }
426 
427 // ------------------------------------------------------------------
428 // ciBytecodeStream::has_appendix
429 //
430 // Returns true if there is an appendix argument stored in the
431 // constant pool cache at the current bci.
432 bool ciBytecodeStream::has_appendix() {
433   VM_ENTRY_MARK;
434   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
435   return ConstantPool::has_appendix_at_if_loaded(cpool, get_method_index());
436 }
437 
438 // ------------------------------------------------------------------
439 // ciBytecodeStream::get_appendix
440 //
441 // Return the appendix argument stored in the constant pool cache at
442 // the current bci.
443 ciObject* ciBytecodeStream::get_appendix() {
444   VM_ENTRY_MARK;
445   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
446   oop appendix_oop = ConstantPool::appendix_at_if_loaded(cpool, get_method_index());
447   return CURRENT_ENV-&gt;get_object(appendix_oop);
448 }
449 
450 // ------------------------------------------------------------------
451 // ciBytecodeStream::has_local_signature
452 //
453 // Returns true if the method stored in the constant
454 // pool cache at the current bci has a local signature.
455 bool ciBytecodeStream::has_local_signature() {
456   GUARDED_VM_ENTRY(
457     constantPoolHandle cpool(Thread::current(), _method-&gt;get_Method()-&gt;constants());
458     return ConstantPool::has_local_signature_at_if_loaded(cpool, get_method_index());
459   )
460 }
461 
462 // ------------------------------------------------------------------
463 // ciBytecodeStream::get_declared_method_holder
464 //
465 // Get the declared holder of the currently referenced method.
466 //
467 // Usage note: the holder() of a ciMethod class returns the canonical
468 // holder of the method, rather than the holder declared in the
469 // bytecodes.
470 //
471 // There is no &quot;will_link&quot; result passed back.  The user is responsible
472 // for checking linkability when retrieving the associated method.
473 ciKlass* ciBytecodeStream::get_declared_method_holder() {
474   VM_ENTRY_MARK;
475   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());
476   bool ignore;
477   // report as MethodHandle for invokedynamic, which is syntactically classless
478   if (cur_bc() == Bytecodes::_invokedynamic)
479     return CURRENT_ENV-&gt;get_klass_by_name(_holder, ciSymbol::java_lang_invoke_MethodHandle(), false);
480   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_method_holder_index(), ignore, _holder);
481 }
482 
483 // ------------------------------------------------------------------
484 // ciBytecodeStream::get_method_holder_index
485 //
486 // Get the constant pool index of the declared holder of the method
487 // referenced by the current bytecode.  Used for generating
488 // deoptimization information.
489 int ciBytecodeStream::get_method_holder_index() {
490   ConstantPool* cpool = _method-&gt;get_Method()-&gt;constants();
491   return cpool-&gt;klass_ref_index_at(get_method_index());
492 }
493 
494 // ------------------------------------------------------------------
495 // ciBytecodeStream::get_method_signature_index
496 //
497 // Get the constant pool index of the signature of the method
498 // referenced by the current bytecode.  Used for generating
499 // deoptimization information.
500 int ciBytecodeStream::get_method_signature_index(const constantPoolHandle&amp; cpool) {
501   GUARDED_VM_ENTRY(
502     const int method_index = get_method_index();
503     const int name_and_type_index = cpool-&gt;name_and_type_ref_index_at(method_index);
504     return cpool-&gt;signature_ref_index_at(name_and_type_index);
505   )
506 }
507 
    </pre>
  </body>
</html>