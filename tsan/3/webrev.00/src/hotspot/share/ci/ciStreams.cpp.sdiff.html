<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/ci/ciStreams.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ciSignature.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciSymbol.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/ci/ciStreams.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
169   case Bytecodes::_checkcast:
170   case Bytecodes::_instanceof:
171   case Bytecodes::_anewarray:
172   case Bytecodes::_multianewarray:
173   case Bytecodes::_new:
174   case Bytecodes::_newarray:
175     return get_index_u2();
176   default:
177     ShouldNotReachHere();
178     return 0;
179   }
180 }
181 
182 // ------------------------------------------------------------------
183 // ciBytecodeStream::get_klass
184 //
185 // If this bytecode is a new, newarray, multianewarray, instanceof,
186 // or checkcast, get the referenced klass.
187 ciKlass* ciBytecodeStream::get_klass(bool&amp; will_link) {
188   VM_ENTRY_MARK;
<span class="line-modified">189   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
190   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_klass_index(), will_link, _holder);
191 }
192 
193 // ------------------------------------------------------------------
194 // ciBytecodeStream::get_constant_raw_index
195 //
196 // If this bytecode is one of the ldc variants, get the index of the
197 // referenced constant.
198 int ciBytecodeStream::get_constant_raw_index() const {
199   // work-alike for Bytecode_loadconstant::raw_index()
200   switch (cur_bc()) {
201   case Bytecodes::_ldc:
202     return get_index_u1();
203   case Bytecodes::_ldc_w:
204   case Bytecodes::_ldc2_w:
205     return get_index_u2();
206   default:
207     ShouldNotReachHere();
208     return 0;
209   }
210 }
211 
212 // ------------------------------------------------------------------
213 // ciBytecodeStream::get_constant_pool_index
214 // Decode any reference index into a regular pool index.
215 int ciBytecodeStream::get_constant_pool_index() const {
216   // work-alike for Bytecode_loadconstant::pool_index()
217   int index = get_constant_raw_index();
218   if (has_cache_index()) {
219     VM_ENTRY_MARK;
<span class="line-modified">220     constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
221     return cpool-&gt;object_to_cp_index(index);
222   }
223   return index;
224 }
225 
226 // ------------------------------------------------------------------
227 // ciBytecodeStream::get_constant
228 //
229 // If this bytecode is one of the ldc variants, get the referenced
230 // constant.
231 ciConstant ciBytecodeStream::get_constant() {
232   int pool_index = get_constant_raw_index();
233   int cache_index = -1;
234   if (has_cache_index()) {
235     cache_index = pool_index;
236     pool_index = -1;
237   }
238   VM_ENTRY_MARK;
<span class="line-modified">239   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
240   return CURRENT_ENV-&gt;get_constant_by_index(cpool, pool_index, cache_index, _holder);
241 }
242 
243 // ------------------------------------------------------------------
244 // ciBytecodeStream::get_constant_pool_tag
245 //
246 // If this bytecode is one of the ldc variants, get the referenced
247 // constant.
248 constantTag ciBytecodeStream::get_constant_pool_tag(int index) const {
249   VM_ENTRY_MARK;
250   return _method-&gt;get_Method()-&gt;constants()-&gt;constant_tag_at(index);
251 }
252 
253 // ------------------------------------------------------------------
254 // ciBytecodeStream::get_field_index
255 //
256 // If this is a field access bytecode, get the constant pool
257 // index of the referenced field.
258 int ciBytecodeStream::get_field_index() {
259   assert(cur_bc() == Bytecodes::_getfield ||
</pre>
<hr />
<pre>
272 ciField* ciBytecodeStream::get_field(bool&amp; will_link) {
273   ciField* f = CURRENT_ENV-&gt;get_field_by_index(_holder, get_field_index());
274   will_link = f-&gt;will_link(_method, _bc);
275   return f;
276 }
277 
278 
279 // ------------------------------------------------------------------
280 // ciBytecodeStream::get_declared_field_holder
281 //
282 // Get the declared holder of the currently referenced field.
283 //
284 // Usage note: the holder() of a ciField class returns the canonical
285 // holder of the field, rather than the holder declared in the
286 // bytecodes.
287 //
288 // There is no &quot;will_link&quot; result passed back.  The user is responsible
289 // for checking linkability when retrieving the associated field.
290 ciInstanceKlass* ciBytecodeStream::get_declared_field_holder() {
291   VM_ENTRY_MARK;
<span class="line-modified">292   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
293   int holder_index = get_field_holder_index();
294   bool ignore;
295   return CURRENT_ENV-&gt;get_klass_by_index(cpool, holder_index, ignore, _holder)
296       -&gt;as_instance_klass();
297 }
298 
299 // ------------------------------------------------------------------
300 // ciBytecodeStream::get_field_holder_index
301 //
302 // Get the constant pool index of the declared holder of the field
303 // referenced by the current bytecode.  Used for generating
304 // deoptimization information.
305 int ciBytecodeStream::get_field_holder_index() {
306   GUARDED_VM_ENTRY(
307     ConstantPool* cpool = _holder-&gt;get_instanceKlass()-&gt;constants();
308     return cpool-&gt;klass_ref_index_at(get_field_index());
309   )
310 }
311 
312 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
414     // meth = static final native jint java.lang.invoke.MethodHandle.linkToStatic(jobject, jobject, jint, jint, jobject)
415     // msig = (Ljava/lang/Object;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)I
416     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)Z
417     //
418     // meth = final native jint java.lang.invoke.MethodHandle.invokeBasic(jobject, jobject, jint, jint)
419     // msig = (Ljava/lang/Object;Ljava/lang/Object;II)I
420     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;II)Z
421     //
422     (*declared_signature_result) = m-&gt;signature();
423   }
424   return m;
425 }
426 
427 // ------------------------------------------------------------------
428 // ciBytecodeStream::has_appendix
429 //
430 // Returns true if there is an appendix argument stored in the
431 // constant pool cache at the current bci.
432 bool ciBytecodeStream::has_appendix() {
433   VM_ENTRY_MARK;
<span class="line-modified">434   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
435   return ConstantPool::has_appendix_at_if_loaded(cpool, get_method_index());
436 }
437 
438 // ------------------------------------------------------------------
439 // ciBytecodeStream::get_appendix
440 //
441 // Return the appendix argument stored in the constant pool cache at
442 // the current bci.
443 ciObject* ciBytecodeStream::get_appendix() {
444   VM_ENTRY_MARK;
<span class="line-modified">445   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
446   oop appendix_oop = ConstantPool::appendix_at_if_loaded(cpool, get_method_index());
447   return CURRENT_ENV-&gt;get_object(appendix_oop);
448 }
449 
450 // ------------------------------------------------------------------
451 // ciBytecodeStream::has_local_signature
452 //
453 // Returns true if the method stored in the constant
454 // pool cache at the current bci has a local signature.
455 bool ciBytecodeStream::has_local_signature() {
456   GUARDED_VM_ENTRY(
<span class="line-modified">457     constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
458     return ConstantPool::has_local_signature_at_if_loaded(cpool, get_method_index());
459   )
460 }
461 
462 // ------------------------------------------------------------------
463 // ciBytecodeStream::get_declared_method_holder
464 //
465 // Get the declared holder of the currently referenced method.
466 //
467 // Usage note: the holder() of a ciMethod class returns the canonical
468 // holder of the method, rather than the holder declared in the
469 // bytecodes.
470 //
471 // There is no &quot;will_link&quot; result passed back.  The user is responsible
472 // for checking linkability when retrieving the associated method.
473 ciKlass* ciBytecodeStream::get_declared_method_holder() {
474   VM_ENTRY_MARK;
<span class="line-modified">475   constantPoolHandle cpool(_method-&gt;get_Method()-&gt;constants());</span>
476   bool ignore;
477   // report as MethodHandle for invokedynamic, which is syntactically classless
478   if (cur_bc() == Bytecodes::_invokedynamic)
479     return CURRENT_ENV-&gt;get_klass_by_name(_holder, ciSymbol::java_lang_invoke_MethodHandle(), false);
480   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_method_holder_index(), ignore, _holder);
481 }
482 
483 // ------------------------------------------------------------------
484 // ciBytecodeStream::get_method_holder_index
485 //
486 // Get the constant pool index of the declared holder of the method
487 // referenced by the current bytecode.  Used for generating
488 // deoptimization information.
489 int ciBytecodeStream::get_method_holder_index() {
490   ConstantPool* cpool = _method-&gt;get_Method()-&gt;constants();
491   return cpool-&gt;klass_ref_index_at(get_method_index());
492 }
493 
494 // ------------------------------------------------------------------
495 // ciBytecodeStream::get_method_signature_index
</pre>
</td>
<td>
<hr />
<pre>
169   case Bytecodes::_checkcast:
170   case Bytecodes::_instanceof:
171   case Bytecodes::_anewarray:
172   case Bytecodes::_multianewarray:
173   case Bytecodes::_new:
174   case Bytecodes::_newarray:
175     return get_index_u2();
176   default:
177     ShouldNotReachHere();
178     return 0;
179   }
180 }
181 
182 // ------------------------------------------------------------------
183 // ciBytecodeStream::get_klass
184 //
185 // If this bytecode is a new, newarray, multianewarray, instanceof,
186 // or checkcast, get the referenced klass.
187 ciKlass* ciBytecodeStream::get_klass(bool&amp; will_link) {
188   VM_ENTRY_MARK;
<span class="line-modified">189   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
190   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_klass_index(), will_link, _holder);
191 }
192 
193 // ------------------------------------------------------------------
194 // ciBytecodeStream::get_constant_raw_index
195 //
196 // If this bytecode is one of the ldc variants, get the index of the
197 // referenced constant.
198 int ciBytecodeStream::get_constant_raw_index() const {
199   // work-alike for Bytecode_loadconstant::raw_index()
200   switch (cur_bc()) {
201   case Bytecodes::_ldc:
202     return get_index_u1();
203   case Bytecodes::_ldc_w:
204   case Bytecodes::_ldc2_w:
205     return get_index_u2();
206   default:
207     ShouldNotReachHere();
208     return 0;
209   }
210 }
211 
212 // ------------------------------------------------------------------
213 // ciBytecodeStream::get_constant_pool_index
214 // Decode any reference index into a regular pool index.
215 int ciBytecodeStream::get_constant_pool_index() const {
216   // work-alike for Bytecode_loadconstant::pool_index()
217   int index = get_constant_raw_index();
218   if (has_cache_index()) {
219     VM_ENTRY_MARK;
<span class="line-modified">220     constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
221     return cpool-&gt;object_to_cp_index(index);
222   }
223   return index;
224 }
225 
226 // ------------------------------------------------------------------
227 // ciBytecodeStream::get_constant
228 //
229 // If this bytecode is one of the ldc variants, get the referenced
230 // constant.
231 ciConstant ciBytecodeStream::get_constant() {
232   int pool_index = get_constant_raw_index();
233   int cache_index = -1;
234   if (has_cache_index()) {
235     cache_index = pool_index;
236     pool_index = -1;
237   }
238   VM_ENTRY_MARK;
<span class="line-modified">239   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
240   return CURRENT_ENV-&gt;get_constant_by_index(cpool, pool_index, cache_index, _holder);
241 }
242 
243 // ------------------------------------------------------------------
244 // ciBytecodeStream::get_constant_pool_tag
245 //
246 // If this bytecode is one of the ldc variants, get the referenced
247 // constant.
248 constantTag ciBytecodeStream::get_constant_pool_tag(int index) const {
249   VM_ENTRY_MARK;
250   return _method-&gt;get_Method()-&gt;constants()-&gt;constant_tag_at(index);
251 }
252 
253 // ------------------------------------------------------------------
254 // ciBytecodeStream::get_field_index
255 //
256 // If this is a field access bytecode, get the constant pool
257 // index of the referenced field.
258 int ciBytecodeStream::get_field_index() {
259   assert(cur_bc() == Bytecodes::_getfield ||
</pre>
<hr />
<pre>
272 ciField* ciBytecodeStream::get_field(bool&amp; will_link) {
273   ciField* f = CURRENT_ENV-&gt;get_field_by_index(_holder, get_field_index());
274   will_link = f-&gt;will_link(_method, _bc);
275   return f;
276 }
277 
278 
279 // ------------------------------------------------------------------
280 // ciBytecodeStream::get_declared_field_holder
281 //
282 // Get the declared holder of the currently referenced field.
283 //
284 // Usage note: the holder() of a ciField class returns the canonical
285 // holder of the field, rather than the holder declared in the
286 // bytecodes.
287 //
288 // There is no &quot;will_link&quot; result passed back.  The user is responsible
289 // for checking linkability when retrieving the associated field.
290 ciInstanceKlass* ciBytecodeStream::get_declared_field_holder() {
291   VM_ENTRY_MARK;
<span class="line-modified">292   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
293   int holder_index = get_field_holder_index();
294   bool ignore;
295   return CURRENT_ENV-&gt;get_klass_by_index(cpool, holder_index, ignore, _holder)
296       -&gt;as_instance_klass();
297 }
298 
299 // ------------------------------------------------------------------
300 // ciBytecodeStream::get_field_holder_index
301 //
302 // Get the constant pool index of the declared holder of the field
303 // referenced by the current bytecode.  Used for generating
304 // deoptimization information.
305 int ciBytecodeStream::get_field_holder_index() {
306   GUARDED_VM_ENTRY(
307     ConstantPool* cpool = _holder-&gt;get_instanceKlass()-&gt;constants();
308     return cpool-&gt;klass_ref_index_at(get_field_index());
309   )
310 }
311 
312 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
414     // meth = static final native jint java.lang.invoke.MethodHandle.linkToStatic(jobject, jobject, jint, jint, jobject)
415     // msig = (Ljava/lang/Object;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)I
416     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;IILjava/lang/invoke/MemberName;)Z
417     //
418     // meth = final native jint java.lang.invoke.MethodHandle.invokeBasic(jobject, jobject, jint, jint)
419     // msig = (Ljava/lang/Object;Ljava/lang/Object;II)I
420     // call = (Ljava/lang/invoke/VarHandle;Ljava/lang/Object;II)Z
421     //
422     (*declared_signature_result) = m-&gt;signature();
423   }
424   return m;
425 }
426 
427 // ------------------------------------------------------------------
428 // ciBytecodeStream::has_appendix
429 //
430 // Returns true if there is an appendix argument stored in the
431 // constant pool cache at the current bci.
432 bool ciBytecodeStream::has_appendix() {
433   VM_ENTRY_MARK;
<span class="line-modified">434   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
435   return ConstantPool::has_appendix_at_if_loaded(cpool, get_method_index());
436 }
437 
438 // ------------------------------------------------------------------
439 // ciBytecodeStream::get_appendix
440 //
441 // Return the appendix argument stored in the constant pool cache at
442 // the current bci.
443 ciObject* ciBytecodeStream::get_appendix() {
444   VM_ENTRY_MARK;
<span class="line-modified">445   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
446   oop appendix_oop = ConstantPool::appendix_at_if_loaded(cpool, get_method_index());
447   return CURRENT_ENV-&gt;get_object(appendix_oop);
448 }
449 
450 // ------------------------------------------------------------------
451 // ciBytecodeStream::has_local_signature
452 //
453 // Returns true if the method stored in the constant
454 // pool cache at the current bci has a local signature.
455 bool ciBytecodeStream::has_local_signature() {
456   GUARDED_VM_ENTRY(
<span class="line-modified">457     constantPoolHandle cpool(Thread::current(), _method-&gt;get_Method()-&gt;constants());</span>
458     return ConstantPool::has_local_signature_at_if_loaded(cpool, get_method_index());
459   )
460 }
461 
462 // ------------------------------------------------------------------
463 // ciBytecodeStream::get_declared_method_holder
464 //
465 // Get the declared holder of the currently referenced method.
466 //
467 // Usage note: the holder() of a ciMethod class returns the canonical
468 // holder of the method, rather than the holder declared in the
469 // bytecodes.
470 //
471 // There is no &quot;will_link&quot; result passed back.  The user is responsible
472 // for checking linkability when retrieving the associated method.
473 ciKlass* ciBytecodeStream::get_declared_method_holder() {
474   VM_ENTRY_MARK;
<span class="line-modified">475   constantPoolHandle cpool(THREAD, _method-&gt;get_Method()-&gt;constants());</span>
476   bool ignore;
477   // report as MethodHandle for invokedynamic, which is syntactically classless
478   if (cur_bc() == Bytecodes::_invokedynamic)
479     return CURRENT_ENV-&gt;get_klass_by_name(_holder, ciSymbol::java_lang_invoke_MethodHandle(), false);
480   return CURRENT_ENV-&gt;get_klass_by_index(cpool, get_method_holder_index(), ignore, _holder);
481 }
482 
483 // ------------------------------------------------------------------
484 // ciBytecodeStream::get_method_holder_index
485 //
486 // Get the constant pool index of the declared holder of the method
487 // referenced by the current bytecode.  Used for generating
488 // deoptimization information.
489 int ciBytecodeStream::get_method_holder_index() {
490   ConstantPool* cpool = _method-&gt;get_Method()-&gt;constants();
491   return cpool-&gt;klass_ref_index_at(get_method_index());
492 }
493 
494 // ------------------------------------------------------------------
495 // ciBytecodeStream::get_method_signature_index
</pre>
</td>
</tr>
</table>
<center><a href="ciSignature.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciSymbol.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>