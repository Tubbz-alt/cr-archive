<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/ci/ciEnv.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ciEnv.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciExceptionHandler.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/ci/ciEnv.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 34 #include &quot;compiler/oopMap.hpp&quot;
 35 #include &quot;oops/methodData.hpp&quot;
 36 #include &quot;runtime/thread.hpp&quot;
 37 
 38 class CompileTask;
 39 
 40 // ciEnv
 41 //
 42 // This class is the top level broker for requests from the compiler
 43 // to the VM.
 44 class ciEnv : StackObj {
 45   CI_PACKAGE_ACCESS_TO
 46 
 47   friend class CompileBroker;
 48   friend class Dependencies;  // for get_object, during logging
 49   friend class PrepareExtraDataClosure;
 50 
 51 private:
 52   Arena*           _arena;       // Alias for _ciEnv_arena except in init_shared_objects()
 53   Arena            _ciEnv_arena;
<span class="line-removed"> 54   int              _system_dictionary_modification_counter;</span>
 55   ciObjectFactory* _factory;
 56   OopRecorder*     _oop_recorder;
 57   DebugInformationRecorder* _debug_info;
 58   Dependencies*    _dependencies;
 59   const char*      _failure_reason;
 60   bool             _inc_decompile_count_on_failure;
 61   int              _compilable;
 62   bool             _break_at_compile;
 63   int              _num_inlined_bytecodes;
 64   CompileTask*     _task;           // faster access to CompilerThread::task
 65   CompileLog*      _log;            // faster access to CompilerThread::log
 66   void*            _compiler_data;  // compiler-specific stuff, if any
 67 
 68   char* _name_buffer;
 69   int   _name_buffer_len;
 70 
 71   // Cache Jvmti state

 72   bool  _jvmti_can_hotswap_or_post_breakpoint;
 73   bool  _jvmti_can_access_local_variables;
 74   bool  _jvmti_can_post_on_exceptions;
 75   bool  _jvmti_can_pop_frame;

 76 
 77   // Cache DTrace flags
 78   bool  _dtrace_extended_probes;
 79   bool  _dtrace_monitor_probes;
 80   bool  _dtrace_method_probes;
 81   bool  _dtrace_alloc_probes;
 82 
 83   // Distinguished instances of certain ciObjects..
 84   static ciObject*              _null_object_instance;
 85 
 86 #define WK_KLASS_DECL(name, ignore_s) static ciInstanceKlass* _##name;
 87   WK_KLASSES_DO(WK_KLASS_DECL)
 88 #undef WK_KLASS_DECL
 89 
 90   static ciSymbol*        _unloaded_cisymbol;
 91   static ciInstanceKlass* _unloaded_ciinstance_klass;
 92   static ciObjArrayKlass* _unloaded_ciobjarrayklass;
 93 
 94   static jobject _ArrayIndexOutOfBoundsException_handle;
 95   static jobject _ArrayStoreException_handle;
</pre>
<hr />
<pre>
274   ciReturnAddress* get_return_address(int bci) {
275     return _factory-&gt;get_return_address(bci);
276   }
277 
278   // Get a ciMethodData representing the methodData for a method
279   // with none.
280   ciMethodData* get_empty_methodData() {
281     return _factory-&gt;get_empty_methodData();
282   }
283 
284   // General utility : get a buffer of some required length.
285   // Used in symbol creation.
286   char* name_buffer(int req_len);
287 
288   // Is this thread currently in the VM state?
289   static bool is_in_vm();
290 
291   // Helper routine for determining the validity of a compilation with
292   // respect to method dependencies (e.g. concurrent class loading).
293   void validate_compile_task_dependencies(ciMethod* target);
<span class="line-removed">294 </span>
<span class="line-removed">295   // Call internally when Compile_lock is already held.</span>
<span class="line-removed">296   bool system_dictionary_modification_counter_changed_locked();</span>
297 public:
298   enum {
299     MethodCompilable,
300     MethodCompilable_not_at_tier,
301     MethodCompilable_never
302   };
303 
<span class="line-modified">304   ciEnv(CompileTask* task, int system_dictionary_modification_counter);</span>
305   // Used only during initialization of the ci
306   ciEnv(Arena* arena);
307   ~ciEnv();
308 
309   OopRecorder* oop_recorder() { return _oop_recorder; }
310   void set_oop_recorder(OopRecorder* r) { _oop_recorder = r; }
311 
312   DebugInformationRecorder* debug_info() { return _debug_info; }
313   void set_debug_info(DebugInformationRecorder* i) { _debug_info = i; }
314 
315   Dependencies* dependencies() { return _dependencies; }
316   void set_dependencies(Dependencies* d) { _dependencies = d; }
317 
318   // This is true if the compilation is not going to produce code.
319   // (It is reasonable to retry failed compilations.)
320   bool failing() { return _failure_reason != NULL; }
321 
322   // Reason this compilation is failing, such as &quot;too many basic blocks&quot;.
323   const char* failure_reason() { return _failure_reason; }
324 
</pre>
<hr />
<pre>
333         return &quot;not retryable&quot;;
334       case ciEnv::MethodCompilable:
335         return NULL;
336       default:
337         ShouldNotReachHere();
338         return NULL;
339     }
340   }
341 
342   bool break_at_compile() { return _break_at_compile; }
343   void set_break_at_compile(bool z) { _break_at_compile = z; }
344 
345   // Cache Jvmti state
346   void  cache_jvmti_state();
347   bool  jvmti_state_changed() const;
348   bool  should_retain_local_variables() const {
349     return _jvmti_can_access_local_variables || _jvmti_can_pop_frame;
350   }
351   bool  jvmti_can_hotswap_or_post_breakpoint() const { return _jvmti_can_hotswap_or_post_breakpoint; }
352   bool  jvmti_can_post_on_exceptions()         const { return _jvmti_can_post_on_exceptions; }

353 
354   // Cache DTrace flags
355   void  cache_dtrace_flags();
356   bool  dtrace_extended_probes() const { return _dtrace_extended_probes; }
357   bool  dtrace_monitor_probes()  const { return _dtrace_monitor_probes; }
358   bool  dtrace_method_probes()   const { return _dtrace_method_probes; }
359   bool  dtrace_alloc_probes()    const { return _dtrace_alloc_probes; }
360 
361   // The compiler task which has created this env.
362   // May be useful to find out compile_id, comp_level, etc.
363   CompileTask* task() { return _task; }
364 
365   // Handy forwards to the task:
366   int comp_level();   // task()-&gt;comp_level()
367   uint compile_id();  // task()-&gt;compile_id()
368 
369   // Register the result of a compilation.
370   void register_method(ciMethod*                 target,
371                        int                       entry_bci,
372                        CodeOffsets*              offsets,
</pre>
<hr />
<pre>
439   static ciEnv* current() { return CompilerThread::current()-&gt;env(); }
440 
441   // Overload with current thread argument
442   static ciEnv* current(CompilerThread *thread) { return thread-&gt;env(); }
443 
444   // Per-compiler data.  (Used by C2 to publish the Compile* pointer.)
445   void* compiler_data() { return _compiler_data; }
446   void set_compiler_data(void* x) { _compiler_data = x; }
447 
448   // Notice that a method has been inlined in the current compile;
449   // used only for statistics.
450   void notice_inlined_method(ciMethod* method);
451 
452   // Total number of bytecodes in inlined methods in this compile
453   int num_inlined_bytecodes() const;
454 
455   // Output stream for logging compilation info.
456   CompileLog* log() { return _log; }
457   void set_log(CompileLog* log) { _log = log; }
458 
<span class="line-removed">459   // Check for changes to the system dictionary during compilation</span>
<span class="line-removed">460   bool system_dictionary_modification_counter_changed();</span>
<span class="line-removed">461 </span>
462   void record_failure(const char* reason);      // Record failure and report later
463   void report_failure(const char* reason);      // Report failure immediately
464   void record_method_not_compilable(const char* reason, bool all_tiers = true);
465   void record_out_of_memory_failure();
466 
467   // RedefineClasses support
<span class="line-modified">468   void metadata_do(void f(Metadata*)) { _factory-&gt;metadata_do(f); }</span>
469 
470   // Dump the compilation replay data for the ciEnv to the stream.
471   void dump_replay_data(int compile_id);
472   void dump_inline_data(int compile_id);
473   void dump_replay_data(outputStream* out);
474   void dump_replay_data_unsafe(outputStream* out);
475   void dump_compile_data(outputStream* out);
476 };
477 
478 #endif // SHARE_CI_CIENV_HPP
</pre>
</td>
<td>
<hr />
<pre>
 34 #include &quot;compiler/oopMap.hpp&quot;
 35 #include &quot;oops/methodData.hpp&quot;
 36 #include &quot;runtime/thread.hpp&quot;
 37 
 38 class CompileTask;
 39 
 40 // ciEnv
 41 //
 42 // This class is the top level broker for requests from the compiler
 43 // to the VM.
 44 class ciEnv : StackObj {
 45   CI_PACKAGE_ACCESS_TO
 46 
 47   friend class CompileBroker;
 48   friend class Dependencies;  // for get_object, during logging
 49   friend class PrepareExtraDataClosure;
 50 
 51 private:
 52   Arena*           _arena;       // Alias for _ciEnv_arena except in init_shared_objects()
 53   Arena            _ciEnv_arena;

 54   ciObjectFactory* _factory;
 55   OopRecorder*     _oop_recorder;
 56   DebugInformationRecorder* _debug_info;
 57   Dependencies*    _dependencies;
 58   const char*      _failure_reason;
 59   bool             _inc_decompile_count_on_failure;
 60   int              _compilable;
 61   bool             _break_at_compile;
 62   int              _num_inlined_bytecodes;
 63   CompileTask*     _task;           // faster access to CompilerThread::task
 64   CompileLog*      _log;            // faster access to CompilerThread::log
 65   void*            _compiler_data;  // compiler-specific stuff, if any
 66 
 67   char* _name_buffer;
 68   int   _name_buffer_len;
 69 
 70   // Cache Jvmti state
<span class="line-added"> 71   uint64_t _jvmti_redefinition_count;</span>
 72   bool  _jvmti_can_hotswap_or_post_breakpoint;
 73   bool  _jvmti_can_access_local_variables;
 74   bool  _jvmti_can_post_on_exceptions;
 75   bool  _jvmti_can_pop_frame;
<span class="line-added"> 76   bool  _jvmti_can_get_owned_monitor_info; // includes can_get_owned_monitor_stack_depth_info</span>
 77 
 78   // Cache DTrace flags
 79   bool  _dtrace_extended_probes;
 80   bool  _dtrace_monitor_probes;
 81   bool  _dtrace_method_probes;
 82   bool  _dtrace_alloc_probes;
 83 
 84   // Distinguished instances of certain ciObjects..
 85   static ciObject*              _null_object_instance;
 86 
 87 #define WK_KLASS_DECL(name, ignore_s) static ciInstanceKlass* _##name;
 88   WK_KLASSES_DO(WK_KLASS_DECL)
 89 #undef WK_KLASS_DECL
 90 
 91   static ciSymbol*        _unloaded_cisymbol;
 92   static ciInstanceKlass* _unloaded_ciinstance_klass;
 93   static ciObjArrayKlass* _unloaded_ciobjarrayklass;
 94 
 95   static jobject _ArrayIndexOutOfBoundsException_handle;
 96   static jobject _ArrayStoreException_handle;
</pre>
<hr />
<pre>
275   ciReturnAddress* get_return_address(int bci) {
276     return _factory-&gt;get_return_address(bci);
277   }
278 
279   // Get a ciMethodData representing the methodData for a method
280   // with none.
281   ciMethodData* get_empty_methodData() {
282     return _factory-&gt;get_empty_methodData();
283   }
284 
285   // General utility : get a buffer of some required length.
286   // Used in symbol creation.
287   char* name_buffer(int req_len);
288 
289   // Is this thread currently in the VM state?
290   static bool is_in_vm();
291 
292   // Helper routine for determining the validity of a compilation with
293   // respect to method dependencies (e.g. concurrent class loading).
294   void validate_compile_task_dependencies(ciMethod* target);



295 public:
296   enum {
297     MethodCompilable,
298     MethodCompilable_not_at_tier,
299     MethodCompilable_never
300   };
301 
<span class="line-modified">302   ciEnv(CompileTask* task);</span>
303   // Used only during initialization of the ci
304   ciEnv(Arena* arena);
305   ~ciEnv();
306 
307   OopRecorder* oop_recorder() { return _oop_recorder; }
308   void set_oop_recorder(OopRecorder* r) { _oop_recorder = r; }
309 
310   DebugInformationRecorder* debug_info() { return _debug_info; }
311   void set_debug_info(DebugInformationRecorder* i) { _debug_info = i; }
312 
313   Dependencies* dependencies() { return _dependencies; }
314   void set_dependencies(Dependencies* d) { _dependencies = d; }
315 
316   // This is true if the compilation is not going to produce code.
317   // (It is reasonable to retry failed compilations.)
318   bool failing() { return _failure_reason != NULL; }
319 
320   // Reason this compilation is failing, such as &quot;too many basic blocks&quot;.
321   const char* failure_reason() { return _failure_reason; }
322 
</pre>
<hr />
<pre>
331         return &quot;not retryable&quot;;
332       case ciEnv::MethodCompilable:
333         return NULL;
334       default:
335         ShouldNotReachHere();
336         return NULL;
337     }
338   }
339 
340   bool break_at_compile() { return _break_at_compile; }
341   void set_break_at_compile(bool z) { _break_at_compile = z; }
342 
343   // Cache Jvmti state
344   void  cache_jvmti_state();
345   bool  jvmti_state_changed() const;
346   bool  should_retain_local_variables() const {
347     return _jvmti_can_access_local_variables || _jvmti_can_pop_frame;
348   }
349   bool  jvmti_can_hotswap_or_post_breakpoint() const { return _jvmti_can_hotswap_or_post_breakpoint; }
350   bool  jvmti_can_post_on_exceptions()         const { return _jvmti_can_post_on_exceptions; }
<span class="line-added">351   bool  jvmti_can_get_owned_monitor_info()     const { return _jvmti_can_get_owned_monitor_info; }</span>
352 
353   // Cache DTrace flags
354   void  cache_dtrace_flags();
355   bool  dtrace_extended_probes() const { return _dtrace_extended_probes; }
356   bool  dtrace_monitor_probes()  const { return _dtrace_monitor_probes; }
357   bool  dtrace_method_probes()   const { return _dtrace_method_probes; }
358   bool  dtrace_alloc_probes()    const { return _dtrace_alloc_probes; }
359 
360   // The compiler task which has created this env.
361   // May be useful to find out compile_id, comp_level, etc.
362   CompileTask* task() { return _task; }
363 
364   // Handy forwards to the task:
365   int comp_level();   // task()-&gt;comp_level()
366   uint compile_id();  // task()-&gt;compile_id()
367 
368   // Register the result of a compilation.
369   void register_method(ciMethod*                 target,
370                        int                       entry_bci,
371                        CodeOffsets*              offsets,
</pre>
<hr />
<pre>
438   static ciEnv* current() { return CompilerThread::current()-&gt;env(); }
439 
440   // Overload with current thread argument
441   static ciEnv* current(CompilerThread *thread) { return thread-&gt;env(); }
442 
443   // Per-compiler data.  (Used by C2 to publish the Compile* pointer.)
444   void* compiler_data() { return _compiler_data; }
445   void set_compiler_data(void* x) { _compiler_data = x; }
446 
447   // Notice that a method has been inlined in the current compile;
448   // used only for statistics.
449   void notice_inlined_method(ciMethod* method);
450 
451   // Total number of bytecodes in inlined methods in this compile
452   int num_inlined_bytecodes() const;
453 
454   // Output stream for logging compilation info.
455   CompileLog* log() { return _log; }
456   void set_log(CompileLog* log) { _log = log; }
457 



458   void record_failure(const char* reason);      // Record failure and report later
459   void report_failure(const char* reason);      // Report failure immediately
460   void record_method_not_compilable(const char* reason, bool all_tiers = true);
461   void record_out_of_memory_failure();
462 
463   // RedefineClasses support
<span class="line-modified">464   void metadata_do(MetadataClosure* f) { _factory-&gt;metadata_do(f); }</span>
465 
466   // Dump the compilation replay data for the ciEnv to the stream.
467   void dump_replay_data(int compile_id);
468   void dump_inline_data(int compile_id);
469   void dump_replay_data(outputStream* out);
470   void dump_replay_data_unsafe(outputStream* out);
471   void dump_compile_data(outputStream* out);
472 };
473 
474 #endif // SHARE_CI_CIENV_HPP
</pre>
</td>
</tr>
</table>
<center><a href="ciEnv.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciExceptionHandler.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>