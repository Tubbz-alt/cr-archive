<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/ci/ciInstanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ciField.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciInstanceKlass.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/ci/ciInstanceKlass.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 30,11 ***</span>
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
<span class="line-modified">! #include &quot;oops/fieldStreams.hpp&quot;</span>
  #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/jniHandles.inline.hpp&quot;
  
  // ciInstanceKlass
<span class="line-new-header">--- 30,11 ---</span>
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
<span class="line-modified">! #include &quot;oops/fieldStreams.inline.hpp&quot;</span>
  #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/jniHandles.inline.hpp&quot;
  
  // ciInstanceKlass
</pre>
<hr />
<pre>
<span class="line-old-header">*** 114,11 ***</span>
  // Version for unloaded classes:
  ciInstanceKlass::ciInstanceKlass(ciSymbol* name,
                                   jobject loader, jobject protection_domain)
    : ciKlass(name, T_OBJECT)
  {
<span class="line-modified">!   assert(name-&gt;char_at(0) != &#39;[&#39;, &quot;not an instance klass&quot;);</span>
    _init_state = (InstanceKlass::ClassState)0;
    _nonstatic_field_size = -1;
    _has_nonstatic_fields = false;
    _nonstatic_fields = NULL;
    _has_injected_fields = -1;
<span class="line-new-header">--- 114,11 ---</span>
  // Version for unloaded classes:
  ciInstanceKlass::ciInstanceKlass(ciSymbol* name,
                                   jobject loader, jobject protection_domain)
    : ciKlass(name, T_OBJECT)
  {
<span class="line-modified">!   assert(name-&gt;char_at(0) != JVM_SIGNATURE_ARRAY, &quot;not an instance klass&quot;);</span>
    _init_state = (InstanceKlass::ClassState)0;
    _nonstatic_field_size = -1;
    _has_nonstatic_fields = false;
    _nonstatic_fields = NULL;
    _has_injected_fields = -1;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 211,18 ***</span>
      // All header offsets belong properly to java/lang/Object.
      return CURRENT_ENV-&gt;Object_klass();
    }
  
    ciInstanceKlass* self = this;
<span class="line-modified">!   for (;;) {</span>
<span class="line-modified">!     assert(self-&gt;is_loaded(), &quot;must be loaded to have size&quot;);</span>
<span class="line-modified">!     ciInstanceKlass* super = self-&gt;super();</span>
<span class="line-modified">!     if (super == NULL || super-&gt;nof_nonstatic_fields() == 0 ||</span>
<span class="line-modified">!         !super-&gt;contains_field_offset(offset)) {</span>
<span class="line-modified">!       return self;</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!       self = super;  // return super-&gt;get_canonical_holder(offset)</span>
      }
    }
  }
  
  // ------------------------------------------------------------------
<span class="line-new-header">--- 211,23 ---</span>
      // All header offsets belong properly to java/lang/Object.
      return CURRENT_ENV-&gt;Object_klass();
    }
  
    ciInstanceKlass* self = this;
<span class="line-modified">!   assert(self-&gt;is_loaded(), &quot;must be loaded to access field info&quot;);</span>
<span class="line-modified">!   ciField* field = self-&gt;get_field_by_offset(offset, false);</span>
<span class="line-modified">!   if (field != NULL) {</span>
<span class="line-modified">!     return field-&gt;holder();</span>
<span class="line-modified">!   } else {</span>
<span class="line-modified">!     for (;;) {</span>
<span class="line-modified">!       assert(self-&gt;is_loaded(), &quot;must be loaded to have size&quot;);</span>
<span class="line-modified">!       ciInstanceKlass* super = self-&gt;super();</span>
<span class="line-added">+       if (super == NULL || super-&gt;nof_nonstatic_fields() == 0) {</span>
<span class="line-added">+         return self;</span>
<span class="line-added">+       } else {</span>
<span class="line-added">+         self = super;  // return super-&gt;get_canonical_holder(offset)</span>
<span class="line-added">+       }</span>
      }
    }
  }
  
  // ------------------------------------------------------------------
</pre>
<hr />
<pre>
<span class="line-old-header">*** 313,11 ***</span>
  // ciInstanceKlass::print_impl
  //
  // Implementation of the print method.
  void ciInstanceKlass::print_impl(outputStream* st) {
    ciKlass::print_impl(st);
<span class="line-modified">!   GUARDED_VM_ENTRY(st-&gt;print(&quot; loader=&quot; INTPTR_FORMAT, p2i((address)loader()));)</span>
    if (is_loaded()) {
      st-&gt;print(&quot; loaded=true initialized=%s finalized=%s subklass=%s size=%d flags=&quot;,
                bool_to_str(is_initialized()),
                bool_to_str(has_finalizer()),
                bool_to_str(has_subklass()),
<span class="line-new-header">--- 318,11 ---</span>
  // ciInstanceKlass::print_impl
  //
  // Implementation of the print method.
  void ciInstanceKlass::print_impl(outputStream* st) {
    ciKlass::print_impl(st);
<span class="line-modified">!   GUARDED_VM_ENTRY(st-&gt;print(&quot; loader=&quot; INTPTR_FORMAT, p2i(loader()));)</span>
    if (is_loaded()) {
      st-&gt;print(&quot; loaded=true initialized=%s finalized=%s subklass=%s size=%d flags=&quot;,
                bool_to_str(is_initialized()),
                bool_to_str(has_finalizer()),
                bool_to_str(has_subklass()),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 389,10 ***</span>
<span class="line-new-header">--- 394,17 ---</span>
    if (!is_loaded())     return true;
    VM_ENTRY_MARK;
    return Dependencies::find_finalizable_subclass(get_instanceKlass()) != NULL;
  }
  
<span class="line-added">+ // ------------------------------------------------------------------</span>
<span class="line-added">+ // ciInstanceKlass::contains_field_offset</span>
<span class="line-added">+ bool ciInstanceKlass::contains_field_offset(int offset) {</span>
<span class="line-added">+   VM_ENTRY_MARK;</span>
<span class="line-added">+   return get_instanceKlass()-&gt;contains_field_offset(offset);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  // ------------------------------------------------------------------
  // ciInstanceKlass::get_field_by_offset
  ciField* ciInstanceKlass::get_field_by_offset(int field_offset, bool is_static) {
    if (!is_static) {
      for (int i = 0, len = nof_nonstatic_fields(); i &lt; len; i++) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 455,19 ***</span>
    int fsize = nonstatic_field_size() * heapOopSize;
  
    ciInstanceKlass* super = this-&gt;super();
    GrowableArray&lt;ciField*&gt;* super_fields = NULL;
    if (super != NULL &amp;&amp; super-&gt;has_nonstatic_fields()) {
<span class="line-removed">-     int super_fsize  = super-&gt;nonstatic_field_size() * heapOopSize;</span>
      int super_flen   = super-&gt;nof_nonstatic_fields();
      super_fields = super-&gt;_nonstatic_fields;
      assert(super_flen == 0 || super_fields != NULL, &quot;first get nof_fields&quot;);
<span class="line-removed">-     // See if I am no larger than my super; if so, I can use his fields.</span>
<span class="line-removed">-     if (fsize == super_fsize) {</span>
<span class="line-removed">-       _nonstatic_fields = super_fields;</span>
<span class="line-removed">-       return super_fields-&gt;length();</span>
<span class="line-removed">-     }</span>
    }
  
    GrowableArray&lt;ciField*&gt;* fields = NULL;
    GUARDED_VM_ENTRY({
        fields = compute_nonstatic_fields_impl(super_fields);
<span class="line-new-header">--- 467,13 ---</span>
</pre>
<center><a href="ciField.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciInstanceKlass.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>