<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/ci/ciEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;ci/ciConstant.hpp&quot;
  28 #include &quot;ci/ciEnv.hpp&quot;
  29 #include &quot;ci/ciField.hpp&quot;
  30 #include &quot;ci/ciInstance.hpp&quot;
  31 #include &quot;ci/ciInstanceKlass.hpp&quot;
  32 #include &quot;ci/ciMethod.hpp&quot;
  33 #include &quot;ci/ciNullObject.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;classfile/vmSymbols.hpp&quot;
  38 #include &quot;code/codeCache.hpp&quot;
  39 #include &quot;code/scopeDesc.hpp&quot;
  40 #include &quot;compiler/compileBroker.hpp&quot;
  41 #include &quot;compiler/compileLog.hpp&quot;
  42 #include &quot;compiler/disassembler.hpp&quot;
  43 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  44 #include &quot;interpreter/linkResolver.hpp&quot;
  45 #include &quot;jfr/jfrEvents.hpp&quot;
  46 #include &quot;memory/allocation.inline.hpp&quot;
  47 #include &quot;memory/oopFactory.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/constantPool.inline.hpp&quot;
  51 #include &quot;oops/cpCache.inline.hpp&quot;
  52 #include &quot;oops/method.inline.hpp&quot;
  53 #include &quot;oops/methodData.hpp&quot;
  54 #include &quot;oops/objArrayKlass.hpp&quot;
  55 #include &quot;oops/objArrayOop.inline.hpp&quot;
  56 #include &quot;oops/oop.inline.hpp&quot;
  57 #include &quot;prims/jvmtiExport.hpp&quot;
  58 #include &quot;runtime/handles.inline.hpp&quot;
  59 #include &quot;runtime/init.hpp&quot;
  60 #include &quot;runtime/reflection.hpp&quot;
  61 #include &quot;runtime/jniHandles.inline.hpp&quot;
  62 #include &quot;runtime/safepointVerifiers.hpp&quot;
  63 #include &quot;runtime/sharedRuntime.hpp&quot;
  64 #include &quot;runtime/thread.inline.hpp&quot;
  65 #include &quot;utilities/dtrace.hpp&quot;
  66 #include &quot;utilities/macros.hpp&quot;
  67 #ifdef COMPILER1
  68 #include &quot;c1/c1_Runtime1.hpp&quot;
  69 #endif
  70 #ifdef COMPILER2
  71 #include &quot;opto/runtime.hpp&quot;
  72 #endif
  73 
  74 // ciEnv
  75 //
  76 // This class is the top level broker for requests from the compiler
  77 // to the VM.
  78 
  79 ciObject*              ciEnv::_null_object_instance;
  80 
  81 #define WK_KLASS_DEFN(name, ignore_s) ciInstanceKlass* ciEnv::_##name = NULL;
  82 WK_KLASSES_DO(WK_KLASS_DEFN)
  83 #undef WK_KLASS_DEFN
  84 
  85 ciSymbol*        ciEnv::_unloaded_cisymbol = NULL;
  86 ciInstanceKlass* ciEnv::_unloaded_ciinstance_klass = NULL;
  87 ciObjArrayKlass* ciEnv::_unloaded_ciobjarrayklass = NULL;
  88 
  89 jobject ciEnv::_ArrayIndexOutOfBoundsException_handle = NULL;
  90 jobject ciEnv::_ArrayStoreException_handle = NULL;
  91 jobject ciEnv::_ClassCastException_handle = NULL;
  92 
  93 #ifndef PRODUCT
  94 static bool firstEnv = true;
  95 #endif /* PRODUCT */
  96 
  97 // ------------------------------------------------------------------
  98 // ciEnv::ciEnv
  99 ciEnv::ciEnv(CompileTask* task, int system_dictionary_modification_counter)
 100   : _ciEnv_arena(mtCompiler) {
 101   VM_ENTRY_MARK;
 102 
 103   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 104   thread-&gt;set_env(this);
 105   assert(ciEnv::current() == this, &quot;sanity&quot;);
 106 
 107   _oop_recorder = NULL;
 108   _debug_info = NULL;
 109   _dependencies = NULL;
 110   _failure_reason = NULL;
 111   _inc_decompile_count_on_failure = true;
 112   _compilable = MethodCompilable;
 113   _break_at_compile = false;
 114   _compiler_data = NULL;
 115 #ifndef PRODUCT
 116   assert(!firstEnv, &quot;not initialized properly&quot;);
 117 #endif /* !PRODUCT */
 118 
 119   _system_dictionary_modification_counter = system_dictionary_modification_counter;
 120   _num_inlined_bytecodes = 0;
 121   assert(task == NULL || thread-&gt;task() == task, &quot;sanity&quot;);
 122   if (task != NULL) {
 123     task-&gt;mark_started(os::elapsed_counter());
 124   }
 125   _task = task;
 126   _log = NULL;
 127 
 128   // Temporary buffer for creating symbols and such.
 129   _name_buffer = NULL;
 130   _name_buffer_len = 0;
 131 
 132   _arena   = &amp;_ciEnv_arena;
 133   _factory = new (_arena) ciObjectFactory(_arena, 128);
 134 
 135   // Preload commonly referenced system ciObjects.
 136 
 137   // During VM initialization, these instances have not yet been created.
 138   // Assertions ensure that these instances are not accessed before
 139   // their initialization.
 140 
 141   assert(Universe::is_fully_initialized(), &quot;should be complete&quot;);
 142 
 143   oop o = Universe::null_ptr_exception_instance();
 144   assert(o != NULL, &quot;should have been initialized&quot;);
 145   _NullPointerException_instance = get_object(o)-&gt;as_instance();
 146   o = Universe::arithmetic_exception_instance();
 147   assert(o != NULL, &quot;should have been initialized&quot;);
 148   _ArithmeticException_instance = get_object(o)-&gt;as_instance();
 149 
 150   _ArrayIndexOutOfBoundsException_instance = NULL;
 151   _ArrayStoreException_instance = NULL;
 152   _ClassCastException_instance = NULL;
 153   _the_null_string = NULL;
 154   _the_min_jint_string = NULL;
 155 
 156   _jvmti_can_hotswap_or_post_breakpoint = false;
 157   _jvmti_can_access_local_variables = false;
 158   _jvmti_can_post_on_exceptions = false;
 159   _jvmti_can_pop_frame = false;
 160 }
 161 
 162 ciEnv::ciEnv(Arena* arena) : _ciEnv_arena(mtCompiler) {
 163   ASSERT_IN_VM;
 164 
 165   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 166   CompilerThread* current_thread = CompilerThread::current();
 167   assert(current_thread-&gt;env() == NULL, &quot;must be&quot;);
 168   current_thread-&gt;set_env(this);
 169   assert(ciEnv::current() == this, &quot;sanity&quot;);
 170 
 171   _oop_recorder = NULL;
 172   _debug_info = NULL;
 173   _dependencies = NULL;
 174   _failure_reason = NULL;
 175   _inc_decompile_count_on_failure = true;
 176   _compilable = MethodCompilable_never;
 177   _break_at_compile = false;
 178   _compiler_data = NULL;
 179 #ifndef PRODUCT
 180   assert(firstEnv, &quot;must be first&quot;);
 181   firstEnv = false;
 182 #endif /* !PRODUCT */
 183 
 184   _system_dictionary_modification_counter = 0;
 185   _num_inlined_bytecodes = 0;
 186   _task = NULL;
 187   _log = NULL;
 188 
 189   // Temporary buffer for creating symbols and such.
 190   _name_buffer = NULL;
 191   _name_buffer_len = 0;
 192 
 193   _arena   = arena;
 194   _factory = new (_arena) ciObjectFactory(_arena, 128);
 195 
 196   // Preload commonly referenced system ciObjects.
 197 
 198   // During VM initialization, these instances have not yet been created.
 199   // Assertions ensure that these instances are not accessed before
 200   // their initialization.
 201 
 202   assert(Universe::is_fully_initialized(), &quot;must be&quot;);
 203 
 204   _NullPointerException_instance = NULL;
 205   _ArithmeticException_instance = NULL;
 206   _ArrayIndexOutOfBoundsException_instance = NULL;
 207   _ArrayStoreException_instance = NULL;
 208   _ClassCastException_instance = NULL;
 209   _the_null_string = NULL;
 210   _the_min_jint_string = NULL;
 211 
 212   _jvmti_can_hotswap_or_post_breakpoint = false;
 213   _jvmti_can_access_local_variables = false;
 214   _jvmti_can_post_on_exceptions = false;
 215   _jvmti_can_pop_frame = false;
 216 }
 217 
 218 ciEnv::~ciEnv() {
 219   GUARDED_VM_ENTRY(
 220       CompilerThread* current_thread = CompilerThread::current();
 221       _factory-&gt;remove_symbols();
 222       // Need safepoint to clear the env on the thread.  RedefineClasses might
 223       // be reading it.
 224       current_thread-&gt;set_env(NULL);
 225   )
 226 }
 227 
 228 // ------------------------------------------------------------------
 229 // Cache Jvmti state
 230 void ciEnv::cache_jvmti_state() {
 231   VM_ENTRY_MARK;
 232   // Get Jvmti capabilities under lock to get consistant values.
 233   MutexLocker mu(JvmtiThreadState_lock);
 234   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint();
 235   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables();
 236   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions();
 237   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame();
 238 }
 239 
 240 bool ciEnv::jvmti_state_changed() const {
 241   if (!_jvmti_can_access_local_variables &amp;&amp;
 242       JvmtiExport::can_access_local_variables()) {
 243     return true;
 244   }
 245   if (!_jvmti_can_hotswap_or_post_breakpoint &amp;&amp;
 246       JvmtiExport::can_hotswap_or_post_breakpoint()) {
 247     return true;
 248   }
 249   if (!_jvmti_can_post_on_exceptions &amp;&amp;
 250       JvmtiExport::can_post_on_exceptions()) {
 251     return true;
 252   }
 253   if (!_jvmti_can_pop_frame &amp;&amp;
 254       JvmtiExport::can_pop_frame()) {
 255     return true;
 256   }
 257   return false;
 258 }
 259 
 260 // ------------------------------------------------------------------
 261 // Cache DTrace flags
 262 void ciEnv::cache_dtrace_flags() {
 263   // Need lock?
 264   _dtrace_extended_probes = ExtendedDTraceProbes;
 265   if (_dtrace_extended_probes) {
 266     _dtrace_monitor_probes  = true;
 267     _dtrace_method_probes   = true;
 268     _dtrace_alloc_probes    = true;
 269   } else {
 270     _dtrace_monitor_probes  = DTraceMonitorProbes;
 271     _dtrace_method_probes   = DTraceMethodProbes;
 272     _dtrace_alloc_probes    = DTraceAllocProbes;
 273   }
 274 }
 275 
 276 // ------------------------------------------------------------------
 277 // helper for lazy exception creation
 278 ciInstance* ciEnv::get_or_create_exception(jobject&amp; handle, Symbol* name) {
 279   VM_ENTRY_MARK;
 280   if (handle == NULL) {
 281     // Cf. universe.cpp, creation of Universe::_null_ptr_exception_instance.
 282     Klass* k = SystemDictionary::find(name, Handle(), Handle(), THREAD);
 283     jobject objh = NULL;
 284     if (!HAS_PENDING_EXCEPTION &amp;&amp; k != NULL) {
 285       oop obj = InstanceKlass::cast(k)-&gt;allocate_instance(THREAD);
 286       if (!HAS_PENDING_EXCEPTION)
 287         objh = JNIHandles::make_global(Handle(THREAD, obj));
 288     }
 289     if (HAS_PENDING_EXCEPTION) {
 290       CLEAR_PENDING_EXCEPTION;
 291     } else {
 292       handle = objh;
 293     }
 294   }
 295   oop obj = JNIHandles::resolve(handle);
 296   return obj == NULL? NULL: get_object(obj)-&gt;as_instance();
 297 }
 298 
 299 ciInstance* ciEnv::ArrayIndexOutOfBoundsException_instance() {
 300   if (_ArrayIndexOutOfBoundsException_instance == NULL) {
 301     _ArrayIndexOutOfBoundsException_instance
 302           = get_or_create_exception(_ArrayIndexOutOfBoundsException_handle,
 303           vmSymbols::java_lang_ArrayIndexOutOfBoundsException());
 304   }
 305   return _ArrayIndexOutOfBoundsException_instance;
 306 }
 307 ciInstance* ciEnv::ArrayStoreException_instance() {
 308   if (_ArrayStoreException_instance == NULL) {
 309     _ArrayStoreException_instance
 310           = get_or_create_exception(_ArrayStoreException_handle,
 311           vmSymbols::java_lang_ArrayStoreException());
 312   }
 313   return _ArrayStoreException_instance;
 314 }
 315 ciInstance* ciEnv::ClassCastException_instance() {
 316   if (_ClassCastException_instance == NULL) {
 317     _ClassCastException_instance
 318           = get_or_create_exception(_ClassCastException_handle,
 319           vmSymbols::java_lang_ClassCastException());
 320   }
 321   return _ClassCastException_instance;
 322 }
 323 
 324 ciInstance* ciEnv::the_null_string() {
 325   if (_the_null_string == NULL) {
 326     VM_ENTRY_MARK;
 327     _the_null_string = get_object(Universe::the_null_string())-&gt;as_instance();
 328   }
 329   return _the_null_string;
 330 }
 331 
 332 ciInstance* ciEnv::the_min_jint_string() {
 333   if (_the_min_jint_string == NULL) {
 334     VM_ENTRY_MARK;
 335     _the_min_jint_string = get_object(Universe::the_min_jint_string())-&gt;as_instance();
 336   }
 337   return _the_min_jint_string;
 338 }
 339 
 340 // ------------------------------------------------------------------
 341 // ciEnv::get_method_from_handle
 342 ciMethod* ciEnv::get_method_from_handle(Method* method) {
 343   VM_ENTRY_MARK;
 344   return get_metadata(method)-&gt;as_method();
 345 }
 346 
 347 // ------------------------------------------------------------------
 348 // ciEnv::array_element_offset_in_bytes
 349 int ciEnv::array_element_offset_in_bytes(ciArray* a_h, ciObject* o_h) {
 350   VM_ENTRY_MARK;
 351   objArrayOop a = (objArrayOop)a_h-&gt;get_oop();
 352   assert(a-&gt;is_objArray(), &quot;&quot;);
 353   int length = a-&gt;length();
 354   oop o = o_h-&gt;get_oop();
 355   for (int i = 0; i &lt; length; i++) {
 356     if (a-&gt;obj_at(i) == o)  return i;
 357   }
 358   return -1;
 359 }
 360 
 361 
 362 // ------------------------------------------------------------------
 363 // ciEnv::check_klass_accessiblity
 364 //
 365 // Note: the logic of this method should mirror the logic of
 366 // ConstantPool::verify_constant_pool_resolve.
 367 bool ciEnv::check_klass_accessibility(ciKlass* accessing_klass,
 368                                       Klass* resolved_klass) {
 369   if (accessing_klass == NULL || !accessing_klass-&gt;is_loaded()) {
 370     return true;
 371   }
 372   if (accessing_klass-&gt;is_obj_array_klass()) {
 373     accessing_klass = accessing_klass-&gt;as_obj_array_klass()-&gt;base_element_klass();
 374   }
 375   if (!accessing_klass-&gt;is_instance_klass()) {
 376     return true;
 377   }
 378 
 379   if (resolved_klass-&gt;is_objArray_klass()) {
 380     // Find the element klass, if this is an array.
 381     resolved_klass = ObjArrayKlass::cast(resolved_klass)-&gt;bottom_klass();
 382   }
 383   if (resolved_klass-&gt;is_instance_klass()) {
 384     return (Reflection::verify_class_access(accessing_klass-&gt;get_Klass(),
 385                                             InstanceKlass::cast(resolved_klass),
 386                                             true) == Reflection::ACCESS_OK);
 387   }
 388   return true;
 389 }
 390 
 391 // ------------------------------------------------------------------
 392 // ciEnv::get_klass_by_name_impl
 393 ciKlass* ciEnv::get_klass_by_name_impl(ciKlass* accessing_klass,
 394                                        const constantPoolHandle&amp; cpool,
 395                                        ciSymbol* name,
 396                                        bool require_local) {
 397   ASSERT_IN_VM;
 398   EXCEPTION_CONTEXT;
 399 
 400   // Now we need to check the SystemDictionary
 401   Symbol* sym = name-&gt;get_symbol();
 402   if (sym-&gt;char_at(0) == &#39;L&#39; &amp;&amp;
 403     sym-&gt;char_at(sym-&gt;utf8_length()-1) == &#39;;&#39;) {
 404     // This is a name from a signature.  Strip off the trimmings.
 405     // Call recursive to keep scope of strippedsym.
 406     TempNewSymbol strippedsym = SymbolTable::new_symbol(sym-&gt;as_utf8()+1,
 407                     sym-&gt;utf8_length()-2,
 408                     KILL_COMPILE_ON_FATAL_(_unloaded_ciinstance_klass));
 409     ciSymbol* strippedname = get_symbol(strippedsym);
 410     return get_klass_by_name_impl(accessing_klass, cpool, strippedname, require_local);
 411   }
 412 
 413   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 414   // can vary over time but the compiler needs consistency.
 415   ciKlass* unloaded_klass = check_get_unloaded_klass(accessing_klass, name);
 416   if (unloaded_klass != NULL) {
 417     if (require_local)  return NULL;
 418     return unloaded_klass;
 419   }
 420 
 421   Handle loader(THREAD, (oop)NULL);
 422   Handle domain(THREAD, (oop)NULL);
 423   if (accessing_klass != NULL) {
 424     loader = Handle(THREAD, accessing_klass-&gt;loader());
 425     domain = Handle(THREAD, accessing_klass-&gt;protection_domain());
 426   }
 427 
 428   // setup up the proper type to return on OOM
 429   ciKlass* fail_type;
 430   if (sym-&gt;char_at(0) == &#39;[&#39;) {
 431     fail_type = _unloaded_ciobjarrayklass;
 432   } else {
 433     fail_type = _unloaded_ciinstance_klass;
 434   }
 435   Klass* found_klass;
 436   {
 437     ttyUnlocker ttyul;  // release tty lock to avoid ordering problems
 438     MutexLocker ml(Compile_lock);
 439     Klass* kls;
 440     if (!require_local) {
 441       kls = SystemDictionary::find_constrained_instance_or_array_klass(sym, loader,
 442                                                                        KILL_COMPILE_ON_FATAL_(fail_type));
 443     } else {
 444       kls = SystemDictionary::find_instance_or_array_klass(sym, loader, domain,
 445                                                            KILL_COMPILE_ON_FATAL_(fail_type));
 446     }
 447     found_klass = kls;
 448   }
 449 
 450   // If we fail to find an array klass, look again for its element type.
 451   // The element type may be available either locally or via constraints.
 452   // In either case, if we can find the element type in the system dictionary,
 453   // we must build an array type around it.  The CI requires array klasses
 454   // to be loaded if their element klasses are loaded, except when memory
 455   // is exhausted.
 456   if (sym-&gt;char_at(0) == &#39;[&#39; &amp;&amp;
 457       (sym-&gt;char_at(1) == &#39;[&#39; || sym-&gt;char_at(1) == &#39;L&#39;)) {
 458     // We have an unloaded array.
 459     // Build it on the fly if the element class exists.
 460     TempNewSymbol elem_sym = SymbolTable::new_symbol(sym-&gt;as_utf8()+1,
 461                                                  sym-&gt;utf8_length()-1,
 462                                                  KILL_COMPILE_ON_FATAL_(fail_type));
 463 
 464     // Get element ciKlass recursively.
 465     ciKlass* elem_klass =
 466       get_klass_by_name_impl(accessing_klass,
 467                              cpool,
 468                              get_symbol(elem_sym),
 469                              require_local);
 470     if (elem_klass != NULL &amp;&amp; elem_klass-&gt;is_loaded()) {
 471       // Now make an array for it
 472       return ciObjArrayKlass::make_impl(elem_klass);
 473     }
 474   }
 475 
 476   if (found_klass == NULL &amp;&amp; !cpool.is_null() &amp;&amp; cpool-&gt;has_preresolution()) {
 477     // Look inside the constant pool for pre-resolved class entries.
 478     for (int i = cpool-&gt;length() - 1; i &gt;= 1; i--) {
 479       if (cpool-&gt;tag_at(i).is_klass()) {
 480         Klass* kls = cpool-&gt;resolved_klass_at(i);
 481         if (kls-&gt;name() == sym) {
 482           found_klass = kls;
 483           break;
 484         }
 485       }
 486     }
 487   }
 488 
 489   if (found_klass != NULL) {
 490     // Found it.  Build a CI handle.
 491     return get_klass(found_klass);
 492   }
 493 
 494   if (require_local)  return NULL;
 495 
 496   // Not yet loaded into the VM, or not governed by loader constraints.
 497   // Make a CI representative for it.
 498   return get_unloaded_klass(accessing_klass, name);
 499 }
 500 
 501 // ------------------------------------------------------------------
 502 // ciEnv::get_klass_by_name
 503 ciKlass* ciEnv::get_klass_by_name(ciKlass* accessing_klass,
 504                                   ciSymbol* klass_name,
 505                                   bool require_local) {
 506   GUARDED_VM_ENTRY(return get_klass_by_name_impl(accessing_klass,
 507                                                  constantPoolHandle(),
 508                                                  klass_name,
 509                                                  require_local);)
 510 }
 511 
 512 // ------------------------------------------------------------------
 513 // ciEnv::get_klass_by_index_impl
 514 //
 515 // Implementation of get_klass_by_index.
 516 ciKlass* ciEnv::get_klass_by_index_impl(const constantPoolHandle&amp; cpool,
 517                                         int index,
 518                                         bool&amp; is_accessible,
 519                                         ciInstanceKlass* accessor) {
 520   EXCEPTION_CONTEXT;
 521   Klass* klass = NULL;
 522   Symbol* klass_name = NULL;
 523 
 524   if (cpool-&gt;tag_at(index).is_symbol()) {
 525     klass_name = cpool-&gt;symbol_at(index);
 526   } else {
 527     // Check if it&#39;s resolved if it&#39;s not a symbol constant pool entry.
 528     klass =  ConstantPool::klass_at_if_loaded(cpool, index);
 529     // Try to look it up by name.
 530     if (klass == NULL) {
 531       klass_name = cpool-&gt;klass_name_at(index);
 532     }
 533   }
 534 
 535   if (klass == NULL) {
 536     // Not found in constant pool.  Use the name to do the lookup.
 537     ciKlass* k = get_klass_by_name_impl(accessor,
 538                                         cpool,
 539                                         get_symbol(klass_name),
 540                                         false);
 541     // Calculate accessibility the hard way.
 542     if (!k-&gt;is_loaded()) {
 543       is_accessible = false;
 544     } else if (!oopDesc::equals(k-&gt;loader(), accessor-&gt;loader()) &amp;&amp;
 545                get_klass_by_name_impl(accessor, cpool, k-&gt;name(), true) == NULL) {
 546       // Loaded only remotely.  Not linked yet.
 547       is_accessible = false;
 548     } else {
 549       // Linked locally, and we must also check public/private, etc.
 550       is_accessible = check_klass_accessibility(accessor, k-&gt;get_Klass());
 551     }
 552     return k;
 553   }
 554 
 555   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 556   // can vary over time but the compiler needs consistency.
 557   ciSymbol* name = get_symbol(klass-&gt;name());
 558   ciKlass* unloaded_klass = check_get_unloaded_klass(accessor, name);
 559   if (unloaded_klass != NULL) {
 560     is_accessible = false;
 561     return unloaded_klass;
 562   }
 563 
 564   // It is known to be accessible, since it was found in the constant pool.
 565   is_accessible = true;
 566   return get_klass(klass);
 567 }
 568 
 569 // ------------------------------------------------------------------
 570 // ciEnv::get_klass_by_index
 571 //
 572 // Get a klass from the constant pool.
 573 ciKlass* ciEnv::get_klass_by_index(const constantPoolHandle&amp; cpool,
 574                                    int index,
 575                                    bool&amp; is_accessible,
 576                                    ciInstanceKlass* accessor) {
 577   GUARDED_VM_ENTRY(return get_klass_by_index_impl(cpool, index, is_accessible, accessor);)
 578 }
 579 
 580 // ------------------------------------------------------------------
 581 // ciEnv::get_constant_by_index_impl
 582 //
 583 // Implementation of get_constant_by_index().
 584 ciConstant ciEnv::get_constant_by_index_impl(const constantPoolHandle&amp; cpool,
 585                                              int pool_index, int cache_index,
 586                                              ciInstanceKlass* accessor) {
 587   bool ignore_will_link;
 588   EXCEPTION_CONTEXT;
 589   int index = pool_index;
 590   if (cache_index &gt;= 0) {
 591     assert(index &lt; 0, &quot;only one kind of index at a time&quot;);
 592     index = cpool-&gt;object_to_cp_index(cache_index);
 593     oop obj = cpool-&gt;resolved_references()-&gt;obj_at(cache_index);
 594     if (obj != NULL) {
 595       if (oopDesc::equals(obj, Universe::the_null_sentinel())) {
 596         return ciConstant(T_OBJECT, get_object(NULL));
 597       }
 598       BasicType bt = T_OBJECT;
 599       if (cpool-&gt;tag_at(index).is_dynamic_constant())
 600         bt = FieldType::basic_type(cpool-&gt;uncached_signature_ref_at(index));
 601       if (is_reference_type(bt)) {
 602       } else {
 603         // we have to unbox the primitive value
 604         if (!is_java_primitive(bt))  return ciConstant();
 605         jvalue value;
 606         BasicType bt2 = java_lang_boxing_object::get_value(obj, &amp;value);
 607         assert(bt2 == bt, &quot;&quot;);
 608         switch (bt2) {
 609         case T_DOUBLE:  return ciConstant(value.d);
 610         case T_FLOAT:   return ciConstant(value.f);
 611         case T_LONG:    return ciConstant(value.j);
 612         case T_INT:     return ciConstant(bt2, value.i);
 613         case T_SHORT:   return ciConstant(bt2, value.s);
 614         case T_BYTE:    return ciConstant(bt2, value.b);
 615         case T_CHAR:    return ciConstant(bt2, value.c);
 616         case T_BOOLEAN: return ciConstant(bt2, value.z);
 617         default:  return ciConstant();
 618         }
 619       }
 620       ciObject* ciobj = get_object(obj);
 621       if (ciobj-&gt;is_array()) {
 622         return ciConstant(T_ARRAY, ciobj);
 623       } else {
 624         assert(ciobj-&gt;is_instance(), &quot;should be an instance&quot;);
 625         return ciConstant(T_OBJECT, ciobj);
 626       }
 627     }
 628   }
 629   constantTag tag = cpool-&gt;tag_at(index);
 630   if (tag.is_int()) {
 631     return ciConstant(T_INT, (jint)cpool-&gt;int_at(index));
 632   } else if (tag.is_long()) {
 633     return ciConstant((jlong)cpool-&gt;long_at(index));
 634   } else if (tag.is_float()) {
 635     return ciConstant((jfloat)cpool-&gt;float_at(index));
 636   } else if (tag.is_double()) {
 637     return ciConstant((jdouble)cpool-&gt;double_at(index));
 638   } else if (tag.is_string()) {
 639     oop string = NULL;
 640     assert(cache_index &gt;= 0, &quot;should have a cache index&quot;);
 641     if (cpool-&gt;is_pseudo_string_at(index)) {
 642       string = cpool-&gt;pseudo_string_at(index, cache_index);
 643     } else {
 644       string = cpool-&gt;string_at(index, cache_index, THREAD);
 645       if (HAS_PENDING_EXCEPTION) {
 646         CLEAR_PENDING_EXCEPTION;
 647         record_out_of_memory_failure();
 648         return ciConstant();
 649       }
 650     }
 651     ciObject* constant = get_object(string);
 652     if (constant-&gt;is_array()) {
 653       return ciConstant(T_ARRAY, constant);
 654     } else {
 655       assert (constant-&gt;is_instance(), &quot;must be an instance, or not? &quot;);
 656       return ciConstant(T_OBJECT, constant);
 657     }
 658   } else if (tag.is_klass() || tag.is_unresolved_klass()) {
 659     // 4881222: allow ldc to take a class type
 660     ciKlass* klass = get_klass_by_index_impl(cpool, index, ignore_will_link, accessor);
 661     if (HAS_PENDING_EXCEPTION) {
 662       CLEAR_PENDING_EXCEPTION;
 663       record_out_of_memory_failure();
 664       return ciConstant();
 665     }
 666     assert (klass-&gt;is_instance_klass() || klass-&gt;is_array_klass(),
 667             &quot;must be an instance or array klass &quot;);
 668     return ciConstant(T_OBJECT, klass-&gt;java_mirror());
 669   } else if (tag.is_method_type()) {
 670     // must execute Java code to link this CP entry into cache[i].f1
 671     ciSymbol* signature = get_symbol(cpool-&gt;method_type_signature_at(index));
 672     ciObject* ciobj = get_unloaded_method_type_constant(signature);
 673     return ciConstant(T_OBJECT, ciobj);
 674   } else if (tag.is_method_handle()) {
 675     // must execute Java code to link this CP entry into cache[i].f1
 676     int ref_kind        = cpool-&gt;method_handle_ref_kind_at(index);
 677     int callee_index    = cpool-&gt;method_handle_klass_index_at(index);
 678     ciKlass* callee     = get_klass_by_index_impl(cpool, callee_index, ignore_will_link, accessor);
 679     ciSymbol* name      = get_symbol(cpool-&gt;method_handle_name_ref_at(index));
 680     ciSymbol* signature = get_symbol(cpool-&gt;method_handle_signature_ref_at(index));
 681     ciObject* ciobj     = get_unloaded_method_handle_constant(callee, name, signature, ref_kind);
 682     return ciConstant(T_OBJECT, ciobj);
 683   } else if (tag.is_dynamic_constant()) {
 684     return ciConstant();
 685   } else {
 686     ShouldNotReachHere();
 687     return ciConstant();
 688   }
 689 }
 690 
 691 // ------------------------------------------------------------------
 692 // ciEnv::get_constant_by_index
 693 //
 694 // Pull a constant out of the constant pool.  How appropriate.
 695 //
 696 // Implementation note: this query is currently in no way cached.
 697 ciConstant ciEnv::get_constant_by_index(const constantPoolHandle&amp; cpool,
 698                                         int pool_index, int cache_index,
 699                                         ciInstanceKlass* accessor) {
 700   GUARDED_VM_ENTRY(return get_constant_by_index_impl(cpool, pool_index, cache_index, accessor);)
 701 }
 702 
 703 // ------------------------------------------------------------------
 704 // ciEnv::get_field_by_index_impl
 705 //
 706 // Implementation of get_field_by_index.
 707 //
 708 // Implementation note: the results of field lookups are cached
 709 // in the accessor klass.
 710 ciField* ciEnv::get_field_by_index_impl(ciInstanceKlass* accessor,
 711                                         int index) {
 712   ciConstantPoolCache* cache = accessor-&gt;field_cache();
 713   if (cache == NULL) {
 714     ciField* field = new (arena()) ciField(accessor, index);
 715     return field;
 716   } else {
 717     ciField* field = (ciField*)cache-&gt;get(index);
 718     if (field == NULL) {
 719       field = new (arena()) ciField(accessor, index);
 720       cache-&gt;insert(index, field);
 721     }
 722     return field;
 723   }
 724 }
 725 
 726 // ------------------------------------------------------------------
 727 // ciEnv::get_field_by_index
 728 //
 729 // Get a field by index from a klass&#39;s constant pool.
 730 ciField* ciEnv::get_field_by_index(ciInstanceKlass* accessor,
 731                                    int index) {
 732   GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)
 733 }
 734 
 735 // ------------------------------------------------------------------
 736 // ciEnv::lookup_method
 737 //
 738 // Perform an appropriate method lookup based on accessor, holder,
 739 // name, signature, and bytecode.
 740 Method* ciEnv::lookup_method(ciInstanceKlass* accessor,
 741                              ciKlass*         holder,
 742                              Symbol*          name,
 743                              Symbol*          sig,
 744                              Bytecodes::Code  bc,
 745                              constantTag      tag) {
 746   // Accessibility checks are performed in ciEnv::get_method_by_index_impl.
 747   assert(check_klass_accessibility(accessor, holder-&gt;get_Klass()), &quot;holder not accessible&quot;);
 748 
 749   InstanceKlass* accessor_klass = accessor-&gt;get_instanceKlass();
 750   Klass* holder_klass = holder-&gt;get_Klass();
 751   methodHandle dest_method;
 752   LinkInfo link_info(holder_klass, name, sig, accessor_klass, LinkInfo::needs_access_check, tag);
 753   switch (bc) {
 754   case Bytecodes::_invokestatic:
 755     dest_method =
 756       LinkResolver::resolve_static_call_or_null(link_info);
 757     break;
 758   case Bytecodes::_invokespecial:
 759     dest_method =
 760       LinkResolver::resolve_special_call_or_null(link_info);
 761     break;
 762   case Bytecodes::_invokeinterface:
 763     dest_method =
 764       LinkResolver::linktime_resolve_interface_method_or_null(link_info);
 765     break;
 766   case Bytecodes::_invokevirtual:
 767     dest_method =
 768       LinkResolver::linktime_resolve_virtual_method_or_null(link_info);
 769     break;
 770   default: ShouldNotReachHere();
 771   }
 772 
 773   return dest_method();
 774 }
 775 
 776 
 777 // ------------------------------------------------------------------
 778 // ciEnv::get_method_by_index_impl
 779 ciMethod* ciEnv::get_method_by_index_impl(const constantPoolHandle&amp; cpool,
 780                                           int index, Bytecodes::Code bc,
 781                                           ciInstanceKlass* accessor) {
 782   if (bc == Bytecodes::_invokedynamic) {
 783     ConstantPoolCacheEntry* cpce = cpool-&gt;invokedynamic_cp_cache_entry_at(index);
 784     bool is_resolved = !cpce-&gt;is_f1_null();
 785     // FIXME: code generation could allow for null (unlinked) call site
 786     // The call site could be made patchable as follows:
 787     // Load the appendix argument from the constant pool.
 788     // Test the appendix argument and jump to a known deopt routine if it is null.
 789     // Jump through a patchable call site, which is initially a deopt routine.
 790     // Patch the call site to the nmethod entry point of the static compiled lambda form.
 791     // As with other two-component call sites, both values must be independently verified.
 792 
 793     if (is_resolved) {
 794       // Get the invoker Method* from the constant pool.
 795       // (The appendix argument, if any, will be noted in the method&#39;s signature.)
 796       Method* adapter = cpce-&gt;f1_as_method();
 797       return get_method(adapter);
 798     }
 799 
 800     // Fake a method that is equivalent to a declared method.
 801     ciInstanceKlass* holder    = get_instance_klass(SystemDictionary::MethodHandle_klass());
 802     ciSymbol*        name      = ciSymbol::invokeBasic_name();
 803     ciSymbol*        signature = get_symbol(cpool-&gt;signature_ref_at(index));
 804     return get_unloaded_method(holder, name, signature, accessor);
 805   } else {
 806     const int holder_index = cpool-&gt;klass_ref_index_at(index);
 807     bool holder_is_accessible;
 808     ciKlass* holder = get_klass_by_index_impl(cpool, holder_index, holder_is_accessible, accessor);
 809 
 810     // Get the method&#39;s name and signature.
 811     Symbol* name_sym = cpool-&gt;name_ref_at(index);
 812     Symbol* sig_sym  = cpool-&gt;signature_ref_at(index);
 813 
 814     if (cpool-&gt;has_preresolution()
 815         || ((holder == ciEnv::MethodHandle_klass() || holder == ciEnv::VarHandle_klass()) &amp;&amp;
 816             MethodHandles::is_signature_polymorphic_name(holder-&gt;get_Klass(), name_sym))) {
 817       // Short-circuit lookups for JSR 292-related call sites.
 818       // That is, do not rely only on name-based lookups, because they may fail
 819       // if the names are not resolvable in the boot class loader (7056328).
 820       switch (bc) {
 821       case Bytecodes::_invokevirtual:
 822       case Bytecodes::_invokeinterface:
 823       case Bytecodes::_invokespecial:
 824       case Bytecodes::_invokestatic:
 825         {
 826           Method* m = ConstantPool::method_at_if_loaded(cpool, index);
 827           if (m != NULL) {
 828             return get_method(m);
 829           }
 830         }
 831         break;
 832       default:
 833         break;
 834       }
 835     }
 836 
 837     if (holder_is_accessible) {  // Our declared holder is loaded.
 838       constantTag tag = cpool-&gt;tag_ref_at(index);
 839       assert(accessor-&gt;get_instanceKlass() == cpool-&gt;pool_holder(), &quot;not the pool holder?&quot;);
 840       Method* m = lookup_method(accessor, holder, name_sym, sig_sym, bc, tag);
 841       if (m != NULL &amp;&amp;
 842           (bc == Bytecodes::_invokestatic
 843            ?  m-&gt;method_holder()-&gt;is_not_initialized()
 844            : !m-&gt;method_holder()-&gt;is_loaded())) {
 845         m = NULL;
 846       }
 847 #ifdef ASSERT
 848       if (m != NULL &amp;&amp; ReplayCompiles &amp;&amp; !ciReplay::is_loaded(m)) {
 849         m = NULL;
 850       }
 851 #endif
 852       if (m != NULL) {
 853         // We found the method.
 854         return get_method(m);
 855       }
 856     }
 857 
 858     // Either the declared holder was not loaded, or the method could
 859     // not be found.  Create a dummy ciMethod to represent the failed
 860     // lookup.
 861     ciSymbol* name      = get_symbol(name_sym);
 862     ciSymbol* signature = get_symbol(sig_sym);
 863     return get_unloaded_method(holder, name, signature, accessor);
 864   }
 865 }
 866 
 867 
 868 // ------------------------------------------------------------------
 869 // ciEnv::get_instance_klass_for_declared_method_holder
 870 ciInstanceKlass* ciEnv::get_instance_klass_for_declared_method_holder(ciKlass* method_holder) {
 871   // For the case of &lt;array&gt;.clone(), the method holder can be a ciArrayKlass
 872   // instead of a ciInstanceKlass.  For that case simply pretend that the
 873   // declared holder is Object.clone since that&#39;s where the call will bottom out.
 874   // A more correct fix would trickle out through many interfaces in CI,
 875   // requiring ciInstanceKlass* to become ciKlass* and many more places would
 876   // require checks to make sure the expected type was found.  Given that this
 877   // only occurs for clone() the more extensive fix seems like overkill so
 878   // instead we simply smear the array type into Object.
 879   guarantee(method_holder != NULL, &quot;no method holder&quot;);
 880   if (method_holder-&gt;is_instance_klass()) {
 881     return method_holder-&gt;as_instance_klass();
 882   } else if (method_holder-&gt;is_array_klass()) {
 883     return current()-&gt;Object_klass();
 884   } else {
 885     ShouldNotReachHere();
 886   }
 887   return NULL;
 888 }
 889 
 890 
 891 // ------------------------------------------------------------------
 892 // ciEnv::get_method_by_index
 893 ciMethod* ciEnv::get_method_by_index(const constantPoolHandle&amp; cpool,
 894                                      int index, Bytecodes::Code bc,
 895                                      ciInstanceKlass* accessor) {
 896   GUARDED_VM_ENTRY(return get_method_by_index_impl(cpool, index, bc, accessor);)
 897 }
 898 
 899 
 900 // ------------------------------------------------------------------
 901 // ciEnv::name_buffer
 902 char *ciEnv::name_buffer(int req_len) {
 903   if (_name_buffer_len &lt; req_len) {
 904     if (_name_buffer == NULL) {
 905       _name_buffer = (char*)arena()-&gt;Amalloc(sizeof(char)*req_len);
 906       _name_buffer_len = req_len;
 907     } else {
 908       _name_buffer =
 909         (char*)arena()-&gt;Arealloc(_name_buffer, _name_buffer_len, req_len);
 910       _name_buffer_len = req_len;
 911     }
 912   }
 913   return _name_buffer;
 914 }
 915 
 916 // ------------------------------------------------------------------
 917 // ciEnv::is_in_vm
 918 bool ciEnv::is_in_vm() {
 919   return JavaThread::current()-&gt;thread_state() == _thread_in_vm;
 920 }
 921 
 922 bool ciEnv::system_dictionary_modification_counter_changed_locked() {
 923   assert_locked_or_safepoint(Compile_lock);
 924   return _system_dictionary_modification_counter != SystemDictionary::number_of_modifications();
 925 }
 926 
 927 bool ciEnv::system_dictionary_modification_counter_changed() {
 928   VM_ENTRY_MARK;
 929   MutexLocker ml(Compile_lock, THREAD); // lock with safepoint check
 930   return system_dictionary_modification_counter_changed_locked();
 931 }
 932 
 933 // ------------------------------------------------------------------
 934 // ciEnv::validate_compile_task_dependencies
 935 //
 936 // Check for changes during compilation (e.g. class loads, evolution,
 937 // breakpoints, call site invalidation).
 938 void ciEnv::validate_compile_task_dependencies(ciMethod* target) {
 939   if (failing())  return;  // no need for further checks
 940 
 941   bool counter_changed = system_dictionary_modification_counter_changed_locked();
 942   Dependencies::DepType result = dependencies()-&gt;validate_dependencies(_task, counter_changed);
 943   if (result != Dependencies::end_marker) {
 944     if (result == Dependencies::call_site_target_value) {
 945       _inc_decompile_count_on_failure = false;
 946       record_failure(&quot;call site target change&quot;);
 947     } else if (Dependencies::is_klass_type(result)) {
 948       record_failure(&quot;concurrent class loading&quot;);
 949     } else {
 950       record_failure(&quot;invalid non-klass dependency&quot;);
 951     }
 952   }
 953 }
 954 
 955 // ------------------------------------------------------------------
 956 // ciEnv::register_method
 957 void ciEnv::register_method(ciMethod* target,
 958                             int entry_bci,
 959                             CodeOffsets* offsets,
 960                             int orig_pc_offset,
 961                             CodeBuffer* code_buffer,
 962                             int frame_words,
 963                             OopMapSet* oop_map_set,
 964                             ExceptionHandlerTable* handler_table,
 965                             ImplicitExceptionTable* inc_table,
 966                             AbstractCompiler* compiler,
 967                             bool has_unsafe_access,
 968                             bool has_wide_vectors,
 969                             RTMState  rtm_state) {
 970   VM_ENTRY_MARK;
 971   nmethod* nm = NULL;
 972   {
 973     // To prevent compile queue updates.
 974     MutexLocker locker(MethodCompileQueue_lock, THREAD);
 975 
 976     // Prevent SystemDictionary::add_to_hierarchy from running
 977     // and invalidating our dependencies until we install this method.
 978     // No safepoints are allowed. Otherwise, class redefinition can occur in between.
 979     MutexLocker ml(Compile_lock);
 980     NoSafepointVerifier nsv;
 981 
 982     // Change in Jvmti state may invalidate compilation.
 983     if (!failing() &amp;&amp; jvmti_state_changed()) {
 984       record_failure(&quot;Jvmti state change invalidated dependencies&quot;);
 985     }
 986 
 987     // Change in DTrace flags may invalidate compilation.
 988     if (!failing() &amp;&amp;
 989         ( (!dtrace_extended_probes() &amp;&amp; ExtendedDTraceProbes) ||
 990           (!dtrace_method_probes() &amp;&amp; DTraceMethodProbes) ||
 991           (!dtrace_alloc_probes() &amp;&amp; DTraceAllocProbes) )) {
 992       record_failure(&quot;DTrace flags change invalidated dependencies&quot;);
 993     }
 994 
 995     if (!failing()) {
 996       if (log() != NULL) {
 997         // Log the dependencies which this compilation declares.
 998         dependencies()-&gt;log_all_dependencies();
 999       }
1000 
1001       // Encode the dependencies now, so we can check them right away.
1002       dependencies()-&gt;encode_content_bytes();
1003 
1004       // Check for {class loads, evolution, breakpoints, ...} during compilation
1005       validate_compile_task_dependencies(target);
1006     }
1007 
1008     methodHandle method(THREAD, target-&gt;get_Method());
1009 
1010 #if INCLUDE_RTM_OPT
1011     if (!failing() &amp;&amp; (rtm_state != NoRTM) &amp;&amp;
1012         (method()-&gt;method_data() != NULL) &amp;&amp;
1013         (method()-&gt;method_data()-&gt;rtm_state() != rtm_state)) {
1014       // Preemptive decompile if rtm state was changed.
1015       record_failure(&quot;RTM state change invalidated rtm code&quot;);
1016     }
1017 #endif
1018 
1019     if (failing()) {
1020       // While not a true deoptimization, it is a preemptive decompile.
1021       MethodData* mdo = method()-&gt;method_data();
1022       if (mdo != NULL &amp;&amp; _inc_decompile_count_on_failure) {
1023         mdo-&gt;inc_decompile_count();
1024       }
1025 
1026       // All buffers in the CodeBuffer are allocated in the CodeCache.
1027       // If the code buffer is created on each compile attempt
1028       // as in C2, then it must be freed.
1029       code_buffer-&gt;free_blob();
1030       return;
1031     }
1032 
1033     assert(offsets-&gt;value(CodeOffsets::Deopt) != -1, &quot;must have deopt entry&quot;);
1034     assert(offsets-&gt;value(CodeOffsets::Exceptions) != -1, &quot;must have exception entry&quot;);
1035 
1036     nm =  nmethod::new_nmethod(method,
1037                                compile_id(),
1038                                entry_bci,
1039                                offsets,
1040                                orig_pc_offset,
1041                                debug_info(), dependencies(), code_buffer,
1042                                frame_words, oop_map_set,
1043                                handler_table, inc_table,
1044                                compiler, task()-&gt;comp_level());
1045 
1046     // Free codeBlobs
1047     code_buffer-&gt;free_blob();
1048 
1049     if (nm != NULL) {
1050       nm-&gt;set_has_unsafe_access(has_unsafe_access);
1051       nm-&gt;set_has_wide_vectors(has_wide_vectors);
1052 #if INCLUDE_RTM_OPT
1053       nm-&gt;set_rtm_state(rtm_state);
1054 #endif
1055 
1056       // Record successful registration.
1057       // (Put nm into the task handle *before* publishing to the Java heap.)
1058       if (task() != NULL) {
1059         task()-&gt;set_code(nm);
1060       }
1061 
1062       if (entry_bci == InvocationEntryBci) {
1063         if (TieredCompilation) {
1064           // If there is an old version we&#39;re done with it
1065           CompiledMethod* old = method-&gt;code();
1066           if (TraceMethodReplacement &amp;&amp; old != NULL) {
1067             ResourceMark rm;
1068             char *method_name = method-&gt;name_and_sig_as_C_string();
1069             tty-&gt;print_cr(&quot;Replacing method %s&quot;, method_name);
1070           }
1071           if (old != NULL) {
1072             old-&gt;make_not_used();
1073           }
1074         }
1075         if (TraceNMethodInstalls) {
1076           ResourceMark rm;
1077           char *method_name = method-&gt;name_and_sig_as_C_string();
1078           ttyLocker ttyl;
1079           tty-&gt;print_cr(&quot;Installing method (%d) %s &quot;,
1080                         task()-&gt;comp_level(),
1081                         method_name);
1082         }
1083         // Allow the code to be executed
1084         method-&gt;set_code(method, nm);
1085       } else {
1086         if (TraceNMethodInstalls) {
1087           ResourceMark rm;
1088           char *method_name = method-&gt;name_and_sig_as_C_string();
1089           ttyLocker ttyl;
1090           tty-&gt;print_cr(&quot;Installing osr method (%d) %s @ %d&quot;,
1091                         task()-&gt;comp_level(),
1092                         method_name,
1093                         entry_bci);
1094         }
1095         method-&gt;method_holder()-&gt;add_osr_nmethod(nm);
1096       }
1097       nm-&gt;make_in_use();
1098     }
1099   }  // safepoints are allowed again
1100 
1101   if (nm != NULL) {
1102     // JVMTI -- compiled method notification (must be done outside lock)
1103     nm-&gt;post_compiled_method_load_event();
1104   } else {
1105     // The CodeCache is full.
1106     record_failure(&quot;code cache is full&quot;);
1107   }
1108 }
1109 
1110 
1111 // ------------------------------------------------------------------
1112 // ciEnv::find_system_klass
1113 ciKlass* ciEnv::find_system_klass(ciSymbol* klass_name) {
1114   VM_ENTRY_MARK;
1115   return get_klass_by_name_impl(NULL, constantPoolHandle(), klass_name, false);
1116 }
1117 
1118 // ------------------------------------------------------------------
1119 // ciEnv::comp_level
1120 int ciEnv::comp_level() {
1121   if (task() == NULL)  return CompLevel_highest_tier;
1122   return task()-&gt;comp_level();
1123 }
1124 
1125 // ------------------------------------------------------------------
1126 // ciEnv::compile_id
1127 uint ciEnv::compile_id() {
1128   if (task() == NULL)  return 0;
1129   return task()-&gt;compile_id();
1130 }
1131 
1132 // ------------------------------------------------------------------
1133 // ciEnv::notice_inlined_method()
1134 void ciEnv::notice_inlined_method(ciMethod* method) {
1135   _num_inlined_bytecodes += method-&gt;code_size_for_inlining();
1136 }
1137 
1138 // ------------------------------------------------------------------
1139 // ciEnv::num_inlined_bytecodes()
1140 int ciEnv::num_inlined_bytecodes() const {
1141   return _num_inlined_bytecodes;
1142 }
1143 
1144 // ------------------------------------------------------------------
1145 // ciEnv::record_failure()
1146 void ciEnv::record_failure(const char* reason) {
1147   if (_failure_reason == NULL) {
1148     // Record the first failure reason.
1149     _failure_reason = reason;
1150   }
1151 }
1152 
1153 void ciEnv::report_failure(const char* reason) {
1154   EventCompilationFailure event;
1155   if (event.should_commit()) {
1156     event.set_compileId(compile_id());
1157     event.set_failureMessage(reason);
1158     event.commit();
1159   }
1160 }
1161 
1162 // ------------------------------------------------------------------
1163 // ciEnv::record_method_not_compilable()
1164 void ciEnv::record_method_not_compilable(const char* reason, bool all_tiers) {
1165   int new_compilable =
1166     all_tiers ? MethodCompilable_never : MethodCompilable_not_at_tier ;
1167 
1168   // Only note transitions to a worse state
1169   if (new_compilable &gt; _compilable) {
1170     if (log() != NULL) {
1171       if (all_tiers) {
1172         log()-&gt;elem(&quot;method_not_compilable&quot;);
1173       } else {
1174         log()-&gt;elem(&quot;method_not_compilable_at_tier level=&#39;%d&#39;&quot;,
1175                     current()-&gt;task()-&gt;comp_level());
1176       }
1177     }
1178     _compilable = new_compilable;
1179 
1180     // Reset failure reason; this one is more important.
1181     _failure_reason = NULL;
1182     record_failure(reason);
1183   }
1184 }
1185 
1186 // ------------------------------------------------------------------
1187 // ciEnv::record_out_of_memory_failure()
1188 void ciEnv::record_out_of_memory_failure() {
1189   // If memory is low, we stop compiling methods.
1190   record_method_not_compilable(&quot;out of memory&quot;);
1191 }
1192 
1193 ciInstance* ciEnv::unloaded_ciinstance() {
1194   GUARDED_VM_ENTRY(return _factory-&gt;get_unloaded_object_constant();)
1195 }
1196 
1197 // ------------------------------------------------------------------
1198 // ciEnv::dump_replay_data*
1199 
1200 // Don&#39;t change thread state and acquire any locks.
1201 // Safe to call from VM error reporter.
1202 
1203 void ciEnv::dump_compile_data(outputStream* out) {
1204   CompileTask* task = this-&gt;task();
1205   if (task) {
1206     Method* method = task-&gt;method();
1207     int entry_bci = task-&gt;osr_bci();
1208     int comp_level = task-&gt;comp_level();
1209     out-&gt;print(&quot;compile %s %s %s %d %d&quot;,
1210                method-&gt;klass_name()-&gt;as_quoted_ascii(),
1211                method-&gt;name()-&gt;as_quoted_ascii(),
1212                method-&gt;signature()-&gt;as_quoted_ascii(),
1213                entry_bci, comp_level);
1214     if (compiler_data() != NULL) {
1215       if (is_c2_compile(comp_level)) {
1216 #ifdef COMPILER2
1217         // Dump C2 inlining data.
1218         ((Compile*)compiler_data())-&gt;dump_inline_data(out);
1219 #endif
1220       } else if (is_c1_compile(comp_level)) {
1221 #ifdef COMPILER1
1222         // Dump C1 inlining data.
1223         ((Compilation*)compiler_data())-&gt;dump_inline_data(out);
1224 #endif
1225       }
1226     }
1227     out-&gt;cr();
1228   }
1229 }
1230 
1231 void ciEnv::dump_replay_data_unsafe(outputStream* out) {
1232   ResourceMark rm;
1233 #if INCLUDE_JVMTI
1234   out-&gt;print_cr(&quot;JvmtiExport can_access_local_variables %d&quot;,     _jvmti_can_access_local_variables);
1235   out-&gt;print_cr(&quot;JvmtiExport can_hotswap_or_post_breakpoint %d&quot;, _jvmti_can_hotswap_or_post_breakpoint);
1236   out-&gt;print_cr(&quot;JvmtiExport can_post_on_exceptions %d&quot;,         _jvmti_can_post_on_exceptions);
1237 #endif // INCLUDE_JVMTI
1238 
1239   GrowableArray&lt;ciMetadata*&gt;* objects = _factory-&gt;get_ci_metadata();
1240   out-&gt;print_cr(&quot;# %d ciObject found&quot;, objects-&gt;length());
1241   for (int i = 0; i &lt; objects-&gt;length(); i++) {
1242     objects-&gt;at(i)-&gt;dump_replay_data(out);
1243   }
1244   dump_compile_data(out);
1245   out-&gt;flush();
1246 }
1247 
1248 void ciEnv::dump_replay_data(outputStream* out) {
1249   GUARDED_VM_ENTRY(
1250     MutexLocker ml(Compile_lock);
1251     dump_replay_data_unsafe(out);
1252   )
1253 }
1254 
1255 void ciEnv::dump_replay_data(int compile_id) {
1256   static char buffer[O_BUFLEN];
1257   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;replay_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1258   if (ret &gt; 0) {
1259     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1260     if (fd != -1) {
1261       FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1262       if (replay_data_file != NULL) {
1263         fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1264         dump_replay_data(&amp;replay_data_stream);
1265         tty-&gt;print_cr(&quot;# Compiler replay data is saved as: %s&quot;, buffer);
1266       } else {
1267         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump replay data.&quot;);
1268       }
1269     }
1270   }
1271 }
1272 
1273 void ciEnv::dump_inline_data(int compile_id) {
1274   static char buffer[O_BUFLEN];
1275   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;inline_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1276   if (ret &gt; 0) {
1277     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1278     if (fd != -1) {
1279       FILE* inline_data_file = os::open(fd, &quot;w&quot;);
1280       if (inline_data_file != NULL) {
1281         fileStream replay_data_stream(inline_data_file, /*need_close=*/true);
1282         GUARDED_VM_ENTRY(
1283           MutexLocker ml(Compile_lock);
1284           dump_compile_data(&amp;replay_data_stream);
1285         )
1286         replay_data_stream.flush();
1287         tty-&gt;print(&quot;# Compiler inline data is saved as: &quot;);
1288         tty-&gt;print_cr(&quot;%s&quot;, buffer);
1289       } else {
1290         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump inline data.&quot;);
1291       }
1292     }
1293   }
1294 }
    </pre>
  </body>
</html>