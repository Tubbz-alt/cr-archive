<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEventController.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interpreter/interpreter.hpp&quot;
  27 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  28 #include &quot;logging/log.hpp&quot;
  29 #include &quot;memory/resourceArea.hpp&quot;
  30 #include &quot;prims/jvmtiEventController.hpp&quot;
  31 #include &quot;prims/jvmtiEventController.inline.hpp&quot;
  32 #include &quot;prims/jvmtiExport.hpp&quot;
  33 #include &quot;prims/jvmtiImpl.hpp&quot;
  34 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
<a name="2" id="anc2"></a><span class="line-added">  35 #include &quot;runtime/deoptimization.hpp&quot;</span>
  36 #include &quot;runtime/frame.hpp&quot;
  37 #include &quot;runtime/thread.inline.hpp&quot;
  38 #include &quot;runtime/threadSMR.hpp&quot;
  39 #include &quot;runtime/vframe.hpp&quot;
  40 #include &quot;runtime/vframe_hp.hpp&quot;
  41 #include &quot;runtime/vmThread.hpp&quot;
  42 #include &quot;runtime/vmOperations.hpp&quot;
  43 
  44 #ifdef JVMTI_TRACE
  45 #define EC_TRACE(out) do { \
  46   if (JvmtiTrace::trace_event_controller()) { \
  47     SafeResourceMark rm; \
  48     log_trace(jvmti) out; \
  49   } \
  50 } while (0)
  51 #else
  52 #define EC_TRACE(out)
  53 #endif /*JVMTI_TRACE */
  54 
  55 // bits for standard events
  56 
  57 static const jlong  SINGLE_STEP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_SINGLE_STEP - TOTAL_MIN_EVENT_TYPE_VAL));
  58 static const jlong  FRAME_POP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FRAME_POP - TOTAL_MIN_EVENT_TYPE_VAL));
  59 static const jlong  BREAKPOINT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_BREAKPOINT - TOTAL_MIN_EVENT_TYPE_VAL));
  60 static const jlong  FIELD_ACCESS_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FIELD_ACCESS - TOTAL_MIN_EVENT_TYPE_VAL));
  61 static const jlong  FIELD_MODIFICATION_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FIELD_MODIFICATION - TOTAL_MIN_EVENT_TYPE_VAL));
  62 static const jlong  METHOD_ENTRY_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_METHOD_ENTRY - TOTAL_MIN_EVENT_TYPE_VAL));
  63 static const jlong  METHOD_EXIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_METHOD_EXIT - TOTAL_MIN_EVENT_TYPE_VAL));
  64 static const jlong  CLASS_FILE_LOAD_HOOK_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_FILE_LOAD_HOOK - TOTAL_MIN_EVENT_TYPE_VAL));
  65 static const jlong  NATIVE_METHOD_BIND_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_NATIVE_METHOD_BIND - TOTAL_MIN_EVENT_TYPE_VAL));
  66 static const jlong  VM_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_START - TOTAL_MIN_EVENT_TYPE_VAL));
  67 static const jlong  VM_INIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_INIT - TOTAL_MIN_EVENT_TYPE_VAL));
  68 static const jlong  VM_DEATH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_DEATH - TOTAL_MIN_EVENT_TYPE_VAL));
  69 static const jlong  CLASS_LOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_LOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  70 static const jlong  CLASS_PREPARE_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_PREPARE - TOTAL_MIN_EVENT_TYPE_VAL));
  71 static const jlong  THREAD_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_THREAD_START - TOTAL_MIN_EVENT_TYPE_VAL));
  72 static const jlong  THREAD_END_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_THREAD_END - TOTAL_MIN_EVENT_TYPE_VAL));
  73 static const jlong  EXCEPTION_THROW_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_EXCEPTION - TOTAL_MIN_EVENT_TYPE_VAL));
  74 static const jlong  EXCEPTION_CATCH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_EXCEPTION_CATCH - TOTAL_MIN_EVENT_TYPE_VAL));
  75 static const jlong  MONITOR_CONTENDED_ENTER_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_CONTENDED_ENTER - TOTAL_MIN_EVENT_TYPE_VAL));
  76 static const jlong  MONITOR_CONTENDED_ENTERED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_CONTENDED_ENTERED - TOTAL_MIN_EVENT_TYPE_VAL));
  77 static const jlong  MONITOR_WAIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_WAIT - TOTAL_MIN_EVENT_TYPE_VAL));
  78 static const jlong  MONITOR_WAITED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_WAITED - TOTAL_MIN_EVENT_TYPE_VAL));
  79 static const jlong  DYNAMIC_CODE_GENERATED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_DYNAMIC_CODE_GENERATED - TOTAL_MIN_EVENT_TYPE_VAL));
  80 static const jlong  DATA_DUMP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_DATA_DUMP_REQUEST - TOTAL_MIN_EVENT_TYPE_VAL));
  81 static const jlong  COMPILED_METHOD_LOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_COMPILED_METHOD_LOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  82 static const jlong  COMPILED_METHOD_UNLOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_COMPILED_METHOD_UNLOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  83 static const jlong  GARBAGE_COLLECTION_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_GARBAGE_COLLECTION_START - TOTAL_MIN_EVENT_TYPE_VAL));
  84 static const jlong  GARBAGE_COLLECTION_FINISH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_GARBAGE_COLLECTION_FINISH - TOTAL_MIN_EVENT_TYPE_VAL));
  85 static const jlong  OBJECT_FREE_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_OBJECT_FREE - TOTAL_MIN_EVENT_TYPE_VAL));
  86 static const jlong  RESOURCE_EXHAUSTED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_RESOURCE_EXHAUSTED - TOTAL_MIN_EVENT_TYPE_VAL));
  87 static const jlong  VM_OBJECT_ALLOC_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_OBJECT_ALLOC - TOTAL_MIN_EVENT_TYPE_VAL));
  88 static const jlong  SAMPLED_OBJECT_ALLOC_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_SAMPLED_OBJECT_ALLOC - TOTAL_MIN_EVENT_TYPE_VAL));
  89 
  90 // bits for extension events
  91 static const jlong  CLASS_UNLOAD_BIT = (((jlong)1) &lt;&lt; (EXT_EVENT_CLASS_UNLOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  92 
  93 
  94 static const jlong  MONITOR_BITS = MONITOR_CONTENDED_ENTER_BIT | MONITOR_CONTENDED_ENTERED_BIT |
  95                           MONITOR_WAIT_BIT | MONITOR_WAITED_BIT;
  96 static const jlong  EXCEPTION_BITS = EXCEPTION_THROW_BIT | EXCEPTION_CATCH_BIT;
  97 static const jlong  INTERP_EVENT_BITS =  SINGLE_STEP_BIT | METHOD_ENTRY_BIT | METHOD_EXIT_BIT |
  98                                 FRAME_POP_BIT | FIELD_ACCESS_BIT | FIELD_MODIFICATION_BIT;
  99 static const jlong  THREAD_FILTERED_EVENT_BITS = INTERP_EVENT_BITS | EXCEPTION_BITS | MONITOR_BITS |
 100                                         BREAKPOINT_BIT | CLASS_LOAD_BIT | CLASS_PREPARE_BIT | THREAD_END_BIT |
 101                                         SAMPLED_OBJECT_ALLOC_BIT;
 102 static const jlong  NEED_THREAD_LIFE_EVENTS = THREAD_FILTERED_EVENT_BITS | THREAD_START_BIT;
 103 static const jlong  EARLY_EVENT_BITS = CLASS_FILE_LOAD_HOOK_BIT | CLASS_LOAD_BIT | CLASS_PREPARE_BIT |
 104                                VM_START_BIT | VM_INIT_BIT | VM_DEATH_BIT | NATIVE_METHOD_BIND_BIT |
 105                                THREAD_START_BIT | THREAD_END_BIT |
 106                                COMPILED_METHOD_LOAD_BIT | COMPILED_METHOD_UNLOAD_BIT |
 107                                DYNAMIC_CODE_GENERATED_BIT;
 108 static const jlong  GLOBAL_EVENT_BITS = ~THREAD_FILTERED_EVENT_BITS;
 109 static const jlong  SHOULD_POST_ON_EXCEPTIONS_BITS = EXCEPTION_BITS | METHOD_EXIT_BIT | FRAME_POP_BIT;
 110 
 111 ///////////////////////////////////////////////////////////////
 112 //
 113 // JvmtiEventEnabled
 114 //
 115 
 116 JvmtiEventEnabled::JvmtiEventEnabled() {
 117   clear();
 118 }
 119 
 120 
 121 void JvmtiEventEnabled::clear() {
 122   _enabled_bits = 0;
 123 #ifndef PRODUCT
 124   _init_guard = JEE_INIT_GUARD;
 125 #endif
 126 }
 127 
 128 void JvmtiEventEnabled::set_enabled(jvmtiEvent event_type, bool enabled) {
 129   jlong bits = get_bits();
 130   jlong mask = bit_for(event_type);
 131   if (enabled) {
 132     bits |= mask;
 133   } else {
 134     bits &amp;= ~mask;
 135   }
 136   set_bits(bits);
 137 }
 138 
 139 
 140 ///////////////////////////////////////////////////////////////
 141 //
 142 // JvmtiEnvThreadEventEnable
 143 //
 144 
 145 JvmtiEnvThreadEventEnable::JvmtiEnvThreadEventEnable() {
 146   _event_user_enabled.clear();
 147   _event_enabled.clear();
 148 }
 149 
 150 
 151 JvmtiEnvThreadEventEnable::~JvmtiEnvThreadEventEnable() {
 152   _event_user_enabled.clear();
 153   _event_enabled.clear();
 154 }
 155 
 156 
 157 ///////////////////////////////////////////////////////////////
 158 //
 159 // JvmtiThreadEventEnable
 160 //
 161 
 162 JvmtiThreadEventEnable::JvmtiThreadEventEnable() {
 163   _event_enabled.clear();
 164 }
 165 
 166 
 167 JvmtiThreadEventEnable::~JvmtiThreadEventEnable() {
 168   _event_enabled.clear();
 169 }
 170 
 171 
 172 ///////////////////////////////////////////////////////////////
 173 //
 174 // JvmtiEnvEventEnable
 175 //
 176 
 177 JvmtiEnvEventEnable::JvmtiEnvEventEnable() {
 178   _event_user_enabled.clear();
 179   _event_callback_enabled.clear();
 180   _event_enabled.clear();
 181 }
 182 
 183 
 184 JvmtiEnvEventEnable::~JvmtiEnvEventEnable() {
 185   _event_user_enabled.clear();
 186   _event_callback_enabled.clear();
 187   _event_enabled.clear();
 188 }
 189 
 190 
 191 ///////////////////////////////////////////////////////////////
 192 //
 193 // VM_EnterInterpOnlyMode
 194 //
 195 
 196 class VM_EnterInterpOnlyMode : public VM_Operation {
 197 private:
 198   JvmtiThreadState *_state;
 199 
 200 public:
 201   VM_EnterInterpOnlyMode(JvmtiThreadState *state);
 202 
 203   bool allow_nested_vm_operations() const        { return true; }
 204   VMOp_Type type() const { return VMOp_EnterInterpOnlyMode; }
 205   void doit();
 206 
 207   // to do: this same function is in jvmtiImpl - should be in one place
 208   bool can_be_deoptimized(vframe* vf) {
 209     return (vf-&gt;is_compiled_frame() &amp;&amp; vf-&gt;fr().can_be_deoptimized());
 210   }
 211 };
 212 
 213 VM_EnterInterpOnlyMode::VM_EnterInterpOnlyMode(JvmtiThreadState *state)
 214   : _state(state)
 215 {
 216 }
 217 
 218 
 219 void VM_EnterInterpOnlyMode::doit() {
 220   // Set up the current stack depth for later tracking
 221   _state-&gt;invalidate_cur_stack_depth();
 222 
 223   _state-&gt;enter_interp_only_mode();
 224 
 225   JavaThread *thread = _state-&gt;get_thread();
 226   if (thread-&gt;has_last_Java_frame()) {
 227     // If running in fullspeed mode, single stepping is implemented
 228     // as follows: first, the interpreter does not dispatch to
 229     // compiled code for threads that have single stepping enabled;
 230     // second, we deoptimize all methods on the thread&#39;s stack when
 231     // interpreted-only mode is enabled the first time for a given
 232     // thread (nothing to do if no Java frames yet).
 233     int num_marked = 0;
 234     ResourceMark resMark;
 235     RegisterMap rm(thread, false);
 236     for (vframe* vf = thread-&gt;last_java_vframe(&amp;rm); vf; vf = vf-&gt;sender()) {
 237       if (can_be_deoptimized(vf)) {
 238         ((compiledVFrame*) vf)-&gt;code()-&gt;mark_for_deoptimization();
 239         ++num_marked;
 240       }
 241     }
 242     if (num_marked &gt; 0) {
<a name="3" id="anc3"></a><span class="line-modified"> 243       Deoptimization::deoptimize_all_marked();</span>

 244     }
 245   }
 246 }
 247 
 248 
 249 ///////////////////////////////////////////////////////////////
 250 //
 251 // VM_ChangeSingleStep
 252 //
 253 
 254 class VM_ChangeSingleStep : public VM_Operation {
 255 private:
 256   bool _on;
 257 
 258 public:
 259   VM_ChangeSingleStep(bool on);
 260   VMOp_Type type() const                         { return VMOp_ChangeSingleStep; }
 261   bool allow_nested_vm_operations() const        { return true; }
 262   void doit();   // method definition is after definition of JvmtiEventControllerPrivate because of scoping
 263 };
 264 
 265 
 266 VM_ChangeSingleStep::VM_ChangeSingleStep(bool on)
<a name="4" id="anc4"></a><span class="line-modified"> 267   : _on(on)</span>
 268 {
 269 }
 270 
 271 
 272 
 273 
 274 ///////////////////////////////////////////////////////////////
 275 //
 276 // JvmtiEventControllerPrivate
 277 //
 278 // Private internal implementation methods for JvmtiEventController.
 279 //
 280 // These methods are thread safe either because they are called
 281 // in early VM initialization which is single threaded, or they
 282 // hold the JvmtiThreadState_lock.
 283 //
 284 
 285 class JvmtiEventControllerPrivate : public AllStatic {
 286   static bool _initialized;
 287 public:
 288   static void set_should_post_single_step(bool on);
 289   static void enter_interp_only_mode(JvmtiThreadState *state);
 290   static void leave_interp_only_mode(JvmtiThreadState *state);
 291   static void recompute_enabled();
 292   static jlong recompute_env_enabled(JvmtiEnvBase* env);
 293   static jlong recompute_env_thread_enabled(JvmtiEnvThreadState* ets, JvmtiThreadState* state);
 294   static jlong recompute_thread_enabled(JvmtiThreadState *state);
 295   static void event_init();
 296 
 297   static void set_user_enabled(JvmtiEnvBase *env, JavaThread *thread,
 298                         jvmtiEvent event_type, bool enabled);
 299   static void set_event_callbacks(JvmtiEnvBase *env,
 300                                   const jvmtiEventCallbacks* callbacks,
 301                                   jint size_of_callbacks);
 302 
 303   static void set_extension_event_callback(JvmtiEnvBase *env,
 304                                            jint extension_event_index,
 305                                            jvmtiExtensionEvent callback);
 306 
 307   static void set_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 308   static void clear_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 309   static void clear_to_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 310   static void change_field_watch(jvmtiEvent event_type, bool added);
 311 
 312   static void thread_started(JavaThread *thread);
 313   static void thread_ended(JavaThread *thread);
 314 
 315   static void env_initialize(JvmtiEnvBase *env);
 316   static void env_dispose(JvmtiEnvBase *env);
 317 
 318   static void vm_start();
 319   static void vm_init();
 320   static void vm_death();
 321 
 322   static void trace_changed(JvmtiThreadState *state, jlong now_enabled, jlong changed);
 323   static void trace_changed(jlong now_enabled, jlong changed);
 324 };
 325 
 326 bool JvmtiEventControllerPrivate::_initialized = false;
 327 
 328 void JvmtiEventControllerPrivate::set_should_post_single_step(bool on) {
 329   // we have permission to do this, VM op doesn&#39;t
 330   JvmtiExport::set_should_post_single_step(on);
 331 }
 332 
 333 
<a name="5" id="anc5"></a><span class="line-modified"> 334 // When _on == true, we use the safepoint interpreter dispatch table</span>
<span class="line-modified"> 335 // to allow us to find the single step points. Otherwise, we switch</span>
<span class="line-modified"> 336 // back to the regular interpreter dispatch table.</span>
<span class="line-modified"> 337 // Note: We call Interpreter::notice_safepoints() and ignore_safepoints()</span>
<span class="line-modified"> 338 // in a VM_Operation to safely make the dispatch table switch. We</span>
<span class="line-modified"> 339 // no longer rely on the safepoint mechanism to do any of this work</span>
<span class="line-modified"> 340 // for us.</span>

 341 void VM_ChangeSingleStep::doit() {
<a name="6" id="anc6"></a><span class="line-added"> 342   log_debug(interpreter, safepoint)(&quot;changing single step to &#39;%s&#39;&quot;, _on ? &quot;on&quot; : &quot;off&quot;);</span>
 343   JvmtiEventControllerPrivate::set_should_post_single_step(_on);
 344   if (_on) {
 345     Interpreter::notice_safepoints();
<a name="7" id="anc7"></a><span class="line-added"> 346   } else {</span>
<span class="line-added"> 347     Interpreter::ignore_safepoints();</span>
 348   }
 349 }
 350 
 351 
 352 void JvmtiEventControllerPrivate::enter_interp_only_mode(JvmtiThreadState *state) {
 353   EC_TRACE((&quot;[%s] # Entering interpreter only mode&quot;,
 354             JvmtiTrace::safe_get_thread_name(state-&gt;get_thread())));
 355 
 356   VM_EnterInterpOnlyMode op(state);
 357   VMThread::execute(&amp;op);
 358 }
 359 
 360 
 361 void
 362 JvmtiEventControllerPrivate::leave_interp_only_mode(JvmtiThreadState *state) {
 363   EC_TRACE((&quot;[%s] # Leaving interpreter only mode&quot;,
 364             JvmtiTrace::safe_get_thread_name(state-&gt;get_thread())));
 365   state-&gt;leave_interp_only_mode();
 366 }
 367 
 368 
 369 void
 370 JvmtiEventControllerPrivate::trace_changed(JvmtiThreadState *state, jlong now_enabled, jlong changed) {
 371 #ifdef JVMTI_TRACE
 372   if (JvmtiTrace::trace_event_controller()) {
 373     SafeResourceMark rm;
 374     // traces standard events only
 375     for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 376       jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 377       if (changed &amp; bit) {
 378         // it changed, print it
 379          log_trace(jvmti)(&quot;[%s] # %s event %s&quot;,
 380                       JvmtiTrace::safe_get_thread_name(state-&gt;get_thread()),
 381                       (now_enabled &amp; bit)? &quot;Enabling&quot; : &quot;Disabling&quot;, JvmtiTrace::event_name((jvmtiEvent)ei));
 382       }
 383     }
 384   }
 385 #endif /*JVMTI_TRACE */
 386 }
 387 
 388 
 389 void
 390 JvmtiEventControllerPrivate::trace_changed(jlong now_enabled, jlong changed) {
 391 #ifdef JVMTI_TRACE
 392   if (JvmtiTrace::trace_event_controller()) {
 393     SafeResourceMark rm;
 394     // traces standard events only
 395     for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 396       jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 397       if (changed &amp; bit) {
 398         // it changed, print it
 399          log_trace(jvmti)(&quot;[-] # %s event %s&quot;,
 400                       (now_enabled &amp; bit)? &quot;Enabling&quot; : &quot;Disabling&quot;, JvmtiTrace::event_name((jvmtiEvent)ei));
 401       }
 402     }
 403   }
 404 #endif /*JVMTI_TRACE */
 405 }
 406 
 407 
 408 // For the specified env: compute the currently truly enabled events
 409 // set external state accordingly.
 410 // Return value and set value must include all events.
 411 // But outside this class, only non-thread-filtered events can be queried..
 412 jlong
 413 JvmtiEventControllerPrivate::recompute_env_enabled(JvmtiEnvBase* env) {
 414   jlong was_enabled = env-&gt;env_event_enable()-&gt;_event_enabled.get_bits();
 415   jlong now_enabled =
 416     env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits() &amp;
 417     env-&gt;env_event_enable()-&gt;_event_user_enabled.get_bits();
 418 
 419   switch (env-&gt;phase()) {
 420   case JVMTI_PHASE_PRIMORDIAL:
 421   case JVMTI_PHASE_ONLOAD:
 422     // only these events allowed in primordial or onload phase
 423     now_enabled &amp;= (EARLY_EVENT_BITS &amp; ~THREAD_FILTERED_EVENT_BITS);
 424     break;
 425   case JVMTI_PHASE_START:
 426     // only these events allowed in start phase
 427     now_enabled &amp;= EARLY_EVENT_BITS;
 428     break;
 429   case JVMTI_PHASE_LIVE:
 430     // all events allowed during live phase
 431     break;
 432   case JVMTI_PHASE_DEAD:
 433     // no events allowed when dead
 434     now_enabled = 0;
 435     break;
 436   default:
 437     assert(false, &quot;no other phases - sanity check&quot;);
 438     break;
 439   }
 440 
 441   // will we really send these events to this env
 442   env-&gt;env_event_enable()-&gt;_event_enabled.set_bits(now_enabled);
 443 
 444   trace_changed(now_enabled, (now_enabled ^ was_enabled)  &amp; ~THREAD_FILTERED_EVENT_BITS);
 445 
 446   return now_enabled;
 447 }
 448 
 449 
 450 // For the specified env and thread: compute the currently truly enabled events
 451 // set external state accordingly.  Only thread-filtered events are included.
 452 jlong
 453 JvmtiEventControllerPrivate::recompute_env_thread_enabled(JvmtiEnvThreadState* ets, JvmtiThreadState* state) {
 454   JvmtiEnv *env = ets-&gt;get_env();
 455 
 456   jlong was_enabled = ets-&gt;event_enable()-&gt;_event_enabled.get_bits();
 457   jlong now_enabled =  THREAD_FILTERED_EVENT_BITS &amp;
 458     env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits() &amp;
 459     (env-&gt;env_event_enable()-&gt;_event_user_enabled.get_bits() |
 460      ets-&gt;event_enable()-&gt;_event_user_enabled.get_bits());
 461 
 462   // for frame pops and field watchs, computed enabled state
 463   // is only true if an event has been requested
 464   if (!ets-&gt;has_frame_pops()) {
 465     now_enabled &amp;= ~FRAME_POP_BIT;
 466   }
 467   if (*((int *)JvmtiExport::get_field_access_count_addr()) == 0) {
 468     now_enabled &amp;= ~FIELD_ACCESS_BIT;
 469   }
 470   if (*((int *)JvmtiExport::get_field_modification_count_addr()) == 0) {
 471     now_enabled &amp;= ~FIELD_MODIFICATION_BIT;
 472   }
 473 
 474   switch (JvmtiEnv::get_phase()) {
 475   case JVMTI_PHASE_DEAD:
 476     // no events allowed when dead
 477     now_enabled = 0;
 478     break;
 479   default:
 480     break;
 481   }
 482 
 483   // if anything changed do update
 484   if (now_enabled != was_enabled) {
 485 
 486     // will we really send these events to this thread x env
 487     ets-&gt;event_enable()-&gt;_event_enabled.set_bits(now_enabled);
 488 
 489     // If the enabled status of the single step or breakpoint events changed,
 490     // the location status may need to change as well.
 491     jlong changed = now_enabled ^ was_enabled;
 492     if (changed &amp; SINGLE_STEP_BIT) {
 493       ets-&gt;reset_current_location(JVMTI_EVENT_SINGLE_STEP, (now_enabled &amp; SINGLE_STEP_BIT) != 0);
 494     }
 495     if (changed &amp; BREAKPOINT_BIT) {
 496       ets-&gt;reset_current_location(JVMTI_EVENT_BREAKPOINT,  (now_enabled &amp; BREAKPOINT_BIT) != 0);
 497     }
 498     trace_changed(state, now_enabled, changed);
 499   }
 500   return now_enabled;
 501 }
 502 
 503 
 504 // For the specified thread: compute the currently truly enabled events
 505 // set external state accordingly.  Only thread-filtered events are included.
 506 jlong
 507 JvmtiEventControllerPrivate::recompute_thread_enabled(JvmtiThreadState *state) {
 508   if (state == NULL) {
 509     // associated JavaThread is exiting
 510     return (jlong)0;
 511   }
 512 
 513   julong was_any_env_enabled = state-&gt;thread_event_enable()-&gt;_event_enabled.get_bits();
 514   julong any_env_enabled = 0;
 515   // JVMTI_EVENT_FRAME_POP can be disabled (in the case FRAME_POP_BIT is not set),
 516   // but we need to set interp_only if some JvmtiEnvThreadState has frame pop set
 517   // to clear the request
 518   bool has_frame_pops = false;
 519 
 520   {
 521     // This iteration will include JvmtiEnvThreadStates whose environments
 522     // have been disposed.  These JvmtiEnvThreadStates must not be filtered
 523     // as recompute must be called on them to disable their events,
 524     JvmtiEnvThreadStateIterator it(state);
 525     for (JvmtiEnvThreadState* ets = it.first(); ets != NULL; ets = it.next(ets)) {
 526       any_env_enabled |= recompute_env_thread_enabled(ets, state);
 527       has_frame_pops |= ets-&gt;has_frame_pops();
 528     }
 529   }
 530 
 531   if (any_env_enabled != was_any_env_enabled) {
 532     // mark if event is truly enabled on this thread in any environment
 533     state-&gt;thread_event_enable()-&gt;_event_enabled.set_bits(any_env_enabled);
 534 
 535     // update the JavaThread cached value for thread-specific should_post_on_exceptions value
 536     bool should_post_on_exceptions = (any_env_enabled &amp; SHOULD_POST_ON_EXCEPTIONS_BITS) != 0;
 537     state-&gt;set_should_post_on_exceptions(should_post_on_exceptions);
 538   }
 539 
 540   // compute interp_only mode
 541   bool should_be_interp = (any_env_enabled &amp; INTERP_EVENT_BITS) != 0 || has_frame_pops;
 542   bool is_now_interp = state-&gt;is_interp_only_mode();
 543 
 544   if (should_be_interp != is_now_interp) {
 545     if (should_be_interp) {
 546       enter_interp_only_mode(state);
 547     } else {
 548       leave_interp_only_mode(state);
 549     }
 550   }
 551 
 552   return any_env_enabled;
 553 }
 554 
 555 
 556 // Compute truly enabled events - meaning if the event can and could be
 557 // sent.  An event is truly enabled if it is user enabled on the thread
 558 // or globally user enabled, but only if there is a callback or event hook
 559 // for it and, for field watch and frame pop, one has been set.
 560 // Compute if truly enabled, per thread, per environment, per combination
 561 // (thread x environment), and overall.  These merges are true if any is true.
 562 // True per thread if some environment has callback set and the event is globally
 563 // enabled or enabled for this thread.
 564 // True per environment if the callback is set and the event is globally
 565 // enabled in this environment or enabled for any thread in this environment.
 566 // True per combination if the environment has the callback set and the
 567 // event is globally enabled in this environment or the event is enabled
 568 // for this thread and environment.
 569 //
 570 // All states transitions dependent on these transitions are also handled here.
 571 void
 572 JvmtiEventControllerPrivate::recompute_enabled() {
 573   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 574 
 575   // event enabled for any thread in any environment
 576   julong was_any_env_thread_enabled = JvmtiEventController::_universal_global_event_enabled.get_bits();
 577   julong any_env_thread_enabled = 0;
 578 
 579   EC_TRACE((&quot;[-] # recompute enabled - before &quot; JULONG_FORMAT_X, was_any_env_thread_enabled));
 580 
 581   // compute non-thread-filters events.
 582   // This must be done separately from thread-filtered events, since some
 583   // events can occur before any threads exist.
 584   JvmtiEnvIterator it;
 585   for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 586     any_env_thread_enabled |= recompute_env_enabled(env);
 587   }
 588 
 589   // We need to create any missing jvmti_thread_state if there are globally set thread
 590   // filtered events and there weren&#39;t last time
 591   if (    (any_env_thread_enabled &amp; THREAD_FILTERED_EVENT_BITS) != 0 &amp;&amp;
 592       (was_any_env_thread_enabled &amp; THREAD_FILTERED_EVENT_BITS) == 0) {
 593     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
 594       // state_for_while_locked() makes tp-&gt;is_exiting() check
 595       JvmtiThreadState::state_for_while_locked(tp);  // create the thread state if missing
 596     }
 597   }
 598 
 599   // compute and set thread-filtered events
 600   for (JvmtiThreadState *state = JvmtiThreadState::first(); state != NULL; state = state-&gt;next()) {
 601     any_env_thread_enabled |= recompute_thread_enabled(state);
 602   }
 603 
 604   // set universal state (across all envs and threads)
 605   jlong delta = any_env_thread_enabled ^ was_any_env_thread_enabled;
 606   if (delta != 0) {
 607     JvmtiExport::set_should_post_field_access((any_env_thread_enabled &amp; FIELD_ACCESS_BIT) != 0);
 608     JvmtiExport::set_should_post_field_modification((any_env_thread_enabled &amp; FIELD_MODIFICATION_BIT) != 0);
 609     JvmtiExport::set_should_post_class_load((any_env_thread_enabled &amp; CLASS_LOAD_BIT) != 0);
 610     JvmtiExport::set_should_post_class_file_load_hook((any_env_thread_enabled &amp; CLASS_FILE_LOAD_HOOK_BIT) != 0);
 611     JvmtiExport::set_should_post_native_method_bind((any_env_thread_enabled &amp; NATIVE_METHOD_BIND_BIT) != 0);
 612     JvmtiExport::set_should_post_dynamic_code_generated((any_env_thread_enabled &amp; DYNAMIC_CODE_GENERATED_BIT) != 0);
 613     JvmtiExport::set_should_post_data_dump((any_env_thread_enabled &amp; DATA_DUMP_BIT) != 0);
 614     JvmtiExport::set_should_post_class_prepare((any_env_thread_enabled &amp; CLASS_PREPARE_BIT) != 0);
 615     JvmtiExport::set_should_post_class_unload((any_env_thread_enabled &amp; CLASS_UNLOAD_BIT) != 0);
 616     JvmtiExport::set_should_post_monitor_contended_enter((any_env_thread_enabled &amp; MONITOR_CONTENDED_ENTER_BIT) != 0);
 617     JvmtiExport::set_should_post_monitor_contended_entered((any_env_thread_enabled &amp; MONITOR_CONTENDED_ENTERED_BIT) != 0);
 618     JvmtiExport::set_should_post_monitor_wait((any_env_thread_enabled &amp; MONITOR_WAIT_BIT) != 0);
 619     JvmtiExport::set_should_post_monitor_waited((any_env_thread_enabled &amp; MONITOR_WAITED_BIT) != 0);
 620     JvmtiExport::set_should_post_garbage_collection_start((any_env_thread_enabled &amp; GARBAGE_COLLECTION_START_BIT) != 0);
 621     JvmtiExport::set_should_post_garbage_collection_finish((any_env_thread_enabled &amp; GARBAGE_COLLECTION_FINISH_BIT) != 0);
 622     JvmtiExport::set_should_post_object_free((any_env_thread_enabled &amp; OBJECT_FREE_BIT) != 0);
 623     JvmtiExport::set_should_post_resource_exhausted((any_env_thread_enabled &amp; RESOURCE_EXHAUSTED_BIT) != 0);
 624     JvmtiExport::set_should_post_compiled_method_load((any_env_thread_enabled &amp; COMPILED_METHOD_LOAD_BIT) != 0);
 625     JvmtiExport::set_should_post_compiled_method_unload((any_env_thread_enabled &amp; COMPILED_METHOD_UNLOAD_BIT) != 0);
 626     JvmtiExport::set_should_post_vm_object_alloc((any_env_thread_enabled &amp; VM_OBJECT_ALLOC_BIT) != 0);
 627     JvmtiExport::set_should_post_sampled_object_alloc((any_env_thread_enabled &amp; SAMPLED_OBJECT_ALLOC_BIT) != 0);
 628 
 629     // need this if we want thread events or we need them to init data
 630     JvmtiExport::set_should_post_thread_life((any_env_thread_enabled &amp; NEED_THREAD_LIFE_EVENTS) != 0);
 631 
 632     // If single stepping is turned on or off, execute the VM op to change it.
 633     if (delta &amp; SINGLE_STEP_BIT) {
 634       switch (JvmtiEnv::get_phase()) {
 635       case JVMTI_PHASE_DEAD:
 636         // If the VM is dying we can&#39;t execute VM ops
 637         break;
 638       case JVMTI_PHASE_LIVE: {
 639         VM_ChangeSingleStep op((any_env_thread_enabled &amp; SINGLE_STEP_BIT) != 0);
 640         VMThread::execute(&amp;op);
 641         break;
 642       }
 643       default:
 644         assert(false, &quot;should never come here before live phase&quot;);
 645         break;
 646       }
 647     }
 648 
 649     // set global truly enabled, that is, any thread in any environment
 650     JvmtiEventController::_universal_global_event_enabled.set_bits(any_env_thread_enabled);
 651 
 652     // set global should_post_on_exceptions
 653     JvmtiExport::set_should_post_on_exceptions((any_env_thread_enabled &amp; SHOULD_POST_ON_EXCEPTIONS_BITS) != 0);
 654 
 655   }
 656 
 657   EC_TRACE((&quot;[-] # recompute enabled - after &quot; JULONG_FORMAT_X, any_env_thread_enabled));
 658 }
 659 
 660 
 661 void
 662 JvmtiEventControllerPrivate::thread_started(JavaThread *thread) {
 663   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
 664   assert(thread == Thread::current(), &quot;must be current thread&quot;);
 665   assert(JvmtiEnvBase::environments_might_exist(), &quot;to enter event controller, JVM TI environments must exist&quot;);
 666 
 667   EC_TRACE((&quot;[%s] # thread started&quot;, JvmtiTrace::safe_get_thread_name(thread)));
 668 
 669   // if we have any thread filtered events globally enabled, create/update the thread state
 670   if ((JvmtiEventController::_universal_global_event_enabled.get_bits() &amp; THREAD_FILTERED_EVENT_BITS) != 0) {
 671     MutexLocker mu(JvmtiThreadState_lock);
 672     // create the thread state if missing
 673     JvmtiThreadState *state = JvmtiThreadState::state_for_while_locked(thread);
 674     if (state != NULL) {    // skip threads with no JVMTI thread state
 675       recompute_thread_enabled(state);
 676     }
 677   }
 678 }
 679 
 680 
 681 void
 682 JvmtiEventControllerPrivate::thread_ended(JavaThread *thread) {
 683   // Removes the JvmtiThreadState associated with the specified thread.
 684   // May be called after all environments have been disposed.
 685   assert(JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 686 
 687   EC_TRACE((&quot;[%s] # thread ended&quot;, JvmtiTrace::safe_get_thread_name(thread)));
 688 
 689   JvmtiThreadState *state = thread-&gt;jvmti_thread_state();
 690   assert(state != NULL, &quot;else why are we here?&quot;);
 691   delete state;
 692 }
 693 
 694 void JvmtiEventControllerPrivate::set_event_callbacks(JvmtiEnvBase *env,
 695                                                       const jvmtiEventCallbacks* callbacks,
 696                                                       jint size_of_callbacks) {
 697   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 698   EC_TRACE((&quot;[*] # set event callbacks&quot;));
 699 
 700   env-&gt;set_event_callbacks(callbacks, size_of_callbacks);
 701   jlong enabled_bits = 0;
 702   for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 703     jvmtiEvent evt_t = (jvmtiEvent)ei;
 704     if (env-&gt;has_callback(evt_t)) {
 705       enabled_bits |= JvmtiEventEnabled::bit_for(evt_t);
 706     }
 707   }
 708   env-&gt;env_event_enable()-&gt;_event_callback_enabled.set_bits(enabled_bits);
 709   recompute_enabled();
 710 }
 711 
 712 void
 713 JvmtiEventControllerPrivate::set_extension_event_callback(JvmtiEnvBase *env,
 714                                                           jint extension_event_index,
 715                                                           jvmtiExtensionEvent callback)
 716 {
 717   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 718   EC_TRACE((&quot;[*] # set extension event callback&quot;));
 719 
 720   // extension events are allocated below JVMTI_MIN_EVENT_TYPE_VAL
 721   assert(extension_event_index &gt;= (jint)EXT_MIN_EVENT_TYPE_VAL &amp;&amp;
 722          extension_event_index &lt;= (jint)EXT_MAX_EVENT_TYPE_VAL, &quot;sanity check&quot;);
 723 
 724 
 725   // As the bits for both standard (jvmtiEvent) and extension
 726   // (jvmtiExtEvents) are stored in the same word we cast here to
 727   // jvmtiEvent to set/clear the bit for this extension event.
 728   jvmtiEvent event_type = (jvmtiEvent)extension_event_index;
 729 
 730   // Prevent a possible race condition where events are re-enabled by a call to
 731   // set event callbacks, where the DisposeEnvironment occurs after the boiler-plate
 732   // environment check and before the lock is acquired.
 733   // We can safely do the is_valid check now, as JvmtiThreadState_lock is held.
 734   bool enabling = (callback != NULL) &amp;&amp; (env-&gt;is_valid());
 735   env-&gt;env_event_enable()-&gt;set_user_enabled(event_type, enabling);
 736 
 737   // update the callback
 738   jvmtiExtEventCallbacks* ext_callbacks = env-&gt;ext_callbacks();
 739   switch (extension_event_index) {
 740     case EXT_EVENT_CLASS_UNLOAD :
 741       ext_callbacks-&gt;ClassUnload = callback;
 742       break;
 743     default:
 744       ShouldNotReachHere();
 745   }
 746 
 747   // update the callback enable/disable bit
 748   jlong enabled_bits = env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits();
 749   jlong bit_for = JvmtiEventEnabled::bit_for(event_type);
 750   if (enabling) {
 751     enabled_bits |= bit_for;
 752   } else {
 753     enabled_bits &amp;= ~bit_for;
 754   }
 755   env-&gt;env_event_enable()-&gt;_event_callback_enabled.set_bits(enabled_bits);
 756 
 757   recompute_enabled();
 758 }
 759 
 760 
 761 void
 762 JvmtiEventControllerPrivate::env_initialize(JvmtiEnvBase *env) {
 763   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 764   EC_TRACE((&quot;[*] # env initialize&quot;));
 765 
 766   if (JvmtiEnvBase::is_vm_live()) {
 767     // if we didn&#39;t initialize event info already (this is a late
 768     // launched environment), do it now.
 769     event_init();
 770   }
 771 
 772   env-&gt;initialize();
 773 
 774   // add the JvmtiEnvThreadState to each JvmtiThreadState
 775   for (JvmtiThreadState *state = JvmtiThreadState::first(); state != NULL; state = state-&gt;next()) {
 776     state-&gt;add_env(env);
 777     assert((JvmtiEnv*)(state-&gt;env_thread_state(env)-&gt;get_env()) == env, &quot;sanity check&quot;);
 778   }
 779   JvmtiEventControllerPrivate::recompute_enabled();
 780 }
 781 
 782 
 783 void
 784 JvmtiEventControllerPrivate::env_dispose(JvmtiEnvBase *env) {
 785   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 786   EC_TRACE((&quot;[*] # env dispose&quot;));
 787 
 788   // Before the environment is marked disposed, disable all events on this
 789   // environment (by zapping the callbacks).  As a result, the disposed
 790   // environment will not call event handlers.
 791   set_event_callbacks(env, NULL, 0);
 792   for (jint extension_event_index = EXT_MIN_EVENT_TYPE_VAL;
 793        extension_event_index &lt;= EXT_MAX_EVENT_TYPE_VAL;
 794        ++extension_event_index) {
 795     set_extension_event_callback(env, extension_event_index, NULL);
 796   }
 797 
 798   // Let the environment finish disposing itself.
 799   env-&gt;env_dispose();
 800 }
 801 
 802 
 803 void
 804 JvmtiEventControllerPrivate::set_user_enabled(JvmtiEnvBase *env, JavaThread *thread,
 805                                           jvmtiEvent event_type, bool enabled) {
 806   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 807 
 808   EC_TRACE((&quot;[%s] # user %s event %s&quot;,
 809             thread==NULL? &quot;ALL&quot;: JvmtiTrace::safe_get_thread_name(thread),
 810             enabled? &quot;enabled&quot; : &quot;disabled&quot;, JvmtiTrace::event_name(event_type)));
 811 
 812   if (thread == NULL) {
 813     env-&gt;env_event_enable()-&gt;set_user_enabled(event_type, enabled);
 814   } else {
 815     // create the thread state (if it didn&#39;t exist before)
 816     JvmtiThreadState *state = JvmtiThreadState::state_for_while_locked(thread);
 817     if (state != NULL) {
 818       state-&gt;env_thread_state(env)-&gt;event_enable()-&gt;set_user_enabled(event_type, enabled);
 819     }
 820   }
 821   recompute_enabled();
 822 }
 823 
 824 
 825 void
 826 JvmtiEventControllerPrivate::set_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 827   EC_TRACE((&quot;[%s] # set frame pop - frame=%d&quot;,
 828             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 829             fpop.frame_number() ));
 830 
 831   ets-&gt;get_frame_pops()-&gt;set(fpop);
 832   recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 833 }
 834 
 835 
 836 void
 837 JvmtiEventControllerPrivate::clear_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 838   EC_TRACE((&quot;[%s] # clear frame pop - frame=%d&quot;,
 839             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 840             fpop.frame_number() ));
 841 
 842   ets-&gt;get_frame_pops()-&gt;clear(fpop);
 843   recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 844 }
 845 
 846 
 847 void
 848 JvmtiEventControllerPrivate::clear_to_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 849   int cleared_cnt = ets-&gt;get_frame_pops()-&gt;clear_to(fpop);
 850 
 851   EC_TRACE((&quot;[%s] # clear to frame pop - frame=%d, count=%d&quot;,
 852             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 853             fpop.frame_number(),
 854             cleared_cnt ));
 855 
 856   if (cleared_cnt &gt; 0) {
 857     recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 858   }
 859 }
 860 
 861 void
 862 JvmtiEventControllerPrivate::change_field_watch(jvmtiEvent event_type, bool added) {
 863   int *count_addr;
 864 
 865   switch (event_type) {
 866   case JVMTI_EVENT_FIELD_MODIFICATION:
 867     count_addr = (int *)JvmtiExport::get_field_modification_count_addr();
 868     break;
 869   case JVMTI_EVENT_FIELD_ACCESS:
 870     count_addr = (int *)JvmtiExport::get_field_access_count_addr();
 871     break;
 872   default:
 873     assert(false, &quot;incorrect event&quot;);
 874     return;
 875   }
 876 
 877   EC_TRACE((&quot;[-] # change field watch - %s %s count=%d&quot;,
 878             event_type==JVMTI_EVENT_FIELD_MODIFICATION? &quot;modification&quot; : &quot;access&quot;,
 879             added? &quot;add&quot; : &quot;remove&quot;,
 880             *count_addr));
 881 
 882   if (added) {
 883     (*count_addr)++;
 884     if (*count_addr == 1) {
 885       recompute_enabled();
 886     }
 887   } else {
 888     if (*count_addr &gt; 0) {
 889       (*count_addr)--;
 890       if (*count_addr == 0) {
 891         recompute_enabled();
 892       }
 893     } else {
 894       assert(false, &quot;field watch out of phase&quot;);
 895     }
 896   }
 897 }
 898 
 899 void
 900 JvmtiEventControllerPrivate::event_init() {
 901   assert(JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 902 
 903   if (_initialized) {
 904     return;
 905   }
 906 
 907   EC_TRACE((&quot;[-] # VM live&quot;));
 908 
 909 #ifdef ASSERT
 910   // check that our idea and the spec&#39;s idea of threaded events match
 911   for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 912     jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 913     assert(((THREAD_FILTERED_EVENT_BITS &amp; bit) != 0) == JvmtiUtil::event_threaded(ei),
 914            &quot;thread filtered event list does not match&quot;);
 915   }
 916 #endif
 917 
 918   _initialized = true;
 919 }
 920 
 921 void
 922 JvmtiEventControllerPrivate::vm_start() {
 923   // some events are now able to be enabled (phase has changed)
 924   JvmtiEventControllerPrivate::recompute_enabled();
 925 }
 926 
 927 
 928 void
 929 JvmtiEventControllerPrivate::vm_init() {
 930   event_init();
 931 
 932   // all the events are now able to be enabled (phase has changed)
 933   JvmtiEventControllerPrivate::recompute_enabled();
 934 }
 935 
 936 
 937 void
 938 JvmtiEventControllerPrivate::vm_death() {
 939   // events are disabled (phase has changed)
 940   JvmtiEventControllerPrivate::recompute_enabled();
 941 }
 942 
 943 
 944 ///////////////////////////////////////////////////////////////
 945 //
 946 // JvmtiEventController
 947 //
 948 
 949 JvmtiEventEnabled JvmtiEventController::_universal_global_event_enabled;
 950 
 951 bool
 952 JvmtiEventController::is_global_event(jvmtiEvent event_type) {
 953   assert(is_valid_event_type(event_type), &quot;invalid event type&quot;);
 954   jlong bit_for = ((jlong)1) &lt;&lt; (event_type - TOTAL_MIN_EVENT_TYPE_VAL);
 955   return((bit_for &amp; GLOBAL_EVENT_BITS)!=0);
 956 }
 957 
 958 void
 959 JvmtiEventController::set_user_enabled(JvmtiEnvBase *env, JavaThread *thread, jvmtiEvent event_type, bool enabled) {
 960   if (Threads::number_of_threads() == 0) {
 961     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
 962     // call the functionality without holding the JvmtiThreadState_lock.
 963     JvmtiEventControllerPrivate::set_user_enabled(env, thread, event_type, enabled);
 964   } else {
 965     MutexLocker mu(JvmtiThreadState_lock);
 966     JvmtiEventControllerPrivate::set_user_enabled(env, thread, event_type, enabled);
 967   }
 968 }
 969 
 970 
 971 void
 972 JvmtiEventController::set_event_callbacks(JvmtiEnvBase *env,
 973                                           const jvmtiEventCallbacks* callbacks,
 974                                           jint size_of_callbacks) {
 975   if (Threads::number_of_threads() == 0) {
 976     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
 977     // call the functionality without holding the JvmtiThreadState_lock.
 978     JvmtiEventControllerPrivate::set_event_callbacks(env, callbacks, size_of_callbacks);
 979   } else {
 980     MutexLocker mu(JvmtiThreadState_lock);
 981     JvmtiEventControllerPrivate::set_event_callbacks(env, callbacks, size_of_callbacks);
 982   }
 983 }
 984 
 985 void
 986 JvmtiEventController::set_extension_event_callback(JvmtiEnvBase *env,
 987                                                    jint extension_event_index,
 988                                                    jvmtiExtensionEvent callback) {
 989   if (Threads::number_of_threads() == 0) {
 990     JvmtiEventControllerPrivate::set_extension_event_callback(env, extension_event_index, callback);
 991   } else {
 992     MutexLocker mu(JvmtiThreadState_lock);
 993     JvmtiEventControllerPrivate::set_extension_event_callback(env, extension_event_index, callback);
 994   }
 995 }
 996 
 997 
 998 
 999 
1000 void
1001 JvmtiEventController::set_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
<a name="8" id="anc8"></a><span class="line-modified">1002   MutexLocker mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);</span>
1003   JvmtiEventControllerPrivate::set_frame_pop(ets, fpop);
1004 }
1005 
1006 
1007 void
1008 JvmtiEventController::clear_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
<a name="9" id="anc9"></a><span class="line-modified">1009   MutexLocker mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);</span>
1010   JvmtiEventControllerPrivate::clear_frame_pop(ets, fpop);
1011 }
1012 
1013 
1014 void
1015 JvmtiEventController::clear_to_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
<a name="10" id="anc10"></a><span class="line-modified">1016   MutexLocker mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);</span>
1017   JvmtiEventControllerPrivate::clear_to_frame_pop(ets, fpop);
1018 }
1019 
1020 void
1021 JvmtiEventController::change_field_watch(jvmtiEvent event_type, bool added) {
1022   MutexLocker mu(JvmtiThreadState_lock);
1023   JvmtiEventControllerPrivate::change_field_watch(event_type, added);
1024 }
1025 
1026 void
1027 JvmtiEventController::thread_started(JavaThread *thread) {
1028   // operates only on the current thread
1029   // JvmtiThreadState_lock grabbed only if needed.
1030   JvmtiEventControllerPrivate::thread_started(thread);
1031 }
1032 
1033 void
1034 JvmtiEventController::thread_ended(JavaThread *thread) {
1035   // operates only on the current thread
1036   // JvmtiThreadState_lock grabbed only if needed.
1037   JvmtiEventControllerPrivate::thread_ended(thread);
1038 }
1039 
1040 void
1041 JvmtiEventController::env_initialize(JvmtiEnvBase *env) {
1042   if (Threads::number_of_threads() == 0) {
1043     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
1044     // call the functionality without holding the JvmtiThreadState_lock.
1045     JvmtiEventControllerPrivate::env_initialize(env);
1046   } else {
1047     MutexLocker mu(JvmtiThreadState_lock);
1048     JvmtiEventControllerPrivate::env_initialize(env);
1049   }
1050 }
1051 
1052 void
1053 JvmtiEventController::env_dispose(JvmtiEnvBase *env) {
1054   if (Threads::number_of_threads() == 0) {
1055     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
1056     // call the functionality without holding the JvmtiThreadState_lock.
1057     JvmtiEventControllerPrivate::env_dispose(env);
1058   } else {
1059     MutexLocker mu(JvmtiThreadState_lock);
1060     JvmtiEventControllerPrivate::env_dispose(env);
1061   }
1062 }
1063 
1064 
1065 void
1066 JvmtiEventController::vm_start() {
1067   if (JvmtiEnvBase::environments_might_exist()) {
1068     MutexLocker mu(JvmtiThreadState_lock);
1069     JvmtiEventControllerPrivate::vm_start();
1070   }
1071 }
1072 
1073 void
1074 JvmtiEventController::vm_init() {
1075   if (JvmtiEnvBase::environments_might_exist()) {
1076     MutexLocker mu(JvmtiThreadState_lock);
1077     JvmtiEventControllerPrivate::vm_init();
1078   }
1079 }
1080 
1081 void
1082 JvmtiEventController::vm_death() {
1083   if (JvmtiEnvBase::environments_might_exist()) {
1084     MutexLocker mu(JvmtiThreadState_lock);
1085     JvmtiEventControllerPrivate::vm_death();
1086   }
1087 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>