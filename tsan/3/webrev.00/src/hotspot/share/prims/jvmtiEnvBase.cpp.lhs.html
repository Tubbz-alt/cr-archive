<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnvBase.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
<a name="1" id="anc1"></a>
  27 #include &quot;classfile/systemDictionary.hpp&quot;
  28 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
<a name="2" id="anc2"></a>
  29 #include &quot;memory/resourceArea.hpp&quot;
  30 #include &quot;oops/objArrayKlass.hpp&quot;
  31 #include &quot;oops/objArrayOop.hpp&quot;
  32 #include &quot;oops/oop.inline.hpp&quot;
  33 #include &quot;oops/oopHandle.inline.hpp&quot;
  34 #include &quot;prims/jvmtiEnvBase.hpp&quot;
  35 #include &quot;prims/jvmtiEventController.inline.hpp&quot;
  36 #include &quot;prims/jvmtiExtensions.hpp&quot;
  37 #include &quot;prims/jvmtiImpl.hpp&quot;
  38 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  39 #include &quot;prims/jvmtiTagMap.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  41 #include &quot;runtime/biasedLocking.hpp&quot;
  42 #include &quot;runtime/deoptimization.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/handles.inline.hpp&quot;
  45 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  46 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  47 #include &quot;runtime/jniHandles.inline.hpp&quot;
  48 #include &quot;runtime/objectMonitor.hpp&quot;
  49 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  50 #include &quot;runtime/signature.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/threadSMR.hpp&quot;
  53 #include &quot;runtime/vframe.hpp&quot;
  54 #include &quot;runtime/vframe_hp.hpp&quot;
  55 #include &quot;runtime/vmThread.hpp&quot;
  56 #include &quot;runtime/vmOperations.hpp&quot;
  57 
  58 ///////////////////////////////////////////////////////////////
  59 //
  60 // JvmtiEnvBase
  61 //
  62 
  63 JvmtiEnvBase* JvmtiEnvBase::_head_environment = NULL;
  64 
  65 bool JvmtiEnvBase::_globally_initialized = false;
  66 volatile bool JvmtiEnvBase::_needs_clean_up = false;
  67 
  68 jvmtiPhase JvmtiEnvBase::_phase = JVMTI_PHASE_PRIMORDIAL;
  69 
  70 volatile int JvmtiEnvBase::_dying_thread_env_iteration_count = 0;
  71 
  72 extern jvmtiInterface_1_ jvmti_Interface;
  73 extern jvmtiInterface_1_ jvmtiTrace_Interface;
  74 
  75 
  76 // perform initializations that must occur before any JVMTI environments
  77 // are released but which should only be initialized once (no matter
  78 // how many environments are created).
  79 void
  80 JvmtiEnvBase::globally_initialize() {
  81   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
  82   assert(_globally_initialized == false, &quot;bad call&quot;);
  83 
  84   JvmtiManageCapabilities::initialize();
  85 
  86   // register extension functions and events
  87   JvmtiExtensions::register_extensions();
  88 
  89 #ifdef JVMTI_TRACE
  90   JvmtiTrace::initialize();
  91 #endif
  92 
  93   _globally_initialized = true;
  94 }
  95 
  96 
  97 void
  98 JvmtiEnvBase::initialize() {
  99   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 100 
 101   // Add this environment to the end of the environment list (order is important)
 102   {
 103     // This block of code must not contain any safepoints, as list deallocation
 104     // (which occurs at a safepoint) cannot occur simultaneously with this list
 105     // addition.  Note: NoSafepointVerifier cannot, currently, be used before
 106     // threads exist.
 107     JvmtiEnvIterator it;
 108     JvmtiEnvBase *previous_env = NULL;
 109     for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 110       previous_env = env;
 111     }
 112     if (previous_env == NULL) {
 113       _head_environment = this;
 114     } else {
 115       previous_env-&gt;set_next_environment(this);
 116     }
 117   }
 118 
 119   if (_globally_initialized == false) {
 120     globally_initialize();
 121   }
 122 }
 123 
 124 jvmtiPhase
 125 JvmtiEnvBase::phase() {
 126   // For the JVMTI environments possessed the can_generate_early_vmstart:
 127   //   replace JVMTI_PHASE_PRIMORDIAL with JVMTI_PHASE_START
 128   if (_phase == JVMTI_PHASE_PRIMORDIAL &amp;&amp;
 129       JvmtiExport::early_vmstart_recorded() &amp;&amp;
 130       early_vmstart_env()) {
 131     return JVMTI_PHASE_START;
 132   }
 133   return _phase; // Normal case
 134 }
 135 
 136 bool
 137 JvmtiEnvBase::is_valid() {
 138   jint value = 0;
 139 
 140   // This object might not be a JvmtiEnvBase so we can&#39;t assume
 141   // the _magic field is properly aligned. Get the value in a safe
 142   // way and then check against JVMTI_MAGIC.
 143 
 144   switch (sizeof(_magic)) {
 145   case 2:
 146     value = Bytes::get_native_u2((address)&amp;_magic);
 147     break;
 148 
 149   case 4:
 150     value = Bytes::get_native_u4((address)&amp;_magic);
 151     break;
 152 
 153   case 8:
 154     value = Bytes::get_native_u8((address)&amp;_magic);
 155     break;
 156 
 157   default:
 158     guarantee(false, &quot;_magic field is an unexpected size&quot;);
 159   }
 160 
 161   return value == JVMTI_MAGIC;
 162 }
 163 
 164 
 165 bool
 166 JvmtiEnvBase::use_version_1_0_semantics() {
 167   int major, minor, micro;
 168 
 169   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 170   return major == 1 &amp;&amp; minor == 0;  // micro version doesn&#39;t matter here
 171 }
 172 
 173 
 174 bool
 175 JvmtiEnvBase::use_version_1_1_semantics() {
 176   int major, minor, micro;
 177 
 178   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 179   return major == 1 &amp;&amp; minor == 1;  // micro version doesn&#39;t matter here
 180 }
 181 
 182 bool
 183 JvmtiEnvBase::use_version_1_2_semantics() {
 184   int major, minor, micro;
 185 
 186   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 187   return major == 1 &amp;&amp; minor == 2;  // micro version doesn&#39;t matter here
 188 }
 189 
 190 
 191 JvmtiEnvBase::JvmtiEnvBase(jint version) : _env_event_enable() {
 192   _version = version;
 193   _env_local_storage = NULL;
 194   _tag_map = NULL;
 195   _native_method_prefix_count = 0;
 196   _native_method_prefixes = NULL;
 197   _next = NULL;
 198   _class_file_load_hook_ever_enabled = false;
 199 
 200   // Moot since ClassFileLoadHook not yet enabled.
 201   // But &quot;true&quot; will give a more predictable ClassFileLoadHook behavior
 202   // for environment creation during ClassFileLoadHook.
 203   _is_retransformable = true;
 204 
 205   // all callbacks initially NULL
 206   memset(&amp;_event_callbacks,0,sizeof(jvmtiEventCallbacks));
 207 
 208   // all capabilities initially off
 209   memset(&amp;_current_capabilities, 0, sizeof(_current_capabilities));
 210 
 211   // all prohibited capabilities initially off
 212   memset(&amp;_prohibited_capabilities, 0, sizeof(_prohibited_capabilities));
 213 
 214   _magic = JVMTI_MAGIC;
 215 
 216   JvmtiEventController::env_initialize((JvmtiEnv*)this);
 217 
 218 #ifdef JVMTI_TRACE
 219   _jvmti_external.functions = TraceJVMTI != NULL ? &amp;jvmtiTrace_Interface : &amp;jvmti_Interface;
 220 #else
 221   _jvmti_external.functions = &amp;jvmti_Interface;
 222 #endif
 223 }
 224 
 225 
 226 void
 227 JvmtiEnvBase::dispose() {
 228 
 229 #ifdef JVMTI_TRACE
 230   JvmtiTrace::shutdown();
 231 #endif
 232 
 233   // Dispose of event info and let the event controller call us back
 234   // in a locked state (env_dispose, below)
 235   JvmtiEventController::env_dispose(this);
 236 }
 237 
 238 void
 239 JvmtiEnvBase::env_dispose() {
 240   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 241 
 242   // We have been entered with all events disabled on this environment.
 243   // A race to re-enable events (by setting callbacks) is prevented by
 244   // checking for a valid environment when setting callbacks (while
 245   // holding the JvmtiThreadState_lock).
 246 
 247   // Mark as invalid.
 248   _magic = DISPOSED_MAGIC;
 249 
 250   // Relinquish all capabilities.
 251   jvmtiCapabilities *caps = get_capabilities();
 252   JvmtiManageCapabilities::relinquish_capabilities(caps, caps, caps);
 253 
 254   // Same situation as with events (see above)
 255   set_native_method_prefixes(0, NULL);
 256 
 257   JvmtiTagMap* tag_map_to_deallocate = _tag_map;
 258   set_tag_map(NULL);
 259   // A tag map can be big, deallocate it now
 260   if (tag_map_to_deallocate != NULL) {
 261     delete tag_map_to_deallocate;
 262   }
 263 
 264   _needs_clean_up = true;
 265 }
 266 
 267 
 268 JvmtiEnvBase::~JvmtiEnvBase() {
 269   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 270 
 271   // There is a small window of time during which the tag map of a
 272   // disposed environment could have been reallocated.
 273   // Make sure it is gone.
 274   JvmtiTagMap* tag_map_to_deallocate = _tag_map;
 275   set_tag_map(NULL);
 276   // A tag map can be big, deallocate it now
 277   if (tag_map_to_deallocate != NULL) {
 278     delete tag_map_to_deallocate;
 279   }
 280 
 281   _magic = BAD_MAGIC;
 282 }
 283 
 284 
 285 void
 286 JvmtiEnvBase::periodic_clean_up() {
 287   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 288 
 289   // JvmtiEnvBase reference is saved in JvmtiEnvThreadState. So
 290   // clean up JvmtiThreadState before deleting JvmtiEnv pointer.
 291   JvmtiThreadState::periodic_clean_up();
 292 
 293   // Unlink all invalid environments from the list of environments
 294   // and deallocate them
 295   JvmtiEnvIterator it;
 296   JvmtiEnvBase* previous_env = NULL;
 297   JvmtiEnvBase* env = it.first();
 298   while (env != NULL) {
 299     if (env-&gt;is_valid()) {
 300       previous_env = env;
 301       env = it.next(env);
 302     } else {
 303       // This one isn&#39;t valid, remove it from the list and deallocate it
 304       JvmtiEnvBase* defunct_env = env;
 305       env = it.next(env);
 306       if (previous_env == NULL) {
 307         _head_environment = env;
 308       } else {
 309         previous_env-&gt;set_next_environment(env);
 310       }
 311       delete defunct_env;
 312     }
 313   }
 314 
 315 }
 316 
 317 
 318 void
 319 JvmtiEnvBase::check_for_periodic_clean_up() {
 320   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 321 
 322   class ThreadInsideIterationClosure: public ThreadClosure {
 323    private:
 324     bool _inside;
 325    public:
 326     ThreadInsideIterationClosure() : _inside(false) {};
 327 
 328     void do_thread(Thread* thread) {
 329       _inside |= thread-&gt;is_inside_jvmti_env_iteration();
 330     }
 331 
 332     bool is_inside_jvmti_env_iteration() {
 333       return _inside;
 334     }
 335   };
 336 
 337   if (_needs_clean_up) {
 338     // Check if we are currently iterating environment,
 339     // deallocation should not occur if we are
 340     ThreadInsideIterationClosure tiic;
 341     Threads::threads_do(&amp;tiic);
 342     if (!tiic.is_inside_jvmti_env_iteration() &amp;&amp;
 343              !is_inside_dying_thread_env_iteration()) {
 344       _needs_clean_up = false;
 345       JvmtiEnvBase::periodic_clean_up();
 346     }
 347   }
 348 }
 349 
 350 
 351 void
 352 JvmtiEnvBase::record_first_time_class_file_load_hook_enabled() {
 353   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(),
 354          &quot;sanity check&quot;);
 355 
 356   if (!_class_file_load_hook_ever_enabled) {
 357     _class_file_load_hook_ever_enabled = true;
 358 
 359     if (get_capabilities()-&gt;can_retransform_classes) {
 360       _is_retransformable = true;
 361     } else {
 362       _is_retransformable = false;
 363 
 364       // cannot add retransform capability after ClassFileLoadHook has been enabled
 365       get_prohibited_capabilities()-&gt;can_retransform_classes = 1;
 366     }
 367   }
 368 }
 369 
 370 
 371 void
 372 JvmtiEnvBase::record_class_file_load_hook_enabled() {
 373   if (!_class_file_load_hook_ever_enabled) {
 374     if (Threads::number_of_threads() == 0) {
 375       record_first_time_class_file_load_hook_enabled();
 376     } else {
 377       MutexLocker mu(JvmtiThreadState_lock);
 378       record_first_time_class_file_load_hook_enabled();
 379     }
 380   }
 381 }
 382 
 383 
 384 jvmtiError
 385 JvmtiEnvBase::set_native_method_prefixes(jint prefix_count, char** prefixes) {
 386   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(),
 387          &quot;sanity check&quot;);
 388 
 389   int old_prefix_count = get_native_method_prefix_count();
 390   char **old_prefixes = get_native_method_prefixes();
 391 
 392   // allocate and install the new prefixex
 393   if (prefix_count == 0 || !is_valid()) {
 394     _native_method_prefix_count = 0;
 395     _native_method_prefixes = NULL;
 396   } else {
 397     // there are prefixes, allocate an array to hold them, and fill it
 398     char** new_prefixes = (char**)os::malloc((prefix_count) * sizeof(char*), mtInternal);
 399     if (new_prefixes == NULL) {
 400       return JVMTI_ERROR_OUT_OF_MEMORY;
 401     }
 402     for (int i = 0; i &lt; prefix_count; i++) {
 403       char* prefix = prefixes[i];
 404       if (prefix == NULL) {
 405         for (int j = 0; j &lt; (i-1); j++) {
 406           os::free(new_prefixes[j]);
 407         }
 408         os::free(new_prefixes);
 409         return JVMTI_ERROR_NULL_POINTER;
 410       }
 411       prefix = os::strdup(prefixes[i]);
 412       if (prefix == NULL) {
 413         for (int j = 0; j &lt; (i-1); j++) {
 414           os::free(new_prefixes[j]);
 415         }
 416         os::free(new_prefixes);
 417         return JVMTI_ERROR_OUT_OF_MEMORY;
 418       }
 419       new_prefixes[i] = prefix;
 420     }
 421     _native_method_prefix_count = prefix_count;
 422     _native_method_prefixes = new_prefixes;
 423   }
 424 
 425   // now that we know the new prefixes have been successfully installed we can
 426   // safely remove the old ones
 427   if (old_prefix_count != 0) {
 428     for (int i = 0; i &lt; old_prefix_count; i++) {
 429       os::free(old_prefixes[i]);
 430     }
 431     os::free(old_prefixes);
 432   }
 433 
 434   return JVMTI_ERROR_NONE;
 435 }
 436 
 437 
 438 // Collect all the prefixes which have been set in any JVM TI environments
 439 // by the SetNativeMethodPrefix(es) functions.  Be sure to maintain the
 440 // order of environments and the order of prefixes within each environment.
 441 // Return in a resource allocated array.
 442 char**
 443 JvmtiEnvBase::get_all_native_method_prefixes(int* count_ptr) {
 444   assert(Threads::number_of_threads() == 0 ||
 445          SafepointSynchronize::is_at_safepoint() ||
 446          JvmtiThreadState_lock-&gt;is_locked(),
 447          &quot;sanity check&quot;);
 448 
 449   int total_count = 0;
 450   GrowableArray&lt;char*&gt;* prefix_array =new GrowableArray&lt;char*&gt;(5);
 451 
 452   JvmtiEnvIterator it;
 453   for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 454     int prefix_count = env-&gt;get_native_method_prefix_count();
 455     char** prefixes = env-&gt;get_native_method_prefixes();
 456     for (int j = 0; j &lt; prefix_count; j++) {
 457       // retrieve a prefix and so that it is safe against asynchronous changes
 458       // copy it into the resource area
 459       char* prefix = prefixes[j];
 460       char* prefix_copy = NEW_RESOURCE_ARRAY(char, strlen(prefix)+1);
 461       strcpy(prefix_copy, prefix);
 462       prefix_array-&gt;at_put_grow(total_count++, prefix_copy);
 463     }
 464   }
 465 
 466   char** all_prefixes = NEW_RESOURCE_ARRAY(char*, total_count);
 467   char** p = all_prefixes;
 468   for (int i = 0; i &lt; total_count; ++i) {
 469     *p++ = prefix_array-&gt;at(i);
 470   }
 471   *count_ptr = total_count;
 472   return all_prefixes;
 473 }
 474 
 475 void
 476 JvmtiEnvBase::set_event_callbacks(const jvmtiEventCallbacks* callbacks,
 477                                                jint size_of_callbacks) {
 478   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 479 
 480   size_t byte_cnt = sizeof(jvmtiEventCallbacks);
 481 
 482   // clear in either case to be sure we got any gap between sizes
 483   memset(&amp;_event_callbacks, 0, byte_cnt);
 484 
 485   // Now that JvmtiThreadState_lock is held, prevent a possible race condition where events
 486   // are re-enabled by a call to set event callbacks where the DisposeEnvironment
 487   // occurs after the boiler-plate environment check and before the lock is acquired.
 488   if (callbacks != NULL &amp;&amp; is_valid()) {
 489     if (size_of_callbacks &lt; (jint)byte_cnt) {
 490       byte_cnt = size_of_callbacks;
 491     }
 492     memcpy(&amp;_event_callbacks, callbacks, byte_cnt);
 493   }
 494 }
 495 
 496 
 497 // In the fullness of time, all users of the method should instead
 498 // directly use allocate, besides being cleaner and faster, this will
 499 // mean much better out of memory handling
 500 unsigned char *
 501 JvmtiEnvBase::jvmtiMalloc(jlong size) {
 502   unsigned char* mem = NULL;
 503   jvmtiError result = allocate(size, &amp;mem);
 504   assert(result == JVMTI_ERROR_NONE, &quot;Allocate failed&quot;);
 505   return mem;
 506 }
 507 
 508 
 509 // Handle management
 510 
 511 jobject JvmtiEnvBase::jni_reference(Handle hndl) {
 512   return JNIHandles::make_local(hndl());
 513 }
 514 
 515 jobject JvmtiEnvBase::jni_reference(JavaThread *thread, Handle hndl) {
 516   return JNIHandles::make_local(thread, hndl());
 517 }
 518 
 519 void JvmtiEnvBase::destroy_jni_reference(jobject jobj) {
 520   JNIHandles::destroy_local(jobj);
 521 }
 522 
 523 void JvmtiEnvBase::destroy_jni_reference(JavaThread *thread, jobject jobj) {
 524   JNIHandles::destroy_local(jobj); // thread is unused.
 525 }
 526 
 527 //
 528 // Threads
 529 //
 530 
 531 jobject *
 532 JvmtiEnvBase::new_jobjectArray(int length, Handle *handles) {
 533   if (length == 0) {
 534     return NULL;
 535   }
 536 
 537   jobject *objArray = (jobject *) jvmtiMalloc(sizeof(jobject) * length);
 538   NULL_CHECK(objArray, NULL);
 539 
 540   for (int i=0; i&lt;length; i++) {
 541     objArray[i] = jni_reference(handles[i]);
 542   }
 543   return objArray;
 544 }
 545 
 546 jthread *
 547 JvmtiEnvBase::new_jthreadArray(int length, Handle *handles) {
 548   return (jthread *) new_jobjectArray(length,handles);
 549 }
 550 
 551 jthreadGroup *
 552 JvmtiEnvBase::new_jthreadGroupArray(int length, Handle *handles) {
 553   return (jthreadGroup *) new_jobjectArray(length,handles);
 554 }
 555 
 556 // return the vframe on the specified thread and depth, NULL if no such frame
 557 vframe*
 558 JvmtiEnvBase::vframeFor(JavaThread* java_thread, jint depth) {
 559   if (!java_thread-&gt;has_last_Java_frame()) {
 560     return NULL;
 561   }
 562   RegisterMap reg_map(java_thread);
 563   vframe *vf = java_thread-&gt;last_java_vframe(&amp;reg_map);
 564   int d = 0;
 565   while ((vf != NULL) &amp;&amp; (d &lt; depth)) {
 566     vf = vf-&gt;java_sender();
 567     d++;
 568   }
 569   return vf;
 570 }
 571 
 572 
 573 //
 574 // utilities: JNI objects
 575 //
 576 
 577 
 578 jclass
 579 JvmtiEnvBase::get_jni_class_non_null(Klass* k) {
 580   assert(k != NULL, &quot;k != NULL&quot;);
 581   Thread *thread = Thread::current();
 582   return (jclass)jni_reference(Handle(thread, k-&gt;java_mirror()));
 583 }
 584 
 585 //
 586 // Field Information
 587 //
 588 
 589 bool
 590 JvmtiEnvBase::get_field_descriptor(Klass* k, jfieldID field, fieldDescriptor* fd) {
 591   if (!jfieldIDWorkaround::is_valid_jfieldID(k, field)) {
 592     return false;
 593   }
 594   bool found = false;
 595   if (jfieldIDWorkaround::is_static_jfieldID(field)) {
 596     JNIid* id = jfieldIDWorkaround::from_static_jfieldID(field);
 597     found = id-&gt;find_local_field(fd);
 598   } else {
 599     // Non-static field. The fieldID is really the offset of the field within the object.
 600     int offset = jfieldIDWorkaround::from_instance_jfieldID(k, field);
 601     found = InstanceKlass::cast(k)-&gt;find_field_from_offset(offset, false, fd);
 602   }
 603   return found;
 604 }
 605 
 606 //
 607 // Object Monitor Information
 608 //
 609 
 610 //
 611 // Count the number of objects for a lightweight monitor. The hobj
 612 // parameter is object that owns the monitor so this routine will
 613 // count the number of times the same object was locked by frames
 614 // in java_thread.
 615 //
 616 jint
 617 JvmtiEnvBase::count_locked_objects(JavaThread *java_thread, Handle hobj) {
 618   jint ret = 0;
 619   if (!java_thread-&gt;has_last_Java_frame()) {
 620     return ret;  // no Java frames so no monitors
 621   }
 622 
 623   ResourceMark rm;
 624   HandleMark   hm;
 625   RegisterMap  reg_map(java_thread);
 626 
 627   for(javaVFrame *jvf=java_thread-&gt;last_java_vframe(&amp;reg_map); jvf != NULL;
 628                                                  jvf = jvf-&gt;java_sender()) {
 629     GrowableArray&lt;MonitorInfo*&gt;* mons = jvf-&gt;monitors();
 630     if (!mons-&gt;is_empty()) {
 631       for (int i = 0; i &lt; mons-&gt;length(); i++) {
 632         MonitorInfo *mi = mons-&gt;at(i);
 633         if (mi-&gt;owner_is_scalar_replaced()) continue;
 634 
 635         // see if owner of the monitor is our object
 636         if (mi-&gt;owner() != NULL &amp;&amp; mi-&gt;owner() == hobj()) {
 637           ret++;
 638         }
 639       }
 640     }
 641   }
 642   return ret;
 643 }
 644 
 645 
 646 
 647 jvmtiError
 648 JvmtiEnvBase::get_current_contended_monitor(JavaThread *calling_thread, JavaThread *java_thread, jobject *monitor_ptr) {
 649 #ifdef ASSERT
 650   uint32_t debug_bits = 0;
 651 #endif
 652   assert((SafepointSynchronize::is_at_safepoint() ||
 653           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 654          &quot;at safepoint or target thread is suspended&quot;);
 655   oop obj = NULL;
 656   ObjectMonitor *mon = java_thread-&gt;current_waiting_monitor();
 657   if (mon == NULL) {
 658     // thread is not doing an Object.wait() call
 659     mon = java_thread-&gt;current_pending_monitor();
 660     if (mon != NULL) {
<a name="3" id="anc3"></a><span class="line-modified"> 661       // The thread is trying to enter() or raw_enter() an ObjectMonitor.</span>
 662       obj = (oop)mon-&gt;object();
<a name="4" id="anc4"></a><span class="line-modified"> 663       // If obj == NULL, then ObjectMonitor is raw which doesn&#39;t count</span>
<span class="line-removed"> 664       // as contended for this API</span>
 665     }
 666     // implied else: no contended ObjectMonitor
 667   } else {
 668     // thread is doing an Object.wait() call
 669     obj = (oop)mon-&gt;object();
 670     assert(obj != NULL, &quot;Object.wait() should have an object&quot;);
 671   }
 672 
 673   if (obj == NULL) {
 674     *monitor_ptr = NULL;
 675   } else {
 676     HandleMark hm;
 677     Handle     hobj(Thread::current(), obj);
 678     *monitor_ptr = jni_reference(calling_thread, hobj);
 679   }
 680   return JVMTI_ERROR_NONE;
 681 }
 682 
 683 
 684 jvmtiError
 685 JvmtiEnvBase::get_owned_monitors(JavaThread *calling_thread, JavaThread* java_thread,
 686                                  GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list) {
 687   jvmtiError err = JVMTI_ERROR_NONE;
 688 #ifdef ASSERT
 689   uint32_t debug_bits = 0;
 690 #endif
 691   assert((SafepointSynchronize::is_at_safepoint() ||
 692           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 693          &quot;at safepoint or target thread is suspended&quot;);
 694 
 695   if (java_thread-&gt;has_last_Java_frame()) {
 696     ResourceMark rm;
 697     HandleMark   hm;
 698     RegisterMap  reg_map(java_thread);
 699 
 700     int depth = 0;
 701     for (javaVFrame *jvf = java_thread-&gt;last_java_vframe(&amp;reg_map); jvf != NULL;
 702          jvf = jvf-&gt;java_sender()) {
 703       if (MaxJavaStackTraceDepth == 0 || depth++ &lt; MaxJavaStackTraceDepth) {  // check for stack too deep
 704         // add locked objects for this frame into list
 705         err = get_locked_objects_in_frame(calling_thread, java_thread, jvf, owned_monitors_list, depth-1);
 706         if (err != JVMTI_ERROR_NONE) {
 707           return err;
 708         }
 709       }
 710     }
 711   }
 712 
 713   // Get off stack monitors. (e.g. acquired via jni MonitorEnter).
 714   JvmtiMonitorClosure jmc(java_thread, calling_thread, owned_monitors_list, this);
 715   ObjectSynchronizer::monitors_iterate(&amp;jmc);
 716   err = jmc.error();
 717 
 718   return err;
 719 }
 720 
 721 // Save JNI local handles for any objects that this frame owns.
 722 jvmtiError
 723 JvmtiEnvBase::get_locked_objects_in_frame(JavaThread* calling_thread, JavaThread* java_thread,
 724                                  javaVFrame *jvf, GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;* owned_monitors_list, jint stack_depth) {
 725   jvmtiError err = JVMTI_ERROR_NONE;
 726   ResourceMark rm;
 727 
 728   GrowableArray&lt;MonitorInfo*&gt;* mons = jvf-&gt;monitors();
 729   if (mons-&gt;is_empty()) {
 730     return err;  // this javaVFrame holds no monitors
 731   }
 732 
 733   HandleMark hm;
 734   oop wait_obj = NULL;
 735   {
 736     // save object of current wait() call (if any) for later comparison
 737     ObjectMonitor *mon = java_thread-&gt;current_waiting_monitor();
 738     if (mon != NULL) {
 739       wait_obj = (oop)mon-&gt;object();
 740     }
 741   }
 742   oop pending_obj = NULL;
 743   {
 744     // save object of current enter() call (if any) for later comparison
 745     ObjectMonitor *mon = java_thread-&gt;current_pending_monitor();
 746     if (mon != NULL) {
 747       pending_obj = (oop)mon-&gt;object();
 748     }
 749   }
 750 
 751   for (int i = 0; i &lt; mons-&gt;length(); i++) {
 752     MonitorInfo *mi = mons-&gt;at(i);
 753 
 754     if (mi-&gt;owner_is_scalar_replaced()) continue;
 755 
 756     oop obj = mi-&gt;owner();
 757     if (obj == NULL) {
 758       // this monitor doesn&#39;t have an owning object so skip it
 759       continue;
 760     }
 761 
 762     if (wait_obj == obj) {
 763       // the thread is waiting on this monitor so it isn&#39;t really owned
 764       continue;
 765     }
 766 
 767     if (pending_obj == obj) {
 768       // the thread is pending on this monitor so it isn&#39;t really owned
 769       continue;
 770     }
 771 
 772     if (owned_monitors_list-&gt;length() &gt; 0) {
 773       // Our list has at least one object on it so we have to check
 774       // for recursive object locking
 775       bool found = false;
 776       for (int j = 0; j &lt; owned_monitors_list-&gt;length(); j++) {
 777         jobject jobj = ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(j))-&gt;monitor;
 778         oop check = JNIHandles::resolve(jobj);
 779         if (check == obj) {
 780           found = true;  // we found the object
 781           break;
 782         }
 783       }
 784 
 785       if (found) {
 786         // already have this object so don&#39;t include it
 787         continue;
 788       }
 789     }
 790 
 791     // add the owning object to our list
 792     jvmtiMonitorStackDepthInfo *jmsdi;
 793     err = allocate(sizeof(jvmtiMonitorStackDepthInfo), (unsigned char **)&amp;jmsdi);
 794     if (err != JVMTI_ERROR_NONE) {
 795         return err;
 796     }
 797     Handle hobj(Thread::current(), obj);
 798     jmsdi-&gt;monitor = jni_reference(calling_thread, hobj);
 799     jmsdi-&gt;stack_depth = stack_depth;
 800     owned_monitors_list-&gt;append(jmsdi);
 801   }
 802 
 803   return err;
 804 }
 805 
 806 jvmtiError
 807 JvmtiEnvBase::get_stack_trace(JavaThread *java_thread,
 808                               jint start_depth, jint max_count,
 809                               jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
 810 #ifdef ASSERT
 811   uint32_t debug_bits = 0;
 812 #endif
 813   assert((SafepointSynchronize::is_at_safepoint() ||
 814           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 815          &quot;at safepoint or target thread is suspended&quot;);
 816   int count = 0;
 817   if (java_thread-&gt;has_last_Java_frame()) {
 818     RegisterMap reg_map(java_thread);
 819     Thread* current_thread = Thread::current();
 820     ResourceMark rm(current_thread);
 821     javaVFrame *jvf = java_thread-&gt;last_java_vframe(&amp;reg_map);
 822     HandleMark hm(current_thread);
 823     if (start_depth != 0) {
 824       if (start_depth &gt; 0) {
 825         for (int j = 0; j &lt; start_depth &amp;&amp; jvf != NULL; j++) {
 826           jvf = jvf-&gt;java_sender();
 827         }
 828         if (jvf == NULL) {
 829           // start_depth is deeper than the stack depth
 830           return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 831         }
 832       } else { // start_depth &lt; 0
 833         // we are referencing the starting depth based on the oldest
 834         // part of the stack.
 835         // optimize to limit the number of times that java_sender() is called
 836         javaVFrame *jvf_cursor = jvf;
 837         javaVFrame *jvf_prev = NULL;
 838         javaVFrame *jvf_prev_prev = NULL;
 839         int j = 0;
 840         while (jvf_cursor != NULL) {
 841           jvf_prev_prev = jvf_prev;
 842           jvf_prev = jvf_cursor;
 843           for (j = 0; j &gt; start_depth &amp;&amp; jvf_cursor != NULL; j--) {
 844             jvf_cursor = jvf_cursor-&gt;java_sender();
 845           }
 846         }
 847         if (j == start_depth) {
 848           // previous pointer is exactly where we want to start
 849           jvf = jvf_prev;
 850         } else {
 851           // we need to back up further to get to the right place
 852           if (jvf_prev_prev == NULL) {
 853             // the -start_depth is greater than the stack depth
 854             return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 855           }
 856           // j now is the number of frames on the stack starting with
 857           // jvf_prev, we start from jvf_prev_prev and move older on
 858           // the stack that many, the result is -start_depth frames
 859           // remaining.
 860           jvf = jvf_prev_prev;
 861           for (; j &lt; 0; j++) {
 862             jvf = jvf-&gt;java_sender();
 863           }
 864         }
 865       }
 866     }
 867     for (; count &lt; max_count &amp;&amp; jvf != NULL; count++) {
 868       frame_buffer[count].method = jvf-&gt;method()-&gt;jmethod_id();
 869       frame_buffer[count].location = (jvf-&gt;method()-&gt;is_native() ? -1 : jvf-&gt;bci());
 870       jvf = jvf-&gt;java_sender();
 871     }
 872   } else {
 873     if (start_depth != 0) {
 874       // no frames and there is a starting depth
 875       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 876     }
 877   }
 878   *count_ptr = count;
 879   return JVMTI_ERROR_NONE;
 880 }
 881 
 882 jvmtiError
 883 JvmtiEnvBase::get_frame_count(JvmtiThreadState *state, jint *count_ptr) {
 884   assert((state != NULL),
 885          &quot;JavaThread should create JvmtiThreadState before calling this method&quot;);
 886   *count_ptr = state-&gt;count_frames();
 887   return JVMTI_ERROR_NONE;
 888 }
 889 
 890 jvmtiError
 891 JvmtiEnvBase::get_frame_location(JavaThread *java_thread, jint depth,
 892                                  jmethodID* method_ptr, jlocation* location_ptr) {
 893 #ifdef ASSERT
 894   uint32_t debug_bits = 0;
 895 #endif
 896   assert((SafepointSynchronize::is_at_safepoint() ||
 897           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 898          &quot;at safepoint or target thread is suspended&quot;);
 899   Thread* current_thread = Thread::current();
 900   ResourceMark rm(current_thread);
 901 
 902   vframe *vf = vframeFor(java_thread, depth);
 903   if (vf == NULL) {
 904     return JVMTI_ERROR_NO_MORE_FRAMES;
 905   }
 906 
 907   // vframeFor should return a java frame. If it doesn&#39;t
 908   // it means we&#39;ve got an internal error and we return the
 909   // error in product mode. In debug mode we will instead
 910   // attempt to cast the vframe to a javaVFrame and will
 911   // cause an assertion/crash to allow further diagnosis.
 912 #ifdef PRODUCT
 913   if (!vf-&gt;is_java_frame()) {
 914     return JVMTI_ERROR_INTERNAL;
 915   }
 916 #endif
 917 
 918   HandleMark hm(current_thread);
 919   javaVFrame *jvf = javaVFrame::cast(vf);
 920   Method* method = jvf-&gt;method();
 921   if (method-&gt;is_native()) {
 922     *location_ptr = -1;
 923   } else {
 924     *location_ptr = jvf-&gt;bci();
 925   }
 926   *method_ptr = method-&gt;jmethod_id();
 927 
 928   return JVMTI_ERROR_NONE;
 929 }
 930 
 931 
 932 jvmtiError
 933 JvmtiEnvBase::get_object_monitor_usage(JavaThread* calling_thread, jobject object, jvmtiMonitorUsage* info_ptr) {
 934   HandleMark hm;
 935   Handle hobj;
 936 
 937   Thread* current_thread = Thread::current();
 938   bool at_safepoint = SafepointSynchronize::is_at_safepoint();
 939 
 940   // Check arguments
 941   {
 942     oop mirror = JNIHandles::resolve_external_guard(object);
 943     NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 944     NULL_CHECK(info_ptr, JVMTI_ERROR_NULL_POINTER);
 945 
 946     hobj = Handle(current_thread, mirror);
 947   }
 948 
 949   JavaThread *owning_thread = NULL;
 950   ObjectMonitor *mon = NULL;
 951   jvmtiMonitorUsage ret = {
 952       NULL, 0, 0, NULL, 0, NULL
 953   };
 954 
 955   uint32_t debug_bits = 0;
 956   // first derive the object&#39;s owner and entry_count (if any)
 957   {
 958     // Revoke any biases before querying the mark word
 959     if (at_safepoint) {
 960       BiasedLocking::revoke_at_safepoint(hobj);
 961     } else {
<a name="5" id="anc5"></a><span class="line-modified"> 962       BiasedLocking::revoke_and_rebias(hobj, false, calling_thread);</span>
 963     }
 964 
 965     address owner = NULL;
 966     {
<a name="6" id="anc6"></a><span class="line-modified"> 967       markOop mark = hobj()-&gt;mark();</span>
 968 
<a name="7" id="anc7"></a><span class="line-modified"> 969       if (!mark-&gt;has_monitor()) {</span>
 970         // this object has a lightweight monitor
 971 
<a name="8" id="anc8"></a><span class="line-modified"> 972         if (mark-&gt;has_locker()) {</span>
<span class="line-modified"> 973           owner = (address)mark-&gt;locker(); // save the address of the Lock word</span>
 974         }
 975         // implied else: no owner
 976       } else {
 977         // this object has a heavyweight monitor
<a name="9" id="anc9"></a><span class="line-modified"> 978         mon = mark-&gt;monitor();</span>
 979 
 980         // The owner field of a heavyweight monitor may be NULL for no
 981         // owner, a JavaThread * or it may still be the address of the
 982         // Lock word in a JavaThread&#39;s stack. A monitor can be inflated
 983         // by a non-owning JavaThread, but only the owning JavaThread
 984         // can change the owner field from the Lock word to the
 985         // JavaThread * and it may not have done that yet.
 986         owner = (address)mon-&gt;owner();
 987       }
 988     }
 989 
 990     if (owner != NULL) {
 991       // Use current thread since function can be called from a
 992       // JavaThread or the VMThread.
 993       ThreadsListHandle tlh;
 994       // This monitor is owned so we have to find the owning JavaThread.
 995       owning_thread = Threads::owning_thread_from_monitor_owner(tlh.list(), owner);
 996       // Cannot assume (owning_thread != NULL) here because this function
 997       // may not have been called at a safepoint and the owning_thread
 998       // might not be suspended.
 999       if (owning_thread != NULL) {
1000         // The monitor&#39;s owner either has to be the current thread, at safepoint
1001         // or it has to be suspended. Any of these conditions will prevent both
1002         // contending and waiting threads from modifying the state of
1003         // the monitor.
1004         if (!at_safepoint &amp;&amp; !owning_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1005           // Don&#39;t worry! This return of JVMTI_ERROR_THREAD_NOT_SUSPENDED
1006           // will not make it back to the JVM/TI agent. The error code will
1007           // get intercepted in JvmtiEnv::GetObjectMonitorUsage() which
1008           // will retry the call via a VM_GetObjectMonitorUsage VM op.
1009           return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1010         }
1011         HandleMark hm;
1012         Handle     th(current_thread, owning_thread-&gt;threadObj());
1013         ret.owner = (jthread)jni_reference(calling_thread, th);
1014       }
1015       // implied else: no owner
1016     } // ThreadsListHandle is destroyed here.
1017 
1018     if (owning_thread != NULL) {  // monitor is owned
1019       // The recursions field of a monitor does not reflect recursions
1020       // as lightweight locks before inflating the monitor are not included.
1021       // We have to count the number of recursive monitor entries the hard way.
1022       // We pass a handle to survive any GCs along the way.
1023       ResourceMark rm;
1024       ret.entry_count = count_locked_objects(owning_thread, hobj);
1025     }
1026     // implied else: entry_count == 0
1027   }
1028 
1029   jint nWant = 0, nWait = 0;
1030   if (mon != NULL) {
1031     // this object has a heavyweight monitor
1032     nWant = mon-&gt;contentions(); // # of threads contending for monitor
1033     nWait = mon-&gt;waiters();     // # of threads in Object.wait()
1034     ret.waiter_count = nWant + nWait;
1035     ret.notify_waiter_count = nWait;
1036   } else {
1037     // this object has a lightweight monitor
1038     ret.waiter_count = 0;
1039     ret.notify_waiter_count = 0;
1040   }
1041 
1042   // Allocate memory for heavyweight and lightweight monitor.
1043   jvmtiError err;
1044   err = allocate(ret.waiter_count * sizeof(jthread *), (unsigned char**)&amp;ret.waiters);
1045   if (err != JVMTI_ERROR_NONE) {
1046     return err;
1047   }
1048   err = allocate(ret.notify_waiter_count * sizeof(jthread *),
1049                  (unsigned char**)&amp;ret.notify_waiters);
1050   if (err != JVMTI_ERROR_NONE) {
1051     deallocate((unsigned char*)ret.waiters);
1052     return err;
1053   }
1054 
1055   // now derive the rest of the fields
1056   if (mon != NULL) {
1057     // this object has a heavyweight monitor
1058 
1059     // Number of waiters may actually be less than the waiter count.
1060     // So NULL out memory so that unused memory will be NULL.
1061     memset(ret.waiters, 0, ret.waiter_count * sizeof(jthread *));
1062     memset(ret.notify_waiters, 0, ret.notify_waiter_count * sizeof(jthread *));
1063 
1064     if (ret.waiter_count &gt; 0) {
1065       // we have contending and/or waiting threads
1066       HandleMark hm;
1067       // Use current thread since function can be called from a
1068       // JavaThread or the VMThread.
1069       ThreadsListHandle tlh;
1070       if (nWant &gt; 0) {
1071         // we have contending threads
1072         ResourceMark rm;
1073         // get_pending_threads returns only java thread so we do not need to
1074         // check for non java threads.
1075         GrowableArray&lt;JavaThread*&gt;* wantList = Threads::get_pending_threads(tlh.list(), nWant, (address)mon);
1076         if (wantList-&gt;length() &lt; nWant) {
1077           // robustness: the pending list has gotten smaller
1078           nWant = wantList-&gt;length();
1079         }
1080         for (int i = 0; i &lt; nWant; i++) {
1081           JavaThread *pending_thread = wantList-&gt;at(i);
1082           // If the monitor has no owner, then a non-suspended contending
1083           // thread could potentially change the state of the monitor by
1084           // entering it. The JVM/TI spec doesn&#39;t allow this.
<a name="10" id="anc10"></a><span class="line-modified">1085           if (owning_thread == NULL &amp;&amp; !at_safepoint &amp;</span>
1086               !pending_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1087             if (ret.owner != NULL) {
1088               destroy_jni_reference(calling_thread, ret.owner);
1089             }
1090             for (int j = 0; j &lt; i; j++) {
1091               destroy_jni_reference(calling_thread, ret.waiters[j]);
1092             }
1093             deallocate((unsigned char*)ret.waiters);
1094             deallocate((unsigned char*)ret.notify_waiters);
1095             return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1096           }
1097           Handle th(current_thread, pending_thread-&gt;threadObj());
1098           ret.waiters[i] = (jthread)jni_reference(calling_thread, th);
1099         }
1100       }
1101       if (nWait &gt; 0) {
1102         // we have threads in Object.wait()
1103         int offset = nWant;  // add after any contending threads
1104         ObjectWaiter *waiter = mon-&gt;first_waiter();
1105         for (int i = 0, j = 0; i &lt; nWait; i++) {
1106           if (waiter == NULL) {
1107             // robustness: the waiting list has gotten smaller
1108             nWait = j;
1109             break;
1110           }
1111           Thread *t = mon-&gt;thread_of_waiter(waiter);
1112           if (t != NULL &amp;&amp; t-&gt;is_Java_thread()) {
1113             JavaThread *wjava_thread = (JavaThread *)t;
1114             // If the thread was found on the ObjectWaiter list, then
1115             // it has not been notified. This thread can&#39;t change the
1116             // state of the monitor so it doesn&#39;t need to be suspended.
1117             Handle th(current_thread, wjava_thread-&gt;threadObj());
1118             ret.waiters[offset + j] = (jthread)jni_reference(calling_thread, th);
1119             ret.notify_waiters[j++] = (jthread)jni_reference(calling_thread, th);
1120           }
1121           waiter = mon-&gt;next_waiter(waiter);
1122         }
1123       }
1124     } // ThreadsListHandle is destroyed here.
1125 
1126     // Adjust count. nWant and nWait count values may be less than original.
1127     ret.waiter_count = nWant + nWait;
1128     ret.notify_waiter_count = nWait;
1129   } else {
1130     // this object has a lightweight monitor and we have nothing more
1131     // to do here because the defaults are just fine.
1132   }
1133 
1134   // we don&#39;t update return parameter unless everything worked
1135   *info_ptr = ret;
1136 
1137   return JVMTI_ERROR_NONE;
1138 }
1139 
1140 ResourceTracker::ResourceTracker(JvmtiEnv* env) {
1141   _env = env;
1142   _allocations = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;unsigned char*&gt;(20, true);
1143   _failed = false;
1144 }
1145 ResourceTracker::~ResourceTracker() {
1146   if (_failed) {
1147     for (int i=0; i&lt;_allocations-&gt;length(); i++) {
1148       _env-&gt;deallocate(_allocations-&gt;at(i));
1149     }
1150   }
1151   delete _allocations;
1152 }
1153 
1154 jvmtiError ResourceTracker::allocate(jlong size, unsigned char** mem_ptr) {
1155   unsigned char *ptr;
1156   jvmtiError err = _env-&gt;allocate(size, &amp;ptr);
1157   if (err == JVMTI_ERROR_NONE) {
1158     _allocations-&gt;append(ptr);
1159     *mem_ptr = ptr;
1160   } else {
1161     *mem_ptr = NULL;
1162     _failed = true;
1163   }
1164   return err;
1165  }
1166 
1167 unsigned char* ResourceTracker::allocate(jlong size) {
1168   unsigned char* ptr;
1169   allocate(size, &amp;ptr);
1170   return ptr;
1171 }
1172 
1173 char* ResourceTracker::strdup(const char* str) {
1174   char *dup_str = (char*)allocate(strlen(str)+1);
1175   if (dup_str != NULL) {
1176     strcpy(dup_str, str);
1177   }
1178   return dup_str;
1179 }
1180 
1181 struct StackInfoNode {
1182   struct StackInfoNode *next;
1183   jvmtiStackInfo info;
1184 };
1185 
1186 // Create a jvmtiStackInfo inside a linked list node and create a
1187 // buffer for the frame information, both allocated as resource objects.
1188 // Fill in both the jvmtiStackInfo and the jvmtiFrameInfo.
1189 // Note that either or both of thr and thread_oop
1190 // may be null if the thread is new or has exited.
1191 void
1192 VM_GetMultipleStackTraces::fill_frames(jthread jt, JavaThread *thr, oop thread_oop) {
1193   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1194 
1195   jint state = 0;
1196   struct StackInfoNode *node = NEW_RESOURCE_OBJ(struct StackInfoNode);
1197   jvmtiStackInfo *infop = &amp;(node-&gt;info);
1198   node-&gt;next = head();
1199   set_head(node);
1200   infop-&gt;frame_count = 0;
1201   infop-&gt;thread = jt;
1202 
1203   if (thread_oop != NULL) {
1204     // get most state bits
1205     state = (jint)java_lang_Thread::get_thread_status(thread_oop);
1206   }
1207 
1208   if (thr != NULL) {    // add more state bits if there is a JavaThead to query
1209     // same as is_being_ext_suspended() but without locking
1210     if (thr-&gt;is_ext_suspended() || thr-&gt;is_external_suspend()) {
1211       state |= JVMTI_THREAD_STATE_SUSPENDED;
1212     }
1213     JavaThreadState jts = thr-&gt;thread_state();
1214     if (jts == _thread_in_native) {
1215       state |= JVMTI_THREAD_STATE_IN_NATIVE;
1216     }
<a name="11" id="anc11"></a><span class="line-modified">1217     OSThread* osThread = thr-&gt;osthread();</span>
<span class="line-removed">1218     if (osThread != NULL &amp;&amp; osThread-&gt;interrupted()) {</span>
1219       state |= JVMTI_THREAD_STATE_INTERRUPTED;
1220     }
1221   }
1222   infop-&gt;state = state;
1223 
1224   if (thr != NULL &amp;&amp; (state &amp; JVMTI_THREAD_STATE_ALIVE) != 0) {
1225     infop-&gt;frame_buffer = NEW_RESOURCE_ARRAY(jvmtiFrameInfo, max_frame_count());
1226     env()-&gt;get_stack_trace(thr, 0, max_frame_count(),
1227                            infop-&gt;frame_buffer, &amp;(infop-&gt;frame_count));
1228   } else {
1229     infop-&gt;frame_buffer = NULL;
1230     infop-&gt;frame_count = 0;
1231   }
1232   _frame_count_total += infop-&gt;frame_count;
1233 }
1234 
1235 // Based on the stack information in the linked list, allocate memory
1236 // block to return and fill it from the info in the linked list.
1237 void
1238 VM_GetMultipleStackTraces::allocate_and_fill_stacks(jint thread_count) {
1239   // do I need to worry about alignment issues?
1240   jlong alloc_size =  thread_count       * sizeof(jvmtiStackInfo)
1241                     + _frame_count_total * sizeof(jvmtiFrameInfo);
1242   env()-&gt;allocate(alloc_size, (unsigned char **)&amp;_stack_info);
1243 
1244   // pointers to move through the newly allocated space as it is filled in
1245   jvmtiStackInfo *si = _stack_info + thread_count;      // bottom of stack info
1246   jvmtiFrameInfo *fi = (jvmtiFrameInfo *)si;            // is the top of frame info
1247 
1248   // copy information in resource area into allocated buffer
1249   // insert stack info backwards since linked list is backwards
1250   // insert frame info forwards
1251   // walk the StackInfoNodes
1252   for (struct StackInfoNode *sin = head(); sin != NULL; sin = sin-&gt;next) {
1253     jint frame_count = sin-&gt;info.frame_count;
1254     size_t frames_size = frame_count * sizeof(jvmtiFrameInfo);
1255     --si;
1256     memcpy(si, &amp;(sin-&gt;info), sizeof(jvmtiStackInfo));
1257     if (frames_size == 0) {
1258       si-&gt;frame_buffer = NULL;
1259     } else {
1260       memcpy(fi, sin-&gt;info.frame_buffer, frames_size);
1261       si-&gt;frame_buffer = fi;  // point to the new allocated copy of the frames
1262       fi += frame_count;
1263     }
1264   }
1265   assert(si == _stack_info, &quot;the last copied stack info must be the first record&quot;);
1266   assert((unsigned char *)fi == ((unsigned char *)_stack_info) + alloc_size,
1267          &quot;the last copied frame info must be the last record&quot;);
1268 }
1269 
1270 
1271 void
1272 VM_GetThreadListStackTraces::doit() {
1273   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1274 
1275   ResourceMark rm;
1276   ThreadsListHandle tlh;
1277   for (int i = 0; i &lt; _thread_count; ++i) {
1278     jthread jt = _thread_list[i];
1279     JavaThread* java_thread = NULL;
1280     oop thread_oop = NULL;
1281     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), jt, &amp;java_thread, &amp;thread_oop);
1282     if (err != JVMTI_ERROR_NONE) {
1283       // We got an error code so we don&#39;t have a JavaThread *, but
1284       // only return an error from here if we didn&#39;t get a valid
1285       // thread_oop.
1286       if (thread_oop == NULL) {
1287         set_result(err);
1288         return;
1289       }
1290       // We have a valid thread_oop.
1291     }
1292     fill_frames(jt, java_thread, thread_oop);
1293   }
1294   allocate_and_fill_stacks(_thread_count);
1295 }
1296 
1297 void
1298 VM_GetAllStackTraces::doit() {
1299   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1300 
1301   ResourceMark rm;
1302   _final_thread_count = 0;
1303   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
1304     oop thread_oop = jt-&gt;threadObj();
1305     if (thread_oop != NULL &amp;&amp;
1306         !jt-&gt;is_exiting() &amp;&amp;
1307         java_lang_Thread::is_alive(thread_oop) &amp;&amp;
1308         !jt-&gt;is_hidden_from_external_view()) {
1309       ++_final_thread_count;
1310       // Handle block of the calling thread is used to create local refs.
1311       fill_frames((jthread)JNIHandles::make_local(_calling_thread, thread_oop),
1312                   jt, thread_oop);
1313     }
1314   }
1315   allocate_and_fill_stacks(_final_thread_count);
1316 }
1317 
1318 // Verifies that the top frame is a java frame in an expected state.
1319 // Deoptimizes frame if needed.
1320 // Checks that the frame method signature matches the return type (tos).
1321 // HandleMark must be defined in the caller only.
1322 // It is to keep a ret_ob_h handle alive after return to the caller.
1323 jvmtiError
1324 JvmtiEnvBase::check_top_frame(JavaThread* current_thread, JavaThread* java_thread,
1325                               jvalue value, TosState tos, Handle* ret_ob_h) {
1326   ResourceMark rm(current_thread);
1327 
1328   vframe *vf = vframeFor(java_thread, 0);
1329   NULL_CHECK(vf, JVMTI_ERROR_NO_MORE_FRAMES);
1330 
1331   javaVFrame *jvf = (javaVFrame*) vf;
1332   if (!vf-&gt;is_java_frame() || jvf-&gt;method()-&gt;is_native()) {
1333     return JVMTI_ERROR_OPAQUE_FRAME;
1334   }
1335 
1336   // If the frame is a compiled one, need to deoptimize it.
1337   if (vf-&gt;is_compiled_frame()) {
1338     if (!vf-&gt;fr().can_be_deoptimized()) {
1339       return JVMTI_ERROR_OPAQUE_FRAME;
1340     }
1341     Deoptimization::deoptimize_frame(java_thread, jvf-&gt;fr().id());
1342   }
1343 
1344   // Get information about method return type
1345   Symbol* signature = jvf-&gt;method()-&gt;signature();
1346 
1347   ResultTypeFinder rtf(signature);
1348   TosState fr_tos = as_TosState(rtf.type());
1349   if (fr_tos != tos) {
1350     if (tos != itos || (fr_tos != btos &amp;&amp; fr_tos != ztos &amp;&amp; fr_tos != ctos &amp;&amp; fr_tos != stos)) {
1351       return JVMTI_ERROR_TYPE_MISMATCH;
1352     }
1353   }
1354 
1355   // Check that the jobject class matches the return type signature.
1356   jobject jobj = value.l;
1357   if (tos == atos &amp;&amp; jobj != NULL) { // NULL reference is allowed
1358     Handle ob_h(current_thread, JNIHandles::resolve_external_guard(jobj));
1359     NULL_CHECK(ob_h, JVMTI_ERROR_INVALID_OBJECT);
1360     Klass* ob_k = ob_h()-&gt;klass();
1361     NULL_CHECK(ob_k, JVMTI_ERROR_INVALID_OBJECT);
1362 
1363     // Method return type signature.
<a name="12" id="anc12"></a><span class="line-modified">1364     char* ty_sign = 1 + strchr(signature-&gt;as_C_string(), &#39;)&#39;);</span>
1365 
1366     if (!VM_GetOrSetLocal::is_assignable(ty_sign, ob_k, current_thread)) {
1367       return JVMTI_ERROR_TYPE_MISMATCH;
1368     }
1369     *ret_ob_h = ob_h;
1370   }
1371   return JVMTI_ERROR_NONE;
1372 } /* end check_top_frame */
1373 
1374 
1375 // ForceEarlyReturn&lt;type&gt; follows the PopFrame approach in many aspects.
1376 // Main difference is on the last stage in the interpreter.
1377 // The PopFrame stops method execution to continue execution
1378 // from the same method call instruction.
1379 // The ForceEarlyReturn forces return from method so the execution
1380 // continues at the bytecode following the method call.
1381 
1382 // Threads_lock NOT held, java_thread not protected by lock
1383 // java_thread - pre-checked
1384 
1385 jvmtiError
1386 JvmtiEnvBase::force_early_return(JavaThread* java_thread, jvalue value, TosState tos) {
1387   JavaThread* current_thread = JavaThread::current();
1388   HandleMark   hm(current_thread);
1389   uint32_t debug_bits = 0;
1390 
1391   // retrieve or create the state
1392   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1393   if (state == NULL) {
1394     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1395   }
1396 
1397   // Check if java_thread is fully suspended
1398   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1399     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1400   }
1401 
1402   // Check to see if a ForceEarlyReturn was already in progress
1403   if (state-&gt;is_earlyret_pending()) {
1404     // Probably possible for JVMTI clients to trigger this, but the
1405     // JPDA backend shouldn&#39;t allow this to happen
1406     return JVMTI_ERROR_INTERNAL;
1407   }
1408   {
1409     // The same as for PopFrame. Workaround bug:
1410     //  4812902: popFrame hangs if the method is waiting at a synchronize
1411     // Catch this condition and return an error to avoid hanging.
1412     // Now JVMTI spec allows an implementation to bail out with an opaque
1413     // frame error.
1414     OSThread* osThread = java_thread-&gt;osthread();
1415     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1416       return JVMTI_ERROR_OPAQUE_FRAME;
1417     }
1418   }
1419   Handle ret_ob_h;
1420   jvmtiError err = check_top_frame(current_thread, java_thread, value, tos, &amp;ret_ob_h);
1421   if (err != JVMTI_ERROR_NONE) {
1422     return err;
1423   }
1424   assert(tos != atos || value.l == NULL || ret_ob_h() != NULL,
1425          &quot;return object oop must not be NULL if jobject is not NULL&quot;);
1426 
1427   // Update the thread state to reflect that the top frame must be
1428   // forced to return.
1429   // The current frame will be returned later when the suspended
1430   // thread is resumed and right before returning from VM to Java.
1431   // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1432 
1433   state-&gt;set_earlyret_pending();
1434   state-&gt;set_earlyret_oop(ret_ob_h());
1435   state-&gt;set_earlyret_value(value, tos);
1436 
1437   // Set pending step flag for this early return.
1438   // It is cleared when next step event is posted.
1439   state-&gt;set_pending_step_for_earlyret();
1440 
1441   return JVMTI_ERROR_NONE;
1442 } /* end force_early_return */
1443 
1444 void
1445 JvmtiMonitorClosure::do_monitor(ObjectMonitor* mon) {
1446   if ( _error != JVMTI_ERROR_NONE) {
1447     // Error occurred in previous iteration so no need to add
1448     // to the list.
1449     return;
1450   }
1451   if (mon-&gt;owner() == _java_thread ) {
1452     // Filter out on stack monitors collected during stack walk.
1453     oop obj = (oop)mon-&gt;object();
1454     bool found = false;
1455     for (int j = 0; j &lt; _owned_monitors_list-&gt;length(); j++) {
1456       jobject jobj = ((jvmtiMonitorStackDepthInfo*)_owned_monitors_list-&gt;at(j))-&gt;monitor;
1457       oop check = JNIHandles::resolve(jobj);
1458       if (check == obj) {
1459         // On stack monitor already collected during the stack walk.
1460         found = true;
1461         break;
1462       }
1463     }
1464     if (found == false) {
1465       // This is off stack monitor (e.g. acquired via jni MonitorEnter).
1466       jvmtiError err;
1467       jvmtiMonitorStackDepthInfo *jmsdi;
1468       err = _env-&gt;allocate(sizeof(jvmtiMonitorStackDepthInfo), (unsigned char **)&amp;jmsdi);
1469       if (err != JVMTI_ERROR_NONE) {
1470         _error = err;
1471         return;
1472       }
1473       Handle hobj(Thread::current(), obj);
1474       jmsdi-&gt;monitor = _env-&gt;jni_reference(_calling_thread, hobj);
1475       // stack depth is unknown for this monitor.
1476       jmsdi-&gt;stack_depth = -1;
1477       _owned_monitors_list-&gt;append(jmsdi);
1478     }
1479   }
1480 }
1481 
1482 GrowableArray&lt;OopHandle&gt;* JvmtiModuleClosure::_tbl = NULL;
1483 
1484 void JvmtiModuleClosure::do_module(ModuleEntry* entry) {
1485   assert_locked_or_safepoint(Module_lock);
1486   OopHandle module = entry-&gt;module_handle();
1487   guarantee(module.resolve() != NULL, &quot;module object is NULL&quot;);
1488   _tbl-&gt;push(module);
1489 }
1490 
1491 jvmtiError
1492 JvmtiModuleClosure::get_all_modules(JvmtiEnv* env, jint* module_count_ptr, jobject** modules_ptr) {
1493   ResourceMark rm;
1494   MutexLocker mcld(ClassLoaderDataGraph_lock);
1495   MutexLocker ml(Module_lock);
1496 
1497   _tbl = new GrowableArray&lt;OopHandle&gt;(77);
1498   if (_tbl == NULL) {
1499     return JVMTI_ERROR_OUT_OF_MEMORY;
1500   }
1501 
1502   // Iterate over all the modules loaded to the system.
1503   ClassLoaderDataGraph::modules_do(&amp;do_module);
1504 
1505   jint len = _tbl-&gt;length();
1506   guarantee(len &gt; 0, &quot;at least one module must be present&quot;);
1507 
1508   jobject* array = (jobject*)env-&gt;jvmtiMalloc((jlong)(len * sizeof(jobject)));
1509   if (array == NULL) {
1510     return JVMTI_ERROR_OUT_OF_MEMORY;
1511   }
1512   for (jint idx = 0; idx &lt; len; idx++) {
1513     array[idx] = JNIHandles::make_local(Thread::current(), _tbl-&gt;at(idx).resolve());
1514   }
1515   _tbl = NULL;
1516   *modules_ptr = array;
1517   *module_count_ptr = len;
1518   return JVMTI_ERROR_NONE;
1519 }
1520 
1521 void
1522 VM_UpdateForPopTopFrame::doit() {
1523   JavaThread* jt = _state-&gt;get_thread();
1524   ThreadsListHandle tlh;
1525   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1526     _state-&gt;update_for_pop_top_frame();
1527   } else {
1528     _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1529   }
1530 }
1531 
1532 void
1533 VM_SetFramePop::doit() {
1534   JavaThread* jt = _state-&gt;get_thread();
1535   ThreadsListHandle tlh;
1536   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1537     int frame_number = _state-&gt;count_frames() - _depth;
1538     _state-&gt;env_thread_state((JvmtiEnvBase*)_env)-&gt;set_frame_pop(frame_number);
1539   } else {
1540     _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1541   }
1542 }
1543 
1544 void
1545 VM_GetOwnedMonitorInfo::doit() {
1546   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1547   ThreadsListHandle tlh;
1548   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1549       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1550     _result = ((JvmtiEnvBase *)_env)-&gt;get_owned_monitors(_calling_thread, _java_thread,
1551                                                           _owned_monitors_list);
1552   }
1553 }
1554 
1555 void
1556 VM_GetCurrentContendedMonitor::doit() {
1557   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1558   ThreadsListHandle tlh;
1559   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1560       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1561     _result = ((JvmtiEnvBase *)_env)-&gt;get_current_contended_monitor(_calling_thread,_java_thread,_owned_monitor_ptr);
1562   }
1563 }
1564 
1565 void
1566 VM_GetStackTrace::doit() {
1567   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1568   ThreadsListHandle tlh;
1569   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1570       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1571     _result = ((JvmtiEnvBase *)_env)-&gt;get_stack_trace(_java_thread,
1572                                                       _start_depth, _max_count,
1573                                                       _frame_buffer, _count_ptr);
1574   }
1575 }
1576 
1577 void
1578 VM_GetFrameCount::doit() {
1579   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1580   JavaThread* jt = _state-&gt;get_thread();
1581   ThreadsListHandle tlh;
1582   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1583     _result = ((JvmtiEnvBase*)_env)-&gt;get_frame_count(_state, _count_ptr);
1584   }
1585 }
1586 
1587 void
1588 VM_GetFrameLocation::doit() {
1589   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1590   ThreadsListHandle tlh;
1591   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1592       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1593     _result = ((JvmtiEnvBase*)_env)-&gt;get_frame_location(_java_thread, _depth,
1594                                                         _method_ptr, _location_ptr);
1595   }
1596 }
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>