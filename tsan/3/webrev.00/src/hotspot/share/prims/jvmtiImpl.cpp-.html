<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/prims/jvmtiImpl.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/systemDictionary.hpp&quot;
  27 #include &quot;interpreter/interpreter.hpp&quot;
  28 #include &quot;interpreter/oopMapCache.hpp&quot;
  29 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  30 #include &quot;logging/log.hpp&quot;
  31 #include &quot;logging/logStream.hpp&quot;
  32 #include &quot;memory/allocation.inline.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;oops/instanceKlass.hpp&quot;
  35 #include &quot;oops/oop.inline.hpp&quot;
  36 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  37 #include &quot;prims/jvmtiEventController.inline.hpp&quot;
  38 #include &quot;prims/jvmtiImpl.hpp&quot;
  39 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  40 #include &quot;runtime/atomic.hpp&quot;
  41 #include &quot;runtime/deoptimization.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/handles.inline.hpp&quot;
  44 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  45 #include &quot;runtime/javaCalls.hpp&quot;
  46 #include &quot;runtime/os.hpp&quot;
  47 #include &quot;runtime/serviceThread.hpp&quot;
  48 #include &quot;runtime/signature.hpp&quot;
  49 #include &quot;runtime/thread.inline.hpp&quot;
  50 #include &quot;runtime/threadSMR.hpp&quot;
  51 #include &quot;runtime/vframe.hpp&quot;
  52 #include &quot;runtime/vframe_hp.hpp&quot;
  53 #include &quot;runtime/vmOperations.hpp&quot;
  54 #include &quot;utilities/exceptions.hpp&quot;
  55 
  56 //
  57 // class JvmtiAgentThread
  58 //
  59 // JavaThread used to wrap a thread started by an agent
  60 // using the JVMTI method RunAgentThread.
  61 //
  62 
  63 JvmtiAgentThread::JvmtiAgentThread(JvmtiEnv* env, jvmtiStartFunction start_fn, const void *start_arg)
  64     : JavaThread(start_function_wrapper) {
  65     _env = env;
  66     _start_fn = start_fn;
  67     _start_arg = start_arg;
  68 }
  69 
  70 void
  71 JvmtiAgentThread::start_function_wrapper(JavaThread *thread, TRAPS) {
  72     // It is expected that any Agent threads will be created as
  73     // Java Threads.  If this is the case, notification of the creation
  74     // of the thread is given in JavaThread::thread_main().
  75     assert(thread-&gt;is_Java_thread(), &quot;debugger thread should be a Java Thread&quot;);
  76     assert(thread == JavaThread::current(), &quot;sanity check&quot;);
  77 
  78     JvmtiAgentThread *dthread = (JvmtiAgentThread *)thread;
  79     dthread-&gt;call_start_function();
  80 }
  81 
  82 void
  83 JvmtiAgentThread::call_start_function() {
  84     ThreadToNativeFromVM transition(this);
  85     _start_fn(_env-&gt;jvmti_external(), jni_environment(), (void*)_start_arg);
  86 }
  87 
  88 
  89 //
  90 // class GrowableCache - private methods
  91 //
  92 
  93 void GrowableCache::recache() {
  94   int len = _elements-&gt;length();
  95 
  96   FREE_C_HEAP_ARRAY(address, _cache);
  97   _cache = NEW_C_HEAP_ARRAY(address,len+1, mtInternal);
  98 
  99   for (int i=0; i&lt;len; i++) {
 100     _cache[i] = _elements-&gt;at(i)-&gt;getCacheValue();
 101     //
 102     // The cache entry has gone bad. Without a valid frame pointer
 103     // value, the entry is useless so we simply delete it in product
 104     // mode. The call to remove() will rebuild the cache again
 105     // without the bad entry.
 106     //
 107     if (_cache[i] == NULL) {
 108       assert(false, &quot;cannot recache NULL elements&quot;);
 109       remove(i);
 110       return;
 111     }
 112   }
 113   _cache[len] = NULL;
 114 
 115   _listener_fun(_this_obj,_cache);
 116 }
 117 
 118 bool GrowableCache::equals(void* v, GrowableElement *e2) {
 119   GrowableElement *e1 = (GrowableElement *) v;
 120   assert(e1 != NULL, &quot;e1 != NULL&quot;);
 121   assert(e2 != NULL, &quot;e2 != NULL&quot;);
 122 
 123   return e1-&gt;equals(e2);
 124 }
 125 
 126 //
 127 // class GrowableCache - public methods
 128 //
 129 
 130 GrowableCache::GrowableCache() {
 131   _this_obj       = NULL;
 132   _listener_fun   = NULL;
 133   _elements       = NULL;
 134   _cache          = NULL;
 135 }
 136 
 137 GrowableCache::~GrowableCache() {
 138   clear();
 139   delete _elements;
 140   FREE_C_HEAP_ARRAY(address, _cache);
 141 }
 142 
 143 void GrowableCache::initialize(void *this_obj, void listener_fun(void *, address*) ) {
 144   _this_obj       = this_obj;
 145   _listener_fun   = listener_fun;
 146   _elements       = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;GrowableElement*&gt;(5,true);
 147   recache();
 148 }
 149 
 150 // number of elements in the collection
 151 int GrowableCache::length() {
 152   return _elements-&gt;length();
 153 }
 154 
 155 // get the value of the index element in the collection
 156 GrowableElement* GrowableCache::at(int index) {
 157   GrowableElement *e = (GrowableElement *) _elements-&gt;at(index);
 158   assert(e != NULL, &quot;e != NULL&quot;);
 159   return e;
 160 }
 161 
 162 int GrowableCache::find(GrowableElement* e) {
 163   return _elements-&gt;find(e, GrowableCache::equals);
 164 }
 165 
 166 // append a copy of the element to the end of the collection
 167 void GrowableCache::append(GrowableElement* e) {
 168   GrowableElement *new_e = e-&gt;clone();
 169   _elements-&gt;append(new_e);
 170   recache();
 171 }
 172 
 173 // insert a copy of the element using lessthan()
 174 void GrowableCache::insert(GrowableElement* e) {
 175   GrowableElement *new_e = e-&gt;clone();
 176   _elements-&gt;append(new_e);
 177 
 178   int n = length()-2;
 179   for (int i=n; i&gt;=0; i--) {
 180     GrowableElement *e1 = _elements-&gt;at(i);
 181     GrowableElement *e2 = _elements-&gt;at(i+1);
 182     if (e2-&gt;lessThan(e1)) {
 183       _elements-&gt;at_put(i+1, e1);
 184       _elements-&gt;at_put(i,   e2);
 185     }
 186   }
 187 
 188   recache();
 189 }
 190 
 191 // remove the element at index
 192 void GrowableCache::remove (int index) {
 193   GrowableElement *e = _elements-&gt;at(index);
 194   assert(e != NULL, &quot;e != NULL&quot;);
 195   _elements-&gt;remove(e);
 196   delete e;
 197   recache();
 198 }
 199 
 200 // clear out all elements, release all heap space and
 201 // let our listener know that things have changed.
 202 void GrowableCache::clear() {
 203   int len = _elements-&gt;length();
 204   for (int i=0; i&lt;len; i++) {
 205     delete _elements-&gt;at(i);
 206   }
 207   _elements-&gt;clear();
 208   recache();
 209 }
 210 
 211 void GrowableCache::oops_do(OopClosure* f) {
 212   int len = _elements-&gt;length();
 213   for (int i=0; i&lt;len; i++) {
 214     GrowableElement *e = _elements-&gt;at(i);
 215     e-&gt;oops_do(f);
 216   }
 217 }
 218 
 219 void GrowableCache::metadata_do(void f(Metadata*)) {
 220   int len = _elements-&gt;length();
 221   for (int i=0; i&lt;len; i++) {
 222     GrowableElement *e = _elements-&gt;at(i);
 223     e-&gt;metadata_do(f);
 224   }
 225 }
 226 
 227 void GrowableCache::gc_epilogue() {
 228   int len = _elements-&gt;length();
 229   for (int i=0; i&lt;len; i++) {
 230     _cache[i] = _elements-&gt;at(i)-&gt;getCacheValue();
 231   }
 232 }
 233 
 234 //
 235 // class JvmtiBreakpoint
 236 //
 237 
 238 JvmtiBreakpoint::JvmtiBreakpoint() {
 239   _method = NULL;
 240   _bci    = 0;
 241   _class_holder = NULL;
 242 }
 243 
 244 JvmtiBreakpoint::JvmtiBreakpoint(Method* m_method, jlocation location) {
 245   _method        = m_method;
 246   _class_holder  = _method-&gt;method_holder()-&gt;klass_holder();
 247 #ifdef CHECK_UNHANDLED_OOPS
 248   // _class_holder can&#39;t be wrapped in a Handle, because JvmtiBreakpoints are
 249   // sometimes allocated on the heap.
 250   //
 251   // The code handling JvmtiBreakpoints allocated on the stack can&#39;t be
 252   // interrupted by a GC until _class_holder is reachable by the GC via the
 253   // oops_do method.
 254   Thread::current()-&gt;allow_unhandled_oop(&amp;_class_holder);
 255 #endif // CHECK_UNHANDLED_OOPS
 256   assert(_method != NULL, &quot;_method != NULL&quot;);
 257   _bci           = (int) location;
 258   assert(_bci &gt;= 0, &quot;_bci &gt;= 0&quot;);
 259 }
 260 
 261 void JvmtiBreakpoint::copy(JvmtiBreakpoint&amp; bp) {
 262   _method   = bp._method;
 263   _bci      = bp._bci;
 264   _class_holder = bp._class_holder;
 265 }
 266 
 267 bool JvmtiBreakpoint::lessThan(JvmtiBreakpoint&amp; bp) {
 268   Unimplemented();
 269   return false;
 270 }
 271 
 272 bool JvmtiBreakpoint::equals(JvmtiBreakpoint&amp; bp) {
 273   return _method   == bp._method
 274     &amp;&amp;   _bci      == bp._bci;
 275 }
 276 
 277 bool JvmtiBreakpoint::is_valid() {
 278   // class loader can be NULL
 279   return _method != NULL &amp;&amp;
 280          _bci &gt;= 0;
 281 }
 282 
 283 address JvmtiBreakpoint::getBcp() const {
 284   return _method-&gt;bcp_from(_bci);
 285 }
 286 
 287 void JvmtiBreakpoint::each_method_version_do(method_action meth_act) {
 288   ((Method*)_method-&gt;*meth_act)(_bci);
 289 
 290   // add/remove breakpoint to/from versions of the method that are EMCP.
 291   Thread *thread = Thread::current();
 292   InstanceKlass* ik = _method-&gt;method_holder();
 293   Symbol* m_name = _method-&gt;name();
 294   Symbol* m_signature = _method-&gt;signature();
 295 
 296   // search previous versions if they exist
 297   for (InstanceKlass* pv_node = ik-&gt;previous_versions();
 298        pv_node != NULL;
 299        pv_node = pv_node-&gt;previous_versions()) {
 300     Array&lt;Method*&gt;* methods = pv_node-&gt;methods();
 301 
 302     for (int i = methods-&gt;length() - 1; i &gt;= 0; i--) {
 303       Method* method = methods-&gt;at(i);
 304       // Only set breakpoints in running EMCP methods.
 305       if (method-&gt;is_running_emcp() &amp;&amp;
 306           method-&gt;name() == m_name &amp;&amp;
 307           method-&gt;signature() == m_signature) {
 308         ResourceMark rm;
 309         log_debug(redefine, class, breakpoint)
 310           (&quot;%sing breakpoint in %s(%s)&quot;, meth_act == &amp;Method::set_breakpoint ? &quot;sett&quot; : &quot;clear&quot;,
 311            method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string());
 312         (method-&gt;*meth_act)(_bci);
 313         break;
 314       }
 315     }
 316   }
 317 }
 318 
 319 void JvmtiBreakpoint::set() {
 320   each_method_version_do(&amp;Method::set_breakpoint);
 321 }
 322 
 323 void JvmtiBreakpoint::clear() {
 324   each_method_version_do(&amp;Method::clear_breakpoint);
 325 }
 326 
 327 void JvmtiBreakpoint::print_on(outputStream* out) const {
 328 #ifndef PRODUCT
 329   ResourceMark rm;
 330   const char *class_name  = (_method == NULL) ? &quot;NULL&quot; : _method-&gt;klass_name()-&gt;as_C_string();
 331   const char *method_name = (_method == NULL) ? &quot;NULL&quot; : _method-&gt;name()-&gt;as_C_string();
 332   out-&gt;print(&quot;Breakpoint(%s,%s,%d,%p)&quot;, class_name, method_name, _bci, getBcp());
 333 #endif
 334 }
 335 
 336 
 337 //
 338 // class VM_ChangeBreakpoints
 339 //
 340 // Modify the Breakpoints data structure at a safepoint
 341 //
 342 
 343 void VM_ChangeBreakpoints::doit() {
 344   switch (_operation) {
 345   case SET_BREAKPOINT:
 346     _breakpoints-&gt;set_at_safepoint(*_bp);
 347     break;
 348   case CLEAR_BREAKPOINT:
 349     _breakpoints-&gt;clear_at_safepoint(*_bp);
 350     break;
 351   default:
 352     assert(false, &quot;Unknown operation&quot;);
 353   }
 354 }
 355 
 356 void VM_ChangeBreakpoints::oops_do(OopClosure* f) {
 357   // The JvmtiBreakpoints in _breakpoints will be visited via
 358   // JvmtiExport::oops_do.
 359   if (_bp != NULL) {
 360     _bp-&gt;oops_do(f);
 361   }
 362 }
 363 
 364 void VM_ChangeBreakpoints::metadata_do(void f(Metadata*)) {
 365   // Walk metadata in breakpoints to keep from being deallocated with RedefineClasses
 366   if (_bp != NULL) {
 367     _bp-&gt;metadata_do(f);
 368   }
 369 }
 370 
 371 //
 372 // class JvmtiBreakpoints
 373 //
 374 // a JVMTI internal collection of JvmtiBreakpoint
 375 //
 376 
 377 JvmtiBreakpoints::JvmtiBreakpoints(void listener_fun(void *,address *)) {
 378   _bps.initialize(this,listener_fun);
 379 }
 380 
 381 JvmtiBreakpoints:: ~JvmtiBreakpoints() {}
 382 
 383 void  JvmtiBreakpoints::oops_do(OopClosure* f) {
 384   _bps.oops_do(f);
 385 }
 386 
 387 void  JvmtiBreakpoints::metadata_do(void f(Metadata*)) {
 388   _bps.metadata_do(f);
 389 }
 390 
 391 void JvmtiBreakpoints::gc_epilogue() {
 392   _bps.gc_epilogue();
 393 }
 394 
 395 void JvmtiBreakpoints::print() {
 396 #ifndef PRODUCT
 397   LogTarget(Trace, jvmti) log;
 398   LogStream log_stream(log);
 399 
 400   int n = _bps.length();
 401   for (int i=0; i&lt;n; i++) {
 402     JvmtiBreakpoint&amp; bp = _bps.at(i);
 403     log_stream.print(&quot;%d: &quot;, i);
 404     bp.print_on(&amp;log_stream);
 405     log_stream.cr();
 406   }
 407 #endif
 408 }
 409 
 410 
 411 void JvmtiBreakpoints::set_at_safepoint(JvmtiBreakpoint&amp; bp) {
 412   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
 413 
 414   int i = _bps.find(bp);
 415   if (i == -1) {
 416     _bps.append(bp);
 417     bp.set();
 418   }
 419 }
 420 
 421 void JvmtiBreakpoints::clear_at_safepoint(JvmtiBreakpoint&amp; bp) {
 422   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
 423 
 424   int i = _bps.find(bp);
 425   if (i != -1) {
 426     _bps.remove(i);
 427     bp.clear();
 428   }
 429 }
 430 
 431 int JvmtiBreakpoints::length() { return _bps.length(); }
 432 
 433 int JvmtiBreakpoints::set(JvmtiBreakpoint&amp; bp) {
 434   if ( _bps.find(bp) != -1) {
 435      return JVMTI_ERROR_DUPLICATE;
 436   }
 437   VM_ChangeBreakpoints set_breakpoint(VM_ChangeBreakpoints::SET_BREAKPOINT, &amp;bp);
 438   VMThread::execute(&amp;set_breakpoint);
 439   return JVMTI_ERROR_NONE;
 440 }
 441 
 442 int JvmtiBreakpoints::clear(JvmtiBreakpoint&amp; bp) {
 443   if ( _bps.find(bp) == -1) {
 444      return JVMTI_ERROR_NOT_FOUND;
 445   }
 446 
 447   VM_ChangeBreakpoints clear_breakpoint(VM_ChangeBreakpoints::CLEAR_BREAKPOINT, &amp;bp);
 448   VMThread::execute(&amp;clear_breakpoint);
 449   return JVMTI_ERROR_NONE;
 450 }
 451 
 452 void JvmtiBreakpoints::clearall_in_class_at_safepoint(Klass* klass) {
 453   bool changed = true;
 454   // We are going to run thru the list of bkpts
 455   // and delete some.  This deletion probably alters
 456   // the list in some implementation defined way such
 457   // that when we delete entry i, the next entry might
 458   // no longer be at i+1.  To be safe, each time we delete
 459   // an entry, we&#39;ll just start again from the beginning.
 460   // We&#39;ll stop when we make a pass thru the whole list without
 461   // deleting anything.
 462   while (changed) {
 463     int len = _bps.length();
 464     changed = false;
 465     for (int i = 0; i &lt; len; i++) {
 466       JvmtiBreakpoint&amp; bp = _bps.at(i);
 467       if (bp.method()-&gt;method_holder() == klass) {
 468         bp.clear();
 469         _bps.remove(i);
 470         // This changed &#39;i&#39; so we have to start over.
 471         changed = true;
 472         break;
 473       }
 474     }
 475   }
 476 }
 477 
 478 //
 479 // class JvmtiCurrentBreakpoints
 480 //
 481 
 482 JvmtiBreakpoints *JvmtiCurrentBreakpoints::_jvmti_breakpoints  = NULL;
 483 address *         JvmtiCurrentBreakpoints::_breakpoint_list    = NULL;
 484 
 485 
 486 JvmtiBreakpoints&amp; JvmtiCurrentBreakpoints::get_jvmti_breakpoints() {
 487   if (_jvmti_breakpoints != NULL) return (*_jvmti_breakpoints);
 488   _jvmti_breakpoints = new JvmtiBreakpoints(listener_fun);
 489   assert(_jvmti_breakpoints != NULL, &quot;_jvmti_breakpoints != NULL&quot;);
 490   return (*_jvmti_breakpoints);
 491 }
 492 
 493 void  JvmtiCurrentBreakpoints::listener_fun(void *this_obj, address *cache) {
 494   JvmtiBreakpoints *this_jvmti = (JvmtiBreakpoints *) this_obj;
 495   assert(this_jvmti != NULL, &quot;this_jvmti != NULL&quot;);
 496 
 497   debug_only(int n = this_jvmti-&gt;length(););
 498   assert(cache[n] == NULL, &quot;cache must be NULL terminated&quot;);
 499 
 500   set_breakpoint_list(cache);
 501 }
 502 
 503 
 504 void JvmtiCurrentBreakpoints::oops_do(OopClosure* f) {
 505   if (_jvmti_breakpoints != NULL) {
 506     _jvmti_breakpoints-&gt;oops_do(f);
 507   }
 508 }
 509 
 510 void JvmtiCurrentBreakpoints::metadata_do(void f(Metadata*)) {
 511   if (_jvmti_breakpoints != NULL) {
 512     _jvmti_breakpoints-&gt;metadata_do(f);
 513   }
 514 }
 515 
 516 void JvmtiCurrentBreakpoints::gc_epilogue() {
 517   if (_jvmti_breakpoints != NULL) {
 518     _jvmti_breakpoints-&gt;gc_epilogue();
 519   }
 520 }
 521 
 522 ///////////////////////////////////////////////////////////////
 523 //
 524 // class VM_GetOrSetLocal
 525 //
 526 
 527 // Constructor for non-object getter
 528 VM_GetOrSetLocal::VM_GetOrSetLocal(JavaThread* thread, jint depth, jint index, BasicType type)
 529   : _thread(thread)
 530   , _calling_thread(NULL)
 531   , _depth(depth)
 532   , _index(index)
 533   , _type(type)
 534   , _jvf(NULL)
 535   , _set(false)
 536   , _result(JVMTI_ERROR_NONE)
 537 {
 538 }
 539 
 540 // Constructor for object or non-object setter
 541 VM_GetOrSetLocal::VM_GetOrSetLocal(JavaThread* thread, jint depth, jint index, BasicType type, jvalue value)
 542   : _thread(thread)
 543   , _calling_thread(NULL)
 544   , _depth(depth)
 545   , _index(index)
 546   , _type(type)
 547   , _value(value)
 548   , _jvf(NULL)
 549   , _set(true)
 550   , _result(JVMTI_ERROR_NONE)
 551 {
 552 }
 553 
 554 // Constructor for object getter
 555 VM_GetOrSetLocal::VM_GetOrSetLocal(JavaThread* thread, JavaThread* calling_thread, jint depth, int index)
 556   : _thread(thread)
 557   , _calling_thread(calling_thread)
 558   , _depth(depth)
 559   , _index(index)
 560   , _type(T_OBJECT)
 561   , _jvf(NULL)
 562   , _set(false)
 563   , _result(JVMTI_ERROR_NONE)
 564 {
 565 }
 566 
 567 vframe *VM_GetOrSetLocal::get_vframe() {
 568   if (!_thread-&gt;has_last_Java_frame()) {
 569     return NULL;
 570   }
 571   RegisterMap reg_map(_thread);
 572   vframe *vf = _thread-&gt;last_java_vframe(&amp;reg_map);
 573   int d = 0;
 574   while ((vf != NULL) &amp;&amp; (d &lt; _depth)) {
 575     vf = vf-&gt;java_sender();
 576     d++;
 577   }
 578   return vf;
 579 }
 580 
 581 javaVFrame *VM_GetOrSetLocal::get_java_vframe() {
 582   vframe* vf = get_vframe();
 583   if (vf == NULL) {
 584     _result = JVMTI_ERROR_NO_MORE_FRAMES;
 585     return NULL;
 586   }
 587   javaVFrame *jvf = (javaVFrame*)vf;
 588 
 589   if (!vf-&gt;is_java_frame()) {
 590     _result = JVMTI_ERROR_OPAQUE_FRAME;
 591     return NULL;
 592   }
 593   return jvf;
 594 }
 595 
 596 // Check that the klass is assignable to a type with the given signature.
 597 // Another solution could be to use the function Klass::is_subtype_of(type).
 598 // But the type class can be forced to load/initialize eagerly in such a case.
 599 // This may cause unexpected consequences like CFLH or class-init JVMTI events.
 600 // It is better to avoid such a behavior.
 601 bool VM_GetOrSetLocal::is_assignable(const char* ty_sign, Klass* klass, Thread* thread) {
 602   assert(ty_sign != NULL, &quot;type signature must not be NULL&quot;);
 603   assert(thread != NULL, &quot;thread must not be NULL&quot;);
 604   assert(klass != NULL, &quot;klass must not be NULL&quot;);
 605 
 606   int len = (int) strlen(ty_sign);
 607   if (ty_sign[0] == &#39;L&#39; &amp;&amp; ty_sign[len-1] == &#39;;&#39;) { // Need pure class/interface name
 608     ty_sign++;
 609     len -= 2;
 610   }
 611   TempNewSymbol ty_sym = SymbolTable::new_symbol(ty_sign, len, thread);
 612   if (klass-&gt;name() == ty_sym) {
 613     return true;
 614   }
 615   // Compare primary supers
 616   int super_depth = klass-&gt;super_depth();
 617   int idx;
 618   for (idx = 0; idx &lt; super_depth; idx++) {
 619     if (klass-&gt;primary_super_of_depth(idx)-&gt;name() == ty_sym) {
 620       return true;
 621     }
 622   }
 623   // Compare secondary supers
 624   const Array&lt;Klass*&gt;* sec_supers = klass-&gt;secondary_supers();
 625   for (idx = 0; idx &lt; sec_supers-&gt;length(); idx++) {
 626     if (((Klass*) sec_supers-&gt;at(idx))-&gt;name() == ty_sym) {
 627       return true;
 628     }
 629   }
 630   return false;
 631 }
 632 
 633 // Checks error conditions:
 634 //   JVMTI_ERROR_INVALID_SLOT
 635 //   JVMTI_ERROR_TYPE_MISMATCH
 636 // Returns: &#39;true&#39; - everything is Ok, &#39;false&#39; - error code
 637 
 638 bool VM_GetOrSetLocal::check_slot_type_lvt(javaVFrame* jvf) {
 639   Method* method_oop = jvf-&gt;method();
 640   jint num_entries = method_oop-&gt;localvariable_table_length();
 641   if (num_entries == 0) {
 642     _result = JVMTI_ERROR_INVALID_SLOT;
 643     return false;       // There are no slots
 644   }
 645   int signature_idx = -1;
 646   int vf_bci = jvf-&gt;bci();
 647   LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
 648   for (int i = 0; i &lt; num_entries; i++) {
 649     int start_bci = table[i].start_bci;
 650     int end_bci = start_bci + table[i].length;
 651 
 652     // Here we assume that locations of LVT entries
 653     // with the same slot number cannot be overlapped
 654     if (_index == (jint) table[i].slot &amp;&amp; start_bci &lt;= vf_bci &amp;&amp; vf_bci &lt;= end_bci) {
 655       signature_idx = (int) table[i].descriptor_cp_index;
 656       break;
 657     }
 658   }
 659   if (signature_idx == -1) {
 660     _result = JVMTI_ERROR_INVALID_SLOT;
 661     return false;       // Incorrect slot index
 662   }
 663   Symbol*   sign_sym  = method_oop-&gt;constants()-&gt;symbol_at(signature_idx);
 664   const char* signature = (const char *) sign_sym-&gt;as_utf8();
 665   BasicType slot_type = char2type(signature[0]);
 666 
 667   switch (slot_type) {
 668   case T_BYTE:
 669   case T_SHORT:
 670   case T_CHAR:
 671   case T_BOOLEAN:
 672     slot_type = T_INT;
 673     break;
 674   case T_ARRAY:
 675     slot_type = T_OBJECT;
 676     break;
 677   default:
 678     break;
 679   };
 680   if (_type != slot_type) {
 681     _result = JVMTI_ERROR_TYPE_MISMATCH;
 682     return false;
 683   }
 684 
 685   jobject jobj = _value.l;
 686   if (_set &amp;&amp; slot_type == T_OBJECT &amp;&amp; jobj != NULL) { // NULL reference is allowed
 687     // Check that the jobject class matches the return type signature.
 688     JavaThread* cur_thread = JavaThread::current();
 689     HandleMark hm(cur_thread);
 690 
 691     Handle obj(cur_thread, JNIHandles::resolve_external_guard(jobj));
 692     NULL_CHECK(obj, (_result = JVMTI_ERROR_INVALID_OBJECT, false));
 693     Klass* ob_k = obj-&gt;klass();
 694     NULL_CHECK(ob_k, (_result = JVMTI_ERROR_INVALID_OBJECT, false));
 695 
 696     if (!is_assignable(signature, ob_k, cur_thread)) {
 697       _result = JVMTI_ERROR_TYPE_MISMATCH;
 698       return false;
 699     }
 700   }
 701   return true;
 702 }
 703 
 704 bool VM_GetOrSetLocal::check_slot_type_no_lvt(javaVFrame* jvf) {
 705   Method* method_oop = jvf-&gt;method();
 706   jint extra_slot = (_type == T_LONG || _type == T_DOUBLE) ? 1 : 0;
 707 
 708   if (_index &lt; 0 || _index + extra_slot &gt;= method_oop-&gt;max_locals()) {
 709     _result = JVMTI_ERROR_INVALID_SLOT;
 710     return false;
 711   }
 712   StackValueCollection *locals = _jvf-&gt;locals();
 713   BasicType slot_type = locals-&gt;at(_index)-&gt;type();
 714 
 715   if (slot_type == T_CONFLICT) {
 716     _result = JVMTI_ERROR_INVALID_SLOT;
 717     return false;
 718   }
 719   if (extra_slot) {
 720     BasicType extra_slot_type = locals-&gt;at(_index + 1)-&gt;type();
 721     if (extra_slot_type != T_INT) {
 722       _result = JVMTI_ERROR_INVALID_SLOT;
 723       return false;
 724     }
 725   }
 726   if (_type != slot_type &amp;&amp; (_type == T_OBJECT || slot_type != T_INT)) {
 727     _result = JVMTI_ERROR_TYPE_MISMATCH;
 728     return false;
 729   }
 730   return true;
 731 }
 732 
 733 static bool can_be_deoptimized(vframe* vf) {
 734   return (vf-&gt;is_compiled_frame() &amp;&amp; vf-&gt;fr().can_be_deoptimized());
 735 }
 736 
 737 bool VM_GetOrSetLocal::doit_prologue() {
 738   _jvf = get_java_vframe();
 739   NULL_CHECK(_jvf, false);
 740 
 741   Method* method_oop = _jvf-&gt;method();
 742   if (method_oop-&gt;is_native()) {
 743     if (getting_receiver() &amp;&amp; !method_oop-&gt;is_static()) {
 744       return true;
 745     } else {
 746       _result = JVMTI_ERROR_OPAQUE_FRAME;
 747       return false;
 748     }
 749   }
 750 
 751   if (method_oop-&gt;has_localvariable_table()) {
 752     return check_slot_type_lvt(_jvf);
 753   } else {
 754     return check_slot_type_no_lvt(_jvf);
 755   }
 756   return true;
 757 }
 758 
 759 void VM_GetOrSetLocal::doit() {
 760   InterpreterOopMap oop_mask;
 761   _jvf-&gt;method()-&gt;mask_for(_jvf-&gt;bci(), &amp;oop_mask);
 762   if (oop_mask.is_dead(_index)) {
 763     // The local can be invalid and uninitialized in the scope of current bci
 764     _result = JVMTI_ERROR_INVALID_SLOT;
 765     return;
 766   }
 767   if (_set) {
 768     // Force deoptimization of frame if compiled because it&#39;s
 769     // possible the compiler emitted some locals as constant values,
 770     // meaning they are not mutable.
 771     if (can_be_deoptimized(_jvf)) {
 772 
 773       // Schedule deoptimization so that eventually the local
 774       // update will be written to an interpreter frame.
 775       Deoptimization::deoptimize_frame(_jvf-&gt;thread(), _jvf-&gt;fr().id());
 776 
 777       // Now store a new value for the local which will be applied
 778       // once deoptimization occurs. Note however that while this
 779       // write is deferred until deoptimization actually happens
 780       // can vframe created after this point will have its locals
 781       // reflecting this update so as far as anyone can see the
 782       // write has already taken place.
 783 
 784       // If we are updating an oop then get the oop from the handle
 785       // since the handle will be long gone by the time the deopt
 786       // happens. The oop stored in the deferred local will be
 787       // gc&#39;d on its own.
 788       if (_type == T_OBJECT) {
 789         _value.l = (jobject) (JNIHandles::resolve_external_guard(_value.l));
 790       }
 791       // Re-read the vframe so we can see that it is deoptimized
 792       // [ Only need because of assert in update_local() ]
 793       _jvf = get_java_vframe();
 794       ((compiledVFrame*)_jvf)-&gt;update_local(_type, _index, _value);
 795       return;
 796     }
 797     StackValueCollection *locals = _jvf-&gt;locals();
 798     HandleMark hm;
 799 
 800     switch (_type) {
 801       case T_INT:    locals-&gt;set_int_at   (_index, _value.i); break;
 802       case T_LONG:   locals-&gt;set_long_at  (_index, _value.j); break;
 803       case T_FLOAT:  locals-&gt;set_float_at (_index, _value.f); break;
 804       case T_DOUBLE: locals-&gt;set_double_at(_index, _value.d); break;
 805       case T_OBJECT: {
 806         Handle ob_h(Thread::current(), JNIHandles::resolve_external_guard(_value.l));
 807         locals-&gt;set_obj_at (_index, ob_h);
 808         break;
 809       }
 810       default: ShouldNotReachHere();
 811     }
 812     _jvf-&gt;set_locals(locals);
 813   } else {
 814     if (_jvf-&gt;method()-&gt;is_native() &amp;&amp; _jvf-&gt;is_compiled_frame()) {
 815       assert(getting_receiver(), &quot;Can only get here when getting receiver&quot;);
 816       oop receiver = _jvf-&gt;fr().get_native_receiver();
 817       _value.l = JNIHandles::make_local(_calling_thread, receiver);
 818     } else {
 819       StackValueCollection *locals = _jvf-&gt;locals();
 820 
 821       switch (_type) {
 822         case T_INT:    _value.i = locals-&gt;int_at   (_index);   break;
 823         case T_LONG:   _value.j = locals-&gt;long_at  (_index);   break;
 824         case T_FLOAT:  _value.f = locals-&gt;float_at (_index);   break;
 825         case T_DOUBLE: _value.d = locals-&gt;double_at(_index);   break;
 826         case T_OBJECT: {
 827           // Wrap the oop to be returned in a local JNI handle since
 828           // oops_do() no longer applies after doit() is finished.
 829           oop obj = locals-&gt;obj_at(_index)();
 830           _value.l = JNIHandles::make_local(_calling_thread, obj);
 831           break;
 832         }
 833         default: ShouldNotReachHere();
 834       }
 835     }
 836   }
 837 }
 838 
 839 
 840 bool VM_GetOrSetLocal::allow_nested_vm_operations() const {
 841   return true; // May need to deoptimize
 842 }
 843 
 844 
 845 VM_GetReceiver::VM_GetReceiver(
 846     JavaThread* thread, JavaThread* caller_thread, jint depth)
 847     : VM_GetOrSetLocal(thread, caller_thread, depth, 0) {}
 848 
 849 /////////////////////////////////////////////////////////////////////////////////////////
 850 
 851 //
 852 // class JvmtiSuspendControl - see comments in jvmtiImpl.hpp
 853 //
 854 
 855 bool JvmtiSuspendControl::suspend(JavaThread *java_thread) {
 856   // external suspend should have caught suspending a thread twice
 857 
 858   // Immediate suspension required for JPDA back-end so JVMTI agent threads do
 859   // not deadlock due to later suspension on transitions while holding
 860   // raw monitors.  Passing true causes the immediate suspension.
 861   // java_suspend() will catch threads in the process of exiting
 862   // and will ignore them.
 863   java_thread-&gt;java_suspend();
 864 
 865   // It would be nice to have the following assertion in all the time,
 866   // but it is possible for a racing resume request to have resumed
 867   // this thread right after we suspended it. Temporarily enable this
 868   // assertion if you are chasing a different kind of bug.
 869   //
 870   // assert(java_lang_Thread::thread(java_thread-&gt;threadObj()) == NULL ||
 871   //   java_thread-&gt;is_being_ext_suspended(), &quot;thread is not suspended&quot;);
 872 
 873   if (java_lang_Thread::thread(java_thread-&gt;threadObj()) == NULL) {
 874     // check again because we can get delayed in java_suspend():
 875     // the thread is in process of exiting.
 876     return false;
 877   }
 878 
 879   return true;
 880 }
 881 
 882 bool JvmtiSuspendControl::resume(JavaThread *java_thread) {
 883   // external suspend should have caught resuming a thread twice
 884   assert(java_thread-&gt;is_being_ext_suspended(), &quot;thread should be suspended&quot;);
 885 
 886   // resume thread
 887   {
 888     // must always grab Threads_lock, see JVM_SuspendThread
 889     MutexLocker ml(Threads_lock);
 890     java_thread-&gt;java_resume();
 891   }
 892 
 893   return true;
 894 }
 895 
 896 
 897 void JvmtiSuspendControl::print() {
 898 #ifndef PRODUCT
 899   LogStreamHandle(Trace, jvmti) log_stream;
 900   log_stream.print(&quot;Suspended Threads: [&quot;);
 901   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *thread = jtiwh.next(); ) {
 902 #ifdef JVMTI_TRACE
 903     const char *name   = JvmtiTrace::safe_get_thread_name(thread);
 904 #else
 905     const char *name   = &quot;&quot;;
 906 #endif /*JVMTI_TRACE */
 907     log_stream.print(&quot;%s(%c &quot;, name, thread-&gt;is_being_ext_suspended() ? &#39;S&#39; : &#39;_&#39;);
 908     if (!thread-&gt;has_last_Java_frame()) {
 909       log_stream.print(&quot;no stack&quot;);
 910     }
 911     log_stream.print(&quot;) &quot;);
 912   }
 913   log_stream.print_cr(&quot;]&quot;);
 914 #endif
 915 }
 916 
 917 JvmtiDeferredEvent JvmtiDeferredEvent::compiled_method_load_event(
 918     nmethod* nm) {
 919   JvmtiDeferredEvent event = JvmtiDeferredEvent(TYPE_COMPILED_METHOD_LOAD);
 920   event._event_data.compiled_method_load = nm;
 921   // Keep the nmethod alive until the ServiceThread can process
 922   // this deferred event.
 923   nmethodLocker::lock_nmethod(nm);
 924   return event;
 925 }
 926 
 927 JvmtiDeferredEvent JvmtiDeferredEvent::compiled_method_unload_event(
 928     nmethod* nm, jmethodID id, const void* code) {
 929   JvmtiDeferredEvent event = JvmtiDeferredEvent(TYPE_COMPILED_METHOD_UNLOAD);
 930   event._event_data.compiled_method_unload.nm = nm;
 931   event._event_data.compiled_method_unload.method_id = id;
 932   event._event_data.compiled_method_unload.code_begin = code;
 933   // Keep the nmethod alive until the ServiceThread can process
 934   // this deferred event. This will keep the memory for the
 935   // generated code from being reused too early. We pass
 936   // zombie_ok == true here so that our nmethod that was just
 937   // made into a zombie can be locked.
 938   nmethodLocker::lock_nmethod(nm, true /* zombie_ok */);
 939   return event;
 940 }
 941 
 942 JvmtiDeferredEvent JvmtiDeferredEvent::dynamic_code_generated_event(
 943       const char* name, const void* code_begin, const void* code_end) {
 944   JvmtiDeferredEvent event = JvmtiDeferredEvent(TYPE_DYNAMIC_CODE_GENERATED);
 945   // Need to make a copy of the name since we don&#39;t know how long
 946   // the event poster will keep it around after we enqueue the
 947   // deferred event and return. strdup() failure is handled in
 948   // the post() routine below.
 949   event._event_data.dynamic_code_generated.name = os::strdup(name);
 950   event._event_data.dynamic_code_generated.code_begin = code_begin;
 951   event._event_data.dynamic_code_generated.code_end = code_end;
 952   return event;
 953 }
 954 
 955 void JvmtiDeferredEvent::post() {
 956   assert(ServiceThread::is_service_thread(Thread::current()),
 957          &quot;Service thread must post enqueued events&quot;);
 958   switch(_type) {
 959     case TYPE_COMPILED_METHOD_LOAD: {
 960       nmethod* nm = _event_data.compiled_method_load;
 961       JvmtiExport::post_compiled_method_load(nm);
 962       // done with the deferred event so unlock the nmethod
 963       nmethodLocker::unlock_nmethod(nm);
 964       break;
 965     }
 966     case TYPE_COMPILED_METHOD_UNLOAD: {
 967       nmethod* nm = _event_data.compiled_method_unload.nm;
 968       JvmtiExport::post_compiled_method_unload(
 969         _event_data.compiled_method_unload.method_id,
 970         _event_data.compiled_method_unload.code_begin);
 971       // done with the deferred event so unlock the nmethod
 972       nmethodLocker::unlock_nmethod(nm);
 973       break;
 974     }
 975     case TYPE_DYNAMIC_CODE_GENERATED: {
 976       JvmtiExport::post_dynamic_code_generated_internal(
 977         // if strdup failed give the event a default name
 978         (_event_data.dynamic_code_generated.name == NULL)
 979           ? &quot;unknown_code&quot; : _event_data.dynamic_code_generated.name,
 980         _event_data.dynamic_code_generated.code_begin,
 981         _event_data.dynamic_code_generated.code_end);
 982       if (_event_data.dynamic_code_generated.name != NULL) {
 983         // release our copy
 984         os::free((void *)_event_data.dynamic_code_generated.name);
 985       }
 986       break;
 987     }
 988     default:
 989       ShouldNotReachHere();
 990   }
 991 }
 992 
 993 JvmtiDeferredEventQueue::QueueNode* JvmtiDeferredEventQueue::_queue_tail = NULL;
 994 JvmtiDeferredEventQueue::QueueNode* JvmtiDeferredEventQueue::_queue_head = NULL;
 995 
 996 bool JvmtiDeferredEventQueue::has_events() {
 997   assert(Service_lock-&gt;owned_by_self(), &quot;Must own Service_lock&quot;);
 998   return _queue_head != NULL;
 999 }
1000 
1001 void JvmtiDeferredEventQueue::enqueue(const JvmtiDeferredEvent&amp; event) {
1002   assert(Service_lock-&gt;owned_by_self(), &quot;Must own Service_lock&quot;);
1003 
1004   // Events get added to the end of the queue (and are pulled off the front).
1005   QueueNode* node = new QueueNode(event);
1006   if (_queue_tail == NULL) {
1007     _queue_tail = _queue_head = node;
1008   } else {
1009     assert(_queue_tail-&gt;next() == NULL, &quot;Must be the last element in the list&quot;);
1010     _queue_tail-&gt;set_next(node);
1011     _queue_tail = node;
1012   }
1013 
1014   Service_lock-&gt;notify_all();
1015   assert((_queue_head == NULL) == (_queue_tail == NULL),
1016          &quot;Inconsistent queue markers&quot;);
1017 }
1018 
1019 JvmtiDeferredEvent JvmtiDeferredEventQueue::dequeue() {
1020   assert(Service_lock-&gt;owned_by_self(), &quot;Must own Service_lock&quot;);
1021 
1022   assert(_queue_head != NULL, &quot;Nothing to dequeue&quot;);
1023 
1024   if (_queue_head == NULL) {
1025     // Just in case this happens in product; it shouldn&#39;t but let&#39;s not crash
1026     return JvmtiDeferredEvent();
1027   }
1028 
1029   QueueNode* node = _queue_head;
1030   _queue_head = _queue_head-&gt;next();
1031   if (_queue_head == NULL) {
1032     _queue_tail = NULL;
1033   }
1034 
1035   assert((_queue_head == NULL) == (_queue_tail == NULL),
1036          &quot;Inconsistent queue markers&quot;);
1037 
1038   JvmtiDeferredEvent event = node-&gt;event();
1039   delete node;
1040   return event;
1041 }
    </pre>
  </body>
</html>