<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jniCheck.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jni.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jniCheck.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jni.h&quot;
  27 #include &quot;jvm.h&quot;
  28 #include &quot;classfile/javaClasses.inline.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;


  31 #include &quot;memory/allocation.inline.hpp&quot;
  32 #include &quot;memory/guardedMemory.hpp&quot;
  33 #include &quot;oops/instanceKlass.hpp&quot;
  34 #include &quot;oops/oop.inline.hpp&quot;
  35 #include &quot;oops/symbol.hpp&quot;
  36 #include &quot;prims/jniCheck.hpp&quot;
  37 #include &quot;prims/jvm_misc.hpp&quot;
  38 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  41 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  42 #include &quot;runtime/jniHandles.inline.hpp&quot;
  43 #include &quot;runtime/thread.inline.hpp&quot;
  44 
  45 // Complain every extra number of unplanned local refs
  46 #define CHECK_JNI_LOCAL_REF_CAP_WARN_THRESHOLD 32
  47 
  48 // Heap objects are allowed to be directly referenced only in VM code,
  49 // not in native code.
  50 
</pre>
<hr />
<pre>
 249     add_planned_handle_capacity(handles, 0);
 250   }
 251 }
 252 
 253 static inline void
 254 checkStaticFieldID(JavaThread* thr, jfieldID fid, jclass cls, int ftype)
 255 {
 256   fieldDescriptor fd;
 257 
 258   /* make sure it is a static field */
 259   if (!jfieldIDWorkaround::is_static_jfieldID(fid))
 260     ReportJNIFatalError(thr, fatal_should_be_static);
 261 
 262   /* validate the class being passed */
 263   ASSERT_OOPS_ALLOWED;
 264   Klass* k_oop = jniCheck::validate_class(thr, cls, false);
 265 
 266   /* check for proper subclass hierarchy */
 267   JNIid* id = jfieldIDWorkaround::from_static_jfieldID(fid);
 268   Klass* f_oop = id-&gt;holder();
<span class="line-modified"> 269   if (!InstanceKlass::cast(k_oop)-&gt;is_subtype_of(f_oop))</span>
 270     ReportJNIFatalError(thr, fatal_wrong_static_field);
 271 
 272   /* check for proper field type */
 273   if (!id-&gt;find_local_field(&amp;fd))
 274     ReportJNIFatalError(thr, fatal_static_field_not_found);
 275   if ((fd.field_type() != ftype) &amp;&amp;
 276       !(fd.field_type() == T_ARRAY &amp;&amp; ftype == T_OBJECT)) {
 277     ReportJNIFatalError(thr, fatal_static_field_mismatch);
 278   }
 279 }
 280 
 281 static inline void
 282 checkInstanceFieldID(JavaThread* thr, jfieldID fid, jobject obj, int ftype)
 283 {
 284   fieldDescriptor fd;
 285 
 286   /* make sure it is an instance field */
 287   if (jfieldIDWorkaround::is_static_jfieldID(fid))
 288     ReportJNIFatalError(thr, fatal_should_be_nonstatic);
 289 
</pre>
<hr />
<pre>
 431     NativeReportJNIFatalError(thr, &quot;Unrecognized array release mode&quot;);
 432   }
 433   // We always need to release the copy we made with GuardedMemory
 434   GuardedMemory::free_copy(carray);
 435   return orig_result;
 436 }
 437 
 438 oop jniCheck::validate_handle(JavaThread* thr, jobject obj) {
 439   if ((obj != NULL) &amp;&amp; (JNIHandles::handle_type(thr, obj) != JNIInvalidRefType)) {
 440     ASSERT_OOPS_ALLOWED;
 441     return JNIHandles::resolve_external_guard(obj);
 442   }
 443   ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 444   return NULL;
 445 }
 446 
 447 
 448 Method* jniCheck::validate_jmethod_id(JavaThread* thr, jmethodID method_id) {
 449   ASSERT_OOPS_ALLOWED;
 450   // do the fast jmethodID check first
<span class="line-modified"> 451   Method* moop = Method::checked_resolve_jmethod_id(method_id);</span>
<span class="line-modified"> 452   if (moop == NULL) {</span>
 453     ReportJNIFatalError(thr, fatal_wrong_class_or_method);
 454   }
<span class="line-modified"> 455   // jmethodIDs are supposed to be weak handles in the class loader data,</span>
 456   // but that can be expensive so check it last
 457   else if (!Method::is_method_id(method_id)) {
 458     ReportJNIFatalError(thr, fatal_non_weak_method);
 459   }
<span class="line-modified"> 460   return moop;</span>
 461 }
 462 
 463 
 464 oop jniCheck::validate_object(JavaThread* thr, jobject obj) {
 465   if (obj == NULL) return NULL;
 466   ASSERT_OOPS_ALLOWED;
 467   oop oopObj = jniCheck::validate_handle(thr, obj);
 468   if (oopObj == NULL) {
 469     ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 470   }
 471   return oopObj;
 472 }
 473 
 474 // Warn if a class descriptor is in decorated form; class descriptors
 475 // passed to JNI findClass should not be decorated unless they are
 476 // array descriptors.
 477 void jniCheck::validate_class_descriptor(JavaThread* thr, const char* name) {
 478   if (name == NULL) return;  // implementation accepts NULL so just return
 479 
 480   size_t len = strlen(name);
</pre>
<hr />
<pre>
 496     ReportJNIFatalError(thr, fatal_received_null_class);
 497   }
 498 
 499   if (mirror-&gt;klass() != SystemDictionary::Class_klass()) {
 500     ReportJNIFatalError(thr, fatal_class_not_a_class);
 501   }
 502 
 503   Klass* k = java_lang_Class::as_Klass(mirror);
 504   // Make allowances for primitive classes ...
 505   if (!(k != NULL || (allow_primitive &amp;&amp; java_lang_Class::is_primitive(mirror)))) {
 506     ReportJNIFatalError(thr, fatal_class_not_a_class);
 507   }
 508   return k;
 509 }
 510 
 511 void jniCheck::validate_throwable_klass(JavaThread* thr, Klass* klass) {
 512   ASSERT_OOPS_ALLOWED;
 513   assert(klass != NULL, &quot;klass argument must have a value&quot;);
 514 
 515   if (!klass-&gt;is_instance_klass() ||
<span class="line-modified"> 516       !InstanceKlass::cast(klass)-&gt;is_subclass_of(SystemDictionary::Throwable_klass())) {</span>
 517     ReportJNIFatalError(thr, fatal_class_not_a_throwable_class);
 518   }
 519 }
 520 
<span class="line-modified"> 521 void jniCheck::validate_call_object(JavaThread* thr, jobject obj, jmethodID method_id) {</span>
<span class="line-removed"> 522   /* validate the object being passed */</span>
 523   ASSERT_OOPS_ALLOWED;
<span class="line-modified"> 524   jniCheck::validate_jmethod_id(thr, method_id);</span>
<span class="line-modified"> 525   jniCheck::validate_object(thr, obj);</span>
<span class="line-modified"> 526 }</span>







 527 
<span class="line-modified"> 528 void jniCheck::validate_call_class(JavaThread* thr, jclass clazz, jmethodID method_id) {</span>
<span class="line-modified"> 529   /* validate the class being passed */</span>
<span class="line-modified"> 530   ASSERT_OOPS_ALLOWED;</span>
<span class="line-modified"> 531   jniCheck::validate_jmethod_id(thr, method_id);</span>
<span class="line-modified"> 532   jniCheck::validate_class(thr, clazz, false);</span>





 533 }
 534 
 535 
 536 /*
 537  * IMPLEMENTATION OF FUNCTIONS IN CHECKED TABLE
 538  */
 539 
 540 JNI_ENTRY_CHECKED(jclass,
 541   checked_jni_DefineClass(JNIEnv *env,
 542                           const char *name,
 543                           jobject loader,
 544                           const jbyte *buf,
 545                           jsize len))
 546     functionEnter(thr);
 547     IN_VM(
 548       jniCheck::validate_object(thr, loader);
 549     )
 550     jclass result = UNCHECKED()-&gt;DefineClass(env, name, loader, buf, len);
 551     functionExit(thr);
 552     return result;
</pre>
<hr />
<pre>
 578 
 579 JNI_ENTRY_CHECKED(jfieldID,
 580   checked_jni_FromReflectedField(JNIEnv *env,
 581                                  jobject field))
 582     functionEnter(thr);
 583     IN_VM(
 584       jniCheck::validate_object(thr, field);
 585     )
 586     jfieldID result = UNCHECKED()-&gt;FromReflectedField(env, field);
 587     functionExit(thr);
 588     return result;
 589 JNI_END
 590 
 591 JNI_ENTRY_CHECKED(jobject,
 592   checked_jni_ToReflectedMethod(JNIEnv *env,
 593                                 jclass cls,
 594                                 jmethodID methodID,
 595                                 jboolean isStatic))
 596     functionEnter(thr);
 597     IN_VM(
<span class="line-modified"> 598       jniCheck::validate_class(thr, cls, false);</span>
<span class="line-removed"> 599       jniCheck::validate_jmethod_id(thr, methodID);</span>
 600     )
 601     jobject result = UNCHECKED()-&gt;ToReflectedMethod(env, cls, methodID,
 602                                                     isStatic);
 603     functionExit(thr);
 604     return result;
 605 JNI_END
 606 
 607 JNI_ENTRY_CHECKED(jclass,
 608   checked_jni_GetSuperclass(JNIEnv *env,
 609                             jclass sub))
 610     functionEnter(thr);
 611     IN_VM(
 612       jniCheck::validate_class(thr, sub, true);
 613     )
 614     jclass result = UNCHECKED()-&gt;GetSuperclass(env, sub);
 615     functionExit(thr);
 616     return result;
 617 JNI_END
 618 
 619 JNI_ENTRY_CHECKED(jboolean,
</pre>
<hr />
<pre>
 835 JNI_ENTRY_CHECKED(jobject,
 836   checked_jni_AllocObject(JNIEnv *env,
 837                           jclass clazz))
 838     functionEnter(thr);
 839     IN_VM(
 840       jniCheck::validate_class(thr, clazz, false);
 841     )
 842     jobject result = UNCHECKED()-&gt;AllocObject(env,clazz);
 843     functionExit(thr);
 844     return result;
 845 JNI_END
 846 
 847 JNI_ENTRY_CHECKED(jobject,
 848   checked_jni_NewObject(JNIEnv *env,
 849                         jclass clazz,
 850                         jmethodID methodID,
 851                         ...))
 852     functionEnter(thr);
 853     va_list args;
 854     IN_VM(
<span class="line-modified"> 855       jniCheck::validate_class(thr, clazz, false);</span>
<span class="line-removed"> 856       jniCheck::validate_jmethod_id(thr, methodID);</span>
 857     )
 858     va_start(args, methodID);
 859     jobject result = UNCHECKED()-&gt;NewObjectV(env,clazz,methodID,args);
 860     va_end(args);
 861     functionExit(thr);
 862     return result;
 863 JNI_END
 864 
 865 JNI_ENTRY_CHECKED(jobject,
 866   checked_jni_NewObjectV(JNIEnv *env,
 867                          jclass clazz,
 868                          jmethodID methodID,
 869                          va_list args))
 870     functionEnter(thr);
 871     IN_VM(
<span class="line-modified"> 872       jniCheck::validate_class(thr, clazz, false);</span>
<span class="line-removed"> 873       jniCheck::validate_jmethod_id(thr, methodID);</span>
 874     )
 875     jobject result = UNCHECKED()-&gt;NewObjectV(env,clazz,methodID,args);
 876     functionExit(thr);
 877     return result;
 878 JNI_END
 879 
 880 JNI_ENTRY_CHECKED(jobject,
 881   checked_jni_NewObjectA(JNIEnv *env,
 882                          jclass clazz,
 883                          jmethodID methodID,
 884                          const jvalue *args))
 885     functionEnter(thr);
 886     IN_VM(
<span class="line-modified"> 887       jniCheck::validate_class(thr, clazz, false);</span>
<span class="line-removed"> 888       jniCheck::validate_jmethod_id(thr, methodID);</span>
 889     )
 890     jobject result = UNCHECKED()-&gt;NewObjectA(env,clazz,methodID,args);
 891     functionExit(thr);
 892     return result;
 893 JNI_END
 894 
 895 JNI_ENTRY_CHECKED(jclass,
 896   checked_jni_GetObjectClass(JNIEnv *env,
 897                              jobject obj))
 898     functionEnter(thr);
 899     IN_VM(
 900       jniCheck::validate_object(thr, obj);
 901     )
 902     jclass result = UNCHECKED()-&gt;GetObjectClass(env,obj);
 903     functionExit(thr);
 904     return result;
 905 JNI_END
 906 
 907 JNI_ENTRY_CHECKED(jboolean,
 908   checked_jni_IsInstanceOf(JNIEnv *env,
</pre>
<hr />
<pre>
 924                           const char *name,
 925                           const char *sig))
 926     functionEnter(thr);
 927     IN_VM(
 928       jniCheck::validate_class(thr, clazz, false);
 929     )
 930     jmethodID result = UNCHECKED()-&gt;GetMethodID(env,clazz,name,sig);
 931     functionExit(thr);
 932     return result;
 933 JNI_END
 934 
 935 #define WRAPPER_CallMethod(ResultType, Result) \
 936 JNI_ENTRY_CHECKED(ResultType,  \
 937   checked_jni_Call##Result##Method(JNIEnv *env, \
 938                                    jobject obj, \
 939                                    jmethodID methodID, \
 940                                    ...)) \
 941     functionEnter(thr); \
 942     va_list args; \
 943     IN_VM( \
<span class="line-modified"> 944       jniCheck::validate_call_object(thr, obj, methodID); \</span>
 945     ) \
 946     va_start(args,methodID); \
 947     ResultType result =UNCHECKED()-&gt;Call##Result##MethodV(env, obj, methodID, \
 948                                                           args); \
 949     va_end(args); \
 950     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;Method&quot;); \
 951     functionExit(thr); \
 952     return result; \
 953 JNI_END \
 954 \
 955 JNI_ENTRY_CHECKED(ResultType,  \
 956   checked_jni_Call##Result##MethodV(JNIEnv *env, \
 957                                     jobject obj, \
 958                                     jmethodID methodID, \
 959                                     va_list args)) \
 960     functionEnter(thr); \
 961     IN_VM(\
<span class="line-modified"> 962       jniCheck::validate_call_object(thr, obj, methodID); \</span>
 963     ) \
 964     ResultType result = UNCHECKED()-&gt;Call##Result##MethodV(env, obj, methodID,\
 965                                                            args); \
 966     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;MethodV&quot;); \
 967     functionExit(thr); \
 968     return result; \
 969 JNI_END \
 970 \
 971 JNI_ENTRY_CHECKED(ResultType,  \
 972   checked_jni_Call##Result##MethodA(JNIEnv *env, \
 973                                     jobject obj, \
 974                                     jmethodID methodID, \
 975                                     const jvalue * args)) \
 976     functionEnter(thr); \
 977     IN_VM( \
<span class="line-modified"> 978       jniCheck::validate_call_object(thr, obj, methodID); \</span>
 979     ) \
 980     ResultType result = UNCHECKED()-&gt;Call##Result##MethodA(env, obj, methodID,\
 981                                                            args); \
 982     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;MethodA&quot;); \
 983     functionExit(thr); \
 984     return result; \
 985 JNI_END
 986 
 987 WRAPPER_CallMethod(jobject,Object)
 988 WRAPPER_CallMethod(jboolean,Boolean)
 989 WRAPPER_CallMethod(jbyte,Byte)
 990 WRAPPER_CallMethod(jshort,Short)
 991 WRAPPER_CallMethod(jchar,Char)
 992 WRAPPER_CallMethod(jint,Int)
 993 WRAPPER_CallMethod(jlong,Long)
 994 WRAPPER_CallMethod(jfloat,Float)
 995 WRAPPER_CallMethod(jdouble,Double)
 996 
 997 JNI_ENTRY_CHECKED(void,
 998   checked_jni_CallVoidMethod(JNIEnv *env, \
 999                              jobject obj, \
1000                              jmethodID methodID, \
1001                              ...))
1002     functionEnter(thr);
1003     va_list args;
1004     IN_VM(
<span class="line-modified">1005       jniCheck::validate_call_object(thr, obj, methodID);</span>
1006     )
1007     va_start(args,methodID);
1008     UNCHECKED()-&gt;CallVoidMethodV(env,obj,methodID,args);
1009     va_end(args);
1010     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethod&quot;);
1011     functionExit(thr);
1012 JNI_END
1013 
1014 JNI_ENTRY_CHECKED(void,
1015   checked_jni_CallVoidMethodV(JNIEnv *env,
1016                               jobject obj,
1017                               jmethodID methodID,
1018                               va_list args))
1019     functionEnter(thr);
1020     IN_VM(
<span class="line-modified">1021       jniCheck::validate_call_object(thr, obj, methodID);</span>
1022     )
1023     UNCHECKED()-&gt;CallVoidMethodV(env,obj,methodID,args);
1024     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethodV&quot;);
1025     functionExit(thr);
1026 JNI_END
1027 
1028 JNI_ENTRY_CHECKED(void,
1029   checked_jni_CallVoidMethodA(JNIEnv *env,
1030                               jobject obj,
1031                               jmethodID methodID,
1032                               const jvalue * args))
1033     functionEnter(thr);
1034     IN_VM(
<span class="line-modified">1035       jniCheck::validate_call_object(thr, obj, methodID);</span>
1036     )
1037     UNCHECKED()-&gt;CallVoidMethodA(env,obj,methodID,args);
1038     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethodA&quot;);
1039     functionExit(thr);
1040 JNI_END
1041 
1042 #define WRAPPER_CallNonvirtualMethod(ResultType, Result) \
1043 JNI_ENTRY_CHECKED(ResultType,  \
1044   checked_jni_CallNonvirtual##Result##Method(JNIEnv *env, \
1045                                              jobject obj, \
1046                                              jclass clazz, \
1047                                              jmethodID methodID, \
1048                                              ...)) \
1049     functionEnter(thr); \
1050     va_list args; \
1051     IN_VM( \
<span class="line-modified">1052       jniCheck::validate_call_object(thr, obj, methodID); \</span>
<span class="line-removed">1053       jniCheck::validate_call_class(thr, clazz, methodID); \</span>
1054     ) \
1055     va_start(args,methodID); \
1056     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodV(env, \
1057                                                                      obj, \
1058                                                                      clazz, \
1059                                                                      methodID,\
1060                                                                      args); \
1061     va_end(args); \
1062     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;Method&quot;); \
1063     functionExit(thr); \
1064     return result; \
1065 JNI_END \
1066 \
1067 JNI_ENTRY_CHECKED(ResultType,  \
1068   checked_jni_CallNonvirtual##Result##MethodV(JNIEnv *env, \
1069                                               jobject obj, \
1070                                               jclass clazz, \
1071                                               jmethodID methodID, \
1072                                               va_list args)) \
1073     functionEnter(thr); \
1074     IN_VM( \
<span class="line-modified">1075       jniCheck::validate_call_object(thr, obj, methodID); \</span>
<span class="line-removed">1076       jniCheck::validate_call_class(thr, clazz, methodID); \</span>
1077     ) \
1078     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodV(env, \
1079                                                                      obj, \
1080                                                                      clazz, \
1081                                                                      methodID,\
1082                                                                      args); \
1083     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;MethodV&quot;); \
1084     functionExit(thr); \
1085     return result; \
1086 JNI_END \
1087 \
1088 JNI_ENTRY_CHECKED(ResultType,  \
1089   checked_jni_CallNonvirtual##Result##MethodA(JNIEnv *env, \
1090                                               jobject obj, \
1091                                               jclass clazz, \
1092                                               jmethodID methodID, \
1093                                               const jvalue * args)) \
1094     functionEnter(thr); \
1095     IN_VM( \
<span class="line-modified">1096       jniCheck::validate_call_object(thr, obj, methodID); \</span>
<span class="line-removed">1097       jniCheck::validate_call_class(thr, clazz, methodID); \</span>
1098     ) \
1099     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodA(env, \
1100                                                                      obj, \
1101                                                                      clazz, \
1102                                                                      methodID,\
1103                                                                      args); \
1104     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;MethodA&quot;); \
1105     functionExit(thr); \
1106     return result; \
1107 JNI_END
1108 
1109 WRAPPER_CallNonvirtualMethod(jobject,Object)
1110 WRAPPER_CallNonvirtualMethod(jboolean,Boolean)
1111 WRAPPER_CallNonvirtualMethod(jbyte,Byte)
1112 WRAPPER_CallNonvirtualMethod(jshort,Short)
1113 WRAPPER_CallNonvirtualMethod(jchar,Char)
1114 WRAPPER_CallNonvirtualMethod(jint,Int)
1115 WRAPPER_CallNonvirtualMethod(jlong,Long)
1116 WRAPPER_CallNonvirtualMethod(jfloat,Float)
1117 WRAPPER_CallNonvirtualMethod(jdouble,Double)
1118 
1119 JNI_ENTRY_CHECKED(void,
1120   checked_jni_CallNonvirtualVoidMethod(JNIEnv *env,
1121                                        jobject obj,
1122                                        jclass clazz,
1123                                        jmethodID methodID,
1124                                        ...))
1125     functionEnter(thr);
1126     va_list args;
1127     IN_VM(
<span class="line-modified">1128       jniCheck::validate_call_object(thr, obj, methodID);</span>
<span class="line-removed">1129       jniCheck::validate_call_class(thr, clazz, methodID);</span>
1130     )
1131     va_start(args,methodID);
1132     UNCHECKED()-&gt;CallNonvirtualVoidMethodV(env,obj,clazz,methodID,args);
1133     va_end(args);
1134     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethod&quot;);
1135     functionExit(thr);
1136 JNI_END
1137 
1138 JNI_ENTRY_CHECKED(void,
1139   checked_jni_CallNonvirtualVoidMethodV(JNIEnv *env,
1140                                         jobject obj,
1141                                         jclass clazz,
1142                                         jmethodID methodID,
1143                                         va_list args))
1144     functionEnter(thr);
1145     IN_VM(
<span class="line-modified">1146       jniCheck::validate_call_object(thr, obj, methodID);</span>
<span class="line-removed">1147       jniCheck::validate_call_class(thr, clazz, methodID);</span>
1148     )
1149     UNCHECKED()-&gt;CallNonvirtualVoidMethodV(env,obj,clazz,methodID,args);
1150     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethodV&quot;);
1151     functionExit(thr);
1152 JNI_END
1153 
1154 JNI_ENTRY_CHECKED(void,
1155   checked_jni_CallNonvirtualVoidMethodA(JNIEnv *env,
1156                                         jobject obj,
1157                                         jclass clazz,
1158                                         jmethodID methodID,
1159                                         const jvalue * args))
1160     functionEnter(thr);
1161     IN_VM(
<span class="line-modified">1162       jniCheck::validate_call_object(thr, obj, methodID);</span>
<span class="line-removed">1163       jniCheck::validate_call_class(thr, clazz, methodID);</span>
1164     )
1165     UNCHECKED()-&gt;CallNonvirtualVoidMethodA(env,obj,clazz,methodID,args);
1166     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethodA&quot;);
1167     functionExit(thr);
1168 JNI_END
1169 
1170 JNI_ENTRY_CHECKED(jfieldID,
1171   checked_jni_GetFieldID(JNIEnv *env,
1172                          jclass clazz,
1173                          const char *name,
1174                          const char *sig))
1175     functionEnter(thr);
1176     IN_VM(
1177       jniCheck::validate_class(thr, clazz, false);
1178     )
1179     jfieldID result = UNCHECKED()-&gt;GetFieldID(env,clazz,name,sig);
1180     functionExit(thr);
1181     return result;
1182 JNI_END
1183 
</pre>
<hr />
<pre>
1236                                 const char *name,
1237                                 const char *sig))
1238     functionEnter(thr);
1239     IN_VM(
1240       jniCheck::validate_class(thr, clazz, false);
1241     )
1242     jmethodID result = UNCHECKED()-&gt;GetStaticMethodID(env,clazz,name,sig);
1243     functionExit(thr);
1244     return result;
1245 JNI_END
1246 
1247 #define WRAPPER_CallStaticMethod(ReturnType,Result) \
1248 JNI_ENTRY_CHECKED(ReturnType,  \
1249   checked_jni_CallStatic##Result##Method(JNIEnv *env, \
1250                                          jclass clazz, \
1251                                          jmethodID methodID, \
1252                                          ...)) \
1253     functionEnter(thr); \
1254     va_list args; \
1255     IN_VM( \
<span class="line-modified">1256       jniCheck::validate_jmethod_id(thr, methodID); \</span>
<span class="line-removed">1257       jniCheck::validate_class(thr, clazz, false); \</span>
1258     ) \
1259     va_start(args,methodID); \
1260     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodV(env, \
1261                                                                  clazz, \
1262                                                                  methodID, \
1263                                                                  args); \
1264     va_end(args); \
1265     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;Method&quot;); \
1266     functionExit(thr); \
1267     return result; \
1268 JNI_END \
1269 \
1270 JNI_ENTRY_CHECKED(ReturnType,  \
1271   checked_jni_CallStatic##Result##MethodV(JNIEnv *env, \
1272                                           jclass clazz, \
1273                                           jmethodID methodID,\
1274                                           va_list args)) \
1275     functionEnter(thr); \
1276     IN_VM( \
<span class="line-modified">1277       jniCheck::validate_jmethod_id(thr, methodID); \</span>
<span class="line-removed">1278       jniCheck::validate_class(thr, clazz, false); \</span>
1279     ) \
1280     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodV(env, \
1281                                                                  clazz, \
1282                                                                  methodID, \
1283                                                                  args); \
1284     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;MethodV&quot;); \
1285     functionExit(thr); \
1286     return result; \
1287 JNI_END \
1288 \
1289 JNI_ENTRY_CHECKED(ReturnType,  \
1290   checked_jni_CallStatic##Result##MethodA(JNIEnv *env, \
1291                                           jclass clazz, \
1292                                           jmethodID methodID, \
1293                                           const jvalue *args)) \
1294     functionEnter(thr); \
1295     IN_VM( \
<span class="line-modified">1296       jniCheck::validate_jmethod_id(thr, methodID); \</span>
<span class="line-removed">1297       jniCheck::validate_class(thr, clazz, false); \</span>
1298     ) \
1299     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodA(env, \
1300                                                                  clazz, \
1301                                                                  methodID, \
1302                                                                  args); \
1303     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;MethodA&quot;); \
1304     functionExit(thr); \
1305     return result; \
1306 JNI_END
1307 
1308 WRAPPER_CallStaticMethod(jobject,Object)
1309 WRAPPER_CallStaticMethod(jboolean,Boolean)
1310 WRAPPER_CallStaticMethod(jbyte,Byte)
1311 WRAPPER_CallStaticMethod(jshort,Short)
1312 WRAPPER_CallStaticMethod(jchar,Char)
1313 WRAPPER_CallStaticMethod(jint,Int)
1314 WRAPPER_CallStaticMethod(jlong,Long)
1315 WRAPPER_CallStaticMethod(jfloat,Float)
1316 WRAPPER_CallStaticMethod(jdouble,Double)
1317 
1318 JNI_ENTRY_CHECKED(void,
1319   checked_jni_CallStaticVoidMethod(JNIEnv *env,
1320                                    jclass cls,
1321                                    jmethodID methodID,
1322                                    ...))
1323     functionEnter(thr);
1324     va_list args;
1325     IN_VM(
<span class="line-modified">1326       jniCheck::validate_jmethod_id(thr, methodID);</span>
<span class="line-removed">1327       jniCheck::validate_class(thr, cls, false);</span>
1328     )
1329     va_start(args,methodID);
1330     UNCHECKED()-&gt;CallStaticVoidMethodV(env,cls,methodID,args);
1331     va_end(args);
1332     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethod&quot;);
1333     functionExit(thr);
1334 JNI_END
1335 
1336 JNI_ENTRY_CHECKED(void,
1337   checked_jni_CallStaticVoidMethodV(JNIEnv *env,
1338                                     jclass cls,
1339                                     jmethodID methodID,
1340                                     va_list args))
1341     functionEnter(thr);
1342     IN_VM(
<span class="line-modified">1343       jniCheck::validate_jmethod_id(thr, methodID);</span>
<span class="line-removed">1344       jniCheck::validate_class(thr, cls, false);</span>
1345     )
1346     UNCHECKED()-&gt;CallStaticVoidMethodV(env,cls,methodID,args);
1347     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethodV&quot;);
1348     functionExit(thr);
1349 JNI_END
1350 
1351 JNI_ENTRY_CHECKED(void,
1352   checked_jni_CallStaticVoidMethodA(JNIEnv *env,
1353                                     jclass cls,
1354                                     jmethodID methodID,
1355                                     const jvalue * args))
1356     functionEnter(thr);
1357     IN_VM(
<span class="line-modified">1358       jniCheck::validate_jmethod_id(thr, methodID);</span>
<span class="line-removed">1359       jniCheck::validate_class(thr, cls, false);</span>
1360     )
1361     UNCHECKED()-&gt;CallStaticVoidMethodA(env,cls,methodID,args);
1362     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethodA&quot;);
1363     functionExit(thr);
1364 JNI_END
1365 
1366 JNI_ENTRY_CHECKED(jfieldID,
1367   checked_jni_GetStaticFieldID(JNIEnv *env,
1368                                jclass clazz,
1369                                const char *name,
1370                                const char *sig))
1371     functionEnter(thr);
1372     IN_VM(
1373       jniCheck::validate_class(thr, clazz, false);
1374     )
1375     jfieldID result = UNCHECKED()-&gt;GetStaticFieldID(env,clazz,name,sig);
1376     functionExit(thr);
1377     return result;
1378 JNI_END
1379 
</pre>
<hr />
<pre>
1910 JNI_END
1911 
1912 JNI_ENTRY_CHECKED(jweak,
1913   checked_jni_NewWeakGlobalRef(JNIEnv *env,
1914                                jobject obj))
1915     functionEnter(thr);
1916     IN_VM(
1917       if (obj != NULL) {
1918         jniCheck::validate_handle(thr, obj);
1919       }
1920     )
1921     jweak result = UNCHECKED()-&gt;NewWeakGlobalRef(env, obj);
1922     functionExit(thr);
1923     return result;
1924 JNI_END
1925 
1926 JNI_ENTRY_CHECKED(void,
1927   checked_jni_DeleteWeakGlobalRef(JNIEnv *env,
1928                                   jweak ref))
1929     functionEnterExceptionAllowed(thr);






1930     UNCHECKED()-&gt;DeleteWeakGlobalRef(env, ref);
1931     functionExit(thr);
1932 JNI_END
1933 
1934 JNI_ENTRY_CHECKED(jboolean,
1935   checked_jni_ExceptionCheck(JNIEnv *env))
1936     thr-&gt;clear_pending_jni_exception_check();
1937     functionEnterExceptionAllowed(thr);
1938     jboolean result = UNCHECKED()-&gt;ExceptionCheck(env);
1939     functionExit(thr);
1940     return result;
1941 JNI_END
1942 
1943 JNI_ENTRY_CHECKED(jobject,
1944   checked_jni_NewDirectByteBuffer(JNIEnv *env,
1945                                   void *address,
1946                                   jlong capacity))
1947     functionEnter(thr);
1948     jobject result = UNCHECKED()-&gt;NewDirectByteBuffer(env, address, capacity);
1949     functionExit(thr);
</pre>
<hr />
<pre>
2285     // Module Features
2286 
2287     checked_jni_GetModule
2288 };
2289 
2290 
2291 // Returns the function structure
2292 struct JNINativeInterface_* jni_functions_check() {
2293 
2294   unchecked_jni_NativeInterface = jni_functions_nocheck();
2295 
2296   // make sure the last pointer in the checked table is not null, indicating
2297   // an addition to the JNINativeInterface_ structure without initializing
2298   // it in the checked table.
2299   debug_only(int *lastPtr = (int *)((char *)&amp;checked_jni_NativeInterface + \
2300              sizeof(*unchecked_jni_NativeInterface) - sizeof(char *));)
2301   assert(*lastPtr != 0,
2302          &quot;Mismatched JNINativeInterface tables, check for new entries&quot;);
2303 
2304   // with -verbose:jni this message will print
<span class="line-modified">2305   if (PrintJNIResolving) {</span>
<span class="line-removed">2306     tty-&gt;print_cr(&quot;Checked JNI functions are being used to &quot; \</span>
<span class="line-removed">2307                   &quot;validate JNI usage&quot;);</span>
<span class="line-removed">2308   }</span>
2309 
2310   return &amp;checked_jni_NativeInterface;
2311 }
</pre>
</td>
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jni.h&quot;
  27 #include &quot;jvm.h&quot;
  28 #include &quot;classfile/javaClasses.inline.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
<span class="line-added">  31 #include &quot;logging/log.hpp&quot;</span>
<span class="line-added">  32 #include &quot;logging/logTag.hpp&quot;</span>
  33 #include &quot;memory/allocation.inline.hpp&quot;
  34 #include &quot;memory/guardedMemory.hpp&quot;
  35 #include &quot;oops/instanceKlass.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;oops/symbol.hpp&quot;
  38 #include &quot;prims/jniCheck.hpp&quot;
  39 #include &quot;prims/jvm_misc.hpp&quot;
  40 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  41 #include &quot;runtime/handles.inline.hpp&quot;
  42 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  43 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  44 #include &quot;runtime/jniHandles.inline.hpp&quot;
  45 #include &quot;runtime/thread.inline.hpp&quot;
  46 
  47 // Complain every extra number of unplanned local refs
  48 #define CHECK_JNI_LOCAL_REF_CAP_WARN_THRESHOLD 32
  49 
  50 // Heap objects are allowed to be directly referenced only in VM code,
  51 // not in native code.
  52 
</pre>
<hr />
<pre>
 251     add_planned_handle_capacity(handles, 0);
 252   }
 253 }
 254 
 255 static inline void
 256 checkStaticFieldID(JavaThread* thr, jfieldID fid, jclass cls, int ftype)
 257 {
 258   fieldDescriptor fd;
 259 
 260   /* make sure it is a static field */
 261   if (!jfieldIDWorkaround::is_static_jfieldID(fid))
 262     ReportJNIFatalError(thr, fatal_should_be_static);
 263 
 264   /* validate the class being passed */
 265   ASSERT_OOPS_ALLOWED;
 266   Klass* k_oop = jniCheck::validate_class(thr, cls, false);
 267 
 268   /* check for proper subclass hierarchy */
 269   JNIid* id = jfieldIDWorkaround::from_static_jfieldID(fid);
 270   Klass* f_oop = id-&gt;holder();
<span class="line-modified"> 271   if (!k_oop-&gt;is_subtype_of(f_oop))</span>
 272     ReportJNIFatalError(thr, fatal_wrong_static_field);
 273 
 274   /* check for proper field type */
 275   if (!id-&gt;find_local_field(&amp;fd))
 276     ReportJNIFatalError(thr, fatal_static_field_not_found);
 277   if ((fd.field_type() != ftype) &amp;&amp;
 278       !(fd.field_type() == T_ARRAY &amp;&amp; ftype == T_OBJECT)) {
 279     ReportJNIFatalError(thr, fatal_static_field_mismatch);
 280   }
 281 }
 282 
 283 static inline void
 284 checkInstanceFieldID(JavaThread* thr, jfieldID fid, jobject obj, int ftype)
 285 {
 286   fieldDescriptor fd;
 287 
 288   /* make sure it is an instance field */
 289   if (jfieldIDWorkaround::is_static_jfieldID(fid))
 290     ReportJNIFatalError(thr, fatal_should_be_nonstatic);
 291 
</pre>
<hr />
<pre>
 433     NativeReportJNIFatalError(thr, &quot;Unrecognized array release mode&quot;);
 434   }
 435   // We always need to release the copy we made with GuardedMemory
 436   GuardedMemory::free_copy(carray);
 437   return orig_result;
 438 }
 439 
 440 oop jniCheck::validate_handle(JavaThread* thr, jobject obj) {
 441   if ((obj != NULL) &amp;&amp; (JNIHandles::handle_type(thr, obj) != JNIInvalidRefType)) {
 442     ASSERT_OOPS_ALLOWED;
 443     return JNIHandles::resolve_external_guard(obj);
 444   }
 445   ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 446   return NULL;
 447 }
 448 
 449 
 450 Method* jniCheck::validate_jmethod_id(JavaThread* thr, jmethodID method_id) {
 451   ASSERT_OOPS_ALLOWED;
 452   // do the fast jmethodID check first
<span class="line-modified"> 453   Method* m = Method::checked_resolve_jmethod_id(method_id);</span>
<span class="line-modified"> 454   if (m == NULL) {</span>
 455     ReportJNIFatalError(thr, fatal_wrong_class_or_method);
 456   }
<span class="line-modified"> 457   // jmethodIDs are handles in the class loader data,</span>
 458   // but that can be expensive so check it last
 459   else if (!Method::is_method_id(method_id)) {
 460     ReportJNIFatalError(thr, fatal_non_weak_method);
 461   }
<span class="line-modified"> 462   return m;</span>
 463 }
 464 
 465 
 466 oop jniCheck::validate_object(JavaThread* thr, jobject obj) {
 467   if (obj == NULL) return NULL;
 468   ASSERT_OOPS_ALLOWED;
 469   oop oopObj = jniCheck::validate_handle(thr, obj);
 470   if (oopObj == NULL) {
 471     ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 472   }
 473   return oopObj;
 474 }
 475 
 476 // Warn if a class descriptor is in decorated form; class descriptors
 477 // passed to JNI findClass should not be decorated unless they are
 478 // array descriptors.
 479 void jniCheck::validate_class_descriptor(JavaThread* thr, const char* name) {
 480   if (name == NULL) return;  // implementation accepts NULL so just return
 481 
 482   size_t len = strlen(name);
</pre>
<hr />
<pre>
 498     ReportJNIFatalError(thr, fatal_received_null_class);
 499   }
 500 
 501   if (mirror-&gt;klass() != SystemDictionary::Class_klass()) {
 502     ReportJNIFatalError(thr, fatal_class_not_a_class);
 503   }
 504 
 505   Klass* k = java_lang_Class::as_Klass(mirror);
 506   // Make allowances for primitive classes ...
 507   if (!(k != NULL || (allow_primitive &amp;&amp; java_lang_Class::is_primitive(mirror)))) {
 508     ReportJNIFatalError(thr, fatal_class_not_a_class);
 509   }
 510   return k;
 511 }
 512 
 513 void jniCheck::validate_throwable_klass(JavaThread* thr, Klass* klass) {
 514   ASSERT_OOPS_ALLOWED;
 515   assert(klass != NULL, &quot;klass argument must have a value&quot;);
 516 
 517   if (!klass-&gt;is_instance_klass() ||
<span class="line-modified"> 518       !klass-&gt;is_subclass_of(SystemDictionary::Throwable_klass())) {</span>
 519     ReportJNIFatalError(thr, fatal_class_not_a_throwable_class);
 520   }
 521 }
 522 
<span class="line-modified"> 523 void jniCheck::validate_call(JavaThread* thr, jclass clazz, jmethodID method_id, jobject obj) {</span>

 524   ASSERT_OOPS_ALLOWED;
<span class="line-modified"> 525   Method* m = jniCheck::validate_jmethod_id(thr, method_id);</span>
<span class="line-modified"> 526   InstanceKlass* holder = m-&gt;method_holder();</span>
<span class="line-modified"> 527 </span>
<span class="line-added"> 528   if (clazz != NULL) {</span>
<span class="line-added"> 529     Klass* k = jniCheck::validate_class(thr, clazz, false);</span>
<span class="line-added"> 530     // Check that method is in the class, must be InstanceKlass</span>
<span class="line-added"> 531     if (!InstanceKlass::cast(k)-&gt;is_subtype_of(holder)) {</span>
<span class="line-added"> 532       ReportJNIFatalError(thr, fatal_wrong_class_or_method);</span>
<span class="line-added"> 533     }</span>
<span class="line-added"> 534   }</span>
 535 
<span class="line-modified"> 536   if (obj != NULL) {</span>
<span class="line-modified"> 537     oop recv = jniCheck::validate_object(thr, obj);</span>
<span class="line-modified"> 538     assert(recv != NULL, &quot;validate_object checks that&quot;);</span>
<span class="line-modified"> 539     Klass* rk = recv-&gt;klass();</span>
<span class="line-modified"> 540 </span>
<span class="line-added"> 541     // Check that the object is a subtype of method holder too.</span>
<span class="line-added"> 542     if (!rk-&gt;is_subtype_of(holder)) {</span>
<span class="line-added"> 543       ReportJNIFatalError(thr, fatal_wrong_class_or_method);</span>
<span class="line-added"> 544     }</span>
<span class="line-added"> 545   }</span>
 546 }
 547 
 548 
 549 /*
 550  * IMPLEMENTATION OF FUNCTIONS IN CHECKED TABLE
 551  */
 552 
 553 JNI_ENTRY_CHECKED(jclass,
 554   checked_jni_DefineClass(JNIEnv *env,
 555                           const char *name,
 556                           jobject loader,
 557                           const jbyte *buf,
 558                           jsize len))
 559     functionEnter(thr);
 560     IN_VM(
 561       jniCheck::validate_object(thr, loader);
 562     )
 563     jclass result = UNCHECKED()-&gt;DefineClass(env, name, loader, buf, len);
 564     functionExit(thr);
 565     return result;
</pre>
<hr />
<pre>
 591 
 592 JNI_ENTRY_CHECKED(jfieldID,
 593   checked_jni_FromReflectedField(JNIEnv *env,
 594                                  jobject field))
 595     functionEnter(thr);
 596     IN_VM(
 597       jniCheck::validate_object(thr, field);
 598     )
 599     jfieldID result = UNCHECKED()-&gt;FromReflectedField(env, field);
 600     functionExit(thr);
 601     return result;
 602 JNI_END
 603 
 604 JNI_ENTRY_CHECKED(jobject,
 605   checked_jni_ToReflectedMethod(JNIEnv *env,
 606                                 jclass cls,
 607                                 jmethodID methodID,
 608                                 jboolean isStatic))
 609     functionEnter(thr);
 610     IN_VM(
<span class="line-modified"> 611       jniCheck::validate_call(thr, cls, methodID);</span>

 612     )
 613     jobject result = UNCHECKED()-&gt;ToReflectedMethod(env, cls, methodID,
 614                                                     isStatic);
 615     functionExit(thr);
 616     return result;
 617 JNI_END
 618 
 619 JNI_ENTRY_CHECKED(jclass,
 620   checked_jni_GetSuperclass(JNIEnv *env,
 621                             jclass sub))
 622     functionEnter(thr);
 623     IN_VM(
 624       jniCheck::validate_class(thr, sub, true);
 625     )
 626     jclass result = UNCHECKED()-&gt;GetSuperclass(env, sub);
 627     functionExit(thr);
 628     return result;
 629 JNI_END
 630 
 631 JNI_ENTRY_CHECKED(jboolean,
</pre>
<hr />
<pre>
 847 JNI_ENTRY_CHECKED(jobject,
 848   checked_jni_AllocObject(JNIEnv *env,
 849                           jclass clazz))
 850     functionEnter(thr);
 851     IN_VM(
 852       jniCheck::validate_class(thr, clazz, false);
 853     )
 854     jobject result = UNCHECKED()-&gt;AllocObject(env,clazz);
 855     functionExit(thr);
 856     return result;
 857 JNI_END
 858 
 859 JNI_ENTRY_CHECKED(jobject,
 860   checked_jni_NewObject(JNIEnv *env,
 861                         jclass clazz,
 862                         jmethodID methodID,
 863                         ...))
 864     functionEnter(thr);
 865     va_list args;
 866     IN_VM(
<span class="line-modified"> 867       jniCheck::validate_call(thr, clazz, methodID);</span>

 868     )
 869     va_start(args, methodID);
 870     jobject result = UNCHECKED()-&gt;NewObjectV(env,clazz,methodID,args);
 871     va_end(args);
 872     functionExit(thr);
 873     return result;
 874 JNI_END
 875 
 876 JNI_ENTRY_CHECKED(jobject,
 877   checked_jni_NewObjectV(JNIEnv *env,
 878                          jclass clazz,
 879                          jmethodID methodID,
 880                          va_list args))
 881     functionEnter(thr);
 882     IN_VM(
<span class="line-modified"> 883       jniCheck::validate_call(thr, clazz, methodID);</span>

 884     )
 885     jobject result = UNCHECKED()-&gt;NewObjectV(env,clazz,methodID,args);
 886     functionExit(thr);
 887     return result;
 888 JNI_END
 889 
 890 JNI_ENTRY_CHECKED(jobject,
 891   checked_jni_NewObjectA(JNIEnv *env,
 892                          jclass clazz,
 893                          jmethodID methodID,
 894                          const jvalue *args))
 895     functionEnter(thr);
 896     IN_VM(
<span class="line-modified"> 897       jniCheck::validate_call(thr, clazz, methodID);</span>

 898     )
 899     jobject result = UNCHECKED()-&gt;NewObjectA(env,clazz,methodID,args);
 900     functionExit(thr);
 901     return result;
 902 JNI_END
 903 
 904 JNI_ENTRY_CHECKED(jclass,
 905   checked_jni_GetObjectClass(JNIEnv *env,
 906                              jobject obj))
 907     functionEnter(thr);
 908     IN_VM(
 909       jniCheck::validate_object(thr, obj);
 910     )
 911     jclass result = UNCHECKED()-&gt;GetObjectClass(env,obj);
 912     functionExit(thr);
 913     return result;
 914 JNI_END
 915 
 916 JNI_ENTRY_CHECKED(jboolean,
 917   checked_jni_IsInstanceOf(JNIEnv *env,
</pre>
<hr />
<pre>
 933                           const char *name,
 934                           const char *sig))
 935     functionEnter(thr);
 936     IN_VM(
 937       jniCheck::validate_class(thr, clazz, false);
 938     )
 939     jmethodID result = UNCHECKED()-&gt;GetMethodID(env,clazz,name,sig);
 940     functionExit(thr);
 941     return result;
 942 JNI_END
 943 
 944 #define WRAPPER_CallMethod(ResultType, Result) \
 945 JNI_ENTRY_CHECKED(ResultType,  \
 946   checked_jni_Call##Result##Method(JNIEnv *env, \
 947                                    jobject obj, \
 948                                    jmethodID methodID, \
 949                                    ...)) \
 950     functionEnter(thr); \
 951     va_list args; \
 952     IN_VM( \
<span class="line-modified"> 953       jniCheck::validate_call(thr, NULL, methodID, obj); \</span>
 954     ) \
 955     va_start(args,methodID); \
 956     ResultType result =UNCHECKED()-&gt;Call##Result##MethodV(env, obj, methodID, \
 957                                                           args); \
 958     va_end(args); \
 959     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;Method&quot;); \
 960     functionExit(thr); \
 961     return result; \
 962 JNI_END \
 963 \
 964 JNI_ENTRY_CHECKED(ResultType,  \
 965   checked_jni_Call##Result##MethodV(JNIEnv *env, \
 966                                     jobject obj, \
 967                                     jmethodID methodID, \
 968                                     va_list args)) \
 969     functionEnter(thr); \
 970     IN_VM(\
<span class="line-modified"> 971       jniCheck::validate_call(thr, NULL, methodID, obj); \</span>
 972     ) \
 973     ResultType result = UNCHECKED()-&gt;Call##Result##MethodV(env, obj, methodID,\
 974                                                            args); \
 975     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;MethodV&quot;); \
 976     functionExit(thr); \
 977     return result; \
 978 JNI_END \
 979 \
 980 JNI_ENTRY_CHECKED(ResultType,  \
 981   checked_jni_Call##Result##MethodA(JNIEnv *env, \
 982                                     jobject obj, \
 983                                     jmethodID methodID, \
 984                                     const jvalue * args)) \
 985     functionEnter(thr); \
 986     IN_VM( \
<span class="line-modified"> 987       jniCheck::validate_call(thr, NULL, methodID, obj); \</span>
 988     ) \
 989     ResultType result = UNCHECKED()-&gt;Call##Result##MethodA(env, obj, methodID,\
 990                                                            args); \
 991     thr-&gt;set_pending_jni_exception_check(&quot;Call&quot;#Result&quot;MethodA&quot;); \
 992     functionExit(thr); \
 993     return result; \
 994 JNI_END
 995 
 996 WRAPPER_CallMethod(jobject,Object)
 997 WRAPPER_CallMethod(jboolean,Boolean)
 998 WRAPPER_CallMethod(jbyte,Byte)
 999 WRAPPER_CallMethod(jshort,Short)
1000 WRAPPER_CallMethod(jchar,Char)
1001 WRAPPER_CallMethod(jint,Int)
1002 WRAPPER_CallMethod(jlong,Long)
1003 WRAPPER_CallMethod(jfloat,Float)
1004 WRAPPER_CallMethod(jdouble,Double)
1005 
1006 JNI_ENTRY_CHECKED(void,
1007   checked_jni_CallVoidMethod(JNIEnv *env, \
1008                              jobject obj, \
1009                              jmethodID methodID, \
1010                              ...))
1011     functionEnter(thr);
1012     va_list args;
1013     IN_VM(
<span class="line-modified">1014       jniCheck::validate_call(thr, NULL, methodID, obj);</span>
1015     )
1016     va_start(args,methodID);
1017     UNCHECKED()-&gt;CallVoidMethodV(env,obj,methodID,args);
1018     va_end(args);
1019     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethod&quot;);
1020     functionExit(thr);
1021 JNI_END
1022 
1023 JNI_ENTRY_CHECKED(void,
1024   checked_jni_CallVoidMethodV(JNIEnv *env,
1025                               jobject obj,
1026                               jmethodID methodID,
1027                               va_list args))
1028     functionEnter(thr);
1029     IN_VM(
<span class="line-modified">1030       jniCheck::validate_call(thr, NULL, methodID, obj);</span>
1031     )
1032     UNCHECKED()-&gt;CallVoidMethodV(env,obj,methodID,args);
1033     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethodV&quot;);
1034     functionExit(thr);
1035 JNI_END
1036 
1037 JNI_ENTRY_CHECKED(void,
1038   checked_jni_CallVoidMethodA(JNIEnv *env,
1039                               jobject obj,
1040                               jmethodID methodID,
1041                               const jvalue * args))
1042     functionEnter(thr);
1043     IN_VM(
<span class="line-modified">1044       jniCheck::validate_call(thr, NULL, methodID, obj);</span>
1045     )
1046     UNCHECKED()-&gt;CallVoidMethodA(env,obj,methodID,args);
1047     thr-&gt;set_pending_jni_exception_check(&quot;CallVoidMethodA&quot;);
1048     functionExit(thr);
1049 JNI_END
1050 
1051 #define WRAPPER_CallNonvirtualMethod(ResultType, Result) \
1052 JNI_ENTRY_CHECKED(ResultType,  \
1053   checked_jni_CallNonvirtual##Result##Method(JNIEnv *env, \
1054                                              jobject obj, \
1055                                              jclass clazz, \
1056                                              jmethodID methodID, \
1057                                              ...)) \
1058     functionEnter(thr); \
1059     va_list args; \
1060     IN_VM( \
<span class="line-modified">1061       jniCheck::validate_call(thr, clazz, methodID, obj); \</span>

1062     ) \
1063     va_start(args,methodID); \
1064     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodV(env, \
1065                                                                      obj, \
1066                                                                      clazz, \
1067                                                                      methodID,\
1068                                                                      args); \
1069     va_end(args); \
1070     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;Method&quot;); \
1071     functionExit(thr); \
1072     return result; \
1073 JNI_END \
1074 \
1075 JNI_ENTRY_CHECKED(ResultType,  \
1076   checked_jni_CallNonvirtual##Result##MethodV(JNIEnv *env, \
1077                                               jobject obj, \
1078                                               jclass clazz, \
1079                                               jmethodID methodID, \
1080                                               va_list args)) \
1081     functionEnter(thr); \
1082     IN_VM( \
<span class="line-modified">1083       jniCheck::validate_call(thr, clazz, methodID, obj); \</span>

1084     ) \
1085     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodV(env, \
1086                                                                      obj, \
1087                                                                      clazz, \
1088                                                                      methodID,\
1089                                                                      args); \
1090     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;MethodV&quot;); \
1091     functionExit(thr); \
1092     return result; \
1093 JNI_END \
1094 \
1095 JNI_ENTRY_CHECKED(ResultType,  \
1096   checked_jni_CallNonvirtual##Result##MethodA(JNIEnv *env, \
1097                                               jobject obj, \
1098                                               jclass clazz, \
1099                                               jmethodID methodID, \
1100                                               const jvalue * args)) \
1101     functionEnter(thr); \
1102     IN_VM( \
<span class="line-modified">1103       jniCheck::validate_call(thr, clazz, methodID, obj); \</span>

1104     ) \
1105     ResultType result = UNCHECKED()-&gt;CallNonvirtual##Result##MethodA(env, \
1106                                                                      obj, \
1107                                                                      clazz, \
1108                                                                      methodID,\
1109                                                                      args); \
1110     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtual&quot;#Result&quot;MethodA&quot;); \
1111     functionExit(thr); \
1112     return result; \
1113 JNI_END
1114 
1115 WRAPPER_CallNonvirtualMethod(jobject,Object)
1116 WRAPPER_CallNonvirtualMethod(jboolean,Boolean)
1117 WRAPPER_CallNonvirtualMethod(jbyte,Byte)
1118 WRAPPER_CallNonvirtualMethod(jshort,Short)
1119 WRAPPER_CallNonvirtualMethod(jchar,Char)
1120 WRAPPER_CallNonvirtualMethod(jint,Int)
1121 WRAPPER_CallNonvirtualMethod(jlong,Long)
1122 WRAPPER_CallNonvirtualMethod(jfloat,Float)
1123 WRAPPER_CallNonvirtualMethod(jdouble,Double)
1124 
1125 JNI_ENTRY_CHECKED(void,
1126   checked_jni_CallNonvirtualVoidMethod(JNIEnv *env,
1127                                        jobject obj,
1128                                        jclass clazz,
1129                                        jmethodID methodID,
1130                                        ...))
1131     functionEnter(thr);
1132     va_list args;
1133     IN_VM(
<span class="line-modified">1134       jniCheck::validate_call(thr, clazz, methodID, obj);</span>

1135     )
1136     va_start(args,methodID);
1137     UNCHECKED()-&gt;CallNonvirtualVoidMethodV(env,obj,clazz,methodID,args);
1138     va_end(args);
1139     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethod&quot;);
1140     functionExit(thr);
1141 JNI_END
1142 
1143 JNI_ENTRY_CHECKED(void,
1144   checked_jni_CallNonvirtualVoidMethodV(JNIEnv *env,
1145                                         jobject obj,
1146                                         jclass clazz,
1147                                         jmethodID methodID,
1148                                         va_list args))
1149     functionEnter(thr);
1150     IN_VM(
<span class="line-modified">1151       jniCheck::validate_call(thr, clazz, methodID, obj);</span>

1152     )
1153     UNCHECKED()-&gt;CallNonvirtualVoidMethodV(env,obj,clazz,methodID,args);
1154     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethodV&quot;);
1155     functionExit(thr);
1156 JNI_END
1157 
1158 JNI_ENTRY_CHECKED(void,
1159   checked_jni_CallNonvirtualVoidMethodA(JNIEnv *env,
1160                                         jobject obj,
1161                                         jclass clazz,
1162                                         jmethodID methodID,
1163                                         const jvalue * args))
1164     functionEnter(thr);
1165     IN_VM(
<span class="line-modified">1166       jniCheck::validate_call(thr, clazz, methodID, obj);</span>

1167     )
1168     UNCHECKED()-&gt;CallNonvirtualVoidMethodA(env,obj,clazz,methodID,args);
1169     thr-&gt;set_pending_jni_exception_check(&quot;CallNonvirtualVoidMethodA&quot;);
1170     functionExit(thr);
1171 JNI_END
1172 
1173 JNI_ENTRY_CHECKED(jfieldID,
1174   checked_jni_GetFieldID(JNIEnv *env,
1175                          jclass clazz,
1176                          const char *name,
1177                          const char *sig))
1178     functionEnter(thr);
1179     IN_VM(
1180       jniCheck::validate_class(thr, clazz, false);
1181     )
1182     jfieldID result = UNCHECKED()-&gt;GetFieldID(env,clazz,name,sig);
1183     functionExit(thr);
1184     return result;
1185 JNI_END
1186 
</pre>
<hr />
<pre>
1239                                 const char *name,
1240                                 const char *sig))
1241     functionEnter(thr);
1242     IN_VM(
1243       jniCheck::validate_class(thr, clazz, false);
1244     )
1245     jmethodID result = UNCHECKED()-&gt;GetStaticMethodID(env,clazz,name,sig);
1246     functionExit(thr);
1247     return result;
1248 JNI_END
1249 
1250 #define WRAPPER_CallStaticMethod(ReturnType,Result) \
1251 JNI_ENTRY_CHECKED(ReturnType,  \
1252   checked_jni_CallStatic##Result##Method(JNIEnv *env, \
1253                                          jclass clazz, \
1254                                          jmethodID methodID, \
1255                                          ...)) \
1256     functionEnter(thr); \
1257     va_list args; \
1258     IN_VM( \
<span class="line-modified">1259       jniCheck::validate_call(thr, clazz, methodID); \</span>

1260     ) \
1261     va_start(args,methodID); \
1262     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodV(env, \
1263                                                                  clazz, \
1264                                                                  methodID, \
1265                                                                  args); \
1266     va_end(args); \
1267     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;Method&quot;); \
1268     functionExit(thr); \
1269     return result; \
1270 JNI_END \
1271 \
1272 JNI_ENTRY_CHECKED(ReturnType,  \
1273   checked_jni_CallStatic##Result##MethodV(JNIEnv *env, \
1274                                           jclass clazz, \
1275                                           jmethodID methodID,\
1276                                           va_list args)) \
1277     functionEnter(thr); \
1278     IN_VM( \
<span class="line-modified">1279       jniCheck::validate_call(thr, clazz, methodID); \</span>

1280     ) \
1281     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodV(env, \
1282                                                                  clazz, \
1283                                                                  methodID, \
1284                                                                  args); \
1285     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;MethodV&quot;); \
1286     functionExit(thr); \
1287     return result; \
1288 JNI_END \
1289 \
1290 JNI_ENTRY_CHECKED(ReturnType,  \
1291   checked_jni_CallStatic##Result##MethodA(JNIEnv *env, \
1292                                           jclass clazz, \
1293                                           jmethodID methodID, \
1294                                           const jvalue *args)) \
1295     functionEnter(thr); \
1296     IN_VM( \
<span class="line-modified">1297       jniCheck::validate_call(thr, clazz, methodID); \</span>

1298     ) \
1299     ReturnType result = UNCHECKED()-&gt;CallStatic##Result##MethodA(env, \
1300                                                                  clazz, \
1301                                                                  methodID, \
1302                                                                  args); \
1303     thr-&gt;set_pending_jni_exception_check(&quot;CallStatic&quot;#Result&quot;MethodA&quot;); \
1304     functionExit(thr); \
1305     return result; \
1306 JNI_END
1307 
1308 WRAPPER_CallStaticMethod(jobject,Object)
1309 WRAPPER_CallStaticMethod(jboolean,Boolean)
1310 WRAPPER_CallStaticMethod(jbyte,Byte)
1311 WRAPPER_CallStaticMethod(jshort,Short)
1312 WRAPPER_CallStaticMethod(jchar,Char)
1313 WRAPPER_CallStaticMethod(jint,Int)
1314 WRAPPER_CallStaticMethod(jlong,Long)
1315 WRAPPER_CallStaticMethod(jfloat,Float)
1316 WRAPPER_CallStaticMethod(jdouble,Double)
1317 
1318 JNI_ENTRY_CHECKED(void,
1319   checked_jni_CallStaticVoidMethod(JNIEnv *env,
1320                                    jclass cls,
1321                                    jmethodID methodID,
1322                                    ...))
1323     functionEnter(thr);
1324     va_list args;
1325     IN_VM(
<span class="line-modified">1326       jniCheck::validate_call(thr, cls, methodID);</span>

1327     )
1328     va_start(args,methodID);
1329     UNCHECKED()-&gt;CallStaticVoidMethodV(env,cls,methodID,args);
1330     va_end(args);
1331     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethod&quot;);
1332     functionExit(thr);
1333 JNI_END
1334 
1335 JNI_ENTRY_CHECKED(void,
1336   checked_jni_CallStaticVoidMethodV(JNIEnv *env,
1337                                     jclass cls,
1338                                     jmethodID methodID,
1339                                     va_list args))
1340     functionEnter(thr);
1341     IN_VM(
<span class="line-modified">1342       jniCheck::validate_call(thr, cls, methodID);</span>

1343     )
1344     UNCHECKED()-&gt;CallStaticVoidMethodV(env,cls,methodID,args);
1345     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethodV&quot;);
1346     functionExit(thr);
1347 JNI_END
1348 
1349 JNI_ENTRY_CHECKED(void,
1350   checked_jni_CallStaticVoidMethodA(JNIEnv *env,
1351                                     jclass cls,
1352                                     jmethodID methodID,
1353                                     const jvalue * args))
1354     functionEnter(thr);
1355     IN_VM(
<span class="line-modified">1356       jniCheck::validate_call(thr, cls, methodID);</span>

1357     )
1358     UNCHECKED()-&gt;CallStaticVoidMethodA(env,cls,methodID,args);
1359     thr-&gt;set_pending_jni_exception_check(&quot;CallStaticVoidMethodA&quot;);
1360     functionExit(thr);
1361 JNI_END
1362 
1363 JNI_ENTRY_CHECKED(jfieldID,
1364   checked_jni_GetStaticFieldID(JNIEnv *env,
1365                                jclass clazz,
1366                                const char *name,
1367                                const char *sig))
1368     functionEnter(thr);
1369     IN_VM(
1370       jniCheck::validate_class(thr, clazz, false);
1371     )
1372     jfieldID result = UNCHECKED()-&gt;GetStaticFieldID(env,clazz,name,sig);
1373     functionExit(thr);
1374     return result;
1375 JNI_END
1376 
</pre>
<hr />
<pre>
1907 JNI_END
1908 
1909 JNI_ENTRY_CHECKED(jweak,
1910   checked_jni_NewWeakGlobalRef(JNIEnv *env,
1911                                jobject obj))
1912     functionEnter(thr);
1913     IN_VM(
1914       if (obj != NULL) {
1915         jniCheck::validate_handle(thr, obj);
1916       }
1917     )
1918     jweak result = UNCHECKED()-&gt;NewWeakGlobalRef(env, obj);
1919     functionExit(thr);
1920     return result;
1921 JNI_END
1922 
1923 JNI_ENTRY_CHECKED(void,
1924   checked_jni_DeleteWeakGlobalRef(JNIEnv *env,
1925                                   jweak ref))
1926     functionEnterExceptionAllowed(thr);
<span class="line-added">1927     IN_VM(</span>
<span class="line-added">1928       if (ref &amp;&amp; !JNIHandles::is_weak_global_handle(ref)) {</span>
<span class="line-added">1929         ReportJNIFatalError(thr,</span>
<span class="line-added">1930              &quot;Invalid weak global JNI handle passed to DeleteWeakGlobalRef&quot;);</span>
<span class="line-added">1931       }</span>
<span class="line-added">1932     )</span>
1933     UNCHECKED()-&gt;DeleteWeakGlobalRef(env, ref);
1934     functionExit(thr);
1935 JNI_END
1936 
1937 JNI_ENTRY_CHECKED(jboolean,
1938   checked_jni_ExceptionCheck(JNIEnv *env))
1939     thr-&gt;clear_pending_jni_exception_check();
1940     functionEnterExceptionAllowed(thr);
1941     jboolean result = UNCHECKED()-&gt;ExceptionCheck(env);
1942     functionExit(thr);
1943     return result;
1944 JNI_END
1945 
1946 JNI_ENTRY_CHECKED(jobject,
1947   checked_jni_NewDirectByteBuffer(JNIEnv *env,
1948                                   void *address,
1949                                   jlong capacity))
1950     functionEnter(thr);
1951     jobject result = UNCHECKED()-&gt;NewDirectByteBuffer(env, address, capacity);
1952     functionExit(thr);
</pre>
<hr />
<pre>
2288     // Module Features
2289 
2290     checked_jni_GetModule
2291 };
2292 
2293 
2294 // Returns the function structure
2295 struct JNINativeInterface_* jni_functions_check() {
2296 
2297   unchecked_jni_NativeInterface = jni_functions_nocheck();
2298 
2299   // make sure the last pointer in the checked table is not null, indicating
2300   // an addition to the JNINativeInterface_ structure without initializing
2301   // it in the checked table.
2302   debug_only(int *lastPtr = (int *)((char *)&amp;checked_jni_NativeInterface + \
2303              sizeof(*unchecked_jni_NativeInterface) - sizeof(char *));)
2304   assert(*lastPtr != 0,
2305          &quot;Mismatched JNINativeInterface tables, check for new entries&quot;);
2306 
2307   // with -verbose:jni this message will print
<span class="line-modified">2308   log_debug(jni, resolve)(&quot;Checked JNI functions are being used to validate JNI usage&quot;);</span>



2309 
2310   return &amp;checked_jni_NativeInterface;
2311 }
</pre>
</td>
</tr>
</table>
<center><a href="jni.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>