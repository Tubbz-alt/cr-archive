<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/prims/jvmtiEventController.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interpreter/interpreter.hpp&quot;
  27 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  28 #include &quot;logging/log.hpp&quot;
  29 #include &quot;memory/resourceArea.hpp&quot;
  30 #include &quot;prims/jvmtiEventController.hpp&quot;
  31 #include &quot;prims/jvmtiEventController.inline.hpp&quot;
  32 #include &quot;prims/jvmtiExport.hpp&quot;
  33 #include &quot;prims/jvmtiImpl.hpp&quot;
  34 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  35 #include &quot;runtime/frame.hpp&quot;
  36 #include &quot;runtime/thread.inline.hpp&quot;
  37 #include &quot;runtime/threadSMR.hpp&quot;
  38 #include &quot;runtime/vframe.hpp&quot;
  39 #include &quot;runtime/vframe_hp.hpp&quot;
  40 #include &quot;runtime/vmThread.hpp&quot;
  41 #include &quot;runtime/vmOperations.hpp&quot;
  42 
  43 #ifdef JVMTI_TRACE
  44 #define EC_TRACE(out) do { \
  45   if (JvmtiTrace::trace_event_controller()) { \
  46     SafeResourceMark rm; \
  47     log_trace(jvmti) out; \
  48   } \
  49 } while (0)
  50 #else
  51 #define EC_TRACE(out)
  52 #endif /*JVMTI_TRACE */
  53 
  54 // bits for standard events
  55 
  56 static const jlong  SINGLE_STEP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_SINGLE_STEP - TOTAL_MIN_EVENT_TYPE_VAL));
  57 static const jlong  FRAME_POP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FRAME_POP - TOTAL_MIN_EVENT_TYPE_VAL));
  58 static const jlong  BREAKPOINT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_BREAKPOINT - TOTAL_MIN_EVENT_TYPE_VAL));
  59 static const jlong  FIELD_ACCESS_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FIELD_ACCESS - TOTAL_MIN_EVENT_TYPE_VAL));
  60 static const jlong  FIELD_MODIFICATION_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_FIELD_MODIFICATION - TOTAL_MIN_EVENT_TYPE_VAL));
  61 static const jlong  METHOD_ENTRY_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_METHOD_ENTRY - TOTAL_MIN_EVENT_TYPE_VAL));
  62 static const jlong  METHOD_EXIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_METHOD_EXIT - TOTAL_MIN_EVENT_TYPE_VAL));
  63 static const jlong  CLASS_FILE_LOAD_HOOK_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_FILE_LOAD_HOOK - TOTAL_MIN_EVENT_TYPE_VAL));
  64 static const jlong  NATIVE_METHOD_BIND_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_NATIVE_METHOD_BIND - TOTAL_MIN_EVENT_TYPE_VAL));
  65 static const jlong  VM_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_START - TOTAL_MIN_EVENT_TYPE_VAL));
  66 static const jlong  VM_INIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_INIT - TOTAL_MIN_EVENT_TYPE_VAL));
  67 static const jlong  VM_DEATH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_DEATH - TOTAL_MIN_EVENT_TYPE_VAL));
  68 static const jlong  CLASS_LOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_LOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  69 static const jlong  CLASS_PREPARE_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_CLASS_PREPARE - TOTAL_MIN_EVENT_TYPE_VAL));
  70 static const jlong  THREAD_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_THREAD_START - TOTAL_MIN_EVENT_TYPE_VAL));
  71 static const jlong  THREAD_END_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_THREAD_END - TOTAL_MIN_EVENT_TYPE_VAL));
  72 static const jlong  EXCEPTION_THROW_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_EXCEPTION - TOTAL_MIN_EVENT_TYPE_VAL));
  73 static const jlong  EXCEPTION_CATCH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_EXCEPTION_CATCH - TOTAL_MIN_EVENT_TYPE_VAL));
  74 static const jlong  MONITOR_CONTENDED_ENTER_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_CONTENDED_ENTER - TOTAL_MIN_EVENT_TYPE_VAL));
  75 static const jlong  MONITOR_CONTENDED_ENTERED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_CONTENDED_ENTERED - TOTAL_MIN_EVENT_TYPE_VAL));
  76 static const jlong  MONITOR_WAIT_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_WAIT - TOTAL_MIN_EVENT_TYPE_VAL));
  77 static const jlong  MONITOR_WAITED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_MONITOR_WAITED - TOTAL_MIN_EVENT_TYPE_VAL));
  78 static const jlong  DYNAMIC_CODE_GENERATED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_DYNAMIC_CODE_GENERATED - TOTAL_MIN_EVENT_TYPE_VAL));
  79 static const jlong  DATA_DUMP_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_DATA_DUMP_REQUEST - TOTAL_MIN_EVENT_TYPE_VAL));
  80 static const jlong  COMPILED_METHOD_LOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_COMPILED_METHOD_LOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  81 static const jlong  COMPILED_METHOD_UNLOAD_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_COMPILED_METHOD_UNLOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  82 static const jlong  GARBAGE_COLLECTION_START_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_GARBAGE_COLLECTION_START - TOTAL_MIN_EVENT_TYPE_VAL));
  83 static const jlong  GARBAGE_COLLECTION_FINISH_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_GARBAGE_COLLECTION_FINISH - TOTAL_MIN_EVENT_TYPE_VAL));
  84 static const jlong  OBJECT_FREE_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_OBJECT_FREE - TOTAL_MIN_EVENT_TYPE_VAL));
  85 static const jlong  RESOURCE_EXHAUSTED_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_RESOURCE_EXHAUSTED - TOTAL_MIN_EVENT_TYPE_VAL));
  86 static const jlong  VM_OBJECT_ALLOC_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_VM_OBJECT_ALLOC - TOTAL_MIN_EVENT_TYPE_VAL));
  87 static const jlong  SAMPLED_OBJECT_ALLOC_BIT = (((jlong)1) &lt;&lt; (JVMTI_EVENT_SAMPLED_OBJECT_ALLOC - TOTAL_MIN_EVENT_TYPE_VAL));
  88 
  89 // bits for extension events
  90 static const jlong  CLASS_UNLOAD_BIT = (((jlong)1) &lt;&lt; (EXT_EVENT_CLASS_UNLOAD - TOTAL_MIN_EVENT_TYPE_VAL));
  91 
  92 
  93 static const jlong  MONITOR_BITS = MONITOR_CONTENDED_ENTER_BIT | MONITOR_CONTENDED_ENTERED_BIT |
  94                           MONITOR_WAIT_BIT | MONITOR_WAITED_BIT;
  95 static const jlong  EXCEPTION_BITS = EXCEPTION_THROW_BIT | EXCEPTION_CATCH_BIT;
  96 static const jlong  INTERP_EVENT_BITS =  SINGLE_STEP_BIT | METHOD_ENTRY_BIT | METHOD_EXIT_BIT |
  97                                 FRAME_POP_BIT | FIELD_ACCESS_BIT | FIELD_MODIFICATION_BIT;
  98 static const jlong  THREAD_FILTERED_EVENT_BITS = INTERP_EVENT_BITS | EXCEPTION_BITS | MONITOR_BITS |
  99                                         BREAKPOINT_BIT | CLASS_LOAD_BIT | CLASS_PREPARE_BIT | THREAD_END_BIT |
 100                                         SAMPLED_OBJECT_ALLOC_BIT;
 101 static const jlong  NEED_THREAD_LIFE_EVENTS = THREAD_FILTERED_EVENT_BITS | THREAD_START_BIT;
 102 static const jlong  EARLY_EVENT_BITS = CLASS_FILE_LOAD_HOOK_BIT | CLASS_LOAD_BIT | CLASS_PREPARE_BIT |
 103                                VM_START_BIT | VM_INIT_BIT | VM_DEATH_BIT | NATIVE_METHOD_BIND_BIT |
 104                                THREAD_START_BIT | THREAD_END_BIT |
 105                                COMPILED_METHOD_LOAD_BIT | COMPILED_METHOD_UNLOAD_BIT |
 106                                DYNAMIC_CODE_GENERATED_BIT;
 107 static const jlong  GLOBAL_EVENT_BITS = ~THREAD_FILTERED_EVENT_BITS;
 108 static const jlong  SHOULD_POST_ON_EXCEPTIONS_BITS = EXCEPTION_BITS | METHOD_EXIT_BIT | FRAME_POP_BIT;
 109 
 110 ///////////////////////////////////////////////////////////////
 111 //
 112 // JvmtiEventEnabled
 113 //
 114 
 115 JvmtiEventEnabled::JvmtiEventEnabled() {
 116   clear();
 117 }
 118 
 119 
 120 void JvmtiEventEnabled::clear() {
 121   _enabled_bits = 0;
 122 #ifndef PRODUCT
 123   _init_guard = JEE_INIT_GUARD;
 124 #endif
 125 }
 126 
 127 void JvmtiEventEnabled::set_enabled(jvmtiEvent event_type, bool enabled) {
 128   jlong bits = get_bits();
 129   jlong mask = bit_for(event_type);
 130   if (enabled) {
 131     bits |= mask;
 132   } else {
 133     bits &amp;= ~mask;
 134   }
 135   set_bits(bits);
 136 }
 137 
 138 
 139 ///////////////////////////////////////////////////////////////
 140 //
 141 // JvmtiEnvThreadEventEnable
 142 //
 143 
 144 JvmtiEnvThreadEventEnable::JvmtiEnvThreadEventEnable() {
 145   _event_user_enabled.clear();
 146   _event_enabled.clear();
 147 }
 148 
 149 
 150 JvmtiEnvThreadEventEnable::~JvmtiEnvThreadEventEnable() {
 151   _event_user_enabled.clear();
 152   _event_enabled.clear();
 153 }
 154 
 155 
 156 ///////////////////////////////////////////////////////////////
 157 //
 158 // JvmtiThreadEventEnable
 159 //
 160 
 161 JvmtiThreadEventEnable::JvmtiThreadEventEnable() {
 162   _event_enabled.clear();
 163 }
 164 
 165 
 166 JvmtiThreadEventEnable::~JvmtiThreadEventEnable() {
 167   _event_enabled.clear();
 168 }
 169 
 170 
 171 ///////////////////////////////////////////////////////////////
 172 //
 173 // JvmtiEnvEventEnable
 174 //
 175 
 176 JvmtiEnvEventEnable::JvmtiEnvEventEnable() {
 177   _event_user_enabled.clear();
 178   _event_callback_enabled.clear();
 179   _event_enabled.clear();
 180 }
 181 
 182 
 183 JvmtiEnvEventEnable::~JvmtiEnvEventEnable() {
 184   _event_user_enabled.clear();
 185   _event_callback_enabled.clear();
 186   _event_enabled.clear();
 187 }
 188 
 189 
 190 ///////////////////////////////////////////////////////////////
 191 //
 192 // VM_EnterInterpOnlyMode
 193 //
 194 
 195 class VM_EnterInterpOnlyMode : public VM_Operation {
 196 private:
 197   JvmtiThreadState *_state;
 198 
 199 public:
 200   VM_EnterInterpOnlyMode(JvmtiThreadState *state);
 201 
 202   bool allow_nested_vm_operations() const        { return true; }
 203   VMOp_Type type() const { return VMOp_EnterInterpOnlyMode; }
 204   void doit();
 205 
 206   // to do: this same function is in jvmtiImpl - should be in one place
 207   bool can_be_deoptimized(vframe* vf) {
 208     return (vf-&gt;is_compiled_frame() &amp;&amp; vf-&gt;fr().can_be_deoptimized());
 209   }
 210 };
 211 
 212 VM_EnterInterpOnlyMode::VM_EnterInterpOnlyMode(JvmtiThreadState *state)
 213   : _state(state)
 214 {
 215 }
 216 
 217 
 218 void VM_EnterInterpOnlyMode::doit() {
 219   // Set up the current stack depth for later tracking
 220   _state-&gt;invalidate_cur_stack_depth();
 221 
 222   _state-&gt;enter_interp_only_mode();
 223 
 224   JavaThread *thread = _state-&gt;get_thread();
 225   if (thread-&gt;has_last_Java_frame()) {
 226     // If running in fullspeed mode, single stepping is implemented
 227     // as follows: first, the interpreter does not dispatch to
 228     // compiled code for threads that have single stepping enabled;
 229     // second, we deoptimize all methods on the thread&#39;s stack when
 230     // interpreted-only mode is enabled the first time for a given
 231     // thread (nothing to do if no Java frames yet).
 232     int num_marked = 0;
 233     ResourceMark resMark;
 234     RegisterMap rm(thread, false);
 235     for (vframe* vf = thread-&gt;last_java_vframe(&amp;rm); vf; vf = vf-&gt;sender()) {
 236       if (can_be_deoptimized(vf)) {
 237         ((compiledVFrame*) vf)-&gt;code()-&gt;mark_for_deoptimization();
 238         ++num_marked;
 239       }
 240     }
 241     if (num_marked &gt; 0) {
 242       VM_Deoptimize op;
 243       VMThread::execute(&amp;op);
 244     }
 245   }
 246 }
 247 
 248 
 249 ///////////////////////////////////////////////////////////////
 250 //
 251 // VM_ChangeSingleStep
 252 //
 253 
 254 class VM_ChangeSingleStep : public VM_Operation {
 255 private:
 256   bool _on;
 257 
 258 public:
 259   VM_ChangeSingleStep(bool on);
 260   VMOp_Type type() const                         { return VMOp_ChangeSingleStep; }
 261   bool allow_nested_vm_operations() const        { return true; }
 262   void doit();   // method definition is after definition of JvmtiEventControllerPrivate because of scoping
 263 };
 264 
 265 
 266 VM_ChangeSingleStep::VM_ChangeSingleStep(bool on)
 267   : _on(on != 0)
 268 {
 269 }
 270 
 271 
 272 
 273 
 274 ///////////////////////////////////////////////////////////////
 275 //
 276 // JvmtiEventControllerPrivate
 277 //
 278 // Private internal implementation methods for JvmtiEventController.
 279 //
 280 // These methods are thread safe either because they are called
 281 // in early VM initialization which is single threaded, or they
 282 // hold the JvmtiThreadState_lock.
 283 //
 284 
 285 class JvmtiEventControllerPrivate : public AllStatic {
 286   static bool _initialized;
 287 public:
 288   static void set_should_post_single_step(bool on);
 289   static void enter_interp_only_mode(JvmtiThreadState *state);
 290   static void leave_interp_only_mode(JvmtiThreadState *state);
 291   static void recompute_enabled();
 292   static jlong recompute_env_enabled(JvmtiEnvBase* env);
 293   static jlong recompute_env_thread_enabled(JvmtiEnvThreadState* ets, JvmtiThreadState* state);
 294   static jlong recompute_thread_enabled(JvmtiThreadState *state);
 295   static void event_init();
 296 
 297   static void set_user_enabled(JvmtiEnvBase *env, JavaThread *thread,
 298                         jvmtiEvent event_type, bool enabled);
 299   static void set_event_callbacks(JvmtiEnvBase *env,
 300                                   const jvmtiEventCallbacks* callbacks,
 301                                   jint size_of_callbacks);
 302 
 303   static void set_extension_event_callback(JvmtiEnvBase *env,
 304                                            jint extension_event_index,
 305                                            jvmtiExtensionEvent callback);
 306 
 307   static void set_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 308   static void clear_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 309   static void clear_to_frame_pop(JvmtiEnvThreadState *env_thread, JvmtiFramePop fpop);
 310   static void change_field_watch(jvmtiEvent event_type, bool added);
 311 
 312   static void thread_started(JavaThread *thread);
 313   static void thread_ended(JavaThread *thread);
 314 
 315   static void env_initialize(JvmtiEnvBase *env);
 316   static void env_dispose(JvmtiEnvBase *env);
 317 
 318   static void vm_start();
 319   static void vm_init();
 320   static void vm_death();
 321 
 322   static void trace_changed(JvmtiThreadState *state, jlong now_enabled, jlong changed);
 323   static void trace_changed(jlong now_enabled, jlong changed);
 324 };
 325 
 326 bool JvmtiEventControllerPrivate::_initialized = false;
 327 
 328 void JvmtiEventControllerPrivate::set_should_post_single_step(bool on) {
 329   // we have permission to do this, VM op doesn&#39;t
 330   JvmtiExport::set_should_post_single_step(on);
 331 }
 332 
 333 
 334 // This change must always be occur when at a safepoint.
 335 // Being at a safepoint causes the interpreter to use the
 336 // safepoint dispatch table which we overload to find single
 337 // step points.  Just to be sure that it has been set, we
 338 // call notice_safepoints when turning on single stepping.
 339 // When we leave our current safepoint, should_post_single_step
 340 // will be checked by the interpreter, and the table kept
 341 // or changed accordingly.
 342 void VM_ChangeSingleStep::doit() {
 343   JvmtiEventControllerPrivate::set_should_post_single_step(_on);
 344   if (_on) {
 345     Interpreter::notice_safepoints();
 346   }
 347 }
 348 
 349 
 350 void JvmtiEventControllerPrivate::enter_interp_only_mode(JvmtiThreadState *state) {
 351   EC_TRACE((&quot;[%s] # Entering interpreter only mode&quot;,
 352             JvmtiTrace::safe_get_thread_name(state-&gt;get_thread())));
 353 
 354   VM_EnterInterpOnlyMode op(state);
 355   VMThread::execute(&amp;op);
 356 }
 357 
 358 
 359 void
 360 JvmtiEventControllerPrivate::leave_interp_only_mode(JvmtiThreadState *state) {
 361   EC_TRACE((&quot;[%s] # Leaving interpreter only mode&quot;,
 362             JvmtiTrace::safe_get_thread_name(state-&gt;get_thread())));
 363   state-&gt;leave_interp_only_mode();
 364 }
 365 
 366 
 367 void
 368 JvmtiEventControllerPrivate::trace_changed(JvmtiThreadState *state, jlong now_enabled, jlong changed) {
 369 #ifdef JVMTI_TRACE
 370   if (JvmtiTrace::trace_event_controller()) {
 371     SafeResourceMark rm;
 372     // traces standard events only
 373     for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 374       jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 375       if (changed &amp; bit) {
 376         // it changed, print it
 377          log_trace(jvmti)(&quot;[%s] # %s event %s&quot;,
 378                       JvmtiTrace::safe_get_thread_name(state-&gt;get_thread()),
 379                       (now_enabled &amp; bit)? &quot;Enabling&quot; : &quot;Disabling&quot;, JvmtiTrace::event_name((jvmtiEvent)ei));
 380       }
 381     }
 382   }
 383 #endif /*JVMTI_TRACE */
 384 }
 385 
 386 
 387 void
 388 JvmtiEventControllerPrivate::trace_changed(jlong now_enabled, jlong changed) {
 389 #ifdef JVMTI_TRACE
 390   if (JvmtiTrace::trace_event_controller()) {
 391     SafeResourceMark rm;
 392     // traces standard events only
 393     for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 394       jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 395       if (changed &amp; bit) {
 396         // it changed, print it
 397          log_trace(jvmti)(&quot;[-] # %s event %s&quot;,
 398                       (now_enabled &amp; bit)? &quot;Enabling&quot; : &quot;Disabling&quot;, JvmtiTrace::event_name((jvmtiEvent)ei));
 399       }
 400     }
 401   }
 402 #endif /*JVMTI_TRACE */
 403 }
 404 
 405 
 406 // For the specified env: compute the currently truly enabled events
 407 // set external state accordingly.
 408 // Return value and set value must include all events.
 409 // But outside this class, only non-thread-filtered events can be queried..
 410 jlong
 411 JvmtiEventControllerPrivate::recompute_env_enabled(JvmtiEnvBase* env) {
 412   jlong was_enabled = env-&gt;env_event_enable()-&gt;_event_enabled.get_bits();
 413   jlong now_enabled =
 414     env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits() &amp;
 415     env-&gt;env_event_enable()-&gt;_event_user_enabled.get_bits();
 416 
 417   switch (env-&gt;phase()) {
 418   case JVMTI_PHASE_PRIMORDIAL:
 419   case JVMTI_PHASE_ONLOAD:
 420     // only these events allowed in primordial or onload phase
 421     now_enabled &amp;= (EARLY_EVENT_BITS &amp; ~THREAD_FILTERED_EVENT_BITS);
 422     break;
 423   case JVMTI_PHASE_START:
 424     // only these events allowed in start phase
 425     now_enabled &amp;= EARLY_EVENT_BITS;
 426     break;
 427   case JVMTI_PHASE_LIVE:
 428     // all events allowed during live phase
 429     break;
 430   case JVMTI_PHASE_DEAD:
 431     // no events allowed when dead
 432     now_enabled = 0;
 433     break;
 434   default:
 435     assert(false, &quot;no other phases - sanity check&quot;);
 436     break;
 437   }
 438 
 439   // will we really send these events to this env
 440   env-&gt;env_event_enable()-&gt;_event_enabled.set_bits(now_enabled);
 441 
 442   trace_changed(now_enabled, (now_enabled ^ was_enabled)  &amp; ~THREAD_FILTERED_EVENT_BITS);
 443 
 444   return now_enabled;
 445 }
 446 
 447 
 448 // For the specified env and thread: compute the currently truly enabled events
 449 // set external state accordingly.  Only thread-filtered events are included.
 450 jlong
 451 JvmtiEventControllerPrivate::recompute_env_thread_enabled(JvmtiEnvThreadState* ets, JvmtiThreadState* state) {
 452   JvmtiEnv *env = ets-&gt;get_env();
 453 
 454   jlong was_enabled = ets-&gt;event_enable()-&gt;_event_enabled.get_bits();
 455   jlong now_enabled =  THREAD_FILTERED_EVENT_BITS &amp;
 456     env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits() &amp;
 457     (env-&gt;env_event_enable()-&gt;_event_user_enabled.get_bits() |
 458      ets-&gt;event_enable()-&gt;_event_user_enabled.get_bits());
 459 
 460   // for frame pops and field watchs, computed enabled state
 461   // is only true if an event has been requested
 462   if (!ets-&gt;has_frame_pops()) {
 463     now_enabled &amp;= ~FRAME_POP_BIT;
 464   }
 465   if (*((int *)JvmtiExport::get_field_access_count_addr()) == 0) {
 466     now_enabled &amp;= ~FIELD_ACCESS_BIT;
 467   }
 468   if (*((int *)JvmtiExport::get_field_modification_count_addr()) == 0) {
 469     now_enabled &amp;= ~FIELD_MODIFICATION_BIT;
 470   }
 471 
 472   switch (JvmtiEnv::get_phase()) {
 473   case JVMTI_PHASE_DEAD:
 474     // no events allowed when dead
 475     now_enabled = 0;
 476     break;
 477   default:
 478     break;
 479   }
 480 
 481   // if anything changed do update
 482   if (now_enabled != was_enabled) {
 483 
 484     // will we really send these events to this thread x env
 485     ets-&gt;event_enable()-&gt;_event_enabled.set_bits(now_enabled);
 486 
 487     // If the enabled status of the single step or breakpoint events changed,
 488     // the location status may need to change as well.
 489     jlong changed = now_enabled ^ was_enabled;
 490     if (changed &amp; SINGLE_STEP_BIT) {
 491       ets-&gt;reset_current_location(JVMTI_EVENT_SINGLE_STEP, (now_enabled &amp; SINGLE_STEP_BIT) != 0);
 492     }
 493     if (changed &amp; BREAKPOINT_BIT) {
 494       ets-&gt;reset_current_location(JVMTI_EVENT_BREAKPOINT,  (now_enabled &amp; BREAKPOINT_BIT) != 0);
 495     }
 496     trace_changed(state, now_enabled, changed);
 497   }
 498   return now_enabled;
 499 }
 500 
 501 
 502 // For the specified thread: compute the currently truly enabled events
 503 // set external state accordingly.  Only thread-filtered events are included.
 504 jlong
 505 JvmtiEventControllerPrivate::recompute_thread_enabled(JvmtiThreadState *state) {
 506   if (state == NULL) {
 507     // associated JavaThread is exiting
 508     return (jlong)0;
 509   }
 510 
 511   julong was_any_env_enabled = state-&gt;thread_event_enable()-&gt;_event_enabled.get_bits();
 512   julong any_env_enabled = 0;
 513   // JVMTI_EVENT_FRAME_POP can be disabled (in the case FRAME_POP_BIT is not set),
 514   // but we need to set interp_only if some JvmtiEnvThreadState has frame pop set
 515   // to clear the request
 516   bool has_frame_pops = false;
 517 
 518   {
 519     // This iteration will include JvmtiEnvThreadStates whose environments
 520     // have been disposed.  These JvmtiEnvThreadStates must not be filtered
 521     // as recompute must be called on them to disable their events,
 522     JvmtiEnvThreadStateIterator it(state);
 523     for (JvmtiEnvThreadState* ets = it.first(); ets != NULL; ets = it.next(ets)) {
 524       any_env_enabled |= recompute_env_thread_enabled(ets, state);
 525       has_frame_pops |= ets-&gt;has_frame_pops();
 526     }
 527   }
 528 
 529   if (any_env_enabled != was_any_env_enabled) {
 530     // mark if event is truly enabled on this thread in any environment
 531     state-&gt;thread_event_enable()-&gt;_event_enabled.set_bits(any_env_enabled);
 532 
 533     // update the JavaThread cached value for thread-specific should_post_on_exceptions value
 534     bool should_post_on_exceptions = (any_env_enabled &amp; SHOULD_POST_ON_EXCEPTIONS_BITS) != 0;
 535     state-&gt;set_should_post_on_exceptions(should_post_on_exceptions);
 536   }
 537 
 538   // compute interp_only mode
 539   bool should_be_interp = (any_env_enabled &amp; INTERP_EVENT_BITS) != 0 || has_frame_pops;
 540   bool is_now_interp = state-&gt;is_interp_only_mode();
 541 
 542   if (should_be_interp != is_now_interp) {
 543     if (should_be_interp) {
 544       enter_interp_only_mode(state);
 545     } else {
 546       leave_interp_only_mode(state);
 547     }
 548   }
 549 
 550   return any_env_enabled;
 551 }
 552 
 553 
 554 // Compute truly enabled events - meaning if the event can and could be
 555 // sent.  An event is truly enabled if it is user enabled on the thread
 556 // or globally user enabled, but only if there is a callback or event hook
 557 // for it and, for field watch and frame pop, one has been set.
 558 // Compute if truly enabled, per thread, per environment, per combination
 559 // (thread x environment), and overall.  These merges are true if any is true.
 560 // True per thread if some environment has callback set and the event is globally
 561 // enabled or enabled for this thread.
 562 // True per environment if the callback is set and the event is globally
 563 // enabled in this environment or enabled for any thread in this environment.
 564 // True per combination if the environment has the callback set and the
 565 // event is globally enabled in this environment or the event is enabled
 566 // for this thread and environment.
 567 //
 568 // All states transitions dependent on these transitions are also handled here.
 569 void
 570 JvmtiEventControllerPrivate::recompute_enabled() {
 571   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 572 
 573   // event enabled for any thread in any environment
 574   julong was_any_env_thread_enabled = JvmtiEventController::_universal_global_event_enabled.get_bits();
 575   julong any_env_thread_enabled = 0;
 576 
 577   EC_TRACE((&quot;[-] # recompute enabled - before &quot; JULONG_FORMAT_X, was_any_env_thread_enabled));
 578 
 579   // compute non-thread-filters events.
 580   // This must be done separately from thread-filtered events, since some
 581   // events can occur before any threads exist.
 582   JvmtiEnvIterator it;
 583   for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 584     any_env_thread_enabled |= recompute_env_enabled(env);
 585   }
 586 
 587   // We need to create any missing jvmti_thread_state if there are globally set thread
 588   // filtered events and there weren&#39;t last time
 589   if (    (any_env_thread_enabled &amp; THREAD_FILTERED_EVENT_BITS) != 0 &amp;&amp;
 590       (was_any_env_thread_enabled &amp; THREAD_FILTERED_EVENT_BITS) == 0) {
 591     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
 592       // state_for_while_locked() makes tp-&gt;is_exiting() check
 593       JvmtiThreadState::state_for_while_locked(tp);  // create the thread state if missing
 594     }
 595   }
 596 
 597   // compute and set thread-filtered events
 598   for (JvmtiThreadState *state = JvmtiThreadState::first(); state != NULL; state = state-&gt;next()) {
 599     any_env_thread_enabled |= recompute_thread_enabled(state);
 600   }
 601 
 602   // set universal state (across all envs and threads)
 603   jlong delta = any_env_thread_enabled ^ was_any_env_thread_enabled;
 604   if (delta != 0) {
 605     JvmtiExport::set_should_post_field_access((any_env_thread_enabled &amp; FIELD_ACCESS_BIT) != 0);
 606     JvmtiExport::set_should_post_field_modification((any_env_thread_enabled &amp; FIELD_MODIFICATION_BIT) != 0);
 607     JvmtiExport::set_should_post_class_load((any_env_thread_enabled &amp; CLASS_LOAD_BIT) != 0);
 608     JvmtiExport::set_should_post_class_file_load_hook((any_env_thread_enabled &amp; CLASS_FILE_LOAD_HOOK_BIT) != 0);
 609     JvmtiExport::set_should_post_native_method_bind((any_env_thread_enabled &amp; NATIVE_METHOD_BIND_BIT) != 0);
 610     JvmtiExport::set_should_post_dynamic_code_generated((any_env_thread_enabled &amp; DYNAMIC_CODE_GENERATED_BIT) != 0);
 611     JvmtiExport::set_should_post_data_dump((any_env_thread_enabled &amp; DATA_DUMP_BIT) != 0);
 612     JvmtiExport::set_should_post_class_prepare((any_env_thread_enabled &amp; CLASS_PREPARE_BIT) != 0);
 613     JvmtiExport::set_should_post_class_unload((any_env_thread_enabled &amp; CLASS_UNLOAD_BIT) != 0);
 614     JvmtiExport::set_should_post_monitor_contended_enter((any_env_thread_enabled &amp; MONITOR_CONTENDED_ENTER_BIT) != 0);
 615     JvmtiExport::set_should_post_monitor_contended_entered((any_env_thread_enabled &amp; MONITOR_CONTENDED_ENTERED_BIT) != 0);
 616     JvmtiExport::set_should_post_monitor_wait((any_env_thread_enabled &amp; MONITOR_WAIT_BIT) != 0);
 617     JvmtiExport::set_should_post_monitor_waited((any_env_thread_enabled &amp; MONITOR_WAITED_BIT) != 0);
 618     JvmtiExport::set_should_post_garbage_collection_start((any_env_thread_enabled &amp; GARBAGE_COLLECTION_START_BIT) != 0);
 619     JvmtiExport::set_should_post_garbage_collection_finish((any_env_thread_enabled &amp; GARBAGE_COLLECTION_FINISH_BIT) != 0);
 620     JvmtiExport::set_should_post_object_free((any_env_thread_enabled &amp; OBJECT_FREE_BIT) != 0);
 621     JvmtiExport::set_should_post_resource_exhausted((any_env_thread_enabled &amp; RESOURCE_EXHAUSTED_BIT) != 0);
 622     JvmtiExport::set_should_post_compiled_method_load((any_env_thread_enabled &amp; COMPILED_METHOD_LOAD_BIT) != 0);
 623     JvmtiExport::set_should_post_compiled_method_unload((any_env_thread_enabled &amp; COMPILED_METHOD_UNLOAD_BIT) != 0);
 624     JvmtiExport::set_should_post_vm_object_alloc((any_env_thread_enabled &amp; VM_OBJECT_ALLOC_BIT) != 0);
 625     JvmtiExport::set_should_post_sampled_object_alloc((any_env_thread_enabled &amp; SAMPLED_OBJECT_ALLOC_BIT) != 0);
 626 
 627     // need this if we want thread events or we need them to init data
 628     JvmtiExport::set_should_post_thread_life((any_env_thread_enabled &amp; NEED_THREAD_LIFE_EVENTS) != 0);
 629 
 630     // If single stepping is turned on or off, execute the VM op to change it.
 631     if (delta &amp; SINGLE_STEP_BIT) {
 632       switch (JvmtiEnv::get_phase()) {
 633       case JVMTI_PHASE_DEAD:
 634         // If the VM is dying we can&#39;t execute VM ops
 635         break;
 636       case JVMTI_PHASE_LIVE: {
 637         VM_ChangeSingleStep op((any_env_thread_enabled &amp; SINGLE_STEP_BIT) != 0);
 638         VMThread::execute(&amp;op);
 639         break;
 640       }
 641       default:
 642         assert(false, &quot;should never come here before live phase&quot;);
 643         break;
 644       }
 645     }
 646 
 647     // set global truly enabled, that is, any thread in any environment
 648     JvmtiEventController::_universal_global_event_enabled.set_bits(any_env_thread_enabled);
 649 
 650     // set global should_post_on_exceptions
 651     JvmtiExport::set_should_post_on_exceptions((any_env_thread_enabled &amp; SHOULD_POST_ON_EXCEPTIONS_BITS) != 0);
 652 
 653   }
 654 
 655   EC_TRACE((&quot;[-] # recompute enabled - after &quot; JULONG_FORMAT_X, any_env_thread_enabled));
 656 }
 657 
 658 
 659 void
 660 JvmtiEventControllerPrivate::thread_started(JavaThread *thread) {
 661   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
 662   assert(thread == Thread::current(), &quot;must be current thread&quot;);
 663   assert(JvmtiEnvBase::environments_might_exist(), &quot;to enter event controller, JVM TI environments must exist&quot;);
 664 
 665   EC_TRACE((&quot;[%s] # thread started&quot;, JvmtiTrace::safe_get_thread_name(thread)));
 666 
 667   // if we have any thread filtered events globally enabled, create/update the thread state
 668   if ((JvmtiEventController::_universal_global_event_enabled.get_bits() &amp; THREAD_FILTERED_EVENT_BITS) != 0) {
 669     MutexLocker mu(JvmtiThreadState_lock);
 670     // create the thread state if missing
 671     JvmtiThreadState *state = JvmtiThreadState::state_for_while_locked(thread);
 672     if (state != NULL) {    // skip threads with no JVMTI thread state
 673       recompute_thread_enabled(state);
 674     }
 675   }
 676 }
 677 
 678 
 679 void
 680 JvmtiEventControllerPrivate::thread_ended(JavaThread *thread) {
 681   // Removes the JvmtiThreadState associated with the specified thread.
 682   // May be called after all environments have been disposed.
 683   assert(JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 684 
 685   EC_TRACE((&quot;[%s] # thread ended&quot;, JvmtiTrace::safe_get_thread_name(thread)));
 686 
 687   JvmtiThreadState *state = thread-&gt;jvmti_thread_state();
 688   assert(state != NULL, &quot;else why are we here?&quot;);
 689   delete state;
 690 }
 691 
 692 void JvmtiEventControllerPrivate::set_event_callbacks(JvmtiEnvBase *env,
 693                                                       const jvmtiEventCallbacks* callbacks,
 694                                                       jint size_of_callbacks) {
 695   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 696   EC_TRACE((&quot;[*] # set event callbacks&quot;));
 697 
 698   env-&gt;set_event_callbacks(callbacks, size_of_callbacks);
 699   jlong enabled_bits = 0;
 700   for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 701     jvmtiEvent evt_t = (jvmtiEvent)ei;
 702     if (env-&gt;has_callback(evt_t)) {
 703       enabled_bits |= JvmtiEventEnabled::bit_for(evt_t);
 704     }
 705   }
 706   env-&gt;env_event_enable()-&gt;_event_callback_enabled.set_bits(enabled_bits);
 707   recompute_enabled();
 708 }
 709 
 710 void
 711 JvmtiEventControllerPrivate::set_extension_event_callback(JvmtiEnvBase *env,
 712                                                           jint extension_event_index,
 713                                                           jvmtiExtensionEvent callback)
 714 {
 715   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 716   EC_TRACE((&quot;[*] # set extension event callback&quot;));
 717 
 718   // extension events are allocated below JVMTI_MIN_EVENT_TYPE_VAL
 719   assert(extension_event_index &gt;= (jint)EXT_MIN_EVENT_TYPE_VAL &amp;&amp;
 720          extension_event_index &lt;= (jint)EXT_MAX_EVENT_TYPE_VAL, &quot;sanity check&quot;);
 721 
 722 
 723   // As the bits for both standard (jvmtiEvent) and extension
 724   // (jvmtiExtEvents) are stored in the same word we cast here to
 725   // jvmtiEvent to set/clear the bit for this extension event.
 726   jvmtiEvent event_type = (jvmtiEvent)extension_event_index;
 727 
 728   // Prevent a possible race condition where events are re-enabled by a call to
 729   // set event callbacks, where the DisposeEnvironment occurs after the boiler-plate
 730   // environment check and before the lock is acquired.
 731   // We can safely do the is_valid check now, as JvmtiThreadState_lock is held.
 732   bool enabling = (callback != NULL) &amp;&amp; (env-&gt;is_valid());
 733   env-&gt;env_event_enable()-&gt;set_user_enabled(event_type, enabling);
 734 
 735   // update the callback
 736   jvmtiExtEventCallbacks* ext_callbacks = env-&gt;ext_callbacks();
 737   switch (extension_event_index) {
 738     case EXT_EVENT_CLASS_UNLOAD :
 739       ext_callbacks-&gt;ClassUnload = callback;
 740       break;
 741     default:
 742       ShouldNotReachHere();
 743   }
 744 
 745   // update the callback enable/disable bit
 746   jlong enabled_bits = env-&gt;env_event_enable()-&gt;_event_callback_enabled.get_bits();
 747   jlong bit_for = JvmtiEventEnabled::bit_for(event_type);
 748   if (enabling) {
 749     enabled_bits |= bit_for;
 750   } else {
 751     enabled_bits &amp;= ~bit_for;
 752   }
 753   env-&gt;env_event_enable()-&gt;_event_callback_enabled.set_bits(enabled_bits);
 754 
 755   recompute_enabled();
 756 }
 757 
 758 
 759 void
 760 JvmtiEventControllerPrivate::env_initialize(JvmtiEnvBase *env) {
 761   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 762   EC_TRACE((&quot;[*] # env initialize&quot;));
 763 
 764   if (JvmtiEnvBase::is_vm_live()) {
 765     // if we didn&#39;t initialize event info already (this is a late
 766     // launched environment), do it now.
 767     event_init();
 768   }
 769 
 770   env-&gt;initialize();
 771 
 772   // add the JvmtiEnvThreadState to each JvmtiThreadState
 773   for (JvmtiThreadState *state = JvmtiThreadState::first(); state != NULL; state = state-&gt;next()) {
 774     state-&gt;add_env(env);
 775     assert((JvmtiEnv*)(state-&gt;env_thread_state(env)-&gt;get_env()) == env, &quot;sanity check&quot;);
 776   }
 777   JvmtiEventControllerPrivate::recompute_enabled();
 778 }
 779 
 780 
 781 void
 782 JvmtiEventControllerPrivate::env_dispose(JvmtiEnvBase *env) {
 783   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 784   EC_TRACE((&quot;[*] # env dispose&quot;));
 785 
 786   // Before the environment is marked disposed, disable all events on this
 787   // environment (by zapping the callbacks).  As a result, the disposed
 788   // environment will not call event handlers.
 789   set_event_callbacks(env, NULL, 0);
 790   for (jint extension_event_index = EXT_MIN_EVENT_TYPE_VAL;
 791        extension_event_index &lt;= EXT_MAX_EVENT_TYPE_VAL;
 792        ++extension_event_index) {
 793     set_extension_event_callback(env, extension_event_index, NULL);
 794   }
 795 
 796   // Let the environment finish disposing itself.
 797   env-&gt;env_dispose();
 798 }
 799 
 800 
 801 void
 802 JvmtiEventControllerPrivate::set_user_enabled(JvmtiEnvBase *env, JavaThread *thread,
 803                                           jvmtiEvent event_type, bool enabled) {
 804   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 805 
 806   EC_TRACE((&quot;[%s] # user %s event %s&quot;,
 807             thread==NULL? &quot;ALL&quot;: JvmtiTrace::safe_get_thread_name(thread),
 808             enabled? &quot;enabled&quot; : &quot;disabled&quot;, JvmtiTrace::event_name(event_type)));
 809 
 810   if (thread == NULL) {
 811     env-&gt;env_event_enable()-&gt;set_user_enabled(event_type, enabled);
 812   } else {
 813     // create the thread state (if it didn&#39;t exist before)
 814     JvmtiThreadState *state = JvmtiThreadState::state_for_while_locked(thread);
 815     if (state != NULL) {
 816       state-&gt;env_thread_state(env)-&gt;event_enable()-&gt;set_user_enabled(event_type, enabled);
 817     }
 818   }
 819   recompute_enabled();
 820 }
 821 
 822 
 823 void
 824 JvmtiEventControllerPrivate::set_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 825   EC_TRACE((&quot;[%s] # set frame pop - frame=%d&quot;,
 826             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 827             fpop.frame_number() ));
 828 
 829   ets-&gt;get_frame_pops()-&gt;set(fpop);
 830   recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 831 }
 832 
 833 
 834 void
 835 JvmtiEventControllerPrivate::clear_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 836   EC_TRACE((&quot;[%s] # clear frame pop - frame=%d&quot;,
 837             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 838             fpop.frame_number() ));
 839 
 840   ets-&gt;get_frame_pops()-&gt;clear(fpop);
 841   recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 842 }
 843 
 844 
 845 void
 846 JvmtiEventControllerPrivate::clear_to_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
 847   int cleared_cnt = ets-&gt;get_frame_pops()-&gt;clear_to(fpop);
 848 
 849   EC_TRACE((&quot;[%s] # clear to frame pop - frame=%d, count=%d&quot;,
 850             JvmtiTrace::safe_get_thread_name(ets-&gt;get_thread()),
 851             fpop.frame_number(),
 852             cleared_cnt ));
 853 
 854   if (cleared_cnt &gt; 0) {
 855     recompute_thread_enabled(ets-&gt;get_thread()-&gt;jvmti_thread_state());
 856   }
 857 }
 858 
 859 void
 860 JvmtiEventControllerPrivate::change_field_watch(jvmtiEvent event_type, bool added) {
 861   int *count_addr;
 862 
 863   switch (event_type) {
 864   case JVMTI_EVENT_FIELD_MODIFICATION:
 865     count_addr = (int *)JvmtiExport::get_field_modification_count_addr();
 866     break;
 867   case JVMTI_EVENT_FIELD_ACCESS:
 868     count_addr = (int *)JvmtiExport::get_field_access_count_addr();
 869     break;
 870   default:
 871     assert(false, &quot;incorrect event&quot;);
 872     return;
 873   }
 874 
 875   EC_TRACE((&quot;[-] # change field watch - %s %s count=%d&quot;,
 876             event_type==JVMTI_EVENT_FIELD_MODIFICATION? &quot;modification&quot; : &quot;access&quot;,
 877             added? &quot;add&quot; : &quot;remove&quot;,
 878             *count_addr));
 879 
 880   if (added) {
 881     (*count_addr)++;
 882     if (*count_addr == 1) {
 883       recompute_enabled();
 884     }
 885   } else {
 886     if (*count_addr &gt; 0) {
 887       (*count_addr)--;
 888       if (*count_addr == 0) {
 889         recompute_enabled();
 890       }
 891     } else {
 892       assert(false, &quot;field watch out of phase&quot;);
 893     }
 894   }
 895 }
 896 
 897 void
 898 JvmtiEventControllerPrivate::event_init() {
 899   assert(JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 900 
 901   if (_initialized) {
 902     return;
 903   }
 904 
 905   EC_TRACE((&quot;[-] # VM live&quot;));
 906 
 907 #ifdef ASSERT
 908   // check that our idea and the spec&#39;s idea of threaded events match
 909   for (int ei = JVMTI_MIN_EVENT_TYPE_VAL; ei &lt;= JVMTI_MAX_EVENT_TYPE_VAL; ++ei) {
 910     jlong bit = JvmtiEventEnabled::bit_for((jvmtiEvent)ei);
 911     assert(((THREAD_FILTERED_EVENT_BITS &amp; bit) != 0) == JvmtiUtil::event_threaded(ei),
 912            &quot;thread filtered event list does not match&quot;);
 913   }
 914 #endif
 915 
 916   _initialized = true;
 917 }
 918 
 919 void
 920 JvmtiEventControllerPrivate::vm_start() {
 921   // some events are now able to be enabled (phase has changed)
 922   JvmtiEventControllerPrivate::recompute_enabled();
 923 }
 924 
 925 
 926 void
 927 JvmtiEventControllerPrivate::vm_init() {
 928   event_init();
 929 
 930   // all the events are now able to be enabled (phase has changed)
 931   JvmtiEventControllerPrivate::recompute_enabled();
 932 }
 933 
 934 
 935 void
 936 JvmtiEventControllerPrivate::vm_death() {
 937   // events are disabled (phase has changed)
 938   JvmtiEventControllerPrivate::recompute_enabled();
 939 }
 940 
 941 
 942 ///////////////////////////////////////////////////////////////
 943 //
 944 // JvmtiEventController
 945 //
 946 
 947 JvmtiEventEnabled JvmtiEventController::_universal_global_event_enabled;
 948 
 949 bool
 950 JvmtiEventController::is_global_event(jvmtiEvent event_type) {
 951   assert(is_valid_event_type(event_type), &quot;invalid event type&quot;);
 952   jlong bit_for = ((jlong)1) &lt;&lt; (event_type - TOTAL_MIN_EVENT_TYPE_VAL);
 953   return((bit_for &amp; GLOBAL_EVENT_BITS)!=0);
 954 }
 955 
 956 void
 957 JvmtiEventController::set_user_enabled(JvmtiEnvBase *env, JavaThread *thread, jvmtiEvent event_type, bool enabled) {
 958   if (Threads::number_of_threads() == 0) {
 959     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
 960     // call the functionality without holding the JvmtiThreadState_lock.
 961     JvmtiEventControllerPrivate::set_user_enabled(env, thread, event_type, enabled);
 962   } else {
 963     MutexLocker mu(JvmtiThreadState_lock);
 964     JvmtiEventControllerPrivate::set_user_enabled(env, thread, event_type, enabled);
 965   }
 966 }
 967 
 968 
 969 void
 970 JvmtiEventController::set_event_callbacks(JvmtiEnvBase *env,
 971                                           const jvmtiEventCallbacks* callbacks,
 972                                           jint size_of_callbacks) {
 973   if (Threads::number_of_threads() == 0) {
 974     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
 975     // call the functionality without holding the JvmtiThreadState_lock.
 976     JvmtiEventControllerPrivate::set_event_callbacks(env, callbacks, size_of_callbacks);
 977   } else {
 978     MutexLocker mu(JvmtiThreadState_lock);
 979     JvmtiEventControllerPrivate::set_event_callbacks(env, callbacks, size_of_callbacks);
 980   }
 981 }
 982 
 983 void
 984 JvmtiEventController::set_extension_event_callback(JvmtiEnvBase *env,
 985                                                    jint extension_event_index,
 986                                                    jvmtiExtensionEvent callback) {
 987   if (Threads::number_of_threads() == 0) {
 988     JvmtiEventControllerPrivate::set_extension_event_callback(env, extension_event_index, callback);
 989   } else {
 990     MutexLocker mu(JvmtiThreadState_lock);
 991     JvmtiEventControllerPrivate::set_extension_event_callback(env, extension_event_index, callback);
 992   }
 993 }
 994 
 995 
 996 
 997 
 998 void
 999 JvmtiEventController::set_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
1000   MutexLockerEx mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);
1001   JvmtiEventControllerPrivate::set_frame_pop(ets, fpop);
1002 }
1003 
1004 
1005 void
1006 JvmtiEventController::clear_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
1007   MutexLockerEx mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);
1008   JvmtiEventControllerPrivate::clear_frame_pop(ets, fpop);
1009 }
1010 
1011 
1012 void
1013 JvmtiEventController::clear_to_frame_pop(JvmtiEnvThreadState *ets, JvmtiFramePop fpop) {
1014   MutexLockerEx mu(SafepointSynchronize::is_at_safepoint() ? NULL : JvmtiThreadState_lock);
1015   JvmtiEventControllerPrivate::clear_to_frame_pop(ets, fpop);
1016 }
1017 
1018 void
1019 JvmtiEventController::change_field_watch(jvmtiEvent event_type, bool added) {
1020   MutexLocker mu(JvmtiThreadState_lock);
1021   JvmtiEventControllerPrivate::change_field_watch(event_type, added);
1022 }
1023 
1024 void
1025 JvmtiEventController::thread_started(JavaThread *thread) {
1026   // operates only on the current thread
1027   // JvmtiThreadState_lock grabbed only if needed.
1028   JvmtiEventControllerPrivate::thread_started(thread);
1029 }
1030 
1031 void
1032 JvmtiEventController::thread_ended(JavaThread *thread) {
1033   // operates only on the current thread
1034   // JvmtiThreadState_lock grabbed only if needed.
1035   JvmtiEventControllerPrivate::thread_ended(thread);
1036 }
1037 
1038 void
1039 JvmtiEventController::env_initialize(JvmtiEnvBase *env) {
1040   if (Threads::number_of_threads() == 0) {
1041     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
1042     // call the functionality without holding the JvmtiThreadState_lock.
1043     JvmtiEventControllerPrivate::env_initialize(env);
1044   } else {
1045     MutexLocker mu(JvmtiThreadState_lock);
1046     JvmtiEventControllerPrivate::env_initialize(env);
1047   }
1048 }
1049 
1050 void
1051 JvmtiEventController::env_dispose(JvmtiEnvBase *env) {
1052   if (Threads::number_of_threads() == 0) {
1053     // during early VM start-up locks don&#39;t exist, but we are safely single threaded,
1054     // call the functionality without holding the JvmtiThreadState_lock.
1055     JvmtiEventControllerPrivate::env_dispose(env);
1056   } else {
1057     MutexLocker mu(JvmtiThreadState_lock);
1058     JvmtiEventControllerPrivate::env_dispose(env);
1059   }
1060 }
1061 
1062 
1063 void
1064 JvmtiEventController::vm_start() {
1065   if (JvmtiEnvBase::environments_might_exist()) {
1066     MutexLocker mu(JvmtiThreadState_lock);
1067     JvmtiEventControllerPrivate::vm_start();
1068   }
1069 }
1070 
1071 void
1072 JvmtiEventController::vm_init() {
1073   if (JvmtiEnvBase::environments_might_exist()) {
1074     MutexLocker mu(JvmtiThreadState_lock);
1075     JvmtiEventControllerPrivate::vm_init();
1076   }
1077 }
1078 
1079 void
1080 JvmtiEventController::vm_death() {
1081   if (JvmtiEnvBase::environments_might_exist()) {
1082     MutexLocker mu(JvmtiThreadState_lock);
1083     JvmtiEventControllerPrivate::vm_death();
1084   }
1085 }
    </pre>
  </body>
</html>