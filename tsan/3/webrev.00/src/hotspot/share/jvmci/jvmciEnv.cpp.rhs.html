<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jvmci/jvmciEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
<a name="1" id="anc1"></a><span class="line-modified">  26 #include &quot;classfile/stringTable.hpp&quot;</span>
<span class="line-modified">  27 #include &quot;classfile/symbolTable.hpp&quot;</span>


  28 #include &quot;code/codeCache.hpp&quot;
<a name="2" id="anc2"></a>





  29 #include &quot;memory/oopFactory.hpp&quot;
  30 #include &quot;memory/resourceArea.hpp&quot;
  31 #include &quot;memory/universe.hpp&quot;
<a name="3" id="anc3"></a>



  32 #include &quot;oops/objArrayKlass.hpp&quot;
<a name="4" id="anc4"></a><span class="line-modified">  33 #include &quot;oops/typeArrayOop.inline.hpp&quot;</span>
<span class="line-modified">  34 #include &quot;runtime/deoptimization.hpp&quot;</span>
<span class="line-modified">  35 #include &quot;runtime/jniHandles.inline.hpp&quot;</span>
<span class="line-modified">  36 #include &quot;runtime/javaCalls.hpp&quot;</span>
<span class="line-modified">  37 #include &quot;jvmci/jniAccessMark.inline.hpp&quot;</span>




  38 #include &quot;jvmci/jvmciRuntime.hpp&quot;
<a name="5" id="anc5"></a>
  39 
<a name="6" id="anc6"></a><span class="line-modified">  40 JVMCICompileState::JVMCICompileState(CompileTask* task):</span>
  41   _task(task),
<a name="7" id="anc7"></a>
  42   _retryable(true),
  43   _failure_reason(NULL),
<a name="8" id="anc8"></a><span class="line-modified">  44   _failure_reason_on_C_heap(false) {</span>

  45   // Get Jvmti capabilities under lock to get consistent values.
  46   MutexLocker mu(JvmtiThreadState_lock);
<a name="9" id="anc9"></a><span class="line-added">  47   _jvmti_redefinition_count             = JvmtiExport::redefinition_count();</span>
  48   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint() ? 1 : 0;
  49   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables() ? 1 : 0;
  50   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions() ? 1 : 0;
  51   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame() ? 1 : 0;
  52 }
  53 
<a name="10" id="anc10"></a><span class="line-modified">  54 bool JVMCICompileState::jvmti_state_changed() const {</span>
<span class="line-added">  55   // Some classes were redefined</span>
<span class="line-added">  56   if (jvmti_redefinition_count() != JvmtiExport::redefinition_count()) {</span>
<span class="line-added">  57     return true;</span>
<span class="line-added">  58   }</span>
  59   if (!jvmti_can_access_local_variables() &amp;&amp;
  60       JvmtiExport::can_access_local_variables()) {
  61     return true;
  62   }
  63   if (!jvmti_can_hotswap_or_post_breakpoint() &amp;&amp;
  64       JvmtiExport::can_hotswap_or_post_breakpoint()) {
  65     return true;
  66   }
  67   if (!jvmti_can_post_on_exceptions() &amp;&amp;
  68       JvmtiExport::can_post_on_exceptions()) {
  69     return true;
  70   }
  71   if (!jvmti_can_pop_frame() &amp;&amp;
  72       JvmtiExport::can_pop_frame()) {
  73     return true;
  74   }
  75   return false;
  76 }
  77 
<a name="11" id="anc11"></a><span class="line-modified">  78 JavaVM* JVMCIEnv::_shared_library_javavm = NULL;</span>
<span class="line-modified">  79 void* JVMCIEnv::_shared_library_handle = NULL;</span>
<span class="line-modified">  80 char* JVMCIEnv::_shared_library_path = NULL;</span>
<span class="line-modified">  81 </span>
<span class="line-modified">  82 void JVMCIEnv::copy_saved_properties() {</span>
<span class="line-modified">  83   assert(!is_hotspot(), &quot;can only copy saved properties from HotSpot to native image&quot;);</span>
<span class="line-added">  84 </span>
<span class="line-added">  85   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">  86 </span>
<span class="line-added">  87   Klass* k = SystemDictionary::resolve_or_fail(vmSymbols::jdk_vm_ci_services_Services(), Handle(), Handle(), true, THREAD);</span>
<span class="line-added">  88   if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added">  89     JVMCIRuntime::exit_on_pending_exception(NULL, &quot;Error initializing jdk.vm.ci.services.Services&quot;);</span>
  90   }
<a name="12" id="anc12"></a><span class="line-modified">  91   InstanceKlass* ik = InstanceKlass::cast(k);</span>
<span class="line-modified">  92   if (ik-&gt;should_be_initialized()) {</span>
<span class="line-added">  93     ik-&gt;initialize(THREAD);</span>
<span class="line-added">  94     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added">  95       JVMCIRuntime::exit_on_pending_exception(NULL, &quot;Error initializing jdk.vm.ci.services.Services&quot;);</span>
<span class="line-added">  96     }</span>
  97   }
  98 
<a name="13" id="anc13"></a><span class="line-modified">  99   // Get the serialized saved properties from HotSpot</span>
<span class="line-modified"> 100   TempNewSymbol serializeSavedProperties = SymbolTable::new_symbol(&quot;serializeSavedProperties&quot;);</span>
<span class="line-modified"> 101   JavaValue result(T_OBJECT);</span>
<span class="line-added"> 102   JavaCallArguments args;</span>
<span class="line-added"> 103   JavaCalls::call_static(&amp;result, ik, serializeSavedProperties, vmSymbols::serializePropertiesToByteArray_signature(), &amp;args, THREAD);</span>
<span class="line-added"> 104   if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added"> 105     JVMCIRuntime::exit_on_pending_exception(NULL, &quot;Error calling jdk.vm.ci.services.Services.serializeSavedProperties&quot;);</span>
 106   }
<a name="14" id="anc14"></a><span class="line-modified"> 107   oop res = (oop) result.get_jobject();</span>
<span class="line-modified"> 108   assert(res-&gt;is_typeArray(), &quot;must be&quot;);</span>
<span class="line-modified"> 109   assert(TypeArrayKlass::cast(res-&gt;klass())-&gt;element_type() == T_BYTE, &quot;must be&quot;);</span>
<span class="line-modified"> 110   typeArrayOop ba = typeArrayOop(res);</span>
<span class="line-added"> 111   int serialized_properties_len = ba-&gt;length();</span>
<span class="line-added"> 112 </span>
<span class="line-added"> 113   // Copy serialized saved properties from HotSpot object into native buffer</span>
<span class="line-added"> 114   jbyte* serialized_properties = NEW_RESOURCE_ARRAY(jbyte, serialized_properties_len);</span>
<span class="line-added"> 115   memcpy(serialized_properties, ba-&gt;byte_at_addr(0), serialized_properties_len);</span>
<span class="line-added"> 116 </span>
<span class="line-added"> 117   // Copy native buffer into shared library object</span>
<span class="line-added"> 118   JVMCIPrimitiveArray buf = new_byteArray(serialized_properties_len, this);</span>
<span class="line-added"> 119   if (has_pending_exception()) {</span>
<span class="line-added"> 120     describe_pending_exception(true);</span>
<span class="line-added"> 121     fatal(&quot;Error in copy_saved_properties&quot;);</span>
<span class="line-added"> 122   }</span>
<span class="line-added"> 123   copy_bytes_from(serialized_properties, buf, 0, serialized_properties_len);</span>
<span class="line-added"> 124   if (has_pending_exception()) {</span>
<span class="line-added"> 125     describe_pending_exception(true);</span>
<span class="line-added"> 126     fatal(&quot;Error in copy_saved_properties&quot;);</span>
<span class="line-added"> 127   }</span>
<span class="line-added"> 128 </span>
<span class="line-added"> 129   // Initialize saved properties in shared library</span>
<span class="line-added"> 130   jclass servicesClass = JNIJVMCI::Services::clazz();</span>
<span class="line-added"> 131   jmethodID initializeSavedProperties = JNIJVMCI::Services::initializeSavedProperties_method();</span>
<span class="line-added"> 132   JNIAccessMark jni(this);</span>
<span class="line-added"> 133   jni()-&gt;CallStaticVoidMethod(servicesClass, initializeSavedProperties, buf.as_jobject());</span>
<span class="line-added"> 134   if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 135     jni()-&gt;ExceptionDescribe();</span>
<span class="line-added"> 136     fatal(&quot;Error calling jdk.vm.ci.services.Services.initializeSavedProperties&quot;);</span>
 137   }
<a name="15" id="anc15"></a>
 138 }
 139 
<a name="16" id="anc16"></a><span class="line-modified"> 140 JNIEnv* JVMCIEnv::init_shared_library(JavaThread* thread) {</span>
<span class="line-modified"> 141   if (_shared_library_javavm == NULL) {</span>
<span class="line-modified"> 142     MutexLocker locker(JVMCI_lock);</span>
<span class="line-modified"> 143     if (_shared_library_javavm == NULL) {</span>
<span class="line-modified"> 144       char path[JVM_MAXPATHLEN];</span>
<span class="line-modified"> 145       char ebuf[1024];</span>
<span class="line-added"> 146       if (JVMCILibPath != NULL) {</span>
<span class="line-added"> 147         if (!os::dll_locate_lib(path, sizeof(path), JVMCILibPath, JVMCI_SHARED_LIBRARY_NAME)) {</span>
<span class="line-added"> 148           vm_exit_during_initialization(&quot;Unable to create JVMCI shared library path from -XX:JVMCILibPath value&quot;, JVMCILibPath);</span>
<span class="line-added"> 149         }</span>
<span class="line-added"> 150       } else {</span>
<span class="line-added"> 151         if (!os::dll_locate_lib(path, sizeof(path), Arguments::get_dll_dir(), JVMCI_SHARED_LIBRARY_NAME)) {</span>
<span class="line-added"> 152           vm_exit_during_initialization(&quot;Unable to create path to JVMCI shared library&quot;);</span>
<span class="line-added"> 153         }</span>
<span class="line-added"> 154       }</span>
<span class="line-added"> 155 </span>
<span class="line-added"> 156       void* handle = os::dll_load(path, ebuf, sizeof ebuf);</span>
<span class="line-added"> 157       if (handle == NULL) {</span>
<span class="line-added"> 158         vm_exit_during_initialization(&quot;Unable to load JVMCI shared library&quot;, ebuf);</span>
<span class="line-added"> 159       }</span>
<span class="line-added"> 160       _shared_library_handle = handle;</span>
<span class="line-added"> 161       _shared_library_path = strdup(path);</span>
<span class="line-added"> 162       jint (*JNI_CreateJavaVM)(JavaVM **pvm, void **penv, void *args);</span>
<span class="line-added"> 163       typedef jint (*JNI_CreateJavaVM_t)(JavaVM **pvm, void **penv, void *args);</span>
<span class="line-added"> 164 </span>
<span class="line-added"> 165       JNI_CreateJavaVM = CAST_TO_FN_PTR(JNI_CreateJavaVM_t, os::dll_lookup(handle, &quot;JNI_CreateJavaVM&quot;));</span>
<span class="line-added"> 166       JNIEnv* env;</span>
<span class="line-added"> 167       if (JNI_CreateJavaVM == NULL) {</span>
<span class="line-added"> 168         vm_exit_during_initialization(&quot;Unable to find JNI_CreateJavaVM&quot;, path);</span>
<span class="line-added"> 169       }</span>
<span class="line-added"> 170 </span>
<span class="line-added"> 171       ResourceMark rm;</span>
<span class="line-added"> 172       JavaVMInitArgs vm_args;</span>
<span class="line-added"> 173       vm_args.version = JNI_VERSION_1_2;</span>
<span class="line-added"> 174       vm_args.ignoreUnrecognized = JNI_TRUE;</span>
<span class="line-added"> 175       vm_args.options = NULL;</span>
<span class="line-added"> 176       vm_args.nOptions = 0;</span>
 177 
<a name="17" id="anc17"></a><span class="line-modified"> 178       JavaVM* the_javavm = NULL;</span>
<span class="line-modified"> 179       int result = (*JNI_CreateJavaVM)(&amp;the_javavm, (void**) &amp;env, &amp;vm_args);</span>
<span class="line-modified"> 180       if (result == JNI_OK) {</span>
<span class="line-modified"> 181         guarantee(env != NULL, &quot;missing env&quot;);</span>
<span class="line-modified"> 182         _shared_library_javavm = the_javavm;</span>
<span class="line-modified"> 183         return env;</span>
<span class="line-modified"> 184       } else {</span>
<span class="line-modified"> 185         vm_exit_during_initialization(err_msg(&quot;JNI_CreateJavaVM failed with return value %d&quot;, result), path);</span>
<span class="line-modified"> 186       }</span>
<span class="line-added"> 187     }</span>
 188   }
<a name="18" id="anc18"></a><span class="line-added"> 189   return NULL;</span>
<span class="line-added"> 190 }</span>
 191 
<a name="19" id="anc19"></a><span class="line-modified"> 192 void JVMCIEnv::init_env_mode_runtime(JavaThread* thread, JNIEnv* parent_env) {</span>
<span class="line-modified"> 193   assert(thread != NULL, &quot;npe&quot;);</span>
<span class="line-modified"> 194   // By default there is only one runtime which is the compiler runtime.</span>
<span class="line-modified"> 195   _runtime = JVMCI::compiler_runtime();</span>
<span class="line-modified"> 196   _env = NULL;</span>
<span class="line-added"> 197   _pop_frame_on_close = false;</span>
<span class="line-added"> 198   _detach_on_close = false;</span>
<span class="line-added"> 199   if (!UseJVMCINativeLibrary) {</span>
<span class="line-added"> 200     // In HotSpot mode, JNI isn&#39;t used at all.</span>
<span class="line-added"> 201     _is_hotspot = true;</span>
<span class="line-added"> 202     return;</span>
 203   }
 204 
<a name="20" id="anc20"></a><span class="line-modified"> 205   if (parent_env != NULL) {</span>
<span class="line-modified"> 206     // If the parent JNI environment is non-null then figure out whether it</span>
<span class="line-modified"> 207     // is a HotSpot or shared library JNIEnv and set the state appropriately.</span>
<span class="line-modified"> 208     _is_hotspot = thread-&gt;jni_environment() == parent_env;</span>
<span class="line-modified"> 209     if (_is_hotspot) {</span>
<span class="line-modified"> 210       // Select the Java runtime</span>
<span class="line-added"> 211       _runtime = JVMCI::java_runtime();</span>
<span class="line-added"> 212       return;</span>
<span class="line-added"> 213     }</span>
<span class="line-added"> 214     _env = parent_env;</span>
<span class="line-added"> 215     return;</span>
<span class="line-added"> 216   }</span>
<span class="line-added"> 217 </span>
<span class="line-added"> 218   // Running in JVMCI shared library mode so ensure the shared library</span>
<span class="line-added"> 219   // is loaded and initialized and get a shared library JNIEnv</span>
<span class="line-added"> 220   _is_hotspot = false;</span>
<span class="line-added"> 221   _env = init_shared_library(thread);</span>
<span class="line-added"> 222 </span>
<span class="line-added"> 223   if (_env != NULL) {</span>
<span class="line-added"> 224     // Creating the JVMCI shared library VM also attaches the current thread</span>
<span class="line-added"> 225     _detach_on_close = true;</span>
<span class="line-added"> 226   } else {</span>
<span class="line-added"> 227     _shared_library_javavm-&gt;GetEnv((void**)&amp;parent_env, JNI_VERSION_1_2);</span>
<span class="line-added"> 228     if (parent_env != NULL) {</span>
<span class="line-added"> 229       // Even though there&#39;s a parent JNI env, there&#39;s no guarantee</span>
<span class="line-added"> 230       // it was opened by a JVMCIEnv scope and thus may not have</span>
<span class="line-added"> 231       // pushed a local JNI frame. As such, we use a new JNI local</span>
<span class="line-added"> 232       // frame in this scope to ensure local JNI refs are collected</span>
<span class="line-added"> 233       // in a timely manner after leaving this scope.</span>
<span class="line-added"> 234       _env = parent_env;</span>
 235     } else {
<a name="21" id="anc21"></a><span class="line-modified"> 236       ResourceMark rm; // Thread name is resource allocated</span>
<span class="line-modified"> 237       JavaVMAttachArgs attach_args;</span>
<span class="line-modified"> 238       attach_args.version = JNI_VERSION_1_2;</span>
<span class="line-modified"> 239       attach_args.name = thread-&gt;name();</span>
<span class="line-modified"> 240       attach_args.group = NULL;</span>
<span class="line-modified"> 241       if (_shared_library_javavm-&gt;AttachCurrentThread((void**)&amp;_env, &amp;attach_args) != JNI_OK) {</span>
<span class="line-modified"> 242         fatal(&quot;Error attaching current thread (%s) to JVMCI shared library JNI interface&quot;, attach_args.name);</span>































 243       }
<a name="22" id="anc22"></a><span class="line-added"> 244       _detach_on_close = true;</span>
 245     }
 246   }
 247 
<a name="23" id="anc23"></a><span class="line-modified"> 248   assert(_env != NULL, &quot;missing env&quot;);</span>
<span class="line-added"> 249   assert(_throw_to_caller == false, &quot;must be&quot;);</span>
<span class="line-added"> 250 </span>
<span class="line-added"> 251   JNIAccessMark jni(this);</span>
<span class="line-added"> 252   jint result = _env-&gt;PushLocalFrame(32);</span>
<span class="line-added"> 253   if (result != JNI_OK) {</span>
<span class="line-added"> 254     char message[256];</span>
<span class="line-added"> 255     jio_snprintf(message, 256, &quot;Uncaught exception pushing local frame for JVMCIEnv scope entered at %s:%d&quot;, _file, _line);</span>
<span class="line-added"> 256     JVMCIRuntime::exit_on_pending_exception(this, message);</span>
<span class="line-added"> 257   }</span>
<span class="line-added"> 258   _pop_frame_on_close = true;</span>
<span class="line-added"> 259 }</span>
<span class="line-added"> 260 </span>
<span class="line-added"> 261 JVMCIEnv::JVMCIEnv(JavaThread* thread, JVMCICompileState* compile_state, const char* file, int line):</span>
<span class="line-added"> 262     _throw_to_caller(false), _file(file), _line(line), _compile_state(compile_state) {</span>
<span class="line-added"> 263   init_env_mode_runtime(thread, NULL);</span>
<span class="line-added"> 264 }</span>
<span class="line-added"> 265 </span>
<span class="line-added"> 266 JVMCIEnv::JVMCIEnv(JavaThread* thread, const char* file, int line):</span>
<span class="line-added"> 267     _throw_to_caller(false), _file(file), _line(line), _compile_state(NULL) {</span>
<span class="line-added"> 268   init_env_mode_runtime(thread, NULL);</span>
<span class="line-added"> 269 }</span>
<span class="line-added"> 270 </span>
<span class="line-added"> 271 JVMCIEnv::JVMCIEnv(JavaThread* thread, JNIEnv* parent_env, const char* file, int line):</span>
<span class="line-added"> 272     _throw_to_caller(true), _file(file), _line(line), _compile_state(NULL) {</span>
<span class="line-added"> 273   init_env_mode_runtime(thread, parent_env);</span>
<span class="line-added"> 274   assert(_env == NULL || parent_env == _env, &quot;mismatched JNIEnvironment&quot;);</span>
<span class="line-added"> 275 }</span>
<span class="line-added"> 276 </span>
<span class="line-added"> 277 void JVMCIEnv::init(JavaThread* thread, bool is_hotspot, const char* file, int line) {</span>
<span class="line-added"> 278   _compile_state = NULL;</span>
<span class="line-added"> 279   _throw_to_caller = false;</span>
<span class="line-added"> 280   _file = file;</span>
<span class="line-added"> 281   _line = line;</span>
<span class="line-added"> 282   if (is_hotspot) {</span>
<span class="line-added"> 283     _env = NULL;</span>
<span class="line-added"> 284     _pop_frame_on_close = false;</span>
<span class="line-added"> 285     _detach_on_close = false;</span>
<span class="line-added"> 286     _is_hotspot = true;</span>
<span class="line-added"> 287     _runtime = JVMCI::java_runtime();</span>
<span class="line-added"> 288   } else {</span>
<span class="line-added"> 289     init_env_mode_runtime(thread, NULL);</span>
<span class="line-added"> 290   }</span>
<span class="line-added"> 291 }</span>
<span class="line-added"> 292 </span>
<span class="line-added"> 293 // Prints a pending exception (if any) and its stack trace.</span>
<span class="line-added"> 294 void JVMCIEnv::describe_pending_exception(bool clear) {</span>
<span class="line-added"> 295   if (!is_hotspot()) {</span>
<span class="line-added"> 296     JNIAccessMark jni(this);</span>
<span class="line-added"> 297     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 298       jthrowable ex = !clear ? jni()-&gt;ExceptionOccurred() : NULL;</span>
<span class="line-added"> 299       jni()-&gt;ExceptionDescribe();</span>
<span class="line-added"> 300       if (ex != NULL) {</span>
<span class="line-added"> 301         jni()-&gt;Throw(ex);</span>
<span class="line-added"> 302       }</span>
<span class="line-added"> 303     }</span>
<span class="line-added"> 304   } else {</span>
<span class="line-added"> 305     Thread* THREAD = Thread::current();</span>
<span class="line-added"> 306     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added"> 307       JVMCIRuntime::describe_pending_hotspot_exception((JavaThread*) THREAD, clear);</span>
<span class="line-added"> 308     }</span>
<span class="line-added"> 309   }</span>
 310 }
 311 
<a name="24" id="anc24"></a><span class="line-modified"> 312 void JVMCIEnv::translate_hotspot_exception_to_jni_exception(JavaThread* THREAD, const Handle&amp; throwable) {</span>
<span class="line-modified"> 313   assert(!is_hotspot(), &quot;must_be&quot;);</span>
<span class="line-modified"> 314   // Resolve HotSpotJVMCIRuntime class explicitly as HotSpotJVMCI::compute_offsets</span>
<span class="line-modified"> 315   // may not have been called.</span>
<span class="line-added"> 316   Klass* runtimeKlass = SystemDictionary::resolve_or_fail(vmSymbols::jdk_vm_ci_hotspot_HotSpotJVMCIRuntime(), true, CHECK);</span>
<span class="line-added"> 317   JavaCallArguments jargs;</span>
<span class="line-added"> 318   jargs.push_oop(throwable);</span>
<span class="line-added"> 319   JavaValue result(T_OBJECT);</span>
<span class="line-added"> 320   JavaCalls::call_static(&amp;result,</span>
<span class="line-added"> 321                           runtimeKlass,</span>
<span class="line-added"> 322                           vmSymbols::encodeThrowable_name(),</span>
<span class="line-added"> 323                           vmSymbols::encodeThrowable_signature(), &amp;jargs, THREAD);</span>
<span class="line-added"> 324   if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added"> 325     JVMCIRuntime::exit_on_pending_exception(this, &quot;HotSpotJVMCIRuntime.encodeThrowable should not throw an exception&quot;);</span>
<span class="line-added"> 326   }</span>
<span class="line-added"> 327 </span>
<span class="line-added"> 328   oop encoded_throwable_string = (oop) result.get_jobject();</span>
<span class="line-added"> 329 </span>
 330   ResourceMark rm;
<a name="25" id="anc25"></a><span class="line-modified"> 331   const char* encoded_throwable_chars = java_lang_String::as_utf8_string(encoded_throwable_string);</span>
<span class="line-modified"> 332 </span>
<span class="line-modified"> 333   JNIAccessMark jni(this);</span>
<span class="line-modified"> 334   jobject jni_encoded_throwable_string = jni()-&gt;NewStringUTF(encoded_throwable_chars);</span>
<span class="line-modified"> 335   jthrowable jni_throwable = (jthrowable) jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotJVMCIRuntime::clazz(),</span>
<span class="line-modified"> 336                                 JNIJVMCI::HotSpotJVMCIRuntime::decodeThrowable_method(),</span>
<span class="line-modified"> 337                                 jni_encoded_throwable_string);</span>
<span class="line-modified"> 338   jni()-&gt;Throw(jni_throwable);</span>
<span class="line-modified"> 339 }</span>
<span class="line-modified"> 340 </span>
<span class="line-modified"> 341 JVMCIEnv::~JVMCIEnv() {</span>
<span class="line-modified"> 342   if (_throw_to_caller) {</span>
<span class="line-modified"> 343     if (is_hotspot()) {</span>
<span class="line-modified"> 344       // Nothing to do</span>



















 345     } else {
<a name="26" id="anc26"></a><span class="line-modified"> 346       if (Thread::current()-&gt;is_Java_thread()) {</span>
<span class="line-modified"> 347         JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 348         if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added"> 349           Handle throwable = Handle(THREAD, PENDING_EXCEPTION);</span>
<span class="line-added"> 350           CLEAR_PENDING_EXCEPTION;</span>
<span class="line-added"> 351           translate_hotspot_exception_to_jni_exception(THREAD, throwable);</span>
<span class="line-added"> 352         }</span>
<span class="line-added"> 353       }</span>
<span class="line-added"> 354     }</span>
<span class="line-added"> 355   } else {</span>
<span class="line-added"> 356     if (_pop_frame_on_close) {</span>
<span class="line-added"> 357       // Pop the JNI local frame that was pushed when entering this JVMCIEnv scope.</span>
<span class="line-added"> 358       JNIAccessMark jni(this);</span>
<span class="line-added"> 359       jni()-&gt;PopLocalFrame(NULL);</span>
 360     }
<a name="27" id="anc27"></a><span class="line-modified"> 361 </span>
<span class="line-modified"> 362     if (has_pending_exception()) {</span>
<span class="line-added"> 363       char message[256];</span>
<span class="line-added"> 364       jio_snprintf(message, 256, &quot;Uncaught exception exiting JVMCIEnv scope entered at %s:%d&quot;, _file, _line);</span>
<span class="line-added"> 365       JVMCIRuntime::exit_on_pending_exception(this, message);</span>
<span class="line-added"> 366     }</span>
<span class="line-added"> 367 </span>
<span class="line-added"> 368     if (_detach_on_close) {</span>
<span class="line-added"> 369       get_shared_library_javavm()-&gt;DetachCurrentThread();</span>
 370     }
<a name="28" id="anc28"></a>
 371   }
<a name="29" id="anc29"></a><span class="line-added"> 372 }</span>
 373 
<a name="30" id="anc30"></a><span class="line-modified"> 374 jboolean JVMCIEnv::has_pending_exception() {</span>
<span class="line-modified"> 375   if (is_hotspot()) {</span>
<span class="line-modified"> 376     Thread* THREAD = Thread::current();</span>
<span class="line-added"> 377     return HAS_PENDING_EXCEPTION;</span>
<span class="line-added"> 378   } else {</span>
<span class="line-added"> 379     JNIAccessMark jni(this);</span>
<span class="line-added"> 380     return jni()-&gt;ExceptionCheck();</span>
<span class="line-added"> 381   }</span>
 382 }
 383 
<a name="31" id="anc31"></a><span class="line-modified"> 384 void JVMCIEnv::clear_pending_exception() {</span>
<span class="line-modified"> 385   if (is_hotspot()) {</span>
<span class="line-modified"> 386     Thread* THREAD = Thread::current();</span>
<span class="line-modified"> 387     CLEAR_PENDING_EXCEPTION;</span>
<span class="line-modified"> 388   } else {</span>
<span class="line-modified"> 389     JNIAccessMark jni(this);</span>
<span class="line-modified"> 390     jni()-&gt;ExceptionClear();</span>
<span class="line-modified"> 391   }</span>
 392 }
 393 
<a name="32" id="anc32"></a><span class="line-modified"> 394 int JVMCIEnv::get_length(JVMCIArray array) {</span>
<span class="line-modified"> 395   if (is_hotspot()) {</span>
<span class="line-modified"> 396     return HotSpotJVMCI::resolve(array)-&gt;length();</span>
<span class="line-modified"> 397   } else {</span>
<span class="line-modified"> 398     JNIAccessMark jni(this);</span>
<span class="line-modified"> 399     return jni()-&gt;GetArrayLength(get_jarray(array));</span>
<span class="line-modified"> 400   }</span>
<span class="line-modified"> 401 }</span>
 402 
<a name="33" id="anc33"></a><span class="line-modified"> 403 JVMCIObject JVMCIEnv::get_object_at(JVMCIObjectArray array, int index) {</span>
<span class="line-added"> 404   if (is_hotspot()) {</span>
<span class="line-added"> 405     oop result = HotSpotJVMCI::resolve(array)-&gt;obj_at(index);</span>
<span class="line-added"> 406     return wrap(result);</span>
<span class="line-added"> 407   } else {</span>
<span class="line-added"> 408     JNIAccessMark jni(this);</span>
<span class="line-added"> 409     jobject result = jni()-&gt;GetObjectArrayElement(get_jobjectArray(array), index);</span>
<span class="line-added"> 410     return wrap(result);</span>
<span class="line-added"> 411   }</span>
<span class="line-added"> 412 }</span>
 413 
<a name="34" id="anc34"></a><span class="line-modified"> 414 void JVMCIEnv::put_object_at(JVMCIObjectArray array, int index, JVMCIObject value) {</span>
<span class="line-added"> 415   if (is_hotspot()) {</span>
<span class="line-added"> 416     HotSpotJVMCI::resolve(array)-&gt;obj_at_put(index, HotSpotJVMCI::resolve(value));</span>
<span class="line-added"> 417   } else {</span>
<span class="line-added"> 418     JNIAccessMark jni(this);</span>
<span class="line-added"> 419     jni()-&gt;SetObjectArrayElement(get_jobjectArray(array), index, get_jobject(value));</span>
<span class="line-added"> 420   }</span>
<span class="line-added"> 421 }</span>
 422 
<a name="35" id="anc35"></a><span class="line-modified"> 423 jboolean JVMCIEnv::get_bool_at(JVMCIPrimitiveArray array, int index) {</span>
<span class="line-modified"> 424   if (is_hotspot()) {</span>
<span class="line-added"> 425     return HotSpotJVMCI::resolve(array)-&gt;bool_at(index);</span>
<span class="line-added"> 426   } else {</span>
<span class="line-added"> 427     JNIAccessMark jni(this);</span>
<span class="line-added"> 428     jboolean result;</span>
<span class="line-added"> 429     jni()-&gt;GetBooleanArrayRegion(array.as_jbooleanArray(), index, 1, &amp;result);</span>
<span class="line-added"> 430     return result;</span>
<span class="line-added"> 431   }</span>
<span class="line-added"> 432 }</span>
<span class="line-added"> 433 void JVMCIEnv::put_bool_at(JVMCIPrimitiveArray array, int index, jboolean value) {</span>
<span class="line-added"> 434   if (is_hotspot()) {</span>
<span class="line-added"> 435     HotSpotJVMCI::resolve(array)-&gt;bool_at_put(index, value);</span>
<span class="line-added"> 436   } else {</span>
<span class="line-added"> 437     JNIAccessMark jni(this);</span>
<span class="line-added"> 438     jni()-&gt;SetBooleanArrayRegion(array.as_jbooleanArray(), index, 1, &amp;value);</span>
<span class="line-added"> 439   }</span>
<span class="line-added"> 440 }</span>
 441 
<a name="36" id="anc36"></a><span class="line-modified"> 442 jbyte JVMCIEnv::get_byte_at(JVMCIPrimitiveArray array, int index) {</span>
<span class="line-modified"> 443   if (is_hotspot()) {</span>
<span class="line-modified"> 444     return HotSpotJVMCI::resolve(array)-&gt;byte_at(index);</span>
<span class="line-added"> 445   } else {</span>
<span class="line-added"> 446     JNIAccessMark jni(this);</span>
<span class="line-added"> 447     jbyte result;</span>
<span class="line-added"> 448     jni()-&gt;GetByteArrayRegion(array.as_jbyteArray(), index, 1, &amp;result);</span>
<span class="line-added"> 449     return result;</span>
<span class="line-added"> 450   }</span>
<span class="line-added"> 451 }</span>
<span class="line-added"> 452 void JVMCIEnv::put_byte_at(JVMCIPrimitiveArray array, int index, jbyte value) {</span>
<span class="line-added"> 453   if (is_hotspot()) {</span>
<span class="line-added"> 454     HotSpotJVMCI::resolve(array)-&gt;byte_at_put(index, value);</span>
<span class="line-added"> 455   } else {</span>
<span class="line-added"> 456     JNIAccessMark jni(this);</span>
<span class="line-added"> 457     jni()-&gt;SetByteArrayRegion(array.as_jbyteArray(), index, 1, &amp;value);</span>
<span class="line-added"> 458   }</span>
<span class="line-added"> 459 }</span>
 460 
<a name="37" id="anc37"></a><span class="line-modified"> 461 jint JVMCIEnv::get_int_at(JVMCIPrimitiveArray array, int index) {</span>
<span class="line-modified"> 462   if (is_hotspot()) {</span>
<span class="line-modified"> 463     return HotSpotJVMCI::resolve(array)-&gt;int_at(index);</span>
<span class="line-modified"> 464   } else {</span>
<span class="line-modified"> 465     JNIAccessMark jni(this);</span>
<span class="line-modified"> 466     jint result;</span>
<span class="line-added"> 467     jni()-&gt;GetIntArrayRegion(array.as_jintArray(), index, 1, &amp;result);</span>
<span class="line-added"> 468     return result;</span>
<span class="line-added"> 469   }</span>
<span class="line-added"> 470 }</span>
<span class="line-added"> 471 void JVMCIEnv::put_int_at(JVMCIPrimitiveArray array, int index, jint value) {</span>
<span class="line-added"> 472   if (is_hotspot()) {</span>
<span class="line-added"> 473     HotSpotJVMCI::resolve(array)-&gt;int_at_put(index, value);</span>
<span class="line-added"> 474   } else {</span>
<span class="line-added"> 475     JNIAccessMark jni(this);</span>
<span class="line-added"> 476     jni()-&gt;SetIntArrayRegion(array.as_jintArray(), index, 1, &amp;value);</span>
<span class="line-added"> 477   }</span>
<span class="line-added"> 478 }</span>
 479 
<a name="38" id="anc38"></a><span class="line-modified"> 480 long JVMCIEnv::get_long_at(JVMCIPrimitiveArray array, int index) {</span>
<span class="line-modified"> 481   if (is_hotspot()) {</span>
<span class="line-modified"> 482     return HotSpotJVMCI::resolve(array)-&gt;long_at(index);</span>
<span class="line-modified"> 483   } else {</span>
<span class="line-added"> 484     JNIAccessMark jni(this);</span>
<span class="line-added"> 485     jlong result;</span>
<span class="line-added"> 486     jni()-&gt;GetLongArrayRegion(array.as_jlongArray(), index, 1, &amp;result);</span>
<span class="line-added"> 487     return result;</span>
<span class="line-added"> 488   }</span>
<span class="line-added"> 489 }</span>
<span class="line-added"> 490 void JVMCIEnv::put_long_at(JVMCIPrimitiveArray array, int index, jlong value) {</span>
<span class="line-added"> 491   if (is_hotspot()) {</span>
<span class="line-added"> 492     HotSpotJVMCI::resolve(array)-&gt;long_at_put(index, value);</span>
<span class="line-added"> 493   } else {</span>
<span class="line-added"> 494     JNIAccessMark jni(this);</span>
<span class="line-added"> 495     jni()-&gt;SetLongArrayRegion(array.as_jlongArray(), index, 1, &amp;value);</span>
 496   }
<a name="39" id="anc39"></a><span class="line-added"> 497 }</span>
 498 
<a name="40" id="anc40"></a><span class="line-added"> 499 void JVMCIEnv::copy_bytes_to(JVMCIPrimitiveArray src, jbyte* dest, int offset, jsize length) {</span>
<span class="line-added"> 500   if (length == 0) {</span>
<span class="line-added"> 501     return;</span>
<span class="line-added"> 502   }</span>
<span class="line-added"> 503   if (is_hotspot()) {</span>
<span class="line-added"> 504     memcpy(dest, HotSpotJVMCI::resolve(src)-&gt;byte_at_addr(offset), length);</span>
<span class="line-added"> 505   } else {</span>
<span class="line-added"> 506     JNIAccessMark jni(this);</span>
<span class="line-added"> 507     jni()-&gt;GetByteArrayRegion(src.as_jbyteArray(), offset, length, dest);</span>
<span class="line-added"> 508   }</span>
<span class="line-added"> 509 }</span>
<span class="line-added"> 510 void JVMCIEnv::copy_bytes_from(jbyte* src, JVMCIPrimitiveArray dest, int offset, jsize length) {</span>
<span class="line-added"> 511   if (length == 0) {</span>
<span class="line-added"> 512     return;</span>
<span class="line-added"> 513   }</span>
<span class="line-added"> 514   if (is_hotspot()) {</span>
<span class="line-added"> 515     memcpy(HotSpotJVMCI::resolve(dest)-&gt;byte_at_addr(offset), src, length);</span>
<span class="line-added"> 516   } else {</span>
<span class="line-added"> 517     JNIAccessMark jni(this);</span>
<span class="line-added"> 518     jni()-&gt;SetByteArrayRegion(dest.as_jbyteArray(), offset, length, src);</span>
<span class="line-added"> 519   }</span>
<span class="line-added"> 520 }</span>
 521 
<a name="41" id="anc41"></a><span class="line-modified"> 522 void JVMCIEnv::copy_longs_from(jlong* src, JVMCIPrimitiveArray dest, int offset, jsize length) {</span>
<span class="line-modified"> 523   if (length == 0) {</span>


 524     return;
 525   }
<a name="42" id="anc42"></a><span class="line-added"> 526   if (is_hotspot()) {</span>
<span class="line-added"> 527     memcpy(HotSpotJVMCI::resolve(dest)-&gt;long_at_addr(offset), src, length * sizeof(jlong));</span>
<span class="line-added"> 528   } else {</span>
<span class="line-added"> 529     JNIAccessMark jni(this);</span>
<span class="line-added"> 530     jni()-&gt;SetLongArrayRegion(dest.as_jlongArray(), offset, length, src);</span>
<span class="line-added"> 531   }</span>
<span class="line-added"> 532 }</span>
 533 
<a name="43" id="anc43"></a><span class="line-modified"> 534 jboolean JVMCIEnv::is_boxing_object(BasicType type, JVMCIObject object) {</span>
<span class="line-added"> 535   if (is_hotspot()) {</span>
<span class="line-added"> 536     return java_lang_boxing_object::is_instance(HotSpotJVMCI::resolve(object), type);</span>
<span class="line-added"> 537   } else {</span>
<span class="line-added"> 538     JNIAccessMark jni(this);</span>
<span class="line-added"> 539     return jni()-&gt;IsInstanceOf(get_jobject(object), JNIJVMCI::box_class(type));</span>
<span class="line-added"> 540   }</span>
 541 }
 542 
<a name="44" id="anc44"></a><span class="line-modified"> 543 // Get the primitive value from a Java boxing object.  It&#39;s hard error to</span>
<span class="line-modified"> 544 // pass a non-primitive BasicType.</span>
<span class="line-modified"> 545 jvalue JVMCIEnv::get_boxed_value(BasicType type, JVMCIObject object) {</span>
<span class="line-modified"> 546   jvalue result;</span>
<span class="line-modified"> 547   if (is_hotspot()) {</span>
<span class="line-modified"> 548     if (java_lang_boxing_object::get_value(HotSpotJVMCI::resolve(object), &amp;result) == T_ILLEGAL) {</span>
<span class="line-modified"> 549       ShouldNotReachHere();</span>
<span class="line-modified"> 550     }</span>
<span class="line-modified"> 551   } else {</span>
<span class="line-modified"> 552     JNIAccessMark jni(this);</span>
<span class="line-modified"> 553     jfieldID field = JNIJVMCI::box_field(type);</span>
<span class="line-modified"> 554     switch (type) {</span>
<span class="line-modified"> 555       case T_BOOLEAN: result.z = jni()-&gt;GetBooleanField(get_jobject(object), field); break;</span>
<span class="line-modified"> 556       case T_BYTE:    result.b = jni()-&gt;GetByteField(get_jobject(object), field); break;</span>
<span class="line-modified"> 557       case T_SHORT:   result.s = jni()-&gt;GetShortField(get_jobject(object), field); break;</span>
<span class="line-modified"> 558       case T_CHAR:    result.c = jni()-&gt;GetCharField(get_jobject(object), field); break;</span>
<span class="line-modified"> 559       case T_INT:     result.i = jni()-&gt;GetIntField(get_jobject(object), field); break;</span>
<span class="line-modified"> 560       case T_LONG:    result.j = jni()-&gt;GetLongField(get_jobject(object), field); break;</span>
<span class="line-modified"> 561       case T_FLOAT:   result.f = jni()-&gt;GetFloatField(get_jobject(object), field); break;</span>
<span class="line-modified"> 562       case T_DOUBLE:  result.d = jni()-&gt;GetDoubleField(get_jobject(object), field); break;</span>
<span class="line-modified"> 563       default:</span>
<span class="line-modified"> 564         ShouldNotReachHere();</span>



































 565     }
<a name="45" id="anc45"></a><span class="line-added"> 566   }</span>
<span class="line-added"> 567   return result;</span>
<span class="line-added"> 568 }</span>
 569 
<a name="46" id="anc46"></a><span class="line-modified"> 570 // Return the BasicType of the object if it&#39;s a boxing object, otherwise return T_ILLEGAL.</span>
<span class="line-added"> 571 BasicType JVMCIEnv::get_box_type(JVMCIObject object) {</span>
<span class="line-added"> 572   if (is_hotspot()) {</span>
<span class="line-added"> 573     return java_lang_boxing_object::basic_type(HotSpotJVMCI::resolve(object));</span>
<span class="line-added"> 574   } else {</span>
<span class="line-added"> 575     JNIAccessMark jni(this);</span>
<span class="line-added"> 576     jclass clazz = jni()-&gt;GetObjectClass(get_jobject(object));</span>
<span class="line-added"> 577     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_BOOLEAN))) return T_BOOLEAN;</span>
<span class="line-added"> 578     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_BYTE))) return T_BYTE;</span>
<span class="line-added"> 579     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_SHORT))) return T_SHORT;</span>
<span class="line-added"> 580     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_CHAR))) return T_CHAR;</span>
<span class="line-added"> 581     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_INT))) return T_INT;</span>
<span class="line-added"> 582     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_LONG))) return T_LONG;</span>
<span class="line-added"> 583     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_FLOAT))) return T_FLOAT;</span>
<span class="line-added"> 584     if (jni()-&gt;IsSameObject(clazz, JNIJVMCI::box_class(T_DOUBLE))) return T_DOUBLE;</span>
<span class="line-added"> 585     return T_ILLEGAL;</span>
 586   }
<a name="47" id="anc47"></a><span class="line-added"> 587 }</span>
 588 
<a name="48" id="anc48"></a><span class="line-modified"> 589 // Create a boxing object of the appropriate primitive type.</span>
<span class="line-modified"> 590 JVMCIObject JVMCIEnv::create_box(BasicType type, jvalue* value, JVMCI_TRAPS) {</span>
<span class="line-modified"> 591   switch (type) {</span>
<span class="line-modified"> 592     case T_BOOLEAN:</span>
<span class="line-modified"> 593     case T_BYTE:</span>
<span class="line-modified"> 594     case T_CHAR:</span>
<span class="line-modified"> 595     case T_SHORT:</span>
<span class="line-modified"> 596     case T_INT:</span>
<span class="line-modified"> 597     case T_LONG:</span>
<span class="line-modified"> 598     case T_FLOAT:</span>
<span class="line-modified"> 599     case T_DOUBLE:</span>














 600       break;
 601     default:
<a name="49" id="anc49"></a><span class="line-modified"> 602       JVMCI_THROW_MSG_(IllegalArgumentException, &quot;Only boxes for primitive values can be created&quot;, JVMCIObject());</span>
<span class="line-added"> 603   }</span>
<span class="line-added"> 604   if (is_hotspot()) {</span>
<span class="line-added"> 605     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 606     oop box = java_lang_boxing_object::create(type, value, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 607     return HotSpotJVMCI::wrap(box);</span>
<span class="line-added"> 608   } else {</span>
<span class="line-added"> 609     JNIAccessMark jni(this);</span>
<span class="line-added"> 610     jobject box = jni()-&gt;NewObjectA(JNIJVMCI::box_class(type), JNIJVMCI::box_constructor(type), value);</span>
<span class="line-added"> 611     assert(box != NULL, &quot;&quot;);</span>
<span class="line-added"> 612     return wrap(box);</span>
<span class="line-added"> 613   }</span>
<span class="line-added"> 614 }</span>
<span class="line-added"> 615 </span>
<span class="line-added"> 616 const char* JVMCIEnv::as_utf8_string(JVMCIObject str) {</span>
<span class="line-added"> 617   if (is_hotspot()) {</span>
<span class="line-added"> 618     return java_lang_String::as_utf8_string(HotSpotJVMCI::resolve(str));</span>
<span class="line-added"> 619   } else {</span>
<span class="line-added"> 620     JNIAccessMark jni(this);</span>
<span class="line-added"> 621     int length = jni()-&gt;GetStringLength(str.as_jstring());</span>
<span class="line-added"> 622     char* result = NEW_RESOURCE_ARRAY(char, length + 1);</span>
<span class="line-added"> 623     jni()-&gt;GetStringUTFRegion(str.as_jstring(), 0, length, result);</span>
<span class="line-added"> 624     return result;</span>
<span class="line-added"> 625   }</span>
<span class="line-added"> 626 }</span>
<span class="line-added"> 627 </span>
<span class="line-added"> 628 char* JVMCIEnv::as_utf8_string(JVMCIObject str, char* buf, int buflen) {</span>
<span class="line-added"> 629   if (is_hotspot()) {</span>
<span class="line-added"> 630     return java_lang_String::as_utf8_string(HotSpotJVMCI::resolve(str), buf, buflen);</span>
<span class="line-added"> 631   } else {</span>
<span class="line-added"> 632     JNIAccessMark jni(this);</span>
<span class="line-added"> 633     int length = jni()-&gt;GetStringLength(str.as_jstring());</span>
<span class="line-added"> 634     if (length &gt;= buflen) {</span>
<span class="line-added"> 635       length = buflen;</span>
 636     }
<a name="50" id="anc50"></a><span class="line-added"> 637     jni()-&gt;GetStringUTFRegion(str.as_jstring(), 0, length, buf);</span>
<span class="line-added"> 638     return buf;</span>
<span class="line-added"> 639   }</span>
<span class="line-added"> 640 }</span>
<span class="line-added"> 641 </span>
<span class="line-added"> 642 #define DO_THROW(name)                             \</span>
<span class="line-added"> 643 void JVMCIEnv::throw_##name(const char* msg) {     \</span>
<span class="line-added"> 644   if (is_hotspot()) {                              \</span>
<span class="line-added"> 645     JavaThread* THREAD = JavaThread::current();    \</span>
<span class="line-added"> 646     THROW_MSG(HotSpotJVMCI::name::symbol(), msg);  \</span>
<span class="line-added"> 647   } else {                                         \</span>
<span class="line-added"> 648     JNIAccessMark jni(this);                       \</span>
<span class="line-added"> 649     jni()-&gt;ThrowNew(JNIJVMCI::name::clazz(), msg); \</span>
<span class="line-added"> 650   }                                                \</span>
<span class="line-added"> 651 }</span>
<span class="line-added"> 652 </span>
<span class="line-added"> 653 DO_THROW(InternalError)</span>
<span class="line-added"> 654 DO_THROW(ArrayIndexOutOfBoundsException)</span>
<span class="line-added"> 655 DO_THROW(IllegalStateException)</span>
<span class="line-added"> 656 DO_THROW(NullPointerException)</span>
<span class="line-added"> 657 DO_THROW(IllegalArgumentException)</span>
<span class="line-added"> 658 DO_THROW(InvalidInstalledCodeException)</span>
<span class="line-added"> 659 DO_THROW(UnsatisfiedLinkError)</span>
<span class="line-added"> 660 DO_THROW(UnsupportedOperationException)</span>
<span class="line-added"> 661 DO_THROW(ClassNotFoundException)</span>
<span class="line-added"> 662 </span>
<span class="line-added"> 663 #undef DO_THROW</span>
<span class="line-added"> 664 </span>
<span class="line-added"> 665 void JVMCIEnv::fthrow_error(const char* file, int line, const char* format, ...) {</span>
<span class="line-added"> 666   const int max_msg_size = 1024;</span>
<span class="line-added"> 667   va_list ap;</span>
<span class="line-added"> 668   va_start(ap, format);</span>
<span class="line-added"> 669   char msg[max_msg_size];</span>
<span class="line-added"> 670   vsnprintf(msg, max_msg_size, format, ap);</span>
<span class="line-added"> 671   msg[max_msg_size-1] = &#39;\0&#39;;</span>
<span class="line-added"> 672   va_end(ap);</span>
<span class="line-added"> 673   if (is_hotspot()) {</span>
<span class="line-added"> 674     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 675     Handle h_loader = Handle();</span>
<span class="line-added"> 676     Handle h_protection_domain = Handle();</span>
<span class="line-added"> 677     Exceptions::_throw_msg(THREAD, file, line, vmSymbols::jdk_vm_ci_common_JVMCIError(), msg, h_loader, h_protection_domain);</span>
<span class="line-added"> 678   } else {</span>
<span class="line-added"> 679     JNIAccessMark jni(this);</span>
<span class="line-added"> 680     jni()-&gt;ThrowNew(JNIJVMCI::JVMCIError::clazz(), msg);</span>
 681   }
<a name="51" id="anc51"></a><span class="line-added"> 682 }</span>
 683 
<a name="52" id="anc52"></a><span class="line-modified"> 684 JVMCIObject JVMCIEnv::call_HotSpotJVMCIRuntime_compileMethod (JVMCIObject runtime, JVMCIObject method, int entry_bci,</span>
<span class="line-modified"> 685                                                               jlong compile_state, int id) {</span>
<span class="line-modified"> 686   if (is_hotspot()) {</span>
<span class="line-modified"> 687     Thread* THREAD = Thread::current();</span>
<span class="line-modified"> 688     JavaCallArguments jargs;</span>
<span class="line-modified"> 689     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(runtime)));</span>
<span class="line-added"> 690     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(method)));</span>
<span class="line-added"> 691     jargs.push_int(entry_bci);</span>
<span class="line-added"> 692     jargs.push_long(compile_state);</span>
<span class="line-added"> 693     jargs.push_int(id);</span>
<span class="line-added"> 694     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 695     JavaCalls::call_special(&amp;result,</span>
<span class="line-added"> 696                             HotSpotJVMCI::HotSpotJVMCIRuntime::klass(),</span>
<span class="line-added"> 697                             vmSymbols::compileMethod_name(),</span>
<span class="line-added"> 698                             vmSymbols::compileMethod_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 699     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 700   } else {</span>
<span class="line-added"> 701     JNIAccessMark jni(this);</span>
<span class="line-added"> 702     jobject result = jni()-&gt;CallNonvirtualObjectMethod(runtime.as_jobject(),</span>
<span class="line-added"> 703                                                      JNIJVMCI::HotSpotJVMCIRuntime::clazz(),</span>
<span class="line-added"> 704                                                      JNIJVMCI::HotSpotJVMCIRuntime::compileMethod_method(),</span>
<span class="line-added"> 705                                                      method.as_jobject(), entry_bci, compile_state, id);</span>
<span class="line-added"> 706     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 707       return JVMCIObject();</span>
 708     }
<a name="53" id="anc53"></a><span class="line-added"> 709     return wrap(result);</span>
 710   }
<a name="54" id="anc54"></a><span class="line-added"> 711 }</span>
 712 
<a name="55" id="anc55"></a><span class="line-modified"> 713 void JVMCIEnv::call_HotSpotJVMCIRuntime_bootstrapFinished (JVMCIObject runtime, JVMCIEnv* JVMCIENV) {</span>
<span class="line-modified"> 714   if (is_hotspot()) {</span>
<span class="line-added"> 715     Thread* THREAD = Thread::current();</span>
<span class="line-added"> 716     JavaCallArguments jargs;</span>
<span class="line-added"> 717     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(runtime)));</span>
<span class="line-added"> 718     JavaValue result(T_VOID);</span>
<span class="line-added"> 719     JavaCalls::call_special(&amp;result, HotSpotJVMCI::HotSpotJVMCIRuntime::klass(), vmSymbols::bootstrapFinished_name(), vmSymbols::void_method_signature(), &amp;jargs, CHECK);</span>
<span class="line-added"> 720   } else {</span>
<span class="line-added"> 721     JNIAccessMark jni(this);</span>
<span class="line-added"> 722     jni()-&gt;CallNonvirtualVoidMethod(runtime.as_jobject(), JNIJVMCI::HotSpotJVMCIRuntime::clazz(), JNIJVMCI::HotSpotJVMCIRuntime::bootstrapFinished_method());</span>
 723 
<a name="56" id="anc56"></a><span class="line-modified"> 724   }</span>
 725 }
 726 
<a name="57" id="anc57"></a><span class="line-modified"> 727 void JVMCIEnv::call_HotSpotJVMCIRuntime_shutdown (JVMCIObject runtime) {</span>
<span class="line-modified"> 728   HandleMark hm;</span>
<span class="line-modified"> 729   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-modified"> 730   if (is_hotspot()) {</span>
<span class="line-modified"> 731     JavaCallArguments jargs;</span>
<span class="line-modified"> 732     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(runtime)));</span>
<span class="line-modified"> 733     JavaValue result(T_VOID);</span>
<span class="line-modified"> 734     JavaCalls::call_special(&amp;result, HotSpotJVMCI::HotSpotJVMCIRuntime::klass(), vmSymbols::shutdown_name(), vmSymbols::void_method_signature(), &amp;jargs, THREAD);</span>

 735   } else {
<a name="58" id="anc58"></a><span class="line-modified"> 736     JNIAccessMark jni(this);</span>
<span class="line-added"> 737     jni()-&gt;CallNonvirtualVoidMethod(runtime.as_jobject(), JNIJVMCI::HotSpotJVMCIRuntime::clazz(), JNIJVMCI::HotSpotJVMCIRuntime::shutdown_method());</span>
<span class="line-added"> 738   }</span>
<span class="line-added"> 739   if (has_pending_exception()) {</span>
<span class="line-added"> 740     // This should never happen as HotSpotJVMCIRuntime.shutdown() should</span>
<span class="line-added"> 741     // handle all exceptions.</span>
<span class="line-added"> 742     describe_pending_exception(true);</span>
 743   }
<a name="59" id="anc59"></a>
 744 }
 745 
<a name="60" id="anc60"></a><span class="line-added"> 746 JVMCIObject JVMCIEnv::call_HotSpotJVMCIRuntime_runtime (JVMCIEnv* JVMCIENV) {</span>
<span class="line-added"> 747   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 748   if (is_hotspot()) {</span>
<span class="line-added"> 749     JavaCallArguments jargs;</span>
<span class="line-added"> 750     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 751     JavaCalls::call_static(&amp;result, HotSpotJVMCI::HotSpotJVMCIRuntime::klass(), vmSymbols::runtime_name(), vmSymbols::runtime_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 752     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 753   } else {</span>
<span class="line-added"> 754     JNIAccessMark jni(this);</span>
<span class="line-added"> 755     jobject result = jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotJVMCIRuntime::clazz(), JNIJVMCI::HotSpotJVMCIRuntime::runtime_method());</span>
<span class="line-added"> 756     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 757       return JVMCIObject();</span>
<span class="line-added"> 758     }</span>
<span class="line-added"> 759     return wrap(result);</span>
<span class="line-added"> 760   }</span>
<span class="line-added"> 761 }</span>
 762 
<a name="61" id="anc61"></a><span class="line-modified"> 763 JVMCIObject JVMCIEnv::call_JVMCI_getRuntime (JVMCIEnv* JVMCIENV) {</span>
<span class="line-modified"> 764   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-modified"> 765   if (is_hotspot()) {</span>
<span class="line-modified"> 766     JavaCallArguments jargs;</span>
<span class="line-modified"> 767     JavaValue result(T_OBJECT);</span>
<span class="line-modified"> 768     JavaCalls::call_static(&amp;result, HotSpotJVMCI::JVMCI::klass(), vmSymbols::getRuntime_name(), vmSymbols::getRuntime_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-modified"> 769     return wrap((oop) result.get_jobject());</span>
<span class="line-modified"> 770   } else {</span>
<span class="line-modified"> 771     JNIAccessMark jni(this);</span>
<span class="line-modified"> 772     jobject result = jni()-&gt;CallStaticObjectMethod(JNIJVMCI::JVMCI::clazz(), JNIJVMCI::JVMCI::getRuntime_method());</span>
<span class="line-modified"> 773     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-modified"> 774       return JVMCIObject();</span>



































































 775     }
<a name="62" id="anc62"></a><span class="line-added"> 776     return wrap(result);</span>
<span class="line-added"> 777   }</span>
<span class="line-added"> 778 }</span>
 779 
<a name="63" id="anc63"></a><span class="line-modified"> 780 JVMCIObject JVMCIEnv::call_HotSpotJVMCIRuntime_getCompiler (JVMCIObject runtime, JVMCIEnv* JVMCIENV) {</span>
<span class="line-modified"> 781   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-modified"> 782   if (is_hotspot()) {</span>
<span class="line-modified"> 783     JavaCallArguments jargs;</span>
<span class="line-modified"> 784     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(runtime)));</span>
<span class="line-modified"> 785     JavaValue result(T_OBJECT);</span>
<span class="line-modified"> 786     JavaCalls::call_virtual(&amp;result, HotSpotJVMCI::HotSpotJVMCIRuntime::klass(), vmSymbols::getCompiler_name(), vmSymbols::getCompiler_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-modified"> 787     return wrap((oop) result.get_jobject());</span>
<span class="line-modified"> 788   } else {</span>
<span class="line-modified"> 789     JNIAccessMark jni(this);</span>
<span class="line-modified"> 790     jobject result = jni()-&gt;CallObjectMethod(runtime.as_jobject(), JNIJVMCI::HotSpotJVMCIRuntime::getCompiler_method());</span>
<span class="line-modified"> 791     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-modified"> 792       return JVMCIObject();</span>
<span class="line-added"> 793     }</span>
<span class="line-added"> 794     return wrap(result);</span>
<span class="line-added"> 795   }</span>
<span class="line-added"> 796 }</span>
<span class="line-added"> 797 </span>
<span class="line-added"> 798 </span>
<span class="line-added"> 799 JVMCIObject JVMCIEnv::call_HotSpotJVMCIRuntime_callToString(JVMCIObject object, JVMCIEnv* JVMCIENV) {</span>
<span class="line-added"> 800   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 801   if (is_hotspot()) {</span>
<span class="line-added"> 802     JavaCallArguments jargs;</span>
<span class="line-added"> 803     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(object)));</span>
<span class="line-added"> 804     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 805     JavaCalls::call_static(&amp;result,</span>
<span class="line-added"> 806                            HotSpotJVMCI::HotSpotJVMCIRuntime::klass(),</span>
<span class="line-added"> 807                            vmSymbols::callToString_name(),</span>
<span class="line-added"> 808                            vmSymbols::callToString_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 809     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 810   } else {</span>
<span class="line-added"> 811     JNIAccessMark jni(this);</span>
<span class="line-added"> 812     jobject result = (jstring) jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotJVMCIRuntime::clazz(),</span>
<span class="line-added"> 813                                                      JNIJVMCI::HotSpotJVMCIRuntime::callToString_method(),</span>
<span class="line-added"> 814                                                      object.as_jobject());</span>
<span class="line-added"> 815     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 816       return JVMCIObject();</span>
<span class="line-added"> 817     }</span>
<span class="line-added"> 818     return wrap(result);</span>
<span class="line-added"> 819   }</span>
<span class="line-added"> 820 }</span>
<span class="line-added"> 821 </span>
<span class="line-added"> 822 </span>
<span class="line-added"> 823 JVMCIObject JVMCIEnv::call_PrimitiveConstant_forTypeChar(jchar kind, jlong value, JVMCI_TRAPS) {</span>
<span class="line-added"> 824   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 825   if (is_hotspot()) {</span>
<span class="line-added"> 826     JavaCallArguments jargs;</span>
<span class="line-added"> 827     jargs.push_int(kind);</span>
<span class="line-added"> 828     jargs.push_long(value);</span>
<span class="line-added"> 829     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 830     JavaCalls::call_static(&amp;result,</span>
<span class="line-added"> 831                            HotSpotJVMCI::PrimitiveConstant::klass(),</span>
<span class="line-added"> 832                            vmSymbols::forTypeChar_name(),</span>
<span class="line-added"> 833                            vmSymbols::forTypeChar_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 834     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 835   } else {</span>
<span class="line-added"> 836     JNIAccessMark jni(this);</span>
<span class="line-added"> 837     jobject result = (jstring) jni()-&gt;CallStaticObjectMethod(JNIJVMCI::PrimitiveConstant::clazz(),</span>
<span class="line-added"> 838                                                      JNIJVMCI::PrimitiveConstant::forTypeChar_method(),</span>
<span class="line-added"> 839                                                      kind, value);</span>
<span class="line-added"> 840     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 841       return JVMCIObject();</span>
<span class="line-added"> 842     }</span>
<span class="line-added"> 843     return wrap(result);</span>
<span class="line-added"> 844   }</span>
<span class="line-added"> 845 }</span>
<span class="line-added"> 846 </span>
<span class="line-added"> 847 JVMCIObject JVMCIEnv::call_JavaConstant_forFloat(float value, JVMCI_TRAPS) {</span>
<span class="line-added"> 848   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 849   if (is_hotspot()) {</span>
<span class="line-added"> 850     JavaCallArguments jargs;</span>
<span class="line-added"> 851     jargs.push_float(value);</span>
<span class="line-added"> 852     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 853     JavaCalls::call_static(&amp;result,</span>
<span class="line-added"> 854                            HotSpotJVMCI::JavaConstant::klass(),</span>
<span class="line-added"> 855                            vmSymbols::forFloat_name(),</span>
<span class="line-added"> 856                            vmSymbols::forFloat_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 857     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 858   } else {</span>
<span class="line-added"> 859     JNIAccessMark jni(this);</span>
<span class="line-added"> 860     jobject result = (jstring) jni()-&gt;CallStaticObjectMethod(JNIJVMCI::JavaConstant::clazz(),</span>
<span class="line-added"> 861                                                      JNIJVMCI::JavaConstant::forFloat_method(),</span>
<span class="line-added"> 862                                                      value);</span>
<span class="line-added"> 863     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 864       return JVMCIObject();</span>
<span class="line-added"> 865     }</span>
<span class="line-added"> 866     return wrap(result);</span>
<span class="line-added"> 867   }</span>
<span class="line-added"> 868 }</span>
<span class="line-added"> 869 </span>
<span class="line-added"> 870 JVMCIObject JVMCIEnv::call_JavaConstant_forDouble(double value, JVMCI_TRAPS) {</span>
<span class="line-added"> 871   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 872   if (is_hotspot()) {</span>
<span class="line-added"> 873     JavaCallArguments jargs;</span>
<span class="line-added"> 874     jargs.push_double(value);</span>
<span class="line-added"> 875     JavaValue result(T_OBJECT);</span>
<span class="line-added"> 876     JavaCalls::call_static(&amp;result,</span>
<span class="line-added"> 877                            HotSpotJVMCI::JavaConstant::klass(),</span>
<span class="line-added"> 878                            vmSymbols::forDouble_name(),</span>
<span class="line-added"> 879                            vmSymbols::forDouble_signature(), &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 880     return wrap((oop) result.get_jobject());</span>
<span class="line-added"> 881   } else {</span>
<span class="line-added"> 882     JNIAccessMark jni(this);</span>
<span class="line-added"> 883     jobject result = (jstring) jni()-&gt;CallStaticObjectMethod(JNIJVMCI::JavaConstant::clazz(),</span>
<span class="line-added"> 884                                                      JNIJVMCI::JavaConstant::forDouble_method(),</span>
<span class="line-added"> 885                                                      value);</span>
<span class="line-added"> 886     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 887       return JVMCIObject();</span>
<span class="line-added"> 888     }</span>
<span class="line-added"> 889     return wrap(result);</span>
<span class="line-added"> 890   }</span>
<span class="line-added"> 891 }</span>
<span class="line-added"> 892 </span>
<span class="line-added"> 893 JVMCIObject JVMCIEnv::get_jvmci_primitive_type(BasicType type) {</span>
<span class="line-added"> 894   JVMCIObjectArray primitives = get_HotSpotResolvedPrimitiveType_primitives();</span>
<span class="line-added"> 895   JVMCIObject result = get_object_at(primitives, type);</span>
<span class="line-added"> 896   return result;</span>
<span class="line-added"> 897 }</span>
<span class="line-added"> 898 </span>
<span class="line-added"> 899 JVMCIObject JVMCIEnv::new_StackTraceElement(const methodHandle&amp; method, int bci, JVMCI_TRAPS) {</span>
<span class="line-added"> 900   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 901   Symbol* file_name_sym;</span>
<span class="line-added"> 902   int line_number;</span>
<span class="line-added"> 903   java_lang_StackTraceElement::decode(method, bci, file_name_sym, line_number, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 904 </span>
<span class="line-added"> 905   Symbol* method_name_sym = method-&gt;name();</span>
<span class="line-added"> 906   InstanceKlass* holder = method-&gt;method_holder();</span>
<span class="line-added"> 907   const char* declaring_class_str = holder-&gt;external_name();</span>
<span class="line-added"> 908 </span>
<span class="line-added"> 909   if (is_hotspot()) {</span>
<span class="line-added"> 910     HotSpotJVMCI::StackTraceElement::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added"> 911     oop objOop = HotSpotJVMCI::StackTraceElement::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added"> 912     Handle obj = Handle(THREAD, objOop);</span>
<span class="line-added"> 913 </span>
<span class="line-added"> 914     oop declaring_class = StringTable::intern((char*) declaring_class_str, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 915     HotSpotJVMCI::StackTraceElement::set_declaringClass(this, obj(), declaring_class);</span>
<span class="line-added"> 916 </span>
<span class="line-added"> 917     oop method_name = StringTable::intern(method_name_sym, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 918     HotSpotJVMCI::StackTraceElement::set_methodName(this, obj(), method_name);</span>
<span class="line-added"> 919 </span>
<span class="line-added"> 920     if (file_name_sym != NULL) {</span>
<span class="line-added"> 921       oop file_name = StringTable::intern(file_name_sym, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 922       HotSpotJVMCI::StackTraceElement::set_fileName(this, obj(), file_name);</span>
<span class="line-added"> 923     }</span>
<span class="line-added"> 924     HotSpotJVMCI::StackTraceElement::set_lineNumber(this, obj(), line_number);</span>
<span class="line-added"> 925     return wrap(obj());</span>
<span class="line-added"> 926   } else {</span>
<span class="line-added"> 927     JNIAccessMark jni(this);</span>
<span class="line-added"> 928     jobject declaring_class = jni()-&gt;NewStringUTF(declaring_class_str);</span>
<span class="line-added"> 929     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 930       return JVMCIObject();</span>
<span class="line-added"> 931     }</span>
<span class="line-added"> 932     jobject method_name = jni()-&gt;NewStringUTF(method_name_sym-&gt;as_C_string());</span>
<span class="line-added"> 933     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 934       return JVMCIObject();</span>
<span class="line-added"> 935     }</span>
<span class="line-added"> 936     jobject file_name = NULL;</span>
<span class="line-added"> 937     if (file_name_sym != NULL) {</span>
<span class="line-added"> 938       file_name = jni()-&gt;NewStringUTF(file_name_sym-&gt;as_C_string());</span>
<span class="line-added"> 939       if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 940         return JVMCIObject();</span>
 941       }
<a name="64" id="anc64"></a><span class="line-added"> 942     }</span>
<span class="line-added"> 943 </span>
<span class="line-added"> 944     jobject result = jni()-&gt;NewObject(JNIJVMCI::StackTraceElement::clazz(),</span>
<span class="line-added"> 945                                       JNIJVMCI::StackTraceElement::constructor(),</span>
<span class="line-added"> 946                                       declaring_class, method_name, file_name, line_number);</span>
<span class="line-added"> 947     return wrap(result);</span>
<span class="line-added"> 948   }</span>
<span class="line-added"> 949 }</span>
<span class="line-added"> 950 </span>
<span class="line-added"> 951 JVMCIObject JVMCIEnv::new_HotSpotNmethod(const methodHandle&amp; method, const char* name, jboolean isDefault, jlong compileId, JVMCI_TRAPS) {</span>
<span class="line-added"> 952   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added"> 953 </span>
<span class="line-added"> 954   JVMCIObject methodObject = get_jvmci_method(method, JVMCI_CHECK_(JVMCIObject()));</span>
<span class="line-added"> 955 </span>
<span class="line-added"> 956   if (is_hotspot()) {</span>
<span class="line-added"> 957     InstanceKlass* ik = InstanceKlass::cast(HotSpotJVMCI::HotSpotNmethod::klass());</span>
<span class="line-added"> 958     if (ik-&gt;should_be_initialized()) {</span>
<span class="line-added"> 959       ik-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added"> 960     }</span>
<span class="line-added"> 961     oop obj = ik-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added"> 962     Handle obj_h(THREAD, obj);</span>
<span class="line-added"> 963     Handle nameStr = java_lang_String::create_from_str(name, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 964 </span>
<span class="line-added"> 965     // Call constructor</span>
<span class="line-added"> 966     JavaCallArguments jargs;</span>
<span class="line-added"> 967     jargs.push_oop(obj_h);</span>
<span class="line-added"> 968     jargs.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(methodObject)));</span>
<span class="line-added"> 969     jargs.push_oop(nameStr);</span>
<span class="line-added"> 970     jargs.push_int(isDefault);</span>
<span class="line-added"> 971     jargs.push_long(compileId);</span>
<span class="line-added"> 972     JavaValue result(T_VOID);</span>
<span class="line-added"> 973     JavaCalls::call_special(&amp;result, ik,</span>
<span class="line-added"> 974                             vmSymbols::object_initializer_name(),</span>
<span class="line-added"> 975                             vmSymbols::method_string_bool_long_signature(),</span>
<span class="line-added"> 976                             &amp;jargs, CHECK_(JVMCIObject()));</span>
<span class="line-added"> 977     return wrap(obj_h());</span>
<span class="line-added"> 978   } else {</span>
<span class="line-added"> 979     JNIAccessMark jni(this);</span>
<span class="line-added"> 980     jobject nameStr = name == NULL ? NULL : jni()-&gt;NewStringUTF(name);</span>
<span class="line-added"> 981     if (jni()-&gt;ExceptionCheck()) {</span>
<span class="line-added"> 982       return JVMCIObject();</span>
<span class="line-added"> 983     }</span>
<span class="line-added"> 984 </span>
<span class="line-added"> 985     jobject result = jni()-&gt;NewObject(JNIJVMCI::HotSpotNmethod::clazz(),</span>
<span class="line-added"> 986                                       JNIJVMCI::HotSpotNmethod::constructor(),</span>
<span class="line-added"> 987                                       methodObject.as_jobject(), nameStr, isDefault);</span>
<span class="line-added"> 988     return wrap(result);</span>
<span class="line-added"> 989   }</span>
<span class="line-added"> 990 }</span>
<span class="line-added"> 991 </span>
<span class="line-added"> 992 JVMCIObject JVMCIEnv::make_local(JVMCIObject object) {</span>
<span class="line-added"> 993   if (object.is_null()) {</span>
<span class="line-added"> 994     return JVMCIObject();</span>
<span class="line-added"> 995   }</span>
<span class="line-added"> 996   if (is_hotspot()) {</span>
<span class="line-added"> 997     return wrap(JNIHandles::make_local(HotSpotJVMCI::resolve(object)));</span>
<span class="line-added"> 998   } else {</span>
<span class="line-added"> 999     JNIAccessMark jni(this);</span>
<span class="line-added">1000     return wrap(jni()-&gt;NewLocalRef(object.as_jobject()));</span>
<span class="line-added">1001   }</span>
<span class="line-added">1002 }</span>
<span class="line-added">1003 </span>
<span class="line-added">1004 JVMCIObject JVMCIEnv::make_global(JVMCIObject object) {</span>
<span class="line-added">1005   if (object.is_null()) {</span>
<span class="line-added">1006     return JVMCIObject();</span>
<span class="line-added">1007   }</span>
<span class="line-added">1008   if (is_hotspot()) {</span>
<span class="line-added">1009     return wrap(JNIHandles::make_global(Handle(Thread::current(), HotSpotJVMCI::resolve(object))));</span>
<span class="line-added">1010   } else {</span>
<span class="line-added">1011     JNIAccessMark jni(this);</span>
<span class="line-added">1012     return wrap(jni()-&gt;NewGlobalRef(object.as_jobject()));</span>
<span class="line-added">1013   }</span>
<span class="line-added">1014 }</span>
<span class="line-added">1015 </span>
<span class="line-added">1016 JVMCIObject JVMCIEnv::make_weak(JVMCIObject object) {</span>
<span class="line-added">1017   if (object.is_null()) {</span>
<span class="line-added">1018     return JVMCIObject();</span>
<span class="line-added">1019   }</span>
<span class="line-added">1020   if (is_hotspot()) {</span>
<span class="line-added">1021     return wrap(JNIHandles::make_weak_global(Handle(Thread::current(), HotSpotJVMCI::resolve(object))));</span>
<span class="line-added">1022   } else {</span>
<span class="line-added">1023     JNIAccessMark jni(this);</span>
<span class="line-added">1024     return wrap(jni()-&gt;NewWeakGlobalRef(object.as_jobject()));</span>
<span class="line-added">1025   }</span>
<span class="line-added">1026 }</span>
1027 
<a name="65" id="anc65"></a><span class="line-modified">1028 void JVMCIEnv::destroy_local(JVMCIObject object) {</span>
<span class="line-modified">1029   if (is_hotspot()) {</span>
<span class="line-modified">1030     JNIHandles::destroy_local(object.as_jobject());</span>
<span class="line-modified">1031   } else {</span>
<span class="line-added">1032     JNIAccessMark jni(this);</span>
<span class="line-added">1033     jni()-&gt;DeleteLocalRef(object.as_jobject());</span>
<span class="line-added">1034   }</span>
<span class="line-added">1035 }</span>
<span class="line-added">1036 </span>
<span class="line-added">1037 void JVMCIEnv::destroy_global(JVMCIObject object) {</span>
<span class="line-added">1038   if (is_hotspot()) {</span>
<span class="line-added">1039     JNIHandles::destroy_global(object.as_jobject());</span>
<span class="line-added">1040   } else {</span>
<span class="line-added">1041     JNIAccessMark jni(this);</span>
<span class="line-added">1042     jni()-&gt;DeleteGlobalRef(object.as_jobject());</span>
<span class="line-added">1043   }</span>
<span class="line-added">1044 }</span>
<span class="line-added">1045 </span>
<span class="line-added">1046 void JVMCIEnv::destroy_weak(JVMCIObject object) {</span>
<span class="line-added">1047   if (is_hotspot()) {</span>
<span class="line-added">1048     JNIHandles::destroy_weak_global(object.as_jweak());</span>
<span class="line-added">1049   } else {</span>
<span class="line-added">1050     JNIAccessMark jni(this);</span>
<span class="line-added">1051     jni()-&gt;DeleteWeakGlobalRef(object.as_jweak());</span>
<span class="line-added">1052   }</span>
<span class="line-added">1053 }</span>
<span class="line-added">1054 </span>
<span class="line-added">1055 const char* JVMCIEnv::klass_name(JVMCIObject object) {</span>
<span class="line-added">1056   if (is_hotspot()) {</span>
<span class="line-added">1057     return HotSpotJVMCI::resolve(object)-&gt;klass()-&gt;signature_name();</span>
<span class="line-added">1058   } else {</span>
<span class="line-added">1059     JVMCIObject name;</span>
<span class="line-added">1060     {</span>
<span class="line-added">1061       JNIAccessMark jni(this);</span>
<span class="line-added">1062       jclass jcl = jni()-&gt;GetObjectClass(object.as_jobject());</span>
<span class="line-added">1063       jobject result = jni()-&gt;CallObjectMethod(jcl, JNIJVMCI::Class_getName_method());</span>
<span class="line-added">1064       name = JVMCIObject::create(result, is_hotspot());</span>
<span class="line-added">1065     }</span>
<span class="line-added">1066     return as_utf8_string(name);</span>
<span class="line-added">1067   }</span>
<span class="line-added">1068 }</span>
<span class="line-added">1069 </span>
<span class="line-added">1070 JVMCIObject JVMCIEnv::get_jvmci_method(const methodHandle&amp; method, JVMCI_TRAPS) {</span>
<span class="line-added">1071   JVMCIObject method_object;</span>
<span class="line-added">1072   if (method() == NULL) {</span>
<span class="line-added">1073     return method_object;</span>
<span class="line-added">1074   }</span>
<span class="line-added">1075 </span>
<span class="line-added">1076   Thread* THREAD = Thread::current();</span>
<span class="line-added">1077   jmetadata handle = JVMCI::allocate_handle(method);</span>
<span class="line-added">1078   jboolean exception = false;</span>
<span class="line-added">1079   if (is_hotspot()) {</span>
<span class="line-added">1080     JavaValue result(T_OBJECT);</span>
<span class="line-added">1081     JavaCallArguments args;</span>
<span class="line-added">1082     args.push_long((jlong) handle);</span>
<span class="line-added">1083     JavaCalls::call_static(&amp;result, HotSpotJVMCI::HotSpotResolvedJavaMethodImpl::klass(),</span>
<span class="line-added">1084                            vmSymbols::fromMetaspace_name(),</span>
<span class="line-added">1085                            vmSymbols::method_fromMetaspace_signature(), &amp;args, THREAD);</span>
<span class="line-added">1086     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added">1087       exception = true;</span>
1088     } else {
<a name="66" id="anc66"></a><span class="line-modified">1089       method_object = wrap((oop)result.get_jobject());</span>
<span class="line-modified">1090     }</span>
<span class="line-modified">1091   } else {</span>
<span class="line-modified">1092     JNIAccessMark jni(this);</span>
<span class="line-modified">1093     method_object = JNIJVMCI::wrap(jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotResolvedJavaMethodImpl::clazz(),</span>
<span class="line-modified">1094                                                                   JNIJVMCI::HotSpotResolvedJavaMethodImpl_fromMetaspace_method(),</span>
<span class="line-modified">1095                                                                   (jlong) handle));</span>
<span class="line-modified">1096     exception = jni()-&gt;ExceptionCheck();</span>
<span class="line-modified">1097   }</span>
<span class="line-modified">1098 </span>
<span class="line-modified">1099   if (exception) {</span>
<span class="line-modified">1100     JVMCI::release_handle(handle);</span>
<span class="line-modified">1101     return JVMCIObject();</span>
<span class="line-modified">1102   }</span>
<span class="line-modified">1103 </span>
<span class="line-modified">1104   assert(asMethod(method_object) == method(), &quot;must be&quot;);</span>
<span class="line-modified">1105   if (get_HotSpotResolvedJavaMethodImpl_metadataHandle(method_object) != (jlong) handle) {</span>
<span class="line-modified">1106     JVMCI::release_handle(handle);</span>
<span class="line-modified">1107   }</span>
<span class="line-modified">1108   assert(!method_object.is_null(), &quot;must be&quot;);</span>
<span class="line-modified">1109   return method_object;</span>
<span class="line-modified">1110 }</span>
<span class="line-modified">1111 </span>
<span class="line-modified">1112 JVMCIObject JVMCIEnv::get_jvmci_type(const JVMCIKlassHandle&amp; klass, JVMCI_TRAPS) {</span>
<span class="line-modified">1113   JVMCIObject type;</span>
<span class="line-modified">1114   if (klass.is_null()) {</span>
<span class="line-modified">1115     return type;</span>
<span class="line-modified">1116   }</span>
<span class="line-modified">1117 </span>
<span class="line-modified">1118   jlong pointer = (jlong) klass();</span>
<span class="line-modified">1119   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1120   JVMCIObject signature = create_string(klass-&gt;signature_name(), JVMCI_CHECK_(JVMCIObject()));</span>
<span class="line-added">1121   jboolean exception = false;</span>
<span class="line-added">1122   if (is_hotspot()) {</span>
<span class="line-added">1123     JavaValue result(T_OBJECT);</span>
<span class="line-added">1124     JavaCallArguments args;</span>
<span class="line-added">1125     args.push_long(pointer);</span>
<span class="line-added">1126     args.push_oop(Handle(THREAD, HotSpotJVMCI::resolve(signature)));</span>
<span class="line-added">1127     JavaCalls::call_static(&amp;result,</span>
<span class="line-added">1128                            HotSpotJVMCI::HotSpotResolvedObjectTypeImpl::klass(),</span>
<span class="line-added">1129                            vmSymbols::fromMetaspace_name(),</span>
<span class="line-added">1130                            vmSymbols::klass_fromMetaspace_signature(), &amp;args, THREAD);</span>
<span class="line-added">1131 </span>
<span class="line-added">1132     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added">1133       exception = true;</span>
<span class="line-added">1134     } else {</span>
<span class="line-added">1135       type = wrap((oop)result.get_jobject());</span>
<span class="line-added">1136     }</span>
<span class="line-added">1137   } else {</span>
<span class="line-added">1138     JNIAccessMark jni(this);</span>
<span class="line-added">1139 </span>
<span class="line-added">1140     HandleMark hm(THREAD);</span>
<span class="line-added">1141     type = JNIJVMCI::wrap(jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotResolvedObjectTypeImpl::clazz(),</span>
<span class="line-added">1142                                                         JNIJVMCI::HotSpotResolvedObjectTypeImpl_fromMetaspace_method(),</span>
<span class="line-added">1143                                                         pointer, signature.as_jstring()));</span>
<span class="line-added">1144     exception = jni()-&gt;ExceptionCheck();</span>
<span class="line-added">1145   }</span>
<span class="line-added">1146   if (exception) {</span>
<span class="line-added">1147     return JVMCIObject();</span>
<span class="line-added">1148   }</span>
<span class="line-added">1149 </span>
<span class="line-added">1150   assert(type.is_non_null(), &quot;must have result&quot;);</span>
<span class="line-added">1151   return type;</span>
<span class="line-added">1152 }</span>
<span class="line-added">1153 </span>
<span class="line-added">1154 JVMCIObject JVMCIEnv::get_jvmci_constant_pool(const constantPoolHandle&amp; cp, JVMCI_TRAPS) {</span>
<span class="line-added">1155   JVMCIObject cp_object;</span>
<span class="line-added">1156   jmetadata handle = JVMCI::allocate_handle(cp);</span>
<span class="line-added">1157   jboolean exception = false;</span>
<span class="line-added">1158   if (is_hotspot()) {</span>
<span class="line-added">1159     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1160     JavaValue result(T_OBJECT);</span>
<span class="line-added">1161     JavaCallArguments args;</span>
<span class="line-added">1162     args.push_long((jlong) handle);</span>
<span class="line-added">1163     JavaCalls::call_static(&amp;result,</span>
<span class="line-added">1164                            HotSpotJVMCI::HotSpotConstantPool::klass(),</span>
<span class="line-added">1165                            vmSymbols::fromMetaspace_name(),</span>
<span class="line-added">1166                            vmSymbols::constantPool_fromMetaspace_signature(), &amp;args, THREAD);</span>
<span class="line-added">1167     if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-added">1168       exception = true;</span>
<span class="line-added">1169     } else {</span>
<span class="line-added">1170       cp_object = wrap((oop)result.get_jobject());</span>
<span class="line-added">1171     }</span>
<span class="line-added">1172   } else {</span>
<span class="line-added">1173     JNIAccessMark jni(this);</span>
<span class="line-added">1174     cp_object = JNIJVMCI::wrap(jni()-&gt;CallStaticObjectMethod(JNIJVMCI::HotSpotConstantPool::clazz(),</span>
<span class="line-added">1175                                                              JNIJVMCI::HotSpotConstantPool_fromMetaspace_method(),</span>
<span class="line-added">1176                                                              (jlong) handle));</span>
<span class="line-added">1177     exception = jni()-&gt;ExceptionCheck();</span>
<span class="line-added">1178   }</span>
<span class="line-added">1179 </span>
<span class="line-added">1180   if (exception) {</span>
<span class="line-added">1181     JVMCI::release_handle(handle);</span>
<span class="line-added">1182     return JVMCIObject();</span>
<span class="line-added">1183   }</span>
<span class="line-added">1184 </span>
<span class="line-added">1185   assert(!cp_object.is_null(), &quot;must be&quot;);</span>
<span class="line-added">1186   // Constant pools aren&#39;t cached so this is always a newly created object using the handle</span>
<span class="line-added">1187   assert(get_HotSpotConstantPool_metadataHandle(cp_object) == (jlong) handle, &quot;must use same handle&quot;);</span>
<span class="line-added">1188   return cp_object;</span>
<span class="line-added">1189 }</span>
<span class="line-added">1190 </span>
<span class="line-added">1191 JVMCIPrimitiveArray JVMCIEnv::new_booleanArray(int length, JVMCI_TRAPS) {</span>
<span class="line-added">1192   if (is_hotspot()) {</span>
<span class="line-added">1193     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1194     typeArrayOop result = oopFactory::new_boolArray(length, CHECK_(JVMCIObject()));</span>
<span class="line-added">1195     return wrap(result);</span>
<span class="line-added">1196   } else {</span>
<span class="line-added">1197     JNIAccessMark jni(this);</span>
<span class="line-added">1198     jbooleanArray result = jni()-&gt;NewBooleanArray(length);</span>
<span class="line-added">1199     return wrap(result);</span>
<span class="line-added">1200   }</span>
<span class="line-added">1201 }</span>
<span class="line-added">1202 </span>
<span class="line-added">1203 JVMCIPrimitiveArray JVMCIEnv::new_byteArray(int length, JVMCI_TRAPS) {</span>
<span class="line-added">1204   if (is_hotspot()) {</span>
<span class="line-added">1205     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1206     typeArrayOop result = oopFactory::new_byteArray(length, CHECK_(JVMCIObject()));</span>
<span class="line-added">1207     return wrap(result);</span>
<span class="line-added">1208   } else {</span>
<span class="line-added">1209     JNIAccessMark jni(this);</span>
<span class="line-added">1210     jbyteArray result = jni()-&gt;NewByteArray(length);</span>
<span class="line-added">1211     return wrap(result);</span>
<span class="line-added">1212   }</span>
<span class="line-added">1213 }</span>
<span class="line-added">1214 </span>
<span class="line-added">1215 JVMCIObjectArray JVMCIEnv::new_byte_array_array(int length, JVMCI_TRAPS) {</span>
<span class="line-added">1216   if (is_hotspot()) {</span>
<span class="line-added">1217     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1218     Klass* byteArrayArrayKlass = TypeArrayKlass::cast(Universe::byteArrayKlassObj  ())-&gt;array_klass(CHECK_(JVMCIObject()));</span>
<span class="line-added">1219     objArrayOop result = ObjArrayKlass::cast(byteArrayArrayKlass) -&gt;allocate(length, CHECK_(JVMCIObject()));</span>
<span class="line-added">1220     return wrap(result);</span>
<span class="line-added">1221   } else {</span>
<span class="line-added">1222     JNIAccessMark jni(this);</span>
<span class="line-added">1223     jobjectArray result = jni()-&gt;NewObjectArray(length, JNIJVMCI::byte_array(), NULL);</span>
<span class="line-added">1224     return wrap(result);</span>
<span class="line-added">1225   }</span>
<span class="line-added">1226 }</span>
<span class="line-added">1227 </span>
<span class="line-added">1228 JVMCIPrimitiveArray JVMCIEnv::new_intArray(int length, JVMCI_TRAPS) {</span>
<span class="line-added">1229   if (is_hotspot()) {</span>
<span class="line-added">1230     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1231     typeArrayOop result = oopFactory::new_intArray(length, CHECK_(JVMCIObject()));</span>
<span class="line-added">1232     return wrap(result);</span>
<span class="line-added">1233   } else {</span>
<span class="line-added">1234     JNIAccessMark jni(this);</span>
<span class="line-added">1235     jintArray result = jni()-&gt;NewIntArray(length);</span>
<span class="line-added">1236     return wrap(result);</span>
<span class="line-added">1237   }</span>
<span class="line-added">1238 }</span>
<span class="line-added">1239 </span>
<span class="line-added">1240 JVMCIPrimitiveArray JVMCIEnv::new_longArray(int length, JVMCI_TRAPS) {</span>
<span class="line-added">1241   if (is_hotspot()) {</span>
<span class="line-added">1242     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1243     typeArrayOop result = oopFactory::new_longArray(length, CHECK_(JVMCIObject()));</span>
<span class="line-added">1244     return wrap(result);</span>
<span class="line-added">1245   } else {</span>
<span class="line-added">1246     JNIAccessMark jni(this);</span>
<span class="line-added">1247     jlongArray result = jni()-&gt;NewLongArray(length);</span>
<span class="line-added">1248     return wrap(result);</span>
<span class="line-added">1249   }</span>
<span class="line-added">1250 }</span>
<span class="line-added">1251 </span>
<span class="line-added">1252 JVMCIObject JVMCIEnv::new_VMField(JVMCIObject name, JVMCIObject type, jlong offset, jlong address, JVMCIObject value, JVMCI_TRAPS) {</span>
<span class="line-added">1253   if (is_hotspot()) {</span>
<span class="line-added">1254     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1255     HotSpotJVMCI::VMField::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1256     oop obj = HotSpotJVMCI::VMField::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1257     HotSpotJVMCI::VMField::set_name(this, obj, HotSpotJVMCI::resolve(name));</span>
<span class="line-added">1258     HotSpotJVMCI::VMField::set_type(this, obj, HotSpotJVMCI::resolve(type));</span>
<span class="line-added">1259     HotSpotJVMCI::VMField::set_offset(this, obj, offset);</span>
<span class="line-added">1260     HotSpotJVMCI::VMField::set_address(this, obj, address);</span>
<span class="line-added">1261     HotSpotJVMCI::VMField::set_value(this, obj, HotSpotJVMCI::resolve(value));</span>
<span class="line-added">1262     return wrap(obj);</span>
<span class="line-added">1263   } else {</span>
<span class="line-added">1264     JNIAccessMark jni(this);</span>
<span class="line-added">1265     jobject result = jni()-&gt;NewObject(JNIJVMCI::VMField::clazz(),</span>
<span class="line-added">1266                                     JNIJVMCI::VMField::constructor(),</span>
<span class="line-added">1267                                     get_jobject(name), get_jobject(type), offset, address, get_jobject(value));</span>
<span class="line-added">1268     return wrap(result);</span>
<span class="line-added">1269   }</span>
<span class="line-added">1270 }</span>
<span class="line-added">1271 </span>
<span class="line-added">1272 JVMCIObject JVMCIEnv::new_VMFlag(JVMCIObject name, JVMCIObject type, JVMCIObject value, JVMCI_TRAPS) {</span>
<span class="line-added">1273   if (is_hotspot()) {</span>
<span class="line-added">1274     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1275     HotSpotJVMCI::VMFlag::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1276     oop obj = HotSpotJVMCI::VMFlag::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1277     HotSpotJVMCI::VMFlag::set_name(this, obj, HotSpotJVMCI::resolve(name));</span>
<span class="line-added">1278     HotSpotJVMCI::VMFlag::set_type(this, obj, HotSpotJVMCI::resolve(type));</span>
<span class="line-added">1279     HotSpotJVMCI::VMFlag::set_value(this, obj, HotSpotJVMCI::resolve(value));</span>
<span class="line-added">1280     return wrap(obj);</span>
<span class="line-added">1281   } else {</span>
<span class="line-added">1282     JNIAccessMark jni(this);</span>
<span class="line-added">1283     jobject result = jni()-&gt;NewObject(JNIJVMCI::VMFlag::clazz(),</span>
<span class="line-added">1284                                     JNIJVMCI::VMFlag::constructor(),</span>
<span class="line-added">1285                                     get_jobject(name), get_jobject(type), get_jobject(value));</span>
<span class="line-added">1286     return wrap(result);</span>
<span class="line-added">1287   }</span>
<span class="line-added">1288 }</span>
<span class="line-added">1289 </span>
<span class="line-added">1290 JVMCIObject JVMCIEnv::new_VMIntrinsicMethod(JVMCIObject declaringClass, JVMCIObject name, JVMCIObject descriptor, int id, JVMCI_TRAPS) {</span>
<span class="line-added">1291   if (is_hotspot()) {</span>
<span class="line-added">1292     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1293     HotSpotJVMCI::VMIntrinsicMethod::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1294     oop obj = HotSpotJVMCI::VMIntrinsicMethod::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1295     HotSpotJVMCI::VMIntrinsicMethod::set_declaringClass(this, obj, HotSpotJVMCI::resolve(declaringClass));</span>
<span class="line-added">1296     HotSpotJVMCI::VMIntrinsicMethod::set_name(this, obj, HotSpotJVMCI::resolve(name));</span>
<span class="line-added">1297     HotSpotJVMCI::VMIntrinsicMethod::set_descriptor(this, obj, HotSpotJVMCI::resolve(descriptor));</span>
<span class="line-added">1298     HotSpotJVMCI::VMIntrinsicMethod::set_id(this, obj, id);</span>
<span class="line-added">1299     return wrap(obj);</span>
<span class="line-added">1300   } else {</span>
<span class="line-added">1301     JNIAccessMark jni(this);</span>
<span class="line-added">1302     jobject result = jni()-&gt;NewObject(JNIJVMCI::VMIntrinsicMethod::clazz(),</span>
<span class="line-added">1303                                     JNIJVMCI::VMIntrinsicMethod::constructor(),</span>
<span class="line-added">1304                                     get_jobject(declaringClass), get_jobject(name), get_jobject(descriptor), id);</span>
<span class="line-added">1305     return wrap(result);</span>
<span class="line-added">1306   }</span>
<span class="line-added">1307 }</span>
<span class="line-added">1308 </span>
<span class="line-added">1309 JVMCIObject JVMCIEnv::new_HotSpotStackFrameReference(JVMCI_TRAPS) {</span>
<span class="line-added">1310   if (is_hotspot()) {</span>
<span class="line-added">1311     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1312     HotSpotJVMCI::HotSpotStackFrameReference::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1313     oop obj = HotSpotJVMCI::HotSpotStackFrameReference::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1314     return wrap(obj);</span>
<span class="line-added">1315   } else {</span>
<span class="line-added">1316     ShouldNotReachHere();</span>
<span class="line-added">1317     return JVMCIObject();</span>
<span class="line-added">1318   }</span>
<span class="line-added">1319 }</span>
<span class="line-added">1320 JVMCIObject JVMCIEnv::new_JVMCIError(JVMCI_TRAPS) {</span>
<span class="line-added">1321   if (is_hotspot()) {</span>
<span class="line-added">1322     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1323     HotSpotJVMCI::JVMCIError::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1324     oop obj = HotSpotJVMCI::JVMCIError::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1325     return wrap(obj);</span>
<span class="line-added">1326   } else {</span>
<span class="line-added">1327     ShouldNotReachHere();</span>
<span class="line-added">1328     return JVMCIObject();</span>
<span class="line-added">1329   }</span>
<span class="line-added">1330 }</span>
<span class="line-added">1331 </span>
<span class="line-added">1332 </span>
<span class="line-added">1333 JVMCIObject JVMCIEnv::get_object_constant(oop objOop, bool compressed, bool dont_register) {</span>
<span class="line-added">1334   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1335   Handle obj = Handle(THREAD, objOop);</span>
<span class="line-added">1336   if (obj.is_null()) {</span>
<span class="line-added">1337     return JVMCIObject();</span>
<span class="line-added">1338   }</span>
<span class="line-added">1339   if (is_hotspot()) {</span>
<span class="line-added">1340     HotSpotJVMCI::DirectHotSpotObjectConstantImpl::klass()-&gt;initialize(CHECK_(JVMCIObject()));</span>
<span class="line-added">1341     oop constant = HotSpotJVMCI::DirectHotSpotObjectConstantImpl::klass()-&gt;allocate_instance(CHECK_(JVMCIObject()));</span>
<span class="line-added">1342     HotSpotJVMCI::DirectHotSpotObjectConstantImpl::set_object(this, constant, obj());</span>
<span class="line-added">1343     HotSpotJVMCI::HotSpotObjectConstantImpl::set_compressed(this, constant, compressed);</span>
<span class="line-added">1344     return wrap(constant);</span>
<span class="line-added">1345   } else {</span>
<span class="line-added">1346     jlong handle = make_handle(obj);</span>
<span class="line-added">1347     JNIAccessMark jni(this);</span>
<span class="line-added">1348     jobject result = jni()-&gt;NewObject(JNIJVMCI::IndirectHotSpotObjectConstantImpl::clazz(),</span>
<span class="line-added">1349                                       JNIJVMCI::IndirectHotSpotObjectConstantImpl::constructor(),</span>
<span class="line-added">1350                                       handle, compressed, dont_register);</span>
<span class="line-added">1351     return wrap(result);</span>
<span class="line-added">1352   }</span>
<span class="line-added">1353 }</span>
<span class="line-added">1354 </span>
<span class="line-added">1355 </span>
<span class="line-added">1356 Handle JVMCIEnv::asConstant(JVMCIObject constant, JVMCI_TRAPS) {</span>
<span class="line-added">1357   if (constant.is_null()) {</span>
<span class="line-added">1358     return Handle();</span>
<span class="line-added">1359   }</span>
<span class="line-added">1360   JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1361   if (is_hotspot()) {</span>
<span class="line-added">1362     assert(HotSpotJVMCI::DirectHotSpotObjectConstantImpl::is_instance(this, constant), &quot;wrong type&quot;);</span>
<span class="line-added">1363     oop obj = HotSpotJVMCI::DirectHotSpotObjectConstantImpl::object(this, HotSpotJVMCI::resolve(constant));</span>
<span class="line-added">1364     return Handle(THREAD, obj);</span>
<span class="line-added">1365   } else if (isa_IndirectHotSpotObjectConstantImpl(constant)) {</span>
<span class="line-added">1366     jlong object_handle = get_IndirectHotSpotObjectConstantImpl_objectHandle(constant);</span>
<span class="line-added">1367     if (object_handle == 0L) {</span>
<span class="line-added">1368       JVMCI_THROW_MSG_(NullPointerException, &quot;Foreign object reference has been cleared&quot;, Handle());</span>
<span class="line-added">1369     }</span>
<span class="line-added">1370     oop result = resolve_handle(object_handle);</span>
<span class="line-added">1371     if (result == NULL) {</span>
<span class="line-added">1372       JVMCI_THROW_MSG_(InternalError, &quot;Constant was unexpectedly NULL&quot;, Handle());</span>
<span class="line-added">1373     }</span>
<span class="line-added">1374     return Handle(THREAD, result);</span>
<span class="line-added">1375   } else {</span>
<span class="line-added">1376     JVMCI_THROW_MSG_(IllegalArgumentException, &quot;DirectHotSpotObjectConstantImpl shouldn&#39;t reach JVMCI in SVM mode&quot;, Handle());</span>
<span class="line-added">1377   }</span>
<span class="line-added">1378 }</span>
<span class="line-added">1379 </span>
<span class="line-added">1380 JVMCIObject JVMCIEnv::wrap(jobject object) {</span>
<span class="line-added">1381   return JVMCIObject::create(object, is_hotspot());</span>
<span class="line-added">1382 }</span>
<span class="line-added">1383 </span>
<span class="line-added">1384 jlong JVMCIEnv::make_handle(const Handle&amp; obj) {</span>
<span class="line-added">1385   assert(!obj.is_null(), &quot;should only create handle for non-NULL oops&quot;);</span>
<span class="line-added">1386   jobject handle = JVMCI::make_global(obj);</span>
<span class="line-added">1387   return (jlong) handle;</span>
<span class="line-added">1388 }</span>
<span class="line-added">1389 </span>
<span class="line-added">1390 oop JVMCIEnv::resolve_handle(jlong objectHandle) {</span>
<span class="line-added">1391   assert(objectHandle != 0, &quot;should be a valid handle&quot;);</span>
<span class="line-added">1392   oop obj = *((oopDesc**)objectHandle);</span>
<span class="line-added">1393   if (obj != NULL) {</span>
<span class="line-added">1394     oopDesc::verify(obj);</span>
<span class="line-added">1395   }</span>
<span class="line-added">1396   return obj;</span>
<span class="line-added">1397 }</span>
<span class="line-added">1398 </span>
<span class="line-added">1399 JVMCIObject JVMCIEnv::create_string(const char* str, JVMCI_TRAPS) {</span>
<span class="line-added">1400   if (is_hotspot()) {</span>
<span class="line-added">1401     JavaThread* THREAD = JavaThread::current();</span>
<span class="line-added">1402     Handle result = java_lang_String::create_from_str(str, CHECK_(JVMCIObject()));</span>
<span class="line-added">1403     return HotSpotJVMCI::wrap(result());</span>
<span class="line-added">1404   } else {</span>
<span class="line-added">1405     jobject result;</span>
<span class="line-added">1406     jboolean exception = false;</span>
<span class="line-added">1407     {</span>
<span class="line-added">1408       JNIAccessMark jni(this);</span>
<span class="line-added">1409       result = jni()-&gt;NewStringUTF(str);</span>
<span class="line-added">1410       exception = jni()-&gt;ExceptionCheck();</span>
<span class="line-added">1411     }</span>
<span class="line-added">1412     return wrap(result);</span>
<span class="line-added">1413   }</span>
<span class="line-added">1414 }</span>
<span class="line-added">1415 </span>
<span class="line-added">1416 bool JVMCIEnv::equals(JVMCIObject a, JVMCIObject b) {</span>
<span class="line-added">1417   if (is_hotspot()) {</span>
<span class="line-added">1418     return HotSpotJVMCI::resolve(a) == HotSpotJVMCI::resolve(b);</span>
<span class="line-added">1419   } else {</span>
<span class="line-added">1420     JNIAccessMark jni(this);</span>
<span class="line-added">1421     return jni()-&gt;IsSameObject(a.as_jobject(), b.as_jobject()) != 0;</span>
<span class="line-added">1422   }</span>
<span class="line-added">1423 }</span>
<span class="line-added">1424 </span>
<span class="line-added">1425 BasicType JVMCIEnv::kindToBasicType(JVMCIObject kind, JVMCI_TRAPS) {</span>
<span class="line-added">1426   if (kind.is_null()) {</span>
<span class="line-added">1427     JVMCI_THROW_(NullPointerException, T_ILLEGAL);</span>
<span class="line-added">1428   }</span>
<span class="line-added">1429   jchar ch = get_JavaKind_typeChar(kind);</span>
<span class="line-added">1430   switch(ch) {</span>
<span class="line-added">1431     case &#39;Z&#39;: return T_BOOLEAN;</span>
<span class="line-added">1432     case &#39;B&#39;: return T_BYTE;</span>
<span class="line-added">1433     case &#39;S&#39;: return T_SHORT;</span>
<span class="line-added">1434     case &#39;C&#39;: return T_CHAR;</span>
<span class="line-added">1435     case &#39;I&#39;: return T_INT;</span>
<span class="line-added">1436     case &#39;F&#39;: return T_FLOAT;</span>
<span class="line-added">1437     case &#39;J&#39;: return T_LONG;</span>
<span class="line-added">1438     case &#39;D&#39;: return T_DOUBLE;</span>
<span class="line-added">1439     case &#39;A&#39;: return T_OBJECT;</span>
<span class="line-added">1440     case &#39;-&#39;: return T_ILLEGAL;</span>
<span class="line-added">1441     default:</span>
<span class="line-added">1442       JVMCI_ERROR_(T_ILLEGAL, &quot;unexpected Kind: %c&quot;, ch);</span>
<span class="line-added">1443   }</span>
<span class="line-added">1444 }</span>
<span class="line-added">1445 </span>
<span class="line-added">1446 void JVMCIEnv::initialize_installed_code(JVMCIObject installed_code, CodeBlob* cb, JVMCI_TRAPS) {</span>
<span class="line-added">1447   // Ensure that all updates to the InstalledCode fields are consistent.</span>
<span class="line-added">1448   if (get_InstalledCode_address(installed_code) != 0) {</span>
<span class="line-added">1449     JVMCI_THROW_MSG(InternalError, &quot;InstalledCode instance already in use&quot;);</span>
<span class="line-added">1450   }</span>
<span class="line-added">1451   if (!isa_HotSpotInstalledCode(installed_code)) {</span>
<span class="line-added">1452     JVMCI_THROW_MSG(InternalError, &quot;InstalledCode instance must be a subclass of HotSpotInstalledCode&quot;);</span>
<span class="line-added">1453   }</span>
<span class="line-added">1454 </span>
<span class="line-added">1455   // Ignore the version which can stay at 0</span>
<span class="line-added">1456   if (cb-&gt;is_nmethod()) {</span>
<span class="line-added">1457     nmethod* nm = cb-&gt;as_nmethod_or_null();</span>
<span class="line-added">1458     if (!nm-&gt;is_alive()) {</span>
<span class="line-added">1459       JVMCI_THROW_MSG(InternalError, &quot;nmethod has been reclaimed&quot;);</span>
<span class="line-added">1460     }</span>
<span class="line-added">1461     if (nm-&gt;is_in_use()) {</span>
<span class="line-added">1462       set_InstalledCode_entryPoint(installed_code, (jlong) nm-&gt;verified_entry_point());</span>
<span class="line-added">1463     }</span>
<span class="line-added">1464   } else {</span>
<span class="line-added">1465     set_InstalledCode_entryPoint(installed_code, (jlong) cb-&gt;code_begin());</span>
<span class="line-added">1466   }</span>
<span class="line-added">1467   set_InstalledCode_address(installed_code, (jlong) cb);</span>
<span class="line-added">1468   set_HotSpotInstalledCode_size(installed_code, cb-&gt;size());</span>
<span class="line-added">1469   set_HotSpotInstalledCode_codeStart(installed_code, (jlong) cb-&gt;code_begin());</span>
<span class="line-added">1470   set_HotSpotInstalledCode_codeSize(installed_code, cb-&gt;code_size());</span>
<span class="line-added">1471 }</span>
<span class="line-added">1472 </span>
<span class="line-added">1473 </span>
<span class="line-added">1474 void JVMCIEnv::invalidate_nmethod_mirror(JVMCIObject mirror, JVMCI_TRAPS) {</span>
<span class="line-added">1475   if (mirror.is_null()) {</span>
<span class="line-added">1476     JVMCI_THROW(NullPointerException);</span>
<span class="line-added">1477   }</span>
<span class="line-added">1478 </span>
<span class="line-added">1479   nmethodLocker locker;</span>
<span class="line-added">1480   nmethod* nm = JVMCIENV-&gt;get_nmethod(mirror, locker);</span>
<span class="line-added">1481   if (nm == NULL) {</span>
<span class="line-added">1482     // Nothing to do</span>
<span class="line-added">1483     return;</span>
<span class="line-added">1484   }</span>
<span class="line-added">1485 </span>
<span class="line-added">1486   Thread* THREAD = Thread::current();</span>
<span class="line-added">1487   if (!mirror.is_hotspot() &amp;&amp; !THREAD-&gt;is_Java_thread()) {</span>
<span class="line-added">1488     // Calling back into native might cause the execution to block, so only allow this when calling</span>
<span class="line-added">1489     // from a JavaThread, which is the normal case anyway.</span>
<span class="line-added">1490     JVMCI_THROW_MSG(IllegalArgumentException,</span>
<span class="line-added">1491                     &quot;Cannot invalidate HotSpotNmethod object in shared library VM heap from non-JavaThread&quot;);</span>
<span class="line-added">1492   }</span>
<span class="line-added">1493 </span>
<span class="line-added">1494   nmethodLocker nml(nm);</span>
<span class="line-added">1495   if (nm-&gt;is_alive()) {</span>
<span class="line-added">1496     // Invalidating the HotSpotNmethod means we want the nmethod to be deoptimized.</span>
<span class="line-added">1497     Deoptimization::deoptimize_all_marked(nm);</span>
<span class="line-added">1498   }</span>
<span class="line-added">1499 </span>
<span class="line-added">1500   // A HotSpotNmethod instance can only reference a single nmethod</span>
<span class="line-added">1501   // during its lifetime so simply clear it here.</span>
<span class="line-added">1502   set_InstalledCode_address(mirror, 0);</span>
<span class="line-added">1503 }</span>
<span class="line-added">1504 </span>
<span class="line-added">1505 Klass* JVMCIEnv::asKlass(JVMCIObject obj) {</span>
<span class="line-added">1506   return (Klass*) get_HotSpotResolvedObjectTypeImpl_metadataPointer(obj);</span>
<span class="line-added">1507 }</span>
<span class="line-added">1508 </span>
<span class="line-added">1509 Method* JVMCIEnv::asMethod(JVMCIObject obj) {</span>
<span class="line-added">1510   Method** metadataHandle = (Method**) get_HotSpotResolvedJavaMethodImpl_metadataHandle(obj);</span>
<span class="line-added">1511   return *metadataHandle;</span>
<span class="line-added">1512 }</span>
<span class="line-added">1513 </span>
<span class="line-added">1514 ConstantPool* JVMCIEnv::asConstantPool(JVMCIObject obj) {</span>
<span class="line-added">1515   ConstantPool** metadataHandle = (ConstantPool**) get_HotSpotConstantPool_metadataHandle(obj);</span>
<span class="line-added">1516   return *metadataHandle;</span>
<span class="line-added">1517 }</span>
<span class="line-added">1518 </span>
<span class="line-added">1519 CodeBlob* JVMCIEnv::get_code_blob(JVMCIObject obj, nmethodLocker&amp; locker) {</span>
<span class="line-added">1520   address code = (address) get_InstalledCode_address(obj);</span>
<span class="line-added">1521   if (code == NULL) {</span>
<span class="line-added">1522     return NULL;</span>
<span class="line-added">1523   }</span>
<span class="line-added">1524   if (isa_HotSpotNmethod(obj)) {</span>
<span class="line-added">1525     nmethod* nm = NULL;</span>
<span class="line-added">1526     {</span>
<span class="line-added">1527       // Lookup the CodeBlob while holding the CodeCache_lock to ensure the nmethod can&#39;t be freed</span>
<span class="line-added">1528       // by nmethod::flush while we&#39;re interrogating it.</span>
<span class="line-added">1529       MutexLocker cm_lock(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-added">1530       CodeBlob* cb = CodeCache::find_blob_unsafe(code);</span>
<span class="line-added">1531       if (cb == (CodeBlob*) code) {</span>
<span class="line-added">1532         nmethod* the_nm = cb-&gt;as_nmethod_or_null();</span>
<span class="line-added">1533         if (the_nm != NULL &amp;&amp; the_nm-&gt;is_alive()) {</span>
<span class="line-added">1534           // Lock the nmethod to stop any further transitions by the sweeper.  It&#39;s still possible</span>
<span class="line-added">1535           // for this code to execute in the middle of the sweeping of the nmethod but that will be</span>
<span class="line-added">1536           // handled below.</span>
<span class="line-added">1537           locker.set_code(nm, true);</span>
<span class="line-added">1538           nm = the_nm;</span>
1539         }
<a name="67" id="anc67"></a><span class="line-added">1540       }</span>
<span class="line-added">1541     }</span>
<span class="line-added">1542 </span>
<span class="line-added">1543     if (nm != NULL) {</span>
<span class="line-added">1544       // We found the nmethod but it could be in the process of being freed.  Check the state of the</span>
<span class="line-added">1545       // nmethod while holding the CompiledMethod_lock.  This ensures that any transitions by other</span>
<span class="line-added">1546       // threads have seen the is_locked_by_vm() update above.</span>
<span class="line-added">1547       MutexLocker cm_lock(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-added">1548       if (!nm-&gt;is_alive()) {</span>
<span class="line-added">1549         //  It was alive when we looked it up but it&#39;s no longer alive so release it.</span>
<span class="line-added">1550         locker.set_code(NULL);</span>
<span class="line-added">1551         nm = NULL;</span>
<span class="line-added">1552       }</span>
<span class="line-added">1553     }</span>
1554 
<a name="68" id="anc68"></a><span class="line-modified">1555     jlong compile_id_snapshot = get_HotSpotNmethod_compileIdSnapshot(obj);</span>
<span class="line-modified">1556     if (compile_id_snapshot != 0L) {</span>
<span class="line-modified">1557       // Found a live nmethod with the same address, make sure it&#39;s the same nmethod</span>
<span class="line-modified">1558       if (nm == (nmethod*) code &amp;&amp; nm-&gt;compile_id() == compile_id_snapshot &amp;&amp; nm-&gt;is_alive()) {</span>
<span class="line-modified">1559         if (nm-&gt;is_not_entrant()) {</span>
<span class="line-modified">1560           // Zero the entry point so that the nmethod</span>
<span class="line-modified">1561           // cannot be invoked by the mirror but can</span>
<span class="line-modified">1562           // still be deoptimized.</span>
<span class="line-modified">1563           set_InstalledCode_entryPoint(obj, 0);</span>



























1564         }
<a name="69" id="anc69"></a><span class="line-modified">1565         return nm;</span>
1566       }
<a name="70" id="anc70"></a><span class="line-modified">1567       // The HotSpotNmethod no longer refers to a valid nmethod so clear the state</span>
<span class="line-added">1568       locker.set_code(NULL);</span>
<span class="line-added">1569       nm = NULL;</span>
1570     }
<a name="71" id="anc71"></a><span class="line-added">1571 </span>
<span class="line-added">1572     if (nm == NULL) {</span>
<span class="line-added">1573       // The HotSpotNmethod was pointing at some nmethod but the nmethod is no longer valid, so</span>
<span class="line-added">1574       // clear the InstalledCode fields of this HotSpotNmethod so that it no longer refers to a</span>
<span class="line-added">1575       // nmethod in the code cache.</span>
<span class="line-added">1576       set_InstalledCode_address(obj, 0);</span>
<span class="line-added">1577       set_InstalledCode_entryPoint(obj, 0);</span>
<span class="line-added">1578     }</span>
<span class="line-added">1579     return nm;</span>
1580   }
1581 
<a name="72" id="anc72"></a><span class="line-modified">1582   CodeBlob* cb = (CodeBlob*) code;</span>
<span class="line-modified">1583   assert(!cb-&gt;is_nmethod(), &quot;unexpected nmethod&quot;);</span>
<span class="line-modified">1584   return cb;</span>
<span class="line-modified">1585 }</span>
<span class="line-modified">1586 </span>
<span class="line-added">1587 nmethod* JVMCIEnv::get_nmethod(JVMCIObject obj, nmethodLocker&amp; locker) {</span>
<span class="line-added">1588   CodeBlob* cb = get_code_blob(obj, locker);</span>
<span class="line-added">1589   if (cb != NULL) {</span>
<span class="line-added">1590     return cb-&gt;as_nmethod_or_null();</span>
1591   }
<a name="73" id="anc73"></a><span class="line-added">1592   return NULL;</span>
<span class="line-added">1593 }</span>
1594 
<a name="74" id="anc74"></a><span class="line-modified">1595 // Generate implementations for the initialize, new, isa, get and set methods for all the types and</span>
<span class="line-modified">1596 // fields declared in the JVMCI_CLASSES_DO macro.</span>

1597 
<a name="75" id="anc75"></a><span class="line-modified">1598 #define START_CLASS(className, fullClassName)                                                                        \</span>
<span class="line-modified">1599   void JVMCIEnv::className##_initialize(JVMCI_TRAPS) {                                                               \</span>
<span class="line-modified">1600     if (is_hotspot()) {                                                                                              \</span>
<span class="line-modified">1601       HotSpotJVMCI::className::initialize(JVMCI_CHECK);                                                              \</span>
<span class="line-modified">1602     } else {                                                                                                         \</span>
<span class="line-modified">1603       JNIJVMCI::className::initialize(JVMCI_CHECK);                                                                  \</span>
<span class="line-added">1604     }                                                                                                                \</span>
<span class="line-added">1605   }                                                                                                                  \</span>
<span class="line-added">1606   JVMCIObjectArray JVMCIEnv::new_##className##_array(int length, JVMCI_TRAPS) {                                      \</span>
<span class="line-added">1607     if (is_hotspot()) {                                                                                              \</span>
<span class="line-added">1608       Thread* THREAD = Thread::current();                                                                            \</span>
<span class="line-added">1609       objArrayOop array = oopFactory::new_objArray(HotSpotJVMCI::className::klass(), length, CHECK_(JVMCIObject())); \</span>
<span class="line-added">1610       return (JVMCIObjectArray) wrap(array);                                                                         \</span>
<span class="line-added">1611     } else {                                                                                                         \</span>
<span class="line-added">1612       JNIAccessMark jni(this);                                                                                       \</span>
<span class="line-added">1613       jobjectArray result = jni()-&gt;NewObjectArray(length, JNIJVMCI::className::clazz(), NULL);                       \</span>
<span class="line-added">1614       return wrap(result);                                                                                           \</span>
<span class="line-added">1615     }                                                                                                                \</span>
<span class="line-added">1616   }                                                                                                                  \</span>
<span class="line-added">1617   bool JVMCIEnv::isa_##className(JVMCIObject object) {                                                               \</span>
<span class="line-added">1618     if (is_hotspot()) {                                                                                              \</span>
<span class="line-added">1619       return HotSpotJVMCI::className::is_instance(this, object);                                                     \</span>
<span class="line-added">1620     } else {                                                                                                         \</span>
<span class="line-added">1621       return JNIJVMCI::className::is_instance(this, object);                                                         \</span>
<span class="line-added">1622     }                                                                                                                \</span>
1623   }
1624 
<a name="76" id="anc76"></a><span class="line-modified">1625 #define END_CLASS</span>
<span class="line-modified">1626 </span>
<span class="line-added">1627 #define FIELD(className, name, type, accessor, cast)                 \</span>
<span class="line-added">1628   type JVMCIEnv::get_##className##_##name(JVMCIObject obj) {         \</span>
<span class="line-added">1629     if (is_hotspot()) {                                              \</span>
<span class="line-added">1630       return HotSpotJVMCI::className::get_##name(this, obj);         \</span>
<span class="line-added">1631     } else {                                                         \</span>
<span class="line-added">1632       return JNIJVMCI::className::get_##name(this, obj);             \</span>
<span class="line-added">1633     }                                                                \</span>
<span class="line-added">1634   }                                                                  \</span>
<span class="line-added">1635   void JVMCIEnv::set_##className##_##name(JVMCIObject obj, type x) { \</span>
<span class="line-added">1636     if (is_hotspot()) {                                              \</span>
<span class="line-added">1637       HotSpotJVMCI::className::set_##name(this, obj, x);             \</span>
<span class="line-added">1638     } else {                                                         \</span>
<span class="line-added">1639       JNIJVMCI::className::set_##name(this, obj, x);                 \</span>
<span class="line-added">1640     }                                                                \</span>
<span class="line-added">1641   }</span>
<span class="line-added">1642 </span>
<span class="line-added">1643 #define EMPTY_CAST</span>
<span class="line-added">1644 #define CHAR_FIELD(className, name)                    FIELD(className, name, jchar, Char, EMPTY_CAST)</span>
<span class="line-added">1645 #define INT_FIELD(className, name)                     FIELD(className, name, jint, Int, EMPTY_CAST)</span>
<span class="line-added">1646 #define BOOLEAN_FIELD(className, name)                 FIELD(className, name, jboolean, Boolean, EMPTY_CAST)</span>
<span class="line-added">1647 #define LONG_FIELD(className, name)                    FIELD(className, name, jlong, Long, EMPTY_CAST)</span>
<span class="line-added">1648 #define FLOAT_FIELD(className, name)                   FIELD(className, name, jfloat, Float, EMPTY_CAST)</span>
<span class="line-added">1649 </span>
<span class="line-added">1650 #define OBJECT_FIELD(className, name, signature)              OOPISH_FIELD(className, name, JVMCIObject, Object, EMPTY_CAST)</span>
<span class="line-added">1651 #define OBJECTARRAY_FIELD(className, name, signature)         OOPISH_FIELD(className, name, JVMCIObjectArray, Object, (JVMCIObjectArray))</span>
<span class="line-added">1652 #define PRIMARRAY_FIELD(className, name, signature)           OOPISH_FIELD(className, name, JVMCIPrimitiveArray, Object, (JVMCIPrimitiveArray))</span>
<span class="line-added">1653 </span>
<span class="line-added">1654 #define STATIC_OBJECT_FIELD(className, name, signature)       STATIC_OOPISH_FIELD(className, name, JVMCIObject, Object, (JVMCIObject))</span>
<span class="line-added">1655 #define STATIC_OBJECTARRAY_FIELD(className, name, signature)  STATIC_OOPISH_FIELD(className, name, JVMCIObjectArray, Object, (JVMCIObjectArray))</span>
<span class="line-added">1656 </span>
<span class="line-added">1657 #define OOPISH_FIELD(className, name, type, accessor, cast)           \</span>
<span class="line-added">1658   type JVMCIEnv::get_##className##_##name(JVMCIObject obj) {          \</span>
<span class="line-added">1659     if (is_hotspot()) {                                               \</span>
<span class="line-added">1660       return HotSpotJVMCI::className::get_##name(this, obj);          \</span>
<span class="line-added">1661     } else {                                                          \</span>
<span class="line-added">1662       return JNIJVMCI::className::get_##name(this, obj);              \</span>
<span class="line-added">1663     }                                                                 \</span>
<span class="line-added">1664   }                                                                   \</span>
<span class="line-added">1665   void JVMCIEnv::set_##className##_##name(JVMCIObject obj, type x) {  \</span>
<span class="line-added">1666     if (is_hotspot()) {                                               \</span>
<span class="line-added">1667       HotSpotJVMCI::className::set_##name(this, obj, x);              \</span>
<span class="line-added">1668     } else {                                                          \</span>
<span class="line-added">1669       JNIJVMCI::className::set_##name(this, obj, x);                  \</span>
<span class="line-added">1670     }                                                                 \</span>
<span class="line-added">1671   }</span>
<span class="line-added">1672 </span>
<span class="line-added">1673 #define STATIC_OOPISH_FIELD(className, name, type, accessor, cast)    \</span>
<span class="line-added">1674   type JVMCIEnv::get_##className##_##name() {                         \</span>
<span class="line-added">1675     if (is_hotspot()) {                                               \</span>
<span class="line-added">1676       return HotSpotJVMCI::className::get_##name(this);               \</span>
<span class="line-added">1677     } else {                                                          \</span>
<span class="line-added">1678       return JNIJVMCI::className::get_##name(this);                   \</span>
<span class="line-added">1679     }                                                                 \</span>
<span class="line-added">1680   }                                                                   \</span>
<span class="line-added">1681   void JVMCIEnv::set_##className##_##name(type x) {                   \</span>
<span class="line-added">1682     if (is_hotspot()) {                                               \</span>
<span class="line-added">1683       HotSpotJVMCI::className::set_##name(this, x);                   \</span>
<span class="line-added">1684     } else {                                                          \</span>
<span class="line-added">1685       JNIJVMCI::className::set_##name(this, x);                       \</span>
<span class="line-added">1686     }                                                                 \</span>
<span class="line-added">1687   }</span>
<span class="line-added">1688 </span>
<span class="line-added">1689 #define STATIC_PRIMITIVE_FIELD(className, name, type, accessor, cast) \</span>
<span class="line-added">1690   type JVMCIEnv::get_##className##_##name() {                         \</span>
<span class="line-added">1691     if (is_hotspot()) {                                               \</span>
<span class="line-added">1692       return HotSpotJVMCI::className::get_##name(this);               \</span>
<span class="line-added">1693     } else {                                                          \</span>
<span class="line-added">1694       return JNIJVMCI::className::get_##name(this);                   \</span>
<span class="line-added">1695     }                                                                 \</span>
<span class="line-added">1696   }                                                                   \</span>
<span class="line-added">1697   void JVMCIEnv::set_##className##_##name(type x) {                   \</span>
<span class="line-added">1698     if (is_hotspot()) {                                               \</span>
<span class="line-added">1699       HotSpotJVMCI::className::set_##name(this, x);                   \</span>
<span class="line-added">1700     } else {                                                          \</span>
<span class="line-added">1701       JNIJVMCI::className::set_##name(this, x);                       \</span>
<span class="line-added">1702     }                                                                 \</span>
<span class="line-added">1703   }</span>
<span class="line-added">1704 #define STATIC_INT_FIELD(className, name) STATIC_PRIMITIVE_FIELD(className, name, jint, Int, EMPTY_CAST)</span>
<span class="line-added">1705 #define STATIC_BOOLEAN_FIELD(className, name) STATIC_PRIMITIVE_FIELD(className, name, jboolean, Boolean, EMPTY_CAST)</span>
<span class="line-added">1706 #define METHOD(jniCallType, jniGetMethod, hsCallType, returnType, className, methodName, signatureSymbolName, args)</span>
<span class="line-added">1707 #define CONSTRUCTOR(className, signature)</span>
<span class="line-added">1708 </span>
<span class="line-added">1709 JVMCI_CLASSES_DO(START_CLASS, END_CLASS, CHAR_FIELD, INT_FIELD, BOOLEAN_FIELD, LONG_FIELD, FLOAT_FIELD, OBJECT_FIELD, PRIMARRAY_FIELD, OBJECTARRAY_FIELD, STATIC_OBJECT_FIELD, STATIC_OBJECTARRAY_FIELD, STATIC_INT_FIELD, STATIC_BOOLEAN_FIELD, METHOD, CONSTRUCTOR)</span>
<span class="line-added">1710 </span>
<span class="line-added">1711 #undef START_CLASS</span>
<span class="line-added">1712 #undef END_CLASS</span>
<span class="line-added">1713 #undef METHOD</span>
<span class="line-added">1714 #undef CONSTRUCTOR</span>
<span class="line-added">1715 #undef FIELD</span>
<span class="line-added">1716 #undef CHAR_FIELD</span>
<span class="line-added">1717 #undef INT_FIELD</span>
<span class="line-added">1718 #undef BOOLEAN_FIELD</span>
<span class="line-added">1719 #undef LONG_FIELD</span>
<span class="line-added">1720 #undef FLOAT_FIELD</span>
<span class="line-added">1721 #undef OBJECT_FIELD</span>
<span class="line-added">1722 #undef PRIMARRAY_FIELD</span>
<span class="line-added">1723 #undef OBJECTARRAY_FIELD</span>
<span class="line-added">1724 #undef STATIC_OOPISH_FIELD</span>
<span class="line-added">1725 #undef STATIC_OBJECT_FIELD</span>
<span class="line-added">1726 #undef STATIC_OBJECTARRAY_FIELD</span>
<span class="line-added">1727 #undef STATIC_INT_FIELD</span>
<span class="line-added">1728 #undef STATIC_BOOLEAN_FIELD</span>
<span class="line-added">1729 #undef EMPTY_CAST</span>
<a name="77" id="anc77"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="77" type="hidden" />
</body>
</html>