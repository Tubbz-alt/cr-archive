<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jvmci/jvmci_globals.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmciRuntime.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmci_globals.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmci_globals.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,30 +25,21 @@</span>
  #include &quot;precompiled.hpp&quot;
  #include &quot;jvm.h&quot;
  #include &quot;jvmci/jvmci_globals.hpp&quot;
  #include &quot;gc/shared/gcConfig.hpp&quot;
  #include &quot;utilities/defaultStream.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/ostream.hpp&quot;</span>
  #include &quot;runtime/globals_extension.hpp&quot;
  
<span class="udiff-line-modified-removed">- JVMCI_FLAGS(MATERIALIZE_DEVELOPER_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_PD_DEVELOPER_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_PRODUCT_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_PD_PRODUCT_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_DIAGNOSTIC_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_PD_DIAGNOSTIC_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_EXPERIMENTAL_FLAG, \</span>
<span class="udiff-line-removed">-             MATERIALIZE_NOTPRODUCT_FLAG,</span>
<span class="udiff-line-removed">-             IGNORE_RANGE, \</span>
<span class="udiff-line-removed">-             IGNORE_CONSTRAINT, \</span>
<span class="udiff-line-removed">-             IGNORE_WRITEABLE)</span>
<span class="udiff-line-modified-added">+ fileStream* JVMCIGlobals::_jni_config_file = NULL;</span>
  
  // Return true if jvmci flags are consistent.
  bool JVMCIGlobals::check_jvmci_flags_are_consistent() {
  
  #ifndef PRODUCT
  #define APPLY_JVMCI_FLAGS(params3, params4) \
<span class="udiff-line-modified-removed">-   JVMCI_FLAGS(params4, params3, params4, params3, params4, params3, params4, params4, IGNORE_RANGE, IGNORE_CONSTRAINT, IGNORE_WRITEABLE)</span>
<span class="udiff-line-modified-added">+   JVMCI_FLAGS(params4, params3, params4, params3, params4, params3, params4, params4, IGNORE_RANGE, IGNORE_CONSTRAINT)</span>
  #define JVMCI_DECLARE_CHECK4(type, name, value, doc) bool name##checked = false;
  #define JVMCI_DECLARE_CHECK3(type, name, doc)        bool name##checked = false;
  #define JVMCI_FLAG_CHECKED(name)                          name##checked = true;
    APPLY_JVMCI_FLAGS(JVMCI_DECLARE_CHECK3, JVMCI_DECLARE_CHECK4)
  #else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -62,25 +53,47 @@</span>
      jio_fprintf(defaultStream::error_stream(),         \
          &quot;Improperly specified VM option &#39;%s&#39;: &#39;%s&#39; must be enabled\n&quot;, #FLAG, #GUARD); \
      return false;                                      \
    }
  
<span class="udiff-line-added">+   if (EnableJVMCIProduct) {</span>
<span class="udiff-line-added">+     if (FLAG_IS_DEFAULT(EnableJVMCI)) {</span>
<span class="udiff-line-added">+       FLAG_SET_DEFAULT(EnableJVMCI, true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (EnableJVMCI &amp;&amp; FLAG_IS_DEFAULT(UseJVMCICompiler)) {</span>
<span class="udiff-line-added">+       FLAG_SET_DEFAULT(UseJVMCICompiler, true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    JVMCI_FLAG_CHECKED(UseJVMCICompiler)
    JVMCI_FLAG_CHECKED(EnableJVMCI)
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(EnableJVMCIProduct)</span>
  
    CHECK_NOT_SET(BootstrapJVMCI,   UseJVMCICompiler)
    CHECK_NOT_SET(PrintBootstrap,   UseJVMCICompiler)
    CHECK_NOT_SET(JVMCIThreads,     UseJVMCICompiler)
    CHECK_NOT_SET(JVMCIHostThreads, UseJVMCICompiler)
  
    if (UseJVMCICompiler) {
<span class="udiff-line-added">+     if (FLAG_IS_DEFAULT(UseJVMCINativeLibrary) &amp;&amp; !UseJVMCINativeLibrary) {</span>
<span class="udiff-line-added">+       char path[JVM_MAXPATHLEN];</span>
<span class="udiff-line-added">+       if (os::dll_locate_lib(path, sizeof(path), Arguments::get_dll_dir(), JVMCI_SHARED_LIBRARY_NAME)) {</span>
<span class="udiff-line-added">+         // If a JVMCI native library is present,</span>
<span class="udiff-line-added">+         // we enable UseJVMCINativeLibrary by default.</span>
<span class="udiff-line-added">+         FLAG_SET_DEFAULT(UseJVMCINativeLibrary, true);</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     }</span>
      if (!FLAG_IS_DEFAULT(EnableJVMCI) &amp;&amp; !EnableJVMCI) {
        jio_fprintf(defaultStream::error_stream(),
            &quot;Improperly specified VM option UseJVMCICompiler: EnableJVMCI cannot be disabled\n&quot;);
        return false;
      }
      FLAG_SET_DEFAULT(EnableJVMCI, true);
<span class="udiff-line-added">+     if (BootstrapJVMCI &amp;&amp; UseJVMCINativeLibrary) {</span>
<span class="udiff-line-added">+       jio_fprintf(defaultStream::error_stream(), &quot;-XX:+BootstrapJVMCI is not compatible with -XX:+UseJVMCINativeLibrary\n&quot;);</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     }</span>
    }
  
    if (!EnableJVMCI) {
      // Switch off eager JVMCI initialization if JVMCI is disabled.
      // Don&#39;t throw error if EagerJVMCI is set to allow testing.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,11 +108,23 @@</span>
    CHECK_NOT_SET(JVMCICountersExcludeCompiler, EnableJVMCI)
    CHECK_NOT_SET(JVMCIUseFastLocking,          EnableJVMCI)
    CHECK_NOT_SET(JVMCINMethodSizeLimit,        EnableJVMCI)
    CHECK_NOT_SET(MethodProfileWidth,           EnableJVMCI)
    CHECK_NOT_SET(JVMCIPrintProperties,         EnableJVMCI)
<span class="udiff-line-modified-removed">-   CHECK_NOT_SET(TraceUncollectedSpeculations, EnableJVMCI)</span>
<span class="udiff-line-modified-added">+   CHECK_NOT_SET(UseJVMCINativeLibrary,        EnableJVMCI)</span>
<span class="udiff-line-added">+   CHECK_NOT_SET(JVMCILibPath,                 EnableJVMCI)</span>
<span class="udiff-line-added">+   CHECK_NOT_SET(JVMCILibDumpJNIConfig,        EnableJVMCI)</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifndef COMPILER2</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(MaxVectorSize)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(ReduceInitialCardMarks)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(UseMultiplyToLenIntrinsic)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(UseSquareToLenIntrinsic)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(UseMulAddIntrinsic)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(UseMontgomeryMultiplyIntrinsic)</span>
<span class="udiff-line-added">+   JVMCI_FLAG_CHECKED(UseMontgomerySquareIntrinsic)</span>
<span class="udiff-line-added">+ #endif // !COMPILER2</span>
  
  #ifndef PRODUCT
  #define JVMCI_CHECK4(type, name, value, doc) assert(name##checked, #name &quot; flag not checked&quot;);
  #define JVMCI_CHECK3(type, name, doc)        assert(name##checked, #name &quot; flag not checked&quot;);
    // Ensures that all JVMCI flags are checked by this method.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -108,18 +133,70 @@</span>
  #undef JVMCI_DECLARE_CHECK3
  #undef JVMCI_DECLARE_CHECK4
  #undef JVMCI_CHECK3
  #undef JVMCI_CHECK4
  #undef JVMCI_FLAG_CHECKED
<span class="udiff-line-modified-removed">- #endif</span>
<span class="udiff-line-modified-added">+ #endif // PRODUCT</span>
  #undef CHECK_NOT_SET
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (JVMCILibDumpJNIConfig != NULL) {</span>
<span class="udiff-line-added">+     _jni_config_file = new(ResourceObj::C_HEAP, mtJVMCI) fileStream(JVMCILibDumpJNIConfig);</span>
<span class="udiff-line-added">+     if (_jni_config_file == NULL || !_jni_config_file-&gt;is_open()) {</span>
<span class="udiff-line-added">+       jio_fprintf(defaultStream::error_stream(),</span>
<span class="udiff-line-added">+           &quot;Could not open file for dumping JVMCI shared library JNI config: %s\n&quot;, JVMCILibDumpJNIConfig);</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    return true;
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // Convert JVMCI flags from experimental to product</span>
<span class="udiff-line-added">+ bool JVMCIGlobals::enable_jvmci_product_mode(JVMFlag::Flags origin) {</span>
<span class="udiff-line-added">+   const char *JVMCIFlags[] = {</span>
<span class="udiff-line-added">+     &quot;EnableJVMCI&quot;,</span>
<span class="udiff-line-added">+     &quot;EnableJVMCIProduct&quot;,</span>
<span class="udiff-line-added">+     &quot;UseJVMCICompiler&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCIPrintProperties&quot;,</span>
<span class="udiff-line-added">+     &quot;EagerJVMCI&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCIThreads&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCICounterSize&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCICountersExcludeCompiler&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCINMethodSizeLimit&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCILibPath&quot;,</span>
<span class="udiff-line-added">+     &quot;JVMCILibDumpJNIConfig&quot;,</span>
<span class="udiff-line-added">+     &quot;UseJVMCINativeLibrary&quot;,</span>
<span class="udiff-line-added">+     NULL</span>
<span class="udiff-line-added">+   };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (int i = 0; JVMCIFlags[i] != NULL; i++) {</span>
<span class="udiff-line-added">+     JVMFlag *jvmciFlag = (JVMFlag *)JVMFlag::find_declared_flag(JVMCIFlags[i]);</span>
<span class="udiff-line-added">+     if (jvmciFlag == NULL) {</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     jvmciFlag-&gt;clear_experimental();</span>
<span class="udiff-line-added">+     jvmciFlag-&gt;set_product();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool value = true;</span>
<span class="udiff-line-added">+   JVMFlag *jvmciEnableFlag = JVMFlag::find_flag(&quot;EnableJVMCIProduct&quot;);</span>
<span class="udiff-line-added">+   if (JVMFlag::boolAtPut(jvmciEnableFlag, &amp;value, origin) != JVMFlag::SUCCESS) {</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Effect of EnableJVMCIProduct on changing defaults of EnableJVMCI</span>
<span class="udiff-line-added">+   // and UseJVMCICompiler is deferred to check_jvmci_flags_are_consistent</span>
<span class="udiff-line-added">+   // so that setting these flags explicitly (e.g. on the command line)</span>
<span class="udiff-line-added">+   // takes precedence.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void JVMCIGlobals::check_jvmci_supported_gc() {
    if (EnableJVMCI) {
      // Check if selected GC is supported by JVMCI and Java compiler
<span class="udiff-line-modified-removed">-     if (!(UseSerialGC || UseParallelGC || UseParallelOldGC || UseG1GC)) {</span>
<span class="udiff-line-modified-added">+     if (!(UseSerialGC || UseParallelGC || UseG1GC)) {</span>
        vm_exit_during_initialization(&quot;JVMCI Compiler does not support selected GC&quot;, GCConfig::hs_err_name());
        FLAG_SET_DEFAULT(EnableJVMCI, false);
        FLAG_SET_DEFAULT(UseJVMCICompiler, false);
      }
    }
</pre>
<center><a href="jvmciRuntime.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmci_globals.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>