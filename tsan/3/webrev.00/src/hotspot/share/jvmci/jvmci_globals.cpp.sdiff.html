<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jvmci/jvmci_globals.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmciRuntime.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmci_globals.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmci_globals.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;jvmci/jvmci_globals.hpp&quot;
 28 #include &quot;gc/shared/gcConfig.hpp&quot;
 29 #include &quot;utilities/defaultStream.hpp&quot;

 30 #include &quot;runtime/globals_extension.hpp&quot;
 31 
<span class="line-modified"> 32 JVMCI_FLAGS(MATERIALIZE_DEVELOPER_FLAG, \</span>
<span class="line-removed"> 33             MATERIALIZE_PD_DEVELOPER_FLAG, \</span>
<span class="line-removed"> 34             MATERIALIZE_PRODUCT_FLAG, \</span>
<span class="line-removed"> 35             MATERIALIZE_PD_PRODUCT_FLAG, \</span>
<span class="line-removed"> 36             MATERIALIZE_DIAGNOSTIC_FLAG, \</span>
<span class="line-removed"> 37             MATERIALIZE_PD_DIAGNOSTIC_FLAG, \</span>
<span class="line-removed"> 38             MATERIALIZE_EXPERIMENTAL_FLAG, \</span>
<span class="line-removed"> 39             MATERIALIZE_NOTPRODUCT_FLAG,</span>
<span class="line-removed"> 40             IGNORE_RANGE, \</span>
<span class="line-removed"> 41             IGNORE_CONSTRAINT, \</span>
<span class="line-removed"> 42             IGNORE_WRITEABLE)</span>
 43 
 44 // Return true if jvmci flags are consistent.
 45 bool JVMCIGlobals::check_jvmci_flags_are_consistent() {
 46 
 47 #ifndef PRODUCT
 48 #define APPLY_JVMCI_FLAGS(params3, params4) \
<span class="line-modified"> 49   JVMCI_FLAGS(params4, params3, params4, params3, params4, params3, params4, params4, IGNORE_RANGE, IGNORE_CONSTRAINT, IGNORE_WRITEABLE)</span>
 50 #define JVMCI_DECLARE_CHECK4(type, name, value, doc) bool name##checked = false;
 51 #define JVMCI_DECLARE_CHECK3(type, name, doc)        bool name##checked = false;
 52 #define JVMCI_FLAG_CHECKED(name)                          name##checked = true;
 53   APPLY_JVMCI_FLAGS(JVMCI_DECLARE_CHECK3, JVMCI_DECLARE_CHECK4)
 54 #else
 55 #define JVMCI_FLAG_CHECKED(name)
 56 #endif
 57 
 58   // Checks that a given flag is not set if a given guard flag is false.
 59 #define CHECK_NOT_SET(FLAG, GUARD)                     \
 60   JVMCI_FLAG_CHECKED(FLAG)                             \
 61   if (!GUARD &amp;&amp; !FLAG_IS_DEFAULT(FLAG)) {              \
 62     jio_fprintf(defaultStream::error_stream(),         \
 63         &quot;Improperly specified VM option &#39;%s&#39;: &#39;%s&#39; must be enabled\n&quot;, #FLAG, #GUARD); \
 64     return false;                                      \
 65   }
 66 









 67   JVMCI_FLAG_CHECKED(UseJVMCICompiler)
 68   JVMCI_FLAG_CHECKED(EnableJVMCI)

 69 
 70   CHECK_NOT_SET(BootstrapJVMCI,   UseJVMCICompiler)
 71   CHECK_NOT_SET(PrintBootstrap,   UseJVMCICompiler)
 72   CHECK_NOT_SET(JVMCIThreads,     UseJVMCICompiler)
 73   CHECK_NOT_SET(JVMCIHostThreads, UseJVMCICompiler)
 74 
 75   if (UseJVMCICompiler) {








 76     if (!FLAG_IS_DEFAULT(EnableJVMCI) &amp;&amp; !EnableJVMCI) {
 77       jio_fprintf(defaultStream::error_stream(),
 78           &quot;Improperly specified VM option UseJVMCICompiler: EnableJVMCI cannot be disabled\n&quot;);
 79       return false;
 80     }
 81     FLAG_SET_DEFAULT(EnableJVMCI, true);




 82   }
 83 
 84   if (!EnableJVMCI) {
 85     // Switch off eager JVMCI initialization if JVMCI is disabled.
 86     // Don&#39;t throw error if EagerJVMCI is set to allow testing.
 87     if (EagerJVMCI) {
 88       FLAG_SET_DEFAULT(EagerJVMCI, false);
 89     }
 90   }
 91   JVMCI_FLAG_CHECKED(EagerJVMCI)
 92 
 93   CHECK_NOT_SET(JVMCITraceLevel,              EnableJVMCI)
 94   CHECK_NOT_SET(JVMCICounterSize,             EnableJVMCI)
 95   CHECK_NOT_SET(JVMCICountersExcludeCompiler, EnableJVMCI)
 96   CHECK_NOT_SET(JVMCIUseFastLocking,          EnableJVMCI)
 97   CHECK_NOT_SET(JVMCINMethodSizeLimit,        EnableJVMCI)
 98   CHECK_NOT_SET(MethodProfileWidth,           EnableJVMCI)
 99   CHECK_NOT_SET(JVMCIPrintProperties,         EnableJVMCI)
<span class="line-modified">100   CHECK_NOT_SET(TraceUncollectedSpeculations, EnableJVMCI)</span>












101 
102 #ifndef PRODUCT
103 #define JVMCI_CHECK4(type, name, value, doc) assert(name##checked, #name &quot; flag not checked&quot;);
104 #define JVMCI_CHECK3(type, name, doc)        assert(name##checked, #name &quot; flag not checked&quot;);
105   // Ensures that all JVMCI flags are checked by this method.
106   APPLY_JVMCI_FLAGS(JVMCI_CHECK3, JVMCI_CHECK4)
107 #undef APPLY_JVMCI_FLAGS
108 #undef JVMCI_DECLARE_CHECK3
109 #undef JVMCI_DECLARE_CHECK4
110 #undef JVMCI_CHECK3
111 #undef JVMCI_CHECK4
112 #undef JVMCI_FLAG_CHECKED
<span class="line-modified">113 #endif</span>
114 #undef CHECK_NOT_SET










115   return true;
116 }










































117 void JVMCIGlobals::check_jvmci_supported_gc() {
118   if (EnableJVMCI) {
119     // Check if selected GC is supported by JVMCI and Java compiler
<span class="line-modified">120     if (!(UseSerialGC || UseParallelGC || UseParallelOldGC || UseG1GC)) {</span>
121       vm_exit_during_initialization(&quot;JVMCI Compiler does not support selected GC&quot;, GCConfig::hs_err_name());
122       FLAG_SET_DEFAULT(EnableJVMCI, false);
123       FLAG_SET_DEFAULT(UseJVMCICompiler, false);
124     }
125   }
126 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;jvm.h&quot;
 27 #include &quot;jvmci/jvmci_globals.hpp&quot;
 28 #include &quot;gc/shared/gcConfig.hpp&quot;
 29 #include &quot;utilities/defaultStream.hpp&quot;
<span class="line-added"> 30 #include &quot;utilities/ostream.hpp&quot;</span>
 31 #include &quot;runtime/globals_extension.hpp&quot;
 32 
<span class="line-modified"> 33 fileStream* JVMCIGlobals::_jni_config_file = NULL;</span>










 34 
 35 // Return true if jvmci flags are consistent.
 36 bool JVMCIGlobals::check_jvmci_flags_are_consistent() {
 37 
 38 #ifndef PRODUCT
 39 #define APPLY_JVMCI_FLAGS(params3, params4) \
<span class="line-modified"> 40   JVMCI_FLAGS(params4, params3, params4, params3, params4, params3, params4, params4, IGNORE_RANGE, IGNORE_CONSTRAINT)</span>
 41 #define JVMCI_DECLARE_CHECK4(type, name, value, doc) bool name##checked = false;
 42 #define JVMCI_DECLARE_CHECK3(type, name, doc)        bool name##checked = false;
 43 #define JVMCI_FLAG_CHECKED(name)                          name##checked = true;
 44   APPLY_JVMCI_FLAGS(JVMCI_DECLARE_CHECK3, JVMCI_DECLARE_CHECK4)
 45 #else
 46 #define JVMCI_FLAG_CHECKED(name)
 47 #endif
 48 
 49   // Checks that a given flag is not set if a given guard flag is false.
 50 #define CHECK_NOT_SET(FLAG, GUARD)                     \
 51   JVMCI_FLAG_CHECKED(FLAG)                             \
 52   if (!GUARD &amp;&amp; !FLAG_IS_DEFAULT(FLAG)) {              \
 53     jio_fprintf(defaultStream::error_stream(),         \
 54         &quot;Improperly specified VM option &#39;%s&#39;: &#39;%s&#39; must be enabled\n&quot;, #FLAG, #GUARD); \
 55     return false;                                      \
 56   }
 57 
<span class="line-added"> 58   if (EnableJVMCIProduct) {</span>
<span class="line-added"> 59     if (FLAG_IS_DEFAULT(EnableJVMCI)) {</span>
<span class="line-added"> 60       FLAG_SET_DEFAULT(EnableJVMCI, true);</span>
<span class="line-added"> 61     }</span>
<span class="line-added"> 62     if (EnableJVMCI &amp;&amp; FLAG_IS_DEFAULT(UseJVMCICompiler)) {</span>
<span class="line-added"> 63       FLAG_SET_DEFAULT(UseJVMCICompiler, true);</span>
<span class="line-added"> 64     }</span>
<span class="line-added"> 65   }</span>
<span class="line-added"> 66 </span>
 67   JVMCI_FLAG_CHECKED(UseJVMCICompiler)
 68   JVMCI_FLAG_CHECKED(EnableJVMCI)
<span class="line-added"> 69   JVMCI_FLAG_CHECKED(EnableJVMCIProduct)</span>
 70 
 71   CHECK_NOT_SET(BootstrapJVMCI,   UseJVMCICompiler)
 72   CHECK_NOT_SET(PrintBootstrap,   UseJVMCICompiler)
 73   CHECK_NOT_SET(JVMCIThreads,     UseJVMCICompiler)
 74   CHECK_NOT_SET(JVMCIHostThreads, UseJVMCICompiler)
 75 
 76   if (UseJVMCICompiler) {
<span class="line-added"> 77     if (FLAG_IS_DEFAULT(UseJVMCINativeLibrary) &amp;&amp; !UseJVMCINativeLibrary) {</span>
<span class="line-added"> 78       char path[JVM_MAXPATHLEN];</span>
<span class="line-added"> 79       if (os::dll_locate_lib(path, sizeof(path), Arguments::get_dll_dir(), JVMCI_SHARED_LIBRARY_NAME)) {</span>
<span class="line-added"> 80         // If a JVMCI native library is present,</span>
<span class="line-added"> 81         // we enable UseJVMCINativeLibrary by default.</span>
<span class="line-added"> 82         FLAG_SET_DEFAULT(UseJVMCINativeLibrary, true);</span>
<span class="line-added"> 83       }</span>
<span class="line-added"> 84     }</span>
 85     if (!FLAG_IS_DEFAULT(EnableJVMCI) &amp;&amp; !EnableJVMCI) {
 86       jio_fprintf(defaultStream::error_stream(),
 87           &quot;Improperly specified VM option UseJVMCICompiler: EnableJVMCI cannot be disabled\n&quot;);
 88       return false;
 89     }
 90     FLAG_SET_DEFAULT(EnableJVMCI, true);
<span class="line-added"> 91     if (BootstrapJVMCI &amp;&amp; UseJVMCINativeLibrary) {</span>
<span class="line-added"> 92       jio_fprintf(defaultStream::error_stream(), &quot;-XX:+BootstrapJVMCI is not compatible with -XX:+UseJVMCINativeLibrary\n&quot;);</span>
<span class="line-added"> 93       return false;</span>
<span class="line-added"> 94     }</span>
 95   }
 96 
 97   if (!EnableJVMCI) {
 98     // Switch off eager JVMCI initialization if JVMCI is disabled.
 99     // Don&#39;t throw error if EagerJVMCI is set to allow testing.
100     if (EagerJVMCI) {
101       FLAG_SET_DEFAULT(EagerJVMCI, false);
102     }
103   }
104   JVMCI_FLAG_CHECKED(EagerJVMCI)
105 
106   CHECK_NOT_SET(JVMCITraceLevel,              EnableJVMCI)
107   CHECK_NOT_SET(JVMCICounterSize,             EnableJVMCI)
108   CHECK_NOT_SET(JVMCICountersExcludeCompiler, EnableJVMCI)
109   CHECK_NOT_SET(JVMCIUseFastLocking,          EnableJVMCI)
110   CHECK_NOT_SET(JVMCINMethodSizeLimit,        EnableJVMCI)
111   CHECK_NOT_SET(MethodProfileWidth,           EnableJVMCI)
112   CHECK_NOT_SET(JVMCIPrintProperties,         EnableJVMCI)
<span class="line-modified">113   CHECK_NOT_SET(UseJVMCINativeLibrary,        EnableJVMCI)</span>
<span class="line-added">114   CHECK_NOT_SET(JVMCILibPath,                 EnableJVMCI)</span>
<span class="line-added">115   CHECK_NOT_SET(JVMCILibDumpJNIConfig,        EnableJVMCI)</span>
<span class="line-added">116 </span>
<span class="line-added">117 #ifndef COMPILER2</span>
<span class="line-added">118   JVMCI_FLAG_CHECKED(MaxVectorSize)</span>
<span class="line-added">119   JVMCI_FLAG_CHECKED(ReduceInitialCardMarks)</span>
<span class="line-added">120   JVMCI_FLAG_CHECKED(UseMultiplyToLenIntrinsic)</span>
<span class="line-added">121   JVMCI_FLAG_CHECKED(UseSquareToLenIntrinsic)</span>
<span class="line-added">122   JVMCI_FLAG_CHECKED(UseMulAddIntrinsic)</span>
<span class="line-added">123   JVMCI_FLAG_CHECKED(UseMontgomeryMultiplyIntrinsic)</span>
<span class="line-added">124   JVMCI_FLAG_CHECKED(UseMontgomerySquareIntrinsic)</span>
<span class="line-added">125 #endif // !COMPILER2</span>
126 
127 #ifndef PRODUCT
128 #define JVMCI_CHECK4(type, name, value, doc) assert(name##checked, #name &quot; flag not checked&quot;);
129 #define JVMCI_CHECK3(type, name, doc)        assert(name##checked, #name &quot; flag not checked&quot;);
130   // Ensures that all JVMCI flags are checked by this method.
131   APPLY_JVMCI_FLAGS(JVMCI_CHECK3, JVMCI_CHECK4)
132 #undef APPLY_JVMCI_FLAGS
133 #undef JVMCI_DECLARE_CHECK3
134 #undef JVMCI_DECLARE_CHECK4
135 #undef JVMCI_CHECK3
136 #undef JVMCI_CHECK4
137 #undef JVMCI_FLAG_CHECKED
<span class="line-modified">138 #endif // PRODUCT</span>
139 #undef CHECK_NOT_SET
<span class="line-added">140 </span>
<span class="line-added">141   if (JVMCILibDumpJNIConfig != NULL) {</span>
<span class="line-added">142     _jni_config_file = new(ResourceObj::C_HEAP, mtJVMCI) fileStream(JVMCILibDumpJNIConfig);</span>
<span class="line-added">143     if (_jni_config_file == NULL || !_jni_config_file-&gt;is_open()) {</span>
<span class="line-added">144       jio_fprintf(defaultStream::error_stream(),</span>
<span class="line-added">145           &quot;Could not open file for dumping JVMCI shared library JNI config: %s\n&quot;, JVMCILibDumpJNIConfig);</span>
<span class="line-added">146       return false;</span>
<span class="line-added">147     }</span>
<span class="line-added">148   }</span>
<span class="line-added">149 </span>
150   return true;
151 }
<span class="line-added">152 </span>
<span class="line-added">153 // Convert JVMCI flags from experimental to product</span>
<span class="line-added">154 bool JVMCIGlobals::enable_jvmci_product_mode(JVMFlag::Flags origin) {</span>
<span class="line-added">155   const char *JVMCIFlags[] = {</span>
<span class="line-added">156     &quot;EnableJVMCI&quot;,</span>
<span class="line-added">157     &quot;EnableJVMCIProduct&quot;,</span>
<span class="line-added">158     &quot;UseJVMCICompiler&quot;,</span>
<span class="line-added">159     &quot;JVMCIPrintProperties&quot;,</span>
<span class="line-added">160     &quot;EagerJVMCI&quot;,</span>
<span class="line-added">161     &quot;JVMCIThreads&quot;,</span>
<span class="line-added">162     &quot;JVMCICounterSize&quot;,</span>
<span class="line-added">163     &quot;JVMCICountersExcludeCompiler&quot;,</span>
<span class="line-added">164     &quot;JVMCINMethodSizeLimit&quot;,</span>
<span class="line-added">165     &quot;JVMCILibPath&quot;,</span>
<span class="line-added">166     &quot;JVMCILibDumpJNIConfig&quot;,</span>
<span class="line-added">167     &quot;UseJVMCINativeLibrary&quot;,</span>
<span class="line-added">168     NULL</span>
<span class="line-added">169   };</span>
<span class="line-added">170 </span>
<span class="line-added">171   for (int i = 0; JVMCIFlags[i] != NULL; i++) {</span>
<span class="line-added">172     JVMFlag *jvmciFlag = (JVMFlag *)JVMFlag::find_declared_flag(JVMCIFlags[i]);</span>
<span class="line-added">173     if (jvmciFlag == NULL) {</span>
<span class="line-added">174       return false;</span>
<span class="line-added">175     }</span>
<span class="line-added">176     jvmciFlag-&gt;clear_experimental();</span>
<span class="line-added">177     jvmciFlag-&gt;set_product();</span>
<span class="line-added">178   }</span>
<span class="line-added">179 </span>
<span class="line-added">180   bool value = true;</span>
<span class="line-added">181   JVMFlag *jvmciEnableFlag = JVMFlag::find_flag(&quot;EnableJVMCIProduct&quot;);</span>
<span class="line-added">182   if (JVMFlag::boolAtPut(jvmciEnableFlag, &amp;value, origin) != JVMFlag::SUCCESS) {</span>
<span class="line-added">183     return false;</span>
<span class="line-added">184   }</span>
<span class="line-added">185 </span>
<span class="line-added">186   // Effect of EnableJVMCIProduct on changing defaults of EnableJVMCI</span>
<span class="line-added">187   // and UseJVMCICompiler is deferred to check_jvmci_flags_are_consistent</span>
<span class="line-added">188   // so that setting these flags explicitly (e.g. on the command line)</span>
<span class="line-added">189   // takes precedence.</span>
<span class="line-added">190 </span>
<span class="line-added">191   return true;</span>
<span class="line-added">192 }</span>
<span class="line-added">193 </span>
194 void JVMCIGlobals::check_jvmci_supported_gc() {
195   if (EnableJVMCI) {
196     // Check if selected GC is supported by JVMCI and Java compiler
<span class="line-modified">197     if (!(UseSerialGC || UseParallelGC || UseG1GC)) {</span>
198       vm_exit_during_initialization(&quot;JVMCI Compiler does not support selected GC&quot;, GCConfig::hs_err_name());
199       FLAG_SET_DEFAULT(EnableJVMCI, false);
200       FLAG_SET_DEFAULT(UseJVMCICompiler, false);
201     }
202   }
203 }
</pre>
</td>
</tr>
</table>
<center><a href="jvmciRuntime.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmci_globals.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>