<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jvmci/jvmciCodeInstaller.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmciCodeInstaller.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompiler.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmciCodeInstaller.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,13 +22,15 @@</span>
   */
  
  #ifndef SHARE_JVMCI_JVMCICODEINSTALLER_HPP
  #define SHARE_JVMCI_JVMCICODEINSTALLER_HPP
  
<span class="udiff-line-modified-removed">- #include &quot;jvmci/jvmciCompiler.hpp&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;jvmci/jvmciEnv.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;code/debugInfoRec.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;code/exceptionHandlerTable.hpp&quot;</span>
  #include &quot;code/nativeInst.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jvmci/jvmci.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;jvmci/jvmciEnv.hpp&quot;</span>
  
  #if INCLUDE_AOT
  class RelocBuffer : public StackObj {
    enum { stack_size = 1024 };
  public:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,24 +44,29 @@</span>
    size_t _size;
    char _static_buffer[stack_size];
    char *_buffer;
  };
  
<span class="udiff-line-added">+ class CodeInstaller;</span>
<span class="udiff-line-added">+ </span>
  class AOTOopRecorder : public OopRecorder {
  public:
<span class="udiff-line-modified-removed">-   AOTOopRecorder(Arena* arena = NULL, bool deduplicate = false);</span>
<span class="udiff-line-modified-added">+   AOTOopRecorder(CodeInstaller* code_inst, Arena* arena = NULL, bool deduplicate = false);</span>
  
    virtual int find_index(Metadata* h);
    virtual int find_index(jobject h);
    int nr_meta_refs() const;
    jobject meta_element(int pos) const;
  
  private:
    void record_meta_ref(jobject ref, int index);
  
    GrowableArray&lt;jobject&gt;* _meta_refs;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   CodeInstaller* _code_inst;</span>
  };
<span class="udiff-line-added">+ #endif // INCLUDE_AOT</span>
  
  class CodeMetadata {
  public:
    CodeMetadata() {}
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,47 +76,58 @@</span>
    int get_nr_pc_desc() const { return _nr_pc_desc; }
  
    u_char* get_scopes_desc() const { return _scopes_desc; }
    int get_scopes_size() const { return _nr_scopes_desc; }
  
<span class="udiff-line-added">+ #if INCLUDE_AOT</span>
    RelocBuffer* get_reloc_buffer() { return &amp;_reloc_buffer; }
<span class="udiff-line-removed">- </span>
    AOTOopRecorder* get_oop_recorder() { return _oop_recorder; }
<span class="udiff-line-added">+ #endif</span>
  
    ExceptionHandlerTable* get_exception_table() { return _exception_table; }
  
<span class="udiff-line-added">+   ImplicitExceptionTable* get_implicit_exception_table() { return _implicit_exception_table; }</span>
<span class="udiff-line-added">+ </span>
    void set_pc_desc(PcDesc* desc, int count) {
      _pc_desc = desc;
      _nr_pc_desc = count;
    }
  
    void set_scopes(u_char* scopes, int size) {
      _scopes_desc = scopes;
      _nr_scopes_desc = size;
    }
  
<span class="udiff-line-added">+ #if INCLUDE_AOT</span>
    void set_oop_recorder(AOTOopRecorder* recorder) {
      _oop_recorder = recorder;
    }
<span class="udiff-line-added">+ #endif</span>
  
    void set_exception_table(ExceptionHandlerTable* table) {
      _exception_table = table;
    }
  
<span class="udiff-line-added">+   void set_implicit_exception_table(ImplicitExceptionTable* table) {</span>
<span class="udiff-line-added">+     _implicit_exception_table = table;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
  private:
    CodeBlob* _cb;
    PcDesc* _pc_desc;
    int _nr_pc_desc;
  
    u_char* _scopes_desc;
    int _nr_scopes_desc;
  
<span class="udiff-line-added">+ #if INCLUDE_AOT</span>
    RelocBuffer _reloc_buffer;
    AOTOopRecorder* _oop_recorder;
<span class="udiff-line-added">+ #endif</span>
    ExceptionHandlerTable* _exception_table;
<span class="udiff-line-added">+   ImplicitExceptionTable* _implicit_exception_table;</span>
  };
<span class="udiff-line-removed">- #endif // INCLUDE_AOT</span>
  
  /*
   * This class handles the conversion from a InstalledCode to a CodeBlob or an nmethod.
   */
  class CodeInstaller : public StackObj {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,28 +159,30 @@</span>
      INLINE_CONTIGUOUS_ALLOCATION_SUPPORTED = 23,
      INVOKE_INVALID                         = -1
    };
  
    Arena         _arena;
<span class="udiff-line-added">+   JVMCIEnv*     _jvmci_env;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   JVMCIPrimitiveArray    _data_section_handle;</span>
<span class="udiff-line-added">+   JVMCIObjectArray       _data_section_patches_handle;</span>
<span class="udiff-line-added">+   JVMCIObjectArray       _sites_handle;</span>
<span class="udiff-line-added">+ #ifndef PRODUCT</span>
<span class="udiff-line-added">+   JVMCIObjectArray       _comments_handle;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   JVMCIPrimitiveArray    _code_handle;</span>
<span class="udiff-line-added">+   JVMCIObject            _word_kind_handle;</span>
  
<span class="udiff-line-removed">-   jobject       _data_section_handle;</span>
<span class="udiff-line-removed">-   jobject       _data_section_patches_handle;</span>
<span class="udiff-line-removed">-   jobject       _sites_handle;</span>
    CodeOffsets   _offsets;
  
<span class="udiff-line-removed">-   jobject       _code_handle;</span>
    jint          _code_size;
    jint          _total_frame_size;
    jint          _orig_pc_offset;
    jint          _parameter_count;
    jint          _constants_size;
<span class="udiff-line-removed">- #ifndef PRODUCT</span>
<span class="udiff-line-removed">-   jobject       _comments_handle;</span>
<span class="udiff-line-removed">- #endif</span>
  
    bool          _has_wide_vector;
<span class="udiff-line-removed">-   jobject       _word_kind_handle;</span>
  
    MarkId        _next_call_type;
    address       _invoke_mark_pc;
  
    CodeSection*  _instructions;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,86 +190,99 @@</span>
  
    OopRecorder*              _oop_recorder;
    DebugInformationRecorder* _debug_recorder;
    Dependencies*             _dependencies;
    ExceptionHandlerTable     _exception_handler_table;
<span class="udiff-line-added">+   ImplicitExceptionTable    _implicit_exception_table;</span>
  
    bool _immutable_pic_compilation;  // Installer is called for Immutable PIC compilation.
  
    static ConstantOopWriteValue* _oop_null_scope_value;
    static ConstantIntValue*    _int_m1_scope_value;
    static ConstantIntValue*    _int_0_scope_value;
    static ConstantIntValue*    _int_1_scope_value;
    static ConstantIntValue*    _int_2_scope_value;
    static LocationValue*       _illegal_value;
  
<span class="udiff-line-modified-removed">-   jint pd_next_offset(NativeInstruction* inst, jint pc_offset, Handle method, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_patch_OopConstant(int pc_offset, Handle constant, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_patch_MetaspaceConstant(int pc_offset, Handle constant, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_patch_DataSectionReference(int pc_offset, int data_offset, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_relocate_ForeignCall(NativeInstruction* inst, jlong foreign_call_destination, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_relocate_JavaMethod(CodeBuffer &amp;cbuf, Handle method, jint pc_offset, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void pd_relocate_poll(address pc, jint mark, TRAPS);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   objArrayOop sites();</span>
<span class="udiff-line-modified-removed">-   arrayOop code();</span>
<span class="udiff-line-modified-removed">-   arrayOop data_section();</span>
<span class="udiff-line-modified-removed">-   objArrayOop data_section_patches();</span>
<span class="udiff-line-modified-added">+   jint pd_next_offset(NativeInstruction* inst, jint pc_offset, JVMCIObject method, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_patch_OopConstant(int pc_offset, JVMCIObject constant, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_patch_MetaspaceConstant(int pc_offset, JVMCIObject constant, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_patch_DataSectionReference(int pc_offset, int data_offset, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_relocate_ForeignCall(NativeInstruction* inst, jlong foreign_call_destination, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_relocate_JavaMethod(CodeBuffer &amp;cbuf, JVMCIObject method, jint pc_offset, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void pd_relocate_poll(address pc, jint mark, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   JVMCIObjectArray sites()                { return _sites_handle; }</span>
<span class="udiff-line-modified-added">+   JVMCIPrimitiveArray code()              { return _code_handle; }</span>
<span class="udiff-line-modified-added">+   JVMCIPrimitiveArray  data_section()     { return _data_section_handle; }</span>
<span class="udiff-line-modified-added">+   JVMCIObjectArray data_section_patches() { return _data_section_patches_handle; }</span>
  #ifndef PRODUCT
<span class="udiff-line-modified-removed">-   objArrayOop comments();</span>
<span class="udiff-line-modified-added">+   JVMCIObjectArray comments()             { return _comments_handle; }</span>
  #endif
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-   oop word_kind();</span>
<span class="udiff-line-modified-added">+   JVMCIObject word_kind()                 { return _word_kind_handle; }</span>
  
  public:
  
<span class="udiff-line-modified-removed">-   CodeInstaller(bool immutable_pic_compilation) : _arena(mtCompiler), _immutable_pic_compilation(immutable_pic_compilation) {}</span>
<span class="udiff-line-modified-added">+   CodeInstaller(JVMCIEnv* jvmci_env, bool immutable_pic_compilation) : _arena(mtJVMCI), _jvmci_env(jvmci_env), _immutable_pic_compilation(immutable_pic_compilation) {}</span>
  
  #if INCLUDE_AOT
<span class="udiff-line-modified-removed">-   JVMCIEnv::CodeInstallResult gather_metadata(Handle target, Handle compiled_code, CodeMetadata&amp; metadata, TRAPS);</span>
<span class="udiff-line-modified-added">+   JVMCI::CodeInstallResult gather_metadata(JVMCIObject target, JVMCIObject compiled_code, CodeMetadata&amp; metadata, JVMCI_TRAPS);</span>
  #endif
<span class="udiff-line-modified-removed">-   JVMCIEnv::CodeInstallResult install(JVMCICompiler* compiler, Handle target, Handle compiled_code, CodeBlob*&amp; cb, Handle installed_code, Handle speculation_log, TRAPS);</span>
<span class="udiff-line-modified-added">+   JVMCI::CodeInstallResult install(JVMCICompiler* compiler,</span>
<span class="udiff-line-added">+                                    JVMCIObject target,</span>
<span class="udiff-line-added">+                                    JVMCIObject compiled_code,</span>
<span class="udiff-line-added">+                                    CodeBlob*&amp; cb,</span>
<span class="udiff-line-added">+                                    JVMCIObject installed_code,</span>
<span class="udiff-line-added">+                                    FailedSpeculation** failed_speculations,</span>
<span class="udiff-line-added">+                                    char* speculations,</span>
<span class="udiff-line-added">+                                    int speculations_len,</span>
<span class="udiff-line-added">+                                    JVMCI_TRAPS);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   JVMCIEnv* jvmci_env() { return _jvmci_env; }</span>
<span class="udiff-line-added">+   JVMCIRuntime* runtime() { return _jvmci_env-&gt;runtime(); }</span>
  
    static address runtime_call_target_address(oop runtime_call);
<span class="udiff-line-modified-removed">-   static VMReg get_hotspot_reg(jint jvmciRegisterNumber, TRAPS);</span>
<span class="udiff-line-modified-added">+   static VMReg get_hotspot_reg(jint jvmciRegisterNumber, JVMCI_TRAPS);</span>
    static bool is_general_purpose_reg(VMReg hotspotRegister);
  
    const OopMapSet* oopMapSet() const { return _debug_recorder-&gt;_oopmaps; }
  
  protected:
<span class="udiff-line-modified-removed">-   Location::Type get_oop_type(Thread* thread, Handle value);</span>
<span class="udiff-line-modified-removed">-   ScopeValue* get_scope_value(Handle value, BasicType type, GrowableArray&lt;ScopeValue*&gt;* objects, ScopeValue* &amp;second, TRAPS);</span>
<span class="udiff-line-modified-removed">-   MonitorValue* get_monitor_value(Handle value, GrowableArray&lt;ScopeValue*&gt;* objects, TRAPS);</span>
<span class="udiff-line-modified-added">+   Location::Type get_oop_type(JVMCIObject value);</span>
<span class="udiff-line-modified-added">+   ScopeValue* get_scope_value(JVMCIObject value, BasicType type, GrowableArray&lt;ScopeValue*&gt;* objects, ScopeValue* &amp;second, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   MonitorValue* get_monitor_value(JVMCIObject value, GrowableArray&lt;ScopeValue*&gt;* objects, JVMCI_TRAPS);</span>
  
<span class="udiff-line-modified-removed">-   void* record_metadata_reference(CodeSection* section, address dest, Handle constant, TRAPS);</span>
<span class="udiff-line-modified-added">+   void* record_metadata_reference(CodeSection* section, address dest, JVMCIObject constant, JVMCI_TRAPS);</span>
  #ifdef _LP64
<span class="udiff-line-modified-removed">-   narrowKlass record_narrow_metadata_reference(CodeSection* section, address dest, Handle constant, TRAPS);</span>
<span class="udiff-line-modified-added">+   narrowKlass record_narrow_metadata_reference(CodeSection* section, address dest, JVMCIObject constant, JVMCI_TRAPS);</span>
  #endif
  
    // extract the fields of the HotSpotCompiledCode
<span class="udiff-line-modified-removed">-   void initialize_fields(oop target, oop target_method, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void initialize_dependencies(oop target_method, OopRecorder* oop_recorder, TRAPS);</span>
<span class="udiff-line-modified-added">+   void initialize_fields(JVMCIObject target, JVMCIObject compiled_code, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void initialize_dependencies(JVMCIObject compiled_code, OopRecorder* oop_recorder, JVMCI_TRAPS);</span>
  
<span class="udiff-line-modified-removed">-   int estimate_stubs_size(TRAPS);</span>
<span class="udiff-line-modified-added">+   int estimate_stubs_size(JVMCI_TRAPS);</span>
  
    // perform data and call relocation on the CodeBuffer
<span class="udiff-line-modified-removed">-   JVMCIEnv::CodeInstallResult initialize_buffer(CodeBuffer&amp; buffer, bool check_size, TRAPS);</span>
<span class="udiff-line-modified-added">+   JVMCI::CodeInstallResult initialize_buffer(CodeBuffer&amp; buffer, bool check_size, JVMCI_TRAPS);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void assumption_NoFinalizableSubclass(JVMCIObject assumption);</span>
<span class="udiff-line-added">+   void assumption_ConcreteSubtype(JVMCIObject assumption);</span>
<span class="udiff-line-added">+   void assumption_LeafType(JVMCIObject assumption);</span>
<span class="udiff-line-added">+   void assumption_ConcreteMethod(JVMCIObject assumption);</span>
<span class="udiff-line-added">+   void assumption_CallSiteTargetValue(JVMCIObject assumption, JVMCI_TRAPS);</span>
  
<span class="udiff-line-modified-removed">-   void assumption_NoFinalizableSubclass(Thread* thread, Handle assumption);</span>
<span class="udiff-line-modified-removed">-   void assumption_ConcreteSubtype(Thread* thread, Handle assumption);</span>
<span class="udiff-line-modified-removed">-   void assumption_LeafType(Thread* thread, Handle assumption);</span>
<span class="udiff-line-modified-removed">-   void assumption_ConcreteMethod(Thread* thread, Handle assumption);</span>
<span class="udiff-line-modified-removed">-   void assumption_CallSiteTargetValue(Thread* thread, Handle assumption);</span>
<span class="udiff-line-modified-added">+   void site_Safepoint(CodeBuffer&amp; buffer, jint pc_offset, JVMCIObject site, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void site_Infopoint(CodeBuffer&amp; buffer, jint pc_offset, JVMCIObject site, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void site_Call(CodeBuffer&amp; buffer, jint pc_offset, JVMCIObject site, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void site_DataPatch(CodeBuffer&amp; buffer, jint pc_offset, JVMCIObject site, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void site_Mark(CodeBuffer&amp; buffer, jint pc_offset, JVMCIObject site, JVMCI_TRAPS);</span>
<span class="udiff-line-added">+   void site_ExceptionHandler(jint pc_offset, JVMCIObject site);</span>
  
<span class="udiff-line-modified-removed">-   void site_Safepoint(CodeBuffer&amp; buffer, jint pc_offset, Handle site, TRAPS);</span>
<span class="udiff-line-removed">-   void site_Infopoint(CodeBuffer&amp; buffer, jint pc_offset, Handle site, TRAPS);</span>
<span class="udiff-line-removed">-   void site_Call(CodeBuffer&amp; buffer, jint pc_offset, Handle site, TRAPS);</span>
<span class="udiff-line-removed">-   void site_DataPatch(CodeBuffer&amp; buffer, jint pc_offset, Handle site, TRAPS);</span>
<span class="udiff-line-removed">-   void site_Mark(CodeBuffer&amp; buffer, jint pc_offset, Handle site, TRAPS);</span>
<span class="udiff-line-removed">-   void site_ExceptionHandler(jint pc_offset, Handle site);</span>
<span class="udiff-line-modified-added">+   OopMap* create_oop_map(JVMCIObject debug_info, JVMCI_TRAPS);</span>
  
<span class="udiff-line-modified-removed">-   OopMap* create_oop_map(Handle debug_info, TRAPS);</span>
<span class="udiff-line-modified-added">+   VMReg getVMRegFromLocation(JVMCIObject location, int total_frame_size, JVMCI_TRAPS);</span>
  
    /**
     * Specifies the level of detail to record for a scope.
     */
    enum ScopeMode {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,25 +291,19 @@</span>
      // Record a method, bci and JVM frame state
      FullFrame
    };
  
    int map_jvmci_bci(int bci);
<span class="udiff-line-modified-removed">-   void record_scope(jint pc_offset, Handle debug_info, ScopeMode scope_mode, bool return_oop, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void record_scope(jint pc_offset, Handle debug_info, ScopeMode scope_mode, TRAPS) {</span>
<span class="udiff-line-modified-removed">-     record_scope(pc_offset, debug_info, scope_mode, false /* return_oop */, THREAD);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   void record_scope(jint pc_offset, JVMCIObject debug_info, ScopeMode scope_mode, bool return_oop, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void record_scope(jint pc_offset, JVMCIObject debug_info, ScopeMode scope_mode, JVMCI_TRAPS) {</span>
<span class="udiff-line-added">+     record_scope(pc_offset, debug_info, scope_mode, false /* return_oop */, JVMCIENV);</span>
    }
<span class="udiff-line-modified-removed">-   void record_scope(jint pc_offset, Handle position, ScopeMode scope_mode, GrowableArray&lt;ScopeValue*&gt;* objects, bool return_oop, TRAPS);</span>
<span class="udiff-line-modified-removed">-   void record_object_value(ObjectValue* sv, Handle value, GrowableArray&lt;ScopeValue*&gt;* objects, TRAPS);</span>
<span class="udiff-line-modified-added">+   void record_scope(jint pc_offset, JVMCIObject position, ScopeMode scope_mode, GrowableArray&lt;ScopeValue*&gt;* objects, bool return_oop, JVMCI_TRAPS);</span>
<span class="udiff-line-modified-added">+   void record_object_value(ObjectValue* sv, JVMCIObject value, GrowableArray&lt;ScopeValue*&gt;* objects, JVMCI_TRAPS);</span>
  
<span class="udiff-line-modified-removed">-   GrowableArray&lt;ScopeValue*&gt;* record_virtual_objects(Handle debug_info, TRAPS);</span>
<span class="udiff-line-modified-added">+   GrowableArray&lt;ScopeValue*&gt;* record_virtual_objects(JVMCIObject debug_info, JVMCI_TRAPS);</span>
  
    int estimateStubSpace(int static_call_stubs);
  };
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * Gets the Method metaspace object from a HotSpotResolvedJavaMethodImpl Java object.</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- Method* getMethodFromHotSpotMethod(oop hotspot_method);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  #endif // SHARE_JVMCI_JVMCICODEINSTALLER_HPP
</pre>
<center><a href="jvmciCodeInstaller.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompiler.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>