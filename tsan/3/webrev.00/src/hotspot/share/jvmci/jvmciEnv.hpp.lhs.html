<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/jvmci/jvmciEnv.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_JVMCI_JVMCIENV_HPP
 26 #define SHARE_JVMCI_JVMCIENV_HPP
 27 
<a name="1" id="anc1"></a><span class="line-modified"> 28 #include &quot;classfile/systemDictionary.hpp&quot;</span>
<span class="line-modified"> 29 #include &quot;code/debugInfoRec.hpp&quot;</span>
<span class="line-removed"> 30 #include &quot;code/dependencies.hpp&quot;</span>
<span class="line-removed"> 31 #include &quot;code/exceptionHandlerTable.hpp&quot;</span>
<span class="line-removed"> 32 #include &quot;compiler/oopMap.hpp&quot;</span>
 33 #include &quot;runtime/thread.hpp&quot;
 34 
 35 class CompileTask;
<a name="2" id="anc2"></a><span class="line-modified"> 36 </span>
<span class="line-modified"> 37 // Bring the JVMCI compiler thread into the VM state.</span>
<span class="line-modified"> 38 #define JVMCI_VM_ENTRY_MARK                       \</span>
<span class="line-modified"> 39   JavaThread* thread = JavaThread::current(); \</span>
<span class="line-modified"> 40   ThreadInVMfromNative __tiv(thread);       \</span>
<span class="line-removed"> 41   ResetNoHandleMark rnhm;                   \</span>
<span class="line-removed"> 42   HandleMarkCleaner __hm(thread);           \</span>
<span class="line-removed"> 43   Thread* THREAD = thread;                  \</span>
<span class="line-removed"> 44   debug_only(VMNativeEntryWrapper __vew;)</span>
 45 
 46 #define JVMCI_EXCEPTION_CONTEXT \
 47   JavaThread* thread=JavaThread::current(); \
 48   Thread* THREAD = thread;
 49 
<a name="3" id="anc3"></a><span class="line-modified"> 50 //</span>
<span class="line-modified"> 51 // This class is the top level broker for requests from the compiler</span>
<span class="line-modified"> 52 // to the VM.</span>
<span class="line-modified"> 53 class JVMCIEnv : StackObj {</span>
<span class="line-modified"> 54   CI_PACKAGE_ACCESS_TO</span>






 55 
<a name="4" id="anc4"></a><span class="line-modified"> 56   friend class JVMCIVMStructs;</span>
<span class="line-modified"> 57   friend class CompileBroker;</span>
<span class="line-modified"> 58   friend class Dependencies;  // for get_object, during logging</span>



 59 
<a name="5" id="anc5"></a><span class="line-modified"> 60 public:</span>

 61 
<a name="6" id="anc6"></a><span class="line-modified"> 62   enum CodeInstallResult {</span>
<span class="line-modified"> 63      ok,</span>
<span class="line-modified"> 64      dependencies_failed,</span>
<span class="line-modified"> 65      dependencies_invalid,</span>
<span class="line-removed"> 66      cache_full,</span>
<span class="line-removed"> 67      code_too_large</span>
<span class="line-removed"> 68   };</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70   // Look up a klass by name from a particular class loader (the accessor&#39;s).</span>
<span class="line-removed"> 71   // If require_local, result must be defined in that class loader, or NULL.</span>
<span class="line-removed"> 72   // If !require_local, a result from remote class loader may be reported,</span>
<span class="line-removed"> 73   // if sufficient class loader constraints exist such that initiating</span>
<span class="line-removed"> 74   // a class loading request from the given loader is bound to return</span>
<span class="line-removed"> 75   // the class defined in the remote loader (or throw an error).</span>
<span class="line-removed"> 76   //</span>
<span class="line-removed"> 77   // Return an unloaded klass if !require_local and no class at all is found.</span>
<span class="line-removed"> 78   //</span>
<span class="line-removed"> 79   // The CI treats a klass as loaded if it is consistently defined in</span>
<span class="line-removed"> 80   // another loader, even if it hasn&#39;t yet been loaded in all loaders</span>
<span class="line-removed"> 81   // that could potentially see it via delegation.</span>
<span class="line-removed"> 82   static Klass* get_klass_by_name(Klass* accessing_klass, Symbol* klass_name, bool require_local);</span>
<span class="line-removed"> 83 </span>
<span class="line-removed"> 84   // Constant pool access.</span>
<span class="line-removed"> 85   static Klass* get_klass_by_index(const constantPoolHandle&amp; cpool,</span>
<span class="line-removed"> 86                                    int klass_index,</span>
<span class="line-removed"> 87                                    bool&amp; is_accessible,</span>
<span class="line-removed"> 88                                    Klass* loading_klass);</span>
<span class="line-removed"> 89   static void   get_field_by_index(InstanceKlass* loading_klass, fieldDescriptor&amp; fd,</span>
<span class="line-removed"> 90                                    int field_index);</span>
<span class="line-removed"> 91   static methodHandle  get_method_by_index(const constantPoolHandle&amp; cpool,</span>
<span class="line-removed"> 92                                     int method_index, Bytecodes::Code bc,</span>
<span class="line-removed"> 93                                     InstanceKlass* loading_klass);</span>
<span class="line-removed"> 94 </span>
<span class="line-removed"> 95   JVMCIEnv(CompileTask* task, int system_dictionary_modification_counter);</span>
<span class="line-removed"> 96 </span>
<span class="line-removed"> 97 private:</span>
<span class="line-removed"> 98   CompileTask*     _task;</span>
<span class="line-removed"> 99   int              _system_dictionary_modification_counter;</span>
100 
<a name="7" id="anc7"></a><span class="line-modified">101   // Compilation result values</span>
<span class="line-modified">102   bool             _retryable;</span>
<span class="line-modified">103   const char*      _failure_reason;</span>
104 
<a name="8" id="anc8"></a><span class="line-modified">105   // Specifies if _failure_reason is on the C heap.</span>
<span class="line-modified">106   bool             _failure_reason_on_C_heap;</span>

















107 
108   // Cache JVMTI state. Defined as bytes so that reading them from Java
109   // via Unsafe is well defined (the C++ type for bool is implementation
110   // defined and may not be the same as a Java boolean).
<a name="9" id="anc9"></a>
111   jbyte  _jvmti_can_hotswap_or_post_breakpoint;
112   jbyte  _jvmti_can_access_local_variables;
113   jbyte  _jvmti_can_post_on_exceptions;
114   jbyte  _jvmti_can_pop_frame;
115 
<a name="10" id="anc10"></a><span class="line-modified">116   // Implementation methods for loading and constant pool access.</span>
<span class="line-modified">117   static Klass* get_klass_by_name_impl(Klass* accessing_klass,</span>
<span class="line-modified">118                                   const constantPoolHandle&amp; cpool,</span>
<span class="line-modified">119                                   Symbol* klass_name,</span>
<span class="line-modified">120                                   bool require_local);</span>
<span class="line-modified">121   static Klass* get_klass_by_index_impl(const constantPoolHandle&amp; cpool,</span>
<span class="line-modified">122                                      int klass_index,</span>
<span class="line-modified">123                                      bool&amp; is_accessible,</span>
<span class="line-modified">124                                      Klass* loading_klass);</span>
<span class="line-modified">125   static void   get_field_by_index_impl(InstanceKlass* loading_klass, fieldDescriptor&amp; fd,</span>
<span class="line-removed">126                                      int field_index);</span>
<span class="line-removed">127   static methodHandle  get_method_by_index_impl(const constantPoolHandle&amp; cpool,</span>
<span class="line-removed">128                                       int method_index, Bytecodes::Code bc,</span>
<span class="line-removed">129                                       InstanceKlass* loading_klass);</span>
<span class="line-removed">130 </span>
<span class="line-removed">131   // Helper methods</span>
<span class="line-removed">132   static bool       check_klass_accessibility(Klass* accessing_klass, Klass* resolved_klass);</span>
<span class="line-removed">133   static methodHandle  lookup_method(InstanceKlass*  accessor,</span>
<span class="line-removed">134                            Klass*         holder,</span>
<span class="line-removed">135                            Symbol*        name,</span>
<span class="line-removed">136                            Symbol*        sig,</span>
<span class="line-removed">137                            Bytecodes::Code bc,</span>
<span class="line-removed">138                            constantTag     tag);</span>
<span class="line-removed">139 </span>
<span class="line-removed">140   private:</span>
<span class="line-removed">141 </span>
<span class="line-removed">142   // Is this thread currently in the VM state?</span>
<span class="line-removed">143   static bool is_in_vm();</span>
<span class="line-removed">144 </span>
<span class="line-removed">145   // Helper routine for determining the validity of a compilation</span>
<span class="line-removed">146   // with respect to concurrent class loading.</span>
<span class="line-removed">147   static JVMCIEnv::CodeInstallResult validate_compile_task_dependencies(Dependencies* target, Handle compiled_code,</span>
<span class="line-removed">148                                                                         JVMCIEnv* env, char** failure_detail);</span>
149 
<a name="11" id="anc11"></a><span class="line-removed">150 public:</span>
151   CompileTask* task() { return _task; }
152 
153   bool  jvmti_state_changed() const;
<a name="12" id="anc12"></a>
154   bool  jvmti_can_hotswap_or_post_breakpoint() const { return  _jvmti_can_hotswap_or_post_breakpoint != 0; }
155   bool  jvmti_can_access_local_variables() const     { return  _jvmti_can_access_local_variables != 0; }
156   bool  jvmti_can_post_on_exceptions() const         { return  _jvmti_can_post_on_exceptions != 0; }
157   bool  jvmti_can_pop_frame() const                  { return  _jvmti_can_pop_frame != 0; }
158 
159   const char* failure_reason() { return _failure_reason; }
160   bool failure_reason_on_C_heap() { return _failure_reason_on_C_heap; }
161   bool retryable() { return _retryable; }
162 
163   void set_failure(bool retryable, const char* reason, bool reason_on_C_heap = false) {
164     _failure_reason = reason;
165     _failure_reason_on_C_heap = reason_on_C_heap;
166     _retryable = retryable;
167   }
<a name="13" id="anc13"></a>


























































































































































































































































































































































168 
<a name="14" id="anc14"></a><span class="line-modified">169   // Register the result of a compilation.</span>
<span class="line-removed">170   static JVMCIEnv::CodeInstallResult register_method(</span>
<span class="line-removed">171                        const methodHandle&amp;       target,</span>
<span class="line-removed">172                        nmethod*&amp;                 nm,</span>
<span class="line-removed">173                        int                       entry_bci,</span>
<span class="line-removed">174                        CodeOffsets*              offsets,</span>
<span class="line-removed">175                        int                       orig_pc_offset,</span>
<span class="line-removed">176                        CodeBuffer*               code_buffer,</span>
<span class="line-removed">177                        int                       frame_words,</span>
<span class="line-removed">178                        OopMapSet*                oop_map_set,</span>
<span class="line-removed">179                        ExceptionHandlerTable*    handler_table,</span>
<span class="line-removed">180                        AbstractCompiler*         compiler,</span>
<span class="line-removed">181                        DebugInformationRecorder* debug_info,</span>
<span class="line-removed">182                        Dependencies*             dependencies,</span>
<span class="line-removed">183                        JVMCIEnv*                 env,</span>
<span class="line-removed">184                        int                       compile_id,</span>
<span class="line-removed">185                        bool                      has_unsafe_access,</span>
<span class="line-removed">186                        bool                      has_wide_vector,</span>
<span class="line-removed">187                        Handle                    installed_code,</span>
<span class="line-removed">188                        Handle                    compiled_code,</span>
<span class="line-removed">189                        Handle                    speculation_log);</span>
<span class="line-removed">190 </span>
<span class="line-removed">191   // converts the Klass* representing the holder of a method into a</span>
<span class="line-removed">192   // InstanceKlass*.  This is needed since the holder of a method in</span>
<span class="line-removed">193   // the bytecodes could be an array type.  Basically this converts</span>
<span class="line-removed">194   // array types into java/lang/Object and other types stay as they are.</span>
<span class="line-removed">195   static InstanceKlass* get_instance_klass_for_declared_method_holder(Klass* klass);</span>
196 };
197 
198 #endif // SHARE_JVMCI_JVMCIENV_HPP
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>