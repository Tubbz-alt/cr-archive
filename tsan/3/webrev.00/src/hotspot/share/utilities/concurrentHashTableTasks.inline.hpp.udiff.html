<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/utilities/concurrentHashTableTasks.inline.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="concurrentHashTable.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="count_leading_zeros.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/utilities/concurrentHashTableTasks.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,21 +23,22 @@</span>
   */
  
  #ifndef SHARE_UTILITIES_CONCURRENTHASHTABLETASKS_INLINE_HPP
  #define SHARE_UTILITIES_CONCURRENTHASHTABLETASKS_INLINE_HPP
  
<span class="udiff-line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;utilities/globalDefinitions.hpp&quot;
  #include &quot;utilities/concurrentHashTable.inline.hpp&quot;
  
  // This inline file contains BulkDeleteTask and GrowTasks which are both bucket
  // operations, which they are serialized with each other.
  
  // Base class for pause and/or parallel bulk operations.
<span class="udiff-line-modified-removed">- template &lt;typename VALUE, typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-removed">- class ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;::BucketsOperation {</span>
<span class="udiff-line-modified-added">+ template &lt;typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-added">+ class ConcurrentHashTable&lt;CONFIG, F&gt;::BucketsOperation {</span>
   protected:
<span class="udiff-line-modified-removed">-   ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;* _cht;</span>
<span class="udiff-line-modified-added">+   ConcurrentHashTable&lt;CONFIG, F&gt;* _cht;</span>
  
    // Default size of _task_size_log2
    static const size_t DEFAULT_TASK_SIZE_LOG2 = 12;
  
    // The table is split into ranges, every increment is one range.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -45,17 +46,17 @@</span>
    size_t _task_size_log2; // Number of buckets.
    size_t _stop_task;      // Last task
    size_t _size_log2;      // Table size.
    bool   _is_mt;
  
<span class="udiff-line-modified-removed">-   BucketsOperation(ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;* cht, bool is_mt = false)</span>
<span class="udiff-line-modified-added">+   BucketsOperation(ConcurrentHashTable&lt;CONFIG, F&gt;* cht, bool is_mt = false)</span>
      : _cht(cht), _next_to_claim(0), _task_size_log2(DEFAULT_TASK_SIZE_LOG2),
      _stop_task(0), _size_log2(0), _is_mt(is_mt) {}
  
    // Returns true if you succeeded to claim the range start -&gt; (stop-1).
    bool claim(size_t* start, size_t* stop) {
<span class="udiff-line-modified-removed">-     size_t claimed = Atomic::add((size_t)1, &amp;_next_to_claim) - 1;</span>
<span class="udiff-line-modified-added">+     size_t claimed = Atomic::fetch_and_add(&amp;_next_to_claim, 1u);</span>
      if (claimed &gt;= _stop_task) {
        return false;
      }
      *start = claimed * (((size_t)1) &lt;&lt; _task_size_log2);
      *stop  = ((*start) + (((size_t)1) &lt;&lt; _task_size_log2));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -72,11 +73,11 @@</span>
      _stop_task = (((size_t)1) &lt;&lt; tmp);
    }
  
    // Returns false if all ranges are claimed.
    bool have_more_work() {
<span class="udiff-line-modified-removed">-     return OrderAccess::load_acquire(&amp;_next_to_claim) &gt;= _stop_task;</span>
<span class="udiff-line-modified-added">+     return Atomic::load_acquire(&amp;_next_to_claim) &gt;= _stop_task;</span>
    }
  
    void thread_owns_resize_lock(Thread* thread) {
      assert(BucketsOperation::_cht-&gt;_resize_lock_owner == thread,
             &quot;Should be locked by me&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,16 +115,16 @@</span>
      this-&gt;thread_owns_resize_lock(thread);
    }
  };
  
  // For doing pausable/parallel bulk delete.
<span class="udiff-line-modified-removed">- template &lt;typename VALUE, typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-removed">- class ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;::BulkDeleteTask :</span>
<span class="udiff-line-modified-added">+ template &lt;typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-added">+ class ConcurrentHashTable&lt;CONFIG, F&gt;::BulkDeleteTask :</span>
    public BucketsOperation
  {
   public:
<span class="udiff-line-modified-removed">-   BulkDeleteTask(ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;* cht, bool is_mt = false)</span>
<span class="udiff-line-modified-added">+   BulkDeleteTask(ConcurrentHashTable&lt;CONFIG, F&gt;* cht, bool is_mt = false)</span>
      : BucketsOperation(cht, is_mt) {
    }
    // Before start prepare must be called.
    bool prepare(Thread* thread) {
      bool lock = BucketsOperation::_cht-&gt;try_resize_lock(thread);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -158,16 +159,16 @@</span>
      BucketsOperation::_cht-&gt;unlock_resize_lock(thread);
      this-&gt;thread_do_not_own_resize_lock(thread);
    }
  };
  
<span class="udiff-line-modified-removed">- template &lt;typename VALUE, typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-removed">- class ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;::GrowTask :</span>
<span class="udiff-line-modified-added">+ template &lt;typename CONFIG, MEMFLAGS F&gt;</span>
<span class="udiff-line-modified-added">+ class ConcurrentHashTable&lt;CONFIG, F&gt;::GrowTask :</span>
    public BucketsOperation
  {
   public:
<span class="udiff-line-modified-removed">-   GrowTask(ConcurrentHashTable&lt;VALUE, CONFIG, F&gt;* cht) : BucketsOperation(cht) {</span>
<span class="udiff-line-modified-added">+   GrowTask(ConcurrentHashTable&lt;CONFIG, F&gt;* cht) : BucketsOperation(cht) {</span>
    }
    // Before start prepare must be called.
    bool prepare(Thread* thread) {
      if (!BucketsOperation::_cht-&gt;internal_grow_prolog(
            thread, BucketsOperation::_cht-&gt;_log2_size_limit)) {
</pre>
<center><a href="concurrentHashTable.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="count_leading_zeros.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>