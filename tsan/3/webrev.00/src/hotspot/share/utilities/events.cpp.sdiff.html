<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/utilities/events.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="dtrace_disabled.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/utilities/events.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 34 #include &quot;utilities/events.hpp&quot;
 35 
 36 
 37 EventLog* Events::_logs = NULL;
 38 StringEventLog* Events::_messages = NULL;
 39 ExceptionsEventLog* Events::_exceptions = NULL;
 40 StringEventLog* Events::_redefinitions = NULL;
 41 UnloadingEventLog* Events::_class_unloading = NULL;
 42 StringEventLog* Events::_deopt_messages = NULL;
 43 
 44 EventLog::EventLog() {
 45   // This normally done during bootstrap when we&#39;re only single
 46   // threaded but use a ThreadCritical to ensure inclusion in case
 47   // some are created slightly late.
 48   ThreadCritical tc;
 49   _next = Events::_logs;
 50   Events::_logs = this;
 51 }
 52 
 53 // For each registered event logger, print out the current contents of
<span class="line-modified"> 54 // the buffer.  This is normally called when the JVM is crashing.</span>
<span class="line-modified"> 55 void Events::print_all(outputStream* out) {</span>
 56   EventLog* log = _logs;
 57   while (log != NULL) {
<span class="line-modified"> 58     log-&gt;print_log_on(out);</span>
 59     log = log-&gt;next();
 60   }
 61 }
 62 

























 63 void Events::print() {
 64   print_all(tty);
 65 }
 66 
 67 void Events::init() {
 68   if (LogEvents) {
<span class="line-modified"> 69     _messages = new StringEventLog(&quot;Events&quot;);</span>
<span class="line-modified"> 70     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;);</span>
<span class="line-modified"> 71     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;);</span>
<span class="line-modified"> 72     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;);</span>
<span class="line-modified"> 73     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;);</span>
 74   }
 75 }
 76 
 77 void eventlog_init() {
 78   Events::init();
 79 }
 80 
 81 ///////////////////////////////////////////////////////////////////////////
 82 // EventMark
 83 
 84 EventMark::EventMark(const char* format, ...) {
 85   if (LogEvents) {
 86     va_list ap;
 87     va_start(ap, format);
 88     // Save a copy of begin message and log it.
 89     _buffer.printv(format, ap);
 90     Events::log(NULL, &quot;%s&quot;, _buffer.buffer());
 91     va_end(ap);
 92   }
 93 }
 94 
 95 EventMark::~EventMark() {
 96   if (LogEvents) {
 97     // Append &quot; done&quot; to the begin message and log it
 98     _buffer.append(&quot; done&quot;);
 99     Events::log(NULL, &quot;%s&quot;, _buffer.buffer());
100   }
101 }
102 
103 void UnloadingEventLog::log(Thread* thread, InstanceKlass* ik) {
104   if (!should_log()) return;
105 
106   double timestamp = fetch_timestamp();
107   // Unloading events are single threaded.
108   int index = compute_log_index();
109   _records[index].thread = thread;
110   _records[index].timestamp = timestamp;
<span class="line-modified">111   stringStream st = _records[index].data.stream();</span>

112   st.print(&quot;Unloading class &quot; INTPTR_FORMAT &quot; &quot;, p2i(ik));
113   ik-&gt;name()-&gt;print_value_on(&amp;st);
114 }
115 
116 void ExceptionsEventLog::log(Thread* thread, Handle h_exception, const char* message, const char* file, int line) {
117   if (!should_log()) return;
118 
119   double timestamp = fetch_timestamp();
<span class="line-modified">120   MutexLockerEx ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
121   int index = compute_log_index();
122   _records[index].thread = thread;
123   _records[index].timestamp = timestamp;
<span class="line-modified">124   stringStream st = _records[index].data.stream();</span>

125   st.print(&quot;Exception &lt;&quot;);
126   h_exception-&gt;print_value_on(&amp;st);
127   st.print(&quot;%s%s&gt; (&quot; INTPTR_FORMAT &quot;) \n&quot;
<span class="line-modified">128            &quot;thrown [%s, line %d]\nfor thread &quot; INTPTR_FORMAT,</span>
129            message ? &quot;: &quot; : &quot;&quot;, message ? message : &quot;&quot;,
<span class="line-modified">130            p2i(h_exception()), file, line, p2i(thread));</span>
131 }
</pre>
</td>
<td>
<hr />
<pre>
 34 #include &quot;utilities/events.hpp&quot;
 35 
 36 
 37 EventLog* Events::_logs = NULL;
 38 StringEventLog* Events::_messages = NULL;
 39 ExceptionsEventLog* Events::_exceptions = NULL;
 40 StringEventLog* Events::_redefinitions = NULL;
 41 UnloadingEventLog* Events::_class_unloading = NULL;
 42 StringEventLog* Events::_deopt_messages = NULL;
 43 
 44 EventLog::EventLog() {
 45   // This normally done during bootstrap when we&#39;re only single
 46   // threaded but use a ThreadCritical to ensure inclusion in case
 47   // some are created slightly late.
 48   ThreadCritical tc;
 49   _next = Events::_logs;
 50   Events::_logs = this;
 51 }
 52 
 53 // For each registered event logger, print out the current contents of
<span class="line-modified"> 54 // the buffer.</span>
<span class="line-modified"> 55 void Events::print_all(outputStream* out, int max) {</span>
 56   EventLog* log = _logs;
 57   while (log != NULL) {
<span class="line-modified"> 58     log-&gt;print_log_on(out, max);</span>
 59     log = log-&gt;next();
 60   }
 61 }
 62 
<span class="line-added"> 63 // Print a single event log specified by name.</span>
<span class="line-added"> 64 void Events::print_one(outputStream* out, const char* log_name, int max) {</span>
<span class="line-added"> 65   EventLog* log = _logs;</span>
<span class="line-added"> 66   int num_printed = 0;</span>
<span class="line-added"> 67   while (log != NULL) {</span>
<span class="line-added"> 68     if (log-&gt;matches_name_or_handle(log_name)) {</span>
<span class="line-added"> 69       log-&gt;print_log_on(out, max);</span>
<span class="line-added"> 70       num_printed ++;</span>
<span class="line-added"> 71     }</span>
<span class="line-added"> 72     log = log-&gt;next();</span>
<span class="line-added"> 73   }</span>
<span class="line-added"> 74   // Write a short error note if no name matched.</span>
<span class="line-added"> 75   if (num_printed == 0) {</span>
<span class="line-added"> 76     out-&gt;print_cr(&quot;The name \&quot;%s\&quot; did not match any known event log. &quot;</span>
<span class="line-added"> 77                   &quot;Valid event log names are:&quot;, log_name);</span>
<span class="line-added"> 78     EventLog* log = _logs;</span>
<span class="line-added"> 79     while (log != NULL) {</span>
<span class="line-added"> 80       log-&gt;print_names(out);</span>
<span class="line-added"> 81       out-&gt;cr();</span>
<span class="line-added"> 82       log = log-&gt;next();</span>
<span class="line-added"> 83     }</span>
<span class="line-added"> 84   }</span>
<span class="line-added"> 85 }</span>
<span class="line-added"> 86 </span>
<span class="line-added"> 87 </span>
 88 void Events::print() {
 89   print_all(tty);
 90 }
 91 
 92 void Events::init() {
 93   if (LogEvents) {
<span class="line-modified"> 94     _messages = new StringEventLog(&quot;Events&quot;, &quot;events&quot;);</span>
<span class="line-modified"> 95     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;, &quot;exc&quot;);</span>
<span class="line-modified"> 96     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;, &quot;redef&quot;);</span>
<span class="line-modified"> 97     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;, &quot;unload&quot;);</span>
<span class="line-modified"> 98     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;, &quot;deopt&quot;);</span>
 99   }
100 }
101 
102 void eventlog_init() {
103   Events::init();
104 }
105 
106 ///////////////////////////////////////////////////////////////////////////
107 // EventMark
108 
109 EventMark::EventMark(const char* format, ...) {
110   if (LogEvents) {
111     va_list ap;
112     va_start(ap, format);
113     // Save a copy of begin message and log it.
114     _buffer.printv(format, ap);
115     Events::log(NULL, &quot;%s&quot;, _buffer.buffer());
116     va_end(ap);
117   }
118 }
119 
120 EventMark::~EventMark() {
121   if (LogEvents) {
122     // Append &quot; done&quot; to the begin message and log it
123     _buffer.append(&quot; done&quot;);
124     Events::log(NULL, &quot;%s&quot;, _buffer.buffer());
125   }
126 }
127 
128 void UnloadingEventLog::log(Thread* thread, InstanceKlass* ik) {
129   if (!should_log()) return;
130 
131   double timestamp = fetch_timestamp();
132   // Unloading events are single threaded.
133   int index = compute_log_index();
134   _records[index].thread = thread;
135   _records[index].timestamp = timestamp;
<span class="line-modified">136   stringStream st(_records[index].data.buffer(),</span>
<span class="line-added">137                   _records[index].data.size());</span>
138   st.print(&quot;Unloading class &quot; INTPTR_FORMAT &quot; &quot;, p2i(ik));
139   ik-&gt;name()-&gt;print_value_on(&amp;st);
140 }
141 
142 void ExceptionsEventLog::log(Thread* thread, Handle h_exception, const char* message, const char* file, int line) {
143   if (!should_log()) return;
144 
145   double timestamp = fetch_timestamp();
<span class="line-modified">146   MutexLocker ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
147   int index = compute_log_index();
148   _records[index].thread = thread;
149   _records[index].timestamp = timestamp;
<span class="line-modified">150   stringStream st(_records[index].data.buffer(),</span>
<span class="line-added">151                   _records[index].data.size());</span>
152   st.print(&quot;Exception &lt;&quot;);
153   h_exception-&gt;print_value_on(&amp;st);
154   st.print(&quot;%s%s&gt; (&quot; INTPTR_FORMAT &quot;) \n&quot;
<span class="line-modified">155            &quot;thrown [%s, line %d]&quot;,</span>
156            message ? &quot;: &quot; : &quot;&quot;, message ? message : &quot;&quot;,
<span class="line-modified">157            p2i(h_exception()), file, line);</span>
158 }
</pre>
</td>
</tr>
</table>
<center><a href="dtrace_disabled.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>