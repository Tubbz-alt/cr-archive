<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/utilities/events.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="dtrace_disabled.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/utilities/events.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -49,30 +49,55 @@</span>
    _next = Events::_logs;
    Events::_logs = this;
  }
  
  // For each registered event logger, print out the current contents of
<span class="udiff-line-modified-removed">- // the buffer.  This is normally called when the JVM is crashing.</span>
<span class="udiff-line-modified-removed">- void Events::print_all(outputStream* out) {</span>
<span class="udiff-line-modified-added">+ // the buffer.</span>
<span class="udiff-line-modified-added">+ void Events::print_all(outputStream* out, int max) {</span>
    EventLog* log = _logs;
    while (log != NULL) {
<span class="udiff-line-modified-removed">-     log-&gt;print_log_on(out);</span>
<span class="udiff-line-modified-added">+     log-&gt;print_log_on(out, max);</span>
      log = log-&gt;next();
    }
  }
  
<span class="udiff-line-added">+ // Print a single event log specified by name.</span>
<span class="udiff-line-added">+ void Events::print_one(outputStream* out, const char* log_name, int max) {</span>
<span class="udiff-line-added">+   EventLog* log = _logs;</span>
<span class="udiff-line-added">+   int num_printed = 0;</span>
<span class="udiff-line-added">+   while (log != NULL) {</span>
<span class="udiff-line-added">+     if (log-&gt;matches_name_or_handle(log_name)) {</span>
<span class="udiff-line-added">+       log-&gt;print_log_on(out, max);</span>
<span class="udiff-line-added">+       num_printed ++;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     log = log-&gt;next();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   // Write a short error note if no name matched.</span>
<span class="udiff-line-added">+   if (num_printed == 0) {</span>
<span class="udiff-line-added">+     out-&gt;print_cr(&quot;The name \&quot;%s\&quot; did not match any known event log. &quot;</span>
<span class="udiff-line-added">+                   &quot;Valid event log names are:&quot;, log_name);</span>
<span class="udiff-line-added">+     EventLog* log = _logs;</span>
<span class="udiff-line-added">+     while (log != NULL) {</span>
<span class="udiff-line-added">+       log-&gt;print_names(out);</span>
<span class="udiff-line-added">+       out-&gt;cr();</span>
<span class="udiff-line-added">+       log = log-&gt;next();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  void Events::print() {
    print_all(tty);
  }
  
  void Events::init() {
    if (LogEvents) {
<span class="udiff-line-modified-removed">-     _messages = new StringEventLog(&quot;Events&quot;);</span>
<span class="udiff-line-modified-removed">-     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;);</span>
<span class="udiff-line-modified-removed">-     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;);</span>
<span class="udiff-line-modified-removed">-     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;);</span>
<span class="udiff-line-modified-removed">-     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;);</span>
<span class="udiff-line-modified-added">+     _messages = new StringEventLog(&quot;Events&quot;, &quot;events&quot;);</span>
<span class="udiff-line-modified-added">+     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;, &quot;exc&quot;);</span>
<span class="udiff-line-modified-added">+     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;, &quot;redef&quot;);</span>
<span class="udiff-line-modified-added">+     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;, &quot;unload&quot;);</span>
<span class="udiff-line-modified-added">+     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;, &quot;deopt&quot;);</span>
    }
  }
  
  void eventlog_init() {
    Events::init();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,26 +131,28 @@</span>
    double timestamp = fetch_timestamp();
    // Unloading events are single threaded.
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="udiff-line-modified-removed">-   stringStream st = _records[index].data.stream();</span>
<span class="udiff-line-modified-added">+   stringStream st(_records[index].data.buffer(),</span>
<span class="udiff-line-added">+                   _records[index].data.size());</span>
    st.print(&quot;Unloading class &quot; INTPTR_FORMAT &quot; &quot;, p2i(ik));
    ik-&gt;name()-&gt;print_value_on(&amp;st);
  }
  
  void ExceptionsEventLog::log(Thread* thread, Handle h_exception, const char* message, const char* file, int line) {
    if (!should_log()) return;
  
    double timestamp = fetch_timestamp();
<span class="udiff-line-modified-removed">-   MutexLockerEx ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="udiff-line-modified-removed">-   stringStream st = _records[index].data.stream();</span>
<span class="udiff-line-modified-added">+   stringStream st(_records[index].data.buffer(),</span>
<span class="udiff-line-added">+                   _records[index].data.size());</span>
    st.print(&quot;Exception &lt;&quot;);
    h_exception-&gt;print_value_on(&amp;st);
    st.print(&quot;%s%s&gt; (&quot; INTPTR_FORMAT &quot;) \n&quot;
<span class="udiff-line-modified-removed">-            &quot;thrown [%s, line %d]\nfor thread &quot; INTPTR_FORMAT,</span>
<span class="udiff-line-modified-added">+            &quot;thrown [%s, line %d]&quot;,</span>
             message ? &quot;: &quot; : &quot;&quot;, message ? message : &quot;&quot;,
<span class="udiff-line-modified-removed">-            p2i(h_exception()), file, line, p2i(thread));</span>
<span class="udiff-line-modified-added">+            p2i(h_exception()), file, line);</span>
  }
</pre>
<center><a href="dtrace_disabled.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>