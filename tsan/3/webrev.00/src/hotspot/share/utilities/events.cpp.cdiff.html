<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/utilities/events.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="dtrace_disabled.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/utilities/events.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 49,30 ***</span>
    _next = Events::_logs;
    Events::_logs = this;
  }
  
  // For each registered event logger, print out the current contents of
<span class="line-modified">! // the buffer.  This is normally called when the JVM is crashing.</span>
<span class="line-modified">! void Events::print_all(outputStream* out) {</span>
    EventLog* log = _logs;
    while (log != NULL) {
<span class="line-modified">!     log-&gt;print_log_on(out);</span>
      log = log-&gt;next();
    }
  }
  
  void Events::print() {
    print_all(tty);
  }
  
  void Events::init() {
    if (LogEvents) {
<span class="line-modified">!     _messages = new StringEventLog(&quot;Events&quot;);</span>
<span class="line-modified">!     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;);</span>
<span class="line-modified">!     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;);</span>
<span class="line-modified">!     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;);</span>
<span class="line-modified">!     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;);</span>
    }
  }
  
  void eventlog_init() {
    Events::init();
<span class="line-new-header">--- 49,55 ---</span>
    _next = Events::_logs;
    Events::_logs = this;
  }
  
  // For each registered event logger, print out the current contents of
<span class="line-modified">! // the buffer.</span>
<span class="line-modified">! void Events::print_all(outputStream* out, int max) {</span>
    EventLog* log = _logs;
    while (log != NULL) {
<span class="line-modified">!     log-&gt;print_log_on(out, max);</span>
      log = log-&gt;next();
    }
  }
  
<span class="line-added">+ // Print a single event log specified by name.</span>
<span class="line-added">+ void Events::print_one(outputStream* out, const char* log_name, int max) {</span>
<span class="line-added">+   EventLog* log = _logs;</span>
<span class="line-added">+   int num_printed = 0;</span>
<span class="line-added">+   while (log != NULL) {</span>
<span class="line-added">+     if (log-&gt;matches_name_or_handle(log_name)) {</span>
<span class="line-added">+       log-&gt;print_log_on(out, max);</span>
<span class="line-added">+       num_printed ++;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     log = log-&gt;next();</span>
<span class="line-added">+   }</span>
<span class="line-added">+   // Write a short error note if no name matched.</span>
<span class="line-added">+   if (num_printed == 0) {</span>
<span class="line-added">+     out-&gt;print_cr(&quot;The name \&quot;%s\&quot; did not match any known event log. &quot;</span>
<span class="line-added">+                   &quot;Valid event log names are:&quot;, log_name);</span>
<span class="line-added">+     EventLog* log = _logs;</span>
<span class="line-added">+     while (log != NULL) {</span>
<span class="line-added">+       log-&gt;print_names(out);</span>
<span class="line-added">+       out-&gt;cr();</span>
<span class="line-added">+       log = log-&gt;next();</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  void Events::print() {
    print_all(tty);
  }
  
  void Events::init() {
    if (LogEvents) {
<span class="line-modified">!     _messages = new StringEventLog(&quot;Events&quot;, &quot;events&quot;);</span>
<span class="line-modified">!     _exceptions = new ExceptionsEventLog(&quot;Internal exceptions&quot;, &quot;exc&quot;);</span>
<span class="line-modified">!     _redefinitions = new StringEventLog(&quot;Classes redefined&quot;, &quot;redef&quot;);</span>
<span class="line-modified">!     _class_unloading = new UnloadingEventLog(&quot;Classes unloaded&quot;, &quot;unload&quot;);</span>
<span class="line-modified">!     _deopt_messages = new StringEventLog(&quot;Deoptimization events&quot;, &quot;deopt&quot;);</span>
    }
  }
  
  void eventlog_init() {
    Events::init();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 106,26 ***</span>
    double timestamp = fetch_timestamp();
    // Unloading events are single threaded.
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="line-modified">!   stringStream st = _records[index].data.stream();</span>
    st.print(&quot;Unloading class &quot; INTPTR_FORMAT &quot; &quot;, p2i(ik));
    ik-&gt;name()-&gt;print_value_on(&amp;st);
  }
  
  void ExceptionsEventLog::log(Thread* thread, Handle h_exception, const char* message, const char* file, int line) {
    if (!should_log()) return;
  
    double timestamp = fetch_timestamp();
<span class="line-modified">!   MutexLockerEx ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="line-modified">!   stringStream st = _records[index].data.stream();</span>
    st.print(&quot;Exception &lt;&quot;);
    h_exception-&gt;print_value_on(&amp;st);
    st.print(&quot;%s%s&gt; (&quot; INTPTR_FORMAT &quot;) \n&quot;
<span class="line-modified">!            &quot;thrown [%s, line %d]\nfor thread &quot; INTPTR_FORMAT,</span>
             message ? &quot;: &quot; : &quot;&quot;, message ? message : &quot;&quot;,
<span class="line-modified">!            p2i(h_exception()), file, line, p2i(thread));</span>
  }
<span class="line-new-header">--- 131,28 ---</span>
    double timestamp = fetch_timestamp();
    // Unloading events are single threaded.
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="line-modified">!   stringStream st(_records[index].data.buffer(),</span>
<span class="line-added">+                   _records[index].data.size());</span>
    st.print(&quot;Unloading class &quot; INTPTR_FORMAT &quot; &quot;, p2i(ik));
    ik-&gt;name()-&gt;print_value_on(&amp;st);
  }
  
  void ExceptionsEventLog::log(Thread* thread, Handle h_exception, const char* message, const char* file, int line) {
    if (!should_log()) return;
  
    double timestamp = fetch_timestamp();
<span class="line-modified">!   MutexLocker ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
    int index = compute_log_index();
    _records[index].thread = thread;
    _records[index].timestamp = timestamp;
<span class="line-modified">!   stringStream st(_records[index].data.buffer(),</span>
<span class="line-added">+                   _records[index].data.size());</span>
    st.print(&quot;Exception &lt;&quot;);
    h_exception-&gt;print_value_on(&amp;st);
    st.print(&quot;%s%s&gt; (&quot; INTPTR_FORMAT &quot;) \n&quot;
<span class="line-modified">!            &quot;thrown [%s, line %d]&quot;,</span>
             message ? &quot;: &quot; : &quot;&quot;, message ? message : &quot;&quot;,
<span class="line-modified">!            p2i(h_exception()), file, line);</span>
  }
</pre>
<center><a href="dtrace_disabled.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="events.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>