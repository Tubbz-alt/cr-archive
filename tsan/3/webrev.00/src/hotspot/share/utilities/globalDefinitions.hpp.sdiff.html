<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/utilities/globalDefinitions.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="globalDefinitions.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="globalDefinitions_gcc.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/utilities/globalDefinitions.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  26 #define SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  27 
  28 #include &quot;utilities/compilerWarnings.hpp&quot;
  29 #include &quot;utilities/debug.hpp&quot;
  30 #include &quot;utilities/macros.hpp&quot;
  31 



  32 #include COMPILER_HEADER(utilities/globalDefinitions)
  33 
  34 // Defaults for macros that might be defined per compiler.
  35 #ifndef NOINLINE
  36 #define NOINLINE
  37 #endif
  38 #ifndef ALWAYSINLINE
  39 #define ALWAYSINLINE inline
  40 #endif
  41 
  42 #ifndef ATTRIBUTE_ALIGNED
  43 #define ATTRIBUTE_ALIGNED(x)
  44 #endif
  45 




















  46 // This file holds all globally used constants &amp; types, class (forward)
  47 // declarations and a few frequently used utility functions.
  48 













  49 //----------------------------------------------------------------------------------------------------
  50 // Printf-style formatters for fixed- and variable-width types as pointers and
  51 // integers.  These are derived from the definitions in inttypes.h.  If the platform
  52 // doesn&#39;t provide appropriate definitions, they should be provided in
  53 // the compiler-specific definitions file (e.g., globalDefinitions_gcc.hpp)
  54 
  55 #define BOOL_TO_STR(_b_) ((_b_) ? &quot;true&quot; : &quot;false&quot;)
  56 
  57 // Format 32-bit quantities.
  58 #define INT32_FORMAT           &quot;%&quot; PRId32
  59 #define UINT32_FORMAT          &quot;%&quot; PRIu32
  60 #define INT32_FORMAT_W(width)  &quot;%&quot; #width PRId32
  61 #define UINT32_FORMAT_W(width) &quot;%&quot; #width PRIu32
  62 
  63 #define PTR32_FORMAT           &quot;0x%08&quot; PRIx32
  64 #define PTR32_FORMAT_W(width)  &quot;0x%&quot; #width PRIx32
  65 
  66 // Format 64-bit quantities.
  67 #define INT64_FORMAT           &quot;%&quot; PRId64
  68 #define UINT64_FORMAT          &quot;%&quot; PRIu64
  69 #define UINT64_FORMAT_X        &quot;%&quot; PRIx64
  70 #define INT64_FORMAT_W(width)  &quot;%&quot; #width PRId64
  71 #define UINT64_FORMAT_W(width) &quot;%&quot; #width PRIu64
  72 #define UINT64_FORMAT_X_W(width) &quot;%&quot; #width PRIx64
  73 
  74 #define PTR64_FORMAT           &quot;0x%016&quot; PRIx64
  75 
  76 // Format jlong, if necessary
  77 #ifndef JLONG_FORMAT
  78 #define JLONG_FORMAT           INT64_FORMAT
  79 #endif



  80 #ifndef JULONG_FORMAT
  81 #define JULONG_FORMAT          UINT64_FORMAT
  82 #endif
  83 #ifndef JULONG_FORMAT_X
  84 #define JULONG_FORMAT_X        UINT64_FORMAT_X
  85 #endif
  86 
  87 // Format pointers which change size between 32- and 64-bit.
  88 #ifdef  _LP64
  89 #define INTPTR_FORMAT &quot;0x%016&quot; PRIxPTR
  90 #define PTR_FORMAT    &quot;0x%016&quot; PRIxPTR
  91 #else   // !_LP64
  92 #define INTPTR_FORMAT &quot;0x%08&quot;  PRIxPTR
  93 #define PTR_FORMAT    &quot;0x%08&quot;  PRIxPTR
  94 #endif  // _LP64
  95 
  96 // Format pointers without leading zeros
  97 #define INTPTRNZ_FORMAT &quot;0x%&quot;  PRIxPTR
  98 
  99 #define INTPTR_FORMAT_W(width)   &quot;%&quot; #width PRIxPTR
</pre>
<hr />
<pre>
 198 // Constant for jlong (standardized by C++11)
 199 
 200 // Build a 64bit integer constant
 201 #define CONST64(x)  (x ## LL)
 202 #define UCONST64(x) (x ## ULL)
 203 
 204 const jlong min_jlong = CONST64(0x8000000000000000);
 205 const jlong max_jlong = CONST64(0x7fffffffffffffff);
 206 
 207 const size_t K                  = 1024;
 208 const size_t M                  = K*K;
 209 const size_t G                  = M*K;
 210 const size_t HWperKB            = K / sizeof(HeapWord);
 211 
 212 // Constants for converting from a base unit to milli-base units.  For
 213 // example from seconds to milliseconds and microseconds
 214 
 215 const int MILLIUNITS    = 1000;         // milli units per base unit
 216 const int MICROUNITS    = 1000000;      // micro units per base unit
 217 const int NANOUNITS     = 1000000000;   // nano units per base unit

 218 
 219 const jlong NANOSECS_PER_SEC      = CONST64(1000000000);
 220 const jint  NANOSECS_PER_MILLISEC = 1000000;
 221 











 222 // Proper units routines try to maintain at least three significant digits.
 223 // In worst case, it would print five significant digits with lower prefix.
 224 // G is close to MAX_SIZE on 32-bit platforms, so its product can easily overflow,
 225 // and therefore we need to be careful.
 226 
 227 inline const char* proper_unit_for_byte_size(size_t s) {
 228 #ifdef _LP64
 229   if (s &gt;= 100*G) {
 230     return &quot;G&quot;;
 231   }
 232 #endif
 233   if (s &gt;= 100*M) {
 234     return &quot;M&quot;;
 235   } else if (s &gt;= 100*K) {
 236     return &quot;K&quot;;
 237   } else {
 238     return &quot;B&quot;;
 239   }
 240 }
 241 
</pre>
<hr />
<pre>
 268     return &quot;K&quot;;
 269   }
 270   return &quot;B&quot;;
 271 }
 272 
 273 inline size_t byte_size_in_exact_unit(size_t s) {
 274 #ifdef _LP64
 275   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 276     return s / G;
 277   }
 278 #endif
 279   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 280     return s / M;
 281   }
 282   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 283     return s / K;
 284   }
 285   return s;
 286 }
 287 







 288 //----------------------------------------------------------------------------------------------------
 289 // VM type definitions
 290 
 291 // intx and uintx are the &#39;extended&#39; int and &#39;extended&#39; unsigned int types;
 292 // they are 32bit wide on a 32-bit platform, and 64bit wide on a 64bit platform.
 293 
 294 typedef intptr_t  intx;
 295 typedef uintptr_t uintx;
 296 
 297 const intx  min_intx  = (intx)1 &lt;&lt; (sizeof(intx)*BitsPerByte-1);
 298 const intx  max_intx  = (uintx)min_intx - 1;
 299 const uintx max_uintx = (uintx)-1;
 300 
 301 // Table of values:
 302 //      sizeof intx         4               8
 303 // min_intx             0x80000000      0x8000000000000000
 304 // max_intx             0x7FFFFFFF      0x7FFFFFFFFFFFFFFF
 305 // max_uintx            0xFFFFFFFF      0xFFFFFFFFFFFFFFFF
 306 
 307 typedef unsigned int uint;   NEEDS_CLEANUP
</pre>
<hr />
<pre>
 434 
 435 // Maximal size of compressed class space. Above this limit compression is not possible.
 436 // Also upper bound for placement of zero based class space. (Class space is further limited
 437 // to be &lt; 3G, see arguments.cpp.)
 438 const  uint64_t KlassEncodingMetaspaceMax = (uint64_t(max_juint) + 1) &lt;&lt; LogKlassAlignmentInBytes;
 439 
 440 // Machine dependent stuff
 441 
 442 // The maximum size of the code cache.  Can be overridden by targets.
 443 #define CODE_CACHE_SIZE_LIMIT (2*G)
 444 // Allow targets to reduce the default size of the code cache.
 445 #define CODE_CACHE_DEFAULT_LIMIT CODE_CACHE_SIZE_LIMIT
 446 
 447 #include CPU_HEADER(globalDefinitions)
 448 
 449 // To assure the IRIW property on processors that are not multiple copy
 450 // atomic, sync instructions must be issued between volatile reads to
 451 // assure their ordering, instead of after volatile stores.
 452 // (See &quot;A Tutorial Introduction to the ARM and POWER Relaxed Memory Models&quot;
 453 // by Luc Maranget, Susmit Sarkar and Peter Sewell, INRIA/Cambridge)
<span class="line-modified"> 454 #ifdef CPU_NOT_MULTIPLE_COPY_ATOMIC</span>
<span class="line-modified"> 455 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = true;</span>
<span class="line-removed"> 456 #else</span>
 457 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = false;




 458 #endif
 459 
 460 // The expected size in bytes of a cache line, used to pad data structures.
 461 #ifndef DEFAULT_CACHE_LINE_SIZE
 462   #define DEFAULT_CACHE_LINE_SIZE 64
 463 #endif
 464 
 465 
 466 //----------------------------------------------------------------------------------------------------
 467 // Utility macros for compilers
 468 // used to silence compiler warnings
 469 
 470 #define Unused_Variable(var) var
 471 
 472 
 473 //----------------------------------------------------------------------------------------------------
 474 // Miscellaneous
 475 
 476 // 6302670 Eliminate Hotspot __fabsf dependency
 477 // All fabs() callers should call this function instead, which will implicitly
</pre>
<hr />
<pre>
 520 inline void set_high(jlong* value, jint high)    { *value &amp;= (jlong)(julong)(juint)0xffffffff;
 521                                                    *value |= (jlong)high       &lt;&lt; 32; }
 522 
 523 inline jlong jlong_from(jint h, jint l) {
 524   jlong result = 0; // initialization to avoid warning
 525   set_high(&amp;result, h);
 526   set_low(&amp;result,  l);
 527   return result;
 528 }
 529 
 530 union jlong_accessor {
 531   jint  words[2];
 532   jlong long_value;
 533 };
 534 
 535 void basic_types_init(); // cannot define here; uses assert
 536 
 537 
 538 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 539 enum BasicType {
<span class="line-modified"> 540   T_BOOLEAN     =  4,</span>
<span class="line-modified"> 541   T_CHAR        =  5,</span>
<span class="line-modified"> 542   T_FLOAT       =  6,</span>
<span class="line-modified"> 543   T_DOUBLE      =  7,</span>
<span class="line-modified"> 544   T_BYTE        =  8,</span>
<span class="line-modified"> 545   T_SHORT       =  9,</span>
<span class="line-modified"> 546   T_INT         = 10,</span>
<span class="line-modified"> 547   T_LONG        = 11,</span>








 548   T_OBJECT      = 12,
 549   T_ARRAY       = 13,
 550   T_VOID        = 14,
 551   T_ADDRESS     = 15,
 552   T_NARROWOOP   = 16,
 553   T_METADATA    = 17,
 554   T_NARROWKLASS = 18,
 555   T_CONFLICT    = 19, // for stack value type with conflicting contents
 556   T_ILLEGAL     = 99
 557 };
 558 


















 559 inline bool is_java_primitive(BasicType t) {
 560   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_LONG;
 561 }
 562 
 563 inline bool is_subword_type(BasicType t) {
 564   // these guys are processed exactly like T_INT in calling sequences:
 565   return (t == T_BOOLEAN || t == T_CHAR || t == T_BYTE || t == T_SHORT);
 566 }
 567 
 568 inline bool is_signed_subword_type(BasicType t) {
 569   return (t == T_BYTE || t == T_SHORT);
 570 }
 571 
<span class="line-modified"> 572 inline bool is_reference_type(BasicType t) {</span>
<span class="line-modified"> 573   return (t == T_OBJECT || t == T_ARRAY);</span>
 574 }
 575 
<span class="line-modified"> 576 // Convert a char from a classfile signature to a BasicType</span>
<span class="line-modified"> 577 inline BasicType char2type(char c) {</span>
<span class="line-removed"> 578   switch( c ) {</span>
<span class="line-removed"> 579   case &#39;B&#39;: return T_BYTE;</span>
<span class="line-removed"> 580   case &#39;C&#39;: return T_CHAR;</span>
<span class="line-removed"> 581   case &#39;D&#39;: return T_DOUBLE;</span>
<span class="line-removed"> 582   case &#39;F&#39;: return T_FLOAT;</span>
<span class="line-removed"> 583   case &#39;I&#39;: return T_INT;</span>
<span class="line-removed"> 584   case &#39;J&#39;: return T_LONG;</span>
<span class="line-removed"> 585   case &#39;S&#39;: return T_SHORT;</span>
<span class="line-removed"> 586   case &#39;Z&#39;: return T_BOOLEAN;</span>
<span class="line-removed"> 587   case &#39;V&#39;: return T_VOID;</span>
<span class="line-removed"> 588   case &#39;L&#39;: return T_OBJECT;</span>
<span class="line-removed"> 589   case &#39;[&#39;: return T_ARRAY;</span>
<span class="line-removed"> 590   }</span>
<span class="line-removed"> 591   return T_ILLEGAL;</span>
 592 }
 593 
 594 extern char type2char_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 595 inline char type2char(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2char_tab[t] : 0; }
 596 extern int type2size[T_CONFLICT+1];         // Map BasicType to result stack elements
 597 extern const char* type2name_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 598 inline const char* type2name(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2name_tab[t] : NULL; }
 599 extern BasicType name2type(const char* name);
 600 
 601 // Auxiliary math routines
 602 // least common multiple
 603 extern size_t lcm(size_t a, size_t b);
 604 
 605 
 606 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 607 enum BasicTypeSize {
 608   T_BOOLEAN_size     = 1,
 609   T_CHAR_size        = 1,
 610   T_FLOAT_size       = 1,
 611   T_DOUBLE_size      = 2,
 612   T_BYTE_size        = 1,
 613   T_SHORT_size       = 1,
 614   T_INT_size         = 1,
 615   T_LONG_size        = 2,
 616   T_OBJECT_size      = 1,
 617   T_ARRAY_size       = 1,
 618   T_NARROWOOP_size   = 1,
 619   T_NARROWKLASS_size = 1,
 620   T_VOID_size        = 0
 621 };
 622 







 623 
 624 // maps a BasicType to its instance field storage type:
 625 // all sub-word integral types are widened to T_INT
 626 extern BasicType type2field[T_CONFLICT+1];
 627 extern BasicType type2wfield[T_CONFLICT+1];
 628 
 629 
 630 // size in bytes
 631 enum ArrayElementSize {
 632   T_BOOLEAN_aelem_bytes     = 1,
 633   T_CHAR_aelem_bytes        = 2,
 634   T_FLOAT_aelem_bytes       = 4,
 635   T_DOUBLE_aelem_bytes      = 8,
 636   T_BYTE_aelem_bytes        = 1,
 637   T_SHORT_aelem_bytes       = 2,
 638   T_INT_aelem_bytes         = 4,
 639   T_LONG_aelem_bytes        = 8,
 640 #ifdef _LP64
 641   T_OBJECT_aelem_bytes      = 8,
 642   T_ARRAY_aelem_bytes       = 8,
</pre>
<hr />
<pre>
 884 #endif
 885 
 886 #ifdef min
 887 #undef min
 888 #endif
 889 
 890 // It is necessary to use templates here. Having normal overloaded
 891 // functions does not work because it is necessary to provide both 32-
 892 // and 64-bit overloaded functions, which does not work, and having
 893 // explicitly-typed versions of these routines (i.e., MAX2I, MAX2L)
 894 // will be even more error-prone than macros.
 895 template&lt;class T&gt; inline T MAX2(T a, T b)           { return (a &gt; b) ? a : b; }
 896 template&lt;class T&gt; inline T MIN2(T a, T b)           { return (a &lt; b) ? a : b; }
 897 template&lt;class T&gt; inline T MAX3(T a, T b, T c)      { return MAX2(MAX2(a, b), c); }
 898 template&lt;class T&gt; inline T MIN3(T a, T b, T c)      { return MIN2(MIN2(a, b), c); }
 899 template&lt;class T&gt; inline T MAX4(T a, T b, T c, T d) { return MAX2(MAX3(a, b, c), d); }
 900 template&lt;class T&gt; inline T MIN4(T a, T b, T c, T d) { return MIN2(MIN3(a, b, c), d); }
 901 
 902 template&lt;class T&gt; inline T ABS(T x)                 { return (x &gt; 0) ? x : -x; }
 903 
<span class="line-modified"> 904 // true if x is a power of 2, false otherwise</span>
<span class="line-modified"> 905 inline bool is_power_of_2(intptr_t x) {</span>
<span class="line-modified"> 906   return ((x != NoBits) &amp;&amp; (mask_bits(x, x - 1) == NoBits));</span>
<span class="line-modified"> 907 }</span>
<span class="line-modified"> 908 </span>
<span class="line-removed"> 909 // long version of is_power_of_2</span>
<span class="line-removed"> 910 inline bool is_power_of_2_long(jlong x) {</span>
<span class="line-removed"> 911   return ((x != NoLongBits) &amp;&amp; (mask_long_bits(x, x - 1) == NoLongBits));</span>
 912 }
 913 
 914 // Returns largest i such that 2^i &lt;= x.
 915 // If x == 0, the function returns -1.
 916 inline int log2_intptr(uintptr_t x) {
 917   int i = -1;
 918   uintptr_t p = 1;
 919   while (p != 0 &amp;&amp; p &lt;= x) {
 920     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
 921     i++; p *= 2;
 922   }
 923   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
 924   // If p = 0, overflow has occurred and i = 31 or i = 63 (depending on the machine word size).
 925   return i;
 926 }
 927 
 928 //* largest i such that 2^i &lt;= x
 929 inline int log2_long(julong x) {
 930   int i = -1;
 931   julong p =  1;
</pre>
<hr />
<pre>
 947   STATIC_ASSERT(sizeof(int) &lt;= sizeof(uintptr_t));
 948   return log2_intptr((uintptr_t)x);
 949 }
 950 
 951 inline int log2_jint(jint x) {
 952   STATIC_ASSERT(sizeof(jint) &lt;= sizeof(uintptr_t));
 953   return log2_intptr((uintptr_t)x);
 954 }
 955 
 956 inline int log2_uint(uint x) {
 957   STATIC_ASSERT(sizeof(uint) &lt;= sizeof(uintptr_t));
 958   return log2_intptr((uintptr_t)x);
 959 }
 960 
 961 //  A negative value of &#39;x&#39; will return &#39;63&#39;
 962 inline int log2_jlong(jlong x) {
 963   STATIC_ASSERT(sizeof(jlong) &lt;= sizeof(julong));
 964   return log2_long((julong)x);
 965 }
 966 
<span class="line-removed"> 967 //* the argument must be exactly a power of 2</span>
<span class="line-removed"> 968 inline int exact_log2(intptr_t x) {</span>
<span class="line-removed"> 969   assert(is_power_of_2(x), &quot;x must be a power of 2: &quot; INTPTR_FORMAT, x);</span>
<span class="line-removed"> 970   return log2_intptr(x);</span>
<span class="line-removed"> 971 }</span>
<span class="line-removed"> 972 </span>
<span class="line-removed"> 973 //* the argument must be exactly a power of 2</span>
<span class="line-removed"> 974 inline int exact_log2_long(jlong x) {</span>
<span class="line-removed"> 975   assert(is_power_of_2_long(x), &quot;x must be a power of 2: &quot; JLONG_FORMAT, x);</span>
<span class="line-removed"> 976   return log2_long(x);</span>
<span class="line-removed"> 977 }</span>
<span class="line-removed"> 978 </span>
 979 inline bool is_odd (intx x) { return x &amp; 1;      }
 980 inline bool is_even(intx x) { return !is_odd(x); }
 981 
 982 // abs methods which cannot overflow and so are well-defined across
 983 // the entire domain of integer types.
 984 static inline unsigned int uabs(unsigned int n) {
 985   union {
 986     unsigned int result;
 987     int value;
 988   };
 989   result = n;
 990   if (value &lt; 0) result = 0-result;
 991   return result;
 992 }
 993 static inline julong uabs(julong n) {
 994   union {
 995     julong result;
 996     jlong value;
 997   };
 998   result = n;
</pre>
<hr />
<pre>
1045 // The goal of this code to avoid undefined or implementation-defined
1046 // behavior.  The use of an lvalue to reference cast is explicitly
1047 // permitted by Lvalues and rvalues [basic.lval].  [Section 3.10 Para
1048 // 15 in C++03]
1049 #define JAVA_INTEGER_OP(OP, NAME, TYPE, UNSIGNED_TYPE)  \
1050 inline TYPE NAME (TYPE in1, TYPE in2) {                 \
1051   UNSIGNED_TYPE ures = static_cast&lt;UNSIGNED_TYPE&gt;(in1); \
1052   ures OP ## = static_cast&lt;UNSIGNED_TYPE&gt;(in2);         \
1053   return reinterpret_cast&lt;TYPE&amp;&gt;(ures);                 \
1054 }
1055 
1056 JAVA_INTEGER_OP(+, java_add, jint, juint)
1057 JAVA_INTEGER_OP(-, java_subtract, jint, juint)
1058 JAVA_INTEGER_OP(*, java_multiply, jint, juint)
1059 JAVA_INTEGER_OP(+, java_add, jlong, julong)
1060 JAVA_INTEGER_OP(-, java_subtract, jlong, julong)
1061 JAVA_INTEGER_OP(*, java_multiply, jlong, julong)
1062 
1063 #undef JAVA_INTEGER_OP
1064 

















































1065 // Dereference vptr
1066 // All C++ compilers that we know of have the vtbl pointer in the first
1067 // word.  If there are exceptions, this function needs to be made compiler
1068 // specific.
1069 static inline void* dereference_vptr(const void* addr) {
1070   return *(void**)addr;
1071 }
1072 
1073 //----------------------------------------------------------------------------------------------------
1074 // String type aliases used by command line flag declarations and
1075 // processing utilities.
1076 
1077 typedef const char* ccstr;
1078 typedef const char* ccstrlist;   // represents string arguments which accumulate
1079 
1080 //----------------------------------------------------------------------------------------------------
1081 // Default hash/equals functions used by ResourceHashtable and KVHashtable
1082 
1083 template&lt;typename K&gt; unsigned primitive_hash(const K&amp; k) {
1084   unsigned hash = (unsigned)((uintptr_t)k);
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  26 #define SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  27 
  28 #include &quot;utilities/compilerWarnings.hpp&quot;
  29 #include &quot;utilities/debug.hpp&quot;
  30 #include &quot;utilities/macros.hpp&quot;
  31 
<span class="line-added">  32 // Get constants like JVM_T_CHAR and JVM_SIGNATURE_INT, before pulling in &lt;jvm.h&gt;.</span>
<span class="line-added">  33 #include &quot;classfile_constants.h&quot;</span>
<span class="line-added">  34 </span>
  35 #include COMPILER_HEADER(utilities/globalDefinitions)
  36 
  37 // Defaults for macros that might be defined per compiler.
  38 #ifndef NOINLINE
  39 #define NOINLINE
  40 #endif
  41 #ifndef ALWAYSINLINE
  42 #define ALWAYSINLINE inline
  43 #endif
  44 
  45 #ifndef ATTRIBUTE_ALIGNED
  46 #define ATTRIBUTE_ALIGNED(x)
  47 #endif
  48 
<span class="line-added">  49 // These are #defines to selectively turn on/off the Print(Opto)Assembly</span>
<span class="line-added">  50 // capabilities. Choices should be led by a tradeoff between</span>
<span class="line-added">  51 // code size and improved supportability.</span>
<span class="line-added">  52 // if PRINT_ASSEMBLY then PRINT_ABSTRACT_ASSEMBLY must be true as well</span>
<span class="line-added">  53 // to have a fallback in case hsdis is not available.</span>
<span class="line-added">  54 #if defined(PRODUCT)</span>
<span class="line-added">  55   #define SUPPORT_ABSTRACT_ASSEMBLY</span>
<span class="line-added">  56   #define SUPPORT_ASSEMBLY</span>
<span class="line-added">  57   #undef  SUPPORT_OPTO_ASSEMBLY      // Can&#39;t activate. In PRODUCT, many dump methods are missing.</span>
<span class="line-added">  58   #undef  SUPPORT_DATA_STRUCTS       // Of limited use. In PRODUCT, many print methods are empty.</span>
<span class="line-added">  59 #else</span>
<span class="line-added">  60   #define SUPPORT_ABSTRACT_ASSEMBLY</span>
<span class="line-added">  61   #define SUPPORT_ASSEMBLY</span>
<span class="line-added">  62   #define SUPPORT_OPTO_ASSEMBLY</span>
<span class="line-added">  63   #define SUPPORT_DATA_STRUCTS</span>
<span class="line-added">  64 #endif</span>
<span class="line-added">  65 #if defined(SUPPORT_ASSEMBLY) &amp;&amp; !defined(SUPPORT_ABSTRACT_ASSEMBLY)</span>
<span class="line-added">  66   #define SUPPORT_ABSTRACT_ASSEMBLY</span>
<span class="line-added">  67 #endif</span>
<span class="line-added">  68 </span>
  69 // This file holds all globally used constants &amp; types, class (forward)
  70 // declarations and a few frequently used utility functions.
  71 
<span class="line-added">  72 // Declare the named class to be noncopyable.  This macro must be used in</span>
<span class="line-added">  73 // a private part of the class&#39;s definition, followed by a semi-colon.</span>
<span class="line-added">  74 // Doing so provides private declarations for the class&#39;s copy constructor</span>
<span class="line-added">  75 // and assignment operator.  Because these operations are private, most</span>
<span class="line-added">  76 // potential callers will fail to compile because they are inaccessible.</span>
<span class="line-added">  77 // The operations intentionally lack a definition, to provoke link-time</span>
<span class="line-added">  78 // failures for calls from contexts where they are accessible, e.g. from</span>
<span class="line-added">  79 // within the class or from a friend of the class.</span>
<span class="line-added">  80 // Note: The lack of definitions is still not completely bullet-proof, as</span>
<span class="line-added">  81 // an apparent call might be optimized away by copy elision.</span>
<span class="line-added">  82 // For C++11 the declarations should be changed to deleted definitions.</span>
<span class="line-added">  83 #define NONCOPYABLE(C) C(C const&amp;); C&amp; operator=(C const&amp;) /* next token must be ; */</span>
<span class="line-added">  84 </span>
  85 //----------------------------------------------------------------------------------------------------
  86 // Printf-style formatters for fixed- and variable-width types as pointers and
  87 // integers.  These are derived from the definitions in inttypes.h.  If the platform
  88 // doesn&#39;t provide appropriate definitions, they should be provided in
  89 // the compiler-specific definitions file (e.g., globalDefinitions_gcc.hpp)
  90 
  91 #define BOOL_TO_STR(_b_) ((_b_) ? &quot;true&quot; : &quot;false&quot;)
  92 
  93 // Format 32-bit quantities.
  94 #define INT32_FORMAT           &quot;%&quot; PRId32
  95 #define UINT32_FORMAT          &quot;%&quot; PRIu32
  96 #define INT32_FORMAT_W(width)  &quot;%&quot; #width PRId32
  97 #define UINT32_FORMAT_W(width) &quot;%&quot; #width PRIu32
  98 
  99 #define PTR32_FORMAT           &quot;0x%08&quot; PRIx32
 100 #define PTR32_FORMAT_W(width)  &quot;0x%&quot; #width PRIx32
 101 
 102 // Format 64-bit quantities.
 103 #define INT64_FORMAT           &quot;%&quot; PRId64
 104 #define UINT64_FORMAT          &quot;%&quot; PRIu64
 105 #define UINT64_FORMAT_X        &quot;%&quot; PRIx64
 106 #define INT64_FORMAT_W(width)  &quot;%&quot; #width PRId64
 107 #define UINT64_FORMAT_W(width) &quot;%&quot; #width PRIu64
 108 #define UINT64_FORMAT_X_W(width) &quot;%&quot; #width PRIx64
 109 
 110 #define PTR64_FORMAT           &quot;0x%016&quot; PRIx64
 111 
 112 // Format jlong, if necessary
 113 #ifndef JLONG_FORMAT
 114 #define JLONG_FORMAT           INT64_FORMAT
 115 #endif
<span class="line-added"> 116 #ifndef JLONG_FORMAT_W</span>
<span class="line-added"> 117 #define JLONG_FORMAT_W(width)  INT64_FORMAT_W(width)</span>
<span class="line-added"> 118 #endif</span>
 119 #ifndef JULONG_FORMAT
 120 #define JULONG_FORMAT          UINT64_FORMAT
 121 #endif
 122 #ifndef JULONG_FORMAT_X
 123 #define JULONG_FORMAT_X        UINT64_FORMAT_X
 124 #endif
 125 
 126 // Format pointers which change size between 32- and 64-bit.
 127 #ifdef  _LP64
 128 #define INTPTR_FORMAT &quot;0x%016&quot; PRIxPTR
 129 #define PTR_FORMAT    &quot;0x%016&quot; PRIxPTR
 130 #else   // !_LP64
 131 #define INTPTR_FORMAT &quot;0x%08&quot;  PRIxPTR
 132 #define PTR_FORMAT    &quot;0x%08&quot;  PRIxPTR
 133 #endif  // _LP64
 134 
 135 // Format pointers without leading zeros
 136 #define INTPTRNZ_FORMAT &quot;0x%&quot;  PRIxPTR
 137 
 138 #define INTPTR_FORMAT_W(width)   &quot;%&quot; #width PRIxPTR
</pre>
<hr />
<pre>
 237 // Constant for jlong (standardized by C++11)
 238 
 239 // Build a 64bit integer constant
 240 #define CONST64(x)  (x ## LL)
 241 #define UCONST64(x) (x ## ULL)
 242 
 243 const jlong min_jlong = CONST64(0x8000000000000000);
 244 const jlong max_jlong = CONST64(0x7fffffffffffffff);
 245 
 246 const size_t K                  = 1024;
 247 const size_t M                  = K*K;
 248 const size_t G                  = M*K;
 249 const size_t HWperKB            = K / sizeof(HeapWord);
 250 
 251 // Constants for converting from a base unit to milli-base units.  For
 252 // example from seconds to milliseconds and microseconds
 253 
 254 const int MILLIUNITS    = 1000;         // milli units per base unit
 255 const int MICROUNITS    = 1000000;      // micro units per base unit
 256 const int NANOUNITS     = 1000000000;   // nano units per base unit
<span class="line-added"> 257 const int NANOUNITS_PER_MILLIUNIT = NANOUNITS / MILLIUNITS;</span>
 258 
 259 const jlong NANOSECS_PER_SEC      = CONST64(1000000000);
 260 const jint  NANOSECS_PER_MILLISEC = 1000000;
 261 
<span class="line-added"> 262 </span>
<span class="line-added"> 263 // Unit conversion functions</span>
<span class="line-added"> 264 // The caller is responsible for considering overlow.</span>
<span class="line-added"> 265 </span>
<span class="line-added"> 266 inline int64_t nanos_to_millis(int64_t nanos) {</span>
<span class="line-added"> 267   return nanos / NANOUNITS_PER_MILLIUNIT;</span>
<span class="line-added"> 268 }</span>
<span class="line-added"> 269 inline int64_t millis_to_nanos(int64_t millis) {</span>
<span class="line-added"> 270   return millis * NANOUNITS_PER_MILLIUNIT;</span>
<span class="line-added"> 271 }</span>
<span class="line-added"> 272 </span>
 273 // Proper units routines try to maintain at least three significant digits.
 274 // In worst case, it would print five significant digits with lower prefix.
 275 // G is close to MAX_SIZE on 32-bit platforms, so its product can easily overflow,
 276 // and therefore we need to be careful.
 277 
 278 inline const char* proper_unit_for_byte_size(size_t s) {
 279 #ifdef _LP64
 280   if (s &gt;= 100*G) {
 281     return &quot;G&quot;;
 282   }
 283 #endif
 284   if (s &gt;= 100*M) {
 285     return &quot;M&quot;;
 286   } else if (s &gt;= 100*K) {
 287     return &quot;K&quot;;
 288   } else {
 289     return &quot;B&quot;;
 290   }
 291 }
 292 
</pre>
<hr />
<pre>
 319     return &quot;K&quot;;
 320   }
 321   return &quot;B&quot;;
 322 }
 323 
 324 inline size_t byte_size_in_exact_unit(size_t s) {
 325 #ifdef _LP64
 326   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 327     return s / G;
 328   }
 329 #endif
 330   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 331     return s / M;
 332   }
 333   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 334     return s / K;
 335   }
 336   return s;
 337 }
 338 
<span class="line-added"> 339 // Memory size transition formatting.</span>
<span class="line-added"> 340 </span>
<span class="line-added"> 341 #define HEAP_CHANGE_FORMAT &quot;%s: &quot; SIZE_FORMAT &quot;K(&quot; SIZE_FORMAT &quot;K)-&gt;&quot; SIZE_FORMAT &quot;K(&quot; SIZE_FORMAT &quot;K)&quot;</span>
<span class="line-added"> 342 </span>
<span class="line-added"> 343 #define HEAP_CHANGE_FORMAT_ARGS(_name_, _prev_used_, _prev_capacity_, _used_, _capacity_) \</span>
<span class="line-added"> 344   (_name_), (_prev_used_) / K, (_prev_capacity_) / K, (_used_) / K, (_capacity_) / K</span>
<span class="line-added"> 345 </span>
 346 //----------------------------------------------------------------------------------------------------
 347 // VM type definitions
 348 
 349 // intx and uintx are the &#39;extended&#39; int and &#39;extended&#39; unsigned int types;
 350 // they are 32bit wide on a 32-bit platform, and 64bit wide on a 64bit platform.
 351 
 352 typedef intptr_t  intx;
 353 typedef uintptr_t uintx;
 354 
 355 const intx  min_intx  = (intx)1 &lt;&lt; (sizeof(intx)*BitsPerByte-1);
 356 const intx  max_intx  = (uintx)min_intx - 1;
 357 const uintx max_uintx = (uintx)-1;
 358 
 359 // Table of values:
 360 //      sizeof intx         4               8
 361 // min_intx             0x80000000      0x8000000000000000
 362 // max_intx             0x7FFFFFFF      0x7FFFFFFFFFFFFFFF
 363 // max_uintx            0xFFFFFFFF      0xFFFFFFFFFFFFFFFF
 364 
 365 typedef unsigned int uint;   NEEDS_CLEANUP
</pre>
<hr />
<pre>
 492 
 493 // Maximal size of compressed class space. Above this limit compression is not possible.
 494 // Also upper bound for placement of zero based class space. (Class space is further limited
 495 // to be &lt; 3G, see arguments.cpp.)
 496 const  uint64_t KlassEncodingMetaspaceMax = (uint64_t(max_juint) + 1) &lt;&lt; LogKlassAlignmentInBytes;
 497 
 498 // Machine dependent stuff
 499 
 500 // The maximum size of the code cache.  Can be overridden by targets.
 501 #define CODE_CACHE_SIZE_LIMIT (2*G)
 502 // Allow targets to reduce the default size of the code cache.
 503 #define CODE_CACHE_DEFAULT_LIMIT CODE_CACHE_SIZE_LIMIT
 504 
 505 #include CPU_HEADER(globalDefinitions)
 506 
 507 // To assure the IRIW property on processors that are not multiple copy
 508 // atomic, sync instructions must be issued between volatile reads to
 509 // assure their ordering, instead of after volatile stores.
 510 // (See &quot;A Tutorial Introduction to the ARM and POWER Relaxed Memory Models&quot;
 511 // by Luc Maranget, Susmit Sarkar and Peter Sewell, INRIA/Cambridge)
<span class="line-modified"> 512 #ifdef CPU_MULTI_COPY_ATOMIC</span>
<span class="line-modified"> 513 // Not needed.</span>

 514 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = false;
<span class="line-added"> 515 #else</span>
<span class="line-added"> 516 // From all non-multi-copy-atomic architectures, only PPC64 supports IRIW at the moment.</span>
<span class="line-added"> 517 // Final decision is subject to JEP 188: Java Memory Model Update.</span>
<span class="line-added"> 518 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = PPC64_ONLY(true) NOT_PPC64(false);</span>
 519 #endif
 520 
 521 // The expected size in bytes of a cache line, used to pad data structures.
 522 #ifndef DEFAULT_CACHE_LINE_SIZE
 523   #define DEFAULT_CACHE_LINE_SIZE 64
 524 #endif
 525 
 526 
 527 //----------------------------------------------------------------------------------------------------
 528 // Utility macros for compilers
 529 // used to silence compiler warnings
 530 
 531 #define Unused_Variable(var) var
 532 
 533 
 534 //----------------------------------------------------------------------------------------------------
 535 // Miscellaneous
 536 
 537 // 6302670 Eliminate Hotspot __fabsf dependency
 538 // All fabs() callers should call this function instead, which will implicitly
</pre>
<hr />
<pre>
 581 inline void set_high(jlong* value, jint high)    { *value &amp;= (jlong)(julong)(juint)0xffffffff;
 582                                                    *value |= (jlong)high       &lt;&lt; 32; }
 583 
 584 inline jlong jlong_from(jint h, jint l) {
 585   jlong result = 0; // initialization to avoid warning
 586   set_high(&amp;result, h);
 587   set_low(&amp;result,  l);
 588   return result;
 589 }
 590 
 591 union jlong_accessor {
 592   jint  words[2];
 593   jlong long_value;
 594 };
 595 
 596 void basic_types_init(); // cannot define here; uses assert
 597 
 598 
 599 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 600 enum BasicType {
<span class="line-modified"> 601 // The values T_BOOLEAN..T_LONG (4..11) are derived from the JVMS.</span>
<span class="line-modified"> 602   T_BOOLEAN     = JVM_T_BOOLEAN,</span>
<span class="line-modified"> 603   T_CHAR        = JVM_T_CHAR,</span>
<span class="line-modified"> 604   T_FLOAT       = JVM_T_FLOAT,</span>
<span class="line-modified"> 605   T_DOUBLE      = JVM_T_DOUBLE,</span>
<span class="line-modified"> 606   T_BYTE        = JVM_T_BYTE,</span>
<span class="line-modified"> 607   T_SHORT       = JVM_T_SHORT,</span>
<span class="line-modified"> 608   T_INT         = JVM_T_INT,</span>
<span class="line-added"> 609   T_LONG        = JVM_T_LONG,</span>
<span class="line-added"> 610   // The remaining values are not part of any standard.</span>
<span class="line-added"> 611   // T_OBJECT and T_VOID denote two more semantic choices</span>
<span class="line-added"> 612   // for method return values.</span>
<span class="line-added"> 613   // T_OBJECT and T_ARRAY describe signature syntax.</span>
<span class="line-added"> 614   // T_ADDRESS, T_METADATA, T_NARROWOOP, T_NARROWKLASS describe</span>
<span class="line-added"> 615   // internal references within the JVM as if they were Java</span>
<span class="line-added"> 616   // types in their own right.</span>
 617   T_OBJECT      = 12,
 618   T_ARRAY       = 13,
 619   T_VOID        = 14,
 620   T_ADDRESS     = 15,
 621   T_NARROWOOP   = 16,
 622   T_METADATA    = 17,
 623   T_NARROWKLASS = 18,
 624   T_CONFLICT    = 19, // for stack value type with conflicting contents
 625   T_ILLEGAL     = 99
 626 };
 627 
<span class="line-added"> 628 #define SIGNATURE_TYPES_DO(F, N)                \</span>
<span class="line-added"> 629     F(JVM_SIGNATURE_BOOLEAN, T_BOOLEAN, N)      \</span>
<span class="line-added"> 630     F(JVM_SIGNATURE_CHAR,    T_CHAR,    N)      \</span>
<span class="line-added"> 631     F(JVM_SIGNATURE_FLOAT,   T_FLOAT,   N)      \</span>
<span class="line-added"> 632     F(JVM_SIGNATURE_DOUBLE,  T_DOUBLE,  N)      \</span>
<span class="line-added"> 633     F(JVM_SIGNATURE_BYTE,    T_BYTE,    N)      \</span>
<span class="line-added"> 634     F(JVM_SIGNATURE_SHORT,   T_SHORT,   N)      \</span>
<span class="line-added"> 635     F(JVM_SIGNATURE_INT,     T_INT,     N)      \</span>
<span class="line-added"> 636     F(JVM_SIGNATURE_LONG,    T_LONG,    N)      \</span>
<span class="line-added"> 637     F(JVM_SIGNATURE_CLASS,   T_OBJECT,  N)      \</span>
<span class="line-added"> 638     F(JVM_SIGNATURE_ARRAY,   T_ARRAY,   N)      \</span>
<span class="line-added"> 639     F(JVM_SIGNATURE_VOID,    T_VOID,    N)      \</span>
<span class="line-added"> 640     /*end*/</span>
<span class="line-added"> 641 </span>
<span class="line-added"> 642 inline bool is_java_type(BasicType t) {</span>
<span class="line-added"> 643   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_VOID;</span>
<span class="line-added"> 644 }</span>
<span class="line-added"> 645 </span>
 646 inline bool is_java_primitive(BasicType t) {
 647   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_LONG;
 648 }
 649 
 650 inline bool is_subword_type(BasicType t) {
 651   // these guys are processed exactly like T_INT in calling sequences:
 652   return (t == T_BOOLEAN || t == T_CHAR || t == T_BYTE || t == T_SHORT);
 653 }
 654 
 655 inline bool is_signed_subword_type(BasicType t) {
 656   return (t == T_BYTE || t == T_SHORT);
 657 }
 658 
<span class="line-modified"> 659 inline bool is_double_word_type(BasicType t) {</span>
<span class="line-modified"> 660   return (t == T_DOUBLE || t == T_LONG);</span>
 661 }
 662 
<span class="line-modified"> 663 inline bool is_reference_type(BasicType t) {</span>
<span class="line-modified"> 664   return (t == T_OBJECT || t == T_ARRAY);</span>














 665 }
 666 
 667 extern char type2char_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 668 inline char type2char(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2char_tab[t] : 0; }
 669 extern int type2size[T_CONFLICT+1];         // Map BasicType to result stack elements
 670 extern const char* type2name_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 671 inline const char* type2name(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2name_tab[t] : NULL; }
 672 extern BasicType name2type(const char* name);
 673 
 674 // Auxiliary math routines
 675 // least common multiple
 676 extern size_t lcm(size_t a, size_t b);
 677 
 678 
 679 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 680 enum BasicTypeSize {
 681   T_BOOLEAN_size     = 1,
 682   T_CHAR_size        = 1,
 683   T_FLOAT_size       = 1,
 684   T_DOUBLE_size      = 2,
 685   T_BYTE_size        = 1,
 686   T_SHORT_size       = 1,
 687   T_INT_size         = 1,
 688   T_LONG_size        = 2,
 689   T_OBJECT_size      = 1,
 690   T_ARRAY_size       = 1,
 691   T_NARROWOOP_size   = 1,
 692   T_NARROWKLASS_size = 1,
 693   T_VOID_size        = 0
 694 };
 695 
<span class="line-added"> 696 // this works on valid parameter types but not T_VOID, T_CONFLICT, etc.</span>
<span class="line-added"> 697 inline int parameter_type_word_count(BasicType t) {</span>
<span class="line-added"> 698   if (is_double_word_type(t))  return 2;</span>
<span class="line-added"> 699   assert(is_java_primitive(t) || is_reference_type(t), &quot;no goofy types here please&quot;);</span>
<span class="line-added"> 700   assert(type2size[t] == 1, &quot;must be&quot;);</span>
<span class="line-added"> 701   return 1;</span>
<span class="line-added"> 702 }</span>
 703 
 704 // maps a BasicType to its instance field storage type:
 705 // all sub-word integral types are widened to T_INT
 706 extern BasicType type2field[T_CONFLICT+1];
 707 extern BasicType type2wfield[T_CONFLICT+1];
 708 
 709 
 710 // size in bytes
 711 enum ArrayElementSize {
 712   T_BOOLEAN_aelem_bytes     = 1,
 713   T_CHAR_aelem_bytes        = 2,
 714   T_FLOAT_aelem_bytes       = 4,
 715   T_DOUBLE_aelem_bytes      = 8,
 716   T_BYTE_aelem_bytes        = 1,
 717   T_SHORT_aelem_bytes       = 2,
 718   T_INT_aelem_bytes         = 4,
 719   T_LONG_aelem_bytes        = 8,
 720 #ifdef _LP64
 721   T_OBJECT_aelem_bytes      = 8,
 722   T_ARRAY_aelem_bytes       = 8,
</pre>
<hr />
<pre>
 964 #endif
 965 
 966 #ifdef min
 967 #undef min
 968 #endif
 969 
 970 // It is necessary to use templates here. Having normal overloaded
 971 // functions does not work because it is necessary to provide both 32-
 972 // and 64-bit overloaded functions, which does not work, and having
 973 // explicitly-typed versions of these routines (i.e., MAX2I, MAX2L)
 974 // will be even more error-prone than macros.
 975 template&lt;class T&gt; inline T MAX2(T a, T b)           { return (a &gt; b) ? a : b; }
 976 template&lt;class T&gt; inline T MIN2(T a, T b)           { return (a &lt; b) ? a : b; }
 977 template&lt;class T&gt; inline T MAX3(T a, T b, T c)      { return MAX2(MAX2(a, b), c); }
 978 template&lt;class T&gt; inline T MIN3(T a, T b, T c)      { return MIN2(MIN2(a, b), c); }
 979 template&lt;class T&gt; inline T MAX4(T a, T b, T c, T d) { return MAX2(MAX3(a, b, c), d); }
 980 template&lt;class T&gt; inline T MIN4(T a, T b, T c, T d) { return MIN2(MIN3(a, b, c), d); }
 981 
 982 template&lt;class T&gt; inline T ABS(T x)                 { return (x &gt; 0) ? x : -x; }
 983 
<span class="line-modified"> 984 // Return the given value clamped to the range [min ... max]</span>
<span class="line-modified"> 985 template&lt;typename T&gt;</span>
<span class="line-modified"> 986 inline T clamp(T value, T min, T max) {</span>
<span class="line-modified"> 987   assert(min &lt;= max, &quot;must be&quot;);</span>
<span class="line-modified"> 988   return MIN2(MAX2(value, min), max);</span>



 989 }
 990 
 991 // Returns largest i such that 2^i &lt;= x.
 992 // If x == 0, the function returns -1.
 993 inline int log2_intptr(uintptr_t x) {
 994   int i = -1;
 995   uintptr_t p = 1;
 996   while (p != 0 &amp;&amp; p &lt;= x) {
 997     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
 998     i++; p *= 2;
 999   }
1000   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
1001   // If p = 0, overflow has occurred and i = 31 or i = 63 (depending on the machine word size).
1002   return i;
1003 }
1004 
1005 //* largest i such that 2^i &lt;= x
1006 inline int log2_long(julong x) {
1007   int i = -1;
1008   julong p =  1;
</pre>
<hr />
<pre>
1024   STATIC_ASSERT(sizeof(int) &lt;= sizeof(uintptr_t));
1025   return log2_intptr((uintptr_t)x);
1026 }
1027 
1028 inline int log2_jint(jint x) {
1029   STATIC_ASSERT(sizeof(jint) &lt;= sizeof(uintptr_t));
1030   return log2_intptr((uintptr_t)x);
1031 }
1032 
1033 inline int log2_uint(uint x) {
1034   STATIC_ASSERT(sizeof(uint) &lt;= sizeof(uintptr_t));
1035   return log2_intptr((uintptr_t)x);
1036 }
1037 
1038 //  A negative value of &#39;x&#39; will return &#39;63&#39;
1039 inline int log2_jlong(jlong x) {
1040   STATIC_ASSERT(sizeof(jlong) &lt;= sizeof(julong));
1041   return log2_long((julong)x);
1042 }
1043 












1044 inline bool is_odd (intx x) { return x &amp; 1;      }
1045 inline bool is_even(intx x) { return !is_odd(x); }
1046 
1047 // abs methods which cannot overflow and so are well-defined across
1048 // the entire domain of integer types.
1049 static inline unsigned int uabs(unsigned int n) {
1050   union {
1051     unsigned int result;
1052     int value;
1053   };
1054   result = n;
1055   if (value &lt; 0) result = 0-result;
1056   return result;
1057 }
1058 static inline julong uabs(julong n) {
1059   union {
1060     julong result;
1061     jlong value;
1062   };
1063   result = n;
</pre>
<hr />
<pre>
1110 // The goal of this code to avoid undefined or implementation-defined
1111 // behavior.  The use of an lvalue to reference cast is explicitly
1112 // permitted by Lvalues and rvalues [basic.lval].  [Section 3.10 Para
1113 // 15 in C++03]
1114 #define JAVA_INTEGER_OP(OP, NAME, TYPE, UNSIGNED_TYPE)  \
1115 inline TYPE NAME (TYPE in1, TYPE in2) {                 \
1116   UNSIGNED_TYPE ures = static_cast&lt;UNSIGNED_TYPE&gt;(in1); \
1117   ures OP ## = static_cast&lt;UNSIGNED_TYPE&gt;(in2);         \
1118   return reinterpret_cast&lt;TYPE&amp;&gt;(ures);                 \
1119 }
1120 
1121 JAVA_INTEGER_OP(+, java_add, jint, juint)
1122 JAVA_INTEGER_OP(-, java_subtract, jint, juint)
1123 JAVA_INTEGER_OP(*, java_multiply, jint, juint)
1124 JAVA_INTEGER_OP(+, java_add, jlong, julong)
1125 JAVA_INTEGER_OP(-, java_subtract, jlong, julong)
1126 JAVA_INTEGER_OP(*, java_multiply, jlong, julong)
1127 
1128 #undef JAVA_INTEGER_OP
1129 
<span class="line-added">1130 // Provide integer shift operations with Java semantics.  No overflow</span>
<span class="line-added">1131 // issues - left shifts simply discard shifted out bits.  No undefined</span>
<span class="line-added">1132 // behavior for large or negative shift quantities; instead the actual</span>
<span class="line-added">1133 // shift distance is the argument modulo the lhs value&#39;s size in bits.</span>
<span class="line-added">1134 // No undefined or implementation defined behavior for shifting negative</span>
<span class="line-added">1135 // values; left shift discards bits, right shift sign extends.  We use</span>
<span class="line-added">1136 // the same safe conversion technique as above for java_add and friends.</span>
<span class="line-added">1137 #define JAVA_INTEGER_SHIFT_OP(OP, NAME, TYPE, XTYPE)    \</span>
<span class="line-added">1138 inline TYPE NAME (TYPE lhs, jint rhs) {                 \</span>
<span class="line-added">1139   const uint rhs_mask = (sizeof(TYPE) * 8) - 1;         \</span>
<span class="line-added">1140   STATIC_ASSERT(rhs_mask == 31 || rhs_mask == 63);      \</span>
<span class="line-added">1141   XTYPE xres = static_cast&lt;XTYPE&gt;(lhs);                 \</span>
<span class="line-added">1142   xres OP ## = (rhs &amp; rhs_mask);                        \</span>
<span class="line-added">1143   return reinterpret_cast&lt;TYPE&amp;&gt;(xres);                 \</span>
<span class="line-added">1144 }</span>
<span class="line-added">1145 </span>
<span class="line-added">1146 JAVA_INTEGER_SHIFT_OP(&lt;&lt;, java_shift_left, jint, juint)</span>
<span class="line-added">1147 JAVA_INTEGER_SHIFT_OP(&lt;&lt;, java_shift_left, jlong, julong)</span>
<span class="line-added">1148 // For signed shift right, assume C++ implementation &gt;&gt; sign extends.</span>
<span class="line-added">1149 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right, jint, jint)</span>
<span class="line-added">1150 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right, jlong, jlong)</span>
<span class="line-added">1151 // For &gt;&gt;&gt; use C++ unsigned &gt;&gt;.</span>
<span class="line-added">1152 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right_unsigned, jint, juint)</span>
<span class="line-added">1153 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right_unsigned, jlong, julong)</span>
<span class="line-added">1154 </span>
<span class="line-added">1155 #undef JAVA_INTEGER_SHIFT_OP</span>
<span class="line-added">1156 </span>
<span class="line-added">1157 //----------------------------------------------------------------------------------------------------</span>
<span class="line-added">1158 // The goal of this code is to provide saturating operations for int/uint.</span>
<span class="line-added">1159 // Checks overflow conditions and saturates the result to min_jint/max_jint.</span>
<span class="line-added">1160 #define SATURATED_INTEGER_OP(OP, NAME, TYPE1, TYPE2) \</span>
<span class="line-added">1161 inline int NAME (TYPE1 in1, TYPE2 in2) {             \</span>
<span class="line-added">1162   jlong res = static_cast&lt;jlong&gt;(in1);               \</span>
<span class="line-added">1163   res OP ## = static_cast&lt;jlong&gt;(in2);               \</span>
<span class="line-added">1164   if (res &gt; max_jint) {                              \</span>
<span class="line-added">1165     res = max_jint;                                  \</span>
<span class="line-added">1166   } else if (res &lt; min_jint) {                       \</span>
<span class="line-added">1167     res = min_jint;                                  \</span>
<span class="line-added">1168   }                                                  \</span>
<span class="line-added">1169   return static_cast&lt;int&gt;(res);                      \</span>
<span class="line-added">1170 }</span>
<span class="line-added">1171 </span>
<span class="line-added">1172 SATURATED_INTEGER_OP(+, saturated_add, int, int)</span>
<span class="line-added">1173 SATURATED_INTEGER_OP(+, saturated_add, int, uint)</span>
<span class="line-added">1174 SATURATED_INTEGER_OP(+, saturated_add, uint, int)</span>
<span class="line-added">1175 SATURATED_INTEGER_OP(+, saturated_add, uint, uint)</span>
<span class="line-added">1176 </span>
<span class="line-added">1177 #undef SATURATED_INTEGER_OP</span>
<span class="line-added">1178 </span>
1179 // Dereference vptr
1180 // All C++ compilers that we know of have the vtbl pointer in the first
1181 // word.  If there are exceptions, this function needs to be made compiler
1182 // specific.
1183 static inline void* dereference_vptr(const void* addr) {
1184   return *(void**)addr;
1185 }
1186 
1187 //----------------------------------------------------------------------------------------------------
1188 // String type aliases used by command line flag declarations and
1189 // processing utilities.
1190 
1191 typedef const char* ccstr;
1192 typedef const char* ccstrlist;   // represents string arguments which accumulate
1193 
1194 //----------------------------------------------------------------------------------------------------
1195 // Default hash/equals functions used by ResourceHashtable and KVHashtable
1196 
1197 template&lt;typename K&gt; unsigned primitive_hash(const K&amp; k) {
1198   unsigned hash = (unsigned)((uintptr_t)k);
</pre>
</td>
</tr>
</table>
<center><a href="globalDefinitions.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="globalDefinitions_gcc.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>