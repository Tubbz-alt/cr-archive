<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shared/weakProcessorPhaseTimes.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="weakProcessor.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="weakProcessorPhaseTimes.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/weakProcessorPhaseTimes.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,30 ***</span>
   * questions.
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/shared/weakProcessorPhases.hpp&quot;
  #include &quot;gc/shared/weakProcessorPhaseTimes.hpp&quot;
  #include &quot;gc/shared/workerDataArray.inline.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
  
<span class="line-modified">! static uint phase_index(WeakProcessorPhase phase) {</span>
<span class="line-modified">!   return WeakProcessorPhases::index(phase);</span>
  }
  
  static bool is_serial_phase(WeakProcessorPhase phase) {
    return WeakProcessorPhases::is_serial(phase);
  }
  
<span class="line-modified">! static void assert_oop_storage_phase(WeakProcessorPhase phase) {</span>
<span class="line-modified">!   assert(WeakProcessorPhases::is_oop_storage(phase),</span>
<span class="line-modified">!          &quot;Not an oop_storage phase %u&quot;, phase_index(phase));</span>
  }
  
  const double uninitialized_time = -1.0;
  
  #ifdef ASSERT
<span class="line-new-header">--- 21,36 ---</span>
   * questions.
   *
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="line-added">+ #include &quot;gc/shared/oopStorage.hpp&quot;</span>
  #include &quot;gc/shared/weakProcessorPhases.hpp&quot;
  #include &quot;gc/shared/weakProcessorPhaseTimes.hpp&quot;
  #include &quot;gc/shared/workerDataArray.inline.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
  
<span class="line-modified">! static uint serial_phase_index(WeakProcessorPhase phase) {</span>
<span class="line-modified">!   return WeakProcessorPhases::serial_index(phase);</span>
  }
  
  static bool is_serial_phase(WeakProcessorPhase phase) {
    return WeakProcessorPhases::is_serial(phase);
  }
  
<span class="line-modified">! static void assert_serial_phase(WeakProcessorPhase phase) {</span>
<span class="line-modified">!   assert(is_serial_phase(phase),</span>
<span class="line-modified">!          &quot;Not a serial phase %u&quot;, static_cast&lt;uint&gt;(phase));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void assert_oopstorage_phase(WeakProcessorPhase phase) {</span>
<span class="line-added">+   assert(WeakProcessorPhases::is_oopstorage(phase),</span>
<span class="line-added">+          &quot;Not an oopstorage phase %u&quot;, static_cast&lt;uint&gt;(phase));</span>
  }
  
  const double uninitialized_time = -1.0;
  
  #ifdef ASSERT
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,41 ***</span>
    for (size_t i = 0; i &lt; nitems; ++i) {
      items[i] = 0;
    }
  }
  
  WeakProcessorPhaseTimes::WeakProcessorPhaseTimes(uint max_threads) :
    _max_threads(max_threads),
    _active_workers(0),
    _total_time_sec(uninitialized_time),
<span class="line-modified">!   _worker_data(),</span>
<span class="line-removed">-   _worker_dead_items(),</span>
<span class="line-removed">-   _worker_total_items()</span>
  {
    assert(_max_threads &gt; 0, &quot;max_threads must not be zero&quot;);
  
<span class="line-modified">!   reset_times(_phase_times_sec, ARRAY_SIZE(_phase_times_sec));</span>
<span class="line-modified">!   reset_items(_phase_dead_items, ARRAY_SIZE(_phase_dead_items));</span>
<span class="line-modified">!   reset_items(_phase_total_items, ARRAY_SIZE(_phase_total_items));</span>
<span class="line-modified">! </span>
<span class="line-modified">!   if (_max_threads &gt; 1) {</span>
<span class="line-modified">!     WorkerDataArray&lt;double&gt;** wpt = _worker_data;</span>
<span class="line-modified">!     FOR_EACH_WEAK_PROCESSOR_OOP_STORAGE_PHASE(phase) {</span>
<span class="line-modified">!       const char* description = WeakProcessorPhases::description(phase);</span>
<span class="line-modified">!       *wpt = new WorkerDataArray&lt;double&gt;(_max_threads, description);</span>
<span class="line-modified">!       (*wpt)-&gt;link_thread_work_items(new WorkerDataArray&lt;size_t&gt;(_max_threads, &quot;Dead&quot;), DeadItems);</span>
<span class="line-modified">!       (*wpt)-&gt;link_thread_work_items(new WorkerDataArray&lt;size_t&gt;(_max_threads, &quot;Total&quot;), TotalItems);</span>
<span class="line-removed">-       wpt++;</span>
<span class="line-removed">-     }</span>
    }
  }
  
  WeakProcessorPhaseTimes::~WeakProcessorPhaseTimes() {
    for (size_t i = 0; i &lt; ARRAY_SIZE(_worker_data); ++i) {
      delete _worker_data[i];
<span class="line-removed">-     delete _worker_dead_items[i];</span>
<span class="line-removed">-     delete _worker_total_items[i];</span>
    }
  }
  
  uint WeakProcessorPhaseTimes::max_threads() const { return _max_threads; }
  
<span class="line-new-header">--- 68,42 ---</span>
    for (size_t i = 0; i &lt; nitems; ++i) {
      items[i] = 0;
    }
  }
  
<span class="line-added">+ void WeakProcessorPhaseTimes::reset_phase_data() {</span>
<span class="line-added">+   reset_times(_phase_times_sec, ARRAY_SIZE(_phase_times_sec));</span>
<span class="line-added">+   reset_items(_phase_dead_items, ARRAY_SIZE(_phase_dead_items));</span>
<span class="line-added">+   reset_items(_phase_total_items, ARRAY_SIZE(_phase_total_items));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  WeakProcessorPhaseTimes::WeakProcessorPhaseTimes(uint max_threads) :
    _max_threads(max_threads),
    _active_workers(0),
    _total_time_sec(uninitialized_time),
<span class="line-modified">!   _worker_data()</span>
  {
    assert(_max_threads &gt; 0, &quot;max_threads must not be zero&quot;);
  
<span class="line-modified">!   reset_phase_data();</span>
<span class="line-modified">! </span>
<span class="line-modified">!   WorkerDataArray&lt;double&gt;** wpt = _worker_data;</span>
<span class="line-modified">!   OopStorageSet::Iterator it = OopStorageSet::weak_iterator();</span>
<span class="line-modified">!   for ( ; !it.is_end(); ++it) {</span>
<span class="line-modified">!     assert(size_t(wpt - _worker_data) &lt; ARRAY_SIZE(_worker_data), &quot;invariant&quot;);</span>
<span class="line-modified">!     const char* description = it-&gt;name();</span>
<span class="line-modified">!     *wpt = new WorkerDataArray&lt;double&gt;(description, _max_threads);</span>
<span class="line-modified">!     (*wpt)-&gt;create_thread_work_items(&quot;Dead&quot;, DeadItems);</span>
<span class="line-modified">!     (*wpt)-&gt;create_thread_work_items(&quot;Total&quot;, TotalItems);</span>
<span class="line-modified">!     wpt++;</span>
    }
<span class="line-added">+   assert(size_t(wpt - _worker_data) == ARRAY_SIZE(_worker_data), &quot;invariant&quot;);</span>
  }
  
  WeakProcessorPhaseTimes::~WeakProcessorPhaseTimes() {
    for (size_t i = 0; i &lt; ARRAY_SIZE(_worker_data); ++i) {
      delete _worker_data[i];
    }
  }
  
  uint WeakProcessorPhaseTimes::max_threads() const { return _max_threads; }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 113,17 ***</span>
  }
  
  void WeakProcessorPhaseTimes::reset() {
    _active_workers = 0;
    _total_time_sec = uninitialized_time;
<span class="line-modified">!   reset_times(_phase_times_sec, ARRAY_SIZE(_phase_times_sec));</span>
<span class="line-modified">!   reset_items(_phase_dead_items, ARRAY_SIZE(_phase_dead_items));</span>
<span class="line-modified">!   reset_items(_phase_total_items, ARRAY_SIZE(_phase_total_items));</span>
<span class="line-removed">-   if (_max_threads &gt; 1) {</span>
<span class="line-removed">-     for (size_t i = 0; i &lt; ARRAY_SIZE(_worker_data); ++i) {</span>
<span class="line-removed">-       _worker_data[i]-&gt;reset();</span>
<span class="line-removed">-     }</span>
    }
  }
  
  double WeakProcessorPhaseTimes::total_time_sec() const {
    assert(is_initialized_time(_total_time_sec), &quot;Total time not set&quot;);
<span class="line-new-header">--- 120,13 ---</span>
  }
  
  void WeakProcessorPhaseTimes::reset() {
    _active_workers = 0;
    _total_time_sec = uninitialized_time;
<span class="line-modified">!   reset_phase_data();</span>
<span class="line-modified">!   for (size_t i = 0; i &lt; ARRAY_SIZE(_worker_data); ++i) {</span>
<span class="line-modified">!     _worker_data[i]-&gt;reset();</span>
    }
  }
  
  double WeakProcessorPhaseTimes::total_time_sec() const {
    assert(is_initialized_time(_total_time_sec), &quot;Total time not set&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 134,67 ***</span>
    assert(!is_initialized_time(_total_time_sec), &quot;Already set total time&quot;);
    _total_time_sec = time_sec;
  }
  
  double WeakProcessorPhaseTimes::phase_time_sec(WeakProcessorPhase phase) const {
<span class="line-modified">!   assert(is_initialized_time(_phase_times_sec[phase_index(phase)]),</span>
<span class="line-modified">!          &quot;phase time not set %u&quot;, phase_index(phase));</span>
<span class="line-modified">!   return _phase_times_sec[phase_index(phase)];</span>
  }
  
  void WeakProcessorPhaseTimes::record_phase_time_sec(WeakProcessorPhase phase, double time_sec) {
<span class="line-modified">!   assert(!is_initialized_time(_phase_times_sec[phase_index(phase)]),</span>
<span class="line-modified">!          &quot;Already set time for phase %u&quot;, phase_index(phase));</span>
<span class="line-modified">!   _phase_times_sec[phase_index(phase)] = time_sec;</span>
  }
  
  void WeakProcessorPhaseTimes::record_phase_items(WeakProcessorPhase phase, size_t num_dead, size_t num_total) {
<span class="line-modified">!   uint p = phase_index(phase);</span>
    assert(!is_initialized_items(_phase_dead_items[p]),
           &quot;Already set dead items for phase %u&quot;, p);
    assert(!is_initialized_items(_phase_total_items[p]),
           &quot;Already set total items for phase %u&quot;, p);
    _phase_dead_items[p] = num_dead;
    _phase_total_items[p] = num_total;
  }
  
  WorkerDataArray&lt;double&gt;* WeakProcessorPhaseTimes::worker_data(WeakProcessorPhase phase) const {
<span class="line-modified">!   assert_oop_storage_phase(phase);</span>
<span class="line-modified">!   assert(active_workers() &gt; 1, &quot;No worker data when single-threaded&quot;);</span>
<span class="line-removed">-   return _worker_data[WeakProcessorPhases::oop_storage_index(phase)];</span>
  }
  
  double WeakProcessorPhaseTimes::worker_time_sec(uint worker_id, WeakProcessorPhase phase) const {
    assert(worker_id &lt; active_workers(),
           &quot;invalid worker id %u for %u&quot;, worker_id, active_workers());
<span class="line-modified">!   if (active_workers() == 1) {</span>
<span class="line-removed">-     return phase_time_sec(phase);</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     return worker_data(phase)-&gt;get(worker_id);</span>
<span class="line-removed">-   }</span>
  }
  
  void WeakProcessorPhaseTimes::record_worker_time_sec(uint worker_id,
                                                       WeakProcessorPhase phase,
                                                       double time_sec) {
<span class="line-modified">!   if (active_workers() == 1) {</span>
<span class="line-removed">-     record_phase_time_sec(phase, time_sec);</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     worker_data(phase)-&gt;set(worker_id, time_sec);</span>
<span class="line-removed">-   }</span>
  }
  
  void WeakProcessorPhaseTimes::record_worker_items(uint worker_id,
                                                    WeakProcessorPhase phase,
                                                    size_t num_dead,
                                                    size_t num_total) {
<span class="line-modified">!   if (active_workers() == 1) {</span>
<span class="line-modified">!     record_phase_items(phase, num_dead, num_total);</span>
<span class="line-modified">!   } else {</span>
<span class="line-removed">-     worker_data(phase)-&gt;set_or_add_thread_work_item(worker_id, num_dead, DeadItems);</span>
<span class="line-removed">-     worker_data(phase)-&gt;set_or_add_thread_work_item(worker_id, num_total, TotalItems);</span>
<span class="line-removed">-   }</span>
  }
  
  static double elapsed_time_sec(Ticks start_time, Ticks end_time) {
    return (end_time - start_time).seconds();
  }
<span class="line-new-header">--- 137,58 ---</span>
    assert(!is_initialized_time(_total_time_sec), &quot;Already set total time&quot;);
    _total_time_sec = time_sec;
  }
  
  double WeakProcessorPhaseTimes::phase_time_sec(WeakProcessorPhase phase) const {
<span class="line-modified">!   assert_serial_phase(phase);</span>
<span class="line-modified">!   assert(is_initialized_time(_phase_times_sec[serial_phase_index(phase)]),</span>
<span class="line-modified">!          &quot;phase time not set %u&quot;, serial_phase_index(phase));</span>
<span class="line-added">+   return _phase_times_sec[serial_phase_index(phase)];</span>
  }
  
  void WeakProcessorPhaseTimes::record_phase_time_sec(WeakProcessorPhase phase, double time_sec) {
<span class="line-modified">!   assert_serial_phase(phase);</span>
<span class="line-modified">!   assert(!is_initialized_time(_phase_times_sec[serial_phase_index(phase)]),</span>
<span class="line-modified">!          &quot;Already set time for phase %u&quot;, serial_phase_index(phase));</span>
<span class="line-added">+   _phase_times_sec[serial_phase_index(phase)] = time_sec;</span>
  }
  
  void WeakProcessorPhaseTimes::record_phase_items(WeakProcessorPhase phase, size_t num_dead, size_t num_total) {
<span class="line-modified">!   assert_serial_phase(phase);</span>
<span class="line-added">+   uint p = serial_phase_index(phase);</span>
    assert(!is_initialized_items(_phase_dead_items[p]),
           &quot;Already set dead items for phase %u&quot;, p);
    assert(!is_initialized_items(_phase_total_items[p]),
           &quot;Already set total items for phase %u&quot;, p);
    _phase_dead_items[p] = num_dead;
    _phase_total_items[p] = num_total;
  }
  
  WorkerDataArray&lt;double&gt;* WeakProcessorPhaseTimes::worker_data(WeakProcessorPhase phase) const {
<span class="line-modified">!   assert_oopstorage_phase(phase);</span>
<span class="line-modified">!   return _worker_data[WeakProcessorPhases::oopstorage_index(phase)];</span>
  }
  
  double WeakProcessorPhaseTimes::worker_time_sec(uint worker_id, WeakProcessorPhase phase) const {
    assert(worker_id &lt; active_workers(),
           &quot;invalid worker id %u for %u&quot;, worker_id, active_workers());
<span class="line-modified">!   return worker_data(phase)-&gt;get(worker_id);</span>
  }
  
  void WeakProcessorPhaseTimes::record_worker_time_sec(uint worker_id,
                                                       WeakProcessorPhase phase,
                                                       double time_sec) {
<span class="line-modified">!   worker_data(phase)-&gt;set(worker_id, time_sec);</span>
  }
  
  void WeakProcessorPhaseTimes::record_worker_items(uint worker_id,
                                                    WeakProcessorPhase phase,
                                                    size_t num_dead,
                                                    size_t num_total) {
<span class="line-modified">!   WorkerDataArray&lt;double&gt;* phase_data = worker_data(phase);</span>
<span class="line-modified">!   phase_data-&gt;set_or_add_thread_work_item(worker_id, num_dead, DeadItems);</span>
<span class="line-modified">!   phase_data-&gt;set_or_add_thread_work_item(worker_id, num_total, TotalItems);</span>
  }
  
  static double elapsed_time_sec(Ticks start_time, Ticks end_time) {
    return (end_time - start_time).seconds();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 217,11 ***</span>
    _times(times),
    _phase(phase),
    _worker_id(worker_id),
    _start_time(Ticks::now())
  {
<span class="line-modified">!   assert_oop_storage_phase(_phase);</span>
    assert(_times == NULL || worker_id &lt; _times-&gt;active_workers(),
           &quot;Invalid worker_id %u&quot;, worker_id);
  }
  
  WeakProcessorPhaseTimeTracker::WeakProcessorPhaseTimeTracker(WeakProcessorPhaseTimes* times,
<span class="line-new-header">--- 211,11 ---</span>
    _times(times),
    _phase(phase),
    _worker_id(worker_id),
    _start_time(Ticks::now())
  {
<span class="line-modified">!   assert_oopstorage_phase(_phase);</span>
    assert(_times == NULL || worker_id &lt; _times-&gt;active_workers(),
           &quot;Invalid worker_id %u&quot;, worker_id);
  }
  
  WeakProcessorPhaseTimeTracker::WeakProcessorPhaseTimeTracker(WeakProcessorPhaseTimes* times,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 229,11 ***</span>
    _times(times),
    _phase(phase),
    _worker_id(0),
    _start_time(Ticks::now())
  {
<span class="line-modified">!   assert(is_serial_phase(phase), &quot;Not a serial phase %u&quot;, phase_index(phase));</span>
  }
  
  WeakProcessorPhaseTimeTracker::~WeakProcessorPhaseTimeTracker() {
    if (_times != NULL) {
      double time_sec = elapsed_time_sec(_start_time, Ticks::now());
<span class="line-new-header">--- 223,11 ---</span>
    _times(times),
    _phase(phase),
    _worker_id(0),
    _start_time(Ticks::now())
  {
<span class="line-modified">!   assert_serial_phase(phase);</span>
  }
  
  WeakProcessorPhaseTimeTracker::~WeakProcessorPhaseTimeTracker() {
    if (_times != NULL) {
      double time_sec = elapsed_time_sec(_start_time, Ticks::now());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,24 ***</span>
  
  #define TIME_FORMAT &quot;%.1lfms&quot;
  
  void WeakProcessorPhaseTimes::log_st_phase(WeakProcessorPhase phase,
                                             uint indent) const {
    log_debug(gc, phases)(&quot;%s%s: &quot; TIME_FORMAT,
                          indent_str(indent),
                          WeakProcessorPhases::description(phase),
                          phase_time_sec(phase) * MILLIUNITS);
  
    log_debug(gc, phases)(&quot;%s%s: &quot; SIZE_FORMAT,
                          indent_str(indent + 1),
                          &quot;Dead&quot;,
<span class="line-modified">!                         _phase_dead_items[phase_index(phase)]);</span>
  
    log_debug(gc, phases)(&quot;%s%s: &quot; SIZE_FORMAT,
                          indent_str(indent + 1),
                          &quot;Total&quot;,
<span class="line-modified">!                         _phase_total_items[phase_index(phase)]);</span>
  }
  
  void WeakProcessorPhaseTimes::log_mt_phase_summary(WeakProcessorPhase phase,
                                                     uint indent) const {
    LogTarget(Debug, gc, phases) lt;
<span class="line-new-header">--- 251,25 ---</span>
  
  #define TIME_FORMAT &quot;%.1lfms&quot;
  
  void WeakProcessorPhaseTimes::log_st_phase(WeakProcessorPhase phase,
                                             uint indent) const {
<span class="line-added">+   assert_serial_phase(phase);</span>
    log_debug(gc, phases)(&quot;%s%s: &quot; TIME_FORMAT,
                          indent_str(indent),
                          WeakProcessorPhases::description(phase),
                          phase_time_sec(phase) * MILLIUNITS);
  
    log_debug(gc, phases)(&quot;%s%s: &quot; SIZE_FORMAT,
                          indent_str(indent + 1),
                          &quot;Dead&quot;,
<span class="line-modified">!                         _phase_dead_items[serial_phase_index(phase)]);</span>
  
    log_debug(gc, phases)(&quot;%s%s: &quot; SIZE_FORMAT,
                          indent_str(indent + 1),
                          &quot;Total&quot;,
<span class="line-modified">!                         _phase_total_items[serial_phase_index(phase)]);</span>
  }
  
  void WeakProcessorPhaseTimes::log_mt_phase_summary(WeakProcessorPhase phase,
                                                     uint indent) const {
    LogTarget(Debug, gc, phases) lt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 304,16 ***</span>
    }
  }
  
  void WeakProcessorPhaseTimes::log_print_phases(uint indent) const {
    if (log_is_enabled(Debug, gc, phases)) {
<span class="line-modified">!     FOR_EACH_WEAK_PROCESSOR_PHASE(phase) {</span>
<span class="line-modified">!       if (is_serial_phase(phase) || (active_workers() == 1)) {</span>
<span class="line-modified">!         log_st_phase(phase, indent);</span>
<span class="line-modified">!       } else {</span>
<span class="line-modified">!         log_mt_phase_summary(phase, indent);</span>
<span class="line-modified">!       }</span>
      }
    }
  }
  
  void WeakProcessorPhaseTimes::log_print(uint indent) const {
<span class="line-new-header">--- 299,16 ---</span>
    }
  }
  
  void WeakProcessorPhaseTimes::log_print_phases(uint indent) const {
    if (log_is_enabled(Debug, gc, phases)) {
<span class="line-modified">!     typedef WeakProcessorPhases::Iterator Iterator;</span>
<span class="line-modified">!     for (Iterator it = WeakProcessorPhases::serial_iterator(); !it.is_end(); ++it) {</span>
<span class="line-modified">!       log_st_phase(*it, indent);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     for (Iterator it = WeakProcessorPhases::oopstorage_iterator(); !it.is_end(); ++it) {</span>
<span class="line-modified">!       log_mt_phase_summary(*it, indent);</span>
      }
    }
  }
  
  void WeakProcessorPhaseTimes::log_print(uint indent) const {
</pre>
<center><a href="weakProcessor.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="weakProcessorPhaseTimes.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>