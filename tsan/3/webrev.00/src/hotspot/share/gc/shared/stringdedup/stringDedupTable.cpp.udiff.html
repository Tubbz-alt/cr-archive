<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shared/stringdedup/stringDedupTable.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="stringDedupQueue.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="stringDedupTable.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/stringdedup/stringDedupTable.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,16 +28,19 @@</span>
  #include &quot;gc/shared/stringdedup/stringDedup.hpp&quot;
  #include &quot;gc/shared/stringdedup/stringDedupTable.hpp&quot;
  #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/padded.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/arrayOop.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;oops/typeArrayOop.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;runtime/mutexLocker.hpp&quot;
  #include &quot;runtime/safepointVerifiers.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/powerOfTwo.hpp&quot;</span>
  
  //
  // List of deduplication table entries. Links table
  // entries together using their _next fields.
  //
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -211,11 +214,11 @@</span>
  const double             StringDedupTable::_max_cache_factor = 0.1; // Cache a maximum of 10% of the table size
  const uintx              StringDedupTable::_rehash_multiple = 60;   // Hash bucket has 60 times more collisions than expected
  const uintx              StringDedupTable::_rehash_threshold = (uintx)(_rehash_multiple * _grow_load_factor);
  
  uintx                    StringDedupTable::_entries_added = 0;
<span class="udiff-line-modified-removed">- uintx                    StringDedupTable::_entries_removed = 0;</span>
<span class="udiff-line-modified-added">+ volatile uintx           StringDedupTable::_entries_removed = 0;</span>
  uintx                    StringDedupTable::_resize_count = 0;
  uintx                    StringDedupTable::_rehash_count = 0;
  
  StringDedupTable*        StringDedupTable::_resized_table = NULL;
  StringDedupTable*        StringDedupTable::_rehashed_table = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -232,11 +235,11 @@</span>
    _buckets = NEW_C_HEAP_ARRAY(StringDedupEntry*, _size, mtGC);
    memset(_buckets, 0, _size * sizeof(StringDedupEntry*));
  }
  
  StringDedupTable::~StringDedupTable() {
<span class="udiff-line-modified-removed">-   FREE_C_HEAP_ARRAY(G1StringDedupEntry*, _buckets);</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(StringDedupEntry*, _buckets);</span>
  }
  
  void StringDedupTable::create() {
    assert(_table == NULL, &quot;One string deduplication table allowed&quot;);
    _entry_cache = new StringDedupEntryCache(_min_size * _max_cache_factor);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,27 +352,22 @@</span>
  
    bool latin1 = java_lang_String::is_latin1(java_string);
    unsigned int hash = 0;
  
    if (use_java_hash()) {
<span class="udiff-line-modified-removed">-     // Get hash code from cache</span>
<span class="udiff-line-modified-removed">-     hash = java_lang_String::hash(java_string);</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   if (hash == 0) {</span>
<span class="udiff-line-modified-added">+     if (!java_lang_String::hash_is_set(java_string)) {</span>
<span class="udiff-line-modified-added">+       stat-&gt;inc_hashed();</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+     hash = java_lang_String::hash_code(java_string);</span>
<span class="udiff-line-modified-added">+   } else {</span>
      // Compute hash
      hash = hash_code(value, latin1);
      stat-&gt;inc_hashed();
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (use_java_hash() &amp;&amp; hash != 0) {</span>
<span class="udiff-line-removed">-       // Store hash code in cache</span>
<span class="udiff-line-removed">-       java_lang_String::set_hash(java_string, hash);</span>
<span class="udiff-line-removed">-     }</span>
    }
  
    typeArrayOop existing_value = lookup_or_add(value, latin1, hash);
<span class="udiff-line-modified-removed">-   if (oopDesc::equals_raw(existing_value, value)) {</span>
<span class="udiff-line-modified-added">+   if (existing_value == value) {</span>
      // Same value, already known
      stat-&gt;inc_known();
      return;
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -478,15 +476,17 @@</span>
      // Scan the partition followed by the sibling partition in the second half of the table
      removed += unlink_or_oops_do(cl, partition_begin, partition_end, worker_id);
      removed += unlink_or_oops_do(cl, table_half + partition_begin, table_half + partition_end, worker_id);
    }
  
<span class="udiff-line-modified-removed">-   // Delayed update to avoid contention on the table lock</span>
<span class="udiff-line-modified-added">+   // Do atomic update here instead of taking StringDedupTable_lock. This allows concurrent</span>
<span class="udiff-line-added">+   // cleanup when multiple workers are cleaning up the table, while the mutators are blocked</span>
<span class="udiff-line-added">+   // on StringDedupTable_lock.</span>
    if (removed &gt; 0) {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(StringDedupTable_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-removed">-     _table-&gt;_entries -= removed;</span>
<span class="udiff-line-modified-removed">-     _entries_removed += removed;</span>
<span class="udiff-line-modified-added">+     assert_locked_or_safepoint_weak(StringDedupTable_lock);</span>
<span class="udiff-line-modified-added">+     Atomic::sub(&amp;_table-&gt;_entries, removed);</span>
<span class="udiff-line-modified-added">+     Atomic::add(&amp;_entries_removed, removed);</span>
    }
  }
  
  uintx StringDedupTable::unlink_or_oops_do(StringDedupUnlinkOrOopsDoClosure* cl,
                                            size_t partition_begin,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -591,21 +591,21 @@</span>
    // Install new table
    _table = rehashed_table;
  }
  
  size_t StringDedupTable::claim_table_partition(size_t partition_size) {
<span class="udiff-line-modified-removed">-   return Atomic::add(partition_size, &amp;_claimed_index) - partition_size;</span>
<span class="udiff-line-modified-added">+   return Atomic::fetch_and_add(&amp;_claimed_index, partition_size);</span>
  }
  
  void StringDedupTable::verify() {
    for (size_t bucket = 0; bucket &lt; _table-&gt;_size; bucket++) {
      // Verify entries
      StringDedupEntry** entry = _table-&gt;bucket(bucket);
      while (*entry != NULL) {
        typeArrayOop value = (*entry)-&gt;obj();
        guarantee(value != NULL, &quot;Object must not be NULL&quot;);
<span class="udiff-line-modified-removed">-       guarantee(Universe::heap()-&gt;is_in_reserved(value), &quot;Object must be on the heap&quot;);</span>
<span class="udiff-line-modified-added">+       guarantee(Universe::heap()-&gt;is_in(value), &quot;Object must be on the heap&quot;);</span>
        guarantee(!value-&gt;is_forwarded(), &quot;Object must not be forwarded&quot;);
        guarantee(value-&gt;is_typeArray(), &quot;Object must be a typeArrayOop&quot;);
        bool latin1 = (*entry)-&gt;latin1();
        unsigned int hash = hash_code(value, latin1);
        guarantee((*entry)-&gt;hash() == hash, &quot;Table entry has inorrect hash&quot;);
</pre>
<center><a href="stringDedupQueue.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="stringDedupTable.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>