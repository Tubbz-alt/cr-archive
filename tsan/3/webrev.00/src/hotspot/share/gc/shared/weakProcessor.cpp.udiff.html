<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shared/weakProcessor.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="vmStructs_gc.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="weakProcessor.inline.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/weakProcessor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,34 +24,48 @@</span>
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
  #include &quot;gc/shared/oopStorage.inline.hpp&quot;
  #include &quot;gc/shared/oopStorageParState.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;gc/shared/oopStorageSet.hpp&quot;</span>
  #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  #include &quot;gc/shared/weakProcessorPhases.hpp&quot;
  #include &quot;gc/shared/weakProcessorPhaseTimes.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
<span class="udiff-line-added">+ #include &quot;prims/resolvedMethodTable.hpp&quot;</span>
  #include &quot;runtime/globals.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  
<span class="udiff-line-modified-removed">- void WeakProcessor::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive) {</span>
<span class="udiff-line-modified-removed">-   FOR_EACH_WEAK_PROCESSOR_PHASE(phase) {</span>
<span class="udiff-line-modified-removed">-     if (WeakProcessorPhases::is_serial(phase)) {</span>
<span class="udiff-line-modified-removed">-       WeakProcessorPhases::processor(phase)(is_alive, keep_alive);</span>
<span class="udiff-line-modified-removed">-     } else {</span>
<span class="udiff-line-modified-removed">-       if (WeakProcessorPhases::is_stringtable(phase)) {</span>
<span class="udiff-line-modified-removed">-         StringTable::reset_dead_counter();</span>
<span class="udiff-line-modified-added">+ template &lt;typename Container&gt;</span>
<span class="udiff-line-modified-added">+ class OopsDoAndReportCounts {</span>
<span class="udiff-line-modified-added">+ public:</span>
<span class="udiff-line-modified-added">+   void operator()(BoolObjectClosure* is_alive, OopClosure* keep_alive, OopStorage* storage) {</span>
<span class="udiff-line-modified-added">+     Container::reset_dead_counter();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     CountingSkippedIsAliveClosure&lt;BoolObjectClosure, OopClosure&gt; cl(is_alive, keep_alive);</span>
<span class="udiff-line-added">+     storage-&gt;oops_do(&amp;cl);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Container::inc_dead_counter(cl.num_dead() + cl.num_skipped());</span>
<span class="udiff-line-added">+     Container::finish_dead_counter();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ };</span>
  
<span class="udiff-line-modified-removed">-         CountingSkippedIsAliveClosure&lt;BoolObjectClosure, OopClosure&gt; cl(is_alive, keep_alive);</span>
<span class="udiff-line-modified-removed">-         WeakProcessorPhases::oop_storage(phase)-&gt;oops_do(&amp;cl);</span>
<span class="udiff-line-modified-added">+ void WeakProcessor::weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive) {</span>
<span class="udiff-line-modified-added">+   WeakProcessorPhases::Iterator pit = WeakProcessorPhases::serial_iterator();</span>
<span class="udiff-line-added">+   for ( ; !pit.is_end(); ++pit) {</span>
<span class="udiff-line-added">+     WeakProcessorPhases::processor(*pit)(is_alive, keep_alive);</span>
<span class="udiff-line-added">+   }</span>
  
<span class="udiff-line-modified-removed">-         StringTable::inc_dead_counter(cl.num_dead() + cl.num_skipped());</span>
<span class="udiff-line-modified-removed">-         StringTable::finish_dead_counter();</span>
<span class="udiff-line-modified-removed">-       } else {</span>
<span class="udiff-line-modified-removed">-         WeakProcessorPhases::oop_storage(phase)-&gt;weak_oops_do(is_alive, keep_alive);</span>
<span class="udiff-line-modified-removed">-       }</span>
<span class="udiff-line-modified-added">+   OopStorageSet::Iterator it = OopStorageSet::weak_iterator();</span>
<span class="udiff-line-modified-added">+   for ( ; !it.is_end(); ++it) {</span>
<span class="udiff-line-modified-added">+     if (OopStorageSet::string_table_weak() == *it) {</span>
<span class="udiff-line-modified-added">+       OopsDoAndReportCounts&lt;StringTable&gt;()(is_alive, keep_alive, *it);</span>
<span class="udiff-line-modified-added">+     } else if (OopStorageSet::resolved_method_table_weak() == *it) {</span>
<span class="udiff-line-added">+       OopsDoAndReportCounts&lt;ResolvedMethodTable&gt;()(is_alive, keep_alive, *it);</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+       it-&gt;weak_oops_do(is_alive, keep_alive);</span>
      }
    }
  }
  
  void WeakProcessor::oops_do(OopClosure* closure) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -73,12 +87,13 @@</span>
    // cost of running unnecessary threads.  These phases are normally
    // small or empty (assuming they are configured to exist at all),
    // and development oriented, so not allocating any threads
    // specifically for them is okay.
    size_t ref_count = 0;
<span class="udiff-line-modified-removed">-   FOR_EACH_WEAK_PROCESSOR_OOP_STORAGE_PHASE(phase) {</span>
<span class="udiff-line-modified-removed">-     ref_count += WeakProcessorPhases::oop_storage(phase)-&gt;allocation_count();</span>
<span class="udiff-line-modified-added">+   OopStorageSet::Iterator it = OopStorageSet::weak_iterator();</span>
<span class="udiff-line-modified-added">+   for ( ; !it.is_end(); ++it) {</span>
<span class="udiff-line-added">+     ref_count += it-&gt;allocation_count();</span>
    }
  
    // +1 to (approx) round up the ref per thread division.
    size_t nworkers = 1 + (ref_count / ReferencesPerThread);
    nworkers = MIN2(nworkers, static_cast&lt;size_t&gt;(max_workers));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,19 +108,22 @@</span>
  
    if (_phase_times) {
      _phase_times-&gt;set_active_workers(_nworkers);
    }
  
<span class="udiff-line-modified-removed">-   uint storage_count = WeakProcessorPhases::oop_storage_phase_count;</span>
<span class="udiff-line-modified-added">+   uint storage_count = WeakProcessorPhases::oopstorage_phase_count;</span>
    _storage_states = NEW_C_HEAP_ARRAY(StorageState, storage_count, mtGC);
  
<span class="udiff-line-modified-removed">-   StorageState* states = _storage_states;</span>
<span class="udiff-line-modified-removed">-   FOR_EACH_WEAK_PROCESSOR_OOP_STORAGE_PHASE(phase) {</span>
<span class="udiff-line-modified-removed">-     OopStorage* storage = WeakProcessorPhases::oop_storage(phase);</span>
<span class="udiff-line-modified-removed">-     new (states++) StorageState(storage, _nworkers);</span>
<span class="udiff-line-modified-added">+   StorageState* cur_state = _storage_states;</span>
<span class="udiff-line-modified-added">+   OopStorageSet::Iterator it = OopStorageSet::weak_iterator();</span>
<span class="udiff-line-modified-added">+   for ( ; !it.is_end(); ++it, ++cur_state) {</span>
<span class="udiff-line-modified-added">+     assert(pointer_delta(cur_state, _storage_states, sizeof(StorageState)) &lt; storage_count, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+     new (cur_state) StorageState(*it, _nworkers);</span>
    }
<span class="udiff-line-added">+   assert(pointer_delta(cur_state, _storage_states, sizeof(StorageState)) == storage_count, &quot;invariant&quot;);</span>
    StringTable::reset_dead_counter();
<span class="udiff-line-added">+   ResolvedMethodTable::reset_dead_counter();</span>
  }
  
  WeakProcessor::Task::Task(uint nworkers) :
    _phase_times(NULL),
    _nworkers(nworkers),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,17 +143,18 @@</span>
  }
  
  WeakProcessor::Task::~Task() {
    if (_storage_states != NULL) {
      StorageState* states = _storage_states;
<span class="udiff-line-modified-removed">-     FOR_EACH_WEAK_PROCESSOR_OOP_STORAGE_PHASE(phase) {</span>
<span class="udiff-line-modified-added">+     for (uint i = 0; i &lt; WeakProcessorPhases::oopstorage_phase_count; ++i) {</span>
        states-&gt;StorageState::~StorageState();
        ++states;
      }
      FREE_C_HEAP_ARRAY(StorageState, _storage_states);
    }
    StringTable::finish_dead_counter();
<span class="udiff-line-added">+   ResolvedMethodTable::finish_dead_counter();</span>
  }
  
  void WeakProcessor::GangTask::work(uint worker_id) {
    _erased_do_work(this, worker_id);
  }
</pre>
<center><a href="vmStructs_gc.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="weakProcessor.inline.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>