<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shared/preservedMarks.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="plab.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="preservedMarks.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/preservedMarks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,24 +26,25 @@</span>
  #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  #include &quot;gc/shared/workgroup.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;utilities/macros.hpp&quot;
  
  void PreservedMarks::restore() {
    while (!_stack.is_empty()) {
<span class="udiff-line-modified-removed">-     const OopAndMarkOop elem = _stack.pop();</span>
<span class="udiff-line-modified-added">+     const OopAndMarkWord elem = _stack.pop();</span>
      elem.set_mark();
    }
    assert_empty();
  }
  
  void PreservedMarks::adjust_during_full_gc() {
<span class="udiff-line-modified-removed">-   StackIterator&lt;OopAndMarkOop, mtGC&gt; iter(_stack);</span>
<span class="udiff-line-modified-added">+   StackIterator&lt;OopAndMarkWord, mtGC&gt; iter(_stack);</span>
    while (!iter.is_empty()) {
<span class="udiff-line-modified-removed">-     OopAndMarkOop* elem = iter.next_addr();</span>
<span class="udiff-line-modified-added">+     OopAndMarkWord* elem = iter.next_addr();</span>
  
      oop obj = elem-&gt;get_oop();
      if (obj-&gt;is_forwarded()) {
        elem-&gt;set_oop(obj-&gt;forwardee());
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,11 +54,11 @@</span>
  void PreservedMarks::restore_and_increment(volatile size_t* const total_size_addr) {
    const size_t stack_size = size();
    restore();
    // Only do the atomic add if the size is &gt; 0.
    if (stack_size &gt; 0) {
<span class="udiff-line-modified-removed">-     Atomic::add(stack_size, total_size_addr);</span>
<span class="udiff-line-modified-added">+     Atomic::add(total_size_addr, stack_size);</span>
    }
  }
  
  #ifndef PRODUCT
  void PreservedMarks::assert_empty() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -115,10 +116,40 @@</span>
      _sub_tasks.set_n_threads(worker_num);
      _sub_tasks.set_n_tasks(preserved_marks_set-&gt;num());
    }
  };
  
<span class="udiff-line-added">+ void PreservedMarksSet::restore(WorkGang* workers) {</span>
<span class="udiff-line-added">+   volatile size_t total_size = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef ASSERT</span>
<span class="udiff-line-added">+   // This is to make sure the total_size we&#39;ll calculate below is correct.</span>
<span class="udiff-line-added">+   size_t total_size_before = 0;</span>
<span class="udiff-line-added">+   for (uint i = 0; i &lt; _num; i += 1) {</span>
<span class="udiff-line-added">+     total_size_before += get(i)-&gt;size();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ #endif // def ASSERT</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (workers == NULL) {</span>
<span class="udiff-line-added">+     for (uint i = 0; i &lt; num(); i += 1) {</span>
<span class="udiff-line-added">+       total_size += get(i)-&gt;size();</span>
<span class="udiff-line-added">+       get(i)-&gt;restore();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   } else {</span>
<span class="udiff-line-added">+     ParRestoreTask task(workers-&gt;active_workers(), this, &amp;total_size);</span>
<span class="udiff-line-added">+     workers-&gt;run_task(&amp;task);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   assert_empty();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   assert(total_size == total_size_before,</span>
<span class="udiff-line-added">+          &quot;total_size = &quot; SIZE_FORMAT &quot; before = &quot; SIZE_FORMAT,</span>
<span class="udiff-line-added">+          total_size, total_size_before);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   log_trace(gc)(&quot;Restored &quot; SIZE_FORMAT &quot; marks&quot;, total_size);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void PreservedMarksSet::reclaim() {
    assert_empty();
  
    for (uint i = 0; i &lt; _num; i += 1) {
      _stacks[i].~Padded&lt;PreservedMarks&gt;();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -139,18 +170,5 @@</span>
    for (uint i = 0; i &lt; _num; i += 1) {
      get(i)-&gt;assert_empty();
    }
  }
  #endif // ndef PRODUCT
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void SharedRestorePreservedMarksTaskExecutor::restore(PreservedMarksSet* preserved_marks_set,</span>
<span class="udiff-line-removed">-                                                       volatile size_t* total_size_addr) {</span>
<span class="udiff-line-removed">-   if (_workers == NULL) {</span>
<span class="udiff-line-removed">-     for (uint i = 0; i &lt; preserved_marks_set-&gt;num(); i += 1) {</span>
<span class="udiff-line-removed">-       *total_size_addr += preserved_marks_set-&gt;get(i)-&gt;size();</span>
<span class="udiff-line-removed">-       preserved_marks_set-&gt;get(i)-&gt;restore();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     ParRestoreTask task(_workers-&gt;active_workers(), preserved_marks_set, total_size_addr);</span>
<span class="udiff-line-removed">-     _workers-&gt;run_task(&amp;task);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
</pre>
<center><a href="plab.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="preservedMarks.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>