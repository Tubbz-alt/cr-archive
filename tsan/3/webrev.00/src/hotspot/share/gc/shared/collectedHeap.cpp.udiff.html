<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shared/collectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="cardTableRS.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="collectedHeap.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/collectedHeap.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,10 +36,11 @@</span>
  #include &quot;gc/shared/gcWhen.hpp&quot;
  #include &quot;gc/shared/memAllocator.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/metaspace.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="udiff-line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/instanceMirrorKlass.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/init.hpp&quot;
  #include &quot;runtime/thread.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,11 +64,11 @@</span>
    if (!should_log()) {
      return;
    }
  
    double timestamp = fetch_timestamp();
<span class="udiff-line-modified-removed">-   MutexLockerEx ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker ml(&amp;_mutex, Mutex::_no_safepoint_check_flag);</span>
    int index = compute_log_index();
    _records[index].thread = NULL; // Its the GC thread so it&#39;s not that interesting.
    _records[index].timestamp = timestamp;
    _records[index].data.is_before = before;
    stringStream st(_records[index].data.buffer(), _records[index].data.size());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -79,15 +80,20 @@</span>
  
    heap-&gt;print_on(&amp;st);
    st.print_cr(&quot;}&quot;);
  }
  
<span class="udiff-line-added">+ size_t CollectedHeap::unused() const {</span>
<span class="udiff-line-added">+   MutexLocker ml(Heap_lock);</span>
<span class="udiff-line-added">+   return capacity() - used();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  VirtualSpaceSummary CollectedHeap::create_heap_space_summary() {
    size_t capacity_in_words = capacity() / HeapWordSize;
  
    return VirtualSpaceSummary(
<span class="udiff-line-modified-removed">-     reserved_region().start(), reserved_region().start() + capacity_in_words, reserved_region().end());</span>
<span class="udiff-line-modified-added">+     _reserved.start(), _reserved.start() + capacity_in_words, _reserved.end());</span>
  }
  
  GCHeapSummary CollectedHeap::create_heap_summary() {
    VirtualSpaceSummary heap_space = create_heap_space_summary();
    return GCHeapSummary(heap_space, used());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,10 +134,12 @@</span>
    if (_gc_heap_log != NULL) {
      _gc_heap_log-&gt;log_heap_after(this);
    }
  }
  
<span class="udiff-line-added">+ void CollectedHeap::print() const { print_on(tty); }</span>
<span class="udiff-line-added">+ </span>
  void CollectedHeap::print_on_error(outputStream* st) const {
    st-&gt;print_cr(&quot;Heap:&quot;);
    print_extended_on(st);
    st-&gt;cr();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,19 +172,19 @@</span>
  bool CollectedHeap::request_concurrent_phase(const char* phase) {
    return false;
  }
  
  bool CollectedHeap::is_oop(oop object) const {
<span class="udiff-line-modified-removed">-   if (!check_obj_alignment(object)) {</span>
<span class="udiff-line-modified-added">+   if (!is_object_aligned(object)) {</span>
      return false;
    }
  
<span class="udiff-line-modified-removed">-   if (!is_in_reserved(object)) {</span>
<span class="udiff-line-modified-added">+   if (!is_in(object)) {</span>
      return false;
    }
  
<span class="udiff-line-modified-removed">-   if (is_in_reserved(object-&gt;klass_or_null())) {</span>
<span class="udiff-line-modified-added">+   if (is_in(object-&gt;klass_or_null())) {</span>
      return false;
    }
  
    return true;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -325,13 +333,13 @@</span>
  
  
  #ifndef PRODUCT
  void CollectedHeap::check_for_non_bad_heap_word_value(HeapWord* addr, size_t size) {
    if (CheckMemoryInitialization &amp;&amp; ZapUnusedHeapArea) {
<span class="udiff-line-modified-removed">-     for (size_t slot = 0; slot &lt; size; slot += 1) {</span>
<span class="udiff-line-modified-removed">-       assert((*(intptr_t*) (addr + slot)) == ((intptr_t) badHeapWordVal),</span>
<span class="udiff-line-modified-removed">-              &quot;Found non badHeapWordValue in pre-allocation check&quot;);</span>
<span class="udiff-line-modified-added">+     // please note mismatch between size (in 32/64 bit words), and ju_addr that always point to a 32 bit word</span>
<span class="udiff-line-modified-added">+     for (juint* ju_addr = reinterpret_cast&lt;juint*&gt;(addr); ju_addr &lt; reinterpret_cast&lt;juint*&gt;(addr + size); ++ju_addr) {</span>
<span class="udiff-line-modified-added">+       assert(*ju_addr == badHeapWordVal, &quot;Found non badHeapWordValue in pre-allocation check&quot;);</span>
      }
    }
  }
  #endif // PRODUCT
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -361,12 +369,10 @@</span>
  #ifdef ASSERT
  void CollectedHeap::fill_args_check(HeapWord* start, size_t words)
  {
    assert(words &gt;= min_fill_size(), &quot;too small to fill&quot;);
    assert(is_object_aligned(words), &quot;unaligned size&quot;);
<span class="udiff-line-removed">-   assert(Universe::heap()-&gt;is_in_reserved(start), &quot;not in heap&quot;);</span>
<span class="udiff-line-removed">-   assert(Universe::heap()-&gt;is_in_reserved(start + words - 1), &quot;not in heap&quot;);</span>
  }
  
  void CollectedHeap::zap_filler_array(HeapWord* start, size_t words, bool zap)
  {
    if (ZapFillerObjects &amp;&amp; zap) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -506,16 +512,16 @@</span>
  
  void CollectedHeap::post_full_gc_dump(GCTimer* timer) {
    full_gc_dump(timer, false);
  }
  
<span class="udiff-line-modified-removed">- void CollectedHeap::initialize_reserved_region(HeapWord *start, HeapWord *end) {</span>
<span class="udiff-line-modified-added">+ void CollectedHeap::initialize_reserved_region(const ReservedHeapSpace&amp; rs) {</span>
    // It is important to do this in a way such that concurrent readers can&#39;t
    // temporarily think something is in the heap.  (Seen this happen in asserts.)
    _reserved.set_word_size(0);
<span class="udiff-line-modified-removed">-   _reserved.set_start(start);</span>
<span class="udiff-line-modified-removed">-   _reserved.set_end(end);</span>
<span class="udiff-line-modified-added">+   _reserved.set_start((HeapWord*)rs.base());</span>
<span class="udiff-line-modified-added">+   _reserved.set_end((HeapWord*)rs.end());</span>
  }
  
  void CollectedHeap::post_initialize() {
    initialize_serviceability();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -573,5 +579,10 @@</span>
  }
  
  size_t CollectedHeap::obj_size(oop obj) const {
    return obj-&gt;size();
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ uint32_t CollectedHeap::hash_oop(oop obj) const {</span>
<span class="udiff-line-added">+   const uintptr_t addr = cast_from_oop&lt;uintptr_t&gt;(obj);</span>
<span class="udiff-line-added">+   return static_cast&lt;uint32_t&gt;(addr &gt;&gt; LogMinObjAlignment);</span>
<span class="udiff-line-added">+ }</span>
</pre>
<center><a href="cardTableRS.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="collectedHeap.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>