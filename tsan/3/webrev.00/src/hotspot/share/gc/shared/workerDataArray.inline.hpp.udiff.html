<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shared/workerDataArray.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="workerDataArray.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="workerPolicy.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/workerDataArray.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,15 +28,17 @@</span>
  #include &quot;gc/shared/workerDataArray.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;utilities/ostream.hpp&quot;
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- WorkerDataArray&lt;T&gt;::WorkerDataArray(uint length, const char* title) :</span>
<span class="udiff-line-modified-added">+ WorkerDataArray&lt;T&gt;::WorkerDataArray(const char* title, uint length, bool is_serial) :</span>
   _data(NULL),
   _length(length),
<span class="udiff-line-modified-removed">-  _title(title) {</span>
<span class="udiff-line-modified-added">+  _title(title),</span>
<span class="udiff-line-added">+  _is_serial(is_serial) {</span>
    assert(length &gt; 0, &quot;Must have some workers to store data for&quot;);
<span class="udiff-line-added">+   assert(!is_serial || length == 1, &quot;Serial phase must only have a single entry.&quot;);</span>
    _data = NEW_C_HEAP_ARRAY(T, _length, mtGC);
    for (uint i = 0; i &lt; MaxThreadWorkItems; i++) {
      _thread_work_items[i] = NULL;
    }
    reset();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,17 +57,22 @@</span>
    return _data[worker_i];
  }
  
  template &lt;typename T&gt;
  WorkerDataArray&lt;T&gt;::~WorkerDataArray() {
<span class="udiff-line-added">+   for (uint i = 0; i &lt; MaxThreadWorkItems; i++) {</span>
<span class="udiff-line-added">+     delete _thread_work_items[i];</span>
<span class="udiff-line-added">+   }</span>
    FREE_C_HEAP_ARRAY(T, _data);
  }
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- void WorkerDataArray&lt;T&gt;::link_thread_work_items(WorkerDataArray&lt;size_t&gt;* thread_work_items, uint index) {</span>
<span class="udiff-line-modified-added">+ void WorkerDataArray&lt;T&gt;::create_thread_work_items(const char* title, uint index, uint length_override) {</span>
    assert(index &lt; MaxThreadWorkItems, &quot;Tried to access thread work item %u (max %u)&quot;, index, MaxThreadWorkItems);
<span class="udiff-line-modified-removed">-   _thread_work_items[index] = thread_work_items;</span>
<span class="udiff-line-modified-added">+   assert(_thread_work_items[index] == NULL, &quot;Tried to overwrite existing thread work item&quot;);</span>
<span class="udiff-line-added">+   uint length = length_override != 0 ? length_override : _length;</span>
<span class="udiff-line-added">+   _thread_work_items[index] = new WorkerDataArray&lt;size_t&gt;(title, length);</span>
  }
  
  template &lt;typename T&gt;
  void WorkerDataArray&lt;T&gt;::set_thread_work_item(uint worker_i, size_t value, uint index) {
    assert(index &lt; MaxThreadWorkItems, &quot;Tried to access thread work item %u (max %u)&quot;, index, MaxThreadWorkItems);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -89,14 +96,21 @@</span>
    } else {
      _thread_work_items[index]-&gt;add(worker_i, value);
    }
  }
  
<span class="udiff-line-added">+ template &lt;typename T&gt;</span>
<span class="udiff-line-added">+ size_t WorkerDataArray&lt;T&gt;::get_thread_work_item(uint worker_i, uint index) {</span>
<span class="udiff-line-added">+   assert(index &lt; MaxThreadWorkItems, &quot;Tried to access thread work item %u (max %u)&quot;, index, MaxThreadWorkItems);</span>
<span class="udiff-line-added">+   assert(_thread_work_items[index] != NULL, &quot;No sub count&quot;);</span>
<span class="udiff-line-added">+   return _thread_work_items[index]-&gt;get(worker_i);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  template &lt;typename T&gt;
  void WorkerDataArray&lt;T&gt;::add(uint worker_i, T value) {
    assert(worker_i &lt; _length, &quot;Worker %d is greater than max: %d&quot;, worker_i, _length);
<span class="udiff-line-modified-removed">-   assert(_data[worker_i] != uninitialized(), &quot;No data to add to for worker %d&quot;, worker_i);</span>
<span class="udiff-line-modified-added">+   assert(_data[worker_i] != uninitialized(), &quot;No data to add to %s for worker %d&quot;, _title, worker_i);</span>
    _data[worker_i] += value;
  }
  
  template &lt;typename T&gt;
  double WorkerDataArray&lt;T&gt;::average() const {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,34 +144,43 @@</span>
    }
  }
  
  template &lt;class T&gt;
  void WorkerDataArray&lt;T&gt;::print_summary_on(outputStream* out, bool print_sum) const {
<span class="udiff-line-modified-removed">-   out-&gt;print(&quot;%-25s&quot;, title());</span>
<span class="udiff-line-modified-added">+   if (_is_serial) {</span>
<span class="udiff-line-added">+     out-&gt;print(&quot;%s:&quot;, title());</span>
<span class="udiff-line-added">+   } else {</span>
<span class="udiff-line-added">+     out-&gt;print(&quot;%-25s&quot;, title());</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    uint start = 0;
    while (start &lt; _length &amp;&amp; get(start) == uninitialized()) {
      start++;
    }
    if (start &lt; _length) {
<span class="udiff-line-modified-removed">-     T min = get(start);</span>
<span class="udiff-line-modified-removed">-     T max = min;</span>
<span class="udiff-line-modified-removed">-     T sum = 0;</span>
<span class="udiff-line-modified-removed">-     uint contributing_threads = 0;</span>
<span class="udiff-line-modified-removed">-     for (uint i = start; i &lt; _length; ++i) {</span>
<span class="udiff-line-modified-removed">-       T value = get(i);</span>
<span class="udiff-line-modified-removed">-       if (value != uninitialized()) {</span>
<span class="udiff-line-modified-removed">-         max = MAX2(max, value);</span>
<span class="udiff-line-modified-removed">-         min = MIN2(min, value);</span>
<span class="udiff-line-modified-removed">-         sum += value;</span>
<span class="udiff-line-modified-removed">-         contributing_threads++;</span>
<span class="udiff-line-modified-added">+     if (_is_serial) {</span>
<span class="udiff-line-modified-added">+       WDAPrinter::summary(out, get(0));</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-modified-added">+       T min = get(start);</span>
<span class="udiff-line-modified-added">+       T max = min;</span>
<span class="udiff-line-modified-added">+       T sum = 0;</span>
<span class="udiff-line-modified-added">+       uint contributing_threads = 0;</span>
<span class="udiff-line-modified-added">+       for (uint i = start; i &lt; _length; ++i) {</span>
<span class="udiff-line-modified-added">+         T value = get(i);</span>
<span class="udiff-line-modified-added">+         if (value != uninitialized()) {</span>
<span class="udiff-line-modified-added">+           max = MAX2(max, value);</span>
<span class="udiff-line-added">+           min = MIN2(min, value);</span>
<span class="udiff-line-added">+           sum += value;</span>
<span class="udiff-line-added">+           contributing_threads++;</span>
<span class="udiff-line-added">+         }</span>
        }
<span class="udiff-line-added">+       T diff = max - min;</span>
<span class="udiff-line-added">+       assert(contributing_threads != 0, &quot;Must be since we found a used value for the start index&quot;);</span>
<span class="udiff-line-added">+       double avg = sum / (double) contributing_threads;</span>
<span class="udiff-line-added">+       WDAPrinter::summary(out, min, avg, max, diff, sum, print_sum);</span>
<span class="udiff-line-added">+       out-&gt;print_cr(&quot;, Workers: %d&quot;, contributing_threads);</span>
      }
<span class="udiff-line-removed">-     T diff = max - min;</span>
<span class="udiff-line-removed">-     assert(contributing_threads != 0, &quot;Must be since we found a used value for the start index&quot;);</span>
<span class="udiff-line-removed">-     double avg = sum / (double) contributing_threads;</span>
<span class="udiff-line-removed">-     WDAPrinter::summary(out, min, avg, max, diff, sum, print_sum);</span>
<span class="udiff-line-removed">-     out-&gt;print_cr(&quot;, Workers: %d&quot;, contributing_threads);</span>
    } else {
      // No data for this phase.
      out-&gt;print_cr(&quot; skipped&quot;);
    }
  }
</pre>
<center><a href="workerDataArray.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="workerPolicy.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>