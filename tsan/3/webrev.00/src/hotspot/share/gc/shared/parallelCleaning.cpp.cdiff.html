<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shared/parallelCleaning.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="oopStorageParState.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="parallelCleaning.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/parallelCleaning.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 28,10 ***</span>
<span class="line-new-header">--- 28,11 ---</span>
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;gc/shared/parallelCleaning.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;logging/log.hpp&quot;
<span class="line-added">+ #include &quot;runtime/atomic.hpp&quot;</span>
  
  StringDedupCleaningTask::StringDedupCleaningTask(BoolObjectClosure* is_alive,
                                                   OopClosure* keep_alive,
                                                   bool resize_table) :
    AbstractGangTask(&quot;String Dedup Cleaning&quot;),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 92,11 ***</span>
          claimed_nmethods[i] = last.method();
          (*num_claimed_nmethods)++;
        }
      }
  
<span class="line-modified">!   } while (Atomic::cmpxchg(last.method(), &amp;_claimed_nmethod, first) != first);</span>
  }
  
  void CodeCacheUnloadingTask::work(uint worker_id) {
    // The first nmethods is claimed by the first worker.
    if (worker_id == 0 &amp;&amp; _first_nmethod != NULL) {
<span class="line-new-header">--- 93,11 ---</span>
          claimed_nmethods[i] = last.method();
          (*num_claimed_nmethods)++;
        }
      }
  
<span class="line-modified">!   } while (Atomic::cmpxchg(&amp;_claimed_nmethod, first, last.method()) != first);</span>
  }
  
  void CodeCacheUnloadingTask::work(uint worker_id) {
    // The first nmethods is claimed by the first worker.
    if (worker_id == 0 &amp;&amp; _first_nmethod != NULL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 128,11 ***</span>
  bool KlassCleaningTask::claim_clean_klass_tree_task() {
    if (_clean_klass_tree_claimed) {
      return false;
    }
  
<span class="line-modified">!   return Atomic::cmpxchg(1, &amp;_clean_klass_tree_claimed, 0) == 0;</span>
  }
  
  InstanceKlass* KlassCleaningTask::claim_next_klass() {
    Klass* klass;
    do {
<span class="line-new-header">--- 129,11 ---</span>
  bool KlassCleaningTask::claim_clean_klass_tree_task() {
    if (_clean_klass_tree_claimed) {
      return false;
    }
  
<span class="line-modified">!   return Atomic::cmpxchg(&amp;_clean_klass_tree_claimed, 0, 1) == 0;</span>
  }
  
  InstanceKlass* KlassCleaningTask::claim_next_klass() {
    Klass* klass;
    do {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 155,32 ***</span>
    InstanceKlass* klass;
    while ((klass = claim_next_klass()) != NULL) {
      clean_klass(klass);
    }
  }
<span class="line-removed">- </span>
<span class="line-removed">- ParallelCleaningTask::ParallelCleaningTask(BoolObjectClosure* is_alive,</span>
<span class="line-removed">-                                            uint num_workers,</span>
<span class="line-removed">-                                            bool unloading_occurred,</span>
<span class="line-removed">-                                            bool resize_dedup_table) :</span>
<span class="line-removed">-   AbstractGangTask(&quot;Parallel Cleaning&quot;),</span>
<span class="line-removed">-   _unloading_occurred(unloading_occurred),</span>
<span class="line-removed">-   _string_dedup_task(is_alive, NULL, resize_dedup_table),</span>
<span class="line-removed">-   _code_cache_task(num_workers, is_alive, unloading_occurred),</span>
<span class="line-removed">-   _klass_cleaning_task() {</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // The parallel work done by all worker threads.</span>
<span class="line-removed">- void ParallelCleaningTask::work(uint worker_id) {</span>
<span class="line-removed">-   // Do first pass of code cache cleaning.</span>
<span class="line-removed">-   _code_cache_task.work(worker_id);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Clean the string dedup data structures.</span>
<span class="line-removed">-   _string_dedup_task.work(worker_id);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Clean all klasses that were not unloaded.</span>
<span class="line-removed">-   // The weak metadata in klass doesn&#39;t need to be</span>
<span class="line-removed">-   // processed if there was no unloading.</span>
<span class="line-removed">-   if (_unloading_occurred) {</span>
<span class="line-removed">-     _klass_cleaning_task.work();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-new-header">--- 156,5 ---</span>
</pre>
<center><a href="oopStorageParState.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="parallelCleaning.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>