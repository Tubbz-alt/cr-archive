<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/shared/stringdedup/stringDedup.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_SHARED_STRINGDEDUP_STRINGDEDUP_HPP
 26 #define SHARE_GC_SHARED_STRINGDEDUP_STRINGDEDUP_HPP
 27 
 28 //
 29 // String Deduplication
 30 //
 31 // String deduplication aims to reduce the heap live-set by deduplicating identical
 32 // instances of String so that they share the same backing character array.
 33 //
 34 // The deduplication process is divided in two main parts, 1) finding the objects to
 35 // deduplicate, and 2) deduplicating those objects. The first part is done as part of
 36 // a normal GC cycle when objects are marked or evacuated. At this time a check is
 37 // applied on each object to check if it is a candidate for deduplication. If so, the
 38 // object is placed on the deduplication queue for later processing. The second part,
 39 // processing the objects on the deduplication queue, is a concurrent phase which
 40 // starts right after the stop-the-wold marking/evacuation phase. This phase is
 41 // executed by the deduplication thread, which pulls deduplication candidates of the
 42 // deduplication queue and tries to deduplicate them.
 43 //
 44 // A deduplication hashtable is used to keep track of all unique character arrays
 45 // used by String objects. When deduplicating, a lookup is made in this table to see
 46 // if there is already an identical character array somewhere on the heap. If so, the
 47 // String object is adjusted to point to that character array, releasing the reference
 48 // to the original array allowing it to eventually be garbage collected. If the lookup
 49 // fails the character array is instead inserted into the hashtable so that this array
 50 // can be shared at some point in the future.
 51 //
 52 // Candidate selection criteria is GC specific.
 53 //
 54 // Interned strings are a bit special. They are explicitly deduplicated just before
 55 // being inserted into the StringTable (to avoid counteracting C2 optimizations done
 56 // on string literals), then they also become deduplication candidates if they reach
 57 // the deduplication age threshold or are evacuated to an old heap region. The second
 58 // attempt to deduplicate such strings will be in vain, but we have no fast way of
 59 // filtering them out. This has not shown to be a problem, as the number of interned
 60 // strings is usually dwarfed by the number of normal (non-interned) strings.
 61 //
 62 // For additional information on string deduplication, please see JEP 192,
 63 // http://openjdk.java.net/jeps/192
 64 //
 65 
 66 #include &quot;gc/shared/stringdedup/stringDedupQueue.hpp&quot;
 67 #include &quot;gc/shared/stringdedup/stringDedupStat.hpp&quot;
 68 #include &quot;gc/shared/stringdedup/stringDedupTable.hpp&quot;
 69 #include &quot;memory/allocation.hpp&quot;
 70 #include &quot;runtime/thread.hpp&quot;
 71 
 72 class ThreadClosure;
 73 
 74 //
 75 // Main interface for interacting with string deduplication.
 76 //
 77 class StringDedup : public AllStatic {
 78 private:
 79   // Single state for checking if string deduplication is enabled.
 80   static bool _enabled;
 81 
 82 public:
 83   // Returns true if string deduplication is enabled.
 84   static bool is_enabled() {
 85     return _enabled;
 86   }
 87 
 88   // Stop the deduplication thread.
 89   static void stop();
 90 
 91   // Immediately deduplicates the given String object, bypassing the
 92   // the deduplication queue.
 93   static void deduplicate(oop java_string);
 94 
 95   static void parallel_unlink(StringDedupUnlinkOrOopsDoClosure* unlink, uint worker_id);
 96 
 97   static void threads_do(ThreadClosure* tc);
 98   static void print_worker_threads_on(outputStream* st);
 99   static void verify();
100 
101   // GC support
102   static void gc_prologue(bool resize_and_rehash_table);
103   static void gc_epilogue();
104 
105 protected:
106   // Initialize string deduplication.
107   // Q: String Dedup Queue implementation
108   // S: String Dedup Stat implementation
109   template &lt;typename Q, typename S&gt;
110   static void initialize_impl();
111 };
112 
113 //
114 // This closure encapsulates the closures needed when scanning
115 // the deduplication queue and table during the unlink_or_oops_do() operation.
116 //
117 class StringDedupUnlinkOrOopsDoClosure : public StackObj {
118   AlwaysTrueClosure   _always_true;
119   DoNothingClosure    _do_nothing;
120   BoolObjectClosure*  _is_alive;
121   OopClosure*         _keep_alive;
122 
123 public:
124   StringDedupUnlinkOrOopsDoClosure(BoolObjectClosure* is_alive,
125                                    OopClosure* keep_alive);
126 
127   bool is_alive(oop o) { return _is_alive-&gt;do_object_b(o); }
128 
129   void keep_alive(oop* p) { _keep_alive-&gt;do_oop(p); }
130 };
131 
132 #endif // SHARE_GC_SHARED_STRINGDEDUP_STRINGDEDUP_HPP
    </pre>
  </body>
</html>