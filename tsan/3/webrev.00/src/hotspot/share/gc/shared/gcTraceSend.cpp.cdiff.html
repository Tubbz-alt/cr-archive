<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shared/gcTraceSend.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="gcTrace.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="gcVMOperations.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shared/gcTraceSend.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,14 ***</span>
  #include &quot;gc/shared/gcTrace.hpp&quot;
  #include &quot;gc/shared/gcWhen.hpp&quot;
  #include &quot;jfr/jfrEvents.hpp&quot;
  #include &quot;runtime/os.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
<span class="line-removed">- #if INCLUDE_G1GC</span>
<span class="line-removed">- #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;</span>
<span class="line-removed">- #include &quot;gc/g1/g1YCTypes.hpp&quot;</span>
<span class="line-removed">- #endif</span>
  
  // All GC dependencies against the trace framework is contained within this file.
  
  typedef uintptr_t TraceAddress;
  
<span class="line-new-header">--- 29,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 175,144 ***</span>
      e.set_thread(pf_info.thread_trace_id());
      e.commit();
    }
  }
  
<span class="line-modified">! // Common to CMS and G1</span>
  void OldGCTracer::send_concurrent_mode_failure_event() {
    EventConcurrentModeFailure e;
    if (e.should_commit()) {
      e.set_gcId(GCId::current());
      e.commit();
    }
  }
  
<span class="line-removed">- #if INCLUDE_G1GC</span>
<span class="line-removed">- void G1NewTracer::send_g1_young_gc_event() {</span>
<span class="line-removed">-   EventG1GarbageCollection e(UNTIMED);</span>
<span class="line-removed">-   if (e.should_commit()) {</span>
<span class="line-removed">-     e.set_gcId(GCId::current());</span>
<span class="line-removed">-     e.set_type(_g1_young_gc_info.type());</span>
<span class="line-removed">-     e.set_starttime(_shared_gc_info.start_timestamp());</span>
<span class="line-removed">-     e.set_endtime(_shared_gc_info.end_timestamp());</span>
<span class="line-removed">-     e.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1MMUTracer::send_g1_mmu_event(double time_slice_ms, double gc_time_ms, double max_time_ms) {</span>
<span class="line-removed">-   EventG1MMU e;</span>
<span class="line-removed">-   if (e.should_commit()) {</span>
<span class="line-removed">-     e.set_gcId(GCId::current());</span>
<span class="line-removed">-     e.set_timeSlice(time_slice_ms);</span>
<span class="line-removed">-     e.set_gcTime(gc_time_ms);</span>
<span class="line-removed">-     e.set_pauseTarget(max_time_ms);</span>
<span class="line-removed">-     e.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_evacuation_info_event(G1EvacuationInfo* info) {</span>
<span class="line-removed">-   EventEvacuationInformation e;</span>
<span class="line-removed">-   if (e.should_commit()) {</span>
<span class="line-removed">-     e.set_gcId(GCId::current());</span>
<span class="line-removed">-     e.set_cSetRegions(info-&gt;collectionset_regions());</span>
<span class="line-removed">-     e.set_cSetUsedBefore(info-&gt;collectionset_used_before());</span>
<span class="line-removed">-     e.set_cSetUsedAfter(info-&gt;collectionset_used_after());</span>
<span class="line-removed">-     e.set_allocationRegions(info-&gt;allocation_regions());</span>
<span class="line-removed">-     e.set_allocationRegionsUsedBefore(info-&gt;alloc_regions_used_before());</span>
<span class="line-removed">-     e.set_allocationRegionsUsedAfter(info-&gt;alloc_regions_used_before() + info-&gt;bytes_copied());</span>
<span class="line-removed">-     e.set_bytesCopied(info-&gt;bytes_copied());</span>
<span class="line-removed">-     e.set_regionsFreed(info-&gt;regions_freed());</span>
<span class="line-removed">-     e.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_evacuation_failed_event(const EvacuationFailedInfo&amp; ef_info) const {</span>
<span class="line-removed">-   EventEvacuationFailed e;</span>
<span class="line-removed">-   if (e.should_commit()) {</span>
<span class="line-removed">-     e.set_gcId(GCId::current());</span>
<span class="line-removed">-     e.set_evacuationFailed(to_struct(ef_info));</span>
<span class="line-removed">-     e.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static JfrStructG1EvacuationStatistics</span>
<span class="line-removed">- create_g1_evacstats(unsigned gcid, const G1EvacSummary&amp; summary) {</span>
<span class="line-removed">-   JfrStructG1EvacuationStatistics s;</span>
<span class="line-removed">-   s.set_gcId(gcid);</span>
<span class="line-removed">-   s.set_allocated(summary.allocated() * HeapWordSize);</span>
<span class="line-removed">-   s.set_wasted(summary.wasted() * HeapWordSize);</span>
<span class="line-removed">-   s.set_used(summary.used() * HeapWordSize);</span>
<span class="line-removed">-   s.set_undoWaste(summary.undo_wasted() * HeapWordSize);</span>
<span class="line-removed">-   s.set_regionEndWaste(summary.region_end_waste() * HeapWordSize);</span>
<span class="line-removed">-   s.set_regionsRefilled(summary.regions_filled());</span>
<span class="line-removed">-   s.set_directAllocated(summary.direct_allocated() * HeapWordSize);</span>
<span class="line-removed">-   s.set_failureUsed(summary.failure_used() * HeapWordSize);</span>
<span class="line-removed">-   s.set_failureWaste(summary.failure_waste() * HeapWordSize);</span>
<span class="line-removed">-   return s;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_young_evacuation_statistics(const G1EvacSummary&amp; summary) const {</span>
<span class="line-removed">-   EventG1EvacuationYoungStatistics surv_evt;</span>
<span class="line-removed">-   if (surv_evt.should_commit()) {</span>
<span class="line-removed">-     surv_evt.set_statistics(create_g1_evacstats(GCId::current(), summary));</span>
<span class="line-removed">-     surv_evt.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_old_evacuation_statistics(const G1EvacSummary&amp; summary) const {</span>
<span class="line-removed">-   EventG1EvacuationOldStatistics old_evt;</span>
<span class="line-removed">-   if (old_evt.should_commit()) {</span>
<span class="line-removed">-     old_evt.set_statistics(create_g1_evacstats(GCId::current(), summary));</span>
<span class="line-removed">-     old_evt.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_basic_ihop_statistics(size_t threshold,</span>
<span class="line-removed">-                                              size_t target_occupancy,</span>
<span class="line-removed">-                                              size_t current_occupancy,</span>
<span class="line-removed">-                                              size_t last_allocation_size,</span>
<span class="line-removed">-                                              double last_allocation_duration,</span>
<span class="line-removed">-                                              double last_marking_length) {</span>
<span class="line-removed">-   EventG1BasicIHOP evt;</span>
<span class="line-removed">-   if (evt.should_commit()) {</span>
<span class="line-removed">-     evt.set_gcId(GCId::current());</span>
<span class="line-removed">-     evt.set_threshold(threshold);</span>
<span class="line-removed">-     evt.set_targetOccupancy(target_occupancy);</span>
<span class="line-removed">-     evt.set_thresholdPercentage(target_occupancy &gt; 0 ? ((double)threshold / target_occupancy) : 0.0);</span>
<span class="line-removed">-     evt.set_currentOccupancy(current_occupancy);</span>
<span class="line-removed">-     evt.set_recentMutatorAllocationSize(last_allocation_size);</span>
<span class="line-removed">-     evt.set_recentMutatorDuration(last_allocation_duration * MILLIUNITS);</span>
<span class="line-removed">-     evt.set_recentAllocationRate(last_allocation_duration != 0.0 ? last_allocation_size / last_allocation_duration : 0.0);</span>
<span class="line-removed">-     evt.set_lastMarkingDuration(last_marking_length * MILLIUNITS);</span>
<span class="line-removed">-     evt.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void G1NewTracer::send_adaptive_ihop_statistics(size_t threshold,</span>
<span class="line-removed">-                                                 size_t internal_target_occupancy,</span>
<span class="line-removed">-                                                 size_t current_occupancy,</span>
<span class="line-removed">-                                                 size_t additional_buffer_size,</span>
<span class="line-removed">-                                                 double predicted_allocation_rate,</span>
<span class="line-removed">-                                                 double predicted_marking_length,</span>
<span class="line-removed">-                                                 bool prediction_active) {</span>
<span class="line-removed">-   EventG1AdaptiveIHOP evt;</span>
<span class="line-removed">-   if (evt.should_commit()) {</span>
<span class="line-removed">-     evt.set_gcId(GCId::current());</span>
<span class="line-removed">-     evt.set_threshold(threshold);</span>
<span class="line-removed">-     evt.set_thresholdPercentage(internal_target_occupancy &gt; 0 ? ((double)threshold / internal_target_occupancy) : 0.0);</span>
<span class="line-removed">-     evt.set_ihopTargetOccupancy(internal_target_occupancy);</span>
<span class="line-removed">-     evt.set_currentOccupancy(current_occupancy);</span>
<span class="line-removed">-     evt.set_additionalBufferSize(additional_buffer_size);</span>
<span class="line-removed">-     evt.set_predictedAllocationRate(predicted_allocation_rate);</span>
<span class="line-removed">-     evt.set_predictedMarkingDuration(predicted_marking_length * MILLIUNITS);</span>
<span class="line-removed">-     evt.set_predictionActive(prediction_active);</span>
<span class="line-removed">-     evt.commit();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #endif // INCLUDE_G1GC</span>
<span class="line-removed">- </span>
  static JfrStructVirtualSpace to_struct(const VirtualSpaceSummary&amp; summary) {
    JfrStructVirtualSpace space;
    space.set_start((TraceAddress)summary.start());
    space.set_committedEnd((TraceAddress)summary.committed_end());
    space.set_committedSize(summary.committed_size());
<span class="line-new-header">--- 171,19 ---</span>
      e.set_thread(pf_info.thread_trace_id());
      e.commit();
    }
  }
  
<span class="line-modified">! // G1</span>
  void OldGCTracer::send_concurrent_mode_failure_event() {
    EventConcurrentModeFailure e;
    if (e.should_commit()) {
      e.set_gcId(GCId::current());
      e.commit();
    }
  }
  
  static JfrStructVirtualSpace to_struct(const VirtualSpaceSummary&amp; summary) {
    JfrStructVirtualSpace space;
    space.set_start((TraceAddress)summary.start());
    space.set_committedEnd((TraceAddress)summary.committed_end());
    space.set_committedSize(summary.committed_size());
</pre>
<center><a href="gcTrace.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="gcVMOperations.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>