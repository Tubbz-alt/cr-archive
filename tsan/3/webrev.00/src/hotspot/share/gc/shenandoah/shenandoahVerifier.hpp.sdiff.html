<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahVerifier.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahVerifier.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahWorkGroup.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahVerifier.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>

  3  *
  4  * This code is free software; you can redistribute it and/or modify it
  5  * under the terms of the GNU General Public License version 2 only, as
  6  * published by the Free Software Foundation.
  7  *
  8  * This code is distributed in the hope that it will be useful, but WITHOUT
  9  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11  * version 2 for more details (a copy is included in the LICENSE file that
 12  * accompanied this code).
 13  *
 14  * You should have received a copy of the GNU General Public License version
 15  * 2 along with this work; if not, write to the Free Software Foundation,
 16  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17  *
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  *
 22  */
 23 
 24 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 25 #define SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 26 
 27 #include &quot;gc/shared/markBitMap.hpp&quot;

 28 #include &quot;memory/allocation.hpp&quot;
 29 #include &quot;oops/oopsHierarchy.hpp&quot;
 30 #include &quot;utilities/stack.hpp&quot;
 31 
 32 class ShenandoahHeap;
 33 
 34 #ifdef _WINDOWS
 35 #pragma warning( disable : 4522 )
 36 #endif
 37 
 38 class ShenandoahVerifierTask {
 39 public:
 40   ShenandoahVerifierTask(oop o = NULL, int idx = 0): _obj(o) { }
 41   ShenandoahVerifierTask(oop o, size_t idx): _obj(o) { }
 42   ShenandoahVerifierTask(const ShenandoahVerifierTask&amp; t): _obj(t._obj) { }
 43 
 44   ShenandoahVerifierTask&amp; operator =(const ShenandoahVerifierTask&amp; t) {
 45     _obj = t._obj;
 46     return *this;
 47   }
</pre>
<hr />
<pre>
 56 private:
 57   oop _obj;
 58 };
 59 
 60 typedef Stack&lt;ShenandoahVerifierTask, mtGC&gt; ShenandoahVerifierStack;
 61 typedef volatile juint ShenandoahLivenessData;
 62 
 63 class ShenandoahVerifier : public CHeapObj&lt;mtGC&gt; {
 64 private:
 65   ShenandoahHeap* _heap;
 66   MarkBitMap* _verification_bit_map;
 67 public:
 68   typedef enum {
 69     // Disable marked objects verification.
 70     _verify_marked_disable,
 71 
 72     // Objects should be marked in &quot;next&quot; bitmap.
 73     _verify_marked_incomplete,
 74 
 75     // Objects should be marked in &quot;complete&quot; bitmap.
<span class="line-modified"> 76     _verify_marked_complete,</span>
 77   } VerifyMarked;
 78 
 79   typedef enum {
 80     // Disable forwarded objects verification.
 81     _verify_forwarded_disable,
 82 
 83     // Objects should not have forwardees.
 84     _verify_forwarded_none,
 85 
 86     // Objects may have forwardees.
<span class="line-modified"> 87     _verify_forwarded_allow,</span>
 88   } VerifyForwarded;
 89 
 90   typedef enum {
 91     // Disable collection set verification.
 92     _verify_cset_disable,
 93 
 94     // Should have no references to cset.
 95     _verify_cset_none,
 96 
 97     // May have references to cset, all should be forwarded.
 98     // Note: Allowing non-forwarded references to cset is equivalent
 99     // to _verify_cset_disable.
<span class="line-modified">100     _verify_cset_forwarded,</span>
101   } VerifyCollectionSet;
102 
103   typedef enum {
104     // Disable liveness verification
105     _verify_liveness_disable,
106 
107     // All objects should belong to live regions
108     _verify_liveness_conservative,
109 
110     // All objects should belong to live regions,
111     // and liveness data should be accurate
<span class="line-modified">112     _verify_liveness_complete,</span>
113   } VerifyLiveness;
114 
115   typedef enum {
116     // Disable region verification
117     _verify_regions_disable,
118 
119     // No trash regions allowed
120     _verify_regions_notrash,
121 
122     // No collection set regions allowed
123     _verify_regions_nocset,
124 
125     // No trash and no cset regions allowed
<span class="line-modified">126     _verify_regions_notrash_nocset,</span>
127   } VerifyRegions;
128 
129   typedef enum {
130     // Disable gc-state verification
131     _verify_gcstate_disable,
132 
133     // Nothing is in progress, no forwarded objects
134     _verify_gcstate_stable,
135 
136     // Nothing is in progress, some objects are forwarded
137     _verify_gcstate_forwarded,



138   } VerifyGCState;
139 






140   struct VerifyOptions {
141     VerifyForwarded     _verify_forwarded;
142     VerifyMarked        _verify_marked;
143     VerifyCollectionSet _verify_cset;
144     VerifyLiveness      _verify_liveness;
145     VerifyRegions       _verify_regions;
146     VerifyGCState       _verify_gcstate;

147 
148     VerifyOptions(VerifyForwarded verify_forwarded,
149                   VerifyMarked verify_marked,
150                   VerifyCollectionSet verify_collection_set,
151                   VerifyLiveness verify_liveness,
152                   VerifyRegions verify_regions,
<span class="line-modified">153                   VerifyGCState verify_gcstate) :</span>

154             _verify_forwarded(verify_forwarded), _verify_marked(verify_marked),
155             _verify_cset(verify_collection_set),
156             _verify_liveness(verify_liveness), _verify_regions(verify_regions),
<span class="line-modified">157             _verify_gcstate(verify_gcstate) {}</span>

158   };
159 
160 private:
161   void verify_at_safepoint(const char *label,
162                            VerifyForwarded forwarded,
163                            VerifyMarked marked,
164                            VerifyCollectionSet cset,
165                            VerifyLiveness liveness,
166                            VerifyRegions regions,
<span class="line-modified">167                            VerifyGCState gcstate);</span>

168 
169 public:
170   ShenandoahVerifier(ShenandoahHeap* heap, MarkBitMap* verification_bitmap) :
171           _heap(heap), _verification_bit_map(verification_bitmap) {};
172 
173   void verify_before_concmark();
174   void verify_after_concmark();
175   void verify_before_evacuation();

176   void verify_after_evacuation();
177   void verify_before_updaterefs();
178   void verify_after_updaterefs();
179   void verify_before_fullgc();
180   void verify_after_fullgc();
181   void verify_before_traversal();
182   void verify_after_traversal();
183   void verify_after_degenerated();
184   void verify_generic(VerifyOption option);







185 };
186 
187 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2020, Red Hat, Inc. All rights reserved.</span>
<span class="line-added">  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 26 #define SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 27 
 28 #include &quot;gc/shared/markBitMap.hpp&quot;
<span class="line-added"> 29 #include &quot;gc/shenandoah/shenandoahRootVerifier.hpp&quot;</span>
 30 #include &quot;memory/allocation.hpp&quot;
 31 #include &quot;oops/oopsHierarchy.hpp&quot;
 32 #include &quot;utilities/stack.hpp&quot;
 33 
 34 class ShenandoahHeap;
 35 
 36 #ifdef _WINDOWS
 37 #pragma warning( disable : 4522 )
 38 #endif
 39 
 40 class ShenandoahVerifierTask {
 41 public:
 42   ShenandoahVerifierTask(oop o = NULL, int idx = 0): _obj(o) { }
 43   ShenandoahVerifierTask(oop o, size_t idx): _obj(o) { }
 44   ShenandoahVerifierTask(const ShenandoahVerifierTask&amp; t): _obj(t._obj) { }
 45 
 46   ShenandoahVerifierTask&amp; operator =(const ShenandoahVerifierTask&amp; t) {
 47     _obj = t._obj;
 48     return *this;
 49   }
</pre>
<hr />
<pre>
 58 private:
 59   oop _obj;
 60 };
 61 
 62 typedef Stack&lt;ShenandoahVerifierTask, mtGC&gt; ShenandoahVerifierStack;
 63 typedef volatile juint ShenandoahLivenessData;
 64 
 65 class ShenandoahVerifier : public CHeapObj&lt;mtGC&gt; {
 66 private:
 67   ShenandoahHeap* _heap;
 68   MarkBitMap* _verification_bit_map;
 69 public:
 70   typedef enum {
 71     // Disable marked objects verification.
 72     _verify_marked_disable,
 73 
 74     // Objects should be marked in &quot;next&quot; bitmap.
 75     _verify_marked_incomplete,
 76 
 77     // Objects should be marked in &quot;complete&quot; bitmap.
<span class="line-modified"> 78     _verify_marked_complete</span>
 79   } VerifyMarked;
 80 
 81   typedef enum {
 82     // Disable forwarded objects verification.
 83     _verify_forwarded_disable,
 84 
 85     // Objects should not have forwardees.
 86     _verify_forwarded_none,
 87 
 88     // Objects may have forwardees.
<span class="line-modified"> 89     _verify_forwarded_allow</span>
 90   } VerifyForwarded;
 91 
 92   typedef enum {
 93     // Disable collection set verification.
 94     _verify_cset_disable,
 95 
 96     // Should have no references to cset.
 97     _verify_cset_none,
 98 
 99     // May have references to cset, all should be forwarded.
100     // Note: Allowing non-forwarded references to cset is equivalent
101     // to _verify_cset_disable.
<span class="line-modified">102     _verify_cset_forwarded</span>
103   } VerifyCollectionSet;
104 
105   typedef enum {
106     // Disable liveness verification
107     _verify_liveness_disable,
108 
109     // All objects should belong to live regions
110     _verify_liveness_conservative,
111 
112     // All objects should belong to live regions,
113     // and liveness data should be accurate
<span class="line-modified">114     _verify_liveness_complete</span>
115   } VerifyLiveness;
116 
117   typedef enum {
118     // Disable region verification
119     _verify_regions_disable,
120 
121     // No trash regions allowed
122     _verify_regions_notrash,
123 
124     // No collection set regions allowed
125     _verify_regions_nocset,
126 
127     // No trash and no cset regions allowed
<span class="line-modified">128     _verify_regions_notrash_nocset</span>
129   } VerifyRegions;
130 
131   typedef enum {
132     // Disable gc-state verification
133     _verify_gcstate_disable,
134 
135     // Nothing is in progress, no forwarded objects
136     _verify_gcstate_stable,
137 
138     // Nothing is in progress, some objects are forwarded
139     _verify_gcstate_forwarded,
<span class="line-added">140 </span>
<span class="line-added">141     // Evacuation is in progress, some objects are forwarded</span>
<span class="line-added">142     _verify_gcstate_evacuation</span>
143   } VerifyGCState;
144 
<span class="line-added">145   typedef enum {</span>
<span class="line-added">146     _verify_all_weak_roots,</span>
<span class="line-added">147     _verify_serial_weak_roots,</span>
<span class="line-added">148     _verify_concurrent_weak_roots</span>
<span class="line-added">149   } VerifyWeakRoots;</span>
<span class="line-added">150 </span>
151   struct VerifyOptions {
152     VerifyForwarded     _verify_forwarded;
153     VerifyMarked        _verify_marked;
154     VerifyCollectionSet _verify_cset;
155     VerifyLiveness      _verify_liveness;
156     VerifyRegions       _verify_regions;
157     VerifyGCState       _verify_gcstate;
<span class="line-added">158     VerifyWeakRoots     _verify_weak_roots;</span>
159 
160     VerifyOptions(VerifyForwarded verify_forwarded,
161                   VerifyMarked verify_marked,
162                   VerifyCollectionSet verify_collection_set,
163                   VerifyLiveness verify_liveness,
164                   VerifyRegions verify_regions,
<span class="line-modified">165                   VerifyGCState verify_gcstate,</span>
<span class="line-added">166                   VerifyWeakRoots verify_weak_roots = _verify_all_weak_roots) :</span>
167             _verify_forwarded(verify_forwarded), _verify_marked(verify_marked),
168             _verify_cset(verify_collection_set),
169             _verify_liveness(verify_liveness), _verify_regions(verify_regions),
<span class="line-modified">170             _verify_gcstate(verify_gcstate),</span>
<span class="line-added">171             _verify_weak_roots(verify_weak_roots) {}</span>
172   };
173 
174 private:
175   void verify_at_safepoint(const char *label,
176                            VerifyForwarded forwarded,
177                            VerifyMarked marked,
178                            VerifyCollectionSet cset,
179                            VerifyLiveness liveness,
180                            VerifyRegions regions,
<span class="line-modified">181                            VerifyGCState gcstate,</span>
<span class="line-added">182                            VerifyWeakRoots weakRoots);</span>
183 
184 public:
185   ShenandoahVerifier(ShenandoahHeap* heap, MarkBitMap* verification_bitmap) :
186           _heap(heap), _verification_bit_map(verification_bitmap) {};
187 
188   void verify_before_concmark();
189   void verify_after_concmark();
190   void verify_before_evacuation();
<span class="line-added">191   void verify_during_evacuation();</span>
192   void verify_after_evacuation();
193   void verify_before_updaterefs();
194   void verify_after_updaterefs();
195   void verify_before_fullgc();
196   void verify_after_fullgc();
197   void verify_before_traversal();
198   void verify_after_traversal();
199   void verify_after_degenerated();
200   void verify_generic(VerifyOption option);
<span class="line-added">201 </span>
<span class="line-added">202   // Roots should only contain to-space oops</span>
<span class="line-added">203   void verify_roots_in_to_space();</span>
<span class="line-added">204   void verify_roots_in_to_space_except(ShenandoahRootVerifier::RootTypes types);</span>
<span class="line-added">205 </span>
<span class="line-added">206   void verify_roots_no_forwarded();</span>
<span class="line-added">207   void verify_roots_no_forwarded_except(ShenandoahRootVerifier::RootTypes types);</span>
208 };
209 
210 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahVerifier.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahWorkGroup.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>