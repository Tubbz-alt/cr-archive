<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahHeapRegion.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahHeapRegion.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahHeapRegion.inline.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahHeapRegion.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2018, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,17 +28,18 @@</span>
  #include &quot;gc/shared/space.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahAllocRequest.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahAsserts.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahHeap.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahPacer.hpp&quot;
<span class="udiff-line-removed">- #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;utilities/sizes.hpp&quot;
  
  class VMStructs;
<span class="udiff-line-added">+ class ShenandoahHeapRegionStateConstant;</span>
  
  class ShenandoahHeapRegion : public ContiguousSpace {
    friend class VMStructs;
<span class="udiff-line-added">+   friend class ShenandoahHeapRegionStateConstant;</span>
  private:
    /*
      Region state is described by a state machine. Transitions are guarded by
      heap lock, which allows changing the state of several regions atomically.
      Region states can be logically aggregated in groups.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,13 +116,14 @@</span>
      _pinned_humongous_start,  // region is both humongous start and pinned
      _cset,                    // region is in collection set
      _pinned,                  // region is pinned
      _pinned_cset,             // region is pinned and in cset (evac failure path)
      _trash,                   // region contains only trash
<span class="udiff-line-added">+     _REGION_STATES_NUM        // last</span>
    };
  
<span class="udiff-line-modified-removed">-   const char* region_state_to_string(RegionState s) const {</span>
<span class="udiff-line-modified-added">+   static const char* region_state_to_string(RegionState s) {</span>
      switch (s) {
        case _empty_uncommitted:       return &quot;Empty Uncommitted&quot;;
        case _empty_committed:         return &quot;Empty Committed&quot;;
        case _regular:                 return &quot;Regular&quot;;
        case _humongous_start:         return &quot;Humongous Start&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -156,10 +159,14 @@</span>
    }
  
    void report_illegal_transition(const char* method);
  
  public:
<span class="udiff-line-added">+   static const int region_states_num() {</span>
<span class="udiff-line-added">+     return _REGION_STATES_NUM;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    // Allowed transitions from the outside code:
    void make_regular_allocation();
    void make_regular_bypass();
    void make_humongous_start();
    void make_humongous_cont();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -190,15 +197,19 @@</span>
    bool is_cset()                   const { return _state == _cset   || _state == _pinned_cset; }
    bool is_pinned()                 const { return _state == _pinned || _state == _pinned_cset || _state == _pinned_humongous_start; }
  
    // Macro-properties:
    bool is_alloc_allowed()          const { return is_empty() || is_regular() || _state == _pinned; }
<span class="udiff-line-modified-removed">-   bool is_move_allowed()           const { return is_regular() || _state == _cset || (ShenandoahHumongousMoves &amp;&amp; _state == _humongous_start); }</span>
<span class="udiff-line-modified-added">+   bool is_stw_move_allowed()       const { return is_regular() || _state == _cset || (ShenandoahHumongousMoves &amp;&amp; _state == _humongous_start); }</span>
  
    RegionState state()              const { return _state; }
    int  state_ordinal()             const { return region_state_to_ordinal(_state); }
  
<span class="udiff-line-added">+   void record_pin();</span>
<span class="udiff-line-added">+   void record_unpin();</span>
<span class="udiff-line-added">+   size_t pin_count() const;</span>
<span class="udiff-line-added">+ </span>
  private:
    static size_t RegionCount;
    static size_t RegionSizeBytes;
    static size_t RegionSizeWords;
    static size_t RegionSizeBytesShift;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,11 +241,10 @@</span>
    MemRegion _reserved;
    size_t _region_number;
  
    // Rarely updated fields
    HeapWord* _new_top;
<span class="udiff-line-removed">-   size_t _critical_pins;</span>
    double _empty_time;
  
    // Seldom updated fields
    RegionState _state;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -247,20 +257,21 @@</span>
    uint64_t _seqnum_first_alloc_gc;
    uint64_t _seqnum_last_alloc_mutator;
    uint64_t _seqnum_last_alloc_gc;
  
    volatile size_t _live_data;
<span class="udiff-line-added">+   volatile size_t _critical_pins;</span>
  
    // Claim some space at the end to protect next region
    DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, 0);
  
  public:
    ShenandoahHeapRegion(ShenandoahHeap* heap, HeapWord* start, size_t size_words, size_t index, bool committed);
  
    static const size_t MIN_NUM_REGIONS = 10;
  
<span class="udiff-line-modified-removed">-   static void setup_sizes(size_t initial_heap_size, size_t max_heap_size);</span>
<span class="udiff-line-modified-added">+   static void setup_sizes(size_t max_heap_size);</span>
  
    double empty_time() {
      return _empty_time;
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -423,8 +434,10 @@</span>
  
    void oop_iterate_objects(OopIterateClosure* cl);
    void oop_iterate_humongous(OopIterateClosure* cl);
  
    inline void internal_increase_live_data(size_t s);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void set_state(RegionState to);</span>
  };
  
  #endif // SHARE_GC_SHENANDOAH_SHENANDOAHHEAPREGION_HPP
</pre>
<center><a href="shenandoahHeapRegion.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahHeapRegion.inline.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>