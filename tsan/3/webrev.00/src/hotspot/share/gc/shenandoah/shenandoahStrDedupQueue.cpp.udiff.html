<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahStrDedupQueue.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahSharedVariables.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStrDedupQueue.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahStrDedupQueue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
   * Copyright (c) 2017, 2019, Red Hat, Inc. All rights reserved.
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,31 +47,31 @@</span>
      _producer_queues[index] = NULL;
    }
  }
  
  ShenandoahStrDedupQueue::~ShenandoahStrDedupQueue() {
<span class="udiff-line-modified-removed">-   MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
    for (size_t index = 0; index &lt; num_queues(); index ++) {
      release_buffers(queue_at(index));
    }
  
    release_buffers(_free_list);
    FREE_C_HEAP_ARRAY(ShenandoahQueueBuffer*, _producer_queues);
  }
  
  void ShenandoahStrDedupQueue::wait_impl() {
<span class="udiff-line-modified-removed">-   MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
    while (_consumer_queue == NULL &amp;&amp; !_cancel) {
<span class="udiff-line-modified-removed">-     ml.wait(Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     ml.wait();</span>
      assert(_consumer_queue == NULL, &quot;Why wait?&quot;);
      _consumer_queue = _published_queues;
      _published_queues = NULL;
    }
  }
  
  void ShenandoahStrDedupQueue::cancel_wait_impl() {
<span class="udiff-line-modified-removed">-   MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
    _cancel = true;
    ml.notify();
  }
  
  void ShenandoahStrDedupQueue::unlink_or_oops_do_impl(StringDedupUnlinkOrOopsDoClosure* cl, size_t queue) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -103,15 +104,15 @@</span>
    assert(ShenandoahStringDedup::is_candidate(string_oop), &quot;Not a candidate&quot;);
  
    ShenandoahQueueBuffer* buf = queue_at((size_t)worker_id);
  
    if (buf == NULL) {
<span class="udiff-line-modified-removed">-     MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
      buf = new_buffer();
      set_producer_buffer(buf, worker_id);
    } else if (buf-&gt;is_full()) {
<span class="udiff-line-modified-removed">-     MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
      buf-&gt;set_next(_published_queues);
      _published_queues = buf;
      buf = new_buffer();
      set_producer_buffer(buf, worker_id);
      ml.notify();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,11 +124,11 @@</span>
  
  oop ShenandoahStrDedupQueue::pop_impl() {
    assert(Thread::current() == StringDedupThread::thread(), &quot;Must be dedup thread&quot;);
    while (true) {
      if (_consumer_queue == NULL) {
<span class="udiff-line-modified-removed">-       MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+       MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
        _consumer_queue = _published_queues;
        _published_queues = NULL;
      }
  
      // there is nothing
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -161,11 +162,11 @@</span>
      }
      obj = _consumer_queue-&gt;pop();
    } while (obj == NULL);
  
    if (to_release != NULL) {
<span class="udiff-line-modified-removed">-     MonitorLockerEx ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+     MonitorLocker ml(StringDedupQueue_lock, Mutex::_no_safepoint_check_flag);</span>
      release_buffers(to_release);
    }
  
    return suc;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -203,12 +204,15 @@</span>
  }
  
  void ShenandoahStrDedupQueue::print_statistics_impl() {
    Log(gc, stringdedup) log;
    log.debug(&quot;  Queue:&quot;);
<span class="udiff-line-modified-removed">-   log.debug(&quot;    Total buffers: &quot; SIZE_FORMAT &quot; (&quot; SIZE_FORMAT &quot; K). &quot; SIZE_FORMAT &quot; buffers are on free list&quot;,</span>
<span class="udiff-line-modified-removed">-     _total_buffers, (_total_buffers * sizeof(ShenandoahQueueBuffer) / K), _num_free_buffer);</span>
<span class="udiff-line-modified-added">+   log.debug(&quot;    Total buffers: &quot; SIZE_FORMAT &quot; (&quot; SIZE_FORMAT &quot; %s). &quot; SIZE_FORMAT &quot; buffers are on free list&quot;,</span>
<span class="udiff-line-modified-added">+     _total_buffers,</span>
<span class="udiff-line-added">+     byte_size_in_proper_unit(_total_buffers * sizeof(ShenandoahQueueBuffer)),</span>
<span class="udiff-line-added">+     proper_unit_for_byte_size(_total_buffers * sizeof(ShenandoahQueueBuffer)),</span>
<span class="udiff-line-added">+     _num_free_buffer);</span>
  }
  
  class VerifyQueueClosure : public OopClosure {
  private:
    ShenandoahHeap* _heap;
</pre>
<center><a href="shenandoahSharedVariables.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStrDedupQueue.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>