<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/c2/shenandoahBarrierSetC2.hpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahBarrierSetC2.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="shenandoahSupport.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahBarrierSetC2.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,18 +29,25 @@</span>
  #include &quot;gc/shenandoah/c2/shenandoahSupport.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
  
  class ShenandoahBarrierSetC2State : public ResourceObj {
  private:
<span class="udiff-line-modified-removed">-   GrowableArray&lt;ShenandoahWriteBarrierNode*&gt;* _shenandoah_barriers;</span>
<span class="udiff-line-modified-added">+   GrowableArray&lt;ShenandoahEnqueueBarrierNode*&gt;* _enqueue_barriers;</span>
<span class="udiff-line-added">+   GrowableArray&lt;ShenandoahLoadReferenceBarrierNode*&gt;* _load_reference_barriers;</span>
  
  public:
    ShenandoahBarrierSetC2State(Arena* comp_arena);
<span class="udiff-line-modified-removed">-   int shenandoah_barriers_count() const;</span>
<span class="udiff-line-modified-removed">-   ShenandoahWriteBarrierNode* shenandoah_barrier(int idx) const;</span>
<span class="udiff-line-modified-removed">-   void add_shenandoah_barrier(ShenandoahWriteBarrierNode * n);</span>
<span class="udiff-line-modified-removed">-   void remove_shenandoah_barrier(ShenandoahWriteBarrierNode * n);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int enqueue_barriers_count() const;</span>
<span class="udiff-line-modified-added">+   ShenandoahEnqueueBarrierNode* enqueue_barrier(int idx) const;</span>
<span class="udiff-line-modified-added">+   void add_enqueue_barrier(ShenandoahEnqueueBarrierNode* n);</span>
<span class="udiff-line-added">+   void remove_enqueue_barrier(ShenandoahEnqueueBarrierNode * n);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   int load_reference_barriers_count() const;</span>
<span class="udiff-line-added">+   ShenandoahLoadReferenceBarrierNode* load_reference_barrier(int idx) const;</span>
<span class="udiff-line-added">+   void add_load_reference_barrier(ShenandoahLoadReferenceBarrierNode* n);</span>
<span class="udiff-line-added">+   void remove_load_reference_barrier(ShenandoahLoadReferenceBarrierNode * n);</span>
  };
  
  class ShenandoahBarrierSetC2 : public BarrierSetC2 {
  private:
    void shenandoah_eliminate_wb_pre(Node* call, PhaseIterGVN* igvn) const;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -64,24 +72,18 @@</span>
                                      const TypeOopPtr* val_type,
                                      Node* pre_val,
                                      BasicType bt) const;
  
    Node* shenandoah_enqueue_barrier(GraphKit* kit, Node* val) const;
<span class="udiff-line-removed">-   Node* shenandoah_read_barrier(GraphKit* kit, Node* obj) const;</span>
    Node* shenandoah_storeval_barrier(GraphKit* kit, Node* obj) const;
<span class="udiff-line-removed">-   Node* shenandoah_write_barrier(GraphKit* kit, Node* obj) const;</span>
<span class="udiff-line-removed">-   Node* shenandoah_read_barrier_impl(GraphKit* kit, Node* obj, bool use_ctrl, bool use_mem, bool allow_fromspace) const;</span>
<span class="udiff-line-removed">-   Node* shenandoah_write_barrier_impl(GraphKit* kit, Node* obj) const;</span>
<span class="udiff-line-removed">-   Node* shenandoah_write_barrier_helper(GraphKit* kit, Node* obj, const TypePtr* adr_type) const;</span>
  
    void insert_pre_barrier(GraphKit* kit, Node* base_oop, Node* offset,
                            Node* pre_val, bool need_mem_bar) const;
  
<span class="udiff-line-modified-removed">-   static bool clone_needs_postbarrier(ArrayCopyNode *ac, PhaseIterGVN&amp; igvn);</span>
<span class="udiff-line-modified-added">+   static bool clone_needs_barrier(Node* src, PhaseGVN&amp; gvn);</span>
  
  protected:
<span class="udiff-line-removed">-   virtual void resolve_address(C2Access&amp; access) const;</span>
    virtual Node* load_at_resolved(C2Access&amp; access, const Type* val_type) const;
    virtual Node* store_at_resolved(C2Access&amp; access, C2AccessValue&amp; val) const;
    virtual Node* atomic_cmpxchg_val_at_resolved(C2AtomicParseAccess&amp; access, Node* expected_val,
                                                 Node* new_val, const Type* val_type) const;
    virtual Node* atomic_cmpxchg_bool_at_resolved(C2AtomicParseAccess&amp; access, Node* expected_val,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,34 +92,27 @@</span>
  
  public:
    static ShenandoahBarrierSetC2* bsc2();
  
    static bool is_shenandoah_wb_pre_call(Node* call);
<span class="udiff-line-modified-removed">-   static bool is_shenandoah_wb_call(Node* call);</span>
<span class="udiff-line-modified-added">+   static bool is_shenandoah_lrb_call(Node* call);</span>
    static bool is_shenandoah_marking_if(PhaseTransform *phase, Node* n);
    static bool is_shenandoah_state_load(Node* n);
    static bool has_only_shenandoah_wb_pre_uses(Node* n);
  
    ShenandoahBarrierSetC2State* state() const;
  
    static const TypeFunc* write_ref_field_pre_entry_Type();
    static const TypeFunc* shenandoah_clone_barrier_Type();
<span class="udiff-line-modified-removed">-   static const TypeFunc* shenandoah_write_barrier_Type();</span>
<span class="udiff-line-modified-added">+   static const TypeFunc* shenandoah_load_reference_barrier_Type();</span>
<span class="udiff-line-added">+   virtual bool has_load_barrier_nodes() const { return true; }</span>
  
    // This is the entry-point for the backend to perform accesses through the Access API.
<span class="udiff-line-modified-removed">-   virtual void clone(GraphKit* kit, Node* src, Node* dst, Node* size, bool is_array) const;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   virtual Node* resolve(GraphKit* kit, Node* n, DecoratorSet decorators) const;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   virtual Node* obj_allocate(PhaseMacroExpand* macro, Node* ctrl, Node* mem, Node* toobig_false, Node* size_in_bytes,</span>
<span class="udiff-line-removed">-                              Node*&amp; i_o, Node*&amp; needgc_ctrl,</span>
<span class="udiff-line-removed">-                              Node*&amp; fast_oop_ctrl, Node*&amp; fast_oop_rawmem,</span>
<span class="udiff-line-removed">-                              intx prefetch_lines) const;</span>
<span class="udiff-line-modified-added">+   virtual void clone_at_expansion(PhaseMacroExpand* phase, ArrayCopyNode* ac) const;</span>
  
    // These are general helper methods used by C2
    virtual bool array_copy_requires_gc_barriers(bool tightly_coupled_alloc, BasicType type, bool is_clone, ArrayCopyPhase phase) const;
<span class="udiff-line-removed">-   virtual void clone_barrier_at_expansion(ArrayCopyNode* ac, Node* call, PhaseIterGVN&amp; igvn) const;</span>
  
    // Support for GC barriers emitted during parsing
    virtual bool is_gc_barrier_node(Node* node) const;
    virtual Node* step_over_gc_barrier(Node* c) const;
    virtual bool expand_barriers(Compile* C, PhaseIterGVN&amp; igvn) const;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -129,11 +124,10 @@</span>
    virtual void register_potential_barrier_node(Node* node) const;
    virtual void unregister_potential_barrier_node(Node* node) const;
    virtual void eliminate_gc_barrier(PhaseMacroExpand* macro, Node* node) const;
    virtual void enqueue_useful_gc_barrier(PhaseIterGVN* igvn, Node* node) const;
    virtual void eliminate_useless_gc_barriers(Unique_Node_List &amp;useful, Compile* C) const;
<span class="udiff-line-removed">-   virtual void add_users_to_worklist(Unique_Node_List* worklist) const;</span>
  
    // Allow barrier sets to have shared state that is preserved across a compilation unit.
    // This could for example comprise macro nodes to be expanded during macro expansion.
    virtual void* create_barrier_state(Arena* comp_arena) const;
    // If the BarrierSetC2 state has kept macro nodes in its compilation unit state to be
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,33 +136,17 @@</span>
  
  #ifdef ASSERT
    virtual void verify_gc_barriers(Compile* compile, CompilePhase phase) const;
  #endif
  
<span class="udiff-line-removed">-   virtual bool flatten_gc_alias_type(const TypePtr*&amp; adr_type) const;</span>
<span class="udiff-line-removed">- #ifdef ASSERT</span>
<span class="udiff-line-removed">-   virtual bool verify_gc_alias_type(const TypePtr* adr_type, int offset) const;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
    virtual Node* ideal_node(PhaseGVN* phase, Node* n, bool can_reshape) const;
<span class="udiff-line-removed">-   virtual Node* identity_node(PhaseGVN* phase, Node* n) const;</span>
    virtual bool final_graph_reshaping(Compile* compile, Node* n, uint opcode) const;
  
    virtual bool escape_add_to_con_graph(ConnectionGraph* conn_graph, PhaseGVN* gvn, Unique_Node_List* delayed_worklist, Node* n, uint opcode) const;
    virtual bool escape_add_final_edges(ConnectionGraph* conn_graph, PhaseGVN* gvn, Node* n, uint opcode) const;
    virtual bool escape_has_out_with_unsafe_object(Node* n) const;
<span class="udiff-line-removed">-   virtual bool escape_is_barrier_node(Node* n) const;</span>
  
<span class="udiff-line-removed">-   virtual bool matcher_find_shared_visit(Matcher* matcher, Matcher::MStack&amp; mstack, Node* n, uint opcode, bool&amp; mem_op, int&amp; mem_addr_idx) const;</span>
    virtual bool matcher_find_shared_post_visit(Matcher* matcher, Node* n, uint opcode) const;
    virtual bool matcher_is_store_load_barrier(Node* x, uint xop) const;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   virtual void igvn_add_users_to_worklist(PhaseIterGVN* igvn, Node* use) const;</span>
<span class="udiff-line-removed">-   virtual void ccp_analyze(PhaseCCP* ccp, Unique_Node_List&amp; worklist, Node* use) const;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   virtual bool has_special_unique_user(const Node* node) const;</span>
<span class="udiff-line-removed">-   virtual Node* split_if_pre(PhaseIdealLoop* phase, Node* n) const;</span>
<span class="udiff-line-removed">-   virtual bool build_loop_late_post(PhaseIdealLoop* phase, Node* n) const;</span>
<span class="udiff-line-removed">-   virtual bool sink_node(PhaseIdealLoop* phase, Node* n, Node* x, Node* x_ctrl, Node* n_ctrl) const;</span>
  };
  
  #endif // SHARE_GC_SHENANDOAH_C2_SHENANDOAHBARRIERSETC2_HPP
</pre>
<center><a href="shenandoahBarrierSetC2.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="shenandoahSupport.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>