<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahCodeRoots.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahCodeRoots.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahCollectionSet.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahCodeRoots.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>

  3  *
  4  * This code is free software; you can redistribute it and/or modify it
  5  * under the terms of the GNU General Public License version 2 only, as
  6  * published by the Free Software Foundation.
  7  *
  8  * This code is distributed in the hope that it will be useful, but WITHOUT
  9  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11  * version 2 for more details (a copy is included in the LICENSE file that
 12  * accompanied this code).
 13  *
 14  * You should have received a copy of the GNU General Public License version
 15  * 2 along with this work; if not, write to the Free Software Foundation,
 16  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17  *
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  *
 22  */
 23 
 24 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 25 #define SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 26 
 27 #include &quot;code/codeCache.hpp&quot;
 28 #include &quot;gc/shenandoah/shenandoahSharedVariables.hpp&quot;


 29 #include &quot;memory/allocation.hpp&quot;
 30 #include &quot;memory/iterator.hpp&quot;

 31 
 32 class ShenandoahHeap;
 33 class ShenandoahHeapRegion;
<span class="line-removed"> 34 class ShenandoahCodeRootsLock;</span>
 35 
 36 class ShenandoahParallelCodeHeapIterator {
 37   friend class CodeCache;
 38 private:
 39   CodeHeap*     _heap;
 40   DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));
 41   volatile int  _claimed_idx;
 42   volatile bool _finished;
 43   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);
 44 public:
 45   ShenandoahParallelCodeHeapIterator(CodeHeap* heap);
 46   void parallel_blobs_do(CodeBlobClosure* f);
 47 };
 48 
 49 class ShenandoahParallelCodeCacheIterator {
 50   friend class CodeCache;
 51 private:
 52   ShenandoahParallelCodeHeapIterator* _iters;
 53   int                       _length;



 54 public:
 55   ShenandoahParallelCodeCacheIterator(const GrowableArray&lt;CodeHeap*&gt;* heaps);
 56   ~ShenandoahParallelCodeCacheIterator();
 57   void parallel_blobs_do(CodeBlobClosure* f);
 58 };
 59 
<span class="line-removed"> 60 // ShenandoahNMethod tuple records the internal locations of oop slots within the nmethod.</span>
<span class="line-removed"> 61 // This allows us to quickly scan the oops without doing the nmethod-internal scans, that</span>
<span class="line-removed"> 62 // sometimes involves parsing the machine code. Note it does not record the oops themselves,</span>
<span class="line-removed"> 63 // because it would then require handling these tuples as the new class of roots.</span>
<span class="line-removed"> 64 class ShenandoahNMethod : public CHeapObj&lt;mtGC&gt; {</span>
<span class="line-removed"> 65 private:</span>
<span class="line-removed"> 66   nmethod* _nm;</span>
<span class="line-removed"> 67   oop**    _oops;</span>
<span class="line-removed"> 68   int      _oops_count;</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70 public:</span>
<span class="line-removed"> 71   ShenandoahNMethod(nmethod *nm, GrowableArray&lt;oop*&gt;* oops);</span>
<span class="line-removed"> 72   ~ShenandoahNMethod();</span>
<span class="line-removed"> 73 </span>
<span class="line-removed"> 74   nmethod* nm() {</span>
<span class="line-removed"> 75     return _nm;</span>
<span class="line-removed"> 76   }</span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78   bool has_cset_oops(ShenandoahHeap* heap);</span>
<span class="line-removed"> 79 </span>
<span class="line-removed"> 80   void assert_alive_and_correct() NOT_DEBUG_RETURN;</span>
<span class="line-removed"> 81   void assert_same_oops(GrowableArray&lt;oop*&gt;* oops) NOT_DEBUG_RETURN;</span>
<span class="line-removed"> 82 </span>
<span class="line-removed"> 83   static bool find_with_nmethod(void* nm, ShenandoahNMethod* other) {</span>
<span class="line-removed"> 84     return other-&gt;_nm == nm;</span>
<span class="line-removed"> 85   }</span>
<span class="line-removed"> 86 };</span>
<span class="line-removed"> 87 </span>
 88 class ShenandoahCodeRootsIterator {
 89   friend class ShenandoahCodeRoots;
 90 protected:
<span class="line-removed"> 91   ShenandoahHeap* _heap;</span>
 92   ShenandoahParallelCodeCacheIterator _par_iterator;
 93   ShenandoahSharedFlag _seq_claimed;
<span class="line-modified"> 94   DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile size_t));</span>
<span class="line-modified"> 95   volatile size_t _claimed;</span>
<span class="line-removed"> 96   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);</span>
 97 protected:
 98   ShenandoahCodeRootsIterator();
 99   ~ShenandoahCodeRootsIterator();
100 
101   template&lt;bool CSET_FILTER&gt;
102   void dispatch_parallel_blobs_do(CodeBlobClosure *f);
103 
104   template&lt;bool CSET_FILTER&gt;
105   void fast_parallel_blobs_do(CodeBlobClosure *f);
106 };
107 
108 class ShenandoahAllCodeRootsIterator : public ShenandoahCodeRootsIterator {
109 public:
110   ShenandoahAllCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
111   void possibly_parallel_blobs_do(CodeBlobClosure *f);
112 };
113 
114 class ShenandoahCsetCodeRootsIterator : public ShenandoahCodeRootsIterator {
115 public:
116   ShenandoahCsetCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
117   void possibly_parallel_blobs_do(CodeBlobClosure* f);
118 };
119 
<span class="line-modified">120 class ShenandoahCodeRoots : public CHeapObj&lt;mtGC&gt; {</span>
121   friend class ShenandoahHeap;
<span class="line-removed">122   friend class ShenandoahCodeRootsLock;</span>
123   friend class ShenandoahCodeRootsIterator;
124 
125 public:
126   static void initialize();
<span class="line-modified">127   static void add_nmethod(nmethod* nm);</span>
<span class="line-modified">128   static void remove_nmethod(nmethod* nm);</span>
<span class="line-modified">129 </span>
<span class="line-removed">130   /**</span>
<span class="line-removed">131    * Provides the iterator over all nmethods in the code cache that have oops.</span>
<span class="line-removed">132    * @return</span>
<span class="line-removed">133    */</span>
<span class="line-removed">134   static ShenandoahAllCodeRootsIterator iterator();</span>
135 
<span class="line-modified">136   /**</span>
<span class="line-modified">137    * Provides the iterator over nmethods that have at least one oop in collection set.</span>
<span class="line-removed">138    * @return</span>
<span class="line-removed">139    */</span>
<span class="line-removed">140   static ShenandoahCsetCodeRootsIterator cset_iterator();</span>
<span class="line-removed">141 </span>
<span class="line-removed">142 private:</span>
<span class="line-removed">143   struct PaddedLock {</span>
<span class="line-removed">144     DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));</span>
<span class="line-removed">145     volatile int _lock;</span>
<span class="line-removed">146     DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);</span>
<span class="line-removed">147   };</span>
<span class="line-removed">148 </span>
<span class="line-removed">149   static PaddedLock _recorded_nms_lock;</span>
<span class="line-removed">150   static GrowableArray&lt;ShenandoahNMethod*&gt;* _recorded_nms;</span>
<span class="line-removed">151 </span>
<span class="line-removed">152   static void acquire_lock(bool write) {</span>
<span class="line-removed">153     volatile int* loc = &amp;_recorded_nms_lock._lock;</span>
<span class="line-removed">154     if (write) {</span>
<span class="line-removed">155       while ((OrderAccess::load_acquire(loc) != 0) ||</span>
<span class="line-removed">156              Atomic::cmpxchg(-1, loc, 0) != 0) {</span>
<span class="line-removed">157         SpinPause();</span>
<span class="line-removed">158       }</span>
<span class="line-removed">159       assert (*loc == -1, &quot;acquired for write&quot;);</span>
<span class="line-removed">160     } else {</span>
<span class="line-removed">161       while (true) {</span>
<span class="line-removed">162         int cur = OrderAccess::load_acquire(loc);</span>
<span class="line-removed">163         if (cur &gt;= 0) {</span>
<span class="line-removed">164           if (Atomic::cmpxchg(cur + 1, loc, cur) == cur) {</span>
<span class="line-removed">165             // Success!</span>
<span class="line-removed">166             assert (*loc &gt; 0, &quot;acquired for read&quot;);</span>
<span class="line-removed">167             return;</span>
<span class="line-removed">168           }</span>
<span class="line-removed">169         }</span>
<span class="line-removed">170         SpinPause();</span>
<span class="line-removed">171       }</span>
<span class="line-removed">172     }</span>
173   }
174 
<span class="line-modified">175   static void release_lock(bool write) {</span>
<span class="line-modified">176     volatile int* loc = &amp;ShenandoahCodeRoots::_recorded_nms_lock._lock;</span>
<span class="line-modified">177     if (write) {</span>
<span class="line-modified">178       OrderAccess::release_store_fence(loc, 0);</span>
<span class="line-modified">179     } else {</span>
<span class="line-modified">180       Atomic::dec(loc);</span>
<span class="line-removed">181     }</span>
<span class="line-removed">182   }</span>
<span class="line-removed">183 };</span>
184 
<span class="line-removed">185 // Very simple unranked read-write lock</span>
<span class="line-removed">186 class ShenandoahCodeRootsLock : public StackObj {</span>
<span class="line-removed">187   friend class ShenandoahCodeRoots;</span>
188 private:
<span class="line-modified">189   const bool _write;</span>
<span class="line-modified">190 public:</span>
<span class="line-removed">191   ShenandoahCodeRootsLock(bool write) : _write(write) {</span>
<span class="line-removed">192     ShenandoahCodeRoots::acquire_lock(write);</span>
<span class="line-removed">193   }</span>
<span class="line-removed">194 </span>
<span class="line-removed">195   ~ShenandoahCodeRootsLock() {</span>
<span class="line-removed">196     ShenandoahCodeRoots::release_lock(_write);</span>
<span class="line-removed">197   }</span>
198 };
199 
200 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="line-added">  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 26 #define SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 27 
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;gc/shenandoah/shenandoahSharedVariables.hpp&quot;
<span class="line-added"> 30 #include &quot;gc/shenandoah/shenandoahLock.hpp&quot;</span>
<span class="line-added"> 31 #include &quot;gc/shenandoah/shenandoahNMethod.hpp&quot;</span>
 32 #include &quot;memory/allocation.hpp&quot;
 33 #include &quot;memory/iterator.hpp&quot;
<span class="line-added"> 34 #include &quot;utilities/globalDefinitions.hpp&quot;</span>
 35 
 36 class ShenandoahHeap;
 37 class ShenandoahHeapRegion;

 38 
 39 class ShenandoahParallelCodeHeapIterator {
 40   friend class CodeCache;
 41 private:
 42   CodeHeap*     _heap;
 43   DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));
 44   volatile int  _claimed_idx;
 45   volatile bool _finished;
 46   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);
 47 public:
 48   ShenandoahParallelCodeHeapIterator(CodeHeap* heap);
 49   void parallel_blobs_do(CodeBlobClosure* f);
 50 };
 51 
 52 class ShenandoahParallelCodeCacheIterator {
 53   friend class CodeCache;
 54 private:
 55   ShenandoahParallelCodeHeapIterator* _iters;
 56   int                       _length;
<span class="line-added"> 57 </span>
<span class="line-added"> 58   NONCOPYABLE(ShenandoahParallelCodeCacheIterator);</span>
<span class="line-added"> 59 </span>
 60 public:
 61   ShenandoahParallelCodeCacheIterator(const GrowableArray&lt;CodeHeap*&gt;* heaps);
 62   ~ShenandoahParallelCodeCacheIterator();
 63   void parallel_blobs_do(CodeBlobClosure* f);
 64 };
 65 




























 66 class ShenandoahCodeRootsIterator {
 67   friend class ShenandoahCodeRoots;
 68 protected:

 69   ShenandoahParallelCodeCacheIterator _par_iterator;
 70   ShenandoahSharedFlag _seq_claimed;
<span class="line-modified"> 71   ShenandoahNMethodTableSnapshot* _table_snapshot;</span>
<span class="line-modified"> 72 </span>

 73 protected:
 74   ShenandoahCodeRootsIterator();
 75   ~ShenandoahCodeRootsIterator();
 76 
 77   template&lt;bool CSET_FILTER&gt;
 78   void dispatch_parallel_blobs_do(CodeBlobClosure *f);
 79 
 80   template&lt;bool CSET_FILTER&gt;
 81   void fast_parallel_blobs_do(CodeBlobClosure *f);
 82 };
 83 
 84 class ShenandoahAllCodeRootsIterator : public ShenandoahCodeRootsIterator {
 85 public:
 86   ShenandoahAllCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
 87   void possibly_parallel_blobs_do(CodeBlobClosure *f);
 88 };
 89 
 90 class ShenandoahCsetCodeRootsIterator : public ShenandoahCodeRootsIterator {
 91 public:
 92   ShenandoahCsetCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
 93   void possibly_parallel_blobs_do(CodeBlobClosure* f);
 94 };
 95 
<span class="line-modified"> 96 class ShenandoahCodeRoots : public AllStatic {</span>
 97   friend class ShenandoahHeap;

 98   friend class ShenandoahCodeRootsIterator;
 99 
100 public:
101   static void initialize();
<span class="line-modified">102   static void register_nmethod(nmethod* nm);</span>
<span class="line-modified">103   static void unregister_nmethod(nmethod* nm);</span>
<span class="line-modified">104   static void flush_nmethod(nmethod* nm);</span>





105 
<span class="line-modified">106   static ShenandoahNMethodTable* table() {</span>
<span class="line-modified">107     return _nmethod_table;</span>



































108   }
109 
<span class="line-modified">110   // Concurrent nmethod unloading support</span>
<span class="line-modified">111   static void unlink(WorkGang* workers, bool unloading_occurred);</span>
<span class="line-modified">112   static void purge(WorkGang* workers);</span>
<span class="line-modified">113   static void arm_nmethods();</span>
<span class="line-modified">114   static int  disarmed_value()         { return _disarmed_value; }</span>
<span class="line-modified">115   static int* disarmed_value_address() { return &amp;_disarmed_value; }</span>



116 



117 private:
<span class="line-modified">118   static ShenandoahNMethodTable* _nmethod_table;</span>
<span class="line-modified">119   static int                     _disarmed_value;</span>







120 };
121 
122 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahCodeRoots.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahCollectionSet.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>