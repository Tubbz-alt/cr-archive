<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahMemoryPool.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahMetrics.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
   * Copyright (c) 2013, 2019, Red Hat, Inc. All rights reserved.
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,51 +126,55 @@</span>
    _used_after = _heap-&gt;used();
    _if_after = ShenandoahMetrics::internal_fragmentation();
    _ef_after = ShenandoahMetrics::external_fragmentation();
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahMetricsSnapshot::print() {</span>
<span class="udiff-line-modified-removed">-   log_info(gc, ergo)(&quot;Used: before: &quot; SIZE_FORMAT &quot;M, after: &quot; SIZE_FORMAT &quot;M&quot;, _used_before/M, _used_after/M);</span>
<span class="udiff-line-removed">-   log_info(gc, ergo)(&quot;Internal frag: before: %.1f%%, after: %.1f%%&quot;, _if_before * 100, _if_after * 100);</span>
<span class="udiff-line-removed">-   log_info(gc, ergo)(&quot;External frag: before: %.1f%%, after: %.1f%%&quot;, _ef_before * 100, _ef_after * 100);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool ShenandoahMetricsSnapshot::is_good_progress(const char *label) {</span>
<span class="udiff-line-removed">-   // Under the critical threshold? Declare failure.</span>
<span class="udiff-line-modified-added">+ bool ShenandoahMetricsSnapshot::is_good_progress() {</span>
<span class="udiff-line-modified-added">+   // Under the critical threshold?</span>
    size_t free_actual   = _heap-&gt;free_set()-&gt;available();
    size_t free_expected = _heap-&gt;max_capacity() / 100 * ShenandoahCriticalFreeThreshold;
<span class="udiff-line-modified-removed">-   if (free_actual &lt; free_expected) {</span>
<span class="udiff-line-modified-removed">-     log_info(gc, ergo)(&quot;Not enough free space (&quot; SIZE_FORMAT &quot;M, need &quot; SIZE_FORMAT &quot;M) after %s&quot;,</span>
<span class="udiff-line-modified-removed">-                        free_actual / M, free_expected / M, label);</span>
<span class="udiff-line-modified-added">+   bool prog_free = free_actual &gt;= free_expected;</span>
<span class="udiff-line-modified-added">+   log_info(gc, ergo)(&quot;%s progress for free space: &quot; SIZE_FORMAT &quot;%s, need &quot; SIZE_FORMAT &quot;%s&quot;,</span>
<span class="udiff-line-modified-added">+                      prog_free ? &quot;Good&quot; : &quot;Bad&quot;,</span>
<span class="udiff-line-added">+                      byte_size_in_proper_unit(free_actual),   proper_unit_for_byte_size(free_actual),</span>
<span class="udiff-line-added">+                      byte_size_in_proper_unit(free_expected), proper_unit_for_byte_size(free_expected));</span>
<span class="udiff-line-added">+   if (!prog_free) {</span>
      return false;
    }
  
<span class="udiff-line-modified-removed">-   // Freed up enough? Good! Declare victory.</span>
<span class="udiff-line-modified-added">+   // Freed up enough?</span>
    size_t progress_actual   = (_used_before &gt; _used_after) ? _used_before - _used_after : 0;
    size_t progress_expected = ShenandoahHeapRegion::region_size_bytes();
<span class="udiff-line-modified-removed">-   if (progress_actual &gt;= progress_expected) {</span>
<span class="udiff-line-modified-added">+   bool prog_used = progress_actual &gt;= progress_expected;</span>
<span class="udiff-line-added">+   log_info(gc, ergo)(&quot;%s progress for used space: &quot; SIZE_FORMAT &quot;%s, need &quot; SIZE_FORMAT &quot;%s&quot;,</span>
<span class="udiff-line-added">+                      prog_used ? &quot;Good&quot; : &quot;Bad&quot;,</span>
<span class="udiff-line-added">+                      byte_size_in_proper_unit(progress_actual),   proper_unit_for_byte_size(progress_actual),</span>
<span class="udiff-line-added">+                      byte_size_in_proper_unit(progress_expected), proper_unit_for_byte_size(progress_expected));</span>
<span class="udiff-line-added">+   if (prog_used) {</span>
      return true;
    }
<span class="udiff-line-removed">-   log_info(gc,ergo)(&quot;Not enough progress (&quot; SIZE_FORMAT &quot;M, need &quot; SIZE_FORMAT &quot;M) after %s&quot;,</span>
<span class="udiff-line-removed">-                     progress_actual / M, progress_expected / M, label);</span>
  
<span class="udiff-line-modified-removed">-   // Internal fragmentation is down? Good! Declare victory.</span>
<span class="udiff-line-modified-added">+   // Internal fragmentation is down?</span>
    double if_actual = _if_before - _if_after;
    double if_expected = 0.01; // 1% should be enough
<span class="udiff-line-modified-removed">-   if (if_actual &gt; if_expected) {</span>
<span class="udiff-line-modified-added">+   bool prog_if = if_actual &gt;= if_expected;</span>
<span class="udiff-line-added">+   log_info(gc, ergo)(&quot;%s progress for internal fragmentation: %.1f%%, need %.1f%%&quot;,</span>
<span class="udiff-line-added">+                      prog_if ? &quot;Good&quot; : &quot;Bad&quot;,</span>
<span class="udiff-line-added">+                      if_actual * 100, if_expected * 100);</span>
<span class="udiff-line-added">+   if (prog_if) {</span>
      return true;
    }
<span class="udiff-line-removed">-   log_info(gc,ergo)(&quot;Not enough internal fragmentation improvement (%.1f%%, need %.1f%%) after %s&quot;,</span>
<span class="udiff-line-removed">-                     if_actual * 100, if_expected * 100, label);</span>
  
<span class="udiff-line-modified-removed">-   // External fragmentation is down? Good! Declare victory.</span>
<span class="udiff-line-modified-added">+   // External fragmentation is down?</span>
    double ef_actual = _ef_before - _ef_after;
    double ef_expected = 0.01; // 1% should be enough
<span class="udiff-line-modified-removed">-   if (ef_actual &gt; ef_expected) {</span>
<span class="udiff-line-modified-added">+   bool prog_ef = ef_actual &gt;= ef_expected;</span>
<span class="udiff-line-added">+   log_info(gc, ergo)(&quot;%s progress for external fragmentation: %.1f%%, need %.1f%%&quot;,</span>
<span class="udiff-line-added">+                      prog_ef ? &quot;Good&quot; : &quot;Bad&quot;,</span>
<span class="udiff-line-added">+                      ef_actual * 100, ef_expected * 100);</span>
<span class="udiff-line-added">+   if (prog_ef) {</span>
      return true;
    }
<span class="udiff-line-removed">-   log_info(gc,ergo)(&quot;Not enough external fragmentation improvement (%.1f%%, need %.1f%%) after %s&quot;,</span>
<span class="udiff-line-removed">-                     if_actual * 100, if_expected * 100, label);</span>
  
    // Nothing good had happened.
    return false;
  }
</pre>
<center><a href="shenandoahMemoryPool.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahMetrics.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>