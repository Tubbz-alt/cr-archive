<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shenandoah/shenandoahSharedVariables.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahSATBMarkQueueSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStrDedupQueue.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahSharedVariables.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
<span class="line-new-header">--- 1,8 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,21 ***</span>
  
  #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHSHAREDVARIABLES_HPP
  #define SHARE_GC_SHENANDOAH_SHENANDOAHSHAREDVARIABLES_HPP
  
  #include &quot;memory/allocation.hpp&quot;
<span class="line-modified">! #include &quot;runtime/orderAccess.hpp&quot;</span>
  
  typedef jbyte ShenandoahSharedValue;
  
  // Needed for cooperation with generated code.
  STATIC_ASSERT(sizeof(ShenandoahSharedValue) == 1);
  
  typedef struct ShenandoahSharedFlag {
    enum {
      UNSET = 0,
<span class="line-modified">!     SET = 1,</span>
    };
  
    DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile ShenandoahSharedValue));
    volatile ShenandoahSharedValue value;
    DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);
<span class="line-new-header">--- 24,21 ---</span>
  
  #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHSHAREDVARIABLES_HPP
  #define SHARE_GC_SHENANDOAH_SHENANDOAHSHAREDVARIABLES_HPP
  
  #include &quot;memory/allocation.hpp&quot;
<span class="line-modified">! #include &quot;runtime/atomic.hpp&quot;</span>
  
  typedef jbyte ShenandoahSharedValue;
  
  // Needed for cooperation with generated code.
  STATIC_ASSERT(sizeof(ShenandoahSharedValue) == 1);
  
  typedef struct ShenandoahSharedFlag {
    enum {
      UNSET = 0,
<span class="line-modified">!     SET = 1</span>
    };
  
    DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile ShenandoahSharedValue));
    volatile ShenandoahSharedValue value;
    DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 45,46 ***</span>
    ShenandoahSharedFlag() {
      unset();
    }
  
    void set() {
<span class="line-modified">!     OrderAccess::release_store_fence(&amp;value, (ShenandoahSharedValue)SET);</span>
    }
  
    void unset() {
<span class="line-modified">!     OrderAccess::release_store_fence(&amp;value, (ShenandoahSharedValue)UNSET);</span>
    }
  
    bool is_set() const {
<span class="line-modified">!     return OrderAccess::load_acquire(&amp;value) == SET;</span>
    }
  
    bool is_unset() const {
<span class="line-modified">!     return OrderAccess::load_acquire(&amp;value) == UNSET;</span>
    }
  
<span class="line-modified">!   void set_cond(bool value) {</span>
<span class="line-modified">!     if (value) {</span>
        set();
      } else {
        unset();
      }
    }
  
    bool try_set() {
      if (is_set()) {
        return false;
      }
<span class="line-modified">!     ShenandoahSharedValue old = Atomic::cmpxchg((ShenandoahSharedValue)SET, &amp;value, (ShenandoahSharedValue)UNSET);</span>
      return old == UNSET; // success
    }
  
    bool try_unset() {
      if (!is_set()) {
        return false;
      }
<span class="line-modified">!     ShenandoahSharedValue old = Atomic::cmpxchg((ShenandoahSharedValue)UNSET, &amp;value, (ShenandoahSharedValue)SET);</span>
      return old == SET; // success
    }
  
    volatile ShenandoahSharedValue* addr_of() {
      return &amp;value;
<span class="line-new-header">--- 46,46 ---</span>
    ShenandoahSharedFlag() {
      unset();
    }
  
    void set() {
<span class="line-modified">!     Atomic::release_store_fence(&amp;value, (ShenandoahSharedValue)SET);</span>
    }
  
    void unset() {
<span class="line-modified">!     Atomic::release_store_fence(&amp;value, (ShenandoahSharedValue)UNSET);</span>
    }
  
    bool is_set() const {
<span class="line-modified">!     return Atomic::load_acquire(&amp;value) == SET;</span>
    }
  
    bool is_unset() const {
<span class="line-modified">!     return Atomic::load_acquire(&amp;value) == UNSET;</span>
    }
  
<span class="line-modified">!   void set_cond(bool val) {</span>
<span class="line-modified">!     if (val) {</span>
        set();
      } else {
        unset();
      }
    }
  
    bool try_set() {
      if (is_set()) {
        return false;
      }
<span class="line-modified">!     ShenandoahSharedValue old = Atomic::cmpxchg(&amp;value, (ShenandoahSharedValue)UNSET, (ShenandoahSharedValue)SET);</span>
      return old == UNSET; // success
    }
  
    bool try_unset() {
      if (!is_set()) {
        return false;
      }
<span class="line-modified">!     ShenandoahSharedValue old = Atomic::cmpxchg(&amp;value, (ShenandoahSharedValue)SET, (ShenandoahSharedValue)UNSET);</span>
      return old == SET; // success
    }
  
    volatile ShenandoahSharedValue* addr_of() {
      return &amp;value;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,61 ***</span>
  
    void set(uint mask) {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
      ShenandoahSharedValue mask_val = (ShenandoahSharedValue) mask;
      while (true) {
<span class="line-modified">!       ShenandoahSharedValue ov = OrderAccess::load_acquire(&amp;value);</span>
        if ((ov &amp; mask_val) != 0) {
          // already set
          return;
        }
  
        ShenandoahSharedValue nv = ov | mask_val;
<span class="line-modified">!       if (Atomic::cmpxchg(nv, &amp;value, ov) == ov) {</span>
          // successfully set
          return;
        }
      }
    }
  
    void unset(uint mask) {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
      ShenandoahSharedValue mask_val = (ShenandoahSharedValue) mask;
      while (true) {
<span class="line-modified">!       ShenandoahSharedValue ov = OrderAccess::load_acquire(&amp;value);</span>
        if ((ov &amp; mask_val) == 0) {
          // already unset
          return;
        }
  
        ShenandoahSharedValue nv = ov &amp; ~mask_val;
<span class="line-modified">!       if (Atomic::cmpxchg(nv, &amp;value, ov) == ov) {</span>
          // successfully unset
          return;
        }
      }
    }
  
    void clear() {
<span class="line-modified">!     OrderAccess::release_store_fence(&amp;value, (ShenandoahSharedValue)0);</span>
    }
  
    bool is_set(uint mask) const {
      return !is_unset(mask);
    }
  
    bool is_unset(uint mask) const {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     return (OrderAccess::load_acquire(&amp;value) &amp; (ShenandoahSharedValue) mask) == 0;</span>
    }
  
    bool is_clear() const {
<span class="line-modified">!     return (OrderAccess::load_acquire(&amp;value)) == 0;</span>
    }
  
<span class="line-modified">!   void set_cond(uint mask, bool value) {</span>
<span class="line-modified">!     if (value) {</span>
        set(mask);
      } else {
        unset(mask);
      }
    }
<span class="line-new-header">--- 117,61 ---</span>
  
    void set(uint mask) {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
      ShenandoahSharedValue mask_val = (ShenandoahSharedValue) mask;
      while (true) {
<span class="line-modified">!       ShenandoahSharedValue ov = Atomic::load_acquire(&amp;value);</span>
        if ((ov &amp; mask_val) != 0) {
          // already set
          return;
        }
  
        ShenandoahSharedValue nv = ov | mask_val;
<span class="line-modified">!       if (Atomic::cmpxchg(&amp;value, ov, nv) == ov) {</span>
          // successfully set
          return;
        }
      }
    }
  
    void unset(uint mask) {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
      ShenandoahSharedValue mask_val = (ShenandoahSharedValue) mask;
      while (true) {
<span class="line-modified">!       ShenandoahSharedValue ov = Atomic::load_acquire(&amp;value);</span>
        if ((ov &amp; mask_val) == 0) {
          // already unset
          return;
        }
  
        ShenandoahSharedValue nv = ov &amp; ~mask_val;
<span class="line-modified">!       if (Atomic::cmpxchg(&amp;value, ov, nv) == ov) {</span>
          // successfully unset
          return;
        }
      }
    }
  
    void clear() {
<span class="line-modified">!     Atomic::release_store_fence(&amp;value, (ShenandoahSharedValue)0);</span>
    }
  
    bool is_set(uint mask) const {
      return !is_unset(mask);
    }
  
    bool is_unset(uint mask) const {
      assert (mask &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     return (Atomic::load_acquire(&amp;value) &amp; (ShenandoahSharedValue) mask) == 0;</span>
    }
  
    bool is_clear() const {
<span class="line-modified">!     return (Atomic::load_acquire(&amp;value)) == 0;</span>
    }
  
<span class="line-modified">!   void set_cond(uint mask, bool val) {</span>
<span class="line-modified">!     if (val) {</span>
        set(mask);
      } else {
        unset(mask);
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 209,21 ***</span>
    }
  
    void set(T v) {
      assert (v &gt;= 0, &quot;sanity&quot;);
      assert (v &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     OrderAccess::release_store_fence(&amp;value, (ShenandoahSharedValue)v);</span>
    }
  
    T get() const {
<span class="line-modified">!     return (T)OrderAccess::load_acquire(&amp;value);</span>
    }
  
    T cmpxchg(T new_value, T expected) {
      assert (new_value &gt;= 0, &quot;sanity&quot;);
      assert (new_value &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     return (T)Atomic::cmpxchg((ShenandoahSharedValue)new_value, &amp;value, (ShenandoahSharedValue)expected);</span>
    }
  
    volatile ShenandoahSharedValue* addr_of() {
      return &amp;value;
    }
<span class="line-new-header">--- 210,21 ---</span>
    }
  
    void set(T v) {
      assert (v &gt;= 0, &quot;sanity&quot;);
      assert (v &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     Atomic::release_store_fence(&amp;value, (ShenandoahSharedValue)v);</span>
    }
  
    T get() const {
<span class="line-modified">!     return (T)Atomic::load_acquire(&amp;value);</span>
    }
  
    T cmpxchg(T new_value, T expected) {
      assert (new_value &gt;= 0, &quot;sanity&quot;);
      assert (new_value &lt; (sizeof(ShenandoahSharedValue) * CHAR_MAX), &quot;sanity&quot;);
<span class="line-modified">!     return (T)Atomic::cmpxchg(&amp;value, (ShenandoahSharedValue)expected, (ShenandoahSharedValue)new_value);</span>
    }
  
    volatile ShenandoahSharedValue* addr_of() {
      return &amp;value;
    }
</pre>
<center><a href="shenandoahSATBMarkQueueSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStrDedupQueue.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>