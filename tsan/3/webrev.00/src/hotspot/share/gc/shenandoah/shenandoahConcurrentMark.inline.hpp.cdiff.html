<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shenandoah/shenandoahConcurrentMark.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahConcurrentMark.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahControlThread.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahConcurrentMark.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
<span class="line-new-header">--- 1,8 ---</span>
  /*
   * Copyright (c) 2015, 2019, Red Hat, Inc. All rights reserved.
<span class="line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,17 ***</span>
  
  #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHCONCURRENTMARK_INLINE_HPP
  #define SHARE_GC_SHENANDOAH_SHENANDOAHCONCURRENTMARK_INLINE_HPP
  
  #include &quot;gc/shenandoah/shenandoahAsserts.hpp&quot;
<span class="line-removed">- #include &quot;gc/shenandoah/shenandoahBrooksPointer.hpp&quot;</span>
  #include &quot;gc/shenandoah/shenandoahBarrierSet.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahConcurrentMark.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahMarkingContext.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahStringDedup.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahTaskqueue.inline.hpp&quot;
  #include &quot;memory/iterator.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/prefetch.inline.hpp&quot;
  
  template &lt;class T&gt;
  void ShenandoahConcurrentMark::do_task(ShenandoahObjToScanQueue* q, T* cl, jushort* live_data, ShenandoahMarkTask* task) {
<span class="line-new-header">--- 24,17 ---</span>
  
  #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHCONCURRENTMARK_INLINE_HPP
  #define SHARE_GC_SHENANDOAH_SHENANDOAHCONCURRENTMARK_INLINE_HPP
  
  #include &quot;gc/shenandoah/shenandoahAsserts.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahBarrierSet.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahConcurrentMark.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahMarkingContext.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahStringDedup.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahTaskqueue.inline.hpp&quot;
  #include &quot;memory/iterator.inline.hpp&quot;
<span class="line-added">+ #include &quot;oops/compressedOops.inline.hpp&quot;</span>
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/prefetch.inline.hpp&quot;
  
  template &lt;class T&gt;
  void ShenandoahConcurrentMark::do_task(ShenandoahObjToScanQueue* q, T* cl, jushort* live_data, ShenandoahMarkTask* task) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 67,11 ***</span>
  }
  
  inline void ShenandoahConcurrentMark::count_liveness(jushort* live_data, oop obj) {
    size_t region_idx = _heap-&gt;heap_region_index_containing(obj);
    ShenandoahHeapRegion* region = _heap-&gt;get_region(region_idx);
<span class="line-modified">!   size_t size = obj-&gt;size() + ShenandoahBrooksPointer::word_size();</span>
  
    if (!region-&gt;is_humongous_start()) {
      assert(!region-&gt;is_humongous(), &quot;Cannot have continuations here&quot;);
      size_t max = (1 &lt;&lt; (sizeof(jushort) * 8)) - 1;
      if (size &gt;= max) {
<span class="line-new-header">--- 68,11 ---</span>
  }
  
  inline void ShenandoahConcurrentMark::count_liveness(jushort* live_data, oop obj) {
    size_t region_idx = _heap-&gt;heap_region_index_containing(obj);
    ShenandoahHeapRegion* region = _heap-&gt;get_region(region_idx);
<span class="line-modified">!   size_t size = obj-&gt;size();</span>
  
    if (!region-&gt;is_humongous_start()) {
      assert(!region-&gt;is_humongous(), &quot;Cannot have continuations here&quot;);
      size_t max = (1 &lt;&lt; (sizeof(jushort) * 8)) - 1;
      if (size &gt;= max) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 251,13 ***</span>
        break;
      default:
        ShouldNotReachHere();
      }
  
<span class="line-modified">!     // Note: Only when concurrently updating references can obj become NULL here.</span>
<span class="line-modified">!     // It happens when a mutator thread beats us by writing another value. In that</span>
<span class="line-modified">!     // case we don&#39;t need to do anything else.</span>
      if (UPDATE_REFS != CONCURRENT || !CompressedOops::is_null(obj)) {
        shenandoah_assert_not_forwarded(p, obj);
        shenandoah_assert_not_in_cset_except(p, obj, heap-&gt;cancelled_gc());
  
        if (mark_context-&gt;mark(obj)) {
<span class="line-new-header">--- 252,16 ---</span>
        break;
      default:
        ShouldNotReachHere();
      }
  
<span class="line-modified">!     // Note: Only when concurrently updating references can obj be different</span>
<span class="line-modified">!     // (that is, really different, not just different from-/to-space copies of the same)</span>
<span class="line-modified">!     // from the one we originally loaded. Mutator thread can beat us by writing something</span>
<span class="line-added">+     // else into the location. In that case, we would mark through that updated value,</span>
<span class="line-added">+     // on the off-chance it is not handled by other means (e.g. via SATB). However,</span>
<span class="line-added">+     // if that write was NULL, we don&#39;t need to do anything else.</span>
      if (UPDATE_REFS != CONCURRENT || !CompressedOops::is_null(obj)) {
        shenandoah_assert_not_forwarded(p, obj);
        shenandoah_assert_not_in_cset_except(p, obj, heap-&gt;cancelled_gc());
  
        if (mark_context-&gt;mark(obj)) {
</pre>
<center><a href="shenandoahConcurrentMark.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahControlThread.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>