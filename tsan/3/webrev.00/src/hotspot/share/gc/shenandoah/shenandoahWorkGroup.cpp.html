<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/shenandoah/shenandoahWorkGroup.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  *
23  */
24 
25 #include &quot;precompiled.hpp&quot;
26 
27 #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
28 #include &quot;gc/shenandoah/shenandoahThreadLocalData.hpp&quot;
29 #include &quot;gc/shenandoah/shenandoahWorkGroup.hpp&quot;
30 #include &quot;gc/shenandoah/shenandoahTaskqueue.hpp&quot;
31 
32 #include &quot;logging/log.hpp&quot;
33 
34 ShenandoahWorkerScope::ShenandoahWorkerScope(WorkGang* workers, uint nworkers, const char* msg, bool check) :
35   _workers(workers) {
36   assert(msg != NULL, &quot;Missing message&quot;);
37 
38   _n_workers = _workers-&gt;update_active_workers(nworkers);
39   assert(_n_workers &lt;= nworkers, &quot;Must be&quot;);
40 
41   log_info(gc, task)(&quot;Using %u of %u workers for %s&quot;,
42     _n_workers, ShenandoahHeap::heap()-&gt;max_workers(), msg);
43 
44   if (check) {
45     ShenandoahHeap::heap()-&gt;assert_gc_workers(_n_workers);
46   }
47 }
48 
49 ShenandoahWorkerScope::~ShenandoahWorkerScope() {
50   assert(_workers-&gt;active_workers() == _n_workers,
51     &quot;Active workers can not be changed within this scope&quot;);
52 }
53 
54 ShenandoahPushWorkerScope::ShenandoahPushWorkerScope(WorkGang* workers, uint nworkers, bool check) :
55   _old_workers(workers-&gt;active_workers()),
56   _workers(workers) {
57   _n_workers = _workers-&gt;update_active_workers(nworkers);
58   assert(_n_workers &lt;= nworkers, &quot;Must be&quot;);
59 
60   // bypass concurrent/parallel protocol check for non-regular paths, e.g. verifier, etc.
61   if (check) {
62     ShenandoahHeap::heap()-&gt;assert_gc_workers(_n_workers);
63   }
64 }
65 
66 ShenandoahPushWorkerScope::~ShenandoahPushWorkerScope() {
67   assert(_workers-&gt;active_workers() == _n_workers,
68     &quot;Active workers can not be changed within this scope&quot;);
69   // Restore old worker value
70   uint nworkers = _workers-&gt;update_active_workers(_old_workers);
71   assert(nworkers == _old_workers, &quot;Must be able to restore&quot;);
72 }
73 
74 ShenandoahPushWorkerQueuesScope::ShenandoahPushWorkerQueuesScope(WorkGang* workers, ShenandoahObjToScanQueueSet* queues, uint nworkers, bool check) :
75   ShenandoahPushWorkerScope(workers, nworkers, check), _queues(queues) {
76   _queues-&gt;reserve(_n_workers);
77 }
78 
79 ShenandoahPushWorkerQueuesScope::~ShenandoahPushWorkerQueuesScope() {
80   // Restore old worker value
81   _queues-&gt;reserve(_old_workers);
82 }
83 
84 AbstractGangWorker* ShenandoahWorkGang::install_worker(uint which) {
85   AbstractGangWorker* worker = WorkGang::install_worker(which);
86   ShenandoahThreadLocalData::create(worker);
87   if (_initialize_gclab) {
88     ShenandoahThreadLocalData::initialize_gclab(worker);
89   }
90   return worker;
91 }
    </pre>
  </body>
</html>