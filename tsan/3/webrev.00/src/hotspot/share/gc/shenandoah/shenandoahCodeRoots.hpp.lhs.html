<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/shenandoah/shenandoahCodeRoots.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>

  3  *
  4  * This code is free software; you can redistribute it and/or modify it
  5  * under the terms of the GNU General Public License version 2 only, as
  6  * published by the Free Software Foundation.
  7  *
  8  * This code is distributed in the hope that it will be useful, but WITHOUT
  9  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11  * version 2 for more details (a copy is included in the LICENSE file that
 12  * accompanied this code).
 13  *
 14  * You should have received a copy of the GNU General Public License version
 15  * 2 along with this work; if not, write to the Free Software Foundation,
 16  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17  *
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  *
 22  */
 23 
 24 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 25 #define SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
 26 
 27 #include &quot;code/codeCache.hpp&quot;
 28 #include &quot;gc/shenandoah/shenandoahSharedVariables.hpp&quot;
<a name="2" id="anc2"></a>

 29 #include &quot;memory/allocation.hpp&quot;
 30 #include &quot;memory/iterator.hpp&quot;
<a name="3" id="anc3"></a>
 31 
 32 class ShenandoahHeap;
 33 class ShenandoahHeapRegion;
<a name="4" id="anc4"></a><span class="line-removed"> 34 class ShenandoahCodeRootsLock;</span>
 35 
 36 class ShenandoahParallelCodeHeapIterator {
 37   friend class CodeCache;
 38 private:
 39   CodeHeap*     _heap;
 40   DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));
 41   volatile int  _claimed_idx;
 42   volatile bool _finished;
 43   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);
 44 public:
 45   ShenandoahParallelCodeHeapIterator(CodeHeap* heap);
 46   void parallel_blobs_do(CodeBlobClosure* f);
 47 };
 48 
 49 class ShenandoahParallelCodeCacheIterator {
 50   friend class CodeCache;
 51 private:
 52   ShenandoahParallelCodeHeapIterator* _iters;
 53   int                       _length;
<a name="5" id="anc5"></a>


 54 public:
 55   ShenandoahParallelCodeCacheIterator(const GrowableArray&lt;CodeHeap*&gt;* heaps);
 56   ~ShenandoahParallelCodeCacheIterator();
 57   void parallel_blobs_do(CodeBlobClosure* f);
 58 };
 59 
<a name="6" id="anc6"></a><span class="line-removed"> 60 // ShenandoahNMethod tuple records the internal locations of oop slots within the nmethod.</span>
<span class="line-removed"> 61 // This allows us to quickly scan the oops without doing the nmethod-internal scans, that</span>
<span class="line-removed"> 62 // sometimes involves parsing the machine code. Note it does not record the oops themselves,</span>
<span class="line-removed"> 63 // because it would then require handling these tuples as the new class of roots.</span>
<span class="line-removed"> 64 class ShenandoahNMethod : public CHeapObj&lt;mtGC&gt; {</span>
<span class="line-removed"> 65 private:</span>
<span class="line-removed"> 66   nmethod* _nm;</span>
<span class="line-removed"> 67   oop**    _oops;</span>
<span class="line-removed"> 68   int      _oops_count;</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70 public:</span>
<span class="line-removed"> 71   ShenandoahNMethod(nmethod *nm, GrowableArray&lt;oop*&gt;* oops);</span>
<span class="line-removed"> 72   ~ShenandoahNMethod();</span>
<span class="line-removed"> 73 </span>
<span class="line-removed"> 74   nmethod* nm() {</span>
<span class="line-removed"> 75     return _nm;</span>
<span class="line-removed"> 76   }</span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78   bool has_cset_oops(ShenandoahHeap* heap);</span>
<span class="line-removed"> 79 </span>
<span class="line-removed"> 80   void assert_alive_and_correct() NOT_DEBUG_RETURN;</span>
<span class="line-removed"> 81   void assert_same_oops(GrowableArray&lt;oop*&gt;* oops) NOT_DEBUG_RETURN;</span>
<span class="line-removed"> 82 </span>
<span class="line-removed"> 83   static bool find_with_nmethod(void* nm, ShenandoahNMethod* other) {</span>
<span class="line-removed"> 84     return other-&gt;_nm == nm;</span>
<span class="line-removed"> 85   }</span>
<span class="line-removed"> 86 };</span>
<span class="line-removed"> 87 </span>
 88 class ShenandoahCodeRootsIterator {
 89   friend class ShenandoahCodeRoots;
 90 protected:
<a name="7" id="anc7"></a><span class="line-removed"> 91   ShenandoahHeap* _heap;</span>
 92   ShenandoahParallelCodeCacheIterator _par_iterator;
 93   ShenandoahSharedFlag _seq_claimed;
<a name="8" id="anc8"></a><span class="line-modified"> 94   DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile size_t));</span>
<span class="line-modified"> 95   volatile size_t _claimed;</span>
<span class="line-removed"> 96   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);</span>
 97 protected:
 98   ShenandoahCodeRootsIterator();
 99   ~ShenandoahCodeRootsIterator();
100 
101   template&lt;bool CSET_FILTER&gt;
102   void dispatch_parallel_blobs_do(CodeBlobClosure *f);
103 
104   template&lt;bool CSET_FILTER&gt;
105   void fast_parallel_blobs_do(CodeBlobClosure *f);
106 };
107 
108 class ShenandoahAllCodeRootsIterator : public ShenandoahCodeRootsIterator {
109 public:
110   ShenandoahAllCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
111   void possibly_parallel_blobs_do(CodeBlobClosure *f);
112 };
113 
114 class ShenandoahCsetCodeRootsIterator : public ShenandoahCodeRootsIterator {
115 public:
116   ShenandoahCsetCodeRootsIterator() : ShenandoahCodeRootsIterator() {};
117   void possibly_parallel_blobs_do(CodeBlobClosure* f);
118 };
119 
<a name="9" id="anc9"></a><span class="line-modified">120 class ShenandoahCodeRoots : public CHeapObj&lt;mtGC&gt; {</span>
121   friend class ShenandoahHeap;
<a name="10" id="anc10"></a><span class="line-removed">122   friend class ShenandoahCodeRootsLock;</span>
123   friend class ShenandoahCodeRootsIterator;
124 
125 public:
126   static void initialize();
<a name="11" id="anc11"></a><span class="line-modified">127   static void add_nmethod(nmethod* nm);</span>
<span class="line-modified">128   static void remove_nmethod(nmethod* nm);</span>
<span class="line-modified">129 </span>
<span class="line-removed">130   /**</span>
<span class="line-removed">131    * Provides the iterator over all nmethods in the code cache that have oops.</span>
<span class="line-removed">132    * @return</span>
<span class="line-removed">133    */</span>
<span class="line-removed">134   static ShenandoahAllCodeRootsIterator iterator();</span>
135 
<a name="12" id="anc12"></a><span class="line-modified">136   /**</span>
<span class="line-modified">137    * Provides the iterator over nmethods that have at least one oop in collection set.</span>
<span class="line-removed">138    * @return</span>
<span class="line-removed">139    */</span>
<span class="line-removed">140   static ShenandoahCsetCodeRootsIterator cset_iterator();</span>
<span class="line-removed">141 </span>
<span class="line-removed">142 private:</span>
<span class="line-removed">143   struct PaddedLock {</span>
<span class="line-removed">144     DEFINE_PAD_MINUS_SIZE(0, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile int));</span>
<span class="line-removed">145     volatile int _lock;</span>
<span class="line-removed">146     DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, 0);</span>
<span class="line-removed">147   };</span>
<span class="line-removed">148 </span>
<span class="line-removed">149   static PaddedLock _recorded_nms_lock;</span>
<span class="line-removed">150   static GrowableArray&lt;ShenandoahNMethod*&gt;* _recorded_nms;</span>
<span class="line-removed">151 </span>
<span class="line-removed">152   static void acquire_lock(bool write) {</span>
<span class="line-removed">153     volatile int* loc = &amp;_recorded_nms_lock._lock;</span>
<span class="line-removed">154     if (write) {</span>
<span class="line-removed">155       while ((OrderAccess::load_acquire(loc) != 0) ||</span>
<span class="line-removed">156              Atomic::cmpxchg(-1, loc, 0) != 0) {</span>
<span class="line-removed">157         SpinPause();</span>
<span class="line-removed">158       }</span>
<span class="line-removed">159       assert (*loc == -1, &quot;acquired for write&quot;);</span>
<span class="line-removed">160     } else {</span>
<span class="line-removed">161       while (true) {</span>
<span class="line-removed">162         int cur = OrderAccess::load_acquire(loc);</span>
<span class="line-removed">163         if (cur &gt;= 0) {</span>
<span class="line-removed">164           if (Atomic::cmpxchg(cur + 1, loc, cur) == cur) {</span>
<span class="line-removed">165             // Success!</span>
<span class="line-removed">166             assert (*loc &gt; 0, &quot;acquired for read&quot;);</span>
<span class="line-removed">167             return;</span>
<span class="line-removed">168           }</span>
<span class="line-removed">169         }</span>
<span class="line-removed">170         SpinPause();</span>
<span class="line-removed">171       }</span>
<span class="line-removed">172     }</span>
173   }
174 
<a name="13" id="anc13"></a><span class="line-modified">175   static void release_lock(bool write) {</span>
<span class="line-modified">176     volatile int* loc = &amp;ShenandoahCodeRoots::_recorded_nms_lock._lock;</span>
<span class="line-modified">177     if (write) {</span>
<span class="line-modified">178       OrderAccess::release_store_fence(loc, 0);</span>
<span class="line-modified">179     } else {</span>
<span class="line-modified">180       Atomic::dec(loc);</span>
<span class="line-removed">181     }</span>
<span class="line-removed">182   }</span>
<span class="line-removed">183 };</span>
184 
<a name="14" id="anc14"></a><span class="line-removed">185 // Very simple unranked read-write lock</span>
<span class="line-removed">186 class ShenandoahCodeRootsLock : public StackObj {</span>
<span class="line-removed">187   friend class ShenandoahCodeRoots;</span>
188 private:
<a name="15" id="anc15"></a><span class="line-modified">189   const bool _write;</span>
<span class="line-modified">190 public:</span>
<span class="line-removed">191   ShenandoahCodeRootsLock(bool write) : _write(write) {</span>
<span class="line-removed">192     ShenandoahCodeRoots::acquire_lock(write);</span>
<span class="line-removed">193   }</span>
<span class="line-removed">194 </span>
<span class="line-removed">195   ~ShenandoahCodeRootsLock() {</span>
<span class="line-removed">196     ShenandoahCodeRoots::release_lock(_write);</span>
<span class="line-removed">197   }</span>
198 };
199 
200 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHCODEROOTS_HPP
<a name="16" id="anc16"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="16" type="hidden" />
</body>
</html>