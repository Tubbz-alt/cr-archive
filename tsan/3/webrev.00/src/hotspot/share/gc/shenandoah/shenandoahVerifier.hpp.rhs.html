<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/shenandoah/shenandoahVerifier.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2017, 2020, Red Hat, Inc. All rights reserved.</span>
<span class="line-added">  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 26 #define SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
 27 
 28 #include &quot;gc/shared/markBitMap.hpp&quot;
<a name="2" id="anc2"></a><span class="line-added"> 29 #include &quot;gc/shenandoah/shenandoahRootVerifier.hpp&quot;</span>
 30 #include &quot;memory/allocation.hpp&quot;
 31 #include &quot;oops/oopsHierarchy.hpp&quot;
 32 #include &quot;utilities/stack.hpp&quot;
 33 
 34 class ShenandoahHeap;
 35 
 36 #ifdef _WINDOWS
 37 #pragma warning( disable : 4522 )
 38 #endif
 39 
 40 class ShenandoahVerifierTask {
 41 public:
 42   ShenandoahVerifierTask(oop o = NULL, int idx = 0): _obj(o) { }
 43   ShenandoahVerifierTask(oop o, size_t idx): _obj(o) { }
 44   ShenandoahVerifierTask(const ShenandoahVerifierTask&amp; t): _obj(t._obj) { }
 45 
 46   ShenandoahVerifierTask&amp; operator =(const ShenandoahVerifierTask&amp; t) {
 47     _obj = t._obj;
 48     return *this;
 49   }
 50   volatile ShenandoahVerifierTask&amp;
 51   operator =(const volatile ShenandoahVerifierTask&amp; t) volatile {
 52     (void)const_cast&lt;oop&amp;&gt;(_obj = t._obj);
 53     return *this;
 54   }
 55 
 56   inline oop obj()  const { return _obj; }
 57 
 58 private:
 59   oop _obj;
 60 };
 61 
 62 typedef Stack&lt;ShenandoahVerifierTask, mtGC&gt; ShenandoahVerifierStack;
 63 typedef volatile juint ShenandoahLivenessData;
 64 
 65 class ShenandoahVerifier : public CHeapObj&lt;mtGC&gt; {
 66 private:
 67   ShenandoahHeap* _heap;
 68   MarkBitMap* _verification_bit_map;
 69 public:
 70   typedef enum {
 71     // Disable marked objects verification.
 72     _verify_marked_disable,
 73 
 74     // Objects should be marked in &quot;next&quot; bitmap.
 75     _verify_marked_incomplete,
 76 
 77     // Objects should be marked in &quot;complete&quot; bitmap.
<a name="3" id="anc3"></a><span class="line-modified"> 78     _verify_marked_complete</span>
 79   } VerifyMarked;
 80 
 81   typedef enum {
 82     // Disable forwarded objects verification.
 83     _verify_forwarded_disable,
 84 
 85     // Objects should not have forwardees.
 86     _verify_forwarded_none,
 87 
 88     // Objects may have forwardees.
<a name="4" id="anc4"></a><span class="line-modified"> 89     _verify_forwarded_allow</span>
 90   } VerifyForwarded;
 91 
 92   typedef enum {
 93     // Disable collection set verification.
 94     _verify_cset_disable,
 95 
 96     // Should have no references to cset.
 97     _verify_cset_none,
 98 
 99     // May have references to cset, all should be forwarded.
100     // Note: Allowing non-forwarded references to cset is equivalent
101     // to _verify_cset_disable.
<a name="5" id="anc5"></a><span class="line-modified">102     _verify_cset_forwarded</span>
103   } VerifyCollectionSet;
104 
105   typedef enum {
106     // Disable liveness verification
107     _verify_liveness_disable,
108 
109     // All objects should belong to live regions
110     _verify_liveness_conservative,
111 
112     // All objects should belong to live regions,
113     // and liveness data should be accurate
<a name="6" id="anc6"></a><span class="line-modified">114     _verify_liveness_complete</span>
115   } VerifyLiveness;
116 
117   typedef enum {
118     // Disable region verification
119     _verify_regions_disable,
120 
121     // No trash regions allowed
122     _verify_regions_notrash,
123 
124     // No collection set regions allowed
125     _verify_regions_nocset,
126 
127     // No trash and no cset regions allowed
<a name="7" id="anc7"></a><span class="line-modified">128     _verify_regions_notrash_nocset</span>
129   } VerifyRegions;
130 
131   typedef enum {
132     // Disable gc-state verification
133     _verify_gcstate_disable,
134 
135     // Nothing is in progress, no forwarded objects
136     _verify_gcstate_stable,
137 
138     // Nothing is in progress, some objects are forwarded
139     _verify_gcstate_forwarded,
<a name="8" id="anc8"></a><span class="line-added">140 </span>
<span class="line-added">141     // Evacuation is in progress, some objects are forwarded</span>
<span class="line-added">142     _verify_gcstate_evacuation</span>
143   } VerifyGCState;
144 
<a name="9" id="anc9"></a><span class="line-added">145   typedef enum {</span>
<span class="line-added">146     _verify_all_weak_roots,</span>
<span class="line-added">147     _verify_serial_weak_roots,</span>
<span class="line-added">148     _verify_concurrent_weak_roots</span>
<span class="line-added">149   } VerifyWeakRoots;</span>
<span class="line-added">150 </span>
151   struct VerifyOptions {
152     VerifyForwarded     _verify_forwarded;
153     VerifyMarked        _verify_marked;
154     VerifyCollectionSet _verify_cset;
155     VerifyLiveness      _verify_liveness;
156     VerifyRegions       _verify_regions;
157     VerifyGCState       _verify_gcstate;
<a name="10" id="anc10"></a><span class="line-added">158     VerifyWeakRoots     _verify_weak_roots;</span>
159 
160     VerifyOptions(VerifyForwarded verify_forwarded,
161                   VerifyMarked verify_marked,
162                   VerifyCollectionSet verify_collection_set,
163                   VerifyLiveness verify_liveness,
164                   VerifyRegions verify_regions,
<a name="11" id="anc11"></a><span class="line-modified">165                   VerifyGCState verify_gcstate,</span>
<span class="line-added">166                   VerifyWeakRoots verify_weak_roots = _verify_all_weak_roots) :</span>
167             _verify_forwarded(verify_forwarded), _verify_marked(verify_marked),
168             _verify_cset(verify_collection_set),
169             _verify_liveness(verify_liveness), _verify_regions(verify_regions),
<a name="12" id="anc12"></a><span class="line-modified">170             _verify_gcstate(verify_gcstate),</span>
<span class="line-added">171             _verify_weak_roots(verify_weak_roots) {}</span>
172   };
173 
174 private:
175   void verify_at_safepoint(const char *label,
176                            VerifyForwarded forwarded,
177                            VerifyMarked marked,
178                            VerifyCollectionSet cset,
179                            VerifyLiveness liveness,
180                            VerifyRegions regions,
<a name="13" id="anc13"></a><span class="line-modified">181                            VerifyGCState gcstate,</span>
<span class="line-added">182                            VerifyWeakRoots weakRoots);</span>
183 
184 public:
185   ShenandoahVerifier(ShenandoahHeap* heap, MarkBitMap* verification_bitmap) :
186           _heap(heap), _verification_bit_map(verification_bitmap) {};
187 
188   void verify_before_concmark();
189   void verify_after_concmark();
190   void verify_before_evacuation();
<a name="14" id="anc14"></a><span class="line-added">191   void verify_during_evacuation();</span>
192   void verify_after_evacuation();
193   void verify_before_updaterefs();
194   void verify_after_updaterefs();
195   void verify_before_fullgc();
196   void verify_after_fullgc();
197   void verify_before_traversal();
198   void verify_after_traversal();
199   void verify_after_degenerated();
200   void verify_generic(VerifyOption option);
<a name="15" id="anc15"></a><span class="line-added">201 </span>
<span class="line-added">202   // Roots should only contain to-space oops</span>
<span class="line-added">203   void verify_roots_in_to_space();</span>
<span class="line-added">204   void verify_roots_in_to_space_except(ShenandoahRootVerifier::RootTypes types);</span>
<span class="line-added">205 </span>
<span class="line-added">206   void verify_roots_no_forwarded();</span>
<span class="line-added">207   void verify_roots_no_forwarded_except(ShenandoahRootVerifier::RootTypes types);</span>
208 };
209 
210 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHVERIFIER_HPP
<a name="16" id="anc16"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="16" type="hidden" />
</body>
</html>