<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahAsserts.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahArguments.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahAsserts.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahAsserts.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,11 +23,11 @@</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  
  #include &quot;gc/shenandoah/shenandoahAsserts.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/shenandoah/shenandoahBrooksPointer.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/shenandoah/shenandoahForwarding.hpp&quot;</span>
  #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahHeapRegionSet.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahMarkingContext.inline.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahTraversalGC.hpp&quot;
  #include &quot;gc/shenandoah/shenandoahUtils.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -58,19 +59,23 @@</span>
  
    ResourceMark rm;
    stringStream ss;
    r-&gt;print_on(&amp;ss);
  
<span class="udiff-line-added">+   stringStream mw_ss;</span>
<span class="udiff-line-added">+   obj-&gt;mark().print_on(&amp;mw_ss);</span>
<span class="udiff-line-added">+ </span>
    ShenandoahMarkingContext* const ctx = heap-&gt;marking_context();
  
    msg.append(&quot;  &quot; PTR_FORMAT &quot; - klass &quot; PTR_FORMAT &quot; %s\n&quot;, p2i(obj), p2i(obj-&gt;klass()), obj-&gt;klass()-&gt;external_name());
<span class="udiff-line-modified-removed">-   msg.append(&quot;    %3s allocated after mark start\n&quot;, ctx-&gt;allocated_after_mark_start((HeapWord *) obj) ? &quot;&quot; : &quot;not&quot;);</span>
<span class="udiff-line-modified-added">+   msg.append(&quot;    %3s allocated after mark start\n&quot;, ctx-&gt;allocated_after_mark_start(obj) ? &quot;&quot; : &quot;not&quot;);</span>
    msg.append(&quot;    %3s marked \n&quot;,                    ctx-&gt;is_marked(obj) ? &quot;&quot; : &quot;not&quot;);
    msg.append(&quot;    %3s in collection set\n&quot;,          heap-&gt;in_collection_set(obj) ? &quot;&quot; : &quot;not&quot;);
    if (heap-&gt;traversal_gc() != NULL) {
<span class="udiff-line-modified-removed">-     msg.append(&quot;    %3s in traversal set\n&quot;,         heap-&gt;traversal_gc()-&gt;traversal_set()-&gt;is_in((HeapWord*) obj) ? &quot;&quot; : &quot;not&quot;);</span>
<span class="udiff-line-modified-added">+     msg.append(&quot;    %3s in traversal set\n&quot;,         heap-&gt;traversal_gc()-&gt;traversal_set()-&gt;is_in(obj) ? &quot;&quot; : &quot;not&quot;);</span>
    }
<span class="udiff-line-added">+   msg.append(&quot;  mark:%s\n&quot;, mw_ss.as_string());</span>
    msg.append(&quot;  region: %s&quot;, ss.as_string());
  }
  
  void ShenandoahAsserts::print_non_obj(ShenandoahMessageBuffer&amp; msg, void* loc) {
    ShenandoahHeap* heap = ShenandoahHeap::heap();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,11 +83,11 @@</span>
      msg.append(&quot;  inside Java heap\n&quot;);
      ShenandoahHeapRegion *r = heap-&gt;heap_region_containing(loc);
      stringStream ss;
      r-&gt;print_on(&amp;ss);
  
<span class="udiff-line-modified-removed">-     msg.append(&quot;    %3s in collection set\n&quot;,    heap-&gt;in_collection_set(loc) ? &quot;&quot; : &quot;not&quot;);</span>
<span class="udiff-line-modified-added">+     msg.append(&quot;    %3s in collection set\n&quot;,    heap-&gt;in_collection_set_loc(loc) ? &quot;&quot; : &quot;not&quot;);</span>
      msg.append(&quot;  region: %s&quot;, ss.as_string());
    } else {
      msg.append(&quot;  outside of Java heap\n&quot;);
      stringStream ss;
      os::print_location(&amp;ss, (intptr_t) loc, false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,13 +139,13 @@</span>
      print_obj_safe(msg, obj);
    }
    msg.append(&quot;\n&quot;);
  
    if (level &gt;= _safe_oop) {
<span class="udiff-line-modified-removed">-     oop fwd = (oop) ShenandoahBrooksPointer::get_raw_unchecked(obj);</span>
<span class="udiff-line-modified-added">+     oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);</span>
      msg.append(&quot;Forwardee:\n&quot;);
<span class="udiff-line-modified-removed">-     if (!oopDesc::equals_raw(obj, fwd)) {</span>
<span class="udiff-line-modified-added">+     if (obj != fwd) {</span>
        if (level &gt;= _safe_oop_fwd) {
          print_obj(msg, fwd);
        } else {
          print_obj_safe(msg, fwd);
        }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,13 +154,13 @@</span>
      }
      msg.append(&quot;\n&quot;);
    }
  
    if (level &gt;= _safe_oop_fwd) {
<span class="udiff-line-modified-removed">-     oop fwd = (oop) ShenandoahBrooksPointer::get_raw_unchecked(obj);</span>
<span class="udiff-line-modified-removed">-     oop fwd2 = (oop) ShenandoahBrooksPointer::get_raw_unchecked(fwd);</span>
<span class="udiff-line-modified-removed">-     if (!oopDesc::equals_raw(fwd, fwd2)) {</span>
<span class="udiff-line-modified-added">+     oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);</span>
<span class="udiff-line-modified-added">+     oop fwd2 = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(fwd);</span>
<span class="udiff-line-modified-added">+     if (fwd != fwd2) {</span>
        msg.append(&quot;Second forwardee:\n&quot;);
        print_obj_safe(msg, fwd2);
        msg.append(&quot;\n&quot;);
      }
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -195,13 +200,13 @@</span>
      print_failure(_safe_unknown, obj, interior_loc, NULL, &quot;Shenandoah assert_correct failed&quot;,
                    &quot;Object klass pointer must go to metaspace&quot;,
                    file,line);
    }
  
<span class="udiff-line-modified-removed">-   oop fwd = oop(ShenandoahBrooksPointer::get_raw_unchecked(obj));</span>
<span class="udiff-line-modified-added">+   oop fwd = oop(ShenandoahForwarding::get_forwardee_raw_unchecked(obj));</span>
  
<span class="udiff-line-modified-removed">-   if (!oopDesc::equals_raw(obj, fwd)) {</span>
<span class="udiff-line-modified-added">+   if (obj != fwd) {</span>
      // When Full GC moves the objects, we cannot trust fwdptrs. If we got here, it means something
      // tries fwdptr manipulation when Full GC is running. The only exception is using the fwdptr
      // that still points to the object itself.
      if (heap-&gt;is_full_gc_move_in_progress()) {
        print_failure(_safe_oop, obj, interior_loc, NULL, &quot;Shenandoah assert_correct failed&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,12 +233,12 @@</span>
                      &quot;Non-trivial forwardee should in another region&quot;,
                      file, line);
      }
  
      // Step 4. Check for multiple forwardings
<span class="udiff-line-modified-removed">-     oop fwd2 = oop(ShenandoahBrooksPointer::get_raw_unchecked(fwd));</span>
<span class="udiff-line-modified-removed">-     if (!oopDesc::equals_raw(fwd, fwd2)) {</span>
<span class="udiff-line-modified-added">+     oop fwd2 = oop(ShenandoahForwarding::get_forwardee_raw_unchecked(fwd));</span>
<span class="udiff-line-modified-added">+     if (fwd != fwd2) {</span>
        print_failure(_safe_all, obj, interior_loc, NULL, &quot;Shenandoah assert_correct failed&quot;,
                      &quot;Multiple forwardings&quot;,
                      file, line);
      }
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -248,11 +253,11 @@</span>
      print_failure(_safe_unknown, obj, interior_loc, NULL, &quot;Shenandoah assert_in_correct_region failed&quot;,
                    &quot;Object must reside in active region&quot;,
                    file, line);
    }
  
<span class="udiff-line-modified-removed">-   size_t alloc_size = obj-&gt;size() + ShenandoahBrooksPointer::word_size();</span>
<span class="udiff-line-modified-added">+   size_t alloc_size = obj-&gt;size();</span>
    if (alloc_size &gt; ShenandoahHeapRegion::humongous_threshold_words()) {
      size_t idx = r-&gt;region_number();
      size_t num_regions = ShenandoahHeapRegion::required_regions(alloc_size * HeapWordSize);
      for (size_t i = idx; i &lt; idx + num_regions; i++) {
        ShenandoahHeapRegion* chain_reg = heap-&gt;get_region(i);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -270,24 +275,24 @@</span>
    }
  }
  
  void ShenandoahAsserts::assert_forwarded(void* interior_loc, oop obj, const char* file, int line) {
    assert_correct(interior_loc, obj, file, line);
<span class="udiff-line-modified-removed">-   oop fwd = oop(ShenandoahBrooksPointer::get_raw_unchecked(obj));</span>
<span class="udiff-line-modified-added">+   oop fwd = oop(ShenandoahForwarding::get_forwardee_raw_unchecked(obj));</span>
  
<span class="udiff-line-modified-removed">-   if (oopDesc::equals_raw(obj, fwd)) {</span>
<span class="udiff-line-modified-added">+   if (obj == fwd) {</span>
      print_failure(_safe_all, obj, interior_loc, NULL, &quot;Shenandoah assert_forwarded failed&quot;,
                    &quot;Object should be forwarded&quot;,
                    file, line);
    }
  }
  
  void ShenandoahAsserts::assert_not_forwarded(void* interior_loc, oop obj, const char* file, int line) {
    assert_correct(interior_loc, obj, file, line);
<span class="udiff-line-modified-removed">-   oop fwd = oop(ShenandoahBrooksPointer::get_raw_unchecked(obj));</span>
<span class="udiff-line-modified-added">+   oop fwd = oop(ShenandoahForwarding::get_forwardee_raw_unchecked(obj));</span>
  
<span class="udiff-line-modified-removed">-   if (!oopDesc::equals_raw(obj, fwd)) {</span>
<span class="udiff-line-modified-added">+   if (obj != fwd) {</span>
      print_failure(_safe_all, obj, interior_loc, NULL, &quot;Shenandoah assert_not_forwarded failed&quot;,
                    &quot;Object should not be forwarded&quot;,
                    file, line);
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -325,11 +330,11 @@</span>
    }
  }
  
  void ShenandoahAsserts::assert_not_in_cset_loc(void* interior_loc, const char* file, int line) {
    ShenandoahHeap* heap = ShenandoahHeap::heap_no_check();
<span class="udiff-line-modified-removed">-   if (heap-&gt;in_collection_set(interior_loc)) {</span>
<span class="udiff-line-modified-added">+   if (heap-&gt;in_collection_set_loc(interior_loc)) {</span>
      print_failure(_safe_unknown, NULL, interior_loc, NULL, &quot;Shenandoah assert_not_in_cset_loc failed&quot;,
                    &quot;Interior location should not be in collection set&quot;,
                    file, line);
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -356,5 +361,18 @@</span>
    if (rp-&gt;is_alive_non_header() == NULL) {
      print_rp_failure(&quot;Shenandoah assert_rp_isalive_installed failed&quot;, rp-&gt;is_alive_non_header(),
                       file, line);
    }
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahAsserts::assert_locked_or_shenandoah_safepoint(Mutex* lock, const char* file, int line) {</span>
<span class="udiff-line-added">+   if (ShenandoahSafepoint::is_at_shenandoah_safepoint()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (lock-&gt;owned_by_self()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ShenandoahMessageBuffer msg(&quot;Must ba at a Shenandoah safepoint or held %s lock&quot;, lock-&gt;name());</span>
<span class="udiff-line-added">+   report_vm_error(file, line, msg.buffer());</span>
<span class="udiff-line-added">+ }</span>
</pre>
<center><a href="shenandoahArguments.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahAsserts.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>