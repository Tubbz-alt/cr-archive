<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/parallel/psOldGen.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="psFileBackedVirtualspace.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="psOldGen.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/parallel/psOldGen.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,41 ***</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/parallel/objectStartArray.inline.hpp&quot;
  #include &quot;gc/parallel/parallelScavengeHeap.hpp&quot;
  #include &quot;gc/parallel/psAdaptiveSizePolicy.hpp&quot;
  #include &quot;gc/parallel/psCardTable.hpp&quot;
  #include &quot;gc/parallel/psFileBackedVirtualspace.hpp&quot;
<span class="line-removed">- #include &quot;gc/parallel/psMarkSweepDecorator.hpp&quot;</span>
  #include &quot;gc/parallel/psOldGen.hpp&quot;
  #include &quot;gc/shared/cardTableBarrierSet.hpp&quot;
  #include &quot;gc/shared/gcLocker.hpp&quot;
<span class="line-modified">! #include &quot;gc/shared/spaceDecorator.hpp&quot;</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/java.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
  
<span class="line-removed">- inline const char* PSOldGen::select_name() {</span>
<span class="line-removed">-   return UseParallelOldGC ? &quot;ParOldGen&quot; : &quot;PSOldGen&quot;;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  PSOldGen::PSOldGen(ReservedSpace rs, size_t alignment,
                     size_t initial_size, size_t min_size, size_t max_size,
                     const char* perf_data_name, int level):
<span class="line-modified">!   _name(select_name()), _init_gen_size(initial_size), _min_gen_size(min_size),</span>
    _max_gen_size(max_size)
  {
    initialize(rs, alignment, perf_data_name, level);
  }
  
  PSOldGen::PSOldGen(size_t initial_size,
                     size_t min_size, size_t max_size,
                     const char* perf_data_name, int level):
<span class="line-modified">!   _name(select_name()), _init_gen_size(initial_size), _min_gen_size(min_size),</span>
    _max_gen_size(max_size)
  {}
  
  void PSOldGen::initialize(ReservedSpace rs, size_t alignment,
                            const char* perf_data_name, int level) {
<span class="line-new-header">--- 22,37 ---</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/parallel/objectStartArray.inline.hpp&quot;
<span class="line-added">+ #include &quot;gc/parallel/parallelArguments.hpp&quot;</span>
  #include &quot;gc/parallel/parallelScavengeHeap.hpp&quot;
  #include &quot;gc/parallel/psAdaptiveSizePolicy.hpp&quot;
  #include &quot;gc/parallel/psCardTable.hpp&quot;
  #include &quot;gc/parallel/psFileBackedVirtualspace.hpp&quot;
  #include &quot;gc/parallel/psOldGen.hpp&quot;
  #include &quot;gc/shared/cardTableBarrierSet.hpp&quot;
  #include &quot;gc/shared/gcLocker.hpp&quot;
<span class="line-modified">! #include &quot;gc/shared/spaceDecorator.inline.hpp&quot;</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/java.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
  
  PSOldGen::PSOldGen(ReservedSpace rs, size_t alignment,
                     size_t initial_size, size_t min_size, size_t max_size,
                     const char* perf_data_name, int level):
<span class="line-modified">!   _init_gen_size(initial_size), _min_gen_size(min_size),</span>
    _max_gen_size(max_size)
  {
    initialize(rs, alignment, perf_data_name, level);
  }
  
  PSOldGen::PSOldGen(size_t initial_size,
                     size_t min_size, size_t max_size,
                     const char* perf_data_name, int level):
<span class="line-modified">!   _init_gen_size(initial_size), _min_gen_size(min_size),</span>
    _max_gen_size(max_size)
  {}
  
  void PSOldGen::initialize(ReservedSpace rs, size_t alignment,
                            const char* perf_data_name, int level) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,11 ***</span>
    initialize_performance_counters(perf_data_name, level);
  }
  
  void PSOldGen::initialize_virtual_space(ReservedSpace rs, size_t alignment) {
  
<span class="line-modified">!   if(ParallelScavengeHeap::heap()-&gt;ps_collector_policy()-&gt;is_hetero_heap()) {</span>
      _virtual_space = new PSFileBackedVirtualSpace(rs, alignment, AllocateOldGenAt);
      if (!(static_cast &lt;PSFileBackedVirtualSpace*&gt;(_virtual_space))-&gt;initialize()) {
        vm_exit_during_initialization(&quot;Could not map space for PSOldGen at given AllocateOldGenAt path&quot;);
      }
    } else {
<span class="line-new-header">--- 66,11 ---</span>
    initialize_performance_counters(perf_data_name, level);
  }
  
  void PSOldGen::initialize_virtual_space(ReservedSpace rs, size_t alignment) {
  
<span class="line-modified">!   if(ParallelArguments::is_heterogeneous_heap()) {</span>
      _virtual_space = new PSFileBackedVirtualSpace(rs, alignment, AllocateOldGenAt);
      if (!(static_cast &lt;PSFileBackedVirtualSpace*&gt;(_virtual_space))-&gt;initialize()) {
        vm_exit_during_initialization(&quot;Could not map space for PSOldGen at given AllocateOldGenAt path&quot;);
      }
    } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 137,26 ***</span>
    //
    // ObjectSpace stuff
    //
  
    _object_space = new MutableSpace(virtual_space()-&gt;alignment());
<span class="line-removed">- </span>
<span class="line-removed">-   if (_object_space == NULL)</span>
<span class="line-removed">-     vm_exit_during_initialization(&quot;Could not allocate an old gen space&quot;);</span>
<span class="line-removed">- </span>
    object_space()-&gt;initialize(cmr,
                               SpaceDecorator::Clear,
                               SpaceDecorator::Mangle);
  
<span class="line-removed">- #if INCLUDE_SERIALGC</span>
<span class="line-removed">-   _object_mark_sweep = new PSMarkSweepDecorator(_object_space, start_array(), MarkSweepDeadRatio);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (_object_mark_sweep == NULL) {</span>
<span class="line-removed">-     vm_exit_during_initialization(&quot;Could not complete allocation of old generation&quot;);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- #endif // INCLUDE_SERIALGC</span>
<span class="line-removed">- </span>
    // Update the start_array
    start_array()-&gt;set_covered_region(cmr);
  }
  
  void PSOldGen::initialize_performance_counters(const char* perf_data_name, int level) {
<span class="line-new-header">--- 133,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 172,34 ***</span>
  // reserved size is not 0.
  bool  PSOldGen::is_allocated() {
    return virtual_space()-&gt;reserved_size() != 0;
  }
  
<span class="line-removed">- #if INCLUDE_SERIALGC</span>
<span class="line-removed">- </span>
<span class="line-removed">- void PSOldGen::precompact() {</span>
<span class="line-removed">-   ParallelScavengeHeap* heap = ParallelScavengeHeap::heap();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Reset start array first.</span>
<span class="line-removed">-   start_array()-&gt;reset();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   object_mark_sweep()-&gt;precompact();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Now compact the young gen</span>
<span class="line-removed">-   heap-&gt;young_gen()-&gt;precompact();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void PSOldGen::adjust_pointers() {</span>
<span class="line-removed">-   object_mark_sweep()-&gt;adjust_pointers();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void PSOldGen::compact() {</span>
<span class="line-removed">-   object_mark_sweep()-&gt;compact(ZapUnusedHeapArea);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #endif // INCLUDE_SERIALGC</span>
<span class="line-removed">- </span>
  size_t PSOldGen::contiguous_available() const {
    return object_space()-&gt;free_in_bytes() + virtual_space()-&gt;uncommitted_size();
  }
  
  // Allocation. We report all successful allocations to the size policy
<span class="line-new-header">--- 156,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 222,19 ***</span>
  }
  
  HeapWord* PSOldGen::expand_and_allocate(size_t word_size) {
    expand(word_size*HeapWordSize);
    if (GCExpandToAllocateDelayMillis &gt; 0) {
<span class="line-modified">!     os::sleep(Thread::current(), GCExpandToAllocateDelayMillis, false);</span>
    }
    return allocate_noexpand(word_size);
  }
  
  HeapWord* PSOldGen::expand_and_cas_allocate(size_t word_size) {
    expand(word_size*HeapWordSize);
    if (GCExpandToAllocateDelayMillis &gt; 0) {
<span class="line-modified">!     os::sleep(Thread::current(), GCExpandToAllocateDelayMillis, false);</span>
    }
    return cas_allocate_noexpand(word_size);
  }
  
  void PSOldGen::expand(size_t bytes) {
<span class="line-new-header">--- 182,19 ---</span>
  }
  
  HeapWord* PSOldGen::expand_and_allocate(size_t word_size) {
    expand(word_size*HeapWordSize);
    if (GCExpandToAllocateDelayMillis &gt; 0) {
<span class="line-modified">!     os::naked_sleep(GCExpandToAllocateDelayMillis);</span>
    }
    return allocate_noexpand(word_size);
  }
  
  HeapWord* PSOldGen::expand_and_cas_allocate(size_t word_size) {
    expand(word_size*HeapWordSize);
    if (GCExpandToAllocateDelayMillis &gt; 0) {
<span class="line-modified">!     os::naked_sleep(GCExpandToAllocateDelayMillis);</span>
    }
    return cas_allocate_noexpand(word_size);
  }
  
  void PSOldGen::expand(size_t bytes) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 352,11 ***</span>
    if (new_size &lt; used_in_bytes()) {
      // Overflowed the addition.
      new_size = gen_size_limit();
    }
    // Adjust according to our min and max
<span class="line-modified">!   new_size = MAX2(MIN2(new_size, gen_size_limit()), min_gen_size());</span>
  
    assert(gen_size_limit() &gt;= reserved().byte_size(), &quot;max new size problem?&quot;);
    new_size = align_up(new_size, alignment);
  
    const size_t current_size = capacity_in_bytes();
<span class="line-new-header">--- 312,11 ---</span>
    if (new_size &lt; used_in_bytes()) {
      // Overflowed the addition.
      new_size = gen_size_limit();
    }
    // Adjust according to our min and max
<span class="line-modified">!   new_size = clamp(new_size, min_gen_size(), gen_size_limit());</span>
  
    assert(gen_size_limit() &gt;= reserved().byte_size(), &quot;max new size problem?&quot;);
    new_size = align_up(new_size, alignment);
  
    const size_t current_size = capacity_in_bytes();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 440,15 ***</span>
                  p2i(virtual_space()-&gt;high_boundary()));
  
    st-&gt;print(&quot;  object&quot;); object_space()-&gt;print_on(st);
  }
  
<span class="line-removed">- void PSOldGen::print_used_change(size_t prev_used) const {</span>
<span class="line-removed">-   log_info(gc, heap)(&quot;%s: &quot;  SIZE_FORMAT &quot;K-&gt;&quot; SIZE_FORMAT &quot;K(&quot;  SIZE_FORMAT &quot;K)&quot;,</span>
<span class="line-removed">-       name(), prev_used / K, used_in_bytes() / K, capacity_in_bytes() / K);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void PSOldGen::update_counters() {
    if (UsePerfData) {
      _space_counters-&gt;update_all();
      _gen_counters-&gt;update_all();
    }
<span class="line-new-header">--- 400,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 484,13 ***</span>
   public:
    VerifyObjectStartArrayClosure(PSOldGen* old_gen, ObjectStartArray* start_array) :
      _old_gen(old_gen), _start_array(start_array) { }
  
    virtual void do_object(oop obj) {
<span class="line-modified">!     HeapWord* test_addr = (HeapWord*)obj + 1;</span>
<span class="line-modified">!     guarantee(_start_array-&gt;object_start(test_addr) == (HeapWord*)obj, &quot;ObjectStartArray cannot find start of object&quot;);</span>
<span class="line-modified">!     guarantee(_start_array-&gt;is_block_allocated((HeapWord*)obj), &quot;ObjectStartArray missing block allocation&quot;);</span>
    }
  };
  
  void PSOldGen::verify_object_start_array() {
    VerifyObjectStartArrayClosure check( this, &amp;_start_array );
<span class="line-new-header">--- 439,13 ---</span>
   public:
    VerifyObjectStartArrayClosure(PSOldGen* old_gen, ObjectStartArray* start_array) :
      _old_gen(old_gen), _start_array(start_array) { }
  
    virtual void do_object(oop obj) {
<span class="line-modified">!     HeapWord* test_addr = cast_from_oop&lt;HeapWord*&gt;(obj) + 1;</span>
<span class="line-modified">!     guarantee(_start_array-&gt;object_start(test_addr) == cast_from_oop&lt;HeapWord*&gt;(obj), &quot;ObjectStartArray cannot find start of object&quot;);</span>
<span class="line-modified">!     guarantee(_start_array-&gt;is_block_allocated(cast_from_oop&lt;HeapWord*&gt;(obj)), &quot;ObjectStartArray missing block allocation&quot;);</span>
    }
  };
  
  void PSOldGen::verify_object_start_array() {
    VerifyObjectStartArrayClosure check( this, &amp;_start_array );
</pre>
<center><a href="psFileBackedVirtualspace.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="psOldGen.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>