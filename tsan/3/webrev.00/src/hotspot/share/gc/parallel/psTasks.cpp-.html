<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/parallel/psTasks.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;aot/aotLoader.hpp&quot;
 27 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 28 #include &quot;classfile/systemDictionary.hpp&quot;
 29 #include &quot;code/codeCache.hpp&quot;
 30 #include &quot;gc/parallel/gcTaskManager.hpp&quot;
 31 #include &quot;gc/parallel/parallelScavengeHeap.inline.hpp&quot;
 32 #include &quot;gc/parallel/psCardTable.hpp&quot;
 33 #include &quot;gc/parallel/psClosure.inline.hpp&quot;
 34 #include &quot;gc/parallel/psPromotionManager.hpp&quot;
 35 #include &quot;gc/parallel/psPromotionManager.inline.hpp&quot;
 36 #include &quot;gc/parallel/psScavenge.inline.hpp&quot;
 37 #include &quot;gc/parallel/psTasks.hpp&quot;
 38 #include &quot;gc/shared/scavengableNMethods.hpp&quot;
 39 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
 40 #include &quot;memory/iterator.hpp&quot;
 41 #include &quot;memory/resourceArea.hpp&quot;
 42 #include &quot;memory/universe.hpp&quot;
 43 #include &quot;oops/oop.inline.hpp&quot;
 44 #include &quot;runtime/thread.hpp&quot;
 45 #include &quot;runtime/vmThread.hpp&quot;
 46 #include &quot;services/management.hpp&quot;
 47 
 48 //
 49 // ScavengeRootsTask
 50 //
 51 
 52 void ScavengeRootsTask::do_it(GCTaskManager* manager, uint which) {
 53   assert(ParallelScavengeHeap::heap()-&gt;is_gc_active(), &quot;called outside gc&quot;);
 54 
 55   PSPromotionManager* pm = PSPromotionManager::gc_thread_promotion_manager(which);
 56   PSScavengeRootsClosure roots_closure(pm);
 57   PSPromoteRootsClosure  roots_to_old_closure(pm);
 58 
 59   switch (_root_type) {
 60     case universe:
 61       Universe::oops_do(&amp;roots_closure);
 62       break;
 63 
 64     case jni_handles:
 65       JNIHandles::oops_do(&amp;roots_closure);
 66       break;
 67 
 68     case threads:
 69     {
 70       ResourceMark rm;
 71       Threads::oops_do(&amp;roots_closure, NULL);
 72     }
 73     break;
 74 
 75     case object_synchronizer:
 76       ObjectSynchronizer::oops_do(&amp;roots_closure);
 77       break;
 78 
 79     case system_dictionary:
 80       SystemDictionary::oops_do(&amp;roots_closure);
 81       break;
 82 
 83     case class_loader_data:
 84     {
 85       PSScavengeCLDClosure cld_closure(pm);
 86       ClassLoaderDataGraph::cld_do(&amp;cld_closure);
 87     }
 88     break;
 89 
 90     case management:
 91       Management::oops_do(&amp;roots_closure);
 92       break;
 93 
 94     case jvmti:
 95       JvmtiExport::oops_do(&amp;roots_closure);
 96       break;
 97 
 98 
 99     case code_cache:
100       {
101         MarkingCodeBlobClosure each_scavengable_code_blob(&amp;roots_to_old_closure, CodeBlobToOopClosure::FixRelocations);
102         ScavengableNMethods::scavengable_nmethods_do(&amp;each_scavengable_code_blob);
103         AOTLoader::oops_do(&amp;roots_closure);
104       }
105       break;
106 
107     default:
108       fatal(&quot;Unknown root type&quot;);
109   }
110 
111   // Do the real work
112   pm-&gt;drain_stacks(false);
113 }
114 
115 //
116 // ThreadRootsTask
117 //
118 
119 void ThreadRootsTask::do_it(GCTaskManager* manager, uint which) {
120   assert(ParallelScavengeHeap::heap()-&gt;is_gc_active(), &quot;called outside gc&quot;);
121 
122   PSPromotionManager* pm = PSPromotionManager::gc_thread_promotion_manager(which);
123   PSScavengeRootsClosure roots_closure(pm);
124   MarkingCodeBlobClosure roots_in_blobs(&amp;roots_closure, CodeBlobToOopClosure::FixRelocations);
125 
126   _thread-&gt;oops_do(&amp;roots_closure, &amp;roots_in_blobs);
127 
128   // Do the real work
129   pm-&gt;drain_stacks(false);
130 }
131 
132 //
133 // StealTask
134 //
135 
136 StealTask::StealTask(ParallelTaskTerminator* t) :
137   _terminator(t) {}
138 
139 void StealTask::do_it(GCTaskManager* manager, uint which) {
140   assert(ParallelScavengeHeap::heap()-&gt;is_gc_active(), &quot;called outside gc&quot;);
141 
142   PSPromotionManager* pm =
143     PSPromotionManager::gc_thread_promotion_manager(which);
144   pm-&gt;drain_stacks(true);
145   guarantee(pm-&gt;stacks_empty(),
146             &quot;stacks should be empty at this point&quot;);
147 
148   while(true) {
149     StarTask p;
150     if (PSPromotionManager::steal_depth(which, p)) {
151       TASKQUEUE_STATS_ONLY(pm-&gt;record_steal(p));
152       pm-&gt;process_popped_location_depth(p);
153       pm-&gt;drain_stacks_depth(true);
154     } else {
155       if (terminator()-&gt;offer_termination()) {
156         break;
157       }
158     }
159   }
160   guarantee(pm-&gt;stacks_empty(), &quot;stacks should be empty at this point&quot;);
161 }
162 
163 //
164 // OldToYoungRootsTask
165 //
166 
167 void OldToYoungRootsTask::do_it(GCTaskManager* manager, uint which) {
168   // There are not old-to-young pointers if the old gen is empty.
169   assert(!_old_gen-&gt;object_space()-&gt;is_empty(),
170     &quot;Should not be called is there is no work&quot;);
171   assert(_old_gen != NULL, &quot;Sanity&quot;);
172   assert(_old_gen-&gt;object_space()-&gt;contains(_gen_top) || _gen_top == _old_gen-&gt;object_space()-&gt;top(), &quot;Sanity&quot;);
173   assert(_stripe_number &lt; ParallelGCThreads, &quot;Sanity&quot;);
174 
175   {
176     PSPromotionManager* pm = PSPromotionManager::gc_thread_promotion_manager(which);
177     PSCardTable* card_table = ParallelScavengeHeap::heap()-&gt;card_table();
178 
179     card_table-&gt;scavenge_contents_parallel(_old_gen-&gt;start_array(),
180                                            _old_gen-&gt;object_space(),
181                                            _gen_top,
182                                            pm,
183                                            _stripe_number,
184                                            _stripe_total);
185 
186     // Do the real work
187     pm-&gt;drain_stacks(false);
188   }
189 }
    </pre>
  </body>
</html>