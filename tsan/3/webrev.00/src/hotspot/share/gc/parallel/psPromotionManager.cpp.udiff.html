<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/parallel/psPromotionManager.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="psPromotionLAB.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="psPromotionManager.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/parallel/psPromotionManager.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,11 +22,10 @@</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/javaClasses.inline.hpp&quot;
<span class="udiff-line-removed">- #include &quot;gc/parallel/gcTaskManager.hpp&quot;</span>
  #include &quot;gc/parallel/mutableSpace.hpp&quot;
  #include &quot;gc/parallel/parallelScavengeHeap.hpp&quot;
  #include &quot;gc/parallel/psOldGen.hpp&quot;
  #include &quot;gc/parallel/psPromotionManager.inline.hpp&quot;
  #include &quot;gc/parallel/psScavenge.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,11 +41,11 @@</span>
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/compressedOops.inline.hpp&quot;
  
  PaddedEnd&lt;PSPromotionManager&gt;* PSPromotionManager::_manager_array = NULL;
<span class="udiff-line-modified-removed">- OopStarTaskQueueSet*           PSPromotionManager::_stack_array_depth = NULL;</span>
<span class="udiff-line-modified-added">+ PSPromotionManager::OopStarTaskQueueSet* PSPromotionManager::_stack_array_depth = NULL;</span>
  PreservedMarksSet*             PSPromotionManager::_preserved_marks_set = NULL;
  PSOldGen*                      PSPromotionManager::_old_gen = NULL;
  MutableSpace*                  PSPromotionManager::_young_space = NULL;
  
  void PSPromotionManager::initialize() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -59,25 +58,22 @@</span>
  
    // To prevent false sharing, we pad the PSPromotionManagers
    // and make sure that the first instance starts at a cache line.
    assert(_manager_array == NULL, &quot;Attempt to initialize twice&quot;);
    _manager_array = PaddedArray&lt;PSPromotionManager, mtGC&gt;::create_unfreeable(promotion_manager_num);
<span class="udiff-line-removed">-   guarantee(_manager_array != NULL, &quot;Could not initialize promotion manager&quot;);</span>
  
    _stack_array_depth = new OopStarTaskQueueSet(ParallelGCThreads);
<span class="udiff-line-removed">-   guarantee(_stack_array_depth != NULL, &quot;Could not initialize promotion manager&quot;);</span>
  
    // Create and register the PSPromotionManager(s) for the worker threads.
    for(uint i=0; i&lt;ParallelGCThreads; i++) {
      stack_array_depth()-&gt;register_queue(i, _manager_array[i].claimed_stack_depth());
    }
    // The VMThread gets its own PSPromotionManager, which is not available
    // for work stealing.
  
    assert(_preserved_marks_set == NULL, &quot;Attempt to initialize twice&quot;);
    _preserved_marks_set = new PreservedMarksSet(true /* in_c_heap */);
<span class="udiff-line-removed">-   guarantee(_preserved_marks_set != NULL, &quot;Could not initialize preserved marks set&quot;);</span>
    _preserved_marks_set-&gt;init(promotion_manager_num);
    for (uint i = 0; i &lt; promotion_manager_num; i += 1) {
      _manager_array[i].register_preserved_marks(_preserved_marks_set-&gt;get(i));
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -238,57 +234,12 @@</span>
  void PSPromotionManager::register_preserved_marks(PreservedMarks* preserved_marks) {
    assert(_preserved_marks == NULL, &quot;do not set it twice&quot;);
    _preserved_marks = preserved_marks;
  }
  
<span class="udiff-line-removed">- class ParRestoreGCTask : public GCTask {</span>
<span class="udiff-line-removed">- private:</span>
<span class="udiff-line-removed">-   const uint _id;</span>
<span class="udiff-line-removed">-   PreservedMarksSet* const _preserved_marks_set;</span>
<span class="udiff-line-removed">-   volatile size_t* const _total_size_addr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   virtual char* name() {</span>
<span class="udiff-line-removed">-     return (char*) &quot;preserved mark restoration task&quot;;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   virtual void do_it(GCTaskManager* manager, uint which){</span>
<span class="udiff-line-removed">-     _preserved_marks_set-&gt;get(_id)-&gt;restore_and_increment(_total_size_addr);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ParRestoreGCTask(uint id,</span>
<span class="udiff-line-removed">-                    PreservedMarksSet* preserved_marks_set,</span>
<span class="udiff-line-removed">-                    volatile size_t* total_size_addr)</span>
<span class="udiff-line-removed">-     : _id(id),</span>
<span class="udiff-line-removed">-       _preserved_marks_set(preserved_marks_set),</span>
<span class="udiff-line-removed">-       _total_size_addr(total_size_addr) { }</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class PSRestorePreservedMarksTaskExecutor : public RestorePreservedMarksTaskExecutor {</span>
<span class="udiff-line-removed">- private:</span>
<span class="udiff-line-removed">-   GCTaskManager* _gc_task_manager;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   PSRestorePreservedMarksTaskExecutor(GCTaskManager* gc_task_manager)</span>
<span class="udiff-line-removed">-       : _gc_task_manager(gc_task_manager) { }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void restore(PreservedMarksSet* preserved_marks_set,</span>
<span class="udiff-line-removed">-                volatile size_t* total_size_addr) {</span>
<span class="udiff-line-removed">-     // GCTask / GCTaskQueue are ResourceObjs</span>
<span class="udiff-line-removed">-     ResourceMark rm;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     GCTaskQueue* q = GCTaskQueue::create();</span>
<span class="udiff-line-removed">-     for (uint i = 0; i &lt; preserved_marks_set-&gt;num(); i += 1) {</span>
<span class="udiff-line-removed">-       q-&gt;enqueue(new ParRestoreGCTask(i, preserved_marks_set, total_size_addr));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     _gc_task_manager-&gt;execute_and_wait(q);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
  void PSPromotionManager::restore_preserved_marks() {
<span class="udiff-line-modified-removed">-   PSRestorePreservedMarksTaskExecutor task_executor(PSScavenge::gc_task_manager());</span>
<span class="udiff-line-removed">-   _preserved_marks_set-&gt;restore(&amp;task_executor);</span>
<span class="udiff-line-modified-added">+   _preserved_marks_set-&gt;restore(&amp;ParallelScavengeHeap::heap()-&gt;workers());</span>
  }
  
  void PSPromotionManager::drain_stacks_depth(bool totally_drain) {
    totally_drain = totally_drain || _totally_drain;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,11 +339,11 @@</span>
    } else {
      process_array_chunk_work&lt;oop&gt;(obj, start, end);
    }
  }
  
<span class="udiff-line-modified-removed">- oop PSPromotionManager::oop_promotion_failed(oop obj, markOop obj_mark) {</span>
<span class="udiff-line-modified-added">+ oop PSPromotionManager::oop_promotion_failed(oop obj, markWord obj_mark) {</span>
    assert(_old_gen_is_full || PromotionFailureALot, &quot;Sanity&quot;);
  
    // Attempt to CAS in the header.
    // This tests if the header is still the same as when
    // this started.  If it is the same (i.e., no forwarding
</pre>
<center><a href="psPromotionLAB.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="psPromotionManager.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>