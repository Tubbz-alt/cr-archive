<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/cms/promotionInfo.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  *
23  */
24 
25 #ifndef SHARE_GC_CMS_PROMOTIONINFO_INLINE_HPP
26 #define SHARE_GC_CMS_PROMOTIONINFO_INLINE_HPP
27 
28 #include &quot;gc/cms/promotionInfo.hpp&quot;
29 #include &quot;oops/oop.inline.hpp&quot;
30 #include &quot;utilities/debug.hpp&quot;
31 #include &quot;utilities/macros.hpp&quot;
32 
33 //////////////////////////////////////////////////////////////////////////////
34 // We go over the list of promoted objects, removing each from the list,
35 // and applying the closure (this may, in turn, add more elements to
36 // the tail of the promoted list, and these newly added objects will
37 // also be processed) until the list is empty.
38 // To aid verification and debugging, in the non-product builds
39 // we actually forward _promoHead each time we process a promoted oop.
40 // Note that this is not necessary in general (i.e. when we don&#39;t need to
41 // call PromotionInfo::verify()) because oop_iterate can only add to the
42 // end of _promoTail, and never needs to look at _promoHead.
43 
44 template &lt;typename OopClosureType&gt;
45 void PromotionInfo::promoted_oops_iterate(OopClosureType* cl) {
46   NOT_PRODUCT(verify());
47   PromotedObject *curObj, *nextObj;
48   for (curObj = _promoHead; curObj != NULL; curObj = nextObj) {
49     if ((nextObj = curObj-&gt;next()) == NULL) {
50       /* protect ourselves against additions due to closure application
51          below by resetting the list.  */
52       assert(_promoTail == curObj, &quot;Should have been the tail&quot;);
53       _promoHead = _promoTail = NULL;
54     }
55     if (curObj-&gt;hasDisplacedMark()) {
56       /* restore displaced header */
57       oop(curObj)-&gt;set_mark_raw(nextDisplacedHeader());
58     } else {
59       /* restore prototypical header */
60       oop(curObj)-&gt;init_mark_raw();
61     }
62     /* The &quot;promoted_mark&quot; should now not be set */
63     assert(!curObj-&gt;hasPromotedMark(),
64            &quot;Should have been cleared by restoring displaced mark-word&quot;);
65     NOT_PRODUCT(_promoHead = nextObj);
66     if (cl != NULL) oop(curObj)-&gt;oop_iterate(cl);
67     if (nextObj == NULL) { /* start at head of list reset above */
68       nextObj = _promoHead;
69     }
70   }
71   assert(noPromotions(), &quot;post-condition violation&quot;);
72   assert(_promoHead == NULL &amp;&amp; _promoTail == NULL, &quot;emptied promoted list&quot;);
73   assert(_spoolHead == _spoolTail, &quot;emptied spooling buffers&quot;);
74   assert(_firstIndex == _nextIndex, &quot;empty buffer&quot;);
75 }
76 
77 #endif // SHARE_GC_CMS_PROMOTIONINFO_INLINE_HPP
    </pre>
  </body>
</html>