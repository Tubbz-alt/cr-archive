<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/cms/concurrentMarkSweepGeneration.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/stringTable.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;gc/cms/cmsCollectorPolicy.hpp&quot;
  32 #include &quot;gc/cms/cmsGCStats.hpp&quot;
  33 #include &quot;gc/cms/cmsHeap.hpp&quot;
  34 #include &quot;gc/cms/cmsOopClosures.inline.hpp&quot;
  35 #include &quot;gc/cms/cmsVMOperations.hpp&quot;
  36 #include &quot;gc/cms/compactibleFreeListSpace.hpp&quot;
  37 #include &quot;gc/cms/concurrentMarkSweepGeneration.inline.hpp&quot;
  38 #include &quot;gc/cms/concurrentMarkSweepThread.hpp&quot;
  39 #include &quot;gc/cms/parNewGeneration.hpp&quot;
  40 #include &quot;gc/cms/promotionInfo.inline.hpp&quot;
  41 #include &quot;gc/serial/genMarkSweep.hpp&quot;
  42 #include &quot;gc/serial/tenuredGeneration.hpp&quot;
  43 #include &quot;gc/shared/adaptiveSizePolicy.hpp&quot;
  44 #include &quot;gc/shared/cardGeneration.inline.hpp&quot;
  45 #include &quot;gc/shared/cardTableRS.hpp&quot;
  46 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  47 #include &quot;gc/shared/collectorCounters.hpp&quot;
  48 #include &quot;gc/shared/collectorPolicy.hpp&quot;
  49 #include &quot;gc/shared/gcLocker.hpp&quot;
  50 #include &quot;gc/shared/gcPolicyCounters.hpp&quot;
  51 #include &quot;gc/shared/gcTimer.hpp&quot;
  52 #include &quot;gc/shared/gcTrace.hpp&quot;
  53 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  54 #include &quot;gc/shared/genCollectedHeap.hpp&quot;
  55 #include &quot;gc/shared/genOopClosures.inline.hpp&quot;
  56 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  57 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  58 #include &quot;gc/shared/owstTaskTerminator.hpp&quot;
  59 #include &quot;gc/shared/referencePolicy.hpp&quot;
  60 #include &quot;gc/shared/referenceProcessorPhaseTimes.hpp&quot;
  61 #include &quot;gc/shared/space.inline.hpp&quot;
  62 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  63 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  64 #include &quot;gc/shared/weakProcessor.hpp&quot;
  65 #include &quot;gc/shared/workerPolicy.hpp&quot;
  66 #include &quot;logging/log.hpp&quot;
  67 #include &quot;logging/logStream.hpp&quot;
  68 #include &quot;memory/allocation.hpp&quot;
  69 #include &quot;memory/binaryTreeDictionary.inline.hpp&quot;
  70 #include &quot;memory/iterator.inline.hpp&quot;
  71 #include &quot;memory/padded.hpp&quot;
  72 #include &quot;memory/resourceArea.hpp&quot;
  73 #include &quot;oops/access.inline.hpp&quot;
  74 #include &quot;oops/oop.inline.hpp&quot;
  75 #include &quot;prims/jvmtiExport.hpp&quot;
  76 #include &quot;runtime/atomic.hpp&quot;
  77 #include &quot;runtime/flags/flagSetting.hpp&quot;
  78 #include &quot;runtime/globals_extension.hpp&quot;
  79 #include &quot;runtime/handles.inline.hpp&quot;
  80 #include &quot;runtime/java.hpp&quot;
  81 #include &quot;runtime/orderAccess.hpp&quot;
  82 #include &quot;runtime/timer.hpp&quot;
  83 #include &quot;runtime/vmThread.hpp&quot;
  84 #include &quot;services/memoryService.hpp&quot;
  85 #include &quot;services/runtimeService.hpp&quot;
  86 #include &quot;utilities/align.hpp&quot;
  87 #include &quot;utilities/stack.inline.hpp&quot;
  88 
  89 // statics
  90 CMSCollector* ConcurrentMarkSweepGeneration::_collector = NULL;
  91 bool CMSCollector::_full_gc_requested = false;
  92 GCCause::Cause CMSCollector::_full_gc_cause = GCCause::_no_gc;
  93 
  94 //////////////////////////////////////////////////////////////////
  95 // In support of CMS/VM thread synchronization
  96 //////////////////////////////////////////////////////////////////
  97 // We split use of the CGC_lock into 2 &quot;levels&quot;.
  98 // The low-level locking is of the usual CGC_lock monitor. We introduce
  99 // a higher level &quot;token&quot; (hereafter &quot;CMS token&quot;) built on top of the
 100 // low level monitor (hereafter &quot;CGC lock&quot;).
 101 // The token-passing protocol gives priority to the VM thread. The
 102 // CMS-lock doesn&#39;t provide any fairness guarantees, but clients
 103 // should ensure that it is only held for very short, bounded
 104 // durations.
 105 //
 106 // When either of the CMS thread or the VM thread is involved in
 107 // collection operations during which it does not want the other
 108 // thread to interfere, it obtains the CMS token.
 109 //
 110 // If either thread tries to get the token while the other has
 111 // it, that thread waits. However, if the VM thread and CMS thread
 112 // both want the token, then the VM thread gets priority while the
 113 // CMS thread waits. This ensures, for instance, that the &quot;concurrent&quot;
 114 // phases of the CMS thread&#39;s work do not block out the VM thread
 115 // for long periods of time as the CMS thread continues to hog
 116 // the token. (See bug 4616232).
 117 //
 118 // The baton-passing functions are, however, controlled by the
 119 // flags _foregroundGCShouldWait and _foregroundGCIsActive,
 120 // and here the low-level CMS lock, not the high level token,
 121 // ensures mutual exclusion.
 122 //
 123 // Two important conditions that we have to satisfy:
 124 // 1. if a thread does a low-level wait on the CMS lock, then it
 125 //    relinquishes the CMS token if it were holding that token
 126 //    when it acquired the low-level CMS lock.
 127 // 2. any low-level notifications on the low-level lock
 128 //    should only be sent when a thread has relinquished the token.
 129 //
 130 // In the absence of either property, we&#39;d have potential deadlock.
 131 //
 132 // We protect each of the CMS (concurrent and sequential) phases
 133 // with the CMS _token_, not the CMS _lock_.
 134 //
 135 // The only code protected by CMS lock is the token acquisition code
 136 // itself, see ConcurrentMarkSweepThread::[de]synchronize(), and the
 137 // baton-passing code.
 138 //
 139 // Unfortunately, i couldn&#39;t come up with a good abstraction to factor and
 140 // hide the naked CGC_lock manipulation in the baton-passing code
 141 // further below. That&#39;s something we should try to do. Also, the proof
 142 // of correctness of this 2-level locking scheme is far from obvious,
 143 // and potentially quite slippery. We have an uneasy suspicion, for instance,
 144 // that there may be a theoretical possibility of delay/starvation in the
 145 // low-level lock/wait/notify scheme used for the baton-passing because of
 146 // potential interference with the priority scheme embodied in the
 147 // CMS-token-passing protocol. See related comments at a CGC_lock-&gt;wait()
 148 // invocation further below and marked with &quot;XXX 20011219YSR&quot;.
 149 // Indeed, as we note elsewhere, this may become yet more slippery
 150 // in the presence of multiple CMS and/or multiple VM threads. XXX
 151 
 152 class CMSTokenSync: public StackObj {
 153  private:
 154   bool _is_cms_thread;
 155  public:
 156   CMSTokenSync(bool is_cms_thread):
 157     _is_cms_thread(is_cms_thread) {
 158     assert(is_cms_thread == Thread::current()-&gt;is_ConcurrentGC_thread(),
 159            &quot;Incorrect argument to constructor&quot;);
 160     ConcurrentMarkSweepThread::synchronize(_is_cms_thread);
 161   }
 162 
 163   ~CMSTokenSync() {
 164     assert(_is_cms_thread ?
 165              ConcurrentMarkSweepThread::cms_thread_has_cms_token() :
 166              ConcurrentMarkSweepThread::vm_thread_has_cms_token(),
 167           &quot;Incorrect state&quot;);
 168     ConcurrentMarkSweepThread::desynchronize(_is_cms_thread);
 169   }
 170 };
 171 
 172 // Convenience class that does a CMSTokenSync, and then acquires
 173 // upto three locks.
 174 class CMSTokenSyncWithLocks: public CMSTokenSync {
 175  private:
 176   // Note: locks are acquired in textual declaration order
 177   // and released in the opposite order
 178   MutexLockerEx _locker1, _locker2, _locker3;
 179  public:
 180   CMSTokenSyncWithLocks(bool is_cms_thread, Mutex* mutex1,
 181                         Mutex* mutex2 = NULL, Mutex* mutex3 = NULL):
 182     CMSTokenSync(is_cms_thread),
 183     _locker1(mutex1, Mutex::_no_safepoint_check_flag),
 184     _locker2(mutex2, Mutex::_no_safepoint_check_flag),
 185     _locker3(mutex3, Mutex::_no_safepoint_check_flag)
 186   { }
 187 };
 188 
 189 
 190 //////////////////////////////////////////////////////////////////
 191 //  Concurrent Mark-Sweep Generation /////////////////////////////
 192 //////////////////////////////////////////////////////////////////
 193 
 194 NOT_PRODUCT(CompactibleFreeListSpace* debug_cms_space;)
 195 
 196 // This struct contains per-thread things necessary to support parallel
 197 // young-gen collection.
 198 class CMSParGCThreadState: public CHeapObj&lt;mtGC&gt; {
 199  public:
 200   CompactibleFreeListSpaceLAB lab;
 201   PromotionInfo promo;
 202 
 203   // Constructor.
 204   CMSParGCThreadState(CompactibleFreeListSpace* cfls) : lab(cfls) {
 205     promo.setSpace(cfls);
 206   }
 207 };
 208 
 209 ConcurrentMarkSweepGeneration::ConcurrentMarkSweepGeneration(
 210      ReservedSpace rs, size_t initial_byte_size, CardTableRS* ct) :
 211   CardGeneration(rs, initial_byte_size, ct),
 212   _dilatation_factor(((double)MinChunkSize)/((double)(CollectedHeap::min_fill_size()))),
 213   _did_compact(false)
 214 {
 215   HeapWord* bottom = (HeapWord*) _virtual_space.low();
 216   HeapWord* end    = (HeapWord*) _virtual_space.high();
 217 
 218   _direct_allocated_words = 0;
 219   NOT_PRODUCT(
 220     _numObjectsPromoted = 0;
 221     _numWordsPromoted = 0;
 222     _numObjectsAllocated = 0;
 223     _numWordsAllocated = 0;
 224   )
 225 
 226   _cmsSpace = new CompactibleFreeListSpace(_bts, MemRegion(bottom, end));
 227   NOT_PRODUCT(debug_cms_space = _cmsSpace;)
 228   _cmsSpace-&gt;_old_gen = this;
 229 
 230   _gc_stats = new CMSGCStats();
 231 
 232   // Verify the assumption that FreeChunk::_prev and OopDesc::_klass
 233   // offsets match. The ability to tell free chunks from objects
 234   // depends on this property.
 235   debug_only(
 236     FreeChunk* junk = NULL;
 237     assert(UseCompressedClassPointers ||
 238            junk-&gt;prev_addr() == (void*)(oop(junk)-&gt;klass_addr()),
 239            &quot;Offset of FreeChunk::_prev within FreeChunk must match&quot;
 240            &quot;  that of OopDesc::_klass within OopDesc&quot;);
 241   )
 242 
 243   _par_gc_thread_states = NEW_C_HEAP_ARRAY(CMSParGCThreadState*, ParallelGCThreads, mtGC);
 244   for (uint i = 0; i &lt; ParallelGCThreads; i++) {
 245     _par_gc_thread_states[i] = new CMSParGCThreadState(cmsSpace());
 246   }
 247 
 248   _incremental_collection_failed = false;
 249   // The &quot;dilatation_factor&quot; is the expansion that can occur on
 250   // account of the fact that the minimum object size in the CMS
 251   // generation may be larger than that in, say, a contiguous young
 252   //  generation.
 253   // Ideally, in the calculation below, we&#39;d compute the dilatation
 254   // factor as: MinChunkSize/(promoting_gen&#39;s min object size)
 255   // Since we do not have such a general query interface for the
 256   // promoting generation, we&#39;ll instead just use the minimum
 257   // object size (which today is a header&#39;s worth of space);
 258   // note that all arithmetic is in units of HeapWords.
 259   assert(MinChunkSize &gt;= CollectedHeap::min_fill_size(), &quot;just checking&quot;);
 260   assert(_dilatation_factor &gt;= 1.0, &quot;from previous assert&quot;);
 261 }
 262 
 263 
 264 // The field &quot;_initiating_occupancy&quot; represents the occupancy percentage
 265 // at which we trigger a new collection cycle.  Unless explicitly specified
 266 // via CMSInitiatingOccupancyFraction (argument &quot;io&quot; below), it
 267 // is calculated by:
 268 //
 269 //   Let &quot;f&quot; be MinHeapFreeRatio in
 270 //
 271 //    _initiating_occupancy = 100-f +
 272 //                           f * (CMSTriggerRatio/100)
 273 //   where CMSTriggerRatio is the argument &quot;tr&quot; below.
 274 //
 275 // That is, if we assume the heap is at its desired maximum occupancy at the
 276 // end of a collection, we let CMSTriggerRatio of the (purported) free
 277 // space be allocated before initiating a new collection cycle.
 278 //
 279 void ConcurrentMarkSweepGeneration::init_initiating_occupancy(intx io, uintx tr) {
 280   assert(io &lt;= 100 &amp;&amp; tr &lt;= 100, &quot;Check the arguments&quot;);
 281   if (io &gt;= 0) {
 282     _initiating_occupancy = (double)io / 100.0;
 283   } else {
 284     _initiating_occupancy = ((100 - MinHeapFreeRatio) +
 285                              (double)(tr * MinHeapFreeRatio) / 100.0)
 286                             / 100.0;
 287   }
 288 }
 289 
 290 void ConcurrentMarkSweepGeneration::ref_processor_init() {
 291   assert(collector() != NULL, &quot;no collector&quot;);
 292   collector()-&gt;ref_processor_init();
 293 }
 294 
 295 void CMSCollector::ref_processor_init() {
 296   if (_ref_processor == NULL) {
 297     // Allocate and initialize a reference processor
 298     _ref_processor =
 299       new ReferenceProcessor(&amp;_span_based_discoverer,
 300                              (ParallelGCThreads &gt; 1) &amp;&amp; ParallelRefProcEnabled, // mt processing
 301                              ParallelGCThreads,                      // mt processing degree
 302                              _cmsGen-&gt;refs_discovery_is_mt(),        // mt discovery
 303                              MAX2(ConcGCThreads, ParallelGCThreads), // mt discovery degree
 304                              _cmsGen-&gt;refs_discovery_is_atomic(),    // discovery is not atomic
 305                              &amp;_is_alive_closure,                     // closure for liveness info
 306                              false);                                 // disable adjusting number of processing threads
 307     // Initialize the _ref_processor field of CMSGen
 308     _cmsGen-&gt;set_ref_processor(_ref_processor);
 309 
 310   }
 311 }
 312 
 313 AdaptiveSizePolicy* CMSCollector::size_policy() {
 314   return CMSHeap::heap()-&gt;size_policy();
 315 }
 316 
 317 void ConcurrentMarkSweepGeneration::initialize_performance_counters() {
 318 
 319   const char* gen_name = &quot;old&quot;;
 320   GenCollectorPolicy* gcp = CMSHeap::heap()-&gt;gen_policy();
 321   // Generation Counters - generation 1, 1 subspace
 322   _gen_counters = new GenerationCounters(gen_name, 1, 1,
 323       gcp-&gt;min_old_size(), gcp-&gt;max_old_size(), &amp;_virtual_space);
 324 
 325   _space_counters = new GSpaceCounters(gen_name, 0,
 326                                        _virtual_space.reserved_size(),
 327                                        this, _gen_counters);
 328 }
 329 
 330 CMSStats::CMSStats(ConcurrentMarkSweepGeneration* cms_gen, unsigned int alpha):
 331   _cms_gen(cms_gen)
 332 {
 333   assert(alpha &lt;= 100, &quot;bad value&quot;);
 334   _saved_alpha = alpha;
 335 
 336   // Initialize the alphas to the bootstrap value of 100.
 337   _gc0_alpha = _cms_alpha = 100;
 338 
 339   _cms_begin_time.update();
 340   _cms_end_time.update();
 341 
 342   _gc0_duration = 0.0;
 343   _gc0_period = 0.0;
 344   _gc0_promoted = 0;
 345 
 346   _cms_duration = 0.0;
 347   _cms_period = 0.0;
 348   _cms_allocated = 0;
 349 
 350   _cms_used_at_gc0_begin = 0;
 351   _cms_used_at_gc0_end = 0;
 352   _allow_duty_cycle_reduction = false;
 353   _valid_bits = 0;
 354 }
 355 
 356 double CMSStats::cms_free_adjustment_factor(size_t free) const {
 357   // TBD: CR 6909490
 358   return 1.0;
 359 }
 360 
 361 void CMSStats::adjust_cms_free_adjustment_factor(bool fail, size_t free) {
 362 }
 363 
 364 // If promotion failure handling is on use
 365 // the padded average size of the promotion for each
 366 // young generation collection.
 367 double CMSStats::time_until_cms_gen_full() const {
 368   size_t cms_free = _cms_gen-&gt;cmsSpace()-&gt;free();
 369   CMSHeap* heap = CMSHeap::heap();
 370   size_t expected_promotion = MIN2(heap-&gt;young_gen()-&gt;capacity(),
 371                                    (size_t) _cms_gen-&gt;gc_stats()-&gt;avg_promoted()-&gt;padded_average());
 372   if (cms_free &gt; expected_promotion) {
 373     // Start a cms collection if there isn&#39;t enough space to promote
 374     // for the next young collection.  Use the padded average as
 375     // a safety factor.
 376     cms_free -= expected_promotion;
 377 
 378     // Adjust by the safety factor.
 379     double cms_free_dbl = (double)cms_free;
 380     double cms_adjustment = (100.0 - CMSIncrementalSafetyFactor) / 100.0;
 381     // Apply a further correction factor which tries to adjust
 382     // for recent occurance of concurrent mode failures.
 383     cms_adjustment = cms_adjustment * cms_free_adjustment_factor(cms_free);
 384     cms_free_dbl = cms_free_dbl * cms_adjustment;
 385 
 386     log_trace(gc)(&quot;CMSStats::time_until_cms_gen_full: cms_free &quot; SIZE_FORMAT &quot; expected_promotion &quot; SIZE_FORMAT,
 387                   cms_free, expected_promotion);
 388     log_trace(gc)(&quot;  cms_free_dbl %f cms_consumption_rate %f&quot;, cms_free_dbl, cms_consumption_rate() + 1.0);
 389     // Add 1 in case the consumption rate goes to zero.
 390     return cms_free_dbl / (cms_consumption_rate() + 1.0);
 391   }
 392   return 0.0;
 393 }
 394 
 395 // Compare the duration of the cms collection to the
 396 // time remaining before the cms generation is empty.
 397 // Note that the time from the start of the cms collection
 398 // to the start of the cms sweep (less than the total
 399 // duration of the cms collection) can be used.  This
 400 // has been tried and some applications experienced
 401 // promotion failures early in execution.  This was
 402 // possibly because the averages were not accurate
 403 // enough at the beginning.
 404 double CMSStats::time_until_cms_start() const {
 405   // We add &quot;gc0_period&quot; to the &quot;work&quot; calculation
 406   // below because this query is done (mostly) at the
 407   // end of a scavenge, so we need to conservatively
 408   // account for that much possible delay
 409   // in the query so as to avoid concurrent mode failures
 410   // due to starting the collection just a wee bit too
 411   // late.
 412   double work = cms_duration() + gc0_period();
 413   double deadline = time_until_cms_gen_full();
 414   // If a concurrent mode failure occurred recently, we want to be
 415   // more conservative and halve our expected time_until_cms_gen_full()
 416   if (work &gt; deadline) {
 417     log_develop_trace(gc)(&quot;CMSCollector: collect because of anticipated promotion before full %3.7f + %3.7f &gt; %3.7f &quot;,
 418                           cms_duration(), gc0_period(), time_until_cms_gen_full());
 419     return 0.0;
 420   }
 421   return work - deadline;
 422 }
 423 
 424 #ifndef PRODUCT
 425 void CMSStats::print_on(outputStream *st) const {
 426   st-&gt;print(&quot; gc0_alpha=%d,cms_alpha=%d&quot;, _gc0_alpha, _cms_alpha);
 427   st-&gt;print(&quot;,gc0_dur=%g,gc0_per=%g,gc0_promo=&quot; SIZE_FORMAT,
 428                gc0_duration(), gc0_period(), gc0_promoted());
 429   st-&gt;print(&quot;,cms_dur=%g,cms_per=%g,cms_alloc=&quot; SIZE_FORMAT,
 430             cms_duration(), cms_period(), cms_allocated());
 431   st-&gt;print(&quot;,cms_since_beg=%g,cms_since_end=%g&quot;,
 432             cms_time_since_begin(), cms_time_since_end());
 433   st-&gt;print(&quot;,cms_used_beg=&quot; SIZE_FORMAT &quot;,cms_used_end=&quot; SIZE_FORMAT,
 434             _cms_used_at_gc0_begin, _cms_used_at_gc0_end);
 435 
 436   if (valid()) {
 437     st-&gt;print(&quot;,promo_rate=%g,cms_alloc_rate=%g&quot;,
 438               promotion_rate(), cms_allocation_rate());
 439     st-&gt;print(&quot;,cms_consumption_rate=%g,time_until_full=%g&quot;,
 440               cms_consumption_rate(), time_until_cms_gen_full());
 441   }
 442   st-&gt;cr();
 443 }
 444 #endif // #ifndef PRODUCT
 445 
 446 CMSCollector::CollectorState CMSCollector::_collectorState =
 447                              CMSCollector::Idling;
 448 bool CMSCollector::_foregroundGCIsActive = false;
 449 bool CMSCollector::_foregroundGCShouldWait = false;
 450 
 451 CMSCollector::CMSCollector(ConcurrentMarkSweepGeneration* cmsGen,
 452                            CardTableRS*                   ct,
 453                            ConcurrentMarkSweepPolicy*     cp):
 454   _overflow_list(NULL),
 455   _conc_workers(NULL),     // may be set later
 456   _completed_initialization(false),
 457   _collection_count_start(0),
 458   _should_unload_classes(CMSClassUnloadingEnabled),
 459   _concurrent_cycles_since_last_unload(0),
 460   _roots_scanning_options(GenCollectedHeap::SO_None),
 461   _verification_mark_bm(0, Mutex::leaf + 1, &quot;CMS_verification_mark_bm_lock&quot;),
 462   _verifying(false),
 463   _collector_policy(cp),
 464   _inter_sweep_estimate(CMS_SweepWeight, CMS_SweepPadding),
 465   _intra_sweep_estimate(CMS_SweepWeight, CMS_SweepPadding),
 466   _gc_tracer_cm(new (ResourceObj::C_HEAP, mtGC) CMSTracer()),
 467   _gc_timer_cm(new (ResourceObj::C_HEAP, mtGC) ConcurrentGCTimer()),
 468   _cms_start_registered(false),
 469   _cmsGen(cmsGen),
 470   // Adjust span to cover old (cms) gen
 471   _span(cmsGen-&gt;reserved()),
 472   _ct(ct),
 473   _markBitMap(0, Mutex::leaf + 1, &quot;CMS_markBitMap_lock&quot;),
 474   _modUnionTable((CardTable::card_shift - LogHeapWordSize),
 475                  -1 /* lock-free */, &quot;No_lock&quot; /* dummy */),
 476   _restart_addr(NULL),
 477   _ser_pmc_preclean_ovflw(0),
 478   _ser_pmc_remark_ovflw(0),
 479   _par_pmc_remark_ovflw(0),
 480   _ser_kac_preclean_ovflw(0),
 481   _ser_kac_ovflw(0),
 482   _par_kac_ovflw(0),
 483 #ifndef PRODUCT
 484   _num_par_pushes(0),
 485 #endif
 486   _span_based_discoverer(_span),
 487   _ref_processor(NULL),    // will be set later
 488   // Construct the is_alive_closure with _span &amp; markBitMap
 489   _is_alive_closure(_span, &amp;_markBitMap),
 490   _modUnionClosurePar(&amp;_modUnionTable),
 491   _between_prologue_and_epilogue(false),
 492   _abort_preclean(false),
 493   _start_sampling(false),
 494   _stats(cmsGen),
 495   _eden_chunk_lock(new Mutex(Mutex::leaf + 1, &quot;CMS_eden_chunk_lock&quot;, true,
 496                              //verify that this lock should be acquired with safepoint check.
 497                              Monitor::_safepoint_check_sometimes)),
 498   _eden_chunk_array(NULL),     // may be set in ctor body
 499   _eden_chunk_index(0),        // -- ditto --
 500   _eden_chunk_capacity(0),     // -- ditto --
 501   _survivor_chunk_array(NULL), // -- ditto --
 502   _survivor_chunk_index(0),    // -- ditto --
 503   _survivor_chunk_capacity(0), // -- ditto --
 504   _survivor_plab_array(NULL)   // -- ditto --
 505 {
 506   // Now expand the span and allocate the collection support structures
 507   // (MUT, marking bit map etc.) to cover both generations subject to
 508   // collection.
 509 
 510   // For use by dirty card to oop closures.
 511   _cmsGen-&gt;cmsSpace()-&gt;set_collector(this);
 512 
 513   // Allocate MUT and marking bit map
 514   {
 515     MutexLockerEx x(_markBitMap.lock(), Mutex::_no_safepoint_check_flag);
 516     if (!_markBitMap.allocate(_span)) {
 517       log_warning(gc)(&quot;Failed to allocate CMS Bit Map&quot;);
 518       return;
 519     }
 520     assert(_markBitMap.covers(_span), &quot;_markBitMap inconsistency?&quot;);
 521   }
 522   {
 523     _modUnionTable.allocate(_span);
 524     assert(_modUnionTable.covers(_span), &quot;_modUnionTable inconsistency?&quot;);
 525   }
 526 
 527   if (!_markStack.allocate(MarkStackSize)) {
 528     log_warning(gc)(&quot;Failed to allocate CMS Marking Stack&quot;);
 529     return;
 530   }
 531 
 532   // Support for multi-threaded concurrent phases
 533   if (CMSConcurrentMTEnabled) {
 534     if (FLAG_IS_DEFAULT(ConcGCThreads)) {
 535       // just for now
 536       FLAG_SET_DEFAULT(ConcGCThreads, (ParallelGCThreads + 3) / 4);
 537     }
 538     if (ConcGCThreads &gt; 1) {
 539       _conc_workers = new YieldingFlexibleWorkGang(&quot;CMS Thread&quot;,
 540                                  ConcGCThreads, true);
 541       if (_conc_workers == NULL) {
 542         log_warning(gc)(&quot;GC/CMS: _conc_workers allocation failure: forcing -CMSConcurrentMTEnabled&quot;);
 543         CMSConcurrentMTEnabled = false;
 544       } else {
 545         _conc_workers-&gt;initialize_workers();
 546       }
 547     } else {
 548       CMSConcurrentMTEnabled = false;
 549     }
 550   }
 551   if (!CMSConcurrentMTEnabled) {
 552     ConcGCThreads = 0;
 553   } else {
 554     // Turn off CMSCleanOnEnter optimization temporarily for
 555     // the MT case where it&#39;s not fixed yet; see 6178663.
 556     CMSCleanOnEnter = false;
 557   }
 558   assert((_conc_workers != NULL) == (ConcGCThreads &gt; 1),
 559          &quot;Inconsistency&quot;);
 560   log_debug(gc)(&quot;ConcGCThreads: %u&quot;, ConcGCThreads);
 561   log_debug(gc)(&quot;ParallelGCThreads: %u&quot;, ParallelGCThreads);
 562 
 563   // Parallel task queues; these are shared for the
 564   // concurrent and stop-world phases of CMS, but
 565   // are not shared with parallel scavenge (ParNew).
 566   {
 567     uint i;
 568     uint num_queues = MAX2(ParallelGCThreads, ConcGCThreads);
 569 
 570     if ((CMSParallelRemarkEnabled || CMSConcurrentMTEnabled
 571          || ParallelRefProcEnabled)
 572         &amp;&amp; num_queues &gt; 0) {
 573       _task_queues = new OopTaskQueueSet(num_queues);
 574       if (_task_queues == NULL) {
 575         log_warning(gc)(&quot;task_queues allocation failure.&quot;);
 576         return;
 577       }
 578       typedef Padded&lt;OopTaskQueue&gt; PaddedOopTaskQueue;
 579       for (i = 0; i &lt; num_queues; i++) {
 580         PaddedOopTaskQueue *q = new PaddedOopTaskQueue();
 581         if (q == NULL) {
 582           log_warning(gc)(&quot;work_queue allocation failure.&quot;);
 583           return;
 584         }
 585         _task_queues-&gt;register_queue(i, q);
 586       }
 587       for (i = 0; i &lt; num_queues; i++) {
 588         _task_queues-&gt;queue(i)-&gt;initialize();
 589       }
 590     }
 591   }
 592 
 593   _cmsGen -&gt;init_initiating_occupancy(CMSInitiatingOccupancyFraction, CMSTriggerRatio);
 594 
 595   // Clip CMSBootstrapOccupancy between 0 and 100.
 596   _bootstrap_occupancy = CMSBootstrapOccupancy / 100.0;
 597 
 598   // Now tell CMS generations the identity of their collector
 599   ConcurrentMarkSweepGeneration::set_collector(this);
 600 
 601   // Create &amp; start a CMS thread for this CMS collector
 602   _cmsThread = ConcurrentMarkSweepThread::start(this);
 603   assert(cmsThread() != NULL, &quot;CMS Thread should have been created&quot;);
 604   assert(cmsThread()-&gt;collector() == this,
 605          &quot;CMS Thread should refer to this gen&quot;);
 606   assert(CGC_lock != NULL, &quot;Where&#39;s the CGC_lock?&quot;);
 607 
 608   // Support for parallelizing young gen rescan
 609   CMSHeap* heap = CMSHeap::heap();
 610   _young_gen = heap-&gt;young_gen();
 611   if (heap-&gt;supports_inline_contig_alloc()) {
 612     _top_addr = heap-&gt;top_addr();
 613     _end_addr = heap-&gt;end_addr();
 614     assert(_young_gen != NULL, &quot;no _young_gen&quot;);
 615     _eden_chunk_index = 0;
 616     _eden_chunk_capacity = (_young_gen-&gt;max_capacity() + CMSSamplingGrain) / CMSSamplingGrain;
 617     _eden_chunk_array = NEW_C_HEAP_ARRAY(HeapWord*, _eden_chunk_capacity, mtGC);
 618   }
 619 
 620   // Support for parallelizing survivor space rescan
 621   if ((CMSParallelRemarkEnabled &amp;&amp; CMSParallelSurvivorRemarkEnabled) || CMSParallelInitialMarkEnabled) {
 622     const size_t max_plab_samples =
 623       _young_gen-&gt;max_survivor_size() / (PLAB::min_size() * HeapWordSize);
 624 
 625     _survivor_plab_array  = NEW_C_HEAP_ARRAY(ChunkArray, ParallelGCThreads, mtGC);
 626     _survivor_chunk_array = NEW_C_HEAP_ARRAY(HeapWord*, max_plab_samples, mtGC);
 627     _cursor               = NEW_C_HEAP_ARRAY(size_t, ParallelGCThreads, mtGC);
 628     _survivor_chunk_capacity = max_plab_samples;
 629     for (uint i = 0; i &lt; ParallelGCThreads; i++) {
 630       HeapWord** vec = NEW_C_HEAP_ARRAY(HeapWord*, max_plab_samples, mtGC);
 631       ChunkArray* cur = ::new (&amp;_survivor_plab_array[i]) ChunkArray(vec, max_plab_samples);
 632       assert(cur-&gt;end() == 0, &quot;Should be 0&quot;);
 633       assert(cur-&gt;array() == vec, &quot;Should be vec&quot;);
 634       assert(cur-&gt;capacity() == max_plab_samples, &quot;Error&quot;);
 635     }
 636   }
 637 
 638   NOT_PRODUCT(_overflow_counter = CMSMarkStackOverflowInterval;)
 639   _gc_counters = new CollectorCounters(&quot;CMS full collection pauses&quot;, 1);
 640   _cgc_counters = new CollectorCounters(&quot;CMS concurrent cycle pauses&quot;, 2);
 641   _completed_initialization = true;
 642   _inter_sweep_timer.start();  // start of time
 643 }
 644 
 645 const char* ConcurrentMarkSweepGeneration::name() const {
 646   return &quot;concurrent mark-sweep generation&quot;;
 647 }
 648 void ConcurrentMarkSweepGeneration::update_counters() {
 649   if (UsePerfData) {
 650     _space_counters-&gt;update_all();
 651     _gen_counters-&gt;update_all();
 652   }
 653 }
 654 
 655 // this is an optimized version of update_counters(). it takes the
 656 // used value as a parameter rather than computing it.
 657 //
 658 void ConcurrentMarkSweepGeneration::update_counters(size_t used) {
 659   if (UsePerfData) {
 660     _space_counters-&gt;update_used(used);
 661     _space_counters-&gt;update_capacity();
 662     _gen_counters-&gt;update_all();
 663   }
 664 }
 665 
 666 void ConcurrentMarkSweepGeneration::print() const {
 667   Generation::print();
 668   cmsSpace()-&gt;print();
 669 }
 670 
 671 #ifndef PRODUCT
 672 void ConcurrentMarkSweepGeneration::print_statistics() {
 673   cmsSpace()-&gt;printFLCensus(0);
 674 }
 675 #endif
 676 
 677 size_t
 678 ConcurrentMarkSweepGeneration::contiguous_available() const {
 679   // dld proposes an improvement in precision here. If the committed
 680   // part of the space ends in a free block we should add that to
 681   // uncommitted size in the calculation below. Will make this
 682   // change later, staying with the approximation below for the
 683   // time being. -- ysr.
 684   return MAX2(_virtual_space.uncommitted_size(), unsafe_max_alloc_nogc());
 685 }
 686 
 687 size_t
 688 ConcurrentMarkSweepGeneration::unsafe_max_alloc_nogc() const {
 689   return _cmsSpace-&gt;max_alloc_in_words() * HeapWordSize;
 690 }
 691 
 692 size_t ConcurrentMarkSweepGeneration::max_available() const {
 693   return free() + _virtual_space.uncommitted_size();
 694 }
 695 
 696 bool ConcurrentMarkSweepGeneration::promotion_attempt_is_safe(size_t max_promotion_in_bytes) const {
 697   size_t available = max_available();
 698   size_t av_promo  = (size_t)gc_stats()-&gt;avg_promoted()-&gt;padded_average();
 699   bool   res = (available &gt;= av_promo) || (available &gt;= max_promotion_in_bytes);
 700   log_trace(gc, promotion)(&quot;CMS: promo attempt is%s safe: available(&quot; SIZE_FORMAT &quot;) %s av_promo(&quot; SIZE_FORMAT &quot;), max_promo(&quot; SIZE_FORMAT &quot;)&quot;,
 701                            res? &quot;&quot;:&quot; not&quot;, available, res? &quot;&gt;=&quot;:&quot;&lt;&quot;, av_promo, max_promotion_in_bytes);
 702   return res;
 703 }
 704 
 705 // At a promotion failure dump information on block layout in heap
 706 // (cms old generation).
 707 void ConcurrentMarkSweepGeneration::promotion_failure_occurred() {
 708   Log(gc, promotion) log;
 709   if (log.is_trace()) {
 710     LogStream ls(log.trace());
 711     cmsSpace()-&gt;dump_at_safepoint_with_locks(collector(), &amp;ls);
 712   }
 713 }
 714 
 715 void ConcurrentMarkSweepGeneration::reset_after_compaction() {
 716   // Clear the promotion information.  These pointers can be adjusted
 717   // along with all the other pointers into the heap but
 718   // compaction is expected to be a rare event with
 719   // a heap using cms so don&#39;t do it without seeing the need.
 720   for (uint i = 0; i &lt; ParallelGCThreads; i++) {
 721     _par_gc_thread_states[i]-&gt;promo.reset();
 722   }
 723 }
 724 
 725 void ConcurrentMarkSweepGeneration::compute_new_size() {
 726   assert_locked_or_safepoint(Heap_lock);
 727 
 728   // If incremental collection failed, we just want to expand
 729   // to the limit.
 730   if (incremental_collection_failed()) {
 731     clear_incremental_collection_failed();
 732     grow_to_reserved();
 733     return;
 734   }
 735 
 736   // The heap has been compacted but not reset yet.
 737   // Any metric such as free() or used() will be incorrect.
 738 
 739   CardGeneration::compute_new_size();
 740 
 741   // Reset again after a possible resizing
 742   if (did_compact()) {
 743     cmsSpace()-&gt;reset_after_compaction();
 744   }
 745 }
 746 
 747 void ConcurrentMarkSweepGeneration::compute_new_size_free_list() {
 748   assert_locked_or_safepoint(Heap_lock);
 749 
 750   // If incremental collection failed, we just want to expand
 751   // to the limit.
 752   if (incremental_collection_failed()) {
 753     clear_incremental_collection_failed();
 754     grow_to_reserved();
 755     return;
 756   }
 757 
 758   double free_percentage = ((double) free()) / capacity();
 759   double desired_free_percentage = (double) MinHeapFreeRatio / 100;
 760   double maximum_free_percentage = (double) MaxHeapFreeRatio / 100;
 761 
 762   // compute expansion delta needed for reaching desired free percentage
 763   if (free_percentage &lt; desired_free_percentage) {
 764     size_t desired_capacity = (size_t)(used() / ((double) 1 - desired_free_percentage));
 765     assert(desired_capacity &gt;= capacity(), &quot;invalid expansion size&quot;);
 766     size_t expand_bytes = MAX2(desired_capacity - capacity(), MinHeapDeltaBytes);
 767     Log(gc) log;
 768     if (log.is_trace()) {
 769       size_t desired_capacity = (size_t)(used() / ((double) 1 - desired_free_percentage));
 770       log.trace(&quot;From compute_new_size: &quot;);
 771       log.trace(&quot;  Free fraction %f&quot;, free_percentage);
 772       log.trace(&quot;  Desired free fraction %f&quot;, desired_free_percentage);
 773       log.trace(&quot;  Maximum free fraction %f&quot;, maximum_free_percentage);
 774       log.trace(&quot;  Capacity &quot; SIZE_FORMAT, capacity() / 1000);
 775       log.trace(&quot;  Desired capacity &quot; SIZE_FORMAT, desired_capacity / 1000);
 776       CMSHeap* heap = CMSHeap::heap();
 777       size_t young_size = heap-&gt;young_gen()-&gt;capacity();
 778       log.trace(&quot;  Young gen size &quot; SIZE_FORMAT, young_size / 1000);
 779       log.trace(&quot;  unsafe_max_alloc_nogc &quot; SIZE_FORMAT, unsafe_max_alloc_nogc() / 1000);
 780       log.trace(&quot;  contiguous available &quot; SIZE_FORMAT, contiguous_available() / 1000);
 781       log.trace(&quot;  Expand by &quot; SIZE_FORMAT &quot; (bytes)&quot;, expand_bytes);
 782     }
 783     // safe if expansion fails
 784     expand_for_gc_cause(expand_bytes, 0, CMSExpansionCause::_satisfy_free_ratio);
 785     log.trace(&quot;  Expanded free fraction %f&quot;, ((double) free()) / capacity());
 786   } else {
 787     size_t desired_capacity = (size_t)(used() / ((double) 1 - desired_free_percentage));
 788     assert(desired_capacity &lt;= capacity(), &quot;invalid expansion size&quot;);
 789     size_t shrink_bytes = capacity() - desired_capacity;
 790     // Don&#39;t shrink unless the delta is greater than the minimum shrink we want
 791     if (shrink_bytes &gt;= MinHeapDeltaBytes) {
 792       shrink_free_list_by(shrink_bytes);
 793     }
 794   }
 795 }
 796 
 797 Mutex* ConcurrentMarkSweepGeneration::freelistLock() const {
 798   return cmsSpace()-&gt;freelistLock();
 799 }
 800 
 801 HeapWord* ConcurrentMarkSweepGeneration::allocate(size_t size, bool tlab) {
 802   CMSSynchronousYieldRequest yr;
 803   MutexLockerEx x(freelistLock(), Mutex::_no_safepoint_check_flag);
 804   return have_lock_and_allocate(size, tlab);
 805 }
 806 
 807 HeapWord* ConcurrentMarkSweepGeneration::have_lock_and_allocate(size_t size,
 808                                                                 bool   tlab /* ignored */) {
 809   assert_lock_strong(freelistLock());
 810   size_t adjustedSize = CompactibleFreeListSpace::adjustObjectSize(size);
 811   HeapWord* res = cmsSpace()-&gt;allocate(adjustedSize);
 812   // Allocate the object live (grey) if the background collector has
 813   // started marking. This is necessary because the marker may
 814   // have passed this address and consequently this object will
 815   // not otherwise be greyed and would be incorrectly swept up.
 816   // Note that if this object contains references, the writing
 817   // of those references will dirty the card containing this object
 818   // allowing the object to be blackened (and its references scanned)
 819   // either during a preclean phase or at the final checkpoint.
 820   if (res != NULL) {
 821     // We may block here with an uninitialized object with
 822     // its mark-bit or P-bits not yet set. Such objects need
 823     // to be safely navigable by block_start().
 824     assert(oop(res)-&gt;klass_or_null() == NULL, &quot;Object should be uninitialized here.&quot;);
 825     assert(!((FreeChunk*)res)-&gt;is_free(), &quot;Error, block will look free but show wrong size&quot;);
 826     collector()-&gt;direct_allocated(res, adjustedSize);
 827     _direct_allocated_words += adjustedSize;
 828     // allocation counters
 829     NOT_PRODUCT(
 830       _numObjectsAllocated++;
 831       _numWordsAllocated += (int)adjustedSize;
 832     )
 833   }
 834   return res;
 835 }
 836 
 837 // In the case of direct allocation by mutators in a generation that
 838 // is being concurrently collected, the object must be allocated
 839 // live (grey) if the background collector has started marking.
 840 // This is necessary because the marker may
 841 // have passed this address and consequently this object will
 842 // not otherwise be greyed and would be incorrectly swept up.
 843 // Note that if this object contains references, the writing
 844 // of those references will dirty the card containing this object
 845 // allowing the object to be blackened (and its references scanned)
 846 // either during a preclean phase or at the final checkpoint.
 847 void CMSCollector::direct_allocated(HeapWord* start, size_t size) {
 848   assert(_markBitMap.covers(start, size), &quot;Out of bounds&quot;);
 849   if (_collectorState &gt;= Marking) {
 850     MutexLockerEx y(_markBitMap.lock(),
 851                     Mutex::_no_safepoint_check_flag);
 852     // [see comments preceding SweepClosure::do_blk() below for details]
 853     //
 854     // Can the P-bits be deleted now?  JJJ
 855     //
 856     // 1. need to mark the object as live so it isn&#39;t collected
 857     // 2. need to mark the 2nd bit to indicate the object may be uninitialized
 858     // 3. need to mark the end of the object so marking, precleaning or sweeping
 859     //    can skip over uninitialized or unparsable objects. An allocated
 860     //    object is considered uninitialized for our purposes as long as
 861     //    its klass word is NULL.  All old gen objects are parsable
 862     //    as soon as they are initialized.)
 863     _markBitMap.mark(start);          // object is live
 864     _markBitMap.mark(start + 1);      // object is potentially uninitialized?
 865     _markBitMap.mark(start + size - 1);
 866                                       // mark end of object
 867   }
 868   // check that oop looks uninitialized
 869   assert(oop(start)-&gt;klass_or_null() == NULL, &quot;_klass should be NULL&quot;);
 870 }
 871 
 872 void CMSCollector::promoted(bool par, HeapWord* start,
 873                             bool is_obj_array, size_t obj_size) {
 874   assert(_markBitMap.covers(start), &quot;Out of bounds&quot;);
 875   // See comment in direct_allocated() about when objects should
 876   // be allocated live.
 877   if (_collectorState &gt;= Marking) {
 878     // we already hold the marking bit map lock, taken in
 879     // the prologue
 880     if (par) {
 881       _markBitMap.par_mark(start);
 882     } else {
 883       _markBitMap.mark(start);
 884     }
 885     // We don&#39;t need to mark the object as uninitialized (as
 886     // in direct_allocated above) because this is being done with the
 887     // world stopped and the object will be initialized by the
 888     // time the marking, precleaning or sweeping get to look at it.
 889     // But see the code for copying objects into the CMS generation,
 890     // where we need to ensure that concurrent readers of the
 891     // block offset table are able to safely navigate a block that
 892     // is in flux from being free to being allocated (and in
 893     // transition while being copied into) and subsequently
 894     // becoming a bona-fide object when the copy/promotion is complete.
 895     assert(SafepointSynchronize::is_at_safepoint(),
 896            &quot;expect promotion only at safepoints&quot;);
 897 
 898     if (_collectorState &lt; Sweeping) {
 899       // Mark the appropriate cards in the modUnionTable, so that
 900       // this object gets scanned before the sweep. If this is
 901       // not done, CMS generation references in the object might
 902       // not get marked.
 903       // For the case of arrays, which are otherwise precisely
 904       // marked, we need to dirty the entire array, not just its head.
 905       if (is_obj_array) {
 906         // The [par_]mark_range() method expects mr.end() below to
 907         // be aligned to the granularity of a bit&#39;s representation
 908         // in the heap. In the case of the MUT below, that&#39;s a
 909         // card size.
 910         MemRegion mr(start,
 911                      align_up(start + obj_size,
 912                               CardTable::card_size /* bytes */));
 913         if (par) {
 914           _modUnionTable.par_mark_range(mr);
 915         } else {
 916           _modUnionTable.mark_range(mr);
 917         }
 918       } else {  // not an obj array; we can just mark the head
 919         if (par) {
 920           _modUnionTable.par_mark(start);
 921         } else {
 922           _modUnionTable.mark(start);
 923         }
 924       }
 925     }
 926   }
 927 }
 928 
 929 oop ConcurrentMarkSweepGeneration::promote(oop obj, size_t obj_size) {
 930   assert(obj_size == (size_t)obj-&gt;size(), &quot;bad obj_size passed in&quot;);
 931   // allocate, copy and if necessary update promoinfo --
 932   // delegate to underlying space.
 933   assert_lock_strong(freelistLock());
 934 
 935 #ifndef PRODUCT
 936   if (CMSHeap::heap()-&gt;promotion_should_fail()) {
 937     return NULL;
 938   }
 939 #endif  // #ifndef PRODUCT
 940 
 941   oop res = _cmsSpace-&gt;promote(obj, obj_size);
 942   if (res == NULL) {
 943     // expand and retry
 944     size_t s = _cmsSpace-&gt;expansionSpaceRequired(obj_size);  // HeapWords
 945     expand_for_gc_cause(s*HeapWordSize, MinHeapDeltaBytes, CMSExpansionCause::_satisfy_promotion);
 946     // Since this is the old generation, we don&#39;t try to promote
 947     // into a more senior generation.
 948     res = _cmsSpace-&gt;promote(obj, obj_size);
 949   }
 950   if (res != NULL) {
 951     // See comment in allocate() about when objects should
 952     // be allocated live.
 953     assert(oopDesc::is_oop(obj), &quot;Will dereference klass pointer below&quot;);
 954     collector()-&gt;promoted(false,           // Not parallel
 955                           (HeapWord*)res, obj-&gt;is_objArray(), obj_size);
 956     // promotion counters
 957     NOT_PRODUCT(
 958       _numObjectsPromoted++;
 959       _numWordsPromoted +=
 960         (int)(CompactibleFreeListSpace::adjustObjectSize(obj-&gt;size()));
 961     )
 962   }
 963   return res;
 964 }
 965 
 966 
 967 // IMPORTANT: Notes on object size recognition in CMS.
 968 // ---------------------------------------------------
 969 // A block of storage in the CMS generation is always in
 970 // one of three states. A free block (FREE), an allocated
 971 // object (OBJECT) whose size() method reports the correct size,
 972 // and an intermediate state (TRANSIENT) in which its size cannot
 973 // be accurately determined.
 974 // STATE IDENTIFICATION:   (32 bit and 64 bit w/o COOPS)
 975 // -----------------------------------------------------
 976 // FREE:      klass_word &amp; 1 == 1; mark_word holds block size
 977 //
 978 // OBJECT:    klass_word installed; klass_word != 0 &amp;&amp; klass_word &amp; 1 == 0;
 979 //            obj-&gt;size() computes correct size
 980 //
 981 // TRANSIENT: klass_word == 0; size is indeterminate until we become an OBJECT
 982 //
 983 // STATE IDENTIFICATION: (64 bit+COOPS)
 984 // ------------------------------------
 985 // FREE:      mark_word &amp; CMS_FREE_BIT == 1; mark_word &amp; ~CMS_FREE_BIT gives block_size
 986 //
 987 // OBJECT:    klass_word installed; klass_word != 0;
 988 //            obj-&gt;size() computes correct size
 989 //
 990 // TRANSIENT: klass_word == 0; size is indeterminate until we become an OBJECT
 991 //
 992 //
 993 // STATE TRANSITION DIAGRAM
 994 //
 995 //        mut / parnew                     mut  /  parnew
 996 // FREE --------------------&gt; TRANSIENT ---------------------&gt; OBJECT --|
 997 //  ^                                                                   |
 998 //  |------------------------ DEAD &lt;------------------------------------|
 999 //         sweep                            mut
1000 //
1001 // While a block is in TRANSIENT state its size cannot be determined
1002 // so readers will either need to come back later or stall until
1003 // the size can be determined. Note that for the case of direct
1004 // allocation, P-bits, when available, may be used to determine the
1005 // size of an object that may not yet have been initialized.
1006 
1007 // Things to support parallel young-gen collection.
1008 oop
1009 ConcurrentMarkSweepGeneration::par_promote(int thread_num,
1010                                            oop old, markOop m,
1011                                            size_t word_sz) {
1012 #ifndef PRODUCT
1013   if (CMSHeap::heap()-&gt;promotion_should_fail()) {
1014     return NULL;
1015   }
1016 #endif  // #ifndef PRODUCT
1017 
1018   CMSParGCThreadState* ps = _par_gc_thread_states[thread_num];
1019   PromotionInfo* promoInfo = &amp;ps-&gt;promo;
1020   // if we are tracking promotions, then first ensure space for
1021   // promotion (including spooling space for saving header if necessary).
1022   // then allocate and copy, then track promoted info if needed.
1023   // When tracking (see PromotionInfo::track()), the mark word may
1024   // be displaced and in this case restoration of the mark word
1025   // occurs in the (oop_since_save_marks_)iterate phase.
1026   if (promoInfo-&gt;tracking() &amp;&amp; !promoInfo-&gt;ensure_spooling_space()) {
1027     // Out of space for allocating spooling buffers;
1028     // try expanding and allocating spooling buffers.
1029     if (!expand_and_ensure_spooling_space(promoInfo)) {
1030       return NULL;
1031     }
1032   }
1033   assert(!promoInfo-&gt;tracking() || promoInfo-&gt;has_spooling_space(), &quot;Control point invariant&quot;);
1034   const size_t alloc_sz = CompactibleFreeListSpace::adjustObjectSize(word_sz);
1035   HeapWord* obj_ptr = ps-&gt;lab.alloc(alloc_sz);
1036   if (obj_ptr == NULL) {
1037      obj_ptr = expand_and_par_lab_allocate(ps, alloc_sz);
1038      if (obj_ptr == NULL) {
1039        return NULL;
1040      }
1041   }
1042   oop obj = oop(obj_ptr);
1043   OrderAccess::storestore();
1044   assert(obj-&gt;klass_or_null() == NULL, &quot;Object should be uninitialized here.&quot;);
1045   assert(!((FreeChunk*)obj_ptr)-&gt;is_free(), &quot;Error, block will look free but show wrong size&quot;);
1046   // IMPORTANT: See note on object initialization for CMS above.
1047   // Otherwise, copy the object.  Here we must be careful to insert the
1048   // klass pointer last, since this marks the block as an allocated object.
1049   // Except with compressed oops it&#39;s the mark word.
1050   HeapWord* old_ptr = (HeapWord*)old;
1051   // Restore the mark word copied above.
1052   obj-&gt;set_mark_raw(m);
1053   assert(obj-&gt;klass_or_null() == NULL, &quot;Object should be uninitialized here.&quot;);
1054   assert(!((FreeChunk*)obj_ptr)-&gt;is_free(), &quot;Error, block will look free but show wrong size&quot;);
1055   OrderAccess::storestore();
1056 
1057   if (UseCompressedClassPointers) {
1058     // Copy gap missed by (aligned) header size calculation below
1059     obj-&gt;set_klass_gap(old-&gt;klass_gap());
1060   }
1061   if (word_sz &gt; (size_t)oopDesc::header_size()) {
1062     Copy::aligned_disjoint_words(old_ptr + oopDesc::header_size(),
1063                                  obj_ptr + oopDesc::header_size(),
1064                                  word_sz - oopDesc::header_size());
1065   }
1066 
1067   // Now we can track the promoted object, if necessary.  We take care
1068   // to delay the transition from uninitialized to full object
1069   // (i.e., insertion of klass pointer) until after, so that it
1070   // atomically becomes a promoted object.
1071   if (promoInfo-&gt;tracking()) {
1072     promoInfo-&gt;track((PromotedObject*)obj, old-&gt;klass());
1073   }
1074   assert(obj-&gt;klass_or_null() == NULL, &quot;Object should be uninitialized here.&quot;);
1075   assert(!((FreeChunk*)obj_ptr)-&gt;is_free(), &quot;Error, block will look free but show wrong size&quot;);
1076   assert(oopDesc::is_oop(old), &quot;Will use and dereference old klass ptr below&quot;);
1077 
1078   // Finally, install the klass pointer (this should be volatile).
1079   OrderAccess::storestore();
1080   obj-&gt;set_klass(old-&gt;klass());
1081   // We should now be able to calculate the right size for this object
1082   assert(oopDesc::is_oop(obj) &amp;&amp; obj-&gt;size() == (int)word_sz, &quot;Error, incorrect size computed for promoted object&quot;);
1083 
1084   collector()-&gt;promoted(true,          // parallel
1085                         obj_ptr, old-&gt;is_objArray(), word_sz);
1086 
1087   NOT_PRODUCT(
1088     Atomic::inc(&amp;_numObjectsPromoted);
1089     Atomic::add(alloc_sz, &amp;_numWordsPromoted);
1090   )
1091 
1092   return obj;
1093 }
1094 
1095 void
1096 ConcurrentMarkSweepGeneration::
1097 par_promote_alloc_done(int thread_num) {
1098   CMSParGCThreadState* ps = _par_gc_thread_states[thread_num];
1099   ps-&gt;lab.retire(thread_num);
1100 }
1101 
1102 void
1103 ConcurrentMarkSweepGeneration::
1104 par_oop_since_save_marks_iterate_done(int thread_num) {
1105   CMSParGCThreadState* ps = _par_gc_thread_states[thread_num];
1106   ParScanWithoutBarrierClosure* dummy_cl = NULL;
1107   ps-&gt;promo.promoted_oops_iterate(dummy_cl);
1108 
1109   // Because card-scanning has been completed, subsequent phases
1110   // (e.g., reference processing) will not need to recognize which
1111   // objects have been promoted during this GC. So, we can now disable
1112   // promotion tracking.
1113   ps-&gt;promo.stopTrackingPromotions();
1114 }
1115 
1116 bool ConcurrentMarkSweepGeneration::should_collect(bool   full,
1117                                                    size_t size,
1118                                                    bool   tlab)
1119 {
1120   // We allow a STW collection only if a full
1121   // collection was requested.
1122   return full || should_allocate(size, tlab); // FIX ME !!!
1123   // This and promotion failure handling are connected at the
1124   // hip and should be fixed by untying them.
1125 }
1126 
1127 bool CMSCollector::shouldConcurrentCollect() {
1128   LogTarget(Trace, gc) log;
1129 
1130   if (_full_gc_requested) {
1131     log.print(&quot;CMSCollector: collect because of explicit  gc request (or GCLocker)&quot;);
1132     return true;
1133   }
1134 
1135   FreelistLocker x(this);
1136   // ------------------------------------------------------------------
1137   // Print out lots of information which affects the initiation of
1138   // a collection.
1139   if (log.is_enabled() &amp;&amp; stats().valid()) {
1140     log.print(&quot;CMSCollector shouldConcurrentCollect: &quot;);
1141 
1142     LogStream out(log);
1143     stats().print_on(&amp;out);
1144 
1145     log.print(&quot;time_until_cms_gen_full %3.7f&quot;, stats().time_until_cms_gen_full());
1146     log.print(&quot;free=&quot; SIZE_FORMAT, _cmsGen-&gt;free());
1147     log.print(&quot;contiguous_available=&quot; SIZE_FORMAT, _cmsGen-&gt;contiguous_available());
1148     log.print(&quot;promotion_rate=%g&quot;, stats().promotion_rate());
1149     log.print(&quot;cms_allocation_rate=%g&quot;, stats().cms_allocation_rate());
1150     log.print(&quot;occupancy=%3.7f&quot;, _cmsGen-&gt;occupancy());
1151     log.print(&quot;initiatingOccupancy=%3.7f&quot;, _cmsGen-&gt;initiating_occupancy());
1152     log.print(&quot;cms_time_since_begin=%3.7f&quot;, stats().cms_time_since_begin());
1153     log.print(&quot;cms_time_since_end=%3.7f&quot;, stats().cms_time_since_end());
1154     log.print(&quot;metadata initialized %d&quot;, MetaspaceGC::should_concurrent_collect());
1155   }
1156   // ------------------------------------------------------------------
1157 
1158   // If the estimated time to complete a cms collection (cms_duration())
1159   // is less than the estimated time remaining until the cms generation
1160   // is full, start a collection.
1161   if (!UseCMSInitiatingOccupancyOnly) {
1162     if (stats().valid()) {
1163       if (stats().time_until_cms_start() == 0.0) {
1164         return true;
1165       }
1166     } else {
1167       // We want to conservatively collect somewhat early in order
1168       // to try and &quot;bootstrap&quot; our CMS/promotion statistics;
1169       // this branch will not fire after the first successful CMS
1170       // collection because the stats should then be valid.
1171       if (_cmsGen-&gt;occupancy() &gt;= _bootstrap_occupancy) {
1172         log.print(&quot; CMSCollector: collect for bootstrapping statistics: occupancy = %f, boot occupancy = %f&quot;,
1173                   _cmsGen-&gt;occupancy(), _bootstrap_occupancy);
1174         return true;
1175       }
1176     }
1177   }
1178 
1179   // Otherwise, we start a collection cycle if
1180   // old gen want a collection cycle started. Each may use
1181   // an appropriate criterion for making this decision.
1182   // XXX We need to make sure that the gen expansion
1183   // criterion dovetails well with this. XXX NEED TO FIX THIS
1184   if (_cmsGen-&gt;should_concurrent_collect()) {
1185     log.print(&quot;CMS old gen initiated&quot;);
1186     return true;
1187   }
1188 
1189   // We start a collection if we believe an incremental collection may fail;
1190   // this is not likely to be productive in practice because it&#39;s probably too
1191   // late anyway.
1192   CMSHeap* heap = CMSHeap::heap();
1193   if (heap-&gt;incremental_collection_will_fail(true /* consult_young */)) {
1194     log.print(&quot;CMSCollector: collect because incremental collection will fail &quot;);
1195     return true;
1196   }
1197 
1198   if (MetaspaceGC::should_concurrent_collect()) {
1199     log.print(&quot;CMSCollector: collect for metadata allocation &quot;);
1200     return true;
1201   }
1202 
1203   // CMSTriggerInterval starts a CMS cycle if enough time has passed.
1204   if (CMSTriggerInterval &gt;= 0) {
1205     if (CMSTriggerInterval == 0) {
1206       // Trigger always
1207       return true;
1208     }
1209 
1210     // Check the CMS time since begin (we do not check the stats validity
1211     // as we want to be able to trigger the first CMS cycle as well)
1212     if (stats().cms_time_since_begin() &gt;= (CMSTriggerInterval / ((double) MILLIUNITS))) {
1213       if (stats().valid()) {
1214         log.print(&quot;CMSCollector: collect because of trigger interval (time since last begin %3.7f secs)&quot;,
1215                   stats().cms_time_since_begin());
1216       } else {
1217         log.print(&quot;CMSCollector: collect because of trigger interval (first collection)&quot;);
1218       }
1219       return true;
1220     }
1221   }
1222 
1223   return false;
1224 }
1225 
1226 void CMSCollector::set_did_compact(bool v) { _cmsGen-&gt;set_did_compact(v); }
1227 
1228 // Clear _expansion_cause fields of constituent generations
1229 void CMSCollector::clear_expansion_cause() {
1230   _cmsGen-&gt;clear_expansion_cause();
1231 }
1232 
1233 // We should be conservative in starting a collection cycle.  To
1234 // start too eagerly runs the risk of collecting too often in the
1235 // extreme.  To collect too rarely falls back on full collections,
1236 // which works, even if not optimum in terms of concurrent work.
1237 // As a work around for too eagerly collecting, use the flag
1238 // UseCMSInitiatingOccupancyOnly.  This also has the advantage of
1239 // giving the user an easily understandable way of controlling the
1240 // collections.
1241 // We want to start a new collection cycle if any of the following
1242 // conditions hold:
1243 // . our current occupancy exceeds the configured initiating occupancy
1244 //   for this generation, or
1245 // . we recently needed to expand this space and have not, since that
1246 //   expansion, done a collection of this generation, or
1247 // . the underlying space believes that it may be a good idea to initiate
1248 //   a concurrent collection (this may be based on criteria such as the
1249 //   following: the space uses linear allocation and linear allocation is
1250 //   going to fail, or there is believed to be excessive fragmentation in
1251 //   the generation, etc... or ...
1252 // [.(currently done by CMSCollector::shouldConcurrentCollect() only for
1253 //   the case of the old generation; see CR 6543076):
1254 //   we may be approaching a point at which allocation requests may fail because
1255 //   we will be out of sufficient free space given allocation rate estimates.]
1256 bool ConcurrentMarkSweepGeneration::should_concurrent_collect() const {
1257 
1258   assert_lock_strong(freelistLock());
1259   if (occupancy() &gt; initiating_occupancy()) {
1260     log_trace(gc)(&quot; %s: collect because of occupancy %f / %f  &quot;,
1261                   short_name(), occupancy(), initiating_occupancy());
1262     return true;
1263   }
1264   if (UseCMSInitiatingOccupancyOnly) {
1265     return false;
1266   }
1267   if (expansion_cause() == CMSExpansionCause::_satisfy_allocation) {
1268     log_trace(gc)(&quot; %s: collect because expanded for allocation &quot;, short_name());
1269     return true;
1270   }
1271   return false;
1272 }
1273 
1274 void ConcurrentMarkSweepGeneration::collect(bool   full,
1275                                             bool   clear_all_soft_refs,
1276                                             size_t size,
1277                                             bool   tlab)
1278 {
1279   collector()-&gt;collect(full, clear_all_soft_refs, size, tlab);
1280 }
1281 
1282 void CMSCollector::collect(bool   full,
1283                            bool   clear_all_soft_refs,
1284                            size_t size,
1285                            bool   tlab)
1286 {
1287   // The following &quot;if&quot; branch is present for defensive reasons.
1288   // In the current uses of this interface, it can be replaced with:
1289   // assert(!GCLocker.is_active(), &quot;Can&#39;t be called otherwise&quot;);
1290   // But I am not placing that assert here to allow future
1291   // generality in invoking this interface.
1292   if (GCLocker::is_active()) {
1293     // A consistency test for GCLocker
1294     assert(GCLocker::needs_gc(), &quot;Should have been set already&quot;);
1295     // Skip this foreground collection, instead
1296     // expanding the heap if necessary.
1297     // Need the free list locks for the call to free() in compute_new_size()
1298     compute_new_size();
1299     return;
1300   }
1301   acquire_control_and_collect(full, clear_all_soft_refs);
1302 }
1303 
1304 void CMSCollector::request_full_gc(unsigned int full_gc_count, GCCause::Cause cause) {
1305   CMSHeap* heap = CMSHeap::heap();
1306   unsigned int gc_count = heap-&gt;total_full_collections();
1307   if (gc_count == full_gc_count) {
1308     MutexLockerEx y(CGC_lock, Mutex::_no_safepoint_check_flag);
1309     _full_gc_requested = true;
1310     _full_gc_cause = cause;
1311     CGC_lock-&gt;notify();   // nudge CMS thread
1312   } else {
1313     assert(gc_count &gt; full_gc_count, &quot;Error: causal loop&quot;);
1314   }
1315 }
1316 
1317 bool CMSCollector::is_external_interruption() {
1318   GCCause::Cause cause = CMSHeap::heap()-&gt;gc_cause();
1319   return GCCause::is_user_requested_gc(cause) ||
1320          GCCause::is_serviceability_requested_gc(cause);
1321 }
1322 
1323 void CMSCollector::report_concurrent_mode_interruption() {
1324   if (is_external_interruption()) {
1325     log_debug(gc)(&quot;Concurrent mode interrupted&quot;);
1326   } else {
1327     log_debug(gc)(&quot;Concurrent mode failure&quot;);
1328     _gc_tracer_cm-&gt;report_concurrent_mode_failure();
1329   }
1330 }
1331 
1332 
1333 // The foreground and background collectors need to coordinate in order
1334 // to make sure that they do not mutually interfere with CMS collections.
1335 // When a background collection is active,
1336 // the foreground collector may need to take over (preempt) and
1337 // synchronously complete an ongoing collection. Depending on the
1338 // frequency of the background collections and the heap usage
1339 // of the application, this preemption can be seldom or frequent.
1340 // There are only certain
1341 // points in the background collection that the &quot;collection-baton&quot;
1342 // can be passed to the foreground collector.
1343 //
1344 // The foreground collector will wait for the baton before
1345 // starting any part of the collection.  The foreground collector
1346 // will only wait at one location.
1347 //
1348 // The background collector will yield the baton before starting a new
1349 // phase of the collection (e.g., before initial marking, marking from roots,
1350 // precleaning, final re-mark, sweep etc.)  This is normally done at the head
1351 // of the loop which switches the phases. The background collector does some
1352 // of the phases (initial mark, final re-mark) with the world stopped.
1353 // Because of locking involved in stopping the world,
1354 // the foreground collector should not block waiting for the background
1355 // collector when it is doing a stop-the-world phase.  The background
1356 // collector will yield the baton at an additional point just before
1357 // it enters a stop-the-world phase.  Once the world is stopped, the
1358 // background collector checks the phase of the collection.  If the
1359 // phase has not changed, it proceeds with the collection.  If the
1360 // phase has changed, it skips that phase of the collection.  See
1361 // the comments on the use of the Heap_lock in collect_in_background().
1362 //
1363 // Variable used in baton passing.
1364 //   _foregroundGCIsActive - Set to true by the foreground collector when
1365 //      it wants the baton.  The foreground clears it when it has finished
1366 //      the collection.
1367 //   _foregroundGCShouldWait - Set to true by the background collector
1368 //        when it is running.  The foreground collector waits while
1369 //      _foregroundGCShouldWait is true.
1370 //  CGC_lock - monitor used to protect access to the above variables
1371 //      and to notify the foreground and background collectors.
1372 //  _collectorState - current state of the CMS collection.
1373 //
1374 // The foreground collector
1375 //   acquires the CGC_lock
1376 //   sets _foregroundGCIsActive
1377 //   waits on the CGC_lock for _foregroundGCShouldWait to be false
1378 //     various locks acquired in preparation for the collection
1379 //     are released so as not to block the background collector
1380 //     that is in the midst of a collection
1381 //   proceeds with the collection
1382 //   clears _foregroundGCIsActive
1383 //   returns
1384 //
1385 // The background collector in a loop iterating on the phases of the
1386 //      collection
1387 //   acquires the CGC_lock
1388 //   sets _foregroundGCShouldWait
1389 //   if _foregroundGCIsActive is set
1390 //     clears _foregroundGCShouldWait, notifies _CGC_lock
1391 //     waits on _CGC_lock for _foregroundGCIsActive to become false
1392 //     and exits the loop.
1393 //   otherwise
1394 //     proceed with that phase of the collection
1395 //     if the phase is a stop-the-world phase,
1396 //       yield the baton once more just before enqueueing
1397 //       the stop-world CMS operation (executed by the VM thread).
1398 //   returns after all phases of the collection are done
1399 //
1400 
1401 void CMSCollector::acquire_control_and_collect(bool full,
1402         bool clear_all_soft_refs) {
1403   assert(SafepointSynchronize::is_at_safepoint(), &quot;should be at safepoint&quot;);
1404   assert(!Thread::current()-&gt;is_ConcurrentGC_thread(),
1405          &quot;shouldn&#39;t try to acquire control from self!&quot;);
1406 
1407   // Start the protocol for acquiring control of the
1408   // collection from the background collector (aka CMS thread).
1409   assert(ConcurrentMarkSweepThread::vm_thread_has_cms_token(),
1410          &quot;VM thread should have CMS token&quot;);
1411   // Remember the possibly interrupted state of an ongoing
1412   // concurrent collection
1413   CollectorState first_state = _collectorState;
1414 
1415   // Signal to a possibly ongoing concurrent collection that
1416   // we want to do a foreground collection.
1417   _foregroundGCIsActive = true;
1418 
1419   // release locks and wait for a notify from the background collector
1420   // releasing the locks in only necessary for phases which
1421   // do yields to improve the granularity of the collection.
1422   assert_lock_strong(bitMapLock());
1423   // We need to lock the Free list lock for the space that we are
1424   // currently collecting.
1425   assert(haveFreelistLocks(), &quot;Must be holding free list locks&quot;);
1426   bitMapLock()-&gt;unlock();
1427   releaseFreelistLocks();
1428   {
1429     MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
1430     if (_foregroundGCShouldWait) {
1431       // We are going to be waiting for action for the CMS thread;
1432       // it had better not be gone (for instance at shutdown)!
1433       assert(ConcurrentMarkSweepThread::cmst() != NULL &amp;&amp; !ConcurrentMarkSweepThread::cmst()-&gt;has_terminated(),
1434              &quot;CMS thread must be running&quot;);
1435       // Wait here until the background collector gives us the go-ahead
1436       ConcurrentMarkSweepThread::clear_CMS_flag(
1437         ConcurrentMarkSweepThread::CMS_vm_has_token);  // release token
1438       // Get a possibly blocked CMS thread going:
1439       //   Note that we set _foregroundGCIsActive true above,
1440       //   without protection of the CGC_lock.
1441       CGC_lock-&gt;notify();
1442       assert(!ConcurrentMarkSweepThread::vm_thread_wants_cms_token(),
1443              &quot;Possible deadlock&quot;);
1444       while (_foregroundGCShouldWait) {
1445         // wait for notification
1446         CGC_lock-&gt;wait(Mutex::_no_safepoint_check_flag);
1447         // Possibility of delay/starvation here, since CMS token does
1448         // not know to give priority to VM thread? Actually, i think
1449         // there wouldn&#39;t be any delay/starvation, but the proof of
1450         // that &quot;fact&quot; (?) appears non-trivial. XXX 20011219YSR
1451       }
1452       ConcurrentMarkSweepThread::set_CMS_flag(
1453         ConcurrentMarkSweepThread::CMS_vm_has_token);
1454     }
1455   }
1456   // The CMS_token is already held.  Get back the other locks.
1457   assert(ConcurrentMarkSweepThread::vm_thread_has_cms_token(),
1458          &quot;VM thread should have CMS token&quot;);
1459   getFreelistLocks();
1460   bitMapLock()-&gt;lock_without_safepoint_check();
1461   log_debug(gc, state)(&quot;CMS foreground collector has asked for control &quot; INTPTR_FORMAT &quot; with first state %d&quot;,
1462                        p2i(Thread::current()), first_state);
1463   log_debug(gc, state)(&quot;    gets control with state %d&quot;, _collectorState);
1464 
1465   // Inform cms gen if this was due to partial collection failing.
1466   // The CMS gen may use this fact to determine its expansion policy.
1467   CMSHeap* heap = CMSHeap::heap();
1468   if (heap-&gt;incremental_collection_will_fail(false /* don&#39;t consult_young */)) {
1469     assert(!_cmsGen-&gt;incremental_collection_failed(),
1470            &quot;Should have been noticed, reacted to and cleared&quot;);
1471     _cmsGen-&gt;set_incremental_collection_failed();
1472   }
1473 
1474   if (first_state &gt; Idling) {
1475     report_concurrent_mode_interruption();
1476   }
1477 
1478   set_did_compact(true);
1479 
1480   // If the collection is being acquired from the background
1481   // collector, there may be references on the discovered
1482   // references lists.  Abandon those references, since some
1483   // of them may have become unreachable after concurrent
1484   // discovery; the STW compacting collector will redo discovery
1485   // more precisely, without being subject to floating garbage.
1486   // Leaving otherwise unreachable references in the discovered
1487   // lists would require special handling.
1488   ref_processor()-&gt;disable_discovery();
1489   ref_processor()-&gt;abandon_partial_discovery();
1490   ref_processor()-&gt;verify_no_references_recorded();
1491 
1492   if (first_state &gt; Idling) {
1493     save_heap_summary();
1494   }
1495 
1496   do_compaction_work(clear_all_soft_refs);
1497 
1498   // Has the GC time limit been exceeded?
1499   size_t max_eden_size = _young_gen-&gt;max_eden_size();
1500   GCCause::Cause gc_cause = heap-&gt;gc_cause();
1501   size_policy()-&gt;check_gc_overhead_limit(_young_gen-&gt;eden()-&gt;used(),
1502                                          _cmsGen-&gt;max_capacity(),
1503                                          max_eden_size,
1504                                          full,
1505                                          gc_cause,
1506                                          heap-&gt;soft_ref_policy());
1507 
1508   // Reset the expansion cause, now that we just completed
1509   // a collection cycle.
1510   clear_expansion_cause();
1511   _foregroundGCIsActive = false;
1512   return;
1513 }
1514 
1515 // Resize the tenured generation
1516 // after obtaining the free list locks for the
1517 // two generations.
1518 void CMSCollector::compute_new_size() {
1519   assert_locked_or_safepoint(Heap_lock);
1520   FreelistLocker z(this);
1521   MetaspaceGC::compute_new_size();
1522   _cmsGen-&gt;compute_new_size_free_list();
1523 }
1524 
1525 // A work method used by the foreground collector to do
1526 // a mark-sweep-compact.
1527 void CMSCollector::do_compaction_work(bool clear_all_soft_refs) {
1528   CMSHeap* heap = CMSHeap::heap();
1529 
1530   STWGCTimer* gc_timer = GenMarkSweep::gc_timer();
1531   gc_timer-&gt;register_gc_start();
1532 
1533   SerialOldTracer* gc_tracer = GenMarkSweep::gc_tracer();
1534   gc_tracer-&gt;report_gc_start(heap-&gt;gc_cause(), gc_timer-&gt;gc_start());
1535 
1536   heap-&gt;pre_full_gc_dump(gc_timer);
1537 
1538   GCTraceTime(Trace, gc, phases) t(&quot;CMS:MSC&quot;);
1539 
1540   // Temporarily widen the span of the weak reference processing to
1541   // the entire heap.
1542   MemRegion new_span(CMSHeap::heap()-&gt;reserved_region());
1543   ReferenceProcessorSpanMutator rp_mut_span(ref_processor(), new_span);
1544   // Temporarily, clear the &quot;is_alive_non_header&quot; field of the
1545   // reference processor.
1546   ReferenceProcessorIsAliveMutator rp_mut_closure(ref_processor(), NULL);
1547   // Temporarily make reference _processing_ single threaded (non-MT).
1548   ReferenceProcessorMTProcMutator rp_mut_mt_processing(ref_processor(), false);
1549   // Temporarily make refs discovery atomic
1550   ReferenceProcessorAtomicMutator rp_mut_atomic(ref_processor(), true);
1551   // Temporarily make reference _discovery_ single threaded (non-MT)
1552   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(ref_processor(), false);
1553 
1554   ref_processor()-&gt;set_enqueuing_is_done(false);
1555   ref_processor()-&gt;enable_discovery();
1556   ref_processor()-&gt;setup_policy(clear_all_soft_refs);
1557   // If an asynchronous collection finishes, the _modUnionTable is
1558   // all clear.  If we are assuming the collection from an asynchronous
1559   // collection, clear the _modUnionTable.
1560   assert(_collectorState != Idling || _modUnionTable.isAllClear(),
1561     &quot;_modUnionTable should be clear if the baton was not passed&quot;);
1562   _modUnionTable.clear_all();
1563   assert(_collectorState != Idling || _ct-&gt;cld_rem_set()-&gt;mod_union_is_clear(),
1564     &quot;mod union for klasses should be clear if the baton was passed&quot;);
1565   _ct-&gt;cld_rem_set()-&gt;clear_mod_union();
1566 
1567 
1568   // We must adjust the allocation statistics being maintained
1569   // in the free list space. We do so by reading and clearing
1570   // the sweep timer and updating the block flux rate estimates below.
1571   assert(!_intra_sweep_timer.is_active(), &quot;_intra_sweep_timer should be inactive&quot;);
1572   if (_inter_sweep_timer.is_active()) {
1573     _inter_sweep_timer.stop();
1574     // Note that we do not use this sample to update the _inter_sweep_estimate.
1575     _cmsGen-&gt;cmsSpace()-&gt;beginSweepFLCensus((float)(_inter_sweep_timer.seconds()),
1576                                             _inter_sweep_estimate.padded_average(),
1577                                             _intra_sweep_estimate.padded_average());
1578   }
1579 
1580   GenMarkSweep::invoke_at_safepoint(ref_processor(), clear_all_soft_refs);
1581   #ifdef ASSERT
1582     CompactibleFreeListSpace* cms_space = _cmsGen-&gt;cmsSpace();
1583     size_t free_size = cms_space-&gt;free();
1584     assert(free_size ==
1585            pointer_delta(cms_space-&gt;end(), cms_space-&gt;compaction_top())
1586            * HeapWordSize,
1587       &quot;All the free space should be compacted into one chunk at top&quot;);
1588     assert(cms_space-&gt;dictionary()-&gt;total_chunk_size(
1589                                       debug_only(cms_space-&gt;freelistLock())) == 0 ||
1590            cms_space-&gt;totalSizeInIndexedFreeLists() == 0,
1591       &quot;All the free space should be in a single chunk&quot;);
1592     size_t num = cms_space-&gt;totalCount();
1593     assert((free_size == 0 &amp;&amp; num == 0) ||
1594            (free_size &gt; 0  &amp;&amp; (num == 1 || num == 2)),
1595          &quot;There should be at most 2 free chunks after compaction&quot;);
1596   #endif // ASSERT
1597   _collectorState = Resetting;
1598   assert(_restart_addr == NULL,
1599          &quot;Should have been NULL&#39;d before baton was passed&quot;);
1600   reset_stw();
1601   _cmsGen-&gt;reset_after_compaction();
1602   _concurrent_cycles_since_last_unload = 0;
1603 
1604   // Clear any data recorded in the PLAB chunk arrays.
1605   if (_survivor_plab_array != NULL) {
1606     reset_survivor_plab_arrays();
1607   }
1608 
1609   // Adjust the per-size allocation stats for the next epoch.
1610   _cmsGen-&gt;cmsSpace()-&gt;endSweepFLCensus(sweep_count() /* fake */);
1611   // Restart the &quot;inter sweep timer&quot; for the next epoch.
1612   _inter_sweep_timer.reset();
1613   _inter_sweep_timer.start();
1614 
1615   // No longer a need to do a concurrent collection for Metaspace.
1616   MetaspaceGC::set_should_concurrent_collect(false);
1617 
1618   heap-&gt;post_full_gc_dump(gc_timer);
1619 
1620   gc_timer-&gt;register_gc_end();
1621 
1622   gc_tracer-&gt;report_gc_end(gc_timer-&gt;gc_end(), gc_timer-&gt;time_partitions());
1623 
1624   // For a mark-sweep-compact, compute_new_size() will be called
1625   // in the heap&#39;s do_collection() method.
1626 }
1627 
1628 void CMSCollector::print_eden_and_survivor_chunk_arrays() {
1629   Log(gc, heap) log;
1630   if (!log.is_trace()) {
1631     return;
1632   }
1633 
1634   ContiguousSpace* eden_space = _young_gen-&gt;eden();
1635   ContiguousSpace* from_space = _young_gen-&gt;from();
1636   ContiguousSpace* to_space   = _young_gen-&gt;to();
1637   // Eden
1638   if (_eden_chunk_array != NULL) {
1639     log.trace(&quot;eden &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;(&quot; SIZE_FORMAT &quot;)&quot;,
1640               p2i(eden_space-&gt;bottom()), p2i(eden_space-&gt;top()),
1641               p2i(eden_space-&gt;end()), eden_space-&gt;capacity());
1642     log.trace(&quot;_eden_chunk_index=&quot; SIZE_FORMAT &quot;, _eden_chunk_capacity=&quot; SIZE_FORMAT,
1643               _eden_chunk_index, _eden_chunk_capacity);
1644     for (size_t i = 0; i &lt; _eden_chunk_index; i++) {
1645       log.trace(&quot;_eden_chunk_array[&quot; SIZE_FORMAT &quot;]=&quot; PTR_FORMAT, i, p2i(_eden_chunk_array[i]));
1646     }
1647   }
1648   // Survivor
1649   if (_survivor_chunk_array != NULL) {
1650     log.trace(&quot;survivor &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;(&quot; SIZE_FORMAT &quot;)&quot;,
1651               p2i(from_space-&gt;bottom()), p2i(from_space-&gt;top()),
1652               p2i(from_space-&gt;end()), from_space-&gt;capacity());
1653     log.trace(&quot;_survivor_chunk_index=&quot; SIZE_FORMAT &quot;, _survivor_chunk_capacity=&quot; SIZE_FORMAT,
1654               _survivor_chunk_index, _survivor_chunk_capacity);
1655     for (size_t i = 0; i &lt; _survivor_chunk_index; i++) {
1656       log.trace(&quot;_survivor_chunk_array[&quot; SIZE_FORMAT &quot;]=&quot; PTR_FORMAT, i, p2i(_survivor_chunk_array[i]));
1657     }
1658   }
1659 }
1660 
1661 void CMSCollector::getFreelistLocks() const {
1662   // Get locks for all free lists in all generations that this
1663   // collector is responsible for
1664   _cmsGen-&gt;freelistLock()-&gt;lock_without_safepoint_check();
1665 }
1666 
1667 void CMSCollector::releaseFreelistLocks() const {
1668   // Release locks for all free lists in all generations that this
1669   // collector is responsible for
1670   _cmsGen-&gt;freelistLock()-&gt;unlock();
1671 }
1672 
1673 bool CMSCollector::haveFreelistLocks() const {
1674   // Check locks for all free lists in all generations that this
1675   // collector is responsible for
1676   assert_lock_strong(_cmsGen-&gt;freelistLock());
1677   PRODUCT_ONLY(ShouldNotReachHere());
1678   return true;
1679 }
1680 
1681 // A utility class that is used by the CMS collector to
1682 // temporarily &quot;release&quot; the foreground collector from its
1683 // usual obligation to wait for the background collector to
1684 // complete an ongoing phase before proceeding.
1685 class ReleaseForegroundGC: public StackObj {
1686  private:
1687   CMSCollector* _c;
1688  public:
1689   ReleaseForegroundGC(CMSCollector* c) : _c(c) {
1690     assert(_c-&gt;_foregroundGCShouldWait, &quot;Else should not need to call&quot;);
1691     MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
1692     // allow a potentially blocked foreground collector to proceed
1693     _c-&gt;_foregroundGCShouldWait = false;
1694     if (_c-&gt;_foregroundGCIsActive) {
1695       CGC_lock-&gt;notify();
1696     }
1697     assert(!ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
1698            &quot;Possible deadlock&quot;);
1699   }
1700 
1701   ~ReleaseForegroundGC() {
1702     assert(!_c-&gt;_foregroundGCShouldWait, &quot;Usage protocol violation?&quot;);
1703     MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
1704     _c-&gt;_foregroundGCShouldWait = true;
1705   }
1706 };
1707 
1708 void CMSCollector::collect_in_background(GCCause::Cause cause) {
1709   assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
1710     &quot;A CMS asynchronous collection is only allowed on a CMS thread.&quot;);
1711 
1712   CMSHeap* heap = CMSHeap::heap();
1713   {
1714     bool safepoint_check = Mutex::_no_safepoint_check_flag;
1715     MutexLockerEx hl(Heap_lock, safepoint_check);
1716     FreelistLocker fll(this);
1717     MutexLockerEx x(CGC_lock, safepoint_check);
1718     if (_foregroundGCIsActive) {
1719       // The foreground collector is. Skip this
1720       // background collection.
1721       assert(!_foregroundGCShouldWait, &quot;Should be clear&quot;);
1722       return;
1723     } else {
1724       assert(_collectorState == Idling, &quot;Should be idling before start.&quot;);
1725       _collectorState = InitialMarking;
1726       register_gc_start(cause);
1727       // Reset the expansion cause, now that we are about to begin
1728       // a new cycle.
1729       clear_expansion_cause();
1730 
1731       // Clear the MetaspaceGC flag since a concurrent collection
1732       // is starting but also clear it after the collection.
1733       MetaspaceGC::set_should_concurrent_collect(false);
1734     }
1735     // Decide if we want to enable class unloading as part of the
1736     // ensuing concurrent GC cycle.
1737     update_should_unload_classes();
1738     _full_gc_requested = false;           // acks all outstanding full gc requests
1739     _full_gc_cause = GCCause::_no_gc;
1740     // Signal that we are about to start a collection
1741     heap-&gt;increment_total_full_collections();  // ... starting a collection cycle
1742     _collection_count_start = heap-&gt;total_full_collections();
1743   }
1744 
1745   size_t prev_used = _cmsGen-&gt;used();
1746 
1747   // The change of the collection state is normally done at this level;
1748   // the exceptions are phases that are executed while the world is
1749   // stopped.  For those phases the change of state is done while the
1750   // world is stopped.  For baton passing purposes this allows the
1751   // background collector to finish the phase and change state atomically.
1752   // The foreground collector cannot wait on a phase that is done
1753   // while the world is stopped because the foreground collector already
1754   // has the world stopped and would deadlock.
1755   while (_collectorState != Idling) {
1756     log_debug(gc, state)(&quot;Thread &quot; INTPTR_FORMAT &quot; in CMS state %d&quot;,
1757                          p2i(Thread::current()), _collectorState);
1758     // The foreground collector
1759     //   holds the Heap_lock throughout its collection.
1760     //   holds the CMS token (but not the lock)
1761     //     except while it is waiting for the background collector to yield.
1762     //
1763     // The foreground collector should be blocked (not for long)
1764     //   if the background collector is about to start a phase
1765     //   executed with world stopped.  If the background
1766     //   collector has already started such a phase, the
1767     //   foreground collector is blocked waiting for the
1768     //   Heap_lock.  The stop-world phases (InitialMarking and FinalMarking)
1769     //   are executed in the VM thread.
1770     //
1771     // The locking order is
1772     //   PendingListLock (PLL)  -- if applicable (FinalMarking)
1773     //   Heap_lock  (both this &amp; PLL locked in VM_CMS_Operation::prologue())
1774     //   CMS token  (claimed in
1775     //                stop_world_and_do() --&gt;
1776     //                  safepoint_synchronize() --&gt;
1777     //                    CMSThread::synchronize())
1778 
1779     {
1780       // Check if the FG collector wants us to yield.
1781       CMSTokenSync x(true); // is cms thread
1782       if (waitForForegroundGC()) {
1783         // We yielded to a foreground GC, nothing more to be
1784         // done this round.
1785         assert(_foregroundGCShouldWait == false, &quot;We set it to false in &quot;
1786                &quot;waitForForegroundGC()&quot;);
1787         log_debug(gc, state)(&quot;CMS Thread &quot; INTPTR_FORMAT &quot; exiting collection CMS state %d&quot;,
1788                              p2i(Thread::current()), _collectorState);
1789         return;
1790       } else {
1791         // The background collector can run but check to see if the
1792         // foreground collector has done a collection while the
1793         // background collector was waiting to get the CGC_lock
1794         // above.  If yes, break so that _foregroundGCShouldWait
1795         // is cleared before returning.
1796         if (_collectorState == Idling) {
1797           break;
1798         }
1799       }
1800     }
1801 
1802     assert(_foregroundGCShouldWait, &quot;Foreground collector, if active, &quot;
1803       &quot;should be waiting&quot;);
1804 
1805     switch (_collectorState) {
1806       case InitialMarking:
1807         {
1808           ReleaseForegroundGC x(this);
1809           stats().record_cms_begin();
1810           VM_CMS_Initial_Mark initial_mark_op(this);
1811           VMThread::execute(&amp;initial_mark_op);
1812         }
1813         // The collector state may be any legal state at this point
1814         // since the background collector may have yielded to the
1815         // foreground collector.
1816         break;
1817       case Marking:
1818         // initial marking in checkpointRootsInitialWork has been completed
1819         if (markFromRoots()) { // we were successful
1820           assert(_collectorState == Precleaning, &quot;Collector state should &quot;
1821             &quot;have changed&quot;);
1822         } else {
1823           assert(_foregroundGCIsActive, &quot;Internal state inconsistency&quot;);
1824         }
1825         break;
1826       case Precleaning:
1827         // marking from roots in markFromRoots has been completed
1828         preclean();
1829         assert(_collectorState == AbortablePreclean ||
1830                _collectorState == FinalMarking,
1831                &quot;Collector state should have changed&quot;);
1832         break;
1833       case AbortablePreclean:
1834         abortable_preclean();
1835         assert(_collectorState == FinalMarking, &quot;Collector state should &quot;
1836           &quot;have changed&quot;);
1837         break;
1838       case FinalMarking:
1839         {
1840           ReleaseForegroundGC x(this);
1841 
1842           VM_CMS_Final_Remark final_remark_op(this);
1843           VMThread::execute(&amp;final_remark_op);
1844         }
1845         assert(_foregroundGCShouldWait, &quot;block post-condition&quot;);
1846         break;
1847       case Sweeping:
1848         // final marking in checkpointRootsFinal has been completed
1849         sweep();
1850         assert(_collectorState == Resizing, &quot;Collector state change &quot;
1851           &quot;to Resizing must be done under the free_list_lock&quot;);
1852 
1853       case Resizing: {
1854         // Sweeping has been completed...
1855         // At this point the background collection has completed.
1856         // Don&#39;t move the call to compute_new_size() down
1857         // into code that might be executed if the background
1858         // collection was preempted.
1859         {
1860           ReleaseForegroundGC x(this);   // unblock FG collection
1861           MutexLockerEx       y(Heap_lock, Mutex::_no_safepoint_check_flag);
1862           CMSTokenSync        z(true);   // not strictly needed.
1863           if (_collectorState == Resizing) {
1864             compute_new_size();
1865             save_heap_summary();
1866             _collectorState = Resetting;
1867           } else {
1868             assert(_collectorState == Idling, &quot;The state should only change&quot;
1869                    &quot; because the foreground collector has finished the collection&quot;);
1870           }
1871         }
1872         break;
1873       }
1874       case Resetting:
1875         // CMS heap resizing has been completed
1876         reset_concurrent();
1877         assert(_collectorState == Idling, &quot;Collector state should &quot;
1878           &quot;have changed&quot;);
1879 
1880         MetaspaceGC::set_should_concurrent_collect(false);
1881 
1882         stats().record_cms_end();
1883         // Don&#39;t move the concurrent_phases_end() and compute_new_size()
1884         // calls to here because a preempted background collection
1885         // has it&#39;s state set to &quot;Resetting&quot;.
1886         break;
1887       case Idling:
1888       default:
1889         ShouldNotReachHere();
1890         break;
1891     }
1892     log_debug(gc, state)(&quot;  Thread &quot; INTPTR_FORMAT &quot; done - next CMS state %d&quot;,
1893                          p2i(Thread::current()), _collectorState);
1894     assert(_foregroundGCShouldWait, &quot;block post-condition&quot;);
1895   }
1896 
1897   // Should this be in gc_epilogue?
1898   heap-&gt;counters()-&gt;update_counters();
1899 
1900   {
1901     // Clear _foregroundGCShouldWait and, in the event that the
1902     // foreground collector is waiting, notify it, before
1903     // returning.
1904     MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
1905     _foregroundGCShouldWait = false;
1906     if (_foregroundGCIsActive) {
1907       CGC_lock-&gt;notify();
1908     }
1909     assert(!ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
1910            &quot;Possible deadlock&quot;);
1911   }
1912   log_debug(gc, state)(&quot;CMS Thread &quot; INTPTR_FORMAT &quot; exiting collection CMS state %d&quot;,
1913                        p2i(Thread::current()), _collectorState);
1914   log_info(gc, heap)(&quot;Old: &quot; SIZE_FORMAT &quot;K-&gt;&quot; SIZE_FORMAT &quot;K(&quot;  SIZE_FORMAT &quot;K)&quot;,
1915                      prev_used / K, _cmsGen-&gt;used()/K, _cmsGen-&gt;capacity() /K);
1916 }
1917 
1918 void CMSCollector::register_gc_start(GCCause::Cause cause) {
1919   _cms_start_registered = true;
1920   _gc_timer_cm-&gt;register_gc_start();
1921   _gc_tracer_cm-&gt;report_gc_start(cause, _gc_timer_cm-&gt;gc_start());
1922 }
1923 
1924 void CMSCollector::register_gc_end() {
1925   if (_cms_start_registered) {
1926     report_heap_summary(GCWhen::AfterGC);
1927 
1928     _gc_timer_cm-&gt;register_gc_end();
1929     _gc_tracer_cm-&gt;report_gc_end(_gc_timer_cm-&gt;gc_end(), _gc_timer_cm-&gt;time_partitions());
1930     _cms_start_registered = false;
1931   }
1932 }
1933 
1934 void CMSCollector::save_heap_summary() {
1935   CMSHeap* heap = CMSHeap::heap();
1936   _last_heap_summary = heap-&gt;create_heap_summary();
1937   _last_metaspace_summary = heap-&gt;create_metaspace_summary();
1938 }
1939 
1940 void CMSCollector::report_heap_summary(GCWhen::Type when) {
1941   _gc_tracer_cm-&gt;report_gc_heap_summary(when, _last_heap_summary);
1942   _gc_tracer_cm-&gt;report_metaspace_summary(when, _last_metaspace_summary);
1943 }
1944 
1945 bool CMSCollector::waitForForegroundGC() {
1946   bool res = false;
1947   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
1948          &quot;CMS thread should have CMS token&quot;);
1949   // Block the foreground collector until the
1950   // background collectors decides whether to
1951   // yield.
1952   MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
1953   _foregroundGCShouldWait = true;
1954   if (_foregroundGCIsActive) {
1955     // The background collector yields to the
1956     // foreground collector and returns a value
1957     // indicating that it has yielded.  The foreground
1958     // collector can proceed.
1959     res = true;
1960     _foregroundGCShouldWait = false;
1961     ConcurrentMarkSweepThread::clear_CMS_flag(
1962       ConcurrentMarkSweepThread::CMS_cms_has_token);
1963     ConcurrentMarkSweepThread::set_CMS_flag(
1964       ConcurrentMarkSweepThread::CMS_cms_wants_token);
1965     // Get a possibly blocked foreground thread going
1966     CGC_lock-&gt;notify();
1967     log_debug(gc, state)(&quot;CMS Thread &quot; INTPTR_FORMAT &quot; waiting at CMS state %d&quot;,
1968                          p2i(Thread::current()), _collectorState);
1969     while (_foregroundGCIsActive) {
1970       CGC_lock-&gt;wait(Mutex::_no_safepoint_check_flag);
1971     }
1972     ConcurrentMarkSweepThread::set_CMS_flag(
1973       ConcurrentMarkSweepThread::CMS_cms_has_token);
1974     ConcurrentMarkSweepThread::clear_CMS_flag(
1975       ConcurrentMarkSweepThread::CMS_cms_wants_token);
1976   }
1977   log_debug(gc, state)(&quot;CMS Thread &quot; INTPTR_FORMAT &quot; continuing at CMS state %d&quot;,
1978                        p2i(Thread::current()), _collectorState);
1979   return res;
1980 }
1981 
1982 // Because of the need to lock the free lists and other structures in
1983 // the collector, common to all the generations that the collector is
1984 // collecting, we need the gc_prologues of individual CMS generations
1985 // delegate to their collector. It may have been simpler had the
1986 // current infrastructure allowed one to call a prologue on a
1987 // collector. In the absence of that we have the generation&#39;s
1988 // prologue delegate to the collector, which delegates back
1989 // some &quot;local&quot; work to a worker method in the individual generations
1990 // that it&#39;s responsible for collecting, while itself doing any
1991 // work common to all generations it&#39;s responsible for. A similar
1992 // comment applies to the  gc_epilogue()&#39;s.
1993 // The role of the variable _between_prologue_and_epilogue is to
1994 // enforce the invocation protocol.
1995 void CMSCollector::gc_prologue(bool full) {
1996   // Call gc_prologue_work() for the CMSGen
1997   // we are responsible for.
1998 
1999   // The following locking discipline assumes that we are only called
2000   // when the world is stopped.
2001   assert(SafepointSynchronize::is_at_safepoint(), &quot;world is stopped assumption&quot;);
2002 
2003   // The CMSCollector prologue must call the gc_prologues for the
2004   // &quot;generations&quot; that it&#39;s responsible
2005   // for.
2006 
2007   assert(   Thread::current()-&gt;is_VM_thread()
2008          || (   CMSScavengeBeforeRemark
2009              &amp;&amp; Thread::current()-&gt;is_ConcurrentGC_thread()),
2010          &quot;Incorrect thread type for prologue execution&quot;);
2011 
2012   if (_between_prologue_and_epilogue) {
2013     // We have already been invoked; this is a gc_prologue delegation
2014     // from yet another CMS generation that we are responsible for, just
2015     // ignore it since all relevant work has already been done.
2016     return;
2017   }
2018 
2019   // set a bit saying prologue has been called; cleared in epilogue
2020   _between_prologue_and_epilogue = true;
2021   // Claim locks for common data structures, then call gc_prologue_work()
2022   // for each CMSGen.
2023 
2024   getFreelistLocks();   // gets free list locks on constituent spaces
2025   bitMapLock()-&gt;lock_without_safepoint_check();
2026 
2027   // Should call gc_prologue_work() for all cms gens we are responsible for
2028   bool duringMarking =    _collectorState &gt;= Marking
2029                          &amp;&amp; _collectorState &lt; Sweeping;
2030 
2031   // The young collections clear the modified oops state, which tells if
2032   // there are any modified oops in the class. The remark phase also needs
2033   // that information. Tell the young collection to save the union of all
2034   // modified klasses.
2035   if (duringMarking) {
2036     _ct-&gt;cld_rem_set()-&gt;set_accumulate_modified_oops(true);
2037   }
2038 
2039   bool registerClosure = duringMarking;
2040 
2041   _cmsGen-&gt;gc_prologue_work(full, registerClosure, &amp;_modUnionClosurePar);
2042 
2043   if (!full) {
2044     stats().record_gc0_begin();
2045   }
2046 }
2047 
2048 void ConcurrentMarkSweepGeneration::gc_prologue(bool full) {
2049 
2050   _capacity_at_prologue = capacity();
2051   _used_at_prologue = used();
2052 
2053   // We enable promotion tracking so that card-scanning can recognize
2054   // which objects have been promoted during this GC and skip them.
2055   for (uint i = 0; i &lt; ParallelGCThreads; i++) {
2056     _par_gc_thread_states[i]-&gt;promo.startTrackingPromotions();
2057   }
2058 
2059   // Delegate to CMScollector which knows how to coordinate between
2060   // this and any other CMS generations that it is responsible for
2061   // collecting.
2062   collector()-&gt;gc_prologue(full);
2063 }
2064 
2065 // This is a &quot;private&quot; interface for use by this generation&#39;s CMSCollector.
2066 // Not to be called directly by any other entity (for instance,
2067 // GenCollectedHeap, which calls the &quot;public&quot; gc_prologue method above).
2068 void ConcurrentMarkSweepGeneration::gc_prologue_work(bool full,
2069   bool registerClosure, ModUnionClosure* modUnionClosure) {
2070   assert(!incremental_collection_failed(), &quot;Shouldn&#39;t be set yet&quot;);
2071   assert(cmsSpace()-&gt;preconsumptionDirtyCardClosure() == NULL,
2072     &quot;Should be NULL&quot;);
2073   if (registerClosure) {
2074     cmsSpace()-&gt;setPreconsumptionDirtyCardClosure(modUnionClosure);
2075   }
2076   cmsSpace()-&gt;gc_prologue();
2077   // Clear stat counters
2078   NOT_PRODUCT(
2079     assert(_numObjectsPromoted == 0, &quot;check&quot;);
2080     assert(_numWordsPromoted   == 0, &quot;check&quot;);
2081     log_develop_trace(gc, alloc)(&quot;Allocated &quot; SIZE_FORMAT &quot; objects, &quot; SIZE_FORMAT &quot; bytes concurrently&quot;,
2082                                  _numObjectsAllocated, _numWordsAllocated*sizeof(HeapWord));
2083     _numObjectsAllocated = 0;
2084     _numWordsAllocated   = 0;
2085   )
2086 }
2087 
2088 void CMSCollector::gc_epilogue(bool full) {
2089   // The following locking discipline assumes that we are only called
2090   // when the world is stopped.
2091   assert(SafepointSynchronize::is_at_safepoint(),
2092          &quot;world is stopped assumption&quot;);
2093 
2094   // Currently the CMS epilogue (see CompactibleFreeListSpace) merely checks
2095   // if linear allocation blocks need to be appropriately marked to allow the
2096   // the blocks to be parsable. We also check here whether we need to nudge the
2097   // CMS collector thread to start a new cycle (if it&#39;s not already active).
2098   assert(   Thread::current()-&gt;is_VM_thread()
2099          || (   CMSScavengeBeforeRemark
2100              &amp;&amp; Thread::current()-&gt;is_ConcurrentGC_thread()),
2101          &quot;Incorrect thread type for epilogue execution&quot;);
2102 
2103   if (!_between_prologue_and_epilogue) {
2104     // We have already been invoked; this is a gc_epilogue delegation
2105     // from yet another CMS generation that we are responsible for, just
2106     // ignore it since all relevant work has already been done.
2107     return;
2108   }
2109   assert(haveFreelistLocks(), &quot;must have freelist locks&quot;);
2110   assert_lock_strong(bitMapLock());
2111 
2112   _ct-&gt;cld_rem_set()-&gt;set_accumulate_modified_oops(false);
2113 
2114   _cmsGen-&gt;gc_epilogue_work(full);
2115 
2116   if (_collectorState == AbortablePreclean || _collectorState == Precleaning) {
2117     // in case sampling was not already enabled, enable it
2118     _start_sampling = true;
2119   }
2120   // reset _eden_chunk_array so sampling starts afresh
2121   _eden_chunk_index = 0;
2122 
2123   size_t cms_used   = _cmsGen-&gt;cmsSpace()-&gt;used();
2124 
2125   // update performance counters - this uses a special version of
2126   // update_counters() that allows the utilization to be passed as a
2127   // parameter, avoiding multiple calls to used().
2128   //
2129   _cmsGen-&gt;update_counters(cms_used);
2130 
2131   bitMapLock()-&gt;unlock();
2132   releaseFreelistLocks();
2133 
2134   if (!CleanChunkPoolAsync) {
2135     Chunk::clean_chunk_pool();
2136   }
2137 
2138   set_did_compact(false);
2139   _between_prologue_and_epilogue = false;  // ready for next cycle
2140 }
2141 
2142 void ConcurrentMarkSweepGeneration::gc_epilogue(bool full) {
2143   collector()-&gt;gc_epilogue(full);
2144 
2145   // When using ParNew, promotion tracking should have already been
2146   // disabled. However, the prologue (which enables promotion
2147   // tracking) and epilogue are called irrespective of the type of
2148   // GC. So they will also be called before and after Full GCs, during
2149   // which promotion tracking will not be explicitly disabled. So,
2150   // it&#39;s safer to also disable it here too (to be symmetric with
2151   // enabling it in the prologue).
2152   for (uint i = 0; i &lt; ParallelGCThreads; i++) {
2153     _par_gc_thread_states[i]-&gt;promo.stopTrackingPromotions();
2154   }
2155 }
2156 
2157 void ConcurrentMarkSweepGeneration::gc_epilogue_work(bool full) {
2158   assert(!incremental_collection_failed(), &quot;Should have been cleared&quot;);
2159   cmsSpace()-&gt;setPreconsumptionDirtyCardClosure(NULL);
2160   cmsSpace()-&gt;gc_epilogue();
2161     // Print stat counters
2162   NOT_PRODUCT(
2163     assert(_numObjectsAllocated == 0, &quot;check&quot;);
2164     assert(_numWordsAllocated == 0, &quot;check&quot;);
2165     log_develop_trace(gc, promotion)(&quot;Promoted &quot; SIZE_FORMAT &quot; objects, &quot; SIZE_FORMAT &quot; bytes&quot;,
2166                                      _numObjectsPromoted, _numWordsPromoted*sizeof(HeapWord));
2167     _numObjectsPromoted = 0;
2168     _numWordsPromoted   = 0;
2169   )
2170 
2171   // Call down the chain in contiguous_available needs the freelistLock
2172   // so print this out before releasing the freeListLock.
2173   log_develop_trace(gc)(&quot; Contiguous available &quot; SIZE_FORMAT &quot; bytes &quot;, contiguous_available());
2174 }
2175 
2176 #ifndef PRODUCT
2177 bool CMSCollector::have_cms_token() {
2178   Thread* thr = Thread::current();
2179   if (thr-&gt;is_VM_thread()) {
2180     return ConcurrentMarkSweepThread::vm_thread_has_cms_token();
2181   } else if (thr-&gt;is_ConcurrentGC_thread()) {
2182     return ConcurrentMarkSweepThread::cms_thread_has_cms_token();
2183   } else if (thr-&gt;is_GC_task_thread()) {
2184     return ConcurrentMarkSweepThread::vm_thread_has_cms_token() &amp;&amp;
2185            ParGCRareEvent_lock-&gt;owned_by_self();
2186   }
2187   return false;
2188 }
2189 
2190 // Check reachability of the given heap address in CMS generation,
2191 // treating all other generations as roots.
2192 bool CMSCollector::is_cms_reachable(HeapWord* addr) {
2193   // We could &quot;guarantee&quot; below, rather than assert, but I&#39;ll
2194   // leave these as &quot;asserts&quot; so that an adventurous debugger
2195   // could try this in the product build provided some subset of
2196   // the conditions were met, provided they were interested in the
2197   // results and knew that the computation below wouldn&#39;t interfere
2198   // with other concurrent computations mutating the structures
2199   // being read or written.
2200   assert(SafepointSynchronize::is_at_safepoint(),
2201          &quot;Else mutations in object graph will make answer suspect&quot;);
2202   assert(have_cms_token(), &quot;Should hold cms token&quot;);
2203   assert(haveFreelistLocks(), &quot;must hold free list locks&quot;);
2204   assert_lock_strong(bitMapLock());
2205 
2206   // Clear the marking bit map array before starting, but, just
2207   // for kicks, first report if the given address is already marked
2208   tty-&gt;print_cr(&quot;Start: Address &quot; PTR_FORMAT &quot; is%s marked&quot;, p2i(addr),
2209                 _markBitMap.isMarked(addr) ? &quot;&quot; : &quot; not&quot;);
2210 
2211   if (verify_after_remark()) {
2212     MutexLockerEx x(verification_mark_bm()-&gt;lock(), Mutex::_no_safepoint_check_flag);
2213     bool result = verification_mark_bm()-&gt;isMarked(addr);
2214     tty-&gt;print_cr(&quot;TransitiveMark: Address &quot; PTR_FORMAT &quot; %s marked&quot;, p2i(addr),
2215                   result ? &quot;IS&quot; : &quot;is NOT&quot;);
2216     return result;
2217   } else {
2218     tty-&gt;print_cr(&quot;Could not compute result&quot;);
2219     return false;
2220   }
2221 }
2222 #endif
2223 
2224 void
2225 CMSCollector::print_on_error(outputStream* st) {
2226   CMSCollector* collector = ConcurrentMarkSweepGeneration::_collector;
2227   if (collector != NULL) {
2228     CMSBitMap* bitmap = &amp;collector-&gt;_markBitMap;
2229     st-&gt;print_cr(&quot;Marking Bits: (CMSBitMap*) &quot; PTR_FORMAT, p2i(bitmap));
2230     bitmap-&gt;print_on_error(st, &quot; Bits: &quot;);
2231 
2232     st-&gt;cr();
2233 
2234     CMSBitMap* mut_bitmap = &amp;collector-&gt;_modUnionTable;
2235     st-&gt;print_cr(&quot;Mod Union Table: (CMSBitMap*) &quot; PTR_FORMAT, p2i(mut_bitmap));
2236     mut_bitmap-&gt;print_on_error(st, &quot; Bits: &quot;);
2237   }
2238 }
2239 
2240 ////////////////////////////////////////////////////////
2241 // CMS Verification Support
2242 ////////////////////////////////////////////////////////
2243 // Following the remark phase, the following invariant
2244 // should hold -- each object in the CMS heap which is
2245 // marked in markBitMap() should be marked in the verification_mark_bm().
2246 
2247 class VerifyMarkedClosure: public BitMapClosure {
2248   CMSBitMap* _marks;
2249   bool       _failed;
2250 
2251  public:
2252   VerifyMarkedClosure(CMSBitMap* bm): _marks(bm), _failed(false) {}
2253 
2254   bool do_bit(size_t offset) {
2255     HeapWord* addr = _marks-&gt;offsetToHeapWord(offset);
2256     if (!_marks-&gt;isMarked(addr)) {
2257       Log(gc, verify) log;
2258       ResourceMark rm;
2259       LogStream ls(log.error());
2260       oop(addr)-&gt;print_on(&amp;ls);
2261       log.error(&quot; (&quot; INTPTR_FORMAT &quot; should have been marked)&quot;, p2i(addr));
2262       _failed = true;
2263     }
2264     return true;
2265   }
2266 
2267   bool failed() { return _failed; }
2268 };
2269 
2270 bool CMSCollector::verify_after_remark() {
2271   GCTraceTime(Info, gc, phases, verify) tm(&quot;Verifying CMS Marking.&quot;);
2272   MutexLockerEx ml(verification_mark_bm()-&gt;lock(), Mutex::_no_safepoint_check_flag);
2273   static bool init = false;
2274 
2275   assert(SafepointSynchronize::is_at_safepoint(),
2276          &quot;Else mutations in object graph will make answer suspect&quot;);
2277   assert(have_cms_token(),
2278          &quot;Else there may be mutual interference in use of &quot;
2279          &quot; verification data structures&quot;);
2280   assert(_collectorState &gt; Marking &amp;&amp; _collectorState &lt;= Sweeping,
2281          &quot;Else marking info checked here may be obsolete&quot;);
2282   assert(haveFreelistLocks(), &quot;must hold free list locks&quot;);
2283   assert_lock_strong(bitMapLock());
2284 
2285 
2286   // Allocate marking bit map if not already allocated
2287   if (!init) { // first time
2288     if (!verification_mark_bm()-&gt;allocate(_span)) {
2289       return false;
2290     }
2291     init = true;
2292   }
2293 
2294   assert(verification_mark_stack()-&gt;isEmpty(), &quot;Should be empty&quot;);
2295 
2296   // Turn off refs discovery -- so we will be tracing through refs.
2297   // This is as intended, because by this time
2298   // GC must already have cleared any refs that need to be cleared,
2299   // and traced those that need to be marked; moreover,
2300   // the marking done here is not going to interfere in any
2301   // way with the marking information used by GC.
2302   NoRefDiscovery no_discovery(ref_processor());
2303 
2304 #if COMPILER2_OR_JVMCI
2305   DerivedPointerTableDeactivate dpt_deact;
2306 #endif
2307 
2308   // Clear any marks from a previous round
2309   verification_mark_bm()-&gt;clear_all();
2310   assert(verification_mark_stack()-&gt;isEmpty(), &quot;markStack should be empty&quot;);
2311   verify_work_stacks_empty();
2312 
2313   CMSHeap* heap = CMSHeap::heap();
2314   heap-&gt;ensure_parsability(false);  // fill TLABs, but no need to retire them
2315   // Update the saved marks which may affect the root scans.
2316   heap-&gt;save_marks();
2317 
2318   if (CMSRemarkVerifyVariant == 1) {
2319     // In this first variant of verification, we complete
2320     // all marking, then check if the new marks-vector is
2321     // a subset of the CMS marks-vector.
2322     verify_after_remark_work_1();
2323   } else {
2324     guarantee(CMSRemarkVerifyVariant == 2, &quot;Range checking for CMSRemarkVerifyVariant should guarantee 1 or 2&quot;);
2325     // In this second variant of verification, we flag an error
2326     // (i.e. an object reachable in the new marks-vector not reachable
2327     // in the CMS marks-vector) immediately, also indicating the
2328     // identify of an object (A) that references the unmarked object (B) --
2329     // presumably, a mutation to A failed to be picked up by preclean/remark?
2330     verify_after_remark_work_2();
2331   }
2332 
2333   return true;
2334 }
2335 
2336 void CMSCollector::verify_after_remark_work_1() {
2337   ResourceMark rm;
2338   HandleMark  hm;
2339   CMSHeap* heap = CMSHeap::heap();
2340 
2341   // Get a clear set of claim bits for the roots processing to work with.
2342   ClassLoaderDataGraph::clear_claimed_marks();
2343 
2344   // Mark from roots one level into CMS
2345   MarkRefsIntoClosure notOlder(_span, verification_mark_bm());
2346   heap-&gt;rem_set()-&gt;prepare_for_younger_refs_iterate(false); // Not parallel.
2347 
2348   {
2349     StrongRootsScope srs(1);
2350 
2351     heap-&gt;cms_process_roots(&amp;srs,
2352                            true,   // young gen as roots
2353                            GenCollectedHeap::ScanningOption(roots_scanning_options()),
2354                            should_unload_classes(),
2355                            &amp;notOlder,
2356                            NULL);
2357   }
2358 
2359   // Now mark from the roots
2360   MarkFromRootsClosure markFromRootsClosure(this, _span,
2361     verification_mark_bm(), verification_mark_stack(),
2362     false /* don&#39;t yield */, true /* verifying */);
2363   assert(_restart_addr == NULL, &quot;Expected pre-condition&quot;);
2364   verification_mark_bm()-&gt;iterate(&amp;markFromRootsClosure);
2365   while (_restart_addr != NULL) {
2366     // Deal with stack overflow: by restarting at the indicated
2367     // address.
2368     HeapWord* ra = _restart_addr;
2369     markFromRootsClosure.reset(ra);
2370     _restart_addr = NULL;
2371     verification_mark_bm()-&gt;iterate(&amp;markFromRootsClosure, ra, _span.end());
2372   }
2373   assert(verification_mark_stack()-&gt;isEmpty(), &quot;Should have been drained&quot;);
2374   verify_work_stacks_empty();
2375 
2376   // Marking completed -- now verify that each bit marked in
2377   // verification_mark_bm() is also marked in markBitMap(); flag all
2378   // errors by printing corresponding objects.
2379   VerifyMarkedClosure vcl(markBitMap());
2380   verification_mark_bm()-&gt;iterate(&amp;vcl);
2381   if (vcl.failed()) {
2382     Log(gc, verify) log;
2383     log.error(&quot;Failed marking verification after remark&quot;);
2384     ResourceMark rm;
2385     LogStream ls(log.error());
2386     heap-&gt;print_on(&amp;ls);
2387     fatal(&quot;CMS: failed marking verification after remark&quot;);
2388   }
2389 }
2390 
2391 class VerifyCLDOopsCLDClosure : public CLDClosure {
2392   class VerifyCLDOopsClosure : public OopClosure {
2393     CMSBitMap* _bitmap;
2394    public:
2395     VerifyCLDOopsClosure(CMSBitMap* bitmap) : _bitmap(bitmap) { }
2396     void do_oop(oop* p)       { guarantee(*p == NULL || _bitmap-&gt;isMarked((HeapWord*) *p), &quot;Should be marked&quot;); }
2397     void do_oop(narrowOop* p) { ShouldNotReachHere(); }
2398   } _oop_closure;
2399  public:
2400   VerifyCLDOopsCLDClosure(CMSBitMap* bitmap) : _oop_closure(bitmap) {}
2401   void do_cld(ClassLoaderData* cld) {
2402     cld-&gt;oops_do(&amp;_oop_closure, ClassLoaderData::_claim_none, false);
2403   }
2404 };
2405 
2406 void CMSCollector::verify_after_remark_work_2() {
2407   ResourceMark rm;
2408   HandleMark  hm;
2409   CMSHeap* heap = CMSHeap::heap();
2410 
2411   // Get a clear set of claim bits for the roots processing to work with.
2412   ClassLoaderDataGraph::clear_claimed_marks();
2413 
2414   // Mark from roots one level into CMS
2415   MarkRefsIntoVerifyClosure notOlder(_span, verification_mark_bm(),
2416                                      markBitMap());
2417   CLDToOopClosure cld_closure(&amp;notOlder, ClassLoaderData::_claim_strong);
2418 
2419   heap-&gt;rem_set()-&gt;prepare_for_younger_refs_iterate(false); // Not parallel.
2420 
2421   {
2422     StrongRootsScope srs(1);
2423 
2424     heap-&gt;cms_process_roots(&amp;srs,
2425                            true,   // young gen as roots
2426                            GenCollectedHeap::ScanningOption(roots_scanning_options()),
2427                            should_unload_classes(),
2428                            &amp;notOlder,
2429                            &amp;cld_closure);
2430   }
2431 
2432   // Now mark from the roots
2433   MarkFromRootsVerifyClosure markFromRootsClosure(this, _span,
2434     verification_mark_bm(), markBitMap(), verification_mark_stack());
2435   assert(_restart_addr == NULL, &quot;Expected pre-condition&quot;);
2436   verification_mark_bm()-&gt;iterate(&amp;markFromRootsClosure);
2437   while (_restart_addr != NULL) {
2438     // Deal with stack overflow: by restarting at the indicated
2439     // address.
2440     HeapWord* ra = _restart_addr;
2441     markFromRootsClosure.reset(ra);
2442     _restart_addr = NULL;
2443     verification_mark_bm()-&gt;iterate(&amp;markFromRootsClosure, ra, _span.end());
2444   }
2445   assert(verification_mark_stack()-&gt;isEmpty(), &quot;Should have been drained&quot;);
2446   verify_work_stacks_empty();
2447 
2448   VerifyCLDOopsCLDClosure verify_cld_oops(verification_mark_bm());
2449   ClassLoaderDataGraph::cld_do(&amp;verify_cld_oops);
2450 
2451   // Marking completed -- now verify that each bit marked in
2452   // verification_mark_bm() is also marked in markBitMap(); flag all
2453   // errors by printing corresponding objects.
2454   VerifyMarkedClosure vcl(markBitMap());
2455   verification_mark_bm()-&gt;iterate(&amp;vcl);
2456   assert(!vcl.failed(), &quot;Else verification above should not have succeeded&quot;);
2457 }
2458 
2459 void ConcurrentMarkSweepGeneration::save_marks() {
2460   // delegate to CMS space
2461   cmsSpace()-&gt;save_marks();
2462 }
2463 
2464 bool ConcurrentMarkSweepGeneration::no_allocs_since_save_marks() {
2465   return cmsSpace()-&gt;no_allocs_since_save_marks();
2466 }
2467 
2468 void
2469 ConcurrentMarkSweepGeneration::oop_iterate(OopIterateClosure* cl) {
2470   if (freelistLock()-&gt;owned_by_self()) {
2471     Generation::oop_iterate(cl);
2472   } else {
2473     MutexLockerEx x(freelistLock(), Mutex::_no_safepoint_check_flag);
2474     Generation::oop_iterate(cl);
2475   }
2476 }
2477 
2478 void
2479 ConcurrentMarkSweepGeneration::object_iterate(ObjectClosure* cl) {
2480   if (freelistLock()-&gt;owned_by_self()) {
2481     Generation::object_iterate(cl);
2482   } else {
2483     MutexLockerEx x(freelistLock(), Mutex::_no_safepoint_check_flag);
2484     Generation::object_iterate(cl);
2485   }
2486 }
2487 
2488 void
2489 ConcurrentMarkSweepGeneration::safe_object_iterate(ObjectClosure* cl) {
2490   if (freelistLock()-&gt;owned_by_self()) {
2491     Generation::safe_object_iterate(cl);
2492   } else {
2493     MutexLockerEx x(freelistLock(), Mutex::_no_safepoint_check_flag);
2494     Generation::safe_object_iterate(cl);
2495   }
2496 }
2497 
2498 void
2499 ConcurrentMarkSweepGeneration::post_compact() {
2500 }
2501 
2502 void
2503 ConcurrentMarkSweepGeneration::prepare_for_verify() {
2504   // Fix the linear allocation blocks to look like free blocks.
2505 
2506   // Locks are normally acquired/released in gc_prologue/gc_epilogue, but those
2507   // are not called when the heap is verified during universe initialization and
2508   // at vm shutdown.
2509   if (freelistLock()-&gt;owned_by_self()) {
2510     cmsSpace()-&gt;prepare_for_verify();
2511   } else {
2512     MutexLockerEx fll(freelistLock(), Mutex::_no_safepoint_check_flag);
2513     cmsSpace()-&gt;prepare_for_verify();
2514   }
2515 }
2516 
2517 void
2518 ConcurrentMarkSweepGeneration::verify() {
2519   // Locks are normally acquired/released in gc_prologue/gc_epilogue, but those
2520   // are not called when the heap is verified during universe initialization and
2521   // at vm shutdown.
2522   if (freelistLock()-&gt;owned_by_self()) {
2523     cmsSpace()-&gt;verify();
2524   } else {
2525     MutexLockerEx fll(freelistLock(), Mutex::_no_safepoint_check_flag);
2526     cmsSpace()-&gt;verify();
2527   }
2528 }
2529 
2530 void CMSCollector::verify() {
2531   _cmsGen-&gt;verify();
2532 }
2533 
2534 #ifndef PRODUCT
2535 bool CMSCollector::overflow_list_is_empty() const {
2536   assert(_num_par_pushes &gt;= 0, &quot;Inconsistency&quot;);
2537   if (_overflow_list == NULL) {
2538     assert(_num_par_pushes == 0, &quot;Inconsistency&quot;);
2539   }
2540   return _overflow_list == NULL;
2541 }
2542 
2543 // The methods verify_work_stacks_empty() and verify_overflow_empty()
2544 // merely consolidate assertion checks that appear to occur together frequently.
2545 void CMSCollector::verify_work_stacks_empty() const {
2546   assert(_markStack.isEmpty(), &quot;Marking stack should be empty&quot;);
2547   assert(overflow_list_is_empty(), &quot;Overflow list should be empty&quot;);
2548 }
2549 
2550 void CMSCollector::verify_overflow_empty() const {
2551   assert(overflow_list_is_empty(), &quot;Overflow list should be empty&quot;);
2552   assert(no_preserved_marks(), &quot;No preserved marks&quot;);
2553 }
2554 #endif // PRODUCT
2555 
2556 // Decide if we want to enable class unloading as part of the
2557 // ensuing concurrent GC cycle. We will collect and
2558 // unload classes if it&#39;s the case that:
2559 //  (a) class unloading is enabled at the command line, and
2560 //  (b) old gen is getting really full
2561 // NOTE: Provided there is no change in the state of the heap between
2562 // calls to this method, it should have idempotent results. Moreover,
2563 // its results should be monotonically increasing (i.e. going from 0 to 1,
2564 // but not 1 to 0) between successive calls between which the heap was
2565 // not collected. For the implementation below, it must thus rely on
2566 // the property that concurrent_cycles_since_last_unload()
2567 // will not decrease unless a collection cycle happened and that
2568 // _cmsGen-&gt;is_too_full() are
2569 // themselves also monotonic in that sense. See check_monotonicity()
2570 // below.
2571 void CMSCollector::update_should_unload_classes() {
2572   _should_unload_classes = false;
2573   if (CMSClassUnloadingEnabled) {
2574     _should_unload_classes = (concurrent_cycles_since_last_unload() &gt;=
2575                               CMSClassUnloadingMaxInterval)
2576                            || _cmsGen-&gt;is_too_full();
2577   }
2578 }
2579 
2580 bool ConcurrentMarkSweepGeneration::is_too_full() const {
2581   bool res = should_concurrent_collect();
2582   res = res &amp;&amp; (occupancy() &gt; (double)CMSIsTooFullPercentage/100.0);
2583   return res;
2584 }
2585 
2586 void CMSCollector::setup_cms_unloading_and_verification_state() {
2587   const  bool should_verify =   VerifyBeforeGC || VerifyAfterGC || VerifyDuringGC
2588                              || VerifyBeforeExit;
2589   const  int  rso           =   GenCollectedHeap::SO_AllCodeCache;
2590 
2591   // We set the proper root for this CMS cycle here.
2592   if (should_unload_classes()) {   // Should unload classes this cycle
2593     remove_root_scanning_option(rso);  // Shrink the root set appropriately
2594     set_verifying(should_verify);    // Set verification state for this cycle
2595     return;                            // Nothing else needs to be done at this time
2596   }
2597 
2598   // Not unloading classes this cycle
2599   assert(!should_unload_classes(), &quot;Inconsistency!&quot;);
2600 
2601   // If we are not unloading classes then add SO_AllCodeCache to root
2602   // scanning options.
2603   add_root_scanning_option(rso);
2604 
2605   if ((!verifying() || unloaded_classes_last_cycle()) &amp;&amp; should_verify) {
2606     set_verifying(true);
2607   } else if (verifying() &amp;&amp; !should_verify) {
2608     // We were verifying, but some verification flags got disabled.
2609     set_verifying(false);
2610     // Exclude symbols, strings and code cache elements from root scanning to
2611     // reduce IM and RM pauses.
2612     remove_root_scanning_option(rso);
2613   }
2614 }
2615 
2616 
2617 #ifndef PRODUCT
2618 HeapWord* CMSCollector::block_start(const void* p) const {
2619   const HeapWord* addr = (HeapWord*)p;
2620   if (_span.contains(p)) {
2621     if (_cmsGen-&gt;cmsSpace()-&gt;is_in_reserved(addr)) {
2622       return _cmsGen-&gt;cmsSpace()-&gt;block_start(p);
2623     }
2624   }
2625   return NULL;
2626 }
2627 #endif
2628 
2629 HeapWord*
2630 ConcurrentMarkSweepGeneration::expand_and_allocate(size_t word_size,
2631                                                    bool   tlab,
2632                                                    bool   parallel) {
2633   CMSSynchronousYieldRequest yr;
2634   assert(!tlab, &quot;Can&#39;t deal with TLAB allocation&quot;);
2635   MutexLockerEx x(freelistLock(), Mutex::_no_safepoint_check_flag);
2636   expand_for_gc_cause(word_size*HeapWordSize, MinHeapDeltaBytes, CMSExpansionCause::_satisfy_allocation);
2637   if (GCExpandToAllocateDelayMillis &gt; 0) {
2638     os::sleep(Thread::current(), GCExpandToAllocateDelayMillis, false);
2639   }
2640   return have_lock_and_allocate(word_size, tlab);
2641 }
2642 
2643 void ConcurrentMarkSweepGeneration::expand_for_gc_cause(
2644     size_t bytes,
2645     size_t expand_bytes,
2646     CMSExpansionCause::Cause cause)
2647 {
2648 
2649   bool success = expand(bytes, expand_bytes);
2650 
2651   // remember why we expanded; this information is used
2652   // by shouldConcurrentCollect() when making decisions on whether to start
2653   // a new CMS cycle.
2654   if (success) {
2655     set_expansion_cause(cause);
2656     log_trace(gc)(&quot;Expanded CMS gen for %s&quot;,  CMSExpansionCause::to_string(cause));
2657   }
2658 }
2659 
2660 HeapWord* ConcurrentMarkSweepGeneration::expand_and_par_lab_allocate(CMSParGCThreadState* ps, size_t word_sz) {
2661   HeapWord* res = NULL;
2662   MutexLocker x(ParGCRareEvent_lock);
2663   while (true) {
2664     // Expansion by some other thread might make alloc OK now:
2665     res = ps-&gt;lab.alloc(word_sz);
2666     if (res != NULL) return res;
2667     // If there&#39;s not enough expansion space available, give up.
2668     if (_virtual_space.uncommitted_size() &lt; (word_sz * HeapWordSize)) {
2669       return NULL;
2670     }
2671     // Otherwise, we try expansion.
2672     expand_for_gc_cause(word_sz*HeapWordSize, MinHeapDeltaBytes, CMSExpansionCause::_allocate_par_lab);
2673     // Now go around the loop and try alloc again;
2674     // A competing par_promote might beat us to the expansion space,
2675     // so we may go around the loop again if promotion fails again.
2676     if (GCExpandToAllocateDelayMillis &gt; 0) {
2677       os::sleep(Thread::current(), GCExpandToAllocateDelayMillis, false);
2678     }
2679   }
2680 }
2681 
2682 
2683 bool ConcurrentMarkSweepGeneration::expand_and_ensure_spooling_space(
2684   PromotionInfo* promo) {
2685   MutexLocker x(ParGCRareEvent_lock);
2686   size_t refill_size_bytes = promo-&gt;refillSize() * HeapWordSize;
2687   while (true) {
2688     // Expansion by some other thread might make alloc OK now:
2689     if (promo-&gt;ensure_spooling_space()) {
2690       assert(promo-&gt;has_spooling_space(),
2691              &quot;Post-condition of successful ensure_spooling_space()&quot;);
2692       return true;
2693     }
2694     // If there&#39;s not enough expansion space available, give up.
2695     if (_virtual_space.uncommitted_size() &lt; refill_size_bytes) {
2696       return false;
2697     }
2698     // Otherwise, we try expansion.
2699     expand_for_gc_cause(refill_size_bytes, MinHeapDeltaBytes, CMSExpansionCause::_allocate_par_spooling_space);
2700     // Now go around the loop and try alloc again;
2701     // A competing allocation might beat us to the expansion space,
2702     // so we may go around the loop again if allocation fails again.
2703     if (GCExpandToAllocateDelayMillis &gt; 0) {
2704       os::sleep(Thread::current(), GCExpandToAllocateDelayMillis, false);
2705     }
2706   }
2707 }
2708 
2709 void ConcurrentMarkSweepGeneration::shrink(size_t bytes) {
2710   // Only shrink if a compaction was done so that all the free space
2711   // in the generation is in a contiguous block at the end.
2712   if (did_compact()) {
2713     CardGeneration::shrink(bytes);
2714   }
2715 }
2716 
2717 void ConcurrentMarkSweepGeneration::assert_correct_size_change_locking() {
2718   assert_locked_or_safepoint(Heap_lock);
2719 }
2720 
2721 void ConcurrentMarkSweepGeneration::shrink_free_list_by(size_t bytes) {
2722   assert_locked_or_safepoint(Heap_lock);
2723   assert_lock_strong(freelistLock());
2724   log_trace(gc)(&quot;Shrinking of CMS not yet implemented&quot;);
2725   return;
2726 }
2727 
2728 
2729 // Simple ctor/dtor wrapper for accounting &amp; timer chores around concurrent
2730 // phases.
2731 class CMSPhaseAccounting: public StackObj {
2732  public:
2733   CMSPhaseAccounting(CMSCollector *collector,
2734                      const char *title);
2735   ~CMSPhaseAccounting();
2736 
2737  private:
2738   CMSCollector *_collector;
2739   const char *_title;
2740   GCTraceConcTime(Info, gc) _trace_time;
2741 
2742  public:
2743   // Not MT-safe; so do not pass around these StackObj&#39;s
2744   // where they may be accessed by other threads.
2745   double wallclock_millis() {
2746     return TimeHelper::counter_to_millis(os::elapsed_counter() - _trace_time.start_time());
2747   }
2748 };
2749 
2750 CMSPhaseAccounting::CMSPhaseAccounting(CMSCollector *collector,
2751                                        const char *title) :
2752   _collector(collector), _title(title), _trace_time(title) {
2753 
2754   _collector-&gt;resetYields();
2755   _collector-&gt;resetTimer();
2756   _collector-&gt;startTimer();
2757   _collector-&gt;gc_timer_cm()-&gt;register_gc_concurrent_start(title);
2758 }
2759 
2760 CMSPhaseAccounting::~CMSPhaseAccounting() {
2761   _collector-&gt;gc_timer_cm()-&gt;register_gc_concurrent_end();
2762   _collector-&gt;stopTimer();
2763   log_debug(gc)(&quot;Concurrent active time: %.3fms&quot;, TimeHelper::counter_to_millis(_collector-&gt;timerTicks()));
2764   log_trace(gc)(&quot; (CMS %s yielded %d times)&quot;, _title, _collector-&gt;yields());
2765 }
2766 
2767 // CMS work
2768 
2769 // The common parts of CMSParInitialMarkTask and CMSParRemarkTask.
2770 class CMSParMarkTask : public AbstractGangTask {
2771  protected:
2772   CMSCollector*     _collector;
2773   uint              _n_workers;
2774   OopStorage::ParState&lt;false, false&gt; _par_state_string;
2775   CMSParMarkTask(const char* name, CMSCollector* collector, uint n_workers) :
2776       AbstractGangTask(name),
2777       _collector(collector),
2778       _n_workers(n_workers),
2779       _par_state_string(StringTable::weak_storage()) {}
2780   // Work method in support of parallel rescan ... of young gen spaces
2781   void do_young_space_rescan(OopsInGenClosure* cl,
2782                              ContiguousSpace* space,
2783                              HeapWord** chunk_array, size_t chunk_top);
2784   void work_on_young_gen_roots(OopsInGenClosure* cl);
2785 };
2786 
2787 // Parallel initial mark task
2788 class CMSParInitialMarkTask: public CMSParMarkTask {
2789   StrongRootsScope* _strong_roots_scope;
2790  public:
2791   CMSParInitialMarkTask(CMSCollector* collector, StrongRootsScope* strong_roots_scope, uint n_workers) :
2792       CMSParMarkTask(&quot;Scan roots and young gen for initial mark in parallel&quot;, collector, n_workers),
2793       _strong_roots_scope(strong_roots_scope) {}
2794   void work(uint worker_id);
2795 };
2796 
2797 // Checkpoint the roots into this generation from outside
2798 // this generation. [Note this initial checkpoint need only
2799 // be approximate -- we&#39;ll do a catch up phase subsequently.]
2800 void CMSCollector::checkpointRootsInitial() {
2801   assert(_collectorState == InitialMarking, &quot;Wrong collector state&quot;);
2802   check_correct_thread_executing();
2803   TraceCMSMemoryManagerStats tms(_collectorState, CMSHeap::heap()-&gt;gc_cause());
2804 
2805   save_heap_summary();
2806   report_heap_summary(GCWhen::BeforeGC);
2807 
2808   ReferenceProcessor* rp = ref_processor();
2809   assert(_restart_addr == NULL, &quot;Control point invariant&quot;);
2810   {
2811     // acquire locks for subsequent manipulations
2812     MutexLockerEx x(bitMapLock(),
2813                     Mutex::_no_safepoint_check_flag);
2814     checkpointRootsInitialWork();
2815     // enable (&quot;weak&quot;) refs discovery
2816     rp-&gt;enable_discovery();
2817     _collectorState = Marking;
2818   }
2819 }
2820 
2821 void CMSCollector::checkpointRootsInitialWork() {
2822   assert(SafepointSynchronize::is_at_safepoint(), &quot;world should be stopped&quot;);
2823   assert(_collectorState == InitialMarking, &quot;just checking&quot;);
2824 
2825   // Already have locks.
2826   assert_lock_strong(bitMapLock());
2827   assert(_markBitMap.isAllClear(), &quot;was reset at end of previous cycle&quot;);
2828 
2829   // Setup the verification and class unloading state for this
2830   // CMS collection cycle.
2831   setup_cms_unloading_and_verification_state();
2832 
2833   GCTraceTime(Trace, gc, phases) ts(&quot;checkpointRootsInitialWork&quot;, _gc_timer_cm);
2834 
2835   // Reset all the PLAB chunk arrays if necessary.
2836   if (_survivor_plab_array != NULL &amp;&amp; !CMSPLABRecordAlways) {
2837     reset_survivor_plab_arrays();
2838   }
2839 
2840   ResourceMark rm;
2841   HandleMark  hm;
2842 
2843   MarkRefsIntoClosure notOlder(_span, &amp;_markBitMap);
2844   CMSHeap* heap = CMSHeap::heap();
2845 
2846   verify_work_stacks_empty();
2847   verify_overflow_empty();
2848 
2849   heap-&gt;ensure_parsability(false);  // fill TLABs, but no need to retire them
2850   // Update the saved marks which may affect the root scans.
2851   heap-&gt;save_marks();
2852 
2853   // weak reference processing has not started yet.
2854   ref_processor()-&gt;set_enqueuing_is_done(false);
2855 
2856   // Need to remember all newly created CLDs,
2857   // so that we can guarantee that the remark finds them.
2858   ClassLoaderDataGraph::remember_new_clds(true);
2859 
2860   // Whenever a CLD is found, it will be claimed before proceeding to mark
2861   // the klasses. The claimed marks need to be cleared before marking starts.
2862   ClassLoaderDataGraph::clear_claimed_marks();
2863 
2864   print_eden_and_survivor_chunk_arrays();
2865 
2866   {
2867 #if COMPILER2_OR_JVMCI
2868     DerivedPointerTableDeactivate dpt_deact;
2869 #endif
2870     if (CMSParallelInitialMarkEnabled) {
2871       // The parallel version.
2872       WorkGang* workers = heap-&gt;workers();
2873       assert(workers != NULL, &quot;Need parallel worker threads.&quot;);
2874       uint n_workers = workers-&gt;active_workers();
2875 
2876       StrongRootsScope srs(n_workers);
2877 
2878       CMSParInitialMarkTask tsk(this, &amp;srs, n_workers);
2879       initialize_sequential_subtasks_for_young_gen_rescan(n_workers);
2880       // If the total workers is greater than 1, then multiple workers
2881       // may be used at some time and the initialization has been set
2882       // such that the single threaded path cannot be used.
2883       if (workers-&gt;total_workers() &gt; 1) {
2884         workers-&gt;run_task(&amp;tsk);
2885       } else {
2886         tsk.work(0);
2887       }
2888     } else {
2889       // The serial version.
2890       CLDToOopClosure cld_closure(&amp;notOlder, ClassLoaderData::_claim_strong);
2891       heap-&gt;rem_set()-&gt;prepare_for_younger_refs_iterate(false); // Not parallel.
2892 
2893       StrongRootsScope srs(1);
2894 
2895       heap-&gt;cms_process_roots(&amp;srs,
2896                              true,   // young gen as roots
2897                              GenCollectedHeap::ScanningOption(roots_scanning_options()),
2898                              should_unload_classes(),
2899                              &amp;notOlder,
2900                              &amp;cld_closure);
2901     }
2902   }
2903 
2904   // Clear mod-union table; it will be dirtied in the prologue of
2905   // CMS generation per each young generation collection.
2906 
2907   assert(_modUnionTable.isAllClear(),
2908        &quot;Was cleared in most recent final checkpoint phase&quot;
2909        &quot; or no bits are set in the gc_prologue before the start of the next &quot;
2910        &quot;subsequent marking phase.&quot;);
2911 
2912   assert(_ct-&gt;cld_rem_set()-&gt;mod_union_is_clear(), &quot;Must be&quot;);
2913 
2914   // Save the end of the used_region of the constituent generations
2915   // to be used to limit the extent of sweep in each generation.
2916   save_sweep_limits();
2917   verify_overflow_empty();
2918 }
2919 
2920 bool CMSCollector::markFromRoots() {
2921   // we might be tempted to assert that:
2922   // assert(!SafepointSynchronize::is_at_safepoint(),
2923   //        &quot;inconsistent argument?&quot;);
2924   // However that wouldn&#39;t be right, because it&#39;s possible that
2925   // a safepoint is indeed in progress as a young generation
2926   // stop-the-world GC happens even as we mark in this generation.
2927   assert(_collectorState == Marking, &quot;inconsistent state?&quot;);
2928   check_correct_thread_executing();
2929   verify_overflow_empty();
2930 
2931   // Weak ref discovery note: We may be discovering weak
2932   // refs in this generation concurrent (but interleaved) with
2933   // weak ref discovery by the young generation collector.
2934 
2935   CMSTokenSyncWithLocks ts(true, bitMapLock());
2936   GCTraceCPUTime tcpu;
2937   CMSPhaseAccounting pa(this, &quot;Concurrent Mark&quot;);
2938   bool res = markFromRootsWork();
2939   if (res) {
2940     _collectorState = Precleaning;
2941   } else { // We failed and a foreground collection wants to take over
2942     assert(_foregroundGCIsActive, &quot;internal state inconsistency&quot;);
2943     assert(_restart_addr == NULL,  &quot;foreground will restart from scratch&quot;);
2944     log_debug(gc)(&quot;bailing out to foreground collection&quot;);
2945   }
2946   verify_overflow_empty();
2947   return res;
2948 }
2949 
2950 bool CMSCollector::markFromRootsWork() {
2951   // iterate over marked bits in bit map, doing a full scan and mark
2952   // from these roots using the following algorithm:
2953   // . if oop is to the right of the current scan pointer,
2954   //   mark corresponding bit (we&#39;ll process it later)
2955   // . else (oop is to left of current scan pointer)
2956   //   push oop on marking stack
2957   // . drain the marking stack
2958 
2959   // Note that when we do a marking step we need to hold the
2960   // bit map lock -- recall that direct allocation (by mutators)
2961   // and promotion (by the young generation collector) is also
2962   // marking the bit map. [the so-called allocate live policy.]
2963   // Because the implementation of bit map marking is not
2964   // robust wrt simultaneous marking of bits in the same word,
2965   // we need to make sure that there is no such interference
2966   // between concurrent such updates.
2967 
2968   // already have locks
2969   assert_lock_strong(bitMapLock());
2970 
2971   verify_work_stacks_empty();
2972   verify_overflow_empty();
2973   bool result = false;
2974   if (CMSConcurrentMTEnabled &amp;&amp; ConcGCThreads &gt; 0) {
2975     result = do_marking_mt();
2976   } else {
2977     result = do_marking_st();
2978   }
2979   return result;
2980 }
2981 
2982 // Forward decl
2983 class CMSConcMarkingTask;
2984 
2985 class CMSConcMarkingParallelTerminator: public ParallelTaskTerminator {
2986   CMSCollector*       _collector;
2987   CMSConcMarkingTask* _task;
2988  public:
2989   virtual void yield();
2990 
2991   // &quot;n_threads&quot; is the number of threads to be terminated.
2992   // &quot;queue_set&quot; is a set of work queues of other threads.
2993   // &quot;collector&quot; is the CMS collector associated with this task terminator.
2994   // &quot;yield&quot; indicates whether we need the gang as a whole to yield.
2995   CMSConcMarkingParallelTerminator(int n_threads, TaskQueueSetSuper* queue_set, CMSCollector* collector) :
2996     ParallelTaskTerminator(n_threads, queue_set),
2997     _collector(collector) { }
2998 
2999   void set_task(CMSConcMarkingTask* task) {
3000     _task = task;
3001   }
3002 };
3003 
3004 class CMSConcMarkingOWSTTerminator: public OWSTTaskTerminator {
3005   CMSCollector*       _collector;
3006   CMSConcMarkingTask* _task;
3007  public:
3008   virtual void yield();
3009 
3010   // &quot;n_threads&quot; is the number of threads to be terminated.
3011   // &quot;queue_set&quot; is a set of work queues of other threads.
3012   // &quot;collector&quot; is the CMS collector associated with this task terminator.
3013   // &quot;yield&quot; indicates whether we need the gang as a whole to yield.
3014   CMSConcMarkingOWSTTerminator(int n_threads, TaskQueueSetSuper* queue_set, CMSCollector* collector) :
3015     OWSTTaskTerminator(n_threads, queue_set),
3016     _collector(collector) { }
3017 
3018   void set_task(CMSConcMarkingTask* task) {
3019     _task = task;
3020   }
3021 };
3022 
3023 class CMSConcMarkingTaskTerminator {
3024  private:
3025   ParallelTaskTerminator* _term;
3026  public:
3027   CMSConcMarkingTaskTerminator(int n_threads, TaskQueueSetSuper* queue_set, CMSCollector* collector) {
3028     if (UseOWSTTaskTerminator) {
3029       _term = new CMSConcMarkingOWSTTerminator(n_threads, queue_set, collector);
3030     } else {
3031       _term = new CMSConcMarkingParallelTerminator(n_threads, queue_set, collector);
3032     }
3033   }
3034   ~CMSConcMarkingTaskTerminator() {
3035     assert(_term != NULL, &quot;Must not be NULL&quot;);
3036     delete _term;
3037   }
3038 
3039   void set_task(CMSConcMarkingTask* task);
3040   ParallelTaskTerminator* terminator() const { return _term; }
3041 };
3042 
3043 class CMSConcMarkingTerminatorTerminator: public TerminatorTerminator {
3044   CMSConcMarkingTask* _task;
3045  public:
3046   bool should_exit_termination();
3047   void set_task(CMSConcMarkingTask* task) {
3048     _task = task;
3049   }
3050 };
3051 
3052 // MT Concurrent Marking Task
3053 class CMSConcMarkingTask: public YieldingFlexibleGangTask {
3054   CMSCollector*             _collector;
3055   uint                      _n_workers;      // requested/desired # workers
3056   bool                      _result;
3057   CompactibleFreeListSpace* _cms_space;
3058   char                      _pad_front[64];   // padding to ...
3059   HeapWord* volatile        _global_finger;   // ... avoid sharing cache line
3060   char                      _pad_back[64];
3061   HeapWord*                 _restart_addr;
3062 
3063   //  Exposed here for yielding support
3064   Mutex* const _bit_map_lock;
3065 
3066   // The per thread work queues, available here for stealing
3067   OopTaskQueueSet*  _task_queues;
3068 
3069   // Termination (and yielding) support
3070   CMSConcMarkingTaskTerminator       _term;
3071   CMSConcMarkingTerminatorTerminator _term_term;
3072 
3073  public:
3074   CMSConcMarkingTask(CMSCollector* collector,
3075                  CompactibleFreeListSpace* cms_space,
3076                  YieldingFlexibleWorkGang* workers,
3077                  OopTaskQueueSet* task_queues):
3078     YieldingFlexibleGangTask(&quot;Concurrent marking done multi-threaded&quot;),
3079     _collector(collector),
3080     _n_workers(0),
3081     _result(true),
3082     _cms_space(cms_space),
3083     _bit_map_lock(collector-&gt;bitMapLock()),
3084     _task_queues(task_queues),
3085     _term(_n_workers, task_queues, _collector)
3086   {
3087     _requested_size = _n_workers;
3088     _term.set_task(this);
3089     _term_term.set_task(this);
3090     _restart_addr = _global_finger = _cms_space-&gt;bottom();
3091   }
3092 
3093 
3094   OopTaskQueueSet* task_queues()  { return _task_queues; }
3095 
3096   OopTaskQueue* work_queue(int i) { return task_queues()-&gt;queue(i); }
3097 
3098   HeapWord* volatile* global_finger_addr() { return &amp;_global_finger; }
3099 
3100   ParallelTaskTerminator* terminator() { return _term.terminator(); }
3101 
3102   virtual void set_for_termination(uint active_workers) {
3103     terminator()-&gt;reset_for_reuse(active_workers);
3104   }
3105 
3106   void work(uint worker_id);
3107   bool should_yield() {
3108     return    ConcurrentMarkSweepThread::should_yield()
3109            &amp;&amp; !_collector-&gt;foregroundGCIsActive();
3110   }
3111 
3112   virtual void coordinator_yield();  // stuff done by coordinator
3113   bool result() { return _result; }
3114 
3115   void reset(HeapWord* ra) {
3116     assert(_global_finger &gt;= _cms_space-&gt;end(),  &quot;Postcondition of ::work(i)&quot;);
3117     _restart_addr = _global_finger = ra;
3118     _term.terminator()-&gt;reset_for_reuse();
3119   }
3120 
3121   static bool get_work_from_overflow_stack(CMSMarkStack* ovflw_stk,
3122                                            OopTaskQueue* work_q);
3123 
3124  private:
3125   void do_scan_and_mark(int i, CompactibleFreeListSpace* sp);
3126   void do_work_steal(int i);
3127   void bump_global_finger(HeapWord* f);
3128 };
3129 
3130 bool CMSConcMarkingTerminatorTerminator::should_exit_termination() {
3131   assert(_task != NULL, &quot;Error&quot;);
3132   return _task-&gt;yielding();
3133   // Note that we do not need the disjunct || _task-&gt;should_yield() above
3134   // because we want terminating threads to yield only if the task
3135   // is already in the midst of yielding, which happens only after at least one
3136   // thread has yielded.
3137 }
3138 
3139 void CMSConcMarkingParallelTerminator::yield() {
3140   if (_task-&gt;should_yield()) {
3141     _task-&gt;yield();
3142   } else {
3143     ParallelTaskTerminator::yield();
3144   }
3145 }
3146 
3147 void CMSConcMarkingOWSTTerminator::yield() {
3148   if (_task-&gt;should_yield()) {
3149     _task-&gt;yield();
3150   } else {
3151     OWSTTaskTerminator::yield();
3152   }
3153 }
3154 
3155 void CMSConcMarkingTaskTerminator::set_task(CMSConcMarkingTask* task) {
3156   if (UseOWSTTaskTerminator) {
3157     ((CMSConcMarkingOWSTTerminator*)_term)-&gt;set_task(task);
3158   } else {
3159     ((CMSConcMarkingParallelTerminator*)_term)-&gt;set_task(task);
3160   }
3161 }
3162 
3163 ////////////////////////////////////////////////////////////////
3164 // Concurrent Marking Algorithm Sketch
3165 ////////////////////////////////////////////////////////////////
3166 // Until all tasks exhausted (both spaces):
3167 // -- claim next available chunk
3168 // -- bump global finger via CAS
3169 // -- find first object that starts in this chunk
3170 //    and start scanning bitmap from that position
3171 // -- scan marked objects for oops
3172 // -- CAS-mark target, and if successful:
3173 //    . if target oop is above global finger (volatile read)
3174 //      nothing to do
3175 //    . if target oop is in chunk and above local finger
3176 //        then nothing to do
3177 //    . else push on work-queue
3178 // -- Deal with possible overflow issues:
3179 //    . local work-queue overflow causes stuff to be pushed on
3180 //      global (common) overflow queue
3181 //    . always first empty local work queue
3182 //    . then get a batch of oops from global work queue if any
3183 //    . then do work stealing
3184 // -- When all tasks claimed (both spaces)
3185 //    and local work queue empty,
3186 //    then in a loop do:
3187 //    . check global overflow stack; steal a batch of oops and trace
3188 //    . try to steal from other threads oif GOS is empty
3189 //    . if neither is available, offer termination
3190 // -- Terminate and return result
3191 //
3192 void CMSConcMarkingTask::work(uint worker_id) {
3193   elapsedTimer _timer;
3194   ResourceMark rm;
3195   HandleMark hm;
3196 
3197   DEBUG_ONLY(_collector-&gt;verify_overflow_empty();)
3198 
3199   // Before we begin work, our work queue should be empty
3200   assert(work_queue(worker_id)-&gt;size() == 0, &quot;Expected to be empty&quot;);
3201   // Scan the bitmap covering _cms_space, tracing through grey objects.
3202   _timer.start();
3203   do_scan_and_mark(worker_id, _cms_space);
3204   _timer.stop();
3205   log_trace(gc, task)(&quot;Finished cms space scanning in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
3206 
3207   // ... do work stealing
3208   _timer.reset();
3209   _timer.start();
3210   do_work_steal(worker_id);
3211   _timer.stop();
3212   log_trace(gc, task)(&quot;Finished work stealing in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
3213   assert(_collector-&gt;_markStack.isEmpty(), &quot;Should have been emptied&quot;);
3214   assert(work_queue(worker_id)-&gt;size() == 0, &quot;Should have been emptied&quot;);
3215   // Note that under the current task protocol, the
3216   // following assertion is true even of the spaces
3217   // expanded since the completion of the concurrent
3218   // marking. XXX This will likely change under a strict
3219   // ABORT semantics.
3220   // After perm removal the comparison was changed to
3221   // greater than or equal to from strictly greater than.
3222   // Before perm removal the highest address sweep would
3223   // have been at the end of perm gen but now is at the
3224   // end of the tenured gen.
3225   assert(_global_finger &gt;=  _cms_space-&gt;end(),
3226          &quot;All tasks have been completed&quot;);
3227   DEBUG_ONLY(_collector-&gt;verify_overflow_empty();)
3228 }
3229 
3230 void CMSConcMarkingTask::bump_global_finger(HeapWord* f) {
3231   HeapWord* read = _global_finger;
3232   HeapWord* cur  = read;
3233   while (f &gt; read) {
3234     cur = read;
3235     read = Atomic::cmpxchg(f, &amp;_global_finger, cur);
3236     if (cur == read) {
3237       // our cas succeeded
3238       assert(_global_finger &gt;= f, &quot;protocol consistency&quot;);
3239       break;
3240     }
3241   }
3242 }
3243 
3244 // This is really inefficient, and should be redone by
3245 // using (not yet available) block-read and -write interfaces to the
3246 // stack and the work_queue. XXX FIX ME !!!
3247 bool CMSConcMarkingTask::get_work_from_overflow_stack(CMSMarkStack* ovflw_stk,
3248                                                       OopTaskQueue* work_q) {
3249   // Fast lock-free check
3250   if (ovflw_stk-&gt;length() == 0) {
3251     return false;
3252   }
3253   assert(work_q-&gt;size() == 0, &quot;Shouldn&#39;t steal&quot;);
3254   MutexLockerEx ml(ovflw_stk-&gt;par_lock(),
3255                    Mutex::_no_safepoint_check_flag);
3256   // Grab up to 1/4 the size of the work queue
3257   size_t num = MIN2((size_t)(work_q-&gt;max_elems() - work_q-&gt;size())/4,
3258                     (size_t)ParGCDesiredObjsFromOverflowList);
3259   num = MIN2(num, ovflw_stk-&gt;length());
3260   for (int i = (int) num; i &gt; 0; i--) {
3261     oop cur = ovflw_stk-&gt;pop();
3262     assert(cur != NULL, &quot;Counted wrong?&quot;);
3263     work_q-&gt;push(cur);
3264   }
3265   return num &gt; 0;
3266 }
3267 
3268 void CMSConcMarkingTask::do_scan_and_mark(int i, CompactibleFreeListSpace* sp) {
3269   SequentialSubTasksDone* pst = sp-&gt;conc_par_seq_tasks();
3270   int n_tasks = pst-&gt;n_tasks();
3271   // We allow that there may be no tasks to do here because
3272   // we are restarting after a stack overflow.
3273   assert(pst-&gt;valid() || n_tasks == 0, &quot;Uninitialized use?&quot;);
3274   uint nth_task = 0;
3275 
3276   HeapWord* aligned_start = sp-&gt;bottom();
3277   if (sp-&gt;used_region().contains(_restart_addr)) {
3278     // Align down to a card boundary for the start of 0th task
3279     // for this space.
3280     aligned_start = align_down(_restart_addr, CardTable::card_size);
3281   }
3282 
3283   size_t chunk_size = sp-&gt;marking_task_size();
3284   while (pst-&gt;try_claim_task(/* reference */ nth_task)) {
3285     // Having claimed the nth task in this space,
3286     // compute the chunk that it corresponds to:
3287     MemRegion span = MemRegion(aligned_start + nth_task*chunk_size,
3288                                aligned_start + (nth_task+1)*chunk_size);
3289     // Try and bump the global finger via a CAS;
3290     // note that we need to do the global finger bump
3291     // _before_ taking the intersection below, because
3292     // the task corresponding to that region will be
3293     // deemed done even if the used_region() expands
3294     // because of allocation -- as it almost certainly will
3295     // during start-up while the threads yield in the
3296     // closure below.
3297     HeapWord* finger = span.end();
3298     bump_global_finger(finger);   // atomically
3299     // There are null tasks here corresponding to chunks
3300     // beyond the &quot;top&quot; address of the space.
3301     span = span.intersection(sp-&gt;used_region());
3302     if (!span.is_empty()) {  // Non-null task
3303       HeapWord* prev_obj;
3304       assert(!span.contains(_restart_addr) || nth_task == 0,
3305              &quot;Inconsistency&quot;);
3306       if (nth_task == 0) {
3307         // For the 0th task, we&#39;ll not need to compute a block_start.
3308         if (span.contains(_restart_addr)) {
3309           // In the case of a restart because of stack overflow,
3310           // we might additionally skip a chunk prefix.
3311           prev_obj = _restart_addr;
3312         } else {
3313           prev_obj = span.start();
3314         }
3315       } else {
3316         // We want to skip the first object because
3317         // the protocol is to scan any object in its entirety
3318         // that _starts_ in this span; a fortiori, any
3319         // object starting in an earlier span is scanned
3320         // as part of an earlier claimed task.
3321         // Below we use the &quot;careful&quot; version of block_start
3322         // so we do not try to navigate uninitialized objects.
3323         prev_obj = sp-&gt;block_start_careful(span.start());
3324         // Below we use a variant of block_size that uses the
3325         // Printezis bits to avoid waiting for allocated
3326         // objects to become initialized/parsable.
3327         while (prev_obj &lt; span.start()) {
3328           size_t sz = sp-&gt;block_size_no_stall(prev_obj, _collector);
3329           if (sz &gt; 0) {
3330             prev_obj += sz;
3331           } else {
3332             // In this case we may end up doing a bit of redundant
3333             // scanning, but that appears unavoidable, short of
3334             // locking the free list locks; see bug 6324141.
3335             break;
3336           }
3337         }
3338       }
3339       if (prev_obj &lt; span.end()) {
3340         MemRegion my_span = MemRegion(prev_obj, span.end());
3341         // Do the marking work within a non-empty span --
3342         // the last argument to the constructor indicates whether the
3343         // iteration should be incremental with periodic yields.
3344         ParMarkFromRootsClosure cl(this, _collector, my_span,
3345                                    &amp;_collector-&gt;_markBitMap,
3346                                    work_queue(i),
3347                                    &amp;_collector-&gt;_markStack);
3348         _collector-&gt;_markBitMap.iterate(&amp;cl, my_span.start(), my_span.end());
3349       } // else nothing to do for this task
3350     }   // else nothing to do for this task
3351   }
3352   // We&#39;d be tempted to assert here that since there are no
3353   // more tasks left to claim in this space, the global_finger
3354   // must exceed space-&gt;top() and a fortiori space-&gt;end(). However,
3355   // that would not quite be correct because the bumping of
3356   // global_finger occurs strictly after the claiming of a task,
3357   // so by the time we reach here the global finger may not yet
3358   // have been bumped up by the thread that claimed the last
3359   // task.
3360   pst-&gt;all_tasks_completed();
3361 }
3362 
3363 class ParConcMarkingClosure: public MetadataVisitingOopIterateClosure {
3364  private:
3365   CMSCollector* _collector;
3366   CMSConcMarkingTask* _task;
3367   MemRegion     _span;
3368   CMSBitMap*    _bit_map;
3369   CMSMarkStack* _overflow_stack;
3370   OopTaskQueue* _work_queue;
3371  protected:
3372   DO_OOP_WORK_DEFN
3373  public:
3374   ParConcMarkingClosure(CMSCollector* collector, CMSConcMarkingTask* task, OopTaskQueue* work_queue,
3375                         CMSBitMap* bit_map, CMSMarkStack* overflow_stack):
3376     MetadataVisitingOopIterateClosure(collector-&gt;ref_processor()),
3377     _collector(collector),
3378     _task(task),
3379     _span(collector-&gt;_span),
3380     _bit_map(bit_map),
3381     _overflow_stack(overflow_stack),
3382     _work_queue(work_queue)
3383   { }
3384   virtual void do_oop(oop* p);
3385   virtual void do_oop(narrowOop* p);
3386 
3387   void trim_queue(size_t max);
3388   void handle_stack_overflow(HeapWord* lost);
3389   void do_yield_check() {
3390     if (_task-&gt;should_yield()) {
3391       _task-&gt;yield();
3392     }
3393   }
3394 };
3395 
3396 DO_OOP_WORK_IMPL(ParConcMarkingClosure)
3397 
3398 // Grey object scanning during work stealing phase --
3399 // the salient assumption here is that any references
3400 // that are in these stolen objects being scanned must
3401 // already have been initialized (else they would not have
3402 // been published), so we do not need to check for
3403 // uninitialized objects before pushing here.
3404 void ParConcMarkingClosure::do_oop(oop obj) {
3405   assert(oopDesc::is_oop_or_null(obj, true), &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
3406   HeapWord* addr = (HeapWord*)obj;
3407   // Check if oop points into the CMS generation
3408   // and is not marked
3409   if (_span.contains(addr) &amp;&amp; !_bit_map-&gt;isMarked(addr)) {
3410     // a white object ...
3411     // If we manage to &quot;claim&quot; the object, by being the
3412     // first thread to mark it, then we push it on our
3413     // marking stack
3414     if (_bit_map-&gt;par_mark(addr)) {     // ... now grey
3415       // push on work queue (grey set)
3416       bool simulate_overflow = false;
3417       NOT_PRODUCT(
3418         if (CMSMarkStackOverflowALot &amp;&amp;
3419             _collector-&gt;simulate_overflow()) {
3420           // simulate a stack overflow
3421           simulate_overflow = true;
3422         }
3423       )
3424       if (simulate_overflow ||
3425           !(_work_queue-&gt;push(obj) || _overflow_stack-&gt;par_push(obj))) {
3426         // stack overflow
3427         log_trace(gc)(&quot;CMS marking stack overflow (benign) at &quot; SIZE_FORMAT, _overflow_stack-&gt;capacity());
3428         // We cannot assert that the overflow stack is full because
3429         // it may have been emptied since.
3430         assert(simulate_overflow ||
3431                _work_queue-&gt;size() == _work_queue-&gt;max_elems(),
3432               &quot;Else push should have succeeded&quot;);
3433         handle_stack_overflow(addr);
3434       }
3435     } // Else, some other thread got there first
3436     do_yield_check();
3437   }
3438 }
3439 
3440 void ParConcMarkingClosure::trim_queue(size_t max) {
3441   while (_work_queue-&gt;size() &gt; max) {
3442     oop new_oop;
3443     if (_work_queue-&gt;pop_local(new_oop)) {
3444       assert(oopDesc::is_oop(new_oop), &quot;Should be an oop&quot;);
3445       assert(_bit_map-&gt;isMarked((HeapWord*)new_oop), &quot;Grey object&quot;);
3446       assert(_span.contains((HeapWord*)new_oop), &quot;Not in span&quot;);
3447       new_oop-&gt;oop_iterate(this);  // do_oop() above
3448       do_yield_check();
3449     }
3450   }
3451 }
3452 
3453 // Upon stack overflow, we discard (part of) the stack,
3454 // remembering the least address amongst those discarded
3455 // in CMSCollector&#39;s _restart_address.
3456 void ParConcMarkingClosure::handle_stack_overflow(HeapWord* lost) {
3457   // We need to do this under a mutex to prevent other
3458   // workers from interfering with the work done below.
3459   MutexLockerEx ml(_overflow_stack-&gt;par_lock(),
3460                    Mutex::_no_safepoint_check_flag);
3461   // Remember the least grey address discarded
3462   HeapWord* ra = (HeapWord*)_overflow_stack-&gt;least_value(lost);
3463   _collector-&gt;lower_restart_addr(ra);
3464   _overflow_stack-&gt;reset();  // discard stack contents
3465   _overflow_stack-&gt;expand(); // expand the stack if possible
3466 }
3467 
3468 
3469 void CMSConcMarkingTask::do_work_steal(int i) {
3470   OopTaskQueue* work_q = work_queue(i);
3471   oop obj_to_scan;
3472   CMSBitMap* bm = &amp;(_collector-&gt;_markBitMap);
3473   CMSMarkStack* ovflw = &amp;(_collector-&gt;_markStack);
3474   ParConcMarkingClosure cl(_collector, this, work_q, bm, ovflw);
3475   while (true) {
3476     cl.trim_queue(0);
3477     assert(work_q-&gt;size() == 0, &quot;Should have been emptied above&quot;);
3478     if (get_work_from_overflow_stack(ovflw, work_q)) {
3479       // Can&#39;t assert below because the work obtained from the
3480       // overflow stack may already have been stolen from us.
3481       // assert(work_q-&gt;size() &gt; 0, &quot;Work from overflow stack&quot;);
3482       continue;
3483     } else if (task_queues()-&gt;steal(i, /* reference */ obj_to_scan)) {
3484       assert(oopDesc::is_oop(obj_to_scan), &quot;Should be an oop&quot;);
3485       assert(bm-&gt;isMarked((HeapWord*)obj_to_scan), &quot;Grey object&quot;);
3486       obj_to_scan-&gt;oop_iterate(&amp;cl);
3487     } else if (terminator()-&gt;offer_termination(&amp;_term_term)) {
3488       assert(work_q-&gt;size() == 0, &quot;Impossible!&quot;);
3489       break;
3490     } else if (yielding() || should_yield()) {
3491       yield();
3492     }
3493   }
3494 }
3495 
3496 // This is run by the CMS (coordinator) thread.
3497 void CMSConcMarkingTask::coordinator_yield() {
3498   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
3499          &quot;CMS thread should hold CMS token&quot;);
3500   // First give up the locks, then yield, then re-lock
3501   // We should probably use a constructor/destructor idiom to
3502   // do this unlock/lock or modify the MutexUnlocker class to
3503   // serve our purpose. XXX
3504   assert_lock_strong(_bit_map_lock);
3505   _bit_map_lock-&gt;unlock();
3506   ConcurrentMarkSweepThread::desynchronize(true);
3507   _collector-&gt;stopTimer();
3508   _collector-&gt;incrementYields();
3509 
3510   // It is possible for whichever thread initiated the yield request
3511   // not to get a chance to wake up and take the bitmap lock between
3512   // this thread releasing it and reacquiring it. So, while the
3513   // should_yield() flag is on, let&#39;s sleep for a bit to give the
3514   // other thread a chance to wake up. The limit imposed on the number
3515   // of iterations is defensive, to avoid any unforseen circumstances
3516   // putting us into an infinite loop. Since it&#39;s always been this
3517   // (coordinator_yield()) method that was observed to cause the
3518   // problem, we are using a parameter (CMSCoordinatorYieldSleepCount)
3519   // which is by default non-zero. For the other seven methods that
3520   // also perform the yield operation, as are using a different
3521   // parameter (CMSYieldSleepCount) which is by default zero. This way we
3522   // can enable the sleeping for those methods too, if necessary.
3523   // See 6442774.
3524   //
3525   // We really need to reconsider the synchronization between the GC
3526   // thread and the yield-requesting threads in the future and we
3527   // should really use wait/notify, which is the recommended
3528   // way of doing this type of interaction. Additionally, we should
3529   // consolidate the eight methods that do the yield operation and they
3530   // are almost identical into one for better maintainability and
3531   // readability. See 6445193.
3532   //
3533   // Tony 2006.06.29
3534   for (unsigned i = 0; i &lt; CMSCoordinatorYieldSleepCount &amp;&amp;
3535                    ConcurrentMarkSweepThread::should_yield() &amp;&amp;
3536                    !CMSCollector::foregroundGCIsActive(); ++i) {
3537     os::sleep(Thread::current(), 1, false);
3538   }
3539 
3540   ConcurrentMarkSweepThread::synchronize(true);
3541   _bit_map_lock-&gt;lock_without_safepoint_check();
3542   _collector-&gt;startTimer();
3543 }
3544 
3545 bool CMSCollector::do_marking_mt() {
3546   assert(ConcGCThreads &gt; 0 &amp;&amp; conc_workers() != NULL, &quot;precondition&quot;);
3547   uint num_workers = WorkerPolicy::calc_active_conc_workers(conc_workers()-&gt;total_workers(),
3548                                                             conc_workers()-&gt;active_workers(),
3549                                                             Threads::number_of_non_daemon_threads());
3550   num_workers = conc_workers()-&gt;update_active_workers(num_workers);
3551   log_info(gc,task)(&quot;Using %u workers of %u for marking&quot;, num_workers, conc_workers()-&gt;total_workers());
3552 
3553   CompactibleFreeListSpace* cms_space  = _cmsGen-&gt;cmsSpace();
3554 
3555   CMSConcMarkingTask tsk(this,
3556                          cms_space,
3557                          conc_workers(),
3558                          task_queues());
3559 
3560   // Since the actual number of workers we get may be different
3561   // from the number we requested above, do we need to do anything different
3562   // below? In particular, may be we need to subclass the SequantialSubTasksDone
3563   // class?? XXX
3564   cms_space -&gt;initialize_sequential_subtasks_for_marking(num_workers);
3565 
3566   // Refs discovery is already non-atomic.
3567   assert(!ref_processor()-&gt;discovery_is_atomic(), &quot;Should be non-atomic&quot;);
3568   assert(ref_processor()-&gt;discovery_is_mt(), &quot;Discovery should be MT&quot;);
3569   conc_workers()-&gt;start_task(&amp;tsk);
3570   while (tsk.yielded()) {
3571     tsk.coordinator_yield();
3572     conc_workers()-&gt;continue_task(&amp;tsk);
3573   }
3574   // If the task was aborted, _restart_addr will be non-NULL
3575   assert(tsk.completed() || _restart_addr != NULL, &quot;Inconsistency&quot;);
3576   while (_restart_addr != NULL) {
3577     // XXX For now we do not make use of ABORTED state and have not
3578     // yet implemented the right abort semantics (even in the original
3579     // single-threaded CMS case). That needs some more investigation
3580     // and is deferred for now; see CR# TBF. 07252005YSR. XXX
3581     assert(!CMSAbortSemantics || tsk.aborted(), &quot;Inconsistency&quot;);
3582     // If _restart_addr is non-NULL, a marking stack overflow
3583     // occurred; we need to do a fresh marking iteration from the
3584     // indicated restart address.
3585     if (_foregroundGCIsActive) {
3586       // We may be running into repeated stack overflows, having
3587       // reached the limit of the stack size, while making very
3588       // slow forward progress. It may be best to bail out and
3589       // let the foreground collector do its job.
3590       // Clear _restart_addr, so that foreground GC
3591       // works from scratch. This avoids the headache of
3592       // a &quot;rescan&quot; which would otherwise be needed because
3593       // of the dirty mod union table &amp; card table.
3594       _restart_addr = NULL;
3595       return false;
3596     }
3597     // Adjust the task to restart from _restart_addr
3598     tsk.reset(_restart_addr);
3599     cms_space -&gt;initialize_sequential_subtasks_for_marking(num_workers,
3600                   _restart_addr);
3601     _restart_addr = NULL;
3602     // Get the workers going again
3603     conc_workers()-&gt;start_task(&amp;tsk);
3604     while (tsk.yielded()) {
3605       tsk.coordinator_yield();
3606       conc_workers()-&gt;continue_task(&amp;tsk);
3607     }
3608   }
3609   assert(tsk.completed(), &quot;Inconsistency&quot;);
3610   assert(tsk.result() == true, &quot;Inconsistency&quot;);
3611   return true;
3612 }
3613 
3614 bool CMSCollector::do_marking_st() {
3615   ResourceMark rm;
3616   HandleMark   hm;
3617 
3618   // Temporarily make refs discovery single threaded (non-MT)
3619   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(ref_processor(), false);
3620   MarkFromRootsClosure markFromRootsClosure(this, _span, &amp;_markBitMap,
3621     &amp;_markStack, CMSYield);
3622   // the last argument to iterate indicates whether the iteration
3623   // should be incremental with periodic yields.
3624   _markBitMap.iterate(&amp;markFromRootsClosure);
3625   // If _restart_addr is non-NULL, a marking stack overflow
3626   // occurred; we need to do a fresh iteration from the
3627   // indicated restart address.
3628   while (_restart_addr != NULL) {
3629     if (_foregroundGCIsActive) {
3630       // We may be running into repeated stack overflows, having
3631       // reached the limit of the stack size, while making very
3632       // slow forward progress. It may be best to bail out and
3633       // let the foreground collector do its job.
3634       // Clear _restart_addr, so that foreground GC
3635       // works from scratch. This avoids the headache of
3636       // a &quot;rescan&quot; which would otherwise be needed because
3637       // of the dirty mod union table &amp; card table.
3638       _restart_addr = NULL;
3639       return false;  // indicating failure to complete marking
3640     }
3641     // Deal with stack overflow:
3642     // we restart marking from _restart_addr
3643     HeapWord* ra = _restart_addr;
3644     markFromRootsClosure.reset(ra);
3645     _restart_addr = NULL;
3646     _markBitMap.iterate(&amp;markFromRootsClosure, ra, _span.end());
3647   }
3648   return true;
3649 }
3650 
3651 void CMSCollector::preclean() {
3652   check_correct_thread_executing();
3653   assert(Thread::current()-&gt;is_ConcurrentGC_thread(), &quot;Wrong thread&quot;);
3654   verify_work_stacks_empty();
3655   verify_overflow_empty();
3656   _abort_preclean = false;
3657   if (CMSPrecleaningEnabled) {
3658     if (!CMSEdenChunksRecordAlways) {
3659       _eden_chunk_index = 0;
3660     }
3661     size_t used = get_eden_used();
3662     size_t capacity = get_eden_capacity();
3663     // Don&#39;t start sampling unless we will get sufficiently
3664     // many samples.
3665     if (used &lt; (((capacity / CMSScheduleRemarkSamplingRatio) / 100)
3666                 * CMSScheduleRemarkEdenPenetration)) {
3667       _start_sampling = true;
3668     } else {
3669       _start_sampling = false;
3670     }
3671     GCTraceCPUTime tcpu;
3672     CMSPhaseAccounting pa(this, &quot;Concurrent Preclean&quot;);
3673     preclean_work(CMSPrecleanRefLists1, CMSPrecleanSurvivors1);
3674   }
3675   CMSTokenSync x(true); // is cms thread
3676   if (CMSPrecleaningEnabled) {
3677     sample_eden();
3678     _collectorState = AbortablePreclean;
3679   } else {
3680     _collectorState = FinalMarking;
3681   }
3682   verify_work_stacks_empty();
3683   verify_overflow_empty();
3684 }
3685 
3686 // Try and schedule the remark such that young gen
3687 // occupancy is CMSScheduleRemarkEdenPenetration %.
3688 void CMSCollector::abortable_preclean() {
3689   check_correct_thread_executing();
3690   assert(CMSPrecleaningEnabled,  &quot;Inconsistent control state&quot;);
3691   assert(_collectorState == AbortablePreclean, &quot;Inconsistent control state&quot;);
3692 
3693   // If Eden&#39;s current occupancy is below this threshold,
3694   // immediately schedule the remark; else preclean
3695   // past the next scavenge in an effort to
3696   // schedule the pause as described above. By choosing
3697   // CMSScheduleRemarkEdenSizeThreshold &gt;= max eden size
3698   // we will never do an actual abortable preclean cycle.
3699   if (get_eden_used() &gt; CMSScheduleRemarkEdenSizeThreshold) {
3700     GCTraceCPUTime tcpu;
3701     CMSPhaseAccounting pa(this, &quot;Concurrent Abortable Preclean&quot;);
3702     // We need more smarts in the abortable preclean
3703     // loop below to deal with cases where allocation
3704     // in young gen is very very slow, and our precleaning
3705     // is running a losing race against a horde of
3706     // mutators intent on flooding us with CMS updates
3707     // (dirty cards).
3708     // One, admittedly dumb, strategy is to give up
3709     // after a certain number of abortable precleaning loops
3710     // or after a certain maximum time. We want to make
3711     // this smarter in the next iteration.
3712     // XXX FIX ME!!! YSR
3713     size_t loops = 0, workdone = 0, cumworkdone = 0, waited = 0;
3714     while (!(should_abort_preclean() ||
3715              ConcurrentMarkSweepThread::cmst()-&gt;should_terminate())) {
3716       workdone = preclean_work(CMSPrecleanRefLists2, CMSPrecleanSurvivors2);
3717       cumworkdone += workdone;
3718       loops++;
3719       // Voluntarily terminate abortable preclean phase if we have
3720       // been at it for too long.
3721       if ((CMSMaxAbortablePrecleanLoops != 0) &amp;&amp;
3722           loops &gt;= CMSMaxAbortablePrecleanLoops) {
3723         log_debug(gc)(&quot; CMS: abort preclean due to loops &quot;);
3724         break;
3725       }
3726       if (pa.wallclock_millis() &gt; CMSMaxAbortablePrecleanTime) {
3727         log_debug(gc)(&quot; CMS: abort preclean due to time &quot;);
3728         break;
3729       }
3730       // If we are doing little work each iteration, we should
3731       // take a short break.
3732       if (workdone &lt; CMSAbortablePrecleanMinWorkPerIteration) {
3733         // Sleep for some time, waiting for work to accumulate
3734         stopTimer();
3735         cmsThread()-&gt;wait_on_cms_lock(CMSAbortablePrecleanWaitMillis);
3736         startTimer();
3737         waited++;
3738       }
3739     }
3740     log_trace(gc)(&quot; [&quot; SIZE_FORMAT &quot; iterations, &quot; SIZE_FORMAT &quot; waits, &quot; SIZE_FORMAT &quot; cards)] &quot;,
3741                                loops, waited, cumworkdone);
3742   }
3743   CMSTokenSync x(true); // is cms thread
3744   if (_collectorState != Idling) {
3745     assert(_collectorState == AbortablePreclean,
3746            &quot;Spontaneous state transition?&quot;);
3747     _collectorState = FinalMarking;
3748   } // Else, a foreground collection completed this CMS cycle.
3749   return;
3750 }
3751 
3752 // Respond to an Eden sampling opportunity
3753 void CMSCollector::sample_eden() {
3754   // Make sure a young gc cannot sneak in between our
3755   // reading and recording of a sample.
3756   assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
3757          &quot;Only the cms thread may collect Eden samples&quot;);
3758   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
3759          &quot;Should collect samples while holding CMS token&quot;);
3760   if (!_start_sampling) {
3761     return;
3762   }
3763   // When CMSEdenChunksRecordAlways is true, the eden chunk array
3764   // is populated by the young generation.
3765   if (_eden_chunk_array != NULL &amp;&amp; !CMSEdenChunksRecordAlways) {
3766     if (_eden_chunk_index &lt; _eden_chunk_capacity) {
3767       _eden_chunk_array[_eden_chunk_index] = *_top_addr;   // take sample
3768       assert(_eden_chunk_array[_eden_chunk_index] &lt;= *_end_addr,
3769              &quot;Unexpected state of Eden&quot;);
3770       // We&#39;d like to check that what we just sampled is an oop-start address;
3771       // however, we cannot do that here since the object may not yet have been
3772       // initialized. So we&#39;ll instead do the check when we _use_ this sample
3773       // later.
3774       if (_eden_chunk_index == 0 ||
3775           (pointer_delta(_eden_chunk_array[_eden_chunk_index],
3776                          _eden_chunk_array[_eden_chunk_index-1])
3777            &gt;= CMSSamplingGrain)) {
3778         _eden_chunk_index++;  // commit sample
3779       }
3780     }
3781   }
3782   if ((_collectorState == AbortablePreclean) &amp;&amp; !_abort_preclean) {
3783     size_t used = get_eden_used();
3784     size_t capacity = get_eden_capacity();
3785     assert(used &lt;= capacity, &quot;Unexpected state of Eden&quot;);
3786     if (used &gt;  (capacity/100 * CMSScheduleRemarkEdenPenetration)) {
3787       _abort_preclean = true;
3788     }
3789   }
3790 }
3791 
3792 size_t CMSCollector::preclean_work(bool clean_refs, bool clean_survivor) {
3793   assert(_collectorState == Precleaning ||
3794          _collectorState == AbortablePreclean, &quot;incorrect state&quot;);
3795   ResourceMark rm;
3796   HandleMark   hm;
3797 
3798   // Precleaning is currently not MT but the reference processor
3799   // may be set for MT.  Disable it temporarily here.
3800   ReferenceProcessor* rp = ref_processor();
3801   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(rp, false);
3802 
3803   // Do one pass of scrubbing the discovered reference lists
3804   // to remove any reference objects with strongly-reachable
3805   // referents.
3806   if (clean_refs) {
3807     CMSPrecleanRefsYieldClosure yield_cl(this);
3808     assert(_span_based_discoverer.span().equals(_span), &quot;Spans should be equal&quot;);
3809     CMSKeepAliveClosure keep_alive(this, _span, &amp;_markBitMap,
3810                                    &amp;_markStack, true /* preclean */);
3811     CMSDrainMarkingStackClosure complete_trace(this,
3812                                    _span, &amp;_markBitMap, &amp;_markStack,
3813                                    &amp;keep_alive, true /* preclean */);
3814 
3815     // We don&#39;t want this step to interfere with a young
3816     // collection because we don&#39;t want to take CPU
3817     // or memory bandwidth away from the young GC threads
3818     // (which may be as many as there are CPUs).
3819     // Note that we don&#39;t need to protect ourselves from
3820     // interference with mutators because they can&#39;t
3821     // manipulate the discovered reference lists nor affect
3822     // the computed reachability of the referents, the
3823     // only properties manipulated by the precleaning
3824     // of these reference lists.
3825     stopTimer();
3826     CMSTokenSyncWithLocks x(true /* is cms thread */,
3827                             bitMapLock());
3828     startTimer();
3829     sample_eden();
3830 
3831     // The following will yield to allow foreground
3832     // collection to proceed promptly. XXX YSR:
3833     // The code in this method may need further
3834     // tweaking for better performance and some restructuring
3835     // for cleaner interfaces.
3836     GCTimer *gc_timer = NULL; // Currently not tracing concurrent phases
3837     rp-&gt;preclean_discovered_references(
3838           rp-&gt;is_alive_non_header(), &amp;keep_alive, &amp;complete_trace, &amp;yield_cl,
3839           gc_timer);
3840   }
3841 
3842   if (clean_survivor) {  // preclean the active survivor space(s)
3843     PushAndMarkClosure pam_cl(this, _span, ref_processor(),
3844                              &amp;_markBitMap, &amp;_modUnionTable,
3845                              &amp;_markStack, true /* precleaning phase */);
3846     stopTimer();
3847     CMSTokenSyncWithLocks ts(true /* is cms thread */,
3848                              bitMapLock());
3849     startTimer();
3850     unsigned int before_count =
3851       CMSHeap::heap()-&gt;total_collections();
3852     SurvivorSpacePrecleanClosure
3853       sss_cl(this, _span, &amp;_markBitMap, &amp;_markStack,
3854              &amp;pam_cl, before_count, CMSYield);
3855     _young_gen-&gt;from()-&gt;object_iterate_careful(&amp;sss_cl);
3856     _young_gen-&gt;to()-&gt;object_iterate_careful(&amp;sss_cl);
3857   }
3858   MarkRefsIntoAndScanClosure
3859     mrias_cl(_span, ref_processor(), &amp;_markBitMap, &amp;_modUnionTable,
3860              &amp;_markStack, this, CMSYield,
3861              true /* precleaning phase */);
3862   // CAUTION: The following closure has persistent state that may need to
3863   // be reset upon a decrease in the sequence of addresses it
3864   // processes.
3865   ScanMarkedObjectsAgainCarefullyClosure
3866     smoac_cl(this, _span,
3867       &amp;_markBitMap, &amp;_markStack, &amp;mrias_cl, CMSYield);
3868 
3869   // Preclean dirty cards in ModUnionTable and CardTable using
3870   // appropriate convergence criterion;
3871   // repeat CMSPrecleanIter times unless we find that
3872   // we are losing.
3873   assert(CMSPrecleanIter &lt; 10, &quot;CMSPrecleanIter is too large&quot;);
3874   assert(CMSPrecleanNumerator &lt; CMSPrecleanDenominator,
3875          &quot;Bad convergence multiplier&quot;);
3876   assert(CMSPrecleanThreshold &gt;= 100,
3877          &quot;Unreasonably low CMSPrecleanThreshold&quot;);
3878 
3879   size_t numIter, cumNumCards, lastNumCards, curNumCards;
3880   for (numIter = 0, cumNumCards = lastNumCards = curNumCards = 0;
3881        numIter &lt; CMSPrecleanIter;
3882        numIter++, lastNumCards = curNumCards, cumNumCards += curNumCards) {
3883     curNumCards  = preclean_mod_union_table(_cmsGen, &amp;smoac_cl);
3884     log_trace(gc)(&quot; (modUnionTable: &quot; SIZE_FORMAT &quot; cards)&quot;, curNumCards);
3885     // Either there are very few dirty cards, so re-mark
3886     // pause will be small anyway, or our pre-cleaning isn&#39;t
3887     // that much faster than the rate at which cards are being
3888     // dirtied, so we might as well stop and re-mark since
3889     // precleaning won&#39;t improve our re-mark time by much.
3890     if (curNumCards &lt;= CMSPrecleanThreshold ||
3891         (numIter &gt; 0 &amp;&amp;
3892          (curNumCards * CMSPrecleanDenominator &gt;
3893          lastNumCards * CMSPrecleanNumerator))) {
3894       numIter++;
3895       cumNumCards += curNumCards;
3896       break;
3897     }
3898   }
3899 
3900   preclean_cld(&amp;mrias_cl, _cmsGen-&gt;freelistLock());
3901 
3902   curNumCards = preclean_card_table(_cmsGen, &amp;smoac_cl);
3903   cumNumCards += curNumCards;
3904   log_trace(gc)(&quot; (cardTable: &quot; SIZE_FORMAT &quot; cards, re-scanned &quot; SIZE_FORMAT &quot; cards, &quot; SIZE_FORMAT &quot; iterations)&quot;,
3905                              curNumCards, cumNumCards, numIter);
3906   return cumNumCards;   // as a measure of useful work done
3907 }
3908 
3909 // PRECLEANING NOTES:
3910 // Precleaning involves:
3911 // . reading the bits of the modUnionTable and clearing the set bits.
3912 // . For the cards corresponding to the set bits, we scan the
3913 //   objects on those cards. This means we need the free_list_lock
3914 //   so that we can safely iterate over the CMS space when scanning
3915 //   for oops.
3916 // . When we scan the objects, we&#39;ll be both reading and setting
3917 //   marks in the marking bit map, so we&#39;ll need the marking bit map.
3918 // . For protecting _collector_state transitions, we take the CGC_lock.
3919 //   Note that any races in the reading of of card table entries by the
3920 //   CMS thread on the one hand and the clearing of those entries by the
3921 //   VM thread or the setting of those entries by the mutator threads on the
3922 //   other are quite benign. However, for efficiency it makes sense to keep
3923 //   the VM thread from racing with the CMS thread while the latter is
3924 //   dirty card info to the modUnionTable. We therefore also use the
3925 //   CGC_lock to protect the reading of the card table and the mod union
3926 //   table by the CM thread.
3927 // . We run concurrently with mutator updates, so scanning
3928 //   needs to be done carefully  -- we should not try to scan
3929 //   potentially uninitialized objects.
3930 //
3931 // Locking strategy: While holding the CGC_lock, we scan over and
3932 // reset a maximal dirty range of the mod union / card tables, then lock
3933 // the free_list_lock and bitmap lock to do a full marking, then
3934 // release these locks; and repeat the cycle. This allows for a
3935 // certain amount of fairness in the sharing of these locks between
3936 // the CMS collector on the one hand, and the VM thread and the
3937 // mutators on the other.
3938 
3939 // NOTE: preclean_mod_union_table() and preclean_card_table()
3940 // further below are largely identical; if you need to modify
3941 // one of these methods, please check the other method too.
3942 
3943 size_t CMSCollector::preclean_mod_union_table(
3944   ConcurrentMarkSweepGeneration* old_gen,
3945   ScanMarkedObjectsAgainCarefullyClosure* cl) {
3946   verify_work_stacks_empty();
3947   verify_overflow_empty();
3948 
3949   // strategy: starting with the first card, accumulate contiguous
3950   // ranges of dirty cards; clear these cards, then scan the region
3951   // covered by these cards.
3952 
3953   // Since all of the MUT is committed ahead, we can just use
3954   // that, in case the generations expand while we are precleaning.
3955   // It might also be fine to just use the committed part of the
3956   // generation, but we might potentially miss cards when the
3957   // generation is rapidly expanding while we are in the midst
3958   // of precleaning.
3959   HeapWord* startAddr = old_gen-&gt;reserved().start();
3960   HeapWord* endAddr   = old_gen-&gt;reserved().end();
3961 
3962   cl-&gt;setFreelistLock(old_gen-&gt;freelistLock());   // needed for yielding
3963 
3964   size_t numDirtyCards, cumNumDirtyCards;
3965   HeapWord *nextAddr, *lastAddr;
3966   for (cumNumDirtyCards = numDirtyCards = 0,
3967        nextAddr = lastAddr = startAddr;
3968        nextAddr &lt; endAddr;
3969        nextAddr = lastAddr, cumNumDirtyCards += numDirtyCards) {
3970 
3971     ResourceMark rm;
3972     HandleMark   hm;
3973 
3974     MemRegion dirtyRegion;
3975     {
3976       stopTimer();
3977       // Potential yield point
3978       CMSTokenSync ts(true);
3979       startTimer();
3980       sample_eden();
3981       // Get dirty region starting at nextOffset (inclusive),
3982       // simultaneously clearing it.
3983       dirtyRegion =
3984         _modUnionTable.getAndClearMarkedRegion(nextAddr, endAddr);
3985       assert(dirtyRegion.start() &gt;= nextAddr,
3986              &quot;returned region inconsistent?&quot;);
3987     }
3988     // Remember where the next search should begin.
3989     // The returned region (if non-empty) is a right open interval,
3990     // so lastOffset is obtained from the right end of that
3991     // interval.
3992     lastAddr = dirtyRegion.end();
3993     // Should do something more transparent and less hacky XXX
3994     numDirtyCards =
3995       _modUnionTable.heapWordDiffToOffsetDiff(dirtyRegion.word_size());
3996 
3997     // We&#39;ll scan the cards in the dirty region (with periodic
3998     // yields for foreground GC as needed).
3999     if (!dirtyRegion.is_empty()) {
4000       assert(numDirtyCards &gt; 0, &quot;consistency check&quot;);
4001       HeapWord* stop_point = NULL;
4002       stopTimer();
4003       // Potential yield point
4004       CMSTokenSyncWithLocks ts(true, old_gen-&gt;freelistLock(),
4005                                bitMapLock());
4006       startTimer();
4007       {
4008         verify_work_stacks_empty();
4009         verify_overflow_empty();
4010         sample_eden();
4011         stop_point =
4012           old_gen-&gt;cmsSpace()-&gt;object_iterate_careful_m(dirtyRegion, cl);
4013       }
4014       if (stop_point != NULL) {
4015         // The careful iteration stopped early either because it found an
4016         // uninitialized object, or because we were in the midst of an
4017         // &quot;abortable preclean&quot;, which should now be aborted. Redirty
4018         // the bits corresponding to the partially-scanned or unscanned
4019         // cards. We&#39;ll either restart at the next block boundary or
4020         // abort the preclean.
4021         assert((_collectorState == AbortablePreclean &amp;&amp; should_abort_preclean()),
4022                &quot;Should only be AbortablePreclean.&quot;);
4023         _modUnionTable.mark_range(MemRegion(stop_point, dirtyRegion.end()));
4024         if (should_abort_preclean()) {
4025           break; // out of preclean loop
4026         } else {
4027           // Compute the next address at which preclean should pick up;
4028           // might need bitMapLock in order to read P-bits.
4029           lastAddr = next_card_start_after_block(stop_point);
4030         }
4031       }
4032     } else {
4033       assert(lastAddr == endAddr, &quot;consistency check&quot;);
4034       assert(numDirtyCards == 0, &quot;consistency check&quot;);
4035       break;
4036     }
4037   }
4038   verify_work_stacks_empty();
4039   verify_overflow_empty();
4040   return cumNumDirtyCards;
4041 }
4042 
4043 // NOTE: preclean_mod_union_table() above and preclean_card_table()
4044 // below are largely identical; if you need to modify
4045 // one of these methods, please check the other method too.
4046 
4047 size_t CMSCollector::preclean_card_table(ConcurrentMarkSweepGeneration* old_gen,
4048   ScanMarkedObjectsAgainCarefullyClosure* cl) {
4049   // strategy: it&#39;s similar to precleamModUnionTable above, in that
4050   // we accumulate contiguous ranges of dirty cards, mark these cards
4051   // precleaned, then scan the region covered by these cards.
4052   HeapWord* endAddr   = (HeapWord*)(old_gen-&gt;_virtual_space.high());
4053   HeapWord* startAddr = (HeapWord*)(old_gen-&gt;_virtual_space.low());
4054 
4055   cl-&gt;setFreelistLock(old_gen-&gt;freelistLock());   // needed for yielding
4056 
4057   size_t numDirtyCards, cumNumDirtyCards;
4058   HeapWord *lastAddr, *nextAddr;
4059 
4060   for (cumNumDirtyCards = numDirtyCards = 0,
4061        nextAddr = lastAddr = startAddr;
4062        nextAddr &lt; endAddr;
4063        nextAddr = lastAddr, cumNumDirtyCards += numDirtyCards) {
4064 
4065     ResourceMark rm;
4066     HandleMark   hm;
4067 
4068     MemRegion dirtyRegion;
4069     {
4070       // See comments in &quot;Precleaning notes&quot; above on why we
4071       // do this locking. XXX Could the locking overheads be
4072       // too high when dirty cards are sparse? [I don&#39;t think so.]
4073       stopTimer();
4074       CMSTokenSync x(true); // is cms thread
4075       startTimer();
4076       sample_eden();
4077       // Get and clear dirty region from card table
4078       dirtyRegion = _ct-&gt;dirty_card_range_after_reset(MemRegion(nextAddr, endAddr),
4079                                                       true,
4080                                                       CardTable::precleaned_card_val());
4081 
4082       assert(dirtyRegion.start() &gt;= nextAddr,
4083              &quot;returned region inconsistent?&quot;);
4084     }
4085     lastAddr = dirtyRegion.end();
4086     numDirtyCards =
4087       dirtyRegion.word_size()/CardTable::card_size_in_words;
4088 
4089     if (!dirtyRegion.is_empty()) {
4090       stopTimer();
4091       CMSTokenSyncWithLocks ts(true, old_gen-&gt;freelistLock(), bitMapLock());
4092       startTimer();
4093       sample_eden();
4094       verify_work_stacks_empty();
4095       verify_overflow_empty();
4096       HeapWord* stop_point =
4097         old_gen-&gt;cmsSpace()-&gt;object_iterate_careful_m(dirtyRegion, cl);
4098       if (stop_point != NULL) {
4099         assert((_collectorState == AbortablePreclean &amp;&amp; should_abort_preclean()),
4100                &quot;Should only be AbortablePreclean.&quot;);
4101         _ct-&gt;invalidate(MemRegion(stop_point, dirtyRegion.end()));
4102         if (should_abort_preclean()) {
4103           break; // out of preclean loop
4104         } else {
4105           // Compute the next address at which preclean should pick up.
4106           lastAddr = next_card_start_after_block(stop_point);
4107         }
4108       }
4109     } else {
4110       break;
4111     }
4112   }
4113   verify_work_stacks_empty();
4114   verify_overflow_empty();
4115   return cumNumDirtyCards;
4116 }
4117 
4118 class PrecleanCLDClosure : public CLDClosure {
4119   MetadataVisitingOopsInGenClosure* _cm_closure;
4120  public:
4121   PrecleanCLDClosure(MetadataVisitingOopsInGenClosure* oop_closure) : _cm_closure(oop_closure) {}
4122   void do_cld(ClassLoaderData* cld) {
4123     if (cld-&gt;has_accumulated_modified_oops()) {
4124       cld-&gt;clear_accumulated_modified_oops();
4125 
4126       _cm_closure-&gt;do_cld(cld);
4127     }
4128   }
4129 };
4130 
4131 // The freelist lock is needed to prevent asserts, is it really needed?
4132 void CMSCollector::preclean_cld(MarkRefsIntoAndScanClosure* cl, Mutex* freelistLock) {
4133   // Needed to walk CLDG
4134   MutexLocker ml(ClassLoaderDataGraph_lock);
4135 
4136   cl-&gt;set_freelistLock(freelistLock);
4137 
4138   CMSTokenSyncWithLocks ts(true, freelistLock, bitMapLock());
4139 
4140   // SSS: Add equivalent to ScanMarkedObjectsAgainCarefullyClosure::do_yield_check and should_abort_preclean?
4141   // SSS: We should probably check if precleaning should be aborted, at suitable intervals?
4142   PrecleanCLDClosure preclean_closure(cl);
4143   ClassLoaderDataGraph::cld_do(&amp;preclean_closure);
4144 
4145   verify_work_stacks_empty();
4146   verify_overflow_empty();
4147 }
4148 
4149 void CMSCollector::checkpointRootsFinal() {
4150   assert(_collectorState == FinalMarking, &quot;incorrect state transition?&quot;);
4151   check_correct_thread_executing();
4152   // world is stopped at this checkpoint
4153   assert(SafepointSynchronize::is_at_safepoint(),
4154          &quot;world should be stopped&quot;);
4155   TraceCMSMemoryManagerStats tms(_collectorState, CMSHeap::heap()-&gt;gc_cause());
4156 
4157   verify_work_stacks_empty();
4158   verify_overflow_empty();
4159 
4160   log_debug(gc)(&quot;YG occupancy: &quot; SIZE_FORMAT &quot; K (&quot; SIZE_FORMAT &quot; K)&quot;,
4161                 _young_gen-&gt;used() / K, _young_gen-&gt;capacity() / K);
4162   {
4163     if (CMSScavengeBeforeRemark) {
4164       CMSHeap* heap = CMSHeap::heap();
4165       // Temporarily set flag to false, GCH-&gt;do_collection will
4166       // expect it to be false and set to true
4167       FlagSetting fl(heap-&gt;_is_gc_active, false);
4168 
4169       heap-&gt;do_collection(true,                      // full (i.e. force, see below)
4170                           false,                     // !clear_all_soft_refs
4171                           0,                         // size
4172                           false,                     // is_tlab
4173                           GenCollectedHeap::YoungGen // type
4174         );
4175     }
4176     FreelistLocker x(this);
4177     MutexLockerEx y(bitMapLock(),
4178                     Mutex::_no_safepoint_check_flag);
4179     checkpointRootsFinalWork();
4180   }
4181   verify_work_stacks_empty();
4182   verify_overflow_empty();
4183 }
4184 
4185 void CMSCollector::checkpointRootsFinalWork() {
4186   GCTraceTime(Trace, gc, phases) tm(&quot;checkpointRootsFinalWork&quot;, _gc_timer_cm);
4187 
4188   assert(haveFreelistLocks(), &quot;must have free list locks&quot;);
4189   assert_lock_strong(bitMapLock());
4190 
4191   ResourceMark rm;
4192   HandleMark   hm;
4193 
4194   CMSHeap* heap = CMSHeap::heap();
4195 
4196   assert(haveFreelistLocks(), &quot;must have free list locks&quot;);
4197   assert_lock_strong(bitMapLock());
4198 
4199   // We might assume that we need not fill TLAB&#39;s when
4200   // CMSScavengeBeforeRemark is set, because we may have just done
4201   // a scavenge which would have filled all TLAB&#39;s -- and besides
4202   // Eden would be empty. This however may not always be the case --
4203   // for instance although we asked for a scavenge, it may not have
4204   // happened because of a JNI critical section. We probably need
4205   // a policy for deciding whether we can in that case wait until
4206   // the critical section releases and then do the remark following
4207   // the scavenge, and skip it here. In the absence of that policy,
4208   // or of an indication of whether the scavenge did indeed occur,
4209   // we cannot rely on TLAB&#39;s having been filled and must do
4210   // so here just in case a scavenge did not happen.
4211   heap-&gt;ensure_parsability(false);  // fill TLAB&#39;s, but no need to retire them
4212   // Update the saved marks which may affect the root scans.
4213   heap-&gt;save_marks();
4214 
4215   print_eden_and_survivor_chunk_arrays();
4216 
4217   {
4218 #if COMPILER2_OR_JVMCI
4219     DerivedPointerTableDeactivate dpt_deact;
4220 #endif
4221 
4222     // Note on the role of the mod union table:
4223     // Since the marker in &quot;markFromRoots&quot; marks concurrently with
4224     // mutators, it is possible for some reachable objects not to have been
4225     // scanned. For instance, an only reference to an object A was
4226     // placed in object B after the marker scanned B. Unless B is rescanned,
4227     // A would be collected. Such updates to references in marked objects
4228     // are detected via the mod union table which is the set of all cards
4229     // dirtied since the first checkpoint in this GC cycle and prior to
4230     // the most recent young generation GC, minus those cleaned up by the
4231     // concurrent precleaning.
4232     if (CMSParallelRemarkEnabled) {
4233       GCTraceTime(Debug, gc, phases) t(&quot;Rescan (parallel)&quot;, _gc_timer_cm);
4234       do_remark_parallel();
4235     } else {
4236       GCTraceTime(Debug, gc, phases) t(&quot;Rescan (non-parallel)&quot;, _gc_timer_cm);
4237       do_remark_non_parallel();
4238     }
4239   }
4240   verify_work_stacks_empty();
4241   verify_overflow_empty();
4242 
4243   {
4244     GCTraceTime(Trace, gc, phases) ts(&quot;refProcessingWork&quot;, _gc_timer_cm);
4245     refProcessingWork();
4246   }
4247   verify_work_stacks_empty();
4248   verify_overflow_empty();
4249 
4250   if (should_unload_classes()) {
4251     heap-&gt;prune_nmethods();
4252   }
4253   JvmtiExport::gc_epilogue();
4254 
4255   // If we encountered any (marking stack / work queue) overflow
4256   // events during the current CMS cycle, take appropriate
4257   // remedial measures, where possible, so as to try and avoid
4258   // recurrence of that condition.
4259   assert(_markStack.isEmpty(), &quot;No grey objects&quot;);
4260   size_t ser_ovflw = _ser_pmc_remark_ovflw + _ser_pmc_preclean_ovflw +
4261                      _ser_kac_ovflw        + _ser_kac_preclean_ovflw;
4262   if (ser_ovflw &gt; 0) {
4263     log_trace(gc)(&quot;Marking stack overflow (benign) (pmc_pc=&quot; SIZE_FORMAT &quot;, pmc_rm=&quot; SIZE_FORMAT &quot;, kac=&quot; SIZE_FORMAT &quot;, kac_preclean=&quot; SIZE_FORMAT &quot;)&quot;,
4264                          _ser_pmc_preclean_ovflw, _ser_pmc_remark_ovflw, _ser_kac_ovflw, _ser_kac_preclean_ovflw);
4265     _markStack.expand();
4266     _ser_pmc_remark_ovflw = 0;
4267     _ser_pmc_preclean_ovflw = 0;
4268     _ser_kac_preclean_ovflw = 0;
4269     _ser_kac_ovflw = 0;
4270   }
4271   if (_par_pmc_remark_ovflw &gt; 0 || _par_kac_ovflw &gt; 0) {
4272      log_trace(gc)(&quot;Work queue overflow (benign) (pmc_rm=&quot; SIZE_FORMAT &quot;, kac=&quot; SIZE_FORMAT &quot;)&quot;,
4273                           _par_pmc_remark_ovflw, _par_kac_ovflw);
4274      _par_pmc_remark_ovflw = 0;
4275     _par_kac_ovflw = 0;
4276   }
4277    if (_markStack._hit_limit &gt; 0) {
4278      log_trace(gc)(&quot; (benign) Hit max stack size limit (&quot; SIZE_FORMAT &quot;)&quot;,
4279                           _markStack._hit_limit);
4280    }
4281    if (_markStack._failed_double &gt; 0) {
4282      log_trace(gc)(&quot; (benign) Failed stack doubling (&quot; SIZE_FORMAT &quot;), current capacity &quot; SIZE_FORMAT,
4283                           _markStack._failed_double, _markStack.capacity());
4284    }
4285   _markStack._hit_limit = 0;
4286   _markStack._failed_double = 0;
4287 
4288   if ((VerifyAfterGC || VerifyDuringGC) &amp;&amp;
4289       CMSHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {
4290     verify_after_remark();
4291   }
4292 
4293   _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;_is_alive_closure);
4294 
4295   // Change under the freelistLocks.
4296   _collectorState = Sweeping;
4297   // Call isAllClear() under bitMapLock
4298   assert(_modUnionTable.isAllClear(),
4299       &quot;Should be clear by end of the final marking&quot;);
4300   assert(_ct-&gt;cld_rem_set()-&gt;mod_union_is_clear(),
4301       &quot;Should be clear by end of the final marking&quot;);
4302 }
4303 
4304 void CMSParInitialMarkTask::work(uint worker_id) {
4305   elapsedTimer _timer;
4306   ResourceMark rm;
4307   HandleMark   hm;
4308 
4309   // ---------- scan from roots --------------
4310   _timer.start();
4311   CMSHeap* heap = CMSHeap::heap();
4312   ParMarkRefsIntoClosure par_mri_cl(_collector-&gt;_span, &amp;(_collector-&gt;_markBitMap));
4313 
4314   // ---------- young gen roots --------------
4315   {
4316     work_on_young_gen_roots(&amp;par_mri_cl);
4317     _timer.stop();
4318     log_trace(gc, task)(&quot;Finished young gen initial mark scan work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4319   }
4320 
4321   // ---------- remaining roots --------------
4322   _timer.reset();
4323   _timer.start();
4324 
4325   CLDToOopClosure cld_closure(&amp;par_mri_cl, ClassLoaderData::_claim_strong);
4326 
4327   heap-&gt;cms_process_roots(_strong_roots_scope,
4328                           false,     // yg was scanned above
4329                           GenCollectedHeap::ScanningOption(_collector-&gt;CMSCollector::roots_scanning_options()),
4330                           _collector-&gt;should_unload_classes(),
4331                           &amp;par_mri_cl,
4332                           &amp;cld_closure);
4333 
4334   assert(_collector-&gt;should_unload_classes()
4335          || (_collector-&gt;CMSCollector::roots_scanning_options() &amp; GenCollectedHeap::SO_AllCodeCache),
4336          &quot;if we didn&#39;t scan the code cache, we have to be ready to drop nmethods with expired weak oops&quot;);
4337   _timer.stop();
4338   log_trace(gc, task)(&quot;Finished remaining root initial mark scan work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4339 }
4340 
4341 // Parallel remark task
4342 class CMSParRemarkTask: public CMSParMarkTask {
4343   CompactibleFreeListSpace* _cms_space;
4344 
4345   // The per-thread work queues, available here for stealing.
4346   OopTaskQueueSet*       _task_queues;
4347   TaskTerminator         _term;
4348   StrongRootsScope*      _strong_roots_scope;
4349 
4350  public:
4351   // A value of 0 passed to n_workers will cause the number of
4352   // workers to be taken from the active workers in the work gang.
4353   CMSParRemarkTask(CMSCollector* collector,
4354                    CompactibleFreeListSpace* cms_space,
4355                    uint n_workers, WorkGang* workers,
4356                    OopTaskQueueSet* task_queues,
4357                    StrongRootsScope* strong_roots_scope):
4358     CMSParMarkTask(&quot;Rescan roots and grey objects in parallel&quot;,
4359                    collector, n_workers),
4360     _cms_space(cms_space),
4361     _task_queues(task_queues),
4362     _term(n_workers, task_queues),
4363     _strong_roots_scope(strong_roots_scope) { }
4364 
4365   OopTaskQueueSet* task_queues() { return _task_queues; }
4366 
4367   OopTaskQueue* work_queue(int i) { return task_queues()-&gt;queue(i); }
4368 
4369   ParallelTaskTerminator* terminator() { return _term.terminator(); }
4370   uint n_workers() { return _n_workers; }
4371 
4372   void work(uint worker_id);
4373 
4374  private:
4375   // ... of  dirty cards in old space
4376   void do_dirty_card_rescan_tasks(CompactibleFreeListSpace* sp, int i,
4377                                   ParMarkRefsIntoAndScanClosure* cl);
4378 
4379   // ... work stealing for the above
4380   void do_work_steal(int i, ParMarkRefsIntoAndScanClosure* cl);
4381 };
4382 
4383 class RemarkCLDClosure : public CLDClosure {
4384   CLDToOopClosure _cm_closure;
4385  public:
4386   RemarkCLDClosure(OopClosure* oop_closure) : _cm_closure(oop_closure, ClassLoaderData::_claim_strong) {}
4387   void do_cld(ClassLoaderData* cld) {
4388     // Check if we have modified any oops in the CLD during the concurrent marking.
4389     if (cld-&gt;has_accumulated_modified_oops()) {
4390       cld-&gt;clear_accumulated_modified_oops();
4391 
4392       // We could have transfered the current modified marks to the accumulated marks,
4393       // like we do with the Card Table to Mod Union Table. But it&#39;s not really necessary.
4394     } else if (cld-&gt;has_modified_oops()) {
4395       // Don&#39;t clear anything, this info is needed by the next young collection.
4396     } else {
4397       // No modified oops in the ClassLoaderData.
4398       return;
4399     }
4400 
4401     // The klass has modified fields, need to scan the klass.
4402     _cm_closure.do_cld(cld);
4403   }
4404 };
4405 
4406 void CMSParMarkTask::work_on_young_gen_roots(OopsInGenClosure* cl) {
4407   ParNewGeneration* young_gen = _collector-&gt;_young_gen;
4408   ContiguousSpace* eden_space = young_gen-&gt;eden();
4409   ContiguousSpace* from_space = young_gen-&gt;from();
4410   ContiguousSpace* to_space   = young_gen-&gt;to();
4411 
4412   HeapWord** eca = _collector-&gt;_eden_chunk_array;
4413   size_t     ect = _collector-&gt;_eden_chunk_index;
4414   HeapWord** sca = _collector-&gt;_survivor_chunk_array;
4415   size_t     sct = _collector-&gt;_survivor_chunk_index;
4416 
4417   assert(ect &lt;= _collector-&gt;_eden_chunk_capacity, &quot;out of bounds&quot;);
4418   assert(sct &lt;= _collector-&gt;_survivor_chunk_capacity, &quot;out of bounds&quot;);
4419 
4420   do_young_space_rescan(cl, to_space, NULL, 0);
4421   do_young_space_rescan(cl, from_space, sca, sct);
4422   do_young_space_rescan(cl, eden_space, eca, ect);
4423 }
4424 
4425 // work_queue(i) is passed to the closure
4426 // ParMarkRefsIntoAndScanClosure.  The &quot;i&quot; parameter
4427 // also is passed to do_dirty_card_rescan_tasks() and to
4428 // do_work_steal() to select the i-th task_queue.
4429 
4430 void CMSParRemarkTask::work(uint worker_id) {
4431   elapsedTimer _timer;
4432   ResourceMark rm;
4433   HandleMark   hm;
4434 
4435   // ---------- rescan from roots --------------
4436   _timer.start();
4437   CMSHeap* heap = CMSHeap::heap();
4438   ParMarkRefsIntoAndScanClosure par_mrias_cl(_collector,
4439     _collector-&gt;_span, _collector-&gt;ref_processor(),
4440     &amp;(_collector-&gt;_markBitMap),
4441     work_queue(worker_id));
4442 
4443   // Rescan young gen roots first since these are likely
4444   // coarsely partitioned and may, on that account, constitute
4445   // the critical path; thus, it&#39;s best to start off that
4446   // work first.
4447   // ---------- young gen roots --------------
4448   {
4449     work_on_young_gen_roots(&amp;par_mrias_cl);
4450     _timer.stop();
4451     log_trace(gc, task)(&quot;Finished young gen rescan work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4452   }
4453 
4454   // ---------- remaining roots --------------
4455   _timer.reset();
4456   _timer.start();
4457   heap-&gt;cms_process_roots(_strong_roots_scope,
4458                           false,     // yg was scanned above
4459                           GenCollectedHeap::ScanningOption(_collector-&gt;CMSCollector::roots_scanning_options()),
4460                           _collector-&gt;should_unload_classes(),
4461                           &amp;par_mrias_cl,
4462                           NULL);     // The dirty klasses will be handled below
4463 
4464   assert(_collector-&gt;should_unload_classes()
4465          || (_collector-&gt;CMSCollector::roots_scanning_options() &amp; GenCollectedHeap::SO_AllCodeCache),
4466          &quot;if we didn&#39;t scan the code cache, we have to be ready to drop nmethods with expired weak oops&quot;);
4467   _timer.stop();
4468   log_trace(gc, task)(&quot;Finished remaining root rescan work in %dth thread: %3.3f sec&quot;,  worker_id, _timer.seconds());
4469 
4470   // ---------- unhandled CLD scanning ----------
4471   if (worker_id == 0) { // Single threaded at the moment.
4472     _timer.reset();
4473     _timer.start();
4474 
4475     // Scan all new class loader data objects and new dependencies that were
4476     // introduced during concurrent marking.
4477     ResourceMark rm;
4478     GrowableArray&lt;ClassLoaderData*&gt;* array = ClassLoaderDataGraph::new_clds();
4479     for (int i = 0; i &lt; array-&gt;length(); i++) {
4480       Devirtualizer::do_cld(&amp;par_mrias_cl, array-&gt;at(i));
4481     }
4482 
4483     // We don&#39;t need to keep track of new CLDs anymore.
4484     ClassLoaderDataGraph::remember_new_clds(false);
4485 
4486     _timer.stop();
4487     log_trace(gc, task)(&quot;Finished unhandled CLD scanning work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4488   }
4489 
4490   // We might have added oops to ClassLoaderData::_handles during the
4491   // concurrent marking phase. These oops do not always point to newly allocated objects
4492   // that are guaranteed to be kept alive.  Hence,
4493   // we do have to revisit the _handles block during the remark phase.
4494 
4495   // ---------- dirty CLD scanning ----------
4496   if (worker_id == 0) { // Single threaded at the moment.
4497     _timer.reset();
4498     _timer.start();
4499 
4500     // Scan all classes that was dirtied during the concurrent marking phase.
4501     RemarkCLDClosure remark_closure(&amp;par_mrias_cl);
4502     ClassLoaderDataGraph::cld_do(&amp;remark_closure);
4503 
4504     _timer.stop();
4505     log_trace(gc, task)(&quot;Finished dirty CLD scanning work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4506   }
4507 
4508 
4509   // ---------- rescan dirty cards ------------
4510   _timer.reset();
4511   _timer.start();
4512 
4513   // Do the rescan tasks for each of the two spaces
4514   // (cms_space) in turn.
4515   // &quot;worker_id&quot; is passed to select the task_queue for &quot;worker_id&quot;
4516   do_dirty_card_rescan_tasks(_cms_space, worker_id, &amp;par_mrias_cl);
4517   _timer.stop();
4518   log_trace(gc, task)(&quot;Finished dirty card rescan work in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4519 
4520   // ---------- steal work from other threads ...
4521   // ---------- ... and drain overflow list.
4522   _timer.reset();
4523   _timer.start();
4524   do_work_steal(worker_id, &amp;par_mrias_cl);
4525   _timer.stop();
4526   log_trace(gc, task)(&quot;Finished work stealing in %dth thread: %3.3f sec&quot;, worker_id, _timer.seconds());
4527 }
4528 
4529 void
4530 CMSParMarkTask::do_young_space_rescan(
4531   OopsInGenClosure* cl, ContiguousSpace* space,
4532   HeapWord** chunk_array, size_t chunk_top) {
4533   // Until all tasks completed:
4534   // . claim an unclaimed task
4535   // . compute region boundaries corresponding to task claimed
4536   //   using chunk_array
4537   // . par_oop_iterate(cl) over that region
4538 
4539   ResourceMark rm;
4540   HandleMark   hm;
4541 
4542   SequentialSubTasksDone* pst = space-&gt;par_seq_tasks();
4543 
4544   uint nth_task = 0;
4545   uint n_tasks  = pst-&gt;n_tasks();
4546 
4547   if (n_tasks &gt; 0) {
4548     assert(pst-&gt;valid(), &quot;Uninitialized use?&quot;);
4549     HeapWord *start, *end;
4550     while (pst-&gt;try_claim_task(/* reference */ nth_task)) {
4551       // We claimed task # nth_task; compute its boundaries.
4552       if (chunk_top == 0) {  // no samples were taken
4553         assert(nth_task == 0 &amp;&amp; n_tasks == 1, &quot;Can have only 1 eden task&quot;);
4554         start = space-&gt;bottom();
4555         end   = space-&gt;top();
4556       } else if (nth_task == 0) {
4557         start = space-&gt;bottom();
4558         end   = chunk_array[nth_task];
4559       } else if (nth_task &lt; (uint)chunk_top) {
4560         assert(nth_task &gt;= 1, &quot;Control point invariant&quot;);
4561         start = chunk_array[nth_task - 1];
4562         end   = chunk_array[nth_task];
4563       } else {
4564         assert(nth_task == (uint)chunk_top, &quot;Control point invariant&quot;);
4565         start = chunk_array[chunk_top - 1];
4566         end   = space-&gt;top();
4567       }
4568       MemRegion mr(start, end);
4569       // Verify that mr is in space
4570       assert(mr.is_empty() || space-&gt;used_region().contains(mr),
4571              &quot;Should be in space&quot;);
4572       // Verify that &quot;start&quot; is an object boundary
4573       assert(mr.is_empty() || oopDesc::is_oop(oop(mr.start())),
4574              &quot;Should be an oop&quot;);
4575       space-&gt;par_oop_iterate(mr, cl);
4576     }
4577     pst-&gt;all_tasks_completed();
4578   }
4579 }
4580 
4581 void
4582 CMSParRemarkTask::do_dirty_card_rescan_tasks(
4583   CompactibleFreeListSpace* sp, int i,
4584   ParMarkRefsIntoAndScanClosure* cl) {
4585   // Until all tasks completed:
4586   // . claim an unclaimed task
4587   // . compute region boundaries corresponding to task claimed
4588   // . transfer dirty bits ct-&gt;mut for that region
4589   // . apply rescanclosure to dirty mut bits for that region
4590 
4591   ResourceMark rm;
4592   HandleMark   hm;
4593 
4594   OopTaskQueue* work_q = work_queue(i);
4595   ModUnionClosure modUnionClosure(&amp;(_collector-&gt;_modUnionTable));
4596   // CAUTION! CAUTION! CAUTION! CAUTION! CAUTION! CAUTION! CAUTION!
4597   // CAUTION: This closure has state that persists across calls to
4598   // the work method dirty_range_iterate_clear() in that it has
4599   // embedded in it a (subtype of) UpwardsObjectClosure. The
4600   // use of that state in the embedded UpwardsObjectClosure instance
4601   // assumes that the cards are always iterated (even if in parallel
4602   // by several threads) in monotonically increasing order per each
4603   // thread. This is true of the implementation below which picks
4604   // card ranges (chunks) in monotonically increasing order globally
4605   // and, a-fortiori, in monotonically increasing order per thread
4606   // (the latter order being a subsequence of the former).
4607   // If the work code below is ever reorganized into a more chaotic
4608   // work-partitioning form than the current &quot;sequential tasks&quot;
4609   // paradigm, the use of that persistent state will have to be
4610   // revisited and modified appropriately. See also related
4611   // bug 4756801 work on which should examine this code to make
4612   // sure that the changes there do not run counter to the
4613   // assumptions made here and necessary for correctness and
4614   // efficiency. Note also that this code might yield inefficient
4615   // behavior in the case of very large objects that span one or
4616   // more work chunks. Such objects would potentially be scanned
4617   // several times redundantly. Work on 4756801 should try and
4618   // address that performance anomaly if at all possible. XXX
4619   MemRegion  full_span  = _collector-&gt;_span;
4620   CMSBitMap* bm    = &amp;(_collector-&gt;_markBitMap);     // shared
4621   MarkFromDirtyCardsClosure
4622     greyRescanClosure(_collector, full_span, // entire span of interest
4623                       sp, bm, work_q, cl);
4624 
4625   SequentialSubTasksDone* pst = sp-&gt;conc_par_seq_tasks();
4626   assert(pst-&gt;valid(), &quot;Uninitialized use?&quot;);
4627   uint nth_task = 0;
4628   const int alignment = CardTable::card_size * BitsPerWord;
4629   MemRegion span = sp-&gt;used_region();
4630   HeapWord* start_addr = span.start();
4631   HeapWord* end_addr = align_up(span.end(), alignment);
4632   const size_t chunk_size = sp-&gt;rescan_task_size(); // in HeapWord units
4633   assert(is_aligned(start_addr, alignment), &quot;Check alignment&quot;);
4634   assert(is_aligned(chunk_size, alignment), &quot;Check alignment&quot;);
4635 
4636   while (pst-&gt;try_claim_task(/* reference */ nth_task)) {
4637     // Having claimed the nth_task, compute corresponding mem-region,
4638     // which is a-fortiori aligned correctly (i.e. at a MUT boundary).
4639     // The alignment restriction ensures that we do not need any
4640     // synchronization with other gang-workers while setting or
4641     // clearing bits in thus chunk of the MUT.
4642     MemRegion this_span = MemRegion(start_addr + nth_task*chunk_size,
4643                                     start_addr + (nth_task+1)*chunk_size);
4644     // The last chunk&#39;s end might be way beyond end of the
4645     // used region. In that case pull back appropriately.
4646     if (this_span.end() &gt; end_addr) {
4647       this_span.set_end(end_addr);
4648       assert(!this_span.is_empty(), &quot;Program logic (calculation of n_tasks)&quot;);
4649     }
4650     // Iterate over the dirty cards covering this chunk, marking them
4651     // precleaned, and setting the corresponding bits in the mod union
4652     // table. Since we have been careful to partition at Card and MUT-word
4653     // boundaries no synchronization is needed between parallel threads.
4654     _collector-&gt;_ct-&gt;dirty_card_iterate(this_span,
4655                                                  &amp;modUnionClosure);
4656 
4657     // Having transferred these marks into the modUnionTable,
4658     // rescan the marked objects on the dirty cards in the modUnionTable.
4659     // Even if this is at a synchronous collection, the initial marking
4660     // may have been done during an asynchronous collection so there
4661     // may be dirty bits in the mod-union table.
4662     _collector-&gt;_modUnionTable.dirty_range_iterate_clear(
4663                   this_span, &amp;greyRescanClosure);
4664     _collector-&gt;_modUnionTable.verifyNoOneBitsInRange(
4665                                  this_span.start(),
4666                                  this_span.end());
4667   }
4668   pst-&gt;all_tasks_completed();  // declare that i am done
4669 }
4670 
4671 // . see if we can share work_queues with ParNew? XXX
4672 void
4673 CMSParRemarkTask::do_work_steal(int i, ParMarkRefsIntoAndScanClosure* cl) {
4674   OopTaskQueue* work_q = work_queue(i);
4675   NOT_PRODUCT(int num_steals = 0;)
4676   oop obj_to_scan;
4677   CMSBitMap* bm = &amp;(_collector-&gt;_markBitMap);
4678 
4679   while (true) {
4680     // Completely finish any left over work from (an) earlier round(s)
4681     cl-&gt;trim_queue(0);
4682     size_t num_from_overflow_list = MIN2((size_t)(work_q-&gt;max_elems() - work_q-&gt;size())/4,
4683                                          (size_t)ParGCDesiredObjsFromOverflowList);
4684     // Now check if there&#39;s any work in the overflow list
4685     // Passing ParallelGCThreads as the third parameter, no_of_gc_threads,
4686     // only affects the number of attempts made to get work from the
4687     // overflow list and does not affect the number of workers.  Just
4688     // pass ParallelGCThreads so this behavior is unchanged.
4689     if (_collector-&gt;par_take_from_overflow_list(num_from_overflow_list,
4690                                                 work_q,
4691                                                 ParallelGCThreads)) {
4692       // found something in global overflow list;
4693       // not yet ready to go stealing work from others.
4694       // We&#39;d like to assert(work_q-&gt;size() != 0, ...)
4695       // because we just took work from the overflow list,
4696       // but of course we can&#39;t since all of that could have
4697       // been already stolen from us.
4698       // &quot;He giveth and He taketh away.&quot;
4699       continue;
4700     }
4701     // Verify that we have no work before we resort to stealing
4702     assert(work_q-&gt;size() == 0, &quot;Have work, shouldn&#39;t steal&quot;);
4703     // Try to steal from other queues that have work
4704     if (task_queues()-&gt;steal(i, /* reference */ obj_to_scan)) {
4705       NOT_PRODUCT(num_steals++;)
4706       assert(oopDesc::is_oop(obj_to_scan), &quot;Oops, not an oop!&quot;);
4707       assert(bm-&gt;isMarked((HeapWord*)obj_to_scan), &quot;Stole an unmarked oop?&quot;);
4708       // Do scanning work
4709       obj_to_scan-&gt;oop_iterate(cl);
4710       // Loop around, finish this work, and try to steal some more
4711     } else if (terminator()-&gt;offer_termination()) {
4712         break;  // nirvana from the infinite cycle
4713     }
4714   }
4715   log_develop_trace(gc, task)(&quot;\t(%d: stole %d oops)&quot;, i, num_steals);
4716   assert(work_q-&gt;size() == 0 &amp;&amp; _collector-&gt;overflow_list_is_empty(),
4717          &quot;Else our work is not yet done&quot;);
4718 }
4719 
4720 // Record object boundaries in _eden_chunk_array by sampling the eden
4721 // top in the slow-path eden object allocation code path and record
4722 // the boundaries, if CMSEdenChunksRecordAlways is true. If
4723 // CMSEdenChunksRecordAlways is false, we use the other asynchronous
4724 // sampling in sample_eden() that activates during the part of the
4725 // preclean phase.
4726 void CMSCollector::sample_eden_chunk() {
4727   if (CMSEdenChunksRecordAlways &amp;&amp; _eden_chunk_array != NULL) {
4728     if (_eden_chunk_lock-&gt;try_lock()) {
4729       // Record a sample. This is the critical section. The contents
4730       // of the _eden_chunk_array have to be non-decreasing in the
4731       // address order.
4732       _eden_chunk_array[_eden_chunk_index] = *_top_addr;
4733       assert(_eden_chunk_array[_eden_chunk_index] &lt;= *_end_addr,
4734              &quot;Unexpected state of Eden&quot;);
4735       if (_eden_chunk_index == 0 ||
4736           ((_eden_chunk_array[_eden_chunk_index] &gt; _eden_chunk_array[_eden_chunk_index-1]) &amp;&amp;
4737            (pointer_delta(_eden_chunk_array[_eden_chunk_index],
4738                           _eden_chunk_array[_eden_chunk_index-1]) &gt;= CMSSamplingGrain))) {
4739         _eden_chunk_index++;  // commit sample
4740       }
4741       _eden_chunk_lock-&gt;unlock();
4742     }
4743   }
4744 }
4745 
4746 // Return a thread-local PLAB recording array, as appropriate.
4747 void* CMSCollector::get_data_recorder(int thr_num) {
4748   if (_survivor_plab_array != NULL &amp;&amp;
4749       (CMSPLABRecordAlways ||
4750        (_collectorState &gt; Marking &amp;&amp; _collectorState &lt; FinalMarking))) {
4751     assert(thr_num &lt; (int)ParallelGCThreads, &quot;thr_num is out of bounds&quot;);
4752     ChunkArray* ca = &amp;_survivor_plab_array[thr_num];
4753     ca-&gt;reset();   // clear it so that fresh data is recorded
4754     return (void*) ca;
4755   } else {
4756     return NULL;
4757   }
4758 }
4759 
4760 // Reset all the thread-local PLAB recording arrays
4761 void CMSCollector::reset_survivor_plab_arrays() {
4762   for (uint i = 0; i &lt; ParallelGCThreads; i++) {
4763     _survivor_plab_array[i].reset();
4764   }
4765 }
4766 
4767 // Merge the per-thread plab arrays into the global survivor chunk
4768 // array which will provide the partitioning of the survivor space
4769 // for CMS initial scan and rescan.
4770 void CMSCollector::merge_survivor_plab_arrays(ContiguousSpace* surv,
4771                                               int no_of_gc_threads) {
4772   assert(_survivor_plab_array  != NULL, &quot;Error&quot;);
4773   assert(_survivor_chunk_array != NULL, &quot;Error&quot;);
4774   assert(_collectorState == FinalMarking ||
4775          (CMSParallelInitialMarkEnabled &amp;&amp; _collectorState == InitialMarking), &quot;Error&quot;);
4776   for (int j = 0; j &lt; no_of_gc_threads; j++) {
4777     _cursor[j] = 0;
4778   }
4779   HeapWord* top = surv-&gt;top();
4780   size_t i;
4781   for (i = 0; i &lt; _survivor_chunk_capacity; i++) {  // all sca entries
4782     HeapWord* min_val = top;          // Higher than any PLAB address
4783     uint      min_tid = 0;            // position of min_val this round
4784     for (int j = 0; j &lt; no_of_gc_threads; j++) {
4785       ChunkArray* cur_sca = &amp;_survivor_plab_array[j];
4786       if (_cursor[j] == cur_sca-&gt;end()) {
4787         continue;
4788       }
4789       assert(_cursor[j] &lt; cur_sca-&gt;end(), &quot;ctl pt invariant&quot;);
4790       HeapWord* cur_val = cur_sca-&gt;nth(_cursor[j]);
4791       assert(surv-&gt;used_region().contains(cur_val), &quot;Out of bounds value&quot;);
4792       if (cur_val &lt; min_val) {
4793         min_tid = j;
4794         min_val = cur_val;
4795       } else {
4796         assert(cur_val &lt; top, &quot;All recorded addresses should be less&quot;);
4797       }
4798     }
4799     // At this point min_val and min_tid are respectively
4800     // the least address in _survivor_plab_array[j]-&gt;nth(_cursor[j])
4801     // and the thread (j) that witnesses that address.
4802     // We record this address in the _survivor_chunk_array[i]
4803     // and increment _cursor[min_tid] prior to the next round i.
4804     if (min_val == top) {
4805       break;
4806     }
4807     _survivor_chunk_array[i] = min_val;
4808     _cursor[min_tid]++;
4809   }
4810   // We are all done; record the size of the _survivor_chunk_array
4811   _survivor_chunk_index = i; // exclusive: [0, i)
4812   log_trace(gc, survivor)(&quot; (Survivor:&quot; SIZE_FORMAT &quot;chunks) &quot;, i);
4813   // Verify that we used up all the recorded entries
4814   #ifdef ASSERT
4815     size_t total = 0;
4816     for (int j = 0; j &lt; no_of_gc_threads; j++) {
4817       assert(_cursor[j] == _survivor_plab_array[j].end(), &quot;Ctl pt invariant&quot;);
4818       total += _cursor[j];
4819     }
4820     assert(total == _survivor_chunk_index, &quot;Ctl Pt Invariant&quot;);
4821     // Check that the merged array is in sorted order
4822     if (total &gt; 0) {
4823       for (size_t i = 0; i &lt; total - 1; i++) {
4824         log_develop_trace(gc, survivor)(&quot; (chunk&quot; SIZE_FORMAT &quot;:&quot; INTPTR_FORMAT &quot;) &quot;,
4825                                      i, p2i(_survivor_chunk_array[i]));
4826         assert(_survivor_chunk_array[i] &lt; _survivor_chunk_array[i+1],
4827                &quot;Not sorted&quot;);
4828       }
4829     }
4830   #endif // ASSERT
4831 }
4832 
4833 // Set up the space&#39;s par_seq_tasks structure for work claiming
4834 // for parallel initial scan and rescan of young gen.
4835 // See ParRescanTask where this is currently used.
4836 void
4837 CMSCollector::
4838 initialize_sequential_subtasks_for_young_gen_rescan(int n_threads) {
4839   assert(n_threads &gt; 0, &quot;Unexpected n_threads argument&quot;);
4840 
4841   // Eden space
4842   if (!_young_gen-&gt;eden()-&gt;is_empty()) {
4843     SequentialSubTasksDone* pst = _young_gen-&gt;eden()-&gt;par_seq_tasks();
4844     assert(!pst-&gt;valid(), &quot;Clobbering existing data?&quot;);
4845     // Each valid entry in [0, _eden_chunk_index) represents a task.
4846     size_t n_tasks = _eden_chunk_index + 1;
4847     assert(n_tasks == 1 || _eden_chunk_array != NULL, &quot;Error&quot;);
4848     // Sets the condition for completion of the subtask (how many threads
4849     // need to finish in order to be done).
4850     pst-&gt;set_n_threads(n_threads);
4851     pst-&gt;set_n_tasks((int)n_tasks);
4852   }
4853 
4854   // Merge the survivor plab arrays into _survivor_chunk_array
4855   if (_survivor_plab_array != NULL) {
4856     merge_survivor_plab_arrays(_young_gen-&gt;from(), n_threads);
4857   } else {
4858     assert(_survivor_chunk_index == 0, &quot;Error&quot;);
4859   }
4860 
4861   // To space
4862   {
4863     SequentialSubTasksDone* pst = _young_gen-&gt;to()-&gt;par_seq_tasks();
4864     assert(!pst-&gt;valid(), &quot;Clobbering existing data?&quot;);
4865     // Sets the condition for completion of the subtask (how many threads
4866     // need to finish in order to be done).
4867     pst-&gt;set_n_threads(n_threads);
4868     pst-&gt;set_n_tasks(1);
4869     assert(pst-&gt;valid(), &quot;Error&quot;);
4870   }
4871 
4872   // From space
4873   {
4874     SequentialSubTasksDone* pst = _young_gen-&gt;from()-&gt;par_seq_tasks();
4875     assert(!pst-&gt;valid(), &quot;Clobbering existing data?&quot;);
4876     size_t n_tasks = _survivor_chunk_index + 1;
4877     assert(n_tasks == 1 || _survivor_chunk_array != NULL, &quot;Error&quot;);
4878     // Sets the condition for completion of the subtask (how many threads
4879     // need to finish in order to be done).
4880     pst-&gt;set_n_threads(n_threads);
4881     pst-&gt;set_n_tasks((int)n_tasks);
4882     assert(pst-&gt;valid(), &quot;Error&quot;);
4883   }
4884 }
4885 
4886 // Parallel version of remark
4887 void CMSCollector::do_remark_parallel() {
4888   CMSHeap* heap = CMSHeap::heap();
4889   WorkGang* workers = heap-&gt;workers();
4890   assert(workers != NULL, &quot;Need parallel worker threads.&quot;);
4891   // Choose to use the number of GC workers most recently set
4892   // into &quot;active_workers&quot;.
4893   uint n_workers = workers-&gt;active_workers();
4894 
4895   CompactibleFreeListSpace* cms_space  = _cmsGen-&gt;cmsSpace();
4896 
4897   StrongRootsScope srs(n_workers);
4898 
4899   CMSParRemarkTask tsk(this, cms_space, n_workers, workers, task_queues(), &amp;srs);
4900 
4901   // We won&#39;t be iterating over the cards in the card table updating
4902   // the younger_gen cards, so we shouldn&#39;t call the following else
4903   // the verification code as well as subsequent younger_refs_iterate
4904   // code would get confused. XXX
4905   // heap-&gt;rem_set()-&gt;prepare_for_younger_refs_iterate(true); // parallel
4906 
4907   // The young gen rescan work will not be done as part of
4908   // process_roots (which currently doesn&#39;t know how to
4909   // parallelize such a scan), but rather will be broken up into
4910   // a set of parallel tasks (via the sampling that the [abortable]
4911   // preclean phase did of eden, plus the [two] tasks of
4912   // scanning the [two] survivor spaces. Further fine-grain
4913   // parallelization of the scanning of the survivor spaces
4914   // themselves, and of precleaning of the young gen itself
4915   // is deferred to the future.
4916   initialize_sequential_subtasks_for_young_gen_rescan(n_workers);
4917 
4918   // The dirty card rescan work is broken up into a &quot;sequence&quot;
4919   // of parallel tasks (per constituent space) that are dynamically
4920   // claimed by the parallel threads.
4921   cms_space-&gt;initialize_sequential_subtasks_for_rescan(n_workers);
4922 
4923   // It turns out that even when we&#39;re using 1 thread, doing the work in a
4924   // separate thread causes wide variance in run times.  We can&#39;t help this
4925   // in the multi-threaded case, but we special-case n=1 here to get
4926   // repeatable measurements of the 1-thread overhead of the parallel code.
4927   if (n_workers &gt; 1) {
4928     // Make refs discovery MT-safe, if it isn&#39;t already: it may not
4929     // necessarily be so, since it&#39;s possible that we are doing
4930     // ST marking.
4931     ReferenceProcessorMTDiscoveryMutator mt(ref_processor(), true);
4932     workers-&gt;run_task(&amp;tsk);
4933   } else {
4934     ReferenceProcessorMTDiscoveryMutator mt(ref_processor(), false);
4935     tsk.work(0);
4936   }
4937 
4938   // restore, single-threaded for now, any preserved marks
4939   // as a result of work_q overflow
4940   restore_preserved_marks_if_any();
4941 }
4942 
4943 // Non-parallel version of remark
4944 void CMSCollector::do_remark_non_parallel() {
4945   ResourceMark rm;
4946   HandleMark   hm;
4947   CMSHeap* heap = CMSHeap::heap();
4948   ReferenceProcessorMTDiscoveryMutator mt(ref_processor(), false);
4949 
4950   MarkRefsIntoAndScanClosure
4951     mrias_cl(_span, ref_processor(), &amp;_markBitMap, NULL /* not precleaning */,
4952              &amp;_markStack, this,
4953              false /* should_yield */, false /* not precleaning */);
4954   MarkFromDirtyCardsClosure
4955     markFromDirtyCardsClosure(this, _span,
4956                               NULL,  // space is set further below
4957                               &amp;_markBitMap, &amp;_markStack, &amp;mrias_cl);
4958   {
4959     GCTraceTime(Trace, gc, phases) t(&quot;Grey Object Rescan&quot;, _gc_timer_cm);
4960     // Iterate over the dirty cards, setting the corresponding bits in the
4961     // mod union table.
4962     {
4963       ModUnionClosure modUnionClosure(&amp;_modUnionTable);
4964       _ct-&gt;dirty_card_iterate(_cmsGen-&gt;used_region(),
4965                               &amp;modUnionClosure);
4966     }
4967     // Having transferred these marks into the modUnionTable, we just need
4968     // to rescan the marked objects on the dirty cards in the modUnionTable.
4969     // The initial marking may have been done during an asynchronous
4970     // collection so there may be dirty bits in the mod-union table.
4971     const int alignment = CardTable::card_size * BitsPerWord;
4972     {
4973       // ... First handle dirty cards in CMS gen
4974       markFromDirtyCardsClosure.set_space(_cmsGen-&gt;cmsSpace());
4975       MemRegion ur = _cmsGen-&gt;used_region();
4976       HeapWord* lb = ur.start();
4977       HeapWord* ub = align_up(ur.end(), alignment);
4978       MemRegion cms_span(lb, ub);
4979       _modUnionTable.dirty_range_iterate_clear(cms_span,
4980                                                &amp;markFromDirtyCardsClosure);
4981       verify_work_stacks_empty();
4982       log_trace(gc)(&quot; (re-scanned &quot; SIZE_FORMAT &quot; dirty cards in cms gen) &quot;, markFromDirtyCardsClosure.num_dirty_cards());
4983     }
4984   }
4985   if (VerifyDuringGC &amp;&amp;
4986       CMSHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {
4987     HandleMark hm;  // Discard invalid handles created during verification
4988     Universe::verify();
4989   }
4990   {
4991     GCTraceTime(Trace, gc, phases) t(&quot;Root Rescan&quot;, _gc_timer_cm);
4992 
4993     verify_work_stacks_empty();
4994 
4995     heap-&gt;rem_set()-&gt;prepare_for_younger_refs_iterate(false); // Not parallel.
4996     StrongRootsScope srs(1);
4997 
4998     heap-&gt;cms_process_roots(&amp;srs,
4999                             true,  // young gen as roots
5000                             GenCollectedHeap::ScanningOption(roots_scanning_options()),
5001                             should_unload_classes(),
5002                             &amp;mrias_cl,
5003                             NULL); // The dirty klasses will be handled below
5004 
5005     assert(should_unload_classes()
5006            || (roots_scanning_options() &amp; GenCollectedHeap::SO_AllCodeCache),
5007            &quot;if we didn&#39;t scan the code cache, we have to be ready to drop nmethods with expired weak oops&quot;);
5008   }
5009 
5010   {
5011     GCTraceTime(Trace, gc, phases) t(&quot;Visit Unhandled CLDs&quot;, _gc_timer_cm);
5012 
5013     verify_work_stacks_empty();
5014 
5015     // Scan all class loader data objects that might have been introduced
5016     // during concurrent marking.
5017     ResourceMark rm;
5018     GrowableArray&lt;ClassLoaderData*&gt;* array = ClassLoaderDataGraph::new_clds();
5019     for (int i = 0; i &lt; array-&gt;length(); i++) {
5020       Devirtualizer::do_cld(&amp;mrias_cl, array-&gt;at(i));
5021     }
5022 
5023     // We don&#39;t need to keep track of new CLDs anymore.
5024     ClassLoaderDataGraph::remember_new_clds(false);
5025 
5026     verify_work_stacks_empty();
5027   }
5028 
5029   // We might have added oops to ClassLoaderData::_handles during the
5030   // concurrent marking phase. These oops do not point to newly allocated objects
5031   // that are guaranteed to be kept alive.  Hence,
5032   // we do have to revisit the _handles block during the remark phase.
5033   {
5034     GCTraceTime(Trace, gc, phases) t(&quot;Dirty CLD Scan&quot;, _gc_timer_cm);
5035 
5036     verify_work_stacks_empty();
5037 
5038     RemarkCLDClosure remark_closure(&amp;mrias_cl);
5039     ClassLoaderDataGraph::cld_do(&amp;remark_closure);
5040 
5041     verify_work_stacks_empty();
5042   }
5043 
5044   verify_work_stacks_empty();
5045   // Restore evacuated mark words, if any, used for overflow list links
5046   restore_preserved_marks_if_any();
5047 
5048   verify_overflow_empty();
5049 }
5050 
5051 ////////////////////////////////////////////////////////
5052 // Parallel Reference Processing Task Proxy Class
5053 ////////////////////////////////////////////////////////
5054 class AbstractGangTaskWOopQueues : public AbstractGangTask {
5055   OopTaskQueueSet*       _queues;
5056   TaskTerminator         _terminator;
5057  public:
5058   AbstractGangTaskWOopQueues(const char* name, OopTaskQueueSet* queues, uint n_threads) :
5059     AbstractGangTask(name), _queues(queues), _terminator(n_threads, _queues) {}
5060   ParallelTaskTerminator* terminator() { return _terminator.terminator(); }
5061   OopTaskQueueSet* queues() { return _queues; }
5062 };
5063 
5064 class CMSRefProcTaskProxy: public AbstractGangTaskWOopQueues {
5065   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
5066   CMSCollector*          _collector;
5067   CMSBitMap*             _mark_bit_map;
5068   const MemRegion        _span;
5069   ProcessTask&amp;           _task;
5070 
5071 public:
5072   CMSRefProcTaskProxy(ProcessTask&amp;     task,
5073                       CMSCollector*    collector,
5074                       const MemRegion&amp; span,
5075                       CMSBitMap*       mark_bit_map,
5076                       AbstractWorkGang* workers,
5077                       OopTaskQueueSet* task_queues):
5078     AbstractGangTaskWOopQueues(&quot;Process referents by policy in parallel&quot;,
5079       task_queues,
5080       workers-&gt;active_workers()),
5081     _collector(collector),
5082     _mark_bit_map(mark_bit_map),
5083     _span(span),
5084     _task(task)
5085   {
5086     assert(_collector-&gt;_span.equals(_span) &amp;&amp; !_span.is_empty(),
5087            &quot;Inconsistency in _span&quot;);
5088   }
5089 
5090   OopTaskQueueSet* task_queues() { return queues(); }
5091 
5092   OopTaskQueue* work_queue(int i) { return task_queues()-&gt;queue(i); }
5093 
5094   void do_work_steal(int i,
5095                      CMSParDrainMarkingStackClosure* drain,
5096                      CMSParKeepAliveClosure* keep_alive);
5097 
5098   virtual void work(uint worker_id);
5099 };
5100 
5101 void CMSRefProcTaskProxy::work(uint worker_id) {
5102   ResourceMark rm;
5103   HandleMark hm;
5104   assert(_collector-&gt;_span.equals(_span), &quot;Inconsistency in _span&quot;);
5105   CMSParKeepAliveClosure par_keep_alive(_collector, _span,
5106                                         _mark_bit_map,
5107                                         work_queue(worker_id));
5108   CMSParDrainMarkingStackClosure par_drain_stack(_collector, _span,
5109                                                  _mark_bit_map,
5110                                                  work_queue(worker_id));
5111   CMSIsAliveClosure is_alive_closure(_span, _mark_bit_map);
5112   _task.work(worker_id, is_alive_closure, par_keep_alive, par_drain_stack);
5113   if (_task.marks_oops_alive()) {
5114     do_work_steal(worker_id, &amp;par_drain_stack, &amp;par_keep_alive);
5115   }
5116   assert(work_queue(worker_id)-&gt;size() == 0, &quot;work_queue should be empty&quot;);
5117   assert(_collector-&gt;_overflow_list == NULL, &quot;non-empty _overflow_list&quot;);
5118 }
5119 
5120 CMSParKeepAliveClosure::CMSParKeepAliveClosure(CMSCollector* collector,
5121   MemRegion span, CMSBitMap* bit_map, OopTaskQueue* work_queue):
5122    _span(span),
5123    _work_queue(work_queue),
5124    _bit_map(bit_map),
5125    _mark_and_push(collector, span, bit_map, work_queue),
5126    _low_water_mark(MIN2((work_queue-&gt;max_elems()/4),
5127                         ((uint)CMSWorkQueueDrainThreshold * ParallelGCThreads)))
5128 { }
5129 
5130 // . see if we can share work_queues with ParNew? XXX
5131 void CMSRefProcTaskProxy::do_work_steal(int i,
5132   CMSParDrainMarkingStackClosure* drain,
5133   CMSParKeepAliveClosure* keep_alive) {
5134   OopTaskQueue* work_q = work_queue(i);
5135   NOT_PRODUCT(int num_steals = 0;)
5136   oop obj_to_scan;
5137 
5138   while (true) {
5139     // Completely finish any left over work from (an) earlier round(s)
5140     drain-&gt;trim_queue(0);
5141     size_t num_from_overflow_list = MIN2((size_t)(work_q-&gt;max_elems() - work_q-&gt;size())/4,
5142                                          (size_t)ParGCDesiredObjsFromOverflowList);
5143     // Now check if there&#39;s any work in the overflow list
5144     // Passing ParallelGCThreads as the third parameter, no_of_gc_threads,
5145     // only affects the number of attempts made to get work from the
5146     // overflow list and does not affect the number of workers.  Just
5147     // pass ParallelGCThreads so this behavior is unchanged.
5148     if (_collector-&gt;par_take_from_overflow_list(num_from_overflow_list,
5149                                                 work_q,
5150                                                 ParallelGCThreads)) {
5151       // Found something in global overflow list;
5152       // not yet ready to go stealing work from others.
5153       // We&#39;d like to assert(work_q-&gt;size() != 0, ...)
5154       // because we just took work from the overflow list,
5155       // but of course we can&#39;t, since all of that might have
5156       // been already stolen from us.
5157       continue;
5158     }
5159     // Verify that we have no work before we resort to stealing
5160     assert(work_q-&gt;size() == 0, &quot;Have work, shouldn&#39;t steal&quot;);
5161     // Try to steal from other queues that have work
5162     if (task_queues()-&gt;steal(i, /* reference */ obj_to_scan)) {
5163       NOT_PRODUCT(num_steals++;)
5164       assert(oopDesc::is_oop(obj_to_scan), &quot;Oops, not an oop!&quot;);
5165       assert(_mark_bit_map-&gt;isMarked((HeapWord*)obj_to_scan), &quot;Stole an unmarked oop?&quot;);
5166       // Do scanning work
5167       obj_to_scan-&gt;oop_iterate(keep_alive);
5168       // Loop around, finish this work, and try to steal some more
5169     } else if (terminator()-&gt;offer_termination()) {
5170       break;  // nirvana from the infinite cycle
5171     }
5172   }
5173   log_develop_trace(gc, task)(&quot;\t(%d: stole %d oops)&quot;, i, num_steals);
5174 }
5175 
5176 void CMSRefProcTaskExecutor::execute(ProcessTask&amp; task, uint ergo_workers) {
5177   CMSHeap* heap = CMSHeap::heap();
5178   WorkGang* workers = heap-&gt;workers();
5179   assert(workers != NULL, &quot;Need parallel worker threads.&quot;);
5180   assert(workers-&gt;active_workers() == ergo_workers,
5181          &quot;Ergonomically chosen workers (%u) must be equal to active workers (%u)&quot;,
5182          ergo_workers, workers-&gt;active_workers());
5183   CMSRefProcTaskProxy rp_task(task, &amp;_collector,
5184                               _collector.ref_processor_span(),
5185                               _collector.markBitMap(),
5186                               workers, _collector.task_queues());
5187   workers-&gt;run_task(&amp;rp_task, workers-&gt;active_workers());
5188 }
5189 
5190 void CMSCollector::refProcessingWork() {
5191   ResourceMark rm;
5192   HandleMark   hm;
5193 
5194   ReferenceProcessor* rp = ref_processor();
5195   assert(_span_based_discoverer.span().equals(_span), &quot;Spans should be equal&quot;);
5196   assert(!rp-&gt;enqueuing_is_done(), &quot;Enqueuing should not be complete&quot;);
5197   // Process weak references.
5198   rp-&gt;setup_policy(false);
5199   verify_work_stacks_empty();
5200 
5201   ReferenceProcessorPhaseTimes pt(_gc_timer_cm, rp-&gt;max_num_queues());
5202   {
5203     GCTraceTime(Debug, gc, phases) t(&quot;Reference Processing&quot;, _gc_timer_cm);
5204 
5205     // Setup keep_alive and complete closures.
5206     CMSKeepAliveClosure cmsKeepAliveClosure(this, _span, &amp;_markBitMap,
5207                                             &amp;_markStack, false /* !preclean */);
5208     CMSDrainMarkingStackClosure cmsDrainMarkingStackClosure(this,
5209                                   _span, &amp;_markBitMap, &amp;_markStack,
5210                                   &amp;cmsKeepAliveClosure, false /* !preclean */);
5211 
5212     ReferenceProcessorStats stats;
5213     if (rp-&gt;processing_is_mt()) {
5214       // Set the degree of MT here.  If the discovery is done MT, there
5215       // may have been a different number of threads doing the discovery
5216       // and a different number of discovered lists may have Ref objects.
5217       // That is OK as long as the Reference lists are balanced (see
5218       // balance_all_queues() and balance_queues()).
5219       CMSHeap* heap = CMSHeap::heap();
5220       uint active_workers = ParallelGCThreads;
5221       WorkGang* workers = heap-&gt;workers();
5222       if (workers != NULL) {
5223         active_workers = workers-&gt;active_workers();
5224         // The expectation is that active_workers will have already
5225         // been set to a reasonable value.  If it has not been set,
5226         // investigate.
5227         assert(active_workers &gt; 0, &quot;Should have been set during scavenge&quot;);
5228       }
5229       rp-&gt;set_active_mt_degree(active_workers);
5230       CMSRefProcTaskExecutor task_executor(*this);
5231       stats = rp-&gt;process_discovered_references(&amp;_is_alive_closure,
5232                                         &amp;cmsKeepAliveClosure,
5233                                         &amp;cmsDrainMarkingStackClosure,
5234                                         &amp;task_executor,
5235                                         &amp;pt);
5236     } else {
5237       stats = rp-&gt;process_discovered_references(&amp;_is_alive_closure,
5238                                         &amp;cmsKeepAliveClosure,
5239                                         &amp;cmsDrainMarkingStackClosure,
5240                                         NULL,
5241                                         &amp;pt);
5242     }
5243     _gc_tracer_cm-&gt;report_gc_reference_stats(stats);
5244     pt.print_all_references();
5245   }
5246 
5247   // This is the point where the entire marking should have completed.
5248   verify_work_stacks_empty();
5249 
5250   {
5251     GCTraceTime(Debug, gc, phases) t(&quot;Weak Processing&quot;, _gc_timer_cm);
5252     WeakProcessor::weak_oops_do(&amp;_is_alive_closure, &amp;do_nothing_cl);
5253   }
5254 
5255   if (should_unload_classes()) {
5256     {
5257       GCTraceTime(Debug, gc, phases) t(&quot;Class Unloading&quot;, _gc_timer_cm);
5258 
5259       // Unload classes and purge the SystemDictionary.
5260       bool purged_class = SystemDictionary::do_unloading(_gc_timer_cm);
5261 
5262       // Unload nmethods.
5263       CodeCache::do_unloading(&amp;_is_alive_closure, purged_class);
5264 
5265       // Prune dead klasses from subklass/sibling/implementor lists.
5266       Klass::clean_weak_klass_links(purged_class);
5267     }
5268   }
5269 
5270   // Restore any preserved marks as a result of mark stack or
5271   // work queue overflow
5272   restore_preserved_marks_if_any();  // done single-threaded for now
5273 
5274   rp-&gt;set_enqueuing_is_done(true);
5275   rp-&gt;verify_no_references_recorded();
5276 }
5277 
5278 #ifndef PRODUCT
5279 void CMSCollector::check_correct_thread_executing() {
5280   Thread* t = Thread::current();
5281   // Only the VM thread or the CMS thread should be here.
5282   assert(t-&gt;is_ConcurrentGC_thread() || t-&gt;is_VM_thread(),
5283          &quot;Unexpected thread type&quot;);
5284   // If this is the vm thread, the foreground process
5285   // should not be waiting.  Note that _foregroundGCIsActive is
5286   // true while the foreground collector is waiting.
5287   if (_foregroundGCShouldWait) {
5288     // We cannot be the VM thread
5289     assert(t-&gt;is_ConcurrentGC_thread(),
5290            &quot;Should be CMS thread&quot;);
5291   } else {
5292     // We can be the CMS thread only if we are in a stop-world
5293     // phase of CMS collection.
5294     if (t-&gt;is_ConcurrentGC_thread()) {
5295       assert(_collectorState == InitialMarking ||
5296              _collectorState == FinalMarking,
5297              &quot;Should be a stop-world phase&quot;);
5298       // The CMS thread should be holding the CMS_token.
5299       assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
5300              &quot;Potential interference with concurrently &quot;
5301              &quot;executing VM thread&quot;);
5302     }
5303   }
5304 }
5305 #endif
5306 
5307 void CMSCollector::sweep() {
5308   assert(_collectorState == Sweeping, &quot;just checking&quot;);
5309   check_correct_thread_executing();
5310   verify_work_stacks_empty();
5311   verify_overflow_empty();
5312   increment_sweep_count();
5313   TraceCMSMemoryManagerStats tms(_collectorState, CMSHeap::heap()-&gt;gc_cause());
5314 
5315   _inter_sweep_timer.stop();
5316   _inter_sweep_estimate.sample(_inter_sweep_timer.seconds());
5317 
5318   assert(!_intra_sweep_timer.is_active(), &quot;Should not be active&quot;);
5319   _intra_sweep_timer.reset();
5320   _intra_sweep_timer.start();
5321   {
5322     GCTraceCPUTime tcpu;
5323     CMSPhaseAccounting pa(this, &quot;Concurrent Sweep&quot;);
5324     // First sweep the old gen
5325     {
5326       CMSTokenSyncWithLocks ts(true, _cmsGen-&gt;freelistLock(),
5327                                bitMapLock());
5328       sweepWork(_cmsGen);
5329     }
5330 
5331     // Update Universe::_heap_*_at_gc figures.
5332     // We need all the free list locks to make the abstract state
5333     // transition from Sweeping to Resetting. See detailed note
5334     // further below.
5335     {
5336       CMSTokenSyncWithLocks ts(true, _cmsGen-&gt;freelistLock());
5337       // Update heap occupancy information which is used as
5338       // input to soft ref clearing policy at the next gc.
5339       Universe::update_heap_info_at_gc();
5340       _collectorState = Resizing;
5341     }
5342   }
5343   verify_work_stacks_empty();
5344   verify_overflow_empty();
5345 
5346   if (should_unload_classes()) {
5347     // Delay purge to the beginning of the next safepoint.  Metaspace::contains
5348     // requires that the virtual spaces are stable and not deleted.
5349     ClassLoaderDataGraph::set_should_purge(true);
5350   }
5351 
5352   _intra_sweep_timer.stop();
5353   _intra_sweep_estimate.sample(_intra_sweep_timer.seconds());
5354 
5355   _inter_sweep_timer.reset();
5356   _inter_sweep_timer.start();
5357 
5358   // We need to use a monotonically non-decreasing time in ms
5359   // or we will see time-warp warnings and os::javaTimeMillis()
5360   // does not guarantee monotonicity.
5361   jlong now = os::javaTimeNanos() / NANOSECS_PER_MILLISEC;
5362   update_time_of_last_gc(now);
5363 
5364   // NOTE on abstract state transitions:
5365   // Mutators allocate-live and/or mark the mod-union table dirty
5366   // based on the state of the collection.  The former is done in
5367   // the interval [Marking, Sweeping] and the latter in the interval
5368   // [Marking, Sweeping).  Thus the transitions into the Marking state
5369   // and out of the Sweeping state must be synchronously visible
5370   // globally to the mutators.
5371   // The transition into the Marking state happens with the world
5372   // stopped so the mutators will globally see it.  Sweeping is
5373   // done asynchronously by the background collector so the transition
5374   // from the Sweeping state to the Resizing state must be done
5375   // under the freelistLock (as is the check for whether to
5376   // allocate-live and whether to dirty the mod-union table).
5377   assert(_collectorState == Resizing, &quot;Change of collector state to&quot;
5378     &quot; Resizing must be done under the freelistLocks (plural)&quot;);
5379 
5380   // Now that sweeping has been completed, we clear
5381   // the incremental_collection_failed flag,
5382   // thus inviting a younger gen collection to promote into
5383   // this generation. If such a promotion may still fail,
5384   // the flag will be set again when a young collection is
5385   // attempted.
5386   CMSHeap* heap = CMSHeap::heap();
5387   heap-&gt;clear_incremental_collection_failed();  // Worth retrying as fresh space may have been freed up
5388   heap-&gt;update_full_collections_completed(_collection_count_start);
5389 }
5390 
5391 // FIX ME!!! Looks like this belongs in CFLSpace, with
5392 // CMSGen merely delegating to it.
5393 void ConcurrentMarkSweepGeneration::setNearLargestChunk() {
5394   double nearLargestPercent = FLSLargestBlockCoalesceProximity;
5395   HeapWord*  minAddr        = _cmsSpace-&gt;bottom();
5396   HeapWord*  largestAddr    =
5397     (HeapWord*) _cmsSpace-&gt;dictionary()-&gt;find_largest_dict();
5398   if (largestAddr == NULL) {
5399     // The dictionary appears to be empty.  In this case
5400     // try to coalesce at the end of the heap.
5401     largestAddr = _cmsSpace-&gt;end();
5402   }
5403   size_t largestOffset     = pointer_delta(largestAddr, minAddr);
5404   size_t nearLargestOffset =
5405     (size_t)((double)largestOffset * nearLargestPercent) - MinChunkSize;
5406   log_debug(gc, freelist)(&quot;CMS: Large Block: &quot; PTR_FORMAT &quot;; Proximity: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT,
5407                           p2i(largestAddr), p2i(_cmsSpace-&gt;nearLargestChunk()), p2i(minAddr + nearLargestOffset));
5408   _cmsSpace-&gt;set_nearLargestChunk(minAddr + nearLargestOffset);
5409 }
5410 
5411 bool ConcurrentMarkSweepGeneration::isNearLargestChunk(HeapWord* addr) {
5412   return addr &gt;= _cmsSpace-&gt;nearLargestChunk();
5413 }
5414 
5415 FreeChunk* ConcurrentMarkSweepGeneration::find_chunk_at_end() {
5416   return _cmsSpace-&gt;find_chunk_at_end();
5417 }
5418 
5419 void ConcurrentMarkSweepGeneration::update_gc_stats(Generation* current_generation,
5420                                                     bool full) {
5421   // If the young generation has been collected, gather any statistics
5422   // that are of interest at this point.
5423   bool current_is_young = CMSHeap::heap()-&gt;is_young_gen(current_generation);
5424   if (!full &amp;&amp; current_is_young) {
5425     // Gather statistics on the young generation collection.
5426     collector()-&gt;stats().record_gc0_end(used());
5427   }
5428 }
5429 
5430 void CMSCollector::sweepWork(ConcurrentMarkSweepGeneration* old_gen) {
5431   // We iterate over the space(s) underlying this generation,
5432   // checking the mark bit map to see if the bits corresponding
5433   // to specific blocks are marked or not. Blocks that are
5434   // marked are live and are not swept up. All remaining blocks
5435   // are swept up, with coalescing on-the-fly as we sweep up
5436   // contiguous free and/or garbage blocks:
5437   // We need to ensure that the sweeper synchronizes with allocators
5438   // and stop-the-world collectors. In particular, the following
5439   // locks are used:
5440   // . CMS token: if this is held, a stop the world collection cannot occur
5441   // . freelistLock: if this is held no allocation can occur from this
5442   //                 generation by another thread
5443   // . bitMapLock: if this is held, no other thread can access or update
5444   //
5445 
5446   // Note that we need to hold the freelistLock if we use
5447   // block iterate below; else the iterator might go awry if
5448   // a mutator (or promotion) causes block contents to change
5449   // (for instance if the allocator divvies up a block).
5450   // If we hold the free list lock, for all practical purposes
5451   // young generation GC&#39;s can&#39;t occur (they&#39;ll usually need to
5452   // promote), so we might as well prevent all young generation
5453   // GC&#39;s while we do a sweeping step. For the same reason, we might
5454   // as well take the bit map lock for the entire duration
5455 
5456   // check that we hold the requisite locks
5457   assert(have_cms_token(), &quot;Should hold cms token&quot;);
5458   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(), &quot;Should possess CMS token to sweep&quot;);
5459   assert_lock_strong(old_gen-&gt;freelistLock());
5460   assert_lock_strong(bitMapLock());
5461 
5462   assert(!_inter_sweep_timer.is_active(), &quot;Was switched off in an outer context&quot;);
5463   assert(_intra_sweep_timer.is_active(),  &quot;Was switched on  in an outer context&quot;);
5464   old_gen-&gt;cmsSpace()-&gt;beginSweepFLCensus((float)(_inter_sweep_timer.seconds()),
5465                                           _inter_sweep_estimate.padded_average(),
5466                                           _intra_sweep_estimate.padded_average());
5467   old_gen-&gt;setNearLargestChunk();
5468 
5469   {
5470     SweepClosure sweepClosure(this, old_gen, &amp;_markBitMap, CMSYield);
5471     old_gen-&gt;cmsSpace()-&gt;blk_iterate_careful(&amp;sweepClosure);
5472     // We need to free-up/coalesce garbage/blocks from a
5473     // co-terminal free run. This is done in the SweepClosure
5474     // destructor; so, do not remove this scope, else the
5475     // end-of-sweep-census below will be off by a little bit.
5476   }
5477   old_gen-&gt;cmsSpace()-&gt;sweep_completed();
5478   old_gen-&gt;cmsSpace()-&gt;endSweepFLCensus(sweep_count());
5479   if (should_unload_classes()) {                // unloaded classes this cycle,
5480     _concurrent_cycles_since_last_unload = 0;   // ... reset count
5481   } else {                                      // did not unload classes,
5482     _concurrent_cycles_since_last_unload++;     // ... increment count
5483   }
5484 }
5485 
5486 // Reset CMS data structures (for now just the marking bit map)
5487 // preparatory for the next cycle.
5488 void CMSCollector::reset_concurrent() {
5489   CMSTokenSyncWithLocks ts(true, bitMapLock());
5490 
5491   // If the state is not &quot;Resetting&quot;, the foreground  thread
5492   // has done a collection and the resetting.
5493   if (_collectorState != Resetting) {
5494     assert(_collectorState == Idling, &quot;The state should only change&quot;
5495       &quot; because the foreground collector has finished the collection&quot;);
5496     return;
5497   }
5498 
5499   {
5500     // Clear the mark bitmap (no grey objects to start with)
5501     // for the next cycle.
5502     GCTraceCPUTime tcpu;
5503     CMSPhaseAccounting cmspa(this, &quot;Concurrent Reset&quot;);
5504 
5505     HeapWord* curAddr = _markBitMap.startWord();
5506     while (curAddr &lt; _markBitMap.endWord()) {
5507       size_t remaining  = pointer_delta(_markBitMap.endWord(), curAddr);
5508       MemRegion chunk(curAddr, MIN2(CMSBitMapYieldQuantum, remaining));
5509       _markBitMap.clear_large_range(chunk);
5510       if (ConcurrentMarkSweepThread::should_yield() &amp;&amp;
5511           !foregroundGCIsActive() &amp;&amp;
5512           CMSYield) {
5513         assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
5514                &quot;CMS thread should hold CMS token&quot;);
5515         assert_lock_strong(bitMapLock());
5516         bitMapLock()-&gt;unlock();
5517         ConcurrentMarkSweepThread::desynchronize(true);
5518         stopTimer();
5519         incrementYields();
5520 
5521         // See the comment in coordinator_yield()
5522         for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
5523                          ConcurrentMarkSweepThread::should_yield() &amp;&amp;
5524                          !CMSCollector::foregroundGCIsActive(); ++i) {
5525           os::sleep(Thread::current(), 1, false);
5526         }
5527 
5528         ConcurrentMarkSweepThread::synchronize(true);
5529         bitMapLock()-&gt;lock_without_safepoint_check();
5530         startTimer();
5531       }
5532       curAddr = chunk.end();
5533     }
5534     // A successful mostly concurrent collection has been done.
5535     // Because only the full (i.e., concurrent mode failure) collections
5536     // are being measured for gc overhead limits, clean the &quot;near&quot; flag
5537     // and count.
5538     size_policy()-&gt;reset_gc_overhead_limit_count();
5539     _collectorState = Idling;
5540   }
5541 
5542   register_gc_end();
5543 }
5544 
5545 // Same as above but for STW paths
5546 void CMSCollector::reset_stw() {
5547   // already have the lock
5548   assert(_collectorState == Resetting, &quot;just checking&quot;);
5549   assert_lock_strong(bitMapLock());
5550   GCIdMark gc_id_mark(_cmsThread-&gt;gc_id());
5551   _markBitMap.clear_all();
5552   _collectorState = Idling;
5553   register_gc_end();
5554 }
5555 
5556 void CMSCollector::do_CMS_operation(CMS_op_type op, GCCause::Cause gc_cause) {
5557   GCTraceCPUTime tcpu;
5558   TraceCollectorStats tcs_cgc(cgc_counters());
5559 
5560   switch (op) {
5561     case CMS_op_checkpointRootsInitial: {
5562       GCTraceTime(Info, gc) t(&quot;Pause Initial Mark&quot;, NULL, GCCause::_no_gc, true);
5563       SvcGCMarker sgcm(SvcGCMarker::CONCURRENT);
5564       checkpointRootsInitial();
5565       break;
5566     }
5567     case CMS_op_checkpointRootsFinal: {
5568       GCTraceTime(Info, gc) t(&quot;Pause Remark&quot;, NULL, GCCause::_no_gc, true);
5569       SvcGCMarker sgcm(SvcGCMarker::CONCURRENT);
5570       checkpointRootsFinal();
5571       break;
5572     }
5573     default:
5574       fatal(&quot;No such CMS_op&quot;);
5575   }
5576 }
5577 
5578 #ifndef PRODUCT
5579 size_t const CMSCollector::skip_header_HeapWords() {
5580   return FreeChunk::header_size();
5581 }
5582 
5583 // Try and collect here conditions that should hold when
5584 // CMS thread is exiting. The idea is that the foreground GC
5585 // thread should not be blocked if it wants to terminate
5586 // the CMS thread and yet continue to run the VM for a while
5587 // after that.
5588 void CMSCollector::verify_ok_to_terminate() const {
5589   assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
5590          &quot;should be called by CMS thread&quot;);
5591   assert(!_foregroundGCShouldWait, &quot;should be false&quot;);
5592   // We could check here that all the various low-level locks
5593   // are not held by the CMS thread, but that is overkill; see
5594   // also CMSThread::verify_ok_to_terminate() where the CGC_lock
5595   // is checked.
5596 }
5597 #endif
5598 
5599 size_t CMSCollector::block_size_using_printezis_bits(HeapWord* addr) const {
5600    assert(_markBitMap.isMarked(addr) &amp;&amp; _markBitMap.isMarked(addr + 1),
5601           &quot;missing Printezis mark?&quot;);
5602   HeapWord* nextOneAddr = _markBitMap.getNextMarkedWordAddress(addr + 2);
5603   size_t size = pointer_delta(nextOneAddr + 1, addr);
5604   assert(size == CompactibleFreeListSpace::adjustObjectSize(size),
5605          &quot;alignment problem&quot;);
5606   assert(size &gt;= 3, &quot;Necessary for Printezis marks to work&quot;);
5607   return size;
5608 }
5609 
5610 // A variant of the above (block_size_using_printezis_bits()) except
5611 // that we return 0 if the P-bits are not yet set.
5612 size_t CMSCollector::block_size_if_printezis_bits(HeapWord* addr) const {
5613   if (_markBitMap.isMarked(addr + 1)) {
5614     assert(_markBitMap.isMarked(addr), &quot;P-bit can be set only for marked objects&quot;);
5615     HeapWord* nextOneAddr = _markBitMap.getNextMarkedWordAddress(addr + 2);
5616     size_t size = pointer_delta(nextOneAddr + 1, addr);
5617     assert(size == CompactibleFreeListSpace::adjustObjectSize(size),
5618            &quot;alignment problem&quot;);
5619     assert(size &gt;= 3, &quot;Necessary for Printezis marks to work&quot;);
5620     return size;
5621   }
5622   return 0;
5623 }
5624 
5625 HeapWord* CMSCollector::next_card_start_after_block(HeapWord* addr) const {
5626   size_t sz = 0;
5627   oop p = (oop)addr;
5628   if (p-&gt;klass_or_null_acquire() != NULL) {
5629     sz = CompactibleFreeListSpace::adjustObjectSize(p-&gt;size());
5630   } else {
5631     sz = block_size_using_printezis_bits(addr);
5632   }
5633   assert(sz &gt; 0, &quot;size must be nonzero&quot;);
5634   HeapWord* next_block = addr + sz;
5635   HeapWord* next_card  = align_up(next_block, CardTable::card_size);
5636   assert(align_down((uintptr_t)addr,      CardTable::card_size) &lt;
5637          align_down((uintptr_t)next_card, CardTable::card_size),
5638          &quot;must be different cards&quot;);
5639   return next_card;
5640 }
5641 
5642 
5643 // CMS Bit Map Wrapper /////////////////////////////////////////
5644 
5645 // Construct a CMS bit map infrastructure, but don&#39;t create the
5646 // bit vector itself. That is done by a separate call CMSBitMap::allocate()
5647 // further below.
5648 CMSBitMap::CMSBitMap(int shifter, int mutex_rank, const char* mutex_name):
5649   _shifter(shifter),
5650   _bm(),
5651   _lock(mutex_rank &gt;= 0 ? new Mutex(mutex_rank, mutex_name, true,
5652                                     Monitor::_safepoint_check_sometimes) : NULL)
5653 {
5654   _bmStartWord = 0;
5655   _bmWordSize  = 0;
5656 }
5657 
5658 bool CMSBitMap::allocate(MemRegion mr) {
5659   _bmStartWord = mr.start();
5660   _bmWordSize  = mr.word_size();
5661   ReservedSpace brs(ReservedSpace::allocation_align_size_up(
5662                      (_bmWordSize &gt;&gt; (_shifter + LogBitsPerByte)) + 1));
5663   if (!brs.is_reserved()) {
5664     log_warning(gc)(&quot;CMS bit map allocation failure&quot;);
5665     return false;
5666   }
5667   // For now we&#39;ll just commit all of the bit map up front.
5668   // Later on we&#39;ll try to be more parsimonious with swap.
5669   if (!_virtual_space.initialize(brs, brs.size())) {
5670     log_warning(gc)(&quot;CMS bit map backing store failure&quot;);
5671     return false;
5672   }
5673   assert(_virtual_space.committed_size() == brs.size(),
5674          &quot;didn&#39;t reserve backing store for all of CMS bit map?&quot;);
5675   assert(_virtual_space.committed_size() &lt;&lt; (_shifter + LogBitsPerByte) &gt;=
5676          _bmWordSize, &quot;inconsistency in bit map sizing&quot;);
5677   _bm = BitMapView((BitMap::bm_word_t*)_virtual_space.low(), _bmWordSize &gt;&gt; _shifter);
5678 
5679   // bm.clear(); // can we rely on getting zero&#39;d memory? verify below
5680   assert(isAllClear(),
5681          &quot;Expected zero&#39;d memory from ReservedSpace constructor&quot;);
5682   assert(_bm.size() == heapWordDiffToOffsetDiff(sizeInWords()),
5683          &quot;consistency check&quot;);
5684   return true;
5685 }
5686 
5687 void CMSBitMap::dirty_range_iterate_clear(MemRegion mr, MemRegionClosure* cl) {
5688   HeapWord *next_addr, *end_addr, *last_addr;
5689   assert_locked();
5690   assert(covers(mr), &quot;out-of-range error&quot;);
5691   // XXX assert that start and end are appropriately aligned
5692   for (next_addr = mr.start(), end_addr = mr.end();
5693        next_addr &lt; end_addr; next_addr = last_addr) {
5694     MemRegion dirty_region = getAndClearMarkedRegion(next_addr, end_addr);
5695     last_addr = dirty_region.end();
5696     if (!dirty_region.is_empty()) {
5697       cl-&gt;do_MemRegion(dirty_region);
5698     } else {
5699       assert(last_addr == end_addr, &quot;program logic&quot;);
5700       return;
5701     }
5702   }
5703 }
5704 
5705 void CMSBitMap::print_on_error(outputStream* st, const char* prefix) const {
5706   _bm.print_on_error(st, prefix);
5707 }
5708 
5709 #ifndef PRODUCT
5710 void CMSBitMap::assert_locked() const {
5711   CMSLockVerifier::assert_locked(lock());
5712 }
5713 
5714 bool CMSBitMap::covers(MemRegion mr) const {
5715   // assert(_bm.map() == _virtual_space.low(), &quot;map inconsistency&quot;);
5716   assert((size_t)_bm.size() == (_bmWordSize &gt;&gt; _shifter),
5717          &quot;size inconsistency&quot;);
5718   return (mr.start() &gt;= _bmStartWord) &amp;&amp;
5719          (mr.end()   &lt;= endWord());
5720 }
5721 
5722 bool CMSBitMap::covers(HeapWord* start, size_t size) const {
5723     return (start &gt;= _bmStartWord &amp;&amp; (start + size) &lt;= endWord());
5724 }
5725 
5726 void CMSBitMap::verifyNoOneBitsInRange(HeapWord* left, HeapWord* right) {
5727   // verify that there are no 1 bits in the interval [left, right)
5728   FalseBitMapClosure falseBitMapClosure;
5729   iterate(&amp;falseBitMapClosure, left, right);
5730 }
5731 
5732 void CMSBitMap::region_invariant(MemRegion mr)
5733 {
5734   assert_locked();
5735   // mr = mr.intersection(MemRegion(_bmStartWord, _bmWordSize));
5736   assert(!mr.is_empty(), &quot;unexpected empty region&quot;);
5737   assert(covers(mr), &quot;mr should be covered by bit map&quot;);
5738   // convert address range into offset range
5739   size_t start_ofs = heapWordToOffset(mr.start());
5740   // Make sure that end() is appropriately aligned
5741   assert(mr.end() == align_up(mr.end(), (1 &lt;&lt; (_shifter+LogHeapWordSize))),
5742          &quot;Misaligned mr.end()&quot;);
5743   size_t end_ofs   = heapWordToOffset(mr.end());
5744   assert(end_ofs &gt; start_ofs, &quot;Should mark at least one bit&quot;);
5745 }
5746 
5747 #endif
5748 
5749 bool CMSMarkStack::allocate(size_t size) {
5750   // allocate a stack of the requisite depth
5751   ReservedSpace rs(ReservedSpace::allocation_align_size_up(
5752                    size * sizeof(oop)));
5753   if (!rs.is_reserved()) {
5754     log_warning(gc)(&quot;CMSMarkStack allocation failure&quot;);
5755     return false;
5756   }
5757   if (!_virtual_space.initialize(rs, rs.size())) {
5758     log_warning(gc)(&quot;CMSMarkStack backing store failure&quot;);
5759     return false;
5760   }
5761   assert(_virtual_space.committed_size() == rs.size(),
5762          &quot;didn&#39;t reserve backing store for all of CMS stack?&quot;);
5763   _base = (oop*)(_virtual_space.low());
5764   _index = 0;
5765   _capacity = size;
5766   NOT_PRODUCT(_max_depth = 0);
5767   return true;
5768 }
5769 
5770 // XXX FIX ME !!! In the MT case we come in here holding a
5771 // leaf lock. For printing we need to take a further lock
5772 // which has lower rank. We need to recalibrate the two
5773 // lock-ranks involved in order to be able to print the
5774 // messages below. (Or defer the printing to the caller.
5775 // For now we take the expedient path of just disabling the
5776 // messages for the problematic case.)
5777 void CMSMarkStack::expand() {
5778   assert(_capacity &lt;= MarkStackSizeMax, &quot;stack bigger than permitted&quot;);
5779   if (_capacity == MarkStackSizeMax) {
5780     if (_hit_limit++ == 0 &amp;&amp; !CMSConcurrentMTEnabled) {
5781       // We print a warning message only once per CMS cycle.
5782       log_debug(gc)(&quot; (benign) Hit CMSMarkStack max size limit&quot;);
5783     }
5784     return;
5785   }
5786   // Double capacity if possible
5787   size_t new_capacity = MIN2(_capacity*2, MarkStackSizeMax);
5788   // Do not give up existing stack until we have managed to
5789   // get the double capacity that we desired.
5790   ReservedSpace rs(ReservedSpace::allocation_align_size_up(
5791                    new_capacity * sizeof(oop)));
5792   if (rs.is_reserved()) {
5793     // Release the backing store associated with old stack
5794     _virtual_space.release();
5795     // Reinitialize virtual space for new stack
5796     if (!_virtual_space.initialize(rs, rs.size())) {
5797       fatal(&quot;Not enough swap for expanded marking stack&quot;);
5798     }
5799     _base = (oop*)(_virtual_space.low());
5800     _index = 0;
5801     _capacity = new_capacity;
5802   } else if (_failed_double++ == 0 &amp;&amp; !CMSConcurrentMTEnabled) {
5803     // Failed to double capacity, continue;
5804     // we print a detail message only once per CMS cycle.
5805     log_debug(gc)(&quot; (benign) Failed to expand marking stack from &quot; SIZE_FORMAT &quot;K to &quot; SIZE_FORMAT &quot;K&quot;,
5806                         _capacity / K, new_capacity / K);
5807   }
5808 }
5809 
5810 
5811 // Closures
5812 // XXX: there seems to be a lot of code  duplication here;
5813 // should refactor and consolidate common code.
5814 
5815 // This closure is used to mark refs into the CMS generation in
5816 // the CMS bit map. Called at the first checkpoint. This closure
5817 // assumes that we do not need to re-mark dirty cards; if the CMS
5818 // generation on which this is used is not an oldest
5819 // generation then this will lose younger_gen cards!
5820 
5821 MarkRefsIntoClosure::MarkRefsIntoClosure(
5822   MemRegion span, CMSBitMap* bitMap):
5823     _span(span),
5824     _bitMap(bitMap)
5825 {
5826   assert(ref_discoverer() == NULL, &quot;deliberately left NULL&quot;);
5827   assert(_bitMap-&gt;covers(_span), &quot;_bitMap/_span mismatch&quot;);
5828 }
5829 
5830 void MarkRefsIntoClosure::do_oop(oop obj) {
5831   // if p points into _span, then mark corresponding bit in _markBitMap
5832   assert(oopDesc::is_oop(obj), &quot;expected an oop&quot;);
5833   HeapWord* addr = (HeapWord*)obj;
5834   if (_span.contains(addr)) {
5835     // this should be made more efficient
5836     _bitMap-&gt;mark(addr);
5837   }
5838 }
5839 
5840 ParMarkRefsIntoClosure::ParMarkRefsIntoClosure(
5841   MemRegion span, CMSBitMap* bitMap):
5842     _span(span),
5843     _bitMap(bitMap)
5844 {
5845   assert(ref_discoverer() == NULL, &quot;deliberately left NULL&quot;);
5846   assert(_bitMap-&gt;covers(_span), &quot;_bitMap/_span mismatch&quot;);
5847 }
5848 
5849 void ParMarkRefsIntoClosure::do_oop(oop obj) {
5850   // if p points into _span, then mark corresponding bit in _markBitMap
5851   assert(oopDesc::is_oop(obj), &quot;expected an oop&quot;);
5852   HeapWord* addr = (HeapWord*)obj;
5853   if (_span.contains(addr)) {
5854     // this should be made more efficient
5855     _bitMap-&gt;par_mark(addr);
5856   }
5857 }
5858 
5859 // A variant of the above, used for CMS marking verification.
5860 MarkRefsIntoVerifyClosure::MarkRefsIntoVerifyClosure(
5861   MemRegion span, CMSBitMap* verification_bm, CMSBitMap* cms_bm):
5862     _span(span),
5863     _verification_bm(verification_bm),
5864     _cms_bm(cms_bm)
5865 {
5866   assert(ref_discoverer() == NULL, &quot;deliberately left NULL&quot;);
5867   assert(_verification_bm-&gt;covers(_span), &quot;_verification_bm/_span mismatch&quot;);
5868 }
5869 
5870 void MarkRefsIntoVerifyClosure::do_oop(oop obj) {
5871   // if p points into _span, then mark corresponding bit in _markBitMap
5872   assert(oopDesc::is_oop(obj), &quot;expected an oop&quot;);
5873   HeapWord* addr = (HeapWord*)obj;
5874   if (_span.contains(addr)) {
5875     _verification_bm-&gt;mark(addr);
5876     if (!_cms_bm-&gt;isMarked(addr)) {
5877       Log(gc, verify) log;
5878       ResourceMark rm;
5879       LogStream ls(log.error());
5880       oop(addr)-&gt;print_on(&amp;ls);
5881       log.error(&quot; (&quot; INTPTR_FORMAT &quot; should have been marked)&quot;, p2i(addr));
5882       fatal(&quot;... aborting&quot;);
5883     }
5884   }
5885 }
5886 
5887 //////////////////////////////////////////////////
5888 // MarkRefsIntoAndScanClosure
5889 //////////////////////////////////////////////////
5890 
5891 MarkRefsIntoAndScanClosure::MarkRefsIntoAndScanClosure(MemRegion span,
5892                                                        ReferenceDiscoverer* rd,
5893                                                        CMSBitMap* bit_map,
5894                                                        CMSBitMap* mod_union_table,
5895                                                        CMSMarkStack*  mark_stack,
5896                                                        CMSCollector* collector,
5897                                                        bool should_yield,
5898                                                        bool concurrent_precleaning):
5899   _span(span),
5900   _bit_map(bit_map),
5901   _mark_stack(mark_stack),
5902   _pushAndMarkClosure(collector, span, rd, bit_map, mod_union_table,
5903                       mark_stack, concurrent_precleaning),
5904   _collector(collector),
5905   _freelistLock(NULL),
5906   _yield(should_yield),
5907   _concurrent_precleaning(concurrent_precleaning)
5908 {
5909   // FIXME: Should initialize in base class constructor.
5910   assert(rd != NULL, &quot;ref_discoverer shouldn&#39;t be NULL&quot;);
5911   set_ref_discoverer_internal(rd);
5912 }
5913 
5914 // This closure is used to mark refs into the CMS generation at the
5915 // second (final) checkpoint, and to scan and transitively follow
5916 // the unmarked oops. It is also used during the concurrent precleaning
5917 // phase while scanning objects on dirty cards in the CMS generation.
5918 // The marks are made in the marking bit map and the marking stack is
5919 // used for keeping the (newly) grey objects during the scan.
5920 // The parallel version (Par_...) appears further below.
5921 void MarkRefsIntoAndScanClosure::do_oop(oop obj) {
5922   if (obj != NULL) {
5923     assert(oopDesc::is_oop(obj), &quot;expected an oop&quot;);
5924     HeapWord* addr = (HeapWord*)obj;
5925     assert(_mark_stack-&gt;isEmpty(), &quot;pre-condition (eager drainage)&quot;);
5926     assert(_collector-&gt;overflow_list_is_empty(),
5927            &quot;overflow list should be empty&quot;);
5928     if (_span.contains(addr) &amp;&amp;
5929         !_bit_map-&gt;isMarked(addr)) {
5930       // mark bit map (object is now grey)
5931       _bit_map-&gt;mark(addr);
5932       // push on marking stack (stack should be empty), and drain the
5933       // stack by applying this closure to the oops in the oops popped
5934       // from the stack (i.e. blacken the grey objects)
5935       bool res = _mark_stack-&gt;push(obj);
5936       assert(res, &quot;Should have space to push on empty stack&quot;);
5937       do {
5938         oop new_oop = _mark_stack-&gt;pop();
5939         assert(new_oop != NULL &amp;&amp; oopDesc::is_oop(new_oop), &quot;Expected an oop&quot;);
5940         assert(_bit_map-&gt;isMarked((HeapWord*)new_oop),
5941                &quot;only grey objects on this stack&quot;);
5942         // iterate over the oops in this oop, marking and pushing
5943         // the ones in CMS heap (i.e. in _span).
5944         new_oop-&gt;oop_iterate(&amp;_pushAndMarkClosure);
5945         // check if it&#39;s time to yield
5946         do_yield_check();
5947       } while (!_mark_stack-&gt;isEmpty() ||
5948                (!_concurrent_precleaning &amp;&amp; take_from_overflow_list()));
5949         // if marking stack is empty, and we are not doing this
5950         // during precleaning, then check the overflow list
5951     }
5952     assert(_mark_stack-&gt;isEmpty(), &quot;post-condition (eager drainage)&quot;);
5953     assert(_collector-&gt;overflow_list_is_empty(),
5954            &quot;overflow list was drained above&quot;);
5955 
5956     assert(_collector-&gt;no_preserved_marks(),
5957            &quot;All preserved marks should have been restored above&quot;);
5958   }
5959 }
5960 
5961 void MarkRefsIntoAndScanClosure::do_yield_work() {
5962   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
5963          &quot;CMS thread should hold CMS token&quot;);
5964   assert_lock_strong(_freelistLock);
5965   assert_lock_strong(_bit_map-&gt;lock());
5966   // relinquish the free_list_lock and bitMaplock()
5967   _bit_map-&gt;lock()-&gt;unlock();
5968   _freelistLock-&gt;unlock();
5969   ConcurrentMarkSweepThread::desynchronize(true);
5970   _collector-&gt;stopTimer();
5971   _collector-&gt;incrementYields();
5972 
5973   // See the comment in coordinator_yield()
5974   for (unsigned i = 0;
5975        i &lt; CMSYieldSleepCount &amp;&amp;
5976        ConcurrentMarkSweepThread::should_yield() &amp;&amp;
5977        !CMSCollector::foregroundGCIsActive();
5978        ++i) {
5979     os::sleep(Thread::current(), 1, false);
5980   }
5981 
5982   ConcurrentMarkSweepThread::synchronize(true);
5983   _freelistLock-&gt;lock_without_safepoint_check();
5984   _bit_map-&gt;lock()-&gt;lock_without_safepoint_check();
5985   _collector-&gt;startTimer();
5986 }
5987 
5988 ///////////////////////////////////////////////////////////
5989 // ParMarkRefsIntoAndScanClosure: a parallel version of
5990 //                                MarkRefsIntoAndScanClosure
5991 ///////////////////////////////////////////////////////////
5992 ParMarkRefsIntoAndScanClosure::ParMarkRefsIntoAndScanClosure(
5993   CMSCollector* collector, MemRegion span, ReferenceDiscoverer* rd,
5994   CMSBitMap* bit_map, OopTaskQueue* work_queue):
5995   _span(span),
5996   _bit_map(bit_map),
5997   _work_queue(work_queue),
5998   _low_water_mark(MIN2((work_queue-&gt;max_elems()/4),
5999                        ((uint)CMSWorkQueueDrainThreshold * ParallelGCThreads))),
6000   _parPushAndMarkClosure(collector, span, rd, bit_map, work_queue)
6001 {
6002   // FIXME: Should initialize in base class constructor.
6003   assert(rd != NULL, &quot;ref_discoverer shouldn&#39;t be NULL&quot;);
6004   set_ref_discoverer_internal(rd);
6005 }
6006 
6007 // This closure is used to mark refs into the CMS generation at the
6008 // second (final) checkpoint, and to scan and transitively follow
6009 // the unmarked oops. The marks are made in the marking bit map and
6010 // the work_queue is used for keeping the (newly) grey objects during
6011 // the scan phase whence they are also available for stealing by parallel
6012 // threads. Since the marking bit map is shared, updates are
6013 // synchronized (via CAS).
6014 void ParMarkRefsIntoAndScanClosure::do_oop(oop obj) {
6015   if (obj != NULL) {
6016     // Ignore mark word because this could be an already marked oop
6017     // that may be chained at the end of the overflow list.
6018     assert(oopDesc::is_oop(obj, true), &quot;expected an oop&quot;);
6019     HeapWord* addr = (HeapWord*)obj;
6020     if (_span.contains(addr) &amp;&amp;
6021         !_bit_map-&gt;isMarked(addr)) {
6022       // mark bit map (object will become grey):
6023       // It is possible for several threads to be
6024       // trying to &quot;claim&quot; this object concurrently;
6025       // the unique thread that succeeds in marking the
6026       // object first will do the subsequent push on
6027       // to the work queue (or overflow list).
6028       if (_bit_map-&gt;par_mark(addr)) {
6029         // push on work_queue (which may not be empty), and trim the
6030         // queue to an appropriate length by applying this closure to
6031         // the oops in the oops popped from the stack (i.e. blacken the
6032         // grey objects)
6033         bool res = _work_queue-&gt;push(obj);
6034         assert(res, &quot;Low water mark should be less than capacity?&quot;);
6035         trim_queue(_low_water_mark);
6036       } // Else, another thread claimed the object
6037     }
6038   }
6039 }
6040 
6041 // This closure is used to rescan the marked objects on the dirty cards
6042 // in the mod union table and the card table proper.
6043 size_t ScanMarkedObjectsAgainCarefullyClosure::do_object_careful_m(
6044   oop p, MemRegion mr) {
6045 
6046   size_t size = 0;
6047   HeapWord* addr = (HeapWord*)p;
6048   DEBUG_ONLY(_collector-&gt;verify_work_stacks_empty();)
6049   assert(_span.contains(addr), &quot;we are scanning the CMS generation&quot;);
6050   // check if it&#39;s time to yield
6051   if (do_yield_check()) {
6052     // We yielded for some foreground stop-world work,
6053     // and we have been asked to abort this ongoing preclean cycle.
6054     return 0;
6055   }
6056   if (_bitMap-&gt;isMarked(addr)) {
6057     // it&#39;s marked; is it potentially uninitialized?
6058     if (p-&gt;klass_or_null_acquire() != NULL) {
6059         // an initialized object; ignore mark word in verification below
6060         // since we are running concurrent with mutators
6061         assert(oopDesc::is_oop(p, true), &quot;should be an oop&quot;);
6062         if (p-&gt;is_objArray()) {
6063           // objArrays are precisely marked; restrict scanning
6064           // to dirty cards only.
6065           size = CompactibleFreeListSpace::adjustObjectSize(
6066                    p-&gt;oop_iterate_size(_scanningClosure, mr));
6067         } else {
6068           // A non-array may have been imprecisely marked; we need
6069           // to scan object in its entirety.
6070           size = CompactibleFreeListSpace::adjustObjectSize(
6071                    p-&gt;oop_iterate_size(_scanningClosure));
6072         }
6073       #ifdef ASSERT
6074         size_t direct_size =
6075           CompactibleFreeListSpace::adjustObjectSize(p-&gt;size());
6076         assert(size == direct_size, &quot;Inconsistency in size&quot;);
6077         assert(size &gt;= 3, &quot;Necessary for Printezis marks to work&quot;);
6078         HeapWord* start_pbit = addr + 1;
6079         HeapWord* end_pbit = addr + size - 1;
6080         assert(_bitMap-&gt;isMarked(start_pbit) == _bitMap-&gt;isMarked(end_pbit),
6081                &quot;inconsistent Printezis mark&quot;);
6082         // Verify inner mark bits (between Printezis bits) are clear,
6083         // but don&#39;t repeat if there are multiple dirty regions for
6084         // the same object, to avoid potential O(N^2) performance.
6085         if (addr != _last_scanned_object) {
6086           _bitMap-&gt;verifyNoOneBitsInRange(start_pbit + 1, end_pbit);
6087           _last_scanned_object = addr;
6088         }
6089       #endif // ASSERT
6090     } else {
6091       // An uninitialized object.
6092       assert(_bitMap-&gt;isMarked(addr+1), &quot;missing Printezis mark?&quot;);
6093       HeapWord* nextOneAddr = _bitMap-&gt;getNextMarkedWordAddress(addr + 2);
6094       size = pointer_delta(nextOneAddr + 1, addr);
6095       assert(size == CompactibleFreeListSpace::adjustObjectSize(size),
6096              &quot;alignment problem&quot;);
6097       // Note that pre-cleaning needn&#39;t redirty the card. OopDesc::set_klass()
6098       // will dirty the card when the klass pointer is installed in the
6099       // object (signaling the completion of initialization).
6100     }
6101   } else {
6102     // Either a not yet marked object or an uninitialized object
6103     if (p-&gt;klass_or_null_acquire() == NULL) {
6104       // An uninitialized object, skip to the next card, since
6105       // we may not be able to read its P-bits yet.
6106       assert(size == 0, &quot;Initial value&quot;);
6107     } else {
6108       // An object not (yet) reached by marking: we merely need to
6109       // compute its size so as to go look at the next block.
6110       assert(oopDesc::is_oop(p, true), &quot;should be an oop&quot;);
6111       size = CompactibleFreeListSpace::adjustObjectSize(p-&gt;size());
6112     }
6113   }
6114   DEBUG_ONLY(_collector-&gt;verify_work_stacks_empty();)
6115   return size;
6116 }
6117 
6118 void ScanMarkedObjectsAgainCarefullyClosure::do_yield_work() {
6119   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
6120          &quot;CMS thread should hold CMS token&quot;);
6121   assert_lock_strong(_freelistLock);
6122   assert_lock_strong(_bitMap-&gt;lock());
6123   // relinquish the free_list_lock and bitMaplock()
6124   _bitMap-&gt;lock()-&gt;unlock();
6125   _freelistLock-&gt;unlock();
6126   ConcurrentMarkSweepThread::desynchronize(true);
6127   _collector-&gt;stopTimer();
6128   _collector-&gt;incrementYields();
6129 
6130   // See the comment in coordinator_yield()
6131   for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
6132                    ConcurrentMarkSweepThread::should_yield() &amp;&amp;
6133                    !CMSCollector::foregroundGCIsActive(); ++i) {
6134     os::sleep(Thread::current(), 1, false);
6135   }
6136 
6137   ConcurrentMarkSweepThread::synchronize(true);
6138   _freelistLock-&gt;lock_without_safepoint_check();
6139   _bitMap-&gt;lock()-&gt;lock_without_safepoint_check();
6140   _collector-&gt;startTimer();
6141 }
6142 
6143 
6144 //////////////////////////////////////////////////////////////////
6145 // SurvivorSpacePrecleanClosure
6146 //////////////////////////////////////////////////////////////////
6147 // This (single-threaded) closure is used to preclean the oops in
6148 // the survivor spaces.
6149 size_t SurvivorSpacePrecleanClosure::do_object_careful(oop p) {
6150 
6151   HeapWord* addr = (HeapWord*)p;
6152   DEBUG_ONLY(_collector-&gt;verify_work_stacks_empty();)
6153   assert(!_span.contains(addr), &quot;we are scanning the survivor spaces&quot;);
6154   assert(p-&gt;klass_or_null() != NULL, &quot;object should be initialized&quot;);
6155   // an initialized object; ignore mark word in verification below
6156   // since we are running concurrent with mutators
6157   assert(oopDesc::is_oop(p, true), &quot;should be an oop&quot;);
6158   // Note that we do not yield while we iterate over
6159   // the interior oops of p, pushing the relevant ones
6160   // on our marking stack.
6161   size_t size = p-&gt;oop_iterate_size(_scanning_closure);
6162   do_yield_check();
6163   // Observe that below, we do not abandon the preclean
6164   // phase as soon as we should; rather we empty the
6165   // marking stack before returning. This is to satisfy
6166   // some existing assertions. In general, it may be a
6167   // good idea to abort immediately and complete the marking
6168   // from the grey objects at a later time.
6169   while (!_mark_stack-&gt;isEmpty()) {
6170     oop new_oop = _mark_stack-&gt;pop();
6171     assert(new_oop != NULL &amp;&amp; oopDesc::is_oop(new_oop), &quot;Expected an oop&quot;);
6172     assert(_bit_map-&gt;isMarked((HeapWord*)new_oop),
6173            &quot;only grey objects on this stack&quot;);
6174     // iterate over the oops in this oop, marking and pushing
6175     // the ones in CMS heap (i.e. in _span).
6176     new_oop-&gt;oop_iterate(_scanning_closure);
6177     // check if it&#39;s time to yield
6178     do_yield_check();
6179   }
6180   unsigned int after_count =
6181     CMSHeap::heap()-&gt;total_collections();
6182   bool abort = (_before_count != after_count) ||
6183                _collector-&gt;should_abort_preclean();
6184   return abort ? 0 : size;
6185 }
6186 
6187 void SurvivorSpacePrecleanClosure::do_yield_work() {
6188   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
6189          &quot;CMS thread should hold CMS token&quot;);
6190   assert_lock_strong(_bit_map-&gt;lock());
6191   // Relinquish the bit map lock
6192   _bit_map-&gt;lock()-&gt;unlock();
6193   ConcurrentMarkSweepThread::desynchronize(true);
6194   _collector-&gt;stopTimer();
6195   _collector-&gt;incrementYields();
6196 
6197   // See the comment in coordinator_yield()
6198   for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
6199                        ConcurrentMarkSweepThread::should_yield() &amp;&amp;
6200                        !CMSCollector::foregroundGCIsActive(); ++i) {
6201     os::sleep(Thread::current(), 1, false);
6202   }
6203 
6204   ConcurrentMarkSweepThread::synchronize(true);
6205   _bit_map-&gt;lock()-&gt;lock_without_safepoint_check();
6206   _collector-&gt;startTimer();
6207 }
6208 
6209 // This closure is used to rescan the marked objects on the dirty cards
6210 // in the mod union table and the card table proper. In the parallel
6211 // case, although the bitMap is shared, we do a single read so the
6212 // isMarked() query is &quot;safe&quot;.
6213 bool ScanMarkedObjectsAgainClosure::do_object_bm(oop p, MemRegion mr) {
6214   // Ignore mark word because we are running concurrent with mutators
6215   assert(oopDesc::is_oop_or_null(p, true), &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(p));
6216   HeapWord* addr = (HeapWord*)p;
6217   assert(_span.contains(addr), &quot;we are scanning the CMS generation&quot;);
6218   bool is_obj_array = false;
6219   #ifdef ASSERT
6220     if (!_parallel) {
6221       assert(_mark_stack-&gt;isEmpty(), &quot;pre-condition (eager drainage)&quot;);
6222       assert(_collector-&gt;overflow_list_is_empty(),
6223              &quot;overflow list should be empty&quot;);
6224 
6225     }
6226   #endif // ASSERT
6227   if (_bit_map-&gt;isMarked(addr)) {
6228     // Obj arrays are precisely marked, non-arrays are not;
6229     // so we scan objArrays precisely and non-arrays in their
6230     // entirety.
6231     if (p-&gt;is_objArray()) {
6232       is_obj_array = true;
6233       if (_parallel) {
6234         p-&gt;oop_iterate(_par_scan_closure, mr);
6235       } else {
6236         p-&gt;oop_iterate(_scan_closure, mr);
6237       }
6238     } else {
6239       if (_parallel) {
6240         p-&gt;oop_iterate(_par_scan_closure);
6241       } else {
6242         p-&gt;oop_iterate(_scan_closure);
6243       }
6244     }
6245   }
6246   #ifdef ASSERT
6247     if (!_parallel) {
6248       assert(_mark_stack-&gt;isEmpty(), &quot;post-condition (eager drainage)&quot;);
6249       assert(_collector-&gt;overflow_list_is_empty(),
6250              &quot;overflow list should be empty&quot;);
6251 
6252     }
6253   #endif // ASSERT
6254   return is_obj_array;
6255 }
6256 
6257 MarkFromRootsClosure::MarkFromRootsClosure(CMSCollector* collector,
6258                         MemRegion span,
6259                         CMSBitMap* bitMap, CMSMarkStack*  markStack,
6260                         bool should_yield, bool verifying):
6261   _collector(collector),
6262   _span(span),
6263   _bitMap(bitMap),
6264   _mut(&amp;collector-&gt;_modUnionTable),
6265   _markStack(markStack),
6266   _yield(should_yield),
6267   _skipBits(0)
6268 {
6269   assert(_markStack-&gt;isEmpty(), &quot;stack should be empty&quot;);
6270   _finger = _bitMap-&gt;startWord();
6271   _threshold = _finger;
6272   assert(_collector-&gt;_restart_addr == NULL, &quot;Sanity check&quot;);
6273   assert(_span.contains(_finger), &quot;Out of bounds _finger?&quot;);
6274   DEBUG_ONLY(_verifying = verifying;)
6275 }
6276 
6277 void MarkFromRootsClosure::reset(HeapWord* addr) {
6278   assert(_markStack-&gt;isEmpty(), &quot;would cause duplicates on stack&quot;);
6279   assert(_span.contains(addr), &quot;Out of bounds _finger?&quot;);
6280   _finger = addr;
6281   _threshold = align_up(_finger, CardTable::card_size);
6282 }
6283 
6284 // Should revisit to see if this should be restructured for
6285 // greater efficiency.
6286 bool MarkFromRootsClosure::do_bit(size_t offset) {
6287   if (_skipBits &gt; 0) {
6288     _skipBits--;
6289     return true;
6290   }
6291   // convert offset into a HeapWord*
6292   HeapWord* addr = _bitMap-&gt;startWord() + offset;
6293   assert(_bitMap-&gt;endWord() &amp;&amp; addr &lt; _bitMap-&gt;endWord(),
6294          &quot;address out of range&quot;);
6295   assert(_bitMap-&gt;isMarked(addr), &quot;tautology&quot;);
6296   if (_bitMap-&gt;isMarked(addr+1)) {
6297     // this is an allocated but not yet initialized object
6298     assert(_skipBits == 0, &quot;tautology&quot;);
6299     _skipBits = 2;  // skip next two marked bits (&quot;Printezis-marks&quot;)
6300     oop p = oop(addr);
6301     if (p-&gt;klass_or_null_acquire() == NULL) {
6302       DEBUG_ONLY(if (!_verifying) {)
6303         // We re-dirty the cards on which this object lies and increase
6304         // the _threshold so that we&#39;ll come back to scan this object
6305         // during the preclean or remark phase. (CMSCleanOnEnter)
6306         if (CMSCleanOnEnter) {
6307           size_t sz = _collector-&gt;block_size_using_printezis_bits(addr);
6308           HeapWord* end_card_addr = align_up(addr + sz, CardTable::card_size);
6309           MemRegion redirty_range = MemRegion(addr, end_card_addr);
6310           assert(!redirty_range.is_empty(), &quot;Arithmetical tautology&quot;);
6311           // Bump _threshold to end_card_addr; note that
6312           // _threshold cannot possibly exceed end_card_addr, anyhow.
6313           // This prevents future clearing of the card as the scan proceeds
6314           // to the right.
6315           assert(_threshold &lt;= end_card_addr,
6316                  &quot;Because we are just scanning into this object&quot;);
6317           if (_threshold &lt; end_card_addr) {
6318             _threshold = end_card_addr;
6319           }
6320           if (p-&gt;klass_or_null_acquire() != NULL) {
6321             // Redirty the range of cards...
6322             _mut-&gt;mark_range(redirty_range);
6323           } // ...else the setting of klass will dirty the card anyway.
6324         }
6325       DEBUG_ONLY(})
6326       return true;
6327     }
6328   }
6329   scanOopsInOop(addr);
6330   return true;
6331 }
6332 
6333 // We take a break if we&#39;ve been at this for a while,
6334 // so as to avoid monopolizing the locks involved.
6335 void MarkFromRootsClosure::do_yield_work() {
6336   // First give up the locks, then yield, then re-lock
6337   // We should probably use a constructor/destructor idiom to
6338   // do this unlock/lock or modify the MutexUnlocker class to
6339   // serve our purpose. XXX
6340   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
6341          &quot;CMS thread should hold CMS token&quot;);
6342   assert_lock_strong(_bitMap-&gt;lock());
6343   _bitMap-&gt;lock()-&gt;unlock();
6344   ConcurrentMarkSweepThread::desynchronize(true);
6345   _collector-&gt;stopTimer();
6346   _collector-&gt;incrementYields();
6347 
6348   // See the comment in coordinator_yield()
6349   for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
6350                        ConcurrentMarkSweepThread::should_yield() &amp;&amp;
6351                        !CMSCollector::foregroundGCIsActive(); ++i) {
6352     os::sleep(Thread::current(), 1, false);
6353   }
6354 
6355   ConcurrentMarkSweepThread::synchronize(true);
6356   _bitMap-&gt;lock()-&gt;lock_without_safepoint_check();
6357   _collector-&gt;startTimer();
6358 }
6359 
6360 void MarkFromRootsClosure::scanOopsInOop(HeapWord* ptr) {
6361   assert(_bitMap-&gt;isMarked(ptr), &quot;expected bit to be set&quot;);
6362   assert(_markStack-&gt;isEmpty(),
6363          &quot;should drain stack to limit stack usage&quot;);
6364   // convert ptr to an oop preparatory to scanning
6365   oop obj = oop(ptr);
6366   // Ignore mark word in verification below, since we
6367   // may be running concurrent with mutators.
6368   assert(oopDesc::is_oop(obj, true), &quot;should be an oop&quot;);
6369   assert(_finger &lt;= ptr, &quot;_finger runneth ahead&quot;);
6370   // advance the finger to right end of this object
6371   _finger = ptr + obj-&gt;size();
6372   assert(_finger &gt; ptr, &quot;we just incremented it above&quot;);
6373   // On large heaps, it may take us some time to get through
6374   // the marking phase. During
6375   // this time it&#39;s possible that a lot of mutations have
6376   // accumulated in the card table and the mod union table --
6377   // these mutation records are redundant until we have
6378   // actually traced into the corresponding card.
6379   // Here, we check whether advancing the finger would make
6380   // us cross into a new card, and if so clear corresponding
6381   // cards in the MUT (preclean them in the card-table in the
6382   // future).
6383 
6384   DEBUG_ONLY(if (!_verifying) {)
6385     // The clean-on-enter optimization is disabled by default,
6386     // until we fix 6178663.
6387     if (CMSCleanOnEnter &amp;&amp; (_finger &gt; _threshold)) {
6388       // [_threshold, _finger) represents the interval
6389       // of cards to be cleared  in MUT (or precleaned in card table).
6390       // The set of cards to be cleared is all those that overlap
6391       // with the interval [_threshold, _finger); note that
6392       // _threshold is always kept card-aligned but _finger isn&#39;t
6393       // always card-aligned.
6394       HeapWord* old_threshold = _threshold;
6395       assert(is_aligned(old_threshold, CardTable::card_size),
6396              &quot;_threshold should always be card-aligned&quot;);
6397       _threshold = align_up(_finger, CardTable::card_size);
6398       MemRegion mr(old_threshold, _threshold);
6399       assert(!mr.is_empty(), &quot;Control point invariant&quot;);
6400       assert(_span.contains(mr), &quot;Should clear within span&quot;);
6401       _mut-&gt;clear_range(mr);
6402     }
6403   DEBUG_ONLY(})
6404   // Note: the finger doesn&#39;t advance while we drain
6405   // the stack below.
6406   PushOrMarkClosure pushOrMarkClosure(_collector,
6407                                       _span, _bitMap, _markStack,
6408                                       _finger, this);
6409   bool res = _markStack-&gt;push(obj);
6410   assert(res, &quot;Empty non-zero size stack should have space for single push&quot;);
6411   while (!_markStack-&gt;isEmpty()) {
6412     oop new_oop = _markStack-&gt;pop();
6413     // Skip verifying header mark word below because we are
6414     // running concurrent with mutators.
6415     assert(oopDesc::is_oop(new_oop, true), &quot;Oops! expected to pop an oop&quot;);
6416     // now scan this oop&#39;s oops
6417     new_oop-&gt;oop_iterate(&amp;pushOrMarkClosure);
6418     do_yield_check();
6419   }
6420   assert(_markStack-&gt;isEmpty(), &quot;tautology, emphasizing post-condition&quot;);
6421 }
6422 
6423 ParMarkFromRootsClosure::ParMarkFromRootsClosure(CMSConcMarkingTask* task,
6424                        CMSCollector* collector, MemRegion span,
6425                        CMSBitMap* bit_map,
6426                        OopTaskQueue* work_queue,
6427                        CMSMarkStack*  overflow_stack):
6428   _collector(collector),
6429   _whole_span(collector-&gt;_span),
6430   _span(span),
6431   _bit_map(bit_map),
6432   _mut(&amp;collector-&gt;_modUnionTable),
6433   _work_queue(work_queue),
6434   _overflow_stack(overflow_stack),
6435   _skip_bits(0),
6436   _task(task)
6437 {
6438   assert(_work_queue-&gt;size() == 0, &quot;work_queue should be empty&quot;);
6439   _finger = span.start();
6440   _threshold = _finger;     // XXX Defer clear-on-enter optimization for now
6441   assert(_span.contains(_finger), &quot;Out of bounds _finger?&quot;);
6442 }
6443 
6444 // Should revisit to see if this should be restructured for
6445 // greater efficiency.
6446 bool ParMarkFromRootsClosure::do_bit(size_t offset) {
6447   if (_skip_bits &gt; 0) {
6448     _skip_bits--;
6449     return true;
6450   }
6451   // convert offset into a HeapWord*
6452   HeapWord* addr = _bit_map-&gt;startWord() + offset;
6453   assert(_bit_map-&gt;endWord() &amp;&amp; addr &lt; _bit_map-&gt;endWord(),
6454          &quot;address out of range&quot;);
6455   assert(_bit_map-&gt;isMarked(addr), &quot;tautology&quot;);
6456   if (_bit_map-&gt;isMarked(addr+1)) {
6457     // this is an allocated object that might not yet be initialized
6458     assert(_skip_bits == 0, &quot;tautology&quot;);
6459     _skip_bits = 2;  // skip next two marked bits (&quot;Printezis-marks&quot;)
6460     oop p = oop(addr);
6461     if (p-&gt;klass_or_null_acquire() == NULL) {
6462       // in the case of Clean-on-Enter optimization, redirty card
6463       // and avoid clearing card by increasing  the threshold.
6464       return true;
6465     }
6466   }
6467   scan_oops_in_oop(addr);
6468   return true;
6469 }
6470 
6471 void ParMarkFromRootsClosure::scan_oops_in_oop(HeapWord* ptr) {
6472   assert(_bit_map-&gt;isMarked(ptr), &quot;expected bit to be set&quot;);
6473   // Should we assert that our work queue is empty or
6474   // below some drain limit?
6475   assert(_work_queue-&gt;size() == 0,
6476          &quot;should drain stack to limit stack usage&quot;);
6477   // convert ptr to an oop preparatory to scanning
6478   oop obj = oop(ptr);
6479   // Ignore mark word in verification below, since we
6480   // may be running concurrent with mutators.
6481   assert(oopDesc::is_oop(obj, true), &quot;should be an oop&quot;);
6482   assert(_finger &lt;= ptr, &quot;_finger runneth ahead&quot;);
6483   // advance the finger to right end of this object
6484   _finger = ptr + obj-&gt;size();
6485   assert(_finger &gt; ptr, &quot;we just incremented it above&quot;);
6486   // On large heaps, it may take us some time to get through
6487   // the marking phase. During
6488   // this time it&#39;s possible that a lot of mutations have
6489   // accumulated in the card table and the mod union table --
6490   // these mutation records are redundant until we have
6491   // actually traced into the corresponding card.
6492   // Here, we check whether advancing the finger would make
6493   // us cross into a new card, and if so clear corresponding
6494   // cards in the MUT (preclean them in the card-table in the
6495   // future).
6496 
6497   // The clean-on-enter optimization is disabled by default,
6498   // until we fix 6178663.
6499   if (CMSCleanOnEnter &amp;&amp; (_finger &gt; _threshold)) {
6500     // [_threshold, _finger) represents the interval
6501     // of cards to be cleared  in MUT (or precleaned in card table).
6502     // The set of cards to be cleared is all those that overlap
6503     // with the interval [_threshold, _finger); note that
6504     // _threshold is always kept card-aligned but _finger isn&#39;t
6505     // always card-aligned.
6506     HeapWord* old_threshold = _threshold;
6507     assert(is_aligned(old_threshold, CardTable::card_size),
6508            &quot;_threshold should always be card-aligned&quot;);
6509     _threshold = align_up(_finger, CardTable::card_size);
6510     MemRegion mr(old_threshold, _threshold);
6511     assert(!mr.is_empty(), &quot;Control point invariant&quot;);
6512     assert(_span.contains(mr), &quot;Should clear within span&quot;); // _whole_span ??
6513     _mut-&gt;clear_range(mr);
6514   }
6515 
6516   // Note: the local finger doesn&#39;t advance while we drain
6517   // the stack below, but the global finger sure can and will.
6518   HeapWord* volatile* gfa = _task-&gt;global_finger_addr();
6519   ParPushOrMarkClosure pushOrMarkClosure(_collector,
6520                                          _span, _bit_map,
6521                                          _work_queue,
6522                                          _overflow_stack,
6523                                          _finger,
6524                                          gfa, this);
6525   bool res = _work_queue-&gt;push(obj);   // overflow could occur here
6526   assert(res, &quot;Will hold once we use workqueues&quot;);
6527   while (true) {
6528     oop new_oop;
6529     if (!_work_queue-&gt;pop_local(new_oop)) {
6530       // We emptied our work_queue; check if there&#39;s stuff that can
6531       // be gotten from the overflow stack.
6532       if (CMSConcMarkingTask::get_work_from_overflow_stack(
6533             _overflow_stack, _work_queue)) {
6534         do_yield_check();
6535         continue;
6536       } else {  // done
6537         break;
6538       }
6539     }
6540     // Skip verifying header mark word below because we are
6541     // running concurrent with mutators.
6542     assert(oopDesc::is_oop(new_oop, true), &quot;Oops! expected to pop an oop&quot;);
6543     // now scan this oop&#39;s oops
6544     new_oop-&gt;oop_iterate(&amp;pushOrMarkClosure);
6545     do_yield_check();
6546   }
6547   assert(_work_queue-&gt;size() == 0, &quot;tautology, emphasizing post-condition&quot;);
6548 }
6549 
6550 // Yield in response to a request from VM Thread or
6551 // from mutators.
6552 void ParMarkFromRootsClosure::do_yield_work() {
6553   assert(_task != NULL, &quot;sanity&quot;);
6554   _task-&gt;yield();
6555 }
6556 
6557 // A variant of the above used for verifying CMS marking work.
6558 MarkFromRootsVerifyClosure::MarkFromRootsVerifyClosure(CMSCollector* collector,
6559                         MemRegion span,
6560                         CMSBitMap* verification_bm, CMSBitMap* cms_bm,
6561                         CMSMarkStack*  mark_stack):
6562   _collector(collector),
6563   _span(span),
6564   _verification_bm(verification_bm),
6565   _cms_bm(cms_bm),
6566   _mark_stack(mark_stack),
6567   _pam_verify_closure(collector, span, verification_bm, cms_bm,
6568                       mark_stack)
6569 {
6570   assert(_mark_stack-&gt;isEmpty(), &quot;stack should be empty&quot;);
6571   _finger = _verification_bm-&gt;startWord();
6572   assert(_collector-&gt;_restart_addr == NULL, &quot;Sanity check&quot;);
6573   assert(_span.contains(_finger), &quot;Out of bounds _finger?&quot;);
6574 }
6575 
6576 void MarkFromRootsVerifyClosure::reset(HeapWord* addr) {
6577   assert(_mark_stack-&gt;isEmpty(), &quot;would cause duplicates on stack&quot;);
6578   assert(_span.contains(addr), &quot;Out of bounds _finger?&quot;);
6579   _finger = addr;
6580 }
6581 
6582 // Should revisit to see if this should be restructured for
6583 // greater efficiency.
6584 bool MarkFromRootsVerifyClosure::do_bit(size_t offset) {
6585   // convert offset into a HeapWord*
6586   HeapWord* addr = _verification_bm-&gt;startWord() + offset;
6587   assert(_verification_bm-&gt;endWord() &amp;&amp; addr &lt; _verification_bm-&gt;endWord(),
6588          &quot;address out of range&quot;);
6589   assert(_verification_bm-&gt;isMarked(addr), &quot;tautology&quot;);
6590   assert(_cms_bm-&gt;isMarked(addr), &quot;tautology&quot;);
6591 
6592   assert(_mark_stack-&gt;isEmpty(),
6593          &quot;should drain stack to limit stack usage&quot;);
6594   // convert addr to an oop preparatory to scanning
6595   oop obj = oop(addr);
6596   assert(oopDesc::is_oop(obj), &quot;should be an oop&quot;);
6597   assert(_finger &lt;= addr, &quot;_finger runneth ahead&quot;);
6598   // advance the finger to right end of this object
6599   _finger = addr + obj-&gt;size();
6600   assert(_finger &gt; addr, &quot;we just incremented it above&quot;);
6601   // Note: the finger doesn&#39;t advance while we drain
6602   // the stack below.
6603   bool res = _mark_stack-&gt;push(obj);
6604   assert(res, &quot;Empty non-zero size stack should have space for single push&quot;);
6605   while (!_mark_stack-&gt;isEmpty()) {
6606     oop new_oop = _mark_stack-&gt;pop();
6607     assert(oopDesc::is_oop(new_oop), &quot;Oops! expected to pop an oop&quot;);
6608     // now scan this oop&#39;s oops
6609     new_oop-&gt;oop_iterate(&amp;_pam_verify_closure);
6610   }
6611   assert(_mark_stack-&gt;isEmpty(), &quot;tautology, emphasizing post-condition&quot;);
6612   return true;
6613 }
6614 
6615 PushAndMarkVerifyClosure::PushAndMarkVerifyClosure(
6616   CMSCollector* collector, MemRegion span,
6617   CMSBitMap* verification_bm, CMSBitMap* cms_bm,
6618   CMSMarkStack*  mark_stack):
6619   MetadataVisitingOopIterateClosure(collector-&gt;ref_processor()),
6620   _collector(collector),
6621   _span(span),
6622   _verification_bm(verification_bm),
6623   _cms_bm(cms_bm),
6624   _mark_stack(mark_stack)
6625 { }
6626 
6627 template &lt;class T&gt; void PushAndMarkVerifyClosure::do_oop_work(T *p) {
6628   oop obj = RawAccess&lt;&gt;::oop_load(p);
6629   do_oop(obj);
6630 }
6631 
6632 void PushAndMarkVerifyClosure::do_oop(oop* p)       { PushAndMarkVerifyClosure::do_oop_work(p); }
6633 void PushAndMarkVerifyClosure::do_oop(narrowOop* p) { PushAndMarkVerifyClosure::do_oop_work(p); }
6634 
6635 // Upon stack overflow, we discard (part of) the stack,
6636 // remembering the least address amongst those discarded
6637 // in CMSCollector&#39;s _restart_address.
6638 void PushAndMarkVerifyClosure::handle_stack_overflow(HeapWord* lost) {
6639   // Remember the least grey address discarded
6640   HeapWord* ra = (HeapWord*)_mark_stack-&gt;least_value(lost);
6641   _collector-&gt;lower_restart_addr(ra);
6642   _mark_stack-&gt;reset();  // discard stack contents
6643   _mark_stack-&gt;expand(); // expand the stack if possible
6644 }
6645 
6646 void PushAndMarkVerifyClosure::do_oop(oop obj) {
6647   assert(oopDesc::is_oop_or_null(obj), &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
6648   HeapWord* addr = (HeapWord*)obj;
6649   if (_span.contains(addr) &amp;&amp; !_verification_bm-&gt;isMarked(addr)) {
6650     // Oop lies in _span and isn&#39;t yet grey or black
6651     _verification_bm-&gt;mark(addr);            // now grey
6652     if (!_cms_bm-&gt;isMarked(addr)) {
6653       Log(gc, verify) log;
6654       ResourceMark rm;
6655       LogStream ls(log.error());
6656       oop(addr)-&gt;print_on(&amp;ls);
6657       log.error(&quot; (&quot; INTPTR_FORMAT &quot; should have been marked)&quot;, p2i(addr));
6658       fatal(&quot;... aborting&quot;);
6659     }
6660 
6661     if (!_mark_stack-&gt;push(obj)) { // stack overflow
6662       log_trace(gc)(&quot;CMS marking stack overflow (benign) at &quot; SIZE_FORMAT, _mark_stack-&gt;capacity());
6663       assert(_mark_stack-&gt;isFull(), &quot;Else push should have succeeded&quot;);
6664       handle_stack_overflow(addr);
6665     }
6666     // anything including and to the right of _finger
6667     // will be scanned as we iterate over the remainder of the
6668     // bit map
6669   }
6670 }
6671 
6672 PushOrMarkClosure::PushOrMarkClosure(CMSCollector* collector,
6673                      MemRegion span,
6674                      CMSBitMap* bitMap, CMSMarkStack*  markStack,
6675                      HeapWord* finger, MarkFromRootsClosure* parent) :
6676   MetadataVisitingOopIterateClosure(collector-&gt;ref_processor()),
6677   _collector(collector),
6678   _span(span),
6679   _bitMap(bitMap),
6680   _markStack(markStack),
6681   _finger(finger),
6682   _parent(parent)
6683 { }
6684 
6685 ParPushOrMarkClosure::ParPushOrMarkClosure(CMSCollector* collector,
6686                                            MemRegion span,
6687                                            CMSBitMap* bit_map,
6688                                            OopTaskQueue* work_queue,
6689                                            CMSMarkStack*  overflow_stack,
6690                                            HeapWord* finger,
6691                                            HeapWord* volatile* global_finger_addr,
6692                                            ParMarkFromRootsClosure* parent) :
6693   MetadataVisitingOopIterateClosure(collector-&gt;ref_processor()),
6694   _collector(collector),
6695   _whole_span(collector-&gt;_span),
6696   _span(span),
6697   _bit_map(bit_map),
6698   _work_queue(work_queue),
6699   _overflow_stack(overflow_stack),
6700   _finger(finger),
6701   _global_finger_addr(global_finger_addr),
6702   _parent(parent)
6703 { }
6704 
6705 // Assumes thread-safe access by callers, who are
6706 // responsible for mutual exclusion.
6707 void CMSCollector::lower_restart_addr(HeapWord* low) {
6708   assert(_span.contains(low), &quot;Out of bounds addr&quot;);
6709   if (_restart_addr == NULL) {
6710     _restart_addr = low;
6711   } else {
6712     _restart_addr = MIN2(_restart_addr, low);
6713   }
6714 }
6715 
6716 // Upon stack overflow, we discard (part of) the stack,
6717 // remembering the least address amongst those discarded
6718 // in CMSCollector&#39;s _restart_address.
6719 void PushOrMarkClosure::handle_stack_overflow(HeapWord* lost) {
6720   // Remember the least grey address discarded
6721   HeapWord* ra = (HeapWord*)_markStack-&gt;least_value(lost);
6722   _collector-&gt;lower_restart_addr(ra);
6723   _markStack-&gt;reset();  // discard stack contents
6724   _markStack-&gt;expand(); // expand the stack if possible
6725 }
6726 
6727 // Upon stack overflow, we discard (part of) the stack,
6728 // remembering the least address amongst those discarded
6729 // in CMSCollector&#39;s _restart_address.
6730 void ParPushOrMarkClosure::handle_stack_overflow(HeapWord* lost) {
6731   // We need to do this under a mutex to prevent other
6732   // workers from interfering with the work done below.
6733   MutexLockerEx ml(_overflow_stack-&gt;par_lock(),
6734                    Mutex::_no_safepoint_check_flag);
6735   // Remember the least grey address discarded
6736   HeapWord* ra = (HeapWord*)_overflow_stack-&gt;least_value(lost);
6737   _collector-&gt;lower_restart_addr(ra);
6738   _overflow_stack-&gt;reset();  // discard stack contents
6739   _overflow_stack-&gt;expand(); // expand the stack if possible
6740 }
6741 
6742 void PushOrMarkClosure::do_oop(oop obj) {
6743   // Ignore mark word because we are running concurrent with mutators.
6744   assert(oopDesc::is_oop_or_null(obj, true), &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
6745   HeapWord* addr = (HeapWord*)obj;
6746   if (_span.contains(addr) &amp;&amp; !_bitMap-&gt;isMarked(addr)) {
6747     // Oop lies in _span and isn&#39;t yet grey or black
6748     _bitMap-&gt;mark(addr);            // now grey
6749     if (addr &lt; _finger) {
6750       // the bit map iteration has already either passed, or
6751       // sampled, this bit in the bit map; we&#39;ll need to
6752       // use the marking stack to scan this oop&#39;s oops.
6753       bool simulate_overflow = false;
6754       NOT_PRODUCT(
6755         if (CMSMarkStackOverflowALot &amp;&amp;
6756             _collector-&gt;simulate_overflow()) {
6757           // simulate a stack overflow
6758           simulate_overflow = true;
6759         }
6760       )
6761       if (simulate_overflow || !_markStack-&gt;push(obj)) { // stack overflow
6762         log_trace(gc)(&quot;CMS marking stack overflow (benign) at &quot; SIZE_FORMAT, _markStack-&gt;capacity());
6763         assert(simulate_overflow || _markStack-&gt;isFull(), &quot;Else push should have succeeded&quot;);
6764         handle_stack_overflow(addr);
6765       }
6766     }
6767     // anything including and to the right of _finger
6768     // will be scanned as we iterate over the remainder of the
6769     // bit map
6770     do_yield_check();
6771   }
6772 }
6773 
6774 void ParPushOrMarkClosure::do_oop(oop obj) {
6775   // Ignore mark word because we are running concurrent with mutators.
6776   assert(oopDesc::is_oop_or_null(obj, true), &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
6777   HeapWord* addr = (HeapWord*)obj;
6778   if (_whole_span.contains(addr) &amp;&amp; !_bit_map-&gt;isMarked(addr)) {
6779     // Oop lies in _span and isn&#39;t yet grey or black
6780     // We read the global_finger (volatile read) strictly after marking oop
6781     bool res = _bit_map-&gt;par_mark(addr);    // now grey
6782     volatile HeapWord** gfa = (volatile HeapWord**)_global_finger_addr;
6783     // Should we push this marked oop on our stack?
6784     // -- if someone else marked it, nothing to do
6785     // -- if target oop is above global finger nothing to do
6786     // -- if target oop is in chunk and above local finger
6787     //      then nothing to do
6788     // -- else push on work queue
6789     if (   !res       // someone else marked it, they will deal with it
6790         || (addr &gt;= *gfa)  // will be scanned in a later task
6791         || (_span.contains(addr) &amp;&amp; addr &gt;= _finger)) { // later in this chunk
6792       return;
6793     }
6794     // the bit map iteration has already either passed, or
6795     // sampled, this bit in the bit map; we&#39;ll need to
6796     // use the marking stack to scan this oop&#39;s oops.
6797     bool simulate_overflow = false;
6798     NOT_PRODUCT(
6799       if (CMSMarkStackOverflowALot &amp;&amp;
6800           _collector-&gt;simulate_overflow()) {
6801         // simulate a stack overflow
6802         simulate_overflow = true;
6803       }
6804     )
6805     if (simulate_overflow ||
6806         !(_work_queue-&gt;push(obj) || _overflow_stack-&gt;par_push(obj))) {
6807       // stack overflow
6808       log_trace(gc)(&quot;CMS marking stack overflow (benign) at &quot; SIZE_FORMAT, _overflow_stack-&gt;capacity());
6809       // We cannot assert that the overflow stack is full because
6810       // it may have been emptied since.
6811       assert(simulate_overflow ||
6812              _work_queue-&gt;size() == _work_queue-&gt;max_elems(),
6813             &quot;Else push should have succeeded&quot;);
6814       handle_stack_overflow(addr);
6815     }
6816     do_yield_check();
6817   }
6818 }
6819 
6820 PushAndMarkClosure::PushAndMarkClosure(CMSCollector* collector,
6821                                        MemRegion span,
6822                                        ReferenceDiscoverer* rd,
6823                                        CMSBitMap* bit_map,
6824                                        CMSBitMap* mod_union_table,
6825                                        CMSMarkStack*  mark_stack,
6826                                        bool           concurrent_precleaning):
6827   MetadataVisitingOopIterateClosure(rd),
6828   _collector(collector),
6829   _span(span),
6830   _bit_map(bit_map),
6831   _mod_union_table(mod_union_table),
6832   _mark_stack(mark_stack),
6833   _concurrent_precleaning(concurrent_precleaning)
6834 {
6835   assert(ref_discoverer() != NULL, &quot;ref_discoverer shouldn&#39;t be NULL&quot;);
6836 }
6837 
6838 // Grey object rescan during pre-cleaning and second checkpoint phases --
6839 // the non-parallel version (the parallel version appears further below.)
6840 void PushAndMarkClosure::do_oop(oop obj) {
6841   // Ignore mark word verification. If during concurrent precleaning,
6842   // the object monitor may be locked. If during the checkpoint
6843   // phases, the object may already have been reached by a  different
6844   // path and may be at the end of the global overflow list (so
6845   // the mark word may be NULL).
6846   assert(oopDesc::is_oop_or_null(obj, true /* ignore mark word */),
6847          &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
6848   HeapWord* addr = (HeapWord*)obj;
6849   // Check if oop points into the CMS generation
6850   // and is not marked
6851   if (_span.contains(addr) &amp;&amp; !_bit_map-&gt;isMarked(addr)) {
6852     // a white object ...
6853     _bit_map-&gt;mark(addr);         // ... now grey
6854     // push on the marking stack (grey set)
6855     bool simulate_overflow = false;
6856     NOT_PRODUCT(
6857       if (CMSMarkStackOverflowALot &amp;&amp;
6858           _collector-&gt;simulate_overflow()) {
6859         // simulate a stack overflow
6860         simulate_overflow = true;
6861       }
6862     )
6863     if (simulate_overflow || !_mark_stack-&gt;push(obj)) {
6864       if (_concurrent_precleaning) {
6865          // During precleaning we can just dirty the appropriate card(s)
6866          // in the mod union table, thus ensuring that the object remains
6867          // in the grey set  and continue. In the case of object arrays
6868          // we need to dirty all of the cards that the object spans,
6869          // since the rescan of object arrays will be limited to the
6870          // dirty cards.
6871          // Note that no one can be interfering with us in this action
6872          // of dirtying the mod union table, so no locking or atomics
6873          // are required.
6874          if (obj-&gt;is_objArray()) {
6875            size_t sz = obj-&gt;size();
6876            HeapWord* end_card_addr = align_up(addr + sz, CardTable::card_size);
6877            MemRegion redirty_range = MemRegion(addr, end_card_addr);
6878            assert(!redirty_range.is_empty(), &quot;Arithmetical tautology&quot;);
6879            _mod_union_table-&gt;mark_range(redirty_range);
6880          } else {
6881            _mod_union_table-&gt;mark(addr);
6882          }
6883          _collector-&gt;_ser_pmc_preclean_ovflw++;
6884       } else {
6885          // During the remark phase, we need to remember this oop
6886          // in the overflow list.
6887          _collector-&gt;push_on_overflow_list(obj);
6888          _collector-&gt;_ser_pmc_remark_ovflw++;
6889       }
6890     }
6891   }
6892 }
6893 
6894 ParPushAndMarkClosure::ParPushAndMarkClosure(CMSCollector* collector,
6895                                              MemRegion span,
6896                                              ReferenceDiscoverer* rd,
6897                                              CMSBitMap* bit_map,
6898                                              OopTaskQueue* work_queue):
6899   MetadataVisitingOopIterateClosure(rd),
6900   _collector(collector),
6901   _span(span),
6902   _bit_map(bit_map),
6903   _work_queue(work_queue)
6904 {
6905   assert(ref_discoverer() != NULL, &quot;ref_discoverer shouldn&#39;t be NULL&quot;);
6906 }
6907 
6908 // Grey object rescan during second checkpoint phase --
6909 // the parallel version.
6910 void ParPushAndMarkClosure::do_oop(oop obj) {
6911   // In the assert below, we ignore the mark word because
6912   // this oop may point to an already visited object that is
6913   // on the overflow stack (in which case the mark word has
6914   // been hijacked for chaining into the overflow stack --
6915   // if this is the last object in the overflow stack then
6916   // its mark word will be NULL). Because this object may
6917   // have been subsequently popped off the global overflow
6918   // stack, and the mark word possibly restored to the prototypical
6919   // value, by the time we get to examined this failing assert in
6920   // the debugger, is_oop_or_null(false) may subsequently start
6921   // to hold.
6922   assert(oopDesc::is_oop_or_null(obj, true),
6923          &quot;Expected an oop or NULL at &quot; PTR_FORMAT, p2i(obj));
6924   HeapWord* addr = (HeapWord*)obj;
6925   // Check if oop points into the CMS generation
6926   // and is not marked
6927   if (_span.contains(addr) &amp;&amp; !_bit_map-&gt;isMarked(addr)) {
6928     // a white object ...
6929     // If we manage to &quot;claim&quot; the object, by being the
6930     // first thread to mark it, then we push it on our
6931     // marking stack
6932     if (_bit_map-&gt;par_mark(addr)) {     // ... now grey
6933       // push on work queue (grey set)
6934       bool simulate_overflow = false;
6935       NOT_PRODUCT(
6936         if (CMSMarkStackOverflowALot &amp;&amp;
6937             _collector-&gt;par_simulate_overflow()) {
6938           // simulate a stack overflow
6939           simulate_overflow = true;
6940         }
6941       )
6942       if (simulate_overflow || !_work_queue-&gt;push(obj)) {
6943         _collector-&gt;par_push_on_overflow_list(obj);
6944         _collector-&gt;_par_pmc_remark_ovflw++; //  imprecise OK: no need to CAS
6945       }
6946     } // Else, some other thread got there first
6947   }
6948 }
6949 
6950 void CMSPrecleanRefsYieldClosure::do_yield_work() {
6951   Mutex* bml = _collector-&gt;bitMapLock();
6952   assert_lock_strong(bml);
6953   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
6954          &quot;CMS thread should hold CMS token&quot;);
6955 
6956   bml-&gt;unlock();
6957   ConcurrentMarkSweepThread::desynchronize(true);
6958 
6959   _collector-&gt;stopTimer();
6960   _collector-&gt;incrementYields();
6961 
6962   // See the comment in coordinator_yield()
6963   for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
6964                        ConcurrentMarkSweepThread::should_yield() &amp;&amp;
6965                        !CMSCollector::foregroundGCIsActive(); ++i) {
6966     os::sleep(Thread::current(), 1, false);
6967   }
6968 
6969   ConcurrentMarkSweepThread::synchronize(true);
6970   bml-&gt;lock();
6971 
6972   _collector-&gt;startTimer();
6973 }
6974 
6975 bool CMSPrecleanRefsYieldClosure::should_return() {
6976   if (ConcurrentMarkSweepThread::should_yield()) {
6977     do_yield_work();
6978   }
6979   return _collector-&gt;foregroundGCIsActive();
6980 }
6981 
6982 void MarkFromDirtyCardsClosure::do_MemRegion(MemRegion mr) {
6983   assert(((size_t)mr.start())%CardTable::card_size_in_words == 0,
6984          &quot;mr should be aligned to start at a card boundary&quot;);
6985   // We&#39;d like to assert:
6986   // assert(mr.word_size()%CardTable::card_size_in_words == 0,
6987   //        &quot;mr should be a range of cards&quot;);
6988   // However, that would be too strong in one case -- the last
6989   // partition ends at _unallocated_block which, in general, can be
6990   // an arbitrary boundary, not necessarily card aligned.
6991   _num_dirty_cards += mr.word_size()/CardTable::card_size_in_words;
6992   _space-&gt;object_iterate_mem(mr, &amp;_scan_cl);
6993 }
6994 
6995 SweepClosure::SweepClosure(CMSCollector* collector,
6996                            ConcurrentMarkSweepGeneration* g,
6997                            CMSBitMap* bitMap, bool should_yield) :
6998   _collector(collector),
6999   _g(g),
7000   _sp(g-&gt;cmsSpace()),
7001   _limit(_sp-&gt;sweep_limit()),
7002   _freelistLock(_sp-&gt;freelistLock()),
7003   _bitMap(bitMap),
7004   _inFreeRange(false),           // No free range at beginning of sweep
7005   _freeRangeInFreeLists(false),  // No free range at beginning of sweep
7006   _lastFreeRangeCoalesced(false),
7007   _yield(should_yield),
7008   _freeFinger(g-&gt;used_region().start())
7009 {
7010   NOT_PRODUCT(
7011     _numObjectsFreed = 0;
7012     _numWordsFreed   = 0;
7013     _numObjectsLive = 0;
7014     _numWordsLive = 0;
7015     _numObjectsAlreadyFree = 0;
7016     _numWordsAlreadyFree = 0;
7017     _last_fc = NULL;
7018 
7019     _sp-&gt;initializeIndexedFreeListArrayReturnedBytes();
7020     _sp-&gt;dictionary()-&gt;initialize_dict_returned_bytes();
7021   )
7022   assert(_limit &gt;= _sp-&gt;bottom() &amp;&amp; _limit &lt;= _sp-&gt;end(),
7023          &quot;sweep _limit out of bounds&quot;);
7024   log_develop_trace(gc, sweep)(&quot;====================&quot;);
7025   log_develop_trace(gc, sweep)(&quot;Starting new sweep with limit &quot; PTR_FORMAT, p2i(_limit));
7026 }
7027 
7028 void SweepClosure::print_on(outputStream* st) const {
7029   st-&gt;print_cr(&quot;_sp = [&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;,
7030                p2i(_sp-&gt;bottom()), p2i(_sp-&gt;end()));
7031   st-&gt;print_cr(&quot;_limit = &quot; PTR_FORMAT, p2i(_limit));
7032   st-&gt;print_cr(&quot;_freeFinger = &quot; PTR_FORMAT, p2i(_freeFinger));
7033   NOT_PRODUCT(st-&gt;print_cr(&quot;_last_fc = &quot; PTR_FORMAT, p2i(_last_fc));)
7034   st-&gt;print_cr(&quot;_inFreeRange = %d, _freeRangeInFreeLists = %d, _lastFreeRangeCoalesced = %d&quot;,
7035                _inFreeRange, _freeRangeInFreeLists, _lastFreeRangeCoalesced);
7036 }
7037 
7038 #ifndef PRODUCT
7039 // Assertion checking only:  no useful work in product mode --
7040 // however, if any of the flags below become product flags,
7041 // you may need to review this code to see if it needs to be
7042 // enabled in product mode.
7043 SweepClosure::~SweepClosure() {
7044   assert_lock_strong(_freelistLock);
7045   assert(_limit &gt;= _sp-&gt;bottom() &amp;&amp; _limit &lt;= _sp-&gt;end(),
7046          &quot;sweep _limit out of bounds&quot;);
7047   if (inFreeRange()) {
7048     Log(gc, sweep) log;
7049     log.error(&quot;inFreeRange() should have been reset; dumping state of SweepClosure&quot;);
7050     ResourceMark rm;
7051     LogStream ls(log.error());
7052     print_on(&amp;ls);
7053     ShouldNotReachHere();
7054   }
7055 
7056   if (log_is_enabled(Debug, gc, sweep)) {
7057     log_debug(gc, sweep)(&quot;Collected &quot; SIZE_FORMAT &quot; objects, &quot; SIZE_FORMAT &quot; bytes&quot;,
7058                          _numObjectsFreed, _numWordsFreed*sizeof(HeapWord));
7059     log_debug(gc, sweep)(&quot;Live &quot; SIZE_FORMAT &quot; objects,  &quot; SIZE_FORMAT &quot; bytes  Already free &quot; SIZE_FORMAT &quot; objects, &quot; SIZE_FORMAT &quot; bytes&quot;,
7060                          _numObjectsLive, _numWordsLive*sizeof(HeapWord), _numObjectsAlreadyFree, _numWordsAlreadyFree*sizeof(HeapWord));
7061     size_t totalBytes = (_numWordsFreed + _numWordsLive + _numWordsAlreadyFree) * sizeof(HeapWord);
7062     log_debug(gc, sweep)(&quot;Total sweep: &quot; SIZE_FORMAT &quot; bytes&quot;, totalBytes);
7063   }
7064 
7065   if (log_is_enabled(Trace, gc, sweep) &amp;&amp; CMSVerifyReturnedBytes) {
7066     size_t indexListReturnedBytes = _sp-&gt;sumIndexedFreeListArrayReturnedBytes();
7067     size_t dict_returned_bytes = _sp-&gt;dictionary()-&gt;sum_dict_returned_bytes();
7068     size_t returned_bytes = indexListReturnedBytes + dict_returned_bytes;
7069     log_trace(gc, sweep)(&quot;Returned &quot; SIZE_FORMAT &quot; bytes   Indexed List Returned &quot; SIZE_FORMAT &quot; bytes        Dictionary Returned &quot; SIZE_FORMAT &quot; bytes&quot;,
7070                          returned_bytes, indexListReturnedBytes, dict_returned_bytes);
7071   }
7072   log_develop_trace(gc, sweep)(&quot;end of sweep with _limit = &quot; PTR_FORMAT, p2i(_limit));
7073   log_develop_trace(gc, sweep)(&quot;================&quot;);
7074 }
7075 #endif  // PRODUCT
7076 
7077 void SweepClosure::initialize_free_range(HeapWord* freeFinger,
7078     bool freeRangeInFreeLists) {
7079   log_develop_trace(gc, sweep)(&quot;---- Start free range at &quot; PTR_FORMAT &quot; with free block (%d)&quot;,
7080                                p2i(freeFinger), freeRangeInFreeLists);
7081   assert(!inFreeRange(), &quot;Trampling existing free range&quot;);
7082   set_inFreeRange(true);
7083   set_lastFreeRangeCoalesced(false);
7084 
7085   set_freeFinger(freeFinger);
7086   set_freeRangeInFreeLists(freeRangeInFreeLists);
7087   if (CMSTestInFreeList) {
7088     if (freeRangeInFreeLists) {
7089       FreeChunk* fc = (FreeChunk*) freeFinger;
7090       assert(fc-&gt;is_free(), &quot;A chunk on the free list should be free.&quot;);
7091       assert(fc-&gt;size() &gt; 0, &quot;Free range should have a size&quot;);
7092       assert(_sp-&gt;verify_chunk_in_free_list(fc), &quot;Chunk is not in free lists&quot;);
7093     }
7094   }
7095 }
7096 
7097 // Note that the sweeper runs concurrently with mutators. Thus,
7098 // it is possible for direct allocation in this generation to happen
7099 // in the middle of the sweep. Note that the sweeper also coalesces
7100 // contiguous free blocks. Thus, unless the sweeper and the allocator
7101 // synchronize appropriately freshly allocated blocks may get swept up.
7102 // This is accomplished by the sweeper locking the free lists while
7103 // it is sweeping. Thus blocks that are determined to be free are
7104 // indeed free. There is however one additional complication:
7105 // blocks that have been allocated since the final checkpoint and
7106 // mark, will not have been marked and so would be treated as
7107 // unreachable and swept up. To prevent this, the allocator marks
7108 // the bit map when allocating during the sweep phase. This leads,
7109 // however, to a further complication -- objects may have been allocated
7110 // but not yet initialized -- in the sense that the header isn&#39;t yet
7111 // installed. The sweeper can not then determine the size of the block
7112 // in order to skip over it. To deal with this case, we use a technique
7113 // (due to Printezis) to encode such uninitialized block sizes in the
7114 // bit map. Since the bit map uses a bit per every HeapWord, but the
7115 // CMS generation has a minimum object size of 3 HeapWords, it follows
7116 // that &quot;normal marks&quot; won&#39;t be adjacent in the bit map (there will
7117 // always be at least two 0 bits between successive 1 bits). We make use
7118 // of these &quot;unused&quot; bits to represent uninitialized blocks -- the bit
7119 // corresponding to the start of the uninitialized object and the next
7120 // bit are both set. Finally, a 1 bit marks the end of the object that
7121 // started with the two consecutive 1 bits to indicate its potentially
7122 // uninitialized state.
7123 
7124 size_t SweepClosure::do_blk_careful(HeapWord* addr) {
7125   FreeChunk* fc = (FreeChunk*)addr;
7126   size_t res;
7127 
7128   // Check if we are done sweeping. Below we check &quot;addr &gt;= _limit&quot; rather
7129   // than &quot;addr == _limit&quot; because although _limit was a block boundary when
7130   // we started the sweep, it may no longer be one because heap expansion
7131   // may have caused us to coalesce the block ending at the address _limit
7132   // with a newly expanded chunk (this happens when _limit was set to the
7133   // previous _end of the space), so we may have stepped past _limit:
7134   // see the following Zeno-like trail of CRs 6977970, 7008136, 7042740.
7135   if (addr &gt;= _limit) { // we have swept up to or past the limit: finish up
7136     assert(_limit &gt;= _sp-&gt;bottom() &amp;&amp; _limit &lt;= _sp-&gt;end(),
7137            &quot;sweep _limit out of bounds&quot;);
7138     assert(addr &lt; _sp-&gt;end(), &quot;addr out of bounds&quot;);
7139     // Flush any free range we might be holding as a single
7140     // coalesced chunk to the appropriate free list.
7141     if (inFreeRange()) {
7142       assert(freeFinger() &gt;= _sp-&gt;bottom() &amp;&amp; freeFinger() &lt; _limit,
7143              &quot;freeFinger() &quot; PTR_FORMAT &quot; is out of bounds&quot;, p2i(freeFinger()));
7144       flush_cur_free_chunk(freeFinger(),
7145                            pointer_delta(addr, freeFinger()));
7146       log_develop_trace(gc, sweep)(&quot;Sweep: last chunk: put_free_blk &quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;) [coalesced:%d]&quot;,
7147                                    p2i(freeFinger()), pointer_delta(addr, freeFinger()),
7148                                    lastFreeRangeCoalesced() ? 1 : 0);
7149     }
7150 
7151     // help the iterator loop finish
7152     return pointer_delta(_sp-&gt;end(), addr);
7153   }
7154 
7155   assert(addr &lt; _limit, &quot;sweep invariant&quot;);
7156   // check if we should yield
7157   do_yield_check(addr);
7158   if (fc-&gt;is_free()) {
7159     // Chunk that is already free
7160     res = fc-&gt;size();
7161     do_already_free_chunk(fc);
7162     debug_only(_sp-&gt;verifyFreeLists());
7163     // If we flush the chunk at hand in lookahead_and_flush()
7164     // and it&#39;s coalesced with a preceding chunk, then the
7165     // process of &quot;mangling&quot; the payload of the coalesced block
7166     // will cause erasure of the size information from the
7167     // (erstwhile) header of all the coalesced blocks but the
7168     // first, so the first disjunct in the assert will not hold
7169     // in that specific case (in which case the second disjunct
7170     // will hold).
7171     assert(res == fc-&gt;size() || ((HeapWord*)fc) + res &gt;= _limit,
7172            &quot;Otherwise the size info doesn&#39;t change at this step&quot;);
7173     NOT_PRODUCT(
7174       _numObjectsAlreadyFree++;
7175       _numWordsAlreadyFree += res;
7176     )
7177     NOT_PRODUCT(_last_fc = fc;)
7178   } else if (!_bitMap-&gt;isMarked(addr)) {
7179     // Chunk is fresh garbage
7180     res = do_garbage_chunk(fc);
7181     debug_only(_sp-&gt;verifyFreeLists());
7182     NOT_PRODUCT(
7183       _numObjectsFreed++;
7184       _numWordsFreed += res;
7185     )
7186   } else {
7187     // Chunk that is alive.
7188     res = do_live_chunk(fc);
7189     debug_only(_sp-&gt;verifyFreeLists());
7190     NOT_PRODUCT(
7191         _numObjectsLive++;
7192         _numWordsLive += res;
7193     )
7194   }
7195   return res;
7196 }
7197 
7198 // For the smart allocation, record following
7199 //  split deaths - a free chunk is removed from its free list because
7200 //      it is being split into two or more chunks.
7201 //  split birth - a free chunk is being added to its free list because
7202 //      a larger free chunk has been split and resulted in this free chunk.
7203 //  coal death - a free chunk is being removed from its free list because
7204 //      it is being coalesced into a large free chunk.
7205 //  coal birth - a free chunk is being added to its free list because
7206 //      it was created when two or more free chunks where coalesced into
7207 //      this free chunk.
7208 //
7209 // These statistics are used to determine the desired number of free
7210 // chunks of a given size.  The desired number is chosen to be relative
7211 // to the end of a CMS sweep.  The desired number at the end of a sweep
7212 // is the
7213 //      count-at-end-of-previous-sweep (an amount that was enough)
7214 //              - count-at-beginning-of-current-sweep  (the excess)
7215 //              + split-births  (gains in this size during interval)
7216 //              - split-deaths  (demands on this size during interval)
7217 // where the interval is from the end of one sweep to the end of the
7218 // next.
7219 //
7220 // When sweeping the sweeper maintains an accumulated chunk which is
7221 // the chunk that is made up of chunks that have been coalesced.  That
7222 // will be termed the left-hand chunk.  A new chunk of garbage that
7223 // is being considered for coalescing will be referred to as the
7224 // right-hand chunk.
7225 //
7226 // When making a decision on whether to coalesce a right-hand chunk with
7227 // the current left-hand chunk, the current count vs. the desired count
7228 // of the left-hand chunk is considered.  Also if the right-hand chunk
7229 // is near the large chunk at the end of the heap (see
7230 // ConcurrentMarkSweepGeneration::isNearLargestChunk()), then the
7231 // left-hand chunk is coalesced.
7232 //
7233 // When making a decision about whether to split a chunk, the desired count
7234 // vs. the current count of the candidate to be split is also considered.
7235 // If the candidate is underpopulated (currently fewer chunks than desired)
7236 // a chunk of an overpopulated (currently more chunks than desired) size may
7237 // be chosen.  The &quot;hint&quot; associated with a free list, if non-null, points
7238 // to a free list which may be overpopulated.
7239 //
7240 
7241 void SweepClosure::do_already_free_chunk(FreeChunk* fc) {
7242   const size_t size = fc-&gt;size();
7243   // Chunks that cannot be coalesced are not in the
7244   // free lists.
7245   if (CMSTestInFreeList &amp;&amp; !fc-&gt;cantCoalesce()) {
7246     assert(_sp-&gt;verify_chunk_in_free_list(fc),
7247            &quot;free chunk should be in free lists&quot;);
7248   }
7249   // a chunk that is already free, should not have been
7250   // marked in the bit map
7251   HeapWord* const addr = (HeapWord*) fc;
7252   assert(!_bitMap-&gt;isMarked(addr), &quot;free chunk should be unmarked&quot;);
7253   // Verify that the bit map has no bits marked between
7254   // addr and purported end of this block.
7255   _bitMap-&gt;verifyNoOneBitsInRange(addr + 1, addr + size);
7256 
7257   // Some chunks cannot be coalesced under any circumstances.
7258   // See the definition of cantCoalesce().
7259   if (!fc-&gt;cantCoalesce()) {
7260     // This chunk can potentially be coalesced.
7261     // All the work is done in
7262     do_post_free_or_garbage_chunk(fc, size);
7263     // Note that if the chunk is not coalescable (the else arm
7264     // below), we unconditionally flush, without needing to do
7265     // a &quot;lookahead,&quot; as we do below.
7266     if (inFreeRange()) lookahead_and_flush(fc, size);
7267   } else {
7268     // Code path common to both original and adaptive free lists.
7269 
7270     // cant coalesce with previous block; this should be treated
7271     // as the end of a free run if any
7272     if (inFreeRange()) {
7273       // we kicked some butt; time to pick up the garbage
7274       assert(freeFinger() &lt; addr, &quot;freeFinger points too high&quot;);
7275       flush_cur_free_chunk(freeFinger(), pointer_delta(addr, freeFinger()));
7276     }
7277     // else, nothing to do, just continue
7278   }
7279 }
7280 
7281 size_t SweepClosure::do_garbage_chunk(FreeChunk* fc) {
7282   // This is a chunk of garbage.  It is not in any free list.
7283   // Add it to a free list or let it possibly be coalesced into
7284   // a larger chunk.
7285   HeapWord* const addr = (HeapWord*) fc;
7286   const size_t size = CompactibleFreeListSpace::adjustObjectSize(oop(addr)-&gt;size());
7287 
7288   // Verify that the bit map has no bits marked between
7289   // addr and purported end of just dead object.
7290   _bitMap-&gt;verifyNoOneBitsInRange(addr + 1, addr + size);
7291   do_post_free_or_garbage_chunk(fc, size);
7292 
7293   assert(_limit &gt;= addr + size,
7294          &quot;A freshly garbage chunk can&#39;t possibly straddle over _limit&quot;);
7295   if (inFreeRange()) lookahead_and_flush(fc, size);
7296   return size;
7297 }
7298 
7299 size_t SweepClosure::do_live_chunk(FreeChunk* fc) {
7300   HeapWord* addr = (HeapWord*) fc;
7301   // The sweeper has just found a live object. Return any accumulated
7302   // left hand chunk to the free lists.
7303   if (inFreeRange()) {
7304     assert(freeFinger() &lt; addr, &quot;freeFinger points too high&quot;);
7305     flush_cur_free_chunk(freeFinger(), pointer_delta(addr, freeFinger()));
7306   }
7307 
7308   // This object is live: we&#39;d normally expect this to be
7309   // an oop, and like to assert the following:
7310   // assert(oopDesc::is_oop(oop(addr)), &quot;live block should be an oop&quot;);
7311   // However, as we commented above, this may be an object whose
7312   // header hasn&#39;t yet been initialized.
7313   size_t size;
7314   assert(_bitMap-&gt;isMarked(addr), &quot;Tautology for this control point&quot;);
7315   if (_bitMap-&gt;isMarked(addr + 1)) {
7316     // Determine the size from the bit map, rather than trying to
7317     // compute it from the object header.
7318     HeapWord* nextOneAddr = _bitMap-&gt;getNextMarkedWordAddress(addr + 2);
7319     size = pointer_delta(nextOneAddr + 1, addr);
7320     assert(size == CompactibleFreeListSpace::adjustObjectSize(size),
7321            &quot;alignment problem&quot;);
7322 
7323 #ifdef ASSERT
7324       if (oop(addr)-&gt;klass_or_null_acquire() != NULL) {
7325         // Ignore mark word because we are running concurrent with mutators
7326         assert(oopDesc::is_oop(oop(addr), true), &quot;live block should be an oop&quot;);
7327         assert(size ==
7328                CompactibleFreeListSpace::adjustObjectSize(oop(addr)-&gt;size()),
7329                &quot;P-mark and computed size do not agree&quot;);
7330       }
7331 #endif
7332 
7333   } else {
7334     // This should be an initialized object that&#39;s alive.
7335     assert(oop(addr)-&gt;klass_or_null_acquire() != NULL,
7336            &quot;Should be an initialized object&quot;);
7337     // Ignore mark word because we are running concurrent with mutators
7338     assert(oopDesc::is_oop(oop(addr), true), &quot;live block should be an oop&quot;);
7339     // Verify that the bit map has no bits marked between
7340     // addr and purported end of this block.
7341     size = CompactibleFreeListSpace::adjustObjectSize(oop(addr)-&gt;size());
7342     assert(size &gt;= 3, &quot;Necessary for Printezis marks to work&quot;);
7343     assert(!_bitMap-&gt;isMarked(addr+1), &quot;Tautology for this control point&quot;);
7344     DEBUG_ONLY(_bitMap-&gt;verifyNoOneBitsInRange(addr+2, addr+size);)
7345   }
7346   return size;
7347 }
7348 
7349 void SweepClosure::do_post_free_or_garbage_chunk(FreeChunk* fc,
7350                                                  size_t chunkSize) {
7351   // do_post_free_or_garbage_chunk() should only be called in the case
7352   // of the adaptive free list allocator.
7353   const bool fcInFreeLists = fc-&gt;is_free();
7354   assert((HeapWord*)fc &lt;= _limit, &quot;sweep invariant&quot;);
7355   if (CMSTestInFreeList &amp;&amp; fcInFreeLists) {
7356     assert(_sp-&gt;verify_chunk_in_free_list(fc), &quot;free chunk is not in free lists&quot;);
7357   }
7358 
7359   log_develop_trace(gc, sweep)(&quot;  -- pick up another chunk at &quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;)&quot;, p2i(fc), chunkSize);
7360 
7361   HeapWord* const fc_addr = (HeapWord*) fc;
7362 
7363   bool coalesce = false;
7364   const size_t left  = pointer_delta(fc_addr, freeFinger());
7365   const size_t right = chunkSize;
7366   switch (FLSCoalescePolicy) {
7367     // numeric value forms a coalition aggressiveness metric
7368     case 0:  { // never coalesce
7369       coalesce = false;
7370       break;
7371     }
7372     case 1: { // coalesce if left &amp; right chunks on overpopulated lists
7373       coalesce = _sp-&gt;coalOverPopulated(left) &amp;&amp;
7374                  _sp-&gt;coalOverPopulated(right);
7375       break;
7376     }
7377     case 2: { // coalesce if left chunk on overpopulated list (default)
7378       coalesce = _sp-&gt;coalOverPopulated(left);
7379       break;
7380     }
7381     case 3: { // coalesce if left OR right chunk on overpopulated list
7382       coalesce = _sp-&gt;coalOverPopulated(left) ||
7383                  _sp-&gt;coalOverPopulated(right);
7384       break;
7385     }
7386     case 4: { // always coalesce
7387       coalesce = true;
7388       break;
7389     }
7390     default:
7391      ShouldNotReachHere();
7392   }
7393 
7394   // Should the current free range be coalesced?
7395   // If the chunk is in a free range and either we decided to coalesce above
7396   // or the chunk is near the large block at the end of the heap
7397   // (isNearLargestChunk() returns true), then coalesce this chunk.
7398   const bool doCoalesce = inFreeRange()
7399                           &amp;&amp; (coalesce || _g-&gt;isNearLargestChunk(fc_addr));
7400   if (doCoalesce) {
7401     // Coalesce the current free range on the left with the new
7402     // chunk on the right.  If either is on a free list,
7403     // it must be removed from the list and stashed in the closure.
7404     if (freeRangeInFreeLists()) {
7405       FreeChunk* const ffc = (FreeChunk*)freeFinger();
7406       assert(ffc-&gt;size() == pointer_delta(fc_addr, freeFinger()),
7407              &quot;Size of free range is inconsistent with chunk size.&quot;);
7408       if (CMSTestInFreeList) {
7409         assert(_sp-&gt;verify_chunk_in_free_list(ffc),
7410                &quot;Chunk is not in free lists&quot;);
7411       }
7412       _sp-&gt;coalDeath(ffc-&gt;size());
7413       _sp-&gt;removeFreeChunkFromFreeLists(ffc);
7414       set_freeRangeInFreeLists(false);
7415     }
7416     if (fcInFreeLists) {
7417       _sp-&gt;coalDeath(chunkSize);
7418       assert(fc-&gt;size() == chunkSize,
7419         &quot;The chunk has the wrong size or is not in the free lists&quot;);
7420       _sp-&gt;removeFreeChunkFromFreeLists(fc);
7421     }
7422     set_lastFreeRangeCoalesced(true);
7423     print_free_block_coalesced(fc);
7424   } else {  // not in a free range and/or should not coalesce
7425     // Return the current free range and start a new one.
7426     if (inFreeRange()) {
7427       // In a free range but cannot coalesce with the right hand chunk.
7428       // Put the current free range into the free lists.
7429       flush_cur_free_chunk(freeFinger(),
7430                            pointer_delta(fc_addr, freeFinger()));
7431     }
7432     // Set up for new free range.  Pass along whether the right hand
7433     // chunk is in the free lists.
7434     initialize_free_range((HeapWord*)fc, fcInFreeLists);
7435   }
7436 }
7437 
7438 // Lookahead flush:
7439 // If we are tracking a free range, and this is the last chunk that
7440 // we&#39;ll look at because its end crosses past _limit, we&#39;ll preemptively
7441 // flush it along with any free range we may be holding on to. Note that
7442 // this can be the case only for an already free or freshly garbage
7443 // chunk. If this block is an object, it can never straddle
7444 // over _limit. The &quot;straddling&quot; occurs when _limit is set at
7445 // the previous end of the space when this cycle started, and
7446 // a subsequent heap expansion caused the previously co-terminal
7447 // free block to be coalesced with the newly expanded portion,
7448 // thus rendering _limit a non-block-boundary making it dangerous
7449 // for the sweeper to step over and examine.
7450 void SweepClosure::lookahead_and_flush(FreeChunk* fc, size_t chunk_size) {
7451   assert(inFreeRange(), &quot;Should only be called if currently in a free range.&quot;);
7452   HeapWord* const eob = ((HeapWord*)fc) + chunk_size;
7453   assert(_sp-&gt;used_region().contains(eob - 1),
7454          &quot;eob = &quot; PTR_FORMAT &quot; eob-1 = &quot; PTR_FORMAT &quot; _limit = &quot; PTR_FORMAT
7455          &quot; out of bounds wrt _sp = [&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;
7456          &quot; when examining fc = &quot; PTR_FORMAT &quot;(&quot; SIZE_FORMAT &quot;)&quot;,
7457          p2i(eob), p2i(eob-1), p2i(_limit), p2i(_sp-&gt;bottom()), p2i(_sp-&gt;end()), p2i(fc), chunk_size);
7458   if (eob &gt;= _limit) {
7459     assert(eob == _limit || fc-&gt;is_free(), &quot;Only a free chunk should allow us to cross over the limit&quot;);
7460     log_develop_trace(gc, sweep)(&quot;_limit &quot; PTR_FORMAT &quot; reached or crossed by block &quot;
7461                                  &quot;[&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;) in space &quot;
7462                                  &quot;[&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;,
7463                                  p2i(_limit), p2i(fc), p2i(eob), p2i(_sp-&gt;bottom()), p2i(_sp-&gt;end()));
7464     // Return the storage we are tracking back into the free lists.
7465     log_develop_trace(gc, sweep)(&quot;Flushing ... &quot;);
7466     assert(freeFinger() &lt; eob, &quot;Error&quot;);
7467     flush_cur_free_chunk( freeFinger(), pointer_delta(eob, freeFinger()));
7468   }
7469 }
7470 
7471 void SweepClosure::flush_cur_free_chunk(HeapWord* chunk, size_t size) {
7472   assert(inFreeRange(), &quot;Should only be called if currently in a free range.&quot;);
7473   assert(size &gt; 0,
7474     &quot;A zero sized chunk cannot be added to the free lists.&quot;);
7475   if (!freeRangeInFreeLists()) {
7476     if (CMSTestInFreeList) {
7477       FreeChunk* fc = (FreeChunk*) chunk;
7478       fc-&gt;set_size(size);
7479       assert(!_sp-&gt;verify_chunk_in_free_list(fc),
7480              &quot;chunk should not be in free lists yet&quot;);
7481     }
7482     log_develop_trace(gc, sweep)(&quot; -- add free block &quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;) to free lists&quot;, p2i(chunk), size);
7483     // A new free range is going to be starting.  The current
7484     // free range has not been added to the free lists yet or
7485     // was removed so add it back.
7486     // If the current free range was coalesced, then the death
7487     // of the free range was recorded.  Record a birth now.
7488     if (lastFreeRangeCoalesced()) {
7489       _sp-&gt;coalBirth(size);
7490     }
7491     _sp-&gt;addChunkAndRepairOffsetTable(chunk, size,
7492             lastFreeRangeCoalesced());
7493   } else {
7494     log_develop_trace(gc, sweep)(&quot;Already in free list: nothing to flush&quot;);
7495   }
7496   set_inFreeRange(false);
7497   set_freeRangeInFreeLists(false);
7498 }
7499 
7500 // We take a break if we&#39;ve been at this for a while,
7501 // so as to avoid monopolizing the locks involved.
7502 void SweepClosure::do_yield_work(HeapWord* addr) {
7503   // Return current free chunk being used for coalescing (if any)
7504   // to the appropriate freelist.  After yielding, the next
7505   // free block encountered will start a coalescing range of
7506   // free blocks.  If the next free block is adjacent to the
7507   // chunk just flushed, they will need to wait for the next
7508   // sweep to be coalesced.
7509   if (inFreeRange()) {
7510     flush_cur_free_chunk(freeFinger(), pointer_delta(addr, freeFinger()));
7511   }
7512 
7513   // First give up the locks, then yield, then re-lock.
7514   // We should probably use a constructor/destructor idiom to
7515   // do this unlock/lock or modify the MutexUnlocker class to
7516   // serve our purpose. XXX
7517   assert_lock_strong(_bitMap-&gt;lock());
7518   assert_lock_strong(_freelistLock);
7519   assert(ConcurrentMarkSweepThread::cms_thread_has_cms_token(),
7520          &quot;CMS thread should hold CMS token&quot;);
7521   _bitMap-&gt;lock()-&gt;unlock();
7522   _freelistLock-&gt;unlock();
7523   ConcurrentMarkSweepThread::desynchronize(true);
7524   _collector-&gt;stopTimer();
7525   _collector-&gt;incrementYields();
7526 
7527   // See the comment in coordinator_yield()
7528   for (unsigned i = 0; i &lt; CMSYieldSleepCount &amp;&amp;
7529                        ConcurrentMarkSweepThread::should_yield() &amp;&amp;
7530                        !CMSCollector::foregroundGCIsActive(); ++i) {
7531     os::sleep(Thread::current(), 1, false);
7532   }
7533 
7534   ConcurrentMarkSweepThread::synchronize(true);
7535   _freelistLock-&gt;lock();
7536   _bitMap-&gt;lock()-&gt;lock_without_safepoint_check();
7537   _collector-&gt;startTimer();
7538 }
7539 
7540 #ifndef PRODUCT
7541 // This is actually very useful in a product build if it can
7542 // be called from the debugger.  Compile it into the product
7543 // as needed.
7544 bool debug_verify_chunk_in_free_list(FreeChunk* fc) {
7545   return debug_cms_space-&gt;verify_chunk_in_free_list(fc);
7546 }
7547 #endif
7548 
7549 void SweepClosure::print_free_block_coalesced(FreeChunk* fc) const {
7550   log_develop_trace(gc, sweep)(&quot;Sweep:coal_free_blk &quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;)&quot;,
7551                                p2i(fc), fc-&gt;size());
7552 }
7553 
7554 // CMSIsAliveClosure
7555 bool CMSIsAliveClosure::do_object_b(oop obj) {
7556   HeapWord* addr = (HeapWord*)obj;
7557   return addr != NULL &amp;&amp;
7558          (!_span.contains(addr) || _bit_map-&gt;isMarked(addr));
7559 }
7560 
7561 CMSKeepAliveClosure::CMSKeepAliveClosure( CMSCollector* collector,
7562                       MemRegion span,
7563                       CMSBitMap* bit_map, CMSMarkStack* mark_stack,
7564                       bool cpc):
7565   _collector(collector),
7566   _span(span),
7567   _mark_stack(mark_stack),
7568   _bit_map(bit_map),
7569   _concurrent_precleaning(cpc) {
7570   assert(!_span.is_empty(), &quot;Empty span could spell trouble&quot;);
7571 }
7572 
7573 
7574 // CMSKeepAliveClosure: the serial version
7575 void CMSKeepAliveClosure::do_oop(oop obj) {
7576   HeapWord* addr = (HeapWord*)obj;
7577   if (_span.contains(addr) &amp;&amp;
7578       !_bit_map-&gt;isMarked(addr)) {
7579     _bit_map-&gt;mark(addr);
7580     bool simulate_overflow = false;
7581     NOT_PRODUCT(
7582       if (CMSMarkStackOverflowALot &amp;&amp;
7583           _collector-&gt;simulate_overflow()) {
7584         // simulate a stack overflow
7585         simulate_overflow = true;
7586       }
7587     )
7588     if (simulate_overflow || !_mark_stack-&gt;push(obj)) {
7589       if (_concurrent_precleaning) {
7590         // We dirty the overflown object and let the remark
7591         // phase deal with it.
7592         assert(_collector-&gt;overflow_list_is_empty(), &quot;Error&quot;);
7593         // In the case of object arrays, we need to dirty all of
7594         // the cards that the object spans. No locking or atomics
7595         // are needed since no one else can be mutating the mod union
7596         // table.
7597         if (obj-&gt;is_objArray()) {
7598           size_t sz = obj-&gt;size();
7599           HeapWord* end_card_addr = align_up(addr + sz, CardTable::card_size);
7600           MemRegion redirty_range = MemRegion(addr, end_card_addr);
7601           assert(!redirty_range.is_empty(), &quot;Arithmetical tautology&quot;);
7602           _collector-&gt;_modUnionTable.mark_range(redirty_range);
7603         } else {
7604           _collector-&gt;_modUnionTable.mark(addr);
7605         }
7606         _collector-&gt;_ser_kac_preclean_ovflw++;
7607       } else {
7608         _collector-&gt;push_on_overflow_list(obj);
7609         _collector-&gt;_ser_kac_ovflw++;
7610       }
7611     }
7612   }
7613 }
7614 
7615 // CMSParKeepAliveClosure: a parallel version of the above.
7616 // The work queues are private to each closure (thread),
7617 // but (may be) available for stealing by other threads.
7618 void CMSParKeepAliveClosure::do_oop(oop obj) {
7619   HeapWord* addr = (HeapWord*)obj;
7620   if (_span.contains(addr) &amp;&amp;
7621       !_bit_map-&gt;isMarked(addr)) {
7622     // In general, during recursive tracing, several threads
7623     // may be concurrently getting here; the first one to
7624     // &quot;tag&quot; it, claims it.
7625     if (_bit_map-&gt;par_mark(addr)) {
7626       bool res = _work_queue-&gt;push(obj);
7627       assert(res, &quot;Low water mark should be much less than capacity&quot;);
7628       // Do a recursive trim in the hope that this will keep
7629       // stack usage lower, but leave some oops for potential stealers
7630       trim_queue(_low_water_mark);
7631     } // Else, another thread got there first
7632   }
7633 }
7634 
7635 void CMSParKeepAliveClosure::trim_queue(uint max) {
7636   while (_work_queue-&gt;size() &gt; max) {
7637     oop new_oop;
7638     if (_work_queue-&gt;pop_local(new_oop)) {
7639       assert(new_oop != NULL &amp;&amp; oopDesc::is_oop(new_oop), &quot;Expected an oop&quot;);
7640       assert(_bit_map-&gt;isMarked((HeapWord*)new_oop),
7641              &quot;no white objects on this stack!&quot;);
7642       assert(_span.contains((HeapWord*)new_oop), &quot;Out of bounds oop&quot;);
7643       // iterate over the oops in this oop, marking and pushing
7644       // the ones in CMS heap (i.e. in _span).
7645       new_oop-&gt;oop_iterate(&amp;_mark_and_push);
7646     }
7647   }
7648 }
7649 
7650 CMSInnerParMarkAndPushClosure::CMSInnerParMarkAndPushClosure(
7651                                 CMSCollector* collector,
7652                                 MemRegion span, CMSBitMap* bit_map,
7653                                 OopTaskQueue* work_queue):
7654   _collector(collector),
7655   _span(span),
7656   _work_queue(work_queue),
7657   _bit_map(bit_map) { }
7658 
7659 void CMSInnerParMarkAndPushClosure::do_oop(oop obj) {
7660   HeapWord* addr = (HeapWord*)obj;
7661   if (_span.contains(addr) &amp;&amp;
7662       !_bit_map-&gt;isMarked(addr)) {
7663     if (_bit_map-&gt;par_mark(addr)) {
7664       bool simulate_overflow = false;
7665       NOT_PRODUCT(
7666         if (CMSMarkStackOverflowALot &amp;&amp;
7667             _collector-&gt;par_simulate_overflow()) {
7668           // simulate a stack overflow
7669           simulate_overflow = true;
7670         }
7671       )
7672       if (simulate_overflow || !_work_queue-&gt;push(obj)) {
7673         _collector-&gt;par_push_on_overflow_list(obj);
7674         _collector-&gt;_par_kac_ovflw++;
7675       }
7676     } // Else another thread got there already
7677   }
7678 }
7679 
7680 //////////////////////////////////////////////////////////////////
7681 //  CMSExpansionCause                /////////////////////////////
7682 //////////////////////////////////////////////////////////////////
7683 const char* CMSExpansionCause::to_string(CMSExpansionCause::Cause cause) {
7684   switch (cause) {
7685     case _no_expansion:
7686       return &quot;No expansion&quot;;
7687     case _satisfy_free_ratio:
7688       return &quot;Free ratio&quot;;
7689     case _satisfy_promotion:
7690       return &quot;Satisfy promotion&quot;;
7691     case _satisfy_allocation:
7692       return &quot;allocation&quot;;
7693     case _allocate_par_lab:
7694       return &quot;Par LAB&quot;;
7695     case _allocate_par_spooling_space:
7696       return &quot;Par Spooling Space&quot;;
7697     case _adaptive_size_policy:
7698       return &quot;Ergonomics&quot;;
7699     default:
7700       return &quot;unknown&quot;;
7701   }
7702 }
7703 
7704 void CMSDrainMarkingStackClosure::do_void() {
7705   // the max number to take from overflow list at a time
7706   const size_t num = _mark_stack-&gt;capacity()/4;
7707   assert(!_concurrent_precleaning || _collector-&gt;overflow_list_is_empty(),
7708          &quot;Overflow list should be NULL during concurrent phases&quot;);
7709   while (!_mark_stack-&gt;isEmpty() ||
7710          // if stack is empty, check the overflow list
7711          _collector-&gt;take_from_overflow_list(num, _mark_stack)) {
7712     oop obj = _mark_stack-&gt;pop();
7713     HeapWord* addr = (HeapWord*)obj;
7714     assert(_span.contains(addr), &quot;Should be within span&quot;);
7715     assert(_bit_map-&gt;isMarked(addr), &quot;Should be marked&quot;);
7716     assert(oopDesc::is_oop(obj), &quot;Should be an oop&quot;);
7717     obj-&gt;oop_iterate(_keep_alive);
7718   }
7719 }
7720 
7721 void CMSParDrainMarkingStackClosure::do_void() {
7722   // drain queue
7723   trim_queue(0);
7724 }
7725 
7726 // Trim our work_queue so its length is below max at return
7727 void CMSParDrainMarkingStackClosure::trim_queue(uint max) {
7728   while (_work_queue-&gt;size() &gt; max) {
7729     oop new_oop;
7730     if (_work_queue-&gt;pop_local(new_oop)) {
7731       assert(oopDesc::is_oop(new_oop), &quot;Expected an oop&quot;);
7732       assert(_bit_map-&gt;isMarked((HeapWord*)new_oop),
7733              &quot;no white objects on this stack!&quot;);
7734       assert(_span.contains((HeapWord*)new_oop), &quot;Out of bounds oop&quot;);
7735       // iterate over the oops in this oop, marking and pushing
7736       // the ones in CMS heap (i.e. in _span).
7737       new_oop-&gt;oop_iterate(&amp;_mark_and_push);
7738     }
7739   }
7740 }
7741 
7742 ////////////////////////////////////////////////////////////////////
7743 // Support for Marking Stack Overflow list handling and related code
7744 ////////////////////////////////////////////////////////////////////
7745 // Much of the following code is similar in shape and spirit to the
7746 // code used in ParNewGC. We should try and share that code
7747 // as much as possible in the future.
7748 
7749 #ifndef PRODUCT
7750 // Debugging support for CMSStackOverflowALot
7751 
7752 // It&#39;s OK to call this multi-threaded;  the worst thing
7753 // that can happen is that we&#39;ll get a bunch of closely
7754 // spaced simulated overflows, but that&#39;s OK, in fact
7755 // probably good as it would exercise the overflow code
7756 // under contention.
7757 bool CMSCollector::simulate_overflow() {
7758   if (_overflow_counter-- &lt;= 0) { // just being defensive
7759     _overflow_counter = CMSMarkStackOverflowInterval;
7760     return true;
7761   } else {
7762     return false;
7763   }
7764 }
7765 
7766 bool CMSCollector::par_simulate_overflow() {
7767   return simulate_overflow();
7768 }
7769 #endif
7770 
7771 // Single-threaded
7772 bool CMSCollector::take_from_overflow_list(size_t num, CMSMarkStack* stack) {
7773   assert(stack-&gt;isEmpty(), &quot;Expected precondition&quot;);
7774   assert(stack-&gt;capacity() &gt; num, &quot;Shouldn&#39;t bite more than can chew&quot;);
7775   size_t i = num;
7776   oop  cur = _overflow_list;
7777   const markOop proto = markOopDesc::prototype();
7778   NOT_PRODUCT(ssize_t n = 0;)
7779   for (oop next; i &gt; 0 &amp;&amp; cur != NULL; cur = next, i--) {
7780     next = oop(cur-&gt;mark_raw());
7781     cur-&gt;set_mark_raw(proto);   // until proven otherwise
7782     assert(oopDesc::is_oop(cur), &quot;Should be an oop&quot;);
7783     bool res = stack-&gt;push(cur);
7784     assert(res, &quot;Bit off more than can chew?&quot;);
7785     NOT_PRODUCT(n++;)
7786   }
7787   _overflow_list = cur;
7788 #ifndef PRODUCT
7789   assert(_num_par_pushes &gt;= n, &quot;Too many pops?&quot;);
7790   _num_par_pushes -=n;
7791 #endif
7792   return !stack-&gt;isEmpty();
7793 }
7794 
7795 #define BUSY  (cast_to_oop&lt;intptr_t&gt;(0x1aff1aff))
7796 // (MT-safe) Get a prefix of at most &quot;num&quot; from the list.
7797 // The overflow list is chained through the mark word of
7798 // each object in the list. We fetch the entire list,
7799 // break off a prefix of the right size and return the
7800 // remainder. If other threads try to take objects from
7801 // the overflow list at that time, they will wait for
7802 // some time to see if data becomes available. If (and
7803 // only if) another thread places one or more object(s)
7804 // on the global list before we have returned the suffix
7805 // to the global list, we will walk down our local list
7806 // to find its end and append the global list to
7807 // our suffix before returning it. This suffix walk can
7808 // prove to be expensive (quadratic in the amount of traffic)
7809 // when there are many objects in the overflow list and
7810 // there is much producer-consumer contention on the list.
7811 // *NOTE*: The overflow list manipulation code here and
7812 // in ParNewGeneration:: are very similar in shape,
7813 // except that in the ParNew case we use the old (from/eden)
7814 // copy of the object to thread the list via its klass word.
7815 // Because of the common code, if you make any changes in
7816 // the code below, please check the ParNew version to see if
7817 // similar changes might be needed.
7818 // CR 6797058 has been filed to consolidate the common code.
7819 bool CMSCollector::par_take_from_overflow_list(size_t num,
7820                                                OopTaskQueue* work_q,
7821                                                int no_of_gc_threads) {
7822   assert(work_q-&gt;size() == 0, &quot;First empty local work queue&quot;);
7823   assert(num &lt; work_q-&gt;max_elems(), &quot;Can&#39;t bite more than we can chew&quot;);
7824   if (_overflow_list == NULL) {
7825     return false;
7826   }
7827   // Grab the entire list; we&#39;ll put back a suffix
7828   oop prefix = cast_to_oop(Atomic::xchg((oopDesc*)BUSY, &amp;_overflow_list));
7829   Thread* tid = Thread::current();
7830   // Before &quot;no_of_gc_threads&quot; was introduced CMSOverflowSpinCount was
7831   // set to ParallelGCThreads.
7832   size_t CMSOverflowSpinCount = (size_t) no_of_gc_threads; // was ParallelGCThreads;
7833   size_t sleep_time_millis = MAX2((size_t)1, num/100);
7834   // If the list is busy, we spin for a short while,
7835   // sleeping between attempts to get the list.
7836   for (size_t spin = 0; prefix == BUSY &amp;&amp; spin &lt; CMSOverflowSpinCount; spin++) {
7837     os::sleep(tid, sleep_time_millis, false);
7838     if (_overflow_list == NULL) {
7839       // Nothing left to take
7840       return false;
7841     } else if (_overflow_list != BUSY) {
7842       // Try and grab the prefix
7843       prefix = cast_to_oop(Atomic::xchg((oopDesc*)BUSY, &amp;_overflow_list));
7844     }
7845   }
7846   // If the list was found to be empty, or we spun long
7847   // enough, we give up and return empty-handed. If we leave
7848   // the list in the BUSY state below, it must be the case that
7849   // some other thread holds the overflow list and will set it
7850   // to a non-BUSY state in the future.
7851   if (prefix == NULL || prefix == BUSY) {
7852      // Nothing to take or waited long enough
7853      if (prefix == NULL) {
7854        // Write back the NULL in case we overwrote it with BUSY above
7855        // and it is still the same value.
7856        Atomic::cmpxchg((oopDesc*)NULL, &amp;_overflow_list, (oopDesc*)BUSY);
7857      }
7858      return false;
7859   }
7860   assert(prefix != NULL &amp;&amp; prefix != BUSY, &quot;Error&quot;);
7861   size_t i = num;
7862   oop cur = prefix;
7863   // Walk down the first &quot;num&quot; objects, unless we reach the end.
7864   for (; i &gt; 1 &amp;&amp; cur-&gt;mark_raw() != NULL; cur = oop(cur-&gt;mark_raw()), i--);
7865   if (cur-&gt;mark_raw() == NULL) {
7866     // We have &quot;num&quot; or fewer elements in the list, so there
7867     // is nothing to return to the global list.
7868     // Write back the NULL in lieu of the BUSY we wrote
7869     // above, if it is still the same value.
7870     if (_overflow_list == BUSY) {
7871       Atomic::cmpxchg((oopDesc*)NULL, &amp;_overflow_list, (oopDesc*)BUSY);
7872     }
7873   } else {
7874     // Chop off the suffix and return it to the global list.
7875     assert(cur-&gt;mark_raw() != BUSY, &quot;Error&quot;);
7876     oop suffix_head = cur-&gt;mark_raw(); // suffix will be put back on global list
7877     cur-&gt;set_mark_raw(NULL);           // break off suffix
7878     // It&#39;s possible that the list is still in the empty(busy) state
7879     // we left it in a short while ago; in that case we may be
7880     // able to place back the suffix without incurring the cost
7881     // of a walk down the list.
7882     oop observed_overflow_list = _overflow_list;
7883     oop cur_overflow_list = observed_overflow_list;
7884     bool attached = false;
7885     while (observed_overflow_list == BUSY || observed_overflow_list == NULL) {
7886       observed_overflow_list =
7887         Atomic::cmpxchg((oopDesc*)suffix_head, &amp;_overflow_list, (oopDesc*)cur_overflow_list);
7888       if (cur_overflow_list == observed_overflow_list) {
7889         attached = true;
7890         break;
7891       } else cur_overflow_list = observed_overflow_list;
7892     }
7893     if (!attached) {
7894       // Too bad, someone else sneaked in (at least) an element; we&#39;ll need
7895       // to do a splice. Find tail of suffix so we can prepend suffix to global
7896       // list.
7897       for (cur = suffix_head; cur-&gt;mark_raw() != NULL; cur = (oop)(cur-&gt;mark_raw()));
7898       oop suffix_tail = cur;
7899       assert(suffix_tail != NULL &amp;&amp; suffix_tail-&gt;mark_raw() == NULL,
7900              &quot;Tautology&quot;);
7901       observed_overflow_list = _overflow_list;
7902       do {
7903         cur_overflow_list = observed_overflow_list;
7904         if (cur_overflow_list != BUSY) {
7905           // Do the splice ...
7906           suffix_tail-&gt;set_mark_raw(markOop(cur_overflow_list));
7907         } else { // cur_overflow_list == BUSY
7908           suffix_tail-&gt;set_mark_raw(NULL);
7909         }
7910         // ... and try to place spliced list back on overflow_list ...
7911         observed_overflow_list =
7912           Atomic::cmpxchg((oopDesc*)suffix_head, &amp;_overflow_list, (oopDesc*)cur_overflow_list);
7913       } while (cur_overflow_list != observed_overflow_list);
7914       // ... until we have succeeded in doing so.
7915     }
7916   }
7917 
7918   // Push the prefix elements on work_q
7919   assert(prefix != NULL, &quot;control point invariant&quot;);
7920   const markOop proto = markOopDesc::prototype();
7921   oop next;
7922   NOT_PRODUCT(ssize_t n = 0;)
7923   for (cur = prefix; cur != NULL; cur = next) {
7924     next = oop(cur-&gt;mark_raw());
7925     cur-&gt;set_mark_raw(proto);   // until proven otherwise
7926     assert(oopDesc::is_oop(cur), &quot;Should be an oop&quot;);
7927     bool res = work_q-&gt;push(cur);
7928     assert(res, &quot;Bit off more than we can chew?&quot;);
7929     NOT_PRODUCT(n++;)
7930   }
7931 #ifndef PRODUCT
7932   assert(_num_par_pushes &gt;= n, &quot;Too many pops?&quot;);
7933   Atomic::sub(n, &amp;_num_par_pushes);
7934 #endif
7935   return true;
7936 }
7937 
7938 // Single-threaded
7939 void CMSCollector::push_on_overflow_list(oop p) {
7940   NOT_PRODUCT(_num_par_pushes++;)
7941   assert(oopDesc::is_oop(p), &quot;Not an oop&quot;);
7942   preserve_mark_if_necessary(p);
7943   p-&gt;set_mark_raw((markOop)_overflow_list);
7944   _overflow_list = p;
7945 }
7946 
7947 // Multi-threaded; use CAS to prepend to overflow list
7948 void CMSCollector::par_push_on_overflow_list(oop p) {
7949   NOT_PRODUCT(Atomic::inc(&amp;_num_par_pushes);)
7950   assert(oopDesc::is_oop(p), &quot;Not an oop&quot;);
7951   par_preserve_mark_if_necessary(p);
7952   oop observed_overflow_list = _overflow_list;
7953   oop cur_overflow_list;
7954   do {
7955     cur_overflow_list = observed_overflow_list;
7956     if (cur_overflow_list != BUSY) {
7957       p-&gt;set_mark_raw(markOop(cur_overflow_list));
7958     } else {
7959       p-&gt;set_mark_raw(NULL);
7960     }
7961     observed_overflow_list =
7962       Atomic::cmpxchg((oopDesc*)p, &amp;_overflow_list, (oopDesc*)cur_overflow_list);
7963   } while (cur_overflow_list != observed_overflow_list);
7964 }
7965 #undef BUSY
7966 
7967 // Single threaded
7968 // General Note on GrowableArray: pushes may silently fail
7969 // because we are (temporarily) out of C-heap for expanding
7970 // the stack. The problem is quite ubiquitous and affects
7971 // a lot of code in the JVM. The prudent thing for GrowableArray
7972 // to do (for now) is to exit with an error. However, that may
7973 // be too draconian in some cases because the caller may be
7974 // able to recover without much harm. For such cases, we
7975 // should probably introduce a &quot;soft_push&quot; method which returns
7976 // an indication of success or failure with the assumption that
7977 // the caller may be able to recover from a failure; code in
7978 // the VM can then be changed, incrementally, to deal with such
7979 // failures where possible, thus, incrementally hardening the VM
7980 // in such low resource situations.
7981 void CMSCollector::preserve_mark_work(oop p, markOop m) {
7982   _preserved_oop_stack.push(p);
7983   _preserved_mark_stack.push(m);
7984   assert(m == p-&gt;mark_raw(), &quot;Mark word changed&quot;);
7985   assert(_preserved_oop_stack.size() == _preserved_mark_stack.size(),
7986          &quot;bijection&quot;);
7987 }
7988 
7989 // Single threaded
7990 void CMSCollector::preserve_mark_if_necessary(oop p) {
7991   markOop m = p-&gt;mark_raw();
7992   if (m-&gt;must_be_preserved(p)) {
7993     preserve_mark_work(p, m);
7994   }
7995 }
7996 
7997 void CMSCollector::par_preserve_mark_if_necessary(oop p) {
7998   markOop m = p-&gt;mark_raw();
7999   if (m-&gt;must_be_preserved(p)) {
8000     MutexLockerEx x(ParGCRareEvent_lock, Mutex::_no_safepoint_check_flag);
8001     // Even though we read the mark word without holding
8002     // the lock, we are assured that it will not change
8003     // because we &quot;own&quot; this oop, so no other thread can
8004     // be trying to push it on the overflow list; see
8005     // the assertion in preserve_mark_work() that checks
8006     // that m == p-&gt;mark_raw().
8007     preserve_mark_work(p, m);
8008   }
8009 }
8010 
8011 // We should be able to do this multi-threaded,
8012 // a chunk of stack being a task (this is
8013 // correct because each oop only ever appears
8014 // once in the overflow list. However, it&#39;s
8015 // not very easy to completely overlap this with
8016 // other operations, so will generally not be done
8017 // until all work&#39;s been completed. Because we
8018 // expect the preserved oop stack (set) to be small,
8019 // it&#39;s probably fine to do this single-threaded.
8020 // We can explore cleverer concurrent/overlapped/parallel
8021 // processing of preserved marks if we feel the
8022 // need for this in the future. Stack overflow should
8023 // be so rare in practice and, when it happens, its
8024 // effect on performance so great that this will
8025 // likely just be in the noise anyway.
8026 void CMSCollector::restore_preserved_marks_if_any() {
8027   assert(SafepointSynchronize::is_at_safepoint(),
8028          &quot;world should be stopped&quot;);
8029   assert(Thread::current()-&gt;is_ConcurrentGC_thread() ||
8030          Thread::current()-&gt;is_VM_thread(),
8031          &quot;should be single-threaded&quot;);
8032   assert(_preserved_oop_stack.size() == _preserved_mark_stack.size(),
8033          &quot;bijection&quot;);
8034 
8035   while (!_preserved_oop_stack.is_empty()) {
8036     oop p = _preserved_oop_stack.pop();
8037     assert(oopDesc::is_oop(p), &quot;Should be an oop&quot;);
8038     assert(_span.contains(p), &quot;oop should be in _span&quot;);
8039     assert(p-&gt;mark_raw() == markOopDesc::prototype(),
8040            &quot;Set when taken from overflow list&quot;);
8041     markOop m = _preserved_mark_stack.pop();
8042     p-&gt;set_mark_raw(m);
8043   }
8044   assert(_preserved_mark_stack.is_empty() &amp;&amp; _preserved_oop_stack.is_empty(),
8045          &quot;stacks were cleared above&quot;);
8046 }
8047 
8048 #ifndef PRODUCT
8049 bool CMSCollector::no_preserved_marks() const {
8050   return _preserved_mark_stack.is_empty() &amp;&amp; _preserved_oop_stack.is_empty();
8051 }
8052 #endif
8053 
8054 // Transfer some number of overflown objects to usual marking
8055 // stack. Return true if some objects were transferred.
8056 bool MarkRefsIntoAndScanClosure::take_from_overflow_list() {
8057   size_t num = MIN2((size_t)(_mark_stack-&gt;capacity() - _mark_stack-&gt;length())/4,
8058                     (size_t)ParGCDesiredObjsFromOverflowList);
8059 
8060   bool res = _collector-&gt;take_from_overflow_list(num, _mark_stack);
8061   assert(_collector-&gt;overflow_list_is_empty() || res,
8062          &quot;If list is not empty, we should have taken something&quot;);
8063   assert(!res || !_mark_stack-&gt;isEmpty(),
8064          &quot;If we took something, it should now be on our stack&quot;);
8065   return res;
8066 }
8067 
8068 size_t MarkDeadObjectsClosure::do_blk(HeapWord* addr) {
8069   size_t res = _sp-&gt;block_size_no_stall(addr, _collector);
8070   if (_sp-&gt;block_is_obj(addr)) {
8071     if (_live_bit_map-&gt;isMarked(addr)) {
8072       // It can&#39;t have been dead in a previous cycle
8073       guarantee(!_dead_bit_map-&gt;isMarked(addr), &quot;No resurrection!&quot;);
8074     } else {
8075       _dead_bit_map-&gt;mark(addr);      // mark the dead object
8076     }
8077   }
8078   // Could be 0, if the block size could not be computed without stalling.
8079   return res;
8080 }
8081 
8082 TraceCMSMemoryManagerStats::TraceCMSMemoryManagerStats(CMSCollector::CollectorState phase, GCCause::Cause cause): TraceMemoryManagerStats() {
8083   GCMemoryManager* manager = CMSHeap::heap()-&gt;old_manager();
8084   switch (phase) {
8085     case CMSCollector::InitialMarking:
8086       initialize(manager /* GC manager */ ,
8087                  cause   /* cause of the GC */,
8088                  true    /* allMemoryPoolsAffected */,
8089                  true    /* recordGCBeginTime */,
8090                  true    /* recordPreGCUsage */,
8091                  false   /* recordPeakUsage */,
8092                  false   /* recordPostGCusage */,
8093                  true    /* recordAccumulatedGCTime */,
8094                  false   /* recordGCEndTime */,
8095                  false   /* countCollection */  );
8096       break;
8097 
8098     case CMSCollector::FinalMarking:
8099       initialize(manager /* GC manager */ ,
8100                  cause   /* cause of the GC */,
8101                  true    /* allMemoryPoolsAffected */,
8102                  false   /* recordGCBeginTime */,
8103                  false   /* recordPreGCUsage */,
8104                  false   /* recordPeakUsage */,
8105                  false   /* recordPostGCusage */,
8106                  true    /* recordAccumulatedGCTime */,
8107                  false   /* recordGCEndTime */,
8108                  false   /* countCollection */  );
8109       break;
8110 
8111     case CMSCollector::Sweeping:
8112       initialize(manager /* GC manager */ ,
8113                  cause   /* cause of the GC */,
8114                  true    /* allMemoryPoolsAffected */,
8115                  false   /* recordGCBeginTime */,
8116                  false   /* recordPreGCUsage */,
8117                  true    /* recordPeakUsage */,
8118                  true    /* recordPostGCusage */,
8119                  false   /* recordAccumulatedGCTime */,
8120                  true    /* recordGCEndTime */,
8121                  true    /* countCollection */  );
8122       break;
8123 
8124     default:
8125       ShouldNotReachHere();
8126   }
8127 }
    </pre>
  </body>
</html>