<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/z/zRootsIterator.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zResurrection.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zRootsIterator.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zRootsIterator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 28,26 ***</span>
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;compiler/oopMap.hpp&quot;
  #include &quot;gc/shared/barrierSet.hpp&quot;
  #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  #include &quot;gc/shared/oopStorageParState.inline.hpp&quot;
  #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  #include &quot;gc/z/zBarrierSetNMethod.hpp&quot;
  #include &quot;gc/z/zGlobals.hpp&quot;
  #include &quot;gc/z/zNMethod.hpp&quot;
  #include &quot;gc/z/zOopClosures.inline.hpp&quot;
  #include &quot;gc/z/zRootsIterator.hpp&quot;
  #include &quot;gc/z/zStat.hpp&quot;
  #include &quot;gc/z/zThreadLocalData.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
<span class="line-removed">- #include &quot;runtime/jniHandles.hpp&quot;</span>
<span class="line-removed">- #include &quot;runtime/thread.hpp&quot;</span>
  #include &quot;runtime/safepoint.hpp&quot;
  #include &quot;runtime/synchronizer.hpp&quot;
  #include &quot;services/management.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #if INCLUDE_JFR
  #include &quot;jfr/jfr.hpp&quot;
  #endif
<span class="line-new-header">--- 28,29 ---</span>
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;compiler/oopMap.hpp&quot;
  #include &quot;gc/shared/barrierSet.hpp&quot;
  #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  #include &quot;gc/shared/oopStorageParState.inline.hpp&quot;
<span class="line-added">+ #include &quot;gc/shared/oopStorageSet.hpp&quot;</span>
  #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  #include &quot;gc/z/zBarrierSetNMethod.hpp&quot;
  #include &quot;gc/z/zGlobals.hpp&quot;
  #include &quot;gc/z/zNMethod.hpp&quot;
  #include &quot;gc/z/zOopClosures.inline.hpp&quot;
  #include &quot;gc/z/zRootsIterator.hpp&quot;
  #include &quot;gc/z/zStat.hpp&quot;
  #include &quot;gc/z/zThreadLocalData.hpp&quot;
<span class="line-added">+ #include &quot;memory/iterator.hpp&quot;</span>
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;prims/jvmtiExport.hpp&quot;
<span class="line-added">+ #include &quot;prims/resolvedMethodTable.hpp&quot;</span>
  #include &quot;runtime/atomic.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  #include &quot;runtime/synchronizer.hpp&quot;
<span class="line-added">+ #include &quot;runtime/thread.hpp&quot;</span>
<span class="line-added">+ #include &quot;runtime/vmThread.hpp&quot;</span>
  #include &quot;services/management.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #if INCLUDE_JFR
  #include &quot;jfr/jfr.hpp&quot;
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 59,17 ***</span>
  static const ZStatSubPhase ZSubPhasePauseRootsObjectSynchronizer(&quot;Pause Roots ObjectSynchronizer&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsManagement(&quot;Pause Roots Management&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsJVMTIExport(&quot;Pause Roots JVMTIExport&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsJVMTIWeakExport(&quot;Pause Roots JVMTIWeakExport&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsSystemDictionary(&quot;Pause Roots SystemDictionary&quot;);
<span class="line-modified">! static const ZStatSubPhase ZSubPhasePauseRootsThreads(&quot;Pause Roots Threads&quot;);</span>
  static const ZStatSubPhase ZSubPhasePauseRootsCodeCache(&quot;Pause Roots CodeCache&quot;);
  
  static const ZStatSubPhase ZSubPhaseConcurrentRootsSetup(&quot;Concurrent Roots Setup&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRoots(&quot;Concurrent Roots&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRootsTeardown(&quot;Concurrent Roots Teardown&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRootsJNIHandles(&quot;Concurrent Roots JNIHandles&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRootsClassLoaderDataGraph(&quot;Concurrent Roots ClassLoaderDataGraph&quot;);
  
  static const ZStatSubPhase ZSubPhasePauseWeakRootsSetup(&quot;Pause Weak Roots Setup&quot;);
  static const ZStatSubPhase ZSubPhasePauseWeakRoots(&quot;Pause Weak Roots&quot;);
  static const ZStatSubPhase ZSubPhasePauseWeakRootsTeardown(&quot;Pause Weak Roots Teardown&quot;);
<span class="line-new-header">--- 62,19 ---</span>
  static const ZStatSubPhase ZSubPhasePauseRootsObjectSynchronizer(&quot;Pause Roots ObjectSynchronizer&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsManagement(&quot;Pause Roots Management&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsJVMTIExport(&quot;Pause Roots JVMTIExport&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsJVMTIWeakExport(&quot;Pause Roots JVMTIWeakExport&quot;);
  static const ZStatSubPhase ZSubPhasePauseRootsSystemDictionary(&quot;Pause Roots SystemDictionary&quot;);
<span class="line-modified">! static const ZStatSubPhase ZSubPhasePauseRootsVMThread(&quot;Pause Roots VM Thread&quot;);</span>
<span class="line-added">+ static const ZStatSubPhase ZSubPhasePauseRootsJavaThreads(&quot;Pause Roots Java Threads&quot;);</span>
  static const ZStatSubPhase ZSubPhasePauseRootsCodeCache(&quot;Pause Roots CodeCache&quot;);
  
  static const ZStatSubPhase ZSubPhaseConcurrentRootsSetup(&quot;Concurrent Roots Setup&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRoots(&quot;Concurrent Roots&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRootsTeardown(&quot;Concurrent Roots Teardown&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentRootsJNIHandles(&quot;Concurrent Roots JNIHandles&quot;);
<span class="line-added">+ static const ZStatSubPhase ZSubPhaseConcurrentRootsVMHandles(&quot;Concurrent Roots VMHandles&quot;);</span>
  static const ZStatSubPhase ZSubPhaseConcurrentRootsClassLoaderDataGraph(&quot;Concurrent Roots ClassLoaderDataGraph&quot;);
  
  static const ZStatSubPhase ZSubPhasePauseWeakRootsSetup(&quot;Pause Weak Roots Setup&quot;);
  static const ZStatSubPhase ZSubPhasePauseWeakRoots(&quot;Pause Weak Roots&quot;);
  static const ZStatSubPhase ZSubPhasePauseWeakRootsTeardown(&quot;Pause Weak Roots Teardown&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,19 ***</span>
  
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRoots(&quot;Concurrent Weak Roots&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsVMWeakHandles(&quot;Concurrent Weak Roots VMWeakHandles&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsJNIWeakHandles(&quot;Concurrent Weak Roots JNIWeakHandles&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsStringTable(&quot;Concurrent Weak Roots StringTable&quot;);
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  ZSerialOopsDo&lt;T, F&gt;::ZSerialOopsDo(T* iter) :
      _iter(iter),
      _claimed(false) {}
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  void ZSerialOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
<span class="line-modified">!   if (!_claimed &amp;&amp; Atomic::cmpxchg(true, &amp;_claimed, false) == false) {</span>
      (_iter-&gt;*F)(cl);
    }
  }
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
<span class="line-new-header">--- 83,20 ---</span>
  
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRoots(&quot;Concurrent Weak Roots&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsVMWeakHandles(&quot;Concurrent Weak Roots VMWeakHandles&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsJNIWeakHandles(&quot;Concurrent Weak Roots JNIWeakHandles&quot;);
  static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsStringTable(&quot;Concurrent Weak Roots StringTable&quot;);
<span class="line-added">+ static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsResolvedMethodTable(&quot;Concurrent Weak Roots ResolvedMethodTable&quot;);</span>
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  ZSerialOopsDo&lt;T, F&gt;::ZSerialOopsDo(T* iter) :
      _iter(iter),
      _claimed(false) {}
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  void ZSerialOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
<span class="line-modified">!   if (!_claimed &amp;&amp; Atomic::cmpxchg(&amp;_claimed, false, true) == false) {</span>
      (_iter-&gt;*F)(cl);
    }
  }
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 113,11 ***</span>
      _iter(iter),
      _claimed(false) {}
  
  template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
  void ZSerialWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
<span class="line-modified">!   if (!_claimed &amp;&amp; Atomic::cmpxchg(true, &amp;_claimed, false) == false) {</span>
      (_iter-&gt;*F)(is_alive, cl);
    }
  }
  
  template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
<span class="line-new-header">--- 119,11 ---</span>
      _iter(iter),
      _claimed(false) {}
  
  template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
  void ZSerialWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
<span class="line-modified">!   if (!_claimed &amp;&amp; Atomic::cmpxchg(&amp;_claimed, false, true) == false) {</span>
      (_iter-&gt;*F)(is_alive, cl);
    }
  }
  
  template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,31 ***</span>
        _completed = true;
      }
    }
  }
  
<span class="line-modified">! class ZRootsIteratorCodeBlobClosure : public CodeBlobToOopClosure {</span>
  private:
<span class="line-modified">!   BarrierSetNMethod* _bs;</span>
  
  public:
<span class="line-modified">!   ZRootsIteratorCodeBlobClosure(OopClosure* cl) :</span>
<span class="line-modified">!     CodeBlobToOopClosure(cl, true /* fix_relocations */),</span>
<span class="line-modified">!     _bs(BarrierSet::barrier_set()-&gt;barrier_set_nmethod()) {}</span>
  
    virtual void do_code_blob(CodeBlob* cb) {
      nmethod* const nm = cb-&gt;as_nmethod_or_null();
<span class="line-modified">!     if (nm != NULL &amp;&amp; !nm-&gt;test_set_oops_do_mark()) {</span>
<span class="line-modified">!       CodeBlobToOopClosure::do_code_blob(cb);</span>
<span class="line-modified">!       _bs-&gt;disarm(nm);</span>
      }
    }
  };
  
  class ZRootsIteratorThreadClosure : public ThreadClosure {
  private:
<span class="line-modified">!   ZRootsIteratorClosure* _cl;</span>
  
  public:
    ZRootsIteratorThreadClosure(ZRootsIteratorClosure* cl) :
        _cl(cl) {}
  
<span class="line-new-header">--- 139,37 ---</span>
        _completed = true;
      }
    }
  }
  
<span class="line-modified">! class ZRootsIteratorCodeBlobClosure : public CodeBlobClosure {</span>
  private:
<span class="line-modified">!   ZRootsIteratorClosure* const _cl;</span>
<span class="line-added">+   const bool                   _should_disarm_nmethods;</span>
  
  public:
<span class="line-modified">!   ZRootsIteratorCodeBlobClosure(ZRootsIteratorClosure* cl) :</span>
<span class="line-modified">!       _cl(cl),</span>
<span class="line-modified">!       _should_disarm_nmethods(cl-&gt;should_disarm_nmethods()) {}</span>
  
    virtual void do_code_blob(CodeBlob* cb) {
      nmethod* const nm = cb-&gt;as_nmethod_or_null();
<span class="line-modified">!     if (nm != NULL &amp;&amp; nm-&gt;oops_do_try_claim()) {</span>
<span class="line-modified">!       ZNMethod::nmethod_oops_do(nm, _cl);</span>
<span class="line-modified">!       assert(!ZNMethod::supports_entry_barrier(nm) ||</span>
<span class="line-added">+              ZNMethod::is_armed(nm) == _should_disarm_nmethods, &quot;Invalid state&quot;);</span>
<span class="line-added">+       if (_should_disarm_nmethods) {</span>
<span class="line-added">+         ZNMethod::disarm(nm);</span>
<span class="line-added">+       }</span>
      }
    }
  };
  
  class ZRootsIteratorThreadClosure : public ThreadClosure {
  private:
<span class="line-modified">!   ZRootsIteratorClosure* const _cl;</span>
<span class="line-added">+   ResourceMark                 _rm;</span>
  
  public:
    ZRootsIteratorThreadClosure(ZRootsIteratorClosure* cl) :
        _cl(cl) {}
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,23 ***</span>
      thread-&gt;oops_do(_cl, ClassUnloading ? &amp;code_cl : NULL);
      _cl-&gt;do_thread(thread);
    }
  };
  
<span class="line-modified">! ZRootsIterator::ZRootsIterator() :</span>
      _universe(this),
      _object_synchronizer(this),
      _management(this),
      _jvmti_export(this),
      _jvmti_weak_export(this),
      _system_dictionary(this),
<span class="line-modified">!     _threads(this),</span>
      _code_cache(this) {
    assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
    ZStatTimer timer(ZSubPhasePauseRootsSetup);
<span class="line-modified">!   Threads::change_thread_claim_parity();</span>
<span class="line-removed">-   COMPILER2_PRESENT(DerivedPointerTable::clear());</span>
    if (ClassUnloading) {
      nmethod::oops_do_marking_prologue();
    } else {
      ZNMethod::oops_do_begin();
    }
<span class="line-new-header">--- 178,39 ---</span>
      thread-&gt;oops_do(_cl, ClassUnloading ? &amp;code_cl : NULL);
      _cl-&gt;do_thread(thread);
    }
  };
  
<span class="line-modified">! ZJavaThreadsIterator::ZJavaThreadsIterator() :</span>
<span class="line-added">+     _threads(),</span>
<span class="line-added">+     _claimed(0) {}</span>
<span class="line-added">+ </span>
<span class="line-added">+ uint ZJavaThreadsIterator::claim() {</span>
<span class="line-added">+   return Atomic::fetch_and_add(&amp;_claimed, 1u);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void ZJavaThreadsIterator::threads_do(ThreadClosure* cl) {</span>
<span class="line-added">+   for (uint i = claim(); i &lt; _threads.length(); i = claim()) {</span>
<span class="line-added">+     cl-&gt;do_thread(_threads.thread_at(i));</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ZRootsIterator::ZRootsIterator(bool visit_jvmti_weak_export) :</span>
<span class="line-added">+     _visit_jvmti_weak_export(visit_jvmti_weak_export),</span>
<span class="line-added">+     _java_threads_iter(),</span>
      _universe(this),
      _object_synchronizer(this),
      _management(this),
      _jvmti_export(this),
      _jvmti_weak_export(this),
      _system_dictionary(this),
<span class="line-modified">!     _vm_thread(this),</span>
<span class="line-added">+     _java_threads(this),</span>
      _code_cache(this) {
    assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
    ZStatTimer timer(ZSubPhasePauseRootsSetup);
<span class="line-modified">!   COMPILER2_OR_JVMCI_PRESENT(DerivedPointerTable::clear());</span>
    if (ClassUnloading) {
      nmethod::oops_do_marking_prologue();
    } else {
      ZNMethod::oops_do_begin();
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 194,14 ***</span>
    if (ClassUnloading) {
      nmethod::oops_do_marking_epilogue();
    } else {
      ZNMethod::oops_do_end();
    }
<span class="line-removed">-   JvmtiExport::gc_epilogue();</span>
  
<span class="line-modified">!   COMPILER2_PRESENT(DerivedPointerTable::update_pointers());</span>
<span class="line-removed">-   Threads::assert_all_threads_claimed();</span>
  }
  
  void ZRootsIterator::do_universe(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsUniverse);
    Universe::oops_do(cl);
<span class="line-new-header">--- 222,12 ---</span>
    if (ClassUnloading) {
      nmethod::oops_do_marking_epilogue();
    } else {
      ZNMethod::oops_do_end();
    }
  
<span class="line-modified">!   COMPILER2_OR_JVMCI_PRESENT(DerivedPointerTable::update_pointers());</span>
  }
  
  void ZRootsIterator::do_universe(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsUniverse);
    Universe::oops_do(cl);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 228,80 ***</span>
    JvmtiExport::weak_oops_do(&amp;always_alive, cl);
  }
  
  void ZRootsIterator::do_system_dictionary(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsSystemDictionary);
<span class="line-modified">!   SystemDictionary::oops_do(cl);</span>
  }
  
<span class="line-modified">! void ZRootsIterator::do_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-modified">!   ZStatTimer timer(ZSubPhasePauseRootsThreads);</span>
<span class="line-removed">-   ResourceMark rm;</span>
    ZRootsIteratorThreadClosure thread_cl(cl);
<span class="line-modified">!   Threads::possibly_parallel_threads_do(true, &amp;thread_cl);</span>
  }
  
  void ZRootsIterator::do_code_cache(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsCodeCache);
    ZNMethod::oops_do(cl);
  }
  
<span class="line-modified">! void ZRootsIterator::oops_do(ZRootsIteratorClosure* cl, bool visit_jvmti_weak_export) {</span>
    ZStatTimer timer(ZSubPhasePauseRoots);
    _universe.oops_do(cl);
    _object_synchronizer.oops_do(cl);
    _management.oops_do(cl);
    _jvmti_export.oops_do(cl);
    _system_dictionary.oops_do(cl);
<span class="line-modified">!   _threads.oops_do(cl);</span>
    if (!ClassUnloading) {
      _code_cache.oops_do(cl);
    }
<span class="line-modified">!   if (visit_jvmti_weak_export) {</span>
      _jvmti_weak_export.oops_do(cl);
    }
  }
  
<span class="line-modified">! ZConcurrentRootsIterator::ZConcurrentRootsIterator(bool marking) :</span>
<span class="line-modified">!     _marking(marking),</span>
<span class="line-modified">!     _sts_joiner(marking /* active */),</span>
<span class="line-modified">!     _jni_handles_iter(JNIHandles::global_handles()),</span>
      _jni_handles(this),
      _class_loader_data_graph(this) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsSetup);
<span class="line-modified">!   if (_marking) {</span>
<span class="line-removed">-     ClassLoaderDataGraph_lock-&gt;lock();</span>
<span class="line-removed">-     ClassLoaderDataGraph::clear_claimed_marks();</span>
<span class="line-removed">-   }</span>
  }
  
  ZConcurrentRootsIterator::~ZConcurrentRootsIterator() {
    ZStatTimer timer(ZSubPhaseConcurrentRootsTeardown);
<span class="line-removed">-   if (_marking) {</span>
<span class="line-removed">-     ClassLoaderDataGraph_lock-&gt;unlock();</span>
<span class="line-removed">-   }</span>
  }
  
  void ZConcurrentRootsIterator::do_jni_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsJNIHandles);
    _jni_handles_iter.oops_do(cl);
  }
  
  void ZConcurrentRootsIterator::do_class_loader_data_graph(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsClassLoaderDataGraph);
<span class="line-modified">!   if (_marking) {</span>
<span class="line-modified">!     CLDToOopClosure cld_cl(cl, ClassLoaderData::_claim_strong);</span>
<span class="line-removed">-     ClassLoaderDataGraph::always_strong_cld_do(&amp;cld_cl);</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     CLDToOopClosure cld_cl(cl, ClassLoaderData::_claim_none);</span>
<span class="line-removed">-     ClassLoaderDataGraph::cld_do(&amp;cld_cl);</span>
<span class="line-removed">-   }</span>
  }
  
  void ZConcurrentRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRoots);
    _jni_handles.oops_do(cl);
    _class_loader_data_graph.oops_do(cl);
  }
  
  ZWeakRootsIterator::ZWeakRootsIterator() :
      _jvmti_weak_export(this),
<span class="line-new-header">--- 254,83 ---</span>
    JvmtiExport::weak_oops_do(&amp;always_alive, cl);
  }
  
  void ZRootsIterator::do_system_dictionary(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsSystemDictionary);
<span class="line-modified">!   // Handles are processed via _vm_handles.</span>
<span class="line-added">+   SystemDictionary::oops_do(cl, false /* include_handles */);</span>
  }
  
<span class="line-modified">! void ZRootsIterator::do_vm_thread(ZRootsIteratorClosure* cl) {</span>
<span class="line-modified">!   ZStatTimer timer(ZSubPhasePauseRootsVMThread);</span>
    ZRootsIteratorThreadClosure thread_cl(cl);
<span class="line-modified">!   thread_cl.do_thread(VMThread::vm_thread());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void ZRootsIterator::do_java_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">+   ZStatTimer timer(ZSubPhasePauseRootsJavaThreads);</span>
<span class="line-added">+   ZRootsIteratorThreadClosure thread_cl(cl);</span>
<span class="line-added">+   _java_threads_iter.threads_do(&amp;thread_cl);</span>
  }
  
  void ZRootsIterator::do_code_cache(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhasePauseRootsCodeCache);
    ZNMethod::oops_do(cl);
  }
  
<span class="line-modified">! void ZRootsIterator::oops_do(ZRootsIteratorClosure* cl) {</span>
    ZStatTimer timer(ZSubPhasePauseRoots);
    _universe.oops_do(cl);
    _object_synchronizer.oops_do(cl);
    _management.oops_do(cl);
    _jvmti_export.oops_do(cl);
    _system_dictionary.oops_do(cl);
<span class="line-modified">!   _vm_thread.oops_do(cl);</span>
<span class="line-added">+   _java_threads.oops_do(cl);</span>
    if (!ClassUnloading) {
      _code_cache.oops_do(cl);
    }
<span class="line-modified">!   if (_visit_jvmti_weak_export) {</span>
      _jvmti_weak_export.oops_do(cl);
    }
  }
  
<span class="line-modified">! ZConcurrentRootsIterator::ZConcurrentRootsIterator(int cld_claim) :</span>
<span class="line-modified">!     _jni_handles_iter(OopStorageSet::jni_global()),</span>
<span class="line-modified">!     _vm_handles_iter(OopStorageSet::vm_global()),</span>
<span class="line-modified">!     _cld_claim(cld_claim),</span>
      _jni_handles(this),
<span class="line-added">+     _vm_handles(this),</span>
      _class_loader_data_graph(this) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsSetup);
<span class="line-modified">!   ClassLoaderDataGraph::clear_claimed_marks(cld_claim);</span>
  }
  
  ZConcurrentRootsIterator::~ZConcurrentRootsIterator() {
    ZStatTimer timer(ZSubPhaseConcurrentRootsTeardown);
  }
  
  void ZConcurrentRootsIterator::do_jni_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsJNIHandles);
    _jni_handles_iter.oops_do(cl);
  }
  
<span class="line-added">+ void ZConcurrentRootsIterator::do_vm_handles(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">+   ZStatTimer timer(ZSubPhaseConcurrentRootsVMHandles);</span>
<span class="line-added">+   _vm_handles_iter.oops_do(cl);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void ZConcurrentRootsIterator::do_class_loader_data_graph(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRootsClassLoaderDataGraph);
<span class="line-modified">!   CLDToOopClosure cld_cl(cl, _cld_claim);</span>
<span class="line-modified">!   ClassLoaderDataGraph::always_strong_cld_do(&amp;cld_cl);</span>
  }
  
  void ZConcurrentRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentRoots);
    _jni_handles.oops_do(cl);
<span class="line-added">+   _vm_handles.oops_do(cl),</span>
    _class_loader_data_graph.oops_do(cl);
  }
  
  ZWeakRootsIterator::ZWeakRootsIterator() :
      _jvmti_weak_export(this),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 336,21 ***</span>
    AlwaysTrueClosure always_alive;
    weak_oops_do(&amp;always_alive, cl);
  }
  
  ZConcurrentWeakRootsIterator::ZConcurrentWeakRootsIterator() :
<span class="line-modified">!     _vm_weak_handles_iter(SystemDictionary::vm_weak_oop_storage()),</span>
<span class="line-modified">!     _jni_weak_handles_iter(JNIHandles::weak_global_handles()),</span>
<span class="line-modified">!     _string_table_iter(StringTable::weak_storage()),</span>
      _vm_weak_handles(this),
      _jni_weak_handles(this),
<span class="line-modified">!     _string_table(this) {</span>
    StringTable::reset_dead_counter();
  }
  
  ZConcurrentWeakRootsIterator::~ZConcurrentWeakRootsIterator() {
    StringTable::finish_dead_counter();
  }
  
  void ZConcurrentWeakRootsIterator::do_vm_weak_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsVMWeakHandles);
    _vm_weak_handles_iter.oops_do(cl);
<span class="line-new-header">--- 365,25 ---</span>
    AlwaysTrueClosure always_alive;
    weak_oops_do(&amp;always_alive, cl);
  }
  
  ZConcurrentWeakRootsIterator::ZConcurrentWeakRootsIterator() :
<span class="line-modified">!     _vm_weak_handles_iter(OopStorageSet::vm_weak()),</span>
<span class="line-modified">!     _jni_weak_handles_iter(OopStorageSet::jni_weak()),</span>
<span class="line-modified">!     _string_table_iter(OopStorageSet::string_table_weak()),</span>
<span class="line-added">+     _resolved_method_table_iter(OopStorageSet::resolved_method_table_weak()),</span>
      _vm_weak_handles(this),
      _jni_weak_handles(this),
<span class="line-modified">!     _string_table(this),</span>
<span class="line-added">+     _resolved_method_table(this) {</span>
    StringTable::reset_dead_counter();
<span class="line-added">+   ResolvedMethodTable::reset_dead_counter();</span>
  }
  
  ZConcurrentWeakRootsIterator::~ZConcurrentWeakRootsIterator() {
    StringTable::finish_dead_counter();
<span class="line-added">+   ResolvedMethodTable::finish_dead_counter();</span>
  }
  
  void ZConcurrentWeakRootsIterator::do_vm_weak_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsVMWeakHandles);
    _vm_weak_handles_iter.oops_do(cl);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 359,22 ***</span>
  void ZConcurrentWeakRootsIterator::do_jni_weak_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsJNIWeakHandles);
    _jni_weak_handles_iter.oops_do(cl);
  }
  
<span class="line-modified">! class ZStringTableDeadCounterClosure : public ZRootsIteratorClosure  {</span>
  private:
    ZRootsIteratorClosure* const _cl;
    size_t                       _ndead;
  
  public:
<span class="line-modified">!   ZStringTableDeadCounterClosure(ZRootsIteratorClosure* cl) :</span>
        _cl(cl),
        _ndead(0) {}
  
<span class="line-modified">!   ~ZStringTableDeadCounterClosure() {</span>
<span class="line-modified">!     StringTable::inc_dead_counter(_ndead);</span>
    }
  
    virtual void do_oop(oop* p) {
      _cl-&gt;do_oop(p);
      if (*p == NULL) {
<span class="line-new-header">--- 392,23 ---</span>
  void ZConcurrentWeakRootsIterator::do_jni_weak_handles(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsJNIWeakHandles);
    _jni_weak_handles_iter.oops_do(cl);
  }
  
<span class="line-modified">! template &lt;class Container&gt;</span>
<span class="line-added">+ class ZDeadCounterClosure : public ZRootsIteratorClosure  {</span>
  private:
    ZRootsIteratorClosure* const _cl;
    size_t                       _ndead;
  
  public:
<span class="line-modified">!   ZDeadCounterClosure(ZRootsIteratorClosure* cl) :</span>
        _cl(cl),
        _ndead(0) {}
  
<span class="line-modified">!   ~ZDeadCounterClosure() {</span>
<span class="line-modified">!     Container::inc_dead_counter(_ndead);</span>
    }
  
    virtual void do_oop(oop* p) {
      _cl-&gt;do_oop(p);
      if (*p == NULL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 387,38 ***</span>
    }
  };
  
  void ZConcurrentWeakRootsIterator::do_string_table(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsStringTable);
<span class="line-modified">!   ZStringTableDeadCounterClosure counter_cl(cl);</span>
    _string_table_iter.oops_do(&amp;counter_cl);
  }
  
  void ZConcurrentWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRoots);
    _vm_weak_handles.oops_do(cl);
    _jni_weak_handles.oops_do(cl);
    _string_table.oops_do(cl);
<span class="line-modified">! }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ZThreadRootsIterator::ZThreadRootsIterator() :</span>
<span class="line-removed">-     _threads(this) {</span>
<span class="line-removed">-   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);</span>
<span class="line-removed">-   ZStatTimer timer(ZSubPhasePauseRootsSetup);</span>
<span class="line-removed">-   Threads::change_thread_claim_parity();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ZThreadRootsIterator::~ZThreadRootsIterator() {</span>
<span class="line-removed">-   ZStatTimer timer(ZSubPhasePauseRootsTeardown);</span>
<span class="line-removed">-   Threads::assert_all_threads_claimed();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void ZThreadRootsIterator::do_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-removed">-   ZStatTimer timer(ZSubPhasePauseRootsThreads);</span>
<span class="line-removed">-   ResourceMark rm;</span>
<span class="line-removed">-   Threads::possibly_parallel_oops_do(true, cl, NULL);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void ZThreadRootsIterator::oops_do(ZRootsIteratorClosure* cl) {</span>
<span class="line-removed">-   ZStatTimer timer(ZSubPhasePauseRoots);</span>
<span class="line-removed">-   _threads.oops_do(cl);</span>
  }
<span class="line-new-header">--- 421,22 ---</span>
    }
  };
  
  void ZConcurrentWeakRootsIterator::do_string_table(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRootsStringTable);
<span class="line-modified">!   ZDeadCounterClosure&lt;StringTable&gt; counter_cl(cl);</span>
    _string_table_iter.oops_do(&amp;counter_cl);
  }
  
<span class="line-added">+ void ZConcurrentWeakRootsIterator::do_resolved_method_table(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">+   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsResolvedMethodTable);</span>
<span class="line-added">+   ZDeadCounterClosure&lt;ResolvedMethodTable&gt; counter_cl(cl);</span>
<span class="line-added">+   _resolved_method_table_iter.oops_do(&amp;counter_cl);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void ZConcurrentWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
    ZStatTimer timer(ZSubPhaseConcurrentWeakRoots);
    _vm_weak_handles.oops_do(cl);
    _jni_weak_handles.oops_do(cl);
    _string_table.oops_do(cl);
<span class="line-modified">!   _resolved_method_table.oops_do(cl);</span>
  }
</pre>
<center><a href="zResurrection.inline.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zRootsIterator.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>