<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/z/zDriver.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zDirector.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zDriver.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zDriver.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 29,10 ***</span>
<span class="line-new-header">--- 29,11 ---</span>
  #include &quot;gc/z/zDriver.hpp&quot;
  #include &quot;gc/z/zHeap.inline.hpp&quot;
  #include &quot;gc/z/zMessagePort.inline.hpp&quot;
  #include &quot;gc/z/zServiceability.hpp&quot;
  #include &quot;gc/z/zStat.hpp&quot;
<span class="line-added">+ #include &quot;gc/z/zVerify.hpp&quot;</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;runtime/vmOperations.hpp&quot;
  #include &quot;runtime/vmThread.hpp&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 41,13 ***</span>
  static const ZStatPhaseConcurrent ZPhaseConcurrentMark(&quot;Concurrent Mark&quot;);
  static const ZStatPhaseConcurrent ZPhaseConcurrentMarkContinue(&quot;Concurrent Mark Continue&quot;);
  static const ZStatPhasePause      ZPhasePauseMarkEnd(&quot;Pause Mark End&quot;);
  static const ZStatPhaseConcurrent ZPhaseConcurrentProcessNonStrongReferences(&quot;Concurrent Process Non-Strong References&quot;);
  static const ZStatPhaseConcurrent ZPhaseConcurrentResetRelocationSet(&quot;Concurrent Reset Relocation Set&quot;);
<span class="line-removed">- static const ZStatPhaseConcurrent ZPhaseConcurrentDestroyDetachedPages(&quot;Concurrent Destroy Detached Pages&quot;);</span>
  static const ZStatPhaseConcurrent ZPhaseConcurrentSelectRelocationSet(&quot;Concurrent Select Relocation Set&quot;);
<span class="line-removed">- static const ZStatPhaseConcurrent ZPhaseConcurrentPrepareRelocationSet(&quot;Concurrent Prepare Relocation Set&quot;);</span>
  static const ZStatPhasePause      ZPhasePauseRelocateStart(&quot;Pause Relocate Start&quot;);
  static const ZStatPhaseConcurrent ZPhaseConcurrentRelocated(&quot;Concurrent Relocate&quot;);
  static const ZStatCriticalPhase   ZCriticalPhaseGCLockerStall(&quot;GC Locker Stall&quot;, false /* verbose */);
  static const ZStatSampler         ZSamplerJavaThreads(&quot;System&quot;, &quot;Java Threads&quot;, ZStatUnitThreads);
  
<span class="line-new-header">--- 42,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 86,10 ***</span>
<span class="line-new-header">--- 85,13 ---</span>
  
      // Setup GC id and active marker
      GCIdMark gc_id_mark(_gc_id);
      IsGCActiveMark gc_active_mark;
  
<span class="line-added">+     // Verify before operation</span>
<span class="line-added">+     ZVerify::before_zoperation();</span>
<span class="line-added">+ </span>
      // Execute operation
      _success = do_operation();
  
      // Update statistics
      ZStatSample(ZSamplerJavaThreads, Threads::number_of_threads());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 207,10 ***</span>
<span class="line-new-header">--- 209,21 ---</span>
      ZHeap::heap()-&gt;relocate_start();
      return true;
    }
  };
  
<span class="line-added">+ class VM_ZVerify : public VM_Operation {</span>
<span class="line-added">+ public:</span>
<span class="line-added">+   virtual VMOp_Type type() const {</span>
<span class="line-added">+     return VMOp_ZVerify;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   virtual void doit() {</span>
<span class="line-added">+     ZVerify::after_weak_processing();</span>
<span class="line-added">+   }</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
  ZDriver::ZDriver() :
      _gc_cycle_port(),
      _gc_locker_port() {
    set_name(&quot;ZDriver&quot;);
    create_and_start();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 234,10 ***</span>
<span class="line-new-header">--- 247,11 ---</span>
    case GCCause::_z_timer:
    case GCCause::_z_warmup:
    case GCCause::_z_allocation_rate:
    case GCCause::_z_allocation_stall:
    case GCCause::_z_proactive:
<span class="line-added">+   case GCCause::_z_high_usage:</span>
    case GCCause::_metadata_GC_threshold:
      // Start asynchronous GC
      _gc_cycle_port.send_async(cause);
      break;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 298,32 ***</span>
  void ZDriver::concurrent_reset_relocation_set() {
    ZStatTimer timer(ZPhaseConcurrentResetRelocationSet);
    ZHeap::heap()-&gt;reset_relocation_set();
  }
  
<span class="line-removed">- void ZDriver::concurrent_destroy_detached_pages() {</span>
<span class="line-removed">-   ZStatTimer timer(ZPhaseConcurrentDestroyDetachedPages);</span>
<span class="line-removed">-   ZHeap::heap()-&gt;destroy_detached_pages();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void ZDriver::pause_verify() {
    if (VerifyBeforeGC || VerifyDuringGC || VerifyAfterGC) {
      VM_Verify op;
      VMThread::execute(&amp;op);
    }
  }
  
  void ZDriver::concurrent_select_relocation_set() {
    ZStatTimer timer(ZPhaseConcurrentSelectRelocationSet);
    ZHeap::heap()-&gt;select_relocation_set();
  }
  
<span class="line-removed">- void ZDriver::concurrent_prepare_relocation_set() {</span>
<span class="line-removed">-   ZStatTimer timer(ZPhaseConcurrentPrepareRelocationSet);</span>
<span class="line-removed">-   ZHeap::heap()-&gt;prepare_relocation_set();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void ZDriver::pause_relocate_start() {
    pause&lt;VM_ZRelocateStart&gt;();
  }
  
  void ZDriver::concurrent_relocate() {
<span class="line-new-header">--- 312,27 ---</span>
  void ZDriver::concurrent_reset_relocation_set() {
    ZStatTimer timer(ZPhaseConcurrentResetRelocationSet);
    ZHeap::heap()-&gt;reset_relocation_set();
  }
  
  void ZDriver::pause_verify() {
    if (VerifyBeforeGC || VerifyDuringGC || VerifyAfterGC) {
<span class="line-added">+     // Full verification</span>
      VM_Verify op;
      VMThread::execute(&amp;op);
<span class="line-added">+   } else if (ZVerifyRoots || ZVerifyObjects) {</span>
<span class="line-added">+     // Limited verification</span>
<span class="line-added">+     VM_ZVerify op;</span>
<span class="line-added">+     VMThread::execute(&amp;op);</span>
    }
  }
  
  void ZDriver::concurrent_select_relocation_set() {
    ZStatTimer timer(ZPhaseConcurrentSelectRelocationSet);
    ZHeap::heap()-&gt;select_relocation_set();
  }
  
  void ZDriver::pause_relocate_start() {
    pause&lt;VM_ZRelocateStart&gt;();
  }
  
  void ZDriver::concurrent_relocate() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,17 ***</span>
    ZHeap::heap()-&gt;check_out_of_memory();
  }
  
  class ZDriverGCScope : public StackObj {
  private:
<span class="line-modified">!   GCIdMark      _gc_id;</span>
<span class="line-modified">!   GCCauseSetter _gc_cause_setter;</span>
<span class="line-modified">!   ZStatTimer    _timer;</span>
  
  public:
    ZDriverGCScope(GCCause::Cause cause) :
        _gc_id(),
        _gc_cause_setter(ZCollectedHeap::heap(), cause),
        _timer(ZPhaseCycle) {
      // Update statistics
      ZStatCycle::at_start();
    }
<span class="line-new-header">--- 344,19 ---</span>
    ZHeap::heap()-&gt;check_out_of_memory();
  }
  
  class ZDriverGCScope : public StackObj {
  private:
<span class="line-modified">!   GCIdMark       _gc_id;</span>
<span class="line-modified">!   GCCause::Cause _gc_cause;</span>
<span class="line-modified">!   GCCauseSetter  _gc_cause_setter;</span>
<span class="line-added">+   ZStatTimer     _timer;</span>
  
  public:
    ZDriverGCScope(GCCause::Cause cause) :
        _gc_id(),
<span class="line-added">+       _gc_cause(cause),</span>
        _gc_cause_setter(ZCollectedHeap::heap(), cause),
        _timer(ZPhaseCycle) {
      // Update statistics
      ZStatCycle::at_start();
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 354,11 ***</span>
      // Calculate boost factor
      const double boost_factor = (double)ZHeap::heap()-&gt;nconcurrent_worker_threads() /
                                  (double)ZHeap::heap()-&gt;nconcurrent_no_boost_worker_threads();
  
      // Update statistics
<span class="line-modified">!     ZStatCycle::at_end(boost_factor);</span>
  
      // Update data used by soft reference policy
      Universe::update_heap_info_at_gc();
    }
  };
<span class="line-new-header">--- 365,11 ---</span>
      // Calculate boost factor
      const double boost_factor = (double)ZHeap::heap()-&gt;nconcurrent_worker_threads() /
                                  (double)ZHeap::heap()-&gt;nconcurrent_no_boost_worker_threads();
  
      // Update statistics
<span class="line-modified">!     ZStatCycle::at_end(_gc_cause, boost_factor);</span>
  
      // Update data used by soft reference policy
      Universe::update_heap_info_at_gc();
    }
  };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,26 ***</span>
    concurrent_process_non_strong_references();
  
    // Phase 5: Concurrent Reset Relocation Set
    concurrent_reset_relocation_set();
  
<span class="line-modified">!   // Phase 6: Concurrent Destroy Detached Pages</span>
<span class="line-removed">-   concurrent_destroy_detached_pages();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Phase 7: Pause Verify</span>
    pause_verify();
  
<span class="line-modified">!   // Phase 8: Concurrent Select Relocation Set</span>
    concurrent_select_relocation_set();
  
<span class="line-modified">!   // Phase 9: Concurrent Prepare Relocation Set</span>
<span class="line-removed">-   concurrent_prepare_relocation_set();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Phase 10: Pause Relocate Start</span>
    pause_relocate_start();
  
<span class="line-modified">!   // Phase 11: Concurrent Relocate</span>
    concurrent_relocate();
  }
  
  void ZDriver::run_service() {
    // Main loop
<span class="line-new-header">--- 393,20 ---</span>
    concurrent_process_non_strong_references();
  
    // Phase 5: Concurrent Reset Relocation Set
    concurrent_reset_relocation_set();
  
<span class="line-modified">!   // Phase 6: Pause Verify</span>
    pause_verify();
  
<span class="line-modified">!   // Phase 7: Concurrent Select Relocation Set</span>
    concurrent_select_relocation_set();
  
<span class="line-modified">!   // Phase 8: Pause Relocate Start</span>
    pause_relocate_start();
  
<span class="line-modified">!   // Phase 9: Concurrent Relocate</span>
    concurrent_relocate();
  }
  
  void ZDriver::run_service() {
    // Main loop
</pre>
<center><a href="zDirector.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zDriver.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>