<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/z/zRootsIterator.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &quot;precompiled.hpp&quot;
 25 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 26 #include &quot;classfile/stringTable.hpp&quot;
 27 #include &quot;classfile/systemDictionary.hpp&quot;
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;compiler/oopMap.hpp&quot;
 30 #include &quot;gc/shared/barrierSet.hpp&quot;
 31 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
 32 #include &quot;gc/shared/oopStorageParState.inline.hpp&quot;
<a name="2" id="anc2"></a>
 33 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
 34 #include &quot;gc/z/zBarrierSetNMethod.hpp&quot;
 35 #include &quot;gc/z/zGlobals.hpp&quot;
 36 #include &quot;gc/z/zNMethod.hpp&quot;
 37 #include &quot;gc/z/zOopClosures.inline.hpp&quot;
 38 #include &quot;gc/z/zRootsIterator.hpp&quot;
 39 #include &quot;gc/z/zStat.hpp&quot;
 40 #include &quot;gc/z/zThreadLocalData.hpp&quot;
<a name="3" id="anc3"></a>
 41 #include &quot;memory/resourceArea.hpp&quot;
 42 #include &quot;memory/universe.hpp&quot;
 43 #include &quot;prims/jvmtiExport.hpp&quot;
<a name="4" id="anc4"></a>
 44 #include &quot;runtime/atomic.hpp&quot;
<a name="5" id="anc5"></a><span class="line-removed"> 45 #include &quot;runtime/jniHandles.hpp&quot;</span>
<span class="line-removed"> 46 #include &quot;runtime/thread.hpp&quot;</span>
 47 #include &quot;runtime/safepoint.hpp&quot;
 48 #include &quot;runtime/synchronizer.hpp&quot;
<a name="6" id="anc6"></a>

 49 #include &quot;services/management.hpp&quot;
 50 #include &quot;utilities/debug.hpp&quot;
 51 #if INCLUDE_JFR
 52 #include &quot;jfr/jfr.hpp&quot;
 53 #endif
 54 
 55 static const ZStatSubPhase ZSubPhasePauseRootsSetup(&quot;Pause Roots Setup&quot;);
 56 static const ZStatSubPhase ZSubPhasePauseRoots(&quot;Pause Roots&quot;);
 57 static const ZStatSubPhase ZSubPhasePauseRootsTeardown(&quot;Pause Roots Teardown&quot;);
 58 static const ZStatSubPhase ZSubPhasePauseRootsUniverse(&quot;Pause Roots Universe&quot;);
 59 static const ZStatSubPhase ZSubPhasePauseRootsObjectSynchronizer(&quot;Pause Roots ObjectSynchronizer&quot;);
 60 static const ZStatSubPhase ZSubPhasePauseRootsManagement(&quot;Pause Roots Management&quot;);
 61 static const ZStatSubPhase ZSubPhasePauseRootsJVMTIExport(&quot;Pause Roots JVMTIExport&quot;);
 62 static const ZStatSubPhase ZSubPhasePauseRootsJVMTIWeakExport(&quot;Pause Roots JVMTIWeakExport&quot;);
 63 static const ZStatSubPhase ZSubPhasePauseRootsSystemDictionary(&quot;Pause Roots SystemDictionary&quot;);
<a name="7" id="anc7"></a><span class="line-modified"> 64 static const ZStatSubPhase ZSubPhasePauseRootsThreads(&quot;Pause Roots Threads&quot;);</span>

 65 static const ZStatSubPhase ZSubPhasePauseRootsCodeCache(&quot;Pause Roots CodeCache&quot;);
 66 
 67 static const ZStatSubPhase ZSubPhaseConcurrentRootsSetup(&quot;Concurrent Roots Setup&quot;);
 68 static const ZStatSubPhase ZSubPhaseConcurrentRoots(&quot;Concurrent Roots&quot;);
 69 static const ZStatSubPhase ZSubPhaseConcurrentRootsTeardown(&quot;Concurrent Roots Teardown&quot;);
 70 static const ZStatSubPhase ZSubPhaseConcurrentRootsJNIHandles(&quot;Concurrent Roots JNIHandles&quot;);
<a name="8" id="anc8"></a>
 71 static const ZStatSubPhase ZSubPhaseConcurrentRootsClassLoaderDataGraph(&quot;Concurrent Roots ClassLoaderDataGraph&quot;);
 72 
 73 static const ZStatSubPhase ZSubPhasePauseWeakRootsSetup(&quot;Pause Weak Roots Setup&quot;);
 74 static const ZStatSubPhase ZSubPhasePauseWeakRoots(&quot;Pause Weak Roots&quot;);
 75 static const ZStatSubPhase ZSubPhasePauseWeakRootsTeardown(&quot;Pause Weak Roots Teardown&quot;);
 76 static const ZStatSubPhase ZSubPhasePauseWeakRootsJVMTIWeakExport(&quot;Pause Weak Roots JVMTIWeakExport&quot;);
 77 static const ZStatSubPhase ZSubPhasePauseWeakRootsJFRWeak(&quot;Pause Weak Roots JFRWeak&quot;);
 78 
 79 static const ZStatSubPhase ZSubPhaseConcurrentWeakRoots(&quot;Concurrent Weak Roots&quot;);
 80 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsVMWeakHandles(&quot;Concurrent Weak Roots VMWeakHandles&quot;);
 81 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsJNIWeakHandles(&quot;Concurrent Weak Roots JNIWeakHandles&quot;);
 82 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsStringTable(&quot;Concurrent Weak Roots StringTable&quot;);
<a name="9" id="anc9"></a>
 83 
 84 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
 85 ZSerialOopsDo&lt;T, F&gt;::ZSerialOopsDo(T* iter) :
 86     _iter(iter),
 87     _claimed(false) {}
 88 
 89 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
 90 void ZSerialOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
<a name="10" id="anc10"></a><span class="line-modified"> 91   if (!_claimed &amp;&amp; Atomic::cmpxchg(true, &amp;_claimed, false) == false) {</span>
 92     (_iter-&gt;*F)(cl);
 93   }
 94 }
 95 
 96 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
 97 ZParallelOopsDo&lt;T, F&gt;::ZParallelOopsDo(T* iter) :
 98     _iter(iter),
 99     _completed(false) {}
100 
101 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
102 void ZParallelOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
103   if (!_completed) {
104     (_iter-&gt;*F)(cl);
105     if (!_completed) {
106       _completed = true;
107     }
108   }
109 }
110 
111 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
112 ZSerialWeakOopsDo&lt;T, F&gt;::ZSerialWeakOopsDo(T* iter) :
113     _iter(iter),
114     _claimed(false) {}
115 
116 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
117 void ZSerialWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
<a name="11" id="anc11"></a><span class="line-modified">118   if (!_claimed &amp;&amp; Atomic::cmpxchg(true, &amp;_claimed, false) == false) {</span>
119     (_iter-&gt;*F)(is_alive, cl);
120   }
121 }
122 
123 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
124 ZParallelWeakOopsDo&lt;T, F&gt;::ZParallelWeakOopsDo(T* iter) :
125     _iter(iter),
126     _completed(false) {}
127 
128 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
129 void ZParallelWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
130   if (!_completed) {
131     (_iter-&gt;*F)(is_alive, cl);
132     if (!_completed) {
133       _completed = true;
134     }
135   }
136 }
137 
<a name="12" id="anc12"></a><span class="line-modified">138 class ZRootsIteratorCodeBlobClosure : public CodeBlobToOopClosure {</span>
139 private:
<a name="13" id="anc13"></a><span class="line-modified">140   BarrierSetNMethod* _bs;</span>

141 
142 public:
<a name="14" id="anc14"></a><span class="line-modified">143   ZRootsIteratorCodeBlobClosure(OopClosure* cl) :</span>
<span class="line-modified">144     CodeBlobToOopClosure(cl, true /* fix_relocations */),</span>
<span class="line-modified">145     _bs(BarrierSet::barrier_set()-&gt;barrier_set_nmethod()) {}</span>
146 
147   virtual void do_code_blob(CodeBlob* cb) {
148     nmethod* const nm = cb-&gt;as_nmethod_or_null();
<a name="15" id="anc15"></a><span class="line-modified">149     if (nm != NULL &amp;&amp; !nm-&gt;test_set_oops_do_mark()) {</span>
<span class="line-modified">150       CodeBlobToOopClosure::do_code_blob(cb);</span>
<span class="line-modified">151       _bs-&gt;disarm(nm);</span>




152     }
153   }
154 };
155 
156 class ZRootsIteratorThreadClosure : public ThreadClosure {
157 private:
<a name="16" id="anc16"></a><span class="line-modified">158   ZRootsIteratorClosure* _cl;</span>

159 
160 public:
161   ZRootsIteratorThreadClosure(ZRootsIteratorClosure* cl) :
162       _cl(cl) {}
163 
164   virtual void do_thread(Thread* thread) {
165     ZRootsIteratorCodeBlobClosure code_cl(_cl);
166     thread-&gt;oops_do(_cl, ClassUnloading ? &amp;code_cl : NULL);
167     _cl-&gt;do_thread(thread);
168   }
169 };
170 
<a name="17" id="anc17"></a><span class="line-modified">171 ZRootsIterator::ZRootsIterator() :</span>
















172     _universe(this),
173     _object_synchronizer(this),
174     _management(this),
175     _jvmti_export(this),
176     _jvmti_weak_export(this),
177     _system_dictionary(this),
<a name="18" id="anc18"></a><span class="line-modified">178     _threads(this),</span>

179     _code_cache(this) {
180   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
181   ZStatTimer timer(ZSubPhasePauseRootsSetup);
<a name="19" id="anc19"></a><span class="line-modified">182   Threads::change_thread_claim_parity();</span>
<span class="line-removed">183   COMPILER2_PRESENT(DerivedPointerTable::clear());</span>
184   if (ClassUnloading) {
185     nmethod::oops_do_marking_prologue();
186   } else {
187     ZNMethod::oops_do_begin();
188   }
189 }
190 
191 ZRootsIterator::~ZRootsIterator() {
192   ZStatTimer timer(ZSubPhasePauseRootsTeardown);
193   ResourceMark rm;
194   if (ClassUnloading) {
195     nmethod::oops_do_marking_epilogue();
196   } else {
197     ZNMethod::oops_do_end();
198   }
<a name="20" id="anc20"></a><span class="line-removed">199   JvmtiExport::gc_epilogue();</span>
200 
<a name="21" id="anc21"></a><span class="line-modified">201   COMPILER2_PRESENT(DerivedPointerTable::update_pointers());</span>
<span class="line-removed">202   Threads::assert_all_threads_claimed();</span>
203 }
204 
205 void ZRootsIterator::do_universe(ZRootsIteratorClosure* cl) {
206   ZStatTimer timer(ZSubPhasePauseRootsUniverse);
207   Universe::oops_do(cl);
208 }
209 
210 void ZRootsIterator::do_object_synchronizer(ZRootsIteratorClosure* cl) {
211   ZStatTimer timer(ZSubPhasePauseRootsObjectSynchronizer);
212   ObjectSynchronizer::oops_do(cl);
213 }
214 
215 void ZRootsIterator::do_management(ZRootsIteratorClosure* cl) {
216   ZStatTimer timer(ZSubPhasePauseRootsManagement);
217   Management::oops_do(cl);
218 }
219 
220 void ZRootsIterator::do_jvmti_export(ZRootsIteratorClosure* cl) {
221   ZStatTimer timer(ZSubPhasePauseRootsJVMTIExport);
222   JvmtiExport::oops_do(cl);
223 }
224 
225 void ZRootsIterator::do_jvmti_weak_export(ZRootsIteratorClosure* cl) {
226   ZStatTimer timer(ZSubPhasePauseRootsJVMTIWeakExport);
227   AlwaysTrueClosure always_alive;
228   JvmtiExport::weak_oops_do(&amp;always_alive, cl);
229 }
230 
231 void ZRootsIterator::do_system_dictionary(ZRootsIteratorClosure* cl) {
232   ZStatTimer timer(ZSubPhasePauseRootsSystemDictionary);
<a name="22" id="anc22"></a><span class="line-modified">233   SystemDictionary::oops_do(cl);</span>

234 }
235 
<a name="23" id="anc23"></a><span class="line-modified">236 void ZRootsIterator::do_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-modified">237   ZStatTimer timer(ZSubPhasePauseRootsThreads);</span>
<span class="line-removed">238   ResourceMark rm;</span>
239   ZRootsIteratorThreadClosure thread_cl(cl);
<a name="24" id="anc24"></a><span class="line-modified">240   Threads::possibly_parallel_threads_do(true, &amp;thread_cl);</span>






241 }
242 
243 void ZRootsIterator::do_code_cache(ZRootsIteratorClosure* cl) {
244   ZStatTimer timer(ZSubPhasePauseRootsCodeCache);
245   ZNMethod::oops_do(cl);
246 }
247 
<a name="25" id="anc25"></a><span class="line-modified">248 void ZRootsIterator::oops_do(ZRootsIteratorClosure* cl, bool visit_jvmti_weak_export) {</span>
249   ZStatTimer timer(ZSubPhasePauseRoots);
250   _universe.oops_do(cl);
251   _object_synchronizer.oops_do(cl);
252   _management.oops_do(cl);
253   _jvmti_export.oops_do(cl);
254   _system_dictionary.oops_do(cl);
<a name="26" id="anc26"></a><span class="line-modified">255   _threads.oops_do(cl);</span>

256   if (!ClassUnloading) {
257     _code_cache.oops_do(cl);
258   }
<a name="27" id="anc27"></a><span class="line-modified">259   if (visit_jvmti_weak_export) {</span>
260     _jvmti_weak_export.oops_do(cl);
261   }
262 }
263 
<a name="28" id="anc28"></a><span class="line-modified">264 ZConcurrentRootsIterator::ZConcurrentRootsIterator(bool marking) :</span>
<span class="line-modified">265     _marking(marking),</span>
<span class="line-modified">266     _sts_joiner(marking /* active */),</span>
<span class="line-modified">267     _jni_handles_iter(JNIHandles::global_handles()),</span>
268     _jni_handles(this),
<a name="29" id="anc29"></a>
269     _class_loader_data_graph(this) {
270   ZStatTimer timer(ZSubPhaseConcurrentRootsSetup);
<a name="30" id="anc30"></a><span class="line-modified">271   if (_marking) {</span>
<span class="line-removed">272     ClassLoaderDataGraph_lock-&gt;lock();</span>
<span class="line-removed">273     ClassLoaderDataGraph::clear_claimed_marks();</span>
<span class="line-removed">274   }</span>
275 }
276 
277 ZConcurrentRootsIterator::~ZConcurrentRootsIterator() {
278   ZStatTimer timer(ZSubPhaseConcurrentRootsTeardown);
<a name="31" id="anc31"></a><span class="line-removed">279   if (_marking) {</span>
<span class="line-removed">280     ClassLoaderDataGraph_lock-&gt;unlock();</span>
<span class="line-removed">281   }</span>
282 }
283 
284 void ZConcurrentRootsIterator::do_jni_handles(ZRootsIteratorClosure* cl) {
285   ZStatTimer timer(ZSubPhaseConcurrentRootsJNIHandles);
286   _jni_handles_iter.oops_do(cl);
287 }
288 
<a name="32" id="anc32"></a>




289 void ZConcurrentRootsIterator::do_class_loader_data_graph(ZRootsIteratorClosure* cl) {
290   ZStatTimer timer(ZSubPhaseConcurrentRootsClassLoaderDataGraph);
<a name="33" id="anc33"></a><span class="line-modified">291   if (_marking) {</span>
<span class="line-modified">292     CLDToOopClosure cld_cl(cl, ClassLoaderData::_claim_strong);</span>
<span class="line-removed">293     ClassLoaderDataGraph::always_strong_cld_do(&amp;cld_cl);</span>
<span class="line-removed">294   } else {</span>
<span class="line-removed">295     CLDToOopClosure cld_cl(cl, ClassLoaderData::_claim_none);</span>
<span class="line-removed">296     ClassLoaderDataGraph::cld_do(&amp;cld_cl);</span>
<span class="line-removed">297   }</span>
298 }
299 
300 void ZConcurrentRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
301   ZStatTimer timer(ZSubPhaseConcurrentRoots);
302   _jni_handles.oops_do(cl);
<a name="34" id="anc34"></a>
303   _class_loader_data_graph.oops_do(cl);
304 }
305 
306 ZWeakRootsIterator::ZWeakRootsIterator() :
307     _jvmti_weak_export(this),
308     _jfr_weak(this) {
309   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
310   ZStatTimer timer(ZSubPhasePauseWeakRootsSetup);
311 }
312 
313 ZWeakRootsIterator::~ZWeakRootsIterator() {
314   ZStatTimer timer(ZSubPhasePauseWeakRootsTeardown);
315 }
316 
317 void ZWeakRootsIterator::do_jvmti_weak_export(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
318   ZStatTimer timer(ZSubPhasePauseWeakRootsJVMTIWeakExport);
319   JvmtiExport::weak_oops_do(is_alive, cl);
320 }
321 
322 void ZWeakRootsIterator::do_jfr_weak(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
323 #if INCLUDE_JFR
324   ZStatTimer timer(ZSubPhasePauseWeakRootsJFRWeak);
325   Jfr::weak_oops_do(is_alive, cl);
326 #endif
327 }
328 
329 void ZWeakRootsIterator::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
330   ZStatTimer timer(ZSubPhasePauseWeakRoots);
331   _jvmti_weak_export.weak_oops_do(is_alive, cl);
332   _jfr_weak.weak_oops_do(is_alive, cl);
333 }
334 
335 void ZWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
336   AlwaysTrueClosure always_alive;
337   weak_oops_do(&amp;always_alive, cl);
338 }
339 
340 ZConcurrentWeakRootsIterator::ZConcurrentWeakRootsIterator() :
<a name="35" id="anc35"></a><span class="line-modified">341     _vm_weak_handles_iter(SystemDictionary::vm_weak_oop_storage()),</span>
<span class="line-modified">342     _jni_weak_handles_iter(JNIHandles::weak_global_handles()),</span>
<span class="line-modified">343     _string_table_iter(StringTable::weak_storage()),</span>

344     _vm_weak_handles(this),
345     _jni_weak_handles(this),
<a name="36" id="anc36"></a><span class="line-modified">346     _string_table(this) {</span>

347   StringTable::reset_dead_counter();
<a name="37" id="anc37"></a>
348 }
349 
350 ZConcurrentWeakRootsIterator::~ZConcurrentWeakRootsIterator() {
351   StringTable::finish_dead_counter();
<a name="38" id="anc38"></a>
352 }
353 
354 void ZConcurrentWeakRootsIterator::do_vm_weak_handles(ZRootsIteratorClosure* cl) {
355   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsVMWeakHandles);
356   _vm_weak_handles_iter.oops_do(cl);
357 }
358 
359 void ZConcurrentWeakRootsIterator::do_jni_weak_handles(ZRootsIteratorClosure* cl) {
360   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsJNIWeakHandles);
361   _jni_weak_handles_iter.oops_do(cl);
362 }
363 
<a name="39" id="anc39"></a><span class="line-modified">364 class ZStringTableDeadCounterClosure : public ZRootsIteratorClosure  {</span>

365 private:
366   ZRootsIteratorClosure* const _cl;
367   size_t                       _ndead;
368 
369 public:
<a name="40" id="anc40"></a><span class="line-modified">370   ZStringTableDeadCounterClosure(ZRootsIteratorClosure* cl) :</span>
371       _cl(cl),
372       _ndead(0) {}
373 
<a name="41" id="anc41"></a><span class="line-modified">374   ~ZStringTableDeadCounterClosure() {</span>
<span class="line-modified">375     StringTable::inc_dead_counter(_ndead);</span>
376   }
377 
378   virtual void do_oop(oop* p) {
379     _cl-&gt;do_oop(p);
380     if (*p == NULL) {
381       _ndead++;
382     }
383   }
384 
385   virtual void do_oop(narrowOop* p) {
386     ShouldNotReachHere();
387   }
388 };
389 
390 void ZConcurrentWeakRootsIterator::do_string_table(ZRootsIteratorClosure* cl) {
391   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsStringTable);
<a name="42" id="anc42"></a><span class="line-modified">392   ZStringTableDeadCounterClosure counter_cl(cl);</span>
393   _string_table_iter.oops_do(&amp;counter_cl);
394 }
395 
<a name="43" id="anc43"></a>





396 void ZConcurrentWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
397   ZStatTimer timer(ZSubPhaseConcurrentWeakRoots);
398   _vm_weak_handles.oops_do(cl);
399   _jni_weak_handles.oops_do(cl);
400   _string_table.oops_do(cl);
<a name="44" id="anc44"></a><span class="line-modified">401 }</span>
<span class="line-removed">402 </span>
<span class="line-removed">403 ZThreadRootsIterator::ZThreadRootsIterator() :</span>
<span class="line-removed">404     _threads(this) {</span>
<span class="line-removed">405   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);</span>
<span class="line-removed">406   ZStatTimer timer(ZSubPhasePauseRootsSetup);</span>
<span class="line-removed">407   Threads::change_thread_claim_parity();</span>
<span class="line-removed">408 }</span>
<span class="line-removed">409 </span>
<span class="line-removed">410 ZThreadRootsIterator::~ZThreadRootsIterator() {</span>
<span class="line-removed">411   ZStatTimer timer(ZSubPhasePauseRootsTeardown);</span>
<span class="line-removed">412   Threads::assert_all_threads_claimed();</span>
<span class="line-removed">413 }</span>
<span class="line-removed">414 </span>
<span class="line-removed">415 void ZThreadRootsIterator::do_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-removed">416   ZStatTimer timer(ZSubPhasePauseRootsThreads);</span>
<span class="line-removed">417   ResourceMark rm;</span>
<span class="line-removed">418   Threads::possibly_parallel_oops_do(true, cl, NULL);</span>
<span class="line-removed">419 }</span>
<span class="line-removed">420 </span>
<span class="line-removed">421 void ZThreadRootsIterator::oops_do(ZRootsIteratorClosure* cl) {</span>
<span class="line-removed">422   ZStatTimer timer(ZSubPhasePauseRoots);</span>
<span class="line-removed">423   _threads.oops_do(cl);</span>
424 }
<a name="45" id="anc45"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="45" type="hidden" />
</body>
</html>