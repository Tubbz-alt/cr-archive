<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/z/zRootsIterator.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zRootsIterator.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zRuntimeWorkers.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zRootsIterator.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 27,16 ***</span>
  #include &quot;gc/shared/oopStorageParState.hpp&quot;
  #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;runtime/thread.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  
<span class="line-modified">! class ZRootsIteratorClosure : public OopClosure {</span>
<span class="line-removed">- public:</span>
<span class="line-removed">-   virtual void do_thread(Thread* thread) {}</span>
<span class="line-removed">- };</span>
  
  typedef OopStorage::ParState&lt;true /* concurrent */, false /* is_const */&gt; ZOopStorageIterator;
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  class ZSerialOopsDo {
<span class="line-new-header">--- 27,14 ---</span>
  #include &quot;gc/shared/oopStorageParState.hpp&quot;
  #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;runtime/thread.hpp&quot;
<span class="line-added">+ #include &quot;runtime/threadSMR.hpp&quot;</span>
  #include &quot;utilities/globalDefinitions.hpp&quot;
  
<span class="line-modified">! class ZRootsIteratorClosure;</span>
  
  typedef OopStorage::ParState&lt;true /* concurrent */, false /* is_const */&gt; ZOopStorageIterator;
  
  template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
  class ZSerialOopsDo {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 80,63 ***</span>
  public:
    ZParallelWeakOopsDo(T* iter);
    void weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
  };
  
  class ZRootsIterator {
  private:
    void do_universe(ZRootsIteratorClosure* cl);
    void do_object_synchronizer(ZRootsIteratorClosure* cl);
    void do_management(ZRootsIteratorClosure* cl);
    void do_jvmti_export(ZRootsIteratorClosure* cl);
    void do_jvmti_weak_export(ZRootsIteratorClosure* cl);
    void do_system_dictionary(ZRootsIteratorClosure* cl);
<span class="line-modified">!   void do_threads(ZRootsIteratorClosure* cl);</span>
    void do_code_cache(ZRootsIteratorClosure* cl);
  
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_universe&gt;            _universe;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_object_synchronizer&gt; _object_synchronizer;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_management&gt;          _management;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_jvmti_export&gt;        _jvmti_export;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_jvmti_weak_export&gt;   _jvmti_weak_export;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_system_dictionary&gt;   _system_dictionary;
<span class="line-modified">!   ZParallelOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_threads&gt;           _threads;</span>
    ZParallelOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_code_cache&gt;        _code_cache;
  
  public:
<span class="line-modified">!   ZRootsIterator();</span>
    ~ZRootsIterator();
  
<span class="line-modified">!   void oops_do(ZRootsIteratorClosure* cl, bool visit_jvmti_weak_export = false);</span>
  };
  
  class ZConcurrentRootsIterator {
  private:
<span class="line-modified">!   const bool                 _marking;</span>
<span class="line-modified">!   SuspendibleThreadSetJoiner _sts_joiner;</span>
<span class="line-modified">!   ZOopStorageIterator        _jni_handles_iter;</span>
  
    void do_jni_handles(ZRootsIteratorClosure* cl);
    void do_class_loader_data_graph(ZRootsIteratorClosure* cl);
  
    ZParallelOopsDo&lt;ZConcurrentRootsIterator, &amp;ZConcurrentRootsIterator::do_jni_handles&gt;             _jni_handles;
    ZParallelOopsDo&lt;ZConcurrentRootsIterator, &amp;ZConcurrentRootsIterator::do_class_loader_data_graph&gt; _class_loader_data_graph;
  
  public:
<span class="line-modified">!   ZConcurrentRootsIterator(bool marking = false);</span>
    ~ZConcurrentRootsIterator();
  
    void oops_do(ZRootsIteratorClosure* cl);
  };
  
  class ZWeakRootsIterator {
  private:
    void do_jvmti_weak_export(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
    void do_jfr_weak(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
  
<span class="line-modified">!   ZSerialWeakOopsDo&lt;ZWeakRootsIterator, &amp;ZWeakRootsIterator::do_jvmti_weak_export&gt;  _jvmti_weak_export;</span>
<span class="line-modified">!   ZSerialWeakOopsDo&lt;ZWeakRootsIterator, &amp;ZWeakRootsIterator::do_jfr_weak&gt;           _jfr_weak;</span>
  
  public:
    ZWeakRootsIterator();
    ~ZWeakRootsIterator();
  
<span class="line-new-header">--- 78,110 ---</span>
  public:
    ZParallelWeakOopsDo(T* iter);
    void weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
  };
  
<span class="line-added">+ class ZRootsIteratorClosure : public OopClosure {</span>
<span class="line-added">+ public:</span>
<span class="line-added">+   virtual void do_thread(Thread* thread) {}</span>
<span class="line-added">+ </span>
<span class="line-added">+   virtual bool should_disarm_nmethods() const {</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ class ZJavaThreadsIterator {</span>
<span class="line-added">+ private:</span>
<span class="line-added">+   ThreadsListHandle _threads;</span>
<span class="line-added">+   volatile uint     _claimed;</span>
<span class="line-added">+ </span>
<span class="line-added">+   uint claim();</span>
<span class="line-added">+ </span>
<span class="line-added">+ public:</span>
<span class="line-added">+   ZJavaThreadsIterator();</span>
<span class="line-added">+ </span>
<span class="line-added">+   void threads_do(ThreadClosure* cl);</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
  class ZRootsIterator {
  private:
<span class="line-added">+   const bool           _visit_jvmti_weak_export;</span>
<span class="line-added">+   ZJavaThreadsIterator _java_threads_iter;</span>
<span class="line-added">+ </span>
    void do_universe(ZRootsIteratorClosure* cl);
    void do_object_synchronizer(ZRootsIteratorClosure* cl);
    void do_management(ZRootsIteratorClosure* cl);
    void do_jvmti_export(ZRootsIteratorClosure* cl);
    void do_jvmti_weak_export(ZRootsIteratorClosure* cl);
    void do_system_dictionary(ZRootsIteratorClosure* cl);
<span class="line-modified">!   void do_vm_thread(ZRootsIteratorClosure* cl);</span>
<span class="line-added">+   void do_java_threads(ZRootsIteratorClosure* cl);</span>
    void do_code_cache(ZRootsIteratorClosure* cl);
  
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_universe&gt;            _universe;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_object_synchronizer&gt; _object_synchronizer;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_management&gt;          _management;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_jvmti_export&gt;        _jvmti_export;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_jvmti_weak_export&gt;   _jvmti_weak_export;
    ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_system_dictionary&gt;   _system_dictionary;
<span class="line-modified">!   ZSerialOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_vm_thread&gt;           _vm_thread;</span>
<span class="line-added">+   ZParallelOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_java_threads&gt;      _java_threads;</span>
    ZParallelOopsDo&lt;ZRootsIterator, &amp;ZRootsIterator::do_code_cache&gt;        _code_cache;
  
  public:
<span class="line-modified">!   ZRootsIterator(bool visit_jvmti_weak_export = false);</span>
    ~ZRootsIterator();
  
<span class="line-modified">!   void oops_do(ZRootsIteratorClosure* cl);</span>
  };
  
  class ZConcurrentRootsIterator {
  private:
<span class="line-modified">!   ZOopStorageIterator _jni_handles_iter;</span>
<span class="line-modified">!   ZOopStorageIterator _vm_handles_iter;</span>
<span class="line-modified">!   const int           _cld_claim;</span>
  
    void do_jni_handles(ZRootsIteratorClosure* cl);
<span class="line-added">+   void do_vm_handles(ZRootsIteratorClosure* cl);</span>
    void do_class_loader_data_graph(ZRootsIteratorClosure* cl);
  
    ZParallelOopsDo&lt;ZConcurrentRootsIterator, &amp;ZConcurrentRootsIterator::do_jni_handles&gt;             _jni_handles;
<span class="line-added">+   ZParallelOopsDo&lt;ZConcurrentRootsIterator, &amp;ZConcurrentRootsIterator::do_vm_handles&gt;              _vm_handles;</span>
    ZParallelOopsDo&lt;ZConcurrentRootsIterator, &amp;ZConcurrentRootsIterator::do_class_loader_data_graph&gt; _class_loader_data_graph;
  
  public:
<span class="line-modified">!   ZConcurrentRootsIterator(int cld_claim);</span>
    ~ZConcurrentRootsIterator();
  
    void oops_do(ZRootsIteratorClosure* cl);
  };
  
<span class="line-added">+ class ZConcurrentRootsIteratorClaimStrong : public ZConcurrentRootsIterator {</span>
<span class="line-added">+ public:</span>
<span class="line-added">+   ZConcurrentRootsIteratorClaimStrong() :</span>
<span class="line-added">+       ZConcurrentRootsIterator(ClassLoaderData::_claim_strong) {}</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ class ZConcurrentRootsIteratorClaimOther : public ZConcurrentRootsIterator {</span>
<span class="line-added">+ public:</span>
<span class="line-added">+   ZConcurrentRootsIteratorClaimOther() :</span>
<span class="line-added">+       ZConcurrentRootsIterator(ClassLoaderData::_claim_other) {}</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ class ZConcurrentRootsIteratorClaimNone : public ZConcurrentRootsIterator {</span>
<span class="line-added">+ public:</span>
<span class="line-added">+   ZConcurrentRootsIteratorClaimNone() :</span>
<span class="line-added">+       ZConcurrentRootsIterator(ClassLoaderData::_claim_none) {}</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
  class ZWeakRootsIterator {
  private:
    void do_jvmti_weak_export(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
    void do_jfr_weak(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl);
  
<span class="line-modified">!   ZSerialWeakOopsDo&lt;ZWeakRootsIterator, &amp;ZWeakRootsIterator::do_jvmti_weak_export&gt; _jvmti_weak_export;</span>
<span class="line-modified">!   ZSerialWeakOopsDo&lt;ZWeakRootsIterator, &amp;ZWeakRootsIterator::do_jfr_weak&gt;          _jfr_weak;</span>
  
  public:
    ZWeakRootsIterator();
    ~ZWeakRootsIterator();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 147,35 ***</span>
  class ZConcurrentWeakRootsIterator {
  private:
    ZOopStorageIterator _vm_weak_handles_iter;
    ZOopStorageIterator _jni_weak_handles_iter;
    ZOopStorageIterator _string_table_iter;
  
    void do_vm_weak_handles(ZRootsIteratorClosure* cl);
    void do_jni_weak_handles(ZRootsIteratorClosure* cl);
    void do_string_table(ZRootsIteratorClosure* cl);
  
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_vm_weak_handles&gt;  _vm_weak_handles;</span>
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_jni_weak_handles&gt; _jni_weak_handles;</span>
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_string_table&gt;     _string_table;</span>
  
  public:
    ZConcurrentWeakRootsIterator();
    ~ZConcurrentWeakRootsIterator();
  
    void oops_do(ZRootsIteratorClosure* cl);
  };
  
<span class="line-removed">- class ZThreadRootsIterator {</span>
<span class="line-removed">- private:</span>
<span class="line-removed">-   void do_threads(ZRootsIteratorClosure* cl);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   ZParallelOopsDo&lt;ZThreadRootsIterator, &amp;ZThreadRootsIterator::do_threads&gt; _threads;</span>
<span class="line-removed">- </span>
<span class="line-removed">- public:</span>
<span class="line-removed">-   ZThreadRootsIterator();</span>
<span class="line-removed">-   ~ZThreadRootsIterator();</span>
<span class="line-removed">- </span>
<span class="line-removed">-   void oops_do(ZRootsIteratorClosure* cl);</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
  #endif // SHARE_GC_Z_ZROOTSITERATOR_HPP
<span class="line-new-header">--- 192,25 ---</span>
  class ZConcurrentWeakRootsIterator {
  private:
    ZOopStorageIterator _vm_weak_handles_iter;
    ZOopStorageIterator _jni_weak_handles_iter;
    ZOopStorageIterator _string_table_iter;
<span class="line-added">+   ZOopStorageIterator _resolved_method_table_iter;</span>
  
    void do_vm_weak_handles(ZRootsIteratorClosure* cl);
    void do_jni_weak_handles(ZRootsIteratorClosure* cl);
    void do_string_table(ZRootsIteratorClosure* cl);
<span class="line-added">+   void do_resolved_method_table(ZRootsIteratorClosure* cl);</span>
  
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_vm_weak_handles&gt;       _vm_weak_handles;</span>
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_jni_weak_handles&gt;      _jni_weak_handles;</span>
<span class="line-modified">!   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_string_table&gt;          _string_table;</span>
<span class="line-added">+   ZParallelOopsDo&lt;ZConcurrentWeakRootsIterator, &amp;ZConcurrentWeakRootsIterator::do_resolved_method_table&gt; _resolved_method_table;</span>
  
  public:
    ZConcurrentWeakRootsIterator();
    ~ZConcurrentWeakRootsIterator();
  
    void oops_do(ZRootsIteratorClosure* cl);
  };
  
  #endif // SHARE_GC_Z_ZROOTSITERATOR_HPP
</pre>
<center><a href="zRootsIterator.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zRuntimeWorkers.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>