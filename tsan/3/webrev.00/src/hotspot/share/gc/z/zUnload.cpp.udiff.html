<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/z/zUnload.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zTracer.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zUnload.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zUnload.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,11 +34,12 @@</span>
  #include &quot;gc/z/zOopClosures.hpp&quot;
  #include &quot;gc/z/zStat.hpp&quot;
  #include &quot;gc/z/zUnload.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
  
<span class="udiff-line-modified-removed">- static const ZStatSubPhase ZSubPhaseConcurrentClassesUnload(&quot;Concurrent Classes Unload&quot;);</span>
<span class="udiff-line-modified-added">+ static const ZStatSubPhase ZSubPhaseConcurrentClassesUnlink(&quot;Concurrent Classes Unlink&quot;);</span>
<span class="udiff-line-added">+ static const ZStatSubPhase ZSubPhaseConcurrentClassesPurge(&quot;Concurrent Classes Purge&quot;);</span>
  
  class ZIsUnloadingOopClosure : public OopClosure {
  private:
    ZPhantomIsAliveObjectClosure _is_alive;
    bool                         _is_unloading;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,11 +70,11 @@</span>
    virtual bool is_unloading(CompiledMethod* method) const {
      nmethod* const nm = method-&gt;as_nmethod();
      ZReentrantLock* const lock = ZNMethod::lock_for_nmethod(nm);
      ZLocker&lt;ZReentrantLock&gt; locker(lock);
      ZIsUnloadingOopClosure cl;
<span class="udiff-line-modified-removed">-     nm-&gt;oops_do(&amp;cl, true /* allow_zombie */);</span>
<span class="udiff-line-modified-added">+     ZNMethod::nmethod_oops_do(nm, &amp;cl);</span>
      return cl.is_unloading();
    }
  };
  
  class ZCompiledICProtectionBehaviour : public CompiledICProtectionBehaviour {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,58 +125,44 @@</span>
    CodeCache::increment_unloading_cycle();
    DependencyContext::cleaning_start();
  }
  
  void ZUnload::unlink() {
<span class="udiff-line-added">+   if (!ClassUnloading) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ZStatTimer timer(ZSubPhaseConcurrentClassesUnlink);</span>
    SuspendibleThreadSetJoiner sts;
    bool unloading_occurred;
  
    {
<span class="udiff-line-modified-removed">-     MutexLockerEx ml(ClassLoaderDataGraph_lock);</span>
<span class="udiff-line-modified-added">+     MutexLocker ml(ClassLoaderDataGraph_lock);</span>
      unloading_occurred = SystemDictionary::do_unloading(ZStatPhase::timer());
    }
  
    Klass::clean_weak_klass_links(unloading_occurred);
<span class="udiff-line-removed">- </span>
    ZNMethod::unlink(_workers, unloading_occurred);
<span class="udiff-line-removed">- </span>
    DependencyContext::cleaning_end();
  }
  
  void ZUnload::purge() {
<span class="udiff-line-added">+   if (!ClassUnloading) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ZStatTimer timer(ZSubPhaseConcurrentClassesPurge);</span>
<span class="udiff-line-added">+ </span>
    {
      SuspendibleThreadSetJoiner sts;
      ZNMethod::purge(_workers);
    }
  
    ClassLoaderDataGraph::purge();
    CodeCache::purge_exception_caches();
  }
  
<span class="udiff-line-removed">- class ZUnloadRendezvousClosure : public ThreadClosure {</span>
<span class="udiff-line-removed">- public:</span>
<span class="udiff-line-removed">-   void do_thread(Thread* thread) {}</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ZUnload::unload() {</span>
<span class="udiff-line-removed">-   if (!ClassUnloading) {</span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ZStatTimer timer(ZSubPhaseConcurrentClassesUnload);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Unlink stale metadata and nmethods</span>
<span class="udiff-line-removed">-   unlink();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Make sure stale metadata and nmethods are no longer observable</span>
<span class="udiff-line-removed">-   ZUnloadRendezvousClosure cl;</span>
<span class="udiff-line-removed">-   Handshake::execute(&amp;cl);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Purge stale metadata and nmethods that were unlinked</span>
<span class="udiff-line-removed">-   purge();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void ZUnload::finish() {
    // Resize and verify metaspace
    MetaspaceGC::compute_new_size();
    MetaspaceUtils::verify_metrics();
  }
</pre>
<center><a href="zTracer.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zUnload.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>