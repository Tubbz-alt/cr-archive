<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/z/zGranuleMap.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zGranuleMap.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zHeap.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zGranuleMap.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,63 +22,82 @@</span>
   */
  
  #ifndef SHARE_GC_Z_ZGRANULEMAP_INLINE_HPP
  #define SHARE_GC_Z_ZGRANULEMAP_INLINE_HPP
  
<span class="udiff-line-removed">- #include &quot;gc/z/zAddress.inline.hpp&quot;</span>
  #include &quot;gc/z/zGlobals.hpp&quot;
  #include &quot;gc/z/zGranuleMap.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/align.hpp&quot;</span>
<span class="udiff-line-added">+ #include &quot;utilities/debug.hpp&quot;</span>
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- inline ZGranuleMap&lt;T&gt;::ZGranuleMap() :</span>
<span class="udiff-line-modified-removed">-     _map(MmapArrayAllocator&lt;T&gt;::allocate(size(), mtGC)) {}</span>
<span class="udiff-line-modified-added">+ inline ZGranuleMap&lt;T&gt;::ZGranuleMap(size_t max_offset) :</span>
<span class="udiff-line-modified-added">+     _size(max_offset &gt;&gt; ZGranuleSizeShift),</span>
<span class="udiff-line-added">+     _map(MmapArrayAllocator&lt;T&gt;::allocate(_size, mtGC)) {</span>
<span class="udiff-line-added">+   assert(is_aligned(max_offset, ZGranuleSize), &quot;Misaligned&quot;);</span>
<span class="udiff-line-added">+ }</span>
  
  template &lt;typename T&gt;
  inline ZGranuleMap&lt;T&gt;::~ZGranuleMap() {
<span class="udiff-line-modified-removed">-   MmapArrayAllocator&lt;T&gt;::free(_map, size());</span>
<span class="udiff-line-modified-added">+   MmapArrayAllocator&lt;T&gt;::free(_map, _size);</span>
  }
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- inline size_t ZGranuleMap&lt;T&gt;::index_for_addr(uintptr_t addr) const {</span>
<span class="udiff-line-modified-removed">-   assert(!ZAddress::is_null(addr), &quot;Invalid address&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-   const size_t index = ZAddress::offset(addr) &gt;&gt; ZGranuleSizeShift;</span>
<span class="udiff-line-removed">-   assert(index &lt; size(), &quot;Invalid index&quot;);</span>
<span class="udiff-line-modified-added">+ inline size_t ZGranuleMap&lt;T&gt;::index_for_offset(uintptr_t offset) const {</span>
<span class="udiff-line-modified-added">+   const size_t index = offset &gt;&gt; ZGranuleSizeShift;</span>
<span class="udiff-line-modified-added">+   assert(index &lt; _size, &quot;Invalid index&quot;);</span>
  
    return index;
  }
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- inline size_t ZGranuleMap&lt;T&gt;::size() const {</span>
<span class="udiff-line-modified-removed">-   return ZAddressOffsetMax &gt;&gt; ZGranuleSizeShift;</span>
<span class="udiff-line-modified-added">+ inline T ZGranuleMap&lt;T&gt;::get(uintptr_t offset) const {</span>
<span class="udiff-line-modified-added">+   const size_t index = index_for_offset(offset);</span>
<span class="udiff-line-added">+   return _map[index];</span>
  }
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- inline T ZGranuleMap&lt;T&gt;::get(uintptr_t addr) const {</span>
<span class="udiff-line-modified-removed">-   const size_t index = index_for_addr(addr);</span>
<span class="udiff-line-modified-removed">-   return _map[index];</span>
<span class="udiff-line-modified-added">+ inline void ZGranuleMap&lt;T&gt;::put(uintptr_t offset, T value) {</span>
<span class="udiff-line-modified-added">+   const size_t index = index_for_offset(offset);</span>
<span class="udiff-line-modified-added">+   _map[index] = value;</span>
  }
  
  template &lt;typename T&gt;
<span class="udiff-line-modified-removed">- inline void ZGranuleMap&lt;T&gt;::put(uintptr_t addr, T value) {</span>
<span class="udiff-line-modified-removed">-   const size_t index = index_for_addr(addr);</span>
<span class="udiff-line-modified-removed">-   _map[index] = value;</span>
<span class="udiff-line-modified-added">+ inline void ZGranuleMap&lt;T&gt;::put(uintptr_t offset, size_t size, T value) {</span>
<span class="udiff-line-modified-added">+   assert(is_aligned(size, ZGranuleSize), &quot;Misaligned&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   const size_t start_index = index_for_offset(offset);</span>
<span class="udiff-line-added">+   const size_t end_index = start_index + (size &gt;&gt; ZGranuleSizeShift);</span>
<span class="udiff-line-added">+   for (size_t index = start_index; index &lt; end_index; index++) {</span>
<span class="udiff-line-added">+     _map[index] = value;</span>
<span class="udiff-line-added">+   }</span>
  }
  
  template &lt;typename T&gt;
  inline ZGranuleMapIterator&lt;T&gt;::ZGranuleMapIterator(const ZGranuleMap&lt;T&gt;* map) :
      _map(map),
      _next(0) {}
  
  template &lt;typename T&gt;
  inline bool ZGranuleMapIterator&lt;T&gt;::next(T* value) {
<span class="udiff-line-modified-removed">-   if (_next &lt; _map-&gt;size()) {</span>
<span class="udiff-line-modified-added">+   if (_next &lt; _map-&gt;_size) {</span>
      *value = _map-&gt;_map[_next++];
      return true;
    }
  
    // End of map
    return false;
  }
  
<span class="udiff-line-added">+ template &lt;typename T&gt;</span>
<span class="udiff-line-added">+ inline bool ZGranuleMapIterator&lt;T&gt;::next(T** value) {</span>
<span class="udiff-line-added">+   if (_next &lt; _map-&gt;_size) {</span>
<span class="udiff-line-added">+     *value = _map-&gt;_map + _next++;</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // End of map</span>
<span class="udiff-line-added">+   return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #endif // SHARE_GC_Z_ZGRANULEMAP_INLINE_HPP
</pre>
<center><a href="zGranuleMap.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zHeap.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>