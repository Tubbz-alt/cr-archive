<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/z/zForwardingTable.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zDriver.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zForwardingTable.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zForwardingTable.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,65 +20,29 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="udiff-line-added">+ #include &quot;gc/z/zForwarding.inline.hpp&quot;</span>
  #include &quot;gc/z/zForwardingTable.inline.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/z/zUtils.inline.hpp&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;memory/allocation.inline.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/z/zGlobals.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/z/zGranuleMap.inline.hpp&quot;</span>
  #include &quot;utilities/debug.hpp&quot;
  
<span class="udiff-line-modified-removed">- void ZForwardingTable::setup(size_t live_objects) {</span>
<span class="udiff-line-modified-removed">-   assert(is_null(), &quot;Should be empty&quot;);</span>
<span class="udiff-line-removed">-   assert(live_objects &gt; 0, &quot;Invalid size&quot;);</span>
<span class="udiff-line-modified-added">+ ZForwardingTable::ZForwardingTable() :</span>
<span class="udiff-line-modified-added">+     _map(ZAddressOffsetMax) {}</span>
  
<span class="udiff-line-modified-removed">-   // Allocate table for linear probing. The size of the table must be</span>
<span class="udiff-line-modified-removed">-   // a power of two to allow for quick and inexpensive indexing/masking.</span>
<span class="udiff-line-modified-removed">-   // The table is sized to have a load factor of 50%, i.e. sized to have</span>
<span class="udiff-line-removed">-   // double the number of entries actually inserted.</span>
<span class="udiff-line-removed">-   _size = ZUtils::round_up_power_of_2(live_objects * 2);</span>
<span class="udiff-line-removed">-   _table = MallocArrayAllocator&lt;ZForwardingTableEntry&gt;::allocate(_size, mtGC);</span>
<span class="udiff-line-modified-added">+ void ZForwardingTable::insert(ZForwarding* forwarding) {</span>
<span class="udiff-line-modified-added">+   const uintptr_t offset = forwarding-&gt;start();</span>
<span class="udiff-line-modified-added">+   const size_t size = forwarding-&gt;size();</span>
  
<span class="udiff-line-modified-removed">-   // Construct table entries</span>
<span class="udiff-line-modified-removed">-   for (size_t i = 0; i &lt; _size; i++) {</span>
<span class="udiff-line-removed">-     ::new (_table + i) ZForwardingTableEntry();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   assert(_map.get(offset) == NULL, &quot;Invalid entry&quot;);</span>
<span class="udiff-line-modified-added">+   _map.put(offset, size, forwarding);</span>
  }
  
<span class="udiff-line-modified-removed">- void ZForwardingTable::reset() {</span>
<span class="udiff-line-modified-removed">-   // Destruct table entries</span>
<span class="udiff-line-modified-removed">-   for (size_t i = 0; i &lt; _size; i++) {</span>
<span class="udiff-line-removed">-     (_table + i)-&gt;~ZForwardingTableEntry();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+ void ZForwardingTable::remove(ZForwarding* forwarding) {</span>
<span class="udiff-line-modified-added">+   const uintptr_t offset = forwarding-&gt;start();</span>
<span class="udiff-line-modified-added">+   const size_t size = forwarding-&gt;size();</span>
  
<span class="udiff-line-modified-removed">-   // Free table</span>
<span class="udiff-line-modified-removed">-   MallocArrayAllocator&lt;ZForwardingTableEntry&gt;::free(_table);</span>
<span class="udiff-line-removed">-   _table = NULL;</span>
<span class="udiff-line-removed">-   _size = 0;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ZForwardingTable::verify(size_t object_max_count, size_t live_objects) const {</span>
<span class="udiff-line-removed">-   size_t count = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   for (size_t i = 0; i &lt; _size; i++) {</span>
<span class="udiff-line-removed">-     const ZForwardingTableEntry entry = _table[i];</span>
<span class="udiff-line-removed">-     if (entry.is_empty()) {</span>
<span class="udiff-line-removed">-       // Skip empty entries</span>
<span class="udiff-line-removed">-       continue;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Check from index</span>
<span class="udiff-line-removed">-     guarantee(entry.from_index() &lt; object_max_count, &quot;Invalid from index&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Check for duplicates</span>
<span class="udiff-line-removed">-     for (size_t j = i + 1; j &lt; _size; j++) {</span>
<span class="udiff-line-removed">-       const ZForwardingTableEntry other = _table[j];</span>
<span class="udiff-line-removed">-       guarantee(entry.from_index() != other.from_index(), &quot;Duplicate from&quot;);</span>
<span class="udiff-line-removed">-       guarantee(entry.to_offset() != other.to_offset(), &quot;Duplicate to&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     count++;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Check number of non-null entries</span>
<span class="udiff-line-removed">-   guarantee(live_objects == count, &quot;Count mismatch&quot;);</span>
<span class="udiff-line-modified-added">+   assert(_map.get(offset) == forwarding, &quot;Invalid entry&quot;);</span>
<span class="udiff-line-modified-added">+   _map.put(offset, size, NULL);</span>
  }
</pre>
<center><a href="zDriver.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zForwardingTable.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>