<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/z/zStat.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zRuntimeWorkers.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zStat.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zStat.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,16 +21,17 @@</span>
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/z/zCollectedHeap.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;gc/z/zCPU.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;gc/z/zCPU.inline.hpp&quot;</span>
  #include &quot;gc/z/zGlobals.hpp&quot;
  #include &quot;gc/z/zHeap.inline.hpp&quot;
  #include &quot;gc/z/zLargePages.inline.hpp&quot;
  #include &quot;gc/z/zNMethodTable.hpp&quot;
  #include &quot;gc/z/zNUMA.hpp&quot;
<span class="udiff-line-added">+ #include &quot;gc/z/zRelocationSetSelector.inline.hpp&quot;</span>
  #include &quot;gc/z/zStat.hpp&quot;
  #include &quot;gc/z/zTracer.inline.hpp&quot;
  #include &quot;gc/z/zUtils.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +40,18 @@</span>
  #include &quot;utilities/align.hpp&quot;
  #include &quot;utilities/compilerWarnings.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/ticks.hpp&quot;
  
<span class="udiff-line-added">+ #define ZSIZE_FMT                       SIZE_FORMAT &quot;M(%.0f%%)&quot;</span>
<span class="udiff-line-added">+ #define ZSIZE_ARGS_WITH_MAX(size, max)  ((size) / M), (percent_of(size, max))</span>
<span class="udiff-line-added">+ #define ZSIZE_ARGS(size)                ZSIZE_ARGS_WITH_MAX(size, ZStatHeap::max_capacity())</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #define ZTABLE_ARGS_NA                  &quot;%9s&quot;, &quot;-&quot;</span>
<span class="udiff-line-added">+ #define ZTABLE_ARGS(size)               SIZE_FORMAT_W(8) &quot;M (%.0f%%)&quot;, \</span>
<span class="udiff-line-added">+                                         ((size) / M), (percent_of(size, ZStatHeap::max_capacity()))</span>
<span class="udiff-line-added">+ </span>
  //
  // Stat sampler/counter data
  //
  struct ZStatSamplerData {
    uint64_t _nsamples;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,11 +63,11 @@</span>
      _sum(0),
      _max(0) {}
  
    void add(const ZStatSamplerData&amp; new_sample) {
      _nsamples += new_sample._nsamples;
<span class="udiff-line-modified-removed">-     _sum += new_sample._nsamples;</span>
<span class="udiff-line-modified-added">+     _sum += new_sample._sum;</span>
      _max = MAX2(_max, new_sample._max);
    }
  };
  
  struct ZStatCounterData {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,11 +237,11 @@</span>
  
  //
  // Stat unit printers
  //
  void ZStatUnitTime(LogTargetHandle log, const ZStatSampler&amp; sampler, const ZStatSamplerHistory&amp; history) {
<span class="udiff-line-modified-removed">-   log.print(&quot; %10s: %-40s  &quot;</span>
<span class="udiff-line-modified-added">+   log.print(&quot; %10s: %-41s &quot;</span>
              &quot;%9.3f / %-9.3f &quot;
              &quot;%9.3f / %-9.3f &quot;
              &quot;%9.3f / %-9.3f &quot;
              &quot;%9.3f / %-9.3f   ms&quot;,
              sampler.group(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -246,11 +255,11 @@</span>
              TimeHelper::counter_to_millis(history.avg_total()),
              TimeHelper::counter_to_millis(history.max_total()));
  }
  
  void ZStatUnitBytes(LogTargetHandle log, const ZStatSampler&amp; sampler, const ZStatSamplerHistory&amp; history) {
<span class="udiff-line-modified-removed">-   log.print(&quot; %10s: %-40s  &quot;</span>
<span class="udiff-line-modified-added">+   log.print(&quot; %10s: %-41s &quot;</span>
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot;   MB&quot;,
              sampler.group(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -264,11 +273,11 @@</span>
              history.avg_total() / M,
              history.max_total() / M);
  }
  
  void ZStatUnitThreads(LogTargetHandle log, const ZStatSampler&amp; sampler, const ZStatSamplerHistory&amp; history) {
<span class="udiff-line-modified-removed">-   log.print(&quot; %10s: %-40s  &quot;</span>
<span class="udiff-line-modified-added">+   log.print(&quot; %10s: %-41s &quot;</span>
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot;   threads&quot;,
              sampler.group(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -282,11 +291,11 @@</span>
              history.avg_total(),
              history.max_total());
  }
  
  void ZStatUnitBytesPerSecond(LogTargetHandle log, const ZStatSampler&amp; sampler, const ZStatSamplerHistory&amp; history) {
<span class="udiff-line-modified-removed">-   log.print(&quot; %10s: %-40s  &quot;</span>
<span class="udiff-line-modified-added">+   log.print(&quot; %10s: %-41s &quot;</span>
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot;   MB/s&quot;,
              sampler.group(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -300,11 +309,11 @@</span>
              history.avg_total() / M,
              history.max_total() / M);
  }
  
  void ZStatUnitOpsPerSecond(LogTargetHandle log, const ZStatSampler&amp; sampler, const ZStatSamplerHistory&amp; history) {
<span class="udiff-line-modified-removed">-   log.print(&quot; %10s: %-40s  &quot;</span>
<span class="udiff-line-modified-added">+   log.print(&quot; %10s: %-41s &quot;</span>
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot; &quot;
              UINT64_FORMAT_W(9) &quot; / &quot; UINT64_FORMAT_W(-9) &quot;   ops/s&quot;,
              sampler.group(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -345,16 +354,15 @@</span>
    return (T*)value_addr;
  }
  
  void ZStatValue::initialize() {
    // Finalize and align CPU offset
<span class="udiff-line-modified-removed">-   _cpu_offset = align_up(_cpu_offset, ZCacheLineSize);</span>
<span class="udiff-line-modified-added">+   _cpu_offset = align_up(_cpu_offset, (uint32_t)ZCacheLineSize);</span>
  
    // Allocation aligned memory
    const size_t size = _cpu_offset * ZCPU::count();
    _base = ZUtils::alloc_aligned(ZCacheLineSize, size);
<span class="udiff-line-removed">-   memset((void*)_base, 0, size);</span>
  }
  
  const char* ZStatValue::group() const {
    return _group;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -416,13 +424,13 @@</span>
  
    const uint32_t ncpus = ZCPU::count();
    for (uint32_t i = 0; i &lt; ncpus; i++) {
      ZStatSamplerData* const cpu_data = get_cpu_local&lt;ZStatSamplerData&gt;(i);
      if (cpu_data-&gt;_nsamples &gt; 0) {
<span class="udiff-line-modified-removed">-       const uint64_t nsamples = Atomic::xchg((uint64_t)0, &amp;cpu_data-&gt;_nsamples);</span>
<span class="udiff-line-modified-removed">-       const uint64_t sum = Atomic::xchg((uint64_t)0, &amp;cpu_data-&gt;_sum);</span>
<span class="udiff-line-modified-removed">-       const uint64_t max = Atomic::xchg((uint64_t)0, &amp;cpu_data-&gt;_max);</span>
<span class="udiff-line-modified-added">+       const uint64_t nsamples = Atomic::xchg(&amp;cpu_data-&gt;_nsamples, (uint64_t)0);</span>
<span class="udiff-line-modified-added">+       const uint64_t sum = Atomic::xchg(&amp;cpu_data-&gt;_sum, (uint64_t)0);</span>
<span class="udiff-line-modified-added">+       const uint64_t max = Atomic::xchg(&amp;cpu_data-&gt;_max, (uint64_t)0);</span>
        all._nsamples += nsamples;
        all._sum += sum;
        if (all._max &lt; max) {
          all._max = max;
        }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -451,11 +459,11 @@</span>
    uint64_t counter = 0;
  
    const uint32_t ncpus = ZCPU::count();
    for (uint32_t i = 0; i &lt; ncpus; i++) {
      ZStatCounterData* const cpu_data = get_cpu_local&lt;ZStatCounterData&gt;(i);
<span class="udiff-line-modified-removed">-     counter += Atomic::xchg((uint64_t)0, &amp;cpu_data-&gt;_counter);</span>
<span class="udiff-line-modified-added">+     counter += Atomic::xchg(&amp;cpu_data-&gt;_counter, (uint64_t)0);</span>
    }
  
    ZStatSample(_sampler, counter);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -473,11 +481,11 @@</span>
    ZStatCounterData all;
  
    const uint32_t ncpus = ZCPU::count();
    for (uint32_t i = 0; i &lt; ncpus; i++) {
      ZStatCounterData* const cpu_data = get_cpu_local&lt;ZStatCounterData&gt;(i);
<span class="udiff-line-modified-removed">-     all._counter += Atomic::xchg((uint64_t)0, &amp;cpu_data-&gt;_counter);</span>
<span class="udiff-line-modified-added">+     all._counter += Atomic::xchg(&amp;cpu_data-&gt;_counter, (uint64_t)0);</span>
    }
  
    return all;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -619,13 +627,10 @@</span>
  
    log_info(gc, start)(&quot;Garbage Collection (%s)&quot;,
                         GCCause::to_string(ZCollectedHeap::heap()-&gt;gc_cause()));
  }
  
<span class="udiff-line-removed">- #define ZUSED_FMT                       SIZE_FORMAT &quot;M(%.0lf%%)&quot;</span>
<span class="udiff-line-removed">- #define ZUSED_ARGS(size, max_capacity)  ((size) / M), (percent_of(size, max_capacity))</span>
<span class="udiff-line-removed">- </span>
  void ZStatPhaseCycle::register_end(const Ticks&amp; start, const Ticks&amp; end) const {
    timer()-&gt;register_gc_end(end);
  
    ZCollectedHeap::heap()-&gt;print_heap_after_gc();
    ZCollectedHeap::heap()-&gt;trace_heap_after_gc(ZTracer::tracer());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -636,20 +641,20 @@</span>
    ZStatSample(_sampler, duration.value());
  
    ZStatLoad::print();
    ZStatMMU::print();
    ZStatMark::print();
<span class="udiff-line-removed">-   ZStatRelocation::print();</span>
    ZStatNMethods::print();
    ZStatMetaspace::print();
    ZStatReferences::print();
<span class="udiff-line-added">+   ZStatRelocation::print();</span>
    ZStatHeap::print();
  
<span class="udiff-line-modified-removed">-   log_info(gc)(&quot;Garbage Collection (%s) &quot; ZUSED_FMT &quot;-&gt;&quot; ZUSED_FMT,</span>
<span class="udiff-line-modified-added">+   log_info(gc)(&quot;Garbage Collection (%s) &quot; ZSIZE_FMT &quot;-&gt;&quot; ZSIZE_FMT,</span>
                 GCCause::to_string(ZCollectedHeap::heap()-&gt;gc_cause()),
<span class="udiff-line-modified-removed">-                ZUSED_ARGS(ZStatHeap::used_at_mark_start(), ZStatHeap::max_capacity()),</span>
<span class="udiff-line-modified-removed">-                ZUSED_ARGS(ZStatHeap::used_at_relocate_end(), ZStatHeap::max_capacity()));</span>
<span class="udiff-line-modified-added">+                ZSIZE_ARGS(ZStatHeap::used_at_mark_start()),</span>
<span class="udiff-line-modified-added">+                ZSIZE_ARGS(ZStatHeap::used_at_relocate_end()));</span>
  }
  
  Tickspan ZStatPhasePause::_max;
  
  ZStatPhasePause::ZStatPhasePause(const char* name) :
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -711,11 +716,11 @@</span>
    LogTarget(Debug, gc, phases, start) log;
    log_start(log, true /* thread */);
  }
  
  void ZStatSubPhase::register_end(const Ticks&amp; start, const Ticks&amp; end) const {
<span class="udiff-line-modified-removed">-   ZTracer::tracer()-&gt;report_thread_phase(*this, start, end);</span>
<span class="udiff-line-modified-added">+   ZTracer::tracer()-&gt;report_thread_phase(name(), start, end);</span>
  
    const Tickspan duration = end - start;
    ZStatSample(_sampler, duration.value());
  
    LogTarget(Debug, gc, phases) log;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -731,11 +736,11 @@</span>
    LogTarget(Debug, gc, start) log;
    log_start(log, true /* thread */);
  }
  
  void ZStatCriticalPhase::register_end(const Ticks&amp; start, const Ticks&amp; end) const {
<span class="udiff-line-modified-removed">-   ZTracer::tracer()-&gt;report_thread_phase(*this, start, end);</span>
<span class="udiff-line-modified-added">+   ZTracer::tracer()-&gt;report_thread_phase(name(), start, end);</span>
  
    const Tickspan duration = end - start;
    ZStatSample(_sampler, duration.value());
    ZStatInc(_counter);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -746,53 +751,54 @@</span>
      LogTarget(Debug, gc) log;
      log_end(log, duration, true /* thread */);
    }
  }
  
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ // Stat timer</span>
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ THREAD_LOCAL uint32_t ZStatTimerDisable::_active = 0;</span>
<span class="udiff-line-added">+ </span>
  //
  // Stat sample/inc
  //
<span class="udiff-line-modified-removed">- void ZStatSample(const ZStatSampler&amp; sampler, uint64_t value, bool trace) {</span>
<span class="udiff-line-modified-added">+ void ZStatSample(const ZStatSampler&amp; sampler, uint64_t value) {</span>
    ZStatSamplerData* const cpu_data = sampler.get();
<span class="udiff-line-modified-removed">-   Atomic::add(1u, &amp;cpu_data-&gt;_nsamples);</span>
<span class="udiff-line-modified-removed">-   Atomic::add(value, &amp;cpu_data-&gt;_sum);</span>
<span class="udiff-line-modified-added">+   Atomic::add(&amp;cpu_data-&gt;_nsamples, 1u);</span>
<span class="udiff-line-modified-added">+   Atomic::add(&amp;cpu_data-&gt;_sum, value);</span>
  
    uint64_t max = cpu_data-&gt;_max;
    for (;;) {
      if (max &gt;= value) {
        // Not max
        break;
      }
  
      const uint64_t new_max = value;
<span class="udiff-line-modified-removed">-     const uint64_t prev_max = Atomic::cmpxchg(new_max, &amp;cpu_data-&gt;_max, max);</span>
<span class="udiff-line-modified-added">+     const uint64_t prev_max = Atomic::cmpxchg(&amp;cpu_data-&gt;_max, max, new_max);</span>
      if (prev_max == max) {
        // Success
        break;
      }
  
      // Retry
      max = prev_max;
    }
  
<span class="udiff-line-modified-removed">-   if (trace) {</span>
<span class="udiff-line-removed">-     ZTracer::tracer()-&gt;report_stat_sampler(sampler, value);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   ZTracer::tracer()-&gt;report_stat_sampler(sampler, value);</span>
  }
  
<span class="udiff-line-modified-removed">- void ZStatInc(const ZStatCounter&amp; counter, uint64_t increment, bool trace) {</span>
<span class="udiff-line-modified-added">+ void ZStatInc(const ZStatCounter&amp; counter, uint64_t increment) {</span>
    ZStatCounterData* const cpu_data = counter.get();
<span class="udiff-line-modified-removed">-   const uint64_t value = Atomic::add(increment, &amp;cpu_data-&gt;_counter);</span>
<span class="udiff-line-modified-added">+   const uint64_t value = Atomic::add(&amp;cpu_data-&gt;_counter, increment);</span>
  
<span class="udiff-line-modified-removed">-   if (trace) {</span>
<span class="udiff-line-removed">-     ZTracer::tracer()-&gt;report_stat_counter(counter, increment, value);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   ZTracer::tracer()-&gt;report_stat_counter(counter, increment, value);</span>
  }
  
  void ZStatInc(const ZStatUnsampledCounter&amp; counter, uint64_t increment) {
    ZStatCounterData* const cpu_data = counter.get();
<span class="udiff-line-modified-removed">-   Atomic::add(increment, &amp;cpu_data-&gt;_counter);</span>
<span class="udiff-line-modified-added">+   Atomic::add(&amp;cpu_data-&gt;_counter, increment);</span>
  }
  
  //
  // Stat allocation rate
  //
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -843,11 +849,20 @@</span>
      sampler_history.add(sampler-&gt;collect_and_reset());
    }
  }
  
  bool ZStat::should_print(LogTargetHandle log) const {
<span class="udiff-line-modified-removed">-   return log.is_enabled() &amp;&amp; (_metronome.nticks() % ZStatisticsInterval == 0);</span>
<span class="udiff-line-modified-added">+   static uint64_t print_at = ZStatisticsInterval;</span>
<span class="udiff-line-added">+   const uint64_t now = os::elapsedTime();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (now &lt; print_at) {</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   print_at = ((now / ZStatisticsInterval) * ZStatisticsInterval) + ZStatisticsInterval;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return log.is_enabled();</span>
  }
  
  void ZStat::print(LogTargetHandle log, const ZStatSamplerHistory* history) const {
    // Print
    log.print(&quot;=== Garbage Collection Statistics =======================================================================================================================&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1009,42 +1024,55 @@</span>
  };
  
  //
  // Stat cycle
  //
<span class="udiff-line-modified-removed">- uint64_t  ZStatCycle::_ncycles = 0;</span>
<span class="udiff-line-modified-added">+ uint64_t  ZStatCycle::_nwarmup_cycles = 0;</span>
  Ticks     ZStatCycle::_start_of_last;
  Ticks     ZStatCycle::_end_of_last;
  NumberSeq ZStatCycle::_normalized_duration(0.3 /* alpha */);
  
  void ZStatCycle::at_start() {
    _start_of_last = Ticks::now();
  }
  
<span class="udiff-line-modified-removed">- void ZStatCycle::at_end(double boost_factor) {</span>
<span class="udiff-line-modified-added">+ void ZStatCycle::at_end(GCCause::Cause cause, double boost_factor) {</span>
    _end_of_last = Ticks::now();
<span class="udiff-line-modified-removed">-   _ncycles++;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   if (cause == GCCause::_z_warmup) {</span>
<span class="udiff-line-added">+     _nwarmup_cycles++;</span>
<span class="udiff-line-added">+   }</span>
  
    // Calculate normalized cycle duration. The measured duration is
    // normalized using the boost factor to avoid artificial deflation
    // of the duration when boost mode is enabled.
    const double duration = (_end_of_last - _start_of_last).seconds();
    const double normalized_duration = duration * boost_factor;
    _normalized_duration.add(normalized_duration);
  }
  
<span class="udiff-line-modified-removed">- uint64_t ZStatCycle::ncycles() {</span>
<span class="udiff-line-modified-removed">-   return _ncycles;</span>
<span class="udiff-line-modified-added">+ bool ZStatCycle::is_warm() {</span>
<span class="udiff-line-modified-added">+   return _nwarmup_cycles &gt;= 3;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ uint64_t ZStatCycle::nwarmup_cycles() {</span>
<span class="udiff-line-added">+   return _nwarmup_cycles;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool ZStatCycle::is_normalized_duration_trustable() {</span>
<span class="udiff-line-added">+   // The normalized duration is considered trustable if we have</span>
<span class="udiff-line-added">+   // completed at least one warmup cycle</span>
<span class="udiff-line-added">+   return _nwarmup_cycles &gt; 0;</span>
  }
  
  const AbsSeq&amp; ZStatCycle::normalized_duration() {
    return _normalized_duration;
  }
  
  double ZStatCycle::time_since_last() {
<span class="udiff-line-modified-removed">-   if (_ncycles == 0) {</span>
<span class="udiff-line-modified-removed">-     // Return time since VM start-up</span>
<span class="udiff-line-modified-added">+   if (_end_of_last.value() == 0) {</span>
<span class="udiff-line-modified-added">+     // No end recorded yet, return time since VM start</span>
      return os::elapsedTime();
    }
  
    const Ticks now = Ticks::now();
    const Tickspan time_since_last = now - _end_of_last;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1098,27 +1126,39 @@</span>
  }
  
  //
  // Stat relocation
  //
<span class="udiff-line-modified-removed">- size_t ZStatRelocation::_relocating;</span>
<span class="udiff-line-modified-removed">- bool ZStatRelocation::_success;</span>
<span class="udiff-line-modified-added">+ ZRelocationSetSelectorStats ZStatRelocation::_stats;</span>
<span class="udiff-line-modified-added">+ bool                        ZStatRelocation::_success;</span>
  
<span class="udiff-line-modified-removed">- void ZStatRelocation::set_at_select_relocation_set(size_t relocating) {</span>
<span class="udiff-line-modified-removed">-   _relocating = relocating;</span>
<span class="udiff-line-modified-added">+ void ZStatRelocation::set_at_select_relocation_set(const ZRelocationSetSelectorStats&amp; stats) {</span>
<span class="udiff-line-modified-added">+   _stats = stats;</span>
  }
  
  void ZStatRelocation::set_at_relocate_end(bool success) {
    _success = success;
  }
  
<span class="udiff-line-added">+ void ZStatRelocation::print(const char* name, const ZRelocationSetSelectorGroupStats&amp; group) {</span>
<span class="udiff-line-added">+   const size_t total = _stats.small().total() + _stats.medium().total() + _stats.large().total();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   log_info(gc, reloc)(&quot;%s Pages: &quot; SIZE_FORMAT &quot; / &quot; ZSIZE_FMT &quot;, Empty: &quot; ZSIZE_FMT &quot;, Compacting: &quot; ZSIZE_FMT &quot;-&gt;&quot; ZSIZE_FMT,</span>
<span class="udiff-line-added">+                       name,</span>
<span class="udiff-line-added">+                       group.npages(),</span>
<span class="udiff-line-added">+                       ZSIZE_ARGS_WITH_MAX(group.total(), total),</span>
<span class="udiff-line-added">+                       ZSIZE_ARGS_WITH_MAX(group.empty(), total),</span>
<span class="udiff-line-added">+                       ZSIZE_ARGS_WITH_MAX(group.compacting_from(), total),</span>
<span class="udiff-line-added">+                       ZSIZE_ARGS_WITH_MAX(group.compacting_to(), total));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void ZStatRelocation::print() {
<span class="udiff-line-modified-removed">-   if (_success) {</span>
<span class="udiff-line-modified-removed">-     log_info(gc, reloc)(&quot;Relocation: Successful, &quot; SIZE_FORMAT &quot;M relocated&quot;, _relocating / M);</span>
<span class="udiff-line-modified-removed">-   } else {</span>
<span class="udiff-line-modified-removed">-     log_info(gc, reloc)(&quot;Relocation: Incomplete&quot;);</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-modified-added">+   print(&quot;Small&quot;, _stats.small());</span>
<span class="udiff-line-modified-added">+   print(&quot;Medium&quot;, _stats.medium());</span>
<span class="udiff-line-modified-added">+   print(&quot;Large&quot;, _stats.large());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   log_info(gc, reloc)(&quot;Relocation: %s&quot;, _success ? &quot;Successful&quot; : &quot;Incomplete&quot;);</span>
  }
  
  //
  // Stat nmethods
  //
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1196,13 +1236,23 @@</span>
  ZStatHeap::ZAtMarkStart ZStatHeap::_at_mark_start;
  ZStatHeap::ZAtMarkEnd ZStatHeap::_at_mark_end;
  ZStatHeap::ZAtRelocateStart ZStatHeap::_at_relocate_start;
  ZStatHeap::ZAtRelocateEnd ZStatHeap::_at_relocate_end;
  
<span class="udiff-line-modified-removed">- #define ZSIZE_NA               &quot;%9s&quot;, &quot;-&quot;</span>
<span class="udiff-line-modified-removed">- #define ZSIZE_ARGS(size)       SIZE_FORMAT_W(8) &quot;M (%.0lf%%)&quot;, \</span>
<span class="udiff-line-modified-removed">-                                ((size) / M), (percent_of(size, _at_initialize.max_capacity))</span>
<span class="udiff-line-modified-added">+ size_t ZStatHeap::capacity_high() {</span>
<span class="udiff-line-modified-added">+   return MAX4(_at_mark_start.capacity,</span>
<span class="udiff-line-modified-added">+               _at_mark_end.capacity,</span>
<span class="udiff-line-added">+               _at_relocate_start.capacity,</span>
<span class="udiff-line-added">+               _at_relocate_end.capacity);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ size_t ZStatHeap::capacity_low() {</span>
<span class="udiff-line-added">+   return MIN4(_at_mark_start.capacity,</span>
<span class="udiff-line-added">+               _at_mark_end.capacity,</span>
<span class="udiff-line-added">+               _at_relocate_start.capacity,</span>
<span class="udiff-line-added">+               _at_relocate_end.capacity);</span>
<span class="udiff-line-added">+ }</span>
  
  size_t ZStatHeap::available(size_t used) {
    return _at_initialize.max_capacity - used;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1212,18 +1262,22 @@</span>
  
  size_t ZStatHeap::free(size_t used) {
    return available(used) - reserve(used);
  }
  
<span class="udiff-line-modified-removed">- void ZStatHeap::set_at_initialize(size_t max_capacity,</span>
<span class="udiff-line-modified-added">+ void ZStatHeap::set_at_initialize(size_t min_capacity,</span>
<span class="udiff-line-added">+                                   size_t max_capacity,</span>
                                    size_t max_reserve) {
<span class="udiff-line-added">+   _at_initialize.min_capacity = min_capacity;</span>
    _at_initialize.max_capacity = max_capacity;
    _at_initialize.max_reserve = max_reserve;
  }
  
<span class="udiff-line-modified-removed">- void ZStatHeap::set_at_mark_start(size_t capacity,</span>
<span class="udiff-line-modified-added">+ void ZStatHeap::set_at_mark_start(size_t soft_max_capacity,</span>
<span class="udiff-line-added">+                                   size_t capacity,</span>
                                    size_t used) {
<span class="udiff-line-added">+   _at_mark_start.soft_max_capacity = soft_max_capacity;</span>
    _at_mark_start.capacity = capacity;
    _at_mark_start.reserve = reserve(used);
    _at_mark_start.used = used;
    _at_mark_start.free = free(used);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1236,13 +1290,14 @@</span>
    _at_mark_end.allocated = allocated;
    _at_mark_end.used = used;
    _at_mark_end.free = free(used);
  }
  
<span class="udiff-line-modified-removed">- void ZStatHeap::set_at_select_relocation_set(size_t live,</span>
<span class="udiff-line-modified-removed">-                                              size_t garbage,</span>
<span class="udiff-line-modified-removed">-                                              size_t reclaimed) {</span>
<span class="udiff-line-modified-added">+ void ZStatHeap::set_at_select_relocation_set(const ZRelocationSetSelectorStats&amp; stats, size_t reclaimed) {</span>
<span class="udiff-line-modified-added">+   const size_t live = stats.small().live() + stats.medium().live() + stats.large().live();</span>
<span class="udiff-line-modified-added">+   const size_t garbage = stats.small().garbage() + stats.medium().garbage() + stats.large().garbage();</span>
<span class="udiff-line-added">+ </span>
    _at_mark_end.live = live;
    _at_mark_end.garbage = garbage;
  
    _at_relocate_start.garbage = garbage - reclaimed;
    _at_relocate_start.reclaimed = reclaimed;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1263,12 +1318,12 @@</span>
                                      size_t reclaimed,
                                      size_t used,
                                      size_t used_high,
                                      size_t used_low) {
    _at_relocate_end.capacity = capacity;
<span class="udiff-line-modified-removed">-   _at_relocate_end.capacity_high = capacity;</span>
<span class="udiff-line-modified-removed">-   _at_relocate_end.capacity_low = _at_mark_start.capacity;</span>
<span class="udiff-line-modified-added">+   _at_relocate_end.capacity_high = capacity_high();</span>
<span class="udiff-line-modified-added">+   _at_relocate_end.capacity_low = capacity_low();</span>
    _at_relocate_end.reserve = reserve(used);
    _at_relocate_end.reserve_high = reserve(used_low);
    _at_relocate_end.reserve_low = reserve(used_high);
    _at_relocate_end.garbage = _at_mark_end.garbage - reclaimed;
    _at_relocate_end.allocated = allocated;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1292,10 +1347,17 @@</span>
  size_t ZStatHeap::used_at_relocate_end() {
    return _at_relocate_end.used;
  }
  
  void ZStatHeap::print() {
<span class="udiff-line-added">+   log_info(gc, heap)(&quot;Min Capacity: &quot;</span>
<span class="udiff-line-added">+                      ZSIZE_FMT, ZSIZE_ARGS(_at_initialize.min_capacity));</span>
<span class="udiff-line-added">+   log_info(gc, heap)(&quot;Max Capacity: &quot;</span>
<span class="udiff-line-added">+                      ZSIZE_FMT, ZSIZE_ARGS(_at_initialize.max_capacity));</span>
<span class="udiff-line-added">+   log_info(gc, heap)(&quot;Soft Max Capacity: &quot;</span>
<span class="udiff-line-added">+                      ZSIZE_FMT, ZSIZE_ARGS(_at_mark_start.soft_max_capacity));</span>
<span class="udiff-line-added">+ </span>
    ZStatTablePrinter table(10, 18);
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .fill()
                       .center(&quot;Mark Start&quot;)
                       .center(&quot;Mark End&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1304,76 +1366,76 @@</span>
                       .center(&quot;High&quot;)
                       .center(&quot;Low&quot;)
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Capacity:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_start.capacity))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.capacity))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.capacity))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.capacity))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.capacity_high))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.capacity_low))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_start.capacity))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.capacity))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.capacity))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.capacity))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.capacity_high))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.capacity_low))</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Reserve:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_start.reserve))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.reserve))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.reserve))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.reserve))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.reserve_high))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.reserve_low))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_start.reserve))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.reserve))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.reserve))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.reserve))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.reserve_high))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.reserve_low))</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Free:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_start.free))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.free))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.free))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.free))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.free_high))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.free_low))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_start.free))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.free))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.free))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.free))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.free_high))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.free_low))</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Used:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_start.used))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.used))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.used))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.used))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.used_high))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.used_low))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_start.used))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.used))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.used))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.used))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.used_high))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.used_low))</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Live:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.live))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.live /* Same as at mark end */))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.live /* Same as at mark end */))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.live))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.live /* Same as at mark end */))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.live /* Same as at mark end */))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Allocated:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.allocated))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.allocated))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.allocated))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.allocated))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.allocated))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.allocated))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Garbage:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_mark_end.garbage))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.garbage))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.garbage))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_mark_end.garbage))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.garbage))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.garbage))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
                       .end());
    log_info(gc, heap)(&quot;%s&quot;, table()
                       .right(&quot;Reclaimed:&quot;)
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_start.reclaimed))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_ARGS(_at_relocate_end.reclaimed))</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-removed">-                      .left(ZSIZE_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_start.reclaimed))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS(_at_relocate_end.reclaimed))</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
<span class="udiff-line-modified-added">+                      .left(ZTABLE_ARGS_NA)</span>
                       .end());
  }
</pre>
<center><a href="zRuntimeWorkers.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zStat.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>