<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/z/zNMethodData.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="zNMethod.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zNMethodData.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/z/zNMethodData.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 20,53 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/z/zLock.inline.hpp&quot;
  #include &quot;gc/z/zNMethodData.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
<span class="line-removed">- #include &quot;runtime/orderAccess.hpp&quot;</span>
  #include &quot;utilities/align.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
  
<span class="line-removed">- size_t ZNMethodDataOops::header_size() {</span>
<span class="line-removed">-   const size_t size = sizeof(ZNMethodDataOops);</span>
<span class="line-removed">-   assert(is_aligned(size, sizeof(oop*)), &quot;Header misaligned&quot;);</span>
<span class="line-removed">-   return size;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  ZNMethodDataOops* ZNMethodDataOops::create(const GrowableArray&lt;oop*&gt;&amp; immediates, bool has_non_immediates) {
<span class="line-modified">!   // Allocate memory for the ZNMethodDataOops object</span>
<span class="line-removed">-   // plus the immediate oop* array that follows right after.</span>
<span class="line-removed">-   const size_t size = ZNMethodDataOops::header_size() + (sizeof(oop*) * immediates.length());</span>
<span class="line-removed">-   void* const mem = NEW_C_HEAP_ARRAY(uint8_t, size, mtGC);</span>
<span class="line-removed">-   return ::new (mem) ZNMethodDataOops(immediates, has_non_immediates);</span>
  }
  
  void ZNMethodDataOops::destroy(ZNMethodDataOops* oops) {
<span class="line-modified">!   FREE_C_HEAP_ARRAY(uint8_t, oops);</span>
  }
  
  ZNMethodDataOops::ZNMethodDataOops(const GrowableArray&lt;oop*&gt;&amp; immediates, bool has_non_immediates) :
<span class="line-modified">!     _nimmediates(immediates.length()),</span>
      _has_non_immediates(has_non_immediates) {
    // Save all immediate oops
<span class="line-modified">!   for (size_t i = 0; i &lt; _nimmediates; i++) {</span>
<span class="line-modified">!     immediates_begin()[i] = immediates.at(i);</span>
    }
  }
  
  size_t ZNMethodDataOops::immediates_count() const {
<span class="line-modified">!   return _nimmediates;</span>
  }
  
  oop** ZNMethodDataOops::immediates_begin() const {
<span class="line-modified">!   // The immediate oop* array starts immediately after this object</span>
<span class="line-removed">-   return (oop**)((uintptr_t)this + header_size());</span>
  }
  
  oop** ZNMethodDataOops::immediates_end() const {
    return immediates_begin() + immediates_count();
  }
<span class="line-new-header">--- 20,42 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;precompiled.hpp&quot;
<span class="line-added">+ #include &quot;gc/z/zAttachedArray.inline.hpp&quot;</span>
  #include &quot;gc/z/zLock.inline.hpp&quot;
  #include &quot;gc/z/zNMethodData.hpp&quot;
  #include &quot;memory/allocation.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
  #include &quot;utilities/debug.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
  
  ZNMethodDataOops* ZNMethodDataOops::create(const GrowableArray&lt;oop*&gt;&amp; immediates, bool has_non_immediates) {
<span class="line-modified">!   return ::new (AttachedArray::alloc(immediates.length())) ZNMethodDataOops(immediates, has_non_immediates);</span>
  }
  
  void ZNMethodDataOops::destroy(ZNMethodDataOops* oops) {
<span class="line-modified">!   AttachedArray::free(oops);</span>
  }
  
  ZNMethodDataOops::ZNMethodDataOops(const GrowableArray&lt;oop*&gt;&amp; immediates, bool has_non_immediates) :
<span class="line-modified">!     _immediates(immediates.length()),</span>
      _has_non_immediates(has_non_immediates) {
    // Save all immediate oops
<span class="line-modified">!   for (size_t i = 0; i &lt; immediates_count(); i++) {</span>
<span class="line-modified">!     immediates_begin()[i] = immediates.at(int(i));</span>
    }
  }
  
  size_t ZNMethodDataOops::immediates_count() const {
<span class="line-modified">!   return _immediates.length();</span>
  }
  
  oop** ZNMethodDataOops::immediates_begin() const {
<span class="line-modified">!   return _immediates(this);</span>
  }
  
  oop** ZNMethodDataOops::immediates_end() const {
    return immediates_begin() + immediates_count();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 86,11 ***</span>
  ZReentrantLock* ZNMethodData::lock() {
    return &amp;_lock;
  }
  
  ZNMethodDataOops* ZNMethodData::oops() const {
<span class="line-modified">!   return OrderAccess::load_acquire(&amp;_oops);</span>
  }
  
  ZNMethodDataOops* ZNMethodData::swap_oops(ZNMethodDataOops* new_oops) {
    ZLocker&lt;ZReentrantLock&gt; locker(&amp;_lock);
    ZNMethodDataOops* const old_oops = _oops;
<span class="line-new-header">--- 75,11 ---</span>
  ZReentrantLock* ZNMethodData::lock() {
    return &amp;_lock;
  }
  
  ZNMethodDataOops* ZNMethodData::oops() const {
<span class="line-modified">!   return Atomic::load_acquire(&amp;_oops);</span>
  }
  
  ZNMethodDataOops* ZNMethodData::swap_oops(ZNMethodDataOops* new_oops) {
    ZLocker&lt;ZReentrantLock&gt; locker(&amp;_lock);
    ZNMethodDataOops* const old_oops = _oops;
</pre>
<center><a href="zNMethod.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="zNMethodData.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>