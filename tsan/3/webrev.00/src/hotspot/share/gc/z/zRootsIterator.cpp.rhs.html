<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/z/zRootsIterator.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &quot;precompiled.hpp&quot;
 25 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 26 #include &quot;classfile/stringTable.hpp&quot;
 27 #include &quot;classfile/systemDictionary.hpp&quot;
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;compiler/oopMap.hpp&quot;
 30 #include &quot;gc/shared/barrierSet.hpp&quot;
 31 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
 32 #include &quot;gc/shared/oopStorageParState.inline.hpp&quot;
<a name="2" id="anc2"></a><span class="line-added"> 33 #include &quot;gc/shared/oopStorageSet.hpp&quot;</span>
 34 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
 35 #include &quot;gc/z/zBarrierSetNMethod.hpp&quot;
 36 #include &quot;gc/z/zGlobals.hpp&quot;
 37 #include &quot;gc/z/zNMethod.hpp&quot;
 38 #include &quot;gc/z/zOopClosures.inline.hpp&quot;
 39 #include &quot;gc/z/zRootsIterator.hpp&quot;
 40 #include &quot;gc/z/zStat.hpp&quot;
 41 #include &quot;gc/z/zThreadLocalData.hpp&quot;
<a name="3" id="anc3"></a><span class="line-added"> 42 #include &quot;memory/iterator.hpp&quot;</span>
 43 #include &quot;memory/resourceArea.hpp&quot;
 44 #include &quot;memory/universe.hpp&quot;
 45 #include &quot;prims/jvmtiExport.hpp&quot;
<a name="4" id="anc4"></a><span class="line-added"> 46 #include &quot;prims/resolvedMethodTable.hpp&quot;</span>
 47 #include &quot;runtime/atomic.hpp&quot;
<a name="5" id="anc5"></a>

 48 #include &quot;runtime/safepoint.hpp&quot;
 49 #include &quot;runtime/synchronizer.hpp&quot;
<a name="6" id="anc6"></a><span class="line-added"> 50 #include &quot;runtime/thread.hpp&quot;</span>
<span class="line-added"> 51 #include &quot;runtime/vmThread.hpp&quot;</span>
 52 #include &quot;services/management.hpp&quot;
 53 #include &quot;utilities/debug.hpp&quot;
 54 #if INCLUDE_JFR
 55 #include &quot;jfr/jfr.hpp&quot;
 56 #endif
 57 
 58 static const ZStatSubPhase ZSubPhasePauseRootsSetup(&quot;Pause Roots Setup&quot;);
 59 static const ZStatSubPhase ZSubPhasePauseRoots(&quot;Pause Roots&quot;);
 60 static const ZStatSubPhase ZSubPhasePauseRootsTeardown(&quot;Pause Roots Teardown&quot;);
 61 static const ZStatSubPhase ZSubPhasePauseRootsUniverse(&quot;Pause Roots Universe&quot;);
 62 static const ZStatSubPhase ZSubPhasePauseRootsObjectSynchronizer(&quot;Pause Roots ObjectSynchronizer&quot;);
 63 static const ZStatSubPhase ZSubPhasePauseRootsManagement(&quot;Pause Roots Management&quot;);
 64 static const ZStatSubPhase ZSubPhasePauseRootsJVMTIExport(&quot;Pause Roots JVMTIExport&quot;);
 65 static const ZStatSubPhase ZSubPhasePauseRootsJVMTIWeakExport(&quot;Pause Roots JVMTIWeakExport&quot;);
 66 static const ZStatSubPhase ZSubPhasePauseRootsSystemDictionary(&quot;Pause Roots SystemDictionary&quot;);
<a name="7" id="anc7"></a><span class="line-modified"> 67 static const ZStatSubPhase ZSubPhasePauseRootsVMThread(&quot;Pause Roots VM Thread&quot;);</span>
<span class="line-added"> 68 static const ZStatSubPhase ZSubPhasePauseRootsJavaThreads(&quot;Pause Roots Java Threads&quot;);</span>
 69 static const ZStatSubPhase ZSubPhasePauseRootsCodeCache(&quot;Pause Roots CodeCache&quot;);
 70 
 71 static const ZStatSubPhase ZSubPhaseConcurrentRootsSetup(&quot;Concurrent Roots Setup&quot;);
 72 static const ZStatSubPhase ZSubPhaseConcurrentRoots(&quot;Concurrent Roots&quot;);
 73 static const ZStatSubPhase ZSubPhaseConcurrentRootsTeardown(&quot;Concurrent Roots Teardown&quot;);
 74 static const ZStatSubPhase ZSubPhaseConcurrentRootsJNIHandles(&quot;Concurrent Roots JNIHandles&quot;);
<a name="8" id="anc8"></a><span class="line-added"> 75 static const ZStatSubPhase ZSubPhaseConcurrentRootsVMHandles(&quot;Concurrent Roots VMHandles&quot;);</span>
 76 static const ZStatSubPhase ZSubPhaseConcurrentRootsClassLoaderDataGraph(&quot;Concurrent Roots ClassLoaderDataGraph&quot;);
 77 
 78 static const ZStatSubPhase ZSubPhasePauseWeakRootsSetup(&quot;Pause Weak Roots Setup&quot;);
 79 static const ZStatSubPhase ZSubPhasePauseWeakRoots(&quot;Pause Weak Roots&quot;);
 80 static const ZStatSubPhase ZSubPhasePauseWeakRootsTeardown(&quot;Pause Weak Roots Teardown&quot;);
 81 static const ZStatSubPhase ZSubPhasePauseWeakRootsJVMTIWeakExport(&quot;Pause Weak Roots JVMTIWeakExport&quot;);
 82 static const ZStatSubPhase ZSubPhasePauseWeakRootsJFRWeak(&quot;Pause Weak Roots JFRWeak&quot;);
 83 
 84 static const ZStatSubPhase ZSubPhaseConcurrentWeakRoots(&quot;Concurrent Weak Roots&quot;);
 85 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsVMWeakHandles(&quot;Concurrent Weak Roots VMWeakHandles&quot;);
 86 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsJNIWeakHandles(&quot;Concurrent Weak Roots JNIWeakHandles&quot;);
 87 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsStringTable(&quot;Concurrent Weak Roots StringTable&quot;);
<a name="9" id="anc9"></a><span class="line-added"> 88 static const ZStatSubPhase ZSubPhaseConcurrentWeakRootsResolvedMethodTable(&quot;Concurrent Weak Roots ResolvedMethodTable&quot;);</span>
 89 
 90 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
 91 ZSerialOopsDo&lt;T, F&gt;::ZSerialOopsDo(T* iter) :
 92     _iter(iter),
 93     _claimed(false) {}
 94 
 95 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
 96 void ZSerialOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
<a name="10" id="anc10"></a><span class="line-modified"> 97   if (!_claimed &amp;&amp; Atomic::cmpxchg(&amp;_claimed, false, true) == false) {</span>
 98     (_iter-&gt;*F)(cl);
 99   }
100 }
101 
102 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
103 ZParallelOopsDo&lt;T, F&gt;::ZParallelOopsDo(T* iter) :
104     _iter(iter),
105     _completed(false) {}
106 
107 template &lt;typename T, void (T::*F)(ZRootsIteratorClosure*)&gt;
108 void ZParallelOopsDo&lt;T, F&gt;::oops_do(ZRootsIteratorClosure* cl) {
109   if (!_completed) {
110     (_iter-&gt;*F)(cl);
111     if (!_completed) {
112       _completed = true;
113     }
114   }
115 }
116 
117 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
118 ZSerialWeakOopsDo&lt;T, F&gt;::ZSerialWeakOopsDo(T* iter) :
119     _iter(iter),
120     _claimed(false) {}
121 
122 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
123 void ZSerialWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
<a name="11" id="anc11"></a><span class="line-modified">124   if (!_claimed &amp;&amp; Atomic::cmpxchg(&amp;_claimed, false, true) == false) {</span>
125     (_iter-&gt;*F)(is_alive, cl);
126   }
127 }
128 
129 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
130 ZParallelWeakOopsDo&lt;T, F&gt;::ZParallelWeakOopsDo(T* iter) :
131     _iter(iter),
132     _completed(false) {}
133 
134 template &lt;typename T, void (T::*F)(BoolObjectClosure*, ZRootsIteratorClosure*)&gt;
135 void ZParallelWeakOopsDo&lt;T, F&gt;::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
136   if (!_completed) {
137     (_iter-&gt;*F)(is_alive, cl);
138     if (!_completed) {
139       _completed = true;
140     }
141   }
142 }
143 
<a name="12" id="anc12"></a><span class="line-modified">144 class ZRootsIteratorCodeBlobClosure : public CodeBlobClosure {</span>
145 private:
<a name="13" id="anc13"></a><span class="line-modified">146   ZRootsIteratorClosure* const _cl;</span>
<span class="line-added">147   const bool                   _should_disarm_nmethods;</span>
148 
149 public:
<a name="14" id="anc14"></a><span class="line-modified">150   ZRootsIteratorCodeBlobClosure(ZRootsIteratorClosure* cl) :</span>
<span class="line-modified">151       _cl(cl),</span>
<span class="line-modified">152       _should_disarm_nmethods(cl-&gt;should_disarm_nmethods()) {}</span>
153 
154   virtual void do_code_blob(CodeBlob* cb) {
155     nmethod* const nm = cb-&gt;as_nmethod_or_null();
<a name="15" id="anc15"></a><span class="line-modified">156     if (nm != NULL &amp;&amp; nm-&gt;oops_do_try_claim()) {</span>
<span class="line-modified">157       ZNMethod::nmethod_oops_do(nm, _cl);</span>
<span class="line-modified">158       assert(!ZNMethod::supports_entry_barrier(nm) ||</span>
<span class="line-added">159              ZNMethod::is_armed(nm) == _should_disarm_nmethods, &quot;Invalid state&quot;);</span>
<span class="line-added">160       if (_should_disarm_nmethods) {</span>
<span class="line-added">161         ZNMethod::disarm(nm);</span>
<span class="line-added">162       }</span>
163     }
164   }
165 };
166 
167 class ZRootsIteratorThreadClosure : public ThreadClosure {
168 private:
<a name="16" id="anc16"></a><span class="line-modified">169   ZRootsIteratorClosure* const _cl;</span>
<span class="line-added">170   ResourceMark                 _rm;</span>
171 
172 public:
173   ZRootsIteratorThreadClosure(ZRootsIteratorClosure* cl) :
174       _cl(cl) {}
175 
176   virtual void do_thread(Thread* thread) {
177     ZRootsIteratorCodeBlobClosure code_cl(_cl);
178     thread-&gt;oops_do(_cl, ClassUnloading ? &amp;code_cl : NULL);
179     _cl-&gt;do_thread(thread);
180   }
181 };
182 
<a name="17" id="anc17"></a><span class="line-modified">183 ZJavaThreadsIterator::ZJavaThreadsIterator() :</span>
<span class="line-added">184     _threads(),</span>
<span class="line-added">185     _claimed(0) {}</span>
<span class="line-added">186 </span>
<span class="line-added">187 uint ZJavaThreadsIterator::claim() {</span>
<span class="line-added">188   return Atomic::fetch_and_add(&amp;_claimed, 1u);</span>
<span class="line-added">189 }</span>
<span class="line-added">190 </span>
<span class="line-added">191 void ZJavaThreadsIterator::threads_do(ThreadClosure* cl) {</span>
<span class="line-added">192   for (uint i = claim(); i &lt; _threads.length(); i = claim()) {</span>
<span class="line-added">193     cl-&gt;do_thread(_threads.thread_at(i));</span>
<span class="line-added">194   }</span>
<span class="line-added">195 }</span>
<span class="line-added">196 </span>
<span class="line-added">197 ZRootsIterator::ZRootsIterator(bool visit_jvmti_weak_export) :</span>
<span class="line-added">198     _visit_jvmti_weak_export(visit_jvmti_weak_export),</span>
<span class="line-added">199     _java_threads_iter(),</span>
200     _universe(this),
201     _object_synchronizer(this),
202     _management(this),
203     _jvmti_export(this),
204     _jvmti_weak_export(this),
205     _system_dictionary(this),
<a name="18" id="anc18"></a><span class="line-modified">206     _vm_thread(this),</span>
<span class="line-added">207     _java_threads(this),</span>
208     _code_cache(this) {
209   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
210   ZStatTimer timer(ZSubPhasePauseRootsSetup);
<a name="19" id="anc19"></a><span class="line-modified">211   COMPILER2_OR_JVMCI_PRESENT(DerivedPointerTable::clear());</span>

212   if (ClassUnloading) {
213     nmethod::oops_do_marking_prologue();
214   } else {
215     ZNMethod::oops_do_begin();
216   }
217 }
218 
219 ZRootsIterator::~ZRootsIterator() {
220   ZStatTimer timer(ZSubPhasePauseRootsTeardown);
221   ResourceMark rm;
222   if (ClassUnloading) {
223     nmethod::oops_do_marking_epilogue();
224   } else {
225     ZNMethod::oops_do_end();
226   }
<a name="20" id="anc20"></a>
227 
<a name="21" id="anc21"></a><span class="line-modified">228   COMPILER2_OR_JVMCI_PRESENT(DerivedPointerTable::update_pointers());</span>

229 }
230 
231 void ZRootsIterator::do_universe(ZRootsIteratorClosure* cl) {
232   ZStatTimer timer(ZSubPhasePauseRootsUniverse);
233   Universe::oops_do(cl);
234 }
235 
236 void ZRootsIterator::do_object_synchronizer(ZRootsIteratorClosure* cl) {
237   ZStatTimer timer(ZSubPhasePauseRootsObjectSynchronizer);
238   ObjectSynchronizer::oops_do(cl);
239 }
240 
241 void ZRootsIterator::do_management(ZRootsIteratorClosure* cl) {
242   ZStatTimer timer(ZSubPhasePauseRootsManagement);
243   Management::oops_do(cl);
244 }
245 
246 void ZRootsIterator::do_jvmti_export(ZRootsIteratorClosure* cl) {
247   ZStatTimer timer(ZSubPhasePauseRootsJVMTIExport);
248   JvmtiExport::oops_do(cl);
249 }
250 
251 void ZRootsIterator::do_jvmti_weak_export(ZRootsIteratorClosure* cl) {
252   ZStatTimer timer(ZSubPhasePauseRootsJVMTIWeakExport);
253   AlwaysTrueClosure always_alive;
254   JvmtiExport::weak_oops_do(&amp;always_alive, cl);
255 }
256 
257 void ZRootsIterator::do_system_dictionary(ZRootsIteratorClosure* cl) {
258   ZStatTimer timer(ZSubPhasePauseRootsSystemDictionary);
<a name="22" id="anc22"></a><span class="line-modified">259   // Handles are processed via _vm_handles.</span>
<span class="line-added">260   SystemDictionary::oops_do(cl, false /* include_handles */);</span>
261 }
262 
<a name="23" id="anc23"></a><span class="line-modified">263 void ZRootsIterator::do_vm_thread(ZRootsIteratorClosure* cl) {</span>
<span class="line-modified">264   ZStatTimer timer(ZSubPhasePauseRootsVMThread);</span>

265   ZRootsIteratorThreadClosure thread_cl(cl);
<a name="24" id="anc24"></a><span class="line-modified">266   thread_cl.do_thread(VMThread::vm_thread());</span>
<span class="line-added">267 }</span>
<span class="line-added">268 </span>
<span class="line-added">269 void ZRootsIterator::do_java_threads(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">270   ZStatTimer timer(ZSubPhasePauseRootsJavaThreads);</span>
<span class="line-added">271   ZRootsIteratorThreadClosure thread_cl(cl);</span>
<span class="line-added">272   _java_threads_iter.threads_do(&amp;thread_cl);</span>
273 }
274 
275 void ZRootsIterator::do_code_cache(ZRootsIteratorClosure* cl) {
276   ZStatTimer timer(ZSubPhasePauseRootsCodeCache);
277   ZNMethod::oops_do(cl);
278 }
279 
<a name="25" id="anc25"></a><span class="line-modified">280 void ZRootsIterator::oops_do(ZRootsIteratorClosure* cl) {</span>
281   ZStatTimer timer(ZSubPhasePauseRoots);
282   _universe.oops_do(cl);
283   _object_synchronizer.oops_do(cl);
284   _management.oops_do(cl);
285   _jvmti_export.oops_do(cl);
286   _system_dictionary.oops_do(cl);
<a name="26" id="anc26"></a><span class="line-modified">287   _vm_thread.oops_do(cl);</span>
<span class="line-added">288   _java_threads.oops_do(cl);</span>
289   if (!ClassUnloading) {
290     _code_cache.oops_do(cl);
291   }
<a name="27" id="anc27"></a><span class="line-modified">292   if (_visit_jvmti_weak_export) {</span>
293     _jvmti_weak_export.oops_do(cl);
294   }
295 }
296 
<a name="28" id="anc28"></a><span class="line-modified">297 ZConcurrentRootsIterator::ZConcurrentRootsIterator(int cld_claim) :</span>
<span class="line-modified">298     _jni_handles_iter(OopStorageSet::jni_global()),</span>
<span class="line-modified">299     _vm_handles_iter(OopStorageSet::vm_global()),</span>
<span class="line-modified">300     _cld_claim(cld_claim),</span>
301     _jni_handles(this),
<a name="29" id="anc29"></a><span class="line-added">302     _vm_handles(this),</span>
303     _class_loader_data_graph(this) {
304   ZStatTimer timer(ZSubPhaseConcurrentRootsSetup);
<a name="30" id="anc30"></a><span class="line-modified">305   ClassLoaderDataGraph::clear_claimed_marks(cld_claim);</span>



306 }
307 
308 ZConcurrentRootsIterator::~ZConcurrentRootsIterator() {
309   ZStatTimer timer(ZSubPhaseConcurrentRootsTeardown);
<a name="31" id="anc31"></a>


310 }
311 
312 void ZConcurrentRootsIterator::do_jni_handles(ZRootsIteratorClosure* cl) {
313   ZStatTimer timer(ZSubPhaseConcurrentRootsJNIHandles);
314   _jni_handles_iter.oops_do(cl);
315 }
316 
<a name="32" id="anc32"></a><span class="line-added">317 void ZConcurrentRootsIterator::do_vm_handles(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">318   ZStatTimer timer(ZSubPhaseConcurrentRootsVMHandles);</span>
<span class="line-added">319   _vm_handles_iter.oops_do(cl);</span>
<span class="line-added">320 }</span>
<span class="line-added">321 </span>
322 void ZConcurrentRootsIterator::do_class_loader_data_graph(ZRootsIteratorClosure* cl) {
323   ZStatTimer timer(ZSubPhaseConcurrentRootsClassLoaderDataGraph);
<a name="33" id="anc33"></a><span class="line-modified">324   CLDToOopClosure cld_cl(cl, _cld_claim);</span>
<span class="line-modified">325   ClassLoaderDataGraph::always_strong_cld_do(&amp;cld_cl);</span>





326 }
327 
328 void ZConcurrentRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
329   ZStatTimer timer(ZSubPhaseConcurrentRoots);
330   _jni_handles.oops_do(cl);
<a name="34" id="anc34"></a><span class="line-added">331   _vm_handles.oops_do(cl),</span>
332   _class_loader_data_graph.oops_do(cl);
333 }
334 
335 ZWeakRootsIterator::ZWeakRootsIterator() :
336     _jvmti_weak_export(this),
337     _jfr_weak(this) {
338   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
339   ZStatTimer timer(ZSubPhasePauseWeakRootsSetup);
340 }
341 
342 ZWeakRootsIterator::~ZWeakRootsIterator() {
343   ZStatTimer timer(ZSubPhasePauseWeakRootsTeardown);
344 }
345 
346 void ZWeakRootsIterator::do_jvmti_weak_export(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
347   ZStatTimer timer(ZSubPhasePauseWeakRootsJVMTIWeakExport);
348   JvmtiExport::weak_oops_do(is_alive, cl);
349 }
350 
351 void ZWeakRootsIterator::do_jfr_weak(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
352 #if INCLUDE_JFR
353   ZStatTimer timer(ZSubPhasePauseWeakRootsJFRWeak);
354   Jfr::weak_oops_do(is_alive, cl);
355 #endif
356 }
357 
358 void ZWeakRootsIterator::weak_oops_do(BoolObjectClosure* is_alive, ZRootsIteratorClosure* cl) {
359   ZStatTimer timer(ZSubPhasePauseWeakRoots);
360   _jvmti_weak_export.weak_oops_do(is_alive, cl);
361   _jfr_weak.weak_oops_do(is_alive, cl);
362 }
363 
364 void ZWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
365   AlwaysTrueClosure always_alive;
366   weak_oops_do(&amp;always_alive, cl);
367 }
368 
369 ZConcurrentWeakRootsIterator::ZConcurrentWeakRootsIterator() :
<a name="35" id="anc35"></a><span class="line-modified">370     _vm_weak_handles_iter(OopStorageSet::vm_weak()),</span>
<span class="line-modified">371     _jni_weak_handles_iter(OopStorageSet::jni_weak()),</span>
<span class="line-modified">372     _string_table_iter(OopStorageSet::string_table_weak()),</span>
<span class="line-added">373     _resolved_method_table_iter(OopStorageSet::resolved_method_table_weak()),</span>
374     _vm_weak_handles(this),
375     _jni_weak_handles(this),
<a name="36" id="anc36"></a><span class="line-modified">376     _string_table(this),</span>
<span class="line-added">377     _resolved_method_table(this) {</span>
378   StringTable::reset_dead_counter();
<a name="37" id="anc37"></a><span class="line-added">379   ResolvedMethodTable::reset_dead_counter();</span>
380 }
381 
382 ZConcurrentWeakRootsIterator::~ZConcurrentWeakRootsIterator() {
383   StringTable::finish_dead_counter();
<a name="38" id="anc38"></a><span class="line-added">384   ResolvedMethodTable::finish_dead_counter();</span>
385 }
386 
387 void ZConcurrentWeakRootsIterator::do_vm_weak_handles(ZRootsIteratorClosure* cl) {
388   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsVMWeakHandles);
389   _vm_weak_handles_iter.oops_do(cl);
390 }
391 
392 void ZConcurrentWeakRootsIterator::do_jni_weak_handles(ZRootsIteratorClosure* cl) {
393   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsJNIWeakHandles);
394   _jni_weak_handles_iter.oops_do(cl);
395 }
396 
<a name="39" id="anc39"></a><span class="line-modified">397 template &lt;class Container&gt;</span>
<span class="line-added">398 class ZDeadCounterClosure : public ZRootsIteratorClosure  {</span>
399 private:
400   ZRootsIteratorClosure* const _cl;
401   size_t                       _ndead;
402 
403 public:
<a name="40" id="anc40"></a><span class="line-modified">404   ZDeadCounterClosure(ZRootsIteratorClosure* cl) :</span>
405       _cl(cl),
406       _ndead(0) {}
407 
<a name="41" id="anc41"></a><span class="line-modified">408   ~ZDeadCounterClosure() {</span>
<span class="line-modified">409     Container::inc_dead_counter(_ndead);</span>
410   }
411 
412   virtual void do_oop(oop* p) {
413     _cl-&gt;do_oop(p);
414     if (*p == NULL) {
415       _ndead++;
416     }
417   }
418 
419   virtual void do_oop(narrowOop* p) {
420     ShouldNotReachHere();
421   }
422 };
423 
424 void ZConcurrentWeakRootsIterator::do_string_table(ZRootsIteratorClosure* cl) {
425   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsStringTable);
<a name="42" id="anc42"></a><span class="line-modified">426   ZDeadCounterClosure&lt;StringTable&gt; counter_cl(cl);</span>
427   _string_table_iter.oops_do(&amp;counter_cl);
428 }
429 
<a name="43" id="anc43"></a><span class="line-added">430 void ZConcurrentWeakRootsIterator::do_resolved_method_table(ZRootsIteratorClosure* cl) {</span>
<span class="line-added">431   ZStatTimer timer(ZSubPhaseConcurrentWeakRootsResolvedMethodTable);</span>
<span class="line-added">432   ZDeadCounterClosure&lt;ResolvedMethodTable&gt; counter_cl(cl);</span>
<span class="line-added">433   _resolved_method_table_iter.oops_do(&amp;counter_cl);</span>
<span class="line-added">434 }</span>
<span class="line-added">435 </span>
436 void ZConcurrentWeakRootsIterator::oops_do(ZRootsIteratorClosure* cl) {
437   ZStatTimer timer(ZSubPhaseConcurrentWeakRoots);
438   _vm_weak_handles.oops_do(cl);
439   _jni_weak_handles.oops_do(cl);
440   _string_table.oops_do(cl);
<a name="44" id="anc44"></a><span class="line-modified">441   _resolved_method_table.oops_do(cl);</span>






















442 }
<a name="45" id="anc45"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="45" type="hidden" />
</body>
</html>