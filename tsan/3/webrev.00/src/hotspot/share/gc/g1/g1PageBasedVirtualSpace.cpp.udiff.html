<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/g1PageBasedVirtualSpace.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1OopStarChunkedList.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1PageBasedVirtualSpace.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1PageBasedVirtualSpace.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,11 @@</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/g1/g1PageBasedVirtualSpace.hpp&quot;
  #include &quot;gc/shared/workgroup.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;oops/markOop.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;oops/markWord.hpp&quot;</span>
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
  #include &quot;runtime/os.inline.hpp&quot;
  #include &quot;services/memTracker.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,10 +122,15 @@</span>
  
  char* G1PageBasedVirtualSpace::page_start(size_t index) const {
    return _low_boundary + index * _page_size;
  }
  
<span class="udiff-line-added">+ size_t G1PageBasedVirtualSpace::page_size() const {</span>
<span class="udiff-line-added">+   assert(_page_size &gt; 0, &quot;Page size is not yet initialized.&quot;);</span>
<span class="udiff-line-added">+   return _page_size;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool G1PageBasedVirtualSpace::is_after_last_page(size_t index) const {
    guarantee(index &lt;= _committed.size(),
              &quot;Given boundary page &quot; SIZE_FORMAT &quot; is beyond managed page count &quot; SIZE_FORMAT, index, _committed.size());
    return index == _committed.size();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -254,11 +259,11 @@</span>
    }
  
    virtual void work(uint worker_id) {
      size_t const actual_chunk_size = MAX2(chunk_size(), _page_size);
      while (true) {
<span class="udiff-line-modified-removed">-       char* touch_addr = Atomic::add(actual_chunk_size, &amp;_cur_addr) - actual_chunk_size;</span>
<span class="udiff-line-modified-added">+       char* touch_addr = Atomic::fetch_and_add(&amp;_cur_addr, actual_chunk_size);</span>
        if (touch_addr &lt; _start_addr || touch_addr &gt;= _end_addr) {
          break;
        }
        char* end_addr = touch_addr + MIN2(actual_chunk_size, pointer_delta(_end_addr, touch_addr, sizeof(char)));
        os::pretouch_memory(touch_addr, end_addr, _page_size);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -272,11 +277,11 @@</span>
    G1PretouchTask cl(page_start(start_page), bounded_end_addr(start_page + size_in_pages), _page_size);
  
    if (pretouch_gang != NULL) {
      size_t num_chunks = MAX2((size_t)1, size_in_pages * _page_size / MAX2(G1PretouchTask::chunk_size(), _page_size));
  
<span class="udiff-line-modified-removed">-     uint num_workers = MIN2((uint)num_chunks, pretouch_gang-&gt;active_workers());</span>
<span class="udiff-line-modified-added">+     uint num_workers = MIN2((uint)num_chunks, pretouch_gang-&gt;total_workers());</span>
      log_debug(gc, heap)(&quot;Running %s with %u workers for &quot; SIZE_FORMAT &quot; work units pre-touching &quot; SIZE_FORMAT &quot;B.&quot;,
                          cl.name(), num_workers, num_chunks, size_in_pages * _page_size);
      pretouch_gang-&gt;run_task(&amp;cl, num_workers);
    } else {
      log_debug(gc, heap)(&quot;Running %s pre-touching &quot; SIZE_FORMAT &quot;B.&quot;,
</pre>
<center><a href="g1OopStarChunkedList.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1PageBasedVirtualSpace.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>