<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/g1/g1CollectedHeap.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1CollectedHeap.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1CollectedHeap.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1CollectedHeap.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  26 #define SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  27 
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1BiasedArray.hpp&quot;
  30 #include &quot;gc/g1/g1CardTable.hpp&quot;
  31 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  32 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  33 #include &quot;gc/g1/g1ConcurrentMark.hpp&quot;
<span class="line-removed">  34 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;</span>
  35 #include &quot;gc/g1/g1EdenRegions.hpp&quot;
  36 #include &quot;gc/g1/g1EvacFailure.hpp&quot;
  37 #include &quot;gc/g1/g1EvacStats.hpp&quot;
  38 #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;
  39 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  40 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  41 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  42 #include &quot;gc/g1/g1HRPrinter.hpp&quot;
<span class="line-modified">  43 #include &quot;gc/g1/g1InCSetState.hpp&quot;</span>
  44 #include &quot;gc/g1/g1MonitoringSupport.hpp&quot;


  45 #include &quot;gc/g1/g1SurvivorRegions.hpp&quot;
  46 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  47 #include &quot;gc/g1/heapRegionManager.hpp&quot;
  48 #include &quot;gc/g1/heapRegionSet.hpp&quot;
  49 #include &quot;gc/g1/heterogeneousHeapRegionManager.hpp&quot;
  50 #include &quot;gc/shared/barrierSet.hpp&quot;
  51 #include &quot;gc/shared/collectedHeap.hpp&quot;
  52 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  53 #include &quot;gc/shared/plab.hpp&quot;
  54 #include &quot;gc/shared/preservedMarks.hpp&quot;
  55 #include &quot;gc/shared/softRefPolicy.hpp&quot;
  56 #include &quot;memory/memRegion.hpp&quot;
  57 #include &quot;utilities/stack.hpp&quot;
  58 
  59 // A &quot;G1CollectedHeap&quot; is an implementation of a java heap for HotSpot.
  60 // It uses the &quot;Garbage First&quot; heap organization and algorithm, which
  61 // may combine concurrent marking with parallel, incremental compaction of
  62 // heap subsets that will yield large amounts of garbage.
  63 
  64 // Forward declarations
  65 class HeapRegion;
  66 class GenerationSpec;
  67 class G1ParScanThreadState;
  68 class G1ParScanThreadStateSet;
  69 class G1ParScanThreadState;
  70 class MemoryPool;
  71 class MemoryManager;
  72 class ObjectClosure;
  73 class SpaceClosure;
  74 class CompactibleSpaceClosure;
  75 class Space;

  76 class G1CollectionSet;
<span class="line-removed">  77 class G1CollectorPolicy;</span>
  78 class G1Policy;
  79 class G1HotCardCache;
  80 class G1RemSet;
  81 class G1YoungRemSetSamplingThread;
<span class="line-removed">  82 class HeapRegionRemSetIterator;</span>
  83 class G1ConcurrentMark;
  84 class G1ConcurrentMarkThread;
  85 class G1ConcurrentRefine;
  86 class GenerationCounters;
  87 class STWGCTimer;
  88 class G1NewTracer;
  89 class EvacuationFailedInfo;
  90 class nmethod;
  91 class WorkGang;
  92 class G1Allocator;
  93 class G1ArchiveAllocator;
  94 class G1FullGCScope;
  95 class G1HeapVerifier;
  96 class G1HeapSizingPolicy;
  97 class G1HeapSummary;
  98 class G1EvacSummary;
  99 
 100 typedef OverflowTaskQueue&lt;StarTask, mtGC&gt;         RefToScanQueue;
 101 typedef GenericTaskQueueSet&lt;RefToScanQueue, mtGC&gt; RefToScanQueueSet;
 102 
</pre>
<hr />
<pre>
 113 public:
 114   G1STWIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 115   bool do_object_b(oop p);
 116 };
 117 
 118 class G1STWSubjectToDiscoveryClosure : public BoolObjectClosure {
 119   G1CollectedHeap* _g1h;
 120 public:
 121   G1STWSubjectToDiscoveryClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 122   bool do_object_b(oop p);
 123 };
 124 
 125 class G1RegionMappingChangedListener : public G1MappingChangedListener {
 126  private:
 127   void reset_from_card_cache(uint start_idx, size_t num_regions);
 128  public:
 129   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 130 };
 131 
 132 class G1CollectedHeap : public CollectedHeap {
<span class="line-removed"> 133   friend class G1FreeCollectionSetTask;</span>
 134   friend class VM_CollectForMetadataAllocation;
 135   friend class VM_G1CollectForAllocation;
 136   friend class VM_G1CollectFull;

 137   friend class VMStructs;
 138   friend class MutatorAllocRegion;
 139   friend class G1FullCollector;
 140   friend class G1GCAllocRegion;
 141   friend class G1HeapVerifier;
 142 
 143   // Closures used in implementation.
 144   friend class G1ParScanThreadState;
 145   friend class G1ParScanThreadStateSet;
<span class="line-modified"> 146   friend class G1ParTask;</span>
 147   friend class G1PLABAllocator;
<span class="line-removed"> 148   friend class G1PrepareCompactClosure;</span>
 149 
 150   // Other related classes.
 151   friend class HeapRegionClaimer;
 152 
 153   // Testing classes.
<span class="line-modified"> 154   friend class G1CheckCSetFastTableClosure;</span>
 155 
 156 private:
 157   G1YoungRemSetSamplingThread* _young_gen_sampling_thread;
 158 
 159   WorkGang* _workers;
<span class="line-removed"> 160   G1CollectorPolicy* _collector_policy;</span>
 161   G1CardTable* _card_table;
 162 
 163   SoftRefPolicy      _soft_ref_policy;
 164 
 165   static size_t _humongous_object_threshold_in_words;
 166 
 167   // These sets keep track of old, archive and humongous regions respectively.
 168   HeapRegionSet _old_set;
 169   HeapRegionSet _archive_set;
 170   HeapRegionSet _humongous_set;
 171 
 172   void eagerly_reclaim_humongous_regions();
 173   // Start a new incremental collection set for the next pause.
 174   void start_new_collection_set();
 175 
 176   // The block offset table for the G1 heap.
 177   G1BlockOffsetTable* _bot;
 178 
 179   // Tears down the region sets / lists so that they are empty and the
 180   // regions on the heap do not belong to a region set / list. The
 181   // only exception is the humongous set which we leave unaltered. If
 182   // free_list_only is true, it will only tear down the master free
 183   // list. It is called before a Full GC (free_list_only == false) or
 184   // before heap shrinking (free_list_only == true).
 185   void tear_down_region_sets(bool free_list_only);
 186 
 187   // Rebuilds the region sets / lists so that they are repopulated to
 188   // reflect the contents of the heap. The only exception is the
 189   // humongous set which was not torn down in the first place. If
 190   // free_list_only is true, it will only rebuild the master free
 191   // list. It is called after a Full GC (free_list_only == false) or
 192   // after heap shrinking (free_list_only == true).
 193   void rebuild_region_sets(bool free_list_only);
 194 
 195   // Callback for region mapping changed events.
 196   G1RegionMappingChangedListener _listener;
 197 



 198   // The sequence of all heap regions in the heap.
 199   HeapRegionManager* _hrm;
 200 
 201   // Manages all allocations with regions except humongous object allocations.
 202   G1Allocator* _allocator;
 203 
 204   // Manages all heap verification.
 205   G1HeapVerifier* _verifier;
 206 
 207   // Outside of GC pauses, the number of bytes used in all regions other
 208   // than the current allocation region(s).
<span class="line-modified"> 209   size_t _summary_bytes_used;</span>
 210 
 211   void increase_used(size_t bytes);
 212   void decrease_used(size_t bytes);
 213 
 214   void set_used(size_t bytes);
 215 




 216   // Class that handles archive allocation ranges.
 217   G1ArchiveAllocator* _archive_allocator;
 218 
 219   // GC allocation statistics policy for survivors.
 220   G1EvacStats _survivor_evac_stats;
 221 
 222   // GC allocation statistics policy for tenured objects.
 223   G1EvacStats _old_evac_stats;
 224 
 225   // It specifies whether we should attempt to expand the heap after a
 226   // region allocation failure. If heap expansion fails we set this to
 227   // false so that we don&#39;t re-attempt the heap expansion (it&#39;s likely
 228   // that subsequent expansion attempts will also fail if one fails).
 229   // Currently, it is only consulted during GC and it&#39;s reset at the
 230   // start of each GC.
 231   bool _expand_heap_after_alloc_failure;
 232 
 233   // Helper for monitoring and management support.
 234   G1MonitoringSupport* _g1mm;
 235 
</pre>
<hr />
<pre>
 242   class HumongousReclaimCandidates : public G1BiasedMappedArray&lt;bool&gt; {
 243    protected:
 244     bool default_value() const { return false; }
 245    public:
 246     void clear() { G1BiasedMappedArray&lt;bool&gt;::clear(); }
 247     void set_candidate(uint region, bool value) {
 248       set_by_index(region, value);
 249     }
 250     bool is_candidate(uint region) {
 251       return get_by_index(region);
 252     }
 253   };
 254 
 255   HumongousReclaimCandidates _humongous_reclaim_candidates;
 256   // Stores whether during humongous object registration we found candidate regions.
 257   // If not, we can skip a few steps.
 258   bool _has_humongous_reclaim_candidates;
 259 
 260   G1HRPrinter _hr_printer;
 261 
<span class="line-modified"> 262   // It decides whether an explicit GC should start a concurrent cycle</span>
<span class="line-modified"> 263   // instead of doing a STW GC. Currently, a concurrent cycle is</span>
<span class="line-modified"> 264   // explicitly started if:</span>
<span class="line-modified"> 265   // (a) cause == _gc_locker and +GCLockerInvokesConcurrent, or</span>
<span class="line-modified"> 266   // (b) cause == _g1_humongous_allocation</span>
<span class="line-modified"> 267   // (c) cause == _java_lang_system_gc and +ExplicitGCInvokesConcurrent.</span>
<span class="line-modified"> 268   // (d) cause == _dcmd_gc_run and +ExplicitGCInvokesConcurrent.</span>
<span class="line-removed"> 269   // (e) cause == _wb_conc_mark</span>
 270   bool should_do_concurrent_full_gc(GCCause::Cause cause);
 271 






 272   // Return true if should upgrade to full gc after an incremental one.
 273   bool should_upgrade_to_full_gc(GCCause::Cause cause);
 274 
 275   // indicates whether we are in young or mixed GC mode
 276   G1CollectorState _collector_state;
 277 
 278   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 279   // concurrent cycles) we have started.
 280   volatile uint _old_marking_cycles_started;
 281 
 282   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 283   // concurrent cycles) we have completed.
 284   volatile uint _old_marking_cycles_completed;
 285 
 286   // This is a non-product method that is helpful for testing. It is
 287   // called at the end of a GC and artificially expands the heap by
 288   // allocating a number of dead regions. This way we can induce very
 289   // frequent marking cycles and stress the cleanup / concurrent
 290   // cleanup code more (as all the regions that will be allocated by
 291   // this method will be found dead by the marking cycle).
</pre>
<hr />
<pre>
 340   do {                                                                        \
 341     assert(!Heap_lock-&gt;owned_by_self(),                                       \
 342         heap_locking_asserts_params(&quot;should not be holding the Heap_lock&quot;));  \
 343   } while (0)
 344 
 345 #define assert_heap_not_locked_and_not_at_safepoint()                         \
 346   do {                                                                        \
 347     assert(!Heap_lock-&gt;owned_by_self() &amp;&amp;                                     \
 348                                     !SafepointSynchronize::is_at_safepoint(), \
 349       heap_locking_asserts_params(&quot;should not be holding the Heap_lock and &quot;  \
 350                                    &quot;should not be at a safepoint&quot;));          \
 351   } while (0)
 352 
 353 #define assert_at_safepoint_on_vm_thread()                                    \
 354   do {                                                                        \
 355     assert_at_safepoint();                                                    \
 356     assert(Thread::current_or_null() != NULL, &quot;no current thread&quot;);           \
 357     assert(Thread::current()-&gt;is_VM_thread(), &quot;current thread is not VM thread&quot;); \
 358   } while (0)
 359 















 360   // The young region list.
 361   G1EdenRegions _eden;
 362   G1SurvivorRegions _survivor;
 363 
 364   STWGCTimer* _gc_timer_stw;
 365 
 366   G1NewTracer* _gc_tracer_stw;
 367 
 368   // The current policy object for the collector.
 369   G1Policy* _policy;
 370   G1HeapSizingPolicy* _heap_sizing_policy;
 371 
 372   G1CollectionSet _collection_set;
 373 
 374   // Try to allocate a single non-humongous HeapRegion sufficient for
 375   // an allocation of the given word_size. If do_expand is true,
 376   // attempt to expand the heap if necessary to satisfy the allocation
 377   // request. &#39;type&#39; takes the type of region to be allocated. (Use constants
 378   // Old, Eden, Humongous, Survivor defined in HeapRegionType.)
<span class="line-modified"> 379   HeapRegion* new_region(size_t word_size, HeapRegionType type, bool do_expand);</span>



 380 
 381   // Initialize a contiguous set of free regions of length num_regions
 382   // and starting at index first so that they appear as a single
 383   // humongous region.
 384   HeapWord* humongous_obj_allocate_initialize_regions(uint first,
 385                                                       uint num_regions,
 386                                                       size_t word_size);
 387 
 388   // Attempt to allocate a humongous object of the given size. Return
 389   // NULL if unsuccessful.
 390   HeapWord* humongous_obj_allocate(size_t word_size);
 391 
 392   // The following two methods, allocate_new_tlab() and
 393   // mem_allocate(), are the two main entry points from the runtime
 394   // into the G1&#39;s allocation routines. They have the following
 395   // assumptions:
 396   //
 397   // * They should both be called outside safepoints.
 398   //
 399   // * They should both be called without holding the Heap_lock.
</pre>
<hr />
<pre>
 434 
 435   // Second-level mutator allocation attempt: take the Heap_lock and
 436   // retry the allocation attempt, potentially scheduling a GC
 437   // pause. This should only be used for non-humongous allocations.
 438   HeapWord* attempt_allocation_slow(size_t word_size);
 439 
 440   // Takes the Heap_lock and attempts a humongous allocation. It can
 441   // potentially schedule a GC pause.
 442   HeapWord* attempt_allocation_humongous(size_t word_size);
 443 
 444   // Allocation attempt that should be called during safepoints (e.g.,
 445   // at the end of a successful GC). expect_null_mutator_alloc_region
 446   // specifies whether the mutator alloc region is expected to be NULL
 447   // or not.
 448   HeapWord* attempt_allocation_at_safepoint(size_t word_size,
 449                                             bool expect_null_mutator_alloc_region);
 450 
 451   // These methods are the &quot;callbacks&quot; from the G1AllocRegion class.
 452 
 453   // For mutator alloc regions.
<span class="line-modified"> 454   HeapRegion* new_mutator_alloc_region(size_t word_size, bool force);</span>
 455   void retire_mutator_alloc_region(HeapRegion* alloc_region,
 456                                    size_t allocated_bytes);
 457 
 458   // For GC alloc regions.
<span class="line-modified"> 459   bool has_more_regions(InCSetState dest);</span>
<span class="line-modified"> 460   HeapRegion* new_gc_alloc_region(size_t word_size, InCSetState dest);</span>
 461   void retire_gc_alloc_region(HeapRegion* alloc_region,
<span class="line-modified"> 462                               size_t allocated_bytes, InCSetState dest);</span>
 463 
 464   // - if explicit_gc is true, the GC is for a System.gc() etc,
 465   //   otherwise it&#39;s for a failed allocation.
 466   // - if clear_all_soft_refs is true, all soft references should be
 467   //   cleared during the GC.
 468   // - it returns false if it is unable to do the collection due to the
 469   //   GC locker being active, true otherwise.
 470   bool do_full_collection(bool explicit_gc,
 471                           bool clear_all_soft_refs);
 472 
 473   // Callback from VM_G1CollectFull operation, or collect_as_vm_thread.
 474   virtual void do_full_collection(bool clear_all_soft_refs);
 475 
 476   // Callback from VM_G1CollectForAllocation operation.
 477   // This function does everything necessary/possible to satisfy a
 478   // failed allocation request (including collection, expansion, etc.)
 479   HeapWord* satisfy_failed_allocation(size_t word_size,
 480                                       bool* succeeded);
 481   // Internal helpers used during full GC to split it up to
 482   // increase readability.
</pre>
<hr />
<pre>
 495                                              bool expect_null_mutator_alloc_region,
 496                                              bool* gc_succeeded);
 497 
 498   // Attempting to expand the heap sufficiently
 499   // to support an allocation of the given &quot;word_size&quot;.  If
 500   // successful, perform the allocation and return the address of the
 501   // allocated block, or else &quot;NULL&quot;.
 502   HeapWord* expand_and_allocate(size_t word_size);
 503 
 504   // Process any reference objects discovered.
 505   void process_discovered_references(G1ParScanThreadStateSet* per_thread_states);
 506 
 507   // If during an initial mark pause we may install a pending list head which is not
 508   // otherwise reachable ensure that it is marked in the bitmap for concurrent marking
 509   // to discover.
 510   void make_pending_list_reachable();
 511 
 512   // Merges the information gathered on a per-thread basis for all worker threads
 513   // during GC into global variables.
 514   void merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states);



 515 public:
 516   G1YoungRemSetSamplingThread* sampling_thread() const { return _young_gen_sampling_thread; }
 517 
 518   WorkGang* workers() const { return _workers; }
 519 




 520   G1Allocator* allocator() {
 521     return _allocator;
 522   }
 523 
 524   G1HeapVerifier* verifier() {
 525     return _verifier;
 526   }
 527 
 528   G1MonitoringSupport* g1mm() {
 529     assert(_g1mm != NULL, &quot;should have been initialized&quot;);
 530     return _g1mm;
 531   }
 532 
 533   void resize_heap_if_necessary();
 534 


 535   // Expand the garbage-first heap by at least the given size (in bytes!).
 536   // Returns true if the heap was expanded by the requested amount;
 537   // false otherwise.
 538   // (Rounds up to a HeapRegion boundary.)
 539   bool expand(size_t expand_bytes, WorkGang* pretouch_workers = NULL, double* expand_time_ms = NULL);

 540 
 541   // Returns the PLAB statistics for a given destination.
<span class="line-modified"> 542   inline G1EvacStats* alloc_buffer_stats(InCSetState dest);</span>
 543 
 544   // Determines PLAB size for a given destination.
<span class="line-modified"> 545   inline size_t desired_plab_sz(InCSetState dest);</span>
 546 
 547   // Do anything common to GC&#39;s.
 548   void gc_prologue(bool full);
 549   void gc_epilogue(bool full);
 550 
 551   // Does the given region fulfill remembered set based eager reclaim candidate requirements?
 552   bool is_potential_eager_reclaim_candidate(HeapRegion* r) const;
 553 
 554   // Modify the reclaim candidate set and test for presence.
 555   // These are only valid for starts_humongous regions.
 556   inline void set_humongous_reclaim_candidate(uint region, bool value);
 557   inline bool is_humongous_reclaim_candidate(uint region);

 558 
 559   // Remove from the reclaim candidate set.  Also remove from the
 560   // collection set so that later encounters avoid the slow path.
 561   inline void set_humongous_is_live(oop obj);
 562 
 563   // Register the given region to be part of the collection set.
<span class="line-modified"> 564   inline void register_humongous_region_with_cset(uint index);</span>
<span class="line-modified"> 565   // Register regions with humongous objects (actually on the start region) in</span>
<span class="line-removed"> 566   // the in_cset_fast_test table.</span>
<span class="line-removed"> 567   void register_humongous_regions_with_cset();</span>
 568   // We register a region with the fast &quot;in collection set&quot; test. We
 569   // simply set to true the array slot corresponding to this region.
<span class="line-modified"> 570   void register_young_region_with_cset(HeapRegion* r) {</span>
<span class="line-modified"> 571     _in_cset_fast_test.set_in_young(r-&gt;hrm_index());</span>
<span class="line-removed"> 572   }</span>
<span class="line-removed"> 573   void register_old_region_with_cset(HeapRegion* r) {</span>
<span class="line-removed"> 574     _in_cset_fast_test.set_in_old(r-&gt;hrm_index());</span>
<span class="line-removed"> 575   }</span>
<span class="line-removed"> 576   void register_optional_region_with_cset(HeapRegion* r) {</span>
<span class="line-removed"> 577     _in_cset_fast_test.set_optional(r-&gt;hrm_index());</span>
 578   }
<span class="line-modified"> 579   void clear_in_cset(const HeapRegion* hr) {</span>
<span class="line-modified"> 580     _in_cset_fast_test.clear(hr);</span>




 581   }
 582 
<span class="line-modified"> 583   void clear_cset_fast_test() {</span>
<span class="line-modified"> 584     _in_cset_fast_test.clear();</span>
 585   }
 586 




 587   bool is_user_requested_concurrent_full_gc(GCCause::Cause cause);
 588 
 589   // This is called at the start of either a concurrent cycle or a Full
 590   // GC to update the number of old marking cycles started.
 591   void increment_old_marking_cycles_started();
 592 
 593   // This is called at the end of either a concurrent cycle or a Full
 594   // GC to update the number of old marking cycles completed. Those two
 595   // can happen in a nested fashion, i.e., we start a concurrent
 596   // cycle, a Full GC happens half-way through it which ends first,
 597   // and then the cycle notices that a Full GC happened and ends
 598   // too. The concurrent parameter is a boolean to help us do a bit
 599   // tighter consistency checking in the method. If concurrent is
 600   // false, the caller is the inner caller in the nesting (i.e., the
 601   // Full GC). If concurrent is true, the caller is the outer caller
 602   // in this nesting (i.e., the concurrent cycle). Further nesting is
 603   // not currently supported. The end of this call also notifies
<span class="line-modified"> 604   // the FullGCCount_lock in case a Java thread is waiting for a full</span>
 605   // GC to happen (e.g., it called System.gc() with
 606   // +ExplicitGCInvokesConcurrent).
 607   void increment_old_marking_cycles_completed(bool concurrent);
 608 
 609   uint old_marking_cycles_completed() {
 610     return _old_marking_cycles_completed;
 611   }
 612 
 613   G1HRPrinter* hr_printer() { return &amp;_hr_printer; }
 614 
 615   // Allocates a new heap region instance.
 616   HeapRegion* new_heap_region(uint hrs_index, MemRegion mr);
 617 
 618   // Allocate the highest free region in the reserved heap. This will commit
 619   // regions as necessary.
 620   HeapRegion* alloc_highest_free_region();
 621 
<span class="line-modified"> 622   // Frees a non-humongous region by initializing its contents and</span>
<span class="line-modified"> 623   // adding it to the free list that&#39;s passed as a parameter (this is</span>
<span class="line-modified"> 624   // usually a local list which will be appended to the master free</span>
<span class="line-modified"> 625   // list later). The used bytes of freed regions are accumulated in</span>
<span class="line-modified"> 626   // pre_used. If skip_remset is true, the region&#39;s RSet will not be freed</span>
<span class="line-modified"> 627   // up. If skip_hot_card_cache is true, the region&#39;s hot card cache will not</span>
<span class="line-modified"> 628   // be freed up. The assumption is that this will be done later.</span>
<span class="line-removed"> 629   // The locked parameter indicates if the caller has already taken</span>
<span class="line-removed"> 630   // care of proper synchronization. This may allow some optimizations.</span>
<span class="line-removed"> 631   void free_region(HeapRegion* hr,</span>
<span class="line-removed"> 632                    FreeRegionList* free_list,</span>
<span class="line-removed"> 633                    bool skip_remset,</span>
<span class="line-removed"> 634                    bool skip_hot_card_cache = false,</span>
<span class="line-removed"> 635                    bool locked = false);</span>
 636 
 637   // It dirties the cards that cover the block so that the post
 638   // write barrier never queues anything when updating objects on this
 639   // block. It is assumed (and in fact we assert) that the block
 640   // belongs to a young region.
 641   inline void dirty_young_block(HeapWord* start, size_t word_size);
 642 
 643   // Frees a humongous region by collapsing it into individual regions
 644   // and calling free_region() for each of them. The freed regions
 645   // will be added to the free list that&#39;s passed as a parameter (this
 646   // is usually a local list which will be appended to the master free
 647   // list later).
 648   // The method assumes that only a single thread is ever calling
 649   // this for a particular region at once.
 650   void free_humongous_region(HeapRegion* hr,
 651                              FreeRegionList* free_list);
 652 
 653   // Facility for allocating in &#39;archive&#39; regions in high heap memory and
 654   // recording the allocated ranges. These should all be called from the
 655   // VM thread at safepoints, without the heap lock held. They can be used
</pre>
<hr />
<pre>
 674   // the containing regions as &#39;archive&#39;. For use at JVM init time, when the
 675   // caller may mmap archived heap data at the specified range(s).
 676   // Verify that the MemRegions specified in the argument array are within the
 677   // reserved heap.
 678   bool check_archive_addresses(MemRegion* range, size_t count);
 679 
 680   // Commit the appropriate G1 regions containing the specified MemRegions
 681   // and mark them as &#39;archive&#39; regions. The regions in the array must be
 682   // non-overlapping and in order of ascending address.
 683   bool alloc_archive_regions(MemRegion* range, size_t count, bool open);
 684 
 685   // Insert any required filler objects in the G1 regions around the specified
 686   // ranges to make the regions parseable. This must be called after
 687   // alloc_archive_regions, and after class loading has occurred.
 688   void fill_archive_regions(MemRegion* range, size_t count);
 689 
 690   // For each of the specified MemRegions, uncommit the containing G1 regions
 691   // which had been allocated by alloc_archive_regions. This should be called
 692   // rather than fill_archive_regions at JVM init time if the archive file
 693   // mapping failed, with the same non-overlapping and sorted MemRegion array.
<span class="line-modified"> 694   void dealloc_archive_regions(MemRegion* range, size_t count, bool is_open);</span>
 695 
 696   oop materialize_archived_object(oop obj);
 697 
 698 private:
 699 
 700   // Shrink the garbage-first heap by at most the given size (in bytes!).
 701   // (Rounds down to a HeapRegion boundary.)
 702   void shrink(size_t expand_bytes);
 703   void shrink_helper(size_t expand_bytes);
 704 
 705   #if TASKQUEUE_STATS
 706   static void print_taskqueue_stats_hdr(outputStream* const st);
 707   void print_taskqueue_stats() const;
 708   void reset_taskqueue_stats();
 709   #endif // TASKQUEUE_STATS
 710 
 711   // Schedule the VM operation that will do an evacuation pause to
 712   // satisfy an allocation request of word_size. *succeeded will
 713   // return whether the VM operation was successful (it did do an
 714   // evacuation pause) or not (another thread beat us to it or the GC
 715   // locker was active). Given that we should not be holding the
 716   // Heap_lock when we enter this method, we will pass the
 717   // gc_count_before (i.e., total_collections()) as a parameter since
 718   // it has to be read while holding the Heap_lock. Currently, both
 719   // methods that call do_collection_pause() release the Heap_lock
 720   // before the call, so it&#39;s easy to read gc_count_before just before.
 721   HeapWord* do_collection_pause(size_t         word_size,
 722                                 uint           gc_count_before,
 723                                 bool*          succeeded,
 724                                 GCCause::Cause gc_cause);
 725 
 726   void wait_for_root_region_scanning();
 727 
<span class="line-modified"> 728   // The guts of the incremental collection pause, executed by the vm</span>
<span class="line-modified"> 729   // thread. It returns false if it is unable to do the collection due</span>
<span class="line-modified"> 730   // to the GC locker being active, true otherwise</span>



 731   bool do_collection_pause_at_safepoint(double target_pause_time_ms);
 732 
<span class="line-modified"> 733   // Actually do the work of evacuating the collection set.</span>
<span class="line-modified"> 734   void evacuate_collection_set(G1ParScanThreadStateSet* per_thread_states);</span>










 735   void evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states);
<span class="line-modified"> 736   void evacuate_optional_regions(G1ParScanThreadStateSet* per_thread_states, G1OptionalCSet* ocset);</span>


 737 
<span class="line-modified"> 738   void pre_evacuate_collection_set();</span>
<span class="line-modified"> 739   void post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* pss);</span>



 740 

 741   // Update object copying statistics.
 742   void record_obj_copy_mem_stats();
 743 
 744   // The hot card cache for remembered set insertion optimization.
 745   G1HotCardCache* _hot_card_cache;
 746 
 747   // The g1 remembered set of the heap.
 748   G1RemSet* _rem_set;
 749 
<span class="line-removed"> 750   // A set of cards that cover the objects for which the Rsets should be updated</span>
<span class="line-removed"> 751   // concurrently after the collection.</span>
<span class="line-removed"> 752   G1DirtyCardQueueSet _dirty_card_queue_set;</span>
<span class="line-removed"> 753 </span>
 754   // After a collection pause, convert the regions in the collection set into free
 755   // regions.
 756   void free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words);
 757 
 758   // Abandon the current collection set without recording policy
 759   // statistics or updating free lists.
 760   void abandon_collection_set(G1CollectionSet* collection_set);
 761 
 762   // The concurrent marker (and the thread it runs in.)
 763   G1ConcurrentMark* _cm;
 764   G1ConcurrentMarkThread* _cm_thread;
 765 
 766   // The concurrent refiner.
 767   G1ConcurrentRefine* _cr;
 768 
 769   // The parallel task queues
 770   RefToScanQueueSet *_task_queues;
 771 
 772   // True iff a evacuation has failed in the current collection.
 773   bool _evacuation_failed;
 774 
 775   EvacuationFailedInfo* _evacuation_failed_info_array;
 776 
 777   // Failed evacuations cause some logical from-space objects to have
 778   // forwarding pointers to themselves.  Reset them.
<span class="line-modified"> 779   void remove_self_forwarding_pointers();</span>
 780 
 781   // Restore the objects in the regions in the collection set after an
 782   // evacuation failure.
<span class="line-modified"> 783   void restore_after_evac_failure();</span>
 784 
 785   PreservedMarksSet _preserved_marks_set;
 786 
 787   // Preserve the mark of &quot;obj&quot;, if necessary, in preparation for its mark
 788   // word being overwritten with a self-forwarding-pointer.
<span class="line-modified"> 789   void preserve_mark_during_evac_failure(uint worker_id, oop obj, markOop m);</span>
 790 
 791 #ifndef PRODUCT
 792   // Support for forcing evacuation failures. Analogous to
 793   // PromotionFailureALot for the other collectors.
 794 
 795   // Records whether G1EvacuationFailureALot should be in effect
 796   // for the current GC
 797   bool _evacuation_failure_alot_for_current_gc;
 798 
 799   // Used to record the GC number for interval checking when
 800   // determining whether G1EvaucationFailureALot is in effect
 801   // for the current GC.
 802   size_t _evacuation_failure_alot_gc_number;
 803 
 804   // Count of the number of evacuations between failures.
 805   volatile size_t _evacuation_failure_alot_count;
 806 
 807   // Set whether G1EvacuationFailureALot should be in effect
 808   // for the current GC (based upon the type of GC and which
 809   // command line flags are set);
</pre>
<hr />
<pre>
 891   G1STWSubjectToDiscoveryClosure _is_subject_to_discovery_stw;
 892 
 893   // The (concurrent marking) reference processor...
 894   ReferenceProcessor* _ref_processor_cm;
 895 
 896   // Instance of the concurrent mark is_alive closure for embedding
 897   // into the Concurrent Marking reference processor as the
 898   // _is_alive_non_header field. Supplying a value for the
 899   // _is_alive_non_header field is optional but doing so prevents
 900   // unnecessary additions to the discovered lists during reference
 901   // discovery.
 902   G1CMIsAliveClosure _is_alive_closure_cm;
 903 
 904   G1CMSubjectToDiscoveryClosure _is_subject_to_discovery_cm;
 905 public:
 906 
 907   RefToScanQueue *task_queue(uint i) const;
 908 
 909   uint num_task_queues() const;
 910 
<span class="line-modified"> 911   // A set of cards where updates happened during the GC</span>
<span class="line-removed"> 912   G1DirtyCardQueueSet&amp; dirty_card_queue_set() { return _dirty_card_queue_set; }</span>
<span class="line-removed"> 913 </span>
<span class="line-removed"> 914   // Create a G1CollectedHeap with the specified policy.</span>
 915   // Must call the initialize method afterwards.
 916   // May not return if something goes wrong.
<span class="line-modified"> 917   G1CollectedHeap(G1CollectorPolicy* policy);</span>
 918 
 919 private:
 920   jint initialize_concurrent_refinement();
 921   jint initialize_young_gen_sampling_thread();
 922 public:
 923   // Initialize the G1CollectedHeap to have the initial and
 924   // maximum sizes and remembered and barrier sets
 925   // specified by the policy object.
 926   jint initialize();
 927 
 928   virtual void stop();
 929   virtual void safepoint_synchronize_begin();
 930   virtual void safepoint_synchronize_end();
 931 
<span class="line-removed"> 932   // Return the (conservative) maximum heap alignment for any G1 heap</span>
<span class="line-removed"> 933   static size_t conservative_max_heap_alignment();</span>
<span class="line-removed"> 934 </span>
 935   // Does operations required after initialization has been done.
 936   void post_initialize();
 937 
 938   // Initialize weak reference processing.
 939   void ref_processing_init();
 940 
 941   virtual Name kind() const {
 942     return CollectedHeap::G1;
 943   }
 944 
 945   virtual const char* name() const {
 946     return &quot;G1&quot;;
 947   }
 948 
 949   const G1CollectorState* collector_state() const { return &amp;_collector_state; }
 950   G1CollectorState* collector_state() { return &amp;_collector_state; }
 951 
 952   // The current policy object for the collector.
 953   G1Policy* policy() const { return _policy; }
 954   // The remembered set.
 955   G1RemSet* rem_set() const { return _rem_set; }
 956 
 957   inline G1GCPhaseTimes* phase_times() const;
 958 
 959   HeapRegionManager* hrm() const { return _hrm; }
 960 
 961   const G1CollectionSet* collection_set() const { return &amp;_collection_set; }
 962   G1CollectionSet* collection_set() { return &amp;_collection_set; }
 963 
<span class="line-removed"> 964   virtual CollectorPolicy* collector_policy() const;</span>
<span class="line-removed"> 965 </span>
 966   virtual SoftRefPolicy* soft_ref_policy();
 967 
 968   virtual void initialize_serviceability();
 969   virtual MemoryUsage memory_usage();
 970   virtual GrowableArray&lt;GCMemoryManager*&gt; memory_managers();
 971   virtual GrowableArray&lt;MemoryPool*&gt; memory_pools();
 972 
 973   // Try to minimize the remembered set.
 974   void scrub_rem_set();
 975 
 976   // Apply the given closure on all cards in the Hot Card Cache, emptying it.
<span class="line-modified"> 977   void iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_i);</span>
<span class="line-removed"> 978 </span>
<span class="line-removed"> 979   // Apply the given closure on all cards in the Dirty Card Queue Set, emptying it.</span>
<span class="line-removed"> 980   void iterate_dirty_card_closure(G1CardTableEntryClosure* cl, uint worker_i);</span>
 981 
 982   // The shared block offset table array.
 983   G1BlockOffsetTable* bot() const { return _bot; }
 984 
 985   // Reference Processing accessors
 986 
 987   // The STW reference processor....
 988   ReferenceProcessor* ref_processor_stw() const { return _ref_processor_stw; }
 989 
 990   G1NewTracer* gc_tracer_stw() const { return _gc_tracer_stw; }
 991 
 992   // The Concurrent Marking reference processor...
 993   ReferenceProcessor* ref_processor_cm() const { return _ref_processor_cm; }
 994 
 995   size_t unused_committed_regions_in_bytes() const;

 996   virtual size_t capacity() const;
 997   virtual size_t used() const;
 998   // This should be called when we&#39;re not holding the heap lock. The
 999   // result might be a bit inaccurate.
1000   size_t used_unlocked() const;
1001   size_t recalculate_used() const;
1002 
1003   // These virtual functions do the actual allocation.
1004   // Some heaps may offer a contiguous region for shared non-blocking
1005   // allocation, via inlined code (by exporting the address of the top and
1006   // end fields defining the extent of the contiguous allocation region.)
1007   // But G1CollectedHeap doesn&#39;t yet support this.
1008 
1009   virtual bool is_maximal_no_gc() const {
1010     return _hrm-&gt;available() == 0;
1011   }
1012 
1013   // Returns whether there are any regions left in the heap for allocation.
1014   bool has_regions_left_for_allocation() const {
1015     return !is_maximal_no_gc() || num_free_regions() != 0;
</pre>
<hr />
<pre>
1044 #endif // ASSERT
1045 
1046   inline void old_set_add(HeapRegion* hr);
1047   inline void old_set_remove(HeapRegion* hr);
1048 
1049   inline void archive_set_add(HeapRegion* hr);
1050 
1051   size_t non_young_capacity_bytes() {
1052     return (old_regions_count() + _archive_set.length() + humongous_regions_count()) * HeapRegion::GrainBytes;
1053   }
1054 
1055   // Determine whether the given region is one that we are using as an
1056   // old GC alloc region.
1057   bool is_old_gc_alloc_region(HeapRegion* hr);
1058 
1059   // Perform a collection of the heap; intended for use in implementing
1060   // &quot;System.gc&quot;.  This probably implies as full a collection as the
1061   // &quot;CollectedHeap&quot; supports.
1062   virtual void collect(GCCause::Cause cause);
1063 
<span class="line-modified">1064   // Perform a collection of the heap with the given cause; if the VM operation</span>
<span class="line-removed">1065   // fails to execute for any reason, retry only if retry_on_gc_failure is set.</span>
1066   // Returns whether this collection actually executed.
<span class="line-modified">1067   bool try_collect(GCCause::Cause cause, bool retry_on_gc_failure);</span>
1068 
1069   // True iff an evacuation has failed in the most-recent collection.
1070   bool evacuation_failed() { return _evacuation_failed; }
1071 
1072   void remove_from_old_sets(const uint old_regions_removed, const uint humongous_regions_removed);
1073   void prepend_to_freelist(FreeRegionList* list);
1074   void decrement_summary_bytes(size_t bytes);
1075 
1076   virtual bool is_in(const void* p) const;
1077 #ifdef ASSERT
1078   // Returns whether p is in one of the available areas of the heap. Slow but
1079   // extensive version.
1080   bool is_in_exact(const void* p) const;
1081 #endif
1082 
1083   // Return &quot;TRUE&quot; iff the given object address is within the collection
1084   // set. Assumes that the reference points into the heap.
1085   inline bool is_in_cset(const HeapRegion *hr);
1086   inline bool is_in_cset(oop obj);
1087   inline bool is_in_cset(HeapWord* addr);
1088 
1089   inline bool is_in_cset_or_humongous(const oop obj);
1090 
1091  private:
1092   // This array is used for a quick test on whether a reference points into
1093   // the collection set or not. Each of the array&#39;s elements denotes whether the
1094   // corresponding region is in the collection set or not.
<span class="line-modified">1095   G1InCSetStateFastTestBiasedMappedArray _in_cset_fast_test;</span>
1096 
1097  public:
1098 
<span class="line-modified">1099   inline InCSetState in_cset_state(const oop obj);</span>

1100 
1101   // Return &quot;TRUE&quot; iff the given object address is in the reserved
1102   // region of g1.
1103   bool is_in_g1_reserved(const void* p) const {
1104     return _hrm-&gt;reserved().contains(p);
1105   }
1106 
1107   // Returns a MemRegion that corresponds to the space that has been
1108   // reserved for the heap
1109   MemRegion g1_reserved() const {
1110     return _hrm-&gt;reserved();
1111   }
1112 
<span class="line-modified">1113   virtual bool is_in_closed_subset(const void* p) const;</span>










1114 
<span class="line-modified">1115   G1HotCardCache* g1_hot_card_cache() const { return _hot_card_cache; }</span>
1116 
1117   G1CardTable* card_table() const {
1118     return _card_table;
1119   }
1120 
1121   // Iteration functions.
1122 
1123   // Iterate over all objects, calling &quot;cl.do_object&quot; on each.
1124   virtual void object_iterate(ObjectClosure* cl);
1125 
<span class="line-modified">1126   virtual void safe_object_iterate(ObjectClosure* cl) {</span>
<span class="line-modified">1127     object_iterate(cl);</span>
<span class="line-removed">1128   }</span>
1129 
1130   // Iterate over heap regions, in address order, terminating the
1131   // iteration early if the &quot;do_heap_region&quot; method returns &quot;true&quot;.
1132   void heap_region_iterate(HeapRegionClosure* blk) const;
1133 
1134   // Return the region with the given index. It assumes the index is valid.
1135   inline HeapRegion* region_at(uint index) const;
1136   inline HeapRegion* region_at_or_null(uint index) const;
1137 
1138   // Return the next region (by index) that is part of the same
1139   // humongous object that hr is part of.
1140   inline HeapRegion* next_region_in_humongous(HeapRegion* hr) const;
1141 
1142   // Calculate the region index of the given address. Given address must be
1143   // within the heap.
1144   inline uint addr_to_region(HeapWord* addr) const;
1145 
1146   inline HeapWord* bottom_addr_for_region(uint index) const;
1147 
1148   // Two functions to iterate over the heap regions in parallel. Threads
1149   // compete using the HeapRegionClaimer to claim the regions before
1150   // applying the closure on them.
1151   // The _from_worker_offset version uses the HeapRegionClaimer and
1152   // the worker id to calculate a start offset to prevent all workers to
1153   // start from the point.
1154   void heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
1155                                                   HeapRegionClaimer* hrclaimer,
1156                                                   uint worker_id) const;
1157 
1158   void heap_region_par_iterate_from_start(HeapRegionClosure* cl,
1159                                           HeapRegionClaimer* hrclaimer) const;
1160 
<span class="line-modified">1161   // Iterate over the regions (if any) in the current collection set.</span>
<span class="line-modified">1162   void collection_set_iterate(HeapRegionClosure* blk);</span>
<span class="line-modified">1163 </span>
<span class="line-modified">1164   // Iterate over the regions (if any) in the current collection set. Starts the</span>
<span class="line-modified">1165   // iteration over the entire collection set so that the start regions of a given</span>
<span class="line-modified">1166   // worker id over the set active_workers are evenly spread across the set of</span>
<span class="line-modified">1167   // collection set regions.</span>
<span class="line-modified">1168   void collection_set_iterate_from(HeapRegionClosure *blk, uint worker_id);</span>










1169 
1170   // Returns the HeapRegion that contains addr. addr must not be NULL.
1171   template &lt;class T&gt;
1172   inline HeapRegion* heap_region_containing(const T addr) const;
1173 
1174   // Returns the HeapRegion that contains addr, or NULL if that is an uncommitted
1175   // region. addr must not be NULL.
1176   template &lt;class T&gt;
1177   inline HeapRegion* heap_region_containing_or_null(const T addr) const;
1178 
1179   // A CollectedHeap is divided into a dense sequence of &quot;blocks&quot;; that is,
1180   // each address in the (reserved) heap is a member of exactly
1181   // one block.  The defining characteristic of a block is that it is
1182   // possible to find its size, and thus to progress forward to the next
1183   // block.  (Blocks may be of different sizes.)  Thus, blocks may
1184   // represent Java objects, or they might be free blocks in a
1185   // free-list-based heap (or subheap), as long as the two kinds are
1186   // distinguishable and the size of each is determinable.
1187 
1188   // Returns the address of the start of the &quot;block&quot; that contains the
1189   // address &quot;addr&quot;.  We say &quot;blocks&quot; instead of &quot;object&quot; since some heaps
1190   // may not pack objects densely; a chunk may either be an object or a
1191   // non-object.
<span class="line-modified">1192   virtual HeapWord* block_start(const void* addr) const;</span>
1193 
1194   // Requires &quot;addr&quot; to be the start of a block, and returns &quot;TRUE&quot; iff
1195   // the block is an object.
<span class="line-modified">1196   virtual bool block_is_obj(const HeapWord* addr) const;</span>
1197 
1198   // Section on thread-local allocation buffers (TLABs)
1199   // See CollectedHeap for semantics.
1200 
1201   bool supports_tlab_allocation() const;
1202   size_t tlab_capacity(Thread* ignored) const;
1203   size_t tlab_used(Thread* ignored) const;
1204   size_t max_tlab_size() const;
1205   size_t unsafe_max_tlab_alloc(Thread* ignored) const;
1206 
1207   inline bool is_in_young(const oop obj);
1208 
1209   // Returns &quot;true&quot; iff the given word_size is &quot;very large&quot;.
1210   static bool is_humongous(size_t word_size) {
1211     // Note this has to be strictly greater-than as the TLABs
1212     // are capped at the humongous threshold and we want to
1213     // ensure that we don&#39;t try to allocate a TLAB as
1214     // humongous and that we don&#39;t allocate a humongous
1215     // object in a TLAB.
1216     return word_size &gt; _humongous_object_threshold_in_words;
</pre>
<hr />
<pre>
1227 
1228   // Print the maximum heap capacity.
1229   virtual size_t max_capacity() const;
1230 
1231   // Return the size of reserved memory. Returns different value than max_capacity() when AllocateOldGenAt is used.
1232   virtual size_t max_reserved_capacity() const;
1233 
1234   virtual jlong millis_since_last_gc();
1235 
1236 
1237   // Convenience function to be used in situations where the heap type can be
1238   // asserted to be this type.
1239   static G1CollectedHeap* heap();
1240 
1241   void set_region_short_lived_locked(HeapRegion* hr);
1242   // add appropriate methods for any other surv rate groups
1243 
1244   const G1SurvivorRegions* survivor() const { return &amp;_survivor; }
1245 
1246   uint eden_regions_count() const { return _eden.length(); }

1247   uint survivor_regions_count() const { return _survivor.length(); }



1248   uint young_regions_count() const { return _eden.length() + _survivor.length(); }
1249   uint old_regions_count() const { return _old_set.length(); }
1250   uint archive_regions_count() const { return _archive_set.length(); }
1251   uint humongous_regions_count() const { return _humongous_set.length(); }
1252 
1253 #ifdef ASSERT
1254   bool check_young_list_empty();
1255 #endif
1256 
1257   // *** Stuff related to concurrent marking.  It&#39;s not clear to me that so
1258   // many of these need to be public.
1259 
1260   // The functions below are helper functions that a subclass of
1261   // &quot;CollectedHeap&quot; can use in the implementation of its virtual
1262   // functions.
1263   // This performs a concurrent marking of the live objects in a
1264   // bitmap off to the side.
1265   void do_concurrent_mark();
1266 
1267   bool is_marked_next(oop obj) const;
</pre>
<hr />
<pre>
1296 
1297   inline bool is_obj_ill(const oop obj) const;
1298 
1299   inline bool is_obj_dead_full(const oop obj, const HeapRegion* hr) const;
1300   inline bool is_obj_dead_full(const oop obj) const;
1301 
1302   G1ConcurrentMark* concurrent_mark() const { return _cm; }
1303 
1304   // Refinement
1305 
1306   G1ConcurrentRefine* concurrent_refine() const { return _cr; }
1307 
1308   // Optimized nmethod scanning support routines
1309 
1310   // Register the given nmethod with the G1 heap.
1311   virtual void register_nmethod(nmethod* nm);
1312 
1313   // Unregister the given nmethod from the G1 heap.
1314   virtual void unregister_nmethod(nmethod* nm);
1315 






1316   // Free up superfluous code root memory.
1317   void purge_code_root_memory();
1318 
1319   // Rebuild the strong code root lists for each region
1320   // after a full GC.
1321   void rebuild_strong_code_roots();
1322 
1323   // Partial cleaning of VM internal data structures.
1324   void string_dedup_cleaning(BoolObjectClosure* is_alive,
1325                              OopClosure* keep_alive,
1326                              G1GCPhaseTimes* phase_times = NULL);
1327 
1328   // Performs cleaning of data structures after class unloading.
1329   void complete_cleaning(BoolObjectClosure* is_alive, bool class_unloading_occurred);
1330 
1331   // Redirty logged cards in the refinement queue.
<span class="line-modified">1332   void redirty_logged_cards();</span>

1333   // Verification
1334 
1335   // Deduplicate the string
1336   virtual void deduplicate_string(oop str);
1337 
1338   // Perform any cleanup actions necessary before allowing a verification.
1339   virtual void prepare_for_verify();
1340 
1341   // Perform verification.
1342 
1343   // vo == UsePrevMarking -&gt; use &quot;prev&quot; marking information,
1344   // vo == UseNextMarking -&gt; use &quot;next&quot; marking information
1345   // vo == UseFullMarking -&gt; use &quot;next&quot; marking bitmap but no TAMS
1346   //
1347   // NOTE: Only the &quot;prev&quot; marking information is guaranteed to be
1348   // consistent most of the time, so most calls to this should use
1349   // vo == UsePrevMarking.
1350   // Currently, there is only one case where this is called with
1351   // vo == UseNextMarking, which is to verify the &quot;next&quot; marking
1352   // information at the end of remark.
</pre>
<hr />
<pre>
1380   // Printing
1381 private:
1382   void print_heap_regions() const;
1383   void print_regions_on(outputStream* st) const;
1384 
1385 public:
1386   virtual void print_on(outputStream* st) const;
1387   virtual void print_extended_on(outputStream* st) const;
1388   virtual void print_on_error(outputStream* st) const;
1389 
1390   virtual void print_gc_threads_on(outputStream* st) const;
1391   virtual void gc_threads_do(ThreadClosure* tc) const;
1392 
1393   // Override
1394   void print_tracing_info() const;
1395 
1396   // The following two methods are helpful for debugging RSet issues.
1397   void print_cset_rsets() PRODUCT_RETURN;
1398   void print_all_rsets() PRODUCT_RETURN;
1399 



1400   size_t pending_card_num();
1401 };
1402 
1403 class G1ParEvacuateFollowersClosure : public VoidClosure {
1404 private:
1405   double _start_term;
1406   double _term_time;
1407   size_t _term_attempts;
1408 
1409   void start_term_time() { _term_attempts++; _start_term = os::elapsedTime(); }
<span class="line-modified">1410   void end_term_time() { _term_time += os::elapsedTime() - _start_term; }</span>
1411 protected:
1412   G1CollectedHeap*              _g1h;
1413   G1ParScanThreadState*         _par_scan_state;
1414   RefToScanQueueSet*            _queues;
<span class="line-modified">1415   ParallelTaskTerminator*       _terminator;</span>
1416   G1GCPhaseTimes::GCParPhases   _phase;
1417 
1418   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
1419   RefToScanQueueSet*      queues()         { return _queues; }
<span class="line-modified">1420   ParallelTaskTerminator* terminator()     { return _terminator; }</span>
1421 
1422 public:
1423   G1ParEvacuateFollowersClosure(G1CollectedHeap* g1h,
1424                                 G1ParScanThreadState* par_scan_state,
1425                                 RefToScanQueueSet* queues,
<span class="line-modified">1426                                 ParallelTaskTerminator* terminator,</span>
1427                                 G1GCPhaseTimes::GCParPhases phase)
1428     : _start_term(0.0), _term_time(0.0), _term_attempts(0),
1429       _g1h(g1h), _par_scan_state(par_scan_state),
1430       _queues(queues), _terminator(terminator), _phase(phase) {}
1431 
1432   void do_void();
1433 
1434   double term_time() const { return _term_time; }
1435   size_t term_attempts() const { return _term_attempts; }
1436 
1437 private:
1438   inline bool offer_termination();
1439 };
1440 
1441 #endif // SHARE_GC_G1_G1COLLECTEDHEAP_HPP
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  26 #define SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  27 
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1BiasedArray.hpp&quot;
  30 #include &quot;gc/g1/g1CardTable.hpp&quot;
  31 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  32 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  33 #include &quot;gc/g1/g1ConcurrentMark.hpp&quot;

  34 #include &quot;gc/g1/g1EdenRegions.hpp&quot;
  35 #include &quot;gc/g1/g1EvacFailure.hpp&quot;
  36 #include &quot;gc/g1/g1EvacStats.hpp&quot;
  37 #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;
  38 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  39 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  40 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  41 #include &quot;gc/g1/g1HRPrinter.hpp&quot;
<span class="line-modified">  42 #include &quot;gc/g1/g1HeapRegionAttr.hpp&quot;</span>
  43 #include &quot;gc/g1/g1MonitoringSupport.hpp&quot;
<span class="line-added">  44 #include &quot;gc/g1/g1NUMA.hpp&quot;</span>
<span class="line-added">  45 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;</span>
  46 #include &quot;gc/g1/g1SurvivorRegions.hpp&quot;
  47 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  48 #include &quot;gc/g1/heapRegionManager.hpp&quot;
  49 #include &quot;gc/g1/heapRegionSet.hpp&quot;
  50 #include &quot;gc/g1/heterogeneousHeapRegionManager.hpp&quot;
  51 #include &quot;gc/shared/barrierSet.hpp&quot;
  52 #include &quot;gc/shared/collectedHeap.hpp&quot;
  53 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  54 #include &quot;gc/shared/plab.hpp&quot;
  55 #include &quot;gc/shared/preservedMarks.hpp&quot;
  56 #include &quot;gc/shared/softRefPolicy.hpp&quot;
  57 #include &quot;memory/memRegion.hpp&quot;
  58 #include &quot;utilities/stack.hpp&quot;
  59 
  60 // A &quot;G1CollectedHeap&quot; is an implementation of a java heap for HotSpot.
  61 // It uses the &quot;Garbage First&quot; heap organization and algorithm, which
  62 // may combine concurrent marking with parallel, incremental compaction of
  63 // heap subsets that will yield large amounts of garbage.
  64 
  65 // Forward declarations
  66 class HeapRegion;
  67 class GenerationSpec;
  68 class G1ParScanThreadState;
  69 class G1ParScanThreadStateSet;
  70 class G1ParScanThreadState;
  71 class MemoryPool;
  72 class MemoryManager;
  73 class ObjectClosure;
  74 class SpaceClosure;
  75 class CompactibleSpaceClosure;
  76 class Space;
<span class="line-added">  77 class G1CardTableEntryClosure;</span>
  78 class G1CollectionSet;

  79 class G1Policy;
  80 class G1HotCardCache;
  81 class G1RemSet;
  82 class G1YoungRemSetSamplingThread;

  83 class G1ConcurrentMark;
  84 class G1ConcurrentMarkThread;
  85 class G1ConcurrentRefine;
  86 class GenerationCounters;
  87 class STWGCTimer;
  88 class G1NewTracer;
  89 class EvacuationFailedInfo;
  90 class nmethod;
  91 class WorkGang;
  92 class G1Allocator;
  93 class G1ArchiveAllocator;
  94 class G1FullGCScope;
  95 class G1HeapVerifier;
  96 class G1HeapSizingPolicy;
  97 class G1HeapSummary;
  98 class G1EvacSummary;
  99 
 100 typedef OverflowTaskQueue&lt;StarTask, mtGC&gt;         RefToScanQueue;
 101 typedef GenericTaskQueueSet&lt;RefToScanQueue, mtGC&gt; RefToScanQueueSet;
 102 
</pre>
<hr />
<pre>
 113 public:
 114   G1STWIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 115   bool do_object_b(oop p);
 116 };
 117 
 118 class G1STWSubjectToDiscoveryClosure : public BoolObjectClosure {
 119   G1CollectedHeap* _g1h;
 120 public:
 121   G1STWSubjectToDiscoveryClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 122   bool do_object_b(oop p);
 123 };
 124 
 125 class G1RegionMappingChangedListener : public G1MappingChangedListener {
 126  private:
 127   void reset_from_card_cache(uint start_idx, size_t num_regions);
 128  public:
 129   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 130 };
 131 
 132 class G1CollectedHeap : public CollectedHeap {

 133   friend class VM_CollectForMetadataAllocation;
 134   friend class VM_G1CollectForAllocation;
 135   friend class VM_G1CollectFull;
<span class="line-added"> 136   friend class VM_G1TryInitiateConcMark;</span>
 137   friend class VMStructs;
 138   friend class MutatorAllocRegion;
 139   friend class G1FullCollector;
 140   friend class G1GCAllocRegion;
 141   friend class G1HeapVerifier;
 142 
 143   // Closures used in implementation.
 144   friend class G1ParScanThreadState;
 145   friend class G1ParScanThreadStateSet;
<span class="line-modified"> 146   friend class G1EvacuateRegionsTask;</span>
 147   friend class G1PLABAllocator;

 148 
 149   // Other related classes.
 150   friend class HeapRegionClaimer;
 151 
 152   // Testing classes.
<span class="line-modified"> 153   friend class G1CheckRegionAttrTableClosure;</span>
 154 
 155 private:
 156   G1YoungRemSetSamplingThread* _young_gen_sampling_thread;
 157 
 158   WorkGang* _workers;

 159   G1CardTable* _card_table;
 160 
 161   SoftRefPolicy      _soft_ref_policy;
 162 
 163   static size_t _humongous_object_threshold_in_words;
 164 
 165   // These sets keep track of old, archive and humongous regions respectively.
 166   HeapRegionSet _old_set;
 167   HeapRegionSet _archive_set;
 168   HeapRegionSet _humongous_set;
 169 
 170   void eagerly_reclaim_humongous_regions();
 171   // Start a new incremental collection set for the next pause.
 172   void start_new_collection_set();
 173 
 174   // The block offset table for the G1 heap.
 175   G1BlockOffsetTable* _bot;
 176 
 177   // Tears down the region sets / lists so that they are empty and the
 178   // regions on the heap do not belong to a region set / list. The
 179   // only exception is the humongous set which we leave unaltered. If
 180   // free_list_only is true, it will only tear down the master free
 181   // list. It is called before a Full GC (free_list_only == false) or
 182   // before heap shrinking (free_list_only == true).
 183   void tear_down_region_sets(bool free_list_only);
 184 
 185   // Rebuilds the region sets / lists so that they are repopulated to
 186   // reflect the contents of the heap. The only exception is the
 187   // humongous set which was not torn down in the first place. If
 188   // free_list_only is true, it will only rebuild the master free
 189   // list. It is called after a Full GC (free_list_only == false) or
 190   // after heap shrinking (free_list_only == true).
 191   void rebuild_region_sets(bool free_list_only);
 192 
 193   // Callback for region mapping changed events.
 194   G1RegionMappingChangedListener _listener;
 195 
<span class="line-added"> 196   // Handle G1 NUMA support.</span>
<span class="line-added"> 197   G1NUMA* _numa;</span>
<span class="line-added"> 198 </span>
 199   // The sequence of all heap regions in the heap.
 200   HeapRegionManager* _hrm;
 201 
 202   // Manages all allocations with regions except humongous object allocations.
 203   G1Allocator* _allocator;
 204 
 205   // Manages all heap verification.
 206   G1HeapVerifier* _verifier;
 207 
 208   // Outside of GC pauses, the number of bytes used in all regions other
 209   // than the current allocation region(s).
<span class="line-modified"> 210   volatile size_t _summary_bytes_used;</span>
 211 
 212   void increase_used(size_t bytes);
 213   void decrease_used(size_t bytes);
 214 
 215   void set_used(size_t bytes);
 216 
<span class="line-added"> 217   // Number of bytes used in all regions during GC. Typically changed when</span>
<span class="line-added"> 218   // retiring a GC alloc region.</span>
<span class="line-added"> 219   size_t _bytes_used_during_gc;</span>
<span class="line-added"> 220 </span>
 221   // Class that handles archive allocation ranges.
 222   G1ArchiveAllocator* _archive_allocator;
 223 
 224   // GC allocation statistics policy for survivors.
 225   G1EvacStats _survivor_evac_stats;
 226 
 227   // GC allocation statistics policy for tenured objects.
 228   G1EvacStats _old_evac_stats;
 229 
 230   // It specifies whether we should attempt to expand the heap after a
 231   // region allocation failure. If heap expansion fails we set this to
 232   // false so that we don&#39;t re-attempt the heap expansion (it&#39;s likely
 233   // that subsequent expansion attempts will also fail if one fails).
 234   // Currently, it is only consulted during GC and it&#39;s reset at the
 235   // start of each GC.
 236   bool _expand_heap_after_alloc_failure;
 237 
 238   // Helper for monitoring and management support.
 239   G1MonitoringSupport* _g1mm;
 240 
</pre>
<hr />
<pre>
 247   class HumongousReclaimCandidates : public G1BiasedMappedArray&lt;bool&gt; {
 248    protected:
 249     bool default_value() const { return false; }
 250    public:
 251     void clear() { G1BiasedMappedArray&lt;bool&gt;::clear(); }
 252     void set_candidate(uint region, bool value) {
 253       set_by_index(region, value);
 254     }
 255     bool is_candidate(uint region) {
 256       return get_by_index(region);
 257     }
 258   };
 259 
 260   HumongousReclaimCandidates _humongous_reclaim_candidates;
 261   // Stores whether during humongous object registration we found candidate regions.
 262   // If not, we can skip a few steps.
 263   bool _has_humongous_reclaim_candidates;
 264 
 265   G1HRPrinter _hr_printer;
 266 
<span class="line-modified"> 267   // Return true if an explicit GC should start a concurrent cycle instead</span>
<span class="line-modified"> 268   // of doing a STW full GC. A concurrent cycle should be started if:</span>
<span class="line-modified"> 269   // (a) cause == _g1_humongous_allocation,</span>
<span class="line-modified"> 270   // (b) cause == _java_lang_system_gc and +ExplicitGCInvokesConcurrent,</span>
<span class="line-modified"> 271   // (c) cause == _dcmd_gc_run and +ExplicitGCInvokesConcurrent,</span>
<span class="line-modified"> 272   // (d) cause == _wb_conc_mark,</span>
<span class="line-modified"> 273   // (e) cause == _g1_periodic_collection and +G1PeriodicGCInvokesConcurrent.</span>

 274   bool should_do_concurrent_full_gc(GCCause::Cause cause);
 275 
<span class="line-added"> 276   // Attempt to start a concurrent cycle with the indicated cause.</span>
<span class="line-added"> 277   // precondition: should_do_concurrent_full_gc(cause)</span>
<span class="line-added"> 278   bool try_collect_concurrently(GCCause::Cause cause,</span>
<span class="line-added"> 279                                 uint gc_counter,</span>
<span class="line-added"> 280                                 uint old_marking_started_before);</span>
<span class="line-added"> 281 </span>
 282   // Return true if should upgrade to full gc after an incremental one.
 283   bool should_upgrade_to_full_gc(GCCause::Cause cause);
 284 
 285   // indicates whether we are in young or mixed GC mode
 286   G1CollectorState _collector_state;
 287 
 288   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 289   // concurrent cycles) we have started.
 290   volatile uint _old_marking_cycles_started;
 291 
 292   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 293   // concurrent cycles) we have completed.
 294   volatile uint _old_marking_cycles_completed;
 295 
 296   // This is a non-product method that is helpful for testing. It is
 297   // called at the end of a GC and artificially expands the heap by
 298   // allocating a number of dead regions. This way we can induce very
 299   // frequent marking cycles and stress the cleanup / concurrent
 300   // cleanup code more (as all the regions that will be allocated by
 301   // this method will be found dead by the marking cycle).
</pre>
<hr />
<pre>
 350   do {                                                                        \
 351     assert(!Heap_lock-&gt;owned_by_self(),                                       \
 352         heap_locking_asserts_params(&quot;should not be holding the Heap_lock&quot;));  \
 353   } while (0)
 354 
 355 #define assert_heap_not_locked_and_not_at_safepoint()                         \
 356   do {                                                                        \
 357     assert(!Heap_lock-&gt;owned_by_self() &amp;&amp;                                     \
 358                                     !SafepointSynchronize::is_at_safepoint(), \
 359       heap_locking_asserts_params(&quot;should not be holding the Heap_lock and &quot;  \
 360                                    &quot;should not be at a safepoint&quot;));          \
 361   } while (0)
 362 
 363 #define assert_at_safepoint_on_vm_thread()                                    \
 364   do {                                                                        \
 365     assert_at_safepoint();                                                    \
 366     assert(Thread::current_or_null() != NULL, &quot;no current thread&quot;);           \
 367     assert(Thread::current()-&gt;is_VM_thread(), &quot;current thread is not VM thread&quot;); \
 368   } while (0)
 369 
<span class="line-added"> 370 #ifdef ASSERT</span>
<span class="line-added"> 371 #define assert_used_and_recalculate_used_equal(g1h)                           \</span>
<span class="line-added"> 372   do {                                                                        \</span>
<span class="line-added"> 373     size_t cur_used_bytes = g1h-&gt;used();                                      \</span>
<span class="line-added"> 374     size_t recal_used_bytes = g1h-&gt;recalculate_used();                        \</span>
<span class="line-added"> 375     assert(cur_used_bytes == recal_used_bytes, &quot;Used(&quot; SIZE_FORMAT &quot;) is not&quot; \</span>
<span class="line-added"> 376            &quot; same as recalculated used(&quot; SIZE_FORMAT &quot;).&quot;,                    \</span>
<span class="line-added"> 377            cur_used_bytes, recal_used_bytes);                                 \</span>
<span class="line-added"> 378   } while (0)</span>
<span class="line-added"> 379 #else</span>
<span class="line-added"> 380 #define assert_used_and_recalculate_used_equal(g1h) do {} while(0)</span>
<span class="line-added"> 381 #endif</span>
<span class="line-added"> 382 </span>
<span class="line-added"> 383   const char* young_gc_name() const;</span>
<span class="line-added"> 384 </span>
 385   // The young region list.
 386   G1EdenRegions _eden;
 387   G1SurvivorRegions _survivor;
 388 
 389   STWGCTimer* _gc_timer_stw;
 390 
 391   G1NewTracer* _gc_tracer_stw;
 392 
 393   // The current policy object for the collector.
 394   G1Policy* _policy;
 395   G1HeapSizingPolicy* _heap_sizing_policy;
 396 
 397   G1CollectionSet _collection_set;
 398 
 399   // Try to allocate a single non-humongous HeapRegion sufficient for
 400   // an allocation of the given word_size. If do_expand is true,
 401   // attempt to expand the heap if necessary to satisfy the allocation
 402   // request. &#39;type&#39; takes the type of region to be allocated. (Use constants
 403   // Old, Eden, Humongous, Survivor defined in HeapRegionType.)
<span class="line-modified"> 404   HeapRegion* new_region(size_t word_size,</span>
<span class="line-added"> 405                          HeapRegionType type,</span>
<span class="line-added"> 406                          bool do_expand,</span>
<span class="line-added"> 407                          uint node_index = G1NUMA::AnyNodeIndex);</span>
 408 
 409   // Initialize a contiguous set of free regions of length num_regions
 410   // and starting at index first so that they appear as a single
 411   // humongous region.
 412   HeapWord* humongous_obj_allocate_initialize_regions(uint first,
 413                                                       uint num_regions,
 414                                                       size_t word_size);
 415 
 416   // Attempt to allocate a humongous object of the given size. Return
 417   // NULL if unsuccessful.
 418   HeapWord* humongous_obj_allocate(size_t word_size);
 419 
 420   // The following two methods, allocate_new_tlab() and
 421   // mem_allocate(), are the two main entry points from the runtime
 422   // into the G1&#39;s allocation routines. They have the following
 423   // assumptions:
 424   //
 425   // * They should both be called outside safepoints.
 426   //
 427   // * They should both be called without holding the Heap_lock.
</pre>
<hr />
<pre>
 462 
 463   // Second-level mutator allocation attempt: take the Heap_lock and
 464   // retry the allocation attempt, potentially scheduling a GC
 465   // pause. This should only be used for non-humongous allocations.
 466   HeapWord* attempt_allocation_slow(size_t word_size);
 467 
 468   // Takes the Heap_lock and attempts a humongous allocation. It can
 469   // potentially schedule a GC pause.
 470   HeapWord* attempt_allocation_humongous(size_t word_size);
 471 
 472   // Allocation attempt that should be called during safepoints (e.g.,
 473   // at the end of a successful GC). expect_null_mutator_alloc_region
 474   // specifies whether the mutator alloc region is expected to be NULL
 475   // or not.
 476   HeapWord* attempt_allocation_at_safepoint(size_t word_size,
 477                                             bool expect_null_mutator_alloc_region);
 478 
 479   // These methods are the &quot;callbacks&quot; from the G1AllocRegion class.
 480 
 481   // For mutator alloc regions.
<span class="line-modified"> 482   HeapRegion* new_mutator_alloc_region(size_t word_size, bool force, uint node_index);</span>
 483   void retire_mutator_alloc_region(HeapRegion* alloc_region,
 484                                    size_t allocated_bytes);
 485 
 486   // For GC alloc regions.
<span class="line-modified"> 487   bool has_more_regions(G1HeapRegionAttr dest);</span>
<span class="line-modified"> 488   HeapRegion* new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index);</span>
 489   void retire_gc_alloc_region(HeapRegion* alloc_region,
<span class="line-modified"> 490                               size_t allocated_bytes, G1HeapRegionAttr dest);</span>
 491 
 492   // - if explicit_gc is true, the GC is for a System.gc() etc,
 493   //   otherwise it&#39;s for a failed allocation.
 494   // - if clear_all_soft_refs is true, all soft references should be
 495   //   cleared during the GC.
 496   // - it returns false if it is unable to do the collection due to the
 497   //   GC locker being active, true otherwise.
 498   bool do_full_collection(bool explicit_gc,
 499                           bool clear_all_soft_refs);
 500 
 501   // Callback from VM_G1CollectFull operation, or collect_as_vm_thread.
 502   virtual void do_full_collection(bool clear_all_soft_refs);
 503 
 504   // Callback from VM_G1CollectForAllocation operation.
 505   // This function does everything necessary/possible to satisfy a
 506   // failed allocation request (including collection, expansion, etc.)
 507   HeapWord* satisfy_failed_allocation(size_t word_size,
 508                                       bool* succeeded);
 509   // Internal helpers used during full GC to split it up to
 510   // increase readability.
</pre>
<hr />
<pre>
 523                                              bool expect_null_mutator_alloc_region,
 524                                              bool* gc_succeeded);
 525 
 526   // Attempting to expand the heap sufficiently
 527   // to support an allocation of the given &quot;word_size&quot;.  If
 528   // successful, perform the allocation and return the address of the
 529   // allocated block, or else &quot;NULL&quot;.
 530   HeapWord* expand_and_allocate(size_t word_size);
 531 
 532   // Process any reference objects discovered.
 533   void process_discovered_references(G1ParScanThreadStateSet* per_thread_states);
 534 
 535   // If during an initial mark pause we may install a pending list head which is not
 536   // otherwise reachable ensure that it is marked in the bitmap for concurrent marking
 537   // to discover.
 538   void make_pending_list_reachable();
 539 
 540   // Merges the information gathered on a per-thread basis for all worker threads
 541   // during GC into global variables.
 542   void merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states);
<span class="line-added"> 543 </span>
<span class="line-added"> 544   void verify_numa_regions(const char* desc);</span>
<span class="line-added"> 545 </span>
 546 public:
 547   G1YoungRemSetSamplingThread* sampling_thread() const { return _young_gen_sampling_thread; }
 548 
 549   WorkGang* workers() const { return _workers; }
 550 
<span class="line-added"> 551   // Runs the given AbstractGangTask with the current active workers, returning the</span>
<span class="line-added"> 552   // total time taken.</span>
<span class="line-added"> 553   Tickspan run_task(AbstractGangTask* task);</span>
<span class="line-added"> 554 </span>
 555   G1Allocator* allocator() {
 556     return _allocator;
 557   }
 558 
 559   G1HeapVerifier* verifier() {
 560     return _verifier;
 561   }
 562 
 563   G1MonitoringSupport* g1mm() {
 564     assert(_g1mm != NULL, &quot;should have been initialized&quot;);
 565     return _g1mm;
 566   }
 567 
 568   void resize_heap_if_necessary();
 569 
<span class="line-added"> 570   G1NUMA* numa() const { return _numa; }</span>
<span class="line-added"> 571 </span>
 572   // Expand the garbage-first heap by at least the given size (in bytes!).
 573   // Returns true if the heap was expanded by the requested amount;
 574   // false otherwise.
 575   // (Rounds up to a HeapRegion boundary.)
 576   bool expand(size_t expand_bytes, WorkGang* pretouch_workers = NULL, double* expand_time_ms = NULL);
<span class="line-added"> 577   bool expand_single_region(uint node_index);</span>
 578 
 579   // Returns the PLAB statistics for a given destination.
<span class="line-modified"> 580   inline G1EvacStats* alloc_buffer_stats(G1HeapRegionAttr dest);</span>
 581 
 582   // Determines PLAB size for a given destination.
<span class="line-modified"> 583   inline size_t desired_plab_sz(G1HeapRegionAttr dest);</span>
 584 
 585   // Do anything common to GC&#39;s.
 586   void gc_prologue(bool full);
 587   void gc_epilogue(bool full);
 588 
 589   // Does the given region fulfill remembered set based eager reclaim candidate requirements?
 590   bool is_potential_eager_reclaim_candidate(HeapRegion* r) const;
 591 
 592   // Modify the reclaim candidate set and test for presence.
 593   // These are only valid for starts_humongous regions.
 594   inline void set_humongous_reclaim_candidate(uint region, bool value);
 595   inline bool is_humongous_reclaim_candidate(uint region);
<span class="line-added"> 596   inline void set_has_humongous_reclaim_candidate(bool value);</span>
 597 
 598   // Remove from the reclaim candidate set.  Also remove from the
 599   // collection set so that later encounters avoid the slow path.
 600   inline void set_humongous_is_live(oop obj);
 601 
 602   // Register the given region to be part of the collection set.
<span class="line-modified"> 603   inline void register_humongous_region_with_region_attr(uint index);</span>
<span class="line-modified"> 604 </span>


 605   // We register a region with the fast &quot;in collection set&quot; test. We
 606   // simply set to true the array slot corresponding to this region.
<span class="line-modified"> 607   void register_young_region_with_region_attr(HeapRegion* r) {</span>
<span class="line-modified"> 608     _region_attr.set_in_young(r-&gt;hrm_index());</span>






 609   }
<span class="line-modified"> 610   inline void register_region_with_region_attr(HeapRegion* r);</span>
<span class="line-modified"> 611   inline void register_old_region_with_region_attr(HeapRegion* r);</span>
<span class="line-added"> 612   inline void register_optional_region_with_region_attr(HeapRegion* r);</span>
<span class="line-added"> 613 </span>
<span class="line-added"> 614   void clear_region_attr(const HeapRegion* hr) {</span>
<span class="line-added"> 615     _region_attr.clear(hr);</span>
 616   }
 617 
<span class="line-modified"> 618   void clear_region_attr() {</span>
<span class="line-modified"> 619     _region_attr.clear();</span>
 620   }
 621 
<span class="line-added"> 622   // Verify that the G1RegionAttr remset tracking corresponds to actual remset tracking</span>
<span class="line-added"> 623   // for all regions.</span>
<span class="line-added"> 624   void verify_region_attr_remset_update() PRODUCT_RETURN;</span>
<span class="line-added"> 625 </span>
 626   bool is_user_requested_concurrent_full_gc(GCCause::Cause cause);
 627 
 628   // This is called at the start of either a concurrent cycle or a Full
 629   // GC to update the number of old marking cycles started.
 630   void increment_old_marking_cycles_started();
 631 
 632   // This is called at the end of either a concurrent cycle or a Full
 633   // GC to update the number of old marking cycles completed. Those two
 634   // can happen in a nested fashion, i.e., we start a concurrent
 635   // cycle, a Full GC happens half-way through it which ends first,
 636   // and then the cycle notices that a Full GC happened and ends
 637   // too. The concurrent parameter is a boolean to help us do a bit
 638   // tighter consistency checking in the method. If concurrent is
 639   // false, the caller is the inner caller in the nesting (i.e., the
 640   // Full GC). If concurrent is true, the caller is the outer caller
 641   // in this nesting (i.e., the concurrent cycle). Further nesting is
 642   // not currently supported. The end of this call also notifies
<span class="line-modified"> 643   // the G1OldGCCount_lock in case a Java thread is waiting for a full</span>
 644   // GC to happen (e.g., it called System.gc() with
 645   // +ExplicitGCInvokesConcurrent).
 646   void increment_old_marking_cycles_completed(bool concurrent);
 647 
 648   uint old_marking_cycles_completed() {
 649     return _old_marking_cycles_completed;
 650   }
 651 
 652   G1HRPrinter* hr_printer() { return &amp;_hr_printer; }
 653 
 654   // Allocates a new heap region instance.
 655   HeapRegion* new_heap_region(uint hrs_index, MemRegion mr);
 656 
 657   // Allocate the highest free region in the reserved heap. This will commit
 658   // regions as necessary.
 659   HeapRegion* alloc_highest_free_region();
 660 
<span class="line-modified"> 661   // Frees a region by resetting its metadata and adding it to the free list</span>
<span class="line-modified"> 662   // passed as a parameter (this is usually a local list which will be appended</span>
<span class="line-modified"> 663   // to the master free list later or NULL if free list management is handled</span>
<span class="line-modified"> 664   // in another way).</span>
<span class="line-modified"> 665   // Callers must ensure they are the only one calling free on the given region</span>
<span class="line-modified"> 666   // at the same time.</span>
<span class="line-modified"> 667   void free_region(HeapRegion* hr, FreeRegionList* free_list);</span>







 668 
 669   // It dirties the cards that cover the block so that the post
 670   // write barrier never queues anything when updating objects on this
 671   // block. It is assumed (and in fact we assert) that the block
 672   // belongs to a young region.
 673   inline void dirty_young_block(HeapWord* start, size_t word_size);
 674 
 675   // Frees a humongous region by collapsing it into individual regions
 676   // and calling free_region() for each of them. The freed regions
 677   // will be added to the free list that&#39;s passed as a parameter (this
 678   // is usually a local list which will be appended to the master free
 679   // list later).
 680   // The method assumes that only a single thread is ever calling
 681   // this for a particular region at once.
 682   void free_humongous_region(HeapRegion* hr,
 683                              FreeRegionList* free_list);
 684 
 685   // Facility for allocating in &#39;archive&#39; regions in high heap memory and
 686   // recording the allocated ranges. These should all be called from the
 687   // VM thread at safepoints, without the heap lock held. They can be used
</pre>
<hr />
<pre>
 706   // the containing regions as &#39;archive&#39;. For use at JVM init time, when the
 707   // caller may mmap archived heap data at the specified range(s).
 708   // Verify that the MemRegions specified in the argument array are within the
 709   // reserved heap.
 710   bool check_archive_addresses(MemRegion* range, size_t count);
 711 
 712   // Commit the appropriate G1 regions containing the specified MemRegions
 713   // and mark them as &#39;archive&#39; regions. The regions in the array must be
 714   // non-overlapping and in order of ascending address.
 715   bool alloc_archive_regions(MemRegion* range, size_t count, bool open);
 716 
 717   // Insert any required filler objects in the G1 regions around the specified
 718   // ranges to make the regions parseable. This must be called after
 719   // alloc_archive_regions, and after class loading has occurred.
 720   void fill_archive_regions(MemRegion* range, size_t count);
 721 
 722   // For each of the specified MemRegions, uncommit the containing G1 regions
 723   // which had been allocated by alloc_archive_regions. This should be called
 724   // rather than fill_archive_regions at JVM init time if the archive file
 725   // mapping failed, with the same non-overlapping and sorted MemRegion array.
<span class="line-modified"> 726   void dealloc_archive_regions(MemRegion* range, size_t count);</span>
 727 
 728   oop materialize_archived_object(oop obj);
 729 
 730 private:
 731 
 732   // Shrink the garbage-first heap by at most the given size (in bytes!).
 733   // (Rounds down to a HeapRegion boundary.)
 734   void shrink(size_t expand_bytes);
 735   void shrink_helper(size_t expand_bytes);
 736 
 737   #if TASKQUEUE_STATS
 738   static void print_taskqueue_stats_hdr(outputStream* const st);
 739   void print_taskqueue_stats() const;
 740   void reset_taskqueue_stats();
 741   #endif // TASKQUEUE_STATS
 742 
 743   // Schedule the VM operation that will do an evacuation pause to
 744   // satisfy an allocation request of word_size. *succeeded will
 745   // return whether the VM operation was successful (it did do an
 746   // evacuation pause) or not (another thread beat us to it or the GC
 747   // locker was active). Given that we should not be holding the
 748   // Heap_lock when we enter this method, we will pass the
 749   // gc_count_before (i.e., total_collections()) as a parameter since
 750   // it has to be read while holding the Heap_lock. Currently, both
 751   // methods that call do_collection_pause() release the Heap_lock
 752   // before the call, so it&#39;s easy to read gc_count_before just before.
 753   HeapWord* do_collection_pause(size_t         word_size,
 754                                 uint           gc_count_before,
 755                                 bool*          succeeded,
 756                                 GCCause::Cause gc_cause);
 757 
 758   void wait_for_root_region_scanning();
 759 
<span class="line-modified"> 760   // Perform an incremental collection at a safepoint, possibly</span>
<span class="line-modified"> 761   // followed by a by-policy upgrade to a full collection.  Returns</span>
<span class="line-modified"> 762   // false if unable to do the collection due to the GC locker being</span>
<span class="line-added"> 763   // active, true otherwise.</span>
<span class="line-added"> 764   // precondition: at safepoint on VM thread</span>
<span class="line-added"> 765   // precondition: !is_gc_active()</span>
 766   bool do_collection_pause_at_safepoint(double target_pause_time_ms);
 767 
<span class="line-modified"> 768   // Helper for do_collection_pause_at_safepoint, containing the guts</span>
<span class="line-modified"> 769   // of the incremental collection pause, executed by the vm thread.</span>
<span class="line-added"> 770   void do_collection_pause_at_safepoint_helper(double target_pause_time_ms);</span>
<span class="line-added"> 771 </span>
<span class="line-added"> 772   G1HeapVerifier::G1VerifyType young_collection_verify_type() const;</span>
<span class="line-added"> 773   void verify_before_young_collection(G1HeapVerifier::G1VerifyType type);</span>
<span class="line-added"> 774   void verify_after_young_collection(G1HeapVerifier::G1VerifyType type);</span>
<span class="line-added"> 775 </span>
<span class="line-added"> 776   void calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms);</span>
<span class="line-added"> 777 </span>
<span class="line-added"> 778   // Actually do the work of evacuating the parts of the collection set.</span>
<span class="line-added"> 779   void evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states);</span>
 780   void evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states);
<span class="line-modified"> 781 private:</span>
<span class="line-added"> 782   // Evacuate the next set of optional regions.</span>
<span class="line-added"> 783   void evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states);</span>
 784 
<span class="line-modified"> 785 public:</span>
<span class="line-modified"> 786   void pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* pss);</span>
<span class="line-added"> 787   void post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,</span>
<span class="line-added"> 788                                     G1RedirtyCardsQueueSet* rdcqs,</span>
<span class="line-added"> 789                                     G1ParScanThreadStateSet* pss);</span>
 790 
<span class="line-added"> 791   void expand_heap_after_young_collection();</span>
 792   // Update object copying statistics.
 793   void record_obj_copy_mem_stats();
 794 
 795   // The hot card cache for remembered set insertion optimization.
 796   G1HotCardCache* _hot_card_cache;
 797 
 798   // The g1 remembered set of the heap.
 799   G1RemSet* _rem_set;
 800 




 801   // After a collection pause, convert the regions in the collection set into free
 802   // regions.
 803   void free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words);
 804 
 805   // Abandon the current collection set without recording policy
 806   // statistics or updating free lists.
 807   void abandon_collection_set(G1CollectionSet* collection_set);
 808 
 809   // The concurrent marker (and the thread it runs in.)
 810   G1ConcurrentMark* _cm;
 811   G1ConcurrentMarkThread* _cm_thread;
 812 
 813   // The concurrent refiner.
 814   G1ConcurrentRefine* _cr;
 815 
 816   // The parallel task queues
 817   RefToScanQueueSet *_task_queues;
 818 
 819   // True iff a evacuation has failed in the current collection.
 820   bool _evacuation_failed;
 821 
 822   EvacuationFailedInfo* _evacuation_failed_info_array;
 823 
 824   // Failed evacuations cause some logical from-space objects to have
 825   // forwarding pointers to themselves.  Reset them.
<span class="line-modified"> 826   void remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs);</span>
 827 
 828   // Restore the objects in the regions in the collection set after an
 829   // evacuation failure.
<span class="line-modified"> 830   void restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs);</span>
 831 
 832   PreservedMarksSet _preserved_marks_set;
 833 
 834   // Preserve the mark of &quot;obj&quot;, if necessary, in preparation for its mark
 835   // word being overwritten with a self-forwarding-pointer.
<span class="line-modified"> 836   void preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m);</span>
 837 
 838 #ifndef PRODUCT
 839   // Support for forcing evacuation failures. Analogous to
 840   // PromotionFailureALot for the other collectors.
 841 
 842   // Records whether G1EvacuationFailureALot should be in effect
 843   // for the current GC
 844   bool _evacuation_failure_alot_for_current_gc;
 845 
 846   // Used to record the GC number for interval checking when
 847   // determining whether G1EvaucationFailureALot is in effect
 848   // for the current GC.
 849   size_t _evacuation_failure_alot_gc_number;
 850 
 851   // Count of the number of evacuations between failures.
 852   volatile size_t _evacuation_failure_alot_count;
 853 
 854   // Set whether G1EvacuationFailureALot should be in effect
 855   // for the current GC (based upon the type of GC and which
 856   // command line flags are set);
</pre>
<hr />
<pre>
 938   G1STWSubjectToDiscoveryClosure _is_subject_to_discovery_stw;
 939 
 940   // The (concurrent marking) reference processor...
 941   ReferenceProcessor* _ref_processor_cm;
 942 
 943   // Instance of the concurrent mark is_alive closure for embedding
 944   // into the Concurrent Marking reference processor as the
 945   // _is_alive_non_header field. Supplying a value for the
 946   // _is_alive_non_header field is optional but doing so prevents
 947   // unnecessary additions to the discovered lists during reference
 948   // discovery.
 949   G1CMIsAliveClosure _is_alive_closure_cm;
 950 
 951   G1CMSubjectToDiscoveryClosure _is_subject_to_discovery_cm;
 952 public:
 953 
 954   RefToScanQueue *task_queue(uint i) const;
 955 
 956   uint num_task_queues() const;
 957 
<span class="line-modified"> 958   // Create a G1CollectedHeap.</span>



 959   // Must call the initialize method afterwards.
 960   // May not return if something goes wrong.
<span class="line-modified"> 961   G1CollectedHeap();</span>
 962 
 963 private:
 964   jint initialize_concurrent_refinement();
 965   jint initialize_young_gen_sampling_thread();
 966 public:
 967   // Initialize the G1CollectedHeap to have the initial and
 968   // maximum sizes and remembered and barrier sets
 969   // specified by the policy object.
 970   jint initialize();
 971 
 972   virtual void stop();
 973   virtual void safepoint_synchronize_begin();
 974   virtual void safepoint_synchronize_end();
 975 



 976   // Does operations required after initialization has been done.
 977   void post_initialize();
 978 
 979   // Initialize weak reference processing.
 980   void ref_processing_init();
 981 
 982   virtual Name kind() const {
 983     return CollectedHeap::G1;
 984   }
 985 
 986   virtual const char* name() const {
 987     return &quot;G1&quot;;
 988   }
 989 
 990   const G1CollectorState* collector_state() const { return &amp;_collector_state; }
 991   G1CollectorState* collector_state() { return &amp;_collector_state; }
 992 
 993   // The current policy object for the collector.
 994   G1Policy* policy() const { return _policy; }
 995   // The remembered set.
 996   G1RemSet* rem_set() const { return _rem_set; }
 997 
 998   inline G1GCPhaseTimes* phase_times() const;
 999 
1000   HeapRegionManager* hrm() const { return _hrm; }
1001 
1002   const G1CollectionSet* collection_set() const { return &amp;_collection_set; }
1003   G1CollectionSet* collection_set() { return &amp;_collection_set; }
1004 


1005   virtual SoftRefPolicy* soft_ref_policy();
1006 
1007   virtual void initialize_serviceability();
1008   virtual MemoryUsage memory_usage();
1009   virtual GrowableArray&lt;GCMemoryManager*&gt; memory_managers();
1010   virtual GrowableArray&lt;MemoryPool*&gt; memory_pools();
1011 
1012   // Try to minimize the remembered set.
1013   void scrub_rem_set();
1014 
1015   // Apply the given closure on all cards in the Hot Card Cache, emptying it.
<span class="line-modified">1016   void iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id);</span>



1017 
1018   // The shared block offset table array.
1019   G1BlockOffsetTable* bot() const { return _bot; }
1020 
1021   // Reference Processing accessors
1022 
1023   // The STW reference processor....
1024   ReferenceProcessor* ref_processor_stw() const { return _ref_processor_stw; }
1025 
1026   G1NewTracer* gc_tracer_stw() const { return _gc_tracer_stw; }
1027 
1028   // The Concurrent Marking reference processor...
1029   ReferenceProcessor* ref_processor_cm() const { return _ref_processor_cm; }
1030 
1031   size_t unused_committed_regions_in_bytes() const;
<span class="line-added">1032 </span>
1033   virtual size_t capacity() const;
1034   virtual size_t used() const;
1035   // This should be called when we&#39;re not holding the heap lock. The
1036   // result might be a bit inaccurate.
1037   size_t used_unlocked() const;
1038   size_t recalculate_used() const;
1039 
1040   // These virtual functions do the actual allocation.
1041   // Some heaps may offer a contiguous region for shared non-blocking
1042   // allocation, via inlined code (by exporting the address of the top and
1043   // end fields defining the extent of the contiguous allocation region.)
1044   // But G1CollectedHeap doesn&#39;t yet support this.
1045 
1046   virtual bool is_maximal_no_gc() const {
1047     return _hrm-&gt;available() == 0;
1048   }
1049 
1050   // Returns whether there are any regions left in the heap for allocation.
1051   bool has_regions_left_for_allocation() const {
1052     return !is_maximal_no_gc() || num_free_regions() != 0;
</pre>
<hr />
<pre>
1081 #endif // ASSERT
1082 
1083   inline void old_set_add(HeapRegion* hr);
1084   inline void old_set_remove(HeapRegion* hr);
1085 
1086   inline void archive_set_add(HeapRegion* hr);
1087 
1088   size_t non_young_capacity_bytes() {
1089     return (old_regions_count() + _archive_set.length() + humongous_regions_count()) * HeapRegion::GrainBytes;
1090   }
1091 
1092   // Determine whether the given region is one that we are using as an
1093   // old GC alloc region.
1094   bool is_old_gc_alloc_region(HeapRegion* hr);
1095 
1096   // Perform a collection of the heap; intended for use in implementing
1097   // &quot;System.gc&quot;.  This probably implies as full a collection as the
1098   // &quot;CollectedHeap&quot; supports.
1099   virtual void collect(GCCause::Cause cause);
1100 
<span class="line-modified">1101   // Perform a collection of the heap with the given cause.</span>

1102   // Returns whether this collection actually executed.
<span class="line-modified">1103   bool try_collect(GCCause::Cause cause);</span>
1104 
1105   // True iff an evacuation has failed in the most-recent collection.
1106   bool evacuation_failed() { return _evacuation_failed; }
1107 
1108   void remove_from_old_sets(const uint old_regions_removed, const uint humongous_regions_removed);
1109   void prepend_to_freelist(FreeRegionList* list);
1110   void decrement_summary_bytes(size_t bytes);
1111 
1112   virtual bool is_in(const void* p) const;
1113 #ifdef ASSERT
1114   // Returns whether p is in one of the available areas of the heap. Slow but
1115   // extensive version.
1116   bool is_in_exact(const void* p) const;
1117 #endif
1118 
1119   // Return &quot;TRUE&quot; iff the given object address is within the collection
1120   // set. Assumes that the reference points into the heap.
1121   inline bool is_in_cset(const HeapRegion *hr);
1122   inline bool is_in_cset(oop obj);
1123   inline bool is_in_cset(HeapWord* addr);
1124 
1125   inline bool is_in_cset_or_humongous(const oop obj);
1126 
1127  private:
1128   // This array is used for a quick test on whether a reference points into
1129   // the collection set or not. Each of the array&#39;s elements denotes whether the
1130   // corresponding region is in the collection set or not.
<span class="line-modified">1131   G1HeapRegionAttrBiasedMappedArray _region_attr;</span>
1132 
1133  public:
1134 
<span class="line-modified">1135   inline G1HeapRegionAttr region_attr(const void* obj) const;</span>
<span class="line-added">1136   inline G1HeapRegionAttr region_attr(uint idx) const;</span>
1137 
1138   // Return &quot;TRUE&quot; iff the given object address is in the reserved
1139   // region of g1.
1140   bool is_in_g1_reserved(const void* p) const {
1141     return _hrm-&gt;reserved().contains(p);
1142   }
1143 
1144   // Returns a MemRegion that corresponds to the space that has been
1145   // reserved for the heap
1146   MemRegion g1_reserved() const {
1147     return _hrm-&gt;reserved();
1148   }
1149 
<span class="line-modified">1150   MemRegion reserved_region() const {</span>
<span class="line-added">1151     return _reserved;</span>
<span class="line-added">1152   }</span>
<span class="line-added">1153 </span>
<span class="line-added">1154   HeapWord* base() const {</span>
<span class="line-added">1155     return _reserved.start();</span>
<span class="line-added">1156   }</span>
<span class="line-added">1157 </span>
<span class="line-added">1158   bool is_in_reserved(const void* addr) const {</span>
<span class="line-added">1159     return _reserved.contains(addr);</span>
<span class="line-added">1160   }</span>
1161 
<span class="line-modified">1162   G1HotCardCache* hot_card_cache() const { return _hot_card_cache; }</span>
1163 
1164   G1CardTable* card_table() const {
1165     return _card_table;
1166   }
1167 
1168   // Iteration functions.
1169 
1170   // Iterate over all objects, calling &quot;cl.do_object&quot; on each.
1171   virtual void object_iterate(ObjectClosure* cl);
1172 
<span class="line-modified">1173   // Keep alive an object that was loaded with AS_NO_KEEPALIVE.</span>
<span class="line-modified">1174   virtual void keep_alive(oop obj);</span>

1175 
1176   // Iterate over heap regions, in address order, terminating the
1177   // iteration early if the &quot;do_heap_region&quot; method returns &quot;true&quot;.
1178   void heap_region_iterate(HeapRegionClosure* blk) const;
1179 
1180   // Return the region with the given index. It assumes the index is valid.
1181   inline HeapRegion* region_at(uint index) const;
1182   inline HeapRegion* region_at_or_null(uint index) const;
1183 
1184   // Return the next region (by index) that is part of the same
1185   // humongous object that hr is part of.
1186   inline HeapRegion* next_region_in_humongous(HeapRegion* hr) const;
1187 
1188   // Calculate the region index of the given address. Given address must be
1189   // within the heap.
1190   inline uint addr_to_region(HeapWord* addr) const;
1191 
1192   inline HeapWord* bottom_addr_for_region(uint index) const;
1193 
1194   // Two functions to iterate over the heap regions in parallel. Threads
1195   // compete using the HeapRegionClaimer to claim the regions before
1196   // applying the closure on them.
1197   // The _from_worker_offset version uses the HeapRegionClaimer and
1198   // the worker id to calculate a start offset to prevent all workers to
1199   // start from the point.
1200   void heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
1201                                                   HeapRegionClaimer* hrclaimer,
1202                                                   uint worker_id) const;
1203 
1204   void heap_region_par_iterate_from_start(HeapRegionClosure* cl,
1205                                           HeapRegionClaimer* hrclaimer) const;
1206 
<span class="line-modified">1207   // Iterate over all regions in the collection set in parallel.</span>
<span class="line-modified">1208   void collection_set_par_iterate_all(HeapRegionClosure* cl,</span>
<span class="line-modified">1209                                       HeapRegionClaimer* hr_claimer,</span>
<span class="line-modified">1210                                       uint worker_id);</span>
<span class="line-modified">1211 </span>
<span class="line-modified">1212   // Iterate over all regions currently in the current collection set.</span>
<span class="line-modified">1213   void collection_set_iterate_all(HeapRegionClosure* blk);</span>
<span class="line-modified">1214 </span>
<span class="line-added">1215   // Iterate over the regions in the current increment of the collection set.</span>
<span class="line-added">1216   // Starts the iteration so that the start regions of a given worker id over the</span>
<span class="line-added">1217   // set active_workers are evenly spread across the set of collection set regions</span>
<span class="line-added">1218   // to be iterated.</span>
<span class="line-added">1219   // The variant with the HeapRegionClaimer guarantees that the closure will be</span>
<span class="line-added">1220   // applied to a particular region exactly once.</span>
<span class="line-added">1221   void collection_set_iterate_increment_from(HeapRegionClosure *blk, uint worker_id) {</span>
<span class="line-added">1222     collection_set_iterate_increment_from(blk, NULL, worker_id);</span>
<span class="line-added">1223   }</span>
<span class="line-added">1224   void collection_set_iterate_increment_from(HeapRegionClosure *blk, HeapRegionClaimer* hr_claimer, uint worker_id);</span>
1225 
1226   // Returns the HeapRegion that contains addr. addr must not be NULL.
1227   template &lt;class T&gt;
1228   inline HeapRegion* heap_region_containing(const T addr) const;
1229 
1230   // Returns the HeapRegion that contains addr, or NULL if that is an uncommitted
1231   // region. addr must not be NULL.
1232   template &lt;class T&gt;
1233   inline HeapRegion* heap_region_containing_or_null(const T addr) const;
1234 
1235   // A CollectedHeap is divided into a dense sequence of &quot;blocks&quot;; that is,
1236   // each address in the (reserved) heap is a member of exactly
1237   // one block.  The defining characteristic of a block is that it is
1238   // possible to find its size, and thus to progress forward to the next
1239   // block.  (Blocks may be of different sizes.)  Thus, blocks may
1240   // represent Java objects, or they might be free blocks in a
1241   // free-list-based heap (or subheap), as long as the two kinds are
1242   // distinguishable and the size of each is determinable.
1243 
1244   // Returns the address of the start of the &quot;block&quot; that contains the
1245   // address &quot;addr&quot;.  We say &quot;blocks&quot; instead of &quot;object&quot; since some heaps
1246   // may not pack objects densely; a chunk may either be an object or a
1247   // non-object.
<span class="line-modified">1248   HeapWord* block_start(const void* addr) const;</span>
1249 
1250   // Requires &quot;addr&quot; to be the start of a block, and returns &quot;TRUE&quot; iff
1251   // the block is an object.
<span class="line-modified">1252   bool block_is_obj(const HeapWord* addr) const;</span>
1253 
1254   // Section on thread-local allocation buffers (TLABs)
1255   // See CollectedHeap for semantics.
1256 
1257   bool supports_tlab_allocation() const;
1258   size_t tlab_capacity(Thread* ignored) const;
1259   size_t tlab_used(Thread* ignored) const;
1260   size_t max_tlab_size() const;
1261   size_t unsafe_max_tlab_alloc(Thread* ignored) const;
1262 
1263   inline bool is_in_young(const oop obj);
1264 
1265   // Returns &quot;true&quot; iff the given word_size is &quot;very large&quot;.
1266   static bool is_humongous(size_t word_size) {
1267     // Note this has to be strictly greater-than as the TLABs
1268     // are capped at the humongous threshold and we want to
1269     // ensure that we don&#39;t try to allocate a TLAB as
1270     // humongous and that we don&#39;t allocate a humongous
1271     // object in a TLAB.
1272     return word_size &gt; _humongous_object_threshold_in_words;
</pre>
<hr />
<pre>
1283 
1284   // Print the maximum heap capacity.
1285   virtual size_t max_capacity() const;
1286 
1287   // Return the size of reserved memory. Returns different value than max_capacity() when AllocateOldGenAt is used.
1288   virtual size_t max_reserved_capacity() const;
1289 
1290   virtual jlong millis_since_last_gc();
1291 
1292 
1293   // Convenience function to be used in situations where the heap type can be
1294   // asserted to be this type.
1295   static G1CollectedHeap* heap();
1296 
1297   void set_region_short_lived_locked(HeapRegion* hr);
1298   // add appropriate methods for any other surv rate groups
1299 
1300   const G1SurvivorRegions* survivor() const { return &amp;_survivor; }
1301 
1302   uint eden_regions_count() const { return _eden.length(); }
<span class="line-added">1303   uint eden_regions_count(uint node_index) const { return _eden.regions_on_node(node_index); }</span>
1304   uint survivor_regions_count() const { return _survivor.length(); }
<span class="line-added">1305   uint survivor_regions_count(uint node_index) const { return _survivor.regions_on_node(node_index); }</span>
<span class="line-added">1306   size_t eden_regions_used_bytes() const { return _eden.used_bytes(); }</span>
<span class="line-added">1307   size_t survivor_regions_used_bytes() const { return _survivor.used_bytes(); }</span>
1308   uint young_regions_count() const { return _eden.length() + _survivor.length(); }
1309   uint old_regions_count() const { return _old_set.length(); }
1310   uint archive_regions_count() const { return _archive_set.length(); }
1311   uint humongous_regions_count() const { return _humongous_set.length(); }
1312 
1313 #ifdef ASSERT
1314   bool check_young_list_empty();
1315 #endif
1316 
1317   // *** Stuff related to concurrent marking.  It&#39;s not clear to me that so
1318   // many of these need to be public.
1319 
1320   // The functions below are helper functions that a subclass of
1321   // &quot;CollectedHeap&quot; can use in the implementation of its virtual
1322   // functions.
1323   // This performs a concurrent marking of the live objects in a
1324   // bitmap off to the side.
1325   void do_concurrent_mark();
1326 
1327   bool is_marked_next(oop obj) const;
</pre>
<hr />
<pre>
1356 
1357   inline bool is_obj_ill(const oop obj) const;
1358 
1359   inline bool is_obj_dead_full(const oop obj, const HeapRegion* hr) const;
1360   inline bool is_obj_dead_full(const oop obj) const;
1361 
1362   G1ConcurrentMark* concurrent_mark() const { return _cm; }
1363 
1364   // Refinement
1365 
1366   G1ConcurrentRefine* concurrent_refine() const { return _cr; }
1367 
1368   // Optimized nmethod scanning support routines
1369 
1370   // Register the given nmethod with the G1 heap.
1371   virtual void register_nmethod(nmethod* nm);
1372 
1373   // Unregister the given nmethod from the G1 heap.
1374   virtual void unregister_nmethod(nmethod* nm);
1375 
<span class="line-added">1376   // No nmethod flushing needed.</span>
<span class="line-added">1377   virtual void flush_nmethod(nmethod* nm) {}</span>
<span class="line-added">1378 </span>
<span class="line-added">1379   // No nmethod verification implemented.</span>
<span class="line-added">1380   virtual void verify_nmethod(nmethod* nm) {}</span>
<span class="line-added">1381 </span>
1382   // Free up superfluous code root memory.
1383   void purge_code_root_memory();
1384 
1385   // Rebuild the strong code root lists for each region
1386   // after a full GC.
1387   void rebuild_strong_code_roots();
1388 
1389   // Partial cleaning of VM internal data structures.
1390   void string_dedup_cleaning(BoolObjectClosure* is_alive,
1391                              OopClosure* keep_alive,
1392                              G1GCPhaseTimes* phase_times = NULL);
1393 
1394   // Performs cleaning of data structures after class unloading.
1395   void complete_cleaning(BoolObjectClosure* is_alive, bool class_unloading_occurred);
1396 
1397   // Redirty logged cards in the refinement queue.
<span class="line-modified">1398   void redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs);</span>
<span class="line-added">1399 </span>
1400   // Verification
1401 
1402   // Deduplicate the string
1403   virtual void deduplicate_string(oop str);
1404 
1405   // Perform any cleanup actions necessary before allowing a verification.
1406   virtual void prepare_for_verify();
1407 
1408   // Perform verification.
1409 
1410   // vo == UsePrevMarking -&gt; use &quot;prev&quot; marking information,
1411   // vo == UseNextMarking -&gt; use &quot;next&quot; marking information
1412   // vo == UseFullMarking -&gt; use &quot;next&quot; marking bitmap but no TAMS
1413   //
1414   // NOTE: Only the &quot;prev&quot; marking information is guaranteed to be
1415   // consistent most of the time, so most calls to this should use
1416   // vo == UsePrevMarking.
1417   // Currently, there is only one case where this is called with
1418   // vo == UseNextMarking, which is to verify the &quot;next&quot; marking
1419   // information at the end of remark.
</pre>
<hr />
<pre>
1447   // Printing
1448 private:
1449   void print_heap_regions() const;
1450   void print_regions_on(outputStream* st) const;
1451 
1452 public:
1453   virtual void print_on(outputStream* st) const;
1454   virtual void print_extended_on(outputStream* st) const;
1455   virtual void print_on_error(outputStream* st) const;
1456 
1457   virtual void print_gc_threads_on(outputStream* st) const;
1458   virtual void gc_threads_do(ThreadClosure* tc) const;
1459 
1460   // Override
1461   void print_tracing_info() const;
1462 
1463   // The following two methods are helpful for debugging RSet issues.
1464   void print_cset_rsets() PRODUCT_RETURN;
1465   void print_all_rsets() PRODUCT_RETURN;
1466 
<span class="line-added">1467   // Used to print information about locations in the hs_err file.</span>
<span class="line-added">1468   virtual bool print_location(outputStream* st, void* addr) const;</span>
<span class="line-added">1469 </span>
1470   size_t pending_card_num();
1471 };
1472 
1473 class G1ParEvacuateFollowersClosure : public VoidClosure {
1474 private:
1475   double _start_term;
1476   double _term_time;
1477   size_t _term_attempts;
1478 
1479   void start_term_time() { _term_attempts++; _start_term = os::elapsedTime(); }
<span class="line-modified">1480   void end_term_time() { _term_time += (os::elapsedTime() - _start_term); }</span>
1481 protected:
1482   G1CollectedHeap*              _g1h;
1483   G1ParScanThreadState*         _par_scan_state;
1484   RefToScanQueueSet*            _queues;
<span class="line-modified">1485   TaskTerminator*               _terminator;</span>
1486   G1GCPhaseTimes::GCParPhases   _phase;
1487 
1488   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
1489   RefToScanQueueSet*      queues()         { return _queues; }
<span class="line-modified">1490   TaskTerminator*         terminator()     { return _terminator; }</span>
1491 
1492 public:
1493   G1ParEvacuateFollowersClosure(G1CollectedHeap* g1h,
1494                                 G1ParScanThreadState* par_scan_state,
1495                                 RefToScanQueueSet* queues,
<span class="line-modified">1496                                 TaskTerminator* terminator,</span>
1497                                 G1GCPhaseTimes::GCParPhases phase)
1498     : _start_term(0.0), _term_time(0.0), _term_attempts(0),
1499       _g1h(g1h), _par_scan_state(par_scan_state),
1500       _queues(queues), _terminator(terminator), _phase(phase) {}
1501 
1502   void do_void();
1503 
1504   double term_time() const { return _term_time; }
1505   size_t term_attempts() const { return _term_attempts; }
1506 
1507 private:
1508   inline bool offer_termination();
1509 };
1510 
1511 #endif // SHARE_GC_G1_G1COLLECTEDHEAP_HPP
</pre>
</td>
</tr>
</table>
<center><a href="g1CollectedHeap.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1CollectedHeap.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>