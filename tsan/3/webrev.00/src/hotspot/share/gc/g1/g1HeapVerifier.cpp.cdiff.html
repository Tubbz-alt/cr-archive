<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/g1/g1HeapVerifier.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1HeapTransition.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1HeapVerifier.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1HeapVerifier.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 36,10 ***</span>
<span class="line-new-header">--- 36,11 ---</span>
  #include &quot;gc/g1/g1StringDedup.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;memory/iterator.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="line-added">+ #include &quot;memory/universe.hpp&quot;</span>
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/compressedOops.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 369,10 ***</span>
<span class="line-new-header">--- 370,11 ---</span>
    bool failures() {
      return _failures;
    }
  
    bool do_heap_region(HeapRegion* r) {
<span class="line-added">+     guarantee(!r-&gt;has_index_in_opt_cset(), &quot;Region %u still has opt collection set index %u&quot;, r-&gt;hrm_index(), r-&gt;index_in_opt_cset());</span>
      guarantee(!r-&gt;is_young() || r-&gt;rem_set()-&gt;is_complete(), &quot;Remembered set for Young region %u must be complete, is %s&quot;, r-&gt;hrm_index(), r-&gt;rem_set()-&gt;get_state_str());
      // Humongous and old regions regions might be of any state, so can&#39;t check here.
      guarantee(!r-&gt;is_free() || !r-&gt;rem_set()-&gt;is_tracked(), &quot;Remembered set for free region %u must be untracked, is %s&quot;, r-&gt;hrm_index(), r-&gt;rem_set()-&gt;get_state_str());
      // Verify that the continues humongous regions&#39; remembered set state matches the
      // one from the starts humongous region.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 778,62 ***</span>
    G1VerifyBitmapClosure cl(caller, this);
    _g1h-&gt;heap_region_iterate(&amp;cl);
    guarantee(!cl.failures(), &quot;bitmap verification&quot;);
  }
  
<span class="line-modified">! class G1CheckCSetFastTableClosure : public HeapRegionClosure {</span>
<span class="line-modified">!  private:</span>
    bool _failures;
<span class="line-modified">!  public:</span>
<span class="line-modified">!   G1CheckCSetFastTableClosure() : HeapRegionClosure(), _failures(false) { }</span>
  
    virtual bool do_heap_region(HeapRegion* hr) {
      uint i = hr-&gt;hrm_index();
<span class="line-modified">!     InCSetState cset_state = (InCSetState) G1CollectedHeap::heap()-&gt;_in_cset_fast_test.get_by_index(i);</span>
      if (hr-&gt;is_humongous()) {
        if (hr-&gt;in_collection_set()) {
          log_error(gc, verify)(&quot;## humongous region %u in CSet&quot;, i);
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (cset_state.is_in_cset()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent cset state &quot; CSETSTATE_FORMAT &quot; for humongous region %u&quot;, cset_state.value(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (hr-&gt;is_continues_humongous() &amp;&amp; cset_state.is_humongous()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent cset state &quot; CSETSTATE_FORMAT &quot; for continues humongous region %u&quot;, cset_state.value(), i);</span>
          _failures = true;
          return true;
        }
      } else {
<span class="line-modified">!       if (cset_state.is_humongous()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent cset state &quot; CSETSTATE_FORMAT &quot; for non-humongous region %u&quot;, cset_state.value(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (hr-&gt;in_collection_set() != cset_state.is_in_cset()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## in CSet %d / cset state &quot; CSETSTATE_FORMAT &quot; inconsistency for region %u&quot;,</span>
<span class="line-modified">!                              hr-&gt;in_collection_set(), cset_state.value(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (cset_state.is_in_cset()) {</span>
          if (hr-&gt;is_archive()) {
            log_error(gc, verify)(&quot;## is_archive in collection set for region %u&quot;, i);
            _failures = true;
            return true;
          }
<span class="line-modified">!         if (hr-&gt;is_young() != (cset_state.is_young())) {</span>
<span class="line-modified">!           log_error(gc, verify)(&quot;## is_young %d / cset state &quot; CSETSTATE_FORMAT &quot; inconsistency for region %u&quot;,</span>
<span class="line-modified">!                                hr-&gt;is_young(), cset_state.value(), i);</span>
            _failures = true;
            return true;
          }
<span class="line-modified">!         if (hr-&gt;is_old() != (cset_state.is_old())) {</span>
<span class="line-modified">!           log_error(gc, verify)(&quot;## is_old %d / cset state &quot; CSETSTATE_FORMAT &quot; inconsistency for region %u&quot;,</span>
<span class="line-modified">!                                hr-&gt;is_old(), cset_state.value(), i);</span>
            _failures = true;
            return true;
          }
        }
      }
<span class="line-new-header">--- 780,63 ---</span>
    G1VerifyBitmapClosure cl(caller, this);
    _g1h-&gt;heap_region_iterate(&amp;cl);
    guarantee(!cl.failures(), &quot;bitmap verification&quot;);
  }
  
<span class="line-modified">! class G1CheckRegionAttrTableClosure : public HeapRegionClosure {</span>
<span class="line-modified">! private:</span>
    bool _failures;
<span class="line-modified">! </span>
<span class="line-modified">! public:</span>
<span class="line-added">+   G1CheckRegionAttrTableClosure() : HeapRegionClosure(), _failures(false) { }</span>
  
    virtual bool do_heap_region(HeapRegion* hr) {
      uint i = hr-&gt;hrm_index();
<span class="line-modified">!     G1HeapRegionAttr region_attr = (G1HeapRegionAttr) G1CollectedHeap::heap()-&gt;_region_attr.get_by_index(i);</span>
      if (hr-&gt;is_humongous()) {
        if (hr-&gt;in_collection_set()) {
          log_error(gc, verify)(&quot;## humongous region %u in CSet&quot;, i);
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (region_attr.is_in_cset()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent region attr type %s for humongous region %u&quot;, region_attr.get_type_str(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (hr-&gt;is_continues_humongous() &amp;&amp; region_attr.is_humongous()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent region attr type %s for continues humongous region %u&quot;, region_attr.get_type_str(), i);</span>
          _failures = true;
          return true;
        }
      } else {
<span class="line-modified">!       if (region_attr.is_humongous()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## inconsistent region attr type %s for non-humongous region %u&quot;, region_attr.get_type_str(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (hr-&gt;in_collection_set() != region_attr.is_in_cset()) {</span>
<span class="line-modified">!         log_error(gc, verify)(&quot;## in CSet %d / region attr type %s inconsistency for region %u&quot;,</span>
<span class="line-modified">!                              hr-&gt;in_collection_set(), region_attr.get_type_str(), i);</span>
          _failures = true;
          return true;
        }
<span class="line-modified">!       if (region_attr.is_in_cset()) {</span>
          if (hr-&gt;is_archive()) {
            log_error(gc, verify)(&quot;## is_archive in collection set for region %u&quot;, i);
            _failures = true;
            return true;
          }
<span class="line-modified">!         if (hr-&gt;is_young() != (region_attr.is_young())) {</span>
<span class="line-modified">!           log_error(gc, verify)(&quot;## is_young %d / region attr type %s inconsistency for region %u&quot;,</span>
<span class="line-modified">!                                hr-&gt;is_young(), region_attr.get_type_str(), i);</span>
            _failures = true;
            return true;
          }
<span class="line-modified">!         if (hr-&gt;is_old() != (region_attr.is_old())) {</span>
<span class="line-modified">!           log_error(gc, verify)(&quot;## is_old %d / region attr type %s inconsistency for region %u&quot;,</span>
<span class="line-modified">!                                hr-&gt;is_old(), region_attr.get_type_str(), i);</span>
            _failures = true;
            return true;
          }
        }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 841,11 ***</span>
    }
  
    bool failures() const { return _failures; }
  };
  
<span class="line-modified">! bool G1HeapVerifier::check_cset_fast_test() {</span>
<span class="line-modified">!   G1CheckCSetFastTableClosure cl;</span>
    _g1h-&gt;_hrm-&gt;iterate(&amp;cl);
    return !cl.failures();
  }
  #endif // PRODUCT
<span class="line-new-header">--- 844,11 ---</span>
    }
  
    bool failures() const { return _failures; }
  };
  
<span class="line-modified">! bool G1HeapVerifier::check_region_attr_table() {</span>
<span class="line-modified">!   G1CheckRegionAttrTableClosure cl;</span>
    _g1h-&gt;_hrm-&gt;iterate(&amp;cl);
    return !cl.failures();
  }
  #endif // PRODUCT
</pre>
<center><a href="g1HeapTransition.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1HeapVerifier.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>