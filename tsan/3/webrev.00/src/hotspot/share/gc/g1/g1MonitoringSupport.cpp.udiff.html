<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/g1MonitoringSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1MMUTracker.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1MonitoringSupport.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1MonitoringSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -201,11 +201,11 @@</span>
    _incremental_memory_manager.add_pool(_survivor_space_pool);
    _incremental_memory_manager.add_pool(_old_gen_pool, false /* always_affected_by_gc */);
  }
  
  MemoryUsage G1MonitoringSupport::memory_usage() {
<span class="udiff-line-modified-removed">-   MutexLockerEx x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
    return MemoryUsage(InitialHeapSize, _overall_used, _overall_committed, _g1h-&gt;max_capacity());
  }
  
  GrowableArray&lt;GCMemoryManager*&gt; G1MonitoringSupport::memory_managers() {
    GrowableArray&lt;GCMemoryManager*&gt; memory_managers(2);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,30 +223,32 @@</span>
  }
  
  void G1MonitoringSupport::recalculate_sizes() {
    assert_heap_locked_or_at_safepoint(true);
  
<span class="udiff-line-modified-removed">-   MutexLockerEx x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
    // Recalculate all the sizes from scratch.
  
<span class="udiff-line-modified-removed">-   uint young_list_length = _g1h-&gt;young_regions_count();</span>
<span class="udiff-line-modified-added">+   // This never includes used bytes of current allocating heap region.</span>
<span class="udiff-line-added">+   _overall_used = _g1h-&gt;used_unlocked();</span>
<span class="udiff-line-added">+   _eden_space_used = _g1h-&gt;eden_regions_used_bytes();</span>
<span class="udiff-line-added">+   _survivor_space_used = _g1h-&gt;survivor_regions_used_bytes();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // _overall_used and _eden_space_used are obtained concurrently so</span>
<span class="udiff-line-added">+   // may be inconsistent with each other. To prevent _old_gen_used going negative,</span>
<span class="udiff-line-added">+   // use smaller value to substract.</span>
<span class="udiff-line-added">+   _old_gen_used = _overall_used - MIN2(_overall_used, _eden_space_used + _survivor_space_used);</span>
<span class="udiff-line-added">+ </span>
    uint survivor_list_length = _g1h-&gt;survivor_regions_count();
<span class="udiff-line-removed">-   assert(young_list_length &gt;= survivor_list_length, &quot;invariant&quot;);</span>
<span class="udiff-line-removed">-   uint eden_list_length = young_list_length - survivor_list_length;</span>
    // Max length includes any potential extensions to the young gen
    // we&#39;ll do when the GC locker is active.
    uint young_list_max_length = _g1h-&gt;policy()-&gt;young_list_max_length();
    assert(young_list_max_length &gt;= survivor_list_length, &quot;invariant&quot;);
    uint eden_list_max_length = young_list_max_length - survivor_list_length;
  
<span class="udiff-line-removed">-   _overall_used = _g1h-&gt;used_unlocked();</span>
<span class="udiff-line-removed">-   _eden_space_used = (size_t) eden_list_length * HeapRegion::GrainBytes;</span>
<span class="udiff-line-removed">-   _survivor_space_used = (size_t) survivor_list_length * HeapRegion::GrainBytes;</span>
<span class="udiff-line-removed">-   _old_gen_used = subtract_up_to_zero(_overall_used, _eden_space_used + _survivor_space_used);</span>
<span class="udiff-line-removed">- </span>
    // First calculate the committed sizes that can be calculated independently.
<span class="udiff-line-modified-removed">-   _survivor_space_committed = _survivor_space_used;</span>
<span class="udiff-line-modified-added">+   _survivor_space_committed = survivor_list_length * HeapRegion::GrainBytes;</span>
    _old_gen_committed = HeapRegion::align_up_to_region_byte_size(_old_gen_used);
  
    // Next, start with the overall committed size.
    _overall_committed = _g1h-&gt;capacity();
    size_t committed = _overall_committed;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -272,15 +274,19 @@</span>
           (_eden_space_committed + _survivor_space_committed + _old_gen_committed),
           &quot;the committed sizes should add up&quot;);
    // Somewhat defensive: cap the eden used size to make sure it
    // never exceeds the committed size.
    _eden_space_used = MIN2(_eden_space_used, _eden_space_committed);
<span class="udiff-line-modified-removed">-   // _survivor_committed and _old_committed are calculated in terms of</span>
<span class="udiff-line-modified-removed">-   // the corresponding _*_used value, so the next two conditions</span>
<span class="udiff-line-modified-removed">-   // should hold.</span>
<span class="udiff-line-modified-removed">-   assert(_survivor_space_used &lt;= _survivor_space_committed, &quot;post-condition&quot;);</span>
<span class="udiff-line-modified-removed">-   assert(_old_gen_used &lt;= _old_gen_committed, &quot;post-condition&quot;);</span>
<span class="udiff-line-modified-added">+   // _survivor_space_used is calculated during a safepoint and _survivor_space_committed</span>
<span class="udiff-line-modified-added">+   // is calculated from survivor region count * heap region size.</span>
<span class="udiff-line-modified-added">+   assert(_survivor_space_used &lt;= _survivor_space_committed, &quot;Survivor used bytes(&quot; SIZE_FORMAT</span>
<span class="udiff-line-modified-added">+          &quot;) should be less than or equal to survivor committed(&quot; SIZE_FORMAT &quot;)&quot;,</span>
<span class="udiff-line-modified-added">+          _survivor_space_used, _survivor_space_committed);</span>
<span class="udiff-line-added">+   // _old_gen_committed is calculated in terms of _old_gen_used value.</span>
<span class="udiff-line-added">+   assert(_old_gen_used &lt;= _old_gen_committed, &quot;Old gen used bytes(&quot; SIZE_FORMAT</span>
<span class="udiff-line-added">+          &quot;) should be less than or equal to old gen committed(&quot; SIZE_FORMAT &quot;)&quot;,</span>
<span class="udiff-line-added">+          _old_gen_used, _old_gen_committed);</span>
  }
  
  void G1MonitoringSupport::update_sizes() {
    recalculate_sizes();
    if (UsePerfData) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -309,29 +315,29 @@</span>
      _eden_space_counters-&gt;update_used(_eden_space_used);
    }
  }
  
  MemoryUsage G1MonitoringSupport::eden_space_memory_usage(size_t initial_size, size_t max_size) {
<span class="udiff-line-modified-removed">-   MutexLockerEx x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
  
    return MemoryUsage(initial_size,
                       _eden_space_used,
                       _eden_space_committed,
                       max_size);
  }
  
  MemoryUsage G1MonitoringSupport::survivor_space_memory_usage(size_t initial_size, size_t max_size) {
<span class="udiff-line-modified-removed">-   MutexLockerEx x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
  
    return MemoryUsage(initial_size,
                       _survivor_space_used,
                       _survivor_space_committed,
                       max_size);
  }
  
  MemoryUsage G1MonitoringSupport::old_gen_memory_usage(size_t initial_size, size_t max_size) {
<span class="udiff-line-modified-removed">-   MutexLockerEx x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="udiff-line-modified-added">+   MutexLocker x(MonitoringSupport_lock, Mutex::_no_safepoint_check_flag);</span>
  
    return MemoryUsage(initial_size,
                       _old_gen_used,
                       _old_gen_committed,
                       max_size);
</pre>
<center><a href="g1MMUTracker.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1MonitoringSupport.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>