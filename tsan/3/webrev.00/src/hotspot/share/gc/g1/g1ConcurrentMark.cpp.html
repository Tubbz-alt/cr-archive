<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/g1/g1ConcurrentMark.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  30 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  31 #include &quot;gc/g1/g1ConcurrentMark.inline.hpp&quot;
  32 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  33 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  34 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  35 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  36 #include &quot;gc/g1/g1Policy.hpp&quot;
  37 #include &quot;gc/g1/g1RegionMarkStatsCache.inline.hpp&quot;
  38 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  39 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  40 #include &quot;gc/g1/g1Trace.hpp&quot;
  41 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  42 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  43 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  44 #include &quot;gc/shared/gcId.hpp&quot;
  45 #include &quot;gc/shared/gcTimer.hpp&quot;
  46 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  47 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  48 #include &quot;gc/shared/genOopClosures.inline.hpp&quot;
  49 #include &quot;gc/shared/referencePolicy.hpp&quot;
  50 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  51 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  52 #include &quot;gc/shared/taskTerminator.hpp&quot;
  53 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  54 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  55 #include &quot;gc/shared/workerPolicy.hpp&quot;
  56 #include &quot;include/jvm.h&quot;
  57 #include &quot;logging/log.hpp&quot;
  58 #include &quot;memory/allocation.hpp&quot;
  59 #include &quot;memory/iterator.hpp&quot;
  60 #include &quot;memory/resourceArea.hpp&quot;
  61 #include &quot;memory/universe.hpp&quot;
  62 #include &quot;oops/access.inline.hpp&quot;
  63 #include &quot;oops/oop.inline.hpp&quot;
  64 #include &quot;runtime/atomic.hpp&quot;
  65 #include &quot;runtime/handles.inline.hpp&quot;
  66 #include &quot;runtime/java.hpp&quot;
  67 #include &quot;runtime/orderAccess.hpp&quot;
  68 #include &quot;runtime/prefetch.inline.hpp&quot;
  69 #include &quot;services/memTracker.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/growableArray.hpp&quot;
  72 
  73 bool G1CMBitMapClosure::do_addr(HeapWord* const addr) {
  74   assert(addr &lt; _cm-&gt;finger(), &quot;invariant&quot;);
  75   assert(addr &gt;= _task-&gt;finger(), &quot;invariant&quot;);
  76 
  77   // We move that task&#39;s local finger along.
  78   _task-&gt;move_finger_to(addr);
  79 
  80   _task-&gt;scan_task_entry(G1TaskQueueEntry::from_oop(oop(addr)));
  81   // we only partially drain the local queue and global stack
  82   _task-&gt;drain_local_queue(true);
  83   _task-&gt;drain_global_stack(true);
  84 
  85   // if the has_aborted flag has been raised, we need to bail out of
  86   // the iteration
  87   return !_task-&gt;has_aborted();
  88 }
  89 
  90 G1CMMarkStack::G1CMMarkStack() :
  91   _max_chunk_capacity(0),
  92   _base(NULL),
  93   _chunk_capacity(0) {
  94   set_empty();
  95 }
  96 
  97 bool G1CMMarkStack::resize(size_t new_capacity) {
  98   assert(is_empty(), &quot;Only resize when stack is empty.&quot;);
  99   assert(new_capacity &lt;= _max_chunk_capacity,
 100          &quot;Trying to resize stack to &quot; SIZE_FORMAT &quot; chunks when the maximum is &quot; SIZE_FORMAT, new_capacity, _max_chunk_capacity);
 101 
 102   TaskQueueEntryChunk* new_base = MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::allocate_or_null(new_capacity, mtGC);
 103 
 104   if (new_base == NULL) {
 105     log_warning(gc)(&quot;Failed to reserve memory for new overflow mark stack with &quot; SIZE_FORMAT &quot; chunks and size &quot; SIZE_FORMAT &quot;B.&quot;, new_capacity, new_capacity * sizeof(TaskQueueEntryChunk));
 106     return false;
 107   }
 108   // Release old mapping.
 109   if (_base != NULL) {
 110     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 111   }
 112 
 113   _base = new_base;
 114   _chunk_capacity = new_capacity;
 115   set_empty();
 116 
 117   return true;
 118 }
 119 
 120 size_t G1CMMarkStack::capacity_alignment() {
 121   return (size_t)lcm(os::vm_allocation_granularity(), sizeof(TaskQueueEntryChunk)) / sizeof(G1TaskQueueEntry);
 122 }
 123 
 124 bool G1CMMarkStack::initialize(size_t initial_capacity, size_t max_capacity) {
 125   guarantee(_max_chunk_capacity == 0, &quot;G1CMMarkStack already initialized.&quot;);
 126 
 127   size_t const TaskEntryChunkSizeInVoidStar = sizeof(TaskQueueEntryChunk) / sizeof(G1TaskQueueEntry);
 128 
 129   _max_chunk_capacity = align_up(max_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 130   size_t initial_chunk_capacity = align_up(initial_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 131 
 132   guarantee(initial_chunk_capacity &lt;= _max_chunk_capacity,
 133             &quot;Maximum chunk capacity &quot; SIZE_FORMAT &quot; smaller than initial capacity &quot; SIZE_FORMAT,
 134             _max_chunk_capacity,
 135             initial_chunk_capacity);
 136 
 137   log_debug(gc)(&quot;Initialize mark stack with &quot; SIZE_FORMAT &quot; chunks, maximum &quot; SIZE_FORMAT,
 138                 initial_chunk_capacity, _max_chunk_capacity);
 139 
 140   return resize(initial_chunk_capacity);
 141 }
 142 
 143 void G1CMMarkStack::expand() {
 144   if (_chunk_capacity == _max_chunk_capacity) {
 145     log_debug(gc)(&quot;Can not expand overflow mark stack further, already at maximum capacity of &quot; SIZE_FORMAT &quot; chunks.&quot;, _chunk_capacity);
 146     return;
 147   }
 148   size_t old_capacity = _chunk_capacity;
 149   // Double capacity if possible
 150   size_t new_capacity = MIN2(old_capacity * 2, _max_chunk_capacity);
 151 
 152   if (resize(new_capacity)) {
 153     log_debug(gc)(&quot;Expanded mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 154                   old_capacity, new_capacity);
 155   } else {
 156     log_warning(gc)(&quot;Failed to expand mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 157                     old_capacity, new_capacity);
 158   }
 159 }
 160 
 161 G1CMMarkStack::~G1CMMarkStack() {
 162   if (_base != NULL) {
 163     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 164   }
 165 }
 166 
 167 void G1CMMarkStack::add_chunk_to_list(TaskQueueEntryChunk* volatile* list, TaskQueueEntryChunk* elem) {
 168   elem-&gt;next = *list;
 169   *list = elem;
 170 }
 171 
 172 void G1CMMarkStack::add_chunk_to_chunk_list(TaskQueueEntryChunk* elem) {
 173   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 174   add_chunk_to_list(&amp;_chunk_list, elem);
 175   _chunks_in_chunk_list++;
 176 }
 177 
 178 void G1CMMarkStack::add_chunk_to_free_list(TaskQueueEntryChunk* elem) {
 179   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 180   add_chunk_to_list(&amp;_free_list, elem);
 181 }
 182 
 183 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_list(TaskQueueEntryChunk* volatile* list) {
 184   TaskQueueEntryChunk* result = *list;
 185   if (result != NULL) {
 186     *list = (*list)-&gt;next;
 187   }
 188   return result;
 189 }
 190 
 191 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_chunk_list() {
 192   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 193   TaskQueueEntryChunk* result = remove_chunk_from_list(&amp;_chunk_list);
 194   if (result != NULL) {
 195     _chunks_in_chunk_list--;
 196   }
 197   return result;
 198 }
 199 
 200 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_free_list() {
 201   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 202   return remove_chunk_from_list(&amp;_free_list);
 203 }
 204 
 205 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::allocate_new_chunk() {
 206   // This dirty read of _hwm is okay because we only ever increase the _hwm in parallel code.
 207   // Further this limits _hwm to a value of _chunk_capacity + #threads, avoiding
 208   // wraparound of _hwm.
 209   if (_hwm &gt;= _chunk_capacity) {
 210     return NULL;
 211   }
 212 
 213   size_t cur_idx = Atomic::fetch_and_add(&amp;_hwm, 1u);
 214   if (cur_idx &gt;= _chunk_capacity) {
 215     return NULL;
 216   }
 217 
 218   TaskQueueEntryChunk* result = ::new (&amp;_base[cur_idx]) TaskQueueEntryChunk;
 219   result-&gt;next = NULL;
 220   return result;
 221 }
 222 
 223 bool G1CMMarkStack::par_push_chunk(G1TaskQueueEntry* ptr_arr) {
 224   // Get a new chunk.
 225   TaskQueueEntryChunk* new_chunk = remove_chunk_from_free_list();
 226 
 227   if (new_chunk == NULL) {
 228     // Did not get a chunk from the free list. Allocate from backing memory.
 229     new_chunk = allocate_new_chunk();
 230 
 231     if (new_chunk == NULL) {
 232       return false;
 233     }
 234   }
 235 
 236   Copy::conjoint_memory_atomic(ptr_arr, new_chunk-&gt;data, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 237 
 238   add_chunk_to_chunk_list(new_chunk);
 239 
 240   return true;
 241 }
 242 
 243 bool G1CMMarkStack::par_pop_chunk(G1TaskQueueEntry* ptr_arr) {
 244   TaskQueueEntryChunk* cur = remove_chunk_from_chunk_list();
 245 
 246   if (cur == NULL) {
 247     return false;
 248   }
 249 
 250   Copy::conjoint_memory_atomic(cur-&gt;data, ptr_arr, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 251 
 252   add_chunk_to_free_list(cur);
 253   return true;
 254 }
 255 
 256 void G1CMMarkStack::set_empty() {
 257   _chunks_in_chunk_list = 0;
 258   _hwm = 0;
 259   _chunk_list = NULL;
 260   _free_list = NULL;
 261 }
 262 
 263 G1CMRootMemRegions::G1CMRootMemRegions(uint const max_regions) :
 264     _root_regions(MemRegion::create_array(max_regions, mtGC)),
 265     _max_regions(max_regions),
 266     _num_root_regions(0),
 267     _claimed_root_regions(0),
 268     _scan_in_progress(false),
 269     _should_abort(false) { }
 270 
 271 G1CMRootMemRegions::~G1CMRootMemRegions() {
 272   FREE_C_HEAP_ARRAY(MemRegion, _root_regions);
 273 }
 274 
 275 void G1CMRootMemRegions::reset() {
 276   _num_root_regions = 0;
 277 }
 278 
 279 void G1CMRootMemRegions::add(HeapWord* start, HeapWord* end) {
 280   assert_at_safepoint();
 281   size_t idx = Atomic::fetch_and_add(&amp;_num_root_regions, 1u);
 282   assert(idx &lt; _max_regions, &quot;Trying to add more root MemRegions than there is space &quot; SIZE_FORMAT, _max_regions);
 283   assert(start != NULL &amp;&amp; end != NULL &amp;&amp; start &lt;= end, &quot;Start (&quot; PTR_FORMAT &quot;) should be less or equal to &quot;
 284          &quot;end (&quot; PTR_FORMAT &quot;)&quot;, p2i(start), p2i(end));
 285   _root_regions[idx].set_start(start);
 286   _root_regions[idx].set_end(end);
 287 }
 288 
 289 void G1CMRootMemRegions::prepare_for_scan() {
 290   assert(!scan_in_progress(), &quot;pre-condition&quot;);
 291 
 292   _scan_in_progress = _num_root_regions &gt; 0;
 293 
 294   _claimed_root_regions = 0;
 295   _should_abort = false;
 296 }
 297 
 298 const MemRegion* G1CMRootMemRegions::claim_next() {
 299   if (_should_abort) {
 300     // If someone has set the should_abort flag, we return NULL to
 301     // force the caller to bail out of their loop.
 302     return NULL;
 303   }
 304 
 305   if (_claimed_root_regions &gt;= _num_root_regions) {
 306     return NULL;
 307   }
 308 
 309   size_t claimed_index = Atomic::fetch_and_add(&amp;_claimed_root_regions, 1u);
 310   if (claimed_index &lt; _num_root_regions) {
 311     return &amp;_root_regions[claimed_index];
 312   }
 313   return NULL;
 314 }
 315 
 316 uint G1CMRootMemRegions::num_root_regions() const {
 317   return (uint)_num_root_regions;
 318 }
 319 
 320 void G1CMRootMemRegions::notify_scan_done() {
 321   MutexLocker x(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 322   _scan_in_progress = false;
 323   RootRegionScan_lock-&gt;notify_all();
 324 }
 325 
 326 void G1CMRootMemRegions::cancel_scan() {
 327   notify_scan_done();
 328 }
 329 
 330 void G1CMRootMemRegions::scan_finished() {
 331   assert(scan_in_progress(), &quot;pre-condition&quot;);
 332 
 333   if (!_should_abort) {
 334     assert(_claimed_root_regions &gt;= num_root_regions(),
 335            &quot;we should have claimed all root regions, claimed &quot; SIZE_FORMAT &quot;, length = %u&quot;,
 336            _claimed_root_regions, num_root_regions());
 337   }
 338 
 339   notify_scan_done();
 340 }
 341 
 342 bool G1CMRootMemRegions::wait_until_scan_finished() {
 343   if (!scan_in_progress()) {
 344     return false;
 345   }
 346 
 347   {
 348     MonitorLocker ml(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 349     while (scan_in_progress()) {
 350       ml.wait();
 351     }
 352   }
 353   return true;
 354 }
 355 
 356 // Returns the maximum number of workers to be used in a concurrent
 357 // phase based on the number of GC workers being used in a STW
 358 // phase.
 359 static uint scale_concurrent_worker_threads(uint num_gc_workers) {
 360   return MAX2((num_gc_workers + 2) / 4, 1U);
 361 }
 362 
 363 G1ConcurrentMark::G1ConcurrentMark(G1CollectedHeap* g1h,
 364                                    G1RegionToSpaceMapper* prev_bitmap_storage,
 365                                    G1RegionToSpaceMapper* next_bitmap_storage) :
 366   // _cm_thread set inside the constructor
 367   _g1h(g1h),
 368   _completed_initialization(false),
 369 
 370   _mark_bitmap_1(),
 371   _mark_bitmap_2(),
 372   _prev_mark_bitmap(&amp;_mark_bitmap_1),
 373   _next_mark_bitmap(&amp;_mark_bitmap_2),
 374 
 375   _heap(_g1h-&gt;reserved_region()),
 376 
 377   _root_regions(_g1h-&gt;max_regions()),
 378 
 379   _global_mark_stack(),
 380 
 381   // _finger set in set_non_marking_state
 382 
 383   _worker_id_offset(G1DirtyCardQueueSet::num_par_ids() + G1ConcRefinementThreads),
 384   _max_num_tasks(ParallelGCThreads),
 385   // _num_active_tasks set in set_non_marking_state()
 386   // _tasks set inside the constructor
 387 
 388   _task_queues(new G1CMTaskQueueSet((int) _max_num_tasks)),
 389   _terminator((int) _max_num_tasks, _task_queues),
 390 
 391   _first_overflow_barrier_sync(),
 392   _second_overflow_barrier_sync(),
 393 
 394   _has_overflown(false),
 395   _concurrent(false),
 396   _has_aborted(false),
 397   _restart_for_overflow(false),
 398   _gc_timer_cm(new (ResourceObj::C_HEAP, mtGC) ConcurrentGCTimer()),
 399   _gc_tracer_cm(new (ResourceObj::C_HEAP, mtGC) G1OldTracer()),
 400 
 401   // _verbose_level set below
 402 
 403   _init_times(),
 404   _remark_times(),
 405   _remark_mark_times(),
 406   _remark_weak_ref_times(),
 407   _cleanup_times(),
 408   _total_cleanup_time(0.0),
 409 
 410   _accum_task_vtime(NULL),
 411 
 412   _concurrent_workers(NULL),
 413   _num_concurrent_workers(0),
 414   _max_concurrent_workers(0),
 415 
 416   _region_mark_stats(NEW_C_HEAP_ARRAY(G1RegionMarkStats, _g1h-&gt;max_regions(), mtGC)),
 417   _top_at_rebuild_starts(NEW_C_HEAP_ARRAY(HeapWord*, _g1h-&gt;max_regions(), mtGC))
 418 {
 419   _mark_bitmap_1.initialize(g1h-&gt;reserved_region(), prev_bitmap_storage);
 420   _mark_bitmap_2.initialize(g1h-&gt;reserved_region(), next_bitmap_storage);
 421 
 422   // Create &amp; start ConcurrentMark thread.
 423   _cm_thread = new G1ConcurrentMarkThread(this);
 424   if (_cm_thread-&gt;osthread() == NULL) {
 425     vm_shutdown_during_initialization(&quot;Could not create ConcurrentMarkThread&quot;);
 426   }
 427 
 428   assert(CGC_lock != NULL, &quot;CGC_lock must be initialized&quot;);
 429 
 430   if (FLAG_IS_DEFAULT(ConcGCThreads) || ConcGCThreads == 0) {
 431     // Calculate the number of concurrent worker threads by scaling
 432     // the number of parallel GC threads.
 433     uint marking_thread_num = scale_concurrent_worker_threads(ParallelGCThreads);
 434     FLAG_SET_ERGO(ConcGCThreads, marking_thread_num);
 435   }
 436 
 437   assert(ConcGCThreads &gt; 0, &quot;ConcGCThreads have been set.&quot;);
 438   if (ConcGCThreads &gt; ParallelGCThreads) {
 439     log_warning(gc)(&quot;More ConcGCThreads (%u) than ParallelGCThreads (%u).&quot;,
 440                     ConcGCThreads, ParallelGCThreads);
 441     return;
 442   }
 443 
 444   log_debug(gc)(&quot;ConcGCThreads: %u offset %u&quot;, ConcGCThreads, _worker_id_offset);
 445   log_debug(gc)(&quot;ParallelGCThreads: %u&quot;, ParallelGCThreads);
 446 
 447   _num_concurrent_workers = ConcGCThreads;
 448   _max_concurrent_workers = _num_concurrent_workers;
 449 
 450   _concurrent_workers = new WorkGang(&quot;G1 Conc&quot;, _max_concurrent_workers, false, true);
 451   _concurrent_workers-&gt;initialize_workers();
 452 
 453   if (FLAG_IS_DEFAULT(MarkStackSize)) {
 454     size_t mark_stack_size =
 455       MIN2(MarkStackSizeMax,
 456           MAX2(MarkStackSize, (size_t) (_max_concurrent_workers * TASKQUEUE_SIZE)));
 457     // Verify that the calculated value for MarkStackSize is in range.
 458     // It would be nice to use the private utility routine from Arguments.
 459     if (!(mark_stack_size &gt;= 1 &amp;&amp; mark_stack_size &lt;= MarkStackSizeMax)) {
 460       log_warning(gc)(&quot;Invalid value calculated for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 461                       &quot;must be between 1 and &quot; SIZE_FORMAT,
 462                       mark_stack_size, MarkStackSizeMax);
 463       return;
 464     }
 465     FLAG_SET_ERGO(MarkStackSize, mark_stack_size);
 466   } else {
 467     // Verify MarkStackSize is in range.
 468     if (FLAG_IS_CMDLINE(MarkStackSize)) {
 469       if (FLAG_IS_DEFAULT(MarkStackSizeMax)) {
 470         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 471           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 472                           &quot;must be between 1 and &quot; SIZE_FORMAT,
 473                           MarkStackSize, MarkStackSizeMax);
 474           return;
 475         }
 476       } else if (FLAG_IS_CMDLINE(MarkStackSizeMax)) {
 477         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 478           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;)&quot;
 479                           &quot; or for MarkStackSizeMax (&quot; SIZE_FORMAT &quot;)&quot;,
 480                           MarkStackSize, MarkStackSizeMax);
 481           return;
 482         }
 483       }
 484     }
 485   }
 486 
 487   if (!_global_mark_stack.initialize(MarkStackSize, MarkStackSizeMax)) {
 488     vm_exit_during_initialization(&quot;Failed to allocate initial concurrent mark overflow mark stack.&quot;);
 489   }
 490 
 491   _tasks = NEW_C_HEAP_ARRAY(G1CMTask*, _max_num_tasks, mtGC);
 492   _accum_task_vtime = NEW_C_HEAP_ARRAY(double, _max_num_tasks, mtGC);
 493 
 494   // so that the assertion in MarkingTaskQueue::task_queue doesn&#39;t fail
 495   _num_active_tasks = _max_num_tasks;
 496 
 497   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 498     G1CMTaskQueue* task_queue = new G1CMTaskQueue();
 499     task_queue-&gt;initialize();
 500     _task_queues-&gt;register_queue(i, task_queue);
 501 
 502     _tasks[i] = new G1CMTask(i, this, task_queue, _region_mark_stats, _g1h-&gt;max_regions());
 503 
 504     _accum_task_vtime[i] = 0.0;
 505   }
 506 
 507   reset_at_marking_complete();
 508   _completed_initialization = true;
 509 }
 510 
 511 void G1ConcurrentMark::reset() {
 512   _has_aborted = false;
 513 
 514   reset_marking_for_restart();
 515 
 516   // Reset all tasks, since different phases will use different number of active
 517   // threads. So, it&#39;s easiest to have all of them ready.
 518   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 519     _tasks[i]-&gt;reset(_next_mark_bitmap);
 520   }
 521 
 522   uint max_regions = _g1h-&gt;max_regions();
 523   for (uint i = 0; i &lt; max_regions; i++) {
 524     _top_at_rebuild_starts[i] = NULL;
 525     _region_mark_stats[i].clear();
 526   }
 527 }
 528 
 529 void G1ConcurrentMark::clear_statistics_in_region(uint region_idx) {
 530   for (uint j = 0; j &lt; _max_num_tasks; ++j) {
 531     _tasks[j]-&gt;clear_mark_stats_cache(region_idx);
 532   }
 533   _top_at_rebuild_starts[region_idx] = NULL;
 534   _region_mark_stats[region_idx].clear();
 535 }
 536 
 537 void G1ConcurrentMark::clear_statistics(HeapRegion* r) {
 538   uint const region_idx = r-&gt;hrm_index();
 539   if (r-&gt;is_humongous()) {
 540     assert(r-&gt;is_starts_humongous(), &quot;Got humongous continues region here&quot;);
 541     uint const size_in_regions = (uint)_g1h-&gt;humongous_obj_size_in_regions(oop(r-&gt;humongous_start_region()-&gt;bottom())-&gt;size());
 542     for (uint j = region_idx; j &lt; (region_idx + size_in_regions); j++) {
 543       clear_statistics_in_region(j);
 544     }
 545   } else {
 546     clear_statistics_in_region(region_idx);
 547   }
 548 }
 549 
 550 static void clear_mark_if_set(G1CMBitMap* bitmap, HeapWord* addr) {
 551   if (bitmap-&gt;is_marked(addr)) {
 552     bitmap-&gt;clear(addr);
 553   }
 554 }
 555 
 556 void G1ConcurrentMark::humongous_object_eagerly_reclaimed(HeapRegion* r) {
 557   assert_at_safepoint_on_vm_thread();
 558 
 559   // Need to clear all mark bits of the humongous object.
 560   clear_mark_if_set(_prev_mark_bitmap, r-&gt;bottom());
 561   clear_mark_if_set(_next_mark_bitmap, r-&gt;bottom());
 562 
 563   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
 564     return;
 565   }
 566 
 567   // Clear any statistics about the region gathered so far.
 568   clear_statistics(r);
 569 }
 570 
 571 void G1ConcurrentMark::reset_marking_for_restart() {
 572   _global_mark_stack.set_empty();
 573 
 574   // Expand the marking stack, if we have to and if we can.
 575   if (has_overflown()) {
 576     _global_mark_stack.expand();
 577 
 578     uint max_regions = _g1h-&gt;max_regions();
 579     for (uint i = 0; i &lt; max_regions; i++) {
 580       _region_mark_stats[i].clear_during_overflow();
 581     }
 582   }
 583 
 584   clear_has_overflown();
 585   _finger = _heap.start();
 586 
 587   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 588     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
 589     queue-&gt;set_empty();
 590   }
 591 }
 592 
 593 void G1ConcurrentMark::set_concurrency(uint active_tasks) {
 594   assert(active_tasks &lt;= _max_num_tasks, &quot;we should not have more&quot;);
 595 
 596   _num_active_tasks = active_tasks;
 597   // Need to update the three data structures below according to the
 598   // number of active threads for this phase.
 599   _terminator.reset_for_reuse(active_tasks);
 600   _first_overflow_barrier_sync.set_n_workers((int) active_tasks);
 601   _second_overflow_barrier_sync.set_n_workers((int) active_tasks);
 602 }
 603 
 604 void G1ConcurrentMark::set_concurrency_and_phase(uint active_tasks, bool concurrent) {
 605   set_concurrency(active_tasks);
 606 
 607   _concurrent = concurrent;
 608 
 609   if (!concurrent) {
 610     // At this point we should be in a STW phase, and completed marking.
 611     assert_at_safepoint_on_vm_thread();
 612     assert(out_of_regions(),
 613            &quot;only way to get here: _finger: &quot; PTR_FORMAT &quot;, _heap_end: &quot; PTR_FORMAT,
 614            p2i(_finger), p2i(_heap.end()));
 615   }
 616 }
 617 
 618 void G1ConcurrentMark::reset_at_marking_complete() {
 619   // We set the global marking state to some default values when we&#39;re
 620   // not doing marking.
 621   reset_marking_for_restart();
 622   _num_active_tasks = 0;
 623 }
 624 
 625 G1ConcurrentMark::~G1ConcurrentMark() {
 626   FREE_C_HEAP_ARRAY(HeapWord*, _top_at_rebuild_starts);
 627   FREE_C_HEAP_ARRAY(G1RegionMarkStats, _region_mark_stats);
 628   // The G1ConcurrentMark instance is never freed.
 629   ShouldNotReachHere();
 630 }
 631 
 632 class G1ClearBitMapTask : public AbstractGangTask {
 633 public:
 634   static size_t chunk_size() { return M; }
 635 
 636 private:
 637   // Heap region closure used for clearing the given mark bitmap.
 638   class G1ClearBitmapHRClosure : public HeapRegionClosure {
 639   private:
 640     G1CMBitMap* _bitmap;
 641     G1ConcurrentMark* _cm;
 642   public:
 643     G1ClearBitmapHRClosure(G1CMBitMap* bitmap, G1ConcurrentMark* cm) : HeapRegionClosure(), _bitmap(bitmap), _cm(cm) {
 644     }
 645 
 646     virtual bool do_heap_region(HeapRegion* r) {
 647       size_t const chunk_size_in_words = G1ClearBitMapTask::chunk_size() / HeapWordSize;
 648 
 649       HeapWord* cur = r-&gt;bottom();
 650       HeapWord* const end = r-&gt;end();
 651 
 652       while (cur &lt; end) {
 653         MemRegion mr(cur, MIN2(cur + chunk_size_in_words, end));
 654         _bitmap-&gt;clear_range(mr);
 655 
 656         cur += chunk_size_in_words;
 657 
 658         // Abort iteration if after yielding the marking has been aborted.
 659         if (_cm != NULL &amp;&amp; _cm-&gt;do_yield_check() &amp;&amp; _cm-&gt;has_aborted()) {
 660           return true;
 661         }
 662         // Repeat the asserts from before the start of the closure. We will do them
 663         // as asserts here to minimize their overhead on the product. However, we
 664         // will have them as guarantees at the beginning / end of the bitmap
 665         // clearing to get some checking in the product.
 666         assert(_cm == NULL || _cm-&gt;cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 667         assert(_cm == NULL || !G1CollectedHeap::heap()-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 668       }
 669       assert(cur == end, &quot;Must have completed iteration over the bitmap for region %u.&quot;, r-&gt;hrm_index());
 670 
 671       return false;
 672     }
 673   };
 674 
 675   G1ClearBitmapHRClosure _cl;
 676   HeapRegionClaimer _hr_claimer;
 677   bool _suspendible; // If the task is suspendible, workers must join the STS.
 678 
 679 public:
 680   G1ClearBitMapTask(G1CMBitMap* bitmap, G1ConcurrentMark* cm, uint n_workers, bool suspendible) :
 681     AbstractGangTask(&quot;G1 Clear Bitmap&quot;),
 682     _cl(bitmap, suspendible ? cm : NULL),
 683     _hr_claimer(n_workers),
 684     _suspendible(suspendible)
 685   { }
 686 
 687   void work(uint worker_id) {
 688     SuspendibleThreadSetJoiner sts_join(_suspendible);
 689     G1CollectedHeap::heap()-&gt;heap_region_par_iterate_from_worker_offset(&amp;_cl, &amp;_hr_claimer, worker_id);
 690   }
 691 
 692   bool is_complete() {
 693     return _cl.is_complete();
 694   }
 695 };
 696 
 697 void G1ConcurrentMark::clear_bitmap(G1CMBitMap* bitmap, WorkGang* workers, bool may_yield) {
 698   assert(may_yield || SafepointSynchronize::is_at_safepoint(), &quot;Non-yielding bitmap clear only allowed at safepoint.&quot;);
 699 
 700   size_t const num_bytes_to_clear = (HeapRegion::GrainBytes * _g1h-&gt;num_regions()) / G1CMBitMap::heap_map_factor();
 701   size_t const num_chunks = align_up(num_bytes_to_clear, G1ClearBitMapTask::chunk_size()) / G1ClearBitMapTask::chunk_size();
 702 
 703   uint const num_workers = (uint)MIN2(num_chunks, (size_t)workers-&gt;active_workers());
 704 
 705   G1ClearBitMapTask cl(bitmap, this, num_workers, may_yield);
 706 
 707   log_debug(gc, ergo)(&quot;Running %s with %u workers for &quot; SIZE_FORMAT &quot; work units.&quot;, cl.name(), num_workers, num_chunks);
 708   workers-&gt;run_task(&amp;cl, num_workers);
 709   guarantee(!may_yield || cl.is_complete(), &quot;Must have completed iteration when not yielding.&quot;);
 710 }
 711 
 712 void G1ConcurrentMark::cleanup_for_next_mark() {
 713   // Make sure that the concurrent mark thread looks to still be in
 714   // the current cycle.
 715   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 716 
 717   // We are finishing up the current cycle by clearing the next
 718   // marking bitmap and getting it ready for the next cycle. During
 719   // this time no other cycle can start. So, let&#39;s make sure that this
 720   // is the case.
 721   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 722 
 723   clear_bitmap(_next_mark_bitmap, _concurrent_workers, true);
 724 
 725   // Repeat the asserts from above.
 726   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 727   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 728 }
 729 
 730 void G1ConcurrentMark::clear_prev_bitmap(WorkGang* workers) {
 731   assert_at_safepoint_on_vm_thread();
 732   clear_bitmap(_prev_mark_bitmap, workers, false);
 733 }
 734 
 735 class NoteStartOfMarkHRClosure : public HeapRegionClosure {
 736 public:
 737   bool do_heap_region(HeapRegion* r) {
 738     r-&gt;note_start_of_marking();
 739     return false;
 740   }
 741 };
 742 
 743 void G1ConcurrentMark::pre_initial_mark() {
 744   assert_at_safepoint_on_vm_thread();
 745 
 746   // Reset marking state.
 747   reset();
 748 
 749   // For each region note start of marking.
 750   NoteStartOfMarkHRClosure startcl;
 751   _g1h-&gt;heap_region_iterate(&amp;startcl);
 752 
 753   _root_regions.reset();
 754 }
 755 
 756 
 757 void G1ConcurrentMark::post_initial_mark() {
 758   // Start Concurrent Marking weak-reference discovery.
 759   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
 760   // enable (&quot;weak&quot;) refs discovery
 761   rp-&gt;enable_discovery();
 762   rp-&gt;setup_policy(false); // snapshot the soft ref policy to be used in this cycle
 763 
 764   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
 765   // This is the start of  the marking cycle, we&#39;re expected all
 766   // threads to have SATB queues with active set to false.
 767   satb_mq_set.set_active_all_threads(true, /* new active value */
 768                                      false /* expected_active */);
 769 
 770   _root_regions.prepare_for_scan();
 771 
 772   // update_g1_committed() will be called at the end of an evac pause
 773   // when marking is on. So, it&#39;s also called at the end of the
 774   // initial-mark pause to update the heap end, if the heap expands
 775   // during it. No need to call it here.
 776 }
 777 
 778 /*
 779  * Notice that in the next two methods, we actually leave the STS
 780  * during the barrier sync and join it immediately afterwards. If we
 781  * do not do this, the following deadlock can occur: one thread could
 782  * be in the barrier sync code, waiting for the other thread to also
 783  * sync up, whereas another one could be trying to yield, while also
 784  * waiting for the other threads to sync up too.
 785  *
 786  * Note, however, that this code is also used during remark and in
 787  * this case we should not attempt to leave / enter the STS, otherwise
 788  * we&#39;ll either hit an assert (debug / fastdebug) or deadlock
 789  * (product). So we should only leave / enter the STS if we are
 790  * operating concurrently.
 791  *
 792  * Because the thread that does the sync barrier has left the STS, it
 793  * is possible to be suspended for a Full GC or an evacuation pause
 794  * could occur. This is actually safe, since the entering the sync
 795  * barrier is one of the last things do_marking_step() does, and it
 796  * doesn&#39;t manipulate any data structures afterwards.
 797  */
 798 
 799 void G1ConcurrentMark::enter_first_sync_barrier(uint worker_id) {
 800   bool barrier_aborted;
 801   {
 802     SuspendibleThreadSetLeaver sts_leave(concurrent());
 803     barrier_aborted = !_first_overflow_barrier_sync.enter();
 804   }
 805 
 806   // at this point everyone should have synced up and not be doing any
 807   // more work
 808 
 809   if (barrier_aborted) {
 810     // If the barrier aborted we ignore the overflow condition and
 811     // just abort the whole marking phase as quickly as possible.
 812     return;
 813   }
 814 }
 815 
 816 void G1ConcurrentMark::enter_second_sync_barrier(uint worker_id) {
 817   SuspendibleThreadSetLeaver sts_leave(concurrent());
 818   _second_overflow_barrier_sync.enter();
 819 
 820   // at this point everything should be re-initialized and ready to go
 821 }
 822 
 823 class G1CMConcurrentMarkingTask : public AbstractGangTask {
 824   G1ConcurrentMark*     _cm;
 825 
 826 public:
 827   void work(uint worker_id) {
 828     assert(Thread::current()-&gt;is_ConcurrentGC_thread(), &quot;Not a concurrent GC thread&quot;);
 829     ResourceMark rm;
 830 
 831     double start_vtime = os::elapsedVTime();
 832 
 833     {
 834       SuspendibleThreadSetJoiner sts_join;
 835 
 836       assert(worker_id &lt; _cm-&gt;active_tasks(), &quot;invariant&quot;);
 837 
 838       G1CMTask* task = _cm-&gt;task(worker_id);
 839       task-&gt;record_start_time();
 840       if (!_cm-&gt;has_aborted()) {
 841         do {
 842           task-&gt;do_marking_step(G1ConcMarkStepDurationMillis,
 843                                 true  /* do_termination */,
 844                                 false /* is_serial*/);
 845 
 846           _cm-&gt;do_yield_check();
 847         } while (!_cm-&gt;has_aborted() &amp;&amp; task-&gt;has_aborted());
 848       }
 849       task-&gt;record_end_time();
 850       guarantee(!task-&gt;has_aborted() || _cm-&gt;has_aborted(), &quot;invariant&quot;);
 851     }
 852 
 853     double end_vtime = os::elapsedVTime();
 854     _cm-&gt;update_accum_task_vtime(worker_id, end_vtime - start_vtime);
 855   }
 856 
 857   G1CMConcurrentMarkingTask(G1ConcurrentMark* cm) :
 858       AbstractGangTask(&quot;Concurrent Mark&quot;), _cm(cm) { }
 859 
 860   ~G1CMConcurrentMarkingTask() { }
 861 };
 862 
 863 uint G1ConcurrentMark::calc_active_marking_workers() {
 864   uint result = 0;
 865   if (!UseDynamicNumberOfGCThreads ||
 866       (!FLAG_IS_DEFAULT(ConcGCThreads) &amp;&amp;
 867        !ForceDynamicNumberOfGCThreads)) {
 868     result = _max_concurrent_workers;
 869   } else {
 870     result =
 871       WorkerPolicy::calc_default_active_workers(_max_concurrent_workers,
 872                                                 1, /* Minimum workers */
 873                                                 _num_concurrent_workers,
 874                                                 Threads::number_of_non_daemon_threads());
 875     // Don&#39;t scale the result down by scale_concurrent_workers() because
 876     // that scaling has already gone into &quot;_max_concurrent_workers&quot;.
 877   }
 878   assert(result &gt; 0 &amp;&amp; result &lt;= _max_concurrent_workers,
 879          &quot;Calculated number of marking workers must be larger than zero and at most the maximum %u, but is %u&quot;,
 880          _max_concurrent_workers, result);
 881   return result;
 882 }
 883 
 884 void G1ConcurrentMark::scan_root_region(const MemRegion* region, uint worker_id) {
 885 #ifdef ASSERT
 886   HeapWord* last = region-&gt;last();
 887   HeapRegion* hr = _g1h-&gt;heap_region_containing(last);
 888   assert(hr-&gt;is_old() || hr-&gt;next_top_at_mark_start() == hr-&gt;bottom(),
 889          &quot;Root regions must be old or survivor/eden but region %u is %s&quot;, hr-&gt;hrm_index(), hr-&gt;get_type_str());
 890   assert(hr-&gt;next_top_at_mark_start() == region-&gt;start(),
 891          &quot;MemRegion start should be equal to nTAMS&quot;);
 892 #endif
 893 
 894   G1RootRegionScanClosure cl(_g1h, this, worker_id);
 895 
 896   const uintx interval = PrefetchScanIntervalInBytes;
 897   HeapWord* curr = region-&gt;start();
 898   const HeapWord* end = region-&gt;end();
 899   while (curr &lt; end) {
 900     Prefetch::read(curr, interval);
 901     oop obj = oop(curr);
 902     int size = obj-&gt;oop_iterate_size(&amp;cl);
 903     assert(size == obj-&gt;size(), &quot;sanity&quot;);
 904     curr += size;
 905   }
 906 }
 907 
 908 class G1CMRootRegionScanTask : public AbstractGangTask {
 909   G1ConcurrentMark* _cm;
 910 public:
 911   G1CMRootRegionScanTask(G1ConcurrentMark* cm) :
 912     AbstractGangTask(&quot;G1 Root Region Scan&quot;), _cm(cm) { }
 913 
 914   void work(uint worker_id) {
 915     assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
 916            &quot;this should only be done by a conc GC thread&quot;);
 917 
 918     G1CMRootMemRegions* root_regions = _cm-&gt;root_regions();
 919     const MemRegion* region = root_regions-&gt;claim_next();
 920     while (region != NULL) {
 921       _cm-&gt;scan_root_region(region, worker_id);
 922       region = root_regions-&gt;claim_next();
 923     }
 924   }
 925 };
 926 
 927 void G1ConcurrentMark::scan_root_regions() {
 928   // scan_in_progress() will have been set to true only if there was
 929   // at least one root region to scan. So, if it&#39;s false, we
 930   // should not attempt to do any further work.
 931   if (root_regions()-&gt;scan_in_progress()) {
 932     assert(!has_aborted(), &quot;Aborting before root region scanning is finished not supported.&quot;);
 933 
 934     _num_concurrent_workers = MIN2(calc_active_marking_workers(),
 935                                    // We distribute work on a per-region basis, so starting
 936                                    // more threads than that is useless.
 937                                    root_regions()-&gt;num_root_regions());
 938     assert(_num_concurrent_workers &lt;= _max_concurrent_workers,
 939            &quot;Maximum number of marking threads exceeded&quot;);
 940 
 941     G1CMRootRegionScanTask task(this);
 942     log_debug(gc, ergo)(&quot;Running %s using %u workers for %u work units.&quot;,
 943                         task.name(), _num_concurrent_workers, root_regions()-&gt;num_root_regions());
 944     _concurrent_workers-&gt;run_task(&amp;task, _num_concurrent_workers);
 945 
 946     // It&#39;s possible that has_aborted() is true here without actually
 947     // aborting the survivor scan earlier. This is OK as it&#39;s
 948     // mainly used for sanity checking.
 949     root_regions()-&gt;scan_finished();
 950   }
 951 }
 952 
 953 void G1ConcurrentMark::concurrent_cycle_start() {
 954   _gc_timer_cm-&gt;register_gc_start();
 955 
 956   _gc_tracer_cm-&gt;report_gc_start(GCCause::_no_gc /* first parameter is not used */, _gc_timer_cm-&gt;gc_start());
 957 
 958   _g1h-&gt;trace_heap_before_gc(_gc_tracer_cm);
 959 }
 960 
 961 void G1ConcurrentMark::concurrent_cycle_end() {
 962   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(false);
 963 
 964   _g1h-&gt;trace_heap_after_gc(_gc_tracer_cm);
 965 
 966   if (has_aborted()) {
 967     log_info(gc, marking)(&quot;Concurrent Mark Abort&quot;);
 968     _gc_tracer_cm-&gt;report_concurrent_mode_failure();
 969   }
 970 
 971   _gc_timer_cm-&gt;register_gc_end();
 972 
 973   _gc_tracer_cm-&gt;report_gc_end(_gc_timer_cm-&gt;gc_end(), _gc_timer_cm-&gt;time_partitions());
 974 }
 975 
 976 void G1ConcurrentMark::mark_from_roots() {
 977   _restart_for_overflow = false;
 978 
 979   _num_concurrent_workers = calc_active_marking_workers();
 980 
 981   uint active_workers = MAX2(1U, _num_concurrent_workers);
 982 
 983   // Setting active workers is not guaranteed since fewer
 984   // worker threads may currently exist and more may not be
 985   // available.
 986   active_workers = _concurrent_workers-&gt;update_active_workers(active_workers);
 987   log_info(gc, task)(&quot;Using %u workers of %u for marking&quot;, active_workers, _concurrent_workers-&gt;total_workers());
 988 
 989   // Parallel task terminator is set in &quot;set_concurrency_and_phase()&quot;
 990   set_concurrency_and_phase(active_workers, true /* concurrent */);
 991 
 992   G1CMConcurrentMarkingTask marking_task(this);
 993   _concurrent_workers-&gt;run_task(&amp;marking_task);
 994   print_stats();
 995 }
 996 
 997 void G1ConcurrentMark::verify_during_pause(G1HeapVerifier::G1VerifyType type, VerifyOption vo, const char* caller) {
 998   G1HeapVerifier* verifier = _g1h-&gt;verifier();
 999 
1000   verifier-&gt;verify_region_sets_optional();
1001 
1002   if (VerifyDuringGC) {
1003     GCTraceTime(Debug, gc, phases) debug(caller, _gc_timer_cm);
1004 
1005     size_t const BufLen = 512;
1006     char buffer[BufLen];
1007 
1008     jio_snprintf(buffer, BufLen, &quot;During GC (%s)&quot;, caller);
1009     verifier-&gt;verify(type, vo, buffer);
1010   }
1011 
1012   verifier-&gt;check_bitmaps(caller);
1013 }
1014 
1015 class G1UpdateRemSetTrackingBeforeRebuildTask : public AbstractGangTask {
1016   G1CollectedHeap* _g1h;
1017   G1ConcurrentMark* _cm;
1018   HeapRegionClaimer _hrclaimer;
1019   uint volatile _total_selected_for_rebuild;
1020 
1021   G1PrintRegionLivenessInfoClosure _cl;
1022 
1023   class G1UpdateRemSetTrackingBeforeRebuild : public HeapRegionClosure {
1024     G1CollectedHeap* _g1h;
1025     G1ConcurrentMark* _cm;
1026 
1027     G1PrintRegionLivenessInfoClosure* _cl;
1028 
1029     uint _num_regions_selected_for_rebuild;  // The number of regions actually selected for rebuild.
1030 
1031     void update_remset_before_rebuild(HeapRegion* hr) {
1032       G1RemSetTrackingPolicy* tracking_policy = _g1h-&gt;policy()-&gt;remset_tracker();
1033 
1034       bool selected_for_rebuild;
1035       if (hr-&gt;is_humongous()) {
1036         bool const is_live = _cm-&gt;liveness(hr-&gt;humongous_start_region()-&gt;hrm_index()) &gt; 0;
1037         selected_for_rebuild = tracking_policy-&gt;update_humongous_before_rebuild(hr, is_live);
1038       } else {
1039         size_t const live_bytes = _cm-&gt;liveness(hr-&gt;hrm_index());
1040         selected_for_rebuild = tracking_policy-&gt;update_before_rebuild(hr, live_bytes);
1041       }
1042       if (selected_for_rebuild) {
1043         _num_regions_selected_for_rebuild++;
1044       }
1045       _cm-&gt;update_top_at_rebuild_start(hr);
1046     }
1047 
1048     // Distribute the given words across the humongous object starting with hr and
1049     // note end of marking.
1050     void distribute_marked_bytes(HeapRegion* hr, size_t marked_words) {
1051       uint const region_idx = hr-&gt;hrm_index();
1052       size_t const obj_size_in_words = (size_t)oop(hr-&gt;bottom())-&gt;size();
1053       uint const num_regions_in_humongous = (uint)G1CollectedHeap::humongous_obj_size_in_regions(obj_size_in_words);
1054 
1055       // &quot;Distributing&quot; zero words means that we only note end of marking for these
1056       // regions.
1057       assert(marked_words == 0 || obj_size_in_words == marked_words,
1058              &quot;Marked words should either be 0 or the same as humongous object (&quot; SIZE_FORMAT &quot;) but is &quot; SIZE_FORMAT,
1059              obj_size_in_words, marked_words);
1060 
1061       for (uint i = region_idx; i &lt; (region_idx + num_regions_in_humongous); i++) {
1062         HeapRegion* const r = _g1h-&gt;region_at(i);
1063         size_t const words_to_add = MIN2(HeapRegion::GrainWords, marked_words);
1064 
1065         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to humongous region %u (%s)&quot;,
1066                                words_to_add, i, r-&gt;get_type_str());
1067         add_marked_bytes_and_note_end(r, words_to_add * HeapWordSize);
1068         marked_words -= words_to_add;
1069       }
1070       assert(marked_words == 0,
1071              SIZE_FORMAT &quot; words left after distributing space across %u regions&quot;,
1072              marked_words, num_regions_in_humongous);
1073     }
1074 
1075     void update_marked_bytes(HeapRegion* hr) {
1076       uint const region_idx = hr-&gt;hrm_index();
1077       size_t const marked_words = _cm-&gt;liveness(region_idx);
1078       // The marking attributes the object&#39;s size completely to the humongous starts
1079       // region. We need to distribute this value across the entire set of regions a
1080       // humongous object spans.
1081       if (hr-&gt;is_humongous()) {
1082         assert(hr-&gt;is_starts_humongous() || marked_words == 0,
1083                &quot;Should not have marked words &quot; SIZE_FORMAT &quot; in non-starts humongous region %u (%s)&quot;,
1084                marked_words, region_idx, hr-&gt;get_type_str());
1085         if (hr-&gt;is_starts_humongous()) {
1086           distribute_marked_bytes(hr, marked_words);
1087         }
1088       } else {
1089         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to region %u (%s)&quot;, marked_words, region_idx, hr-&gt;get_type_str());
1090         add_marked_bytes_and_note_end(hr, marked_words * HeapWordSize);
1091       }
1092     }
1093 
1094     void add_marked_bytes_and_note_end(HeapRegion* hr, size_t marked_bytes) {
1095       hr-&gt;add_to_marked_bytes(marked_bytes);
1096       _cl-&gt;do_heap_region(hr);
1097       hr-&gt;note_end_of_marking();
1098     }
1099 
1100   public:
1101     G1UpdateRemSetTrackingBeforeRebuild(G1CollectedHeap* g1h, G1ConcurrentMark* cm, G1PrintRegionLivenessInfoClosure* cl) :
1102       _g1h(g1h), _cm(cm), _cl(cl), _num_regions_selected_for_rebuild(0) { }
1103 
1104     virtual bool do_heap_region(HeapRegion* r) {
1105       update_remset_before_rebuild(r);
1106       update_marked_bytes(r);
1107 
1108       return false;
1109     }
1110 
1111     uint num_selected_for_rebuild() const { return _num_regions_selected_for_rebuild; }
1112   };
1113 
1114 public:
1115   G1UpdateRemSetTrackingBeforeRebuildTask(G1CollectedHeap* g1h, G1ConcurrentMark* cm, uint num_workers) :
1116     AbstractGangTask(&quot;G1 Update RemSet Tracking Before Rebuild&quot;),
1117     _g1h(g1h), _cm(cm), _hrclaimer(num_workers), _total_selected_for_rebuild(0), _cl(&quot;Post-Marking&quot;) { }
1118 
1119   virtual void work(uint worker_id) {
1120     G1UpdateRemSetTrackingBeforeRebuild update_cl(_g1h, _cm, &amp;_cl);
1121     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;update_cl, &amp;_hrclaimer, worker_id);
1122     Atomic::add(&amp;_total_selected_for_rebuild, update_cl.num_selected_for_rebuild());
1123   }
1124 
1125   uint total_selected_for_rebuild() const { return _total_selected_for_rebuild; }
1126 
1127   // Number of regions for which roughly one thread should be spawned for this work.
1128   static const uint RegionsPerThread = 384;
1129 };
1130 
1131 class G1UpdateRemSetTrackingAfterRebuild : public HeapRegionClosure {
1132   G1CollectedHeap* _g1h;
1133 public:
1134   G1UpdateRemSetTrackingAfterRebuild(G1CollectedHeap* g1h) : _g1h(g1h) { }
1135 
1136   virtual bool do_heap_region(HeapRegion* r) {
1137     _g1h-&gt;policy()-&gt;remset_tracker()-&gt;update_after_rebuild(r);
1138     return false;
1139   }
1140 };
1141 
1142 void G1ConcurrentMark::remark() {
1143   assert_at_safepoint_on_vm_thread();
1144 
1145   // If a full collection has happened, we should not continue. However we might
1146   // have ended up here as the Remark VM operation has been scheduled already.
1147   if (has_aborted()) {
1148     return;
1149   }
1150 
1151   G1Policy* policy = _g1h-&gt;policy();
1152   policy-&gt;record_concurrent_mark_remark_start();
1153 
1154   double start = os::elapsedTime();
1155 
1156   verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark before&quot;);
1157 
1158   {
1159     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Marking&quot;, _gc_timer_cm);
1160     finalize_marking();
1161   }
1162 
1163   double mark_work_end = os::elapsedTime();
1164 
1165   bool const mark_finished = !has_overflown();
1166   if (mark_finished) {
1167     weak_refs_work(false /* clear_all_soft_refs */);
1168 
1169     SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1170     // We&#39;re done with marking.
1171     // This is the end of the marking cycle, we&#39;re expected all
1172     // threads to have SATB queues with active set to true.
1173     satb_mq_set.set_active_all_threads(false, /* new active value */
1174                                        true /* expected_active */);
1175 
1176     {
1177       GCTraceTime(Debug, gc, phases) debug(&quot;Flush Task Caches&quot;, _gc_timer_cm);
1178       flush_all_task_caches();
1179     }
1180 
1181     // Install newly created mark bitmap as &quot;prev&quot;.
1182     swap_mark_bitmaps();
1183     {
1184       GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking Before Rebuild&quot;, _gc_timer_cm);
1185 
1186       uint const workers_by_capacity = (_g1h-&gt;num_regions() + G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread - 1) /
1187                                        G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread;
1188       uint const num_workers = MIN2(_g1h-&gt;workers()-&gt;active_workers(), workers_by_capacity);
1189 
1190       G1UpdateRemSetTrackingBeforeRebuildTask cl(_g1h, this, num_workers);
1191       log_debug(gc,ergo)(&quot;Running %s using %u workers for %u regions in heap&quot;, cl.name(), num_workers, _g1h-&gt;num_regions());
1192       _g1h-&gt;workers()-&gt;run_task(&amp;cl, num_workers);
1193 
1194       log_debug(gc, remset, tracking)(&quot;Remembered Set Tracking update regions total %u, selected %u&quot;,
1195                                       _g1h-&gt;num_regions(), cl.total_selected_for_rebuild());
1196     }
1197     {
1198       GCTraceTime(Debug, gc, phases) debug(&quot;Reclaim Empty Regions&quot;, _gc_timer_cm);
1199       reclaim_empty_regions();
1200     }
1201 
1202     // Clean out dead classes
1203     if (ClassUnloadingWithConcurrentMark) {
1204       GCTraceTime(Debug, gc, phases) debug(&quot;Purge Metaspace&quot;, _gc_timer_cm);
1205       ClassLoaderDataGraph::purge();
1206     }
1207 
1208     _g1h-&gt;resize_heap_if_necessary();
1209 
1210     compute_new_sizes();
1211 
1212     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark after&quot;);
1213 
1214     assert(!restart_for_overflow(), &quot;sanity&quot;);
1215     // Completely reset the marking state since marking completed
1216     reset_at_marking_complete();
1217   } else {
1218     // We overflowed.  Restart concurrent marking.
1219     _restart_for_overflow = true;
1220 
1221     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark overflow&quot;);
1222 
1223     // Clear the marking state because we will be restarting
1224     // marking due to overflowing the global mark stack.
1225     reset_marking_for_restart();
1226   }
1227 
1228   {
1229     GCTraceTime(Debug, gc, phases) debug(&quot;Report Object Count&quot;, _gc_timer_cm);
1230     report_object_count(mark_finished);
1231   }
1232 
1233   // Statistics
1234   double now = os::elapsedTime();
1235   _remark_mark_times.add((mark_work_end - start) * 1000.0);
1236   _remark_weak_ref_times.add((now - mark_work_end) * 1000.0);
1237   _remark_times.add((now - start) * 1000.0);
1238 
1239   policy-&gt;record_concurrent_mark_remark_end();
1240 }
1241 
1242 class G1ReclaimEmptyRegionsTask : public AbstractGangTask {
1243   // Per-region work during the Cleanup pause.
1244   class G1ReclaimEmptyRegionsClosure : public HeapRegionClosure {
1245     G1CollectedHeap* _g1h;
1246     size_t _freed_bytes;
1247     FreeRegionList* _local_cleanup_list;
1248     uint _old_regions_removed;
1249     uint _humongous_regions_removed;
1250 
1251   public:
1252     G1ReclaimEmptyRegionsClosure(G1CollectedHeap* g1h,
1253                                  FreeRegionList* local_cleanup_list) :
1254       _g1h(g1h),
1255       _freed_bytes(0),
1256       _local_cleanup_list(local_cleanup_list),
1257       _old_regions_removed(0),
1258       _humongous_regions_removed(0) { }
1259 
1260     size_t freed_bytes() { return _freed_bytes; }
1261     const uint old_regions_removed() { return _old_regions_removed; }
1262     const uint humongous_regions_removed() { return _humongous_regions_removed; }
1263 
1264     bool do_heap_region(HeapRegion *hr) {
1265       if (hr-&gt;used() &gt; 0 &amp;&amp; hr-&gt;max_live_bytes() == 0 &amp;&amp; !hr-&gt;is_young() &amp;&amp; !hr-&gt;is_archive()) {
1266         _freed_bytes += hr-&gt;used();
1267         hr-&gt;set_containing_set(NULL);
1268         if (hr-&gt;is_humongous()) {
1269           _humongous_regions_removed++;
1270           _g1h-&gt;free_humongous_region(hr, _local_cleanup_list);
1271         } else {
1272           _old_regions_removed++;
1273           _g1h-&gt;free_region(hr, _local_cleanup_list);
1274         }
1275         hr-&gt;clear_cardtable();
1276         _g1h-&gt;concurrent_mark()-&gt;clear_statistics_in_region(hr-&gt;hrm_index());
1277         log_trace(gc)(&quot;Reclaimed empty region %u (%s) bot &quot; PTR_FORMAT, hr-&gt;hrm_index(), hr-&gt;get_short_type_str(), p2i(hr-&gt;bottom()));
1278       }
1279 
1280       return false;
1281     }
1282   };
1283 
1284   G1CollectedHeap* _g1h;
1285   FreeRegionList* _cleanup_list;
1286   HeapRegionClaimer _hrclaimer;
1287 
1288 public:
1289   G1ReclaimEmptyRegionsTask(G1CollectedHeap* g1h, FreeRegionList* cleanup_list, uint n_workers) :
1290     AbstractGangTask(&quot;G1 Cleanup&quot;),
1291     _g1h(g1h),
1292     _cleanup_list(cleanup_list),
1293     _hrclaimer(n_workers) {
1294   }
1295 
1296   void work(uint worker_id) {
1297     FreeRegionList local_cleanup_list(&quot;Local Cleanup List&quot;);
1298     G1ReclaimEmptyRegionsClosure cl(_g1h, &amp;local_cleanup_list);
1299     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_hrclaimer, worker_id);
1300     assert(cl.is_complete(), &quot;Shouldn&#39;t have aborted!&quot;);
1301 
1302     // Now update the old/humongous region sets
1303     _g1h-&gt;remove_from_old_sets(cl.old_regions_removed(), cl.humongous_regions_removed());
1304     {
1305       MutexLocker x(ParGCRareEvent_lock, Mutex::_no_safepoint_check_flag);
1306       _g1h-&gt;decrement_summary_bytes(cl.freed_bytes());
1307 
1308       _cleanup_list-&gt;add_ordered(&amp;local_cleanup_list);
1309       assert(local_cleanup_list.is_empty(), &quot;post-condition&quot;);
1310     }
1311   }
1312 };
1313 
1314 void G1ConcurrentMark::reclaim_empty_regions() {
1315   WorkGang* workers = _g1h-&gt;workers();
1316   FreeRegionList empty_regions_list(&quot;Empty Regions After Mark List&quot;);
1317 
1318   G1ReclaimEmptyRegionsTask cl(_g1h, &amp;empty_regions_list, workers-&gt;active_workers());
1319   workers-&gt;run_task(&amp;cl);
1320 
1321   if (!empty_regions_list.is_empty()) {
1322     log_debug(gc)(&quot;Reclaimed %u empty regions&quot;, empty_regions_list.length());
1323     // Now print the empty regions list.
1324     G1HRPrinter* hrp = _g1h-&gt;hr_printer();
1325     if (hrp-&gt;is_active()) {
1326       FreeRegionListIterator iter(&amp;empty_regions_list);
1327       while (iter.more_available()) {
1328         HeapRegion* hr = iter.get_next();
1329         hrp-&gt;cleanup(hr);
1330       }
1331     }
1332     // And actually make them available.
1333     _g1h-&gt;prepend_to_freelist(&amp;empty_regions_list);
1334   }
1335 }
1336 
1337 void G1ConcurrentMark::compute_new_sizes() {
1338   MetaspaceGC::compute_new_size();
1339 
1340   // Cleanup will have freed any regions completely full of garbage.
1341   // Update the soft reference policy with the new heap occupancy.
1342   Universe::update_heap_info_at_gc();
1343 
1344   // We reclaimed old regions so we should calculate the sizes to make
1345   // sure we update the old gen/space data.
1346   _g1h-&gt;g1mm()-&gt;update_sizes();
1347 }
1348 
1349 void G1ConcurrentMark::cleanup() {
1350   assert_at_safepoint_on_vm_thread();
1351 
1352   // If a full collection has happened, we shouldn&#39;t do this.
1353   if (has_aborted()) {
1354     return;
1355   }
1356 
1357   G1Policy* policy = _g1h-&gt;policy();
1358   policy-&gt;record_concurrent_mark_cleanup_start();
1359 
1360   double start = os::elapsedTime();
1361 
1362   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup before&quot;);
1363 
1364   {
1365     GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking After Rebuild&quot;, _gc_timer_cm);
1366     G1UpdateRemSetTrackingAfterRebuild cl(_g1h);
1367     _g1h-&gt;heap_region_iterate(&amp;cl);
1368   }
1369 
1370   if (log_is_enabled(Trace, gc, liveness)) {
1371     G1PrintRegionLivenessInfoClosure cl(&quot;Post-Cleanup&quot;);
1372     _g1h-&gt;heap_region_iterate(&amp;cl);
1373   }
1374 
1375   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup after&quot;);
1376 
1377   // We need to make this be a &quot;collection&quot; so any collection pause that
1378   // races with it goes around and waits for Cleanup to finish.
1379   _g1h-&gt;increment_total_collections();
1380 
1381   // Local statistics
1382   double recent_cleanup_time = (os::elapsedTime() - start);
1383   _total_cleanup_time += recent_cleanup_time;
1384   _cleanup_times.add(recent_cleanup_time);
1385 
1386   {
1387     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Concurrent Mark Cleanup&quot;, _gc_timer_cm);
1388     policy-&gt;record_concurrent_mark_cleanup_end();
1389   }
1390 }
1391 
1392 // &#39;Keep Alive&#39; oop closure used by both serial parallel reference processing.
1393 // Uses the G1CMTask associated with a worker thread (for serial reference
1394 // processing the G1CMTask for worker 0 is used) to preserve (mark) and
1395 // trace referent objects.
1396 //
1397 // Using the G1CMTask and embedded local queues avoids having the worker
1398 // threads operating on the global mark stack. This reduces the risk
1399 // of overflowing the stack - which we would rather avoid at this late
1400 // state. Also using the tasks&#39; local queues removes the potential
1401 // of the workers interfering with each other that could occur if
1402 // operating on the global stack.
1403 
1404 class G1CMKeepAliveAndDrainClosure : public OopClosure {
1405   G1ConcurrentMark* _cm;
1406   G1CMTask*         _task;
1407   uint              _ref_counter_limit;
1408   uint              _ref_counter;
1409   bool              _is_serial;
1410 public:
1411   G1CMKeepAliveAndDrainClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1412     _cm(cm), _task(task), _ref_counter_limit(G1RefProcDrainInterval),
1413     _ref_counter(_ref_counter_limit), _is_serial(is_serial) {
1414     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1415   }
1416 
1417   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
1418   virtual void do_oop(      oop* p) { do_oop_work(p); }
1419 
1420   template &lt;class T&gt; void do_oop_work(T* p) {
1421     if (_cm-&gt;has_overflown()) {
1422       return;
1423     }
1424     if (!_task-&gt;deal_with_reference(p)) {
1425       // We did not add anything to the mark bitmap (or mark stack), so there is
1426       // no point trying to drain it.
1427       return;
1428     }
1429     _ref_counter--;
1430 
1431     if (_ref_counter == 0) {
1432       // We have dealt with _ref_counter_limit references, pushing them
1433       // and objects reachable from them on to the local stack (and
1434       // possibly the global stack). Call G1CMTask::do_marking_step() to
1435       // process these entries.
1436       //
1437       // We call G1CMTask::do_marking_step() in a loop, which we&#39;ll exit if
1438       // there&#39;s nothing more to do (i.e. we&#39;re done with the entries that
1439       // were pushed as a result of the G1CMTask::deal_with_reference() calls
1440       // above) or we overflow.
1441       //
1442       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1443       // flag while there may still be some work to do. (See the comment at
1444       // the beginning of G1CMTask::do_marking_step() for those conditions -
1445       // one of which is reaching the specified time target.) It is only
1446       // when G1CMTask::do_marking_step() returns without setting the
1447       // has_aborted() flag that the marking step has completed.
1448       do {
1449         double mark_step_duration_ms = G1ConcMarkStepDurationMillis;
1450         _task-&gt;do_marking_step(mark_step_duration_ms,
1451                                false      /* do_termination */,
1452                                _is_serial);
1453       } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1454       _ref_counter = _ref_counter_limit;
1455     }
1456   }
1457 };
1458 
1459 // &#39;Drain&#39; oop closure used by both serial and parallel reference processing.
1460 // Uses the G1CMTask associated with a given worker thread (for serial
1461 // reference processing the G1CMtask for worker 0 is used). Calls the
1462 // do_marking_step routine, with an unbelievably large timeout value,
1463 // to drain the marking data structures of the remaining entries
1464 // added by the &#39;keep alive&#39; oop closure above.
1465 
1466 class G1CMDrainMarkingStackClosure : public VoidClosure {
1467   G1ConcurrentMark* _cm;
1468   G1CMTask*         _task;
1469   bool              _is_serial;
1470  public:
1471   G1CMDrainMarkingStackClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1472     _cm(cm), _task(task), _is_serial(is_serial) {
1473     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1474   }
1475 
1476   void do_void() {
1477     do {
1478       // We call G1CMTask::do_marking_step() to completely drain the local
1479       // and global marking stacks of entries pushed by the &#39;keep alive&#39;
1480       // oop closure (an instance of G1CMKeepAliveAndDrainClosure above).
1481       //
1482       // G1CMTask::do_marking_step() is called in a loop, which we&#39;ll exit
1483       // if there&#39;s nothing more to do (i.e. we&#39;ve completely drained the
1484       // entries that were pushed as a a result of applying the &#39;keep alive&#39;
1485       // closure to the entries on the discovered ref lists) or we overflow
1486       // the global marking stack.
1487       //
1488       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1489       // flag while there may still be some work to do. (See the comment at
1490       // the beginning of G1CMTask::do_marking_step() for those conditions -
1491       // one of which is reaching the specified time target.) It is only
1492       // when G1CMTask::do_marking_step() returns without setting the
1493       // has_aborted() flag that the marking step has completed.
1494 
1495       _task-&gt;do_marking_step(1000000000.0 /* something very large */,
1496                              true         /* do_termination */,
1497                              _is_serial);
1498     } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1499   }
1500 };
1501 
1502 // Implementation of AbstractRefProcTaskExecutor for parallel
1503 // reference processing at the end of G1 concurrent marking
1504 
1505 class G1CMRefProcTaskExecutor : public AbstractRefProcTaskExecutor {
1506 private:
1507   G1CollectedHeap*  _g1h;
1508   G1ConcurrentMark* _cm;
1509   WorkGang*         _workers;
1510   uint              _active_workers;
1511 
1512 public:
1513   G1CMRefProcTaskExecutor(G1CollectedHeap* g1h,
1514                           G1ConcurrentMark* cm,
1515                           WorkGang* workers,
1516                           uint n_workers) :
1517     _g1h(g1h), _cm(cm),
1518     _workers(workers), _active_workers(n_workers) { }
1519 
1520   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
1521 };
1522 
1523 class G1CMRefProcTaskProxy : public AbstractGangTask {
1524   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
1525   ProcessTask&amp;      _proc_task;
1526   G1CollectedHeap*  _g1h;
1527   G1ConcurrentMark* _cm;
1528 
1529 public:
1530   G1CMRefProcTaskProxy(ProcessTask&amp; proc_task,
1531                        G1CollectedHeap* g1h,
1532                        G1ConcurrentMark* cm) :
1533     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
1534     _proc_task(proc_task), _g1h(g1h), _cm(cm) {
1535     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1536     assert(rp-&gt;processing_is_mt(), &quot;shouldn&#39;t be here otherwise&quot;);
1537   }
1538 
1539   virtual void work(uint worker_id) {
1540     ResourceMark rm;
1541     HandleMark hm;
1542     G1CMTask* task = _cm-&gt;task(worker_id);
1543     G1CMIsAliveClosure g1_is_alive(_g1h);
1544     G1CMKeepAliveAndDrainClosure g1_par_keep_alive(_cm, task, false /* is_serial */);
1545     G1CMDrainMarkingStackClosure g1_par_drain(_cm, task, false /* is_serial */);
1546 
1547     _proc_task.work(worker_id, g1_is_alive, g1_par_keep_alive, g1_par_drain);
1548   }
1549 };
1550 
1551 void G1CMRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
1552   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
1553   assert(_g1h-&gt;ref_processor_cm()-&gt;processing_is_mt(), &quot;processing is not MT&quot;);
1554   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
1555          &quot;Ergonomically chosen workers(%u) should be less than or equal to active workers(%u)&quot;,
1556          ergo_workers, _workers-&gt;active_workers());
1557 
1558   G1CMRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _cm);
1559 
1560   // We need to reset the concurrency level before each
1561   // proxy task execution, so that the termination protocol
1562   // and overflow handling in G1CMTask::do_marking_step() knows
1563   // how many workers to wait for.
1564   _cm-&gt;set_concurrency(ergo_workers);
1565   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
1566 }
1567 
1568 void G1ConcurrentMark::weak_refs_work(bool clear_all_soft_refs) {
1569   ResourceMark rm;
1570   HandleMark   hm;
1571 
1572   // Is alive closure.
1573   G1CMIsAliveClosure g1_is_alive(_g1h);
1574 
1575   // Inner scope to exclude the cleaning of the string table
1576   // from the displayed time.
1577   {
1578     GCTraceTime(Debug, gc, phases) debug(&quot;Reference Processing&quot;, _gc_timer_cm);
1579 
1580     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1581 
1582     // See the comment in G1CollectedHeap::ref_processing_init()
1583     // about how reference processing currently works in G1.
1584 
1585     // Set the soft reference policy
1586     rp-&gt;setup_policy(clear_all_soft_refs);
1587     assert(_global_mark_stack.is_empty(), &quot;mark stack should be empty&quot;);
1588 
1589     // Instances of the &#39;Keep Alive&#39; and &#39;Complete GC&#39; closures used
1590     // in serial reference processing. Note these closures are also
1591     // used for serially processing (by the the current thread) the
1592     // JNI references during parallel reference processing.
1593     //
1594     // These closures do not need to synchronize with the worker
1595     // threads involved in parallel reference processing as these
1596     // instances are executed serially by the current thread (e.g.
1597     // reference processing is not multi-threaded and is thus
1598     // performed by the current thread instead of a gang worker).
1599     //
1600     // The gang tasks involved in parallel reference processing create
1601     // their own instances of these closures, which do their own
1602     // synchronization among themselves.
1603     G1CMKeepAliveAndDrainClosure g1_keep_alive(this, task(0), true /* is_serial */);
1604     G1CMDrainMarkingStackClosure g1_drain_mark_stack(this, task(0), true /* is_serial */);
1605 
1606     // We need at least one active thread. If reference processing
1607     // is not multi-threaded we use the current (VMThread) thread,
1608     // otherwise we use the work gang from the G1CollectedHeap and
1609     // we utilize all the worker threads we can.
1610     bool processing_is_mt = rp-&gt;processing_is_mt();
1611     uint active_workers = (processing_is_mt ? _g1h-&gt;workers()-&gt;active_workers() : 1U);
1612     active_workers = clamp(active_workers, 1u, _max_num_tasks);
1613 
1614     // Parallel processing task executor.
1615     G1CMRefProcTaskExecutor par_task_executor(_g1h, this,
1616                                               _g1h-&gt;workers(), active_workers);
1617     AbstractRefProcTaskExecutor* executor = (processing_is_mt ? &amp;par_task_executor : NULL);
1618 
1619     // Set the concurrency level. The phase was already set prior to
1620     // executing the remark task.
1621     set_concurrency(active_workers);
1622 
1623     // Set the degree of MT processing here.  If the discovery was done MT,
1624     // the number of threads involved during discovery could differ from
1625     // the number of active workers.  This is OK as long as the discovered
1626     // Reference lists are balanced (see balance_all_queues() and balance_queues()).
1627     rp-&gt;set_active_mt_degree(active_workers);
1628 
1629     ReferenceProcessorPhaseTimes pt(_gc_timer_cm, rp-&gt;max_num_queues());
1630 
1631     // Process the weak references.
1632     const ReferenceProcessorStats&amp; stats =
1633         rp-&gt;process_discovered_references(&amp;g1_is_alive,
1634                                           &amp;g1_keep_alive,
1635                                           &amp;g1_drain_mark_stack,
1636                                           executor,
1637                                           &amp;pt);
1638     _gc_tracer_cm-&gt;report_gc_reference_stats(stats);
1639     pt.print_all_references();
1640 
1641     // The do_oop work routines of the keep_alive and drain_marking_stack
1642     // oop closures will set the has_overflown flag if we overflow the
1643     // global marking stack.
1644 
1645     assert(has_overflown() || _global_mark_stack.is_empty(),
1646            &quot;Mark stack should be empty (unless it has overflown)&quot;);
1647 
1648     assert(rp-&gt;num_queues() == active_workers, &quot;why not&quot;);
1649 
1650     rp-&gt;verify_no_references_recorded();
1651     assert(!rp-&gt;discovery_enabled(), &quot;Post condition&quot;);
1652   }
1653 
1654   if (has_overflown()) {
1655     // We can not trust g1_is_alive and the contents of the heap if the marking stack
1656     // overflowed while processing references. Exit the VM.
1657     fatal(&quot;Overflow during reference processing, can not continue. Please &quot;
1658           &quot;increase MarkStackSizeMax (current value: &quot; SIZE_FORMAT &quot;) and &quot;
1659           &quot;restart.&quot;, MarkStackSizeMax);
1660     return;
1661   }
1662 
1663   assert(_global_mark_stack.is_empty(), &quot;Marking should have completed&quot;);
1664 
1665   {
1666     GCTraceTime(Debug, gc, phases) debug(&quot;Weak Processing&quot;, _gc_timer_cm);
1667     WeakProcessor::weak_oops_do(_g1h-&gt;workers(), &amp;g1_is_alive, &amp;do_nothing_cl, 1);
1668   }
1669 
1670   // Unload Klasses, String, Code Cache, etc.
1671   if (ClassUnloadingWithConcurrentMark) {
1672     GCTraceTime(Debug, gc, phases) debug(&quot;Class Unloading&quot;, _gc_timer_cm);
1673     bool purged_classes = SystemDictionary::do_unloading(_gc_timer_cm);
1674     _g1h-&gt;complete_cleaning(&amp;g1_is_alive, purged_classes);
1675   } else if (StringDedup::is_enabled()) {
1676     GCTraceTime(Debug, gc, phases) debug(&quot;String Deduplication&quot;, _gc_timer_cm);
1677     _g1h-&gt;string_dedup_cleaning(&amp;g1_is_alive, NULL);
1678   }
1679 }
1680 
1681 class G1PrecleanYieldClosure : public YieldClosure {
1682   G1ConcurrentMark* _cm;
1683 
1684 public:
1685   G1PrecleanYieldClosure(G1ConcurrentMark* cm) : _cm(cm) { }
1686 
1687   virtual bool should_return() {
1688     return _cm-&gt;has_aborted();
1689   }
1690 
1691   virtual bool should_return_fine_grain() {
1692     _cm-&gt;do_yield_check();
1693     return _cm-&gt;has_aborted();
1694   }
1695 };
1696 
1697 void G1ConcurrentMark::preclean() {
1698   assert(G1UseReferencePrecleaning, &quot;Precleaning must be enabled.&quot;);
1699 
1700   SuspendibleThreadSetJoiner joiner;
1701 
1702   G1CMKeepAliveAndDrainClosure keep_alive(this, task(0), true /* is_serial */);
1703   G1CMDrainMarkingStackClosure drain_mark_stack(this, task(0), true /* is_serial */);
1704 
1705   set_concurrency_and_phase(1, true);
1706 
1707   G1PrecleanYieldClosure yield_cl(this);
1708 
1709   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1710   // Precleaning is single threaded. Temporarily disable MT discovery.
1711   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(rp, false);
1712   rp-&gt;preclean_discovered_references(rp-&gt;is_alive_non_header(),
1713                                      &amp;keep_alive,
1714                                      &amp;drain_mark_stack,
1715                                      &amp;yield_cl,
1716                                      _gc_timer_cm);
1717 }
1718 
1719 // When sampling object counts, we already swapped the mark bitmaps, so we need to use
1720 // the prev bitmap determining liveness.
1721 class G1ObjectCountIsAliveClosure: public BoolObjectClosure {
1722   G1CollectedHeap* _g1h;
1723 public:
1724   G1ObjectCountIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) { }
1725 
1726   bool do_object_b(oop obj) {
1727     return obj != NULL &amp;&amp;
1728            (!_g1h-&gt;is_in_g1_reserved(obj) || !_g1h-&gt;is_obj_dead(obj));
1729   }
1730 };
1731 
1732 void G1ConcurrentMark::report_object_count(bool mark_completed) {
1733   // Depending on the completion of the marking liveness needs to be determined
1734   // using either the next or prev bitmap.
1735   if (mark_completed) {
1736     G1ObjectCountIsAliveClosure is_alive(_g1h);
1737     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1738   } else {
1739     G1CMIsAliveClosure is_alive(_g1h);
1740     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1741   }
1742 }
1743 
1744 
1745 void G1ConcurrentMark::swap_mark_bitmaps() {
1746   G1CMBitMap* temp = _prev_mark_bitmap;
1747   _prev_mark_bitmap = _next_mark_bitmap;
1748   _next_mark_bitmap = temp;
1749   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(true);
1750 }
1751 
1752 // Closure for marking entries in SATB buffers.
1753 class G1CMSATBBufferClosure : public SATBBufferClosure {
1754 private:
1755   G1CMTask* _task;
1756   G1CollectedHeap* _g1h;
1757 
1758   // This is very similar to G1CMTask::deal_with_reference, but with
1759   // more relaxed requirements for the argument, so this must be more
1760   // circumspect about treating the argument as an object.
1761   void do_entry(void* entry) const {
1762     _task-&gt;increment_refs_reached();
1763     oop const obj = static_cast&lt;oop&gt;(entry);
1764     _task-&gt;make_reference_grey(obj);
1765   }
1766 
1767 public:
1768   G1CMSATBBufferClosure(G1CMTask* task, G1CollectedHeap* g1h)
1769     : _task(task), _g1h(g1h) { }
1770 
1771   virtual void do_buffer(void** buffer, size_t size) {
1772     for (size_t i = 0; i &lt; size; ++i) {
1773       do_entry(buffer[i]);
1774     }
1775   }
1776 };
1777 
1778 class G1RemarkThreadsClosure : public ThreadClosure {
1779   G1CMSATBBufferClosure _cm_satb_cl;
1780   G1CMOopClosure _cm_cl;
1781   MarkingCodeBlobClosure _code_cl;
1782   uintx _claim_token;
1783 
1784  public:
1785   G1RemarkThreadsClosure(G1CollectedHeap* g1h, G1CMTask* task) :
1786     _cm_satb_cl(task, g1h),
1787     _cm_cl(g1h, task),
1788     _code_cl(&amp;_cm_cl, !CodeBlobToOopClosure::FixRelocations),
1789     _claim_token(Threads::thread_claim_token()) {}
1790 
1791   void do_thread(Thread* thread) {
1792     if (thread-&gt;claim_threads_do(true, _claim_token)) {
1793       SATBMarkQueue&amp; queue = G1ThreadLocalData::satb_mark_queue(thread);
1794       queue.apply_closure_and_empty(&amp;_cm_satb_cl);
1795       if (thread-&gt;is_Java_thread()) {
1796         // In theory it should not be neccessary to explicitly walk the nmethods to find roots for concurrent marking
1797         // however the liveness of oops reachable from nmethods have very complex lifecycles:
1798         // * Alive if on the stack of an executing method
1799         // * Weakly reachable otherwise
1800         // Some objects reachable from nmethods, such as the class loader (or klass_holder) of the receiver should be
1801         // live by the SATB invariant but other oops recorded in nmethods may behave differently.
1802         JavaThread* jt = (JavaThread*)thread;
1803         jt-&gt;nmethods_do(&amp;_code_cl);
1804       }
1805     }
1806   }
1807 };
1808 
1809 class G1CMRemarkTask : public AbstractGangTask {
1810   G1ConcurrentMark* _cm;
1811 public:
1812   void work(uint worker_id) {
1813     G1CMTask* task = _cm-&gt;task(worker_id);
1814     task-&gt;record_start_time();
1815     {
1816       ResourceMark rm;
1817       HandleMark hm;
1818 
1819       G1RemarkThreadsClosure threads_f(G1CollectedHeap::heap(), task);
1820       Threads::threads_do(&amp;threads_f);
1821     }
1822 
1823     do {
1824       task-&gt;do_marking_step(1000000000.0 /* something very large */,
1825                             true         /* do_termination       */,
1826                             false        /* is_serial            */);
1827     } while (task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1828     // If we overflow, then we do not want to restart. We instead
1829     // want to abort remark and do concurrent marking again.
1830     task-&gt;record_end_time();
1831   }
1832 
1833   G1CMRemarkTask(G1ConcurrentMark* cm, uint active_workers) :
1834     AbstractGangTask(&quot;Par Remark&quot;), _cm(cm) {
1835     _cm-&gt;terminator()-&gt;reset_for_reuse(active_workers);
1836   }
1837 };
1838 
1839 void G1ConcurrentMark::finalize_marking() {
1840   ResourceMark rm;
1841   HandleMark   hm;
1842 
1843   _g1h-&gt;ensure_parsability(false);
1844 
1845   // this is remark, so we&#39;ll use up all active threads
1846   uint active_workers = _g1h-&gt;workers()-&gt;active_workers();
1847   set_concurrency_and_phase(active_workers, false /* concurrent */);
1848   // Leave _parallel_marking_threads at it&#39;s
1849   // value originally calculated in the G1ConcurrentMark
1850   // constructor and pass values of the active workers
1851   // through the gang in the task.
1852 
1853   {
1854     StrongRootsScope srs(active_workers);
1855 
1856     G1CMRemarkTask remarkTask(this, active_workers);
1857     // We will start all available threads, even if we decide that the
1858     // active_workers will be fewer. The extra ones will just bail out
1859     // immediately.
1860     _g1h-&gt;workers()-&gt;run_task(&amp;remarkTask);
1861   }
1862 
1863   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1864   guarantee(has_overflown() ||
1865             satb_mq_set.completed_buffers_num() == 0,
1866             &quot;Invariant: has_overflown = %s, num buffers = &quot; SIZE_FORMAT,
1867             BOOL_TO_STR(has_overflown()),
1868             satb_mq_set.completed_buffers_num());
1869 
1870   print_stats();
1871 }
1872 
1873 void G1ConcurrentMark::flush_all_task_caches() {
1874   size_t hits = 0;
1875   size_t misses = 0;
1876   for (uint i = 0; i &lt; _max_num_tasks; i++) {
1877     Pair&lt;size_t, size_t&gt; stats = _tasks[i]-&gt;flush_mark_stats_cache();
1878     hits += stats.first;
1879     misses += stats.second;
1880   }
1881   size_t sum = hits + misses;
1882   log_debug(gc, stats)(&quot;Mark stats cache hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %1.3lf&quot;,
1883                        hits, misses, percent_of(hits, sum));
1884 }
1885 
1886 void G1ConcurrentMark::clear_range_in_prev_bitmap(MemRegion mr) {
1887   _prev_mark_bitmap-&gt;clear_range(mr);
1888 }
1889 
1890 HeapRegion*
1891 G1ConcurrentMark::claim_region(uint worker_id) {
1892   // &quot;checkpoint&quot; the finger
1893   HeapWord* finger = _finger;
1894 
1895   while (finger &lt; _heap.end()) {
1896     assert(_g1h-&gt;is_in_g1_reserved(finger), &quot;invariant&quot;);
1897 
1898     HeapRegion* curr_region = _g1h-&gt;heap_region_containing(finger);
1899     // Make sure that the reads below do not float before loading curr_region.
1900     OrderAccess::loadload();
1901     // Above heap_region_containing may return NULL as we always scan claim
1902     // until the end of the heap. In this case, just jump to the next region.
1903     HeapWord* end = curr_region != NULL ? curr_region-&gt;end() : finger + HeapRegion::GrainWords;
1904 
1905     // Is the gap between reading the finger and doing the CAS too long?
1906     HeapWord* res = Atomic::cmpxchg(&amp;_finger, finger, end);
1907     if (res == finger &amp;&amp; curr_region != NULL) {
1908       // we succeeded
1909       HeapWord*   bottom        = curr_region-&gt;bottom();
1910       HeapWord*   limit         = curr_region-&gt;next_top_at_mark_start();
1911 
1912       // notice that _finger == end cannot be guaranteed here since,
1913       // someone else might have moved the finger even further
1914       assert(_finger &gt;= end, &quot;the finger should have moved forward&quot;);
1915 
1916       if (limit &gt; bottom) {
1917         return curr_region;
1918       } else {
1919         assert(limit == bottom,
1920                &quot;the region limit should be at bottom&quot;);
1921         // we return NULL and the caller should try calling
1922         // claim_region() again.
1923         return NULL;
1924       }
1925     } else {
1926       assert(_finger &gt; finger, &quot;the finger should have moved forward&quot;);
1927       // read it again
1928       finger = _finger;
1929     }
1930   }
1931 
1932   return NULL;
1933 }
1934 
1935 #ifndef PRODUCT
1936 class VerifyNoCSetOops {
1937   G1CollectedHeap* _g1h;
1938   const char* _phase;
1939   int _info;
1940 
1941 public:
1942   VerifyNoCSetOops(const char* phase, int info = -1) :
1943     _g1h(G1CollectedHeap::heap()),
1944     _phase(phase),
1945     _info(info)
1946   { }
1947 
1948   void operator()(G1TaskQueueEntry task_entry) const {
1949     if (task_entry.is_array_slice()) {
1950       guarantee(_g1h-&gt;is_in_reserved(task_entry.slice()), &quot;Slice &quot; PTR_FORMAT &quot; must be in heap.&quot;, p2i(task_entry.slice()));
1951       return;
1952     }
1953     guarantee(oopDesc::is_oop(task_entry.obj()),
1954               &quot;Non-oop &quot; PTR_FORMAT &quot;, phase: %s, info: %d&quot;,
1955               p2i(task_entry.obj()), _phase, _info);
1956     HeapRegion* r = _g1h-&gt;heap_region_containing(task_entry.obj());
1957     guarantee(!(r-&gt;in_collection_set() || r-&gt;has_index_in_opt_cset()),
1958               &quot;obj &quot; PTR_FORMAT &quot; from %s (%d) in region %u in (optional) collection set&quot;,
1959               p2i(task_entry.obj()), _phase, _info, r-&gt;hrm_index());
1960   }
1961 };
1962 
1963 void G1ConcurrentMark::verify_no_collection_set_oops() {
1964   assert(SafepointSynchronize::is_at_safepoint(), &quot;should be at a safepoint&quot;);
1965   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
1966     return;
1967   }
1968 
1969   // Verify entries on the global mark stack
1970   _global_mark_stack.iterate(VerifyNoCSetOops(&quot;Stack&quot;));
1971 
1972   // Verify entries on the task queues
1973   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
1974     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
1975     queue-&gt;iterate(VerifyNoCSetOops(&quot;Queue&quot;, i));
1976   }
1977 
1978   // Verify the global finger
1979   HeapWord* global_finger = finger();
1980   if (global_finger != NULL &amp;&amp; global_finger &lt; _heap.end()) {
1981     // Since we always iterate over all regions, we might get a NULL HeapRegion
1982     // here.
1983     HeapRegion* global_hr = _g1h-&gt;heap_region_containing(global_finger);
1984     guarantee(global_hr == NULL || global_finger == global_hr-&gt;bottom(),
1985               &quot;global finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
1986               p2i(global_finger), HR_FORMAT_PARAMS(global_hr));
1987   }
1988 
1989   // Verify the task fingers
1990   assert(_num_concurrent_workers &lt;= _max_num_tasks, &quot;sanity&quot;);
1991   for (uint i = 0; i &lt; _num_concurrent_workers; ++i) {
1992     G1CMTask* task = _tasks[i];
1993     HeapWord* task_finger = task-&gt;finger();
1994     if (task_finger != NULL &amp;&amp; task_finger &lt; _heap.end()) {
1995       // See above note on the global finger verification.
1996       HeapRegion* r = _g1h-&gt;heap_region_containing(task_finger);
1997       guarantee(r == NULL || task_finger == r-&gt;bottom() ||
1998                 !r-&gt;in_collection_set() || !r-&gt;has_index_in_opt_cset(),
1999                 &quot;task finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
2000                 p2i(task_finger), HR_FORMAT_PARAMS(r));
2001     }
2002   }
2003 }
2004 #endif // PRODUCT
2005 
2006 void G1ConcurrentMark::rebuild_rem_set_concurrently() {
2007   _g1h-&gt;rem_set()-&gt;rebuild_rem_set(this, _concurrent_workers, _worker_id_offset);
2008 }
2009 
2010 void G1ConcurrentMark::print_stats() {
2011   if (!log_is_enabled(Debug, gc, stats)) {
2012     return;
2013   }
2014   log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
2015   for (size_t i = 0; i &lt; _num_active_tasks; ++i) {
2016     _tasks[i]-&gt;print_stats();
2017     log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
2018   }
2019 }
2020 
2021 void G1ConcurrentMark::concurrent_cycle_abort() {
2022   if (!cm_thread()-&gt;during_cycle() || _has_aborted) {
2023     // We haven&#39;t started a concurrent cycle or we have already aborted it. No need to do anything.
2024     return;
2025   }
2026 
2027   // Clear all marks in the next bitmap for the next marking cycle. This will allow us to skip the next
2028   // concurrent bitmap clearing.
2029   {
2030     GCTraceTime(Debug, gc) debug(&quot;Clear Next Bitmap&quot;);
2031     clear_bitmap(_next_mark_bitmap, _g1h-&gt;workers(), false);
2032   }
2033   // Note we cannot clear the previous marking bitmap here
2034   // since VerifyDuringGC verifies the objects marked during
2035   // a full GC against the previous bitmap.
2036 
2037   // Empty mark stack
2038   reset_marking_for_restart();
2039   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
2040     _tasks[i]-&gt;clear_region_fields();
2041   }
2042   _first_overflow_barrier_sync.abort();
2043   _second_overflow_barrier_sync.abort();
2044   _has_aborted = true;
2045 
2046   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2047   satb_mq_set.abandon_partial_marking();
2048   // This can be called either during or outside marking, we&#39;ll read
2049   // the expected_active value from the SATB queue set.
2050   satb_mq_set.set_active_all_threads(
2051                                  false, /* new active value */
2052                                  satb_mq_set.is_active() /* expected_active */);
2053 }
2054 
2055 static void print_ms_time_info(const char* prefix, const char* name,
2056                                NumberSeq&amp; ns) {
2057   log_trace(gc, marking)(&quot;%s%5d %12s: total time = %8.2f s (avg = %8.2f ms).&quot;,
2058                          prefix, ns.num(), name, ns.sum()/1000.0, ns.avg());
2059   if (ns.num() &gt; 0) {
2060     log_trace(gc, marking)(&quot;%s         [std. dev = %8.2f ms, max = %8.2f ms]&quot;,
2061                            prefix, ns.sd(), ns.maximum());
2062   }
2063 }
2064 
2065 void G1ConcurrentMark::print_summary_info() {
2066   Log(gc, marking) log;
2067   if (!log.is_trace()) {
2068     return;
2069   }
2070 
2071   log.trace(&quot; Concurrent marking:&quot;);
2072   print_ms_time_info(&quot;  &quot;, &quot;init marks&quot;, _init_times);
2073   print_ms_time_info(&quot;  &quot;, &quot;remarks&quot;, _remark_times);
2074   {
2075     print_ms_time_info(&quot;     &quot;, &quot;final marks&quot;, _remark_mark_times);
2076     print_ms_time_info(&quot;     &quot;, &quot;weak refs&quot;, _remark_weak_ref_times);
2077 
2078   }
2079   print_ms_time_info(&quot;  &quot;, &quot;cleanups&quot;, _cleanup_times);
2080   log.trace(&quot;    Finalize live data total time = %8.2f s (avg = %8.2f ms).&quot;,
2081             _total_cleanup_time, (_cleanup_times.num() &gt; 0 ? _total_cleanup_time * 1000.0 / (double)_cleanup_times.num() : 0.0));
2082   log.trace(&quot;  Total stop_world time = %8.2f s.&quot;,
2083             (_init_times.sum() + _remark_times.sum() + _cleanup_times.sum())/1000.0);
2084   log.trace(&quot;  Total concurrent time = %8.2f s (%8.2f s marking).&quot;,
2085             cm_thread()-&gt;vtime_accum(), cm_thread()-&gt;vtime_mark_accum());
2086 }
2087 
2088 void G1ConcurrentMark::print_worker_threads_on(outputStream* st) const {
2089   _concurrent_workers-&gt;print_worker_threads_on(st);
2090 }
2091 
2092 void G1ConcurrentMark::threads_do(ThreadClosure* tc) const {
2093   _concurrent_workers-&gt;threads_do(tc);
2094 }
2095 
2096 void G1ConcurrentMark::print_on_error(outputStream* st) const {
2097   st-&gt;print_cr(&quot;Marking Bits (Prev, Next): (CMBitMap*) &quot; PTR_FORMAT &quot;, (CMBitMap*) &quot; PTR_FORMAT,
2098                p2i(_prev_mark_bitmap), p2i(_next_mark_bitmap));
2099   _prev_mark_bitmap-&gt;print_on_error(st, &quot; Prev Bits: &quot;);
2100   _next_mark_bitmap-&gt;print_on_error(st, &quot; Next Bits: &quot;);
2101 }
2102 
2103 static ReferenceProcessor* get_cm_oop_closure_ref_processor(G1CollectedHeap* g1h) {
2104   ReferenceProcessor* result = g1h-&gt;ref_processor_cm();
2105   assert(result != NULL, &quot;CM reference processor should not be NULL&quot;);
2106   return result;
2107 }
2108 
2109 G1CMOopClosure::G1CMOopClosure(G1CollectedHeap* g1h,
2110                                G1CMTask* task)
2111   : MetadataVisitingOopIterateClosure(get_cm_oop_closure_ref_processor(g1h)),
2112     _g1h(g1h), _task(task)
2113 { }
2114 
2115 void G1CMTask::setup_for_region(HeapRegion* hr) {
2116   assert(hr != NULL,
2117         &quot;claim_region() should have filtered out NULL regions&quot;);
2118   _curr_region  = hr;
2119   _finger       = hr-&gt;bottom();
2120   update_region_limit();
2121 }
2122 
2123 void G1CMTask::update_region_limit() {
2124   HeapRegion* hr            = _curr_region;
2125   HeapWord* bottom          = hr-&gt;bottom();
2126   HeapWord* limit           = hr-&gt;next_top_at_mark_start();
2127 
2128   if (limit == bottom) {
2129     // The region was collected underneath our feet.
2130     // We set the finger to bottom to ensure that the bitmap
2131     // iteration that will follow this will not do anything.
2132     // (this is not a condition that holds when we set the region up,
2133     // as the region is not supposed to be empty in the first place)
2134     _finger = bottom;
2135   } else if (limit &gt;= _region_limit) {
2136     assert(limit &gt;= _finger, &quot;peace of mind&quot;);
2137   } else {
2138     assert(limit &lt; _region_limit, &quot;only way to get here&quot;);
2139     // This can happen under some pretty unusual circumstances.  An
2140     // evacuation pause empties the region underneath our feet (NTAMS
2141     // at bottom). We then do some allocation in the region (NTAMS
2142     // stays at bottom), followed by the region being used as a GC
2143     // alloc region (NTAMS will move to top() and the objects
2144     // originally below it will be grayed). All objects now marked in
2145     // the region are explicitly grayed, if below the global finger,
2146     // and we do not need in fact to scan anything else. So, we simply
2147     // set _finger to be limit to ensure that the bitmap iteration
2148     // doesn&#39;t do anything.
2149     _finger = limit;
2150   }
2151 
2152   _region_limit = limit;
2153 }
2154 
2155 void G1CMTask::giveup_current_region() {
2156   assert(_curr_region != NULL, &quot;invariant&quot;);
2157   clear_region_fields();
2158 }
2159 
2160 void G1CMTask::clear_region_fields() {
2161   // Values for these three fields that indicate that we&#39;re not
2162   // holding on to a region.
2163   _curr_region   = NULL;
2164   _finger        = NULL;
2165   _region_limit  = NULL;
2166 }
2167 
2168 void G1CMTask::set_cm_oop_closure(G1CMOopClosure* cm_oop_closure) {
2169   if (cm_oop_closure == NULL) {
2170     assert(_cm_oop_closure != NULL, &quot;invariant&quot;);
2171   } else {
2172     assert(_cm_oop_closure == NULL, &quot;invariant&quot;);
2173   }
2174   _cm_oop_closure = cm_oop_closure;
2175 }
2176 
2177 void G1CMTask::reset(G1CMBitMap* next_mark_bitmap) {
2178   guarantee(next_mark_bitmap != NULL, &quot;invariant&quot;);
2179   _next_mark_bitmap              = next_mark_bitmap;
2180   clear_region_fields();
2181 
2182   _calls                         = 0;
2183   _elapsed_time_ms               = 0.0;
2184   _termination_time_ms           = 0.0;
2185   _termination_start_time_ms     = 0.0;
2186 
2187   _mark_stats_cache.reset();
2188 }
2189 
2190 bool G1CMTask::should_exit_termination() {
2191   if (!regular_clock_call()) {
2192     return true;
2193   }
2194 
2195   // This is called when we are in the termination protocol. We should
2196   // quit if, for some reason, this task wants to abort or the global
2197   // stack is not empty (this means that we can get work from it).
2198   return !_cm-&gt;mark_stack_empty() || has_aborted();
2199 }
2200 
2201 void G1CMTask::reached_limit() {
2202   assert(_words_scanned &gt;= _words_scanned_limit ||
2203          _refs_reached &gt;= _refs_reached_limit ,
2204          &quot;shouldn&#39;t have been called otherwise&quot;);
2205   abort_marking_if_regular_check_fail();
2206 }
2207 
2208 bool G1CMTask::regular_clock_call() {
2209   if (has_aborted()) {
2210     return false;
2211   }
2212 
2213   // First, we need to recalculate the words scanned and refs reached
2214   // limits for the next clock call.
2215   recalculate_limits();
2216 
2217   // During the regular clock call we do the following
2218 
2219   // (1) If an overflow has been flagged, then we abort.
2220   if (_cm-&gt;has_overflown()) {
2221     return false;
2222   }
2223 
2224   // If we are not concurrent (i.e. we&#39;re doing remark) we don&#39;t need
2225   // to check anything else. The other steps are only needed during
2226   // the concurrent marking phase.
2227   if (!_cm-&gt;concurrent()) {
2228     return true;
2229   }
2230 
2231   // (2) If marking has been aborted for Full GC, then we also abort.
2232   if (_cm-&gt;has_aborted()) {
2233     return false;
2234   }
2235 
2236   double curr_time_ms = os::elapsedVTime() * 1000.0;
2237 
2238   // (4) We check whether we should yield. If we have to, then we abort.
2239   if (SuspendibleThreadSet::should_yield()) {
2240     // We should yield. To do this we abort the task. The caller is
2241     // responsible for yielding.
2242     return false;
2243   }
2244 
2245   // (5) We check whether we&#39;ve reached our time quota. If we have,
2246   // then we abort.
2247   double elapsed_time_ms = curr_time_ms - _start_time_ms;
2248   if (elapsed_time_ms &gt; _time_target_ms) {
2249     _has_timed_out = true;
2250     return false;
2251   }
2252 
2253   // (6) Finally, we check whether there are enough completed STAB
2254   // buffers available for processing. If there are, we abort.
2255   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2256   if (!_draining_satb_buffers &amp;&amp; satb_mq_set.process_completed_buffers()) {
2257     // we do need to process SATB buffers, we&#39;ll abort and restart
2258     // the marking task to do so
2259     return false;
2260   }
2261   return true;
2262 }
2263 
2264 void G1CMTask::recalculate_limits() {
2265   _real_words_scanned_limit = _words_scanned + words_scanned_period;
2266   _words_scanned_limit      = _real_words_scanned_limit;
2267 
2268   _real_refs_reached_limit  = _refs_reached  + refs_reached_period;
2269   _refs_reached_limit       = _real_refs_reached_limit;
2270 }
2271 
2272 void G1CMTask::decrease_limits() {
2273   // This is called when we believe that we&#39;re going to do an infrequent
2274   // operation which will increase the per byte scanned cost (i.e. move
2275   // entries to/from the global stack). It basically tries to decrease the
2276   // scanning limit so that the clock is called earlier.
2277 
2278   _words_scanned_limit = _real_words_scanned_limit - 3 * words_scanned_period / 4;
2279   _refs_reached_limit  = _real_refs_reached_limit - 3 * refs_reached_period / 4;
2280 }
2281 
2282 void G1CMTask::move_entries_to_global_stack() {
2283   // Local array where we&#39;ll store the entries that will be popped
2284   // from the local queue.
2285   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2286 
2287   size_t n = 0;
2288   G1TaskQueueEntry task_entry;
2289   while (n &lt; G1CMMarkStack::EntriesPerChunk &amp;&amp; _task_queue-&gt;pop_local(task_entry)) {
2290     buffer[n] = task_entry;
2291     ++n;
2292   }
2293   if (n &lt; G1CMMarkStack::EntriesPerChunk) {
2294     buffer[n] = G1TaskQueueEntry();
2295   }
2296 
2297   if (n &gt; 0) {
2298     if (!_cm-&gt;mark_stack_push(buffer)) {
2299       set_has_aborted();
2300     }
2301   }
2302 
2303   // This operation was quite expensive, so decrease the limits.
2304   decrease_limits();
2305 }
2306 
2307 bool G1CMTask::get_entries_from_global_stack() {
2308   // Local array where we&#39;ll store the entries that will be popped
2309   // from the global stack.
2310   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2311 
2312   if (!_cm-&gt;mark_stack_pop(buffer)) {
2313     return false;
2314   }
2315 
2316   // We did actually pop at least one entry.
2317   for (size_t i = 0; i &lt; G1CMMarkStack::EntriesPerChunk; ++i) {
2318     G1TaskQueueEntry task_entry = buffer[i];
2319     if (task_entry.is_null()) {
2320       break;
2321     }
2322     assert(task_entry.is_array_slice() || oopDesc::is_oop(task_entry.obj()), &quot;Element &quot; PTR_FORMAT &quot; must be an array slice or oop&quot;, p2i(task_entry.obj()));
2323     bool success = _task_queue-&gt;push(task_entry);
2324     // We only call this when the local queue is empty or under a
2325     // given target limit. So, we do not expect this push to fail.
2326     assert(success, &quot;invariant&quot;);
2327   }
2328 
2329   // This operation was quite expensive, so decrease the limits
2330   decrease_limits();
2331   return true;
2332 }
2333 
2334 void G1CMTask::drain_local_queue(bool partially) {
2335   if (has_aborted()) {
2336     return;
2337   }
2338 
2339   // Decide what the target size is, depending whether we&#39;re going to
2340   // drain it partially (so that other tasks can steal if they run out
2341   // of things to do) or totally (at the very end).
2342   size_t target_size;
2343   if (partially) {
2344     target_size = MIN2((size_t)_task_queue-&gt;max_elems()/3, (size_t)GCDrainStackTargetSize);
2345   } else {
2346     target_size = 0;
2347   }
2348 
2349   if (_task_queue-&gt;size() &gt; target_size) {
2350     G1TaskQueueEntry entry;
2351     bool ret = _task_queue-&gt;pop_local(entry);
2352     while (ret) {
2353       scan_task_entry(entry);
2354       if (_task_queue-&gt;size() &lt;= target_size || has_aborted()) {
2355         ret = false;
2356       } else {
2357         ret = _task_queue-&gt;pop_local(entry);
2358       }
2359     }
2360   }
2361 }
2362 
2363 void G1CMTask::drain_global_stack(bool partially) {
2364   if (has_aborted()) {
2365     return;
2366   }
2367 
2368   // We have a policy to drain the local queue before we attempt to
2369   // drain the global stack.
2370   assert(partially || _task_queue-&gt;size() == 0, &quot;invariant&quot;);
2371 
2372   // Decide what the target size is, depending whether we&#39;re going to
2373   // drain it partially (so that other tasks can steal if they run out
2374   // of things to do) or totally (at the very end).
2375   // Notice that when draining the global mark stack partially, due to the racyness
2376   // of the mark stack size update we might in fact drop below the target. But,
2377   // this is not a problem.
2378   // In case of total draining, we simply process until the global mark stack is
2379   // totally empty, disregarding the size counter.
2380   if (partially) {
2381     size_t const target_size = _cm-&gt;partial_mark_stack_size_target();
2382     while (!has_aborted() &amp;&amp; _cm-&gt;mark_stack_size() &gt; target_size) {
2383       if (get_entries_from_global_stack()) {
2384         drain_local_queue(partially);
2385       }
2386     }
2387   } else {
2388     while (!has_aborted() &amp;&amp; get_entries_from_global_stack()) {
2389       drain_local_queue(partially);
2390     }
2391   }
2392 }
2393 
2394 // SATB Queue has several assumptions on whether to call the par or
2395 // non-par versions of the methods. this is why some of the code is
2396 // replicated. We should really get rid of the single-threaded version
2397 // of the code to simplify things.
2398 void G1CMTask::drain_satb_buffers() {
2399   if (has_aborted()) {
2400     return;
2401   }
2402 
2403   // We set this so that the regular clock knows that we&#39;re in the
2404   // middle of draining buffers and doesn&#39;t set the abort flag when it
2405   // notices that SATB buffers are available for draining. It&#39;d be
2406   // very counter productive if it did that. :-)
2407   _draining_satb_buffers = true;
2408 
2409   G1CMSATBBufferClosure satb_cl(this, _g1h);
2410   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2411 
2412   // This keeps claiming and applying the closure to completed buffers
2413   // until we run out of buffers or we need to abort.
2414   while (!has_aborted() &amp;&amp;
2415          satb_mq_set.apply_closure_to_completed_buffer(&amp;satb_cl)) {
2416     abort_marking_if_regular_check_fail();
2417   }
2418 
2419   // Can&#39;t assert qset is empty here, even if not aborted.  If concurrent,
2420   // some other thread might be adding to the queue.  If not concurrent,
2421   // some other thread might have won the race for the last buffer, but
2422   // has not yet decremented the count.
2423 
2424   _draining_satb_buffers = false;
2425 
2426   // again, this was a potentially expensive operation, decrease the
2427   // limits to get the regular clock call early
2428   decrease_limits();
2429 }
2430 
2431 void G1CMTask::clear_mark_stats_cache(uint region_idx) {
2432   _mark_stats_cache.reset(region_idx);
2433 }
2434 
2435 Pair&lt;size_t, size_t&gt; G1CMTask::flush_mark_stats_cache() {
2436   return _mark_stats_cache.evict_all();
2437 }
2438 
2439 void G1CMTask::print_stats() {
2440   log_debug(gc, stats)(&quot;Marking Stats, task = %u, calls = %u&quot;, _worker_id, _calls);
2441   log_debug(gc, stats)(&quot;  Elapsed time = %1.2lfms, Termination time = %1.2lfms&quot;,
2442                        _elapsed_time_ms, _termination_time_ms);
2443   log_debug(gc, stats)(&quot;  Step Times (cum): num = %d, avg = %1.2lfms, sd = %1.2lfms max = %1.2lfms, total = %1.2lfms&quot;,
2444                        _step_times_ms.num(),
2445                        _step_times_ms.avg(),
2446                        _step_times_ms.sd(),
2447                        _step_times_ms.maximum(),
2448                        _step_times_ms.sum());
2449   size_t const hits = _mark_stats_cache.hits();
2450   size_t const misses = _mark_stats_cache.misses();
2451   log_debug(gc, stats)(&quot;  Mark Stats Cache: hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %.3f&quot;,
2452                        hits, misses, percent_of(hits, hits + misses));
2453 }
2454 
2455 bool G1ConcurrentMark::try_stealing(uint worker_id, G1TaskQueueEntry&amp; task_entry) {
2456   return _task_queues-&gt;steal(worker_id, task_entry);
2457 }
2458 
2459 /*****************************************************************************
2460 
2461     The do_marking_step(time_target_ms, ...) method is the building
2462     block of the parallel marking framework. It can be called in parallel
2463     with other invocations of do_marking_step() on different tasks
2464     (but only one per task, obviously) and concurrently with the
2465     mutator threads, or during remark, hence it eliminates the need
2466     for two versions of the code. When called during remark, it will
2467     pick up from where the task left off during the concurrent marking
2468     phase. Interestingly, tasks are also claimable during evacuation
2469     pauses too, since do_marking_step() ensures that it aborts before
2470     it needs to yield.
2471 
2472     The data structures that it uses to do marking work are the
2473     following:
2474 
2475       (1) Marking Bitmap. If there are gray objects that appear only
2476       on the bitmap (this happens either when dealing with an overflow
2477       or when the initial marking phase has simply marked the roots
2478       and didn&#39;t push them on the stack), then tasks claim heap
2479       regions whose bitmap they then scan to find gray objects. A
2480       global finger indicates where the end of the last claimed region
2481       is. A local finger indicates how far into the region a task has
2482       scanned. The two fingers are used to determine how to gray an
2483       object (i.e. whether simply marking it is OK, as it will be
2484       visited by a task in the future, or whether it needs to be also
2485       pushed on a stack).
2486 
2487       (2) Local Queue. The local queue of the task which is accessed
2488       reasonably efficiently by the task. Other tasks can steal from
2489       it when they run out of work. Throughout the marking phase, a
2490       task attempts to keep its local queue short but not totally
2491       empty, so that entries are available for stealing by other
2492       tasks. Only when there is no more work, a task will totally
2493       drain its local queue.
2494 
2495       (3) Global Mark Stack. This handles local queue overflow. During
2496       marking only sets of entries are moved between it and the local
2497       queues, as access to it requires a mutex and more fine-grain
2498       interaction with it which might cause contention. If it
2499       overflows, then the marking phase should restart and iterate
2500       over the bitmap to identify gray objects. Throughout the marking
2501       phase, tasks attempt to keep the global mark stack at a small
2502       length but not totally empty, so that entries are available for
2503       popping by other tasks. Only when there is no more work, tasks
2504       will totally drain the global mark stack.
2505 
2506       (4) SATB Buffer Queue. This is where completed SATB buffers are
2507       made available. Buffers are regularly removed from this queue
2508       and scanned for roots, so that the queue doesn&#39;t get too
2509       long. During remark, all completed buffers are processed, as
2510       well as the filled in parts of any uncompleted buffers.
2511 
2512     The do_marking_step() method tries to abort when the time target
2513     has been reached. There are a few other cases when the
2514     do_marking_step() method also aborts:
2515 
2516       (1) When the marking phase has been aborted (after a Full GC).
2517 
2518       (2) When a global overflow (on the global stack) has been
2519       triggered. Before the task aborts, it will actually sync up with
2520       the other tasks to ensure that all the marking data structures
2521       (local queues, stacks, fingers etc.)  are re-initialized so that
2522       when do_marking_step() completes, the marking phase can
2523       immediately restart.
2524 
2525       (3) When enough completed SATB buffers are available. The
2526       do_marking_step() method only tries to drain SATB buffers right
2527       at the beginning. So, if enough buffers are available, the
2528       marking step aborts and the SATB buffers are processed at
2529       the beginning of the next invocation.
2530 
2531       (4) To yield. when we have to yield then we abort and yield
2532       right at the end of do_marking_step(). This saves us from a lot
2533       of hassle as, by yielding we might allow a Full GC. If this
2534       happens then objects will be compacted underneath our feet, the
2535       heap might shrink, etc. We save checking for this by just
2536       aborting and doing the yield right at the end.
2537 
2538     From the above it follows that the do_marking_step() method should
2539     be called in a loop (or, otherwise, regularly) until it completes.
2540 
2541     If a marking step completes without its has_aborted() flag being
2542     true, it means it has completed the current marking phase (and
2543     also all other marking tasks have done so and have all synced up).
2544 
2545     A method called regular_clock_call() is invoked &quot;regularly&quot; (in
2546     sub ms intervals) throughout marking. It is this clock method that
2547     checks all the abort conditions which were mentioned above and
2548     decides when the task should abort. A work-based scheme is used to
2549     trigger this clock method: when the number of object words the
2550     marking phase has scanned or the number of references the marking
2551     phase has visited reach a given limit. Additional invocations to
2552     the method clock have been planted in a few other strategic places
2553     too. The initial reason for the clock method was to avoid calling
2554     vtime too regularly, as it is quite expensive. So, once it was in
2555     place, it was natural to piggy-back all the other conditions on it
2556     too and not constantly check them throughout the code.
2557 
2558     If do_termination is true then do_marking_step will enter its
2559     termination protocol.
2560 
2561     The value of is_serial must be true when do_marking_step is being
2562     called serially (i.e. by the VMThread) and do_marking_step should
2563     skip any synchronization in the termination and overflow code.
2564     Examples include the serial remark code and the serial reference
2565     processing closures.
2566 
2567     The value of is_serial must be false when do_marking_step is
2568     being called by any of the worker threads in a work gang.
2569     Examples include the concurrent marking code (CMMarkingTask),
2570     the MT remark code, and the MT reference processing closures.
2571 
2572  *****************************************************************************/
2573 
2574 void G1CMTask::do_marking_step(double time_target_ms,
2575                                bool do_termination,
2576                                bool is_serial) {
2577   assert(time_target_ms &gt;= 1.0, &quot;minimum granularity is 1ms&quot;);
2578 
2579   _start_time_ms = os::elapsedVTime() * 1000.0;
2580 
2581   // If do_stealing is true then do_marking_step will attempt to
2582   // steal work from the other G1CMTasks. It only makes sense to
2583   // enable stealing when the termination protocol is enabled
2584   // and do_marking_step() is not being called serially.
2585   bool do_stealing = do_termination &amp;&amp; !is_serial;
2586 
2587   G1Predictions const&amp; predictor = _g1h-&gt;policy()-&gt;predictor();
2588   double diff_prediction_ms = predictor.predict_zero_bounded(&amp;_marking_step_diff_ms);
2589   _time_target_ms = time_target_ms - diff_prediction_ms;
2590 
2591   // set up the variables that are used in the work-based scheme to
2592   // call the regular clock method
2593   _words_scanned = 0;
2594   _refs_reached  = 0;
2595   recalculate_limits();
2596 
2597   // clear all flags
2598   clear_has_aborted();
2599   _has_timed_out = false;
2600   _draining_satb_buffers = false;
2601 
2602   ++_calls;
2603 
2604   // Set up the bitmap and oop closures. Anything that uses them is
2605   // eventually called from this method, so it is OK to allocate these
2606   // statically.
2607   G1CMBitMapClosure bitmap_closure(this, _cm);
2608   G1CMOopClosure cm_oop_closure(_g1h, this);
2609   set_cm_oop_closure(&amp;cm_oop_closure);
2610 
2611   if (_cm-&gt;has_overflown()) {
2612     // This can happen if the mark stack overflows during a GC pause
2613     // and this task, after a yield point, restarts. We have to abort
2614     // as we need to get into the overflow protocol which happens
2615     // right at the end of this task.
2616     set_has_aborted();
2617   }
2618 
2619   // First drain any available SATB buffers. After this, we will not
2620   // look at SATB buffers before the next invocation of this method.
2621   // If enough completed SATB buffers are queued up, the regular clock
2622   // will abort this task so that it restarts.
2623   drain_satb_buffers();
2624   // ...then partially drain the local queue and the global stack
2625   drain_local_queue(true);
2626   drain_global_stack(true);
2627 
2628   do {
2629     if (!has_aborted() &amp;&amp; _curr_region != NULL) {
2630       // This means that we&#39;re already holding on to a region.
2631       assert(_finger != NULL, &quot;if region is not NULL, then the finger &quot;
2632              &quot;should not be NULL either&quot;);
2633 
2634       // We might have restarted this task after an evacuation pause
2635       // which might have evacuated the region we&#39;re holding on to
2636       // underneath our feet. Let&#39;s read its limit again to make sure
2637       // that we do not iterate over a region of the heap that
2638       // contains garbage (update_region_limit() will also move
2639       // _finger to the start of the region if it is found empty).
2640       update_region_limit();
2641       // We will start from _finger not from the start of the region,
2642       // as we might be restarting this task after aborting half-way
2643       // through scanning this region. In this case, _finger points to
2644       // the address where we last found a marked object. If this is a
2645       // fresh region, _finger points to start().
2646       MemRegion mr = MemRegion(_finger, _region_limit);
2647 
2648       assert(!_curr_region-&gt;is_humongous() || mr.start() == _curr_region-&gt;bottom(),
2649              &quot;humongous regions should go around loop once only&quot;);
2650 
2651       // Some special cases:
2652       // If the memory region is empty, we can just give up the region.
2653       // If the current region is humongous then we only need to check
2654       // the bitmap for the bit associated with the start of the object,
2655       // scan the object if it&#39;s live, and give up the region.
2656       // Otherwise, let&#39;s iterate over the bitmap of the part of the region
2657       // that is left.
2658       // If the iteration is successful, give up the region.
2659       if (mr.is_empty()) {
2660         giveup_current_region();
2661         abort_marking_if_regular_check_fail();
2662       } else if (_curr_region-&gt;is_humongous() &amp;&amp; mr.start() == _curr_region-&gt;bottom()) {
2663         if (_next_mark_bitmap-&gt;is_marked(mr.start())) {
2664           // The object is marked - apply the closure
2665           bitmap_closure.do_addr(mr.start());
2666         }
2667         // Even if this task aborted while scanning the humongous object
2668         // we can (and should) give up the current region.
2669         giveup_current_region();
2670         abort_marking_if_regular_check_fail();
2671       } else if (_next_mark_bitmap-&gt;iterate(&amp;bitmap_closure, mr)) {
2672         giveup_current_region();
2673         abort_marking_if_regular_check_fail();
2674       } else {
2675         assert(has_aborted(), &quot;currently the only way to do so&quot;);
2676         // The only way to abort the bitmap iteration is to return
2677         // false from the do_bit() method. However, inside the
2678         // do_bit() method we move the _finger to point to the
2679         // object currently being looked at. So, if we bail out, we
2680         // have definitely set _finger to something non-null.
2681         assert(_finger != NULL, &quot;invariant&quot;);
2682 
2683         // Region iteration was actually aborted. So now _finger
2684         // points to the address of the object we last scanned. If we
2685         // leave it there, when we restart this task, we will rescan
2686         // the object. It is easy to avoid this. We move the finger by
2687         // enough to point to the next possible object header.
2688         assert(_finger &lt; _region_limit, &quot;invariant&quot;);
2689         HeapWord* const new_finger = _finger + ((oop)_finger)-&gt;size();
2690         // Check if bitmap iteration was aborted while scanning the last object
2691         if (new_finger &gt;= _region_limit) {
2692           giveup_current_region();
2693         } else {
2694           move_finger_to(new_finger);
2695         }
2696       }
2697     }
2698     // At this point we have either completed iterating over the
2699     // region we were holding on to, or we have aborted.
2700 
2701     // We then partially drain the local queue and the global stack.
2702     // (Do we really need this?)
2703     drain_local_queue(true);
2704     drain_global_stack(true);
2705 
2706     // Read the note on the claim_region() method on why it might
2707     // return NULL with potentially more regions available for
2708     // claiming and why we have to check out_of_regions() to determine
2709     // whether we&#39;re done or not.
2710     while (!has_aborted() &amp;&amp; _curr_region == NULL &amp;&amp; !_cm-&gt;out_of_regions()) {
2711       // We are going to try to claim a new region. We should have
2712       // given up on the previous one.
2713       // Separated the asserts so that we know which one fires.
2714       assert(_curr_region  == NULL, &quot;invariant&quot;);
2715       assert(_finger       == NULL, &quot;invariant&quot;);
2716       assert(_region_limit == NULL, &quot;invariant&quot;);
2717       HeapRegion* claimed_region = _cm-&gt;claim_region(_worker_id);
2718       if (claimed_region != NULL) {
2719         // Yes, we managed to claim one
2720         setup_for_region(claimed_region);
2721         assert(_curr_region == claimed_region, &quot;invariant&quot;);
2722       }
2723       // It is important to call the regular clock here. It might take
2724       // a while to claim a region if, for example, we hit a large
2725       // block of empty regions. So we need to call the regular clock
2726       // method once round the loop to make sure it&#39;s called
2727       // frequently enough.
2728       abort_marking_if_regular_check_fail();
2729     }
2730 
2731     if (!has_aborted() &amp;&amp; _curr_region == NULL) {
2732       assert(_cm-&gt;out_of_regions(),
2733              &quot;at this point we should be out of regions&quot;);
2734     }
2735   } while ( _curr_region != NULL &amp;&amp; !has_aborted());
2736 
2737   if (!has_aborted()) {
2738     // We cannot check whether the global stack is empty, since other
2739     // tasks might be pushing objects to it concurrently.
2740     assert(_cm-&gt;out_of_regions(),
2741            &quot;at this point we should be out of regions&quot;);
2742     // Try to reduce the number of available SATB buffers so that
2743     // remark has less work to do.
2744     drain_satb_buffers();
2745   }
2746 
2747   // Since we&#39;ve done everything else, we can now totally drain the
2748   // local queue and global stack.
2749   drain_local_queue(false);
2750   drain_global_stack(false);
2751 
2752   // Attempt at work stealing from other task&#39;s queues.
2753   if (do_stealing &amp;&amp; !has_aborted()) {
2754     // We have not aborted. This means that we have finished all that
2755     // we could. Let&#39;s try to do some stealing...
2756 
2757     // We cannot check whether the global stack is empty, since other
2758     // tasks might be pushing objects to it concurrently.
2759     assert(_cm-&gt;out_of_regions() &amp;&amp; _task_queue-&gt;size() == 0,
2760            &quot;only way to reach here&quot;);
2761     while (!has_aborted()) {
2762       G1TaskQueueEntry entry;
2763       if (_cm-&gt;try_stealing(_worker_id, entry)) {
2764         scan_task_entry(entry);
2765 
2766         // And since we&#39;re towards the end, let&#39;s totally drain the
2767         // local queue and global stack.
2768         drain_local_queue(false);
2769         drain_global_stack(false);
2770       } else {
2771         break;
2772       }
2773     }
2774   }
2775 
2776   // We still haven&#39;t aborted. Now, let&#39;s try to get into the
2777   // termination protocol.
2778   if (do_termination &amp;&amp; !has_aborted()) {
2779     // We cannot check whether the global stack is empty, since other
2780     // tasks might be concurrently pushing objects on it.
2781     // Separated the asserts so that we know which one fires.
2782     assert(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2783     assert(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2784     _termination_start_time_ms = os::elapsedVTime() * 1000.0;
2785 
2786     // The G1CMTask class also extends the TerminatorTerminator class,
2787     // hence its should_exit_termination() method will also decide
2788     // whether to exit the termination protocol or not.
2789     bool finished = (is_serial ||
2790                      _cm-&gt;terminator()-&gt;offer_termination(this));
2791     double termination_end_time_ms = os::elapsedVTime() * 1000.0;
2792     _termination_time_ms +=
2793       termination_end_time_ms - _termination_start_time_ms;
2794 
2795     if (finished) {
2796       // We&#39;re all done.
2797 
2798       // We can now guarantee that the global stack is empty, since
2799       // all other tasks have finished. We separated the guarantees so
2800       // that, if a condition is false, we can immediately find out
2801       // which one.
2802       guarantee(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2803       guarantee(_cm-&gt;mark_stack_empty(), &quot;only way to reach here&quot;);
2804       guarantee(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2805       guarantee(!_cm-&gt;has_overflown(), &quot;only way to reach here&quot;);
2806       guarantee(!has_aborted(), &quot;should never happen if termination has completed&quot;);
2807     } else {
2808       // Apparently there&#39;s more work to do. Let&#39;s abort this task. It
2809       // will restart it and we can hopefully find more things to do.
2810       set_has_aborted();
2811     }
2812   }
2813 
2814   // Mainly for debugging purposes to make sure that a pointer to the
2815   // closure which was statically allocated in this frame doesn&#39;t
2816   // escape it by accident.
2817   set_cm_oop_closure(NULL);
2818   double end_time_ms = os::elapsedVTime() * 1000.0;
2819   double elapsed_time_ms = end_time_ms - _start_time_ms;
2820   // Update the step history.
2821   _step_times_ms.add(elapsed_time_ms);
2822 
2823   if (has_aborted()) {
2824     // The task was aborted for some reason.
2825     if (_has_timed_out) {
2826       double diff_ms = elapsed_time_ms - _time_target_ms;
2827       // Keep statistics of how well we did with respect to hitting
2828       // our target only if we actually timed out (if we aborted for
2829       // other reasons, then the results might get skewed).
2830       _marking_step_diff_ms.add(diff_ms);
2831     }
2832 
2833     if (_cm-&gt;has_overflown()) {
2834       // This is the interesting one. We aborted because a global
2835       // overflow was raised. This means we have to restart the
2836       // marking phase and start iterating over regions. However, in
2837       // order to do this we have to make sure that all tasks stop
2838       // what they are doing and re-initialize in a safe manner. We
2839       // will achieve this with the use of two barrier sync points.
2840 
2841       if (!is_serial) {
2842         // We only need to enter the sync barrier if being called
2843         // from a parallel context
2844         _cm-&gt;enter_first_sync_barrier(_worker_id);
2845 
2846         // When we exit this sync barrier we know that all tasks have
2847         // stopped doing marking work. So, it&#39;s now safe to
2848         // re-initialize our data structures.
2849       }
2850 
2851       clear_region_fields();
2852       flush_mark_stats_cache();
2853 
2854       if (!is_serial) {
2855         // If we&#39;re executing the concurrent phase of marking, reset the marking
2856         // state; otherwise the marking state is reset after reference processing,
2857         // during the remark pause.
2858         // If we reset here as a result of an overflow during the remark we will
2859         // see assertion failures from any subsequent set_concurrency_and_phase()
2860         // calls.
2861         if (_cm-&gt;concurrent() &amp;&amp; _worker_id == 0) {
2862           // Worker 0 is responsible for clearing the global data structures because
2863           // of an overflow. During STW we should not clear the overflow flag (in
2864           // G1ConcurrentMark::reset_marking_state()) since we rely on it being true when we exit
2865           // method to abort the pause and restart concurrent marking.
2866           _cm-&gt;reset_marking_for_restart();
2867 
2868           log_info(gc, marking)(&quot;Concurrent Mark reset for overflow&quot;);
2869         }
2870 
2871         // ...and enter the second barrier.
2872         _cm-&gt;enter_second_sync_barrier(_worker_id);
2873       }
2874       // At this point, if we&#39;re during the concurrent phase of
2875       // marking, everything has been re-initialized and we&#39;re
2876       // ready to restart.
2877     }
2878   }
2879 }
2880 
2881 G1CMTask::G1CMTask(uint worker_id,
2882                    G1ConcurrentMark* cm,
2883                    G1CMTaskQueue* task_queue,
2884                    G1RegionMarkStats* mark_stats,
2885                    uint max_regions) :
2886   _objArray_processor(this),
2887   _worker_id(worker_id),
2888   _g1h(G1CollectedHeap::heap()),
2889   _cm(cm),
2890   _next_mark_bitmap(NULL),
2891   _task_queue(task_queue),
2892   _mark_stats_cache(mark_stats, max_regions, RegionMarkStatsCacheSize),
2893   _calls(0),
2894   _time_target_ms(0.0),
2895   _start_time_ms(0.0),
2896   _cm_oop_closure(NULL),
2897   _curr_region(NULL),
2898   _finger(NULL),
2899   _region_limit(NULL),
2900   _words_scanned(0),
2901   _words_scanned_limit(0),
2902   _real_words_scanned_limit(0),
2903   _refs_reached(0),
2904   _refs_reached_limit(0),
2905   _real_refs_reached_limit(0),
2906   _has_aborted(false),
2907   _has_timed_out(false),
2908   _draining_satb_buffers(false),
2909   _step_times_ms(),
2910   _elapsed_time_ms(0.0),
2911   _termination_time_ms(0.0),
2912   _termination_start_time_ms(0.0),
2913   _marking_step_diff_ms()
2914 {
2915   guarantee(task_queue != NULL, &quot;invariant&quot;);
2916 
2917   _marking_step_diff_ms.add(0.5);
2918 }
2919 
2920 // These are formatting macros that are used below to ensure
2921 // consistent formatting. The *_H_* versions are used to format the
2922 // header for a particular value and they should be kept consistent
2923 // with the corresponding macro. Also note that most of the macros add
2924 // the necessary white space (as a prefix) which makes them a bit
2925 // easier to compose.
2926 
2927 // All the output lines are prefixed with this string to be able to
2928 // identify them easily in a large log file.
2929 #define G1PPRL_LINE_PREFIX            &quot;###&quot;
2930 
2931 #define G1PPRL_ADDR_BASE_FORMAT    &quot; &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT
2932 #ifdef _LP64
2933 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %37s&quot;
2934 #else // _LP64
2935 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %21s&quot;
2936 #endif // _LP64
2937 
2938 // For per-region info
2939 #define G1PPRL_TYPE_FORMAT            &quot;   %-4s&quot;
2940 #define G1PPRL_TYPE_H_FORMAT          &quot;   %4s&quot;
2941 #define G1PPRL_STATE_FORMAT           &quot;   %-5s&quot;
2942 #define G1PPRL_STATE_H_FORMAT         &quot;   %5s&quot;
2943 #define G1PPRL_BYTE_FORMAT            &quot;  &quot; SIZE_FORMAT_W(9)
2944 #define G1PPRL_BYTE_H_FORMAT          &quot;  %9s&quot;
2945 #define G1PPRL_DOUBLE_FORMAT          &quot;  %14.1f&quot;
2946 #define G1PPRL_DOUBLE_H_FORMAT        &quot;  %14s&quot;
2947 
2948 // For summary info
2949 #define G1PPRL_SUM_ADDR_FORMAT(tag)    &quot;  &quot; tag &quot;:&quot; G1PPRL_ADDR_BASE_FORMAT
2950 #define G1PPRL_SUM_BYTE_FORMAT(tag)    &quot;  &quot; tag &quot;: &quot; SIZE_FORMAT
2951 #define G1PPRL_SUM_MB_FORMAT(tag)      &quot;  &quot; tag &quot;: %1.2f MB&quot;
2952 #define G1PPRL_SUM_MB_PERC_FORMAT(tag) G1PPRL_SUM_MB_FORMAT(tag) &quot; / %1.2f %%&quot;
2953 
2954 G1PrintRegionLivenessInfoClosure::G1PrintRegionLivenessInfoClosure(const char* phase_name) :
2955   _total_used_bytes(0), _total_capacity_bytes(0),
2956   _total_prev_live_bytes(0), _total_next_live_bytes(0),
2957   _total_remset_bytes(0), _total_strong_code_roots_bytes(0)
2958 {
2959   if (!log_is_enabled(Trace, gc, liveness)) {
2960     return;
2961   }
2962 
2963   G1CollectedHeap* g1h = G1CollectedHeap::heap();
2964   MemRegion g1_reserved = g1h-&gt;g1_reserved();
2965   double now = os::elapsedTime();
2966 
2967   // Print the header of the output.
2968   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; PHASE %s @ %1.3f&quot;, phase_name, now);
2969   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; HEAP&quot;
2970                           G1PPRL_SUM_ADDR_FORMAT(&quot;reserved&quot;)
2971                           G1PPRL_SUM_BYTE_FORMAT(&quot;region-size&quot;),
2972                           p2i(g1_reserved.start()), p2i(g1_reserved.end()),
2973                           HeapRegion::GrainBytes);
2974   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
2975   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2976                           G1PPRL_TYPE_H_FORMAT
2977                           G1PPRL_ADDR_BASE_H_FORMAT
2978                           G1PPRL_BYTE_H_FORMAT
2979                           G1PPRL_BYTE_H_FORMAT
2980                           G1PPRL_BYTE_H_FORMAT
2981                           G1PPRL_DOUBLE_H_FORMAT
2982                           G1PPRL_BYTE_H_FORMAT
2983                           G1PPRL_STATE_H_FORMAT
2984                           G1PPRL_BYTE_H_FORMAT,
2985                           &quot;type&quot;, &quot;address-range&quot;,
2986                           &quot;used&quot;, &quot;prev-live&quot;, &quot;next-live&quot;, &quot;gc-eff&quot;,
2987                           &quot;remset&quot;, &quot;state&quot;, &quot;code-roots&quot;);
2988   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2989                           G1PPRL_TYPE_H_FORMAT
2990                           G1PPRL_ADDR_BASE_H_FORMAT
2991                           G1PPRL_BYTE_H_FORMAT
2992                           G1PPRL_BYTE_H_FORMAT
2993                           G1PPRL_BYTE_H_FORMAT
2994                           G1PPRL_DOUBLE_H_FORMAT
2995                           G1PPRL_BYTE_H_FORMAT
2996                           G1PPRL_STATE_H_FORMAT
2997                           G1PPRL_BYTE_H_FORMAT,
2998                           &quot;&quot;, &quot;&quot;,
2999                           &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes/ms)&quot;,
3000                           &quot;(bytes)&quot;, &quot;&quot;, &quot;(bytes)&quot;);
3001 }
3002 
3003 bool G1PrintRegionLivenessInfoClosure::do_heap_region(HeapRegion* r) {
3004   if (!log_is_enabled(Trace, gc, liveness)) {
3005     return false;
3006   }
3007 
3008   const char* type       = r-&gt;get_type_str();
3009   HeapWord* bottom       = r-&gt;bottom();
3010   HeapWord* end          = r-&gt;end();
3011   size_t capacity_bytes  = r-&gt;capacity();
3012   size_t used_bytes      = r-&gt;used();
3013   size_t prev_live_bytes = r-&gt;live_bytes();
3014   size_t next_live_bytes = r-&gt;next_live_bytes();
3015   double gc_eff          = r-&gt;gc_efficiency();
3016   size_t remset_bytes    = r-&gt;rem_set()-&gt;mem_size();
3017   size_t strong_code_roots_bytes = r-&gt;rem_set()-&gt;strong_code_roots_mem_size();
3018   const char* remset_type = r-&gt;rem_set()-&gt;get_short_state_str();
3019 
3020   _total_used_bytes      += used_bytes;
3021   _total_capacity_bytes  += capacity_bytes;
3022   _total_prev_live_bytes += prev_live_bytes;
3023   _total_next_live_bytes += next_live_bytes;
3024   _total_remset_bytes    += remset_bytes;
3025   _total_strong_code_roots_bytes += strong_code_roots_bytes;
3026 
3027   // Print a line for this particular region.
3028   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3029                           G1PPRL_TYPE_FORMAT
3030                           G1PPRL_ADDR_BASE_FORMAT
3031                           G1PPRL_BYTE_FORMAT
3032                           G1PPRL_BYTE_FORMAT
3033                           G1PPRL_BYTE_FORMAT
3034                           G1PPRL_DOUBLE_FORMAT
3035                           G1PPRL_BYTE_FORMAT
3036                           G1PPRL_STATE_FORMAT
3037                           G1PPRL_BYTE_FORMAT,
3038                           type, p2i(bottom), p2i(end),
3039                           used_bytes, prev_live_bytes, next_live_bytes, gc_eff,
3040                           remset_bytes, remset_type, strong_code_roots_bytes);
3041 
3042   return false;
3043 }
3044 
3045 G1PrintRegionLivenessInfoClosure::~G1PrintRegionLivenessInfoClosure() {
3046   if (!log_is_enabled(Trace, gc, liveness)) {
3047     return;
3048   }
3049 
3050   // add static memory usages to remembered set sizes
3051   _total_remset_bytes += HeapRegionRemSet::fl_mem_size() + HeapRegionRemSet::static_mem_size();
3052   // Print the footer of the output.
3053   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
3054   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3055                          &quot; SUMMARY&quot;
3056                          G1PPRL_SUM_MB_FORMAT(&quot;capacity&quot;)
3057                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;used&quot;)
3058                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;prev-live&quot;)
3059                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;next-live&quot;)
3060                          G1PPRL_SUM_MB_FORMAT(&quot;remset&quot;)
3061                          G1PPRL_SUM_MB_FORMAT(&quot;code-roots&quot;),
3062                          bytes_to_mb(_total_capacity_bytes),
3063                          bytes_to_mb(_total_used_bytes),
3064                          percent_of(_total_used_bytes, _total_capacity_bytes),
3065                          bytes_to_mb(_total_prev_live_bytes),
3066                          percent_of(_total_prev_live_bytes, _total_capacity_bytes),
3067                          bytes_to_mb(_total_next_live_bytes),
3068                          percent_of(_total_next_live_bytes, _total_capacity_bytes),
3069                          bytes_to_mb(_total_remset_bytes),
3070                          bytes_to_mb(_total_strong_code_roots_bytes));
3071 }
    </pre>
  </body>
</html>