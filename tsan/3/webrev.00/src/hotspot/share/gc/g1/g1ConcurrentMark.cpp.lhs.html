<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1ConcurrentMark.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  30 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  31 #include &quot;gc/g1/g1ConcurrentMark.inline.hpp&quot;
  32 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  33 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  34 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  35 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  36 #include &quot;gc/g1/g1Policy.hpp&quot;
  37 #include &quot;gc/g1/g1RegionMarkStatsCache.inline.hpp&quot;
  38 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  39 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
<a name="2" id="anc2"></a>
  40 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  41 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  42 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  43 #include &quot;gc/shared/gcId.hpp&quot;
  44 #include &quot;gc/shared/gcTimer.hpp&quot;
<a name="3" id="anc3"></a><span class="line-removed">  45 #include &quot;gc/shared/gcTrace.hpp&quot;</span>
  46 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  47 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  48 #include &quot;gc/shared/genOopClosures.inline.hpp&quot;
  49 #include &quot;gc/shared/referencePolicy.hpp&quot;
  50 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  51 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
<a name="4" id="anc4"></a>
  52 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  53 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  54 #include &quot;gc/shared/workerPolicy.hpp&quot;
  55 #include &quot;include/jvm.h&quot;
  56 #include &quot;logging/log.hpp&quot;
  57 #include &quot;memory/allocation.hpp&quot;
<a name="5" id="anc5"></a>
  58 #include &quot;memory/resourceArea.hpp&quot;
<a name="6" id="anc6"></a>
  59 #include &quot;oops/access.inline.hpp&quot;
  60 #include &quot;oops/oop.inline.hpp&quot;
  61 #include &quot;runtime/atomic.hpp&quot;
  62 #include &quot;runtime/handles.inline.hpp&quot;
  63 #include &quot;runtime/java.hpp&quot;
<a name="7" id="anc7"></a>
  64 #include &quot;runtime/prefetch.inline.hpp&quot;
  65 #include &quot;services/memTracker.hpp&quot;
  66 #include &quot;utilities/align.hpp&quot;
  67 #include &quot;utilities/growableArray.hpp&quot;
  68 
  69 bool G1CMBitMapClosure::do_addr(HeapWord* const addr) {
  70   assert(addr &lt; _cm-&gt;finger(), &quot;invariant&quot;);
  71   assert(addr &gt;= _task-&gt;finger(), &quot;invariant&quot;);
  72 
  73   // We move that task&#39;s local finger along.
  74   _task-&gt;move_finger_to(addr);
  75 
  76   _task-&gt;scan_task_entry(G1TaskQueueEntry::from_oop(oop(addr)));
  77   // we only partially drain the local queue and global stack
  78   _task-&gt;drain_local_queue(true);
  79   _task-&gt;drain_global_stack(true);
  80 
  81   // if the has_aborted flag has been raised, we need to bail out of
  82   // the iteration
  83   return !_task-&gt;has_aborted();
  84 }
  85 
  86 G1CMMarkStack::G1CMMarkStack() :
  87   _max_chunk_capacity(0),
  88   _base(NULL),
  89   _chunk_capacity(0) {
  90   set_empty();
  91 }
  92 
  93 bool G1CMMarkStack::resize(size_t new_capacity) {
  94   assert(is_empty(), &quot;Only resize when stack is empty.&quot;);
  95   assert(new_capacity &lt;= _max_chunk_capacity,
  96          &quot;Trying to resize stack to &quot; SIZE_FORMAT &quot; chunks when the maximum is &quot; SIZE_FORMAT, new_capacity, _max_chunk_capacity);
  97 
  98   TaskQueueEntryChunk* new_base = MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::allocate_or_null(new_capacity, mtGC);
  99 
 100   if (new_base == NULL) {
 101     log_warning(gc)(&quot;Failed to reserve memory for new overflow mark stack with &quot; SIZE_FORMAT &quot; chunks and size &quot; SIZE_FORMAT &quot;B.&quot;, new_capacity, new_capacity * sizeof(TaskQueueEntryChunk));
 102     return false;
 103   }
 104   // Release old mapping.
 105   if (_base != NULL) {
 106     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 107   }
 108 
 109   _base = new_base;
 110   _chunk_capacity = new_capacity;
 111   set_empty();
 112 
 113   return true;
 114 }
 115 
 116 size_t G1CMMarkStack::capacity_alignment() {
 117   return (size_t)lcm(os::vm_allocation_granularity(), sizeof(TaskQueueEntryChunk)) / sizeof(G1TaskQueueEntry);
 118 }
 119 
 120 bool G1CMMarkStack::initialize(size_t initial_capacity, size_t max_capacity) {
 121   guarantee(_max_chunk_capacity == 0, &quot;G1CMMarkStack already initialized.&quot;);
 122 
 123   size_t const TaskEntryChunkSizeInVoidStar = sizeof(TaskQueueEntryChunk) / sizeof(G1TaskQueueEntry);
 124 
 125   _max_chunk_capacity = align_up(max_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 126   size_t initial_chunk_capacity = align_up(initial_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 127 
 128   guarantee(initial_chunk_capacity &lt;= _max_chunk_capacity,
 129             &quot;Maximum chunk capacity &quot; SIZE_FORMAT &quot; smaller than initial capacity &quot; SIZE_FORMAT,
 130             _max_chunk_capacity,
 131             initial_chunk_capacity);
 132 
 133   log_debug(gc)(&quot;Initialize mark stack with &quot; SIZE_FORMAT &quot; chunks, maximum &quot; SIZE_FORMAT,
 134                 initial_chunk_capacity, _max_chunk_capacity);
 135 
 136   return resize(initial_chunk_capacity);
 137 }
 138 
 139 void G1CMMarkStack::expand() {
 140   if (_chunk_capacity == _max_chunk_capacity) {
 141     log_debug(gc)(&quot;Can not expand overflow mark stack further, already at maximum capacity of &quot; SIZE_FORMAT &quot; chunks.&quot;, _chunk_capacity);
 142     return;
 143   }
 144   size_t old_capacity = _chunk_capacity;
 145   // Double capacity if possible
 146   size_t new_capacity = MIN2(old_capacity * 2, _max_chunk_capacity);
 147 
 148   if (resize(new_capacity)) {
 149     log_debug(gc)(&quot;Expanded mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 150                   old_capacity, new_capacity);
 151   } else {
 152     log_warning(gc)(&quot;Failed to expand mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 153                     old_capacity, new_capacity);
 154   }
 155 }
 156 
 157 G1CMMarkStack::~G1CMMarkStack() {
 158   if (_base != NULL) {
 159     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 160   }
 161 }
 162 
 163 void G1CMMarkStack::add_chunk_to_list(TaskQueueEntryChunk* volatile* list, TaskQueueEntryChunk* elem) {
 164   elem-&gt;next = *list;
 165   *list = elem;
 166 }
 167 
 168 void G1CMMarkStack::add_chunk_to_chunk_list(TaskQueueEntryChunk* elem) {
<a name="8" id="anc8"></a><span class="line-modified"> 169   MutexLockerEx x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);</span>
 170   add_chunk_to_list(&amp;_chunk_list, elem);
 171   _chunks_in_chunk_list++;
 172 }
 173 
 174 void G1CMMarkStack::add_chunk_to_free_list(TaskQueueEntryChunk* elem) {
<a name="9" id="anc9"></a><span class="line-modified"> 175   MutexLockerEx x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);</span>
 176   add_chunk_to_list(&amp;_free_list, elem);
 177 }
 178 
 179 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_list(TaskQueueEntryChunk* volatile* list) {
 180   TaskQueueEntryChunk* result = *list;
 181   if (result != NULL) {
 182     *list = (*list)-&gt;next;
 183   }
 184   return result;
 185 }
 186 
 187 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_chunk_list() {
<a name="10" id="anc10"></a><span class="line-modified"> 188   MutexLockerEx x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);</span>
 189   TaskQueueEntryChunk* result = remove_chunk_from_list(&amp;_chunk_list);
 190   if (result != NULL) {
 191     _chunks_in_chunk_list--;
 192   }
 193   return result;
 194 }
 195 
 196 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_free_list() {
<a name="11" id="anc11"></a><span class="line-modified"> 197   MutexLockerEx x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);</span>
 198   return remove_chunk_from_list(&amp;_free_list);
 199 }
 200 
 201 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::allocate_new_chunk() {
 202   // This dirty read of _hwm is okay because we only ever increase the _hwm in parallel code.
 203   // Further this limits _hwm to a value of _chunk_capacity + #threads, avoiding
 204   // wraparound of _hwm.
 205   if (_hwm &gt;= _chunk_capacity) {
 206     return NULL;
 207   }
 208 
<a name="12" id="anc12"></a><span class="line-modified"> 209   size_t cur_idx = Atomic::add(1u, &amp;_hwm) - 1;</span>
 210   if (cur_idx &gt;= _chunk_capacity) {
 211     return NULL;
 212   }
 213 
 214   TaskQueueEntryChunk* result = ::new (&amp;_base[cur_idx]) TaskQueueEntryChunk;
 215   result-&gt;next = NULL;
 216   return result;
 217 }
 218 
 219 bool G1CMMarkStack::par_push_chunk(G1TaskQueueEntry* ptr_arr) {
 220   // Get a new chunk.
 221   TaskQueueEntryChunk* new_chunk = remove_chunk_from_free_list();
 222 
 223   if (new_chunk == NULL) {
 224     // Did not get a chunk from the free list. Allocate from backing memory.
 225     new_chunk = allocate_new_chunk();
 226 
 227     if (new_chunk == NULL) {
 228       return false;
 229     }
 230   }
 231 
 232   Copy::conjoint_memory_atomic(ptr_arr, new_chunk-&gt;data, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 233 
 234   add_chunk_to_chunk_list(new_chunk);
 235 
 236   return true;
 237 }
 238 
 239 bool G1CMMarkStack::par_pop_chunk(G1TaskQueueEntry* ptr_arr) {
 240   TaskQueueEntryChunk* cur = remove_chunk_from_chunk_list();
 241 
 242   if (cur == NULL) {
 243     return false;
 244   }
 245 
 246   Copy::conjoint_memory_atomic(cur-&gt;data, ptr_arr, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 247 
 248   add_chunk_to_free_list(cur);
 249   return true;
 250 }
 251 
 252 void G1CMMarkStack::set_empty() {
 253   _chunks_in_chunk_list = 0;
 254   _hwm = 0;
 255   _chunk_list = NULL;
 256   _free_list = NULL;
 257 }
 258 
<a name="13" id="anc13"></a><span class="line-modified"> 259 G1CMRootRegions::G1CMRootRegions(uint const max_regions) :</span>
<span class="line-modified"> 260   _root_regions(NEW_C_HEAP_ARRAY(HeapRegion*, max_regions, mtGC)),</span>
<span class="line-modified"> 261   _max_regions(max_regions),</span>
<span class="line-modified"> 262   _num_root_regions(0),</span>
<span class="line-modified"> 263   _claimed_root_regions(0),</span>
<span class="line-modified"> 264   _scan_in_progress(false),</span>
<span class="line-modified"> 265   _should_abort(false) { }</span>
 266 
<a name="14" id="anc14"></a><span class="line-modified"> 267 G1CMRootRegions::~G1CMRootRegions() {</span>
<span class="line-modified"> 268   FREE_C_HEAP_ARRAY(HeapRegion*, _max_regions);</span>
 269 }
 270 
<a name="15" id="anc15"></a><span class="line-modified"> 271 void G1CMRootRegions::reset() {</span>
 272   _num_root_regions = 0;
 273 }
 274 
<a name="16" id="anc16"></a><span class="line-modified"> 275 void G1CMRootRegions::add(HeapRegion* hr) {</span>
 276   assert_at_safepoint();
<a name="17" id="anc17"></a><span class="line-modified"> 277   size_t idx = Atomic::add((size_t)1, &amp;_num_root_regions) - 1;</span>
<span class="line-modified"> 278   assert(idx &lt; _max_regions, &quot;Trying to add more root regions than there is space &quot; SIZE_FORMAT, _max_regions);</span>
<span class="line-modified"> 279   _root_regions[idx] = hr;</span>



 280 }
 281 
<a name="18" id="anc18"></a><span class="line-modified"> 282 void G1CMRootRegions::prepare_for_scan() {</span>
 283   assert(!scan_in_progress(), &quot;pre-condition&quot;);
 284 
 285   _scan_in_progress = _num_root_regions &gt; 0;
 286 
 287   _claimed_root_regions = 0;
 288   _should_abort = false;
 289 }
 290 
<a name="19" id="anc19"></a><span class="line-modified"> 291 HeapRegion* G1CMRootRegions::claim_next() {</span>
 292   if (_should_abort) {
 293     // If someone has set the should_abort flag, we return NULL to
 294     // force the caller to bail out of their loop.
 295     return NULL;
 296   }
 297 
 298   if (_claimed_root_regions &gt;= _num_root_regions) {
 299     return NULL;
 300   }
 301 
<a name="20" id="anc20"></a><span class="line-modified"> 302   size_t claimed_index = Atomic::add((size_t)1, &amp;_claimed_root_regions) - 1;</span>
 303   if (claimed_index &lt; _num_root_regions) {
<a name="21" id="anc21"></a><span class="line-modified"> 304     return _root_regions[claimed_index];</span>
 305   }
 306   return NULL;
 307 }
 308 
<a name="22" id="anc22"></a><span class="line-modified"> 309 uint G1CMRootRegions::num_root_regions() const {</span>
 310   return (uint)_num_root_regions;
 311 }
 312 
<a name="23" id="anc23"></a><span class="line-modified"> 313 void G1CMRootRegions::notify_scan_done() {</span>
<span class="line-modified"> 314   MutexLockerEx x(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);</span>
 315   _scan_in_progress = false;
 316   RootRegionScan_lock-&gt;notify_all();
 317 }
 318 
<a name="24" id="anc24"></a><span class="line-modified"> 319 void G1CMRootRegions::cancel_scan() {</span>
 320   notify_scan_done();
 321 }
 322 
<a name="25" id="anc25"></a><span class="line-modified"> 323 void G1CMRootRegions::scan_finished() {</span>
 324   assert(scan_in_progress(), &quot;pre-condition&quot;);
 325 
 326   if (!_should_abort) {
 327     assert(_claimed_root_regions &gt;= num_root_regions(),
 328            &quot;we should have claimed all root regions, claimed &quot; SIZE_FORMAT &quot;, length = %u&quot;,
 329            _claimed_root_regions, num_root_regions());
 330   }
 331 
 332   notify_scan_done();
 333 }
 334 
<a name="26" id="anc26"></a><span class="line-modified"> 335 bool G1CMRootRegions::wait_until_scan_finished() {</span>
 336   if (!scan_in_progress()) {
 337     return false;
 338   }
 339 
 340   {
<a name="27" id="anc27"></a><span class="line-modified"> 341     MutexLockerEx x(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);</span>
 342     while (scan_in_progress()) {
<a name="28" id="anc28"></a><span class="line-modified"> 343       RootRegionScan_lock-&gt;wait(Mutex::_no_safepoint_check_flag);</span>
 344     }
 345   }
 346   return true;
 347 }
 348 
 349 // Returns the maximum number of workers to be used in a concurrent
 350 // phase based on the number of GC workers being used in a STW
 351 // phase.
 352 static uint scale_concurrent_worker_threads(uint num_gc_workers) {
 353   return MAX2((num_gc_workers + 2) / 4, 1U);
 354 }
 355 
 356 G1ConcurrentMark::G1ConcurrentMark(G1CollectedHeap* g1h,
 357                                    G1RegionToSpaceMapper* prev_bitmap_storage,
 358                                    G1RegionToSpaceMapper* next_bitmap_storage) :
 359   // _cm_thread set inside the constructor
 360   _g1h(g1h),
 361   _completed_initialization(false),
 362 
 363   _mark_bitmap_1(),
 364   _mark_bitmap_2(),
 365   _prev_mark_bitmap(&amp;_mark_bitmap_1),
 366   _next_mark_bitmap(&amp;_mark_bitmap_2),
 367 
 368   _heap(_g1h-&gt;reserved_region()),
 369 
 370   _root_regions(_g1h-&gt;max_regions()),
 371 
 372   _global_mark_stack(),
 373 
 374   // _finger set in set_non_marking_state
 375 
 376   _worker_id_offset(G1DirtyCardQueueSet::num_par_ids() + G1ConcRefinementThreads),
 377   _max_num_tasks(ParallelGCThreads),
 378   // _num_active_tasks set in set_non_marking_state()
 379   // _tasks set inside the constructor
 380 
 381   _task_queues(new G1CMTaskQueueSet((int) _max_num_tasks)),
 382   _terminator((int) _max_num_tasks, _task_queues),
 383 
 384   _first_overflow_barrier_sync(),
 385   _second_overflow_barrier_sync(),
 386 
 387   _has_overflown(false),
 388   _concurrent(false),
 389   _has_aborted(false),
 390   _restart_for_overflow(false),
 391   _gc_timer_cm(new (ResourceObj::C_HEAP, mtGC) ConcurrentGCTimer()),
 392   _gc_tracer_cm(new (ResourceObj::C_HEAP, mtGC) G1OldTracer()),
 393 
 394   // _verbose_level set below
 395 
 396   _init_times(),
 397   _remark_times(),
 398   _remark_mark_times(),
 399   _remark_weak_ref_times(),
 400   _cleanup_times(),
 401   _total_cleanup_time(0.0),
 402 
 403   _accum_task_vtime(NULL),
 404 
 405   _concurrent_workers(NULL),
 406   _num_concurrent_workers(0),
 407   _max_concurrent_workers(0),
 408 
 409   _region_mark_stats(NEW_C_HEAP_ARRAY(G1RegionMarkStats, _g1h-&gt;max_regions(), mtGC)),
 410   _top_at_rebuild_starts(NEW_C_HEAP_ARRAY(HeapWord*, _g1h-&gt;max_regions(), mtGC))
 411 {
 412   _mark_bitmap_1.initialize(g1h-&gt;reserved_region(), prev_bitmap_storage);
 413   _mark_bitmap_2.initialize(g1h-&gt;reserved_region(), next_bitmap_storage);
 414 
 415   // Create &amp; start ConcurrentMark thread.
 416   _cm_thread = new G1ConcurrentMarkThread(this);
 417   if (_cm_thread-&gt;osthread() == NULL) {
 418     vm_shutdown_during_initialization(&quot;Could not create ConcurrentMarkThread&quot;);
 419   }
 420 
 421   assert(CGC_lock != NULL, &quot;CGC_lock must be initialized&quot;);
 422 
 423   if (FLAG_IS_DEFAULT(ConcGCThreads) || ConcGCThreads == 0) {
 424     // Calculate the number of concurrent worker threads by scaling
 425     // the number of parallel GC threads.
 426     uint marking_thread_num = scale_concurrent_worker_threads(ParallelGCThreads);
<a name="29" id="anc29"></a><span class="line-modified"> 427     FLAG_SET_ERGO(uint, ConcGCThreads, marking_thread_num);</span>
 428   }
 429 
 430   assert(ConcGCThreads &gt; 0, &quot;ConcGCThreads have been set.&quot;);
 431   if (ConcGCThreads &gt; ParallelGCThreads) {
 432     log_warning(gc)(&quot;More ConcGCThreads (%u) than ParallelGCThreads (%u).&quot;,
 433                     ConcGCThreads, ParallelGCThreads);
 434     return;
 435   }
 436 
 437   log_debug(gc)(&quot;ConcGCThreads: %u offset %u&quot;, ConcGCThreads, _worker_id_offset);
 438   log_debug(gc)(&quot;ParallelGCThreads: %u&quot;, ParallelGCThreads);
 439 
 440   _num_concurrent_workers = ConcGCThreads;
 441   _max_concurrent_workers = _num_concurrent_workers;
 442 
 443   _concurrent_workers = new WorkGang(&quot;G1 Conc&quot;, _max_concurrent_workers, false, true);
 444   _concurrent_workers-&gt;initialize_workers();
 445 
 446   if (FLAG_IS_DEFAULT(MarkStackSize)) {
 447     size_t mark_stack_size =
 448       MIN2(MarkStackSizeMax,
 449           MAX2(MarkStackSize, (size_t) (_max_concurrent_workers * TASKQUEUE_SIZE)));
 450     // Verify that the calculated value for MarkStackSize is in range.
 451     // It would be nice to use the private utility routine from Arguments.
 452     if (!(mark_stack_size &gt;= 1 &amp;&amp; mark_stack_size &lt;= MarkStackSizeMax)) {
 453       log_warning(gc)(&quot;Invalid value calculated for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 454                       &quot;must be between 1 and &quot; SIZE_FORMAT,
 455                       mark_stack_size, MarkStackSizeMax);
 456       return;
 457     }
<a name="30" id="anc30"></a><span class="line-modified"> 458     FLAG_SET_ERGO(size_t, MarkStackSize, mark_stack_size);</span>
 459   } else {
 460     // Verify MarkStackSize is in range.
 461     if (FLAG_IS_CMDLINE(MarkStackSize)) {
 462       if (FLAG_IS_DEFAULT(MarkStackSizeMax)) {
 463         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 464           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 465                           &quot;must be between 1 and &quot; SIZE_FORMAT,
 466                           MarkStackSize, MarkStackSizeMax);
 467           return;
 468         }
 469       } else if (FLAG_IS_CMDLINE(MarkStackSizeMax)) {
 470         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 471           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;)&quot;
 472                           &quot; or for MarkStackSizeMax (&quot; SIZE_FORMAT &quot;)&quot;,
 473                           MarkStackSize, MarkStackSizeMax);
 474           return;
 475         }
 476       }
 477     }
 478   }
 479 
 480   if (!_global_mark_stack.initialize(MarkStackSize, MarkStackSizeMax)) {
 481     vm_exit_during_initialization(&quot;Failed to allocate initial concurrent mark overflow mark stack.&quot;);
 482   }
 483 
 484   _tasks = NEW_C_HEAP_ARRAY(G1CMTask*, _max_num_tasks, mtGC);
 485   _accum_task_vtime = NEW_C_HEAP_ARRAY(double, _max_num_tasks, mtGC);
 486 
 487   // so that the assertion in MarkingTaskQueue::task_queue doesn&#39;t fail
 488   _num_active_tasks = _max_num_tasks;
 489 
 490   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 491     G1CMTaskQueue* task_queue = new G1CMTaskQueue();
 492     task_queue-&gt;initialize();
 493     _task_queues-&gt;register_queue(i, task_queue);
 494 
 495     _tasks[i] = new G1CMTask(i, this, task_queue, _region_mark_stats, _g1h-&gt;max_regions());
 496 
 497     _accum_task_vtime[i] = 0.0;
 498   }
 499 
 500   reset_at_marking_complete();
 501   _completed_initialization = true;
 502 }
 503 
 504 void G1ConcurrentMark::reset() {
 505   _has_aborted = false;
 506 
 507   reset_marking_for_restart();
 508 
 509   // Reset all tasks, since different phases will use different number of active
 510   // threads. So, it&#39;s easiest to have all of them ready.
 511   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 512     _tasks[i]-&gt;reset(_next_mark_bitmap);
 513   }
 514 
 515   uint max_regions = _g1h-&gt;max_regions();
 516   for (uint i = 0; i &lt; max_regions; i++) {
 517     _top_at_rebuild_starts[i] = NULL;
 518     _region_mark_stats[i].clear();
 519   }
 520 }
 521 
 522 void G1ConcurrentMark::clear_statistics_in_region(uint region_idx) {
 523   for (uint j = 0; j &lt; _max_num_tasks; ++j) {
 524     _tasks[j]-&gt;clear_mark_stats_cache(region_idx);
 525   }
 526   _top_at_rebuild_starts[region_idx] = NULL;
 527   _region_mark_stats[region_idx].clear();
 528 }
 529 
 530 void G1ConcurrentMark::clear_statistics(HeapRegion* r) {
 531   uint const region_idx = r-&gt;hrm_index();
 532   if (r-&gt;is_humongous()) {
 533     assert(r-&gt;is_starts_humongous(), &quot;Got humongous continues region here&quot;);
 534     uint const size_in_regions = (uint)_g1h-&gt;humongous_obj_size_in_regions(oop(r-&gt;humongous_start_region()-&gt;bottom())-&gt;size());
 535     for (uint j = region_idx; j &lt; (region_idx + size_in_regions); j++) {
 536       clear_statistics_in_region(j);
 537     }
 538   } else {
 539     clear_statistics_in_region(region_idx);
 540   }
 541 }
 542 
 543 static void clear_mark_if_set(G1CMBitMap* bitmap, HeapWord* addr) {
 544   if (bitmap-&gt;is_marked(addr)) {
 545     bitmap-&gt;clear(addr);
 546   }
 547 }
 548 
 549 void G1ConcurrentMark::humongous_object_eagerly_reclaimed(HeapRegion* r) {
 550   assert_at_safepoint_on_vm_thread();
 551 
 552   // Need to clear all mark bits of the humongous object.
 553   clear_mark_if_set(_prev_mark_bitmap, r-&gt;bottom());
 554   clear_mark_if_set(_next_mark_bitmap, r-&gt;bottom());
 555 
 556   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
 557     return;
 558   }
 559 
 560   // Clear any statistics about the region gathered so far.
 561   clear_statistics(r);
 562 }
 563 
 564 void G1ConcurrentMark::reset_marking_for_restart() {
 565   _global_mark_stack.set_empty();
 566 
 567   // Expand the marking stack, if we have to and if we can.
 568   if (has_overflown()) {
 569     _global_mark_stack.expand();
 570 
 571     uint max_regions = _g1h-&gt;max_regions();
 572     for (uint i = 0; i &lt; max_regions; i++) {
 573       _region_mark_stats[i].clear_during_overflow();
 574     }
 575   }
 576 
 577   clear_has_overflown();
 578   _finger = _heap.start();
 579 
 580   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 581     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
 582     queue-&gt;set_empty();
 583   }
 584 }
 585 
 586 void G1ConcurrentMark::set_concurrency(uint active_tasks) {
 587   assert(active_tasks &lt;= _max_num_tasks, &quot;we should not have more&quot;);
 588 
 589   _num_active_tasks = active_tasks;
 590   // Need to update the three data structures below according to the
 591   // number of active threads for this phase.
<a name="31" id="anc31"></a><span class="line-modified"> 592   _terminator.terminator()-&gt;reset_for_reuse((int) active_tasks);</span>
 593   _first_overflow_barrier_sync.set_n_workers((int) active_tasks);
 594   _second_overflow_barrier_sync.set_n_workers((int) active_tasks);
 595 }
 596 
 597 void G1ConcurrentMark::set_concurrency_and_phase(uint active_tasks, bool concurrent) {
 598   set_concurrency(active_tasks);
 599 
 600   _concurrent = concurrent;
 601 
 602   if (!concurrent) {
 603     // At this point we should be in a STW phase, and completed marking.
 604     assert_at_safepoint_on_vm_thread();
 605     assert(out_of_regions(),
 606            &quot;only way to get here: _finger: &quot; PTR_FORMAT &quot;, _heap_end: &quot; PTR_FORMAT,
 607            p2i(_finger), p2i(_heap.end()));
 608   }
 609 }
 610 
 611 void G1ConcurrentMark::reset_at_marking_complete() {
 612   // We set the global marking state to some default values when we&#39;re
 613   // not doing marking.
 614   reset_marking_for_restart();
 615   _num_active_tasks = 0;
 616 }
 617 
 618 G1ConcurrentMark::~G1ConcurrentMark() {
 619   FREE_C_HEAP_ARRAY(HeapWord*, _top_at_rebuild_starts);
 620   FREE_C_HEAP_ARRAY(G1RegionMarkStats, _region_mark_stats);
 621   // The G1ConcurrentMark instance is never freed.
 622   ShouldNotReachHere();
 623 }
 624 
 625 class G1ClearBitMapTask : public AbstractGangTask {
 626 public:
 627   static size_t chunk_size() { return M; }
 628 
 629 private:
 630   // Heap region closure used for clearing the given mark bitmap.
 631   class G1ClearBitmapHRClosure : public HeapRegionClosure {
 632   private:
 633     G1CMBitMap* _bitmap;
 634     G1ConcurrentMark* _cm;
 635   public:
 636     G1ClearBitmapHRClosure(G1CMBitMap* bitmap, G1ConcurrentMark* cm) : HeapRegionClosure(), _bitmap(bitmap), _cm(cm) {
 637     }
 638 
 639     virtual bool do_heap_region(HeapRegion* r) {
 640       size_t const chunk_size_in_words = G1ClearBitMapTask::chunk_size() / HeapWordSize;
 641 
 642       HeapWord* cur = r-&gt;bottom();
 643       HeapWord* const end = r-&gt;end();
 644 
 645       while (cur &lt; end) {
 646         MemRegion mr(cur, MIN2(cur + chunk_size_in_words, end));
 647         _bitmap-&gt;clear_range(mr);
 648 
 649         cur += chunk_size_in_words;
 650 
 651         // Abort iteration if after yielding the marking has been aborted.
 652         if (_cm != NULL &amp;&amp; _cm-&gt;do_yield_check() &amp;&amp; _cm-&gt;has_aborted()) {
 653           return true;
 654         }
 655         // Repeat the asserts from before the start of the closure. We will do them
 656         // as asserts here to minimize their overhead on the product. However, we
 657         // will have them as guarantees at the beginning / end of the bitmap
 658         // clearing to get some checking in the product.
 659         assert(_cm == NULL || _cm-&gt;cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 660         assert(_cm == NULL || !G1CollectedHeap::heap()-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 661       }
 662       assert(cur == end, &quot;Must have completed iteration over the bitmap for region %u.&quot;, r-&gt;hrm_index());
 663 
 664       return false;
 665     }
 666   };
 667 
 668   G1ClearBitmapHRClosure _cl;
 669   HeapRegionClaimer _hr_claimer;
 670   bool _suspendible; // If the task is suspendible, workers must join the STS.
 671 
 672 public:
 673   G1ClearBitMapTask(G1CMBitMap* bitmap, G1ConcurrentMark* cm, uint n_workers, bool suspendible) :
 674     AbstractGangTask(&quot;G1 Clear Bitmap&quot;),
 675     _cl(bitmap, suspendible ? cm : NULL),
 676     _hr_claimer(n_workers),
 677     _suspendible(suspendible)
 678   { }
 679 
 680   void work(uint worker_id) {
 681     SuspendibleThreadSetJoiner sts_join(_suspendible);
 682     G1CollectedHeap::heap()-&gt;heap_region_par_iterate_from_worker_offset(&amp;_cl, &amp;_hr_claimer, worker_id);
 683   }
 684 
 685   bool is_complete() {
 686     return _cl.is_complete();
 687   }
 688 };
 689 
 690 void G1ConcurrentMark::clear_bitmap(G1CMBitMap* bitmap, WorkGang* workers, bool may_yield) {
 691   assert(may_yield || SafepointSynchronize::is_at_safepoint(), &quot;Non-yielding bitmap clear only allowed at safepoint.&quot;);
 692 
 693   size_t const num_bytes_to_clear = (HeapRegion::GrainBytes * _g1h-&gt;num_regions()) / G1CMBitMap::heap_map_factor();
 694   size_t const num_chunks = align_up(num_bytes_to_clear, G1ClearBitMapTask::chunk_size()) / G1ClearBitMapTask::chunk_size();
 695 
 696   uint const num_workers = (uint)MIN2(num_chunks, (size_t)workers-&gt;active_workers());
 697 
 698   G1ClearBitMapTask cl(bitmap, this, num_workers, may_yield);
 699 
 700   log_debug(gc, ergo)(&quot;Running %s with %u workers for &quot; SIZE_FORMAT &quot; work units.&quot;, cl.name(), num_workers, num_chunks);
 701   workers-&gt;run_task(&amp;cl, num_workers);
 702   guarantee(!may_yield || cl.is_complete(), &quot;Must have completed iteration when not yielding.&quot;);
 703 }
 704 
 705 void G1ConcurrentMark::cleanup_for_next_mark() {
 706   // Make sure that the concurrent mark thread looks to still be in
 707   // the current cycle.
 708   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 709 
 710   // We are finishing up the current cycle by clearing the next
 711   // marking bitmap and getting it ready for the next cycle. During
 712   // this time no other cycle can start. So, let&#39;s make sure that this
 713   // is the case.
 714   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 715 
 716   clear_bitmap(_next_mark_bitmap, _concurrent_workers, true);
 717 
 718   // Repeat the asserts from above.
 719   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 720   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 721 }
 722 
 723 void G1ConcurrentMark::clear_prev_bitmap(WorkGang* workers) {
 724   assert_at_safepoint_on_vm_thread();
 725   clear_bitmap(_prev_mark_bitmap, workers, false);
 726 }
 727 
 728 class NoteStartOfMarkHRClosure : public HeapRegionClosure {
 729 public:
 730   bool do_heap_region(HeapRegion* r) {
 731     r-&gt;note_start_of_marking();
 732     return false;
 733   }
 734 };
 735 
 736 void G1ConcurrentMark::pre_initial_mark() {
<a name="32" id="anc32"></a><span class="line-modified"> 737   // Initialize marking structures. This has to be done in a STW phase.</span>


 738   reset();
 739 
 740   // For each region note start of marking.
 741   NoteStartOfMarkHRClosure startcl;
 742   _g1h-&gt;heap_region_iterate(&amp;startcl);
 743 
 744   _root_regions.reset();
 745 }
 746 
 747 
 748 void G1ConcurrentMark::post_initial_mark() {
 749   // Start Concurrent Marking weak-reference discovery.
 750   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
 751   // enable (&quot;weak&quot;) refs discovery
 752   rp-&gt;enable_discovery();
 753   rp-&gt;setup_policy(false); // snapshot the soft ref policy to be used in this cycle
 754 
 755   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
 756   // This is the start of  the marking cycle, we&#39;re expected all
 757   // threads to have SATB queues with active set to false.
 758   satb_mq_set.set_active_all_threads(true, /* new active value */
 759                                      false /* expected_active */);
 760 
 761   _root_regions.prepare_for_scan();
 762 
 763   // update_g1_committed() will be called at the end of an evac pause
 764   // when marking is on. So, it&#39;s also called at the end of the
 765   // initial-mark pause to update the heap end, if the heap expands
 766   // during it. No need to call it here.
 767 }
 768 
 769 /*
 770  * Notice that in the next two methods, we actually leave the STS
 771  * during the barrier sync and join it immediately afterwards. If we
 772  * do not do this, the following deadlock can occur: one thread could
 773  * be in the barrier sync code, waiting for the other thread to also
 774  * sync up, whereas another one could be trying to yield, while also
 775  * waiting for the other threads to sync up too.
 776  *
 777  * Note, however, that this code is also used during remark and in
 778  * this case we should not attempt to leave / enter the STS, otherwise
 779  * we&#39;ll either hit an assert (debug / fastdebug) or deadlock
 780  * (product). So we should only leave / enter the STS if we are
 781  * operating concurrently.
 782  *
 783  * Because the thread that does the sync barrier has left the STS, it
 784  * is possible to be suspended for a Full GC or an evacuation pause
 785  * could occur. This is actually safe, since the entering the sync
 786  * barrier is one of the last things do_marking_step() does, and it
 787  * doesn&#39;t manipulate any data structures afterwards.
 788  */
 789 
 790 void G1ConcurrentMark::enter_first_sync_barrier(uint worker_id) {
 791   bool barrier_aborted;
 792   {
 793     SuspendibleThreadSetLeaver sts_leave(concurrent());
 794     barrier_aborted = !_first_overflow_barrier_sync.enter();
 795   }
 796 
 797   // at this point everyone should have synced up and not be doing any
 798   // more work
 799 
 800   if (barrier_aborted) {
 801     // If the barrier aborted we ignore the overflow condition and
 802     // just abort the whole marking phase as quickly as possible.
 803     return;
 804   }
 805 }
 806 
 807 void G1ConcurrentMark::enter_second_sync_barrier(uint worker_id) {
 808   SuspendibleThreadSetLeaver sts_leave(concurrent());
 809   _second_overflow_barrier_sync.enter();
 810 
 811   // at this point everything should be re-initialized and ready to go
 812 }
 813 
 814 class G1CMConcurrentMarkingTask : public AbstractGangTask {
 815   G1ConcurrentMark*     _cm;
 816 
 817 public:
 818   void work(uint worker_id) {
 819     assert(Thread::current()-&gt;is_ConcurrentGC_thread(), &quot;Not a concurrent GC thread&quot;);
 820     ResourceMark rm;
 821 
 822     double start_vtime = os::elapsedVTime();
 823 
 824     {
 825       SuspendibleThreadSetJoiner sts_join;
 826 
 827       assert(worker_id &lt; _cm-&gt;active_tasks(), &quot;invariant&quot;);
 828 
 829       G1CMTask* task = _cm-&gt;task(worker_id);
 830       task-&gt;record_start_time();
 831       if (!_cm-&gt;has_aborted()) {
 832         do {
 833           task-&gt;do_marking_step(G1ConcMarkStepDurationMillis,
 834                                 true  /* do_termination */,
 835                                 false /* is_serial*/);
 836 
 837           _cm-&gt;do_yield_check();
 838         } while (!_cm-&gt;has_aborted() &amp;&amp; task-&gt;has_aborted());
 839       }
 840       task-&gt;record_end_time();
 841       guarantee(!task-&gt;has_aborted() || _cm-&gt;has_aborted(), &quot;invariant&quot;);
 842     }
 843 
 844     double end_vtime = os::elapsedVTime();
 845     _cm-&gt;update_accum_task_vtime(worker_id, end_vtime - start_vtime);
 846   }
 847 
 848   G1CMConcurrentMarkingTask(G1ConcurrentMark* cm) :
 849       AbstractGangTask(&quot;Concurrent Mark&quot;), _cm(cm) { }
 850 
 851   ~G1CMConcurrentMarkingTask() { }
 852 };
 853 
 854 uint G1ConcurrentMark::calc_active_marking_workers() {
 855   uint result = 0;
 856   if (!UseDynamicNumberOfGCThreads ||
 857       (!FLAG_IS_DEFAULT(ConcGCThreads) &amp;&amp;
 858        !ForceDynamicNumberOfGCThreads)) {
 859     result = _max_concurrent_workers;
 860   } else {
 861     result =
 862       WorkerPolicy::calc_default_active_workers(_max_concurrent_workers,
 863                                                 1, /* Minimum workers */
 864                                                 _num_concurrent_workers,
 865                                                 Threads::number_of_non_daemon_threads());
 866     // Don&#39;t scale the result down by scale_concurrent_workers() because
 867     // that scaling has already gone into &quot;_max_concurrent_workers&quot;.
 868   }
 869   assert(result &gt; 0 &amp;&amp; result &lt;= _max_concurrent_workers,
 870          &quot;Calculated number of marking workers must be larger than zero and at most the maximum %u, but is %u&quot;,
 871          _max_concurrent_workers, result);
 872   return result;
 873 }
 874 
<a name="33" id="anc33"></a><span class="line-modified"> 875 void G1ConcurrentMark::scan_root_region(HeapRegion* hr, uint worker_id) {</span>
<span class="line-modified"> 876   assert(hr-&gt;is_old() || (hr-&gt;is_survivor() &amp;&amp; hr-&gt;next_top_at_mark_start() == hr-&gt;bottom()),</span>
<span class="line-modified"> 877          &quot;Root regions must be old or survivor but region %u is %s&quot;, hr-&gt;hrm_index(), hr-&gt;get_type_str());</span>







 878   G1RootRegionScanClosure cl(_g1h, this, worker_id);
 879 
 880   const uintx interval = PrefetchScanIntervalInBytes;
<a name="34" id="anc34"></a><span class="line-modified"> 881   HeapWord* curr = hr-&gt;next_top_at_mark_start();</span>
<span class="line-modified"> 882   const HeapWord* end = hr-&gt;top();</span>
 883   while (curr &lt; end) {
 884     Prefetch::read(curr, interval);
 885     oop obj = oop(curr);
 886     int size = obj-&gt;oop_iterate_size(&amp;cl);
 887     assert(size == obj-&gt;size(), &quot;sanity&quot;);
 888     curr += size;
 889   }
 890 }
 891 
 892 class G1CMRootRegionScanTask : public AbstractGangTask {
 893   G1ConcurrentMark* _cm;
 894 public:
 895   G1CMRootRegionScanTask(G1ConcurrentMark* cm) :
 896     AbstractGangTask(&quot;G1 Root Region Scan&quot;), _cm(cm) { }
 897 
 898   void work(uint worker_id) {
 899     assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
 900            &quot;this should only be done by a conc GC thread&quot;);
 901 
<a name="35" id="anc35"></a><span class="line-modified"> 902     G1CMRootRegions* root_regions = _cm-&gt;root_regions();</span>
<span class="line-modified"> 903     HeapRegion* hr = root_regions-&gt;claim_next();</span>
<span class="line-modified"> 904     while (hr != NULL) {</span>
<span class="line-modified"> 905       _cm-&gt;scan_root_region(hr, worker_id);</span>
<span class="line-modified"> 906       hr = root_regions-&gt;claim_next();</span>
 907     }
 908   }
 909 };
 910 
 911 void G1ConcurrentMark::scan_root_regions() {
 912   // scan_in_progress() will have been set to true only if there was
 913   // at least one root region to scan. So, if it&#39;s false, we
 914   // should not attempt to do any further work.
 915   if (root_regions()-&gt;scan_in_progress()) {
 916     assert(!has_aborted(), &quot;Aborting before root region scanning is finished not supported.&quot;);
 917 
 918     _num_concurrent_workers = MIN2(calc_active_marking_workers(),
 919                                    // We distribute work on a per-region basis, so starting
 920                                    // more threads than that is useless.
 921                                    root_regions()-&gt;num_root_regions());
 922     assert(_num_concurrent_workers &lt;= _max_concurrent_workers,
 923            &quot;Maximum number of marking threads exceeded&quot;);
 924 
 925     G1CMRootRegionScanTask task(this);
 926     log_debug(gc, ergo)(&quot;Running %s using %u workers for %u work units.&quot;,
 927                         task.name(), _num_concurrent_workers, root_regions()-&gt;num_root_regions());
 928     _concurrent_workers-&gt;run_task(&amp;task, _num_concurrent_workers);
 929 
 930     // It&#39;s possible that has_aborted() is true here without actually
 931     // aborting the survivor scan earlier. This is OK as it&#39;s
 932     // mainly used for sanity checking.
 933     root_regions()-&gt;scan_finished();
 934   }
 935 }
 936 
 937 void G1ConcurrentMark::concurrent_cycle_start() {
 938   _gc_timer_cm-&gt;register_gc_start();
 939 
 940   _gc_tracer_cm-&gt;report_gc_start(GCCause::_no_gc /* first parameter is not used */, _gc_timer_cm-&gt;gc_start());
 941 
 942   _g1h-&gt;trace_heap_before_gc(_gc_tracer_cm);
 943 }
 944 
 945 void G1ConcurrentMark::concurrent_cycle_end() {
 946   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(false);
 947 
 948   _g1h-&gt;trace_heap_after_gc(_gc_tracer_cm);
 949 
 950   if (has_aborted()) {
 951     log_info(gc, marking)(&quot;Concurrent Mark Abort&quot;);
 952     _gc_tracer_cm-&gt;report_concurrent_mode_failure();
 953   }
 954 
 955   _gc_timer_cm-&gt;register_gc_end();
 956 
 957   _gc_tracer_cm-&gt;report_gc_end(_gc_timer_cm-&gt;gc_end(), _gc_timer_cm-&gt;time_partitions());
 958 }
 959 
 960 void G1ConcurrentMark::mark_from_roots() {
 961   _restart_for_overflow = false;
 962 
 963   _num_concurrent_workers = calc_active_marking_workers();
 964 
 965   uint active_workers = MAX2(1U, _num_concurrent_workers);
 966 
 967   // Setting active workers is not guaranteed since fewer
 968   // worker threads may currently exist and more may not be
 969   // available.
 970   active_workers = _concurrent_workers-&gt;update_active_workers(active_workers);
 971   log_info(gc, task)(&quot;Using %u workers of %u for marking&quot;, active_workers, _concurrent_workers-&gt;total_workers());
 972 
 973   // Parallel task terminator is set in &quot;set_concurrency_and_phase()&quot;
 974   set_concurrency_and_phase(active_workers, true /* concurrent */);
 975 
 976   G1CMConcurrentMarkingTask marking_task(this);
 977   _concurrent_workers-&gt;run_task(&amp;marking_task);
 978   print_stats();
 979 }
 980 
 981 void G1ConcurrentMark::verify_during_pause(G1HeapVerifier::G1VerifyType type, VerifyOption vo, const char* caller) {
 982   G1HeapVerifier* verifier = _g1h-&gt;verifier();
 983 
 984   verifier-&gt;verify_region_sets_optional();
 985 
 986   if (VerifyDuringGC) {
 987     GCTraceTime(Debug, gc, phases) debug(caller, _gc_timer_cm);
 988 
 989     size_t const BufLen = 512;
 990     char buffer[BufLen];
 991 
 992     jio_snprintf(buffer, BufLen, &quot;During GC (%s)&quot;, caller);
 993     verifier-&gt;verify(type, vo, buffer);
 994   }
 995 
 996   verifier-&gt;check_bitmaps(caller);
 997 }
 998 
 999 class G1UpdateRemSetTrackingBeforeRebuildTask : public AbstractGangTask {
1000   G1CollectedHeap* _g1h;
1001   G1ConcurrentMark* _cm;
1002   HeapRegionClaimer _hrclaimer;
1003   uint volatile _total_selected_for_rebuild;
1004 
1005   G1PrintRegionLivenessInfoClosure _cl;
1006 
1007   class G1UpdateRemSetTrackingBeforeRebuild : public HeapRegionClosure {
1008     G1CollectedHeap* _g1h;
1009     G1ConcurrentMark* _cm;
1010 
1011     G1PrintRegionLivenessInfoClosure* _cl;
1012 
1013     uint _num_regions_selected_for_rebuild;  // The number of regions actually selected for rebuild.
1014 
1015     void update_remset_before_rebuild(HeapRegion* hr) {
1016       G1RemSetTrackingPolicy* tracking_policy = _g1h-&gt;policy()-&gt;remset_tracker();
1017 
1018       bool selected_for_rebuild;
1019       if (hr-&gt;is_humongous()) {
1020         bool const is_live = _cm-&gt;liveness(hr-&gt;humongous_start_region()-&gt;hrm_index()) &gt; 0;
1021         selected_for_rebuild = tracking_policy-&gt;update_humongous_before_rebuild(hr, is_live);
1022       } else {
1023         size_t const live_bytes = _cm-&gt;liveness(hr-&gt;hrm_index());
1024         selected_for_rebuild = tracking_policy-&gt;update_before_rebuild(hr, live_bytes);
1025       }
1026       if (selected_for_rebuild) {
1027         _num_regions_selected_for_rebuild++;
1028       }
1029       _cm-&gt;update_top_at_rebuild_start(hr);
1030     }
1031 
1032     // Distribute the given words across the humongous object starting with hr and
1033     // note end of marking.
1034     void distribute_marked_bytes(HeapRegion* hr, size_t marked_words) {
1035       uint const region_idx = hr-&gt;hrm_index();
1036       size_t const obj_size_in_words = (size_t)oop(hr-&gt;bottom())-&gt;size();
1037       uint const num_regions_in_humongous = (uint)G1CollectedHeap::humongous_obj_size_in_regions(obj_size_in_words);
1038 
1039       // &quot;Distributing&quot; zero words means that we only note end of marking for these
1040       // regions.
1041       assert(marked_words == 0 || obj_size_in_words == marked_words,
1042              &quot;Marked words should either be 0 or the same as humongous object (&quot; SIZE_FORMAT &quot;) but is &quot; SIZE_FORMAT,
1043              obj_size_in_words, marked_words);
1044 
1045       for (uint i = region_idx; i &lt; (region_idx + num_regions_in_humongous); i++) {
1046         HeapRegion* const r = _g1h-&gt;region_at(i);
1047         size_t const words_to_add = MIN2(HeapRegion::GrainWords, marked_words);
1048 
1049         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to humongous region %u (%s)&quot;,
1050                                words_to_add, i, r-&gt;get_type_str());
1051         add_marked_bytes_and_note_end(r, words_to_add * HeapWordSize);
1052         marked_words -= words_to_add;
1053       }
1054       assert(marked_words == 0,
1055              SIZE_FORMAT &quot; words left after distributing space across %u regions&quot;,
1056              marked_words, num_regions_in_humongous);
1057     }
1058 
1059     void update_marked_bytes(HeapRegion* hr) {
1060       uint const region_idx = hr-&gt;hrm_index();
1061       size_t const marked_words = _cm-&gt;liveness(region_idx);
1062       // The marking attributes the object&#39;s size completely to the humongous starts
1063       // region. We need to distribute this value across the entire set of regions a
1064       // humongous object spans.
1065       if (hr-&gt;is_humongous()) {
1066         assert(hr-&gt;is_starts_humongous() || marked_words == 0,
1067                &quot;Should not have marked words &quot; SIZE_FORMAT &quot; in non-starts humongous region %u (%s)&quot;,
1068                marked_words, region_idx, hr-&gt;get_type_str());
1069         if (hr-&gt;is_starts_humongous()) {
1070           distribute_marked_bytes(hr, marked_words);
1071         }
1072       } else {
1073         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to region %u (%s)&quot;, marked_words, region_idx, hr-&gt;get_type_str());
1074         add_marked_bytes_and_note_end(hr, marked_words * HeapWordSize);
1075       }
1076     }
1077 
1078     void add_marked_bytes_and_note_end(HeapRegion* hr, size_t marked_bytes) {
1079       hr-&gt;add_to_marked_bytes(marked_bytes);
1080       _cl-&gt;do_heap_region(hr);
1081       hr-&gt;note_end_of_marking();
1082     }
1083 
1084   public:
1085     G1UpdateRemSetTrackingBeforeRebuild(G1CollectedHeap* g1h, G1ConcurrentMark* cm, G1PrintRegionLivenessInfoClosure* cl) :
1086       _g1h(g1h), _cm(cm), _cl(cl), _num_regions_selected_for_rebuild(0) { }
1087 
1088     virtual bool do_heap_region(HeapRegion* r) {
1089       update_remset_before_rebuild(r);
1090       update_marked_bytes(r);
1091 
1092       return false;
1093     }
1094 
1095     uint num_selected_for_rebuild() const { return _num_regions_selected_for_rebuild; }
1096   };
1097 
1098 public:
1099   G1UpdateRemSetTrackingBeforeRebuildTask(G1CollectedHeap* g1h, G1ConcurrentMark* cm, uint num_workers) :
1100     AbstractGangTask(&quot;G1 Update RemSet Tracking Before Rebuild&quot;),
1101     _g1h(g1h), _cm(cm), _hrclaimer(num_workers), _total_selected_for_rebuild(0), _cl(&quot;Post-Marking&quot;) { }
1102 
1103   virtual void work(uint worker_id) {
1104     G1UpdateRemSetTrackingBeforeRebuild update_cl(_g1h, _cm, &amp;_cl);
1105     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;update_cl, &amp;_hrclaimer, worker_id);
<a name="36" id="anc36"></a><span class="line-modified">1106     Atomic::add(update_cl.num_selected_for_rebuild(), &amp;_total_selected_for_rebuild);</span>
1107   }
1108 
1109   uint total_selected_for_rebuild() const { return _total_selected_for_rebuild; }
1110 
1111   // Number of regions for which roughly one thread should be spawned for this work.
1112   static const uint RegionsPerThread = 384;
1113 };
1114 
1115 class G1UpdateRemSetTrackingAfterRebuild : public HeapRegionClosure {
1116   G1CollectedHeap* _g1h;
1117 public:
1118   G1UpdateRemSetTrackingAfterRebuild(G1CollectedHeap* g1h) : _g1h(g1h) { }
1119 
1120   virtual bool do_heap_region(HeapRegion* r) {
1121     _g1h-&gt;policy()-&gt;remset_tracker()-&gt;update_after_rebuild(r);
1122     return false;
1123   }
1124 };
1125 
1126 void G1ConcurrentMark::remark() {
1127   assert_at_safepoint_on_vm_thread();
1128 
1129   // If a full collection has happened, we should not continue. However we might
1130   // have ended up here as the Remark VM operation has been scheduled already.
1131   if (has_aborted()) {
1132     return;
1133   }
1134 
1135   G1Policy* policy = _g1h-&gt;policy();
1136   policy-&gt;record_concurrent_mark_remark_start();
1137 
1138   double start = os::elapsedTime();
1139 
1140   verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark before&quot;);
1141 
1142   {
1143     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Marking&quot;, _gc_timer_cm);
1144     finalize_marking();
1145   }
1146 
1147   double mark_work_end = os::elapsedTime();
1148 
1149   bool const mark_finished = !has_overflown();
1150   if (mark_finished) {
1151     weak_refs_work(false /* clear_all_soft_refs */);
1152 
1153     SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1154     // We&#39;re done with marking.
1155     // This is the end of the marking cycle, we&#39;re expected all
1156     // threads to have SATB queues with active set to true.
1157     satb_mq_set.set_active_all_threads(false, /* new active value */
1158                                        true /* expected_active */);
1159 
1160     {
1161       GCTraceTime(Debug, gc, phases) debug(&quot;Flush Task Caches&quot;, _gc_timer_cm);
1162       flush_all_task_caches();
1163     }
1164 
1165     // Install newly created mark bitmap as &quot;prev&quot;.
1166     swap_mark_bitmaps();
1167     {
1168       GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking Before Rebuild&quot;, _gc_timer_cm);
1169 
1170       uint const workers_by_capacity = (_g1h-&gt;num_regions() + G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread - 1) /
1171                                        G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread;
1172       uint const num_workers = MIN2(_g1h-&gt;workers()-&gt;active_workers(), workers_by_capacity);
1173 
1174       G1UpdateRemSetTrackingBeforeRebuildTask cl(_g1h, this, num_workers);
1175       log_debug(gc,ergo)(&quot;Running %s using %u workers for %u regions in heap&quot;, cl.name(), num_workers, _g1h-&gt;num_regions());
1176       _g1h-&gt;workers()-&gt;run_task(&amp;cl, num_workers);
1177 
1178       log_debug(gc, remset, tracking)(&quot;Remembered Set Tracking update regions total %u, selected %u&quot;,
1179                                       _g1h-&gt;num_regions(), cl.total_selected_for_rebuild());
1180     }
1181     {
1182       GCTraceTime(Debug, gc, phases) debug(&quot;Reclaim Empty Regions&quot;, _gc_timer_cm);
1183       reclaim_empty_regions();
1184     }
1185 
1186     // Clean out dead classes
1187     if (ClassUnloadingWithConcurrentMark) {
1188       GCTraceTime(Debug, gc, phases) debug(&quot;Purge Metaspace&quot;, _gc_timer_cm);
1189       ClassLoaderDataGraph::purge();
1190     }
1191 
1192     _g1h-&gt;resize_heap_if_necessary();
1193 
1194     compute_new_sizes();
1195 
1196     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark after&quot;);
1197 
1198     assert(!restart_for_overflow(), &quot;sanity&quot;);
1199     // Completely reset the marking state since marking completed
1200     reset_at_marking_complete();
1201   } else {
1202     // We overflowed.  Restart concurrent marking.
1203     _restart_for_overflow = true;
1204 
1205     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark overflow&quot;);
1206 
1207     // Clear the marking state because we will be restarting
1208     // marking due to overflowing the global mark stack.
1209     reset_marking_for_restart();
1210   }
1211 
1212   {
1213     GCTraceTime(Debug, gc, phases) debug(&quot;Report Object Count&quot;, _gc_timer_cm);
1214     report_object_count(mark_finished);
1215   }
1216 
1217   // Statistics
1218   double now = os::elapsedTime();
1219   _remark_mark_times.add((mark_work_end - start) * 1000.0);
1220   _remark_weak_ref_times.add((now - mark_work_end) * 1000.0);
1221   _remark_times.add((now - start) * 1000.0);
1222 
1223   policy-&gt;record_concurrent_mark_remark_end();
1224 }
1225 
1226 class G1ReclaimEmptyRegionsTask : public AbstractGangTask {
1227   // Per-region work during the Cleanup pause.
1228   class G1ReclaimEmptyRegionsClosure : public HeapRegionClosure {
1229     G1CollectedHeap* _g1h;
1230     size_t _freed_bytes;
1231     FreeRegionList* _local_cleanup_list;
1232     uint _old_regions_removed;
1233     uint _humongous_regions_removed;
1234 
1235   public:
1236     G1ReclaimEmptyRegionsClosure(G1CollectedHeap* g1h,
1237                                  FreeRegionList* local_cleanup_list) :
1238       _g1h(g1h),
1239       _freed_bytes(0),
1240       _local_cleanup_list(local_cleanup_list),
1241       _old_regions_removed(0),
1242       _humongous_regions_removed(0) { }
1243 
1244     size_t freed_bytes() { return _freed_bytes; }
1245     const uint old_regions_removed() { return _old_regions_removed; }
1246     const uint humongous_regions_removed() { return _humongous_regions_removed; }
1247 
1248     bool do_heap_region(HeapRegion *hr) {
1249       if (hr-&gt;used() &gt; 0 &amp;&amp; hr-&gt;max_live_bytes() == 0 &amp;&amp; !hr-&gt;is_young() &amp;&amp; !hr-&gt;is_archive()) {
1250         _freed_bytes += hr-&gt;used();
1251         hr-&gt;set_containing_set(NULL);
1252         if (hr-&gt;is_humongous()) {
1253           _humongous_regions_removed++;
1254           _g1h-&gt;free_humongous_region(hr, _local_cleanup_list);
1255         } else {
1256           _old_regions_removed++;
<a name="37" id="anc37"></a><span class="line-modified">1257           _g1h-&gt;free_region(hr, _local_cleanup_list, false /* skip_remset */, false /* skip_hcc */, true /* locked */);</span>
1258         }
1259         hr-&gt;clear_cardtable();
1260         _g1h-&gt;concurrent_mark()-&gt;clear_statistics_in_region(hr-&gt;hrm_index());
1261         log_trace(gc)(&quot;Reclaimed empty region %u (%s) bot &quot; PTR_FORMAT, hr-&gt;hrm_index(), hr-&gt;get_short_type_str(), p2i(hr-&gt;bottom()));
1262       }
1263 
1264       return false;
1265     }
1266   };
1267 
1268   G1CollectedHeap* _g1h;
1269   FreeRegionList* _cleanup_list;
1270   HeapRegionClaimer _hrclaimer;
1271 
1272 public:
1273   G1ReclaimEmptyRegionsTask(G1CollectedHeap* g1h, FreeRegionList* cleanup_list, uint n_workers) :
1274     AbstractGangTask(&quot;G1 Cleanup&quot;),
1275     _g1h(g1h),
1276     _cleanup_list(cleanup_list),
1277     _hrclaimer(n_workers) {
1278   }
1279 
1280   void work(uint worker_id) {
1281     FreeRegionList local_cleanup_list(&quot;Local Cleanup List&quot;);
1282     G1ReclaimEmptyRegionsClosure cl(_g1h, &amp;local_cleanup_list);
1283     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_hrclaimer, worker_id);
1284     assert(cl.is_complete(), &quot;Shouldn&#39;t have aborted!&quot;);
1285 
1286     // Now update the old/humongous region sets
1287     _g1h-&gt;remove_from_old_sets(cl.old_regions_removed(), cl.humongous_regions_removed());
1288     {
<a name="38" id="anc38"></a><span class="line-modified">1289       MutexLockerEx x(ParGCRareEvent_lock, Mutex::_no_safepoint_check_flag);</span>
1290       _g1h-&gt;decrement_summary_bytes(cl.freed_bytes());
1291 
1292       _cleanup_list-&gt;add_ordered(&amp;local_cleanup_list);
1293       assert(local_cleanup_list.is_empty(), &quot;post-condition&quot;);
1294     }
1295   }
1296 };
1297 
1298 void G1ConcurrentMark::reclaim_empty_regions() {
1299   WorkGang* workers = _g1h-&gt;workers();
1300   FreeRegionList empty_regions_list(&quot;Empty Regions After Mark List&quot;);
1301 
1302   G1ReclaimEmptyRegionsTask cl(_g1h, &amp;empty_regions_list, workers-&gt;active_workers());
1303   workers-&gt;run_task(&amp;cl);
1304 
1305   if (!empty_regions_list.is_empty()) {
1306     log_debug(gc)(&quot;Reclaimed %u empty regions&quot;, empty_regions_list.length());
1307     // Now print the empty regions list.
1308     G1HRPrinter* hrp = _g1h-&gt;hr_printer();
1309     if (hrp-&gt;is_active()) {
1310       FreeRegionListIterator iter(&amp;empty_regions_list);
1311       while (iter.more_available()) {
1312         HeapRegion* hr = iter.get_next();
1313         hrp-&gt;cleanup(hr);
1314       }
1315     }
1316     // And actually make them available.
1317     _g1h-&gt;prepend_to_freelist(&amp;empty_regions_list);
1318   }
1319 }
1320 
1321 void G1ConcurrentMark::compute_new_sizes() {
1322   MetaspaceGC::compute_new_size();
1323 
1324   // Cleanup will have freed any regions completely full of garbage.
1325   // Update the soft reference policy with the new heap occupancy.
1326   Universe::update_heap_info_at_gc();
1327 
1328   // We reclaimed old regions so we should calculate the sizes to make
1329   // sure we update the old gen/space data.
1330   _g1h-&gt;g1mm()-&gt;update_sizes();
1331 }
1332 
1333 void G1ConcurrentMark::cleanup() {
1334   assert_at_safepoint_on_vm_thread();
1335 
1336   // If a full collection has happened, we shouldn&#39;t do this.
1337   if (has_aborted()) {
1338     return;
1339   }
1340 
1341   G1Policy* policy = _g1h-&gt;policy();
1342   policy-&gt;record_concurrent_mark_cleanup_start();
1343 
1344   double start = os::elapsedTime();
1345 
1346   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup before&quot;);
1347 
1348   {
1349     GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking After Rebuild&quot;, _gc_timer_cm);
1350     G1UpdateRemSetTrackingAfterRebuild cl(_g1h);
1351     _g1h-&gt;heap_region_iterate(&amp;cl);
1352   }
1353 
1354   if (log_is_enabled(Trace, gc, liveness)) {
1355     G1PrintRegionLivenessInfoClosure cl(&quot;Post-Cleanup&quot;);
1356     _g1h-&gt;heap_region_iterate(&amp;cl);
1357   }
1358 
1359   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup after&quot;);
1360 
1361   // We need to make this be a &quot;collection&quot; so any collection pause that
1362   // races with it goes around and waits for Cleanup to finish.
1363   _g1h-&gt;increment_total_collections();
1364 
1365   // Local statistics
1366   double recent_cleanup_time = (os::elapsedTime() - start);
1367   _total_cleanup_time += recent_cleanup_time;
1368   _cleanup_times.add(recent_cleanup_time);
1369 
1370   {
1371     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Concurrent Mark Cleanup&quot;, _gc_timer_cm);
1372     policy-&gt;record_concurrent_mark_cleanup_end();
1373   }
1374 }
1375 
1376 // &#39;Keep Alive&#39; oop closure used by both serial parallel reference processing.
1377 // Uses the G1CMTask associated with a worker thread (for serial reference
1378 // processing the G1CMTask for worker 0 is used) to preserve (mark) and
1379 // trace referent objects.
1380 //
1381 // Using the G1CMTask and embedded local queues avoids having the worker
1382 // threads operating on the global mark stack. This reduces the risk
1383 // of overflowing the stack - which we would rather avoid at this late
1384 // state. Also using the tasks&#39; local queues removes the potential
1385 // of the workers interfering with each other that could occur if
1386 // operating on the global stack.
1387 
1388 class G1CMKeepAliveAndDrainClosure : public OopClosure {
1389   G1ConcurrentMark* _cm;
1390   G1CMTask*         _task;
1391   uint              _ref_counter_limit;
1392   uint              _ref_counter;
1393   bool              _is_serial;
1394 public:
1395   G1CMKeepAliveAndDrainClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1396     _cm(cm), _task(task), _ref_counter_limit(G1RefProcDrainInterval),
1397     _ref_counter(_ref_counter_limit), _is_serial(is_serial) {
1398     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1399   }
1400 
1401   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
1402   virtual void do_oop(      oop* p) { do_oop_work(p); }
1403 
1404   template &lt;class T&gt; void do_oop_work(T* p) {
1405     if (_cm-&gt;has_overflown()) {
1406       return;
1407     }
1408     if (!_task-&gt;deal_with_reference(p)) {
1409       // We did not add anything to the mark bitmap (or mark stack), so there is
1410       // no point trying to drain it.
1411       return;
1412     }
1413     _ref_counter--;
1414 
1415     if (_ref_counter == 0) {
1416       // We have dealt with _ref_counter_limit references, pushing them
1417       // and objects reachable from them on to the local stack (and
1418       // possibly the global stack). Call G1CMTask::do_marking_step() to
1419       // process these entries.
1420       //
1421       // We call G1CMTask::do_marking_step() in a loop, which we&#39;ll exit if
1422       // there&#39;s nothing more to do (i.e. we&#39;re done with the entries that
1423       // were pushed as a result of the G1CMTask::deal_with_reference() calls
1424       // above) or we overflow.
1425       //
1426       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1427       // flag while there may still be some work to do. (See the comment at
1428       // the beginning of G1CMTask::do_marking_step() for those conditions -
1429       // one of which is reaching the specified time target.) It is only
1430       // when G1CMTask::do_marking_step() returns without setting the
1431       // has_aborted() flag that the marking step has completed.
1432       do {
1433         double mark_step_duration_ms = G1ConcMarkStepDurationMillis;
1434         _task-&gt;do_marking_step(mark_step_duration_ms,
1435                                false      /* do_termination */,
1436                                _is_serial);
1437       } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1438       _ref_counter = _ref_counter_limit;
1439     }
1440   }
1441 };
1442 
1443 // &#39;Drain&#39; oop closure used by both serial and parallel reference processing.
1444 // Uses the G1CMTask associated with a given worker thread (for serial
1445 // reference processing the G1CMtask for worker 0 is used). Calls the
1446 // do_marking_step routine, with an unbelievably large timeout value,
1447 // to drain the marking data structures of the remaining entries
1448 // added by the &#39;keep alive&#39; oop closure above.
1449 
1450 class G1CMDrainMarkingStackClosure : public VoidClosure {
1451   G1ConcurrentMark* _cm;
1452   G1CMTask*         _task;
1453   bool              _is_serial;
1454  public:
1455   G1CMDrainMarkingStackClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1456     _cm(cm), _task(task), _is_serial(is_serial) {
1457     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1458   }
1459 
1460   void do_void() {
1461     do {
1462       // We call G1CMTask::do_marking_step() to completely drain the local
1463       // and global marking stacks of entries pushed by the &#39;keep alive&#39;
1464       // oop closure (an instance of G1CMKeepAliveAndDrainClosure above).
1465       //
1466       // G1CMTask::do_marking_step() is called in a loop, which we&#39;ll exit
1467       // if there&#39;s nothing more to do (i.e. we&#39;ve completely drained the
1468       // entries that were pushed as a a result of applying the &#39;keep alive&#39;
1469       // closure to the entries on the discovered ref lists) or we overflow
1470       // the global marking stack.
1471       //
1472       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1473       // flag while there may still be some work to do. (See the comment at
1474       // the beginning of G1CMTask::do_marking_step() for those conditions -
1475       // one of which is reaching the specified time target.) It is only
1476       // when G1CMTask::do_marking_step() returns without setting the
1477       // has_aborted() flag that the marking step has completed.
1478 
1479       _task-&gt;do_marking_step(1000000000.0 /* something very large */,
1480                              true         /* do_termination */,
1481                              _is_serial);
1482     } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1483   }
1484 };
1485 
1486 // Implementation of AbstractRefProcTaskExecutor for parallel
1487 // reference processing at the end of G1 concurrent marking
1488 
1489 class G1CMRefProcTaskExecutor : public AbstractRefProcTaskExecutor {
1490 private:
1491   G1CollectedHeap*  _g1h;
1492   G1ConcurrentMark* _cm;
1493   WorkGang*         _workers;
1494   uint              _active_workers;
1495 
1496 public:
1497   G1CMRefProcTaskExecutor(G1CollectedHeap* g1h,
1498                           G1ConcurrentMark* cm,
1499                           WorkGang* workers,
1500                           uint n_workers) :
1501     _g1h(g1h), _cm(cm),
1502     _workers(workers), _active_workers(n_workers) { }
1503 
1504   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
1505 };
1506 
1507 class G1CMRefProcTaskProxy : public AbstractGangTask {
1508   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
1509   ProcessTask&amp;      _proc_task;
1510   G1CollectedHeap*  _g1h;
1511   G1ConcurrentMark* _cm;
1512 
1513 public:
1514   G1CMRefProcTaskProxy(ProcessTask&amp; proc_task,
1515                        G1CollectedHeap* g1h,
1516                        G1ConcurrentMark* cm) :
1517     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
1518     _proc_task(proc_task), _g1h(g1h), _cm(cm) {
1519     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1520     assert(rp-&gt;processing_is_mt(), &quot;shouldn&#39;t be here otherwise&quot;);
1521   }
1522 
1523   virtual void work(uint worker_id) {
1524     ResourceMark rm;
1525     HandleMark hm;
1526     G1CMTask* task = _cm-&gt;task(worker_id);
1527     G1CMIsAliveClosure g1_is_alive(_g1h);
1528     G1CMKeepAliveAndDrainClosure g1_par_keep_alive(_cm, task, false /* is_serial */);
1529     G1CMDrainMarkingStackClosure g1_par_drain(_cm, task, false /* is_serial */);
1530 
1531     _proc_task.work(worker_id, g1_is_alive, g1_par_keep_alive, g1_par_drain);
1532   }
1533 };
1534 
1535 void G1CMRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
1536   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
1537   assert(_g1h-&gt;ref_processor_cm()-&gt;processing_is_mt(), &quot;processing is not MT&quot;);
1538   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
1539          &quot;Ergonomically chosen workers(%u) should be less than or equal to active workers(%u)&quot;,
1540          ergo_workers, _workers-&gt;active_workers());
1541 
1542   G1CMRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _cm);
1543 
1544   // We need to reset the concurrency level before each
1545   // proxy task execution, so that the termination protocol
1546   // and overflow handling in G1CMTask::do_marking_step() knows
1547   // how many workers to wait for.
1548   _cm-&gt;set_concurrency(ergo_workers);
1549   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
1550 }
1551 
1552 void G1ConcurrentMark::weak_refs_work(bool clear_all_soft_refs) {
1553   ResourceMark rm;
1554   HandleMark   hm;
1555 
1556   // Is alive closure.
1557   G1CMIsAliveClosure g1_is_alive(_g1h);
1558 
1559   // Inner scope to exclude the cleaning of the string table
1560   // from the displayed time.
1561   {
1562     GCTraceTime(Debug, gc, phases) debug(&quot;Reference Processing&quot;, _gc_timer_cm);
1563 
1564     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1565 
1566     // See the comment in G1CollectedHeap::ref_processing_init()
1567     // about how reference processing currently works in G1.
1568 
1569     // Set the soft reference policy
1570     rp-&gt;setup_policy(clear_all_soft_refs);
1571     assert(_global_mark_stack.is_empty(), &quot;mark stack should be empty&quot;);
1572 
1573     // Instances of the &#39;Keep Alive&#39; and &#39;Complete GC&#39; closures used
1574     // in serial reference processing. Note these closures are also
1575     // used for serially processing (by the the current thread) the
1576     // JNI references during parallel reference processing.
1577     //
1578     // These closures do not need to synchronize with the worker
1579     // threads involved in parallel reference processing as these
1580     // instances are executed serially by the current thread (e.g.
1581     // reference processing is not multi-threaded and is thus
1582     // performed by the current thread instead of a gang worker).
1583     //
1584     // The gang tasks involved in parallel reference processing create
1585     // their own instances of these closures, which do their own
1586     // synchronization among themselves.
1587     G1CMKeepAliveAndDrainClosure g1_keep_alive(this, task(0), true /* is_serial */);
1588     G1CMDrainMarkingStackClosure g1_drain_mark_stack(this, task(0), true /* is_serial */);
1589 
1590     // We need at least one active thread. If reference processing
1591     // is not multi-threaded we use the current (VMThread) thread,
1592     // otherwise we use the work gang from the G1CollectedHeap and
1593     // we utilize all the worker threads we can.
1594     bool processing_is_mt = rp-&gt;processing_is_mt();
1595     uint active_workers = (processing_is_mt ? _g1h-&gt;workers()-&gt;active_workers() : 1U);
<a name="39" id="anc39"></a><span class="line-modified">1596     active_workers = MAX2(MIN2(active_workers, _max_num_tasks), 1U);</span>
1597 
1598     // Parallel processing task executor.
1599     G1CMRefProcTaskExecutor par_task_executor(_g1h, this,
1600                                               _g1h-&gt;workers(), active_workers);
1601     AbstractRefProcTaskExecutor* executor = (processing_is_mt ? &amp;par_task_executor : NULL);
1602 
1603     // Set the concurrency level. The phase was already set prior to
1604     // executing the remark task.
1605     set_concurrency(active_workers);
1606 
1607     // Set the degree of MT processing here.  If the discovery was done MT,
1608     // the number of threads involved during discovery could differ from
1609     // the number of active workers.  This is OK as long as the discovered
1610     // Reference lists are balanced (see balance_all_queues() and balance_queues()).
1611     rp-&gt;set_active_mt_degree(active_workers);
1612 
1613     ReferenceProcessorPhaseTimes pt(_gc_timer_cm, rp-&gt;max_num_queues());
1614 
1615     // Process the weak references.
1616     const ReferenceProcessorStats&amp; stats =
1617         rp-&gt;process_discovered_references(&amp;g1_is_alive,
1618                                           &amp;g1_keep_alive,
1619                                           &amp;g1_drain_mark_stack,
1620                                           executor,
1621                                           &amp;pt);
1622     _gc_tracer_cm-&gt;report_gc_reference_stats(stats);
1623     pt.print_all_references();
1624 
1625     // The do_oop work routines of the keep_alive and drain_marking_stack
1626     // oop closures will set the has_overflown flag if we overflow the
1627     // global marking stack.
1628 
1629     assert(has_overflown() || _global_mark_stack.is_empty(),
1630            &quot;Mark stack should be empty (unless it has overflown)&quot;);
1631 
1632     assert(rp-&gt;num_queues() == active_workers, &quot;why not&quot;);
1633 
1634     rp-&gt;verify_no_references_recorded();
1635     assert(!rp-&gt;discovery_enabled(), &quot;Post condition&quot;);
1636   }
1637 
1638   if (has_overflown()) {
1639     // We can not trust g1_is_alive and the contents of the heap if the marking stack
1640     // overflowed while processing references. Exit the VM.
1641     fatal(&quot;Overflow during reference processing, can not continue. Please &quot;
1642           &quot;increase MarkStackSizeMax (current value: &quot; SIZE_FORMAT &quot;) and &quot;
1643           &quot;restart.&quot;, MarkStackSizeMax);
1644     return;
1645   }
1646 
1647   assert(_global_mark_stack.is_empty(), &quot;Marking should have completed&quot;);
1648 
1649   {
1650     GCTraceTime(Debug, gc, phases) debug(&quot;Weak Processing&quot;, _gc_timer_cm);
1651     WeakProcessor::weak_oops_do(_g1h-&gt;workers(), &amp;g1_is_alive, &amp;do_nothing_cl, 1);
1652   }
1653 
1654   // Unload Klasses, String, Code Cache, etc.
1655   if (ClassUnloadingWithConcurrentMark) {
1656     GCTraceTime(Debug, gc, phases) debug(&quot;Class Unloading&quot;, _gc_timer_cm);
1657     bool purged_classes = SystemDictionary::do_unloading(_gc_timer_cm);
1658     _g1h-&gt;complete_cleaning(&amp;g1_is_alive, purged_classes);
1659   } else if (StringDedup::is_enabled()) {
1660     GCTraceTime(Debug, gc, phases) debug(&quot;String Deduplication&quot;, _gc_timer_cm);
1661     _g1h-&gt;string_dedup_cleaning(&amp;g1_is_alive, NULL);
1662   }
1663 }
1664 
1665 class G1PrecleanYieldClosure : public YieldClosure {
1666   G1ConcurrentMark* _cm;
1667 
1668 public:
1669   G1PrecleanYieldClosure(G1ConcurrentMark* cm) : _cm(cm) { }
1670 
1671   virtual bool should_return() {
1672     return _cm-&gt;has_aborted();
1673   }
1674 
1675   virtual bool should_return_fine_grain() {
1676     _cm-&gt;do_yield_check();
1677     return _cm-&gt;has_aborted();
1678   }
1679 };
1680 
1681 void G1ConcurrentMark::preclean() {
1682   assert(G1UseReferencePrecleaning, &quot;Precleaning must be enabled.&quot;);
1683 
1684   SuspendibleThreadSetJoiner joiner;
1685 
1686   G1CMKeepAliveAndDrainClosure keep_alive(this, task(0), true /* is_serial */);
1687   G1CMDrainMarkingStackClosure drain_mark_stack(this, task(0), true /* is_serial */);
1688 
1689   set_concurrency_and_phase(1, true);
1690 
1691   G1PrecleanYieldClosure yield_cl(this);
1692 
1693   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1694   // Precleaning is single threaded. Temporarily disable MT discovery.
1695   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(rp, false);
1696   rp-&gt;preclean_discovered_references(rp-&gt;is_alive_non_header(),
1697                                      &amp;keep_alive,
1698                                      &amp;drain_mark_stack,
1699                                      &amp;yield_cl,
1700                                      _gc_timer_cm);
1701 }
1702 
1703 // When sampling object counts, we already swapped the mark bitmaps, so we need to use
1704 // the prev bitmap determining liveness.
1705 class G1ObjectCountIsAliveClosure: public BoolObjectClosure {
1706   G1CollectedHeap* _g1h;
1707 public:
1708   G1ObjectCountIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) { }
1709 
1710   bool do_object_b(oop obj) {
<a name="40" id="anc40"></a><span class="line-modified">1711     HeapWord* addr = (HeapWord*)obj;</span>
<span class="line-modified">1712     return addr != NULL &amp;&amp;</span>
<span class="line-removed">1713            (!_g1h-&gt;is_in_g1_reserved(addr) || !_g1h-&gt;is_obj_dead(obj));</span>
1714   }
1715 };
1716 
1717 void G1ConcurrentMark::report_object_count(bool mark_completed) {
1718   // Depending on the completion of the marking liveness needs to be determined
1719   // using either the next or prev bitmap.
1720   if (mark_completed) {
1721     G1ObjectCountIsAliveClosure is_alive(_g1h);
1722     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1723   } else {
1724     G1CMIsAliveClosure is_alive(_g1h);
1725     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1726   }
1727 }
1728 
1729 
1730 void G1ConcurrentMark::swap_mark_bitmaps() {
1731   G1CMBitMap* temp = _prev_mark_bitmap;
1732   _prev_mark_bitmap = _next_mark_bitmap;
1733   _next_mark_bitmap = temp;
1734   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(true);
1735 }
1736 
1737 // Closure for marking entries in SATB buffers.
1738 class G1CMSATBBufferClosure : public SATBBufferClosure {
1739 private:
1740   G1CMTask* _task;
1741   G1CollectedHeap* _g1h;
1742 
1743   // This is very similar to G1CMTask::deal_with_reference, but with
1744   // more relaxed requirements for the argument, so this must be more
1745   // circumspect about treating the argument as an object.
1746   void do_entry(void* entry) const {
1747     _task-&gt;increment_refs_reached();
1748     oop const obj = static_cast&lt;oop&gt;(entry);
1749     _task-&gt;make_reference_grey(obj);
1750   }
1751 
1752 public:
1753   G1CMSATBBufferClosure(G1CMTask* task, G1CollectedHeap* g1h)
1754     : _task(task), _g1h(g1h) { }
1755 
1756   virtual void do_buffer(void** buffer, size_t size) {
1757     for (size_t i = 0; i &lt; size; ++i) {
1758       do_entry(buffer[i]);
1759     }
1760   }
1761 };
1762 
1763 class G1RemarkThreadsClosure : public ThreadClosure {
1764   G1CMSATBBufferClosure _cm_satb_cl;
1765   G1CMOopClosure _cm_cl;
1766   MarkingCodeBlobClosure _code_cl;
<a name="41" id="anc41"></a><span class="line-modified">1767   int _thread_parity;</span>
1768 
1769  public:
1770   G1RemarkThreadsClosure(G1CollectedHeap* g1h, G1CMTask* task) :
1771     _cm_satb_cl(task, g1h),
1772     _cm_cl(g1h, task),
1773     _code_cl(&amp;_cm_cl, !CodeBlobToOopClosure::FixRelocations),
<a name="42" id="anc42"></a><span class="line-modified">1774     _thread_parity(Threads::thread_claim_parity()) {}</span>
1775 
1776   void do_thread(Thread* thread) {
<a name="43" id="anc43"></a><span class="line-modified">1777     if (thread-&gt;claim_oops_do(true, _thread_parity)) {</span>
1778       SATBMarkQueue&amp; queue = G1ThreadLocalData::satb_mark_queue(thread);
1779       queue.apply_closure_and_empty(&amp;_cm_satb_cl);
1780       if (thread-&gt;is_Java_thread()) {
1781         // In theory it should not be neccessary to explicitly walk the nmethods to find roots for concurrent marking
1782         // however the liveness of oops reachable from nmethods have very complex lifecycles:
1783         // * Alive if on the stack of an executing method
1784         // * Weakly reachable otherwise
1785         // Some objects reachable from nmethods, such as the class loader (or klass_holder) of the receiver should be
1786         // live by the SATB invariant but other oops recorded in nmethods may behave differently.
1787         JavaThread* jt = (JavaThread*)thread;
1788         jt-&gt;nmethods_do(&amp;_code_cl);
1789       }
1790     }
1791   }
1792 };
1793 
1794 class G1CMRemarkTask : public AbstractGangTask {
1795   G1ConcurrentMark* _cm;
1796 public:
1797   void work(uint worker_id) {
1798     G1CMTask* task = _cm-&gt;task(worker_id);
1799     task-&gt;record_start_time();
1800     {
1801       ResourceMark rm;
1802       HandleMark hm;
1803 
1804       G1RemarkThreadsClosure threads_f(G1CollectedHeap::heap(), task);
1805       Threads::threads_do(&amp;threads_f);
1806     }
1807 
1808     do {
1809       task-&gt;do_marking_step(1000000000.0 /* something very large */,
1810                             true         /* do_termination       */,
1811                             false        /* is_serial            */);
1812     } while (task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1813     // If we overflow, then we do not want to restart. We instead
1814     // want to abort remark and do concurrent marking again.
1815     task-&gt;record_end_time();
1816   }
1817 
1818   G1CMRemarkTask(G1ConcurrentMark* cm, uint active_workers) :
1819     AbstractGangTask(&quot;Par Remark&quot;), _cm(cm) {
1820     _cm-&gt;terminator()-&gt;reset_for_reuse(active_workers);
1821   }
1822 };
1823 
1824 void G1ConcurrentMark::finalize_marking() {
1825   ResourceMark rm;
1826   HandleMark   hm;
1827 
1828   _g1h-&gt;ensure_parsability(false);
1829 
1830   // this is remark, so we&#39;ll use up all active threads
1831   uint active_workers = _g1h-&gt;workers()-&gt;active_workers();
1832   set_concurrency_and_phase(active_workers, false /* concurrent */);
1833   // Leave _parallel_marking_threads at it&#39;s
1834   // value originally calculated in the G1ConcurrentMark
1835   // constructor and pass values of the active workers
1836   // through the gang in the task.
1837 
1838   {
1839     StrongRootsScope srs(active_workers);
1840 
1841     G1CMRemarkTask remarkTask(this, active_workers);
1842     // We will start all available threads, even if we decide that the
1843     // active_workers will be fewer. The extra ones will just bail out
1844     // immediately.
1845     _g1h-&gt;workers()-&gt;run_task(&amp;remarkTask);
1846   }
1847 
1848   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1849   guarantee(has_overflown() ||
1850             satb_mq_set.completed_buffers_num() == 0,
1851             &quot;Invariant: has_overflown = %s, num buffers = &quot; SIZE_FORMAT,
1852             BOOL_TO_STR(has_overflown()),
1853             satb_mq_set.completed_buffers_num());
1854 
1855   print_stats();
1856 }
1857 
1858 void G1ConcurrentMark::flush_all_task_caches() {
1859   size_t hits = 0;
1860   size_t misses = 0;
1861   for (uint i = 0; i &lt; _max_num_tasks; i++) {
1862     Pair&lt;size_t, size_t&gt; stats = _tasks[i]-&gt;flush_mark_stats_cache();
1863     hits += stats.first;
1864     misses += stats.second;
1865   }
1866   size_t sum = hits + misses;
1867   log_debug(gc, stats)(&quot;Mark stats cache hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %1.3lf&quot;,
1868                        hits, misses, percent_of(hits, sum));
1869 }
1870 
1871 void G1ConcurrentMark::clear_range_in_prev_bitmap(MemRegion mr) {
1872   _prev_mark_bitmap-&gt;clear_range(mr);
1873 }
1874 
1875 HeapRegion*
1876 G1ConcurrentMark::claim_region(uint worker_id) {
1877   // &quot;checkpoint&quot; the finger
1878   HeapWord* finger = _finger;
1879 
1880   while (finger &lt; _heap.end()) {
1881     assert(_g1h-&gt;is_in_g1_reserved(finger), &quot;invariant&quot;);
1882 
1883     HeapRegion* curr_region = _g1h-&gt;heap_region_containing(finger);
1884     // Make sure that the reads below do not float before loading curr_region.
1885     OrderAccess::loadload();
1886     // Above heap_region_containing may return NULL as we always scan claim
1887     // until the end of the heap. In this case, just jump to the next region.
1888     HeapWord* end = curr_region != NULL ? curr_region-&gt;end() : finger + HeapRegion::GrainWords;
1889 
1890     // Is the gap between reading the finger and doing the CAS too long?
<a name="44" id="anc44"></a><span class="line-modified">1891     HeapWord* res = Atomic::cmpxchg(end, &amp;_finger, finger);</span>
1892     if (res == finger &amp;&amp; curr_region != NULL) {
1893       // we succeeded
1894       HeapWord*   bottom        = curr_region-&gt;bottom();
1895       HeapWord*   limit         = curr_region-&gt;next_top_at_mark_start();
1896 
1897       // notice that _finger == end cannot be guaranteed here since,
1898       // someone else might have moved the finger even further
1899       assert(_finger &gt;= end, &quot;the finger should have moved forward&quot;);
1900 
1901       if (limit &gt; bottom) {
1902         return curr_region;
1903       } else {
1904         assert(limit == bottom,
1905                &quot;the region limit should be at bottom&quot;);
1906         // we return NULL and the caller should try calling
1907         // claim_region() again.
1908         return NULL;
1909       }
1910     } else {
1911       assert(_finger &gt; finger, &quot;the finger should have moved forward&quot;);
1912       // read it again
1913       finger = _finger;
1914     }
1915   }
1916 
1917   return NULL;
1918 }
1919 
1920 #ifndef PRODUCT
1921 class VerifyNoCSetOops {
1922   G1CollectedHeap* _g1h;
1923   const char* _phase;
1924   int _info;
1925 
1926 public:
1927   VerifyNoCSetOops(const char* phase, int info = -1) :
1928     _g1h(G1CollectedHeap::heap()),
1929     _phase(phase),
1930     _info(info)
1931   { }
1932 
1933   void operator()(G1TaskQueueEntry task_entry) const {
1934     if (task_entry.is_array_slice()) {
1935       guarantee(_g1h-&gt;is_in_reserved(task_entry.slice()), &quot;Slice &quot; PTR_FORMAT &quot; must be in heap.&quot;, p2i(task_entry.slice()));
1936       return;
1937     }
1938     guarantee(oopDesc::is_oop(task_entry.obj()),
1939               &quot;Non-oop &quot; PTR_FORMAT &quot;, phase: %s, info: %d&quot;,
1940               p2i(task_entry.obj()), _phase, _info);
<a name="45" id="anc45"></a><span class="line-modified">1941     guarantee(!_g1h-&gt;is_in_cset(task_entry.obj()),</span>
<span class="line-modified">1942               &quot;obj: &quot; PTR_FORMAT &quot; in CSet, phase: %s, info: %d&quot;,</span>
<span class="line-modified">1943               p2i(task_entry.obj()), _phase, _info);</span>

1944   }
1945 };
1946 
<a name="46" id="anc46"></a><span class="line-modified">1947 void G1ConcurrentMark::verify_no_cset_oops() {</span>
1948   assert(SafepointSynchronize::is_at_safepoint(), &quot;should be at a safepoint&quot;);
1949   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
1950     return;
1951   }
1952 
1953   // Verify entries on the global mark stack
1954   _global_mark_stack.iterate(VerifyNoCSetOops(&quot;Stack&quot;));
1955 
1956   // Verify entries on the task queues
1957   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
1958     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
1959     queue-&gt;iterate(VerifyNoCSetOops(&quot;Queue&quot;, i));
1960   }
1961 
1962   // Verify the global finger
1963   HeapWord* global_finger = finger();
1964   if (global_finger != NULL &amp;&amp; global_finger &lt; _heap.end()) {
1965     // Since we always iterate over all regions, we might get a NULL HeapRegion
1966     // here.
1967     HeapRegion* global_hr = _g1h-&gt;heap_region_containing(global_finger);
1968     guarantee(global_hr == NULL || global_finger == global_hr-&gt;bottom(),
1969               &quot;global finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
1970               p2i(global_finger), HR_FORMAT_PARAMS(global_hr));
1971   }
1972 
1973   // Verify the task fingers
1974   assert(_num_concurrent_workers &lt;= _max_num_tasks, &quot;sanity&quot;);
1975   for (uint i = 0; i &lt; _num_concurrent_workers; ++i) {
1976     G1CMTask* task = _tasks[i];
1977     HeapWord* task_finger = task-&gt;finger();
1978     if (task_finger != NULL &amp;&amp; task_finger &lt; _heap.end()) {
1979       // See above note on the global finger verification.
<a name="47" id="anc47"></a><span class="line-modified">1980       HeapRegion* task_hr = _g1h-&gt;heap_region_containing(task_finger);</span>
<span class="line-modified">1981       guarantee(task_hr == NULL || task_finger == task_hr-&gt;bottom() ||</span>
<span class="line-modified">1982                 !task_hr-&gt;in_collection_set(),</span>
1983                 &quot;task finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
<a name="48" id="anc48"></a><span class="line-modified">1984                 p2i(task_finger), HR_FORMAT_PARAMS(task_hr));</span>
1985     }
1986   }
1987 }
1988 #endif // PRODUCT
1989 
1990 void G1ConcurrentMark::rebuild_rem_set_concurrently() {
1991   _g1h-&gt;rem_set()-&gt;rebuild_rem_set(this, _concurrent_workers, _worker_id_offset);
1992 }
1993 
1994 void G1ConcurrentMark::print_stats() {
1995   if (!log_is_enabled(Debug, gc, stats)) {
1996     return;
1997   }
1998   log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
1999   for (size_t i = 0; i &lt; _num_active_tasks; ++i) {
2000     _tasks[i]-&gt;print_stats();
2001     log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
2002   }
2003 }
2004 
2005 void G1ConcurrentMark::concurrent_cycle_abort() {
2006   if (!cm_thread()-&gt;during_cycle() || _has_aborted) {
2007     // We haven&#39;t started a concurrent cycle or we have already aborted it. No need to do anything.
2008     return;
2009   }
2010 
2011   // Clear all marks in the next bitmap for the next marking cycle. This will allow us to skip the next
2012   // concurrent bitmap clearing.
2013   {
2014     GCTraceTime(Debug, gc) debug(&quot;Clear Next Bitmap&quot;);
2015     clear_bitmap(_next_mark_bitmap, _g1h-&gt;workers(), false);
2016   }
2017   // Note we cannot clear the previous marking bitmap here
2018   // since VerifyDuringGC verifies the objects marked during
2019   // a full GC against the previous bitmap.
2020 
2021   // Empty mark stack
2022   reset_marking_for_restart();
2023   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
2024     _tasks[i]-&gt;clear_region_fields();
2025   }
2026   _first_overflow_barrier_sync.abort();
2027   _second_overflow_barrier_sync.abort();
2028   _has_aborted = true;
2029 
2030   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2031   satb_mq_set.abandon_partial_marking();
2032   // This can be called either during or outside marking, we&#39;ll read
2033   // the expected_active value from the SATB queue set.
2034   satb_mq_set.set_active_all_threads(
2035                                  false, /* new active value */
2036                                  satb_mq_set.is_active() /* expected_active */);
2037 }
2038 
2039 static void print_ms_time_info(const char* prefix, const char* name,
2040                                NumberSeq&amp; ns) {
2041   log_trace(gc, marking)(&quot;%s%5d %12s: total time = %8.2f s (avg = %8.2f ms).&quot;,
2042                          prefix, ns.num(), name, ns.sum()/1000.0, ns.avg());
2043   if (ns.num() &gt; 0) {
2044     log_trace(gc, marking)(&quot;%s         [std. dev = %8.2f ms, max = %8.2f ms]&quot;,
2045                            prefix, ns.sd(), ns.maximum());
2046   }
2047 }
2048 
2049 void G1ConcurrentMark::print_summary_info() {
2050   Log(gc, marking) log;
2051   if (!log.is_trace()) {
2052     return;
2053   }
2054 
2055   log.trace(&quot; Concurrent marking:&quot;);
2056   print_ms_time_info(&quot;  &quot;, &quot;init marks&quot;, _init_times);
2057   print_ms_time_info(&quot;  &quot;, &quot;remarks&quot;, _remark_times);
2058   {
2059     print_ms_time_info(&quot;     &quot;, &quot;final marks&quot;, _remark_mark_times);
2060     print_ms_time_info(&quot;     &quot;, &quot;weak refs&quot;, _remark_weak_ref_times);
2061 
2062   }
2063   print_ms_time_info(&quot;  &quot;, &quot;cleanups&quot;, _cleanup_times);
2064   log.trace(&quot;    Finalize live data total time = %8.2f s (avg = %8.2f ms).&quot;,
2065             _total_cleanup_time, (_cleanup_times.num() &gt; 0 ? _total_cleanup_time * 1000.0 / (double)_cleanup_times.num() : 0.0));
2066   log.trace(&quot;  Total stop_world time = %8.2f s.&quot;,
2067             (_init_times.sum() + _remark_times.sum() + _cleanup_times.sum())/1000.0);
2068   log.trace(&quot;  Total concurrent time = %8.2f s (%8.2f s marking).&quot;,
2069             cm_thread()-&gt;vtime_accum(), cm_thread()-&gt;vtime_mark_accum());
2070 }
2071 
2072 void G1ConcurrentMark::print_worker_threads_on(outputStream* st) const {
2073   _concurrent_workers-&gt;print_worker_threads_on(st);
2074 }
2075 
2076 void G1ConcurrentMark::threads_do(ThreadClosure* tc) const {
2077   _concurrent_workers-&gt;threads_do(tc);
2078 }
2079 
2080 void G1ConcurrentMark::print_on_error(outputStream* st) const {
2081   st-&gt;print_cr(&quot;Marking Bits (Prev, Next): (CMBitMap*) &quot; PTR_FORMAT &quot;, (CMBitMap*) &quot; PTR_FORMAT,
2082                p2i(_prev_mark_bitmap), p2i(_next_mark_bitmap));
2083   _prev_mark_bitmap-&gt;print_on_error(st, &quot; Prev Bits: &quot;);
2084   _next_mark_bitmap-&gt;print_on_error(st, &quot; Next Bits: &quot;);
2085 }
2086 
2087 static ReferenceProcessor* get_cm_oop_closure_ref_processor(G1CollectedHeap* g1h) {
2088   ReferenceProcessor* result = g1h-&gt;ref_processor_cm();
2089   assert(result != NULL, &quot;CM reference processor should not be NULL&quot;);
2090   return result;
2091 }
2092 
2093 G1CMOopClosure::G1CMOopClosure(G1CollectedHeap* g1h,
2094                                G1CMTask* task)
2095   : MetadataVisitingOopIterateClosure(get_cm_oop_closure_ref_processor(g1h)),
2096     _g1h(g1h), _task(task)
2097 { }
2098 
2099 void G1CMTask::setup_for_region(HeapRegion* hr) {
2100   assert(hr != NULL,
2101         &quot;claim_region() should have filtered out NULL regions&quot;);
2102   _curr_region  = hr;
2103   _finger       = hr-&gt;bottom();
2104   update_region_limit();
2105 }
2106 
2107 void G1CMTask::update_region_limit() {
2108   HeapRegion* hr            = _curr_region;
2109   HeapWord* bottom          = hr-&gt;bottom();
2110   HeapWord* limit           = hr-&gt;next_top_at_mark_start();
2111 
2112   if (limit == bottom) {
2113     // The region was collected underneath our feet.
2114     // We set the finger to bottom to ensure that the bitmap
2115     // iteration that will follow this will not do anything.
2116     // (this is not a condition that holds when we set the region up,
2117     // as the region is not supposed to be empty in the first place)
2118     _finger = bottom;
2119   } else if (limit &gt;= _region_limit) {
2120     assert(limit &gt;= _finger, &quot;peace of mind&quot;);
2121   } else {
2122     assert(limit &lt; _region_limit, &quot;only way to get here&quot;);
2123     // This can happen under some pretty unusual circumstances.  An
2124     // evacuation pause empties the region underneath our feet (NTAMS
2125     // at bottom). We then do some allocation in the region (NTAMS
2126     // stays at bottom), followed by the region being used as a GC
2127     // alloc region (NTAMS will move to top() and the objects
2128     // originally below it will be grayed). All objects now marked in
2129     // the region are explicitly grayed, if below the global finger,
2130     // and we do not need in fact to scan anything else. So, we simply
2131     // set _finger to be limit to ensure that the bitmap iteration
2132     // doesn&#39;t do anything.
2133     _finger = limit;
2134   }
2135 
2136   _region_limit = limit;
2137 }
2138 
2139 void G1CMTask::giveup_current_region() {
2140   assert(_curr_region != NULL, &quot;invariant&quot;);
2141   clear_region_fields();
2142 }
2143 
2144 void G1CMTask::clear_region_fields() {
2145   // Values for these three fields that indicate that we&#39;re not
2146   // holding on to a region.
2147   _curr_region   = NULL;
2148   _finger        = NULL;
2149   _region_limit  = NULL;
2150 }
2151 
2152 void G1CMTask::set_cm_oop_closure(G1CMOopClosure* cm_oop_closure) {
2153   if (cm_oop_closure == NULL) {
2154     assert(_cm_oop_closure != NULL, &quot;invariant&quot;);
2155   } else {
2156     assert(_cm_oop_closure == NULL, &quot;invariant&quot;);
2157   }
2158   _cm_oop_closure = cm_oop_closure;
2159 }
2160 
2161 void G1CMTask::reset(G1CMBitMap* next_mark_bitmap) {
2162   guarantee(next_mark_bitmap != NULL, &quot;invariant&quot;);
2163   _next_mark_bitmap              = next_mark_bitmap;
2164   clear_region_fields();
2165 
2166   _calls                         = 0;
2167   _elapsed_time_ms               = 0.0;
2168   _termination_time_ms           = 0.0;
2169   _termination_start_time_ms     = 0.0;
2170 
2171   _mark_stats_cache.reset();
2172 }
2173 
2174 bool G1CMTask::should_exit_termination() {
2175   if (!regular_clock_call()) {
2176     return true;
2177   }
2178 
2179   // This is called when we are in the termination protocol. We should
2180   // quit if, for some reason, this task wants to abort or the global
2181   // stack is not empty (this means that we can get work from it).
2182   return !_cm-&gt;mark_stack_empty() || has_aborted();
2183 }
2184 
2185 void G1CMTask::reached_limit() {
2186   assert(_words_scanned &gt;= _words_scanned_limit ||
2187          _refs_reached &gt;= _refs_reached_limit ,
2188          &quot;shouldn&#39;t have been called otherwise&quot;);
2189   abort_marking_if_regular_check_fail();
2190 }
2191 
2192 bool G1CMTask::regular_clock_call() {
2193   if (has_aborted()) {
2194     return false;
2195   }
2196 
2197   // First, we need to recalculate the words scanned and refs reached
2198   // limits for the next clock call.
2199   recalculate_limits();
2200 
2201   // During the regular clock call we do the following
2202 
2203   // (1) If an overflow has been flagged, then we abort.
2204   if (_cm-&gt;has_overflown()) {
2205     return false;
2206   }
2207 
2208   // If we are not concurrent (i.e. we&#39;re doing remark) we don&#39;t need
2209   // to check anything else. The other steps are only needed during
2210   // the concurrent marking phase.
2211   if (!_cm-&gt;concurrent()) {
2212     return true;
2213   }
2214 
2215   // (2) If marking has been aborted for Full GC, then we also abort.
2216   if (_cm-&gt;has_aborted()) {
2217     return false;
2218   }
2219 
2220   double curr_time_ms = os::elapsedVTime() * 1000.0;
2221 
2222   // (4) We check whether we should yield. If we have to, then we abort.
2223   if (SuspendibleThreadSet::should_yield()) {
2224     // We should yield. To do this we abort the task. The caller is
2225     // responsible for yielding.
2226     return false;
2227   }
2228 
2229   // (5) We check whether we&#39;ve reached our time quota. If we have,
2230   // then we abort.
2231   double elapsed_time_ms = curr_time_ms - _start_time_ms;
2232   if (elapsed_time_ms &gt; _time_target_ms) {
2233     _has_timed_out = true;
2234     return false;
2235   }
2236 
2237   // (6) Finally, we check whether there are enough completed STAB
2238   // buffers available for processing. If there are, we abort.
2239   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2240   if (!_draining_satb_buffers &amp;&amp; satb_mq_set.process_completed_buffers()) {
2241     // we do need to process SATB buffers, we&#39;ll abort and restart
2242     // the marking task to do so
2243     return false;
2244   }
2245   return true;
2246 }
2247 
2248 void G1CMTask::recalculate_limits() {
2249   _real_words_scanned_limit = _words_scanned + words_scanned_period;
2250   _words_scanned_limit      = _real_words_scanned_limit;
2251 
2252   _real_refs_reached_limit  = _refs_reached  + refs_reached_period;
2253   _refs_reached_limit       = _real_refs_reached_limit;
2254 }
2255 
2256 void G1CMTask::decrease_limits() {
2257   // This is called when we believe that we&#39;re going to do an infrequent
2258   // operation which will increase the per byte scanned cost (i.e. move
2259   // entries to/from the global stack). It basically tries to decrease the
2260   // scanning limit so that the clock is called earlier.
2261 
2262   _words_scanned_limit = _real_words_scanned_limit - 3 * words_scanned_period / 4;
2263   _refs_reached_limit  = _real_refs_reached_limit - 3 * refs_reached_period / 4;
2264 }
2265 
2266 void G1CMTask::move_entries_to_global_stack() {
2267   // Local array where we&#39;ll store the entries that will be popped
2268   // from the local queue.
2269   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2270 
2271   size_t n = 0;
2272   G1TaskQueueEntry task_entry;
2273   while (n &lt; G1CMMarkStack::EntriesPerChunk &amp;&amp; _task_queue-&gt;pop_local(task_entry)) {
2274     buffer[n] = task_entry;
2275     ++n;
2276   }
2277   if (n &lt; G1CMMarkStack::EntriesPerChunk) {
2278     buffer[n] = G1TaskQueueEntry();
2279   }
2280 
2281   if (n &gt; 0) {
2282     if (!_cm-&gt;mark_stack_push(buffer)) {
2283       set_has_aborted();
2284     }
2285   }
2286 
2287   // This operation was quite expensive, so decrease the limits.
2288   decrease_limits();
2289 }
2290 
2291 bool G1CMTask::get_entries_from_global_stack() {
2292   // Local array where we&#39;ll store the entries that will be popped
2293   // from the global stack.
2294   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2295 
2296   if (!_cm-&gt;mark_stack_pop(buffer)) {
2297     return false;
2298   }
2299 
2300   // We did actually pop at least one entry.
2301   for (size_t i = 0; i &lt; G1CMMarkStack::EntriesPerChunk; ++i) {
2302     G1TaskQueueEntry task_entry = buffer[i];
2303     if (task_entry.is_null()) {
2304       break;
2305     }
2306     assert(task_entry.is_array_slice() || oopDesc::is_oop(task_entry.obj()), &quot;Element &quot; PTR_FORMAT &quot; must be an array slice or oop&quot;, p2i(task_entry.obj()));
2307     bool success = _task_queue-&gt;push(task_entry);
2308     // We only call this when the local queue is empty or under a
2309     // given target limit. So, we do not expect this push to fail.
2310     assert(success, &quot;invariant&quot;);
2311   }
2312 
2313   // This operation was quite expensive, so decrease the limits
2314   decrease_limits();
2315   return true;
2316 }
2317 
2318 void G1CMTask::drain_local_queue(bool partially) {
2319   if (has_aborted()) {
2320     return;
2321   }
2322 
2323   // Decide what the target size is, depending whether we&#39;re going to
2324   // drain it partially (so that other tasks can steal if they run out
2325   // of things to do) or totally (at the very end).
2326   size_t target_size;
2327   if (partially) {
2328     target_size = MIN2((size_t)_task_queue-&gt;max_elems()/3, (size_t)GCDrainStackTargetSize);
2329   } else {
2330     target_size = 0;
2331   }
2332 
2333   if (_task_queue-&gt;size() &gt; target_size) {
2334     G1TaskQueueEntry entry;
2335     bool ret = _task_queue-&gt;pop_local(entry);
2336     while (ret) {
2337       scan_task_entry(entry);
2338       if (_task_queue-&gt;size() &lt;= target_size || has_aborted()) {
2339         ret = false;
2340       } else {
2341         ret = _task_queue-&gt;pop_local(entry);
2342       }
2343     }
2344   }
2345 }
2346 
2347 void G1CMTask::drain_global_stack(bool partially) {
2348   if (has_aborted()) {
2349     return;
2350   }
2351 
2352   // We have a policy to drain the local queue before we attempt to
2353   // drain the global stack.
2354   assert(partially || _task_queue-&gt;size() == 0, &quot;invariant&quot;);
2355 
2356   // Decide what the target size is, depending whether we&#39;re going to
2357   // drain it partially (so that other tasks can steal if they run out
2358   // of things to do) or totally (at the very end).
2359   // Notice that when draining the global mark stack partially, due to the racyness
2360   // of the mark stack size update we might in fact drop below the target. But,
2361   // this is not a problem.
2362   // In case of total draining, we simply process until the global mark stack is
2363   // totally empty, disregarding the size counter.
2364   if (partially) {
2365     size_t const target_size = _cm-&gt;partial_mark_stack_size_target();
2366     while (!has_aborted() &amp;&amp; _cm-&gt;mark_stack_size() &gt; target_size) {
2367       if (get_entries_from_global_stack()) {
2368         drain_local_queue(partially);
2369       }
2370     }
2371   } else {
2372     while (!has_aborted() &amp;&amp; get_entries_from_global_stack()) {
2373       drain_local_queue(partially);
2374     }
2375   }
2376 }
2377 
2378 // SATB Queue has several assumptions on whether to call the par or
2379 // non-par versions of the methods. this is why some of the code is
2380 // replicated. We should really get rid of the single-threaded version
2381 // of the code to simplify things.
2382 void G1CMTask::drain_satb_buffers() {
2383   if (has_aborted()) {
2384     return;
2385   }
2386 
2387   // We set this so that the regular clock knows that we&#39;re in the
2388   // middle of draining buffers and doesn&#39;t set the abort flag when it
2389   // notices that SATB buffers are available for draining. It&#39;d be
2390   // very counter productive if it did that. :-)
2391   _draining_satb_buffers = true;
2392 
2393   G1CMSATBBufferClosure satb_cl(this, _g1h);
2394   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2395 
2396   // This keeps claiming and applying the closure to completed buffers
2397   // until we run out of buffers or we need to abort.
2398   while (!has_aborted() &amp;&amp;
2399          satb_mq_set.apply_closure_to_completed_buffer(&amp;satb_cl)) {
2400     abort_marking_if_regular_check_fail();
2401   }
2402 
<a name="49" id="anc49"></a><span class="line-modified">2403   _draining_satb_buffers = false;</span>



2404 
<a name="50" id="anc50"></a><span class="line-modified">2405   assert(has_aborted() ||</span>
<span class="line-removed">2406          _cm-&gt;concurrent() ||</span>
<span class="line-removed">2407          satb_mq_set.completed_buffers_num() == 0, &quot;invariant&quot;);</span>
2408 
2409   // again, this was a potentially expensive operation, decrease the
2410   // limits to get the regular clock call early
2411   decrease_limits();
2412 }
2413 
2414 void G1CMTask::clear_mark_stats_cache(uint region_idx) {
2415   _mark_stats_cache.reset(region_idx);
2416 }
2417 
2418 Pair&lt;size_t, size_t&gt; G1CMTask::flush_mark_stats_cache() {
2419   return _mark_stats_cache.evict_all();
2420 }
2421 
2422 void G1CMTask::print_stats() {
2423   log_debug(gc, stats)(&quot;Marking Stats, task = %u, calls = %u&quot;, _worker_id, _calls);
2424   log_debug(gc, stats)(&quot;  Elapsed time = %1.2lfms, Termination time = %1.2lfms&quot;,
2425                        _elapsed_time_ms, _termination_time_ms);
2426   log_debug(gc, stats)(&quot;  Step Times (cum): num = %d, avg = %1.2lfms, sd = %1.2lfms max = %1.2lfms, total = %1.2lfms&quot;,
2427                        _step_times_ms.num(),
2428                        _step_times_ms.avg(),
2429                        _step_times_ms.sd(),
2430                        _step_times_ms.maximum(),
2431                        _step_times_ms.sum());
2432   size_t const hits = _mark_stats_cache.hits();
2433   size_t const misses = _mark_stats_cache.misses();
2434   log_debug(gc, stats)(&quot;  Mark Stats Cache: hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %.3f&quot;,
2435                        hits, misses, percent_of(hits, hits + misses));
2436 }
2437 
2438 bool G1ConcurrentMark::try_stealing(uint worker_id, G1TaskQueueEntry&amp; task_entry) {
2439   return _task_queues-&gt;steal(worker_id, task_entry);
2440 }
2441 
2442 /*****************************************************************************
2443 
2444     The do_marking_step(time_target_ms, ...) method is the building
2445     block of the parallel marking framework. It can be called in parallel
2446     with other invocations of do_marking_step() on different tasks
2447     (but only one per task, obviously) and concurrently with the
2448     mutator threads, or during remark, hence it eliminates the need
2449     for two versions of the code. When called during remark, it will
2450     pick up from where the task left off during the concurrent marking
2451     phase. Interestingly, tasks are also claimable during evacuation
2452     pauses too, since do_marking_step() ensures that it aborts before
2453     it needs to yield.
2454 
2455     The data structures that it uses to do marking work are the
2456     following:
2457 
2458       (1) Marking Bitmap. If there are gray objects that appear only
2459       on the bitmap (this happens either when dealing with an overflow
2460       or when the initial marking phase has simply marked the roots
2461       and didn&#39;t push them on the stack), then tasks claim heap
2462       regions whose bitmap they then scan to find gray objects. A
2463       global finger indicates where the end of the last claimed region
2464       is. A local finger indicates how far into the region a task has
2465       scanned. The two fingers are used to determine how to gray an
2466       object (i.e. whether simply marking it is OK, as it will be
2467       visited by a task in the future, or whether it needs to be also
2468       pushed on a stack).
2469 
2470       (2) Local Queue. The local queue of the task which is accessed
2471       reasonably efficiently by the task. Other tasks can steal from
2472       it when they run out of work. Throughout the marking phase, a
2473       task attempts to keep its local queue short but not totally
2474       empty, so that entries are available for stealing by other
2475       tasks. Only when there is no more work, a task will totally
2476       drain its local queue.
2477 
2478       (3) Global Mark Stack. This handles local queue overflow. During
2479       marking only sets of entries are moved between it and the local
2480       queues, as access to it requires a mutex and more fine-grain
2481       interaction with it which might cause contention. If it
2482       overflows, then the marking phase should restart and iterate
2483       over the bitmap to identify gray objects. Throughout the marking
2484       phase, tasks attempt to keep the global mark stack at a small
2485       length but not totally empty, so that entries are available for
2486       popping by other tasks. Only when there is no more work, tasks
2487       will totally drain the global mark stack.
2488 
2489       (4) SATB Buffer Queue. This is where completed SATB buffers are
2490       made available. Buffers are regularly removed from this queue
2491       and scanned for roots, so that the queue doesn&#39;t get too
2492       long. During remark, all completed buffers are processed, as
2493       well as the filled in parts of any uncompleted buffers.
2494 
2495     The do_marking_step() method tries to abort when the time target
2496     has been reached. There are a few other cases when the
2497     do_marking_step() method also aborts:
2498 
2499       (1) When the marking phase has been aborted (after a Full GC).
2500 
2501       (2) When a global overflow (on the global stack) has been
2502       triggered. Before the task aborts, it will actually sync up with
2503       the other tasks to ensure that all the marking data structures
2504       (local queues, stacks, fingers etc.)  are re-initialized so that
2505       when do_marking_step() completes, the marking phase can
2506       immediately restart.
2507 
2508       (3) When enough completed SATB buffers are available. The
2509       do_marking_step() method only tries to drain SATB buffers right
2510       at the beginning. So, if enough buffers are available, the
2511       marking step aborts and the SATB buffers are processed at
2512       the beginning of the next invocation.
2513 
2514       (4) To yield. when we have to yield then we abort and yield
2515       right at the end of do_marking_step(). This saves us from a lot
2516       of hassle as, by yielding we might allow a Full GC. If this
2517       happens then objects will be compacted underneath our feet, the
2518       heap might shrink, etc. We save checking for this by just
2519       aborting and doing the yield right at the end.
2520 
2521     From the above it follows that the do_marking_step() method should
2522     be called in a loop (or, otherwise, regularly) until it completes.
2523 
2524     If a marking step completes without its has_aborted() flag being
2525     true, it means it has completed the current marking phase (and
2526     also all other marking tasks have done so and have all synced up).
2527 
2528     A method called regular_clock_call() is invoked &quot;regularly&quot; (in
2529     sub ms intervals) throughout marking. It is this clock method that
2530     checks all the abort conditions which were mentioned above and
2531     decides when the task should abort. A work-based scheme is used to
2532     trigger this clock method: when the number of object words the
2533     marking phase has scanned or the number of references the marking
2534     phase has visited reach a given limit. Additional invocations to
2535     the method clock have been planted in a few other strategic places
2536     too. The initial reason for the clock method was to avoid calling
2537     vtime too regularly, as it is quite expensive. So, once it was in
2538     place, it was natural to piggy-back all the other conditions on it
2539     too and not constantly check them throughout the code.
2540 
2541     If do_termination is true then do_marking_step will enter its
2542     termination protocol.
2543 
2544     The value of is_serial must be true when do_marking_step is being
2545     called serially (i.e. by the VMThread) and do_marking_step should
2546     skip any synchronization in the termination and overflow code.
2547     Examples include the serial remark code and the serial reference
2548     processing closures.
2549 
2550     The value of is_serial must be false when do_marking_step is
2551     being called by any of the worker threads in a work gang.
2552     Examples include the concurrent marking code (CMMarkingTask),
2553     the MT remark code, and the MT reference processing closures.
2554 
2555  *****************************************************************************/
2556 
2557 void G1CMTask::do_marking_step(double time_target_ms,
2558                                bool do_termination,
2559                                bool is_serial) {
2560   assert(time_target_ms &gt;= 1.0, &quot;minimum granularity is 1ms&quot;);
2561 
2562   _start_time_ms = os::elapsedVTime() * 1000.0;
2563 
2564   // If do_stealing is true then do_marking_step will attempt to
2565   // steal work from the other G1CMTasks. It only makes sense to
2566   // enable stealing when the termination protocol is enabled
2567   // and do_marking_step() is not being called serially.
2568   bool do_stealing = do_termination &amp;&amp; !is_serial;
2569 
<a name="51" id="anc51"></a><span class="line-modified">2570   double diff_prediction_ms = _g1h-&gt;policy()-&gt;predictor().get_new_prediction(&amp;_marking_step_diffs_ms);</span>

2571   _time_target_ms = time_target_ms - diff_prediction_ms;
2572 
2573   // set up the variables that are used in the work-based scheme to
2574   // call the regular clock method
2575   _words_scanned = 0;
2576   _refs_reached  = 0;
2577   recalculate_limits();
2578 
2579   // clear all flags
2580   clear_has_aborted();
2581   _has_timed_out = false;
2582   _draining_satb_buffers = false;
2583 
2584   ++_calls;
2585 
2586   // Set up the bitmap and oop closures. Anything that uses them is
2587   // eventually called from this method, so it is OK to allocate these
2588   // statically.
2589   G1CMBitMapClosure bitmap_closure(this, _cm);
2590   G1CMOopClosure cm_oop_closure(_g1h, this);
2591   set_cm_oop_closure(&amp;cm_oop_closure);
2592 
2593   if (_cm-&gt;has_overflown()) {
2594     // This can happen if the mark stack overflows during a GC pause
2595     // and this task, after a yield point, restarts. We have to abort
2596     // as we need to get into the overflow protocol which happens
2597     // right at the end of this task.
2598     set_has_aborted();
2599   }
2600 
2601   // First drain any available SATB buffers. After this, we will not
2602   // look at SATB buffers before the next invocation of this method.
2603   // If enough completed SATB buffers are queued up, the regular clock
2604   // will abort this task so that it restarts.
2605   drain_satb_buffers();
2606   // ...then partially drain the local queue and the global stack
2607   drain_local_queue(true);
2608   drain_global_stack(true);
2609 
2610   do {
2611     if (!has_aborted() &amp;&amp; _curr_region != NULL) {
2612       // This means that we&#39;re already holding on to a region.
2613       assert(_finger != NULL, &quot;if region is not NULL, then the finger &quot;
2614              &quot;should not be NULL either&quot;);
2615 
2616       // We might have restarted this task after an evacuation pause
2617       // which might have evacuated the region we&#39;re holding on to
2618       // underneath our feet. Let&#39;s read its limit again to make sure
2619       // that we do not iterate over a region of the heap that
2620       // contains garbage (update_region_limit() will also move
2621       // _finger to the start of the region if it is found empty).
2622       update_region_limit();
2623       // We will start from _finger not from the start of the region,
2624       // as we might be restarting this task after aborting half-way
2625       // through scanning this region. In this case, _finger points to
2626       // the address where we last found a marked object. If this is a
2627       // fresh region, _finger points to start().
2628       MemRegion mr = MemRegion(_finger, _region_limit);
2629 
2630       assert(!_curr_region-&gt;is_humongous() || mr.start() == _curr_region-&gt;bottom(),
2631              &quot;humongous regions should go around loop once only&quot;);
2632 
2633       // Some special cases:
2634       // If the memory region is empty, we can just give up the region.
2635       // If the current region is humongous then we only need to check
2636       // the bitmap for the bit associated with the start of the object,
2637       // scan the object if it&#39;s live, and give up the region.
2638       // Otherwise, let&#39;s iterate over the bitmap of the part of the region
2639       // that is left.
2640       // If the iteration is successful, give up the region.
2641       if (mr.is_empty()) {
2642         giveup_current_region();
2643         abort_marking_if_regular_check_fail();
2644       } else if (_curr_region-&gt;is_humongous() &amp;&amp; mr.start() == _curr_region-&gt;bottom()) {
2645         if (_next_mark_bitmap-&gt;is_marked(mr.start())) {
2646           // The object is marked - apply the closure
2647           bitmap_closure.do_addr(mr.start());
2648         }
2649         // Even if this task aborted while scanning the humongous object
2650         // we can (and should) give up the current region.
2651         giveup_current_region();
2652         abort_marking_if_regular_check_fail();
2653       } else if (_next_mark_bitmap-&gt;iterate(&amp;bitmap_closure, mr)) {
2654         giveup_current_region();
2655         abort_marking_if_regular_check_fail();
2656       } else {
2657         assert(has_aborted(), &quot;currently the only way to do so&quot;);
2658         // The only way to abort the bitmap iteration is to return
2659         // false from the do_bit() method. However, inside the
2660         // do_bit() method we move the _finger to point to the
2661         // object currently being looked at. So, if we bail out, we
2662         // have definitely set _finger to something non-null.
2663         assert(_finger != NULL, &quot;invariant&quot;);
2664 
2665         // Region iteration was actually aborted. So now _finger
2666         // points to the address of the object we last scanned. If we
2667         // leave it there, when we restart this task, we will rescan
2668         // the object. It is easy to avoid this. We move the finger by
2669         // enough to point to the next possible object header.
2670         assert(_finger &lt; _region_limit, &quot;invariant&quot;);
2671         HeapWord* const new_finger = _finger + ((oop)_finger)-&gt;size();
2672         // Check if bitmap iteration was aborted while scanning the last object
2673         if (new_finger &gt;= _region_limit) {
2674           giveup_current_region();
2675         } else {
2676           move_finger_to(new_finger);
2677         }
2678       }
2679     }
2680     // At this point we have either completed iterating over the
2681     // region we were holding on to, or we have aborted.
2682 
2683     // We then partially drain the local queue and the global stack.
2684     // (Do we really need this?)
2685     drain_local_queue(true);
2686     drain_global_stack(true);
2687 
2688     // Read the note on the claim_region() method on why it might
2689     // return NULL with potentially more regions available for
2690     // claiming and why we have to check out_of_regions() to determine
2691     // whether we&#39;re done or not.
2692     while (!has_aborted() &amp;&amp; _curr_region == NULL &amp;&amp; !_cm-&gt;out_of_regions()) {
2693       // We are going to try to claim a new region. We should have
2694       // given up on the previous one.
2695       // Separated the asserts so that we know which one fires.
2696       assert(_curr_region  == NULL, &quot;invariant&quot;);
2697       assert(_finger       == NULL, &quot;invariant&quot;);
2698       assert(_region_limit == NULL, &quot;invariant&quot;);
2699       HeapRegion* claimed_region = _cm-&gt;claim_region(_worker_id);
2700       if (claimed_region != NULL) {
2701         // Yes, we managed to claim one
2702         setup_for_region(claimed_region);
2703         assert(_curr_region == claimed_region, &quot;invariant&quot;);
2704       }
2705       // It is important to call the regular clock here. It might take
2706       // a while to claim a region if, for example, we hit a large
2707       // block of empty regions. So we need to call the regular clock
2708       // method once round the loop to make sure it&#39;s called
2709       // frequently enough.
2710       abort_marking_if_regular_check_fail();
2711     }
2712 
2713     if (!has_aborted() &amp;&amp; _curr_region == NULL) {
2714       assert(_cm-&gt;out_of_regions(),
2715              &quot;at this point we should be out of regions&quot;);
2716     }
2717   } while ( _curr_region != NULL &amp;&amp; !has_aborted());
2718 
2719   if (!has_aborted()) {
2720     // We cannot check whether the global stack is empty, since other
2721     // tasks might be pushing objects to it concurrently.
2722     assert(_cm-&gt;out_of_regions(),
2723            &quot;at this point we should be out of regions&quot;);
2724     // Try to reduce the number of available SATB buffers so that
2725     // remark has less work to do.
2726     drain_satb_buffers();
2727   }
2728 
2729   // Since we&#39;ve done everything else, we can now totally drain the
2730   // local queue and global stack.
2731   drain_local_queue(false);
2732   drain_global_stack(false);
2733 
2734   // Attempt at work stealing from other task&#39;s queues.
2735   if (do_stealing &amp;&amp; !has_aborted()) {
2736     // We have not aborted. This means that we have finished all that
2737     // we could. Let&#39;s try to do some stealing...
2738 
2739     // We cannot check whether the global stack is empty, since other
2740     // tasks might be pushing objects to it concurrently.
2741     assert(_cm-&gt;out_of_regions() &amp;&amp; _task_queue-&gt;size() == 0,
2742            &quot;only way to reach here&quot;);
2743     while (!has_aborted()) {
2744       G1TaskQueueEntry entry;
2745       if (_cm-&gt;try_stealing(_worker_id, entry)) {
2746         scan_task_entry(entry);
2747 
2748         // And since we&#39;re towards the end, let&#39;s totally drain the
2749         // local queue and global stack.
2750         drain_local_queue(false);
2751         drain_global_stack(false);
2752       } else {
2753         break;
2754       }
2755     }
2756   }
2757 
2758   // We still haven&#39;t aborted. Now, let&#39;s try to get into the
2759   // termination protocol.
2760   if (do_termination &amp;&amp; !has_aborted()) {
2761     // We cannot check whether the global stack is empty, since other
2762     // tasks might be concurrently pushing objects on it.
2763     // Separated the asserts so that we know which one fires.
2764     assert(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2765     assert(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2766     _termination_start_time_ms = os::elapsedVTime() * 1000.0;
2767 
2768     // The G1CMTask class also extends the TerminatorTerminator class,
2769     // hence its should_exit_termination() method will also decide
2770     // whether to exit the termination protocol or not.
2771     bool finished = (is_serial ||
2772                      _cm-&gt;terminator()-&gt;offer_termination(this));
2773     double termination_end_time_ms = os::elapsedVTime() * 1000.0;
2774     _termination_time_ms +=
2775       termination_end_time_ms - _termination_start_time_ms;
2776 
2777     if (finished) {
2778       // We&#39;re all done.
2779 
2780       // We can now guarantee that the global stack is empty, since
2781       // all other tasks have finished. We separated the guarantees so
2782       // that, if a condition is false, we can immediately find out
2783       // which one.
2784       guarantee(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2785       guarantee(_cm-&gt;mark_stack_empty(), &quot;only way to reach here&quot;);
2786       guarantee(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2787       guarantee(!_cm-&gt;has_overflown(), &quot;only way to reach here&quot;);
2788       guarantee(!has_aborted(), &quot;should never happen if termination has completed&quot;);
2789     } else {
2790       // Apparently there&#39;s more work to do. Let&#39;s abort this task. It
2791       // will restart it and we can hopefully find more things to do.
2792       set_has_aborted();
2793     }
2794   }
2795 
2796   // Mainly for debugging purposes to make sure that a pointer to the
2797   // closure which was statically allocated in this frame doesn&#39;t
2798   // escape it by accident.
2799   set_cm_oop_closure(NULL);
2800   double end_time_ms = os::elapsedVTime() * 1000.0;
2801   double elapsed_time_ms = end_time_ms - _start_time_ms;
2802   // Update the step history.
2803   _step_times_ms.add(elapsed_time_ms);
2804 
2805   if (has_aborted()) {
2806     // The task was aborted for some reason.
2807     if (_has_timed_out) {
2808       double diff_ms = elapsed_time_ms - _time_target_ms;
2809       // Keep statistics of how well we did with respect to hitting
2810       // our target only if we actually timed out (if we aborted for
2811       // other reasons, then the results might get skewed).
<a name="52" id="anc52"></a><span class="line-modified">2812       _marking_step_diffs_ms.add(diff_ms);</span>
2813     }
2814 
2815     if (_cm-&gt;has_overflown()) {
2816       // This is the interesting one. We aborted because a global
2817       // overflow was raised. This means we have to restart the
2818       // marking phase and start iterating over regions. However, in
2819       // order to do this we have to make sure that all tasks stop
2820       // what they are doing and re-initialize in a safe manner. We
2821       // will achieve this with the use of two barrier sync points.
2822 
2823       if (!is_serial) {
2824         // We only need to enter the sync barrier if being called
2825         // from a parallel context
2826         _cm-&gt;enter_first_sync_barrier(_worker_id);
2827 
2828         // When we exit this sync barrier we know that all tasks have
2829         // stopped doing marking work. So, it&#39;s now safe to
2830         // re-initialize our data structures.
2831       }
2832 
2833       clear_region_fields();
2834       flush_mark_stats_cache();
2835 
2836       if (!is_serial) {
2837         // If we&#39;re executing the concurrent phase of marking, reset the marking
2838         // state; otherwise the marking state is reset after reference processing,
2839         // during the remark pause.
2840         // If we reset here as a result of an overflow during the remark we will
2841         // see assertion failures from any subsequent set_concurrency_and_phase()
2842         // calls.
2843         if (_cm-&gt;concurrent() &amp;&amp; _worker_id == 0) {
2844           // Worker 0 is responsible for clearing the global data structures because
2845           // of an overflow. During STW we should not clear the overflow flag (in
2846           // G1ConcurrentMark::reset_marking_state()) since we rely on it being true when we exit
2847           // method to abort the pause and restart concurrent marking.
2848           _cm-&gt;reset_marking_for_restart();
2849 
2850           log_info(gc, marking)(&quot;Concurrent Mark reset for overflow&quot;);
2851         }
2852 
2853         // ...and enter the second barrier.
2854         _cm-&gt;enter_second_sync_barrier(_worker_id);
2855       }
2856       // At this point, if we&#39;re during the concurrent phase of
2857       // marking, everything has been re-initialized and we&#39;re
2858       // ready to restart.
2859     }
2860   }
2861 }
2862 
2863 G1CMTask::G1CMTask(uint worker_id,
2864                    G1ConcurrentMark* cm,
2865                    G1CMTaskQueue* task_queue,
2866                    G1RegionMarkStats* mark_stats,
2867                    uint max_regions) :
2868   _objArray_processor(this),
2869   _worker_id(worker_id),
2870   _g1h(G1CollectedHeap::heap()),
2871   _cm(cm),
2872   _next_mark_bitmap(NULL),
2873   _task_queue(task_queue),
2874   _mark_stats_cache(mark_stats, max_regions, RegionMarkStatsCacheSize),
2875   _calls(0),
2876   _time_target_ms(0.0),
2877   _start_time_ms(0.0),
2878   _cm_oop_closure(NULL),
2879   _curr_region(NULL),
2880   _finger(NULL),
2881   _region_limit(NULL),
2882   _words_scanned(0),
2883   _words_scanned_limit(0),
2884   _real_words_scanned_limit(0),
2885   _refs_reached(0),
2886   _refs_reached_limit(0),
2887   _real_refs_reached_limit(0),
2888   _has_aborted(false),
2889   _has_timed_out(false),
2890   _draining_satb_buffers(false),
2891   _step_times_ms(),
2892   _elapsed_time_ms(0.0),
2893   _termination_time_ms(0.0),
2894   _termination_start_time_ms(0.0),
<a name="53" id="anc53"></a><span class="line-modified">2895   _marking_step_diffs_ms()</span>
2896 {
2897   guarantee(task_queue != NULL, &quot;invariant&quot;);
2898 
<a name="54" id="anc54"></a><span class="line-modified">2899   _marking_step_diffs_ms.add(0.5);</span>
2900 }
2901 
2902 // These are formatting macros that are used below to ensure
2903 // consistent formatting. The *_H_* versions are used to format the
2904 // header for a particular value and they should be kept consistent
2905 // with the corresponding macro. Also note that most of the macros add
2906 // the necessary white space (as a prefix) which makes them a bit
2907 // easier to compose.
2908 
2909 // All the output lines are prefixed with this string to be able to
2910 // identify them easily in a large log file.
2911 #define G1PPRL_LINE_PREFIX            &quot;###&quot;
2912 
2913 #define G1PPRL_ADDR_BASE_FORMAT    &quot; &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT
2914 #ifdef _LP64
2915 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %37s&quot;
2916 #else // _LP64
2917 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %21s&quot;
2918 #endif // _LP64
2919 
2920 // For per-region info
2921 #define G1PPRL_TYPE_FORMAT            &quot;   %-4s&quot;
2922 #define G1PPRL_TYPE_H_FORMAT          &quot;   %4s&quot;
2923 #define G1PPRL_STATE_FORMAT           &quot;   %-5s&quot;
2924 #define G1PPRL_STATE_H_FORMAT         &quot;   %5s&quot;
2925 #define G1PPRL_BYTE_FORMAT            &quot;  &quot; SIZE_FORMAT_W(9)
2926 #define G1PPRL_BYTE_H_FORMAT          &quot;  %9s&quot;
2927 #define G1PPRL_DOUBLE_FORMAT          &quot;  %14.1f&quot;
2928 #define G1PPRL_DOUBLE_H_FORMAT        &quot;  %14s&quot;
2929 
2930 // For summary info
2931 #define G1PPRL_SUM_ADDR_FORMAT(tag)    &quot;  &quot; tag &quot;:&quot; G1PPRL_ADDR_BASE_FORMAT
2932 #define G1PPRL_SUM_BYTE_FORMAT(tag)    &quot;  &quot; tag &quot;: &quot; SIZE_FORMAT
2933 #define G1PPRL_SUM_MB_FORMAT(tag)      &quot;  &quot; tag &quot;: %1.2f MB&quot;
2934 #define G1PPRL_SUM_MB_PERC_FORMAT(tag) G1PPRL_SUM_MB_FORMAT(tag) &quot; / %1.2f %%&quot;
2935 
2936 G1PrintRegionLivenessInfoClosure::G1PrintRegionLivenessInfoClosure(const char* phase_name) :
2937   _total_used_bytes(0), _total_capacity_bytes(0),
2938   _total_prev_live_bytes(0), _total_next_live_bytes(0),
2939   _total_remset_bytes(0), _total_strong_code_roots_bytes(0)
2940 {
2941   if (!log_is_enabled(Trace, gc, liveness)) {
2942     return;
2943   }
2944 
2945   G1CollectedHeap* g1h = G1CollectedHeap::heap();
2946   MemRegion g1_reserved = g1h-&gt;g1_reserved();
2947   double now = os::elapsedTime();
2948 
2949   // Print the header of the output.
2950   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; PHASE %s @ %1.3f&quot;, phase_name, now);
2951   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; HEAP&quot;
2952                           G1PPRL_SUM_ADDR_FORMAT(&quot;reserved&quot;)
2953                           G1PPRL_SUM_BYTE_FORMAT(&quot;region-size&quot;),
2954                           p2i(g1_reserved.start()), p2i(g1_reserved.end()),
2955                           HeapRegion::GrainBytes);
2956   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
2957   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2958                           G1PPRL_TYPE_H_FORMAT
2959                           G1PPRL_ADDR_BASE_H_FORMAT
2960                           G1PPRL_BYTE_H_FORMAT
2961                           G1PPRL_BYTE_H_FORMAT
2962                           G1PPRL_BYTE_H_FORMAT
2963                           G1PPRL_DOUBLE_H_FORMAT
2964                           G1PPRL_BYTE_H_FORMAT
2965                           G1PPRL_STATE_H_FORMAT
2966                           G1PPRL_BYTE_H_FORMAT,
2967                           &quot;type&quot;, &quot;address-range&quot;,
2968                           &quot;used&quot;, &quot;prev-live&quot;, &quot;next-live&quot;, &quot;gc-eff&quot;,
2969                           &quot;remset&quot;, &quot;state&quot;, &quot;code-roots&quot;);
2970   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2971                           G1PPRL_TYPE_H_FORMAT
2972                           G1PPRL_ADDR_BASE_H_FORMAT
2973                           G1PPRL_BYTE_H_FORMAT
2974                           G1PPRL_BYTE_H_FORMAT
2975                           G1PPRL_BYTE_H_FORMAT
2976                           G1PPRL_DOUBLE_H_FORMAT
2977                           G1PPRL_BYTE_H_FORMAT
2978                           G1PPRL_STATE_H_FORMAT
2979                           G1PPRL_BYTE_H_FORMAT,
2980                           &quot;&quot;, &quot;&quot;,
2981                           &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes/ms)&quot;,
2982                           &quot;(bytes)&quot;, &quot;&quot;, &quot;(bytes)&quot;);
2983 }
2984 
2985 bool G1PrintRegionLivenessInfoClosure::do_heap_region(HeapRegion* r) {
2986   if (!log_is_enabled(Trace, gc, liveness)) {
2987     return false;
2988   }
2989 
2990   const char* type       = r-&gt;get_type_str();
2991   HeapWord* bottom       = r-&gt;bottom();
2992   HeapWord* end          = r-&gt;end();
2993   size_t capacity_bytes  = r-&gt;capacity();
2994   size_t used_bytes      = r-&gt;used();
2995   size_t prev_live_bytes = r-&gt;live_bytes();
2996   size_t next_live_bytes = r-&gt;next_live_bytes();
2997   double gc_eff          = r-&gt;gc_efficiency();
2998   size_t remset_bytes    = r-&gt;rem_set()-&gt;mem_size();
2999   size_t strong_code_roots_bytes = r-&gt;rem_set()-&gt;strong_code_roots_mem_size();
3000   const char* remset_type = r-&gt;rem_set()-&gt;get_short_state_str();
3001 
3002   _total_used_bytes      += used_bytes;
3003   _total_capacity_bytes  += capacity_bytes;
3004   _total_prev_live_bytes += prev_live_bytes;
3005   _total_next_live_bytes += next_live_bytes;
3006   _total_remset_bytes    += remset_bytes;
3007   _total_strong_code_roots_bytes += strong_code_roots_bytes;
3008 
3009   // Print a line for this particular region.
3010   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3011                           G1PPRL_TYPE_FORMAT
3012                           G1PPRL_ADDR_BASE_FORMAT
3013                           G1PPRL_BYTE_FORMAT
3014                           G1PPRL_BYTE_FORMAT
3015                           G1PPRL_BYTE_FORMAT
3016                           G1PPRL_DOUBLE_FORMAT
3017                           G1PPRL_BYTE_FORMAT
3018                           G1PPRL_STATE_FORMAT
3019                           G1PPRL_BYTE_FORMAT,
3020                           type, p2i(bottom), p2i(end),
3021                           used_bytes, prev_live_bytes, next_live_bytes, gc_eff,
3022                           remset_bytes, remset_type, strong_code_roots_bytes);
3023 
3024   return false;
3025 }
3026 
3027 G1PrintRegionLivenessInfoClosure::~G1PrintRegionLivenessInfoClosure() {
3028   if (!log_is_enabled(Trace, gc, liveness)) {
3029     return;
3030   }
3031 
3032   // add static memory usages to remembered set sizes
3033   _total_remset_bytes += HeapRegionRemSet::fl_mem_size() + HeapRegionRemSet::static_mem_size();
3034   // Print the footer of the output.
3035   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
3036   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3037                          &quot; SUMMARY&quot;
3038                          G1PPRL_SUM_MB_FORMAT(&quot;capacity&quot;)
3039                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;used&quot;)
3040                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;prev-live&quot;)
3041                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;next-live&quot;)
3042                          G1PPRL_SUM_MB_FORMAT(&quot;remset&quot;)
3043                          G1PPRL_SUM_MB_FORMAT(&quot;code-roots&quot;),
3044                          bytes_to_mb(_total_capacity_bytes),
3045                          bytes_to_mb(_total_used_bytes),
3046                          percent_of(_total_used_bytes, _total_capacity_bytes),
3047                          bytes_to_mb(_total_prev_live_bytes),
3048                          percent_of(_total_prev_live_bytes, _total_capacity_bytes),
3049                          bytes_to_mb(_total_next_live_bytes),
3050                          percent_of(_total_next_live_bytes, _total_capacity_bytes),
3051                          bytes_to_mb(_total_remset_bytes),
3052                          bytes_to_mb(_total_strong_code_roots_bytes));
3053 }
<a name="55" id="anc55"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="55" type="hidden" />
</body>
</html>