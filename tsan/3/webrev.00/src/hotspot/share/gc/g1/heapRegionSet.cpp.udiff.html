<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/heapRegionSet.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="heapRegionRemSet.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="heapRegionSet.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/heapRegionSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,10 +22,11 @@</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;gc/g1/g1NUMA.hpp&quot;</span>
  #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  
  uint FreeRegionList::_unrealistically_long_length = 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,10 +88,16 @@</span>
  void FreeRegionList::set_unrealistically_long_length(uint len) {
    guarantee(_unrealistically_long_length == 0, &quot;should only be set once&quot;);
    _unrealistically_long_length = len;
  }
  
<span class="udiff-line-added">+ void FreeRegionList::abandon() {</span>
<span class="udiff-line-added">+   check_mt_safety();</span>
<span class="udiff-line-added">+   clear();</span>
<span class="udiff-line-added">+   verify_optional();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void FreeRegionList::remove_all() {
    check_mt_safety();
    verify_optional();
  
    HeapRegion* curr = _head;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -99,28 +106,34 @@</span>
  
      HeapRegion* next = curr-&gt;next();
      curr-&gt;set_next(NULL);
      curr-&gt;set_prev(NULL);
      curr-&gt;set_containing_set(NULL);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     decrease_length(curr-&gt;node_index());</span>
<span class="udiff-line-added">+ </span>
      curr = next;
    }
    clear();
  
    verify_optional();
  }
  
<span class="udiff-line-modified-removed">- void FreeRegionList::add_ordered(FreeRegionList* from_list) {</span>
<span class="udiff-line-modified-added">+ void FreeRegionList::add_list_common_start(FreeRegionList* from_list) {</span>
    check_mt_safety();
    from_list-&gt;check_mt_safety();
<span class="udiff-line-removed">- </span>
    verify_optional();
    from_list-&gt;verify_optional();
  
    if (from_list-&gt;is_empty()) {
      return;
    }
  
<span class="udiff-line-added">+   if (_node_info != NULL &amp;&amp; from_list-&gt;_node_info != NULL) {</span>
<span class="udiff-line-added">+     _node_info-&gt;add(from_list-&gt;_node_info);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    #ifdef ASSERT
    FreeRegionListIterator iter(from_list);
    while (iter.more_available()) {
      HeapRegion* hr = iter.get_next();
      // In set_containing_set() we check that we either set the value
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,10 +141,51 @@</span>
      // to NULL it first before setting it to the value.
      hr-&gt;set_containing_set(NULL);
      hr-&gt;set_containing_set(this);
    }
    #endif // ASSERT
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FreeRegionList::add_list_common_end(FreeRegionList* from_list) {</span>
<span class="udiff-line-added">+   _length += from_list-&gt;length();</span>
<span class="udiff-line-added">+   from_list-&gt;clear();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   verify_optional();</span>
<span class="udiff-line-added">+   from_list-&gt;verify_optional();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FreeRegionList::append_ordered(FreeRegionList* from_list) {</span>
<span class="udiff-line-added">+   add_list_common_start(from_list);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (from_list-&gt;is_empty()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (is_empty()) {</span>
<span class="udiff-line-added">+     // Make from_list the current list.</span>
<span class="udiff-line-added">+     assert_free_region_list(length() == 0 &amp;&amp; _tail == NULL, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+     _head = from_list-&gt;_head;</span>
<span class="udiff-line-added">+     _tail = from_list-&gt;_tail;</span>
<span class="udiff-line-added">+   } else {</span>
<span class="udiff-line-added">+     // Add the from_list to the end of the current list.</span>
<span class="udiff-line-added">+     assert(_tail-&gt;hrm_index() &lt; from_list-&gt;_head-&gt;hrm_index(), &quot;Should be sorted %u &lt; %u&quot;,</span>
<span class="udiff-line-added">+            _tail-&gt;hrm_index(), from_list-&gt;_head-&gt;hrm_index());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     _tail-&gt;set_next(from_list-&gt;_head);</span>
<span class="udiff-line-added">+     from_list-&gt;_head-&gt;set_prev(_tail);</span>
<span class="udiff-line-added">+     _tail = from_list-&gt;_tail;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   add_list_common_end(from_list);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FreeRegionList::add_ordered(FreeRegionList* from_list) {</span>
<span class="udiff-line-added">+   add_list_common_start(from_list);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (from_list-&gt;is_empty()) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
  
    if (is_empty()) {
      assert_free_region_list(length() == 0 &amp;&amp; _tail == NULL, &quot;invariant&quot;);
      _head = from_list-&gt;_head;
      _tail = from_list-&gt;_tail;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -168,15 +222,11 @@</span>
      if (_tail-&gt;hrm_index() &lt; from_list-&gt;_tail-&gt;hrm_index()) {
        _tail = from_list-&gt;_tail;
      }
    }
  
<span class="udiff-line-modified-removed">-   _length += from_list-&gt;length();</span>
<span class="udiff-line-removed">-   from_list-&gt;clear();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   verify_optional();</span>
<span class="udiff-line-removed">-   from_list-&gt;verify_optional();</span>
<span class="udiff-line-modified-added">+   add_list_common_end(from_list);</span>
  }
  
  void FreeRegionList::remove_starting_at(HeapRegion* first, uint num_regions) {
    check_mt_safety();
    assert_free_region_list(num_regions &gt;= 1, &quot;pre-condition&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,10 +268,13 @@</span>
      curr-&gt;set_next(NULL);
      curr-&gt;set_prev(NULL);
      remove(curr);
  
      count++;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     decrease_length(curr-&gt;node_index());</span>
<span class="udiff-line-added">+ </span>
      curr = next;
    }
  
    assert(count == num_regions,
           &quot;[%s] count: %u should be == num_regions: %u&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -265,10 +318,14 @@</span>
  void FreeRegionList::clear() {
    _length = 0;
    _head = NULL;
    _tail = NULL;
    _last = NULL;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (_node_info!= NULL) {</span>
<span class="udiff-line-added">+     _node_info-&gt;clear();</span>
<span class="udiff-line-added">+   }</span>
  }
  
  void FreeRegionList::verify_list() {
    HeapRegion* curr = _head;
    HeapRegion* prev1 = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -301,5 +358,43 @@</span>
  
    guarantee(_tail == prev0, &quot;Expected %s to end with %u but it ended with %u.&quot;, name(), _tail-&gt;hrm_index(), prev0-&gt;hrm_index());
    guarantee(_tail == NULL || _tail-&gt;next() == NULL, &quot;_tail should not have a next&quot;);
    guarantee(length() == count, &quot;%s count mismatch. Expected %u, actual %u.&quot;, name(), length(), count);
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FreeRegionList::FreeRegionList(const char* name, HeapRegionSetChecker* checker):</span>
<span class="udiff-line-added">+   HeapRegionSetBase(name, checker),</span>
<span class="udiff-line-added">+   _node_info(G1NUMA::numa()-&gt;is_enabled() ? new NodeInfo() : NULL) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   clear();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FreeRegionList::~FreeRegionList() {</span>
<span class="udiff-line-added">+   if (_node_info != NULL) {</span>
<span class="udiff-line-added">+     delete _node_info;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FreeRegionList::NodeInfo::NodeInfo() : _numa(G1NUMA::numa()), _length_of_node(NULL),</span>
<span class="udiff-line-added">+                                        _num_nodes(_numa-&gt;num_active_nodes()) {</span>
<span class="udiff-line-added">+   assert(UseNUMA, &quot;Invariant&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _length_of_node = NEW_C_HEAP_ARRAY(uint, _num_nodes, mtGC);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FreeRegionList::NodeInfo::~NodeInfo() {</span>
<span class="udiff-line-added">+   FREE_C_HEAP_ARRAY(uint, _length_of_node);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FreeRegionList::NodeInfo::clear() {</span>
<span class="udiff-line-added">+   for (uint i = 0; i &lt; _num_nodes; ++i) {</span>
<span class="udiff-line-added">+     _length_of_node[i] = 0;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FreeRegionList::NodeInfo::add(NodeInfo* info) {</span>
<span class="udiff-line-added">+   for (uint i = 0; i &lt; _num_nodes; ++i) {</span>
<span class="udiff-line-added">+     _length_of_node[i] += info-&gt;_length_of_node[i];</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
</pre>
<center><a href="heapRegionRemSet.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="heapRegionSet.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>