<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/g1/g1RegionToSpaceMapper.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_G1_G1REGIONTOSPACEMAPPER_HPP
 26 #define SHARE_GC_G1_G1REGIONTOSPACEMAPPER_HPP
 27 
 28 #include &quot;gc/g1/g1PageBasedVirtualSpace.hpp&quot;
 29 #include &quot;memory/allocation.hpp&quot;
 30 #include &quot;utilities/debug.hpp&quot;
 31 
 32 class WorkGang;
 33 
 34 class G1MappingChangedListener {
 35  public:
 36   // Fired after commit of the memory, i.e. the memory this listener is registered
 37   // for can be accessed.
 38   // Zero_filled indicates that the memory can be considered as filled with zero bytes
 39   // when called.
 40   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled) = 0;
 41 };
 42 
 43 // Maps region based commit/uncommit requests to the underlying page sized virtual
 44 // space.
 45 class G1RegionToSpaceMapper : public CHeapObj&lt;mtGC&gt; {
 46  private:
 47   G1MappingChangedListener* _listener;
 48  protected:
 49   // Backing storage.
 50   G1PageBasedVirtualSpace _storage;
 51 
 52   size_t _region_granularity;
 53   // Mapping management
 54   CHeapBitMap _commit_map;
 55 
 56   MemoryType _memory_type;
 57 
 58   G1RegionToSpaceMapper(ReservedSpace rs, size_t used_size, size_t page_size, size_t region_granularity, size_t commit_factor, MemoryType type);
 59 
 60   void fire_on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 61  public:
 62   MemRegion reserved() { return _storage.reserved(); }
 63 
 64   size_t reserved_size() { return _storage.reserved_size(); }
 65   size_t committed_size() { return _storage.committed_size(); }
 66 
 67   void set_mapping_changed_listener(G1MappingChangedListener* listener) { _listener = listener; }
 68 
 69   virtual ~G1RegionToSpaceMapper() {}
 70 
 71   bool is_committed(uintptr_t idx) const {
 72     return _commit_map.at(idx);
 73   }
 74 
 75   void commit_and_set_special();
 76   virtual void commit_regions(uint start_idx, size_t num_regions = 1, WorkGang* pretouch_workers = NULL) = 0;
 77   virtual void uncommit_regions(uint start_idx, size_t num_regions = 1) = 0;
 78 
 79   // Creates an appropriate G1RegionToSpaceMapper for the given parameters.
 80   // The actual space to be used within the given reservation is given by actual_size.
 81   // This is because some OSes need to round up the reservation size to guarantee
 82   // alignment of page_size.
 83   // The byte_translation_factor defines how many bytes in a region correspond to
 84   // a single byte in the data structure this mapper is for.
 85   // Eg. in the card table, this value corresponds to the size a single card
 86   // table entry corresponds to in the heap.
 87   static G1RegionToSpaceMapper* create_mapper(ReservedSpace rs,
 88                                               size_t actual_size,
 89                                               size_t page_size,
 90                                               size_t region_granularity,
 91                                               size_t byte_translation_factor,
 92                                               MemoryType type);
 93 
 94   static G1RegionToSpaceMapper* create_heap_mapper(ReservedSpace rs,
 95                                                    size_t actual_size,
 96                                                    size_t page_size,
 97                                                    size_t region_granularity,
 98                                                    size_t byte_translation_factor,
 99                                                    MemoryType type);
100 };
101 
102 // G1RegionToSpaceMapper implementation where
103 // part of space is mapped to dram and part to nv-dimm
104 class G1RegionToHeteroSpaceMapper : public G1RegionToSpaceMapper {
105 private:
106   ReservedSpace _rs;
107   G1RegionToSpaceMapper* _dram_mapper;
108   uint _num_committed_dram;
109   uint _num_committed_nvdimm;
110   uint _start_index_of_dram;
111   size_t _page_size;
112   size_t _commit_factor;
113   MemoryType _type;
114 
115 public:
116   G1RegionToHeteroSpaceMapper(ReservedSpace rs, size_t used_size, size_t page_size, size_t region_granularity, size_t commit_factor, MemoryType type);
117   bool initialize();
118   uint num_committed_dram() const;
119   uint num_committed_nvdimm() const;
120 
121   virtual void commit_regions(uint start_idx, size_t num_regions = 1, WorkGang* pretouch_workers = NULL);
122   virtual void uncommit_regions(uint start_idx, size_t num_regions = 1);
123 };
124 #endif // SHARE_GC_G1_G1REGIONTOSPACEMAPPER_HPP
    </pre>
  </body>
</html>