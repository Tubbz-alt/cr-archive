<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/sparsePRT.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="jvmFlagConstraintsG1.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="sparsePRT.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/sparsePRT.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +28,10 @@</span>
  #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  #include &quot;gc/g1/sparsePRT.hpp&quot;
  #include &quot;gc/shared/cardTableBarrierSet.hpp&quot;
  #include &quot;gc/shared/space.inline.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
<span class="udiff-line-removed">- #include &quot;runtime/atomic.hpp&quot;</span>
  #include &quot;runtime/mutexLocker.hpp&quot;
  
  // Check that the size of the SparsePRTEntry is evenly divisible by the maximum
  // member type to avoid SIGBUS when accessing them.
  STATIC_ASSERT(sizeof(SparsePRTEntry) % sizeof(int) == 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,23 +54,23 @@</span>
      }
    }
    return false;
  }
  
<span class="udiff-line-modified-removed">- SparsePRTEntry::AddCardResult SparsePRTEntry::add_card(CardIdx_t card_index) {</span>
<span class="udiff-line-modified-added">+ SparsePRT::AddCardResult SparsePRTEntry::add_card(CardIdx_t card_index) {</span>
    for (int i = 0; i &lt; num_valid_cards(); i++) {
      if (card(i) == card_index) {
<span class="udiff-line-modified-removed">-       return found;</span>
<span class="udiff-line-modified-added">+       return SparsePRT::found;</span>
      }
    }
    if (num_valid_cards() &lt; cards_num() - 1) {
      _cards[_next_null] = (card_elem_t)card_index;
      _next_null++;
<span class="udiff-line-modified-removed">-     return added;</span>
<span class="udiff-line-modified-added">+     return SparsePRT::added;</span>
     }
    // Otherwise, we&#39;re full.
<span class="udiff-line-modified-removed">-   return overflow;</span>
<span class="udiff-line-modified-added">+   return SparsePRT::overflow;</span>
  }
  
  void SparsePRTEntry::copy_cards(card_elem_t* cards) const {
    memcpy(cards, _cards, cards_num() * sizeof(card_elem_t));
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,11 +89,10 @@</span>
  RSHashTable::RSHashTable(size_t capacity) :
    _num_entries(0),
    _capacity(capacity),
    _capacity_mask(capacity-1),
    _occupied_entries(0),
<span class="udiff-line-removed">-   _occupied_cards(0),</span>
    _entries(NULL),
    _buckets(NEW_C_HEAP_ARRAY(int, capacity, mtGC)),
    _free_region(0),
    _free_list(NullEntry)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,23 +100,16 @@</span>
    _entries = (SparsePRTEntry*)NEW_C_HEAP_ARRAY(char, _num_entries * SparsePRTEntry::size(), mtGC);
    clear();
  }
  
  RSHashTable::~RSHashTable() {
<span class="udiff-line-modified-removed">-   if (_entries != NULL) {</span>
<span class="udiff-line-modified-removed">-     FREE_C_HEAP_ARRAY(SparsePRTEntry, _entries);</span>
<span class="udiff-line-removed">-     _entries = NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   if (_buckets != NULL) {</span>
<span class="udiff-line-removed">-     FREE_C_HEAP_ARRAY(int, _buckets);</span>
<span class="udiff-line-removed">-     _buckets = NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(SparsePRTEntry, _entries);</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(int, _buckets);</span>
  }
  
  void RSHashTable::clear() {
    _occupied_entries = 0;
<span class="udiff-line-removed">-   _occupied_cards = 0;</span>
    guarantee(_entries != NULL, &quot;INV&quot;);
    guarantee(_buckets != NULL, &quot;INV&quot;);
  
    guarantee(_capacity &lt;= ((size_t)1 &lt;&lt; (sizeof(int)*BitsPerByte-1)) - 1,
                  &quot;_capacity too large&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,18 +119,17 @@</span>
    memset((void*)_buckets, NullEntry, _capacity * sizeof(int));
    _free_list = NullEntry;
    _free_region = 0;
  }
  
<span class="udiff-line-modified-removed">- bool RSHashTable::add_card(RegionIdx_t region_ind, CardIdx_t card_index) {</span>
<span class="udiff-line-modified-added">+ SparsePRT::AddCardResult RSHashTable::add_card(RegionIdx_t region_ind, CardIdx_t card_index) {</span>
    SparsePRTEntry* e = entry_for_region_ind_create(region_ind);
    assert(e != NULL &amp;&amp; e-&gt;r_ind() == region_ind,
           &quot;Postcondition of call above.&quot;);
<span class="udiff-line-modified-removed">-   SparsePRTEntry::AddCardResult res = e-&gt;add_card(card_index);</span>
<span class="udiff-line-removed">-   if (res == SparsePRTEntry::added) _occupied_cards++;</span>
<span class="udiff-line-modified-added">+   SparsePRT::AddCardResult res = e-&gt;add_card(card_index);</span>
    assert(e-&gt;num_valid_cards() &gt; 0, &quot;Postcondition&quot;);
<span class="udiff-line-modified-removed">-   return res != SparsePRTEntry::overflow;</span>
<span class="udiff-line-modified-added">+   return res;</span>
  }
  
  SparsePRTEntry* RSHashTable::get_entry(RegionIdx_t region_ind) const {
    int ind = (int) (region_ind &amp; capacity_mask());
    int cur_ind = _buckets[ind];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -168,11 +158,10 @@</span>
    }
  
    if (cur_ind == NullEntry) return false;
    // Otherwise, splice out &quot;cur&quot;.
    *prev_loc = cur-&gt;next_index();
<span class="udiff-line-removed">-   _occupied_cards -= cur-&gt;num_valid_cards();</span>
    free_entry(cur_ind);
    _occupied_entries--;
    return true;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,11 +203,10 @@</span>
  
  void RSHashTable::add_entry(SparsePRTEntry* e) {
    assert(e-&gt;num_valid_cards() &gt; 0, &quot;Precondition.&quot;);
    SparsePRTEntry* e2 = entry_for_region_ind_create(e-&gt;r_ind());
    e-&gt;copy_cards(e2);
<span class="udiff-line-removed">-   _occupied_cards += e2-&gt;num_valid_cards();</span>
    assert(e2-&gt;num_valid_cards() &gt; 0, &quot;Postcondition.&quot;);
  }
  
  CardIdx_t RSHashTableIter::find_first_card_in_list() {
    while (_bl_ind != RSHashTable::NullEntry) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,10 +261,23 @@</span>
    }
    // Otherwise, there were no entry.
    return false;
  }
  
<span class="udiff-line-added">+ bool RSHashTableBucketIter::has_next(SparsePRTEntry*&amp; entry) {</span>
<span class="udiff-line-added">+   while (_bl_ind == RSHashTable::NullEntry)  {</span>
<span class="udiff-line-added">+     if (_tbl_ind == (int)_rsht-&gt;capacity() - 1) {</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     _tbl_ind++;</span>
<span class="udiff-line-added">+     _bl_ind = _rsht-&gt;_buckets[_tbl_ind];</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   entry = _rsht-&gt;entry(_bl_ind);</span>
<span class="udiff-line-added">+   _bl_ind = entry-&gt;next_index();</span>
<span class="udiff-line-added">+   return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool RSHashTable::contains_card(RegionIdx_t region_index, CardIdx_t card_index) const {
    SparsePRTEntry* e = get_entry(region_index);
    return (e != NULL &amp;&amp; e-&gt;contains_card(card_index));
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -301,11 +302,11 @@</span>
    // We ignore &quot;_cur&quot; here, because it either = _next, or else it is
    // on the deleted list.
    return sizeof(SparsePRT) + _table-&gt;mem_size();
  }
  
<span class="udiff-line-modified-removed">- bool SparsePRT::add_card(RegionIdx_t region_id, CardIdx_t card_index) {</span>
<span class="udiff-line-modified-added">+ SparsePRT::AddCardResult SparsePRT::add_card(RegionIdx_t region_id, CardIdx_t card_index) {</span>
    if (_table-&gt;should_expand()) {
      expand();
    }
    return _table-&gt;add_card(region_id, card_index);
  }
</pre>
<center><a href="jvmFlagConstraintsG1.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="sparsePRT.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>