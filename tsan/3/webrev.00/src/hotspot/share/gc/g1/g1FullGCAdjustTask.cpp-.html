<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/g1/g1FullGCAdjustTask.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 27 #include &quot;gc/g1/g1CollectedHeap.hpp&quot;
 28 #include &quot;gc/g1/g1ConcurrentMarkBitMap.inline.hpp&quot;
 29 #include &quot;gc/g1/g1FullCollector.hpp&quot;
 30 #include &quot;gc/g1/g1FullGCAdjustTask.hpp&quot;
 31 #include &quot;gc/g1/g1FullGCCompactionPoint.hpp&quot;
 32 #include &quot;gc/g1/g1FullGCMarker.hpp&quot;
 33 #include &quot;gc/g1/g1FullGCOopClosures.inline.hpp&quot;
 34 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
 35 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
 36 #include &quot;gc/shared/referenceProcessor.hpp&quot;
 37 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
 38 #include &quot;logging/log.hpp&quot;
 39 #include &quot;memory/iterator.inline.hpp&quot;
 40 #include &quot;runtime/atomic.hpp&quot;
 41 
 42 class G1AdjustLiveClosure : public StackObj {
 43   G1AdjustClosure* _adjust_closure;
 44 public:
 45   G1AdjustLiveClosure(G1AdjustClosure* cl) :
 46     _adjust_closure(cl) { }
 47 
 48   size_t apply(oop object) {
 49     return object-&gt;oop_iterate_size(_adjust_closure);
 50   }
 51 };
 52 
 53 class G1AdjustRegionClosure : public HeapRegionClosure {
 54   G1CMBitMap* _bitmap;
 55   uint _worker_id;
 56  public:
 57   G1AdjustRegionClosure(G1CMBitMap* bitmap, uint worker_id) :
 58     _bitmap(bitmap),
 59     _worker_id(worker_id) { }
 60 
 61   bool do_heap_region(HeapRegion* r) {
 62     G1AdjustClosure cl;
 63     if (r-&gt;is_humongous()) {
 64       oop obj = oop(r-&gt;humongous_start_region()-&gt;bottom());
 65       obj-&gt;oop_iterate(&amp;cl, MemRegion(r-&gt;bottom(), r-&gt;top()));
 66     } else if (r-&gt;is_open_archive()) {
 67       // Only adjust the open archive regions, the closed ones
 68       // never change.
 69       G1AdjustLiveClosure adjust(&amp;cl);
 70       r-&gt;apply_to_marked_objects(_bitmap, &amp;adjust);
 71       // Open archive regions will not be compacted and the marking information is
 72       // no longer needed. Clear it here to avoid having to do it later.
 73       _bitmap-&gt;clear_region(r);
 74     } else {
 75       G1AdjustLiveClosure adjust(&amp;cl);
 76       r-&gt;apply_to_marked_objects(_bitmap, &amp;adjust);
 77     }
 78     return false;
 79   }
 80 };
 81 
 82 G1FullGCAdjustTask::G1FullGCAdjustTask(G1FullCollector* collector) :
 83     G1FullGCTask(&quot;G1 Adjust&quot;, collector),
 84     _root_processor(G1CollectedHeap::heap(), collector-&gt;workers()),
 85     _references_done(0),
 86     _weak_proc_task(collector-&gt;workers()),
 87     _hrclaimer(collector-&gt;workers()),
 88     _adjust(),
 89     _string_dedup_cleaning_task(NULL, &amp;_adjust, false) {
 90   // Need cleared claim bits for the roots processing
 91   ClassLoaderDataGraph::clear_claimed_marks();
 92 }
 93 
 94 void G1FullGCAdjustTask::work(uint worker_id) {
 95   Ticks start = Ticks::now();
 96   ResourceMark rm;
 97 
 98   // Adjust preserved marks first since they are not balanced.
 99   G1FullGCMarker* marker = collector()-&gt;marker(worker_id);
100   marker-&gt;preserved_stack()-&gt;adjust_during_full_gc();
101 
102   // Adjust the weak roots.
103 
104   if (Atomic::add(1u, &amp;_references_done) == 1u) { // First incr claims task.
105     G1CollectedHeap::heap()-&gt;ref_processor_stw()-&gt;weak_oops_do(&amp;_adjust);
106   }
107 
108   AlwaysTrueClosure always_alive;
109   _weak_proc_task.work(worker_id, &amp;always_alive, &amp;_adjust);
110 
111   CLDToOopClosure adjust_cld(&amp;_adjust, ClassLoaderData::_claim_strong);
112   CodeBlobToOopClosure adjust_code(&amp;_adjust, CodeBlobToOopClosure::FixRelocations);
113   _root_processor.process_all_roots(&amp;_adjust, &amp;adjust_cld, &amp;adjust_code);
114 
115   // Adjust string dedup data structures.
116   _string_dedup_cleaning_task.work(worker_id);
117 
118   // Now adjust pointers region by region
119   G1AdjustRegionClosure blk(collector()-&gt;mark_bitmap(), worker_id);
120   G1CollectedHeap::heap()-&gt;heap_region_par_iterate_from_worker_offset(&amp;blk, &amp;_hrclaimer, worker_id);
121   log_task(&quot;Adjust task&quot;, worker_id, start);
122 }
    </pre>
  </body>
</html>