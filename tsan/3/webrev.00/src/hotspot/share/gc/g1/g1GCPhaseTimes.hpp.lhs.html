<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1GCPhaseTimes.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_G1_G1GCPHASETIMES_HPP
 26 #define SHARE_GC_G1_G1GCPHASETIMES_HPP
 27 
 28 #include &quot;gc/shared/referenceProcessorPhaseTimes.hpp&quot;
 29 #include &quot;gc/shared/weakProcessorPhaseTimes.hpp&quot;
 30 #include &quot;jfr/jfrEvents.hpp&quot;
 31 #include &quot;logging/logLevel.hpp&quot;
 32 #include &quot;memory/allocation.hpp&quot;
 33 #include &quot;utilities/macros.hpp&quot;
 34 
 35 class LineBuffer;
 36 class G1ParScanThreadState;
 37 class STWGCTimer;
 38 
 39 template &lt;class T&gt; class WorkerDataArray;
 40 
 41 class G1GCPhaseTimes : public CHeapObj&lt;mtGC&gt; {
 42   uint _max_gc_threads;
 43   jlong _gc_start_counter;
 44   double _gc_pause_time_ms;
 45 
 46  public:
 47   enum GCParPhases {
 48     GCWorkerStart,
 49     ExtRootScan,
 50     ThreadRoots,
 51     UniverseRoots,
 52     JNIRoots,
 53     ObjectSynchronizerRoots,
 54     ManagementRoots,
 55     SystemDictionaryRoots,
 56     CLDGRoots,
 57     JVMTIRoots,
<a name="1" id="anc1"></a><span class="line-modified"> 58 #if INCLUDE_AOT</span>
<span class="line-removed"> 59     AOTCodeRoots,</span>
<span class="line-removed"> 60 #endif</span>
 61     CMRefRoots,
<a name="2" id="anc2"></a><span class="line-modified"> 62     WaitForStrongCLD,</span>
<span class="line-modified"> 63     WeakCLDRoots,</span>
<span class="line-modified"> 64     SATBFiltering,</span>
<span class="line-modified"> 65     UpdateRS,</span>
<span class="line-modified"> 66     ScanHCC,</span>
<span class="line-modified"> 67     ScanRS,</span>
<span class="line-modified"> 68     OptScanRS,</span>
 69     CodeRoots,
<a name="3" id="anc3"></a>
 70     ObjCopy,
 71     OptObjCopy,
 72     Termination,
<a name="4" id="anc4"></a>
 73     Other,
 74     GCWorkerTotal,
 75     GCWorkerEnd,
 76     StringDedupQueueFixup,
 77     StringDedupTableFixup,
 78     RedirtyCards,
<a name="5" id="anc5"></a>
 79     YoungFreeCSet,
 80     NonYoungFreeCSet,
<a name="6" id="anc6"></a>

 81     GCParPhasesSentinel
 82   };
 83 
<a name="7" id="anc7"></a><span class="line-modified"> 84   static const GCParPhases ExtRootScanSubPhasesStart = ThreadRoots;</span>
<span class="line-modified"> 85   static const GCParPhases ExtRootScanSubPhasesEnd = SATBFiltering;</span>
 86 
<a name="8" id="anc8"></a><span class="line-modified"> 87   enum GCScanRSWorkItems {</span>
<span class="line-modified"> 88     ScanRSScannedCards,</span>
<span class="line-modified"> 89     ScanRSClaimedCards,</span>
<span class="line-modified"> 90     ScanRSSkippedCards</span>

 91   };
 92 
<a name="9" id="anc9"></a><span class="line-modified"> 93   enum GCUpdateRSWorkItems {</span>
<span class="line-modified"> 94     UpdateRSProcessedBuffers,</span>
<span class="line-modified"> 95     UpdateRSScannedCards,</span>
<span class="line-modified"> 96     UpdateRSSkippedCards</span>


 97   };
 98 
<a name="10" id="anc10"></a><span class="line-modified"> 99   enum GCObjCopyWorkItems {</span>
<span class="line-modified">100     ObjCopyLABWaste,</span>
<span class="line-modified">101     ObjCopyLABUndoWaste</span>
102   };
103 
<a name="11" id="anc11"></a><span class="line-modified">104   enum GCOptCSetWorkItems {</span>
<span class="line-modified">105       OptCSetScannedCards,</span>
<span class="line-modified">106       OptCSetClaimedCards,</span>
<span class="line-modified">107       OptCSetSkippedCards,</span>
<span class="line-modified">108       OptCSetUsedMemory</span>




109   };
110 
111  private:
112   // Markers for grouping the phases in the GCPhases enum above
113   static const int GCMainParPhasesLast = GCWorkerEnd;
114 
115   WorkerDataArray&lt;double&gt;* _gc_par_phases[GCParPhasesSentinel];
116 
<a name="12" id="anc12"></a><span class="line-modified">117   WorkerDataArray&lt;size_t&gt;* _update_rs_processed_buffers;</span>
<span class="line-modified">118   WorkerDataArray&lt;size_t&gt;* _update_rs_scanned_cards;</span>
<span class="line-removed">119   WorkerDataArray&lt;size_t&gt;* _update_rs_skipped_cards;</span>
<span class="line-removed">120 </span>
<span class="line-removed">121   WorkerDataArray&lt;size_t&gt;* _scan_rs_scanned_cards;</span>
<span class="line-removed">122   WorkerDataArray&lt;size_t&gt;* _scan_rs_claimed_cards;</span>
<span class="line-removed">123   WorkerDataArray&lt;size_t&gt;* _scan_rs_skipped_cards;</span>
<span class="line-removed">124 </span>
<span class="line-removed">125   WorkerDataArray&lt;size_t&gt;* _obj_copy_lab_waste;</span>
<span class="line-removed">126   WorkerDataArray&lt;size_t&gt;* _obj_copy_lab_undo_waste;</span>
<span class="line-removed">127 </span>
<span class="line-removed">128   WorkerDataArray&lt;size_t&gt;* _opt_cset_scanned_cards;</span>
<span class="line-removed">129   WorkerDataArray&lt;size_t&gt;* _opt_cset_claimed_cards;</span>
<span class="line-removed">130   WorkerDataArray&lt;size_t&gt;* _opt_cset_skipped_cards;</span>
<span class="line-removed">131   WorkerDataArray&lt;size_t&gt;* _opt_cset_used_memory;</span>
<span class="line-removed">132 </span>
<span class="line-removed">133   WorkerDataArray&lt;size_t&gt;* _termination_attempts;</span>
<span class="line-removed">134 </span>
<span class="line-removed">135   WorkerDataArray&lt;size_t&gt;* _redirtied_cards;</span>
<span class="line-removed">136 </span>
<span class="line-removed">137   double _cur_collection_par_time_ms;</span>
<span class="line-removed">138   double _cur_optional_evac_ms;</span>
139   double _cur_collection_code_root_fixup_time_ms;
140   double _cur_strong_code_root_purge_time_ms;
141 
142   double _cur_evac_fail_recalc_used;
143   double _cur_evac_fail_remove_self_forwards;
144 
145   double _cur_string_deduplication_time_ms;
146 
<a name="13" id="anc13"></a>





147   double _cur_prepare_tlab_time_ms;
148   double _cur_resize_tlab_time_ms;
149 
150   double _cur_derived_pointer_table_update_time_ms;
151 
152   double _cur_clear_ct_time_ms;
153   double _cur_expand_heap_time_ms;
154   double _cur_ref_proc_time_ms;
155 
156   double _cur_collection_start_sec;
157   double _root_region_scan_wait_time_ms;
158 
159   double _external_accounted_time_ms;
160 
<a name="14" id="anc14"></a>

161   double _recorded_clear_claimed_marks_time_ms;
162 
163   double _recorded_young_cset_choice_time_ms;
164   double _recorded_non_young_cset_choice_time_ms;
165 
166   double _recorded_redirty_logged_cards_time_ms;
167 
168   double _recorded_preserve_cm_referents_time_ms;
169 
170   double _recorded_merge_pss_time_ms;
171 
172   double _recorded_start_new_cset_time_ms;
173 
174   double _recorded_total_free_cset_time_ms;
175 
176   double _recorded_serial_free_cset_time_ms;
177 
<a name="15" id="anc15"></a>





178   double _cur_fast_reclaim_humongous_time_ms;
<a name="16" id="anc16"></a><span class="line-removed">179   double _cur_fast_reclaim_humongous_register_time_ms;</span>
180   size_t _cur_fast_reclaim_humongous_total;
181   size_t _cur_fast_reclaim_humongous_candidates;
182   size_t _cur_fast_reclaim_humongous_reclaimed;
183 
184   double _cur_verify_before_time_ms;
185   double _cur_verify_after_time_ms;
186 
187   ReferenceProcessorPhaseTimes _ref_phase_times;
188   WeakProcessorPhaseTimes _weak_phase_times;
189 
190   double worker_time(GCParPhases phase, uint worker);
191   void note_gc_end();
192   void reset();
193 
194   template &lt;class T&gt;
<a name="17" id="anc17"></a><span class="line-modified">195   void details(T* phase, const char* indent) const;</span>
196 
<a name="18" id="anc18"></a><span class="line-modified">197   void log_phase(WorkerDataArray&lt;double&gt;* phase, uint indent, outputStream* out, bool print_sum) const;</span>


198   void debug_phase(WorkerDataArray&lt;double&gt;* phase, uint extra_indent = 0) const;
<a name="19" id="anc19"></a><span class="line-modified">199   void trace_phase(WorkerDataArray&lt;double&gt;* phase, bool print_sum = true) const;</span>
200 
201   void info_time(const char* name, double value) const;
202   void debug_time(const char* name, double value) const;
203   // This will print logs for both &#39;gc+phases&#39; and &#39;gc+phases+ref&#39;.
204   void debug_time_for_reference(const char* name, double value) const;
205   void trace_time(const char* name, double value) const;
206   void trace_count(const char* name, size_t value) const;
207 
208   double print_pre_evacuate_collection_set() const;
<a name="20" id="anc20"></a><span class="line-modified">209   double print_evacuate_collection_set() const;</span>

210   double print_evacuate_optional_collection_set() const;
211   double print_post_evacuate_collection_set() const;
212   void print_other(double accounted_ms) const;
213 
214  public:
215   G1GCPhaseTimes(STWGCTimer* gc_timer, uint max_gc_threads);
216   void note_gc_start();
217   void print();
218   static const char* phase_name(GCParPhases phase);
219 
220   // record the time a phase took in seconds
<a name="21" id="anc21"></a><span class="line-modified">221   void record_time_secs(GCParPhases phase, uint worker_i, double secs);</span>
222 
223   // add a number of seconds to a phase
<a name="22" id="anc22"></a><span class="line-modified">224   void add_time_secs(GCParPhases phase, uint worker_i, double secs);</span>


225 
<a name="23" id="anc23"></a><span class="line-modified">226   void record_or_add_time_secs(GCParPhases phase, uint worker_i, double secs);</span>
227 
<a name="24" id="anc24"></a><span class="line-modified">228   void record_thread_work_item(GCParPhases phase, uint worker_i, size_t count, uint index = 0);</span>
229 
<a name="25" id="anc25"></a><span class="line-modified">230   void record_or_add_thread_work_item(GCParPhases phase, uint worker_i, size_t count, uint index = 0);</span>


231 
232   // return the average time for a phase in milliseconds
233   double average_time_ms(GCParPhases phase);
234 
235   size_t sum_thread_work_items(GCParPhases phase, uint index = 0);
236 
<a name="26" id="anc26"></a><span class="line-removed">237  public:</span>
<span class="line-removed">238 </span>
239   void record_prepare_tlab_time_ms(double ms) {
240     _cur_prepare_tlab_time_ms = ms;
241   }
242 
243   void record_resize_tlab_time_ms(double ms) {
244     _cur_resize_tlab_time_ms = ms;
245   }
246 
247   void record_derived_pointer_table_update_time(double ms) {
248     _cur_derived_pointer_table_update_time_ms = ms;
249   }
250 
251   void record_clear_ct_time(double ms) {
252     _cur_clear_ct_time_ms = ms;
253   }
254 
255   void record_expand_heap_time(double ms) {
256     _cur_expand_heap_time_ms = ms;
257   }
258 
<a name="27" id="anc27"></a><span class="line-modified">259   void record_par_time(double ms) {</span>
<span class="line-modified">260     _cur_collection_par_time_ms = ms;</span>
261   }
262 
<a name="28" id="anc28"></a><span class="line-modified">263   void record_optional_evacuation(double ms) {</span>
<span class="line-modified">264     _cur_optional_evac_ms = ms;</span>
265   }
266 
<a name="29" id="anc29"></a><span class="line-modified">267   void record_code_root_fixup_time(double ms) {</span>
<span class="line-modified">268     _cur_collection_code_root_fixup_time_ms = ms;</span>
269   }
270 
271   void record_strong_code_root_purge_time(double ms) {
272     _cur_strong_code_root_purge_time_ms = ms;
273   }
274 
<a name="30" id="anc30"></a>















275   void record_evac_fail_recalc_used_time(double ms) {
276     _cur_evac_fail_recalc_used = ms;
277   }
278 
279   void record_evac_fail_remove_self_forwards(double ms) {
280     _cur_evac_fail_remove_self_forwards = ms;
281   }
282 
283   void record_string_deduplication_time(double ms) {
284     _cur_string_deduplication_time_ms = ms;
285   }
286 
287   void record_ref_proc_time(double ms) {
288     _cur_ref_proc_time_ms = ms;
289   }
290 
291   void record_root_region_scan_wait_time(double time_ms) {
292     _root_region_scan_wait_time_ms = time_ms;
293   }
294 
295   void record_total_free_cset_time_ms(double time_ms) {
296     _recorded_total_free_cset_time_ms = time_ms;
297   }
298 
299   void record_serial_free_cset_time_ms(double time_ms) {
300     _recorded_serial_free_cset_time_ms = time_ms;
301   }
302 
<a name="31" id="anc31"></a><span class="line-modified">303   void record_fast_reclaim_humongous_stats(double time_ms, size_t total, size_t candidates) {</span>
<span class="line-modified">304     _cur_fast_reclaim_humongous_register_time_ms = time_ms;</span>








305     _cur_fast_reclaim_humongous_total = total;
306     _cur_fast_reclaim_humongous_candidates = candidates;
307   }
308 
309   void record_fast_reclaim_humongous_time_ms(double value, size_t reclaimed) {
310     _cur_fast_reclaim_humongous_time_ms = value;
311     _cur_fast_reclaim_humongous_reclaimed = reclaimed;
312   }
313 
314   void record_young_cset_choice_time_ms(double time_ms) {
315     _recorded_young_cset_choice_time_ms = time_ms;
316   }
317 
318   void record_non_young_cset_choice_time_ms(double time_ms) {
319     _recorded_non_young_cset_choice_time_ms = time_ms;
320   }
321 
322   void record_redirty_logged_cards_time_ms(double time_ms) {
323     _recorded_redirty_logged_cards_time_ms = time_ms;
324   }
325 
326   void record_preserve_cm_referents_time_ms(double time_ms) {
327     _recorded_preserve_cm_referents_time_ms = time_ms;
328   }
329 
<a name="32" id="anc32"></a><span class="line-removed">330   void record_merge_pss_time_ms(double time_ms) {</span>
<span class="line-removed">331     _recorded_merge_pss_time_ms = time_ms;</span>
<span class="line-removed">332   }</span>
<span class="line-removed">333 </span>
334   void record_start_new_cset_time_ms(double time_ms) {
335     _recorded_start_new_cset_time_ms = time_ms;
336   }
337 
338   void record_cur_collection_start_sec(double time_ms) {
339     _cur_collection_start_sec = time_ms;
340   }
341 
342   void record_verify_before_time_ms(double time_ms) {
343     _cur_verify_before_time_ms = time_ms;
344   }
345 
346   void record_verify_after_time_ms(double time_ms) {
347     _cur_verify_after_time_ms = time_ms;
348   }
349 
350   void inc_external_accounted_time_ms(double time_ms) {
351     _external_accounted_time_ms += time_ms;
352   }
353 
<a name="33" id="anc33"></a>



354   void record_clear_claimed_marks_time_ms(double recorded_clear_claimed_marks_time_ms) {
355     _recorded_clear_claimed_marks_time_ms = recorded_clear_claimed_marks_time_ms;
356   }
357 
358   double cur_collection_start_sec() {
359     return _cur_collection_start_sec;
360   }
361 
362   double cur_collection_par_time_ms() {
<a name="34" id="anc34"></a><span class="line-modified">363     return _cur_collection_par_time_ms;</span>
364   }
365 
366   double cur_clear_ct_time_ms() {
367     return _cur_clear_ct_time_ms;
368   }
369 
370   double cur_expand_heap_time_ms() {
371     return _cur_expand_heap_time_ms;
372   }
373 
374   double root_region_scan_wait_time_ms() {
375     return _root_region_scan_wait_time_ms;
376   }
377 
378   double young_cset_choice_time_ms() {
379     return _recorded_young_cset_choice_time_ms;
380   }
381 
382   double total_free_cset_time_ms() {
383     return _recorded_total_free_cset_time_ms;
384   }
385 
<a name="35" id="anc35"></a>



386   double non_young_cset_choice_time_ms() {
387     return _recorded_non_young_cset_choice_time_ms;
388   }
389 
390   double fast_reclaim_humongous_time_ms() {
391     return _cur_fast_reclaim_humongous_time_ms;
392   }
393 
<a name="36" id="anc36"></a>



394   ReferenceProcessorPhaseTimes* ref_phase_times() { return &amp;_ref_phase_times; }
395 
396   WeakProcessorPhaseTimes* weak_phase_times() { return &amp;_weak_phase_times; }
397 };
398 
399 class G1EvacPhaseWithTrimTimeTracker : public StackObj {
400   G1ParScanThreadState* _pss;
401   Ticks _start;
402 
403   Tickspan&amp; _total_time;
404   Tickspan&amp; _trim_time;
405 
406   bool _stopped;
407 public:
408   G1EvacPhaseWithTrimTimeTracker(G1ParScanThreadState* pss, Tickspan&amp; total_time, Tickspan&amp; trim_time);
409   ~G1EvacPhaseWithTrimTimeTracker();
410 
411   void stop();
412 };
413 
414 class G1GCParPhaseTimesTracker : public CHeapObj&lt;mtGC&gt; {
415 protected:
416   Ticks _start_time;
417   G1GCPhaseTimes::GCParPhases _phase;
418   G1GCPhaseTimes* _phase_times;
419   uint _worker_id;
420   EventGCPhaseParallel _event;
<a name="37" id="anc37"></a>

421 public:
<a name="38" id="anc38"></a><span class="line-modified">422   G1GCParPhaseTimesTracker(G1GCPhaseTimes* phase_times, G1GCPhaseTimes::GCParPhases phase, uint worker_id);</span>
423   virtual ~G1GCParPhaseTimesTracker();
424 };
425 
426 class G1EvacPhaseTimesTracker : public G1GCParPhaseTimesTracker {
427   Tickspan _total_time;
428   Tickspan _trim_time;
429 
430   G1EvacPhaseWithTrimTimeTracker _trim_tracker;
431 public:
432   G1EvacPhaseTimesTracker(G1GCPhaseTimes* phase_times, G1ParScanThreadState* pss, G1GCPhaseTimes::GCParPhases phase, uint worker_id);
433   virtual ~G1EvacPhaseTimesTracker();
434 };
435 
436 #endif // SHARE_GC_G1_G1GCPHASETIMES_HPP
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>