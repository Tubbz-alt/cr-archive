<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/g1/g1SharedClosures.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1SATBMarkQueueSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1StringDedup.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1SharedClosures.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 30,18 ***</span>
  class G1ParScanThreadState;
  
  // Simple holder object for a complete set of closures used by the G1 evacuation code.
  template &lt;G1Mark Mark&gt;
  class G1SharedClosures {
  public:
    G1ParCopyClosure&lt;G1BarrierNone, Mark&gt; _oops;
    G1ParCopyClosure&lt;G1BarrierCLD,  Mark&gt; _oops_in_cld;
  
    G1CLDScanClosure                _clds;
    G1CodeBlobClosure               _codeblobs;
  
<span class="line-modified">!   G1SharedClosures(G1CollectedHeap* g1h, G1ParScanThreadState* pss, bool process_only_dirty, int cld_claim) :</span>
      _oops(g1h, pss),
      _oops_in_cld(g1h, pss),
<span class="line-modified">!     _clds(&amp;_oops_in_cld, process_only_dirty, cld_claim),</span>
<span class="line-modified">!     _codeblobs(&amp;_oops) {}</span>
  };
<span class="line-new-header">--- 30,32 ---</span>
  class G1ParScanThreadState;
  
  // Simple holder object for a complete set of closures used by the G1 evacuation code.
  template &lt;G1Mark Mark&gt;
  class G1SharedClosures {
<span class="line-added">+   static bool needs_strong_processing() {</span>
<span class="line-added">+     // Request strong code root processing when G1MarkFromRoot is passed in during</span>
<span class="line-added">+     // initial mark.</span>
<span class="line-added">+     return Mark == G1MarkFromRoot;</span>
<span class="line-added">+   }</span>
  public:
    G1ParCopyClosure&lt;G1BarrierNone, Mark&gt; _oops;
    G1ParCopyClosure&lt;G1BarrierCLD,  Mark&gt; _oops_in_cld;
<span class="line-added">+   // We do not need (and actually should not) collect oops from nmethods into the</span>
<span class="line-added">+   // optional collection set as we already automatically collect the corresponding</span>
<span class="line-added">+   // nmethods in the region&#39;s strong code roots set. So set G1BarrierNoOptRoots in</span>
<span class="line-added">+   // this closure.</span>
<span class="line-added">+   // If these were present there would be opportunity for multiple threads to try</span>
<span class="line-added">+   // to change this oop* at the same time. Since embedded oops are not necessarily</span>
<span class="line-added">+   // word-aligned, this could lead to word tearing during update and crashes.</span>
<span class="line-added">+   G1ParCopyClosure&lt;G1BarrierNoOptRoots, Mark&gt; _oops_in_nmethod;</span>
  
    G1CLDScanClosure                _clds;
    G1CodeBlobClosure               _codeblobs;
  
<span class="line-modified">!   G1SharedClosures(G1CollectedHeap* g1h, G1ParScanThreadState* pss, bool process_only_dirty) :</span>
      _oops(g1h, pss),
      _oops_in_cld(g1h, pss),
<span class="line-modified">!     _oops_in_nmethod(g1h, pss),</span>
<span class="line-modified">!     _clds(&amp;_oops_in_cld, process_only_dirty),</span>
<span class="line-added">+     _codeblobs(pss-&gt;worker_id(), &amp;_oops_in_nmethod, needs_strong_processing()) {}</span>
  };
</pre>
<center><a href="g1SATBMarkQueueSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1StringDedup.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>