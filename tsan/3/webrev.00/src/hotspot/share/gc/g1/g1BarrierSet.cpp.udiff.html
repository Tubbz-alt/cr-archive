<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/g1BarrierSet.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1Arguments.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1BarrierSet.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1BarrierSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,11 +34,11 @@</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/compressedOops.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
  #include &quot;runtime/interfaceSupport.inline.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;runtime/mutexLocker.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;runtime/orderAccess.hpp&quot;</span>
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  #ifdef COMPILER1
  #include &quot;gc/g1/c1/g1BarrierSetC1.hpp&quot;
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,12 +55,13 @@</span>
                        make_barrier_set_c2&lt;G1BarrierSetC2&gt;(),
                        card_table,
                        BarrierSet::FakeRtti(BarrierSet::G1BarrierSet)),
    _satb_mark_queue_buffer_allocator(&quot;SATB Buffer Allocator&quot;, G1SATBBufferSize),
    _dirty_card_queue_buffer_allocator(&quot;DC Buffer Allocator&quot;, G1UpdateBufferSize),
<span class="udiff-line-modified-removed">-   _satb_mark_queue_set(),</span>
<span class="udiff-line-modified-removed">-   _dirty_card_queue_set()</span>
<span class="udiff-line-modified-added">+   _satb_mark_queue_set(&amp;_satb_mark_queue_buffer_allocator),</span>
<span class="udiff-line-modified-added">+   _dirty_card_queue_set(&amp;_dirty_card_queue_buffer_allocator),</span>
<span class="udiff-line-added">+   _shared_dirty_card_queue(&amp;_dirty_card_queue_set)</span>
  {}
  
  void G1BarrierSet::enqueue(oop pre_val) {
    // Nulls should have been already filtered.
    assert(oopDesc::is_oop(pre_val, true), &quot;Error&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,41 +146,16 @@</span>
    // the main thread, before it gets added to the threads list, which
    // is where this is called.  That execution may enqueue dirty cards.
  
    // If we are creating the thread during a marking cycle, we should
    // set the active field of the SATB queue to true.  That involves
<span class="udiff-line-modified-removed">-   // copying the global is_active value to this thread&#39;s queue, which</span>
<span class="udiff-line-removed">-   // is done without any direct synchronization here.</span>
<span class="udiff-line-removed">-   //</span>
<span class="udiff-line-removed">-   // The activation and deactivation of the SATB queues occurs at the</span>
<span class="udiff-line-removed">-   // beginning / end of a marking cycle, and is done during</span>
<span class="udiff-line-removed">-   // safepoints.  This function is called just before a thread is</span>
<span class="udiff-line-removed">-   // added to its corresponding threads list (for Java or non-Java</span>
<span class="udiff-line-removed">-   // threads, respectively).</span>
<span class="udiff-line-removed">-   //</span>
<span class="udiff-line-removed">-   // For Java threads, that&#39;s done while holding the Threads_lock,</span>
<span class="udiff-line-removed">-   // which ensures we&#39;re not at a safepoint, so reading the global</span>
<span class="udiff-line-removed">-   // is_active state is synchronized against update.</span>
<span class="udiff-line-removed">-   assert(!thread-&gt;is_Java_thread() || !SafepointSynchronize::is_at_safepoint(),</span>
<span class="udiff-line-removed">-          &quot;Should not be at a safepoint&quot;);</span>
<span class="udiff-line-removed">-   // For non-Java threads, thread creation (and list addition) may,</span>
<span class="udiff-line-removed">-   // and indeed usually does, occur during a safepoint.  But such</span>
<span class="udiff-line-removed">-   // creation isn&#39;t concurrent with updating the global SATB active</span>
<span class="udiff-line-removed">-   // state.</span>
<span class="udiff-line-modified-added">+   // copying the global is_active value to this thread&#39;s queue.</span>
    bool is_satb_active = _satb_mark_queue_set.is_active();
    G1ThreadLocalData::satb_mark_queue(thread).set_active(is_satb_active);
  }
  
  void G1BarrierSet::on_thread_detach(Thread* thread) {
    // Flush any deferred card marks.
    CardTableBarrierSet::on_thread_detach(thread);
    G1ThreadLocalData::satb_mark_queue(thread).flush();
    G1ThreadLocalData::dirty_card_queue(thread).flush();
  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- BufferNode::Allocator&amp; G1BarrierSet::satb_mark_queue_buffer_allocator() {</span>
<span class="udiff-line-removed">-   return _satb_mark_queue_buffer_allocator;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- BufferNode::Allocator&amp; G1BarrierSet::dirty_card_queue_buffer_allocator() {</span>
<span class="udiff-line-removed">-   return _dirty_card_queue_buffer_allocator;</span>
<span class="udiff-line-removed">- }</span>
</pre>
<center><a href="g1Arguments.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1BarrierSet.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>