<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/g1/g1CollectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;gc/g1/g1Allocator.inline.hpp&quot;
  32 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  33 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  34 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  35 #include &quot;gc/g1/g1CollectorPolicy.hpp&quot;
  36 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  37 #include &quot;gc/g1/g1ConcurrentRefine.hpp&quot;
  38 #include &quot;gc/g1/g1ConcurrentRefineThread.hpp&quot;
  39 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  40 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  41 #include &quot;gc/g1/g1EvacStats.inline.hpp&quot;
  42 #include &quot;gc/g1/g1FullCollector.hpp&quot;
  43 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  44 #include &quot;gc/g1/g1HeapSizingPolicy.hpp&quot;
  45 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  46 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  47 #include &quot;gc/g1/g1HotCardCache.hpp&quot;
  48 #include &quot;gc/g1/g1MemoryPool.hpp&quot;
  49 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  50 #include &quot;gc/g1/g1ParScanThreadState.inline.hpp&quot;
  51 #include &quot;gc/g1/g1Policy.hpp&quot;
  52 #include &quot;gc/g1/g1RegionToSpaceMapper.hpp&quot;
  53 #include &quot;gc/g1/g1RemSet.hpp&quot;
  54 #include &quot;gc/g1/g1RootClosures.hpp&quot;
  55 #include &quot;gc/g1/g1RootProcessor.hpp&quot;
  56 #include &quot;gc/g1/g1SATBMarkQueueSet.hpp&quot;
  57 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  58 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  59 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  60 #include &quot;gc/g1/g1YoungRemSetSamplingThread.hpp&quot;
  61 #include &quot;gc/g1/g1VMOperations.hpp&quot;
  62 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  63 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  64 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  65 #include &quot;gc/shared/gcBehaviours.hpp&quot;
  66 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  67 #include &quot;gc/shared/gcId.hpp&quot;
  68 #include &quot;gc/shared/gcLocker.hpp&quot;
  69 #include &quot;gc/shared/gcTimer.hpp&quot;
  70 #include &quot;gc/shared/gcTrace.hpp&quot;
  71 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  72 #include &quot;gc/shared/generationSpec.hpp&quot;
  73 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  74 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  75 #include &quot;gc/shared/parallelCleaning.hpp&quot;
  76 #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  77 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  78 #include &quot;gc/shared/referenceProcessor.inline.hpp&quot;
  79 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  80 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  81 #include &quot;gc/shared/workerPolicy.hpp&quot;
  82 #include &quot;logging/log.hpp&quot;
  83 #include &quot;memory/allocation.hpp&quot;
  84 #include &quot;memory/iterator.hpp&quot;
  85 #include &quot;memory/resourceArea.hpp&quot;
  86 #include &quot;oops/access.inline.hpp&quot;
  87 #include &quot;oops/compressedOops.inline.hpp&quot;
  88 #include &quot;oops/oop.inline.hpp&quot;
  89 #include &quot;runtime/atomic.hpp&quot;
  90 #include &quot;runtime/flags/flagSetting.hpp&quot;
  91 #include &quot;runtime/handles.inline.hpp&quot;
  92 #include &quot;runtime/init.hpp&quot;
  93 #include &quot;runtime/orderAccess.hpp&quot;
  94 #include &quot;runtime/threadSMR.hpp&quot;
  95 #include &quot;runtime/vmThread.hpp&quot;
  96 #include &quot;utilities/align.hpp&quot;
  97 #include &quot;utilities/globalDefinitions.hpp&quot;
  98 #include &quot;utilities/stack.inline.hpp&quot;
  99 
 100 size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;
 101 
 102 // INVARIANTS/NOTES
 103 //
 104 // All allocation activity covered by the G1CollectedHeap interface is
 105 // serialized by acquiring the HeapLock.  This happens in mem_allocate
 106 // and allocate_new_tlab, which are the &quot;entry&quot; points to the
 107 // allocation code from the rest of the JVM.  (Note that this does not
 108 // apply to TLAB allocation, which is not part of this interface: it
 109 // is done by clients of this interface.)
 110 
 111 class RedirtyLoggedCardTableEntryClosure : public G1CardTableEntryClosure {
 112  private:
 113   size_t _num_dirtied;
 114   G1CollectedHeap* _g1h;
 115   G1CardTable* _g1_ct;
 116 
 117   HeapRegion* region_for_card(CardValue* card_ptr) const {
 118     return _g1h-&gt;heap_region_containing(_g1_ct-&gt;addr_for(card_ptr));
 119   }
 120 
 121   bool will_become_free(HeapRegion* hr) const {
 122     // A region will be freed by free_collection_set if the region is in the
 123     // collection set and has not had an evacuation failure.
 124     return _g1h-&gt;is_in_cset(hr) &amp;&amp; !hr-&gt;evacuation_failed();
 125   }
 126 
 127  public:
 128   RedirtyLoggedCardTableEntryClosure(G1CollectedHeap* g1h) : G1CardTableEntryClosure(),
 129     _num_dirtied(0), _g1h(g1h), _g1_ct(g1h-&gt;card_table()) { }
 130 
 131   bool do_card_ptr(CardValue* card_ptr, uint worker_i) {
 132     HeapRegion* hr = region_for_card(card_ptr);
 133 
 134     // Should only dirty cards in regions that won&#39;t be freed.
 135     if (!will_become_free(hr)) {
 136       *card_ptr = G1CardTable::dirty_card_val();
 137       _num_dirtied++;
 138     }
 139 
 140     return true;
 141   }
 142 
 143   size_t num_dirtied()   const { return _num_dirtied; }
 144 };
 145 
 146 
 147 void G1RegionMappingChangedListener::reset_from_card_cache(uint start_idx, size_t num_regions) {
 148   HeapRegionRemSet::invalidate_from_card_cache(start_idx, num_regions);
 149 }
 150 
 151 void G1RegionMappingChangedListener::on_commit(uint start_idx, size_t num_regions, bool zero_filled) {
 152   // The from card cache is not the memory that is actually committed. So we cannot
 153   // take advantage of the zero_filled parameter.
 154   reset_from_card_cache(start_idx, num_regions);
 155 }
 156 
 157 
 158 HeapRegion* G1CollectedHeap::new_heap_region(uint hrs_index,
 159                                              MemRegion mr) {
 160   return new HeapRegion(hrs_index, bot(), mr);
 161 }
 162 
 163 // Private methods.
 164 
 165 HeapRegion* G1CollectedHeap::new_region(size_t word_size, HeapRegionType type, bool do_expand) {
 166   assert(!is_humongous(word_size) || word_size &lt;= HeapRegion::GrainWords,
 167          &quot;the only time we use this to allocate a humongous region is &quot;
 168          &quot;when we are allocating a single humongous region&quot;);
 169 
 170   HeapRegion* res = _hrm-&gt;allocate_free_region(type);
 171 
 172   if (res == NULL &amp;&amp; do_expand &amp;&amp; _expand_heap_after_alloc_failure) {
 173     // Currently, only attempts to allocate GC alloc regions set
 174     // do_expand to true. So, we should only reach here during a
 175     // safepoint. If this assumption changes we might have to
 176     // reconsider the use of _expand_heap_after_alloc_failure.
 177     assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 178 
 179     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (region allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 180                               word_size * HeapWordSize);
 181 
 182     if (expand(word_size * HeapWordSize)) {
 183       // Given that expand() succeeded in expanding the heap, and we
 184       // always expand the heap by an amount aligned to the heap
 185       // region size, the free list should in theory not be empty.
 186       // In either case allocate_free_region() will check for NULL.
 187       res = _hrm-&gt;allocate_free_region(type);
 188     } else {
 189       _expand_heap_after_alloc_failure = false;
 190     }
 191   }
 192   return res;
 193 }
 194 
 195 HeapWord*
 196 G1CollectedHeap::humongous_obj_allocate_initialize_regions(uint first,
 197                                                            uint num_regions,
 198                                                            size_t word_size) {
 199   assert(first != G1_NO_HRM_INDEX, &quot;pre-condition&quot;);
 200   assert(is_humongous(word_size), &quot;word_size should be humongous&quot;);
 201   assert(num_regions * HeapRegion::GrainWords &gt;= word_size, &quot;pre-condition&quot;);
 202 
 203   // Index of last region in the series.
 204   uint last = first + num_regions - 1;
 205 
 206   // We need to initialize the region(s) we just discovered. This is
 207   // a bit tricky given that it can happen concurrently with
 208   // refinement threads refining cards on these regions and
 209   // potentially wanting to refine the BOT as they are scanning
 210   // those cards (this can happen shortly after a cleanup; see CR
 211   // 6991377). So we have to set up the region(s) carefully and in
 212   // a specific order.
 213 
 214   // The word size sum of all the regions we will allocate.
 215   size_t word_size_sum = (size_t) num_regions * HeapRegion::GrainWords;
 216   assert(word_size &lt;= word_size_sum, &quot;sanity&quot;);
 217 
 218   // This will be the &quot;starts humongous&quot; region.
 219   HeapRegion* first_hr = region_at(first);
 220   // The header of the new object will be placed at the bottom of
 221   // the first region.
 222   HeapWord* new_obj = first_hr-&gt;bottom();
 223   // This will be the new top of the new object.
 224   HeapWord* obj_top = new_obj + word_size;
 225 
 226   // First, we need to zero the header of the space that we will be
 227   // allocating. When we update top further down, some refinement
 228   // threads might try to scan the region. By zeroing the header we
 229   // ensure that any thread that will try to scan the region will
 230   // come across the zero klass word and bail out.
 231   //
 232   // NOTE: It would not have been correct to have used
 233   // CollectedHeap::fill_with_object() and make the space look like
 234   // an int array. The thread that is doing the allocation will
 235   // later update the object header to a potentially different array
 236   // type and, for a very short period of time, the klass and length
 237   // fields will be inconsistent. This could cause a refinement
 238   // thread to calculate the object size incorrectly.
 239   Copy::fill_to_words(new_obj, oopDesc::header_size(), 0);
 240 
 241   // Next, pad out the unused tail of the last region with filler
 242   // objects, for improved usage accounting.
 243   // How many words we use for filler objects.
 244   size_t word_fill_size = word_size_sum - word_size;
 245 
 246   // How many words memory we &quot;waste&quot; which cannot hold a filler object.
 247   size_t words_not_fillable = 0;
 248 
 249   if (word_fill_size &gt;= min_fill_size()) {
 250     fill_with_objects(obj_top, word_fill_size);
 251   } else if (word_fill_size &gt; 0) {
 252     // We have space to fill, but we cannot fit an object there.
 253     words_not_fillable = word_fill_size;
 254     word_fill_size = 0;
 255   }
 256 
 257   // We will set up the first region as &quot;starts humongous&quot;. This
 258   // will also update the BOT covering all the regions to reflect
 259   // that there is a single object that starts at the bottom of the
 260   // first region.
 261   first_hr-&gt;set_starts_humongous(obj_top, word_fill_size);
 262   _policy-&gt;remset_tracker()-&gt;update_at_allocate(first_hr);
 263   // Then, if there are any, we will set up the &quot;continues
 264   // humongous&quot; regions.
 265   HeapRegion* hr = NULL;
 266   for (uint i = first + 1; i &lt;= last; ++i) {
 267     hr = region_at(i);
 268     hr-&gt;set_continues_humongous(first_hr);
 269     _policy-&gt;remset_tracker()-&gt;update_at_allocate(hr);
 270   }
 271 
 272   // Up to this point no concurrent thread would have been able to
 273   // do any scanning on any region in this series. All the top
 274   // fields still point to bottom, so the intersection between
 275   // [bottom,top] and [card_start,card_end] will be empty. Before we
 276   // update the top fields, we&#39;ll do a storestore to make sure that
 277   // no thread sees the update to top before the zeroing of the
 278   // object header and the BOT initialization.
 279   OrderAccess::storestore();
 280 
 281   // Now, we will update the top fields of the &quot;continues humongous&quot;
 282   // regions except the last one.
 283   for (uint i = first; i &lt; last; ++i) {
 284     hr = region_at(i);
 285     hr-&gt;set_top(hr-&gt;end());
 286   }
 287 
 288   hr = region_at(last);
 289   // If we cannot fit a filler object, we must set top to the end
 290   // of the humongous object, otherwise we cannot iterate the heap
 291   // and the BOT will not be complete.
 292   hr-&gt;set_top(hr-&gt;end() - words_not_fillable);
 293 
 294   assert(hr-&gt;bottom() &lt; obj_top &amp;&amp; obj_top &lt;= hr-&gt;end(),
 295          &quot;obj_top should be in last region&quot;);
 296 
 297   _verifier-&gt;check_bitmaps(&quot;Humongous Region Allocation&quot;, first_hr);
 298 
 299   assert(words_not_fillable == 0 ||
 300          first_hr-&gt;bottom() + word_size_sum - words_not_fillable == hr-&gt;top(),
 301          &quot;Miscalculation in humongous allocation&quot;);
 302 
 303   increase_used((word_size_sum - words_not_fillable) * HeapWordSize);
 304 
 305   for (uint i = first; i &lt;= last; ++i) {
 306     hr = region_at(i);
 307     _humongous_set.add(hr);
 308     _hr_printer.alloc(hr);
 309   }
 310 
 311   return new_obj;
 312 }
 313 
 314 size_t G1CollectedHeap::humongous_obj_size_in_regions(size_t word_size) {
 315   assert(is_humongous(word_size), &quot;Object of size &quot; SIZE_FORMAT &quot; must be humongous here&quot;, word_size);
 316   return align_up(word_size, HeapRegion::GrainWords) / HeapRegion::GrainWords;
 317 }
 318 
 319 // If could fit into free regions w/o expansion, try.
 320 // Otherwise, if can expand, do so.
 321 // Otherwise, if using ex regions might help, try with ex given back.
 322 HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
 323   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
 324 
 325   _verifier-&gt;verify_region_sets_optional();
 326 
 327   uint first = G1_NO_HRM_INDEX;
 328   uint obj_regions = (uint) humongous_obj_size_in_regions(word_size);
 329 
 330   if (obj_regions == 1) {
 331     // Only one region to allocate, try to use a fast path by directly allocating
 332     // from the free lists. Do not try to expand here, we will potentially do that
 333     // later.
 334     HeapRegion* hr = new_region(word_size, HeapRegionType::Humongous, false /* do_expand */);
 335     if (hr != NULL) {
 336       first = hr-&gt;hrm_index();
 337     }
 338   } else {
 339     // Policy: Try only empty regions (i.e. already committed first). Maybe we
 340     // are lucky enough to find some.
 341     first = _hrm-&gt;find_contiguous_only_empty(obj_regions);
 342     if (first != G1_NO_HRM_INDEX) {
 343       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 344     }
 345   }
 346 
 347   if (first == G1_NO_HRM_INDEX) {
 348     // Policy: We could not find enough regions for the humongous object in the
 349     // free list. Look through the heap to find a mix of free and uncommitted regions.
 350     // If so, try expansion.
 351     first = _hrm-&gt;find_contiguous_empty_or_unavailable(obj_regions);
 352     if (first != G1_NO_HRM_INDEX) {
 353       // We found something. Make sure these regions are committed, i.e. expand
 354       // the heap. Alternatively we could do a defragmentation GC.
 355       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (humongous allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 356                                     word_size * HeapWordSize);
 357 
 358       _hrm-&gt;expand_at(first, obj_regions, workers());
 359       policy()-&gt;record_new_heap_size(num_regions());
 360 
 361 #ifdef ASSERT
 362       for (uint i = first; i &lt; first + obj_regions; ++i) {
 363         HeapRegion* hr = region_at(i);
 364         assert(hr-&gt;is_free(), &quot;sanity&quot;);
 365         assert(hr-&gt;is_empty(), &quot;sanity&quot;);
 366         assert(is_on_master_free_list(hr), &quot;sanity&quot;);
 367       }
 368 #endif
 369       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 370     } else {
 371       // Policy: Potentially trigger a defragmentation GC.
 372     }
 373   }
 374 
 375   HeapWord* result = NULL;
 376   if (first != G1_NO_HRM_INDEX) {
 377     result = humongous_obj_allocate_initialize_regions(first, obj_regions, word_size);
 378     assert(result != NULL, &quot;it should always return a valid result&quot;);
 379 
 380     // A successful humongous object allocation changes the used space
 381     // information of the old generation so we need to recalculate the
 382     // sizes and update the jstat counters here.
 383     g1mm()-&gt;update_sizes();
 384   }
 385 
 386   _verifier-&gt;verify_region_sets_optional();
 387 
 388   return result;
 389 }
 390 
 391 HeapWord* G1CollectedHeap::allocate_new_tlab(size_t min_size,
 392                                              size_t requested_size,
 393                                              size_t* actual_size) {
 394   assert_heap_not_locked_and_not_at_safepoint();
 395   assert(!is_humongous(requested_size), &quot;we do not allow humongous TLABs&quot;);
 396 
 397   return attempt_allocation(min_size, requested_size, actual_size);
 398 }
 399 
 400 HeapWord*
 401 G1CollectedHeap::mem_allocate(size_t word_size,
 402                               bool*  gc_overhead_limit_was_exceeded) {
 403   assert_heap_not_locked_and_not_at_safepoint();
 404 
 405   if (is_humongous(word_size)) {
 406     return attempt_allocation_humongous(word_size);
 407   }
 408   size_t dummy = 0;
 409   return attempt_allocation(word_size, word_size, &amp;dummy);
 410 }
 411 
 412 HeapWord* G1CollectedHeap::attempt_allocation_slow(size_t word_size) {
 413   ResourceMark rm; // For retrieving the thread names in log messages.
 414 
 415   // Make sure you read the note in attempt_allocation_humongous().
 416 
 417   assert_heap_not_locked_and_not_at_safepoint();
 418   assert(!is_humongous(word_size), &quot;attempt_allocation_slow() should not &quot;
 419          &quot;be called for humongous allocation requests&quot;);
 420 
 421   // We should only get here after the first-level allocation attempt
 422   // (attempt_allocation()) failed to allocate.
 423 
 424   // We will loop until a) we manage to successfully perform the
 425   // allocation or b) we successfully schedule a collection which
 426   // fails to perform the allocation. b) is the only case when we&#39;ll
 427   // return NULL.
 428   HeapWord* result = NULL;
 429   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 430     bool should_try_gc;
 431     uint gc_count_before;
 432 
 433     {
 434       MutexLockerEx x(Heap_lock);
 435       result = _allocator-&gt;attempt_allocation_locked(word_size);
 436       if (result != NULL) {
 437         return result;
 438       }
 439 
 440       // If the GCLocker is active and we are bound for a GC, try expanding young gen.
 441       // This is different to when only GCLocker::needs_gc() is set: try to avoid
 442       // waiting because the GCLocker is active to not wait too long.
 443       if (GCLocker::is_active_and_needs_gc() &amp;&amp; policy()-&gt;can_expand_young_list()) {
 444         // No need for an ergo message here, can_expand_young_list() does this when
 445         // it returns true.
 446         result = _allocator-&gt;attempt_allocation_force(word_size);
 447         if (result != NULL) {
 448           return result;
 449         }
 450       }
 451       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 452       // the GCLocker initiated GC has been performed and then retry. This includes
 453       // the case when the GC Locker is not active but has not been performed.
 454       should_try_gc = !GCLocker::needs_gc();
 455       // Read the GC count while still holding the Heap_lock.
 456       gc_count_before = total_collections();
 457     }
 458 
 459     if (should_try_gc) {
 460       bool succeeded;
 461       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 462                                    GCCause::_g1_inc_collection_pause);
 463       if (result != NULL) {
 464         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 465         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 466                              Thread::current()-&gt;name(), p2i(result));
 467         return result;
 468       }
 469 
 470       if (succeeded) {
 471         // We successfully scheduled a collection which failed to allocate. No
 472         // point in trying to allocate further. We&#39;ll just return NULL.
 473         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 474                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 475         return NULL;
 476       }
 477       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot; words&quot;,
 478                            Thread::current()-&gt;name(), word_size);
 479     } else {
 480       // Failed to schedule a collection.
 481       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 482         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 483                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 484         return NULL;
 485       }
 486       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 487       // The GCLocker is either active or the GCLocker initiated
 488       // GC has not yet been performed. Stall until it is and
 489       // then retry the allocation.
 490       GCLocker::stall_until_clear();
 491       gclocker_retry_count += 1;
 492     }
 493 
 494     // We can reach here if we were unsuccessful in scheduling a
 495     // collection (because another thread beat us to it) or if we were
 496     // stalled due to the GC locker. In either can we should retry the
 497     // allocation attempt in case another thread successfully
 498     // performed a collection and reclaimed enough space. We do the
 499     // first attempt (without holding the Heap_lock) here and the
 500     // follow-on attempt will be at the start of the next loop
 501     // iteration (after taking the Heap_lock).
 502     size_t dummy = 0;
 503     result = _allocator-&gt;attempt_allocation(word_size, word_size, &amp;dummy);
 504     if (result != NULL) {
 505       return result;
 506     }
 507 
 508     // Give a warning if we seem to be looping forever.
 509     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 510         (try_count % QueuedAllocationWarningCount == 0)) {
 511       log_warning(gc, alloc)(&quot;%s:  Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 512                              Thread::current()-&gt;name(), try_count, word_size);
 513     }
 514   }
 515 
 516   ShouldNotReachHere();
 517   return NULL;
 518 }
 519 
 520 void G1CollectedHeap::begin_archive_alloc_range(bool open) {
 521   assert_at_safepoint_on_vm_thread();
 522   if (_archive_allocator == NULL) {
 523     _archive_allocator = G1ArchiveAllocator::create_allocator(this, open);
 524   }
 525 }
 526 
 527 bool G1CollectedHeap::is_archive_alloc_too_large(size_t word_size) {
 528   // Allocations in archive regions cannot be of a size that would be considered
 529   // humongous even for a minimum-sized region, because G1 region sizes/boundaries
 530   // may be different at archive-restore time.
 531   return word_size &gt;= humongous_threshold_for(HeapRegion::min_region_size_in_words());
 532 }
 533 
 534 HeapWord* G1CollectedHeap::archive_mem_allocate(size_t word_size) {
 535   assert_at_safepoint_on_vm_thread();
 536   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 537   if (is_archive_alloc_too_large(word_size)) {
 538     return NULL;
 539   }
 540   return _archive_allocator-&gt;archive_mem_allocate(word_size);
 541 }
 542 
 543 void G1CollectedHeap::end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 544                                               size_t end_alignment_in_bytes) {
 545   assert_at_safepoint_on_vm_thread();
 546   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 547 
 548   // Call complete_archive to do the real work, filling in the MemRegion
 549   // array with the archive regions.
 550   _archive_allocator-&gt;complete_archive(ranges, end_alignment_in_bytes);
 551   delete _archive_allocator;
 552   _archive_allocator = NULL;
 553 }
 554 
 555 bool G1CollectedHeap::check_archive_addresses(MemRegion* ranges, size_t count) {
 556   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 557   assert(count != 0, &quot;No MemRegions provided&quot;);
 558   MemRegion reserved = _hrm-&gt;reserved();
 559   for (size_t i = 0; i &lt; count; i++) {
 560     if (!reserved.contains(ranges[i].start()) || !reserved.contains(ranges[i].last())) {
 561       return false;
 562     }
 563   }
 564   return true;
 565 }
 566 
 567 bool G1CollectedHeap::alloc_archive_regions(MemRegion* ranges,
 568                                             size_t count,
 569                                             bool open) {
 570   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 571   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 572   assert(count != 0, &quot;No MemRegions provided&quot;);
 573   MutexLockerEx x(Heap_lock);
 574 
 575   MemRegion reserved = _hrm-&gt;reserved();
 576   HeapWord* prev_last_addr = NULL;
 577   HeapRegion* prev_last_region = NULL;
 578 
 579   // Temporarily disable pretouching of heap pages. This interface is used
 580   // when mmap&#39;ing archived heap data in, so pre-touching is wasted.
 581   FlagSetting fs(AlwaysPreTouch, false);
 582 
 583   // Enable archive object checking used by G1MarkSweep. We have to let it know
 584   // about each archive range, so that objects in those ranges aren&#39;t marked.
 585   G1ArchiveAllocator::enable_archive_object_check();
 586 
 587   // For each specified MemRegion range, allocate the corresponding G1
 588   // regions and mark them as archive regions. We expect the ranges
 589   // in ascending starting address order, without overlap.
 590   for (size_t i = 0; i &lt; count; i++) {
 591     MemRegion curr_range = ranges[i];
 592     HeapWord* start_address = curr_range.start();
 593     size_t word_size = curr_range.word_size();
 594     HeapWord* last_address = curr_range.last();
 595     size_t commits = 0;
 596 
 597     guarantee(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 598               &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 599               p2i(start_address), p2i(last_address));
 600     guarantee(start_address &gt; prev_last_addr,
 601               &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 602               p2i(start_address), p2i(prev_last_addr));
 603     prev_last_addr = last_address;
 604 
 605     // Check for ranges that start in the same G1 region in which the previous
 606     // range ended, and adjust the start address so we don&#39;t try to allocate
 607     // the same region again. If the current range is entirely within that
 608     // region, skip it, just adjusting the recorded top.
 609     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 610     if ((prev_last_region != NULL) &amp;&amp; (start_region == prev_last_region)) {
 611       start_address = start_region-&gt;end();
 612       if (start_address &gt; last_address) {
 613         increase_used(word_size * HeapWordSize);
 614         start_region-&gt;set_top(last_address + 1);
 615         continue;
 616       }
 617       start_region-&gt;set_top(start_address);
 618       curr_range = MemRegion(start_address, last_address + 1);
 619       start_region = _hrm-&gt;addr_to_region(start_address);
 620     }
 621 
 622     // Perform the actual region allocation, exiting if it fails.
 623     // Then note how much new space we have allocated.
 624     if (!_hrm-&gt;allocate_containing_regions(curr_range, &amp;commits, workers())) {
 625       return false;
 626     }
 627     increase_used(word_size * HeapWordSize);
 628     if (commits != 0) {
 629       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocate archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 630                                 HeapRegion::GrainWords * HeapWordSize * commits);
 631 
 632     }
 633 
 634     // Mark each G1 region touched by the range as archive, add it to
 635     // the old set, and set top.
 636     HeapRegion* curr_region = _hrm-&gt;addr_to_region(start_address);
 637     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 638     prev_last_region = last_region;
 639 
 640     while (curr_region != NULL) {
 641       assert(curr_region-&gt;is_empty() &amp;&amp; !curr_region-&gt;is_pinned(),
 642              &quot;Region already in use (index %u)&quot;, curr_region-&gt;hrm_index());
 643       if (open) {
 644         curr_region-&gt;set_open_archive();
 645       } else {
 646         curr_region-&gt;set_closed_archive();
 647       }
 648       _hr_printer.alloc(curr_region);
 649       _archive_set.add(curr_region);
 650       HeapWord* top;
 651       HeapRegion* next_region;
 652       if (curr_region != last_region) {
 653         top = curr_region-&gt;end();
 654         next_region = _hrm-&gt;next_region_in_heap(curr_region);
 655       } else {
 656         top = last_address + 1;
 657         next_region = NULL;
 658       }
 659       curr_region-&gt;set_top(top);
 660       curr_region-&gt;set_first_dead(top);
 661       curr_region-&gt;set_end_of_live(top);
 662       curr_region = next_region;
 663     }
 664 
 665     // Notify mark-sweep of the archive
 666     G1ArchiveAllocator::set_range_archive(curr_range, open);
 667   }
 668   return true;
 669 }
 670 
 671 void G1CollectedHeap::fill_archive_regions(MemRegion* ranges, size_t count) {
 672   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 673   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 674   assert(count != 0, &quot;No MemRegions provided&quot;);
 675   MemRegion reserved = _hrm-&gt;reserved();
 676   HeapWord *prev_last_addr = NULL;
 677   HeapRegion* prev_last_region = NULL;
 678 
 679   // For each MemRegion, create filler objects, if needed, in the G1 regions
 680   // that contain the address range. The address range actually within the
 681   // MemRegion will not be modified. That is assumed to have been initialized
 682   // elsewhere, probably via an mmap of archived heap data.
 683   MutexLockerEx x(Heap_lock);
 684   for (size_t i = 0; i &lt; count; i++) {
 685     HeapWord* start_address = ranges[i].start();
 686     HeapWord* last_address = ranges[i].last();
 687 
 688     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 689            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 690            p2i(start_address), p2i(last_address));
 691     assert(start_address &gt; prev_last_addr,
 692            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 693            p2i(start_address), p2i(prev_last_addr));
 694 
 695     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 696     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 697     HeapWord* bottom_address = start_region-&gt;bottom();
 698 
 699     // Check for a range beginning in the same region in which the
 700     // previous one ended.
 701     if (start_region == prev_last_region) {
 702       bottom_address = prev_last_addr + 1;
 703     }
 704 
 705     // Verify that the regions were all marked as archive regions by
 706     // alloc_archive_regions.
 707     HeapRegion* curr_region = start_region;
 708     while (curr_region != NULL) {
 709       guarantee(curr_region-&gt;is_archive(),
 710                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 711       if (curr_region != last_region) {
 712         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 713       } else {
 714         curr_region = NULL;
 715       }
 716     }
 717 
 718     prev_last_addr = last_address;
 719     prev_last_region = last_region;
 720 
 721     // Fill the memory below the allocated range with dummy object(s),
 722     // if the region bottom does not match the range start, or if the previous
 723     // range ended within the same G1 region, and there is a gap.
 724     if (start_address != bottom_address) {
 725       size_t fill_size = pointer_delta(start_address, bottom_address);
 726       G1CollectedHeap::fill_with_objects(bottom_address, fill_size);
 727       increase_used(fill_size * HeapWordSize);
 728     }
 729   }
 730 }
 731 
 732 inline HeapWord* G1CollectedHeap::attempt_allocation(size_t min_word_size,
 733                                                      size_t desired_word_size,
 734                                                      size_t* actual_word_size) {
 735   assert_heap_not_locked_and_not_at_safepoint();
 736   assert(!is_humongous(desired_word_size), &quot;attempt_allocation() should not &quot;
 737          &quot;be called for humongous allocation requests&quot;);
 738 
 739   HeapWord* result = _allocator-&gt;attempt_allocation(min_word_size, desired_word_size, actual_word_size);
 740 
 741   if (result == NULL) {
 742     *actual_word_size = desired_word_size;
 743     result = attempt_allocation_slow(desired_word_size);
 744   }
 745 
 746   assert_heap_not_locked();
 747   if (result != NULL) {
 748     assert(*actual_word_size != 0, &quot;Actual size must have been set here&quot;);
 749     dirty_young_block(result, *actual_word_size);
 750   } else {
 751     *actual_word_size = 0;
 752   }
 753 
 754   return result;
 755 }
 756 
 757 void G1CollectedHeap::dealloc_archive_regions(MemRegion* ranges, size_t count, bool is_open) {
 758   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 759   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 760   assert(count != 0, &quot;No MemRegions provided&quot;);
 761   MemRegion reserved = _hrm-&gt;reserved();
 762   HeapWord* prev_last_addr = NULL;
 763   HeapRegion* prev_last_region = NULL;
 764   size_t size_used = 0;
 765   size_t uncommitted_regions = 0;
 766 
 767   // For each Memregion, free the G1 regions that constitute it, and
 768   // notify mark-sweep that the range is no longer to be considered &#39;archive.&#39;
 769   MutexLockerEx x(Heap_lock);
 770   for (size_t i = 0; i &lt; count; i++) {
 771     HeapWord* start_address = ranges[i].start();
 772     HeapWord* last_address = ranges[i].last();
 773 
 774     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 775            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 776            p2i(start_address), p2i(last_address));
 777     assert(start_address &gt; prev_last_addr,
 778            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 779            p2i(start_address), p2i(prev_last_addr));
 780     size_used += ranges[i].byte_size();
 781     prev_last_addr = last_address;
 782 
 783     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 784     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 785 
 786     // Check for ranges that start in the same G1 region in which the previous
 787     // range ended, and adjust the start address so we don&#39;t try to free
 788     // the same region again. If the current range is entirely within that
 789     // region, skip it.
 790     if (start_region == prev_last_region) {
 791       start_address = start_region-&gt;end();
 792       if (start_address &gt; last_address) {
 793         continue;
 794       }
 795       start_region = _hrm-&gt;addr_to_region(start_address);
 796     }
 797     prev_last_region = last_region;
 798 
 799     // After verifying that each region was marked as an archive region by
 800     // alloc_archive_regions, set it free and empty and uncommit it.
 801     HeapRegion* curr_region = start_region;
 802     while (curr_region != NULL) {
 803       guarantee(curr_region-&gt;is_archive(),
 804                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 805       uint curr_index = curr_region-&gt;hrm_index();
 806       _archive_set.remove(curr_region);
 807       curr_region-&gt;set_free();
 808       curr_region-&gt;set_top(curr_region-&gt;bottom());
 809       if (curr_region != last_region) {
 810         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 811       } else {
 812         curr_region = NULL;
 813       }
 814       _hrm-&gt;shrink_at(curr_index, 1);
 815       uncommitted_regions++;
 816     }
 817 
 818     // Notify mark-sweep that this is no longer an archive range.
 819     G1ArchiveAllocator::clear_range_archive(ranges[i], is_open);
 820   }
 821 
 822   if (uncommitted_regions != 0) {
 823     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (uncommitted archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 824                               HeapRegion::GrainWords * HeapWordSize * uncommitted_regions);
 825   }
 826   decrease_used(size_used);
 827 }
 828 
 829 oop G1CollectedHeap::materialize_archived_object(oop obj) {
 830   assert(obj != NULL, &quot;archived obj is NULL&quot;);
 831   assert(G1ArchiveAllocator::is_archived_object(obj), &quot;must be archived object&quot;);
 832 
 833   // Loading an archived object makes it strongly reachable. If it is
 834   // loaded during concurrent marking, it must be enqueued to the SATB
 835   // queue, shading the previously white object gray.
 836   G1BarrierSet::enqueue(obj);
 837 
 838   return obj;
 839 }
 840 
 841 HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {
 842   ResourceMark rm; // For retrieving the thread names in log messages.
 843 
 844   // The structure of this method has a lot of similarities to
 845   // attempt_allocation_slow(). The reason these two were not merged
 846   // into a single one is that such a method would require several &quot;if
 847   // allocation is not humongous do this, otherwise do that&quot;
 848   // conditional paths which would obscure its flow. In fact, an early
 849   // version of this code did use a unified method which was harder to
 850   // follow and, as a result, it had subtle bugs that were hard to
 851   // track down. So keeping these two methods separate allows each to
 852   // be more readable. It will be good to keep these two in sync as
 853   // much as possible.
 854 
 855   assert_heap_not_locked_and_not_at_safepoint();
 856   assert(is_humongous(word_size), &quot;attempt_allocation_humongous() &quot;
 857          &quot;should only be called for humongous allocations&quot;);
 858 
 859   // Humongous objects can exhaust the heap quickly, so we should check if we
 860   // need to start a marking cycle at each humongous object allocation. We do
 861   // the check before we do the actual allocation. The reason for doing it
 862   // before the allocation is that we avoid having to keep track of the newly
 863   // allocated memory while we do a GC.
 864   if (policy()-&gt;need_to_start_conc_mark(&quot;concurrent humongous allocation&quot;,
 865                                            word_size)) {
 866     collect(GCCause::_g1_humongous_allocation);
 867   }
 868 
 869   // We will loop until a) we manage to successfully perform the
 870   // allocation or b) we successfully schedule a collection which
 871   // fails to perform the allocation. b) is the only case when we&#39;ll
 872   // return NULL.
 873   HeapWord* result = NULL;
 874   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 875     bool should_try_gc;
 876     uint gc_count_before;
 877 
 878 
 879     {
 880       MutexLockerEx x(Heap_lock);
 881 
 882       // Given that humongous objects are not allocated in young
 883       // regions, we&#39;ll first try to do the allocation without doing a
 884       // collection hoping that there&#39;s enough space in the heap.
 885       result = humongous_obj_allocate(word_size);
 886       if (result != NULL) {
 887         size_t size_in_regions = humongous_obj_size_in_regions(word_size);
 888         policy()-&gt;add_bytes_allocated_in_old_since_last_gc(size_in_regions * HeapRegion::GrainBytes);
 889         return result;
 890       }
 891 
 892       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 893       // the GCLocker initiated GC has been performed and then retry. This includes
 894       // the case when the GC Locker is not active but has not been performed.
 895       should_try_gc = !GCLocker::needs_gc();
 896       // Read the GC count while still holding the Heap_lock.
 897       gc_count_before = total_collections();
 898     }
 899 
 900     if (should_try_gc) {
 901       bool succeeded;
 902       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 903                                    GCCause::_g1_humongous_allocation);
 904       if (result != NULL) {
 905         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 906         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 907                              Thread::current()-&gt;name(), p2i(result));
 908         return result;
 909       }
 910 
 911       if (succeeded) {
 912         // We successfully scheduled a collection which failed to allocate. No
 913         // point in trying to allocate further. We&#39;ll just return NULL.
 914         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 915                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 916         return NULL;
 917       }
 918       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot;&quot;,
 919                            Thread::current()-&gt;name(), word_size);
 920     } else {
 921       // Failed to schedule a collection.
 922       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 923         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 924                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 925         return NULL;
 926       }
 927       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 928       // The GCLocker is either active or the GCLocker initiated
 929       // GC has not yet been performed. Stall until it is and
 930       // then retry the allocation.
 931       GCLocker::stall_until_clear();
 932       gclocker_retry_count += 1;
 933     }
 934 
 935 
 936     // We can reach here if we were unsuccessful in scheduling a
 937     // collection (because another thread beat us to it) or if we were
 938     // stalled due to the GC locker. In either can we should retry the
 939     // allocation attempt in case another thread successfully
 940     // performed a collection and reclaimed enough space.
 941     // Humongous object allocation always needs a lock, so we wait for the retry
 942     // in the next iteration of the loop, unlike for the regular iteration case.
 943     // Give a warning if we seem to be looping forever.
 944 
 945     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 946         (try_count % QueuedAllocationWarningCount == 0)) {
 947       log_warning(gc, alloc)(&quot;%s: Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 948                              Thread::current()-&gt;name(), try_count, word_size);
 949     }
 950   }
 951 
 952   ShouldNotReachHere();
 953   return NULL;
 954 }
 955 
 956 HeapWord* G1CollectedHeap::attempt_allocation_at_safepoint(size_t word_size,
 957                                                            bool expect_null_mutator_alloc_region) {
 958   assert_at_safepoint_on_vm_thread();
 959   assert(!_allocator-&gt;has_mutator_alloc_region() || !expect_null_mutator_alloc_region,
 960          &quot;the current alloc region was unexpectedly found to be non-NULL&quot;);
 961 
 962   if (!is_humongous(word_size)) {
 963     return _allocator-&gt;attempt_allocation_locked(word_size);
 964   } else {
 965     HeapWord* result = humongous_obj_allocate(word_size);
 966     if (result != NULL &amp;&amp; policy()-&gt;need_to_start_conc_mark(&quot;STW humongous allocation&quot;)) {
 967       collector_state()-&gt;set_initiate_conc_mark_if_possible(true);
 968     }
 969     return result;
 970   }
 971 
 972   ShouldNotReachHere();
 973 }
 974 
 975 class PostCompactionPrinterClosure: public HeapRegionClosure {
 976 private:
 977   G1HRPrinter* _hr_printer;
 978 public:
 979   bool do_heap_region(HeapRegion* hr) {
 980     assert(!hr-&gt;is_young(), &quot;not expecting to find young regions&quot;);
 981     _hr_printer-&gt;post_compaction(hr);
 982     return false;
 983   }
 984 
 985   PostCompactionPrinterClosure(G1HRPrinter* hr_printer)
 986     : _hr_printer(hr_printer) { }
 987 };
 988 
 989 void G1CollectedHeap::print_hrm_post_compaction() {
 990   if (_hr_printer.is_active()) {
 991     PostCompactionPrinterClosure cl(hr_printer());
 992     heap_region_iterate(&amp;cl);
 993   }
 994 }
 995 
 996 void G1CollectedHeap::abort_concurrent_cycle() {
 997   // If we start the compaction before the CM threads finish
 998   // scanning the root regions we might trip them over as we&#39;ll
 999   // be moving objects / updating references. So let&#39;s wait until
1000   // they are done. By telling them to abort, they should complete
1001   // early.
1002   _cm-&gt;root_regions()-&gt;abort();
1003   _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
1004 
1005   // Disable discovery and empty the discovered lists
1006   // for the CM ref processor.
1007   _ref_processor_cm-&gt;disable_discovery();
1008   _ref_processor_cm-&gt;abandon_partial_discovery();
1009   _ref_processor_cm-&gt;verify_no_references_recorded();
1010 
1011   // Abandon current iterations of concurrent marking and concurrent
1012   // refinement, if any are in progress.
1013   concurrent_mark()-&gt;concurrent_cycle_abort();
1014 }
1015 
1016 void G1CollectedHeap::prepare_heap_for_full_collection() {
1017   // Make sure we&#39;ll choose a new allocation region afterwards.
1018   _allocator-&gt;release_mutator_alloc_region();
1019   _allocator-&gt;abandon_gc_alloc_regions();
1020 
1021   // We may have added regions to the current incremental collection
1022   // set between the last GC or pause and now. We need to clear the
1023   // incremental collection set and then start rebuilding it afresh
1024   // after this full GC.
1025   abandon_collection_set(collection_set());
1026 
1027   tear_down_region_sets(false /* free_list_only */);
1028 
1029   hrm()-&gt;prepare_for_full_collection_start();
1030 }
1031 
1032 void G1CollectedHeap::verify_before_full_collection(bool explicit_gc) {
1033   assert(!GCCause::is_user_requested_gc(gc_cause()) || explicit_gc, &quot;invariant&quot;);
1034   assert(used() == recalculate_used(), &quot;Should be equal&quot;);
1035   _verifier-&gt;verify_region_sets_optional();
1036   _verifier-&gt;verify_before_gc(G1HeapVerifier::G1VerifyFull);
1037   _verifier-&gt;check_bitmaps(&quot;Full GC Start&quot;);
1038 }
1039 
1040 void G1CollectedHeap::prepare_heap_for_mutators() {
1041   hrm()-&gt;prepare_for_full_collection_end();
1042 
1043   // Delete metaspaces for unloaded class loaders and clean up loader_data graph
1044   ClassLoaderDataGraph::purge();
1045   MetaspaceUtils::verify_metrics();
1046 
1047   // Prepare heap for normal collections.
1048   assert(num_free_regions() == 0, &quot;we should not have added any free regions&quot;);
1049   rebuild_region_sets(false /* free_list_only */);
1050   abort_refinement();
1051   resize_heap_if_necessary();
1052 
1053   // Rebuild the strong code root lists for each region
1054   rebuild_strong_code_roots();
1055 
1056   // Purge code root memory
1057   purge_code_root_memory();
1058 
1059   // Start a new incremental collection set for the next pause
1060   start_new_collection_set();
1061 
1062   _allocator-&gt;init_mutator_alloc_region();
1063 
1064   // Post collection state updates.
1065   MetaspaceGC::compute_new_size();
1066 }
1067 
1068 void G1CollectedHeap::abort_refinement() {
1069   if (_hot_card_cache-&gt;use_cache()) {
1070     _hot_card_cache-&gt;reset_hot_cache();
1071   }
1072 
1073   // Discard all remembered set updates.
1074   G1BarrierSet::dirty_card_queue_set().abandon_logs();
1075   assert(dirty_card_queue_set().completed_buffers_num() == 0, &quot;DCQS should be empty&quot;);
1076 }
1077 
1078 void G1CollectedHeap::verify_after_full_collection() {
1079   _hrm-&gt;verify_optional();
1080   _verifier-&gt;verify_region_sets_optional();
1081   _verifier-&gt;verify_after_gc(G1HeapVerifier::G1VerifyFull);
1082   // Clear the previous marking bitmap, if needed for bitmap verification.
1083   // Note we cannot do this when we clear the next marking bitmap in
1084   // G1ConcurrentMark::abort() above since VerifyDuringGC verifies the
1085   // objects marked during a full GC against the previous bitmap.
1086   // But we need to clear it before calling check_bitmaps below since
1087   // the full GC has compacted objects and updated TAMS but not updated
1088   // the prev bitmap.
1089   if (G1VerifyBitmaps) {
1090     GCTraceTime(Debug, gc)(&quot;Clear Prev Bitmap for Verification&quot;);
1091     _cm-&gt;clear_prev_bitmap(workers());
1092   }
1093   // This call implicitly verifies that the next bitmap is clear after Full GC.
1094   _verifier-&gt;check_bitmaps(&quot;Full GC End&quot;);
1095 
1096   // At this point there should be no regions in the
1097   // entire heap tagged as young.
1098   assert(check_young_list_empty(), &quot;young list should be empty at this point&quot;);
1099 
1100   // Note: since we&#39;ve just done a full GC, concurrent
1101   // marking is no longer active. Therefore we need not
1102   // re-enable reference discovery for the CM ref processor.
1103   // That will be done at the start of the next marking cycle.
1104   // We also know that the STW processor should no longer
1105   // discover any new references.
1106   assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1107   assert(!_ref_processor_cm-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1108   _ref_processor_stw-&gt;verify_no_references_recorded();
1109   _ref_processor_cm-&gt;verify_no_references_recorded();
1110 }
1111 
1112 void G1CollectedHeap::print_heap_after_full_collection(G1HeapTransition* heap_transition) {
1113   // Post collection logging.
1114   // We should do this after we potentially resize the heap so
1115   // that all the COMMIT / UNCOMMIT events are generated before
1116   // the compaction events.
1117   print_hrm_post_compaction();
1118   heap_transition-&gt;print();
1119   print_heap_after_gc();
1120   print_heap_regions();
1121 #ifdef TRACESPINNING
1122   ParallelTaskTerminator::print_termination_counts();
1123 #endif
1124 }
1125 
1126 bool G1CollectedHeap::do_full_collection(bool explicit_gc,
1127                                          bool clear_all_soft_refs) {
1128   assert_at_safepoint_on_vm_thread();
1129 
1130   if (GCLocker::check_active_before_gc()) {
1131     // Full GC was not completed.
1132     return false;
1133   }
1134 
1135   const bool do_clear_all_soft_refs = clear_all_soft_refs ||
1136       soft_ref_policy()-&gt;should_clear_all_soft_refs();
1137 
1138   G1FullCollector collector(this, explicit_gc, do_clear_all_soft_refs);
1139   GCTraceTime(Info, gc) tm(&quot;Pause Full&quot;, NULL, gc_cause(), true);
1140 
1141   collector.prepare_collection();
1142   collector.collect();
1143   collector.complete_collection();
1144 
1145   // Full collection was successfully completed.
1146   return true;
1147 }
1148 
1149 void G1CollectedHeap::do_full_collection(bool clear_all_soft_refs) {
1150   // Currently, there is no facility in the do_full_collection(bool) API to notify
1151   // the caller that the collection did not succeed (e.g., because it was locked
1152   // out by the GC locker). So, right now, we&#39;ll ignore the return value.
1153   bool dummy = do_full_collection(true,                /* explicit_gc */
1154                                   clear_all_soft_refs);
1155 }
1156 
1157 void G1CollectedHeap::resize_heap_if_necessary() {
1158   assert_at_safepoint_on_vm_thread();
1159 
1160   // Capacity, free and used after the GC counted as full regions to
1161   // include the waste in the following calculations.
1162   const size_t capacity_after_gc = capacity();
1163   const size_t used_after_gc = capacity_after_gc - unused_committed_regions_in_bytes();
1164 
1165   // This is enforced in arguments.cpp.
1166   assert(MinHeapFreeRatio &lt;= MaxHeapFreeRatio,
1167          &quot;otherwise the code below doesn&#39;t make sense&quot;);
1168 
1169   // We don&#39;t have floating point command-line arguments
1170   const double minimum_free_percentage = (double) MinHeapFreeRatio / 100.0;
1171   const double maximum_used_percentage = 1.0 - minimum_free_percentage;
1172   const double maximum_free_percentage = (double) MaxHeapFreeRatio / 100.0;
1173   const double minimum_used_percentage = 1.0 - maximum_free_percentage;
1174 
1175   const size_t min_heap_size = collector_policy()-&gt;min_heap_byte_size();
1176   const size_t max_heap_size = collector_policy()-&gt;max_heap_byte_size();
1177 
1178   // We have to be careful here as these two calculations can overflow
1179   // 32-bit size_t&#39;s.
1180   double used_after_gc_d = (double) used_after_gc;
1181   double minimum_desired_capacity_d = used_after_gc_d / maximum_used_percentage;
1182   double maximum_desired_capacity_d = used_after_gc_d / minimum_used_percentage;
1183 
1184   // Let&#39;s make sure that they are both under the max heap size, which
1185   // by default will make them fit into a size_t.
1186   double desired_capacity_upper_bound = (double) max_heap_size;
1187   minimum_desired_capacity_d = MIN2(minimum_desired_capacity_d,
1188                                     desired_capacity_upper_bound);
1189   maximum_desired_capacity_d = MIN2(maximum_desired_capacity_d,
1190                                     desired_capacity_upper_bound);
1191 
1192   // We can now safely turn them into size_t&#39;s.
1193   size_t minimum_desired_capacity = (size_t) minimum_desired_capacity_d;
1194   size_t maximum_desired_capacity = (size_t) maximum_desired_capacity_d;
1195 
1196   // This assert only makes sense here, before we adjust them
1197   // with respect to the min and max heap size.
1198   assert(minimum_desired_capacity &lt;= maximum_desired_capacity,
1199          &quot;minimum_desired_capacity = &quot; SIZE_FORMAT &quot;, &quot;
1200          &quot;maximum_desired_capacity = &quot; SIZE_FORMAT,
1201          minimum_desired_capacity, maximum_desired_capacity);
1202 
1203   // Should not be greater than the heap max size. No need to adjust
1204   // it with respect to the heap min size as it&#39;s a lower bound (i.e.,
1205   // we&#39;ll try to make the capacity larger than it, not smaller).
1206   minimum_desired_capacity = MIN2(minimum_desired_capacity, max_heap_size);
1207   // Should not be less than the heap min size. No need to adjust it
1208   // with respect to the heap max size as it&#39;s an upper bound (i.e.,
1209   // we&#39;ll try to make the capacity smaller than it, not greater).
1210   maximum_desired_capacity =  MAX2(maximum_desired_capacity, min_heap_size);
1211 
1212   if (capacity_after_gc &lt; minimum_desired_capacity) {
1213     // Don&#39;t expand unless it&#39;s significant
1214     size_t expand_bytes = minimum_desired_capacity - capacity_after_gc;
1215 
1216     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (capacity lower than min desired capacity). &quot;
1217                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1218                               &quot;min_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1219                               capacity_after_gc, used_after_gc, used(), minimum_desired_capacity, MinHeapFreeRatio);
1220 
1221     expand(expand_bytes, _workers);
1222 
1223     // No expansion, now see if we want to shrink
1224   } else if (capacity_after_gc &gt; maximum_desired_capacity) {
1225     // Capacity too large, compute shrinking size
1226     size_t shrink_bytes = capacity_after_gc - maximum_desired_capacity;
1227 
1228     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (capacity higher than max desired capacity). &quot;
1229                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1230                               &quot;maximum_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1231                               capacity_after_gc, used_after_gc, used(), maximum_desired_capacity, MaxHeapFreeRatio);
1232 
1233     shrink(shrink_bytes);
1234   }
1235 }
1236 
1237 HeapWord* G1CollectedHeap::satisfy_failed_allocation_helper(size_t word_size,
1238                                                             bool do_gc,
1239                                                             bool clear_all_soft_refs,
1240                                                             bool expect_null_mutator_alloc_region,
1241                                                             bool* gc_succeeded) {
1242   *gc_succeeded = true;
1243   // Let&#39;s attempt the allocation first.
1244   HeapWord* result =
1245     attempt_allocation_at_safepoint(word_size,
1246                                     expect_null_mutator_alloc_region);
1247   if (result != NULL) {
1248     return result;
1249   }
1250 
1251   // In a G1 heap, we&#39;re supposed to keep allocation from failing by
1252   // incremental pauses.  Therefore, at least for now, we&#39;ll favor
1253   // expansion over collection.  (This might change in the future if we can
1254   // do something smarter than full collection to satisfy a failed alloc.)
1255   result = expand_and_allocate(word_size);
1256   if (result != NULL) {
1257     return result;
1258   }
1259 
1260   if (do_gc) {
1261     // Expansion didn&#39;t work, we&#39;ll try to do a Full GC.
1262     *gc_succeeded = do_full_collection(false, /* explicit_gc */
1263                                        clear_all_soft_refs);
1264   }
1265 
1266   return NULL;
1267 }
1268 
1269 HeapWord* G1CollectedHeap::satisfy_failed_allocation(size_t word_size,
1270                                                      bool* succeeded) {
1271   assert_at_safepoint_on_vm_thread();
1272 
1273   // Attempts to allocate followed by Full GC.
1274   HeapWord* result =
1275     satisfy_failed_allocation_helper(word_size,
1276                                      true,  /* do_gc */
1277                                      false, /* clear_all_soft_refs */
1278                                      false, /* expect_null_mutator_alloc_region */
1279                                      succeeded);
1280 
1281   if (result != NULL || !*succeeded) {
1282     return result;
1283   }
1284 
1285   // Attempts to allocate followed by Full GC that will collect all soft references.
1286   result = satisfy_failed_allocation_helper(word_size,
1287                                             true, /* do_gc */
1288                                             true, /* clear_all_soft_refs */
1289                                             true, /* expect_null_mutator_alloc_region */
1290                                             succeeded);
1291 
1292   if (result != NULL || !*succeeded) {
1293     return result;
1294   }
1295 
1296   // Attempts to allocate, no GC
1297   result = satisfy_failed_allocation_helper(word_size,
1298                                             false, /* do_gc */
1299                                             false, /* clear_all_soft_refs */
1300                                             true,  /* expect_null_mutator_alloc_region */
1301                                             succeeded);
1302 
1303   if (result != NULL) {
1304     return result;
1305   }
1306 
1307   assert(!soft_ref_policy()-&gt;should_clear_all_soft_refs(),
1308          &quot;Flag should have been handled and cleared prior to this point&quot;);
1309 
1310   // What else?  We might try synchronous finalization later.  If the total
1311   // space available is large enough for the allocation, then a more
1312   // complete compaction phase than we&#39;ve tried so far might be
1313   // appropriate.
1314   return NULL;
1315 }
1316 
1317 // Attempting to expand the heap sufficiently
1318 // to support an allocation of the given &quot;word_size&quot;.  If
1319 // successful, perform the allocation and return the address of the
1320 // allocated block, or else &quot;NULL&quot;.
1321 
1322 HeapWord* G1CollectedHeap::expand_and_allocate(size_t word_size) {
1323   assert_at_safepoint_on_vm_thread();
1324 
1325   _verifier-&gt;verify_region_sets_optional();
1326 
1327   size_t expand_bytes = MAX2(word_size * HeapWordSize, MinHeapDeltaBytes);
1328   log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
1329                             word_size * HeapWordSize);
1330 
1331 
1332   if (expand(expand_bytes, _workers)) {
1333     _hrm-&gt;verify_optional();
1334     _verifier-&gt;verify_region_sets_optional();
1335     return attempt_allocation_at_safepoint(word_size,
1336                                            false /* expect_null_mutator_alloc_region */);
1337   }
1338   return NULL;
1339 }
1340 
1341 bool G1CollectedHeap::expand(size_t expand_bytes, WorkGang* pretouch_workers, double* expand_time_ms) {
1342   size_t aligned_expand_bytes = ReservedSpace::page_align_size_up(expand_bytes);
1343   aligned_expand_bytes = align_up(aligned_expand_bytes,
1344                                        HeapRegion::GrainBytes);
1345 
1346   log_debug(gc, ergo, heap)(&quot;Expand the heap. requested expansion amount: &quot; SIZE_FORMAT &quot;B expansion amount: &quot; SIZE_FORMAT &quot;B&quot;,
1347                             expand_bytes, aligned_expand_bytes);
1348 
1349   if (is_maximal_no_gc()) {
1350     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1351     return false;
1352   }
1353 
1354   double expand_heap_start_time_sec = os::elapsedTime();
1355   uint regions_to_expand = (uint)(aligned_expand_bytes / HeapRegion::GrainBytes);
1356   assert(regions_to_expand &gt; 0, &quot;Must expand by at least one region&quot;);
1357 
1358   uint expanded_by = _hrm-&gt;expand_by(regions_to_expand, pretouch_workers);
1359   if (expand_time_ms != NULL) {
1360     *expand_time_ms = (os::elapsedTime() - expand_heap_start_time_sec) * MILLIUNITS;
1361   }
1362 
1363   if (expanded_by &gt; 0) {
1364     size_t actual_expand_bytes = expanded_by * HeapRegion::GrainBytes;
1365     assert(actual_expand_bytes &lt;= aligned_expand_bytes, &quot;post-condition&quot;);
1366     policy()-&gt;record_new_heap_size(num_regions());
1367   } else {
1368     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap expansion operation failed)&quot;);
1369 
1370     // The expansion of the virtual storage space was unsuccessful.
1371     // Let&#39;s see if it was because we ran out of swap.
1372     if (G1ExitOnExpansionFailure &amp;&amp;
1373         _hrm-&gt;available() &gt;= regions_to_expand) {
1374       // We had head room...
1375       vm_exit_out_of_memory(aligned_expand_bytes, OOM_MMAP_ERROR, &quot;G1 heap expansion&quot;);
1376     }
1377   }
1378   return regions_to_expand &gt; 0;
1379 }
1380 
1381 void G1CollectedHeap::shrink_helper(size_t shrink_bytes) {
1382   size_t aligned_shrink_bytes =
1383     ReservedSpace::page_align_size_down(shrink_bytes);
1384   aligned_shrink_bytes = align_down(aligned_shrink_bytes,
1385                                          HeapRegion::GrainBytes);
1386   uint num_regions_to_remove = (uint)(shrink_bytes / HeapRegion::GrainBytes);
1387 
1388   uint num_regions_removed = _hrm-&gt;shrink_by(num_regions_to_remove);
1389   size_t shrunk_bytes = num_regions_removed * HeapRegion::GrainBytes;
1390 
1391 
1392   log_debug(gc, ergo, heap)(&quot;Shrink the heap. requested shrinking amount: &quot; SIZE_FORMAT &quot;B aligned shrinking amount: &quot; SIZE_FORMAT &quot;B attempted shrinking amount: &quot; SIZE_FORMAT &quot;B&quot;,
1393                             shrink_bytes, aligned_shrink_bytes, shrunk_bytes);
1394   if (num_regions_removed &gt; 0) {
1395     policy()-&gt;record_new_heap_size(num_regions());
1396   } else {
1397     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap shrinking operation failed)&quot;);
1398   }
1399 }
1400 
1401 void G1CollectedHeap::shrink(size_t shrink_bytes) {
1402   _verifier-&gt;verify_region_sets_optional();
1403 
1404   // We should only reach here at the end of a Full GC or during Remark which
1405   // means we should not not be holding to any GC alloc regions. The method
1406   // below will make sure of that and do any remaining clean up.
1407   _allocator-&gt;abandon_gc_alloc_regions();
1408 
1409   // Instead of tearing down / rebuilding the free lists here, we
1410   // could instead use the remove_all_pending() method on free_list to
1411   // remove only the ones that we need to remove.
1412   tear_down_region_sets(true /* free_list_only */);
1413   shrink_helper(shrink_bytes);
1414   rebuild_region_sets(true /* free_list_only */);
1415 
1416   _hrm-&gt;verify_optional();
1417   _verifier-&gt;verify_region_sets_optional();
1418 }
1419 
1420 class OldRegionSetChecker : public HeapRegionSetChecker {
1421 public:
1422   void check_mt_safety() {
1423     // Master Old Set MT safety protocol:
1424     // (a) If we&#39;re at a safepoint, operations on the master old set
1425     // should be invoked:
1426     // - by the VM thread (which will serialize them), or
1427     // - by the GC workers while holding the FreeList_lock, if we&#39;re
1428     //   at a safepoint for an evacuation pause (this lock is taken
1429     //   anyway when an GC alloc region is retired so that a new one
1430     //   is allocated from the free list), or
1431     // - by the GC workers while holding the OldSets_lock, if we&#39;re at a
1432     //   safepoint for a cleanup pause.
1433     // (b) If we&#39;re not at a safepoint, operations on the master old set
1434     // should be invoked while holding the Heap_lock.
1435 
1436     if (SafepointSynchronize::is_at_safepoint()) {
1437       guarantee(Thread::current()-&gt;is_VM_thread() ||
1438                 FreeList_lock-&gt;owned_by_self() || OldSets_lock-&gt;owned_by_self(),
1439                 &quot;master old set MT safety protocol at a safepoint&quot;);
1440     } else {
1441       guarantee(Heap_lock-&gt;owned_by_self(), &quot;master old set MT safety protocol outside a safepoint&quot;);
1442     }
1443   }
1444   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_old(); }
1445   const char* get_description() { return &quot;Old Regions&quot;; }
1446 };
1447 
1448 class ArchiveRegionSetChecker : public HeapRegionSetChecker {
1449 public:
1450   void check_mt_safety() {
1451     guarantee(!Universe::is_fully_initialized() || SafepointSynchronize::is_at_safepoint(),
1452               &quot;May only change archive regions during initialization or safepoint.&quot;);
1453   }
1454   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_archive(); }
1455   const char* get_description() { return &quot;Archive Regions&quot;; }
1456 };
1457 
1458 class HumongousRegionSetChecker : public HeapRegionSetChecker {
1459 public:
1460   void check_mt_safety() {
1461     // Humongous Set MT safety protocol:
1462     // (a) If we&#39;re at a safepoint, operations on the master humongous
1463     // set should be invoked by either the VM thread (which will
1464     // serialize them) or by the GC workers while holding the
1465     // OldSets_lock.
1466     // (b) If we&#39;re not at a safepoint, operations on the master
1467     // humongous set should be invoked while holding the Heap_lock.
1468 
1469     if (SafepointSynchronize::is_at_safepoint()) {
1470       guarantee(Thread::current()-&gt;is_VM_thread() ||
1471                 OldSets_lock-&gt;owned_by_self(),
1472                 &quot;master humongous set MT safety protocol at a safepoint&quot;);
1473     } else {
1474       guarantee(Heap_lock-&gt;owned_by_self(),
1475                 &quot;master humongous set MT safety protocol outside a safepoint&quot;);
1476     }
1477   }
1478   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_humongous(); }
1479   const char* get_description() { return &quot;Humongous Regions&quot;; }
1480 };
1481 
1482 G1CollectedHeap::G1CollectedHeap(G1CollectorPolicy* collector_policy) :
1483   CollectedHeap(),
1484   _young_gen_sampling_thread(NULL),
1485   _workers(NULL),
1486   _collector_policy(collector_policy),
1487   _card_table(NULL),
1488   _soft_ref_policy(),
1489   _old_set(&quot;Old Region Set&quot;, new OldRegionSetChecker()),
1490   _archive_set(&quot;Archive Region Set&quot;, new ArchiveRegionSetChecker()),
1491   _humongous_set(&quot;Humongous Region Set&quot;, new HumongousRegionSetChecker()),
1492   _bot(NULL),
1493   _listener(),
1494   _hrm(NULL),
1495   _allocator(NULL),
1496   _verifier(NULL),
1497   _summary_bytes_used(0),
1498   _archive_allocator(NULL),
1499   _survivor_evac_stats(&quot;Young&quot;, YoungPLABSize, PLABWeight),
1500   _old_evac_stats(&quot;Old&quot;, OldPLABSize, PLABWeight),
1501   _expand_heap_after_alloc_failure(true),
1502   _g1mm(NULL),
1503   _humongous_reclaim_candidates(),
1504   _has_humongous_reclaim_candidates(false),
1505   _hr_printer(),
1506   _collector_state(),
1507   _old_marking_cycles_started(0),
1508   _old_marking_cycles_completed(0),
1509   _eden(),
1510   _survivor(),
1511   _gc_timer_stw(new (ResourceObj::C_HEAP, mtGC) STWGCTimer()),
1512   _gc_tracer_stw(new (ResourceObj::C_HEAP, mtGC) G1NewTracer()),
1513   _policy(G1Policy::create_policy(collector_policy, _gc_timer_stw)),
1514   _heap_sizing_policy(NULL),
1515   _collection_set(this, _policy),
1516   _hot_card_cache(NULL),
1517   _rem_set(NULL),
1518   _dirty_card_queue_set(false),
1519   _cm(NULL),
1520   _cm_thread(NULL),
1521   _cr(NULL),
1522   _task_queues(NULL),
1523   _evacuation_failed(false),
1524   _evacuation_failed_info_array(NULL),
1525   _preserved_marks_set(true /* in_c_heap */),
1526 #ifndef PRODUCT
1527   _evacuation_failure_alot_for_current_gc(false),
1528   _evacuation_failure_alot_gc_number(0),
1529   _evacuation_failure_alot_count(0),
1530 #endif
1531   _ref_processor_stw(NULL),
1532   _is_alive_closure_stw(this),
1533   _is_subject_to_discovery_stw(this),
1534   _ref_processor_cm(NULL),
1535   _is_alive_closure_cm(this),
1536   _is_subject_to_discovery_cm(this),
1537   _in_cset_fast_test() {
1538 
1539   _verifier = new G1HeapVerifier(this);
1540 
1541   _allocator = new G1Allocator(this);
1542 
1543   _heap_sizing_policy = G1HeapSizingPolicy::create(this, _policy-&gt;analytics());
1544 
1545   _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);
1546 
1547   // Override the default _filler_array_max_size so that no humongous filler
1548   // objects are created.
1549   _filler_array_max_size = _humongous_object_threshold_in_words;
1550 
1551   uint n_queues = ParallelGCThreads;
1552   _task_queues = new RefToScanQueueSet(n_queues);
1553 
1554   _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);
1555 
1556   for (uint i = 0; i &lt; n_queues; i++) {
1557     RefToScanQueue* q = new RefToScanQueue();
1558     q-&gt;initialize();
1559     _task_queues-&gt;register_queue(i, q);
1560     ::new (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();
1561   }
1562 
1563   // Initialize the G1EvacuationFailureALot counters and flags.
1564   NOT_PRODUCT(reset_evacuation_should_fail();)
1565 
1566   guarantee(_task_queues != NULL, &quot;task_queues allocation failure.&quot;);
1567 }
1568 
1569 static size_t actual_reserved_page_size(ReservedSpace rs) {
1570   size_t page_size = os::vm_page_size();
1571   if (UseLargePages) {
1572     // There are two ways to manage large page memory.
1573     // 1. OS supports committing large page memory.
1574     // 2. OS doesn&#39;t support committing large page memory so ReservedSpace manages it.
1575     //    And ReservedSpace calls it &#39;special&#39;. If we failed to set &#39;special&#39;,
1576     //    we reserved memory without large page.
1577     if (os::can_commit_large_page_memory() || rs.special()) {
1578       page_size = rs.alignment();
1579     }
1580   }
1581 
1582   return page_size;
1583 }
1584 
1585 G1RegionToSpaceMapper* G1CollectedHeap::create_aux_memory_mapper(const char* description,
1586                                                                  size_t size,
1587                                                                  size_t translation_factor) {
1588   size_t preferred_page_size = os::page_size_for_region_unaligned(size, 1);
1589   // Allocate a new reserved space, preferring to use large pages.
1590   ReservedSpace rs(size, preferred_page_size);
1591   size_t page_size = actual_reserved_page_size(rs);
1592   G1RegionToSpaceMapper* result  =
1593     G1RegionToSpaceMapper::create_mapper(rs,
1594                                          size,
1595                                          page_size,
1596                                          HeapRegion::GrainBytes,
1597                                          translation_factor,
1598                                          mtGC);
1599 
1600   os::trace_page_sizes_for_requested_size(description,
1601                                           size,
1602                                           preferred_page_size,
1603                                           page_size,
1604                                           rs.base(),
1605                                           rs.size());
1606 
1607   return result;
1608 }
1609 
1610 jint G1CollectedHeap::initialize_concurrent_refinement() {
1611   jint ecode = JNI_OK;
1612   _cr = G1ConcurrentRefine::create(&amp;ecode);
1613   return ecode;
1614 }
1615 
1616 jint G1CollectedHeap::initialize_young_gen_sampling_thread() {
1617   _young_gen_sampling_thread = new G1YoungRemSetSamplingThread();
1618   if (_young_gen_sampling_thread-&gt;osthread() == NULL) {
1619     vm_shutdown_during_initialization(&quot;Could not create G1YoungRemSetSamplingThread&quot;);
1620     return JNI_ENOMEM;
1621   }
1622   return JNI_OK;
1623 }
1624 
1625 jint G1CollectedHeap::initialize() {
1626   os::enable_vtime();
1627 
1628   // Necessary to satisfy locking discipline assertions.
1629 
1630   MutexLocker x(Heap_lock);
1631 
1632   // While there are no constraints in the GC code that HeapWordSize
1633   // be any particular value, there are multiple other areas in the
1634   // system which believe this to be true (e.g. oop-&gt;object_size in some
1635   // cases incorrectly returns the size in wordSize units rather than
1636   // HeapWordSize).
1637   guarantee(HeapWordSize == wordSize, &quot;HeapWordSize must equal wordSize&quot;);
1638 
1639   size_t init_byte_size = collector_policy()-&gt;initial_heap_byte_size();
1640   size_t max_byte_size = _collector_policy-&gt;heap_reserved_size_bytes();
1641   size_t heap_alignment = collector_policy()-&gt;heap_alignment();
1642 
1643   // Ensure that the sizes are properly aligned.
1644   Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1645   Universe::check_alignment(max_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1646   Universe::check_alignment(max_byte_size, heap_alignment, &quot;g1 heap&quot;);
1647 
1648   // Reserve the maximum.
1649 
1650   // When compressed oops are enabled, the preferred heap base
1651   // is calculated by subtracting the requested size from the
1652   // 32Gb boundary and using the result as the base address for
1653   // heap reservation. If the requested size is not aligned to
1654   // HeapRegion::GrainBytes (i.e. the alignment that is passed
1655   // into the ReservedHeapSpace constructor) then the actual
1656   // base of the reserved heap may end up differing from the
1657   // address that was requested (i.e. the preferred heap base).
1658   // If this happens then we could end up using a non-optimal
1659   // compressed oops mode.
1660 
1661   ReservedSpace heap_rs = Universe::reserve_heap(max_byte_size,
1662                                                  heap_alignment);
1663 
1664   initialize_reserved_region((HeapWord*)heap_rs.base(), (HeapWord*)(heap_rs.base() + heap_rs.size()));
1665 
1666   // Create the barrier set for the entire reserved region.
1667   G1CardTable* ct = new G1CardTable(reserved_region());
1668   ct-&gt;initialize();
1669   G1BarrierSet* bs = new G1BarrierSet(ct);
1670   bs-&gt;initialize();
1671   assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), &quot;sanity&quot;);
1672   BarrierSet::set_barrier_set(bs);
1673   _card_table = ct;
1674 
1675   G1BarrierSet::satb_mark_queue_set().initialize(this,
1676                                                  SATB_Q_CBL_mon,
1677                                                  &amp;bs-&gt;satb_mark_queue_buffer_allocator(),
1678                                                  G1SATBProcessCompletedThreshold,
1679                                                  G1SATBBufferEnqueueingThresholdPercent);
1680 
1681   // process_completed_buffers_threshold and max_completed_buffers are updated
1682   // later, based on the concurrent refinement object.
1683   G1BarrierSet::dirty_card_queue_set().initialize(DirtyCardQ_CBL_mon,
1684                                                   &amp;bs-&gt;dirty_card_queue_buffer_allocator(),
1685                                                   Shared_DirtyCardQ_lock,
1686                                                   true); // init_free_ids
1687 
1688   dirty_card_queue_set().initialize(DirtyCardQ_CBL_mon,
1689                                     &amp;bs-&gt;dirty_card_queue_buffer_allocator(),
1690                                     Shared_DirtyCardQ_lock);
1691 
1692   // Create the hot card cache.
1693   _hot_card_cache = new G1HotCardCache(this);
1694 
1695   // Carve out the G1 part of the heap.
1696   ReservedSpace g1_rs = heap_rs.first_part(max_byte_size);
1697   size_t page_size = actual_reserved_page_size(heap_rs);
1698   G1RegionToSpaceMapper* heap_storage =
1699     G1RegionToSpaceMapper::create_heap_mapper(g1_rs,
1700                                               g1_rs.size(),
1701                                               page_size,
1702                                               HeapRegion::GrainBytes,
1703                                               1,
1704                                               mtJavaHeap);
1705   if(heap_storage == NULL) {
1706     vm_shutdown_during_initialization(&quot;Could not initialize G1 heap&quot;);
1707     return JNI_ERR;
1708   }
1709 
1710   os::trace_page_sizes(&quot;Heap&quot;,
1711                        collector_policy()-&gt;min_heap_byte_size(),
1712                        max_byte_size,
1713                        page_size,
1714                        heap_rs.base(),
1715                        heap_rs.size());
1716   heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);
1717 
1718   // Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.
1719   G1RegionToSpaceMapper* bot_storage =
1720     create_aux_memory_mapper(&quot;Block Offset Table&quot;,
1721                              G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),
1722                              G1BlockOffsetTable::heap_map_factor());
1723 
1724   G1RegionToSpaceMapper* cardtable_storage =
1725     create_aux_memory_mapper(&quot;Card Table&quot;,
1726                              G1CardTable::compute_size(g1_rs.size() / HeapWordSize),
1727                              G1CardTable::heap_map_factor());
1728 
1729   G1RegionToSpaceMapper* card_counts_storage =
1730     create_aux_memory_mapper(&quot;Card Counts Table&quot;,
1731                              G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),
1732                              G1CardCounts::heap_map_factor());
1733 
1734   size_t bitmap_size = G1CMBitMap::compute_size(g1_rs.size());
1735   G1RegionToSpaceMapper* prev_bitmap_storage =
1736     create_aux_memory_mapper(&quot;Prev Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1737   G1RegionToSpaceMapper* next_bitmap_storage =
1738     create_aux_memory_mapper(&quot;Next Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1739 
1740   _hrm = HeapRegionManager::create_manager(this, _collector_policy);
1741 
1742   _hrm-&gt;initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);
1743   _card_table-&gt;initialize(cardtable_storage);
1744   // Do later initialization work for concurrent refinement.
1745   _hot_card_cache-&gt;initialize(card_counts_storage);
1746 
1747   // 6843694 - ensure that the maximum region index can fit
1748   // in the remembered set structures.
1749   const uint max_region_idx = (1U &lt;&lt; (sizeof(RegionIdx_t)*BitsPerByte-1)) - 1;
1750   guarantee((max_regions() - 1) &lt;= max_region_idx, &quot;too many regions&quot;);
1751 
1752   // The G1FromCardCache reserves card with value 0 as &quot;invalid&quot;, so the heap must not
1753   // start within the first card.
1754   guarantee(g1_rs.base() &gt;= (char*)G1CardTable::card_size, &quot;Java heap must not start within the first card.&quot;);
1755   // Also create a G1 rem set.
1756   _rem_set = new G1RemSet(this, _card_table, _hot_card_cache);
1757   _rem_set-&gt;initialize(max_reserved_capacity(), max_regions());
1758 
1759   size_t max_cards_per_region = ((size_t)1 &lt;&lt; (sizeof(CardIdx_t)*BitsPerByte-1)) - 1;
1760   guarantee(HeapRegion::CardsPerRegion &gt; 0, &quot;make sure it&#39;s initialized&quot;);
1761   guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,
1762             &quot;too many cards per region&quot;);
1763 
1764   FreeRegionList::set_unrealistically_long_length(max_expandable_regions() + 1);
1765 
1766   _bot = new G1BlockOffsetTable(reserved_region(), bot_storage);
1767 
1768   {
1769     HeapWord* start = _hrm-&gt;reserved().start();
1770     HeapWord* end = _hrm-&gt;reserved().end();
1771     size_t granularity = HeapRegion::GrainBytes;
1772 
1773     _in_cset_fast_test.initialize(start, end, granularity);
1774     _humongous_reclaim_candidates.initialize(start, end, granularity);
1775   }
1776 
1777   _workers = new WorkGang(&quot;GC Thread&quot;, ParallelGCThreads,
1778                           true /* are_GC_task_threads */,
1779                           false /* are_ConcurrentGC_threads */);
1780   if (_workers == NULL) {
1781     return JNI_ENOMEM;
1782   }
1783   _workers-&gt;initialize_workers();
1784 
1785   // Create the G1ConcurrentMark data structure and thread.
1786   // (Must do this late, so that &quot;max_regions&quot; is defined.)
1787   _cm = new G1ConcurrentMark(this, prev_bitmap_storage, next_bitmap_storage);
1788   if (_cm == NULL || !_cm-&gt;completed_initialization()) {
1789     vm_shutdown_during_initialization(&quot;Could not create/initialize G1ConcurrentMark&quot;);
1790     return JNI_ENOMEM;
1791   }
1792   _cm_thread = _cm-&gt;cm_thread();
1793 
1794   // Now expand into the initial heap size.
1795   if (!expand(init_byte_size, _workers)) {
1796     vm_shutdown_during_initialization(&quot;Failed to allocate initial heap.&quot;);
1797     return JNI_ENOMEM;
1798   }
1799 
1800   // Perform any initialization actions delegated to the policy.
1801   policy()-&gt;init(this, &amp;_collection_set);
1802 
1803   jint ecode = initialize_concurrent_refinement();
1804   if (ecode != JNI_OK) {
1805     return ecode;
1806   }
1807 
1808   ecode = initialize_young_gen_sampling_thread();
1809   if (ecode != JNI_OK) {
1810     return ecode;
1811   }
1812 
1813   {
1814     G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1815     dcqs.set_process_completed_buffers_threshold(concurrent_refine()-&gt;yellow_zone());
1816     dcqs.set_max_completed_buffers(concurrent_refine()-&gt;red_zone());
1817   }
1818 
1819   // Here we allocate the dummy HeapRegion that is required by the
1820   // G1AllocRegion class.
1821   HeapRegion* dummy_region = _hrm-&gt;get_dummy_region();
1822 
1823   // We&#39;ll re-use the same region whether the alloc region will
1824   // require BOT updates or not and, if it doesn&#39;t, then a non-young
1825   // region will complain that it cannot support allocations without
1826   // BOT updates. So we&#39;ll tag the dummy region as eden to avoid that.
1827   dummy_region-&gt;set_eden();
1828   // Make sure it&#39;s full.
1829   dummy_region-&gt;set_top(dummy_region-&gt;end());
1830   G1AllocRegion::setup(this, dummy_region);
1831 
1832   _allocator-&gt;init_mutator_alloc_region();
1833 
1834   // Do create of the monitoring and management support so that
1835   // values in the heap have been properly initialized.
1836   _g1mm = new G1MonitoringSupport(this);
1837 
1838   G1StringDedup::initialize();
1839 
1840   _preserved_marks_set.init(ParallelGCThreads);
1841 
1842   _collection_set.initialize(max_regions());
1843 
1844   return JNI_OK;
1845 }
1846 
1847 void G1CollectedHeap::stop() {
1848   // Stop all concurrent threads. We do this to make sure these threads
1849   // do not continue to execute and access resources (e.g. logging)
1850   // that are destroyed during shutdown.
1851   _cr-&gt;stop();
1852   _young_gen_sampling_thread-&gt;stop();
1853   _cm_thread-&gt;stop();
1854   if (G1StringDedup::is_enabled()) {
1855     G1StringDedup::stop();
1856   }
1857 }
1858 
1859 void G1CollectedHeap::safepoint_synchronize_begin() {
1860   SuspendibleThreadSet::synchronize();
1861 }
1862 
1863 void G1CollectedHeap::safepoint_synchronize_end() {
1864   SuspendibleThreadSet::desynchronize();
1865 }
1866 
1867 size_t G1CollectedHeap::conservative_max_heap_alignment() {
1868   return HeapRegion::max_region_size();
1869 }
1870 
1871 void G1CollectedHeap::post_initialize() {
1872   CollectedHeap::post_initialize();
1873   ref_processing_init();
1874 }
1875 
1876 void G1CollectedHeap::ref_processing_init() {
1877   // Reference processing in G1 currently works as follows:
1878   //
1879   // * There are two reference processor instances. One is
1880   //   used to record and process discovered references
1881   //   during concurrent marking; the other is used to
1882   //   record and process references during STW pauses
1883   //   (both full and incremental).
1884   // * Both ref processors need to &#39;span&#39; the entire heap as
1885   //   the regions in the collection set may be dotted around.
1886   //
1887   // * For the concurrent marking ref processor:
1888   //   * Reference discovery is enabled at initial marking.
1889   //   * Reference discovery is disabled and the discovered
1890   //     references processed etc during remarking.
1891   //   * Reference discovery is MT (see below).
1892   //   * Reference discovery requires a barrier (see below).
1893   //   * Reference processing may or may not be MT
1894   //     (depending on the value of ParallelRefProcEnabled
1895   //     and ParallelGCThreads).
1896   //   * A full GC disables reference discovery by the CM
1897   //     ref processor and abandons any entries on it&#39;s
1898   //     discovered lists.
1899   //
1900   // * For the STW processor:
1901   //   * Non MT discovery is enabled at the start of a full GC.
1902   //   * Processing and enqueueing during a full GC is non-MT.
1903   //   * During a full GC, references are processed after marking.
1904   //
1905   //   * Discovery (may or may not be MT) is enabled at the start
1906   //     of an incremental evacuation pause.
1907   //   * References are processed near the end of a STW evacuation pause.
1908   //   * For both types of GC:
1909   //     * Discovery is atomic - i.e. not concurrent.
1910   //     * Reference discovery will not need a barrier.
1911 
1912   bool mt_processing = ParallelRefProcEnabled &amp;&amp; (ParallelGCThreads &gt; 1);
1913 
1914   // Concurrent Mark ref processor
1915   _ref_processor_cm =
1916     new ReferenceProcessor(&amp;_is_subject_to_discovery_cm,
1917                            mt_processing,                                  // mt processing
1918                            ParallelGCThreads,                              // degree of mt processing
1919                            (ParallelGCThreads &gt; 1) || (ConcGCThreads &gt; 1), // mt discovery
1920                            MAX2(ParallelGCThreads, ConcGCThreads),         // degree of mt discovery
1921                            false,                                          // Reference discovery is not atomic
1922                            &amp;_is_alive_closure_cm,                          // is alive closure
1923                            true);                                          // allow changes to number of processing threads
1924 
1925   // STW ref processor
1926   _ref_processor_stw =
1927     new ReferenceProcessor(&amp;_is_subject_to_discovery_stw,
1928                            mt_processing,                        // mt processing
1929                            ParallelGCThreads,                    // degree of mt processing
1930                            (ParallelGCThreads &gt; 1),              // mt discovery
1931                            ParallelGCThreads,                    // degree of mt discovery
1932                            true,                                 // Reference discovery is atomic
1933                            &amp;_is_alive_closure_stw,               // is alive closure
1934                            true);                                // allow changes to number of processing threads
1935 }
1936 
1937 CollectorPolicy* G1CollectedHeap::collector_policy() const {
1938   return _collector_policy;
1939 }
1940 
1941 SoftRefPolicy* G1CollectedHeap::soft_ref_policy() {
1942   return &amp;_soft_ref_policy;
1943 }
1944 
1945 size_t G1CollectedHeap::capacity() const {
1946   return _hrm-&gt;length() * HeapRegion::GrainBytes;
1947 }
1948 
1949 size_t G1CollectedHeap::unused_committed_regions_in_bytes() const {
1950   return _hrm-&gt;total_free_bytes();
1951 }
1952 
1953 void G1CollectedHeap::iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_i) {
1954   _hot_card_cache-&gt;drain(cl, worker_i);
1955 }
1956 
1957 void G1CollectedHeap::iterate_dirty_card_closure(G1CardTableEntryClosure* cl, uint worker_i) {
1958   G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1959   size_t n_completed_buffers = 0;
1960   while (dcqs.apply_closure_during_gc(cl, worker_i)) {
1961     n_completed_buffers++;
1962   }
1963   assert(dcqs.completed_buffers_num() == 0, &quot;Completed buffers exist!&quot;);
1964   phase_times()-&gt;record_thread_work_item(G1GCPhaseTimes::UpdateRS, worker_i, n_completed_buffers, G1GCPhaseTimes::UpdateRSProcessedBuffers);
1965 }
1966 
1967 // Computes the sum of the storage used by the various regions.
1968 size_t G1CollectedHeap::used() const {
1969   size_t result = _summary_bytes_used + _allocator-&gt;used_in_alloc_regions();
1970   if (_archive_allocator != NULL) {
1971     result += _archive_allocator-&gt;used();
1972   }
1973   return result;
1974 }
1975 
1976 size_t G1CollectedHeap::used_unlocked() const {
1977   return _summary_bytes_used;
1978 }
1979 
1980 class SumUsedClosure: public HeapRegionClosure {
1981   size_t _used;
1982 public:
1983   SumUsedClosure() : _used(0) {}
1984   bool do_heap_region(HeapRegion* r) {
1985     _used += r-&gt;used();
1986     return false;
1987   }
1988   size_t result() { return _used; }
1989 };
1990 
1991 size_t G1CollectedHeap::recalculate_used() const {
1992   SumUsedClosure blk;
1993   heap_region_iterate(&amp;blk);
1994   return blk.result();
1995 }
1996 
1997 bool  G1CollectedHeap::is_user_requested_concurrent_full_gc(GCCause::Cause cause) {
1998   switch (cause) {
1999     case GCCause::_java_lang_system_gc:                 return ExplicitGCInvokesConcurrent;
2000     case GCCause::_dcmd_gc_run:                         return ExplicitGCInvokesConcurrent;
2001     case GCCause::_wb_conc_mark:                        return true;
2002     default :                                           return false;
2003   }
2004 }
2005 
2006 bool G1CollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
2007   switch (cause) {
2008     case GCCause::_gc_locker:               return GCLockerInvokesConcurrent;
2009     case GCCause::_g1_humongous_allocation: return true;
2010     case GCCause::_g1_periodic_collection:  return G1PeriodicGCInvokesConcurrent;
2011     default:                                return is_user_requested_concurrent_full_gc(cause);
2012   }
2013 }
2014 
2015 bool G1CollectedHeap::should_upgrade_to_full_gc(GCCause::Cause cause) {
2016   if(policy()-&gt;force_upgrade_to_full()) {
2017     return true;
2018   } else if (should_do_concurrent_full_gc(_gc_cause)) {
2019     return false;
2020   } else if (has_regions_left_for_allocation()) {
2021     return false;
2022   } else {
2023     return true;
2024   }
2025 }
2026 
2027 #ifndef PRODUCT
2028 void G1CollectedHeap::allocate_dummy_regions() {
2029   // Let&#39;s fill up most of the region
2030   size_t word_size = HeapRegion::GrainWords - 1024;
2031   // And as a result the region we&#39;ll allocate will be humongous.
2032   guarantee(is_humongous(word_size), &quot;sanity&quot;);
2033 
2034   // _filler_array_max_size is set to humongous object threshold
2035   // but temporarily change it to use CollectedHeap::fill_with_object().
2036   SizeTFlagSetting fs(_filler_array_max_size, word_size);
2037 
2038   for (uintx i = 0; i &lt; G1DummyRegionsPerGC; ++i) {
2039     // Let&#39;s use the existing mechanism for the allocation
2040     HeapWord* dummy_obj = humongous_obj_allocate(word_size);
2041     if (dummy_obj != NULL) {
2042       MemRegion mr(dummy_obj, word_size);
2043       CollectedHeap::fill_with_object(mr);
2044     } else {
2045       // If we can&#39;t allocate once, we probably cannot allocate
2046       // again. Let&#39;s get out of the loop.
2047       break;
2048     }
2049   }
2050 }
2051 #endif // !PRODUCT
2052 
2053 void G1CollectedHeap::increment_old_marking_cycles_started() {
2054   assert(_old_marking_cycles_started == _old_marking_cycles_completed ||
2055          _old_marking_cycles_started == _old_marking_cycles_completed + 1,
2056          &quot;Wrong marking cycle count (started: %d, completed: %d)&quot;,
2057          _old_marking_cycles_started, _old_marking_cycles_completed);
2058 
2059   _old_marking_cycles_started++;
2060 }
2061 
2062 void G1CollectedHeap::increment_old_marking_cycles_completed(bool concurrent) {
2063   MonitorLockerEx x(FullGCCount_lock, Mutex::_no_safepoint_check_flag);
2064 
2065   // We assume that if concurrent == true, then the caller is a
2066   // concurrent thread that was joined the Suspendible Thread
2067   // Set. If there&#39;s ever a cheap way to check this, we should add an
2068   // assert here.
2069 
2070   // Given that this method is called at the end of a Full GC or of a
2071   // concurrent cycle, and those can be nested (i.e., a Full GC can
2072   // interrupt a concurrent cycle), the number of full collections
2073   // completed should be either one (in the case where there was no
2074   // nesting) or two (when a Full GC interrupted a concurrent cycle)
2075   // behind the number of full collections started.
2076 
2077   // This is the case for the inner caller, i.e. a Full GC.
2078   assert(concurrent ||
2079          (_old_marking_cycles_started == _old_marking_cycles_completed + 1) ||
2080          (_old_marking_cycles_started == _old_marking_cycles_completed + 2),
2081          &quot;for inner caller (Full GC): _old_marking_cycles_started = %u &quot;
2082          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2083          _old_marking_cycles_started, _old_marking_cycles_completed);
2084 
2085   // This is the case for the outer caller, i.e. the concurrent cycle.
2086   assert(!concurrent ||
2087          (_old_marking_cycles_started == _old_marking_cycles_completed + 1),
2088          &quot;for outer caller (concurrent cycle): &quot;
2089          &quot;_old_marking_cycles_started = %u &quot;
2090          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2091          _old_marking_cycles_started, _old_marking_cycles_completed);
2092 
2093   _old_marking_cycles_completed += 1;
2094 
2095   // We need to clear the &quot;in_progress&quot; flag in the CM thread before
2096   // we wake up any waiters (especially when ExplicitInvokesConcurrent
2097   // is set) so that if a waiter requests another System.gc() it doesn&#39;t
2098   // incorrectly see that a marking cycle is still in progress.
2099   if (concurrent) {
2100     _cm_thread-&gt;set_idle();
2101   }
2102 
2103   // This notify_all() will ensure that a thread that called
2104   // System.gc() with (with ExplicitGCInvokesConcurrent set or not)
2105   // and it&#39;s waiting for a full GC to finish will be woken up. It is
2106   // waiting in VM_G1CollectForAllocation::doit_epilogue().
2107   FullGCCount_lock-&gt;notify_all();
2108 }
2109 
2110 void G1CollectedHeap::collect(GCCause::Cause cause) {
2111   try_collect(cause, true);
2112 }
2113 
2114 bool G1CollectedHeap::try_collect(GCCause::Cause cause, bool retry_on_gc_failure) {
2115   assert_heap_not_locked();
2116 
2117   bool gc_succeeded;
2118   bool should_retry_gc;
2119 
2120   do {
2121     should_retry_gc = false;
2122 
2123     uint gc_count_before;
2124     uint old_marking_count_before;
2125     uint full_gc_count_before;
2126 
2127     {
2128       MutexLocker ml(Heap_lock);
2129 
2130       // Read the GC count while holding the Heap_lock
2131       gc_count_before = total_collections();
2132       full_gc_count_before = total_full_collections();
2133       old_marking_count_before = _old_marking_cycles_started;
2134     }
2135 
2136     if (should_do_concurrent_full_gc(cause)) {
2137       // Schedule an initial-mark evacuation pause that will start a
2138       // concurrent cycle. We&#39;re setting word_size to 0 which means that
2139       // we are not requesting a post-GC allocation.
2140       VM_G1CollectForAllocation op(0,     /* word_size */
2141                                    gc_count_before,
2142                                    cause,
2143                                    true,  /* should_initiate_conc_mark */
2144                                    policy()-&gt;max_pause_time_ms());
2145       VMThread::execute(&amp;op);
2146       gc_succeeded = op.gc_succeeded();
2147       if (!gc_succeeded &amp;&amp; retry_on_gc_failure) {
2148         if (old_marking_count_before == _old_marking_cycles_started) {
2149           should_retry_gc = op.should_retry_gc();
2150         } else {
2151           // A Full GC happened while we were trying to schedule the
2152           // concurrent cycle. No point in starting a new cycle given
2153           // that the whole heap was collected anyway.
2154         }
2155 
2156         if (should_retry_gc &amp;&amp; GCLocker::is_active_and_needs_gc()) {
2157           GCLocker::stall_until_clear();
2158         }
2159       }
2160     } else {
2161       if (cause == GCCause::_gc_locker || cause == GCCause::_wb_young_gc
2162           DEBUG_ONLY(|| cause == GCCause::_scavenge_alot)) {
2163 
2164         // Schedule a standard evacuation pause. We&#39;re setting word_size
2165         // to 0 which means that we are not requesting a post-GC allocation.
2166         VM_G1CollectForAllocation op(0,     /* word_size */
2167                                      gc_count_before,
2168                                      cause,
2169                                      false, /* should_initiate_conc_mark */
2170                                      policy()-&gt;max_pause_time_ms());
2171         VMThread::execute(&amp;op);
2172         gc_succeeded = op.gc_succeeded();
2173       } else {
2174         // Schedule a Full GC.
2175         VM_G1CollectFull op(gc_count_before, full_gc_count_before, cause);
2176         VMThread::execute(&amp;op);
2177         gc_succeeded = op.gc_succeeded();
2178       }
2179     }
2180   } while (should_retry_gc);
2181   return gc_succeeded;
2182 }
2183 
2184 bool G1CollectedHeap::is_in(const void* p) const {
2185   if (_hrm-&gt;reserved().contains(p)) {
2186     // Given that we know that p is in the reserved space,
2187     // heap_region_containing() should successfully
2188     // return the containing region.
2189     HeapRegion* hr = heap_region_containing(p);
2190     return hr-&gt;is_in(p);
2191   } else {
2192     return false;
2193   }
2194 }
2195 
2196 #ifdef ASSERT
2197 bool G1CollectedHeap::is_in_exact(const void* p) const {
2198   bool contains = reserved_region().contains(p);
2199   bool available = _hrm-&gt;is_available(addr_to_region((HeapWord*)p));
2200   if (contains &amp;&amp; available) {
2201     return true;
2202   } else {
2203     return false;
2204   }
2205 }
2206 #endif
2207 
2208 // Iteration functions.
2209 
2210 // Iterates an ObjectClosure over all objects within a HeapRegion.
2211 
2212 class IterateObjectClosureRegionClosure: public HeapRegionClosure {
2213   ObjectClosure* _cl;
2214 public:
2215   IterateObjectClosureRegionClosure(ObjectClosure* cl) : _cl(cl) {}
2216   bool do_heap_region(HeapRegion* r) {
2217     if (!r-&gt;is_continues_humongous()) {
2218       r-&gt;object_iterate(_cl);
2219     }
2220     return false;
2221   }
2222 };
2223 
2224 void G1CollectedHeap::object_iterate(ObjectClosure* cl) {
2225   IterateObjectClosureRegionClosure blk(cl);
2226   heap_region_iterate(&amp;blk);
2227 }
2228 
2229 void G1CollectedHeap::heap_region_iterate(HeapRegionClosure* cl) const {
2230   _hrm-&gt;iterate(cl);
2231 }
2232 
2233 void G1CollectedHeap::heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
2234                                                                  HeapRegionClaimer *hrclaimer,
2235                                                                  uint worker_id) const {
2236   _hrm-&gt;par_iterate(cl, hrclaimer, hrclaimer-&gt;offset_for_worker(worker_id));
2237 }
2238 
2239 void G1CollectedHeap::heap_region_par_iterate_from_start(HeapRegionClosure* cl,
2240                                                          HeapRegionClaimer *hrclaimer) const {
2241   _hrm-&gt;par_iterate(cl, hrclaimer, 0);
2242 }
2243 
2244 void G1CollectedHeap::collection_set_iterate(HeapRegionClosure* cl) {
2245   _collection_set.iterate(cl);
2246 }
2247 
2248 void G1CollectedHeap::collection_set_iterate_from(HeapRegionClosure *cl, uint worker_id) {
2249   _collection_set.iterate_from(cl, worker_id, workers()-&gt;active_workers());
2250 }
2251 
2252 HeapWord* G1CollectedHeap::block_start(const void* addr) const {
2253   HeapRegion* hr = heap_region_containing(addr);
2254   return hr-&gt;block_start(addr);
2255 }
2256 
2257 bool G1CollectedHeap::block_is_obj(const HeapWord* addr) const {
2258   HeapRegion* hr = heap_region_containing(addr);
2259   return hr-&gt;block_is_obj(addr);
2260 }
2261 
2262 bool G1CollectedHeap::supports_tlab_allocation() const {
2263   return true;
2264 }
2265 
2266 size_t G1CollectedHeap::tlab_capacity(Thread* ignored) const {
2267   return (_policy-&gt;young_list_target_length() - _survivor.length()) * HeapRegion::GrainBytes;
2268 }
2269 
2270 size_t G1CollectedHeap::tlab_used(Thread* ignored) const {
2271   return _eden.length() * HeapRegion::GrainBytes;
2272 }
2273 
2274 // For G1 TLABs should not contain humongous objects, so the maximum TLAB size
2275 // must be equal to the humongous object limit.
2276 size_t G1CollectedHeap::max_tlab_size() const {
2277   return align_down(_humongous_object_threshold_in_words, MinObjAlignment);
2278 }
2279 
2280 size_t G1CollectedHeap::unsafe_max_tlab_alloc(Thread* ignored) const {
2281   return _allocator-&gt;unsafe_max_tlab_alloc();
2282 }
2283 
2284 size_t G1CollectedHeap::max_capacity() const {
2285   return _hrm-&gt;max_expandable_length() * HeapRegion::GrainBytes;
2286 }
2287 
2288 size_t G1CollectedHeap::max_reserved_capacity() const {
2289   return _hrm-&gt;max_length() * HeapRegion::GrainBytes;
2290 }
2291 
2292 jlong G1CollectedHeap::millis_since_last_gc() {
2293   // See the notes in GenCollectedHeap::millis_since_last_gc()
2294   // for more information about the implementation.
2295   jlong ret_val = (os::javaTimeNanos() / NANOSECS_PER_MILLISEC) -
2296                   _policy-&gt;collection_pause_end_millis();
2297   if (ret_val &lt; 0) {
2298     log_warning(gc)(&quot;millis_since_last_gc() would return : &quot; JLONG_FORMAT
2299       &quot;. returning zero instead.&quot;, ret_val);
2300     return 0;
2301   }
2302   return ret_val;
2303 }
2304 
2305 void G1CollectedHeap::deduplicate_string(oop str) {
2306   assert(java_lang_String::is_instance(str), &quot;invariant&quot;);
2307 
2308   if (G1StringDedup::is_enabled()) {
2309     G1StringDedup::deduplicate(str);
2310   }
2311 }
2312 
2313 void G1CollectedHeap::prepare_for_verify() {
2314   _verifier-&gt;prepare_for_verify();
2315 }
2316 
2317 void G1CollectedHeap::verify(VerifyOption vo) {
2318   _verifier-&gt;verify(vo);
2319 }
2320 
2321 bool G1CollectedHeap::supports_concurrent_phase_control() const {
2322   return true;
2323 }
2324 
2325 bool G1CollectedHeap::request_concurrent_phase(const char* phase) {
2326   return _cm_thread-&gt;request_concurrent_phase(phase);
2327 }
2328 
2329 bool G1CollectedHeap::is_heterogeneous_heap() const {
2330   return _collector_policy-&gt;is_heterogeneous_heap();
2331 }
2332 
2333 class PrintRegionClosure: public HeapRegionClosure {
2334   outputStream* _st;
2335 public:
2336   PrintRegionClosure(outputStream* st) : _st(st) {}
2337   bool do_heap_region(HeapRegion* r) {
2338     r-&gt;print_on(_st);
2339     return false;
2340   }
2341 };
2342 
2343 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2344                                        const HeapRegion* hr,
2345                                        const VerifyOption vo) const {
2346   switch (vo) {
2347   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj, hr);
2348   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj, hr);
2349   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj, hr);
2350   default:                            ShouldNotReachHere();
2351   }
2352   return false; // keep some compilers happy
2353 }
2354 
2355 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2356                                        const VerifyOption vo) const {
2357   switch (vo) {
2358   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj);
2359   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj);
2360   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj);
2361   default:                            ShouldNotReachHere();
2362   }
2363   return false; // keep some compilers happy
2364 }
2365 
2366 void G1CollectedHeap::print_heap_regions() const {
2367   LogTarget(Trace, gc, heap, region) lt;
2368   if (lt.is_enabled()) {
2369     LogStream ls(lt);
2370     print_regions_on(&amp;ls);
2371   }
2372 }
2373 
2374 void G1CollectedHeap::print_on(outputStream* st) const {
2375   st-&gt;print(&quot; %-20s&quot;, &quot;garbage-first heap&quot;);
2376   st-&gt;print(&quot; total &quot; SIZE_FORMAT &quot;K, used &quot; SIZE_FORMAT &quot;K&quot;,
2377             capacity()/K, used_unlocked()/K);
2378   st-&gt;print(&quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;)&quot;,
2379             p2i(_hrm-&gt;reserved().start()),
2380             p2i(_hrm-&gt;reserved().end()));
2381   st-&gt;cr();
2382   st-&gt;print(&quot;  region size &quot; SIZE_FORMAT &quot;K, &quot;, HeapRegion::GrainBytes / K);
2383   uint young_regions = young_regions_count();
2384   st-&gt;print(&quot;%u young (&quot; SIZE_FORMAT &quot;K), &quot;, young_regions,
2385             (size_t) young_regions * HeapRegion::GrainBytes / K);
2386   uint survivor_regions = survivor_regions_count();
2387   st-&gt;print(&quot;%u survivors (&quot; SIZE_FORMAT &quot;K)&quot;, survivor_regions,
2388             (size_t) survivor_regions * HeapRegion::GrainBytes / K);
2389   st-&gt;cr();
2390   MetaspaceUtils::print_on(st);
2391 }
2392 
2393 void G1CollectedHeap::print_regions_on(outputStream* st) const {
2394   st-&gt;print_cr(&quot;Heap Regions: E=young(eden), S=young(survivor), O=old, &quot;
2395                &quot;HS=humongous(starts), HC=humongous(continues), &quot;
2396                &quot;CS=collection set, F=free, A=archive, &quot;
2397                &quot;TAMS=top-at-mark-start (previous, next)&quot;);
2398   PrintRegionClosure blk(st);
2399   heap_region_iterate(&amp;blk);
2400 }
2401 
2402 void G1CollectedHeap::print_extended_on(outputStream* st) const {
2403   print_on(st);
2404 
2405   // Print the per-region information.
2406   print_regions_on(st);
2407 }
2408 
2409 void G1CollectedHeap::print_on_error(outputStream* st) const {
2410   this-&gt;CollectedHeap::print_on_error(st);
2411 
2412   if (_cm != NULL) {
2413     st-&gt;cr();
2414     _cm-&gt;print_on_error(st);
2415   }
2416 }
2417 
2418 void G1CollectedHeap::print_gc_threads_on(outputStream* st) const {
2419   workers()-&gt;print_worker_threads_on(st);
2420   _cm_thread-&gt;print_on(st);
2421   st-&gt;cr();
2422   _cm-&gt;print_worker_threads_on(st);
2423   _cr-&gt;print_threads_on(st);
2424   _young_gen_sampling_thread-&gt;print_on(st);
2425   if (G1StringDedup::is_enabled()) {
2426     G1StringDedup::print_worker_threads_on(st);
2427   }
2428 }
2429 
2430 void G1CollectedHeap::gc_threads_do(ThreadClosure* tc) const {
2431   workers()-&gt;threads_do(tc);
2432   tc-&gt;do_thread(_cm_thread);
2433   _cm-&gt;threads_do(tc);
2434   _cr-&gt;threads_do(tc);
2435   tc-&gt;do_thread(_young_gen_sampling_thread);
2436   if (G1StringDedup::is_enabled()) {
2437     G1StringDedup::threads_do(tc);
2438   }
2439 }
2440 
2441 void G1CollectedHeap::print_tracing_info() const {
2442   rem_set()-&gt;print_summary_info();
2443   concurrent_mark()-&gt;print_summary_info();
2444 }
2445 
2446 #ifndef PRODUCT
2447 // Helpful for debugging RSet issues.
2448 
2449 class PrintRSetsClosure : public HeapRegionClosure {
2450 private:
2451   const char* _msg;
2452   size_t _occupied_sum;
2453 
2454 public:
2455   bool do_heap_region(HeapRegion* r) {
2456     HeapRegionRemSet* hrrs = r-&gt;rem_set();
2457     size_t occupied = hrrs-&gt;occupied();
2458     _occupied_sum += occupied;
2459 
2460     tty-&gt;print_cr(&quot;Printing RSet for region &quot; HR_FORMAT, HR_FORMAT_PARAMS(r));
2461     if (occupied == 0) {
2462       tty-&gt;print_cr(&quot;  RSet is empty&quot;);
2463     } else {
2464       hrrs-&gt;print();
2465     }
2466     tty-&gt;print_cr(&quot;----------&quot;);
2467     return false;
2468   }
2469 
2470   PrintRSetsClosure(const char* msg) : _msg(msg), _occupied_sum(0) {
2471     tty-&gt;cr();
2472     tty-&gt;print_cr(&quot;========================================&quot;);
2473     tty-&gt;print_cr(&quot;%s&quot;, msg);
2474     tty-&gt;cr();
2475   }
2476 
2477   ~PrintRSetsClosure() {
2478     tty-&gt;print_cr(&quot;Occupied Sum: &quot; SIZE_FORMAT, _occupied_sum);
2479     tty-&gt;print_cr(&quot;========================================&quot;);
2480     tty-&gt;cr();
2481   }
2482 };
2483 
2484 void G1CollectedHeap::print_cset_rsets() {
2485   PrintRSetsClosure cl(&quot;Printing CSet RSets&quot;);
2486   collection_set_iterate(&amp;cl);
2487 }
2488 
2489 void G1CollectedHeap::print_all_rsets() {
2490   PrintRSetsClosure cl(&quot;Printing All RSets&quot;);;
2491   heap_region_iterate(&amp;cl);
2492 }
2493 #endif // PRODUCT
2494 
2495 G1HeapSummary G1CollectedHeap::create_g1_heap_summary() {
2496 
2497   size_t eden_used_bytes = heap()-&gt;eden_regions_count() * HeapRegion::GrainBytes;
2498   size_t survivor_used_bytes = heap()-&gt;survivor_regions_count() * HeapRegion::GrainBytes;
2499   size_t heap_used = Heap_lock-&gt;owned_by_self() ? used() : used_unlocked();
2500 
2501   size_t eden_capacity_bytes =
2502     (policy()-&gt;young_list_target_length() * HeapRegion::GrainBytes) - survivor_used_bytes;
2503 
2504   VirtualSpaceSummary heap_summary = create_heap_space_summary();
2505   return G1HeapSummary(heap_summary, heap_used, eden_used_bytes,
2506                        eden_capacity_bytes, survivor_used_bytes, num_regions());
2507 }
2508 
2509 G1EvacSummary G1CollectedHeap::create_g1_evac_summary(G1EvacStats* stats) {
2510   return G1EvacSummary(stats-&gt;allocated(), stats-&gt;wasted(), stats-&gt;undo_wasted(),
2511                        stats-&gt;unused(), stats-&gt;used(), stats-&gt;region_end_waste(),
2512                        stats-&gt;regions_filled(), stats-&gt;direct_allocated(),
2513                        stats-&gt;failure_used(), stats-&gt;failure_waste());
2514 }
2515 
2516 void G1CollectedHeap::trace_heap(GCWhen::Type when, const GCTracer* gc_tracer) {
2517   const G1HeapSummary&amp; heap_summary = create_g1_heap_summary();
2518   gc_tracer-&gt;report_gc_heap_summary(when, heap_summary);
2519 
2520   const MetaspaceSummary&amp; metaspace_summary = create_metaspace_summary();
2521   gc_tracer-&gt;report_metaspace_summary(when, metaspace_summary);
2522 }
2523 
2524 G1CollectedHeap* G1CollectedHeap::heap() {
2525   CollectedHeap* heap = Universe::heap();
2526   assert(heap != NULL, &quot;Uninitialized access to G1CollectedHeap::heap()&quot;);
2527   assert(heap-&gt;kind() == CollectedHeap::G1, &quot;Invalid name&quot;);
2528   return (G1CollectedHeap*)heap;
2529 }
2530 
2531 void G1CollectedHeap::gc_prologue(bool full) {
2532   // always_do_update_barrier = false;
2533   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
2534 
2535   // This summary needs to be printed before incrementing total collections.
2536   rem_set()-&gt;print_periodic_summary_info(&quot;Before GC RS summary&quot;, total_collections());
2537 
2538   // Update common counters.
2539   increment_total_collections(full /* full gc */);
2540   if (full) {
2541     increment_old_marking_cycles_started();
2542   }
2543 
2544   // Fill TLAB&#39;s and such
2545   double start = os::elapsedTime();
2546   ensure_parsability(true);
2547   phase_times()-&gt;record_prepare_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2548 }
2549 
2550 void G1CollectedHeap::gc_epilogue(bool full) {
2551   // Update common counters.
2552   if (full) {
2553     // Update the number of full collections that have been completed.
2554     increment_old_marking_cycles_completed(false /* concurrent */);
2555   }
2556 
2557   // We are at the end of the GC. Total collections has already been increased.
2558   rem_set()-&gt;print_periodic_summary_info(&quot;After GC RS summary&quot;, total_collections() - 1);
2559 
2560   // FIXME: what is this about?
2561   // I&#39;m ignoring the &quot;fill_newgen()&quot; call if &quot;alloc_event_enabled&quot;
2562   // is set.
2563 #if COMPILER2_OR_JVMCI
2564   assert(DerivedPointerTable::is_empty(), &quot;derived pointer present&quot;);
2565 #endif
2566   // always_do_update_barrier = true;
2567 
2568   double start = os::elapsedTime();
2569   resize_all_tlabs();
2570   phase_times()-&gt;record_resize_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2571 
2572   MemoryService::track_memory_usage();
2573   // We have just completed a GC. Update the soft reference
2574   // policy with the new heap occupancy
2575   Universe::update_heap_info_at_gc();
2576 }
2577 
2578 HeapWord* G1CollectedHeap::do_collection_pause(size_t word_size,
2579                                                uint gc_count_before,
2580                                                bool* succeeded,
2581                                                GCCause::Cause gc_cause) {
2582   assert_heap_not_locked_and_not_at_safepoint();
2583   VM_G1CollectForAllocation op(word_size,
2584                                gc_count_before,
2585                                gc_cause,
2586                                false, /* should_initiate_conc_mark */
2587                                policy()-&gt;max_pause_time_ms());
2588   VMThread::execute(&amp;op);
2589 
2590   HeapWord* result = op.result();
2591   bool ret_succeeded = op.prologue_succeeded() &amp;&amp; op.gc_succeeded();
2592   assert(result == NULL || ret_succeeded,
2593          &quot;the result should be NULL if the VM did not succeed&quot;);
2594   *succeeded = ret_succeeded;
2595 
2596   assert_heap_not_locked();
2597   return result;
2598 }
2599 
2600 void G1CollectedHeap::do_concurrent_mark() {
2601   MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);
2602   if (!_cm_thread-&gt;in_progress()) {
2603     _cm_thread-&gt;set_started();
2604     CGC_lock-&gt;notify();
2605   }
2606 }
2607 
2608 size_t G1CollectedHeap::pending_card_num() {
2609   struct CountCardsClosure : public ThreadClosure {
2610     size_t _cards;
2611     CountCardsClosure() : _cards(0) {}
2612     virtual void do_thread(Thread* t) {
2613       _cards += G1ThreadLocalData::dirty_card_queue(t).size();
2614     }
2615   } count_from_threads;
2616   Threads::threads_do(&amp;count_from_threads);
2617 
2618   G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
2619   size_t buffer_size = dcqs.buffer_size();
2620   size_t buffer_num = dcqs.completed_buffers_num();
2621 
2622   return buffer_size * buffer_num + count_from_threads._cards;
2623 }
2624 
2625 bool G1CollectedHeap::is_potential_eager_reclaim_candidate(HeapRegion* r) const {
2626   // We don&#39;t nominate objects with many remembered set entries, on
2627   // the assumption that such objects are likely still live.
2628   HeapRegionRemSet* rem_set = r-&gt;rem_set();
2629 
2630   return G1EagerReclaimHumongousObjectsWithStaleRefs ?
2631          rem_set-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries) :
2632          G1EagerReclaimHumongousObjects &amp;&amp; rem_set-&gt;is_empty();
2633 }
2634 
2635 class RegisterHumongousWithInCSetFastTestClosure : public HeapRegionClosure {
2636  private:
2637   size_t _total_humongous;
2638   size_t _candidate_humongous;
2639 
2640   G1DirtyCardQueue _dcq;
2641 
2642   bool humongous_region_is_candidate(G1CollectedHeap* g1h, HeapRegion* region) const {
2643     assert(region-&gt;is_starts_humongous(), &quot;Must start a humongous object&quot;);
2644 
2645     oop obj = oop(region-&gt;bottom());
2646 
2647     // Dead objects cannot be eager reclaim candidates. Due to class
2648     // unloading it is unsafe to query their classes so we return early.
2649     if (g1h-&gt;is_obj_dead(obj, region)) {
2650       return false;
2651     }
2652 
2653     // If we do not have a complete remembered set for the region, then we can
2654     // not be sure that we have all references to it.
2655     if (!region-&gt;rem_set()-&gt;is_complete()) {
2656       return false;
2657     }
2658     // Candidate selection must satisfy the following constraints
2659     // while concurrent marking is in progress:
2660     //
2661     // * In order to maintain SATB invariants, an object must not be
2662     // reclaimed if it was allocated before the start of marking and
2663     // has not had its references scanned.  Such an object must have
2664     // its references (including type metadata) scanned to ensure no
2665     // live objects are missed by the marking process.  Objects
2666     // allocated after the start of concurrent marking don&#39;t need to
2667     // be scanned.
2668     //
2669     // * An object must not be reclaimed if it is on the concurrent
2670     // mark stack.  Objects allocated after the start of concurrent
2671     // marking are never pushed on the mark stack.
2672     //
2673     // Nominating only objects allocated after the start of concurrent
2674     // marking is sufficient to meet both constraints.  This may miss
2675     // some objects that satisfy the constraints, but the marking data
2676     // structures don&#39;t support efficiently performing the needed
2677     // additional tests or scrubbing of the mark stack.
2678     //
2679     // However, we presently only nominate is_typeArray() objects.
2680     // A humongous object containing references induces remembered
2681     // set entries on other regions.  In order to reclaim such an
2682     // object, those remembered sets would need to be cleaned up.
2683     //
2684     // We also treat is_typeArray() objects specially, allowing them
2685     // to be reclaimed even if allocated before the start of
2686     // concurrent mark.  For this we rely on mark stack insertion to
2687     // exclude is_typeArray() objects, preventing reclaiming an object
2688     // that is in the mark stack.  We also rely on the metadata for
2689     // such objects to be built-in and so ensured to be kept live.
2690     // Frequent allocation and drop of large binary blobs is an
2691     // important use case for eager reclaim, and this special handling
2692     // may reduce needed headroom.
2693 
2694     return obj-&gt;is_typeArray() &amp;&amp;
2695            g1h-&gt;is_potential_eager_reclaim_candidate(region);
2696   }
2697 
2698  public:
2699   RegisterHumongousWithInCSetFastTestClosure()
2700   : _total_humongous(0),
2701     _candidate_humongous(0),
2702     _dcq(&amp;G1BarrierSet::dirty_card_queue_set()) {
2703   }
2704 
2705   virtual bool do_heap_region(HeapRegion* r) {
2706     if (!r-&gt;is_starts_humongous()) {
2707       return false;
2708     }
2709     G1CollectedHeap* g1h = G1CollectedHeap::heap();
2710 
2711     bool is_candidate = humongous_region_is_candidate(g1h, r);
2712     uint rindex = r-&gt;hrm_index();
2713     g1h-&gt;set_humongous_reclaim_candidate(rindex, is_candidate);
2714     if (is_candidate) {
2715       _candidate_humongous++;
2716       g1h-&gt;register_humongous_region_with_cset(rindex);
2717       // Is_candidate already filters out humongous object with large remembered sets.
2718       // If we have a humongous object with a few remembered sets, we simply flush these
2719       // remembered set entries into the DCQS. That will result in automatic
2720       // re-evaluation of their remembered set entries during the following evacuation
2721       // phase.
2722       if (!r-&gt;rem_set()-&gt;is_empty()) {
2723         guarantee(r-&gt;rem_set()-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries),
2724                   &quot;Found a not-small remembered set here. This is inconsistent with previous assumptions.&quot;);
2725         G1CardTable* ct = g1h-&gt;card_table();
2726         HeapRegionRemSetIterator hrrs(r-&gt;rem_set());
2727         size_t card_index;
2728         while (hrrs.has_next(card_index)) {
2729           CardTable::CardValue* card_ptr = ct-&gt;byte_for_index(card_index);
2730           // The remembered set might contain references to already freed
2731           // regions. Filter out such entries to avoid failing card table
2732           // verification.
2733           if (g1h-&gt;is_in_closed_subset(ct-&gt;addr_for(card_ptr))) {
2734             if (*card_ptr != G1CardTable::dirty_card_val()) {
2735               *card_ptr = G1CardTable::dirty_card_val();
2736               _dcq.enqueue(card_ptr);
2737             }
2738           }
2739         }
2740         assert(hrrs.n_yielded() == r-&gt;rem_set()-&gt;occupied(),
2741                &quot;Remembered set hash maps out of sync, cur: &quot; SIZE_FORMAT &quot; entries, next: &quot; SIZE_FORMAT &quot; entries&quot;,
2742                hrrs.n_yielded(), r-&gt;rem_set()-&gt;occupied());
2743         // We should only clear the card based remembered set here as we will not
2744         // implicitly rebuild anything else during eager reclaim. Note that at the moment
2745         // (and probably never) we do not enter this path if there are other kind of
2746         // remembered sets for this region.
2747         r-&gt;rem_set()-&gt;clear_locked(true /* only_cardset */);
2748         // Clear_locked() above sets the state to Empty. However we want to continue
2749         // collecting remembered set entries for humongous regions that were not
2750         // reclaimed.
2751         r-&gt;rem_set()-&gt;set_state_complete();
2752       }
2753       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point any humongous candidate remembered set must be empty.&quot;);
2754     }
2755     _total_humongous++;
2756 
2757     return false;
2758   }
2759 
2760   size_t total_humongous() const { return _total_humongous; }
2761   size_t candidate_humongous() const { return _candidate_humongous; }
2762 
2763   void flush_rem_set_entries() { _dcq.flush(); }
2764 };
2765 
2766 void G1CollectedHeap::register_humongous_regions_with_cset() {
2767   if (!G1EagerReclaimHumongousObjects) {
2768     phase_times()-&gt;record_fast_reclaim_humongous_stats(0.0, 0, 0);
2769     return;
2770   }
2771   double time = os::elapsed_counter();
2772 
2773   // Collect reclaim candidate information and register candidates with cset.
2774   RegisterHumongousWithInCSetFastTestClosure cl;
2775   heap_region_iterate(&amp;cl);
2776 
2777   time = ((double)(os::elapsed_counter() - time) / os::elapsed_frequency()) * 1000.0;
2778   phase_times()-&gt;record_fast_reclaim_humongous_stats(time,
2779                                                      cl.total_humongous(),
2780                                                      cl.candidate_humongous());
2781   _has_humongous_reclaim_candidates = cl.candidate_humongous() &gt; 0;
2782 
2783   // Finally flush all remembered set entries to re-check into the global DCQS.
2784   cl.flush_rem_set_entries();
2785 }
2786 
2787 class VerifyRegionRemSetClosure : public HeapRegionClosure {
2788   public:
2789     bool do_heap_region(HeapRegion* hr) {
2790       if (!hr-&gt;is_archive() &amp;&amp; !hr-&gt;is_continues_humongous()) {
2791         hr-&gt;verify_rem_set();
2792       }
2793       return false;
2794     }
2795 };
2796 
2797 uint G1CollectedHeap::num_task_queues() const {
2798   return _task_queues-&gt;size();
2799 }
2800 
2801 #if TASKQUEUE_STATS
2802 void G1CollectedHeap::print_taskqueue_stats_hdr(outputStream* const st) {
2803   st-&gt;print_raw_cr(&quot;GC Task Stats&quot;);
2804   st-&gt;print_raw(&quot;thr &quot;); TaskQueueStats::print_header(1, st); st-&gt;cr();
2805   st-&gt;print_raw(&quot;--- &quot;); TaskQueueStats::print_header(2, st); st-&gt;cr();
2806 }
2807 
2808 void G1CollectedHeap::print_taskqueue_stats() const {
2809   if (!log_is_enabled(Trace, gc, task, stats)) {
2810     return;
2811   }
2812   Log(gc, task, stats) log;
2813   ResourceMark rm;
2814   LogStream ls(log.trace());
2815   outputStream* st = &amp;ls;
2816 
2817   print_taskqueue_stats_hdr(st);
2818 
2819   TaskQueueStats totals;
2820   const uint n = num_task_queues();
2821   for (uint i = 0; i &lt; n; ++i) {
2822     st-&gt;print(&quot;%3u &quot;, i); task_queue(i)-&gt;stats.print(st); st-&gt;cr();
2823     totals += task_queue(i)-&gt;stats;
2824   }
2825   st-&gt;print_raw(&quot;tot &quot;); totals.print(st); st-&gt;cr();
2826 
2827   DEBUG_ONLY(totals.verify());
2828 }
2829 
2830 void G1CollectedHeap::reset_taskqueue_stats() {
2831   const uint n = num_task_queues();
2832   for (uint i = 0; i &lt; n; ++i) {
2833     task_queue(i)-&gt;stats.reset();
2834   }
2835 }
2836 #endif // TASKQUEUE_STATS
2837 
2838 void G1CollectedHeap::wait_for_root_region_scanning() {
2839   double scan_wait_start = os::elapsedTime();
2840   // We have to wait until the CM threads finish scanning the
2841   // root regions as it&#39;s the only way to ensure that all the
2842   // objects on them have been correctly scanned before we start
2843   // moving them during the GC.
2844   bool waited = _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
2845   double wait_time_ms = 0.0;
2846   if (waited) {
2847     double scan_wait_end = os::elapsedTime();
2848     wait_time_ms = (scan_wait_end - scan_wait_start) * 1000.0;
2849   }
2850   phase_times()-&gt;record_root_region_scan_wait_time(wait_time_ms);
2851 }
2852 
2853 class G1PrintCollectionSetClosure : public HeapRegionClosure {
2854 private:
2855   G1HRPrinter* _hr_printer;
2856 public:
2857   G1PrintCollectionSetClosure(G1HRPrinter* hr_printer) : HeapRegionClosure(), _hr_printer(hr_printer) { }
2858 
2859   virtual bool do_heap_region(HeapRegion* r) {
2860     _hr_printer-&gt;cset(r);
2861     return false;
2862   }
2863 };
2864 
2865 void G1CollectedHeap::start_new_collection_set() {
2866   collection_set()-&gt;start_incremental_building();
2867 
2868   clear_cset_fast_test();
2869 
2870   guarantee(_eden.length() == 0, &quot;eden should have been cleared&quot;);
2871   policy()-&gt;transfer_survivors_to_cset(survivor());
2872 }
2873 
2874 bool
2875 G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
2876   assert_at_safepoint_on_vm_thread();
2877   guarantee(!is_gc_active(), &quot;collection is not reentrant&quot;);
2878 
2879   if (GCLocker::check_active_before_gc()) {
2880     return false;
2881   }
2882 
2883   _gc_timer_stw-&gt;register_gc_start();
2884 
2885   GCIdMark gc_id_mark;
2886   _gc_tracer_stw-&gt;report_gc_start(gc_cause(), _gc_timer_stw-&gt;gc_start());
2887 
2888   SvcGCMarker sgcm(SvcGCMarker::MINOR);
2889   ResourceMark rm;
2890 
2891   policy()-&gt;note_gc_start();
2892 
2893   wait_for_root_region_scanning();
2894 
2895   print_heap_before_gc();
2896   print_heap_regions();
2897   trace_heap_before_gc(_gc_tracer_stw);
2898 
2899   _verifier-&gt;verify_region_sets_optional();
2900   _verifier-&gt;verify_dirty_young_regions();
2901 
2902   // We should not be doing initial mark unless the conc mark thread is running
2903   if (!_cm_thread-&gt;should_terminate()) {
2904     // This call will decide whether this pause is an initial-mark
2905     // pause. If it is, in_initial_mark_gc() will return true
2906     // for the duration of this pause.
2907     policy()-&gt;decide_on_conc_mark_initiation();
2908   }
2909 
2910   // We do not allow initial-mark to be piggy-backed on a mixed GC.
2911   assert(!collector_state()-&gt;in_initial_mark_gc() ||
2912           collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
2913 
2914   // We also do not allow mixed GCs during marking.
2915   assert(!collector_state()-&gt;mark_or_rebuild_in_progress() || collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
2916 
2917   // Record whether this pause is an initial mark. When the current
2918   // thread has completed its logging output and it&#39;s safe to signal
2919   // the CM thread, the flag&#39;s value in the policy has been reset.
2920   bool should_start_conc_mark = collector_state()-&gt;in_initial_mark_gc();
2921 
2922   // Inner scope for scope based logging, timers, and stats collection
2923   {
2924     G1EvacuationInfo evacuation_info;
2925 
2926     if (collector_state()-&gt;in_initial_mark_gc()) {
2927       // We are about to start a marking cycle, so we increment the
2928       // full collection counter.
2929       increment_old_marking_cycles_started();
2930       _cm-&gt;gc_tracer_cm()-&gt;set_gc_cause(gc_cause());
2931     }
2932 
2933     _gc_tracer_stw-&gt;report_yc_type(collector_state()-&gt;yc_type());
2934 
2935     GCTraceCPUTime tcpu;
2936 
2937     G1HeapVerifier::G1VerifyType verify_type;
2938     FormatBuffer&lt;&gt; gc_string(&quot;Pause Young &quot;);
2939     if (collector_state()-&gt;in_initial_mark_gc()) {
2940       gc_string.append(&quot;(Concurrent Start)&quot;);
2941       verify_type = G1HeapVerifier::G1VerifyConcurrentStart;
2942     } else if (collector_state()-&gt;in_young_only_phase()) {
2943       if (collector_state()-&gt;in_young_gc_before_mixed()) {
2944         gc_string.append(&quot;(Prepare Mixed)&quot;);
2945       } else {
2946         gc_string.append(&quot;(Normal)&quot;);
2947       }
2948       verify_type = G1HeapVerifier::G1VerifyYoungNormal;
2949     } else {
2950       gc_string.append(&quot;(Mixed)&quot;);
2951       verify_type = G1HeapVerifier::G1VerifyMixed;
2952     }
2953     GCTraceTime(Info, gc) tm(gc_string, NULL, gc_cause(), true);
2954 
2955     uint active_workers = WorkerPolicy::calc_active_workers(workers()-&gt;total_workers(),
2956                                                             workers()-&gt;active_workers(),
2957                                                             Threads::number_of_non_daemon_threads());
2958     active_workers = workers()-&gt;update_active_workers(active_workers);
2959     log_info(gc,task)(&quot;Using %u workers of %u for evacuation&quot;, active_workers, workers()-&gt;total_workers());
2960 
2961     G1MonitoringScope ms(g1mm(),
2962                          false /* full_gc */,
2963                          collector_state()-&gt;yc_type() == Mixed /* all_memory_pools_affected */);
2964 
2965     G1HeapTransition heap_transition(this);
2966     size_t heap_used_bytes_before_gc = used();
2967 
2968     // Don&#39;t dynamically change the number of GC threads this early.  A value of
2969     // 0 is used to indicate serial work.  When parallel work is done,
2970     // it will be set.
2971 
2972     { // Call to jvmpi::post_class_unload_events must occur outside of active GC
2973       IsGCActiveMark x;
2974 
2975       gc_prologue(false);
2976 
2977       if (VerifyRememberedSets) {
2978         log_info(gc, verify)(&quot;[Verifying RemSets before GC]&quot;);
2979         VerifyRegionRemSetClosure v_cl;
2980         heap_region_iterate(&amp;v_cl);
2981       }
2982 
2983       _verifier-&gt;verify_before_gc(verify_type);
2984 
2985       _verifier-&gt;check_bitmaps(&quot;GC Start&quot;);
2986 
2987 #if COMPILER2_OR_JVMCI
2988       DerivedPointerTable::clear();
2989 #endif
2990 
2991       // Please see comment in g1CollectedHeap.hpp and
2992       // G1CollectedHeap::ref_processing_init() to see how
2993       // reference processing currently works in G1.
2994 
2995       // Enable discovery in the STW reference processor
2996       _ref_processor_stw-&gt;enable_discovery();
2997 
2998       {
2999         // We want to temporarily turn off discovery by the
3000         // CM ref processor, if necessary, and turn it back on
3001         // on again later if we do. Using a scoped
3002         // NoRefDiscovery object will do this.
3003         NoRefDiscovery no_cm_discovery(_ref_processor_cm);
3004 
3005         // Forget the current alloc region (we might even choose it to be part
3006         // of the collection set!).
3007         _allocator-&gt;release_mutator_alloc_region();
3008 
3009         // This timing is only used by the ergonomics to handle our pause target.
3010         // It is unclear why this should not include the full pause. We will
3011         // investigate this in CR 7178365.
3012         //
3013         // Preserving the old comment here if that helps the investigation:
3014         //
3015         // The elapsed time induced by the start time below deliberately elides
3016         // the possible verification above.
3017         double sample_start_time_sec = os::elapsedTime();
3018 
3019         policy()-&gt;record_collection_pause_start(sample_start_time_sec);
3020 
3021         if (collector_state()-&gt;in_initial_mark_gc()) {
3022           concurrent_mark()-&gt;pre_initial_mark();
3023         }
3024 
3025         policy()-&gt;finalize_collection_set(target_pause_time_ms, &amp;_survivor);
3026 
3027         evacuation_info.set_collectionset_regions(collection_set()-&gt;region_length());
3028 
3029         register_humongous_regions_with_cset();
3030 
3031         assert(_verifier-&gt;check_cset_fast_test(), &quot;Inconsistency in the InCSetState table.&quot;);
3032 
3033         // We call this after finalize_cset() to
3034         // ensure that the CSet has been finalized.
3035         _cm-&gt;verify_no_cset_oops();
3036 
3037         if (_hr_printer.is_active()) {
3038           G1PrintCollectionSetClosure cl(&amp;_hr_printer);
3039           _collection_set.iterate(&amp;cl);
3040         }
3041 
3042         // Initialize the GC alloc regions.
3043         _allocator-&gt;init_gc_alloc_regions(evacuation_info);
3044 
3045         G1ParScanThreadStateSet per_thread_states(this,
3046                                                   workers()-&gt;active_workers(),
3047                                                   collection_set()-&gt;young_region_length(),
3048                                                   collection_set()-&gt;optional_region_length());
3049         pre_evacuate_collection_set();
3050 
3051         // Actually do the work...
3052         evacuate_collection_set(&amp;per_thread_states);
3053         evacuate_optional_collection_set(&amp;per_thread_states);
3054 
3055         post_evacuate_collection_set(evacuation_info, &amp;per_thread_states);
3056 
3057         const size_t* surviving_young_words = per_thread_states.surviving_young_words();
3058         free_collection_set(&amp;_collection_set, evacuation_info, surviving_young_words);
3059 
3060         eagerly_reclaim_humongous_regions();
3061 
3062         record_obj_copy_mem_stats();
3063         _survivor_evac_stats.adjust_desired_plab_sz();
3064         _old_evac_stats.adjust_desired_plab_sz();
3065 
3066         double start = os::elapsedTime();
3067         start_new_collection_set();
3068         phase_times()-&gt;record_start_new_cset_time_ms((os::elapsedTime() - start) * 1000.0);
3069 
3070         if (evacuation_failed()) {
3071           double recalculate_used_start = os::elapsedTime();
3072           set_used(recalculate_used());
3073           phase_times()-&gt;record_evac_fail_recalc_used_time((os::elapsedTime() - recalculate_used_start) * 1000.0);
3074 
3075           if (_archive_allocator != NULL) {
3076             _archive_allocator-&gt;clear_used();
3077           }
3078           for (uint i = 0; i &lt; ParallelGCThreads; i++) {
3079             if (_evacuation_failed_info_array[i].has_failed()) {
3080               _gc_tracer_stw-&gt;report_evacuation_failed(_evacuation_failed_info_array[i]);
3081             }
3082           }
3083         } else {
3084           // The &quot;used&quot; of the the collection set have already been subtracted
3085           // when they were freed.  Add in the bytes evacuated.
3086           increase_used(policy()-&gt;bytes_copied_during_gc());
3087         }
3088 
3089         if (collector_state()-&gt;in_initial_mark_gc()) {
3090           // We have to do this before we notify the CM threads that
3091           // they can start working to make sure that all the
3092           // appropriate initialization is done on the CM object.
3093           concurrent_mark()-&gt;post_initial_mark();
3094           // Note that we don&#39;t actually trigger the CM thread at
3095           // this point. We do that later when we&#39;re sure that
3096           // the current thread has completed its logging output.
3097         }
3098 
3099         allocate_dummy_regions();
3100 
3101         _allocator-&gt;init_mutator_alloc_region();
3102 
3103         {
3104           size_t expand_bytes = _heap_sizing_policy-&gt;expansion_amount();
3105           if (expand_bytes &gt; 0) {
3106             size_t bytes_before = capacity();
3107             // No need for an ergo logging here,
3108             // expansion_amount() does this when it returns a value &gt; 0.
3109             double expand_ms;
3110             if (!expand(expand_bytes, _workers, &amp;expand_ms)) {
3111               // We failed to expand the heap. Cannot do anything about it.
3112             }
3113             phase_times()-&gt;record_expand_heap_time(expand_ms);
3114           }
3115         }
3116 
3117         // We redo the verification but now wrt to the new CSet which
3118         // has just got initialized after the previous CSet was freed.
3119         _cm-&gt;verify_no_cset_oops();
3120 
3121         // This timing is only used by the ergonomics to handle our pause target.
3122         // It is unclear why this should not include the full pause. We will
3123         // investigate this in CR 7178365.
3124         double sample_end_time_sec = os::elapsedTime();
3125         double pause_time_ms = (sample_end_time_sec - sample_start_time_sec) * MILLIUNITS;
3126         size_t total_cards_scanned = phase_times()-&gt;sum_thread_work_items(G1GCPhaseTimes::ScanRS, G1GCPhaseTimes::ScanRSScannedCards);
3127         policy()-&gt;record_collection_pause_end(pause_time_ms, total_cards_scanned, heap_used_bytes_before_gc);
3128 
3129         evacuation_info.set_collectionset_used_before(collection_set()-&gt;bytes_used_before());
3130         evacuation_info.set_bytes_copied(policy()-&gt;bytes_copied_during_gc());
3131 
3132         if (VerifyRememberedSets) {
3133           log_info(gc, verify)(&quot;[Verifying RemSets after GC]&quot;);
3134           VerifyRegionRemSetClosure v_cl;
3135           heap_region_iterate(&amp;v_cl);
3136         }
3137 
3138         _verifier-&gt;verify_after_gc(verify_type);
3139         _verifier-&gt;check_bitmaps(&quot;GC End&quot;);
3140 
3141         assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
3142         _ref_processor_stw-&gt;verify_no_references_recorded();
3143 
3144         // CM reference discovery will be re-enabled if necessary.
3145       }
3146 
3147 #ifdef TRACESPINNING
3148       ParallelTaskTerminator::print_termination_counts();
3149 #endif
3150 
3151       gc_epilogue(false);
3152     }
3153 
3154     // Print the remainder of the GC log output.
3155     if (evacuation_failed()) {
3156       log_info(gc)(&quot;To-space exhausted&quot;);
3157     }
3158 
3159     policy()-&gt;print_phases();
3160     heap_transition.print();
3161 
3162     // It is not yet to safe to tell the concurrent mark to
3163     // start as we have some optional output below. We don&#39;t want the
3164     // output from the concurrent mark thread interfering with this
3165     // logging output either.
3166 
3167     _hrm-&gt;verify_optional();
3168     _verifier-&gt;verify_region_sets_optional();
3169 
3170     TASKQUEUE_STATS_ONLY(print_taskqueue_stats());
3171     TASKQUEUE_STATS_ONLY(reset_taskqueue_stats());
3172 
3173     print_heap_after_gc();
3174     print_heap_regions();
3175     trace_heap_after_gc(_gc_tracer_stw);
3176 
3177     // We must call G1MonitoringSupport::update_sizes() in the same scoping level
3178     // as an active TraceMemoryManagerStats object (i.e. before the destructor for the
3179     // TraceMemoryManagerStats is called) so that the G1 memory pools are updated
3180     // before any GC notifications are raised.
3181     g1mm()-&gt;update_sizes();
3182 
3183     _gc_tracer_stw-&gt;report_evacuation_info(&amp;evacuation_info);
3184     _gc_tracer_stw-&gt;report_tenuring_threshold(_policy-&gt;tenuring_threshold());
3185     _gc_timer_stw-&gt;register_gc_end();
3186     _gc_tracer_stw-&gt;report_gc_end(_gc_timer_stw-&gt;gc_end(), _gc_timer_stw-&gt;time_partitions());
3187   }
3188   // It should now be safe to tell the concurrent mark thread to start
3189   // without its logging output interfering with the logging output
3190   // that came from the pause.
3191 
3192   if (should_start_conc_mark) {
3193     // CAUTION: after the doConcurrentMark() call below,
3194     // the concurrent marking thread(s) could be running
3195     // concurrently with us. Make sure that anything after
3196     // this point does not assume that we are the only GC thread
3197     // running. Note: of course, the actual marking work will
3198     // not start until the safepoint itself is released in
3199     // SuspendibleThreadSet::desynchronize().
3200     do_concurrent_mark();
3201   }
3202 
3203   return true;
3204 }
3205 
3206 void G1CollectedHeap::remove_self_forwarding_pointers() {
3207   G1ParRemoveSelfForwardPtrsTask rsfp_task;
3208   workers()-&gt;run_task(&amp;rsfp_task);
3209 }
3210 
3211 void G1CollectedHeap::restore_after_evac_failure() {
3212   double remove_self_forwards_start = os::elapsedTime();
3213 
3214   remove_self_forwarding_pointers();
3215   SharedRestorePreservedMarksTaskExecutor task_executor(workers());
3216   _preserved_marks_set.restore(&amp;task_executor);
3217 
3218   phase_times()-&gt;record_evac_fail_remove_self_forwards((os::elapsedTime() - remove_self_forwards_start) * 1000.0);
3219 }
3220 
3221 void G1CollectedHeap::preserve_mark_during_evac_failure(uint worker_id, oop obj, markOop m) {
3222   if (!_evacuation_failed) {
3223     _evacuation_failed = true;
3224   }
3225 
3226   _evacuation_failed_info_array[worker_id].register_copy_failure(obj-&gt;size());
3227   _preserved_marks_set.get(worker_id)-&gt;push_if_necessary(obj, m);
3228 }
3229 
3230 bool G1ParEvacuateFollowersClosure::offer_termination() {
3231   EventGCPhaseParallel event;
3232   G1ParScanThreadState* const pss = par_scan_state();
3233   start_term_time();
3234   const bool res = terminator()-&gt;offer_termination();
3235   end_term_time();
3236   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(G1GCPhaseTimes::Termination));
3237   return res;
3238 }
3239 
3240 void G1ParEvacuateFollowersClosure::do_void() {
3241   EventGCPhaseParallel event;
3242   G1ParScanThreadState* const pss = par_scan_state();
3243   pss-&gt;trim_queue();
3244   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3245   do {
3246     EventGCPhaseParallel event;
3247     pss-&gt;steal_and_trim_queue(queues());
3248     event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3249   } while (!offer_termination());
3250 }
3251 
3252 class G1ParTask : public AbstractGangTask {
3253 protected:
3254   G1CollectedHeap*         _g1h;
3255   G1ParScanThreadStateSet* _pss;
3256   RefToScanQueueSet*       _queues;
3257   G1RootProcessor*         _root_processor;
3258   TaskTerminator           _terminator;
3259   uint                     _n_workers;
3260 
3261 public:
3262   G1ParTask(G1CollectedHeap* g1h, G1ParScanThreadStateSet* per_thread_states, RefToScanQueueSet *task_queues, G1RootProcessor* root_processor, uint n_workers)
3263     : AbstractGangTask(&quot;G1 collection&quot;),
3264       _g1h(g1h),
3265       _pss(per_thread_states),
3266       _queues(task_queues),
3267       _root_processor(root_processor),
3268       _terminator(n_workers, _queues),
3269       _n_workers(n_workers)
3270   {}
3271 
3272   void work(uint worker_id) {
3273     if (worker_id &gt;= _n_workers) return;  // no work needed this round
3274 
3275     double start_sec = os::elapsedTime();
3276     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerStart, worker_id, start_sec);
3277 
3278     {
3279       ResourceMark rm;
3280       HandleMark   hm;
3281 
3282       ReferenceProcessor*             rp = _g1h-&gt;ref_processor_stw();
3283 
3284       G1ParScanThreadState*           pss = _pss-&gt;state_for_worker(worker_id);
3285       pss-&gt;set_ref_discoverer(rp);
3286 
3287       double start_strong_roots_sec = os::elapsedTime();
3288 
3289       _root_processor-&gt;evacuate_roots(pss, worker_id);
3290 
3291       _g1h-&gt;rem_set()-&gt;oops_into_collection_set_do(pss, worker_id);
3292 
3293       double strong_roots_sec = os::elapsedTime() - start_strong_roots_sec;
3294 
3295       double term_sec = 0.0;
3296       size_t evac_term_attempts = 0;
3297       {
3298         double start = os::elapsedTime();
3299         G1ParEvacuateFollowersClosure evac(_g1h, pss, _queues, _terminator.terminator(), G1GCPhaseTimes::ObjCopy);
3300         evac.do_void();
3301 
3302         evac_term_attempts = evac.term_attempts();
3303         term_sec = evac.term_time();
3304         double elapsed_sec = os::elapsedTime() - start;
3305 
3306         G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3307         p-&gt;add_time_secs(G1GCPhaseTimes::ObjCopy, worker_id, elapsed_sec - term_sec);
3308 
3309         p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::ObjCopy,
3310                                           worker_id,
3311                                           pss-&gt;lab_waste_words() * HeapWordSize,
3312                                           G1GCPhaseTimes::ObjCopyLABWaste);
3313         p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::ObjCopy,
3314                                           worker_id,
3315                                           pss-&gt;lab_undo_waste_words() * HeapWordSize,
3316                                           G1GCPhaseTimes::ObjCopyLABUndoWaste);
3317 
3318         p-&gt;record_time_secs(G1GCPhaseTimes::Termination, worker_id, term_sec);
3319         p-&gt;record_thread_work_item(G1GCPhaseTimes::Termination, worker_id, evac_term_attempts);
3320       }
3321 
3322       assert(pss-&gt;queue_is_empty(), &quot;should be empty&quot;);
3323 
3324       // Close the inner scope so that the ResourceMark and HandleMark
3325       // destructors are executed here and are included as part of the
3326       // &quot;GC Worker Time&quot;.
3327     }
3328     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerEnd, worker_id, os::elapsedTime());
3329   }
3330 };
3331 
3332 void G1CollectedHeap::complete_cleaning(BoolObjectClosure* is_alive,
3333                                         bool class_unloading_occurred) {
3334   uint num_workers = workers()-&gt;active_workers();
3335   ParallelCleaningTask unlink_task(is_alive, num_workers, class_unloading_occurred, false);
3336   workers()-&gt;run_task(&amp;unlink_task);
3337 }
3338 
3339 // Clean string dedup data structures.
3340 // Ideally we would prefer to use a StringDedupCleaningTask here, but we want to
3341 // record the durations of the phases. Hence the almost-copy.
3342 class G1StringDedupCleaningTask : public AbstractGangTask {
3343   BoolObjectClosure* _is_alive;
3344   OopClosure* _keep_alive;
3345   G1GCPhaseTimes* _phase_times;
3346 
3347 public:
3348   G1StringDedupCleaningTask(BoolObjectClosure* is_alive,
3349                             OopClosure* keep_alive,
3350                             G1GCPhaseTimes* phase_times) :
3351     AbstractGangTask(&quot;Partial Cleaning Task&quot;),
3352     _is_alive(is_alive),
3353     _keep_alive(keep_alive),
3354     _phase_times(phase_times)
3355   {
3356     assert(G1StringDedup::is_enabled(), &quot;String deduplication disabled.&quot;);
3357     StringDedup::gc_prologue(true);
3358   }
3359 
3360   ~G1StringDedupCleaningTask() {
3361     StringDedup::gc_epilogue();
3362   }
3363 
3364   void work(uint worker_id) {
3365     StringDedupUnlinkOrOopsDoClosure cl(_is_alive, _keep_alive);
3366     {
3367       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupQueueFixup, worker_id);
3368       StringDedupQueue::unlink_or_oops_do(&amp;cl);
3369     }
3370     {
3371       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupTableFixup, worker_id);
3372       StringDedupTable::unlink_or_oops_do(&amp;cl, worker_id);
3373     }
3374   }
3375 };
3376 
3377 void G1CollectedHeap::string_dedup_cleaning(BoolObjectClosure* is_alive,
3378                                             OopClosure* keep_alive,
3379                                             G1GCPhaseTimes* phase_times) {
3380   G1StringDedupCleaningTask cl(is_alive, keep_alive, phase_times);
3381   workers()-&gt;run_task(&amp;cl);
3382 }
3383 
3384 class G1RedirtyLoggedCardsTask : public AbstractGangTask {
3385  private:
3386   G1DirtyCardQueueSet* _queue;
3387   G1CollectedHeap* _g1h;
3388  public:
3389   G1RedirtyLoggedCardsTask(G1DirtyCardQueueSet* queue, G1CollectedHeap* g1h) : AbstractGangTask(&quot;Redirty Cards&quot;),
3390     _queue(queue), _g1h(g1h) { }
3391 
3392   virtual void work(uint worker_id) {
3393     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3394     G1GCParPhaseTimesTracker x(p, G1GCPhaseTimes::RedirtyCards, worker_id);
3395 
3396     RedirtyLoggedCardTableEntryClosure cl(_g1h);
3397     _queue-&gt;par_apply_closure_to_all_completed_buffers(&amp;cl);
3398 
3399     p-&gt;record_thread_work_item(G1GCPhaseTimes::RedirtyCards, worker_id, cl.num_dirtied());
3400   }
3401 };
3402 
3403 void G1CollectedHeap::redirty_logged_cards() {
3404   double redirty_logged_cards_start = os::elapsedTime();
3405 
3406   G1RedirtyLoggedCardsTask redirty_task(&amp;dirty_card_queue_set(), this);
3407   dirty_card_queue_set().reset_for_par_iteration();
3408   workers()-&gt;run_task(&amp;redirty_task);
3409 
3410   G1DirtyCardQueueSet&amp; dcq = G1BarrierSet::dirty_card_queue_set();
3411   dcq.merge_bufferlists(&amp;dirty_card_queue_set());
3412   assert(dirty_card_queue_set().completed_buffers_num() == 0, &quot;All should be consumed&quot;);
3413 
3414   phase_times()-&gt;record_redirty_logged_cards_time_ms((os::elapsedTime() - redirty_logged_cards_start) * 1000.0);
3415 }
3416 
3417 // Weak Reference Processing support
3418 
3419 bool G1STWIsAliveClosure::do_object_b(oop p) {
3420   // An object is reachable if it is outside the collection set,
3421   // or is inside and copied.
3422   return !_g1h-&gt;is_in_cset(p) || p-&gt;is_forwarded();
3423 }
3424 
3425 bool G1STWSubjectToDiscoveryClosure::do_object_b(oop obj) {
3426   assert(obj != NULL, &quot;must not be NULL&quot;);
3427   assert(_g1h-&gt;is_in_reserved(obj), &quot;Trying to discover obj &quot; PTR_FORMAT &quot; not in heap&quot;, p2i(obj));
3428   // The areas the CM and STW ref processor manage must be disjoint. The is_in_cset() below
3429   // may falsely indicate that this is not the case here: however the collection set only
3430   // contains old regions when concurrent mark is not running.
3431   return _g1h-&gt;is_in_cset(obj) || _g1h-&gt;heap_region_containing(obj)-&gt;is_survivor();
3432 }
3433 
3434 // Non Copying Keep Alive closure
3435 class G1KeepAliveClosure: public OopClosure {
3436   G1CollectedHeap*_g1h;
3437 public:
3438   G1KeepAliveClosure(G1CollectedHeap* g1h) :_g1h(g1h) {}
3439   void do_oop(narrowOop* p) { guarantee(false, &quot;Not needed&quot;); }
3440   void do_oop(oop* p) {
3441     oop obj = *p;
3442     assert(obj != NULL, &quot;the caller should have filtered out NULL values&quot;);
3443 
3444     const InCSetState cset_state =_g1h-&gt;in_cset_state(obj);
3445     if (!cset_state.is_in_cset_or_humongous()) {
3446       return;
3447     }
3448     if (cset_state.is_in_cset()) {
3449       assert( obj-&gt;is_forwarded(), &quot;invariant&quot; );
3450       *p = obj-&gt;forwardee();
3451     } else {
3452       assert(!obj-&gt;is_forwarded(), &quot;invariant&quot; );
3453       assert(cset_state.is_humongous(),
3454              &quot;Only allowed InCSet state is IsHumongous, but is %d&quot;, cset_state.value());
3455      _g1h-&gt;set_humongous_is_live(obj);
3456     }
3457   }
3458 };
3459 
3460 // Copying Keep Alive closure - can be called from both
3461 // serial and parallel code as long as different worker
3462 // threads utilize different G1ParScanThreadState instances
3463 // and different queues.
3464 
3465 class G1CopyingKeepAliveClosure: public OopClosure {
3466   G1CollectedHeap*         _g1h;
3467   G1ParScanThreadState*    _par_scan_state;
3468 
3469 public:
3470   G1CopyingKeepAliveClosure(G1CollectedHeap* g1h,
3471                             G1ParScanThreadState* pss):
3472     _g1h(g1h),
3473     _par_scan_state(pss)
3474   {}
3475 
3476   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
3477   virtual void do_oop(      oop* p) { do_oop_work(p); }
3478 
3479   template &lt;class T&gt; void do_oop_work(T* p) {
3480     oop obj = RawAccess&lt;&gt;::oop_load(p);
3481 
3482     if (_g1h-&gt;is_in_cset_or_humongous(obj)) {
3483       // If the referent object has been forwarded (either copied
3484       // to a new location or to itself in the event of an
3485       // evacuation failure) then we need to update the reference
3486       // field and, if both reference and referent are in the G1
3487       // heap, update the RSet for the referent.
3488       //
3489       // If the referent has not been forwarded then we have to keep
3490       // it alive by policy. Therefore we have copy the referent.
3491       //
3492       // When the queue is drained (after each phase of reference processing)
3493       // the object and it&#39;s followers will be copied, the reference field set
3494       // to point to the new location, and the RSet updated.
3495       _par_scan_state-&gt;push_on_queue(p);
3496     }
3497   }
3498 };
3499 
3500 // Serial drain queue closure. Called as the &#39;complete_gc&#39;
3501 // closure for each discovered list in some of the
3502 // reference processing phases.
3503 
3504 class G1STWDrainQueueClosure: public VoidClosure {
3505 protected:
3506   G1CollectedHeap* _g1h;
3507   G1ParScanThreadState* _par_scan_state;
3508 
3509   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
3510 
3511 public:
3512   G1STWDrainQueueClosure(G1CollectedHeap* g1h, G1ParScanThreadState* pss) :
3513     _g1h(g1h),
3514     _par_scan_state(pss)
3515   { }
3516 
3517   void do_void() {
3518     G1ParScanThreadState* const pss = par_scan_state();
3519     pss-&gt;trim_queue();
3520   }
3521 };
3522 
3523 // Parallel Reference Processing closures
3524 
3525 // Implementation of AbstractRefProcTaskExecutor for parallel reference
3526 // processing during G1 evacuation pauses.
3527 
3528 class G1STWRefProcTaskExecutor: public AbstractRefProcTaskExecutor {
3529 private:
3530   G1CollectedHeap*          _g1h;
3531   G1ParScanThreadStateSet*  _pss;
3532   RefToScanQueueSet*        _queues;
3533   WorkGang*                 _workers;
3534 
3535 public:
3536   G1STWRefProcTaskExecutor(G1CollectedHeap* g1h,
3537                            G1ParScanThreadStateSet* per_thread_states,
3538                            WorkGang* workers,
3539                            RefToScanQueueSet *task_queues) :
3540     _g1h(g1h),
3541     _pss(per_thread_states),
3542     _queues(task_queues),
3543     _workers(workers)
3544   {
3545     g1h-&gt;ref_processor_stw()-&gt;set_active_mt_degree(workers-&gt;active_workers());
3546   }
3547 
3548   // Executes the given task using concurrent marking worker threads.
3549   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
3550 };
3551 
3552 // Gang task for possibly parallel reference processing
3553 
3554 class G1STWRefProcTaskProxy: public AbstractGangTask {
3555   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
3556   ProcessTask&amp;     _proc_task;
3557   G1CollectedHeap* _g1h;
3558   G1ParScanThreadStateSet* _pss;
3559   RefToScanQueueSet* _task_queues;
3560   ParallelTaskTerminator* _terminator;
3561 
3562 public:
3563   G1STWRefProcTaskProxy(ProcessTask&amp; proc_task,
3564                         G1CollectedHeap* g1h,
3565                         G1ParScanThreadStateSet* per_thread_states,
3566                         RefToScanQueueSet *task_queues,
3567                         ParallelTaskTerminator* terminator) :
3568     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
3569     _proc_task(proc_task),
3570     _g1h(g1h),
3571     _pss(per_thread_states),
3572     _task_queues(task_queues),
3573     _terminator(terminator)
3574   {}
3575 
3576   virtual void work(uint worker_id) {
3577     // The reference processing task executed by a single worker.
3578     ResourceMark rm;
3579     HandleMark   hm;
3580 
3581     G1STWIsAliveClosure is_alive(_g1h);
3582 
3583     G1ParScanThreadState* pss = _pss-&gt;state_for_worker(worker_id);
3584     pss-&gt;set_ref_discoverer(NULL);
3585 
3586     // Keep alive closure.
3587     G1CopyingKeepAliveClosure keep_alive(_g1h, pss);
3588 
3589     // Complete GC closure
3590     G1ParEvacuateFollowersClosure drain_queue(_g1h, pss, _task_queues, _terminator, G1GCPhaseTimes::ObjCopy);
3591 
3592     // Call the reference processing task&#39;s work routine.
3593     _proc_task.work(worker_id, is_alive, keep_alive, drain_queue);
3594 
3595     // Note we cannot assert that the refs array is empty here as not all
3596     // of the processing tasks (specifically phase2 - pp2_work) execute
3597     // the complete_gc closure (which ordinarily would drain the queue) so
3598     // the queue may not be empty.
3599   }
3600 };
3601 
3602 // Driver routine for parallel reference processing.
3603 // Creates an instance of the ref processing gang
3604 // task and has the worker threads execute it.
3605 void G1STWRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
3606   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
3607 
3608   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
3609          &quot;Ergonomically chosen workers (%u) should be less than or equal to active workers (%u)&quot;,
3610          ergo_workers, _workers-&gt;active_workers());
3611   TaskTerminator terminator(ergo_workers, _queues);
3612   G1STWRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _pss, _queues, terminator.terminator());
3613 
3614   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
3615 }
3616 
3617 // End of weak reference support closures
3618 
3619 void G1CollectedHeap::process_discovered_references(G1ParScanThreadStateSet* per_thread_states) {
3620   double ref_proc_start = os::elapsedTime();
3621 
3622   ReferenceProcessor* rp = _ref_processor_stw;
3623   assert(rp-&gt;discovery_enabled(), &quot;should have been enabled&quot;);
3624 
3625   // Closure to test whether a referent is alive.
3626   G1STWIsAliveClosure is_alive(this);
3627 
3628   // Even when parallel reference processing is enabled, the processing
3629   // of JNI refs is serial and performed serially by the current thread
3630   // rather than by a worker. The following PSS will be used for processing
3631   // JNI refs.
3632 
3633   // Use only a single queue for this PSS.
3634   G1ParScanThreadState*          pss = per_thread_states-&gt;state_for_worker(0);
3635   pss-&gt;set_ref_discoverer(NULL);
3636   assert(pss-&gt;queue_is_empty(), &quot;pre-condition&quot;);
3637 
3638   // Keep alive closure.
3639   G1CopyingKeepAliveClosure keep_alive(this, pss);
3640 
3641   // Serial Complete GC closure
3642   G1STWDrainQueueClosure drain_queue(this, pss);
3643 
3644   // Setup the soft refs policy...
3645   rp-&gt;setup_policy(false);
3646 
3647   ReferenceProcessorPhaseTimes* pt = phase_times()-&gt;ref_phase_times();
3648 
3649   ReferenceProcessorStats stats;
3650   if (!rp-&gt;processing_is_mt()) {
3651     // Serial reference processing...
3652     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3653                                               &amp;keep_alive,
3654                                               &amp;drain_queue,
3655                                               NULL,
3656                                               pt);
3657   } else {
3658     uint no_of_gc_workers = workers()-&gt;active_workers();
3659 
3660     // Parallel reference processing
3661     assert(no_of_gc_workers &lt;= rp-&gt;max_num_queues(),
3662            &quot;Mismatch between the number of GC workers %u and the maximum number of Reference process queues %u&quot;,
3663            no_of_gc_workers,  rp-&gt;max_num_queues());
3664 
3665     G1STWRefProcTaskExecutor par_task_executor(this, per_thread_states, workers(), _task_queues);
3666     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3667                                               &amp;keep_alive,
3668                                               &amp;drain_queue,
3669                                               &amp;par_task_executor,
3670                                               pt);
3671   }
3672 
3673   _gc_tracer_stw-&gt;report_gc_reference_stats(stats);
3674 
3675   // We have completed copying any necessary live referent objects.
3676   assert(pss-&gt;queue_is_empty(), &quot;both queue and overflow should be empty&quot;);
3677 
3678   make_pending_list_reachable();
3679 
3680   rp-&gt;verify_no_references_recorded();
3681 
3682   double ref_proc_time = os::elapsedTime() - ref_proc_start;
3683   phase_times()-&gt;record_ref_proc_time(ref_proc_time * 1000.0);
3684 }
3685 
3686 void G1CollectedHeap::make_pending_list_reachable() {
3687   if (collector_state()-&gt;in_initial_mark_gc()) {
3688     oop pll_head = Universe::reference_pending_list();
3689     if (pll_head != NULL) {
3690       // Any valid worker id is fine here as we are in the VM thread and single-threaded.
3691       _cm-&gt;mark_in_next_bitmap(0 /* worker_id */, pll_head);
3692     }
3693   }
3694 }
3695 
3696 void G1CollectedHeap::merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states) {
3697   double merge_pss_time_start = os::elapsedTime();
3698   per_thread_states-&gt;flush();
3699   phase_times()-&gt;record_merge_pss_time_ms((os::elapsedTime() - merge_pss_time_start) * 1000.0);
3700 }
3701 
3702 void G1CollectedHeap::pre_evacuate_collection_set() {
3703   _expand_heap_after_alloc_failure = true;
3704   _evacuation_failed = false;
3705 
3706   // Disable the hot card cache.
3707   _hot_card_cache-&gt;reset_hot_cache_claimed_index();
3708   _hot_card_cache-&gt;set_use_cache(false);
3709 
3710   rem_set()-&gt;prepare_for_oops_into_collection_set_do();
3711   _preserved_marks_set.assert_empty();
3712 
3713   // InitialMark needs claim bits to keep track of the marked-through CLDs.
3714   if (collector_state()-&gt;in_initial_mark_gc()) {
3715     double start_clear_claimed_marks = os::elapsedTime();
3716 
3717     ClassLoaderDataGraph::clear_claimed_marks();
3718 
3719     double recorded_clear_claimed_marks_time_ms = (os::elapsedTime() - start_clear_claimed_marks) * 1000.0;
3720     phase_times()-&gt;record_clear_claimed_marks_time_ms(recorded_clear_claimed_marks_time_ms);
3721   }
3722 }
3723 
3724 void G1CollectedHeap::evacuate_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3725   // Should G1EvacuationFailureALot be in effect for this GC?
3726   NOT_PRODUCT(set_evacuation_failure_alot_for_current_gc();)
3727 
3728   assert(dirty_card_queue_set().completed_buffers_num() == 0, &quot;Should be empty&quot;);
3729 
3730   double start_par_time_sec = os::elapsedTime();
3731   double end_par_time_sec;
3732 
3733   {
3734     const uint n_workers = workers()-&gt;active_workers();
3735     G1RootProcessor root_processor(this, n_workers);
3736     G1ParTask g1_par_task(this, per_thread_states, _task_queues, &amp;root_processor, n_workers);
3737 
3738     workers()-&gt;run_task(&amp;g1_par_task);
3739     end_par_time_sec = os::elapsedTime();
3740 
3741     // Closing the inner scope will execute the destructor
3742     // for the G1RootProcessor object. We record the current
3743     // elapsed time before closing the scope so that time
3744     // taken for the destructor is NOT included in the
3745     // reported parallel time.
3746   }
3747 
3748   double par_time_ms = (end_par_time_sec - start_par_time_sec) * 1000.0;
3749   phase_times()-&gt;record_par_time(par_time_ms);
3750 
3751   double code_root_fixup_time_ms =
3752         (os::elapsedTime() - end_par_time_sec) * 1000.0;
3753   phase_times()-&gt;record_code_root_fixup_time(code_root_fixup_time_ms);
3754 }
3755 
3756 class G1EvacuateOptionalRegionTask : public AbstractGangTask {
3757   G1CollectedHeap* _g1h;
3758   G1ParScanThreadStateSet* _per_thread_states;
3759   G1OptionalCSet* _optional;
3760   RefToScanQueueSet* _queues;
3761   ParallelTaskTerminator _terminator;
3762 
3763   Tickspan trim_ticks(G1ParScanThreadState* pss) {
3764     Tickspan copy_time = pss-&gt;trim_ticks();
3765     pss-&gt;reset_trim_ticks();
3766     return copy_time;
3767   }
3768 
3769   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3770     G1EvacuationRootClosures* root_cls = pss-&gt;closures();
3771     G1ScanObjsDuringScanRSClosure obj_cl(_g1h, pss);
3772 
3773     size_t scanned = 0;
3774     size_t claimed = 0;
3775     size_t skipped = 0;
3776     size_t used_memory = 0;
3777 
3778     Ticks    start = Ticks::now();
3779     Tickspan copy_time;
3780 
3781     for (uint i = _optional-&gt;current_index(); i &lt; _optional-&gt;current_limit(); i++) {
3782       HeapRegion* hr = _optional-&gt;region_at(i);
3783       G1ScanRSForOptionalClosure scan_opt_cl(&amp;obj_cl);
3784       pss-&gt;oops_into_optional_region(hr)-&gt;oops_do(&amp;scan_opt_cl, root_cls-&gt;raw_strong_oops());
3785       copy_time += trim_ticks(pss);
3786 
3787       G1ScanRSForRegionClosure scan_rs_cl(_g1h-&gt;rem_set()-&gt;scan_state(), &amp;obj_cl, pss, G1GCPhaseTimes::OptScanRS, worker_id);
3788       scan_rs_cl.do_heap_region(hr);
3789       copy_time += trim_ticks(pss);
3790       scanned += scan_rs_cl.cards_scanned();
3791       claimed += scan_rs_cl.cards_claimed();
3792       skipped += scan_rs_cl.cards_skipped();
3793 
3794       // Chunk lists for this region is no longer needed.
3795       used_memory += pss-&gt;oops_into_optional_region(hr)-&gt;used_memory();
3796     }
3797 
3798     Tickspan scan_time = (Ticks::now() - start) - copy_time;
3799     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3800     p-&gt;record_or_add_time_secs(G1GCPhaseTimes::OptScanRS, worker_id, scan_time.seconds());
3801     p-&gt;record_or_add_time_secs(G1GCPhaseTimes::OptObjCopy, worker_id, copy_time.seconds());
3802 
3803     p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::OptScanRS, worker_id, scanned, G1GCPhaseTimes::OptCSetScannedCards);
3804     p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::OptScanRS, worker_id, claimed, G1GCPhaseTimes::OptCSetClaimedCards);
3805     p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::OptScanRS, worker_id, skipped, G1GCPhaseTimes::OptCSetSkippedCards);
3806     p-&gt;record_or_add_thread_work_item(G1GCPhaseTimes::OptScanRS, worker_id, used_memory, G1GCPhaseTimes::OptCSetUsedMemory);
3807   }
3808 
3809   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3810     Ticks start = Ticks::now();
3811     G1ParEvacuateFollowersClosure cl(_g1h, pss, _queues, &amp;_terminator, G1GCPhaseTimes::OptObjCopy);
3812     cl.do_void();
3813 
3814     Tickspan evac_time = (Ticks::now() - start);
3815     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3816     p-&gt;record_or_add_time_secs(G1GCPhaseTimes::OptObjCopy, worker_id, evac_time.seconds());
3817     assert(pss-&gt;trim_ticks().seconds() == 0.0, &quot;Unexpected partial trimming done during optional evacuation&quot;);
3818   }
3819 
3820  public:
3821   G1EvacuateOptionalRegionTask(G1CollectedHeap* g1h,
3822                                G1ParScanThreadStateSet* per_thread_states,
3823                                G1OptionalCSet* cset,
3824                                RefToScanQueueSet* queues,
3825                                uint n_workers) :
3826     AbstractGangTask(&quot;G1 Evacuation Optional Region Task&quot;),
3827     _g1h(g1h),
3828     _per_thread_states(per_thread_states),
3829     _optional(cset),
3830     _queues(queues),
3831     _terminator(n_workers, _queues) {
3832   }
3833 
3834   void work(uint worker_id) {
3835     ResourceMark rm;
3836     HandleMark  hm;
3837 
3838     G1ParScanThreadState* pss = _per_thread_states-&gt;state_for_worker(worker_id);
3839     pss-&gt;set_ref_discoverer(_g1h-&gt;ref_processor_stw());
3840 
3841     scan_roots(pss, worker_id);
3842     evacuate_live_objects(pss, worker_id);
3843   }
3844 };
3845 
3846 void G1CollectedHeap::evacuate_optional_regions(G1ParScanThreadStateSet* per_thread_states, G1OptionalCSet* ocset) {
3847   class G1MarkScope : public MarkScope {};
3848   G1MarkScope code_mark_scope;
3849 
3850   G1EvacuateOptionalRegionTask task(this, per_thread_states, ocset, _task_queues, workers()-&gt;active_workers());
3851   workers()-&gt;run_task(&amp;task);
3852 }
3853 
3854 void G1CollectedHeap::evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3855   G1OptionalCSet optional_cset(&amp;_collection_set, per_thread_states);
3856   if (optional_cset.is_empty()) {
3857     return;
3858   }
3859 
3860   if (evacuation_failed()) {
3861     return;
3862   }
3863 
3864   const double gc_start_time_ms = phase_times()-&gt;cur_collection_start_sec() * 1000.0;
3865 
3866   double start_time_sec = os::elapsedTime();
3867 
3868   do {
3869     double time_used_ms = os::elapsedTime() * 1000.0 - gc_start_time_ms;
3870     double time_left_ms = MaxGCPauseMillis - time_used_ms;
3871 
3872     if (time_left_ms &lt; 0) {
3873       log_trace(gc, ergo, cset)(&quot;Skipping %u optional regions, pause time exceeded %.3fms&quot;, optional_cset.size(), time_used_ms);
3874       break;
3875     }
3876 
3877     optional_cset.prepare_evacuation(time_left_ms * _policy-&gt;optional_evacuation_fraction());
3878     if (optional_cset.prepare_failed()) {
3879       log_trace(gc, ergo, cset)(&quot;Skipping %u optional regions, no regions can be evacuated in %.3fms&quot;, optional_cset.size(), time_left_ms);
3880       break;
3881     }
3882 
3883     evacuate_optional_regions(per_thread_states, &amp;optional_cset);
3884 
3885     optional_cset.complete_evacuation();
3886     if (optional_cset.evacuation_failed()) {
3887       break;
3888     }
3889   } while (!optional_cset.is_empty());
3890 
3891   phase_times()-&gt;record_optional_evacuation((os::elapsedTime() - start_time_sec) * 1000.0);
3892 }
3893 
3894 void G1CollectedHeap::post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* per_thread_states) {
3895   // Also cleans the card table from temporary duplicate detection information used
3896   // during UpdateRS/ScanRS.
3897   rem_set()-&gt;cleanup_after_oops_into_collection_set_do();
3898 
3899   // Process any discovered reference objects - we have
3900   // to do this _before_ we retire the GC alloc regions
3901   // as we may have to copy some &#39;reachable&#39; referent
3902   // objects (and their reachable sub-graphs) that were
3903   // not copied during the pause.
3904   process_discovered_references(per_thread_states);
3905 
3906   G1STWIsAliveClosure is_alive(this);
3907   G1KeepAliveClosure keep_alive(this);
3908 
3909   WeakProcessor::weak_oops_do(workers(), &amp;is_alive, &amp;keep_alive,
3910                               phase_times()-&gt;weak_phase_times());
3911 
3912   if (G1StringDedup::is_enabled()) {
3913     double string_dedup_time_ms = os::elapsedTime();
3914 
3915     string_dedup_cleaning(&amp;is_alive, &amp;keep_alive, phase_times());
3916 
3917     double string_cleanup_time_ms = (os::elapsedTime() - string_dedup_time_ms) * 1000.0;
3918     phase_times()-&gt;record_string_deduplication_time(string_cleanup_time_ms);
3919   }
3920 
3921   if (evacuation_failed()) {
3922     restore_after_evac_failure();
3923 
3924     // Reset the G1EvacuationFailureALot counters and flags
3925     // Note: the values are reset only when an actual
3926     // evacuation failure occurs.
3927     NOT_PRODUCT(reset_evacuation_should_fail();)
3928   }
3929 
3930   _preserved_marks_set.assert_empty();
3931 
3932   _allocator-&gt;release_gc_alloc_regions(evacuation_info);
3933 
3934   merge_per_thread_state_info(per_thread_states);
3935 
3936   // Reset and re-enable the hot card cache.
3937   // Note the counts for the cards in the regions in the
3938   // collection set are reset when the collection set is freed.
3939   _hot_card_cache-&gt;reset_hot_cache();
3940   _hot_card_cache-&gt;set_use_cache(true);
3941 
3942   purge_code_root_memory();
3943 
3944   redirty_logged_cards();
3945 #if COMPILER2_OR_JVMCI
3946   double start = os::elapsedTime();
3947   DerivedPointerTable::update_pointers();
3948   phase_times()-&gt;record_derived_pointer_table_update_time((os::elapsedTime() - start) * 1000.0);
3949 #endif
3950   policy()-&gt;print_age_table();
3951 }
3952 
3953 void G1CollectedHeap::record_obj_copy_mem_stats() {
3954   policy()-&gt;add_bytes_allocated_in_old_since_last_gc(_old_evac_stats.allocated() * HeapWordSize);
3955 
3956   _gc_tracer_stw-&gt;report_evacuation_statistics(create_g1_evac_summary(&amp;_survivor_evac_stats),
3957                                                create_g1_evac_summary(&amp;_old_evac_stats));
3958 }
3959 
3960 void G1CollectedHeap::free_region(HeapRegion* hr,
3961                                   FreeRegionList* free_list,
3962                                   bool skip_remset,
3963                                   bool skip_hot_card_cache,
3964                                   bool locked) {
3965   assert(!hr-&gt;is_free(), &quot;the region should not be free&quot;);
3966   assert(!hr-&gt;is_empty(), &quot;the region should not be empty&quot;);
3967   assert(_hrm-&gt;is_available(hr-&gt;hrm_index()), &quot;region should be committed&quot;);
3968   assert(free_list != NULL, &quot;pre-condition&quot;);
3969 
3970   if (G1VerifyBitmaps) {
3971     MemRegion mr(hr-&gt;bottom(), hr-&gt;end());
3972     concurrent_mark()-&gt;clear_range_in_prev_bitmap(mr);
3973   }
3974 
3975   // Clear the card counts for this region.
3976   // Note: we only need to do this if the region is not young
3977   // (since we don&#39;t refine cards in young regions).
3978   if (!skip_hot_card_cache &amp;&amp; !hr-&gt;is_young()) {
3979     _hot_card_cache-&gt;reset_card_counts(hr);
3980   }
3981   hr-&gt;hr_clear(skip_remset, true /* clear_space */, locked /* locked */);
3982   _policy-&gt;remset_tracker()-&gt;update_at_free(hr);
3983   free_list-&gt;add_ordered(hr);
3984 }
3985 
3986 void G1CollectedHeap::free_humongous_region(HeapRegion* hr,
3987                                             FreeRegionList* free_list) {
3988   assert(hr-&gt;is_humongous(), &quot;this is only for humongous regions&quot;);
3989   assert(free_list != NULL, &quot;pre-condition&quot;);
3990   hr-&gt;clear_humongous();
3991   free_region(hr, free_list, false /* skip_remset */, false /* skip_hcc */, true /* locked */);
3992 }
3993 
3994 void G1CollectedHeap::remove_from_old_sets(const uint old_regions_removed,
3995                                            const uint humongous_regions_removed) {
3996   if (old_regions_removed &gt; 0 || humongous_regions_removed &gt; 0) {
3997     MutexLockerEx x(OldSets_lock, Mutex::_no_safepoint_check_flag);
3998     _old_set.bulk_remove(old_regions_removed);
3999     _humongous_set.bulk_remove(humongous_regions_removed);
4000   }
4001 
4002 }
4003 
4004 void G1CollectedHeap::prepend_to_freelist(FreeRegionList* list) {
4005   assert(list != NULL, &quot;list can&#39;t be null&quot;);
4006   if (!list-&gt;is_empty()) {
4007     MutexLockerEx x(FreeList_lock, Mutex::_no_safepoint_check_flag);
4008     _hrm-&gt;insert_list_into_free_list(list);
4009   }
4010 }
4011 
4012 void G1CollectedHeap::decrement_summary_bytes(size_t bytes) {
4013   decrease_used(bytes);
4014 }
4015 
4016 class G1FreeCollectionSetTask : public AbstractGangTask {
4017 private:
4018 
4019   // Closure applied to all regions in the collection set to do work that needs to
4020   // be done serially in a single thread.
4021   class G1SerialFreeCollectionSetClosure : public HeapRegionClosure {
4022   private:
4023     G1EvacuationInfo* _evacuation_info;
4024     const size_t* _surviving_young_words;
4025 
4026     // Bytes used in successfully evacuated regions before the evacuation.
4027     size_t _before_used_bytes;
4028     // Bytes used in unsucessfully evacuated regions before the evacuation
4029     size_t _after_used_bytes;
4030 
4031     size_t _bytes_allocated_in_old_since_last_gc;
4032 
4033     size_t _failure_used_words;
4034     size_t _failure_waste_words;
4035 
4036     FreeRegionList _local_free_list;
4037   public:
4038     G1SerialFreeCollectionSetClosure(G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words) :
4039       HeapRegionClosure(),
4040       _evacuation_info(evacuation_info),
4041       _surviving_young_words(surviving_young_words),
4042       _before_used_bytes(0),
4043       _after_used_bytes(0),
4044       _bytes_allocated_in_old_since_last_gc(0),
4045       _failure_used_words(0),
4046       _failure_waste_words(0),
4047       _local_free_list(&quot;Local Region List for CSet Freeing&quot;) {
4048     }
4049 
4050     virtual bool do_heap_region(HeapRegion* r) {
4051       G1CollectedHeap* g1h = G1CollectedHeap::heap();
4052 
4053       assert(r-&gt;in_collection_set(), &quot;Region %u should be in collection set.&quot;, r-&gt;hrm_index());
4054       g1h-&gt;clear_in_cset(r);
4055 
4056       if (r-&gt;is_young()) {
4057         assert(r-&gt;young_index_in_cset() != -1 &amp;&amp; (uint)r-&gt;young_index_in_cset() &lt; g1h-&gt;collection_set()-&gt;young_region_length(),
4058                &quot;Young index %d is wrong for region %u of type %s with %u young regions&quot;,
4059                r-&gt;young_index_in_cset(),
4060                r-&gt;hrm_index(),
4061                r-&gt;get_type_str(),
4062                g1h-&gt;collection_set()-&gt;young_region_length());
4063         size_t words_survived = _surviving_young_words[r-&gt;young_index_in_cset()];
4064         r-&gt;record_surv_words_in_group(words_survived);
4065       }
4066 
4067       if (!r-&gt;evacuation_failed()) {
4068         assert(r-&gt;not_empty(), &quot;Region %u is an empty region in the collection set.&quot;, r-&gt;hrm_index());
4069         _before_used_bytes += r-&gt;used();
4070         g1h-&gt;free_region(r,
4071                          &amp;_local_free_list,
4072                          true, /* skip_remset */
4073                          true, /* skip_hot_card_cache */
4074                          true  /* locked */);
4075       } else {
4076         r-&gt;uninstall_surv_rate_group();
4077         r-&gt;set_young_index_in_cset(-1);
4078         r-&gt;set_evacuation_failed(false);
4079         // When moving a young gen region to old gen, we &quot;allocate&quot; that whole region
4080         // there. This is in addition to any already evacuated objects. Notify the
4081         // policy about that.
4082         // Old gen regions do not cause an additional allocation: both the objects
4083         // still in the region and the ones already moved are accounted for elsewhere.
4084         if (r-&gt;is_young()) {
4085           _bytes_allocated_in_old_since_last_gc += HeapRegion::GrainBytes;
4086         }
4087         // The region is now considered to be old.
4088         r-&gt;set_old();
4089         // Do some allocation statistics accounting. Regions that failed evacuation
4090         // are always made old, so there is no need to update anything in the young
4091         // gen statistics, but we need to update old gen statistics.
4092         size_t used_words = r-&gt;marked_bytes() / HeapWordSize;
4093 
4094         _failure_used_words += used_words;
4095         _failure_waste_words += HeapRegion::GrainWords - used_words;
4096 
4097         g1h-&gt;old_set_add(r);
4098         _after_used_bytes += r-&gt;used();
4099       }
4100       return false;
4101     }
4102 
4103     void complete_work() {
4104       G1CollectedHeap* g1h = G1CollectedHeap::heap();
4105 
4106       _evacuation_info-&gt;set_regions_freed(_local_free_list.length());
4107       _evacuation_info-&gt;increment_collectionset_used_after(_after_used_bytes);
4108 
4109       g1h-&gt;prepend_to_freelist(&amp;_local_free_list);
4110       g1h-&gt;decrement_summary_bytes(_before_used_bytes);
4111 
4112       G1Policy* policy = g1h-&gt;policy();
4113       policy-&gt;add_bytes_allocated_in_old_since_last_gc(_bytes_allocated_in_old_since_last_gc);
4114 
4115       g1h-&gt;alloc_buffer_stats(InCSetState::Old)-&gt;add_failure_used_and_waste(_failure_used_words, _failure_waste_words);
4116     }
4117   };
4118 
4119   G1CollectionSet* _collection_set;
4120   G1SerialFreeCollectionSetClosure _cl;
4121   const size_t* _surviving_young_words;
4122 
4123   size_t _rs_lengths;
4124 
4125   volatile jint _serial_work_claim;
4126 
4127   struct WorkItem {
4128     uint region_idx;
4129     bool is_young;
4130     bool evacuation_failed;
4131 
4132     WorkItem(HeapRegion* r) {
4133       region_idx = r-&gt;hrm_index();
4134       is_young = r-&gt;is_young();
4135       evacuation_failed = r-&gt;evacuation_failed();
4136     }
4137   };
4138 
4139   volatile size_t _parallel_work_claim;
4140   size_t _num_work_items;
4141   WorkItem* _work_items;
4142 
4143   void do_serial_work() {
4144     // Need to grab the lock to be allowed to modify the old region list.
4145     MutexLockerEx x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4146     _collection_set-&gt;iterate(&amp;_cl);
4147   }
4148 
4149   void do_parallel_work_for_region(uint region_idx, bool is_young, bool evacuation_failed) {
4150     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4151 
4152     HeapRegion* r = g1h-&gt;region_at(region_idx);
4153     assert(!g1h-&gt;is_on_master_free_list(r), &quot;sanity&quot;);
4154 
4155     Atomic::add(r-&gt;rem_set()-&gt;occupied_locked(), &amp;_rs_lengths);
4156 
4157     if (!is_young) {
4158       g1h-&gt;_hot_card_cache-&gt;reset_card_counts(r);
4159     }
4160 
4161     if (!evacuation_failed) {
4162       r-&gt;rem_set()-&gt;clear_locked();
4163     }
4164   }
4165 
4166   class G1PrepareFreeCollectionSetClosure : public HeapRegionClosure {
4167   private:
4168     size_t _cur_idx;
4169     WorkItem* _work_items;
4170   public:
4171     G1PrepareFreeCollectionSetClosure(WorkItem* work_items) : HeapRegionClosure(), _cur_idx(0), _work_items(work_items) { }
4172 
4173     virtual bool do_heap_region(HeapRegion* r) {
4174       _work_items[_cur_idx++] = WorkItem(r);
4175       return false;
4176     }
4177   };
4178 
4179   void prepare_work() {
4180     G1PrepareFreeCollectionSetClosure cl(_work_items);
4181     _collection_set-&gt;iterate(&amp;cl);
4182   }
4183 
4184   void complete_work() {
4185     _cl.complete_work();
4186 
4187     G1Policy* policy = G1CollectedHeap::heap()-&gt;policy();
4188     policy-&gt;record_max_rs_lengths(_rs_lengths);
4189     policy-&gt;cset_regions_freed();
4190   }
4191 public:
4192   G1FreeCollectionSetTask(G1CollectionSet* collection_set, G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words) :
4193     AbstractGangTask(&quot;G1 Free Collection Set&quot;),
4194     _collection_set(collection_set),
4195     _cl(evacuation_info, surviving_young_words),
4196     _surviving_young_words(surviving_young_words),
4197     _rs_lengths(0),
4198     _serial_work_claim(0),
4199     _parallel_work_claim(0),
4200     _num_work_items(collection_set-&gt;region_length()),
4201     _work_items(NEW_C_HEAP_ARRAY(WorkItem, _num_work_items, mtGC)) {
4202     prepare_work();
4203   }
4204 
4205   ~G1FreeCollectionSetTask() {
4206     complete_work();
4207     FREE_C_HEAP_ARRAY(WorkItem, _work_items);
4208   }
4209 
4210   // Chunk size for work distribution. The chosen value has been determined experimentally
4211   // to be a good tradeoff between overhead and achievable parallelism.
4212   static uint chunk_size() { return 32; }
4213 
4214   virtual void work(uint worker_id) {
4215     G1GCPhaseTimes* timer = G1CollectedHeap::heap()-&gt;phase_times();
4216 
4217     // Claim serial work.
4218     if (_serial_work_claim == 0) {
4219       jint value = Atomic::add(1, &amp;_serial_work_claim) - 1;
4220       if (value == 0) {
4221         double serial_time = os::elapsedTime();
4222         do_serial_work();
4223         timer-&gt;record_serial_free_cset_time_ms((os::elapsedTime() - serial_time) * 1000.0);
4224       }
4225     }
4226 
4227     // Start parallel work.
4228     double young_time = 0.0;
4229     bool has_young_time = false;
4230     double non_young_time = 0.0;
4231     bool has_non_young_time = false;
4232 
4233     while (true) {
4234       size_t end = Atomic::add(chunk_size(), &amp;_parallel_work_claim);
4235       size_t cur = end - chunk_size();
4236 
4237       if (cur &gt;= _num_work_items) {
4238         break;
4239       }
4240 
4241       EventGCPhaseParallel event;
4242       double start_time = os::elapsedTime();
4243 
4244       end = MIN2(end, _num_work_items);
4245 
4246       for (; cur &lt; end; cur++) {
4247         bool is_young = _work_items[cur].is_young;
4248 
4249         do_parallel_work_for_region(_work_items[cur].region_idx, is_young, _work_items[cur].evacuation_failed);
4250 
4251         double end_time = os::elapsedTime();
4252         double time_taken = end_time - start_time;
4253         if (is_young) {
4254           young_time += time_taken;
4255           has_young_time = true;
4256           event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::YoungFreeCSet));
4257         } else {
4258           non_young_time += time_taken;
4259           has_non_young_time = true;
4260           event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::NonYoungFreeCSet));
4261         }
4262         start_time = end_time;
4263       }
4264     }
4265 
4266     if (has_young_time) {
4267       timer-&gt;record_time_secs(G1GCPhaseTimes::YoungFreeCSet, worker_id, young_time);
4268     }
4269     if (has_non_young_time) {
4270       timer-&gt;record_time_secs(G1GCPhaseTimes::NonYoungFreeCSet, worker_id, non_young_time);
4271     }
4272   }
4273 };
4274 
4275 void G1CollectedHeap::free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words) {
4276   _eden.clear();
4277 
4278   double free_cset_start_time = os::elapsedTime();
4279 
4280   {
4281     uint const num_chunks = MAX2(_collection_set.region_length() / G1FreeCollectionSetTask::chunk_size(), 1U);
4282     uint const num_workers = MIN2(workers()-&gt;active_workers(), num_chunks);
4283 
4284     G1FreeCollectionSetTask cl(collection_set, &amp;evacuation_info, surviving_young_words);
4285 
4286     log_debug(gc, ergo)(&quot;Running %s using %u workers for collection set length %u&quot;,
4287                         cl.name(),
4288                         num_workers,
4289                         _collection_set.region_length());
4290     workers()-&gt;run_task(&amp;cl, num_workers);
4291   }
4292   phase_times()-&gt;record_total_free_cset_time_ms((os::elapsedTime() - free_cset_start_time) * 1000.0);
4293 
4294   collection_set-&gt;clear();
4295 }
4296 
4297 class G1FreeHumongousRegionClosure : public HeapRegionClosure {
4298  private:
4299   FreeRegionList* _free_region_list;
4300   HeapRegionSet* _proxy_set;
4301   uint _humongous_objects_reclaimed;
4302   uint _humongous_regions_reclaimed;
4303   size_t _freed_bytes;
4304  public:
4305 
4306   G1FreeHumongousRegionClosure(FreeRegionList* free_region_list) :
4307     _free_region_list(free_region_list), _proxy_set(NULL), _humongous_objects_reclaimed(0), _humongous_regions_reclaimed(0), _freed_bytes(0) {
4308   }
4309 
4310   virtual bool do_heap_region(HeapRegion* r) {
4311     if (!r-&gt;is_starts_humongous()) {
4312       return false;
4313     }
4314 
4315     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4316 
4317     oop obj = (oop)r-&gt;bottom();
4318     G1CMBitMap* next_bitmap = g1h-&gt;concurrent_mark()-&gt;next_mark_bitmap();
4319 
4320     // The following checks whether the humongous object is live are sufficient.
4321     // The main additional check (in addition to having a reference from the roots
4322     // or the young gen) is whether the humongous object has a remembered set entry.
4323     //
4324     // A humongous object cannot be live if there is no remembered set for it
4325     // because:
4326     // - there can be no references from within humongous starts regions referencing
4327     // the object because we never allocate other objects into them.
4328     // (I.e. there are no intra-region references that may be missed by the
4329     // remembered set)
4330     // - as soon there is a remembered set entry to the humongous starts region
4331     // (i.e. it has &quot;escaped&quot; to an old object) this remembered set entry will stay
4332     // until the end of a concurrent mark.
4333     //
4334     // It is not required to check whether the object has been found dead by marking
4335     // or not, in fact it would prevent reclamation within a concurrent cycle, as
4336     // all objects allocated during that time are considered live.
4337     // SATB marking is even more conservative than the remembered set.
4338     // So if at this point in the collection there is no remembered set entry,
4339     // nobody has a reference to it.
4340     // At the start of collection we flush all refinement logs, and remembered sets
4341     // are completely up-to-date wrt to references to the humongous object.
4342     //
4343     // Other implementation considerations:
4344     // - never consider object arrays at this time because they would pose
4345     // considerable effort for cleaning up the the remembered sets. This is
4346     // required because stale remembered sets might reference locations that
4347     // are currently allocated into.
4348     uint region_idx = r-&gt;hrm_index();
4349     if (!g1h-&gt;is_humongous_reclaim_candidate(region_idx) ||
4350         !r-&gt;rem_set()-&gt;is_empty()) {
4351       log_debug(gc, humongous)(&quot;Live humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot;  with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4352                                region_idx,
4353                                (size_t)obj-&gt;size() * HeapWordSize,
4354                                p2i(r-&gt;bottom()),
4355                                r-&gt;rem_set()-&gt;occupied(),
4356                                r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4357                                next_bitmap-&gt;is_marked(r-&gt;bottom()),
4358                                g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4359                                obj-&gt;is_typeArray()
4360                               );
4361       return false;
4362     }
4363 
4364     guarantee(obj-&gt;is_typeArray(),
4365               &quot;Only eagerly reclaiming type arrays is supported, but the object &quot;
4366               PTR_FORMAT &quot; is not.&quot;, p2i(r-&gt;bottom()));
4367 
4368     log_debug(gc, humongous)(&quot;Dead humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot; with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4369                              region_idx,
4370                              (size_t)obj-&gt;size() * HeapWordSize,
4371                              p2i(r-&gt;bottom()),
4372                              r-&gt;rem_set()-&gt;occupied(),
4373                              r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4374                              next_bitmap-&gt;is_marked(r-&gt;bottom()),
4375                              g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4376                              obj-&gt;is_typeArray()
4377                             );
4378 
4379     G1ConcurrentMark* const cm = g1h-&gt;concurrent_mark();
4380     cm-&gt;humongous_object_eagerly_reclaimed(r);
4381     assert(!cm-&gt;is_marked_in_prev_bitmap(obj) &amp;&amp; !cm-&gt;is_marked_in_next_bitmap(obj),
4382            &quot;Eagerly reclaimed humongous region %u should not be marked at all but is in prev %s next %s&quot;,
4383            region_idx,
4384            BOOL_TO_STR(cm-&gt;is_marked_in_prev_bitmap(obj)),
4385            BOOL_TO_STR(cm-&gt;is_marked_in_next_bitmap(obj)));
4386     _humongous_objects_reclaimed++;
4387     do {
4388       HeapRegion* next = g1h-&gt;next_region_in_humongous(r);
4389       _freed_bytes += r-&gt;used();
4390       r-&gt;set_containing_set(NULL);
4391       _humongous_regions_reclaimed++;
4392       g1h-&gt;free_humongous_region(r, _free_region_list);
4393       r = next;
4394     } while (r != NULL);
4395 
4396     return false;
4397   }
4398 
4399   uint humongous_objects_reclaimed() {
4400     return _humongous_objects_reclaimed;
4401   }
4402 
4403   uint humongous_regions_reclaimed() {
4404     return _humongous_regions_reclaimed;
4405   }
4406 
4407   size_t bytes_freed() const {
4408     return _freed_bytes;
4409   }
4410 };
4411 
4412 void G1CollectedHeap::eagerly_reclaim_humongous_regions() {
4413   assert_at_safepoint_on_vm_thread();
4414 
4415   if (!G1EagerReclaimHumongousObjects ||
4416       (!_has_humongous_reclaim_candidates &amp;&amp; !log_is_enabled(Debug, gc, humongous))) {
4417     phase_times()-&gt;record_fast_reclaim_humongous_time_ms(0.0, 0);
4418     return;
4419   }
4420 
4421   double start_time = os::elapsedTime();
4422 
4423   FreeRegionList local_cleanup_list(&quot;Local Humongous Cleanup List&quot;);
4424 
4425   G1FreeHumongousRegionClosure cl(&amp;local_cleanup_list);
4426   heap_region_iterate(&amp;cl);
4427 
4428   remove_from_old_sets(0, cl.humongous_regions_reclaimed());
4429 
4430   G1HRPrinter* hrp = hr_printer();
4431   if (hrp-&gt;is_active()) {
4432     FreeRegionListIterator iter(&amp;local_cleanup_list);
4433     while (iter.more_available()) {
4434       HeapRegion* hr = iter.get_next();
4435       hrp-&gt;cleanup(hr);
4436     }
4437   }
4438 
4439   prepend_to_freelist(&amp;local_cleanup_list);
4440   decrement_summary_bytes(cl.bytes_freed());
4441 
4442   phase_times()-&gt;record_fast_reclaim_humongous_time_ms((os::elapsedTime() - start_time) * 1000.0,
4443                                                        cl.humongous_objects_reclaimed());
4444 }
4445 
4446 class G1AbandonCollectionSetClosure : public HeapRegionClosure {
4447 public:
4448   virtual bool do_heap_region(HeapRegion* r) {
4449     assert(r-&gt;in_collection_set(), &quot;Region %u must have been in collection set&quot;, r-&gt;hrm_index());
4450     G1CollectedHeap::heap()-&gt;clear_in_cset(r);
4451     r-&gt;set_young_index_in_cset(-1);
4452     return false;
4453   }
4454 };
4455 
4456 void G1CollectedHeap::abandon_collection_set(G1CollectionSet* collection_set) {
4457   G1AbandonCollectionSetClosure cl;
4458   collection_set-&gt;iterate(&amp;cl);
4459 
4460   collection_set-&gt;clear();
4461   collection_set-&gt;stop_incremental_building();
4462 }
4463 
4464 bool G1CollectedHeap::is_old_gc_alloc_region(HeapRegion* hr) {
4465   return _allocator-&gt;is_retained_old_region(hr);
4466 }
4467 
4468 void G1CollectedHeap::set_region_short_lived_locked(HeapRegion* hr) {
4469   _eden.add(hr);
4470   _policy-&gt;set_region_eden(hr);
4471 }
4472 
4473 #ifdef ASSERT
4474 
4475 class NoYoungRegionsClosure: public HeapRegionClosure {
4476 private:
4477   bool _success;
4478 public:
4479   NoYoungRegionsClosure() : _success(true) { }
4480   bool do_heap_region(HeapRegion* r) {
4481     if (r-&gt;is_young()) {
4482       log_error(gc, verify)(&quot;Region [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) tagged as young&quot;,
4483                             p2i(r-&gt;bottom()), p2i(r-&gt;end()));
4484       _success = false;
4485     }
4486     return false;
4487   }
4488   bool success() { return _success; }
4489 };
4490 
4491 bool G1CollectedHeap::check_young_list_empty() {
4492   bool ret = (young_regions_count() == 0);
4493 
4494   NoYoungRegionsClosure closure;
4495   heap_region_iterate(&amp;closure);
4496   ret = ret &amp;&amp; closure.success();
4497 
4498   return ret;
4499 }
4500 
4501 #endif // ASSERT
4502 
4503 class TearDownRegionSetsClosure : public HeapRegionClosure {
4504   HeapRegionSet *_old_set;
4505 
4506 public:
4507   TearDownRegionSetsClosure(HeapRegionSet* old_set) : _old_set(old_set) { }
4508 
4509   bool do_heap_region(HeapRegion* r) {
4510     if (r-&gt;is_old()) {
4511       _old_set-&gt;remove(r);
4512     } else if(r-&gt;is_young()) {
4513       r-&gt;uninstall_surv_rate_group();
4514     } else {
4515       // We ignore free regions, we&#39;ll empty the free list afterwards.
4516       // We ignore humongous and archive regions, we&#39;re not tearing down these
4517       // sets.
4518       assert(r-&gt;is_archive() || r-&gt;is_free() || r-&gt;is_humongous(),
4519              &quot;it cannot be another type&quot;);
4520     }
4521     return false;
4522   }
4523 
4524   ~TearDownRegionSetsClosure() {
4525     assert(_old_set-&gt;is_empty(), &quot;post-condition&quot;);
4526   }
4527 };
4528 
4529 void G1CollectedHeap::tear_down_region_sets(bool free_list_only) {
4530   assert_at_safepoint_on_vm_thread();
4531 
4532   if (!free_list_only) {
4533     TearDownRegionSetsClosure cl(&amp;_old_set);
4534     heap_region_iterate(&amp;cl);
4535 
4536     // Note that emptying the _young_list is postponed and instead done as
4537     // the first step when rebuilding the regions sets again. The reason for
4538     // this is that during a full GC string deduplication needs to know if
4539     // a collected region was young or old when the full GC was initiated.
4540   }
4541   _hrm-&gt;remove_all_free_regions();
4542 }
4543 
4544 void G1CollectedHeap::increase_used(size_t bytes) {
4545   _summary_bytes_used += bytes;
4546 }
4547 
4548 void G1CollectedHeap::decrease_used(size_t bytes) {
4549   assert(_summary_bytes_used &gt;= bytes,
4550          &quot;invariant: _summary_bytes_used: &quot; SIZE_FORMAT &quot; should be &gt;= bytes: &quot; SIZE_FORMAT,
4551          _summary_bytes_used, bytes);
4552   _summary_bytes_used -= bytes;
4553 }
4554 
4555 void G1CollectedHeap::set_used(size_t bytes) {
4556   _summary_bytes_used = bytes;
4557 }
4558 
4559 class RebuildRegionSetsClosure : public HeapRegionClosure {
4560 private:
4561   bool _free_list_only;
4562 
4563   HeapRegionSet* _old_set;
4564   HeapRegionManager* _hrm;
4565 
4566   size_t _total_used;
4567 
4568 public:
4569   RebuildRegionSetsClosure(bool free_list_only,
4570                            HeapRegionSet* old_set,
4571                            HeapRegionManager* hrm) :
4572     _free_list_only(free_list_only),
4573     _old_set(old_set), _hrm(hrm), _total_used(0) {
4574     assert(_hrm-&gt;num_free_regions() == 0, &quot;pre-condition&quot;);
4575     if (!free_list_only) {
4576       assert(_old_set-&gt;is_empty(), &quot;pre-condition&quot;);
4577     }
4578   }
4579 
4580   bool do_heap_region(HeapRegion* r) {
4581     if (r-&gt;is_empty()) {
4582       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;Empty regions should have empty remembered sets.&quot;);
4583       // Add free regions to the free list
4584       r-&gt;set_free();
4585       _hrm-&gt;insert_into_free_list(r);
4586     } else if (!_free_list_only) {
4587       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point remembered sets must have been cleared.&quot;);
4588 
4589       if (r-&gt;is_archive() || r-&gt;is_humongous()) {
4590         // We ignore archive and humongous regions. We left these sets unchanged.
4591       } else {
4592         assert(r-&gt;is_young() || r-&gt;is_free() || r-&gt;is_old(), &quot;invariant&quot;);
4593         // We now move all (non-humongous, non-old, non-archive) regions to old gen, and register them as such.
4594         r-&gt;move_to_old();
4595         _old_set-&gt;add(r);
4596       }
4597       _total_used += r-&gt;used();
4598     }
4599 
4600     return false;
4601   }
4602 
4603   size_t total_used() {
4604     return _total_used;
4605   }
4606 };
4607 
4608 void G1CollectedHeap::rebuild_region_sets(bool free_list_only) {
4609   assert_at_safepoint_on_vm_thread();
4610 
4611   if (!free_list_only) {
4612     _eden.clear();
4613     _survivor.clear();
4614   }
4615 
4616   RebuildRegionSetsClosure cl(free_list_only, &amp;_old_set, _hrm);
4617   heap_region_iterate(&amp;cl);
4618 
4619   if (!free_list_only) {
4620     set_used(cl.total_used());
4621     if (_archive_allocator != NULL) {
4622       _archive_allocator-&gt;clear_used();
4623     }
4624   }
4625   assert(used() == recalculate_used(),
4626          &quot;inconsistent used(), value: &quot; SIZE_FORMAT &quot; recalculated: &quot; SIZE_FORMAT,
4627          used(), recalculate_used());
4628 }
4629 
4630 bool G1CollectedHeap::is_in_closed_subset(const void* p) const {
4631   HeapRegion* hr = heap_region_containing(p);
4632   return hr-&gt;is_in(p);
4633 }
4634 
4635 // Methods for the mutator alloc region
4636 
4637 HeapRegion* G1CollectedHeap::new_mutator_alloc_region(size_t word_size,
4638                                                       bool force) {
4639   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4640   bool should_allocate = policy()-&gt;should_allocate_mutator_region();
4641   if (force || should_allocate) {
4642     HeapRegion* new_alloc_region = new_region(word_size,
4643                                               HeapRegionType::Eden,
4644                                               false /* do_expand */);
4645     if (new_alloc_region != NULL) {
4646       set_region_short_lived_locked(new_alloc_region);
4647       _hr_printer.alloc(new_alloc_region, !should_allocate);
4648       _verifier-&gt;check_bitmaps(&quot;Mutator Region Allocation&quot;, new_alloc_region);
4649       _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4650       return new_alloc_region;
4651     }
4652   }
4653   return NULL;
4654 }
4655 
4656 void G1CollectedHeap::retire_mutator_alloc_region(HeapRegion* alloc_region,
4657                                                   size_t allocated_bytes) {
4658   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4659   assert(alloc_region-&gt;is_eden(), &quot;all mutator alloc regions should be eden&quot;);
4660 
4661   collection_set()-&gt;add_eden_region(alloc_region);
4662   increase_used(allocated_bytes);
4663   _hr_printer.retire(alloc_region);
4664   // We update the eden sizes here, when the region is retired,
4665   // instead of when it&#39;s allocated, since this is the point that its
4666   // used space has been recorded in _summary_bytes_used.
4667   g1mm()-&gt;update_eden_size();
4668 }
4669 
4670 // Methods for the GC alloc regions
4671 
4672 bool G1CollectedHeap::has_more_regions(InCSetState dest) {
4673   if (dest.is_old()) {
4674     return true;
4675   } else {
4676     return survivor_regions_count() &lt; policy()-&gt;max_survivor_regions();
4677   }
4678 }
4679 
4680 HeapRegion* G1CollectedHeap::new_gc_alloc_region(size_t word_size, InCSetState dest) {
4681   assert(FreeList_lock-&gt;owned_by_self(), &quot;pre-condition&quot;);
4682 
4683   if (!has_more_regions(dest)) {
4684     return NULL;
4685   }
4686 
4687   HeapRegionType type;
4688   if (dest.is_young()) {
4689     type = HeapRegionType::Survivor;
4690   } else {
4691     type = HeapRegionType::Old;
4692   }
4693 
4694   HeapRegion* new_alloc_region = new_region(word_size,
4695                                             type,
4696                                             true /* do_expand */);
4697 
4698   if (new_alloc_region != NULL) {
4699     if (type.is_survivor()) {
4700       new_alloc_region-&gt;set_survivor();
4701       _survivor.add(new_alloc_region);
4702       _verifier-&gt;check_bitmaps(&quot;Survivor Region Allocation&quot;, new_alloc_region);
4703     } else {
4704       new_alloc_region-&gt;set_old();
4705       _verifier-&gt;check_bitmaps(&quot;Old Region Allocation&quot;, new_alloc_region);
4706     }
4707     _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4708     _hr_printer.alloc(new_alloc_region);
4709     return new_alloc_region;
4710   }
4711   return NULL;
4712 }
4713 
4714 void G1CollectedHeap::retire_gc_alloc_region(HeapRegion* alloc_region,
4715                                              size_t allocated_bytes,
4716                                              InCSetState dest) {
4717   policy()-&gt;record_bytes_copied_during_gc(allocated_bytes);
4718   if (dest.is_old()) {
4719     old_set_add(alloc_region);
4720   }
4721 
4722   bool const during_im = collector_state()-&gt;in_initial_mark_gc();
4723   if (during_im &amp;&amp; allocated_bytes &gt; 0) {
4724     _cm-&gt;root_regions()-&gt;add(alloc_region);
4725   }
4726   _hr_printer.retire(alloc_region);
4727 }
4728 
4729 HeapRegion* G1CollectedHeap::alloc_highest_free_region() {
4730   bool expanded = false;
4731   uint index = _hrm-&gt;find_highest_free(&amp;expanded);
4732 
4733   if (index != G1_NO_HRM_INDEX) {
4734     if (expanded) {
4735       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (requested address range outside heap bounds). region size: &quot; SIZE_FORMAT &quot;B&quot;,
4736                                 HeapRegion::GrainWords * HeapWordSize);
4737     }
4738     _hrm-&gt;allocate_free_regions_starting_at(index, 1);
4739     return region_at(index);
4740   }
4741   return NULL;
4742 }
4743 
4744 // Optimized nmethod scanning
4745 
4746 class RegisterNMethodOopClosure: public OopClosure {
4747   G1CollectedHeap* _g1h;
4748   nmethod* _nm;
4749 
4750   template &lt;class T&gt; void do_oop_work(T* p) {
4751     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4752     if (!CompressedOops::is_null(heap_oop)) {
4753       oop obj = CompressedOops::decode_not_null(heap_oop);
4754       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4755       assert(!hr-&gt;is_continues_humongous(),
4756              &quot;trying to add code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4757              &quot; starting at &quot; HR_FORMAT,
4758              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4759 
4760       // HeapRegion::add_strong_code_root_locked() avoids adding duplicate entries.
4761       hr-&gt;add_strong_code_root_locked(_nm);
4762     }
4763   }
4764 
4765 public:
4766   RegisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4767     _g1h(g1h), _nm(nm) {}
4768 
4769   void do_oop(oop* p)       { do_oop_work(p); }
4770   void do_oop(narrowOop* p) { do_oop_work(p); }
4771 };
4772 
4773 class UnregisterNMethodOopClosure: public OopClosure {
4774   G1CollectedHeap* _g1h;
4775   nmethod* _nm;
4776 
4777   template &lt;class T&gt; void do_oop_work(T* p) {
4778     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4779     if (!CompressedOops::is_null(heap_oop)) {
4780       oop obj = CompressedOops::decode_not_null(heap_oop);
4781       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4782       assert(!hr-&gt;is_continues_humongous(),
4783              &quot;trying to remove code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4784              &quot; starting at &quot; HR_FORMAT,
4785              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4786 
4787       hr-&gt;remove_strong_code_root(_nm);
4788     }
4789   }
4790 
4791 public:
4792   UnregisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4793     _g1h(g1h), _nm(nm) {}
4794 
4795   void do_oop(oop* p)       { do_oop_work(p); }
4796   void do_oop(narrowOop* p) { do_oop_work(p); }
4797 };
4798 
4799 void G1CollectedHeap::register_nmethod(nmethod* nm) {
4800   guarantee(nm != NULL, &quot;sanity&quot;);
4801   RegisterNMethodOopClosure reg_cl(this, nm);
4802   nm-&gt;oops_do(&amp;reg_cl);
4803 }
4804 
4805 void G1CollectedHeap::unregister_nmethod(nmethod* nm) {
4806   guarantee(nm != NULL, &quot;sanity&quot;);
4807   UnregisterNMethodOopClosure reg_cl(this, nm);
4808   nm-&gt;oops_do(&amp;reg_cl, true);
4809 }
4810 
4811 void G1CollectedHeap::purge_code_root_memory() {
4812   double purge_start = os::elapsedTime();
4813   G1CodeRootSet::purge();
4814   double purge_time_ms = (os::elapsedTime() - purge_start) * 1000.0;
4815   phase_times()-&gt;record_strong_code_root_purge_time(purge_time_ms);
4816 }
4817 
4818 class RebuildStrongCodeRootClosure: public CodeBlobClosure {
4819   G1CollectedHeap* _g1h;
4820 
4821 public:
4822   RebuildStrongCodeRootClosure(G1CollectedHeap* g1h) :
4823     _g1h(g1h) {}
4824 
4825   void do_code_blob(CodeBlob* cb) {
4826     nmethod* nm = (cb != NULL) ? cb-&gt;as_nmethod_or_null() : NULL;
4827     if (nm == NULL) {
4828       return;
4829     }
4830 
4831     _g1h-&gt;register_nmethod(nm);
4832   }
4833 };
4834 
4835 void G1CollectedHeap::rebuild_strong_code_roots() {
4836   RebuildStrongCodeRootClosure blob_cl(this);
4837   CodeCache::blobs_do(&amp;blob_cl);
4838 }
4839 
4840 void G1CollectedHeap::initialize_serviceability() {
4841   _g1mm-&gt;initialize_serviceability();
4842 }
4843 
4844 MemoryUsage G1CollectedHeap::memory_usage() {
4845   return _g1mm-&gt;memory_usage();
4846 }
4847 
4848 GrowableArray&lt;GCMemoryManager*&gt; G1CollectedHeap::memory_managers() {
4849   return _g1mm-&gt;memory_managers();
4850 }
4851 
4852 GrowableArray&lt;MemoryPool*&gt; G1CollectedHeap::memory_pools() {
4853   return _g1mm-&gt;memory_pools();
4854 }
    </pre>
  </body>
</html>