<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/g1/g1HeapTransition.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="g1HeapSizingPolicy.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1HeapTransition.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/g1HeapTransition.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,20 +24,42 @@</span>
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;gc/g1/g1CollectedHeap.hpp&quot;
  #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  #include &quot;gc/g1/g1Policy.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;logging/log.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;logging/logStream.hpp&quot;</span>
  #include &quot;memory/metaspace.hpp&quot;
  
<span class="udiff-line-modified-removed">- G1HeapTransition::Data::Data(G1CollectedHeap* g1_heap) {</span>
<span class="udiff-line-modified-removed">-   _eden_length = g1_heap-&gt;eden_regions_count();</span>
<span class="udiff-line-modified-removed">-   _survivor_length = g1_heap-&gt;survivor_regions_count();</span>
<span class="udiff-line-modified-removed">-   _old_length = g1_heap-&gt;old_regions_count();</span>
<span class="udiff-line-modified-removed">-   _archive_length = g1_heap-&gt;archive_regions_count();</span>
<span class="udiff-line-modified-removed">-   _humongous_length = g1_heap-&gt;humongous_regions_count();</span>
<span class="udiff-line-modified-removed">-   _metaspace_used_bytes = MetaspaceUtils::used_bytes();</span>
<span class="udiff-line-modified-added">+ G1HeapTransition::Data::Data(G1CollectedHeap* g1_heap) :</span>
<span class="udiff-line-modified-added">+   _eden_length(g1_heap-&gt;eden_regions_count()),</span>
<span class="udiff-line-modified-added">+   _survivor_length(g1_heap-&gt;survivor_regions_count()),</span>
<span class="udiff-line-modified-added">+   _old_length(g1_heap-&gt;old_regions_count()),</span>
<span class="udiff-line-modified-added">+   _archive_length(g1_heap-&gt;archive_regions_count()),</span>
<span class="udiff-line-modified-added">+   _humongous_length(g1_heap-&gt;humongous_regions_count()),</span>
<span class="udiff-line-modified-added">+   _eden_length_per_node(NULL),</span>
<span class="udiff-line-added">+   _survivor_length_per_node(NULL) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   uint node_count = G1NUMA::numa()-&gt;num_active_nodes();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (node_count &gt; 1) {</span>
<span class="udiff-line-added">+     LogTarget(Debug, gc, heap, numa) lt;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (lt.is_enabled()) {</span>
<span class="udiff-line-added">+       _eden_length_per_node = NEW_C_HEAP_ARRAY(uint, node_count, mtGC);</span>
<span class="udiff-line-added">+       _survivor_length_per_node = NEW_C_HEAP_ARRAY(uint, node_count, mtGC);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       for (uint i = 0; i &lt; node_count; i++) {</span>
<span class="udiff-line-added">+         _eden_length_per_node[i] = g1_heap-&gt;eden_regions_count(i);</span>
<span class="udiff-line-added">+         _survivor_length_per_node[i] = g1_heap-&gt;survivor_regions_count(i);</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ G1HeapTransition::Data::~Data() {</span>
<span class="udiff-line-added">+   FREE_C_HEAP_ARRAY(uint, _eden_length_per_node);</span>
<span class="udiff-line-added">+   FREE_C_HEAP_ARRAY(uint, _survivor_length_per_node);</span>
  }
  
  G1HeapTransition::G1HeapTransition(G1CollectedHeap* g1_heap) : _g1_heap(g1_heap), _before(g1_heap) { }
  
  struct DetailedUsage : public StackObj {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,10 +105,38 @@</span>
      }
      return false;
    }
  };
  
<span class="udiff-line-added">+ static void log_regions(const char* msg, size_t before_length, size_t after_length, size_t capacity,</span>
<span class="udiff-line-added">+                         uint* before_per_node_length, uint* after_per_node_length) {</span>
<span class="udiff-line-added">+   LogTarget(Info, gc, heap) lt;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (lt.is_enabled()) {</span>
<span class="udiff-line-added">+     LogStream ls(lt);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ls.print(&quot;%s regions: &quot; SIZE_FORMAT &quot;-&gt;&quot; SIZE_FORMAT &quot;(&quot;  SIZE_FORMAT &quot;)&quot;,</span>
<span class="udiff-line-added">+              msg, before_length, after_length, capacity);</span>
<span class="udiff-line-added">+     // Not NULL only if gc+heap+numa at Debug level is enabled.</span>
<span class="udiff-line-added">+     if (before_per_node_length != NULL &amp;&amp; after_per_node_length != NULL) {</span>
<span class="udiff-line-added">+       G1NUMA* numa = G1NUMA::numa();</span>
<span class="udiff-line-added">+       uint num_nodes = numa-&gt;num_active_nodes();</span>
<span class="udiff-line-added">+       const int* node_ids = numa-&gt;node_ids();</span>
<span class="udiff-line-added">+       ls.print(&quot; (&quot;);</span>
<span class="udiff-line-added">+       for (uint i = 0; i &lt; num_nodes; i++) {</span>
<span class="udiff-line-added">+         ls.print(&quot;%d: %u-&gt;%u&quot;, node_ids[i], before_per_node_length[i], after_per_node_length[i]);</span>
<span class="udiff-line-added">+         // Skip adding below if it is the last one.</span>
<span class="udiff-line-added">+         if (i != num_nodes - 1) {</span>
<span class="udiff-line-added">+           ls.print(&quot;, &quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       ls.print(&quot;)&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ls.print_cr(&quot;&quot;);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void G1HeapTransition::print() {
    Data after(_g1_heap);
  
    size_t eden_capacity_length_after_gc = _g1_heap-&gt;policy()-&gt;young_list_target_length() - after._survivor_length;
    size_t survivor_capacity_length_before_gc = _g1_heap-&gt;policy()-&gt;max_survivor_regions();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -105,16 +155,16 @@</span>
          after._archive_length, usage._archive_region_count);
      assert(usage._humongous_region_count == after._humongous_length, &quot;Expected humongous to be &quot; SIZE_FORMAT &quot; but was &quot; SIZE_FORMAT,
          after._humongous_length, usage._humongous_region_count);
    }
  
<span class="udiff-line-modified-removed">-   log_info(gc, heap)(&quot;Eden regions: &quot; SIZE_FORMAT &quot;-&gt;&quot; SIZE_FORMAT &quot;(&quot;  SIZE_FORMAT &quot;)&quot;,</span>
<span class="udiff-line-modified-removed">-                      _before._eden_length, after._eden_length, eden_capacity_length_after_gc);</span>
<span class="udiff-line-modified-added">+   log_regions(&quot;Eden&quot;, _before._eden_length, after._eden_length, eden_capacity_length_after_gc,</span>
<span class="udiff-line-modified-added">+               _before._eden_length_per_node, after._eden_length_per_node);</span>
    log_trace(gc, heap)(&quot; Used: 0K, Waste: 0K&quot;);
  
<span class="udiff-line-modified-removed">-   log_info(gc, heap)(&quot;Survivor regions: &quot; SIZE_FORMAT &quot;-&gt;&quot; SIZE_FORMAT &quot;(&quot;  SIZE_FORMAT &quot;)&quot;,</span>
<span class="udiff-line-modified-removed">-                      _before._survivor_length, after._survivor_length, survivor_capacity_length_before_gc);</span>
<span class="udiff-line-modified-added">+   log_regions(&quot;Survivor&quot;, _before._survivor_length, after._survivor_length, survivor_capacity_length_before_gc,</span>
<span class="udiff-line-modified-added">+               _before._survivor_length_per_node, after._survivor_length_per_node);</span>
    log_trace(gc, heap)(&quot; Used: &quot; SIZE_FORMAT &quot;K, Waste: &quot; SIZE_FORMAT &quot;K&quot;,
        usage._survivor_used / K, ((after._survivor_length * HeapRegion::GrainBytes) - usage._survivor_used) / K);
  
    log_info(gc, heap)(&quot;Old regions: &quot; SIZE_FORMAT &quot;-&gt;&quot; SIZE_FORMAT,
                       _before._old_length, after._old_length);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -129,7 +179,7 @@</span>
    log_info(gc, heap)(&quot;Humongous regions: &quot; SIZE_FORMAT &quot;-&gt;&quot; SIZE_FORMAT,
                       _before._humongous_length, after._humongous_length);
    log_trace(gc, heap)(&quot; Used: &quot; SIZE_FORMAT &quot;K, Waste: &quot; SIZE_FORMAT &quot;K&quot;,
        usage._humongous_used / K, ((after._humongous_length * HeapRegion::GrainBytes) - usage._humongous_used) / K);
  
<span class="udiff-line-modified-removed">-   MetaspaceUtils::print_metaspace_change(_before._metaspace_used_bytes);</span>
<span class="udiff-line-modified-added">+   MetaspaceUtils::print_metaspace_change(_before._meta_sizes);</span>
  }
</pre>
<center><a href="g1HeapSizingPolicy.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="g1HeapTransition.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>