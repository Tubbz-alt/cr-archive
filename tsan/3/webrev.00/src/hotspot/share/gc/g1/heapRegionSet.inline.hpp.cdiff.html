<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/g1/heapRegionSet.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="heapRegionSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="heterogeneousHeapRegionManager.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/g1/heapRegionSet.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,10 ***</span>
<span class="line-new-header">--- 23,11 ---</span>
   */
  
  #ifndef SHARE_GC_G1_HEAPREGIONSET_INLINE_HPP
  #define SHARE_GC_G1_HEAPREGIONSET_INLINE_HPP
  
<span class="line-added">+ #include &quot;gc/g1/g1NUMA.hpp&quot;</span>
  #include &quot;gc/g1/heapRegionSet.hpp&quot;
  
  inline void HeapRegionSetBase::add(HeapRegion* hr) {
    check_mt_safety();
    assert_heap_region_set(hr-&gt;containing_set() == NULL, &quot;should not already have a containing set&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 47,10 ***</span>
<span class="line-new-header">--- 48,30 ---</span>
    hr-&gt;set_containing_set(NULL);
    assert_heap_region_set(_length &gt; 0, &quot;pre-condition&quot;);
    _length--;
  }
  
<span class="line-added">+ inline void FreeRegionList::add_to_tail(HeapRegion* region_to_add) {</span>
<span class="line-added">+   assert_free_region_list((length() == 0 &amp;&amp; _head == NULL &amp;&amp; _tail == NULL &amp;&amp; _last == NULL) ||</span>
<span class="line-added">+                           (length() &gt;  0 &amp;&amp; _head != NULL &amp;&amp; _tail != NULL &amp;&amp; _tail-&gt;hrm_index() &lt; region_to_add-&gt;hrm_index()),</span>
<span class="line-added">+                           &quot;invariant&quot;);</span>
<span class="line-added">+   // add() will verify the region and check mt safety.</span>
<span class="line-added">+   add(region_to_add);</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (_head != NULL) {</span>
<span class="line-added">+     // Link into list, next is already NULL, no need to set.</span>
<span class="line-added">+     region_to_add-&gt;set_prev(_tail);</span>
<span class="line-added">+     _tail-&gt;set_next(region_to_add);</span>
<span class="line-added">+     _tail = region_to_add;</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     // Empty list, this region is now the list.</span>
<span class="line-added">+     _head = region_to_add;</span>
<span class="line-added">+     _tail = region_to_add;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   increase_length(region_to_add-&gt;node_index());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  inline void FreeRegionList::add_ordered(HeapRegion* hr) {
    assert_free_region_list((length() == 0 &amp;&amp; _head == NULL &amp;&amp; _tail == NULL &amp;&amp; _last == NULL) ||
                            (length() &gt;  0 &amp;&amp; _head != NULL &amp;&amp; _tail != NULL),
                            &quot;invariant&quot;);
    // add() will verify the region and check mt safety.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 92,10 ***</span>
<span class="line-new-header">--- 113,12 ---</span>
      // The list was empty
      _tail = hr;
      _head = hr;
    }
    _last = hr;
<span class="line-added">+ </span>
<span class="line-added">+   increase_length(hr-&gt;node_index());</span>
  }
  
  inline HeapRegion* FreeRegionList::remove_from_head_impl() {
    HeapRegion* result = _head;
    _head = result-&gt;next();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 142,9 ***</span>
<span class="line-new-header">--- 165,109 ---</span>
      _last = NULL;
    }
  
    // remove() will verify the region and check mt safety.
    remove(hr);
<span class="line-added">+ </span>
<span class="line-added">+   decrease_length(hr-&gt;node_index());</span>
<span class="line-added">+ </span>
    return hr;
  }
  
<span class="line-added">+ inline HeapRegion* FreeRegionList::remove_region_with_node_index(bool from_head,</span>
<span class="line-added">+                                                                  uint requested_node_index) {</span>
<span class="line-added">+   assert(UseNUMA, &quot;Invariant&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+   const uint max_search_depth = G1NUMA::numa()-&gt;max_search_depth();</span>
<span class="line-added">+   HeapRegion* cur;</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Find the region to use, searching from _head or _tail as requested.</span>
<span class="line-added">+   size_t cur_depth = 0;</span>
<span class="line-added">+   if (from_head) {</span>
<span class="line-added">+     for (cur = _head;</span>
<span class="line-added">+          cur != NULL &amp;&amp; cur_depth &lt; max_search_depth;</span>
<span class="line-added">+          cur = cur-&gt;next(), ++cur_depth) {</span>
<span class="line-added">+       if (requested_node_index == cur-&gt;node_index()) {</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       }</span>
<span class="line-added">+     }</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     for (cur = _tail;</span>
<span class="line-added">+          cur != NULL &amp;&amp; cur_depth &lt; max_search_depth;</span>
<span class="line-added">+          cur = cur-&gt;prev(), ++cur_depth) {</span>
<span class="line-added">+       if (requested_node_index == cur-&gt;node_index()) {</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       }</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Didn&#39;t find a region to use.</span>
<span class="line-added">+   if (cur == NULL || cur_depth &gt;= max_search_depth) {</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // Splice the region out of the list.</span>
<span class="line-added">+   HeapRegion* prev = cur-&gt;prev();</span>
<span class="line-added">+   HeapRegion* next = cur-&gt;next();</span>
<span class="line-added">+   if (prev == NULL) {</span>
<span class="line-added">+     _head = next;</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     prev-&gt;set_next(next);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   if (next == NULL) {</span>
<span class="line-added">+     _tail = prev;</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     next-&gt;set_prev(prev);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   cur-&gt;set_prev(NULL);</span>
<span class="line-added">+   cur-&gt;set_next(NULL);</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (_last == cur) {</span>
<span class="line-added">+     _last = NULL;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   remove(cur);</span>
<span class="line-added">+   decrease_length(cur-&gt;node_index());</span>
<span class="line-added">+ </span>
<span class="line-added">+   return cur;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline void FreeRegionList::NodeInfo::increase_length(uint node_index) {</span>
<span class="line-added">+   if (node_index &lt; _num_nodes) {</span>
<span class="line-added">+     _length_of_node[node_index] += 1;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline void FreeRegionList::NodeInfo::decrease_length(uint node_index) {</span>
<span class="line-added">+   if (node_index &lt; _num_nodes) {</span>
<span class="line-added">+     assert(_length_of_node[node_index] &gt; 0,</span>
<span class="line-added">+            &quot;Current length %u should be greater than zero for node %u&quot;,</span>
<span class="line-added">+            _length_of_node[node_index], node_index);</span>
<span class="line-added">+     _length_of_node[node_index] -= 1;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline uint FreeRegionList::NodeInfo::length(uint node_index) const {</span>
<span class="line-added">+   return _length_of_node[node_index];</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline void FreeRegionList::increase_length(uint node_index) {</span>
<span class="line-added">+   if (_node_info != NULL) {</span>
<span class="line-added">+     return _node_info-&gt;increase_length(node_index);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline void FreeRegionList::decrease_length(uint node_index) {</span>
<span class="line-added">+   if (_node_info != NULL) {</span>
<span class="line-added">+     return _node_info-&gt;decrease_length(node_index);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ inline uint FreeRegionList::length(uint node_index) const {</span>
<span class="line-added">+   if (_node_info != NULL) {</span>
<span class="line-added">+     return _node_info-&gt;length(node_index);</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     return 0;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #endif // SHARE_GC_G1_HEAPREGIONSET_INLINE_HPP
</pre>
<center><a href="heapRegionSet.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="heterogeneousHeapRegionManager.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>