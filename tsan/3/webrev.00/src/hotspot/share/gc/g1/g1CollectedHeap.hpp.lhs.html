<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1CollectedHeap.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  26 #define SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  27 
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1BiasedArray.hpp&quot;
  30 #include &quot;gc/g1/g1CardTable.hpp&quot;
  31 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  32 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  33 #include &quot;gc/g1/g1ConcurrentMark.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed">  34 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;</span>
  35 #include &quot;gc/g1/g1EdenRegions.hpp&quot;
  36 #include &quot;gc/g1/g1EvacFailure.hpp&quot;
  37 #include &quot;gc/g1/g1EvacStats.hpp&quot;
  38 #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;
  39 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  40 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  41 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  42 #include &quot;gc/g1/g1HRPrinter.hpp&quot;
<a name="3" id="anc3"></a><span class="line-modified">  43 #include &quot;gc/g1/g1InCSetState.hpp&quot;</span>
  44 #include &quot;gc/g1/g1MonitoringSupport.hpp&quot;
<a name="4" id="anc4"></a>

  45 #include &quot;gc/g1/g1SurvivorRegions.hpp&quot;
  46 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  47 #include &quot;gc/g1/heapRegionManager.hpp&quot;
  48 #include &quot;gc/g1/heapRegionSet.hpp&quot;
  49 #include &quot;gc/g1/heterogeneousHeapRegionManager.hpp&quot;
  50 #include &quot;gc/shared/barrierSet.hpp&quot;
  51 #include &quot;gc/shared/collectedHeap.hpp&quot;
  52 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  53 #include &quot;gc/shared/plab.hpp&quot;
  54 #include &quot;gc/shared/preservedMarks.hpp&quot;
  55 #include &quot;gc/shared/softRefPolicy.hpp&quot;
  56 #include &quot;memory/memRegion.hpp&quot;
  57 #include &quot;utilities/stack.hpp&quot;
  58 
  59 // A &quot;G1CollectedHeap&quot; is an implementation of a java heap for HotSpot.
  60 // It uses the &quot;Garbage First&quot; heap organization and algorithm, which
  61 // may combine concurrent marking with parallel, incremental compaction of
  62 // heap subsets that will yield large amounts of garbage.
  63 
  64 // Forward declarations
  65 class HeapRegion;
  66 class GenerationSpec;
  67 class G1ParScanThreadState;
  68 class G1ParScanThreadStateSet;
  69 class G1ParScanThreadState;
  70 class MemoryPool;
  71 class MemoryManager;
  72 class ObjectClosure;
  73 class SpaceClosure;
  74 class CompactibleSpaceClosure;
  75 class Space;
<a name="5" id="anc5"></a>
  76 class G1CollectionSet;
<a name="6" id="anc6"></a><span class="line-removed">  77 class G1CollectorPolicy;</span>
  78 class G1Policy;
  79 class G1HotCardCache;
  80 class G1RemSet;
  81 class G1YoungRemSetSamplingThread;
<a name="7" id="anc7"></a><span class="line-removed">  82 class HeapRegionRemSetIterator;</span>
  83 class G1ConcurrentMark;
  84 class G1ConcurrentMarkThread;
  85 class G1ConcurrentRefine;
  86 class GenerationCounters;
  87 class STWGCTimer;
  88 class G1NewTracer;
  89 class EvacuationFailedInfo;
  90 class nmethod;
  91 class WorkGang;
  92 class G1Allocator;
  93 class G1ArchiveAllocator;
  94 class G1FullGCScope;
  95 class G1HeapVerifier;
  96 class G1HeapSizingPolicy;
  97 class G1HeapSummary;
  98 class G1EvacSummary;
  99 
 100 typedef OverflowTaskQueue&lt;StarTask, mtGC&gt;         RefToScanQueue;
 101 typedef GenericTaskQueueSet&lt;RefToScanQueue, mtGC&gt; RefToScanQueueSet;
 102 
 103 typedef int RegionIdx_t;   // needs to hold [ 0..max_regions() )
 104 typedef int CardIdx_t;     // needs to hold [ 0..CardsPerRegion )
 105 
 106 // The G1 STW is alive closure.
 107 // An instance is embedded into the G1CH and used as the
 108 // (optional) _is_alive_non_header closure in the STW
 109 // reference processor. It is also extensively used during
 110 // reference processing during STW evacuation pauses.
 111 class G1STWIsAliveClosure : public BoolObjectClosure {
 112   G1CollectedHeap* _g1h;
 113 public:
 114   G1STWIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 115   bool do_object_b(oop p);
 116 };
 117 
 118 class G1STWSubjectToDiscoveryClosure : public BoolObjectClosure {
 119   G1CollectedHeap* _g1h;
 120 public:
 121   G1STWSubjectToDiscoveryClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 122   bool do_object_b(oop p);
 123 };
 124 
 125 class G1RegionMappingChangedListener : public G1MappingChangedListener {
 126  private:
 127   void reset_from_card_cache(uint start_idx, size_t num_regions);
 128  public:
 129   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 130 };
 131 
 132 class G1CollectedHeap : public CollectedHeap {
<a name="8" id="anc8"></a><span class="line-removed"> 133   friend class G1FreeCollectionSetTask;</span>
 134   friend class VM_CollectForMetadataAllocation;
 135   friend class VM_G1CollectForAllocation;
 136   friend class VM_G1CollectFull;
<a name="9" id="anc9"></a>
 137   friend class VMStructs;
 138   friend class MutatorAllocRegion;
 139   friend class G1FullCollector;
 140   friend class G1GCAllocRegion;
 141   friend class G1HeapVerifier;
 142 
 143   // Closures used in implementation.
 144   friend class G1ParScanThreadState;
 145   friend class G1ParScanThreadStateSet;
<a name="10" id="anc10"></a><span class="line-modified"> 146   friend class G1ParTask;</span>
 147   friend class G1PLABAllocator;
<a name="11" id="anc11"></a><span class="line-removed"> 148   friend class G1PrepareCompactClosure;</span>
 149 
 150   // Other related classes.
 151   friend class HeapRegionClaimer;
 152 
 153   // Testing classes.
<a name="12" id="anc12"></a><span class="line-modified"> 154   friend class G1CheckCSetFastTableClosure;</span>
 155 
 156 private:
 157   G1YoungRemSetSamplingThread* _young_gen_sampling_thread;
 158 
 159   WorkGang* _workers;
<a name="13" id="anc13"></a><span class="line-removed"> 160   G1CollectorPolicy* _collector_policy;</span>
 161   G1CardTable* _card_table;
 162 
 163   SoftRefPolicy      _soft_ref_policy;
 164 
 165   static size_t _humongous_object_threshold_in_words;
 166 
 167   // These sets keep track of old, archive and humongous regions respectively.
 168   HeapRegionSet _old_set;
 169   HeapRegionSet _archive_set;
 170   HeapRegionSet _humongous_set;
 171 
 172   void eagerly_reclaim_humongous_regions();
 173   // Start a new incremental collection set for the next pause.
 174   void start_new_collection_set();
 175 
 176   // The block offset table for the G1 heap.
 177   G1BlockOffsetTable* _bot;
 178 
 179   // Tears down the region sets / lists so that they are empty and the
 180   // regions on the heap do not belong to a region set / list. The
 181   // only exception is the humongous set which we leave unaltered. If
 182   // free_list_only is true, it will only tear down the master free
 183   // list. It is called before a Full GC (free_list_only == false) or
 184   // before heap shrinking (free_list_only == true).
 185   void tear_down_region_sets(bool free_list_only);
 186 
 187   // Rebuilds the region sets / lists so that they are repopulated to
 188   // reflect the contents of the heap. The only exception is the
 189   // humongous set which was not torn down in the first place. If
 190   // free_list_only is true, it will only rebuild the master free
 191   // list. It is called after a Full GC (free_list_only == false) or
 192   // after heap shrinking (free_list_only == true).
 193   void rebuild_region_sets(bool free_list_only);
 194 
 195   // Callback for region mapping changed events.
 196   G1RegionMappingChangedListener _listener;
 197 
<a name="14" id="anc14"></a>


 198   // The sequence of all heap regions in the heap.
 199   HeapRegionManager* _hrm;
 200 
 201   // Manages all allocations with regions except humongous object allocations.
 202   G1Allocator* _allocator;
 203 
 204   // Manages all heap verification.
 205   G1HeapVerifier* _verifier;
 206 
 207   // Outside of GC pauses, the number of bytes used in all regions other
 208   // than the current allocation region(s).
<a name="15" id="anc15"></a><span class="line-modified"> 209   size_t _summary_bytes_used;</span>
 210 
 211   void increase_used(size_t bytes);
 212   void decrease_used(size_t bytes);
 213 
 214   void set_used(size_t bytes);
 215 
<a name="16" id="anc16"></a>



 216   // Class that handles archive allocation ranges.
 217   G1ArchiveAllocator* _archive_allocator;
 218 
 219   // GC allocation statistics policy for survivors.
 220   G1EvacStats _survivor_evac_stats;
 221 
 222   // GC allocation statistics policy for tenured objects.
 223   G1EvacStats _old_evac_stats;
 224 
 225   // It specifies whether we should attempt to expand the heap after a
 226   // region allocation failure. If heap expansion fails we set this to
 227   // false so that we don&#39;t re-attempt the heap expansion (it&#39;s likely
 228   // that subsequent expansion attempts will also fail if one fails).
 229   // Currently, it is only consulted during GC and it&#39;s reset at the
 230   // start of each GC.
 231   bool _expand_heap_after_alloc_failure;
 232 
 233   // Helper for monitoring and management support.
 234   G1MonitoringSupport* _g1mm;
 235 
 236   // Records whether the region at the given index is (still) a
 237   // candidate for eager reclaim.  Only valid for humongous start
 238   // regions; other regions have unspecified values.  Humongous start
 239   // regions are initialized at start of collection pause, with
 240   // candidates removed from the set as they are found reachable from
 241   // roots or the young generation.
 242   class HumongousReclaimCandidates : public G1BiasedMappedArray&lt;bool&gt; {
 243    protected:
 244     bool default_value() const { return false; }
 245    public:
 246     void clear() { G1BiasedMappedArray&lt;bool&gt;::clear(); }
 247     void set_candidate(uint region, bool value) {
 248       set_by_index(region, value);
 249     }
 250     bool is_candidate(uint region) {
 251       return get_by_index(region);
 252     }
 253   };
 254 
 255   HumongousReclaimCandidates _humongous_reclaim_candidates;
 256   // Stores whether during humongous object registration we found candidate regions.
 257   // If not, we can skip a few steps.
 258   bool _has_humongous_reclaim_candidates;
 259 
 260   G1HRPrinter _hr_printer;
 261 
<a name="17" id="anc17"></a><span class="line-modified"> 262   // It decides whether an explicit GC should start a concurrent cycle</span>
<span class="line-modified"> 263   // instead of doing a STW GC. Currently, a concurrent cycle is</span>
<span class="line-modified"> 264   // explicitly started if:</span>
<span class="line-modified"> 265   // (a) cause == _gc_locker and +GCLockerInvokesConcurrent, or</span>
<span class="line-modified"> 266   // (b) cause == _g1_humongous_allocation</span>
<span class="line-modified"> 267   // (c) cause == _java_lang_system_gc and +ExplicitGCInvokesConcurrent.</span>
<span class="line-modified"> 268   // (d) cause == _dcmd_gc_run and +ExplicitGCInvokesConcurrent.</span>
<span class="line-removed"> 269   // (e) cause == _wb_conc_mark</span>
 270   bool should_do_concurrent_full_gc(GCCause::Cause cause);
 271 
<a name="18" id="anc18"></a>





 272   // Return true if should upgrade to full gc after an incremental one.
 273   bool should_upgrade_to_full_gc(GCCause::Cause cause);
 274 
 275   // indicates whether we are in young or mixed GC mode
 276   G1CollectorState _collector_state;
 277 
 278   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 279   // concurrent cycles) we have started.
 280   volatile uint _old_marking_cycles_started;
 281 
 282   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 283   // concurrent cycles) we have completed.
 284   volatile uint _old_marking_cycles_completed;
 285 
 286   // This is a non-product method that is helpful for testing. It is
 287   // called at the end of a GC and artificially expands the heap by
 288   // allocating a number of dead regions. This way we can induce very
 289   // frequent marking cycles and stress the cleanup / concurrent
 290   // cleanup code more (as all the regions that will be allocated by
 291   // this method will be found dead by the marking cycle).
 292   void allocate_dummy_regions() PRODUCT_RETURN;
 293 
 294   // If the HR printer is active, dump the state of the regions in the
 295   // heap after a compaction.
 296   void print_hrm_post_compaction();
 297 
 298   // Create a memory mapper for auxiliary data structures of the given size and
 299   // translation factor.
 300   static G1RegionToSpaceMapper* create_aux_memory_mapper(const char* description,
 301                                                          size_t size,
 302                                                          size_t translation_factor);
 303 
 304   void trace_heap(GCWhen::Type when, const GCTracer* tracer);
 305 
 306   // These are macros so that, if the assert fires, we get the correct
 307   // line number, file, etc.
 308 
 309 #define heap_locking_asserts_params(_extra_message_)                          \
 310   &quot;%s : Heap_lock locked: %s, at safepoint: %s, is VM thread: %s&quot;,            \
 311   (_extra_message_),                                                          \
 312   BOOL_TO_STR(Heap_lock-&gt;owned_by_self()),                                    \
 313   BOOL_TO_STR(SafepointSynchronize::is_at_safepoint()),                       \
 314   BOOL_TO_STR(Thread::current()-&gt;is_VM_thread())
 315 
 316 #define assert_heap_locked()                                                  \
 317   do {                                                                        \
 318     assert(Heap_lock-&gt;owned_by_self(),                                        \
 319            heap_locking_asserts_params(&quot;should be holding the Heap_lock&quot;));   \
 320   } while (0)
 321 
 322 #define assert_heap_locked_or_at_safepoint(_should_be_vm_thread_)             \
 323   do {                                                                        \
 324     assert(Heap_lock-&gt;owned_by_self() ||                                      \
 325            (SafepointSynchronize::is_at_safepoint() &amp;&amp;                        \
 326              ((_should_be_vm_thread_) == Thread::current()-&gt;is_VM_thread())), \
 327            heap_locking_asserts_params(&quot;should be holding the Heap_lock or &quot;  \
 328                                         &quot;should be at a safepoint&quot;));         \
 329   } while (0)
 330 
 331 #define assert_heap_locked_and_not_at_safepoint()                             \
 332   do {                                                                        \
 333     assert(Heap_lock-&gt;owned_by_self() &amp;&amp;                                      \
 334                                     !SafepointSynchronize::is_at_safepoint(), \
 335           heap_locking_asserts_params(&quot;should be holding the Heap_lock and &quot;  \
 336                                        &quot;should not be at a safepoint&quot;));      \
 337   } while (0)
 338 
 339 #define assert_heap_not_locked()                                              \
 340   do {                                                                        \
 341     assert(!Heap_lock-&gt;owned_by_self(),                                       \
 342         heap_locking_asserts_params(&quot;should not be holding the Heap_lock&quot;));  \
 343   } while (0)
 344 
 345 #define assert_heap_not_locked_and_not_at_safepoint()                         \
 346   do {                                                                        \
 347     assert(!Heap_lock-&gt;owned_by_self() &amp;&amp;                                     \
 348                                     !SafepointSynchronize::is_at_safepoint(), \
 349       heap_locking_asserts_params(&quot;should not be holding the Heap_lock and &quot;  \
 350                                    &quot;should not be at a safepoint&quot;));          \
 351   } while (0)
 352 
 353 #define assert_at_safepoint_on_vm_thread()                                    \
 354   do {                                                                        \
 355     assert_at_safepoint();                                                    \
 356     assert(Thread::current_or_null() != NULL, &quot;no current thread&quot;);           \
 357     assert(Thread::current()-&gt;is_VM_thread(), &quot;current thread is not VM thread&quot;); \
 358   } while (0)
 359 
<a name="19" id="anc19"></a>














 360   // The young region list.
 361   G1EdenRegions _eden;
 362   G1SurvivorRegions _survivor;
 363 
 364   STWGCTimer* _gc_timer_stw;
 365 
 366   G1NewTracer* _gc_tracer_stw;
 367 
 368   // The current policy object for the collector.
 369   G1Policy* _policy;
 370   G1HeapSizingPolicy* _heap_sizing_policy;
 371 
 372   G1CollectionSet _collection_set;
 373 
 374   // Try to allocate a single non-humongous HeapRegion sufficient for
 375   // an allocation of the given word_size. If do_expand is true,
 376   // attempt to expand the heap if necessary to satisfy the allocation
 377   // request. &#39;type&#39; takes the type of region to be allocated. (Use constants
 378   // Old, Eden, Humongous, Survivor defined in HeapRegionType.)
<a name="20" id="anc20"></a><span class="line-modified"> 379   HeapRegion* new_region(size_t word_size, HeapRegionType type, bool do_expand);</span>



 380 
 381   // Initialize a contiguous set of free regions of length num_regions
 382   // and starting at index first so that they appear as a single
 383   // humongous region.
 384   HeapWord* humongous_obj_allocate_initialize_regions(uint first,
 385                                                       uint num_regions,
 386                                                       size_t word_size);
 387 
 388   // Attempt to allocate a humongous object of the given size. Return
 389   // NULL if unsuccessful.
 390   HeapWord* humongous_obj_allocate(size_t word_size);
 391 
 392   // The following two methods, allocate_new_tlab() and
 393   // mem_allocate(), are the two main entry points from the runtime
 394   // into the G1&#39;s allocation routines. They have the following
 395   // assumptions:
 396   //
 397   // * They should both be called outside safepoints.
 398   //
 399   // * They should both be called without holding the Heap_lock.
 400   //
 401   // * All allocation requests for new TLABs should go to
 402   //   allocate_new_tlab().
 403   //
 404   // * All non-TLAB allocation requests should go to mem_allocate().
 405   //
 406   // * If either call cannot satisfy the allocation request using the
 407   //   current allocating region, they will try to get a new one. If
 408   //   this fails, they will attempt to do an evacuation pause and
 409   //   retry the allocation.
 410   //
 411   // * If all allocation attempts fail, even after trying to schedule
 412   //   an evacuation pause, allocate_new_tlab() will return NULL,
 413   //   whereas mem_allocate() will attempt a heap expansion and/or
 414   //   schedule a Full GC.
 415   //
 416   // * We do not allow humongous-sized TLABs. So, allocate_new_tlab
 417   //   should never be called with word_size being humongous. All
 418   //   humongous allocation requests should go to mem_allocate() which
 419   //   will satisfy them with a special path.
 420 
 421   virtual HeapWord* allocate_new_tlab(size_t min_size,
 422                                       size_t requested_size,
 423                                       size_t* actual_size);
 424 
 425   virtual HeapWord* mem_allocate(size_t word_size,
 426                                  bool*  gc_overhead_limit_was_exceeded);
 427 
 428   // First-level mutator allocation attempt: try to allocate out of
 429   // the mutator alloc region without taking the Heap_lock. This
 430   // should only be used for non-humongous allocations.
 431   inline HeapWord* attempt_allocation(size_t min_word_size,
 432                                       size_t desired_word_size,
 433                                       size_t* actual_word_size);
 434 
 435   // Second-level mutator allocation attempt: take the Heap_lock and
 436   // retry the allocation attempt, potentially scheduling a GC
 437   // pause. This should only be used for non-humongous allocations.
 438   HeapWord* attempt_allocation_slow(size_t word_size);
 439 
 440   // Takes the Heap_lock and attempts a humongous allocation. It can
 441   // potentially schedule a GC pause.
 442   HeapWord* attempt_allocation_humongous(size_t word_size);
 443 
 444   // Allocation attempt that should be called during safepoints (e.g.,
 445   // at the end of a successful GC). expect_null_mutator_alloc_region
 446   // specifies whether the mutator alloc region is expected to be NULL
 447   // or not.
 448   HeapWord* attempt_allocation_at_safepoint(size_t word_size,
 449                                             bool expect_null_mutator_alloc_region);
 450 
 451   // These methods are the &quot;callbacks&quot; from the G1AllocRegion class.
 452 
 453   // For mutator alloc regions.
<a name="21" id="anc21"></a><span class="line-modified"> 454   HeapRegion* new_mutator_alloc_region(size_t word_size, bool force);</span>
 455   void retire_mutator_alloc_region(HeapRegion* alloc_region,
 456                                    size_t allocated_bytes);
 457 
 458   // For GC alloc regions.
<a name="22" id="anc22"></a><span class="line-modified"> 459   bool has_more_regions(InCSetState dest);</span>
<span class="line-modified"> 460   HeapRegion* new_gc_alloc_region(size_t word_size, InCSetState dest);</span>
 461   void retire_gc_alloc_region(HeapRegion* alloc_region,
<a name="23" id="anc23"></a><span class="line-modified"> 462                               size_t allocated_bytes, InCSetState dest);</span>
 463 
 464   // - if explicit_gc is true, the GC is for a System.gc() etc,
 465   //   otherwise it&#39;s for a failed allocation.
 466   // - if clear_all_soft_refs is true, all soft references should be
 467   //   cleared during the GC.
 468   // - it returns false if it is unable to do the collection due to the
 469   //   GC locker being active, true otherwise.
 470   bool do_full_collection(bool explicit_gc,
 471                           bool clear_all_soft_refs);
 472 
 473   // Callback from VM_G1CollectFull operation, or collect_as_vm_thread.
 474   virtual void do_full_collection(bool clear_all_soft_refs);
 475 
 476   // Callback from VM_G1CollectForAllocation operation.
 477   // This function does everything necessary/possible to satisfy a
 478   // failed allocation request (including collection, expansion, etc.)
 479   HeapWord* satisfy_failed_allocation(size_t word_size,
 480                                       bool* succeeded);
 481   // Internal helpers used during full GC to split it up to
 482   // increase readability.
 483   void abort_concurrent_cycle();
 484   void verify_before_full_collection(bool explicit_gc);
 485   void prepare_heap_for_full_collection();
 486   void prepare_heap_for_mutators();
 487   void abort_refinement();
 488   void verify_after_full_collection();
 489   void print_heap_after_full_collection(G1HeapTransition* heap_transition);
 490 
 491   // Helper method for satisfy_failed_allocation()
 492   HeapWord* satisfy_failed_allocation_helper(size_t word_size,
 493                                              bool do_gc,
 494                                              bool clear_all_soft_refs,
 495                                              bool expect_null_mutator_alloc_region,
 496                                              bool* gc_succeeded);
 497 
 498   // Attempting to expand the heap sufficiently
 499   // to support an allocation of the given &quot;word_size&quot;.  If
 500   // successful, perform the allocation and return the address of the
 501   // allocated block, or else &quot;NULL&quot;.
 502   HeapWord* expand_and_allocate(size_t word_size);
 503 
 504   // Process any reference objects discovered.
 505   void process_discovered_references(G1ParScanThreadStateSet* per_thread_states);
 506 
 507   // If during an initial mark pause we may install a pending list head which is not
 508   // otherwise reachable ensure that it is marked in the bitmap for concurrent marking
 509   // to discover.
 510   void make_pending_list_reachable();
 511 
 512   // Merges the information gathered on a per-thread basis for all worker threads
 513   // during GC into global variables.
 514   void merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states);
<a name="24" id="anc24"></a>


 515 public:
 516   G1YoungRemSetSamplingThread* sampling_thread() const { return _young_gen_sampling_thread; }
 517 
 518   WorkGang* workers() const { return _workers; }
 519 
<a name="25" id="anc25"></a>



 520   G1Allocator* allocator() {
 521     return _allocator;
 522   }
 523 
 524   G1HeapVerifier* verifier() {
 525     return _verifier;
 526   }
 527 
 528   G1MonitoringSupport* g1mm() {
 529     assert(_g1mm != NULL, &quot;should have been initialized&quot;);
 530     return _g1mm;
 531   }
 532 
 533   void resize_heap_if_necessary();
 534 
<a name="26" id="anc26"></a>

 535   // Expand the garbage-first heap by at least the given size (in bytes!).
 536   // Returns true if the heap was expanded by the requested amount;
 537   // false otherwise.
 538   // (Rounds up to a HeapRegion boundary.)
 539   bool expand(size_t expand_bytes, WorkGang* pretouch_workers = NULL, double* expand_time_ms = NULL);
<a name="27" id="anc27"></a>
 540 
 541   // Returns the PLAB statistics for a given destination.
<a name="28" id="anc28"></a><span class="line-modified"> 542   inline G1EvacStats* alloc_buffer_stats(InCSetState dest);</span>
 543 
 544   // Determines PLAB size for a given destination.
<a name="29" id="anc29"></a><span class="line-modified"> 545   inline size_t desired_plab_sz(InCSetState dest);</span>
 546 
 547   // Do anything common to GC&#39;s.
 548   void gc_prologue(bool full);
 549   void gc_epilogue(bool full);
 550 
 551   // Does the given region fulfill remembered set based eager reclaim candidate requirements?
 552   bool is_potential_eager_reclaim_candidate(HeapRegion* r) const;
 553 
 554   // Modify the reclaim candidate set and test for presence.
 555   // These are only valid for starts_humongous regions.
 556   inline void set_humongous_reclaim_candidate(uint region, bool value);
 557   inline bool is_humongous_reclaim_candidate(uint region);
<a name="30" id="anc30"></a>
 558 
 559   // Remove from the reclaim candidate set.  Also remove from the
 560   // collection set so that later encounters avoid the slow path.
 561   inline void set_humongous_is_live(oop obj);
 562 
 563   // Register the given region to be part of the collection set.
<a name="31" id="anc31"></a><span class="line-modified"> 564   inline void register_humongous_region_with_cset(uint index);</span>
<span class="line-modified"> 565   // Register regions with humongous objects (actually on the start region) in</span>
<span class="line-removed"> 566   // the in_cset_fast_test table.</span>
<span class="line-removed"> 567   void register_humongous_regions_with_cset();</span>
 568   // We register a region with the fast &quot;in collection set&quot; test. We
 569   // simply set to true the array slot corresponding to this region.
<a name="32" id="anc32"></a><span class="line-modified"> 570   void register_young_region_with_cset(HeapRegion* r) {</span>
<span class="line-modified"> 571     _in_cset_fast_test.set_in_young(r-&gt;hrm_index());</span>
<span class="line-removed"> 572   }</span>
<span class="line-removed"> 573   void register_old_region_with_cset(HeapRegion* r) {</span>
<span class="line-removed"> 574     _in_cset_fast_test.set_in_old(r-&gt;hrm_index());</span>
<span class="line-removed"> 575   }</span>
<span class="line-removed"> 576   void register_optional_region_with_cset(HeapRegion* r) {</span>
<span class="line-removed"> 577     _in_cset_fast_test.set_optional(r-&gt;hrm_index());</span>
 578   }
<a name="33" id="anc33"></a><span class="line-modified"> 579   void clear_in_cset(const HeapRegion* hr) {</span>
<span class="line-modified"> 580     _in_cset_fast_test.clear(hr);</span>




 581   }
 582 
<a name="34" id="anc34"></a><span class="line-modified"> 583   void clear_cset_fast_test() {</span>
<span class="line-modified"> 584     _in_cset_fast_test.clear();</span>
 585   }
 586 
<a name="35" id="anc35"></a>



 587   bool is_user_requested_concurrent_full_gc(GCCause::Cause cause);
 588 
 589   // This is called at the start of either a concurrent cycle or a Full
 590   // GC to update the number of old marking cycles started.
 591   void increment_old_marking_cycles_started();
 592 
 593   // This is called at the end of either a concurrent cycle or a Full
 594   // GC to update the number of old marking cycles completed. Those two
 595   // can happen in a nested fashion, i.e., we start a concurrent
 596   // cycle, a Full GC happens half-way through it which ends first,
 597   // and then the cycle notices that a Full GC happened and ends
 598   // too. The concurrent parameter is a boolean to help us do a bit
 599   // tighter consistency checking in the method. If concurrent is
 600   // false, the caller is the inner caller in the nesting (i.e., the
 601   // Full GC). If concurrent is true, the caller is the outer caller
 602   // in this nesting (i.e., the concurrent cycle). Further nesting is
 603   // not currently supported. The end of this call also notifies
<a name="36" id="anc36"></a><span class="line-modified"> 604   // the FullGCCount_lock in case a Java thread is waiting for a full</span>
 605   // GC to happen (e.g., it called System.gc() with
 606   // +ExplicitGCInvokesConcurrent).
 607   void increment_old_marking_cycles_completed(bool concurrent);
 608 
 609   uint old_marking_cycles_completed() {
 610     return _old_marking_cycles_completed;
 611   }
 612 
 613   G1HRPrinter* hr_printer() { return &amp;_hr_printer; }
 614 
 615   // Allocates a new heap region instance.
 616   HeapRegion* new_heap_region(uint hrs_index, MemRegion mr);
 617 
 618   // Allocate the highest free region in the reserved heap. This will commit
 619   // regions as necessary.
 620   HeapRegion* alloc_highest_free_region();
 621 
<a name="37" id="anc37"></a><span class="line-modified"> 622   // Frees a non-humongous region by initializing its contents and</span>
<span class="line-modified"> 623   // adding it to the free list that&#39;s passed as a parameter (this is</span>
<span class="line-modified"> 624   // usually a local list which will be appended to the master free</span>
<span class="line-modified"> 625   // list later). The used bytes of freed regions are accumulated in</span>
<span class="line-modified"> 626   // pre_used. If skip_remset is true, the region&#39;s RSet will not be freed</span>
<span class="line-modified"> 627   // up. If skip_hot_card_cache is true, the region&#39;s hot card cache will not</span>
<span class="line-modified"> 628   // be freed up. The assumption is that this will be done later.</span>
<span class="line-removed"> 629   // The locked parameter indicates if the caller has already taken</span>
<span class="line-removed"> 630   // care of proper synchronization. This may allow some optimizations.</span>
<span class="line-removed"> 631   void free_region(HeapRegion* hr,</span>
<span class="line-removed"> 632                    FreeRegionList* free_list,</span>
<span class="line-removed"> 633                    bool skip_remset,</span>
<span class="line-removed"> 634                    bool skip_hot_card_cache = false,</span>
<span class="line-removed"> 635                    bool locked = false);</span>
 636 
 637   // It dirties the cards that cover the block so that the post
 638   // write barrier never queues anything when updating objects on this
 639   // block. It is assumed (and in fact we assert) that the block
 640   // belongs to a young region.
 641   inline void dirty_young_block(HeapWord* start, size_t word_size);
 642 
 643   // Frees a humongous region by collapsing it into individual regions
 644   // and calling free_region() for each of them. The freed regions
 645   // will be added to the free list that&#39;s passed as a parameter (this
 646   // is usually a local list which will be appended to the master free
 647   // list later).
 648   // The method assumes that only a single thread is ever calling
 649   // this for a particular region at once.
 650   void free_humongous_region(HeapRegion* hr,
 651                              FreeRegionList* free_list);
 652 
 653   // Facility for allocating in &#39;archive&#39; regions in high heap memory and
 654   // recording the allocated ranges. These should all be called from the
 655   // VM thread at safepoints, without the heap lock held. They can be used
 656   // to create and archive a set of heap regions which can be mapped at the
 657   // same fixed addresses in a subsequent JVM invocation.
 658   void begin_archive_alloc_range(bool open = false);
 659 
 660   // Check if the requested size would be too large for an archive allocation.
 661   bool is_archive_alloc_too_large(size_t word_size);
 662 
 663   // Allocate memory of the requested size from the archive region. This will
 664   // return NULL if the size is too large or if no memory is available. It
 665   // does not trigger a garbage collection.
 666   HeapWord* archive_mem_allocate(size_t word_size);
 667 
 668   // Optionally aligns the end address and returns the allocated ranges in
 669   // an array of MemRegions in order of ascending addresses.
 670   void end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 671                                size_t end_alignment_in_bytes = 0);
 672 
 673   // Facility for allocating a fixed range within the heap and marking
 674   // the containing regions as &#39;archive&#39;. For use at JVM init time, when the
 675   // caller may mmap archived heap data at the specified range(s).
 676   // Verify that the MemRegions specified in the argument array are within the
 677   // reserved heap.
 678   bool check_archive_addresses(MemRegion* range, size_t count);
 679 
 680   // Commit the appropriate G1 regions containing the specified MemRegions
 681   // and mark them as &#39;archive&#39; regions. The regions in the array must be
 682   // non-overlapping and in order of ascending address.
 683   bool alloc_archive_regions(MemRegion* range, size_t count, bool open);
 684 
 685   // Insert any required filler objects in the G1 regions around the specified
 686   // ranges to make the regions parseable. This must be called after
 687   // alloc_archive_regions, and after class loading has occurred.
 688   void fill_archive_regions(MemRegion* range, size_t count);
 689 
 690   // For each of the specified MemRegions, uncommit the containing G1 regions
 691   // which had been allocated by alloc_archive_regions. This should be called
 692   // rather than fill_archive_regions at JVM init time if the archive file
 693   // mapping failed, with the same non-overlapping and sorted MemRegion array.
<a name="38" id="anc38"></a><span class="line-modified"> 694   void dealloc_archive_regions(MemRegion* range, size_t count, bool is_open);</span>
 695 
 696   oop materialize_archived_object(oop obj);
 697 
 698 private:
 699 
 700   // Shrink the garbage-first heap by at most the given size (in bytes!).
 701   // (Rounds down to a HeapRegion boundary.)
 702   void shrink(size_t expand_bytes);
 703   void shrink_helper(size_t expand_bytes);
 704 
 705   #if TASKQUEUE_STATS
 706   static void print_taskqueue_stats_hdr(outputStream* const st);
 707   void print_taskqueue_stats() const;
 708   void reset_taskqueue_stats();
 709   #endif // TASKQUEUE_STATS
 710 
 711   // Schedule the VM operation that will do an evacuation pause to
 712   // satisfy an allocation request of word_size. *succeeded will
 713   // return whether the VM operation was successful (it did do an
 714   // evacuation pause) or not (another thread beat us to it or the GC
 715   // locker was active). Given that we should not be holding the
 716   // Heap_lock when we enter this method, we will pass the
 717   // gc_count_before (i.e., total_collections()) as a parameter since
 718   // it has to be read while holding the Heap_lock. Currently, both
 719   // methods that call do_collection_pause() release the Heap_lock
 720   // before the call, so it&#39;s easy to read gc_count_before just before.
 721   HeapWord* do_collection_pause(size_t         word_size,
 722                                 uint           gc_count_before,
 723                                 bool*          succeeded,
 724                                 GCCause::Cause gc_cause);
 725 
 726   void wait_for_root_region_scanning();
 727 
<a name="39" id="anc39"></a><span class="line-modified"> 728   // The guts of the incremental collection pause, executed by the vm</span>
<span class="line-modified"> 729   // thread. It returns false if it is unable to do the collection due</span>
<span class="line-modified"> 730   // to the GC locker being active, true otherwise</span>



 731   bool do_collection_pause_at_safepoint(double target_pause_time_ms);
 732 
<a name="40" id="anc40"></a><span class="line-modified"> 733   // Actually do the work of evacuating the collection set.</span>
<span class="line-modified"> 734   void evacuate_collection_set(G1ParScanThreadStateSet* per_thread_states);</span>










 735   void evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states);
<a name="41" id="anc41"></a><span class="line-modified"> 736   void evacuate_optional_regions(G1ParScanThreadStateSet* per_thread_states, G1OptionalCSet* ocset);</span>


 737 
<a name="42" id="anc42"></a><span class="line-modified"> 738   void pre_evacuate_collection_set();</span>
<span class="line-modified"> 739   void post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* pss);</span>



 740 
<a name="43" id="anc43"></a>
 741   // Update object copying statistics.
 742   void record_obj_copy_mem_stats();
 743 
 744   // The hot card cache for remembered set insertion optimization.
 745   G1HotCardCache* _hot_card_cache;
 746 
 747   // The g1 remembered set of the heap.
 748   G1RemSet* _rem_set;
 749 
<a name="44" id="anc44"></a><span class="line-removed"> 750   // A set of cards that cover the objects for which the Rsets should be updated</span>
<span class="line-removed"> 751   // concurrently after the collection.</span>
<span class="line-removed"> 752   G1DirtyCardQueueSet _dirty_card_queue_set;</span>
<span class="line-removed"> 753 </span>
 754   // After a collection pause, convert the regions in the collection set into free
 755   // regions.
 756   void free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words);
 757 
 758   // Abandon the current collection set without recording policy
 759   // statistics or updating free lists.
 760   void abandon_collection_set(G1CollectionSet* collection_set);
 761 
 762   // The concurrent marker (and the thread it runs in.)
 763   G1ConcurrentMark* _cm;
 764   G1ConcurrentMarkThread* _cm_thread;
 765 
 766   // The concurrent refiner.
 767   G1ConcurrentRefine* _cr;
 768 
 769   // The parallel task queues
 770   RefToScanQueueSet *_task_queues;
 771 
 772   // True iff a evacuation has failed in the current collection.
 773   bool _evacuation_failed;
 774 
 775   EvacuationFailedInfo* _evacuation_failed_info_array;
 776 
 777   // Failed evacuations cause some logical from-space objects to have
 778   // forwarding pointers to themselves.  Reset them.
<a name="45" id="anc45"></a><span class="line-modified"> 779   void remove_self_forwarding_pointers();</span>
 780 
 781   // Restore the objects in the regions in the collection set after an
 782   // evacuation failure.
<a name="46" id="anc46"></a><span class="line-modified"> 783   void restore_after_evac_failure();</span>
 784 
 785   PreservedMarksSet _preserved_marks_set;
 786 
 787   // Preserve the mark of &quot;obj&quot;, if necessary, in preparation for its mark
 788   // word being overwritten with a self-forwarding-pointer.
<a name="47" id="anc47"></a><span class="line-modified"> 789   void preserve_mark_during_evac_failure(uint worker_id, oop obj, markOop m);</span>
 790 
 791 #ifndef PRODUCT
 792   // Support for forcing evacuation failures. Analogous to
 793   // PromotionFailureALot for the other collectors.
 794 
 795   // Records whether G1EvacuationFailureALot should be in effect
 796   // for the current GC
 797   bool _evacuation_failure_alot_for_current_gc;
 798 
 799   // Used to record the GC number for interval checking when
 800   // determining whether G1EvaucationFailureALot is in effect
 801   // for the current GC.
 802   size_t _evacuation_failure_alot_gc_number;
 803 
 804   // Count of the number of evacuations between failures.
 805   volatile size_t _evacuation_failure_alot_count;
 806 
 807   // Set whether G1EvacuationFailureALot should be in effect
 808   // for the current GC (based upon the type of GC and which
 809   // command line flags are set);
 810   inline bool evacuation_failure_alot_for_gc_type(bool for_young_gc,
 811                                                   bool during_initial_mark,
 812                                                   bool mark_or_rebuild_in_progress);
 813 
 814   inline void set_evacuation_failure_alot_for_current_gc();
 815 
 816   // Return true if it&#39;s time to cause an evacuation failure.
 817   inline bool evacuation_should_fail();
 818 
 819   // Reset the G1EvacuationFailureALot counters.  Should be called at
 820   // the end of an evacuation pause in which an evacuation failure occurred.
 821   inline void reset_evacuation_should_fail();
 822 #endif // !PRODUCT
 823 
 824   // (&quot;Weak&quot;) Reference processing support.
 825   //
 826   // G1 has 2 instances of the reference processor class. One
 827   // (_ref_processor_cm) handles reference object discovery
 828   // and subsequent processing during concurrent marking cycles.
 829   //
 830   // The other (_ref_processor_stw) handles reference object
 831   // discovery and processing during full GCs and incremental
 832   // evacuation pauses.
 833   //
 834   // During an incremental pause, reference discovery will be
 835   // temporarily disabled for _ref_processor_cm and will be
 836   // enabled for _ref_processor_stw. At the end of the evacuation
 837   // pause references discovered by _ref_processor_stw will be
 838   // processed and discovery will be disabled. The previous
 839   // setting for reference object discovery for _ref_processor_cm
 840   // will be re-instated.
 841   //
 842   // At the start of marking:
 843   //  * Discovery by the CM ref processor is verified to be inactive
 844   //    and it&#39;s discovered lists are empty.
 845   //  * Discovery by the CM ref processor is then enabled.
 846   //
 847   // At the end of marking:
 848   //  * Any references on the CM ref processor&#39;s discovered
 849   //    lists are processed (possibly MT).
 850   //
 851   // At the start of full GC we:
 852   //  * Disable discovery by the CM ref processor and
 853   //    empty CM ref processor&#39;s discovered lists
 854   //    (without processing any entries).
 855   //  * Verify that the STW ref processor is inactive and it&#39;s
 856   //    discovered lists are empty.
 857   //  * Temporarily set STW ref processor discovery as single threaded.
 858   //  * Temporarily clear the STW ref processor&#39;s _is_alive_non_header
 859   //    field.
 860   //  * Finally enable discovery by the STW ref processor.
 861   //
 862   // The STW ref processor is used to record any discovered
 863   // references during the full GC.
 864   //
 865   // At the end of a full GC we:
 866   //  * Enqueue any reference objects discovered by the STW ref processor
 867   //    that have non-live referents. This has the side-effect of
 868   //    making the STW ref processor inactive by disabling discovery.
 869   //  * Verify that the CM ref processor is still inactive
 870   //    and no references have been placed on it&#39;s discovered
 871   //    lists (also checked as a precondition during initial marking).
 872 
 873   // The (stw) reference processor...
 874   ReferenceProcessor* _ref_processor_stw;
 875 
 876   // During reference object discovery, the _is_alive_non_header
 877   // closure (if non-null) is applied to the referent object to
 878   // determine whether the referent is live. If so then the
 879   // reference object does not need to be &#39;discovered&#39; and can
 880   // be treated as a regular oop. This has the benefit of reducing
 881   // the number of &#39;discovered&#39; reference objects that need to
 882   // be processed.
 883   //
 884   // Instance of the is_alive closure for embedding into the
 885   // STW reference processor as the _is_alive_non_header field.
 886   // Supplying a value for the _is_alive_non_header field is
 887   // optional but doing so prevents unnecessary additions to
 888   // the discovered lists during reference discovery.
 889   G1STWIsAliveClosure _is_alive_closure_stw;
 890 
 891   G1STWSubjectToDiscoveryClosure _is_subject_to_discovery_stw;
 892 
 893   // The (concurrent marking) reference processor...
 894   ReferenceProcessor* _ref_processor_cm;
 895 
 896   // Instance of the concurrent mark is_alive closure for embedding
 897   // into the Concurrent Marking reference processor as the
 898   // _is_alive_non_header field. Supplying a value for the
 899   // _is_alive_non_header field is optional but doing so prevents
 900   // unnecessary additions to the discovered lists during reference
 901   // discovery.
 902   G1CMIsAliveClosure _is_alive_closure_cm;
 903 
 904   G1CMSubjectToDiscoveryClosure _is_subject_to_discovery_cm;
 905 public:
 906 
 907   RefToScanQueue *task_queue(uint i) const;
 908 
 909   uint num_task_queues() const;
 910 
<a name="48" id="anc48"></a><span class="line-modified"> 911   // A set of cards where updates happened during the GC</span>
<span class="line-removed"> 912   G1DirtyCardQueueSet&amp; dirty_card_queue_set() { return _dirty_card_queue_set; }</span>
<span class="line-removed"> 913 </span>
<span class="line-removed"> 914   // Create a G1CollectedHeap with the specified policy.</span>
 915   // Must call the initialize method afterwards.
 916   // May not return if something goes wrong.
<a name="49" id="anc49"></a><span class="line-modified"> 917   G1CollectedHeap(G1CollectorPolicy* policy);</span>
 918 
 919 private:
 920   jint initialize_concurrent_refinement();
 921   jint initialize_young_gen_sampling_thread();
 922 public:
 923   // Initialize the G1CollectedHeap to have the initial and
 924   // maximum sizes and remembered and barrier sets
 925   // specified by the policy object.
 926   jint initialize();
 927 
 928   virtual void stop();
 929   virtual void safepoint_synchronize_begin();
 930   virtual void safepoint_synchronize_end();
 931 
<a name="50" id="anc50"></a><span class="line-removed"> 932   // Return the (conservative) maximum heap alignment for any G1 heap</span>
<span class="line-removed"> 933   static size_t conservative_max_heap_alignment();</span>
<span class="line-removed"> 934 </span>
 935   // Does operations required after initialization has been done.
 936   void post_initialize();
 937 
 938   // Initialize weak reference processing.
 939   void ref_processing_init();
 940 
 941   virtual Name kind() const {
 942     return CollectedHeap::G1;
 943   }
 944 
 945   virtual const char* name() const {
 946     return &quot;G1&quot;;
 947   }
 948 
 949   const G1CollectorState* collector_state() const { return &amp;_collector_state; }
 950   G1CollectorState* collector_state() { return &amp;_collector_state; }
 951 
 952   // The current policy object for the collector.
 953   G1Policy* policy() const { return _policy; }
 954   // The remembered set.
 955   G1RemSet* rem_set() const { return _rem_set; }
 956 
 957   inline G1GCPhaseTimes* phase_times() const;
 958 
 959   HeapRegionManager* hrm() const { return _hrm; }
 960 
 961   const G1CollectionSet* collection_set() const { return &amp;_collection_set; }
 962   G1CollectionSet* collection_set() { return &amp;_collection_set; }
 963 
<a name="51" id="anc51"></a><span class="line-removed"> 964   virtual CollectorPolicy* collector_policy() const;</span>
<span class="line-removed"> 965 </span>
 966   virtual SoftRefPolicy* soft_ref_policy();
 967 
 968   virtual void initialize_serviceability();
 969   virtual MemoryUsage memory_usage();
 970   virtual GrowableArray&lt;GCMemoryManager*&gt; memory_managers();
 971   virtual GrowableArray&lt;MemoryPool*&gt; memory_pools();
 972 
 973   // Try to minimize the remembered set.
 974   void scrub_rem_set();
 975 
 976   // Apply the given closure on all cards in the Hot Card Cache, emptying it.
<a name="52" id="anc52"></a><span class="line-modified"> 977   void iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_i);</span>
<span class="line-removed"> 978 </span>
<span class="line-removed"> 979   // Apply the given closure on all cards in the Dirty Card Queue Set, emptying it.</span>
<span class="line-removed"> 980   void iterate_dirty_card_closure(G1CardTableEntryClosure* cl, uint worker_i);</span>
 981 
 982   // The shared block offset table array.
 983   G1BlockOffsetTable* bot() const { return _bot; }
 984 
 985   // Reference Processing accessors
 986 
 987   // The STW reference processor....
 988   ReferenceProcessor* ref_processor_stw() const { return _ref_processor_stw; }
 989 
 990   G1NewTracer* gc_tracer_stw() const { return _gc_tracer_stw; }
 991 
 992   // The Concurrent Marking reference processor...
 993   ReferenceProcessor* ref_processor_cm() const { return _ref_processor_cm; }
 994 
 995   size_t unused_committed_regions_in_bytes() const;
<a name="53" id="anc53"></a>
 996   virtual size_t capacity() const;
 997   virtual size_t used() const;
 998   // This should be called when we&#39;re not holding the heap lock. The
 999   // result might be a bit inaccurate.
1000   size_t used_unlocked() const;
1001   size_t recalculate_used() const;
1002 
1003   // These virtual functions do the actual allocation.
1004   // Some heaps may offer a contiguous region for shared non-blocking
1005   // allocation, via inlined code (by exporting the address of the top and
1006   // end fields defining the extent of the contiguous allocation region.)
1007   // But G1CollectedHeap doesn&#39;t yet support this.
1008 
1009   virtual bool is_maximal_no_gc() const {
1010     return _hrm-&gt;available() == 0;
1011   }
1012 
1013   // Returns whether there are any regions left in the heap for allocation.
1014   bool has_regions_left_for_allocation() const {
1015     return !is_maximal_no_gc() || num_free_regions() != 0;
1016   }
1017 
1018   // The current number of regions in the heap.
1019   uint num_regions() const { return _hrm-&gt;length(); }
1020 
1021   // The max number of regions in the heap.
1022   uint max_regions() const { return _hrm-&gt;max_length(); }
1023 
1024   // Max number of regions that can be comitted.
1025   uint max_expandable_regions() const { return _hrm-&gt;max_expandable_length(); }
1026 
1027   // The number of regions that are completely free.
1028   uint num_free_regions() const { return _hrm-&gt;num_free_regions(); }
1029 
1030   // The number of regions that can be allocated into.
1031   uint num_free_or_available_regions() const { return num_free_regions() + _hrm-&gt;available(); }
1032 
1033   MemoryUsage get_auxiliary_data_memory_usage() const {
1034     return _hrm-&gt;get_auxiliary_data_memory_usage();
1035   }
1036 
1037   // The number of regions that are not completely free.
1038   uint num_used_regions() const { return num_regions() - num_free_regions(); }
1039 
1040 #ifdef ASSERT
1041   bool is_on_master_free_list(HeapRegion* hr) {
1042     return _hrm-&gt;is_free(hr);
1043   }
1044 #endif // ASSERT
1045 
1046   inline void old_set_add(HeapRegion* hr);
1047   inline void old_set_remove(HeapRegion* hr);
1048 
1049   inline void archive_set_add(HeapRegion* hr);
1050 
1051   size_t non_young_capacity_bytes() {
1052     return (old_regions_count() + _archive_set.length() + humongous_regions_count()) * HeapRegion::GrainBytes;
1053   }
1054 
1055   // Determine whether the given region is one that we are using as an
1056   // old GC alloc region.
1057   bool is_old_gc_alloc_region(HeapRegion* hr);
1058 
1059   // Perform a collection of the heap; intended for use in implementing
1060   // &quot;System.gc&quot;.  This probably implies as full a collection as the
1061   // &quot;CollectedHeap&quot; supports.
1062   virtual void collect(GCCause::Cause cause);
1063 
<a name="54" id="anc54"></a><span class="line-modified">1064   // Perform a collection of the heap with the given cause; if the VM operation</span>
<span class="line-removed">1065   // fails to execute for any reason, retry only if retry_on_gc_failure is set.</span>
1066   // Returns whether this collection actually executed.
<a name="55" id="anc55"></a><span class="line-modified">1067   bool try_collect(GCCause::Cause cause, bool retry_on_gc_failure);</span>
1068 
1069   // True iff an evacuation has failed in the most-recent collection.
1070   bool evacuation_failed() { return _evacuation_failed; }
1071 
1072   void remove_from_old_sets(const uint old_regions_removed, const uint humongous_regions_removed);
1073   void prepend_to_freelist(FreeRegionList* list);
1074   void decrement_summary_bytes(size_t bytes);
1075 
1076   virtual bool is_in(const void* p) const;
1077 #ifdef ASSERT
1078   // Returns whether p is in one of the available areas of the heap. Slow but
1079   // extensive version.
1080   bool is_in_exact(const void* p) const;
1081 #endif
1082 
1083   // Return &quot;TRUE&quot; iff the given object address is within the collection
1084   // set. Assumes that the reference points into the heap.
1085   inline bool is_in_cset(const HeapRegion *hr);
1086   inline bool is_in_cset(oop obj);
1087   inline bool is_in_cset(HeapWord* addr);
1088 
1089   inline bool is_in_cset_or_humongous(const oop obj);
1090 
1091  private:
1092   // This array is used for a quick test on whether a reference points into
1093   // the collection set or not. Each of the array&#39;s elements denotes whether the
1094   // corresponding region is in the collection set or not.
<a name="56" id="anc56"></a><span class="line-modified">1095   G1InCSetStateFastTestBiasedMappedArray _in_cset_fast_test;</span>
1096 
1097  public:
1098 
<a name="57" id="anc57"></a><span class="line-modified">1099   inline InCSetState in_cset_state(const oop obj);</span>

1100 
1101   // Return &quot;TRUE&quot; iff the given object address is in the reserved
1102   // region of g1.
1103   bool is_in_g1_reserved(const void* p) const {
1104     return _hrm-&gt;reserved().contains(p);
1105   }
1106 
1107   // Returns a MemRegion that corresponds to the space that has been
1108   // reserved for the heap
1109   MemRegion g1_reserved() const {
1110     return _hrm-&gt;reserved();
1111   }
1112 
<a name="58" id="anc58"></a><span class="line-modified">1113   virtual bool is_in_closed_subset(const void* p) const;</span>










1114 
<a name="59" id="anc59"></a><span class="line-modified">1115   G1HotCardCache* g1_hot_card_cache() const { return _hot_card_cache; }</span>
1116 
1117   G1CardTable* card_table() const {
1118     return _card_table;
1119   }
1120 
1121   // Iteration functions.
1122 
1123   // Iterate over all objects, calling &quot;cl.do_object&quot; on each.
1124   virtual void object_iterate(ObjectClosure* cl);
1125 
<a name="60" id="anc60"></a><span class="line-modified">1126   virtual void safe_object_iterate(ObjectClosure* cl) {</span>
<span class="line-modified">1127     object_iterate(cl);</span>
<span class="line-removed">1128   }</span>
1129 
1130   // Iterate over heap regions, in address order, terminating the
1131   // iteration early if the &quot;do_heap_region&quot; method returns &quot;true&quot;.
1132   void heap_region_iterate(HeapRegionClosure* blk) const;
1133 
1134   // Return the region with the given index. It assumes the index is valid.
1135   inline HeapRegion* region_at(uint index) const;
1136   inline HeapRegion* region_at_or_null(uint index) const;
1137 
1138   // Return the next region (by index) that is part of the same
1139   // humongous object that hr is part of.
1140   inline HeapRegion* next_region_in_humongous(HeapRegion* hr) const;
1141 
1142   // Calculate the region index of the given address. Given address must be
1143   // within the heap.
1144   inline uint addr_to_region(HeapWord* addr) const;
1145 
1146   inline HeapWord* bottom_addr_for_region(uint index) const;
1147 
1148   // Two functions to iterate over the heap regions in parallel. Threads
1149   // compete using the HeapRegionClaimer to claim the regions before
1150   // applying the closure on them.
1151   // The _from_worker_offset version uses the HeapRegionClaimer and
1152   // the worker id to calculate a start offset to prevent all workers to
1153   // start from the point.
1154   void heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
1155                                                   HeapRegionClaimer* hrclaimer,
1156                                                   uint worker_id) const;
1157 
1158   void heap_region_par_iterate_from_start(HeapRegionClosure* cl,
1159                                           HeapRegionClaimer* hrclaimer) const;
1160 
<a name="61" id="anc61"></a><span class="line-modified">1161   // Iterate over the regions (if any) in the current collection set.</span>
<span class="line-modified">1162   void collection_set_iterate(HeapRegionClosure* blk);</span>
<span class="line-modified">1163 </span>
<span class="line-modified">1164   // Iterate over the regions (if any) in the current collection set. Starts the</span>
<span class="line-modified">1165   // iteration over the entire collection set so that the start regions of a given</span>
<span class="line-modified">1166   // worker id over the set active_workers are evenly spread across the set of</span>
<span class="line-modified">1167   // collection set regions.</span>
<span class="line-modified">1168   void collection_set_iterate_from(HeapRegionClosure *blk, uint worker_id);</span>










1169 
1170   // Returns the HeapRegion that contains addr. addr must not be NULL.
1171   template &lt;class T&gt;
1172   inline HeapRegion* heap_region_containing(const T addr) const;
1173 
1174   // Returns the HeapRegion that contains addr, or NULL if that is an uncommitted
1175   // region. addr must not be NULL.
1176   template &lt;class T&gt;
1177   inline HeapRegion* heap_region_containing_or_null(const T addr) const;
1178 
1179   // A CollectedHeap is divided into a dense sequence of &quot;blocks&quot;; that is,
1180   // each address in the (reserved) heap is a member of exactly
1181   // one block.  The defining characteristic of a block is that it is
1182   // possible to find its size, and thus to progress forward to the next
1183   // block.  (Blocks may be of different sizes.)  Thus, blocks may
1184   // represent Java objects, or they might be free blocks in a
1185   // free-list-based heap (or subheap), as long as the two kinds are
1186   // distinguishable and the size of each is determinable.
1187 
1188   // Returns the address of the start of the &quot;block&quot; that contains the
1189   // address &quot;addr&quot;.  We say &quot;blocks&quot; instead of &quot;object&quot; since some heaps
1190   // may not pack objects densely; a chunk may either be an object or a
1191   // non-object.
<a name="62" id="anc62"></a><span class="line-modified">1192   virtual HeapWord* block_start(const void* addr) const;</span>
1193 
1194   // Requires &quot;addr&quot; to be the start of a block, and returns &quot;TRUE&quot; iff
1195   // the block is an object.
<a name="63" id="anc63"></a><span class="line-modified">1196   virtual bool block_is_obj(const HeapWord* addr) const;</span>
1197 
1198   // Section on thread-local allocation buffers (TLABs)
1199   // See CollectedHeap for semantics.
1200 
1201   bool supports_tlab_allocation() const;
1202   size_t tlab_capacity(Thread* ignored) const;
1203   size_t tlab_used(Thread* ignored) const;
1204   size_t max_tlab_size() const;
1205   size_t unsafe_max_tlab_alloc(Thread* ignored) const;
1206 
1207   inline bool is_in_young(const oop obj);
1208 
1209   // Returns &quot;true&quot; iff the given word_size is &quot;very large&quot;.
1210   static bool is_humongous(size_t word_size) {
1211     // Note this has to be strictly greater-than as the TLABs
1212     // are capped at the humongous threshold and we want to
1213     // ensure that we don&#39;t try to allocate a TLAB as
1214     // humongous and that we don&#39;t allocate a humongous
1215     // object in a TLAB.
1216     return word_size &gt; _humongous_object_threshold_in_words;
1217   }
1218 
1219   // Returns the humongous threshold for a specific region size
1220   static size_t humongous_threshold_for(size_t region_size) {
1221     return (region_size / 2);
1222   }
1223 
1224   // Returns the number of regions the humongous object of the given word size
1225   // requires.
1226   static size_t humongous_obj_size_in_regions(size_t word_size);
1227 
1228   // Print the maximum heap capacity.
1229   virtual size_t max_capacity() const;
1230 
1231   // Return the size of reserved memory. Returns different value than max_capacity() when AllocateOldGenAt is used.
1232   virtual size_t max_reserved_capacity() const;
1233 
1234   virtual jlong millis_since_last_gc();
1235 
1236 
1237   // Convenience function to be used in situations where the heap type can be
1238   // asserted to be this type.
1239   static G1CollectedHeap* heap();
1240 
1241   void set_region_short_lived_locked(HeapRegion* hr);
1242   // add appropriate methods for any other surv rate groups
1243 
1244   const G1SurvivorRegions* survivor() const { return &amp;_survivor; }
1245 
1246   uint eden_regions_count() const { return _eden.length(); }
<a name="64" id="anc64"></a>
1247   uint survivor_regions_count() const { return _survivor.length(); }
<a name="65" id="anc65"></a>


1248   uint young_regions_count() const { return _eden.length() + _survivor.length(); }
1249   uint old_regions_count() const { return _old_set.length(); }
1250   uint archive_regions_count() const { return _archive_set.length(); }
1251   uint humongous_regions_count() const { return _humongous_set.length(); }
1252 
1253 #ifdef ASSERT
1254   bool check_young_list_empty();
1255 #endif
1256 
1257   // *** Stuff related to concurrent marking.  It&#39;s not clear to me that so
1258   // many of these need to be public.
1259 
1260   // The functions below are helper functions that a subclass of
1261   // &quot;CollectedHeap&quot; can use in the implementation of its virtual
1262   // functions.
1263   // This performs a concurrent marking of the live objects in a
1264   // bitmap off to the side.
1265   void do_concurrent_mark();
1266 
1267   bool is_marked_next(oop obj) const;
1268 
1269   // Determine if an object is dead, given the object and also
1270   // the region to which the object belongs. An object is dead
1271   // iff a) it was not allocated since the last mark, b) it
1272   // is not marked, and c) it is not in an archive region.
1273   bool is_obj_dead(const oop obj, const HeapRegion* hr) const {
1274     return
1275       hr-&gt;is_obj_dead(obj, _cm-&gt;prev_mark_bitmap()) &amp;&amp;
1276       !hr-&gt;is_archive();
1277   }
1278 
1279   // This function returns true when an object has been
1280   // around since the previous marking and hasn&#39;t yet
1281   // been marked during this marking, and is not in an archive region.
1282   bool is_obj_ill(const oop obj, const HeapRegion* hr) const {
1283     return
1284       !hr-&gt;obj_allocated_since_next_marking(obj) &amp;&amp;
1285       !is_marked_next(obj) &amp;&amp;
1286       !hr-&gt;is_archive();
1287   }
1288 
1289   // Determine if an object is dead, given only the object itself.
1290   // This will find the region to which the object belongs and
1291   // then call the region version of the same function.
1292 
1293   // Added if it is NULL it isn&#39;t dead.
1294 
1295   inline bool is_obj_dead(const oop obj) const;
1296 
1297   inline bool is_obj_ill(const oop obj) const;
1298 
1299   inline bool is_obj_dead_full(const oop obj, const HeapRegion* hr) const;
1300   inline bool is_obj_dead_full(const oop obj) const;
1301 
1302   G1ConcurrentMark* concurrent_mark() const { return _cm; }
1303 
1304   // Refinement
1305 
1306   G1ConcurrentRefine* concurrent_refine() const { return _cr; }
1307 
1308   // Optimized nmethod scanning support routines
1309 
1310   // Register the given nmethod with the G1 heap.
1311   virtual void register_nmethod(nmethod* nm);
1312 
1313   // Unregister the given nmethod from the G1 heap.
1314   virtual void unregister_nmethod(nmethod* nm);
1315 
<a name="66" id="anc66"></a>





1316   // Free up superfluous code root memory.
1317   void purge_code_root_memory();
1318 
1319   // Rebuild the strong code root lists for each region
1320   // after a full GC.
1321   void rebuild_strong_code_roots();
1322 
1323   // Partial cleaning of VM internal data structures.
1324   void string_dedup_cleaning(BoolObjectClosure* is_alive,
1325                              OopClosure* keep_alive,
1326                              G1GCPhaseTimes* phase_times = NULL);
1327 
1328   // Performs cleaning of data structures after class unloading.
1329   void complete_cleaning(BoolObjectClosure* is_alive, bool class_unloading_occurred);
1330 
1331   // Redirty logged cards in the refinement queue.
<a name="67" id="anc67"></a><span class="line-modified">1332   void redirty_logged_cards();</span>

1333   // Verification
1334 
1335   // Deduplicate the string
1336   virtual void deduplicate_string(oop str);
1337 
1338   // Perform any cleanup actions necessary before allowing a verification.
1339   virtual void prepare_for_verify();
1340 
1341   // Perform verification.
1342 
1343   // vo == UsePrevMarking -&gt; use &quot;prev&quot; marking information,
1344   // vo == UseNextMarking -&gt; use &quot;next&quot; marking information
1345   // vo == UseFullMarking -&gt; use &quot;next&quot; marking bitmap but no TAMS
1346   //
1347   // NOTE: Only the &quot;prev&quot; marking information is guaranteed to be
1348   // consistent most of the time, so most calls to this should use
1349   // vo == UsePrevMarking.
1350   // Currently, there is only one case where this is called with
1351   // vo == UseNextMarking, which is to verify the &quot;next&quot; marking
1352   // information at the end of remark.
1353   // Currently there is only one place where this is called with
1354   // vo == UseFullMarking, which is to verify the marking during a
1355   // full GC.
1356   void verify(VerifyOption vo);
1357 
1358   // WhiteBox testing support.
1359   virtual bool supports_concurrent_phase_control() const;
1360   virtual bool request_concurrent_phase(const char* phase);
1361   bool is_heterogeneous_heap() const;
1362 
1363   virtual WorkGang* get_safepoint_workers() { return _workers; }
1364 
1365   // The methods below are here for convenience and dispatch the
1366   // appropriate method depending on value of the given VerifyOption
1367   // parameter. The values for that parameter, and their meanings,
1368   // are the same as those above.
1369 
1370   bool is_obj_dead_cond(const oop obj,
1371                         const HeapRegion* hr,
1372                         const VerifyOption vo) const;
1373 
1374   bool is_obj_dead_cond(const oop obj,
1375                         const VerifyOption vo) const;
1376 
1377   G1HeapSummary create_g1_heap_summary();
1378   G1EvacSummary create_g1_evac_summary(G1EvacStats* stats);
1379 
1380   // Printing
1381 private:
1382   void print_heap_regions() const;
1383   void print_regions_on(outputStream* st) const;
1384 
1385 public:
1386   virtual void print_on(outputStream* st) const;
1387   virtual void print_extended_on(outputStream* st) const;
1388   virtual void print_on_error(outputStream* st) const;
1389 
1390   virtual void print_gc_threads_on(outputStream* st) const;
1391   virtual void gc_threads_do(ThreadClosure* tc) const;
1392 
1393   // Override
1394   void print_tracing_info() const;
1395 
1396   // The following two methods are helpful for debugging RSet issues.
1397   void print_cset_rsets() PRODUCT_RETURN;
1398   void print_all_rsets() PRODUCT_RETURN;
1399 
<a name="68" id="anc68"></a>


1400   size_t pending_card_num();
1401 };
1402 
1403 class G1ParEvacuateFollowersClosure : public VoidClosure {
1404 private:
1405   double _start_term;
1406   double _term_time;
1407   size_t _term_attempts;
1408 
1409   void start_term_time() { _term_attempts++; _start_term = os::elapsedTime(); }
<a name="69" id="anc69"></a><span class="line-modified">1410   void end_term_time() { _term_time += os::elapsedTime() - _start_term; }</span>
1411 protected:
1412   G1CollectedHeap*              _g1h;
1413   G1ParScanThreadState*         _par_scan_state;
1414   RefToScanQueueSet*            _queues;
<a name="70" id="anc70"></a><span class="line-modified">1415   ParallelTaskTerminator*       _terminator;</span>
1416   G1GCPhaseTimes::GCParPhases   _phase;
1417 
1418   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
1419   RefToScanQueueSet*      queues()         { return _queues; }
<a name="71" id="anc71"></a><span class="line-modified">1420   ParallelTaskTerminator* terminator()     { return _terminator; }</span>
1421 
1422 public:
1423   G1ParEvacuateFollowersClosure(G1CollectedHeap* g1h,
1424                                 G1ParScanThreadState* par_scan_state,
1425                                 RefToScanQueueSet* queues,
<a name="72" id="anc72"></a><span class="line-modified">1426                                 ParallelTaskTerminator* terminator,</span>
1427                                 G1GCPhaseTimes::GCParPhases phase)
1428     : _start_term(0.0), _term_time(0.0), _term_attempts(0),
1429       _g1h(g1h), _par_scan_state(par_scan_state),
1430       _queues(queues), _terminator(terminator), _phase(phase) {}
1431 
1432   void do_void();
1433 
1434   double term_time() const { return _term_time; }
1435   size_t term_attempts() const { return _term_attempts; }
1436 
1437 private:
1438   inline bool offer_termination();
1439 };
1440 
1441 #endif // SHARE_GC_G1_G1COLLECTEDHEAP_HPP
<a name="73" id="anc73"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="73" type="hidden" />
</body>
</html>