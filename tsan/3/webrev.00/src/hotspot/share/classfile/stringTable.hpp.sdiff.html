<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/stringTable.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="stringTable.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="symbolTable.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/stringTable.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_STRINGTABLE_HPP
 26 #define SHARE_CLASSFILE_STRINGTABLE_HPP
 27 
<span class="line-removed"> 28 #include &quot;gc/shared/oopStorage.hpp&quot;</span>
<span class="line-removed"> 29 #include &quot;gc/shared/oopStorageParState.hpp&quot;</span>
 30 #include &quot;memory/allocation.hpp&quot;
 31 #include &quot;memory/padded.hpp&quot;
 32 #include &quot;oops/oop.hpp&quot;
 33 #include &quot;oops/weakHandle.hpp&quot;
<span class="line-modified"> 34 #include &quot;utilities/concurrentHashTable.hpp&quot;</span>
 35 
 36 class CompactHashtableWriter;

 37 class SerializeClosure;
 38 
 39 class StringTable;
 40 class StringTableConfig;
<span class="line-removed"> 41 typedef ConcurrentHashTable&lt;WeakHandle&lt;vm_string_table_data&gt;,</span>
<span class="line-removed"> 42                             StringTableConfig, mtSymbol&gt; StringTableHash;</span>
<span class="line-removed"> 43 </span>
 44 class StringTableCreateEntry;
 45 
 46 class StringTable : public CHeapObj&lt;mtSymbol&gt;{
 47   friend class VMStructs;
 48   friend class Symbol;
 49   friend class StringTableConfig;
 50   friend class StringTableCreateEntry;
 51 
<span class="line-modified"> 52 private:</span>
<span class="line-modified"> 53   void grow(JavaThread* jt);</span>
<span class="line-removed"> 54   void clean_dead_entries(JavaThread* jt);</span>
<span class="line-removed"> 55 </span>
<span class="line-removed"> 56   // The string table</span>
<span class="line-removed"> 57   static StringTable* _the_table;</span>
<span class="line-removed"> 58   static volatile bool _alt_hash;</span>
 59 
<span class="line-removed"> 60 private:</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62   StringTableHash* _local_table;</span>
<span class="line-removed"> 63   size_t _current_size;</span>
<span class="line-removed"> 64   volatile bool _has_work;</span>
 65   // Set if one bucket is out of balance due to hash algorithm deficiency
<span class="line-modified"> 66   volatile bool _needs_rehashing;</span>
<span class="line-removed"> 67 </span>
<span class="line-removed"> 68   OopStorage* _weak_handles;</span>
 69 
<span class="line-modified"> 70   volatile size_t _items_count;</span>
<span class="line-modified"> 71   DEFINE_PAD_MINUS_SIZE(1, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile size_t));</span>
<span class="line-removed"> 72   volatile size_t _uncleaned_items_count;</span>
<span class="line-removed"> 73   DEFINE_PAD_MINUS_SIZE(2, DEFAULT_CACHE_LINE_SIZE, sizeof(volatile size_t));</span>
 74 
<span class="line-modified"> 75   double get_load_factor() const;</span>
<span class="line-modified"> 76   double get_dead_factor() const;</span>
 77 
<span class="line-modified"> 78   void check_concurrent_work();</span>
<span class="line-modified"> 79   void trigger_concurrent_work();</span>
 80 
 81   static size_t item_added();
 82   static void item_removed();
<span class="line-modified"> 83   size_t add_items_to_clean(size_t ndead);</span>
<span class="line-removed"> 84 </span>
<span class="line-removed"> 85   StringTable();</span>
 86 
 87   static oop intern(Handle string_or_null_h, const jchar* name, int len, TRAPS);
<span class="line-modified"> 88   oop do_intern(Handle string_or_null, const jchar* name, int len, uintx hash, TRAPS);</span>
<span class="line-modified"> 89   oop do_lookup(const jchar* name, int len, uintx hash);</span>
 90 
<span class="line-modified"> 91   void concurrent_work(JavaThread* jt);</span>
<span class="line-removed"> 92   void print_table_statistics(outputStream* st, const char* table_name);</span>
 93 
<span class="line-modified"> 94   void try_rehash_table();</span>
<span class="line-removed"> 95   bool do_rehash();</span>
<span class="line-removed"> 96   inline void update_needs_rehash(bool rehash);</span>
 97 
 98  public:
<span class="line-modified"> 99   // The string table</span>
<span class="line-modified">100   static StringTable* the_table() { return _the_table; }</span>
<span class="line-removed">101   size_t table_size();</span>
<span class="line-removed">102 </span>
<span class="line-removed">103   static OopStorage* weak_storage() { return the_table()-&gt;_weak_handles; }</span>
104 
<span class="line-modified">105   static void create_table() {</span>
<span class="line-removed">106     assert(_the_table == NULL, &quot;One string table allowed.&quot;);</span>
<span class="line-removed">107     _the_table = new StringTable();</span>
<span class="line-removed">108   }</span>
109 
110   static void do_concurrent_work(JavaThread* jt);
<span class="line-modified">111   static bool has_work() { return the_table()-&gt;_has_work; }</span>
112 
113   // GC support
114 
115   // Must be called before a parallel walk where strings might die.
<span class="line-modified">116   static void reset_dead_counter() {</span>
<span class="line-modified">117     the_table()-&gt;_uncleaned_items_count = 0;</span>
<span class="line-removed">118   }</span>
119   // After the parallel walk this method must be called to trigger
120   // cleaning. Note it might trigger a resize instead.
<span class="line-modified">121   static void finish_dead_counter() {</span>
<span class="line-removed">122     the_table()-&gt;check_concurrent_work();</span>
<span class="line-removed">123   }</span>
124 
125   // If GC uses ParState directly it should add the number of cleared
126   // strings to this method.
<span class="line-modified">127   static void inc_dead_counter(size_t ndead) {</span>
<span class="line-removed">128     the_table()-&gt;add_items_to_clean(ndead);</span>
<span class="line-removed">129   }</span>
<span class="line-removed">130 </span>
<span class="line-removed">131   // Serially invoke &quot;f-&gt;do_oop&quot; on the locations of all oops in the table.</span>
<span class="line-removed">132   static void oops_do(OopClosure* f);</span>
<span class="line-removed">133 </span>
<span class="line-removed">134   // Possibly parallel versions of the above</span>
<span class="line-removed">135   static void possibly_parallel_oops_do(</span>
<span class="line-removed">136      OopStorage::ParState&lt;false /* concurrent */, false /* const*/&gt;* par_state_string,</span>
<span class="line-removed">137      OopClosure* f);</span>
138 
139   // Probing
140   static oop lookup(Symbol* symbol);
141   static oop lookup(const jchar* chars, int length);
142 
143   // Interning
144   static oop intern(Symbol* symbol, TRAPS);
145   static oop intern(oop string, TRAPS);
146   static oop intern(const char *utf8_string, TRAPS);
147 
148   // Rehash the string table if it gets out of balance
149   static void rehash_table();
<span class="line-modified">150   static bool needs_rehashing()</span>
<span class="line-modified">151     { return StringTable::the_table()-&gt;_needs_rehashing; }</span>




152 
153   // Sharing
154  private:
<span class="line-modified">155   oop lookup_shared(const jchar* name, int len, unsigned int hash) NOT_CDS_JAVA_HEAP_RETURN_(NULL);</span>
156   static void copy_shared_string_table(CompactHashtableWriter* ch_table) NOT_CDS_JAVA_HEAP_RETURN;
157  public:
158   static oop create_archived_string(oop s, Thread* THREAD) NOT_CDS_JAVA_HEAP_RETURN_(NULL);
159   static void shared_oops_do(OopClosure* f) NOT_CDS_JAVA_HEAP_RETURN;
160   static void write_to_archive() NOT_CDS_JAVA_HEAP_RETURN;
161   static void serialize_shared_table_header(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;
162 
163   // Jcmd
164   static void dump(outputStream* st, bool verbose=false);
165   // Debugging
166   static size_t verify_and_compare_entries();
167   static void verify();
168 };
169 
170 #endif // SHARE_CLASSFILE_STRINGTABLE_HPP
</pre>
</td>
<td>
<hr />
<pre>
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_STRINGTABLE_HPP
 26 #define SHARE_CLASSFILE_STRINGTABLE_HPP
 27 


 28 #include &quot;memory/allocation.hpp&quot;
 29 #include &quot;memory/padded.hpp&quot;
 30 #include &quot;oops/oop.hpp&quot;
 31 #include &quot;oops/weakHandle.hpp&quot;
<span class="line-modified"> 32 #include &quot;utilities/tableStatistics.hpp&quot;</span>
 33 
 34 class CompactHashtableWriter;
<span class="line-added"> 35 class JavaThread;</span>
 36 class SerializeClosure;
 37 
 38 class StringTable;
 39 class StringTableConfig;



 40 class StringTableCreateEntry;
 41 
 42 class StringTable : public CHeapObj&lt;mtSymbol&gt;{
 43   friend class VMStructs;
 44   friend class Symbol;
 45   friend class StringTableConfig;
 46   friend class StringTableCreateEntry;
 47 
<span class="line-modified"> 48   static volatile bool _has_work;</span>
<span class="line-modified"> 49   static volatile size_t _uncleaned_items_count;</span>





 50 





 51   // Set if one bucket is out of balance due to hash algorithm deficiency
<span class="line-modified"> 52   static volatile bool _needs_rehashing;</span>


 53 
<span class="line-modified"> 54   static void grow(JavaThread* jt);</span>
<span class="line-modified"> 55   static void clean_dead_entries(JavaThread* jt);</span>


 56 
<span class="line-modified"> 57   static double get_load_factor();</span>
<span class="line-modified"> 58   static double get_dead_factor();</span>
 59 
<span class="line-modified"> 60   static void check_concurrent_work();</span>
<span class="line-modified"> 61   static void trigger_concurrent_work();</span>
 62 
 63   static size_t item_added();
 64   static void item_removed();
<span class="line-modified"> 65   static size_t add_items_to_clean(size_t ndead);</span>


 66 
 67   static oop intern(Handle string_or_null_h, const jchar* name, int len, TRAPS);
<span class="line-modified"> 68   static oop do_intern(Handle string_or_null, const jchar* name, int len, uintx hash, TRAPS);</span>
<span class="line-modified"> 69   static oop do_lookup(const jchar* name, int len, uintx hash);</span>
 70 
<span class="line-modified"> 71   static void print_table_statistics(outputStream* st, const char* table_name);</span>

 72 
<span class="line-modified"> 73   static bool do_rehash();</span>


 74 
 75  public:
<span class="line-modified"> 76   static size_t table_size();</span>
<span class="line-modified"> 77   static TableStatistics get_table_statistics();</span>



 78 
<span class="line-modified"> 79   static void create_table();</span>



 80 
 81   static void do_concurrent_work(JavaThread* jt);
<span class="line-modified"> 82   static bool has_work() { return _has_work; }</span>
 83 
 84   // GC support
 85 
 86   // Must be called before a parallel walk where strings might die.
<span class="line-modified"> 87   static void reset_dead_counter() { _uncleaned_items_count = 0; }</span>
<span class="line-modified"> 88 </span>

 89   // After the parallel walk this method must be called to trigger
 90   // cleaning. Note it might trigger a resize instead.
<span class="line-modified"> 91   static void finish_dead_counter() { check_concurrent_work(); }</span>


 92 
 93   // If GC uses ParState directly it should add the number of cleared
 94   // strings to this method.
<span class="line-modified"> 95   static void inc_dead_counter(size_t ndead) { add_items_to_clean(ndead); }</span>










 96 
 97   // Probing
 98   static oop lookup(Symbol* symbol);
 99   static oop lookup(const jchar* chars, int length);
100 
101   // Interning
102   static oop intern(Symbol* symbol, TRAPS);
103   static oop intern(oop string, TRAPS);
104   static oop intern(const char *utf8_string, TRAPS);
105 
106   // Rehash the string table if it gets out of balance
107   static void rehash_table();
<span class="line-modified">108   static bool needs_rehashing() { return _needs_rehashing; }</span>
<span class="line-modified">109   static inline void update_needs_rehash(bool rehash) {</span>
<span class="line-added">110     if (rehash) {</span>
<span class="line-added">111       _needs_rehashing = true;</span>
<span class="line-added">112     }</span>
<span class="line-added">113   }</span>
114 
115   // Sharing
116  private:
<span class="line-modified">117   static oop lookup_shared(const jchar* name, int len, unsigned int hash) NOT_CDS_JAVA_HEAP_RETURN_(NULL);</span>
118   static void copy_shared_string_table(CompactHashtableWriter* ch_table) NOT_CDS_JAVA_HEAP_RETURN;
119  public:
120   static oop create_archived_string(oop s, Thread* THREAD) NOT_CDS_JAVA_HEAP_RETURN_(NULL);
121   static void shared_oops_do(OopClosure* f) NOT_CDS_JAVA_HEAP_RETURN;
122   static void write_to_archive() NOT_CDS_JAVA_HEAP_RETURN;
123   static void serialize_shared_table_header(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;
124 
125   // Jcmd
126   static void dump(outputStream* st, bool verbose=false);
127   // Debugging
128   static size_t verify_and_compare_entries();
129   static void verify();
130 };
131 
132 #endif // SHARE_CLASSFILE_STRINGTABLE_HPP
</pre>
</td>
</tr>
</table>
<center><a href="stringTable.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="symbolTable.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>