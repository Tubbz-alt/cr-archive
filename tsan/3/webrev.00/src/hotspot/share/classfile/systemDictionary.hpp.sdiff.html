<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/systemDictionary.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="systemDictionary.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionary.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 26 #define SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 27 
<span class="line-modified"> 28 #include &quot;classfile/classLoader.hpp&quot;</span>
<span class="line-removed"> 29 #include &quot;jvmci/systemDictionary_jvmci.hpp&quot;</span>
 30 #include &quot;oops/objArrayOop.hpp&quot;
 31 #include &quot;oops/symbol.hpp&quot;
 32 #include &quot;runtime/java.hpp&quot;

 33 #include &quot;runtime/reflectionUtils.hpp&quot;
 34 #include &quot;runtime/signature.hpp&quot;
 35 #include &quot;utilities/hashtable.hpp&quot;
 36 
 37 // The dictionary in each ClassLoaderData stores all loaded classes, either
 38 // initiatied by its class loader or defined by its class loader:
 39 //
 40 //   class loader -&gt; ClassLoaderData -&gt; [class, protection domain set]
 41 //
 42 // Classes are loaded lazily. The default VM class loader is
 43 // represented as NULL.
 44 
 45 // The underlying data structure is an open hash table (Dictionary) per
 46 // ClassLoaderData with a fixed number of buckets. During loading the
 47 // class loader object is locked, (for the VM loader a private lock object is used).
 48 // The global SystemDictionary_lock is held for all additions into the ClassLoaderData
 49 // dictionaries.  TODO: fix lock granularity so that class loading can
 50 // be done concurrently, but only by different loaders.
 51 //
 52 // During loading a placeholder (name, loader) is temporarily placed in
</pre>
<hr />
<pre>
 56 //
 57 // When class loading is finished, a new entry is added to the dictionary
 58 // of the class loader and the placeholder is removed. Note that the protection
 59 // domain field of the dictionary entry has not yet been filled in when
 60 // the &quot;real&quot; dictionary entry is created.
 61 //
 62 // Clients of this class who are interested in finding if a class has
 63 // been completely loaded -- not classes in the process of being loaded --
 64 // can read the dictionary unlocked. This is safe because
 65 //    - entries are only deleted at safepoints
 66 //    - readers cannot come to a safepoint while actively examining
 67 //         an entry  (an entry cannot be deleted from under a reader)
 68 //    - entries must be fully formed before they are available to concurrent
 69 //         readers (we must ensure write ordering)
 70 //
 71 // Note that placeholders are deleted at any time, as they are removed
 72 // when a class is completely loaded. Therefore, readers as well as writers
 73 // of placeholders must hold the SystemDictionary_lock.
 74 //
 75 

 76 class ClassFileStream;
 77 class Dictionary;
 78 class PlaceholderTable;
 79 class LoaderConstraintTable;
 80 template &lt;MEMFLAGS F&gt; class HashtableBucket;
 81 class ResolutionErrorTable;
 82 class SymbolPropertyTable;
 83 class ProtectionDomainCacheTable;
 84 class ProtectionDomainCacheEntry;
 85 class GCTimer;
<span class="line-removed"> 86 class OopStorage;</span>
 87 
 88 #define WK_KLASS_ENUM_NAME(kname)    kname##_knum
 89 
 90 // Certain classes, such as java.lang.Object and java.lang.String,
 91 // are &quot;well-known&quot;, in the sense that no class loader is allowed
 92 // to provide a different definition.
 93 //
 94 // Each well-known class has a short klass name (like object_klass),
 95 // and a vmSymbol name (like java_lang_Object).
 96 //
 97 // The order of these definitions is significant: the classes are
 98 // resolved during early VM start-up by resolve_well_known_classes
 99 // in this order. Changing the order may require careful restructuring
100 // of the VM start-up sequence.
101 //
102 #define WK_KLASSES_DO(do_klass)                                                                                 \
103   /* well-known classes */                                                                                      \
104   do_klass(Object_klass,                                java_lang_Object                                      ) \
105   do_klass(String_klass,                                java_lang_String                                      ) \
106   do_klass(Class_klass,                                 java_lang_Class                                       ) \
107   do_klass(Cloneable_klass,                             java_lang_Cloneable                                   ) \
108   do_klass(ClassLoader_klass,                           java_lang_ClassLoader                                 ) \
109   do_klass(Serializable_klass,                          java_io_Serializable                                  ) \
110   do_klass(System_klass,                                java_lang_System                                      ) \
111   do_klass(Throwable_klass,                             java_lang_Throwable                                   ) \
112   do_klass(Error_klass,                                 java_lang_Error                                       ) \
113   do_klass(ThreadDeath_klass,                           java_lang_ThreadDeath                                 ) \
114   do_klass(Exception_klass,                             java_lang_Exception                                   ) \
115   do_klass(RuntimeException_klass,                      java_lang_RuntimeException                            ) \
116   do_klass(SecurityManager_klass,                       java_lang_SecurityManager                             ) \
117   do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain                        ) \
118   do_klass(AccessControlContext_klass,                  java_security_AccessControlContext                    ) \
119   do_klass(AccessController_klass,                      java_security_AccessController                        ) \
120   do_klass(SecureClassLoader_klass,                     java_security_SecureClassLoader                       ) \
121   do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException                      ) \

122   do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError                        ) \
123   do_klass(LinkageError_klass,                          java_lang_LinkageError                                ) \
124   do_klass(ClassCastException_klass,                    java_lang_ClassCastException                          ) \
125   do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException                         ) \
126   do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError                         ) \
127   do_klass(OutOfMemoryError_klass,                      java_lang_OutOfMemoryError                            ) \
128   do_klass(StackOverflowError_klass,                    java_lang_StackOverflowError                          ) \
129   do_klass(IllegalMonitorStateException_klass,          java_lang_IllegalMonitorStateException                ) \
130   do_klass(Reference_klass,                             java_lang_ref_Reference                               ) \
131                                                                                                                 \
132   /* ref klasses and set reference types */                                                                     \
133   do_klass(SoftReference_klass,                         java_lang_ref_SoftReference                           ) \
134   do_klass(WeakReference_klass,                         java_lang_ref_WeakReference                           ) \
135   do_klass(FinalReference_klass,                        java_lang_ref_FinalReference                          ) \
136   do_klass(PhantomReference_klass,                      java_lang_ref_PhantomReference                        ) \
137   do_klass(Finalizer_klass,                             java_lang_ref_Finalizer                               ) \
138                                                                                                                 \
139   do_klass(Thread_klass,                                java_lang_Thread                                      ) \
140   do_klass(ThreadGroup_klass,                           java_lang_ThreadGroup                                 ) \
141   do_klass(Properties_klass,                            java_util_Properties                                  ) \
142   do_klass(Module_klass,                                java_lang_Module                                      ) \
143   do_klass(reflect_AccessibleObject_klass,              java_lang_reflect_AccessibleObject                    ) \
144   do_klass(reflect_Field_klass,                         java_lang_reflect_Field                               ) \
145   do_klass(reflect_Parameter_klass,                     java_lang_reflect_Parameter                           ) \
146   do_klass(reflect_Method_klass,                        java_lang_reflect_Method                              ) \
147   do_klass(reflect_Constructor_klass,                   java_lang_reflect_Constructor                         ) \
148                                                                                                                 \
149   /* NOTE: needed too early in bootstrapping process to have checks based on JDK version */                     \
150   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
151   do_klass(reflect_MagicAccessorImpl_klass,             reflect_MagicAccessorImpl                             ) \
152   do_klass(reflect_MethodAccessorImpl_klass,            reflect_MethodAccessorImpl                            ) \
153   do_klass(reflect_ConstructorAccessorImpl_klass,       reflect_ConstructorAccessorImpl                       ) \
154   do_klass(reflect_DelegatingClassLoader_klass,         reflect_DelegatingClassLoader                         ) \
155   do_klass(reflect_ConstantPool_klass,                  reflect_ConstantPool                                  ) \
156   do_klass(reflect_UnsafeStaticFieldAccessorImpl_klass, reflect_UnsafeStaticFieldAccessorImpl                 ) \
157   do_klass(reflect_CallerSensitive_klass,               reflect_CallerSensitive                               ) \

158                                                                                                                 \
159   /* support for dynamic typing; it&#39;s OK if these are NULL in earlier JDKs */                                   \
160   do_klass(DirectMethodHandle_klass,                    java_lang_invoke_DirectMethodHandle                   ) \
161   do_klass(MethodHandle_klass,                          java_lang_invoke_MethodHandle                         ) \
162   do_klass(VarHandle_klass,                             java_lang_invoke_VarHandle                            ) \
163   do_klass(MemberName_klass,                            java_lang_invoke_MemberName                           ) \
164   do_klass(ResolvedMethodName_klass,                    java_lang_invoke_ResolvedMethodName                   ) \
165   do_klass(MethodHandleNatives_klass,                   java_lang_invoke_MethodHandleNatives                  ) \
166   do_klass(LambdaForm_klass,                            java_lang_invoke_LambdaForm                           ) \
167   do_klass(MethodType_klass,                            java_lang_invoke_MethodType                           ) \
168   do_klass(BootstrapMethodError_klass,                  java_lang_BootstrapMethodError                        ) \
169   do_klass(CallSite_klass,                              java_lang_invoke_CallSite                             ) \
170   do_klass(Context_klass,                               java_lang_invoke_MethodHandleNatives_CallSiteContext  ) \
171   do_klass(ConstantCallSite_klass,                      java_lang_invoke_ConstantCallSite                     ) \
172   do_klass(MutableCallSite_klass,                       java_lang_invoke_MutableCallSite                      ) \
173   do_klass(VolatileCallSite_klass,                      java_lang_invoke_VolatileCallSite                     ) \
174   /* Note: MethodHandle must be first, and VolatileCallSite last in group */                                    \
175                                                                                                                 \
176   do_klass(AssertionStatusDirectives_klass,             java_lang_AssertionStatusDirectives                   ) \
177   do_klass(StringBuffer_klass,                          java_lang_StringBuffer                                ) \
178   do_klass(StringBuilder_klass,                         java_lang_StringBuilder                               ) \

179   do_klass(internal_Unsafe_klass,                       jdk_internal_misc_Unsafe                              ) \
180   do_klass(module_Modules_klass,                        jdk_internal_module_Modules                           ) \
181                                                                                                                 \
182   /* support for CDS */                                                                                         \
183   do_klass(ByteArrayInputStream_klass,                  java_io_ByteArrayInputStream                          ) \
184   do_klass(URL_klass,                                   java_net_URL                                          ) \
185   do_klass(Jar_Manifest_klass,                          java_util_jar_Manifest                                ) \
186   do_klass(jdk_internal_loader_ClassLoaders_klass,      jdk_internal_loader_ClassLoaders                      ) \
187   do_klass(jdk_internal_loader_ClassLoaders_AppClassLoader_klass,      jdk_internal_loader_ClassLoaders_AppClassLoader) \
188   do_klass(jdk_internal_loader_ClassLoaders_PlatformClassLoader_klass, jdk_internal_loader_ClassLoaders_PlatformClassLoader) \
189   do_klass(CodeSource_klass,                            java_security_CodeSource                              ) \
190                                                                                                                 \
191   do_klass(StackTraceElement_klass,                     java_lang_StackTraceElement                           ) \
192                                                                                                                 \
193   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
194   do_klass(nio_Buffer_klass,                            java_nio_Buffer                                       ) \
195                                                                                                                 \
196   /* Stack Walking */                                                                                           \
197   do_klass(StackWalker_klass,                           java_lang_StackWalker                                 ) \
198   do_klass(AbstractStackWalker_klass,                   java_lang_StackStreamFactory_AbstractStackWalker      ) \
199   do_klass(StackFrameInfo_klass,                        java_lang_StackFrameInfo                              ) \
200   do_klass(LiveStackFrameInfo_klass,                    java_lang_LiveStackFrameInfo                          ) \
201                                                                                                                 \
202   /* support for stack dump lock analysis */                                                                    \
203   do_klass(java_util_concurrent_locks_AbstractOwnableSynchronizer_klass, java_util_concurrent_locks_AbstractOwnableSynchronizer) \
204                                                                                                                 \
205   /* boxing klasses */                                                                                          \
206   do_klass(Boolean_klass,                               java_lang_Boolean                                     ) \
207   do_klass(Character_klass,                             java_lang_Character                                   ) \
208   do_klass(Float_klass,                                 java_lang_Float                                       ) \
209   do_klass(Double_klass,                                java_lang_Double                                      ) \
210   do_klass(Byte_klass,                                  java_lang_Byte                                        ) \
211   do_klass(Short_klass,                                 java_lang_Short                                       ) \
212   do_klass(Integer_klass,                               java_lang_Integer                                     ) \
213   do_klass(Long_klass,                                  java_lang_Long                                        ) \
214                                                                                                                 \
<span class="line-modified">215   /* JVMCI classes. These are loaded on-demand. */                                                              \</span>
<span class="line-modified">216   JVMCI_WK_KLASSES_DO(do_klass)                                                                                 \</span>



217                                                                                                                 \
218   /*end*/
219 
<span class="line-removed">220 </span>
221 class SystemDictionary : AllStatic {

222   friend class VMStructs;
223   friend class SystemDictionaryHandles;
224 
225  public:
226   enum WKID {
227     NO_WKID = 0,
228 
229     #define WK_KLASS_ENUM(name, symbol) WK_KLASS_ENUM_NAME(name), WK_KLASS_ENUM_NAME(symbol) = WK_KLASS_ENUM_NAME(name),
230     WK_KLASSES_DO(WK_KLASS_ENUM)
231     #undef WK_KLASS_ENUM
232 
233     WKID_LIMIT,
234 
<span class="line-removed">235 #if INCLUDE_JVMCI</span>
<span class="line-removed">236     FIRST_JVMCI_WKID = WK_KLASS_ENUM_NAME(JVMCI_klass),</span>
<span class="line-removed">237     LAST_JVMCI_WKID  = WK_KLASS_ENUM_NAME(Value_klass),</span>
<span class="line-removed">238 #endif</span>
<span class="line-removed">239 </span>
240     FIRST_WKID = NO_WKID + 1
241   };
242 
243   // Returns a class with a given class name and class loader.  Loads the
244   // class if needed. If not found a NoClassDefFoundError or a
245   // ClassNotFoundException is thrown, depending on the value on the
246   // throw_error flag.  For most uses the throw_error argument should be set
247   // to true.
248 
249   static Klass* resolve_or_fail(Symbol* class_name, Handle class_loader, Handle protection_domain, bool throw_error, TRAPS);
250   // Convenient call for null loader and protection domain.
251   static Klass* resolve_or_fail(Symbol* class_name, bool throw_error, TRAPS);
252 protected:
253   // handle error translation for resolve_or_null results
254   static Klass* handle_resolution_exception(Symbol* class_name, bool throw_error, Klass* klass, TRAPS);
255 
256 public:
257 
258   // Returns a class with a given class name and class loader.
259   // Loads the class if needed. If not found NULL is returned.
</pre>
<hr />
<pre>
333   // In all of these cases, the loader constraints on this type are
334   // satisfied, and it is safe for classes in the given class loader
335   // to manipulate strongly-typed values of the found class, subject
336   // to local linkage and access checks.
337   static Klass* find_constrained_instance_or_array_klass(Symbol* class_name,
338                                                            Handle class_loader,
339                                                            TRAPS);
340 
341   static void classes_do(MetaspaceClosure* it);
342   // Iterate over all methods in all klasses
343 
344   static void methods_do(void f(Method*));
345 
346   // Garbage collection support
347 
348   // Unload (that is, break root links to) all unmarked classes and
349   // loaders.  Returns &quot;true&quot; iff something was unloaded.
350   static bool do_unloading(GCTimer* gc_timer);
351 
352   // Applies &quot;f-&gt;do_oop&quot; to all root oops in the system dictionary.
<span class="line-modified">353   static void oops_do(OopClosure* f);</span>


354 
355   // System loader lock
356   static oop system_loader_lock()           { return _system_loader_lock_obj; }
357 
358   // Protection Domain Table
359   static ProtectionDomainCacheTable* pd_cache_table() { return _pd_cache_table; }
360 
361 public:
362   // Printing
<span class="line-modified">363   static void print() { return print_on(tty); }</span>
364   static void print_on(outputStream* st);
365   static void dump(outputStream* st, bool verbose);
366 
<span class="line-removed">367   // Monotonically increasing counter which grows as classes are</span>
<span class="line-removed">368   // loaded or modifications such as hot-swapping or setting/removing</span>
<span class="line-removed">369   // of breakpoints are performed</span>
<span class="line-removed">370   static inline int number_of_modifications()     { assert_locked_or_safepoint(Compile_lock); return _number_of_modifications; }</span>
<span class="line-removed">371   // Needed by evolution and breakpoint code</span>
<span class="line-removed">372   static inline void notice_modification()        { assert_locked_or_safepoint(Compile_lock); ++_number_of_modifications;      }</span>
<span class="line-removed">373 </span>
374   // Verification
375   static void verify();
376 
377   // Initialization
378   static void initialize(TRAPS);
379 
380   // Checked fast access to the well-known classes -- so that you don&#39;t try to use them
381   // before they are resolved.
382   static InstanceKlass* check_klass(InstanceKlass* k) {
383     assert(k != NULL, &quot;klass not loaded&quot;);
384     return k;
385   }
386 
387   static bool resolve_wk_klass(WKID id, TRAPS);
388   static void resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS);
389   static void resolve_wk_klasses_through(WKID end_id, WKID &amp;start_id, TRAPS) {
390     int limit = (int)end_id + 1;
391     resolve_wk_klasses_until((WKID) limit, start_id, THREAD);
392   }
<span class="line-removed">393 </span>
394 public:
395   #define WK_KLASS_DECLARE(name, symbol) \
396     static InstanceKlass* name() { return check_klass(_well_known_klasses[WK_KLASS_ENUM_NAME(name)]); } \
397     static InstanceKlass** name##_addr() {                                                              \
398       return &amp;_well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)];                          \
399     }                                                                                                   \
400     static bool name##_is_loaded() {                                                                    \
401       return _well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)] != NULL;                   \
402     }
403   WK_KLASSES_DO(WK_KLASS_DECLARE);
404   #undef WK_KLASS_DECLARE
405 
406   static InstanceKlass* well_known_klass(WKID id) {
407     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
408     return _well_known_klasses[id];
409   }
410 
411   static InstanceKlass** well_known_klass_addr(WKID id) {
412     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
413     return &amp;_well_known_klasses[id];
</pre>
<hr />
<pre>
420   static InstanceKlass* box_klass(BasicType t) {
421     assert((uint)t &lt; T_VOID+1, &quot;range check&quot;);
422     return check_klass(_box_klasses[t]);
423   }
424   static BasicType box_klass_type(Klass* k);  // inverse of box_klass
425 #ifdef ASSERT
426   static bool is_well_known_klass(Klass* k) {
427     return is_well_known_klass(k-&gt;name());
428   }
429   static bool is_well_known_klass(Symbol* class_name);
430 #endif
431 
432 protected:
433   // Returns the class loader data to be used when looking up/updating the
434   // system dictionary.
435   static ClassLoaderData *class_loader_data(Handle class_loader) {
436     return ClassLoaderData::class_loader_data(class_loader());
437   }
438 
439 public:
<span class="line-removed">440   // Tells whether ClassLoader.checkPackageAccess is present</span>
<span class="line-removed">441   static bool has_checkPackageAccess()      { return _has_checkPackageAccess; }</span>
<span class="line-removed">442 </span>
443   static bool Parameter_klass_loaded()      { return WK_KLASS(reflect_Parameter_klass) != NULL; }
444   static bool Class_klass_loaded()          { return WK_KLASS(Class_klass) != NULL; }
445   static bool Cloneable_klass_loaded()      { return WK_KLASS(Cloneable_klass) != NULL; }
446   static bool Object_klass_loaded()         { return WK_KLASS(Object_klass) != NULL; }
447   static bool ClassLoader_klass_loaded()    { return WK_KLASS(ClassLoader_klass) != NULL; }
448 
449   // Returns java system loader
450   static oop java_system_loader();
451 
452   // Returns java platform loader
453   static oop java_platform_loader();
454 
455   // Compute the java system and platform loaders
456   static void compute_java_loaders(TRAPS);
457 
458   // Register a new class loader
459   static ClassLoaderData* register_loader(Handle class_loader);
460 protected:
461   // Mirrors for primitive classes (created eagerly)
462   static oop check_mirror(oop m) {
463     assert(m != NULL, &quot;mirror not initialized&quot;);
464     return m;
465   }
466 
467 public:
468   // Note:  java_lang_Class::primitive_type is the inverse of java_mirror
469 
470   // Check class loader constraints
471   static bool add_loader_constraint(Symbol* name, Handle loader1,
472                                     Handle loader2, TRAPS);
473   static Symbol* check_signature_loaders(Symbol* signature, Handle loader1,
474                                          Handle loader2, bool is_method, TRAPS);
475 
476   // JSR 292
477   // find a java.lang.invoke.MethodHandle.invoke* method for a given signature
478   // (asks Java to compute it if necessary, except in a compiler thread)
<span class="line-modified">479   static methodHandle find_method_handle_invoker(Klass* klass,</span>
<span class="line-modified">480                                                  Symbol* name,</span>
<span class="line-modified">481                                                  Symbol* signature,</span>
<span class="line-modified">482                                                  Klass* accessing_klass,</span>
<span class="line-modified">483                                                  Handle *appendix_result,</span>
<span class="line-modified">484                                                  TRAPS);</span>
485   // for a given signature, find the internal MethodHandle method (linkTo* or invokeBasic)
486   // (does not ask Java, since this is a low-level intrinsic defined by the JVM)
<span class="line-modified">487   static methodHandle find_method_handle_intrinsic(vmIntrinsics::ID iid,</span>
<span class="line-modified">488                                                    Symbol* signature,</span>
<span class="line-modified">489                                                    TRAPS);</span>
490 
491   // compute java_mirror (java.lang.Class instance) for a type (&quot;I&quot;, &quot;[[B&quot;, &quot;LFoo;&quot;, etc.)
492   // Either the accessing_klass or the CL/PD can be non-null, but not both.
493   static Handle    find_java_mirror_for_type(Symbol* signature,
494                                              Klass* accessing_klass,
495                                              Handle class_loader,
496                                              Handle protection_domain,
497                                              SignatureStream::FailureMode failure_mode,
498                                              TRAPS);
499   static Handle    find_java_mirror_for_type(Symbol* signature,
500                                              Klass* accessing_klass,
501                                              SignatureStream::FailureMode failure_mode,
502                                              TRAPS) {
503     // callee will fill in CL/PD from AK, if they are needed
504     return find_java_mirror_for_type(signature, accessing_klass, Handle(), Handle(),
505                                      failure_mode, THREAD);
506   }
507 
<span class="line-removed">508 </span>
<span class="line-removed">509   // fast short-cut for the one-character case:</span>
<span class="line-removed">510   static oop       find_java_mirror_for_type(char signature_char);</span>
<span class="line-removed">511 </span>
512   // find a java.lang.invoke.MethodType object for a given signature
513   // (asks Java to compute it if necessary, except in a compiler thread)
514   static Handle    find_method_handle_type(Symbol* signature,
515                                            Klass* accessing_klass,
516                                            TRAPS);
517 
518   // find a java.lang.Class object for a given signature
519   static Handle    find_field_handle_type(Symbol* signature,
520                                           Klass* accessing_klass,
521                                           TRAPS);
522 
523   // ask Java to compute a java.lang.invoke.MethodHandle object for a given CP entry
524   static Handle    link_method_handle_constant(Klass* caller,
525                                                int ref_kind, //e.g., JVM_REF_invokeVirtual
526                                                Klass* callee,
527                                                Symbol* name,
528                                                Symbol* signature,
529                                                TRAPS);
530 
531   // ask Java to compute a constant by invoking a BSM given a Dynamic_info CP entry
<span class="line-modified">532   static Handle    link_dynamic_constant(Klass* caller,</span>
<span class="line-removed">533                                          int condy_index,</span>
<span class="line-removed">534                                          Handle bootstrap_specifier,</span>
<span class="line-removed">535                                          Symbol* name,</span>
<span class="line-removed">536                                          Symbol* type,</span>
<span class="line-removed">537                                          TRAPS);</span>
<span class="line-removed">538 </span>
<span class="line-removed">539   // ask Java to create a dynamic call site, while linking an invokedynamic op</span>
<span class="line-removed">540   static methodHandle find_dynamic_call_site_invoker(Klass* caller,</span>
<span class="line-removed">541                                                      int indy_index,</span>
<span class="line-removed">542                                                      Handle bootstrap_method,</span>
<span class="line-removed">543                                                      Symbol* name,</span>
<span class="line-removed">544                                                      Symbol* type,</span>
<span class="line-removed">545                                                      Handle *appendix_result,</span>
<span class="line-removed">546                                                      TRAPS);</span>
547 
548   // Record the error when the first attempt to resolve a reference from a constant
549   // pool entry to a class fails.
550   static void add_resolution_error(const constantPoolHandle&amp; pool, int which, Symbol* error,
551                                    Symbol* message);
552   static void delete_resolution_error(ConstantPool* pool);
553   static Symbol* find_resolution_error(const constantPoolHandle&amp; pool, int which,
554                                        Symbol** message);
555 
556 
557   static ProtectionDomainCacheEntry* cache_get(Handle protection_domain);
558 
559  protected:
560 
561   enum Constants {
562     _loader_constraint_size = 107,                     // number of entries in constraint table
563     _resolution_error_size  = 107,                     // number of entries in resolution error table
564     _invoke_method_size     = 139,                     // number of entries in invoke method table
565     _placeholder_table_size = 1009                     // number of entries in hash table for placeholders
566   };
567 
568 
569   // Static tables owned by the SystemDictionary
570 
571   // Hashtable holding placeholders for classes being loaded.
572   static PlaceholderTable*       _placeholders;
573 
<span class="line-removed">574   // Monotonically increasing counter which grows with</span>
<span class="line-removed">575   // loading classes as well as hot-swapping and breakpoint setting</span>
<span class="line-removed">576   // and removal.</span>
<span class="line-removed">577   static int                     _number_of_modifications;</span>
<span class="line-removed">578 </span>
579   // Lock object for system class loader
580   static oop                     _system_loader_lock_obj;
581 
582   // Constraints on class loaders
583   static LoaderConstraintTable*  _loader_constraints;
584 
585   // Resolution errors
586   static ResolutionErrorTable*   _resolution_errors;
587 
588   // Invoke methods (JSR 292)
589   static SymbolPropertyTable*    _invoke_method_table;
590 
591   // ProtectionDomain cache
592   static ProtectionDomainCacheTable*   _pd_cache_table;
593 
<span class="line-removed">594   // VM weak OopStorage object.</span>
<span class="line-removed">595   static OopStorage*             _vm_weak_oop_storage;</span>
<span class="line-removed">596 </span>
597 protected:
598   static void validate_protection_domain(InstanceKlass* klass,
599                                          Handle class_loader,
600                                          Handle protection_domain, TRAPS);
601 
602   friend class VM_PopulateDumpSharedSpace;
603   friend class TraversePlaceholdersClosure;
604   static PlaceholderTable*   placeholders() { return _placeholders; }
605   static LoaderConstraintTable* constraints() { return _loader_constraints; }
606   static ResolutionErrorTable* resolution_errors() { return _resolution_errors; }
607   static SymbolPropertyTable* invoke_method_table() { return _invoke_method_table; }
608 
609   // Basic loading operations
610   static InstanceKlass* resolve_instance_class_or_null_helper(Symbol* name,
611                                                               Handle class_loader,
612                                                               Handle protection_domain,
613                                                               TRAPS);
614   static InstanceKlass* resolve_instance_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
615   static Klass* resolve_array_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
616   static InstanceKlass* handle_parallel_super_load(Symbol* class_name, Symbol* supername, Handle class_loader, Handle protection_domain, Handle lockObject, TRAPS);
</pre>
<hr />
<pre>
631                                           const ClassFileStream *cfs,
632                                           TRAPS);
633   static InstanceKlass* load_shared_boot_class(Symbol* class_name,
634                                                TRAPS);
635   static InstanceKlass* load_instance_class(Symbol* class_name, Handle class_loader, TRAPS);
636   static Handle compute_loader_lock_object(Handle class_loader, TRAPS);
637   static void check_loader_lock_contention(Handle loader_lock, TRAPS);
638   static bool is_parallelCapable(Handle class_loader);
639   static bool is_parallelDefine(Handle class_loader);
640 
641 public:
642   static bool is_system_class_loader(oop class_loader);
643   static bool is_platform_class_loader(oop class_loader);
644 
645   // Returns TRUE if the method is a non-public member of class java.lang.Object.
646   static bool is_nonpublic_Object_method(Method* m) {
647     assert(m != NULL, &quot;Unexpected NULL Method*&quot;);
648     return !m-&gt;is_public() &amp;&amp; m-&gt;method_holder() == SystemDictionary::Object_klass();
649   }
650 
<span class="line-removed">651   static void initialize_oop_storage();</span>
<span class="line-removed">652   static OopStorage* vm_weak_oop_storage();</span>
<span class="line-removed">653 </span>
654 protected:
655   // Setup link to hierarchy
656   static void add_to_hierarchy(InstanceKlass* k, TRAPS);
657 
658   // Basic find on loaded classes
659   static InstanceKlass* find_class(unsigned int hash,
660                                    Symbol* name, Dictionary* dictionary);
661   static InstanceKlass* find_class(Symbol* class_name, ClassLoaderData* loader_data);
662 
663   // Basic find on classes in the midst of being loaded
664   static Symbol* find_placeholder(Symbol* name, ClassLoaderData* loader_data);
665 
<span class="line-removed">666   // Add a placeholder for a class being loaded</span>
<span class="line-removed">667   static void add_placeholder(int index,</span>
<span class="line-removed">668                               Symbol* class_name,</span>
<span class="line-removed">669                               ClassLoaderData* loader_data);</span>
<span class="line-removed">670   static void remove_placeholder(int index,</span>
<span class="line-removed">671                                  Symbol* class_name,</span>
<span class="line-removed">672                                  ClassLoaderData* loader_data);</span>
<span class="line-removed">673 </span>
<span class="line-removed">674   // Performs cleanups after resolve_super_or_fail. This typically needs</span>
<span class="line-removed">675   // to be called on failure.</span>
<span class="line-removed">676   // Won&#39;t throw, but can block.</span>
<span class="line-removed">677   static void resolution_cleanups(Symbol* class_name,</span>
<span class="line-removed">678                                   ClassLoaderData* loader_data,</span>
<span class="line-removed">679                                   TRAPS);</span>
<span class="line-removed">680 </span>
681   // Resolve well-known classes so they can be used like SystemDictionary::String_klass()
682   static void resolve_well_known_classes(TRAPS);
683 
684   // Class loader constraints
685   static void check_constraints(unsigned int hash,
686                                 InstanceKlass* k, Handle loader,
687                                 bool defining, TRAPS);
688   static void update_dictionary(unsigned int d_hash,
689                                 int p_index, unsigned int p_hash,
690                                 InstanceKlass* k, Handle loader,
691                                 TRAPS);
692 
693   static InstanceKlass* _well_known_klasses[];
694 
695   // table of box klasses (int_klass, etc.)
696   static InstanceKlass* _box_klasses[T_VOID+1];
697 
698 private:
699   static oop  _java_system_loader;
700   static oop  _java_platform_loader;
701 
<span class="line-modified">702   static bool _has_checkPackageAccess;</span>



703 };
704 
705 #endif // SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 26 #define SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 27 
<span class="line-modified"> 28 #include &quot;classfile/classLoaderData.hpp&quot;</span>

 29 #include &quot;oops/objArrayOop.hpp&quot;
 30 #include &quot;oops/symbol.hpp&quot;
 31 #include &quot;runtime/java.hpp&quot;
<span class="line-added"> 32 #include &quot;runtime/mutexLocker.hpp&quot;</span>
 33 #include &quot;runtime/reflectionUtils.hpp&quot;
 34 #include &quot;runtime/signature.hpp&quot;
 35 #include &quot;utilities/hashtable.hpp&quot;
 36 
 37 // The dictionary in each ClassLoaderData stores all loaded classes, either
 38 // initiatied by its class loader or defined by its class loader:
 39 //
 40 //   class loader -&gt; ClassLoaderData -&gt; [class, protection domain set]
 41 //
 42 // Classes are loaded lazily. The default VM class loader is
 43 // represented as NULL.
 44 
 45 // The underlying data structure is an open hash table (Dictionary) per
 46 // ClassLoaderData with a fixed number of buckets. During loading the
 47 // class loader object is locked, (for the VM loader a private lock object is used).
 48 // The global SystemDictionary_lock is held for all additions into the ClassLoaderData
 49 // dictionaries.  TODO: fix lock granularity so that class loading can
 50 // be done concurrently, but only by different loaders.
 51 //
 52 // During loading a placeholder (name, loader) is temporarily placed in
</pre>
<hr />
<pre>
 56 //
 57 // When class loading is finished, a new entry is added to the dictionary
 58 // of the class loader and the placeholder is removed. Note that the protection
 59 // domain field of the dictionary entry has not yet been filled in when
 60 // the &quot;real&quot; dictionary entry is created.
 61 //
 62 // Clients of this class who are interested in finding if a class has
 63 // been completely loaded -- not classes in the process of being loaded --
 64 // can read the dictionary unlocked. This is safe because
 65 //    - entries are only deleted at safepoints
 66 //    - readers cannot come to a safepoint while actively examining
 67 //         an entry  (an entry cannot be deleted from under a reader)
 68 //    - entries must be fully formed before they are available to concurrent
 69 //         readers (we must ensure write ordering)
 70 //
 71 // Note that placeholders are deleted at any time, as they are removed
 72 // when a class is completely loaded. Therefore, readers as well as writers
 73 // of placeholders must hold the SystemDictionary_lock.
 74 //
 75 
<span class="line-added"> 76 class BootstrapInfo;</span>
 77 class ClassFileStream;
 78 class Dictionary;
 79 class PlaceholderTable;
 80 class LoaderConstraintTable;
 81 template &lt;MEMFLAGS F&gt; class HashtableBucket;
 82 class ResolutionErrorTable;
 83 class SymbolPropertyTable;
 84 class ProtectionDomainCacheTable;
 85 class ProtectionDomainCacheEntry;
 86 class GCTimer;

 87 
 88 #define WK_KLASS_ENUM_NAME(kname)    kname##_knum
 89 
 90 // Certain classes, such as java.lang.Object and java.lang.String,
 91 // are &quot;well-known&quot;, in the sense that no class loader is allowed
 92 // to provide a different definition.
 93 //
 94 // Each well-known class has a short klass name (like object_klass),
 95 // and a vmSymbol name (like java_lang_Object).
 96 //
 97 // The order of these definitions is significant: the classes are
 98 // resolved during early VM start-up by resolve_well_known_classes
 99 // in this order. Changing the order may require careful restructuring
100 // of the VM start-up sequence.
101 //
102 #define WK_KLASSES_DO(do_klass)                                                                                 \
103   /* well-known classes */                                                                                      \
104   do_klass(Object_klass,                                java_lang_Object                                      ) \
105   do_klass(String_klass,                                java_lang_String                                      ) \
106   do_klass(Class_klass,                                 java_lang_Class                                       ) \
107   do_klass(Cloneable_klass,                             java_lang_Cloneable                                   ) \
108   do_klass(ClassLoader_klass,                           java_lang_ClassLoader                                 ) \
109   do_klass(Serializable_klass,                          java_io_Serializable                                  ) \
110   do_klass(System_klass,                                java_lang_System                                      ) \
111   do_klass(Throwable_klass,                             java_lang_Throwable                                   ) \
112   do_klass(Error_klass,                                 java_lang_Error                                       ) \
113   do_klass(ThreadDeath_klass,                           java_lang_ThreadDeath                                 ) \
114   do_klass(Exception_klass,                             java_lang_Exception                                   ) \
115   do_klass(RuntimeException_klass,                      java_lang_RuntimeException                            ) \
116   do_klass(SecurityManager_klass,                       java_lang_SecurityManager                             ) \
117   do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain                        ) \
118   do_klass(AccessControlContext_klass,                  java_security_AccessControlContext                    ) \
119   do_klass(AccessController_klass,                      java_security_AccessController                        ) \
120   do_klass(SecureClassLoader_klass,                     java_security_SecureClassLoader                       ) \
121   do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException                      ) \
<span class="line-added">122   do_klass(Record_klass,                                java_lang_Record                                      ) \</span>
123   do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError                        ) \
124   do_klass(LinkageError_klass,                          java_lang_LinkageError                                ) \
125   do_klass(ClassCastException_klass,                    java_lang_ClassCastException                          ) \
126   do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException                         ) \
127   do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError                         ) \
128   do_klass(OutOfMemoryError_klass,                      java_lang_OutOfMemoryError                            ) \
129   do_klass(StackOverflowError_klass,                    java_lang_StackOverflowError                          ) \
130   do_klass(IllegalMonitorStateException_klass,          java_lang_IllegalMonitorStateException                ) \
131   do_klass(Reference_klass,                             java_lang_ref_Reference                               ) \
132                                                                                                                 \
133   /* ref klasses and set reference types */                                                                     \
134   do_klass(SoftReference_klass,                         java_lang_ref_SoftReference                           ) \
135   do_klass(WeakReference_klass,                         java_lang_ref_WeakReference                           ) \
136   do_klass(FinalReference_klass,                        java_lang_ref_FinalReference                          ) \
137   do_klass(PhantomReference_klass,                      java_lang_ref_PhantomReference                        ) \
138   do_klass(Finalizer_klass,                             java_lang_ref_Finalizer                               ) \
139                                                                                                                 \
140   do_klass(Thread_klass,                                java_lang_Thread                                      ) \
141   do_klass(ThreadGroup_klass,                           java_lang_ThreadGroup                                 ) \
142   do_klass(Properties_klass,                            java_util_Properties                                  ) \
143   do_klass(Module_klass,                                java_lang_Module                                      ) \
144   do_klass(reflect_AccessibleObject_klass,              java_lang_reflect_AccessibleObject                    ) \
145   do_klass(reflect_Field_klass,                         java_lang_reflect_Field                               ) \
146   do_klass(reflect_Parameter_klass,                     java_lang_reflect_Parameter                           ) \
147   do_klass(reflect_Method_klass,                        java_lang_reflect_Method                              ) \
148   do_klass(reflect_Constructor_klass,                   java_lang_reflect_Constructor                         ) \
149                                                                                                                 \
150   /* NOTE: needed too early in bootstrapping process to have checks based on JDK version */                     \
151   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
152   do_klass(reflect_MagicAccessorImpl_klass,             reflect_MagicAccessorImpl                             ) \
153   do_klass(reflect_MethodAccessorImpl_klass,            reflect_MethodAccessorImpl                            ) \
154   do_klass(reflect_ConstructorAccessorImpl_klass,       reflect_ConstructorAccessorImpl                       ) \
155   do_klass(reflect_DelegatingClassLoader_klass,         reflect_DelegatingClassLoader                         ) \
156   do_klass(reflect_ConstantPool_klass,                  reflect_ConstantPool                                  ) \
157   do_klass(reflect_UnsafeStaticFieldAccessorImpl_klass, reflect_UnsafeStaticFieldAccessorImpl                 ) \
158   do_klass(reflect_CallerSensitive_klass,               reflect_CallerSensitive                               ) \
<span class="line-added">159   do_klass(reflect_NativeConstructorAccessorImpl_klass, reflect_NativeConstructorAccessorImpl                 ) \</span>
160                                                                                                                 \
161   /* support for dynamic typing; it&#39;s OK if these are NULL in earlier JDKs */                                   \
162   do_klass(DirectMethodHandle_klass,                    java_lang_invoke_DirectMethodHandle                   ) \
163   do_klass(MethodHandle_klass,                          java_lang_invoke_MethodHandle                         ) \
164   do_klass(VarHandle_klass,                             java_lang_invoke_VarHandle                            ) \
165   do_klass(MemberName_klass,                            java_lang_invoke_MemberName                           ) \
166   do_klass(ResolvedMethodName_klass,                    java_lang_invoke_ResolvedMethodName                   ) \
167   do_klass(MethodHandleNatives_klass,                   java_lang_invoke_MethodHandleNatives                  ) \
168   do_klass(LambdaForm_klass,                            java_lang_invoke_LambdaForm                           ) \
169   do_klass(MethodType_klass,                            java_lang_invoke_MethodType                           ) \
170   do_klass(BootstrapMethodError_klass,                  java_lang_BootstrapMethodError                        ) \
171   do_klass(CallSite_klass,                              java_lang_invoke_CallSite                             ) \
172   do_klass(Context_klass,                               java_lang_invoke_MethodHandleNatives_CallSiteContext  ) \
173   do_klass(ConstantCallSite_klass,                      java_lang_invoke_ConstantCallSite                     ) \
174   do_klass(MutableCallSite_klass,                       java_lang_invoke_MutableCallSite                      ) \
175   do_klass(VolatileCallSite_klass,                      java_lang_invoke_VolatileCallSite                     ) \
176   /* Note: MethodHandle must be first, and VolatileCallSite last in group */                                    \
177                                                                                                                 \
178   do_klass(AssertionStatusDirectives_klass,             java_lang_AssertionStatusDirectives                   ) \
179   do_klass(StringBuffer_klass,                          java_lang_StringBuffer                                ) \
180   do_klass(StringBuilder_klass,                         java_lang_StringBuilder                               ) \
<span class="line-added">181   do_klass(UnsafeConstants_klass,                       jdk_internal_misc_UnsafeConstants                     ) \</span>
182   do_klass(internal_Unsafe_klass,                       jdk_internal_misc_Unsafe                              ) \
183   do_klass(module_Modules_klass,                        jdk_internal_module_Modules                           ) \
184                                                                                                                 \
185   /* support for CDS */                                                                                         \
186   do_klass(ByteArrayInputStream_klass,                  java_io_ByteArrayInputStream                          ) \
187   do_klass(URL_klass,                                   java_net_URL                                          ) \
188   do_klass(Jar_Manifest_klass,                          java_util_jar_Manifest                                ) \
189   do_klass(jdk_internal_loader_ClassLoaders_klass,      jdk_internal_loader_ClassLoaders                      ) \
190   do_klass(jdk_internal_loader_ClassLoaders_AppClassLoader_klass,      jdk_internal_loader_ClassLoaders_AppClassLoader) \
191   do_klass(jdk_internal_loader_ClassLoaders_PlatformClassLoader_klass, jdk_internal_loader_ClassLoaders_PlatformClassLoader) \
192   do_klass(CodeSource_klass,                            java_security_CodeSource                              ) \
193                                                                                                                 \
194   do_klass(StackTraceElement_klass,                     java_lang_StackTraceElement                           ) \
195                                                                                                                 \
196   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
197   do_klass(nio_Buffer_klass,                            java_nio_Buffer                                       ) \
198                                                                                                                 \
199   /* Stack Walking */                                                                                           \
200   do_klass(StackWalker_klass,                           java_lang_StackWalker                                 ) \
201   do_klass(AbstractStackWalker_klass,                   java_lang_StackStreamFactory_AbstractStackWalker      ) \
202   do_klass(StackFrameInfo_klass,                        java_lang_StackFrameInfo                              ) \
203   do_klass(LiveStackFrameInfo_klass,                    java_lang_LiveStackFrameInfo                          ) \
204                                                                                                                 \
205   /* support for stack dump lock analysis */                                                                    \
206   do_klass(java_util_concurrent_locks_AbstractOwnableSynchronizer_klass, java_util_concurrent_locks_AbstractOwnableSynchronizer) \
207                                                                                                                 \
208   /* boxing klasses */                                                                                          \
209   do_klass(Boolean_klass,                               java_lang_Boolean                                     ) \
210   do_klass(Character_klass,                             java_lang_Character                                   ) \
211   do_klass(Float_klass,                                 java_lang_Float                                       ) \
212   do_klass(Double_klass,                                java_lang_Double                                      ) \
213   do_klass(Byte_klass,                                  java_lang_Byte                                        ) \
214   do_klass(Short_klass,                                 java_lang_Short                                       ) \
215   do_klass(Integer_klass,                               java_lang_Integer                                     ) \
216   do_klass(Long_klass,                                  java_lang_Long                                        ) \
217                                                                                                                 \
<span class="line-modified">218   /* force inline of iterators */                                                                               \</span>
<span class="line-modified">219   do_klass(Iterator_klass,                              java_util_Iterator                                    ) \</span>
<span class="line-added">220                                                                                                                 \</span>
<span class="line-added">221   /* support for records */                                                                                     \</span>
<span class="line-added">222   do_klass(RecordComponent_klass,                       java_lang_reflect_RecordComponent                     ) \</span>
223                                                                                                                 \
224   /*end*/
225 

226 class SystemDictionary : AllStatic {
<span class="line-added">227   friend class BootstrapInfo;</span>
228   friend class VMStructs;
229   friend class SystemDictionaryHandles;
230 
231  public:
232   enum WKID {
233     NO_WKID = 0,
234 
235     #define WK_KLASS_ENUM(name, symbol) WK_KLASS_ENUM_NAME(name), WK_KLASS_ENUM_NAME(symbol) = WK_KLASS_ENUM_NAME(name),
236     WK_KLASSES_DO(WK_KLASS_ENUM)
237     #undef WK_KLASS_ENUM
238 
239     WKID_LIMIT,
240 





241     FIRST_WKID = NO_WKID + 1
242   };
243 
244   // Returns a class with a given class name and class loader.  Loads the
245   // class if needed. If not found a NoClassDefFoundError or a
246   // ClassNotFoundException is thrown, depending on the value on the
247   // throw_error flag.  For most uses the throw_error argument should be set
248   // to true.
249 
250   static Klass* resolve_or_fail(Symbol* class_name, Handle class_loader, Handle protection_domain, bool throw_error, TRAPS);
251   // Convenient call for null loader and protection domain.
252   static Klass* resolve_or_fail(Symbol* class_name, bool throw_error, TRAPS);
253 protected:
254   // handle error translation for resolve_or_null results
255   static Klass* handle_resolution_exception(Symbol* class_name, bool throw_error, Klass* klass, TRAPS);
256 
257 public:
258 
259   // Returns a class with a given class name and class loader.
260   // Loads the class if needed. If not found NULL is returned.
</pre>
<hr />
<pre>
334   // In all of these cases, the loader constraints on this type are
335   // satisfied, and it is safe for classes in the given class loader
336   // to manipulate strongly-typed values of the found class, subject
337   // to local linkage and access checks.
338   static Klass* find_constrained_instance_or_array_klass(Symbol* class_name,
339                                                            Handle class_loader,
340                                                            TRAPS);
341 
342   static void classes_do(MetaspaceClosure* it);
343   // Iterate over all methods in all klasses
344 
345   static void methods_do(void f(Method*));
346 
347   // Garbage collection support
348 
349   // Unload (that is, break root links to) all unmarked classes and
350   // loaders.  Returns &quot;true&quot; iff something was unloaded.
351   static bool do_unloading(GCTimer* gc_timer);
352 
353   // Applies &quot;f-&gt;do_oop&quot; to all root oops in the system dictionary.
<span class="line-modified">354   // If include_handles is true (the default), then the handles in the</span>
<span class="line-added">355   // vm_global OopStorage object are included.</span>
<span class="line-added">356   static void oops_do(OopClosure* f, bool include_handles = true);</span>
357 
358   // System loader lock
359   static oop system_loader_lock()           { return _system_loader_lock_obj; }
360 
361   // Protection Domain Table
362   static ProtectionDomainCacheTable* pd_cache_table() { return _pd_cache_table; }
363 
364 public:
365   // Printing
<span class="line-modified">366   static void print();</span>
367   static void print_on(outputStream* st);
368   static void dump(outputStream* st, bool verbose);
369 







370   // Verification
371   static void verify();
372 
373   // Initialization
374   static void initialize(TRAPS);
375 
376   // Checked fast access to the well-known classes -- so that you don&#39;t try to use them
377   // before they are resolved.
378   static InstanceKlass* check_klass(InstanceKlass* k) {
379     assert(k != NULL, &quot;klass not loaded&quot;);
380     return k;
381   }
382 
383   static bool resolve_wk_klass(WKID id, TRAPS);
384   static void resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS);
385   static void resolve_wk_klasses_through(WKID end_id, WKID &amp;start_id, TRAPS) {
386     int limit = (int)end_id + 1;
387     resolve_wk_klasses_until((WKID) limit, start_id, THREAD);
388   }

389 public:
390   #define WK_KLASS_DECLARE(name, symbol) \
391     static InstanceKlass* name() { return check_klass(_well_known_klasses[WK_KLASS_ENUM_NAME(name)]); } \
392     static InstanceKlass** name##_addr() {                                                              \
393       return &amp;_well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)];                          \
394     }                                                                                                   \
395     static bool name##_is_loaded() {                                                                    \
396       return _well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)] != NULL;                   \
397     }
398   WK_KLASSES_DO(WK_KLASS_DECLARE);
399   #undef WK_KLASS_DECLARE
400 
401   static InstanceKlass* well_known_klass(WKID id) {
402     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
403     return _well_known_klasses[id];
404   }
405 
406   static InstanceKlass** well_known_klass_addr(WKID id) {
407     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
408     return &amp;_well_known_klasses[id];
</pre>
<hr />
<pre>
415   static InstanceKlass* box_klass(BasicType t) {
416     assert((uint)t &lt; T_VOID+1, &quot;range check&quot;);
417     return check_klass(_box_klasses[t]);
418   }
419   static BasicType box_klass_type(Klass* k);  // inverse of box_klass
420 #ifdef ASSERT
421   static bool is_well_known_klass(Klass* k) {
422     return is_well_known_klass(k-&gt;name());
423   }
424   static bool is_well_known_klass(Symbol* class_name);
425 #endif
426 
427 protected:
428   // Returns the class loader data to be used when looking up/updating the
429   // system dictionary.
430   static ClassLoaderData *class_loader_data(Handle class_loader) {
431     return ClassLoaderData::class_loader_data(class_loader());
432   }
433 
434 public:



435   static bool Parameter_klass_loaded()      { return WK_KLASS(reflect_Parameter_klass) != NULL; }
436   static bool Class_klass_loaded()          { return WK_KLASS(Class_klass) != NULL; }
437   static bool Cloneable_klass_loaded()      { return WK_KLASS(Cloneable_klass) != NULL; }
438   static bool Object_klass_loaded()         { return WK_KLASS(Object_klass) != NULL; }
439   static bool ClassLoader_klass_loaded()    { return WK_KLASS(ClassLoader_klass) != NULL; }
440 
441   // Returns java system loader
442   static oop java_system_loader();
443 
444   // Returns java platform loader
445   static oop java_platform_loader();
446 
447   // Compute the java system and platform loaders
448   static void compute_java_loaders(TRAPS);
449 
450   // Register a new class loader
451   static ClassLoaderData* register_loader(Handle class_loader);
452 protected:
453   // Mirrors for primitive classes (created eagerly)
454   static oop check_mirror(oop m) {
455     assert(m != NULL, &quot;mirror not initialized&quot;);
456     return m;
457   }
458 
459 public:
460   // Note:  java_lang_Class::primitive_type is the inverse of java_mirror
461 
462   // Check class loader constraints
463   static bool add_loader_constraint(Symbol* name, Handle loader1,
464                                     Handle loader2, TRAPS);
465   static Symbol* check_signature_loaders(Symbol* signature, Handle loader1,
466                                          Handle loader2, bool is_method, TRAPS);
467 
468   // JSR 292
469   // find a java.lang.invoke.MethodHandle.invoke* method for a given signature
470   // (asks Java to compute it if necessary, except in a compiler thread)
<span class="line-modified">471   static Method* find_method_handle_invoker(Klass* klass,</span>
<span class="line-modified">472                                             Symbol* name,</span>
<span class="line-modified">473                                             Symbol* signature,</span>
<span class="line-modified">474                                             Klass* accessing_klass,</span>
<span class="line-modified">475                                             Handle *appendix_result,</span>
<span class="line-modified">476                                             TRAPS);</span>
477   // for a given signature, find the internal MethodHandle method (linkTo* or invokeBasic)
478   // (does not ask Java, since this is a low-level intrinsic defined by the JVM)
<span class="line-modified">479   static Method* find_method_handle_intrinsic(vmIntrinsics::ID iid,</span>
<span class="line-modified">480                                               Symbol* signature,</span>
<span class="line-modified">481                                               TRAPS);</span>
482 
483   // compute java_mirror (java.lang.Class instance) for a type (&quot;I&quot;, &quot;[[B&quot;, &quot;LFoo;&quot;, etc.)
484   // Either the accessing_klass or the CL/PD can be non-null, but not both.
485   static Handle    find_java_mirror_for_type(Symbol* signature,
486                                              Klass* accessing_klass,
487                                              Handle class_loader,
488                                              Handle protection_domain,
489                                              SignatureStream::FailureMode failure_mode,
490                                              TRAPS);
491   static Handle    find_java_mirror_for_type(Symbol* signature,
492                                              Klass* accessing_klass,
493                                              SignatureStream::FailureMode failure_mode,
494                                              TRAPS) {
495     // callee will fill in CL/PD from AK, if they are needed
496     return find_java_mirror_for_type(signature, accessing_klass, Handle(), Handle(),
497                                      failure_mode, THREAD);
498   }
499 




500   // find a java.lang.invoke.MethodType object for a given signature
501   // (asks Java to compute it if necessary, except in a compiler thread)
502   static Handle    find_method_handle_type(Symbol* signature,
503                                            Klass* accessing_klass,
504                                            TRAPS);
505 
506   // find a java.lang.Class object for a given signature
507   static Handle    find_field_handle_type(Symbol* signature,
508                                           Klass* accessing_klass,
509                                           TRAPS);
510 
511   // ask Java to compute a java.lang.invoke.MethodHandle object for a given CP entry
512   static Handle    link_method_handle_constant(Klass* caller,
513                                                int ref_kind, //e.g., JVM_REF_invokeVirtual
514                                                Klass* callee,
515                                                Symbol* name,
516                                                Symbol* signature,
517                                                TRAPS);
518 
519   // ask Java to compute a constant by invoking a BSM given a Dynamic_info CP entry
<span class="line-modified">520   static void      invoke_bootstrap_method(BootstrapInfo&amp; bootstrap_specifier, TRAPS);</span>














521 
522   // Record the error when the first attempt to resolve a reference from a constant
523   // pool entry to a class fails.
524   static void add_resolution_error(const constantPoolHandle&amp; pool, int which, Symbol* error,
525                                    Symbol* message);
526   static void delete_resolution_error(ConstantPool* pool);
527   static Symbol* find_resolution_error(const constantPoolHandle&amp; pool, int which,
528                                        Symbol** message);
529 
530 
531   static ProtectionDomainCacheEntry* cache_get(Handle protection_domain);
532 
533  protected:
534 
535   enum Constants {
536     _loader_constraint_size = 107,                     // number of entries in constraint table
537     _resolution_error_size  = 107,                     // number of entries in resolution error table
538     _invoke_method_size     = 139,                     // number of entries in invoke method table
539     _placeholder_table_size = 1009                     // number of entries in hash table for placeholders
540   };
541 
542 
543   // Static tables owned by the SystemDictionary
544 
545   // Hashtable holding placeholders for classes being loaded.
546   static PlaceholderTable*       _placeholders;
547 





548   // Lock object for system class loader
549   static oop                     _system_loader_lock_obj;
550 
551   // Constraints on class loaders
552   static LoaderConstraintTable*  _loader_constraints;
553 
554   // Resolution errors
555   static ResolutionErrorTable*   _resolution_errors;
556 
557   // Invoke methods (JSR 292)
558   static SymbolPropertyTable*    _invoke_method_table;
559 
560   // ProtectionDomain cache
561   static ProtectionDomainCacheTable*   _pd_cache_table;
562 



563 protected:
564   static void validate_protection_domain(InstanceKlass* klass,
565                                          Handle class_loader,
566                                          Handle protection_domain, TRAPS);
567 
568   friend class VM_PopulateDumpSharedSpace;
569   friend class TraversePlaceholdersClosure;
570   static PlaceholderTable*   placeholders() { return _placeholders; }
571   static LoaderConstraintTable* constraints() { return _loader_constraints; }
572   static ResolutionErrorTable* resolution_errors() { return _resolution_errors; }
573   static SymbolPropertyTable* invoke_method_table() { return _invoke_method_table; }
574 
575   // Basic loading operations
576   static InstanceKlass* resolve_instance_class_or_null_helper(Symbol* name,
577                                                               Handle class_loader,
578                                                               Handle protection_domain,
579                                                               TRAPS);
580   static InstanceKlass* resolve_instance_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
581   static Klass* resolve_array_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
582   static InstanceKlass* handle_parallel_super_load(Symbol* class_name, Symbol* supername, Handle class_loader, Handle protection_domain, Handle lockObject, TRAPS);
</pre>
<hr />
<pre>
597                                           const ClassFileStream *cfs,
598                                           TRAPS);
599   static InstanceKlass* load_shared_boot_class(Symbol* class_name,
600                                                TRAPS);
601   static InstanceKlass* load_instance_class(Symbol* class_name, Handle class_loader, TRAPS);
602   static Handle compute_loader_lock_object(Handle class_loader, TRAPS);
603   static void check_loader_lock_contention(Handle loader_lock, TRAPS);
604   static bool is_parallelCapable(Handle class_loader);
605   static bool is_parallelDefine(Handle class_loader);
606 
607 public:
608   static bool is_system_class_loader(oop class_loader);
609   static bool is_platform_class_loader(oop class_loader);
610 
611   // Returns TRUE if the method is a non-public member of class java.lang.Object.
612   static bool is_nonpublic_Object_method(Method* m) {
613     assert(m != NULL, &quot;Unexpected NULL Method*&quot;);
614     return !m-&gt;is_public() &amp;&amp; m-&gt;method_holder() == SystemDictionary::Object_klass();
615   }
616 



617 protected:
618   // Setup link to hierarchy
619   static void add_to_hierarchy(InstanceKlass* k, TRAPS);
620 
621   // Basic find on loaded classes
622   static InstanceKlass* find_class(unsigned int hash,
623                                    Symbol* name, Dictionary* dictionary);
624   static InstanceKlass* find_class(Symbol* class_name, ClassLoaderData* loader_data);
625 
626   // Basic find on classes in the midst of being loaded
627   static Symbol* find_placeholder(Symbol* name, ClassLoaderData* loader_data);
628 















629   // Resolve well-known classes so they can be used like SystemDictionary::String_klass()
630   static void resolve_well_known_classes(TRAPS);
631 
632   // Class loader constraints
633   static void check_constraints(unsigned int hash,
634                                 InstanceKlass* k, Handle loader,
635                                 bool defining, TRAPS);
636   static void update_dictionary(unsigned int d_hash,
637                                 int p_index, unsigned int p_hash,
638                                 InstanceKlass* k, Handle loader,
639                                 TRAPS);
640 
641   static InstanceKlass* _well_known_klasses[];
642 
643   // table of box klasses (int_klass, etc.)
644   static InstanceKlass* _box_klasses[T_VOID+1];
645 
646 private:
647   static oop  _java_system_loader;
648   static oop  _java_platform_loader;
649 
<span class="line-modified">650 public:</span>
<span class="line-added">651   static TableStatistics placeholders_statistics();</span>
<span class="line-added">652   static TableStatistics loader_constraints_statistics();</span>
<span class="line-added">653   static TableStatistics protection_domain_cache_statistics();</span>
654 };
655 
656 #endif // SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
</pre>
</td>
</tr>
</table>
<center><a href="systemDictionary.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>