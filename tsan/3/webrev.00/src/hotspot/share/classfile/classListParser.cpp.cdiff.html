<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/classfile/classListParser.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classFileStream.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoader.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classListParser.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 32,11 ***</span>
  #include &quot;classfile/systemDictionaryShared.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logTag.hpp&quot;
  #include &quot;memory/metaspaceShared.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="line-removed">- #include &quot;runtime/fieldType.hpp&quot;</span>
  #include &quot;runtime/handles.inline.hpp&quot;
  #include &quot;runtime/javaCalls.hpp&quot;
  #include &quot;utilities/defaultStream.hpp&quot;
  #include &quot;utilities/hashtable.inline.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
<span class="line-new-header">--- 32,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 227,21 ***</span>
      jio_fprintf(defaultStream::error_stream(), &quot;  %4d = %s\n&quot;, _interfaces-&gt;at(i), k-&gt;name()-&gt;as_klass_external_name());
    }
    jio_fprintf(defaultStream::error_stream(), &quot;}\n&quot;);
  }
  
<span class="line-modified">! void ClassListParser::print_actual_interfaces(InstanceKlass *ik) {</span>
    int n = ik-&gt;local_interfaces()-&gt;length();
    jio_fprintf(defaultStream::error_stream(), &quot;Actual interfaces[%d] = {\n&quot;, n);
    for (int i = 0; i &lt; n; i++) {
<span class="line-modified">!     InstanceKlass* e = InstanceKlass::cast(ik-&gt;local_interfaces()-&gt;at(i));</span>
      jio_fprintf(defaultStream::error_stream(), &quot;  %s\n&quot;, e-&gt;name()-&gt;as_klass_external_name());
    }
    jio_fprintf(defaultStream::error_stream(), &quot;}\n&quot;);
  }
  
<span class="line-modified">! void ClassListParser::error(const char *msg, ...) {</span>
    va_list ap;
    va_start(ap, msg);
    int error_index = _token - _line;
    if (error_index &gt;= _line_len) {
      error_index = _line_len - 1;
<span class="line-new-header">--- 226,21 ---</span>
      jio_fprintf(defaultStream::error_stream(), &quot;  %4d = %s\n&quot;, _interfaces-&gt;at(i), k-&gt;name()-&gt;as_klass_external_name());
    }
    jio_fprintf(defaultStream::error_stream(), &quot;}\n&quot;);
  }
  
<span class="line-modified">! void ClassListParser::print_actual_interfaces(InstanceKlass* ik) {</span>
    int n = ik-&gt;local_interfaces()-&gt;length();
    jio_fprintf(defaultStream::error_stream(), &quot;Actual interfaces[%d] = {\n&quot;, n);
    for (int i = 0; i &lt; n; i++) {
<span class="line-modified">!     InstanceKlass* e = ik-&gt;local_interfaces()-&gt;at(i);</span>
      jio_fprintf(defaultStream::error_stream(), &quot;  %s\n&quot;, e-&gt;name()-&gt;as_klass_external_name());
    }
    jio_fprintf(defaultStream::error_stream(), &quot;}\n&quot;);
  }
  
<span class="line-modified">! void ClassListParser::error(const char* msg, ...) {</span>
    va_list ap;
    va_start(ap, msg);
    int error_index = _token - _line;
    if (error_index &gt;= _line_len) {
      error_index = _line_len - 1;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 293,18 ***</span>
      error(&quot;If source location is specified, super class must be also specified&quot;);
    }
    if (!is_id_specified()) {
      error(&quot;If source location is specified, id must be also specified&quot;);
    }
<span class="line-removed">-   InstanceKlass* k = ClassLoaderExt::load_class(class_name, _source, CHECK_NULL);</span>
<span class="line-removed">- </span>
    if (strncmp(_class_name, &quot;java/&quot;, 5) == 0) {
      log_info(cds)(&quot;Prohibited package for non-bootstrap classes: %s.class from %s&quot;,
            _class_name, _source);
      return NULL;
    }
  
    if (k != NULL) {
      if (k-&gt;local_interfaces()-&gt;length() != _interfaces-&gt;length()) {
        print_specified_interfaces();
        print_actual_interfaces(k);
        error(&quot;The number of interfaces (%d) specified in class list does not match the class file (%d)&quot;,
<span class="line-new-header">--- 292,18 ---</span>
      error(&quot;If source location is specified, super class must be also specified&quot;);
    }
    if (!is_id_specified()) {
      error(&quot;If source location is specified, id must be also specified&quot;);
    }
    if (strncmp(_class_name, &quot;java/&quot;, 5) == 0) {
      log_info(cds)(&quot;Prohibited package for non-bootstrap classes: %s.class from %s&quot;,
            _class_name, _source);
      return NULL;
    }
  
<span class="line-added">+   InstanceKlass* k = ClassLoaderExt::load_class(class_name, _source, CHECK_NULL);</span>
<span class="line-added">+ </span>
    if (k != NULL) {
      if (k-&gt;local_interfaces()-&gt;length() != _interfaces-&gt;length()) {
        print_specified_interfaces();
        print_actual_interfaces(k);
        error(&quot;The number of interfaces (%d) specified in class list does not match the class file (%d)&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 324,24 ***</span>
  
    return k;
  }
  
  Klass* ClassListParser::load_current_class(TRAPS) {
<span class="line-modified">!   TempNewSymbol class_name_symbol = SymbolTable::new_symbol(_class_name, THREAD);</span>
<span class="line-removed">-   guarantee(!HAS_PENDING_EXCEPTION, &quot;Exception creating a symbol.&quot;);</span>
  
<span class="line-modified">!   Klass *klass = NULL;</span>
    if (!is_loading_from_source()) {
      // Load classes for the boot/platform/app loaders only.
      if (is_super_specified()) {
        error(&quot;If source location is not specified, super class must not be specified&quot;);
      }
      if (are_interfaces_specified()) {
        error(&quot;If source location is not specified, interface(s) must not be specified&quot;);
      }
  
<span class="line-modified">!     bool non_array = !FieldType::is_array(class_name_symbol);</span>
  
      JavaValue result(T_OBJECT);
      if (non_array) {
        // At this point, we are executing in the context of the boot loader. We
        // cannot call Class.forName because that is context dependent and
<span class="line-new-header">--- 323,23 ---</span>
  
    return k;
  }
  
  Klass* ClassListParser::load_current_class(TRAPS) {
<span class="line-modified">!   TempNewSymbol class_name_symbol = SymbolTable::new_symbol(_class_name);</span>
  
<span class="line-modified">!   Klass* klass = NULL;</span>
    if (!is_loading_from_source()) {
      // Load classes for the boot/platform/app loaders only.
      if (is_super_specified()) {
        error(&quot;If source location is not specified, super class must not be specified&quot;);
      }
      if (are_interfaces_specified()) {
        error(&quot;If source location is not specified, interface(s) must not be specified&quot;);
      }
  
<span class="line-modified">!     bool non_array = !Signature::is_array(class_name_symbol);</span>
  
      JavaValue result(T_OBJECT);
      if (non_array) {
        // At this point, we are executing in the context of the boot loader. We
        // cannot call Class.forName because that is context dependent and
</pre>
<hr />
<pre>
<span class="line-old-header">*** 460,6 ***</span>
    error(&quot;The interface %s implemented by class %s does not match any of the specified interface IDs&quot;,
          interface_name-&gt;as_klass_external_name(), _class_name);
    ShouldNotReachHere();
    return NULL;
  }
<span class="line-removed">- </span>
<span class="line-new-header">--- 458,5 ---</span>
</pre>
<center><a href="classFileStream.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoader.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>