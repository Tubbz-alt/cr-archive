<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/classfile/classLoaderExt.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classLoaderDataGraph.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderExt.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classLoaderExt.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,13 +28,13 @@</span>
  #include &quot;classfile/classLoader.inline.hpp&quot;
  #include &quot;classfile/classLoaderExt.hpp&quot;
  #include &quot;classfile/classLoaderData.inline.hpp&quot;
  #include &quot;classfile/klassFactory.hpp&quot;
  #include &quot;classfile/modules.hpp&quot;
<span class="udiff-line-removed">- #include &quot;classfile/sharedPathsMiscInfo.hpp&quot;</span>
  #include &quot;classfile/systemDictionaryShared.hpp&quot;
  #include &quot;classfile/vmSymbols.hpp&quot;
<span class="udiff-line-added">+ #include &quot;logging/log.hpp&quot;</span>
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/filemap.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;oops/instanceKlass.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,28 +54,27 @@</span>
  bool ClassLoaderExt::_has_platform_classes = false;
  
  void ClassLoaderExt::append_boot_classpath(ClassPathEntry* new_entry) {
    if (UseSharedSpaces) {
      warning(&quot;Sharing is only supported for boot loader classes because bootstrap classpath has been appended&quot;);
<span class="udiff-line-modified-removed">-     FileMapInfo::current_info()-&gt;header()-&gt;set_has_platform_or_app_classes(false);</span>
<span class="udiff-line-modified-added">+     FileMapInfo::current_info()-&gt;set_has_platform_or_app_classes(false);</span>
    }
    ClassLoader::add_to_boot_append_entries(new_entry);
  }
  
  void ClassLoaderExt::setup_app_search_path() {
<span class="udiff-line-modified-removed">-   assert(DumpSharedSpaces, &quot;this function is only used with -Xshare:dump&quot;);</span>
<span class="udiff-line-modified-added">+   Arguments::assert_is_dumping_archive();</span>
    _app_class_paths_start_index = ClassLoader::num_boot_classpath_entries();
    char* app_class_path = os::strdup(Arguments::get_appclasspath());
  
    if (strcmp(app_class_path, &quot;.&quot;) == 0) {
      // This doesn&#39;t make any sense, even for AppCDS, so let&#39;s skip it. We
      // don&#39;t want to throw an error here because -cp &quot;.&quot; is usually assigned
      // by the launcher when classpath is not specified.
      trace_class_path(&quot;app loader class path (skipped)=&quot;, app_class_path);
    } else {
      trace_class_path(&quot;app loader class path=&quot;, app_class_path);
<span class="udiff-line-removed">-     shared_paths_misc_info()-&gt;add_app_classpath(app_class_path);</span>
      ClassLoader::setup_app_search_path(app_class_path);
    }
  }
  
  void ClassLoaderExt::process_module_table(ModuleEntryTable* met, TRAPS) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -90,11 +89,11 @@</span>
        m = m-&gt;next();
      }
    }
  }
  void ClassLoaderExt::setup_module_paths(TRAPS) {
<span class="udiff-line-modified-removed">-   assert(DumpSharedSpaces, &quot;this function is only used with -Xshare:dump&quot;);</span>
<span class="udiff-line-modified-added">+   Arguments::assert_is_dumping_archive();</span>
    _app_module_paths_start_index = ClassLoader::num_boot_classpath_entries() +
                                ClassLoader::num_app_classpath_entries();
    Handle system_class_loader (THREAD, SystemDictionary::java_system_loader());
    ModuleEntryTable* met = Modules::get_module_entry_table(system_class_loader);
    process_module_table(met, THREAD);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -144,11 +143,11 @@</span>
      }
      if (strncmp(tag, line_start, tag_len) == 0) {
        if (found != NULL) {
          // Same behavior as jdk/src/share/classes/java/util/jar/Attributes.java
          // If duplicated entries are found, the last one is used.
<span class="udiff-line-modified-removed">-         tty-&gt;print_cr(&quot;Warning: Duplicate name in Manifest: %s.\n&quot;</span>
<span class="udiff-line-modified-added">+         log_warning(cds)(&quot;Warning: Duplicate name in Manifest: %s.\n&quot;</span>
                        &quot;Ensure that the manifest does not have duplicate entries, and\n&quot;
                        &quot;that blank lines separate individual sections in both your\n&quot;
                        &quot;manifest and in the META-INF/MANIFEST.MF entry in the jar file:\n%s\n&quot;, tag, jar_path);
        }
        found = line_start + tag_len;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,28 +207,31 @@</span>
          ResourceMark rm(THREAD);
          size_t libname_len = dir_len + name_len;
          char* libname = NEW_RESOURCE_ARRAY(char, libname_len + 1);
          int n = os::snprintf(libname, libname_len + 1, &quot;%.*s%s&quot;, dir_len, dir_name, file_start);
          assert((size_t)n == libname_len, &quot;Unexpected number of characters in string&quot;);
<span class="udiff-line-modified-removed">-         trace_class_path(&quot;library = &quot;, libname);</span>
<span class="udiff-line-modified-removed">-         ClassLoader::update_class_path_entry_list(libname, true, false);</span>
<span class="udiff-line-modified-added">+         if (ClassLoader::update_class_path_entry_list(libname, true, false, true /* from_class_path_attr */)) {</span>
<span class="udiff-line-modified-added">+           trace_class_path(&quot;library = &quot;, libname);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+           trace_class_path(&quot;library (non-existent) = &quot;, libname);</span>
<span class="udiff-line-added">+           FileMapInfo::record_non_existent_class_path_entry(libname);</span>
<span class="udiff-line-added">+         }</span>
        }
  
        file_start = file_end;
      }
    }
  }
  
  void ClassLoaderExt::setup_search_paths() {
<span class="udiff-line-removed">-   shared_paths_misc_info()-&gt;record_app_offset();</span>
    ClassLoaderExt::setup_app_search_path();
  }
  
  void ClassLoaderExt::record_result(const s2 classpath_index,
                                     InstanceKlass* result,
                                     TRAPS) {
<span class="udiff-line-modified-removed">-   assert(DumpSharedSpaces, &quot;Sanity&quot;);</span>
<span class="udiff-line-modified-added">+   Arguments::assert_is_dumping_archive();</span>
  
    // We need to remember where the class comes from during dumping.
    oop loader = result-&gt;class_loader();
    s2 classloader_type = ClassLoader::BOOT_LOADER;
    if (SystemDictionary::is_system_class_loader(loader)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,16 +246,10 @@</span>
    }
    result-&gt;set_shared_classpath_index(classpath_index);
    result-&gt;set_class_loader_type(classloader_type);
  }
  
<span class="udiff-line-removed">- void ClassLoaderExt::finalize_shared_paths_misc_info() {</span>
<span class="udiff-line-removed">-   if (!_has_app_classes) {</span>
<span class="udiff-line-removed">-     shared_paths_misc_info()-&gt;pop_app();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  // Load the class of the given name from the location given by path. The path is specified by
  // the &quot;source:&quot; in the class list file (see classListParser.cpp), and can be a directory or
  // a JAR file.
  InstanceKlass* ClassLoaderExt::load_class(Symbol* name, const char* path, TRAPS) {
    assert(name != NULL, &quot;invariant&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -277,11 +273,11 @@</span>
                                 PerfClassTraceTime::CLASS_LOAD);
      stream = e-&gt;open_stream(file_name, CHECK_NULL);
    }
  
    if (NULL == stream) {
<span class="udiff-line-modified-removed">-     tty-&gt;print_cr(&quot;Preload Warning: Cannot find %s&quot;, class_name);</span>
<span class="udiff-line-modified-added">+     log_warning(cds)(&quot;Preload Warning: Cannot find %s&quot;, class_name);</span>
      return NULL;
    }
  
    assert(stream != NULL, &quot;invariant&quot;);
    stream-&gt;set_verify(true);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -296,15 +292,13 @@</span>
                                                             NULL, // unsafe_anonymous_host
                                                             NULL, // cp_patches
                                                             THREAD);
  
    if (HAS_PENDING_EXCEPTION) {
<span class="udiff-line-modified-removed">-     tty-&gt;print_cr(&quot;Preload Error: Failed to load %s&quot;, class_name);</span>
<span class="udiff-line-modified-added">+     log_error(cds)(&quot;Preload Error: Failed to load %s&quot;, class_name);</span>
      return NULL;
    }
<span class="udiff-line-removed">-   result-&gt;set_shared_classpath_index(UNREGISTERED_INDEX);</span>
<span class="udiff-line-removed">-   SystemDictionaryShared::set_shared_class_misc_info(result, stream);</span>
    return result;
  }
  
  struct CachedClassPathEntry {
    const char* _path;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -337,11 +331,11 @@</span>
      // File or directory not found
      return NULL;
    }
    ClassPathEntry* new_entry = NULL;
  
<span class="udiff-line-modified-removed">-   new_entry = create_class_path_entry(path, &amp;st, false, false, CHECK_NULL);</span>
<span class="udiff-line-modified-added">+   new_entry = create_class_path_entry(path, &amp;st, false, false, false, CHECK_NULL);</span>
    if (new_entry == NULL) {
      return NULL;
    }
    ccpe._path = strdup(path);
    ccpe._entry = new_entry;
</pre>
<center><a href="classLoaderDataGraph.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderExt.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>