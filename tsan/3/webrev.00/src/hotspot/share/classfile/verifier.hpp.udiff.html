<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/classfile/verifier.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="verifier.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmSymbols.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/verifier.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,10 +29,11 @@</span>
  #include &quot;oops/klass.hpp&quot;
  #include &quot;oops/method.hpp&quot;
  #include &quot;runtime/handles.hpp&quot;
  #include &quot;utilities/exceptions.hpp&quot;
  #include &quot;utilities/growableArray.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/resourceHash.hpp&quot;</span>
  
  // The verifier class
  class Verifier : AllStatic {
   public:
    enum {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,10 +245,37 @@</span>
    void bytecode_details(outputStream* ss, const Method* method) const;
    void handler_details(outputStream* ss, const Method* method) const;
    void stackmap_details(outputStream* ss, const Method* method) const;
  };
  
<span class="udiff-line-added">+ class sig_as_verification_types : public ResourceObj {</span>
<span class="udiff-line-added">+  private:</span>
<span class="udiff-line-added">+   int _num_args;  // Number of arguments, not including return type.</span>
<span class="udiff-line-added">+   GrowableArray&lt;VerificationType&gt;* _sig_verif_types;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  public:</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   sig_as_verification_types(GrowableArray&lt;VerificationType&gt;* sig_verif_types) :</span>
<span class="udiff-line-added">+     _num_args(0), _sig_verif_types(sig_verif_types) {</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   int num_args() const { return _num_args; }</span>
<span class="udiff-line-added">+   void set_num_args(int num_args) { _num_args = num_args; }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   GrowableArray&lt;VerificationType&gt;* sig_verif_types() { return _sig_verif_types; }</span>
<span class="udiff-line-added">+   void set_sig_verif_types(GrowableArray&lt;VerificationType&gt;* sig_verif_types) {</span>
<span class="udiff-line-added">+     _sig_verif_types = sig_verif_types;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // This hashtable is indexed by the Utf8 constant pool indexes pointed to</span>
<span class="udiff-line-added">+ // by constant pool (Interface)Method_refs&#39; NameAndType signature entries.</span>
<span class="udiff-line-added">+ typedef ResourceHashtable&lt;int, sig_as_verification_types*,</span>
<span class="udiff-line-added">+                           primitive_hash&lt;int&gt;, primitive_equals&lt;int&gt;, 1007&gt;</span>
<span class="udiff-line-added">+                           method_signatures_table_type;</span>
<span class="udiff-line-added">+ </span>
  // A new instance of this class is created for each class being verified
  class ClassVerifier : public StackObj {
   private:
    Thread* _thread;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -255,10 +283,12 @@</span>
    GrowableArray&lt;Symbol*&gt;* _symbols;  // keep a list of symbols created
  
    Symbol* _exception_type;
    char* _message;
  
<span class="udiff-line-added">+   method_signatures_table_type* _method_signatures_table;</span>
<span class="udiff-line-added">+ </span>
    ErrorContext _error_context;  // contains information about an error
  
    void verify_method(const methodHandle&amp; method, TRAPS);
    char* generate_code_data(const methodHandle&amp; m, u4 code_length, TRAPS);
    void verify_exception_handler_table(u4 code_length, char* code_data,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -381,10 +411,17 @@</span>
    // Verifies the class.  If a verify or class file format error occurs,
    // the &#39;_exception_name&#39; symbols will set to the exception name and
    // the message_buffer will be filled in with the exception message.
    void verify_class(TRAPS);
  
<span class="udiff-line-added">+   // Translates method signature entries into verificationTypes and saves them</span>
<span class="udiff-line-added">+   // in the growable array.</span>
<span class="udiff-line-added">+   void translate_signature(Symbol* const method_sig, sig_as_verification_types* sig_verif_types, TRAPS);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Initializes a sig_as_verification_types entry and puts it in the hash table.</span>
<span class="udiff-line-added">+   void create_method_sig_entry(sig_as_verification_types* sig_verif_types, int sig_index, TRAPS);</span>
<span class="udiff-line-added">+ </span>
    // Return status modes
    Symbol* result() const { return _exception_type; }
    bool has_error() const { return result() != NULL; }
    char* exception_message() {
      stringStream ss;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,23 +435,31 @@</span>
    void verify_error(ErrorContext ctx, const char* fmt, ...) ATTRIBUTE_PRINTF(3, 4);
    void class_format_error(const char* fmt, ...) ATTRIBUTE_PRINTF(2, 3);
  
    Klass* load_class(Symbol* name, TRAPS);
  
<span class="udiff-line-added">+   method_signatures_table_type* method_signatures_table() const {</span>
<span class="udiff-line-added">+     return _method_signatures_table;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void set_method_signatures_table(method_signatures_table_type* method_signatures_table) {</span>
<span class="udiff-line-added">+     _method_signatures_table = method_signatures_table;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    int change_sig_to_verificationType(
<span class="udiff-line-modified-removed">-     SignatureStream* sig_type, VerificationType* inference_type, TRAPS);</span>
<span class="udiff-line-modified-added">+     SignatureStream* sig_type, VerificationType* inference_type);</span>
  
    VerificationType cp_index_to_type(int index, const constantPoolHandle&amp; cp, TRAPS) {
      return VerificationType::reference_type(cp-&gt;klass_name_at(index));
    }
  
    // Keep a list of temporary symbols created during verification because
    // their reference counts need to be decremented when the verifier object
    // goes out of scope.  Since these symbols escape the scope in which they&#39;re
    // created, we can&#39;t use a TempNewSymbol.
<span class="udiff-line-modified-removed">-   Symbol* create_temporary_symbol(const Symbol* s, int begin, int end, TRAPS);</span>
<span class="udiff-line-modified-removed">-   Symbol* create_temporary_symbol(const char *s, int length, TRAPS);</span>
<span class="udiff-line-modified-added">+   Symbol* create_temporary_symbol(const Symbol* s, int begin, int end);</span>
<span class="udiff-line-modified-added">+   Symbol* create_temporary_symbol(const char *s, int length);</span>
    Symbol* create_temporary_symbol(Symbol* s) {
      if (s == _previous_symbol) {
        return s;
      }
      if (!s-&gt;is_permanent()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -426,22 +471,22 @@</span>
      }
      _previous_symbol = s;
      return s;
    }
  
<span class="udiff-line-modified-removed">-   TypeOrigin ref_ctx(const char* str, TRAPS);</span>
<span class="udiff-line-modified-added">+   TypeOrigin ref_ctx(const char* str);</span>
  
  };
  
  inline int ClassVerifier::change_sig_to_verificationType(
<span class="udiff-line-modified-removed">-     SignatureStream* sig_type, VerificationType* inference_type, TRAPS) {</span>
<span class="udiff-line-modified-added">+     SignatureStream* sig_type, VerificationType* inference_type) {</span>
    BasicType bt = sig_type-&gt;type();
    switch (bt) {
      case T_OBJECT:
      case T_ARRAY:
        {
<span class="udiff-line-modified-removed">-         Symbol* name = sig_type-&gt;as_symbol(CHECK_0);</span>
<span class="udiff-line-modified-added">+         Symbol* name = sig_type-&gt;as_symbol();</span>
          // Create another symbol to save as signature stream unreferences this symbol.
          Symbol* name_copy = create_temporary_symbol(name);
          assert(name_copy == name, &quot;symbols don&#39;t match&quot;);
          *inference_type =
            VerificationType::reference_type(name_copy);
</pre>
<center><a href="verifier.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmSymbols.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>