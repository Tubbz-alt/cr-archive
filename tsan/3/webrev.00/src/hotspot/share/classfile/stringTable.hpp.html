<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/classfile/stringTable.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_STRINGTABLE_HPP
 26 #define SHARE_CLASSFILE_STRINGTABLE_HPP
 27 
 28 #include &quot;memory/allocation.hpp&quot;
 29 #include &quot;memory/padded.hpp&quot;
 30 #include &quot;oops/oop.hpp&quot;
 31 #include &quot;oops/weakHandle.hpp&quot;
 32 #include &quot;utilities/tableStatistics.hpp&quot;
 33 
 34 class CompactHashtableWriter;
 35 class JavaThread;
 36 class SerializeClosure;
 37 
 38 class StringTable;
 39 class StringTableConfig;
 40 class StringTableCreateEntry;
 41 
 42 class StringTable : public CHeapObj&lt;mtSymbol&gt;{
 43   friend class VMStructs;
 44   friend class Symbol;
 45   friend class StringTableConfig;
 46   friend class StringTableCreateEntry;
 47 
 48   static volatile bool _has_work;
 49   static volatile size_t _uncleaned_items_count;
 50 
 51   // Set if one bucket is out of balance due to hash algorithm deficiency
 52   static volatile bool _needs_rehashing;
 53 
 54   static void grow(JavaThread* jt);
 55   static void clean_dead_entries(JavaThread* jt);
 56 
 57   static double get_load_factor();
 58   static double get_dead_factor();
 59 
 60   static void check_concurrent_work();
 61   static void trigger_concurrent_work();
 62 
 63   static size_t item_added();
 64   static void item_removed();
 65   static size_t add_items_to_clean(size_t ndead);
 66 
 67   static oop intern(Handle string_or_null_h, const jchar* name, int len, TRAPS);
 68   static oop do_intern(Handle string_or_null, const jchar* name, int len, uintx hash, TRAPS);
 69   static oop do_lookup(const jchar* name, int len, uintx hash);
 70 
 71   static void print_table_statistics(outputStream* st, const char* table_name);
 72 
 73   static bool do_rehash();
 74 
 75  public:
 76   static size_t table_size();
 77   static TableStatistics get_table_statistics();
 78 
 79   static void create_table();
 80 
 81   static void do_concurrent_work(JavaThread* jt);
 82   static bool has_work() { return _has_work; }
 83 
 84   // GC support
 85 
 86   // Must be called before a parallel walk where strings might die.
 87   static void reset_dead_counter() { _uncleaned_items_count = 0; }
 88 
 89   // After the parallel walk this method must be called to trigger
 90   // cleaning. Note it might trigger a resize instead.
 91   static void finish_dead_counter() { check_concurrent_work(); }
 92 
 93   // If GC uses ParState directly it should add the number of cleared
 94   // strings to this method.
 95   static void inc_dead_counter(size_t ndead) { add_items_to_clean(ndead); }
 96 
 97   // Probing
 98   static oop lookup(Symbol* symbol);
 99   static oop lookup(const jchar* chars, int length);
100 
101   // Interning
102   static oop intern(Symbol* symbol, TRAPS);
103   static oop intern(oop string, TRAPS);
104   static oop intern(const char *utf8_string, TRAPS);
105 
106   // Rehash the string table if it gets out of balance
107   static void rehash_table();
108   static bool needs_rehashing() { return _needs_rehashing; }
109   static inline void update_needs_rehash(bool rehash) {
110     if (rehash) {
111       _needs_rehashing = true;
112     }
113   }
114 
115   // Sharing
116  private:
117   static oop lookup_shared(const jchar* name, int len, unsigned int hash) NOT_CDS_JAVA_HEAP_RETURN_(NULL);
118   static void copy_shared_string_table(CompactHashtableWriter* ch_table) NOT_CDS_JAVA_HEAP_RETURN;
119  public:
120   static oop create_archived_string(oop s, Thread* THREAD) NOT_CDS_JAVA_HEAP_RETURN_(NULL);
121   static void shared_oops_do(OopClosure* f) NOT_CDS_JAVA_HEAP_RETURN;
122   static void write_to_archive() NOT_CDS_JAVA_HEAP_RETURN;
123   static void serialize_shared_table_header(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;
124 
125   // Jcmd
126   static void dump(outputStream* st, bool verbose=false);
127   // Debugging
128   static size_t verify_and_compare_entries();
129   static void verify();
130 };
131 
132 #endif // SHARE_CLASSFILE_STRINGTABLE_HPP
    </pre>
  </body>
</html>