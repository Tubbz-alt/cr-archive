<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/classfile/systemDictionary.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="systemDictionary.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionary.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,15 +23,15 @@</span>
   */
  
  #ifndef SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
  #define SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
  
<span class="udiff-line-modified-removed">- #include &quot;classfile/classLoader.hpp&quot;</span>
<span class="udiff-line-removed">- #include &quot;jvmci/systemDictionary_jvmci.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;classfile/classLoaderData.hpp&quot;</span>
  #include &quot;oops/objArrayOop.hpp&quot;
  #include &quot;oops/symbol.hpp&quot;
  #include &quot;runtime/java.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/mutexLocker.hpp&quot;</span>
  #include &quot;runtime/reflectionUtils.hpp&quot;
  #include &quot;runtime/signature.hpp&quot;
  #include &quot;utilities/hashtable.hpp&quot;
  
  // The dictionary in each ClassLoaderData stores all loaded classes, either
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -71,21 +71,21 @@</span>
  // Note that placeholders are deleted at any time, as they are removed
  // when a class is completely loaded. Therefore, readers as well as writers
  // of placeholders must hold the SystemDictionary_lock.
  //
  
<span class="udiff-line-added">+ class BootstrapInfo;</span>
  class ClassFileStream;
  class Dictionary;
  class PlaceholderTable;
  class LoaderConstraintTable;
  template &lt;MEMFLAGS F&gt; class HashtableBucket;
  class ResolutionErrorTable;
  class SymbolPropertyTable;
  class ProtectionDomainCacheTable;
  class ProtectionDomainCacheEntry;
  class GCTimer;
<span class="udiff-line-removed">- class OopStorage;</span>
  
  #define WK_KLASS_ENUM_NAME(kname)    kname##_knum
  
  // Certain classes, such as java.lang.Object and java.lang.String,
  // are &quot;well-known&quot;, in the sense that no class loader is allowed
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -117,10 +117,11 @@</span>
    do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain                        ) \
    do_klass(AccessControlContext_klass,                  java_security_AccessControlContext                    ) \
    do_klass(AccessController_klass,                      java_security_AccessController                        ) \
    do_klass(SecureClassLoader_klass,                     java_security_SecureClassLoader                       ) \
    do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException                      ) \
<span class="udiff-line-added">+   do_klass(Record_klass,                                java_lang_Record                                      ) \</span>
    do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError                        ) \
    do_klass(LinkageError_klass,                          java_lang_LinkageError                                ) \
    do_klass(ClassCastException_klass,                    java_lang_ClassCastException                          ) \
    do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException                         ) \
    do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError                         ) \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -153,10 +154,11 @@</span>
    do_klass(reflect_ConstructorAccessorImpl_klass,       reflect_ConstructorAccessorImpl                       ) \
    do_klass(reflect_DelegatingClassLoader_klass,         reflect_DelegatingClassLoader                         ) \
    do_klass(reflect_ConstantPool_klass,                  reflect_ConstantPool                                  ) \
    do_klass(reflect_UnsafeStaticFieldAccessorImpl_klass, reflect_UnsafeStaticFieldAccessorImpl                 ) \
    do_klass(reflect_CallerSensitive_klass,               reflect_CallerSensitive                               ) \
<span class="udiff-line-added">+   do_klass(reflect_NativeConstructorAccessorImpl_klass, reflect_NativeConstructorAccessorImpl                 ) \</span>
                                                                                                                  \
    /* support for dynamic typing; it&#39;s OK if these are NULL in earlier JDKs */                                   \
    do_klass(DirectMethodHandle_klass,                    java_lang_invoke_DirectMethodHandle                   ) \
    do_klass(MethodHandle_klass,                          java_lang_invoke_MethodHandle                         ) \
    do_klass(VarHandle_klass,                             java_lang_invoke_VarHandle                            ) \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,10 +176,11 @@</span>
    /* Note: MethodHandle must be first, and VolatileCallSite last in group */                                    \
                                                                                                                  \
    do_klass(AssertionStatusDirectives_klass,             java_lang_AssertionStatusDirectives                   ) \
    do_klass(StringBuffer_klass,                          java_lang_StringBuffer                                ) \
    do_klass(StringBuilder_klass,                         java_lang_StringBuilder                               ) \
<span class="udiff-line-added">+   do_klass(UnsafeConstants_klass,                       jdk_internal_misc_UnsafeConstants                     ) \</span>
    do_klass(internal_Unsafe_klass,                       jdk_internal_misc_Unsafe                              ) \
    do_klass(module_Modules_klass,                        jdk_internal_module_Modules                           ) \
                                                                                                                  \
    /* support for CDS */                                                                                         \
    do_klass(ByteArrayInputStream_klass,                  java_io_ByteArrayInputStream                          ) \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -210,17 +213,20 @@</span>
    do_klass(Byte_klass,                                  java_lang_Byte                                        ) \
    do_klass(Short_klass,                                 java_lang_Short                                       ) \
    do_klass(Integer_klass,                               java_lang_Integer                                     ) \
    do_klass(Long_klass,                                  java_lang_Long                                        ) \
                                                                                                                  \
<span class="udiff-line-modified-removed">-   /* JVMCI classes. These are loaded on-demand. */                                                              \</span>
<span class="udiff-line-modified-removed">-   JVMCI_WK_KLASSES_DO(do_klass)                                                                                 \</span>
<span class="udiff-line-modified-added">+   /* force inline of iterators */                                                                               \</span>
<span class="udiff-line-modified-added">+   do_klass(Iterator_klass,                              java_util_Iterator                                    ) \</span>
<span class="udiff-line-added">+                                                                                                                 \</span>
<span class="udiff-line-added">+   /* support for records */                                                                                     \</span>
<span class="udiff-line-added">+   do_klass(RecordComponent_klass,                       java_lang_reflect_RecordComponent                     ) \</span>
                                                                                                                  \
    /*end*/
  
<span class="udiff-line-removed">- </span>
  class SystemDictionary : AllStatic {
<span class="udiff-line-added">+   friend class BootstrapInfo;</span>
    friend class VMStructs;
    friend class SystemDictionaryHandles;
  
   public:
    enum WKID {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,15 +236,10 @@</span>
      WK_KLASSES_DO(WK_KLASS_ENUM)
      #undef WK_KLASS_ENUM
  
      WKID_LIMIT,
  
<span class="udiff-line-removed">- #if INCLUDE_JVMCI</span>
<span class="udiff-line-removed">-     FIRST_JVMCI_WKID = WK_KLASS_ENUM_NAME(JVMCI_klass),</span>
<span class="udiff-line-removed">-     LAST_JVMCI_WKID  = WK_KLASS_ENUM_NAME(Value_klass),</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
      FIRST_WKID = NO_WKID + 1
    };
  
    // Returns a class with a given class name and class loader.  Loads the
    // class if needed. If not found a NoClassDefFoundError or a
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -348,31 +349,26 @@</span>
    // Unload (that is, break root links to) all unmarked classes and
    // loaders.  Returns &quot;true&quot; iff something was unloaded.
    static bool do_unloading(GCTimer* gc_timer);
  
    // Applies &quot;f-&gt;do_oop&quot; to all root oops in the system dictionary.
<span class="udiff-line-modified-removed">-   static void oops_do(OopClosure* f);</span>
<span class="udiff-line-modified-added">+   // If include_handles is true (the default), then the handles in the</span>
<span class="udiff-line-added">+   // vm_global OopStorage object are included.</span>
<span class="udiff-line-added">+   static void oops_do(OopClosure* f, bool include_handles = true);</span>
  
    // System loader lock
    static oop system_loader_lock()           { return _system_loader_lock_obj; }
  
    // Protection Domain Table
    static ProtectionDomainCacheTable* pd_cache_table() { return _pd_cache_table; }
  
  public:
    // Printing
<span class="udiff-line-modified-removed">-   static void print() { return print_on(tty); }</span>
<span class="udiff-line-modified-added">+   static void print();</span>
    static void print_on(outputStream* st);
    static void dump(outputStream* st, bool verbose);
  
<span class="udiff-line-removed">-   // Monotonically increasing counter which grows as classes are</span>
<span class="udiff-line-removed">-   // loaded or modifications such as hot-swapping or setting/removing</span>
<span class="udiff-line-removed">-   // of breakpoints are performed</span>
<span class="udiff-line-removed">-   static inline int number_of_modifications()     { assert_locked_or_safepoint(Compile_lock); return _number_of_modifications; }</span>
<span class="udiff-line-removed">-   // Needed by evolution and breakpoint code</span>
<span class="udiff-line-removed">-   static inline void notice_modification()        { assert_locked_or_safepoint(Compile_lock); ++_number_of_modifications;      }</span>
<span class="udiff-line-removed">- </span>
    // Verification
    static void verify();
  
    // Initialization
    static void initialize(TRAPS);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,11 +384,10 @@</span>
    static void resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS);
    static void resolve_wk_klasses_through(WKID end_id, WKID &amp;start_id, TRAPS) {
      int limit = (int)end_id + 1;
      resolve_wk_klasses_until((WKID) limit, start_id, THREAD);
    }
<span class="udiff-line-removed">- </span>
  public:
    #define WK_KLASS_DECLARE(name, symbol) \
      static InstanceKlass* name() { return check_klass(_well_known_klasses[WK_KLASS_ENUM_NAME(name)]); } \
      static InstanceKlass** name##_addr() {                                                              \
        return &amp;_well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)];                          \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -435,13 +430,10 @@</span>
    static ClassLoaderData *class_loader_data(Handle class_loader) {
      return ClassLoaderData::class_loader_data(class_loader());
    }
  
  public:
<span class="udiff-line-removed">-   // Tells whether ClassLoader.checkPackageAccess is present</span>
<span class="udiff-line-removed">-   static bool has_checkPackageAccess()      { return _has_checkPackageAccess; }</span>
<span class="udiff-line-removed">- </span>
    static bool Parameter_klass_loaded()      { return WK_KLASS(reflect_Parameter_klass) != NULL; }
    static bool Class_klass_loaded()          { return WK_KLASS(Class_klass) != NULL; }
    static bool Cloneable_klass_loaded()      { return WK_KLASS(Cloneable_klass) != NULL; }
    static bool Object_klass_loaded()         { return WK_KLASS(Object_klass) != NULL; }
    static bool ClassLoader_klass_loaded()    { return WK_KLASS(ClassLoader_klass) != NULL; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -474,21 +466,21 @@</span>
                                           Handle loader2, bool is_method, TRAPS);
  
    // JSR 292
    // find a java.lang.invoke.MethodHandle.invoke* method for a given signature
    // (asks Java to compute it if necessary, except in a compiler thread)
<span class="udiff-line-modified-removed">-   static methodHandle find_method_handle_invoker(Klass* klass,</span>
<span class="udiff-line-modified-removed">-                                                  Symbol* name,</span>
<span class="udiff-line-modified-removed">-                                                  Symbol* signature,</span>
<span class="udiff-line-modified-removed">-                                                  Klass* accessing_klass,</span>
<span class="udiff-line-modified-removed">-                                                  Handle *appendix_result,</span>
<span class="udiff-line-modified-removed">-                                                  TRAPS);</span>
<span class="udiff-line-modified-added">+   static Method* find_method_handle_invoker(Klass* klass,</span>
<span class="udiff-line-modified-added">+                                             Symbol* name,</span>
<span class="udiff-line-modified-added">+                                             Symbol* signature,</span>
<span class="udiff-line-modified-added">+                                             Klass* accessing_klass,</span>
<span class="udiff-line-modified-added">+                                             Handle *appendix_result,</span>
<span class="udiff-line-modified-added">+                                             TRAPS);</span>
    // for a given signature, find the internal MethodHandle method (linkTo* or invokeBasic)
    // (does not ask Java, since this is a low-level intrinsic defined by the JVM)
<span class="udiff-line-modified-removed">-   static methodHandle find_method_handle_intrinsic(vmIntrinsics::ID iid,</span>
<span class="udiff-line-modified-removed">-                                                    Symbol* signature,</span>
<span class="udiff-line-modified-removed">-                                                    TRAPS);</span>
<span class="udiff-line-modified-added">+   static Method* find_method_handle_intrinsic(vmIntrinsics::ID iid,</span>
<span class="udiff-line-modified-added">+                                               Symbol* signature,</span>
<span class="udiff-line-modified-added">+                                               TRAPS);</span>
  
    // compute java_mirror (java.lang.Class instance) for a type (&quot;I&quot;, &quot;[[B&quot;, &quot;LFoo;&quot;, etc.)
    // Either the accessing_klass or the CL/PD can be non-null, but not both.
    static Handle    find_java_mirror_for_type(Symbol* signature,
                                               Klass* accessing_klass,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -503,14 +495,10 @@</span>
      // callee will fill in CL/PD from AK, if they are needed
      return find_java_mirror_for_type(signature, accessing_klass, Handle(), Handle(),
                                       failure_mode, THREAD);
    }
  
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // fast short-cut for the one-character case:</span>
<span class="udiff-line-removed">-   static oop       find_java_mirror_for_type(char signature_char);</span>
<span class="udiff-line-removed">- </span>
    // find a java.lang.invoke.MethodType object for a given signature
    // (asks Java to compute it if necessary, except in a compiler thread)
    static Handle    find_method_handle_type(Symbol* signature,
                                             Klass* accessing_klass,
                                             TRAPS);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -527,25 +515,11 @@</span>
                                                 Symbol* name,
                                                 Symbol* signature,
                                                 TRAPS);
  
    // ask Java to compute a constant by invoking a BSM given a Dynamic_info CP entry
<span class="udiff-line-modified-removed">-   static Handle    link_dynamic_constant(Klass* caller,</span>
<span class="udiff-line-removed">-                                          int condy_index,</span>
<span class="udiff-line-removed">-                                          Handle bootstrap_specifier,</span>
<span class="udiff-line-removed">-                                          Symbol* name,</span>
<span class="udiff-line-removed">-                                          Symbol* type,</span>
<span class="udiff-line-removed">-                                          TRAPS);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // ask Java to create a dynamic call site, while linking an invokedynamic op</span>
<span class="udiff-line-removed">-   static methodHandle find_dynamic_call_site_invoker(Klass* caller,</span>
<span class="udiff-line-removed">-                                                      int indy_index,</span>
<span class="udiff-line-removed">-                                                      Handle bootstrap_method,</span>
<span class="udiff-line-removed">-                                                      Symbol* name,</span>
<span class="udiff-line-removed">-                                                      Symbol* type,</span>
<span class="udiff-line-removed">-                                                      Handle *appendix_result,</span>
<span class="udiff-line-removed">-                                                      TRAPS);</span>
<span class="udiff-line-modified-added">+   static void      invoke_bootstrap_method(BootstrapInfo&amp; bootstrap_specifier, TRAPS);</span>
  
    // Record the error when the first attempt to resolve a reference from a constant
    // pool entry to a class fails.
    static void add_resolution_error(const constantPoolHandle&amp; pool, int which, Symbol* error,
                                     Symbol* message);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -569,15 +543,10 @@</span>
    // Static tables owned by the SystemDictionary
  
    // Hashtable holding placeholders for classes being loaded.
    static PlaceholderTable*       _placeholders;
  
<span class="udiff-line-removed">-   // Monotonically increasing counter which grows with</span>
<span class="udiff-line-removed">-   // loading classes as well as hot-swapping and breakpoint setting</span>
<span class="udiff-line-removed">-   // and removal.</span>
<span class="udiff-line-removed">-   static int                     _number_of_modifications;</span>
<span class="udiff-line-removed">- </span>
    // Lock object for system class loader
    static oop                     _system_loader_lock_obj;
  
    // Constraints on class loaders
    static LoaderConstraintTable*  _loader_constraints;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -589,13 +558,10 @@</span>
    static SymbolPropertyTable*    _invoke_method_table;
  
    // ProtectionDomain cache
    static ProtectionDomainCacheTable*   _pd_cache_table;
  
<span class="udiff-line-removed">-   // VM weak OopStorage object.</span>
<span class="udiff-line-removed">-   static OopStorage*             _vm_weak_oop_storage;</span>
<span class="udiff-line-removed">- </span>
  protected:
    static void validate_protection_domain(InstanceKlass* klass,
                                           Handle class_loader,
                                           Handle protection_domain, TRAPS);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -646,13 +612,10 @@</span>
    static bool is_nonpublic_Object_method(Method* m) {
      assert(m != NULL, &quot;Unexpected NULL Method*&quot;);
      return !m-&gt;is_public() &amp;&amp; m-&gt;method_holder() == SystemDictionary::Object_klass();
    }
  
<span class="udiff-line-removed">-   static void initialize_oop_storage();</span>
<span class="udiff-line-removed">-   static OopStorage* vm_weak_oop_storage();</span>
<span class="udiff-line-removed">- </span>
  protected:
    // Setup link to hierarchy
    static void add_to_hierarchy(InstanceKlass* k, TRAPS);
  
    // Basic find on loaded classes
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -661,25 +624,10 @@</span>
    static InstanceKlass* find_class(Symbol* class_name, ClassLoaderData* loader_data);
  
    // Basic find on classes in the midst of being loaded
    static Symbol* find_placeholder(Symbol* name, ClassLoaderData* loader_data);
  
<span class="udiff-line-removed">-   // Add a placeholder for a class being loaded</span>
<span class="udiff-line-removed">-   static void add_placeholder(int index,</span>
<span class="udiff-line-removed">-                               Symbol* class_name,</span>
<span class="udiff-line-removed">-                               ClassLoaderData* loader_data);</span>
<span class="udiff-line-removed">-   static void remove_placeholder(int index,</span>
<span class="udiff-line-removed">-                                  Symbol* class_name,</span>
<span class="udiff-line-removed">-                                  ClassLoaderData* loader_data);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Performs cleanups after resolve_super_or_fail. This typically needs</span>
<span class="udiff-line-removed">-   // to be called on failure.</span>
<span class="udiff-line-removed">-   // Won&#39;t throw, but can block.</span>
<span class="udiff-line-removed">-   static void resolution_cleanups(Symbol* class_name,</span>
<span class="udiff-line-removed">-                                   ClassLoaderData* loader_data,</span>
<span class="udiff-line-removed">-                                   TRAPS);</span>
<span class="udiff-line-removed">- </span>
    // Resolve well-known classes so they can be used like SystemDictionary::String_klass()
    static void resolve_well_known_classes(TRAPS);
  
    // Class loader constraints
    static void check_constraints(unsigned int hash,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -697,9 +645,12 @@</span>
  
  private:
    static oop  _java_system_loader;
    static oop  _java_platform_loader;
  
<span class="udiff-line-modified-removed">-   static bool _has_checkPackageAccess;</span>
<span class="udiff-line-modified-added">+ public:</span>
<span class="udiff-line-added">+   static TableStatistics placeholders_statistics();</span>
<span class="udiff-line-added">+   static TableStatistics loader_constraints_statistics();</span>
<span class="udiff-line-added">+   static TableStatistics protection_domain_cache_statistics();</span>
  };
  
  #endif // SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
</pre>
<center><a href="systemDictionary.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>