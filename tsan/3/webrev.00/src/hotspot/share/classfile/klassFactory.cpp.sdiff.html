<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/klassFactory.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="javaClasses.inline.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metadataOnStackMark.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/klassFactory.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 41 #endif
 42 
 43 
 44 // called during initial loading of a shared class
 45 InstanceKlass* KlassFactory::check_shared_class_file_load_hook(
 46                                           InstanceKlass* ik,
 47                                           Symbol* class_name,
 48                                           Handle class_loader,
 49                                           Handle protection_domain,
 50                                           const ClassFileStream *cfs,
 51                                           TRAPS) {
 52 #if INCLUDE_CDS &amp;&amp; INCLUDE_JVMTI
 53   assert(ik != NULL, &quot;sanity&quot;);
 54   assert(ik-&gt;is_shared(), &quot;expecting a shared class&quot;);
 55   if (JvmtiExport::should_post_class_file_load_hook()) {
 56     assert(THREAD-&gt;is_Java_thread(), &quot;must be JavaThread&quot;);
 57 
 58     // Post the CFLH
 59     JvmtiCachedClassFileData* cached_class_file = NULL;
 60     if (cfs == NULL) {
<span class="line-modified"> 61       cfs = FileMapInfo::open_stream_for_jvmti(ik, CHECK_NULL);</span>
 62     }
 63     unsigned char* ptr = (unsigned char*)cfs-&gt;buffer();
 64     unsigned char* end_ptr = ptr + cfs-&gt;length();
 65     unsigned char* old_ptr = ptr;
 66     JvmtiExport::post_class_file_load_hook(class_name,
 67                                            class_loader,
 68                                            protection_domain,
 69                                            &amp;ptr,
 70                                            &amp;end_ptr,
 71                                            &amp;cached_class_file);
 72     if (old_ptr != ptr) {
 73       // JVMTI agent has modified class file data.
 74       // Set new class file stream using JVMTI agent modified class file data.
 75       ClassLoaderData* loader_data =
 76         ClassLoaderData::class_loader_data(class_loader());
 77       int path_index = ik-&gt;shared_classpath_index();
 78       ClassFileStream* stream = new ClassFileStream(ptr,
 79                                                     end_ptr - ptr,
 80                                                     cfs-&gt;source(),
 81                                                     ClassFileStream::verify);
</pre>
<hr />
<pre>
201                          unsafe_anonymous_host,
202                          cp_patches,
203                          ClassFileParser::BROADCAST, // publicity level
204                          CHECK_NULL);
205 
206   InstanceKlass* result = parser.create_instance_klass(old_stream != stream, CHECK_NULL);
207   assert(result == parser.create_instance_klass(old_stream != stream, THREAD), &quot;invariant&quot;);
208 
209   if (result == NULL) {
210     return NULL;
211   }
212 
213   if (cached_class_file != NULL) {
214     // JVMTI: we have an InstanceKlass now, tell it about the cached bytes
215     result-&gt;set_cached_class_file(cached_class_file);
216   }
217 
218   JFR_ONLY(ON_KLASS_CREATION(result, parser, THREAD);)
219 
220 #if INCLUDE_CDS
<span class="line-modified">221   if (DumpSharedSpaces) {</span>
222     ClassLoader::record_result(result, stream, THREAD);
223   }
224 #endif // INCLUDE_CDS
225 
226   return result;
227 }
</pre>
</td>
<td>
<hr />
<pre>
 41 #endif
 42 
 43 
 44 // called during initial loading of a shared class
 45 InstanceKlass* KlassFactory::check_shared_class_file_load_hook(
 46                                           InstanceKlass* ik,
 47                                           Symbol* class_name,
 48                                           Handle class_loader,
 49                                           Handle protection_domain,
 50                                           const ClassFileStream *cfs,
 51                                           TRAPS) {
 52 #if INCLUDE_CDS &amp;&amp; INCLUDE_JVMTI
 53   assert(ik != NULL, &quot;sanity&quot;);
 54   assert(ik-&gt;is_shared(), &quot;expecting a shared class&quot;);
 55   if (JvmtiExport::should_post_class_file_load_hook()) {
 56     assert(THREAD-&gt;is_Java_thread(), &quot;must be JavaThread&quot;);
 57 
 58     // Post the CFLH
 59     JvmtiCachedClassFileData* cached_class_file = NULL;
 60     if (cfs == NULL) {
<span class="line-modified"> 61       cfs = FileMapInfo::open_stream_for_jvmti(ik, class_loader, CHECK_NULL);</span>
 62     }
 63     unsigned char* ptr = (unsigned char*)cfs-&gt;buffer();
 64     unsigned char* end_ptr = ptr + cfs-&gt;length();
 65     unsigned char* old_ptr = ptr;
 66     JvmtiExport::post_class_file_load_hook(class_name,
 67                                            class_loader,
 68                                            protection_domain,
 69                                            &amp;ptr,
 70                                            &amp;end_ptr,
 71                                            &amp;cached_class_file);
 72     if (old_ptr != ptr) {
 73       // JVMTI agent has modified class file data.
 74       // Set new class file stream using JVMTI agent modified class file data.
 75       ClassLoaderData* loader_data =
 76         ClassLoaderData::class_loader_data(class_loader());
 77       int path_index = ik-&gt;shared_classpath_index();
 78       ClassFileStream* stream = new ClassFileStream(ptr,
 79                                                     end_ptr - ptr,
 80                                                     cfs-&gt;source(),
 81                                                     ClassFileStream::verify);
</pre>
<hr />
<pre>
201                          unsafe_anonymous_host,
202                          cp_patches,
203                          ClassFileParser::BROADCAST, // publicity level
204                          CHECK_NULL);
205 
206   InstanceKlass* result = parser.create_instance_klass(old_stream != stream, CHECK_NULL);
207   assert(result == parser.create_instance_klass(old_stream != stream, THREAD), &quot;invariant&quot;);
208 
209   if (result == NULL) {
210     return NULL;
211   }
212 
213   if (cached_class_file != NULL) {
214     // JVMTI: we have an InstanceKlass now, tell it about the cached bytes
215     result-&gt;set_cached_class_file(cached_class_file);
216   }
217 
218   JFR_ONLY(ON_KLASS_CREATION(result, parser, THREAD);)
219 
220 #if INCLUDE_CDS
<span class="line-modified">221   if (Arguments::is_dumping_archive()) {</span>
222     ClassLoader::record_result(result, stream, THREAD);
223   }
224 #endif // INCLUDE_CDS
225 
226   return result;
227 }
</pre>
</td>
</tr>
</table>
<center><a href="javaClasses.inline.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metadataOnStackMark.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>