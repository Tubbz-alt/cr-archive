<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/classfile/verificationType.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/symbolTable.hpp&quot;
 27 #include &quot;classfile/systemDictionaryShared.hpp&quot;
 28 #include &quot;classfile/verificationType.hpp&quot;
 29 #include &quot;classfile/verifier.hpp&quot;
 30 #include &quot;logging/log.hpp&quot;
<a name="2" id="anc2"></a>
 31 #include &quot;runtime/handles.inline.hpp&quot;
 32 
 33 VerificationType VerificationType::from_tag(u1 tag) {
 34   switch (tag) {
 35     case ITEM_Top:     return bogus_type();
 36     case ITEM_Integer: return integer_type();
 37     case ITEM_Float:   return float_type();
 38     case ITEM_Double:  return double_type();
 39     case ITEM_Long:    return long_type();
 40     case ITEM_Null:    return null_type();
 41     default:
 42       ShouldNotReachHere();
 43       return bogus_type();
 44   }
 45 }
 46 
 47 bool VerificationType::resolve_and_check_assignability(InstanceKlass* klass, Symbol* name,
 48          Symbol* from_name, bool from_field_is_protected, bool from_is_array, bool from_is_object, TRAPS) {
 49   HandleMark hm(THREAD);
 50   Klass* this_class = SystemDictionary::resolve_or_fail(
 51       name, Handle(THREAD, klass-&gt;class_loader()),
 52       Handle(THREAD, klass-&gt;protection_domain()), true, CHECK_false);
 53   if (log_is_enabled(Debug, class, resolve)) {
 54     Verifier::trace_class_resolution(this_class, klass);
 55   }
 56 
 57   if (this_class-&gt;is_interface() &amp;&amp; (!from_field_is_protected ||
 58       from_name != vmSymbols::java_lang_Object())) {
 59     // If we are not trying to access a protected field or method in
 60     // java.lang.Object then, for arrays, we only allow assignability
 61     // to interfaces java.lang.Cloneable and java.io.Serializable.
 62     // Otherwise, we treat interfaces as java.lang.Object.
 63     return !from_is_array ||
 64       this_class == SystemDictionary::Cloneable_klass() ||
 65       this_class == SystemDictionary::Serializable_klass();
 66   } else if (from_is_object) {
 67     Klass* from_class = SystemDictionary::resolve_or_fail(
 68         from_name, Handle(THREAD, klass-&gt;class_loader()),
 69         Handle(THREAD, klass-&gt;protection_domain()), true, CHECK_false);
 70     if (log_is_enabled(Debug, class, resolve)) {
 71       Verifier::trace_class_resolution(from_class, klass);
 72     }
<a name="3" id="anc3"></a><span class="line-modified"> 73     return InstanceKlass::cast(from_class)-&gt;is_subclass_of(this_class);</span>
 74   }
 75 
 76   return false;
 77 }
 78 
 79 bool VerificationType::is_reference_assignable_from(
 80     const VerificationType&amp; from, ClassVerifier* context,
 81     bool from_field_is_protected, TRAPS) const {
 82   InstanceKlass* klass = context-&gt;current_class();
 83   if (from.is_null()) {
 84     // null is assignable to any reference
 85     return true;
 86   } else if (is_null()) {
 87     return false;
 88   } else if (name() == from.name()) {
 89     return true;
 90   } else if (is_object()) {
 91     // We need check the class hierarchy to check assignability
 92     if (name() == vmSymbols::java_lang_Object()) {
 93       // any object or array is assignable to java.lang.Object
 94       return true;
 95     }
 96 
<a name="4" id="anc4"></a><span class="line-modified"> 97     if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::add_verification_constraint(klass,</span>

 98               name(), from.name(), from_field_is_protected, from.is_array(),
 99               from.is_object())) {
<a name="5" id="anc5"></a><span class="line-modified">100       // If add_verification_constraint() returns true, the resolution/check should be</span>
<span class="line-modified">101       // delayed until runtime.</span>
<span class="line-modified">102       return true;</span>

103     }
104 
105     return resolve_and_check_assignability(klass, name(), from.name(),
106           from_field_is_protected, from.is_array(), from.is_object(), THREAD);
107   } else if (is_array() &amp;&amp; from.is_array()) {
108     VerificationType comp_this = get_component(context, CHECK_false);
109     VerificationType comp_from = from.get_component(context, CHECK_false);
110     if (!comp_this.is_bogus() &amp;&amp; !comp_from.is_bogus()) {
111       return comp_this.is_component_assignable_from(comp_from, context,
112                                                     from_field_is_protected, THREAD);
113     }
114   }
115   return false;
116 }
117 
118 VerificationType VerificationType::get_component(ClassVerifier *context, TRAPS) const {
119   assert(is_array() &amp;&amp; name()-&gt;utf8_length() &gt;= 2, &quot;Must be a valid array&quot;);
<a name="6" id="anc6"></a><span class="line-modified">120   Symbol* component;</span>
<span class="line-modified">121   switch (name()-&gt;char_at(1)) {</span>
<span class="line-modified">122     case &#39;Z&#39;: return VerificationType(Boolean);</span>
<span class="line-modified">123     case &#39;B&#39;: return VerificationType(Byte);</span>
<span class="line-modified">124     case &#39;C&#39;: return VerificationType(Char);</span>
<span class="line-modified">125     case &#39;S&#39;: return VerificationType(Short);</span>
<span class="line-modified">126     case &#39;I&#39;: return VerificationType(Integer);</span>
<span class="line-modified">127     case &#39;J&#39;: return VerificationType(Long);</span>
<span class="line-modified">128     case &#39;F&#39;: return VerificationType(Float);</span>
<span class="line-modified">129     case &#39;D&#39;: return VerificationType(Double);</span>
<span class="line-modified">130     case &#39;[&#39;:</span>
<span class="line-modified">131       component = context-&gt;create_temporary_symbol(</span>
<span class="line-modified">132         name(), 1, name()-&gt;utf8_length(),</span>
<span class="line-modified">133         CHECK_(VerificationType::bogus_type()));</span>
<span class="line-modified">134       return VerificationType::reference_type(component);</span>
<span class="line-modified">135     case &#39;L&#39;:</span>
<span class="line-modified">136       component = context-&gt;create_temporary_symbol(</span>
<span class="line-modified">137         name(), 2, name()-&gt;utf8_length() - 1,</span>
<span class="line-modified">138         CHECK_(VerificationType::bogus_type()));</span>
<span class="line-modified">139       return VerificationType::reference_type(component);</span>
<span class="line-modified">140     default:</span>
<span class="line-modified">141       // Met an invalid type signature, e.g. [X</span>
<span class="line-modified">142       return VerificationType::bogus_type();</span>
143   }
144 }
145 
146 void VerificationType::print_on(outputStream* st) const {
147   switch (_u._data) {
148     case Bogus:            st-&gt;print(&quot;top&quot;); break;
149     case Category1:        st-&gt;print(&quot;category1&quot;); break;
150     case Category2:        st-&gt;print(&quot;category2&quot;); break;
151     case Category2_2nd:    st-&gt;print(&quot;category2_2nd&quot;); break;
152     case Boolean:          st-&gt;print(&quot;boolean&quot;); break;
153     case Byte:             st-&gt;print(&quot;byte&quot;); break;
154     case Short:            st-&gt;print(&quot;short&quot;); break;
155     case Char:             st-&gt;print(&quot;char&quot;); break;
156     case Integer:          st-&gt;print(&quot;integer&quot;); break;
157     case Float:            st-&gt;print(&quot;float&quot;); break;
158     case Long:             st-&gt;print(&quot;long&quot;); break;
159     case Double:           st-&gt;print(&quot;double&quot;); break;
160     case Long_2nd:         st-&gt;print(&quot;long_2nd&quot;); break;
161     case Double_2nd:       st-&gt;print(&quot;double_2nd&quot;); break;
162     case Null:             st-&gt;print(&quot;null&quot;); break;
163     case ReferenceQuery:   st-&gt;print(&quot;reference type&quot;); break;
164     case Category1Query:   st-&gt;print(&quot;category1 type&quot;); break;
165     case Category2Query:   st-&gt;print(&quot;category2 type&quot;); break;
166     case Category2_2ndQuery: st-&gt;print(&quot;category2_2nd type&quot;); break;
167     default:
168       if (is_uninitialized_this()) {
169         st-&gt;print(&quot;uninitializedThis&quot;);
170       } else if (is_uninitialized()) {
171         st-&gt;print(&quot;uninitialized %d&quot;, bci());
172       } else {
173         if (name() != NULL) {
174           name()-&gt;print_value_on(st);
175         } else {
176           st-&gt;print_cr(&quot;NULL&quot;);
177         }
178       }
179   }
180 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>