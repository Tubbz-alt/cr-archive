<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/classfile/vmSymbols.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="verifier.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmSymbols.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/vmSymbols.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,10 ***</span>
<span class="line-new-header">--- 22,11 ---</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;jvm.h&quot;
<span class="line-added">+ #include &quot;classfile/symbolTable.hpp&quot;</span>
  #include &quot;classfile/vmSymbols.hpp&quot;
  #include &quot;compiler/compilerDirectives.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/oopFactory.hpp&quot;
  #include &quot;memory/metaspaceClosure.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 81,11 ***</span>
    assert(vmIntrinsics::FLAG_LIMIT &lt;= (1 &lt;&lt; vmIntrinsics::log2_FLAG_LIMIT), &quot;must fit in this bitfield&quot;);
  
    if (!UseSharedSpaces) {
      const char* string = &amp;vm_symbol_bodies[0];
      for (int index = (int)FIRST_SID; index &lt; (int)SID_LIMIT; index++) {
<span class="line-modified">!       Symbol* sym = SymbolTable::new_permanent_symbol(string, CHECK);</span>
        _symbols[index] = sym;
        string += strlen(string); // skip string body
        string += 1;              // skip trailing null
      }
  
<span class="line-new-header">--- 82,11 ---</span>
    assert(vmIntrinsics::FLAG_LIMIT &lt;= (1 &lt;&lt; vmIntrinsics::log2_FLAG_LIMIT), &quot;must fit in this bitfield&quot;);
  
    if (!UseSharedSpaces) {
      const char* string = &amp;vm_symbol_bodies[0];
      for (int index = (int)FIRST_SID; index &lt; (int)SID_LIMIT; index++) {
<span class="line-modified">!       Symbol* sym = SymbolTable::new_permanent_symbol(string);</span>
        _symbols[index] = sym;
        string += strlen(string); // skip string body
        string += 1;              // skip trailing null
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 96,17 ***</span>
      _type_signatures[T_INT]     = int_signature();
      _type_signatures[T_LONG]    = long_signature();
      _type_signatures[T_SHORT]   = short_signature();
      _type_signatures[T_BOOLEAN] = bool_signature();
      _type_signatures[T_VOID]    = void_signature();
<span class="line-removed">-     // no single signatures for T_OBJECT or T_ARRAY</span>
  #ifdef ASSERT
      for (int i = (int)T_BOOLEAN; i &lt; (int)T_VOID+1; i++) {
        Symbol* s = _type_signatures[i];
        if (s == NULL)  continue;
<span class="line-modified">!       BasicType st = signature_type(s);</span>
<span class="line-modified">!       assert(st == i, &quot;&quot;);</span>
      }
  #endif
    }
  
  #ifdef ASSERT
<span class="line-new-header">--- 97,17 ---</span>
      _type_signatures[T_INT]     = int_signature();
      _type_signatures[T_LONG]    = long_signature();
      _type_signatures[T_SHORT]   = short_signature();
      _type_signatures[T_BOOLEAN] = bool_signature();
      _type_signatures[T_VOID]    = void_signature();
  #ifdef ASSERT
      for (int i = (int)T_BOOLEAN; i &lt; (int)T_VOID+1; i++) {
        Symbol* s = _type_signatures[i];
        if (s == NULL)  continue;
<span class="line-modified">!       SignatureStream ss(s, false);</span>
<span class="line-modified">!       assert(ss.type() == i, &quot;matching signature&quot;);</span>
<span class="line-added">+       assert(!ss.is_reference(), &quot;no single-char signature for T_OBJECT, etc.&quot;);</span>
      }
  #endif
    }
  
  #ifdef ASSERT
</pre>
<hr />
<pre>
<span class="line-old-header">*** 138,11 ***</span>
  #ifdef ASSERT
    {
      // Spot-check correspondence between strings, symbols, and enums:
      assert(_symbols[NO_SID] == NULL, &quot;must be&quot;);
      const char* str = &quot;java/lang/Object&quot;;
<span class="line-modified">!     TempNewSymbol jlo = SymbolTable::new_permanent_symbol(str, CHECK);</span>
      assert(strncmp(str, (char*)jlo-&gt;base(), jlo-&gt;utf8_length()) == 0, &quot;&quot;);
      assert(jlo == java_lang_Object(), &quot;&quot;);
      SID sid = VM_SYMBOL_ENUM_NAME(java_lang_Object);
      assert(find_sid(jlo) == sid, &quot;&quot;);
      assert(symbol_at(sid) == jlo, &quot;&quot;);
<span class="line-new-header">--- 139,11 ---</span>
  #ifdef ASSERT
    {
      // Spot-check correspondence between strings, symbols, and enums:
      assert(_symbols[NO_SID] == NULL, &quot;must be&quot;);
      const char* str = &quot;java/lang/Object&quot;;
<span class="line-modified">!     TempNewSymbol jlo = SymbolTable::new_permanent_symbol(str);</span>
      assert(strncmp(str, (char*)jlo-&gt;base(), jlo-&gt;utf8_length()) == 0, &quot;&quot;);
      assert(jlo == java_lang_Object(), &quot;&quot;);
      SID sid = VM_SYMBOL_ENUM_NAME(java_lang_Object);
      assert(find_sid(jlo) == sid, &quot;&quot;);
      assert(symbol_at(sid) == jlo, &quot;&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,11 ***</span>
      }
  
      // The string &quot;format&quot; happens (at the moment) not to be a vmSymbol,
      // though it is a method name in java.lang.String.
      str = &quot;format&quot;;
<span class="line-modified">!     TempNewSymbol fmt = SymbolTable::new_permanent_symbol(str, CHECK);</span>
      sid = find_sid(fmt);
      assert(sid == NO_SID, &quot;symbol index works (negative test)&quot;);
    }
  #endif
  }
<span class="line-new-header">--- 158,11 ---</span>
      }
  
      // The string &quot;format&quot; happens (at the moment) not to be a vmSymbol,
      // though it is a method name in java.lang.String.
      str = &quot;format&quot;;
<span class="line-modified">!     TempNewSymbol fmt = SymbolTable::new_permanent_symbol(str);</span>
      sid = find_sid(fmt);
      assert(sid == NO_SID, &quot;symbol index works (negative test)&quot;);
    }
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,24 ***</span>
    soc-&gt;do_region((u_char*)&amp;_symbols[FIRST_SID],
                   (SID_LIMIT - FIRST_SID) * sizeof(_symbols[0]));
    soc-&gt;do_region((u_char*)_type_signatures, sizeof(_type_signatures));
  }
  
<span class="line-removed">- </span>
<span class="line-removed">- BasicType vmSymbols::signature_type(const Symbol* s) {</span>
<span class="line-removed">-   assert(s != NULL, &quot;checking&quot;);</span>
<span class="line-removed">-   if (s-&gt;utf8_length() == 1) {</span>
<span class="line-removed">-     BasicType result = char2type(s-&gt;char_at(0));</span>
<span class="line-removed">-     if (is_java_primitive(result) || result == T_VOID) {</span>
<span class="line-removed">-       assert(s == _type_signatures[result], &quot;&quot;);</span>
<span class="line-removed">-       return result;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   return T_OBJECT;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
  static int mid_hint = (int)vmSymbols::FIRST_SID+1;
  
  #ifndef PRODUCT
  static int find_sid_calls, find_sid_probes;
  // (Typical counts are calls=7000 and probes=17000.)
<span class="line-new-header">--- 207,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 361,10 ***</span>
<span class="line-new-header">--- 348,13 ---</span>
    case vmIntrinsics::_longBitsToDouble:
    case vmIntrinsics::_getClass:
    case vmIntrinsics::_isInstance:
    case vmIntrinsics::_currentThread:
    case vmIntrinsics::_dabs:
<span class="line-added">+   case vmIntrinsics::_fabs:</span>
<span class="line-added">+   case vmIntrinsics::_iabs:</span>
<span class="line-added">+   case vmIntrinsics::_labs:</span>
    case vmIntrinsics::_dsqrt:
    case vmIntrinsics::_dsin:
    case vmIntrinsics::_dcos:
    case vmIntrinsics::_dtan:
    case vmIntrinsics::_dlog:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 402,10 ***</span>
<span class="line-new-header">--- 392,13 ---</span>
    case vmIntrinsics::_intBitsToFloat:
    case vmIntrinsics::_doubleToRawLongBits:
    case vmIntrinsics::_longBitsToDouble:
    case vmIntrinsics::_currentThread:
    case vmIntrinsics::_dabs:
<span class="line-added">+   case vmIntrinsics::_fabs:</span>
<span class="line-added">+   case vmIntrinsics::_iabs:</span>
<span class="line-added">+   case vmIntrinsics::_labs:</span>
    case vmIntrinsics::_dsqrt:
    case vmIntrinsics::_dsin:
    case vmIntrinsics::_dcos:
    case vmIntrinsics::_dtan:
    case vmIntrinsics::_dlog:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 454,10 ***</span>
<span class="line-new-header">--- 447,12 ---</span>
  int vmIntrinsics::predicates_needed(vmIntrinsics::ID id) {
    assert(id != vmIntrinsics::_none, &quot;must be a VM intrinsic&quot;);
    switch (id) {
    case vmIntrinsics::_cipherBlockChaining_encryptAESCrypt:
    case vmIntrinsics::_cipherBlockChaining_decryptAESCrypt:
<span class="line-added">+   case vmIntrinsics::_electronicCodeBook_encryptAESCrypt:</span>
<span class="line-added">+   case vmIntrinsics::_electronicCodeBook_decryptAESCrypt:</span>
    case vmIntrinsics::_counterMode_AESCrypt:
      return 1;
    case vmIntrinsics::_digestBase_implCompressMB:
      return 3;
    default:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 557,18 ***</span>
    case vmIntrinsics::_newArray:
    case vmIntrinsics::_getClass:
      if (!InlineClassNatives) return true;
      break;
    case vmIntrinsics::_currentThread:
<span class="line-removed">-   case vmIntrinsics::_isInterrupted:</span>
      if (!InlineThreadNatives) return true;
      break;
    case vmIntrinsics::_floatToRawIntBits:
    case vmIntrinsics::_intBitsToFloat:
    case vmIntrinsics::_doubleToRawLongBits:
    case vmIntrinsics::_longBitsToDouble:
    case vmIntrinsics::_dabs:
    case vmIntrinsics::_dsqrt:
    case vmIntrinsics::_dsin:
    case vmIntrinsics::_dcos:
    case vmIntrinsics::_dtan:
    case vmIntrinsics::_dlog:
<span class="line-new-header">--- 552,23 ---</span>
    case vmIntrinsics::_newArray:
    case vmIntrinsics::_getClass:
      if (!InlineClassNatives) return true;
      break;
    case vmIntrinsics::_currentThread:
      if (!InlineThreadNatives) return true;
      break;
    case vmIntrinsics::_floatToRawIntBits:
    case vmIntrinsics::_intBitsToFloat:
    case vmIntrinsics::_doubleToRawLongBits:
    case vmIntrinsics::_longBitsToDouble:
<span class="line-added">+   case vmIntrinsics::_ceil:</span>
<span class="line-added">+   case vmIntrinsics::_floor:</span>
<span class="line-added">+   case vmIntrinsics::_rint:</span>
    case vmIntrinsics::_dabs:
<span class="line-added">+   case vmIntrinsics::_fabs:</span>
<span class="line-added">+   case vmIntrinsics::_iabs:</span>
<span class="line-added">+   case vmIntrinsics::_labs:</span>
    case vmIntrinsics::_dsqrt:
    case vmIntrinsics::_dsin:
    case vmIntrinsics::_dcos:
    case vmIntrinsics::_dtan:
    case vmIntrinsics::_dlog:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 724,10 ***</span>
<span class="line-new-header">--- 724,14 ---</span>
      break;
    case vmIntrinsics::_cipherBlockChaining_encryptAESCrypt:
    case vmIntrinsics::_cipherBlockChaining_decryptAESCrypt:
      if (!UseAESIntrinsics) return true;
      break;
<span class="line-added">+   case vmIntrinsics::_electronicCodeBook_encryptAESCrypt:</span>
<span class="line-added">+   case vmIntrinsics::_electronicCodeBook_decryptAESCrypt:</span>
<span class="line-added">+     if (!UseAESIntrinsics) return true;</span>
<span class="line-added">+     break;</span>
    case vmIntrinsics::_counterMode_AESCrypt:
      if (!UseAESCTRIntrinsics) return true;
      break;
    case vmIntrinsics::_sha_implCompress:
      if (!UseSHA1Intrinsics) return true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 766,13 ***</span>
      if (!InlineNIOCheckIndex) return true;
      break;
  #endif // COMPILER1
  #ifdef COMPILER2
    case vmIntrinsics::_clone:
<span class="line-removed">- #if INCLUDE_ZGC</span>
<span class="line-removed">-     if (UseZGC) return true;</span>
<span class="line-removed">- #endif</span>
    case vmIntrinsics::_copyOf:
    case vmIntrinsics::_copyOfRange:
      // These intrinsics use both the objectcopy and the arraycopy
      // intrinsic mechanism.
      if (!InlineObjectCopy || !InlineArrayCopy) return true;
<span class="line-new-header">--- 770,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 820,10 ***</span>
<span class="line-new-header">--- 821,13 ---</span>
      if (!UseMontgomeryMultiplyIntrinsic) return true;
      break;
    case vmIntrinsics::_montgomerySquare:
      if (!UseMontgomerySquareIntrinsic) return true;
      break;
<span class="line-added">+   case vmIntrinsics::_bigIntegerRightShiftWorker:</span>
<span class="line-added">+   case vmIntrinsics::_bigIntegerLeftShiftWorker:</span>
<span class="line-added">+     break;</span>
    case vmIntrinsics::_addExactI:
    case vmIntrinsics::_addExactL:
    case vmIntrinsics::_decrementExactI:
    case vmIntrinsics::_decrementExactL:
    case vmIntrinsics::_incrementExactI:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 949,11 ***</span>
    case F_SN: fname = &quot;native static &quot;; break;
    case F_S:  fname = &quot;static &quot;;        break;
    case F_RNY:fname = &quot;native synchronized &quot;; break;
    default:   break;
    }
<span class="line-modified">!   const char* kptr = strrchr(kname, &#39;/&#39;);</span>
    if (kptr != NULL)  kname = kptr + 1;
    int len = jio_snprintf(buf, buflen, &quot;%s: %s%s.%s%s&quot;,
                           str, fname, kname, mname, sname);
    if (len &lt; buflen)
      str = buf;
<span class="line-new-header">--- 953,11 ---</span>
    case F_SN: fname = &quot;native static &quot;; break;
    case F_S:  fname = &quot;static &quot;;        break;
    case F_RNY:fname = &quot;native synchronized &quot;; break;
    default:   break;
    }
<span class="line-modified">!   const char* kptr = strrchr(kname, JVM_SIGNATURE_SLASH);</span>
    if (kptr != NULL)  kname = kptr + 1;
    int len = jio_snprintf(buf, buflen, &quot;%s: %s%s.%s%s&quot;,
                           str, fname, kname, mname, sname);
    if (len &lt; buflen)
      str = buf;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1052,22 ***</span>
      }
    }
  
    const char* declared_name = name_at(declared_id);
    const char* actual_name   = name_at(actual_id);
<span class="line-removed">-   methodHandle mh = m;</span>
    m = NULL;
    ttyLocker ttyl;
    if (xtty != NULL) {
      xtty-&gt;begin_elem(&quot;intrinsic_misdeclared actual=&#39;%s&#39; declared=&#39;%s&#39;&quot;,
                       actual_name, declared_name);
<span class="line-modified">!     xtty-&gt;method(mh);</span>
      xtty-&gt;end_elem(&quot;%s&quot;, &quot;&quot;);
    }
    if (PrintMiscellaneous &amp;&amp; (WizardMode || Verbose)) {
      tty-&gt;print_cr(&quot;*** misidentified method; %s(%d) should be %s(%d):&quot;,
                    declared_name, declared_id, actual_name, actual_id);
<span class="line-modified">!     mh()-&gt;print_short_name(tty);</span>
      tty-&gt;cr();
    }
  }
  #endif //PRODUCT
<span class="line-new-header">--- 1056,21 ---</span>
      }
    }
  
    const char* declared_name = name_at(declared_id);
    const char* actual_name   = name_at(actual_id);
    m = NULL;
    ttyLocker ttyl;
    if (xtty != NULL) {
      xtty-&gt;begin_elem(&quot;intrinsic_misdeclared actual=&#39;%s&#39; declared=&#39;%s&#39;&quot;,
                       actual_name, declared_name);
<span class="line-modified">!     xtty-&gt;method(m);</span>
      xtty-&gt;end_elem(&quot;%s&quot;, &quot;&quot;);
    }
    if (PrintMiscellaneous &amp;&amp; (WizardMode || Verbose)) {
      tty-&gt;print_cr(&quot;*** misidentified method; %s(%d) should be %s(%d):&quot;,
                    declared_name, declared_id, actual_name, actual_id);
<span class="line-modified">!     m-&gt;print_short_name(tty);</span>
      tty-&gt;cr();
    }
  }
  #endif //PRODUCT
</pre>
<center><a href="verifier.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmSymbols.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>