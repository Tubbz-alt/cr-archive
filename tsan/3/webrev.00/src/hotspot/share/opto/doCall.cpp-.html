<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/doCall.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallSite.hpp&quot;
  27 #include &quot;ci/ciMethodHandle.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileBroker.hpp&quot;
  30 #include &quot;compiler/compileLog.hpp&quot;
  31 #include &quot;interpreter/linkResolver.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/callGenerator.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/cfgnode.hpp&quot;
  36 #include &quot;opto/mulnode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;opto/subnode.hpp&quot;
  41 #include &quot;prims/nativeLookup.hpp&quot;
  42 #include &quot;runtime/sharedRuntime.hpp&quot;
  43 
  44 void trace_type_profile(Compile* C, ciMethod *method, int depth, int bci, ciMethod *prof_method, ciKlass *prof_klass, int site_count, int receiver_count) {
  45   if (TraceTypeProfile || C-&gt;print_inlining()) {
  46     outputStream* out = tty;
  47     if (!C-&gt;print_inlining()) {
  48       if (!PrintOpto &amp;&amp; !PrintCompilation) {
  49         method-&gt;print_short_name();
  50         tty-&gt;cr();
  51       }
  52       CompileTask::print_inlining_tty(prof_method, depth, bci);
  53     } else {
  54       out = C-&gt;print_inlining_stream();
  55     }
  56     CompileTask::print_inline_indent(depth, out);
  57     out-&gt;print(&quot; \\-&gt; TypeProfile (%d/%d counts) = &quot;, receiver_count, site_count);
  58     stringStream ss;
  59     prof_klass-&gt;name()-&gt;print_symbol_on(&amp;ss);
  60     out-&gt;print(&quot;%s&quot;, ss.as_string());
  61     out-&gt;cr();
  62   }
  63 }
  64 
  65 CallGenerator* Compile::call_generator(ciMethod* callee, int vtable_index, bool call_does_dispatch,
  66                                        JVMState* jvms, bool allow_inline,
  67                                        float prof_factor, ciKlass* speculative_receiver_type,
  68                                        bool allow_intrinsics, bool delayed_forbidden) {
  69   ciMethod*       caller   = jvms-&gt;method();
  70   int             bci      = jvms-&gt;bci();
  71   Bytecodes::Code bytecode = caller-&gt;java_code_at_bci(bci);
  72   guarantee(callee != NULL, &quot;failed method resolution&quot;);
  73 
  74   // Dtrace currently doesn&#39;t work unless all calls are vanilla
  75   if (env()-&gt;dtrace_method_probes()) {
  76     allow_inline = false;
  77   }
  78 
  79   // Note: When we get profiling during stage-1 compiles, we want to pull
  80   // from more specific profile data which pertains to this inlining.
  81   // Right now, ignore the information in jvms-&gt;caller(), and do method[bci].
  82   ciCallProfile profile = caller-&gt;call_profile_at_bci(bci);
  83 
  84   // See how many times this site has been invoked.
  85   int site_count = profile.count();
  86   int receiver_count = -1;
  87   if (call_does_dispatch &amp;&amp; UseTypeProfile &amp;&amp; profile.has_receiver(0)) {
  88     // Receivers in the profile structure are ordered by call counts
  89     // so that the most called (major) receiver is profile.receiver(0).
  90     receiver_count = profile.receiver_count(0);
  91   }
  92 
  93   CompileLog* log = this-&gt;log();
  94   if (log != NULL) {
  95     int rid = (receiver_count &gt;= 0)? log-&gt;identify(profile.receiver(0)): -1;
  96     int r2id = (rid != -1 &amp;&amp; profile.has_receiver(1))? log-&gt;identify(profile.receiver(1)):-1;
  97     log-&gt;begin_elem(&quot;call method=&#39;%d&#39; count=&#39;%d&#39; prof_factor=&#39;%f&#39;&quot;,
  98                     log-&gt;identify(callee), site_count, prof_factor);
  99     if (call_does_dispatch)  log-&gt;print(&quot; virtual=&#39;1&#39;&quot;);
 100     if (allow_inline)     log-&gt;print(&quot; inline=&#39;1&#39;&quot;);
 101     if (receiver_count &gt;= 0) {
 102       log-&gt;print(&quot; receiver=&#39;%d&#39; receiver_count=&#39;%d&#39;&quot;, rid, receiver_count);
 103       if (profile.has_receiver(1)) {
 104         log-&gt;print(&quot; receiver2=&#39;%d&#39; receiver2_count=&#39;%d&#39;&quot;, r2id, profile.receiver_count(1));
 105       }
 106     }
 107     if (callee-&gt;is_method_handle_intrinsic()) {
 108       log-&gt;print(&quot; method_handle_intrinsic=&#39;1&#39;&quot;);
 109     }
 110     log-&gt;end_elem();
 111   }
 112 
 113   // Special case the handling of certain common, profitable library
 114   // methods.  If these methods are replaced with specialized code,
 115   // then we return it as the inlined version of the call.
 116   // We do this before the strict f.p. check below because the
 117   // intrinsics handle strict f.p. correctly.
 118   CallGenerator* cg_intrinsic = NULL;
 119   if (allow_inline &amp;&amp; allow_intrinsics) {
 120     CallGenerator* cg = find_intrinsic(callee, call_does_dispatch);
 121     if (cg != NULL) {
 122       if (cg-&gt;is_predicated()) {
 123         // Code without intrinsic but, hopefully, inlined.
 124         CallGenerator* inline_cg = this-&gt;call_generator(callee,
 125               vtable_index, call_does_dispatch, jvms, allow_inline, prof_factor, speculative_receiver_type, false);
 126         if (inline_cg != NULL) {
 127           cg = CallGenerator::for_predicated_intrinsic(cg, inline_cg);
 128         }
 129       }
 130 
 131       // If intrinsic does the virtual dispatch, we try to use the type profile
 132       // first, and hopefully inline it as the regular virtual call below.
 133       // We will retry the intrinsic if nothing had claimed it afterwards.
 134       if (cg-&gt;does_virtual_dispatch()) {
 135         cg_intrinsic = cg;
 136         cg = NULL;
 137       } else {
 138         return cg;
 139       }
 140     }
 141   }
 142 
 143   // Do method handle calls.
 144   // NOTE: This must happen before normal inlining logic below since
 145   // MethodHandle.invoke* are native methods which obviously don&#39;t
 146   // have bytecodes and so normal inlining fails.
 147   if (callee-&gt;is_method_handle_intrinsic()) {
 148     CallGenerator* cg = CallGenerator::for_method_handle_call(jvms, caller, callee, delayed_forbidden);
 149     assert(cg == NULL || !delayed_forbidden || !cg-&gt;is_late_inline() || cg-&gt;is_mh_late_inline(), &quot;unexpected CallGenerator&quot;);
 150     return cg;
 151   }
 152 
 153   // Do not inline strict fp into non-strict code, or the reverse
 154   if (caller-&gt;is_strict() ^ callee-&gt;is_strict()) {
 155     allow_inline = false;
 156   }
 157 
 158   // Attempt to inline...
 159   if (allow_inline) {
 160     // The profile data is only partly attributable to this caller,
 161     // scale back the call site information.
 162     float past_uses = jvms-&gt;method()-&gt;scale_count(site_count, prof_factor);
 163     // This is the number of times we expect the call code to be used.
 164     float expected_uses = past_uses;
 165 
 166     // Try inlining a bytecoded method:
 167     if (!call_does_dispatch) {
 168       InlineTree* ilt = InlineTree::find_subtree_from_root(this-&gt;ilt(), jvms-&gt;caller(), jvms-&gt;method());
 169       WarmCallInfo scratch_ci;
 170       bool should_delay = false;
 171       WarmCallInfo* ci = ilt-&gt;ok_to_inline(callee, jvms, profile, &amp;scratch_ci, should_delay);
 172       assert(ci != &amp;scratch_ci, &quot;do not let this pointer escape&quot;);
 173       bool allow_inline   = (ci != NULL &amp;&amp; !ci-&gt;is_cold());
 174       bool require_inline = (allow_inline &amp;&amp; ci-&gt;is_hot());
 175 
 176       if (allow_inline) {
 177         CallGenerator* cg = CallGenerator::for_inline(callee, expected_uses);
 178 
 179         if (require_inline &amp;&amp; cg != NULL) {
 180           // Delay the inlining of this method to give us the
 181           // opportunity to perform some high level optimizations
 182           // first.
 183           if (should_delay_string_inlining(callee, jvms)) {
 184             assert(!delayed_forbidden, &quot;strange&quot;);
 185             return CallGenerator::for_string_late_inline(callee, cg);
 186           } else if (should_delay_boxing_inlining(callee, jvms)) {
 187             assert(!delayed_forbidden, &quot;strange&quot;);
 188             return CallGenerator::for_boxing_late_inline(callee, cg);
 189           } else if ((should_delay || AlwaysIncrementalInline) &amp;&amp; !delayed_forbidden) {
 190             return CallGenerator::for_late_inline(callee, cg);
 191           }
 192         }
 193         if (cg == NULL || should_delay) {
 194           // Fall through.
 195         } else if (require_inline || !InlineWarmCalls) {
 196           return cg;
 197         } else {
 198           CallGenerator* cold_cg = call_generator(callee, vtable_index, call_does_dispatch, jvms, false, prof_factor);
 199           return CallGenerator::for_warm_call(ci, cold_cg, cg);
 200         }
 201       }
 202     }
 203 
 204     // Try using the type profile.
 205     if (call_does_dispatch &amp;&amp; site_count &gt; 0 &amp;&amp; UseTypeProfile) {
 206       // The major receiver&#39;s count &gt;= TypeProfileMajorReceiverPercent of site_count.
 207       bool have_major_receiver = profile.has_receiver(0) &amp;&amp; (100.*profile.receiver_prob(0) &gt;= (float)TypeProfileMajorReceiverPercent);
 208       ciMethod* receiver_method = NULL;
 209 
 210       int morphism = profile.morphism();
 211       if (speculative_receiver_type != NULL) {
 212         if (!too_many_traps_or_recompiles(caller, bci, Deoptimization::Reason_speculate_class_check)) {
 213           // We have a speculative type, we should be able to resolve
 214           // the call. We do that before looking at the profiling at
 215           // this invoke because it may lead to bimorphic inlining which
 216           // a speculative type should help us avoid.
 217           receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 218                                                    speculative_receiver_type);
 219           if (receiver_method == NULL) {
 220             speculative_receiver_type = NULL;
 221           } else {
 222             morphism = 1;
 223           }
 224         } else {
 225           // speculation failed before. Use profiling at the call
 226           // (could allow bimorphic inlining for instance).
 227           speculative_receiver_type = NULL;
 228         }
 229       }
 230       if (receiver_method == NULL &amp;&amp;
 231           (have_major_receiver || morphism == 1 ||
 232            (morphism == 2 &amp;&amp; UseBimorphicInlining))) {
 233         // receiver_method = profile.method();
 234         // Profiles do not suggest methods now.  Look it up in the major receiver.
 235         receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 236                                                       profile.receiver(0));
 237       }
 238       if (receiver_method != NULL) {
 239         // The single majority receiver sufficiently outweighs the minority.
 240         CallGenerator* hit_cg = this-&gt;call_generator(receiver_method,
 241               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 242         if (hit_cg != NULL) {
 243           // Look up second receiver.
 244           CallGenerator* next_hit_cg = NULL;
 245           ciMethod* next_receiver_method = NULL;
 246           if (morphism == 2 &amp;&amp; UseBimorphicInlining) {
 247             next_receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 248                                                                profile.receiver(1));
 249             if (next_receiver_method != NULL) {
 250               next_hit_cg = this-&gt;call_generator(next_receiver_method,
 251                                   vtable_index, !call_does_dispatch, jvms,
 252                                   allow_inline, prof_factor);
 253               if (next_hit_cg != NULL &amp;&amp; !next_hit_cg-&gt;is_inline() &amp;&amp;
 254                   have_major_receiver &amp;&amp; UseOnlyInlinedBimorphic) {
 255                   // Skip if we can&#39;t inline second receiver&#39;s method
 256                   next_hit_cg = NULL;
 257               }
 258             }
 259           }
 260           CallGenerator* miss_cg;
 261           Deoptimization::DeoptReason reason = (morphism == 2
 262                                                ? Deoptimization::Reason_bimorphic
 263                                                : Deoptimization::reason_class_check(speculative_receiver_type != NULL));
 264           if ((morphism == 1 || (morphism == 2 &amp;&amp; next_hit_cg != NULL)) &amp;&amp;
 265               !too_many_traps_or_recompiles(caller, bci, reason)
 266              ) {
 267             // Generate uncommon trap for class check failure path
 268             // in case of monomorphic or bimorphic virtual call site.
 269             miss_cg = CallGenerator::for_uncommon_trap(callee, reason,
 270                         Deoptimization::Action_maybe_recompile);
 271           } else {
 272             // Generate virtual call for class check failure path
 273             // in case of polymorphic virtual call site.
 274             miss_cg = CallGenerator::for_virtual_call(callee, vtable_index);
 275           }
 276           if (miss_cg != NULL) {
 277             if (next_hit_cg != NULL) {
 278               assert(speculative_receiver_type == NULL, &quot;shouldn&#39;t end up here if we used speculation&quot;);
 279               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), next_receiver_method, profile.receiver(1), site_count, profile.receiver_count(1));
 280               // We don&#39;t need to record dependency on a receiver here and below.
 281               // Whenever we inline, the dependency is added by Parse::Parse().
 282               miss_cg = CallGenerator::for_predicted_call(profile.receiver(1), miss_cg, next_hit_cg, PROB_MAX);
 283             }
 284             if (miss_cg != NULL) {
 285               ciKlass* k = speculative_receiver_type != NULL ? speculative_receiver_type : profile.receiver(0);
 286               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), receiver_method, k, site_count, receiver_count);
 287               float hit_prob = speculative_receiver_type != NULL ? 1.0 : profile.receiver_prob(0);
 288               CallGenerator* cg = CallGenerator::for_predicted_call(k, miss_cg, hit_cg, hit_prob);
 289               if (cg != NULL)  return cg;
 290             }
 291           }
 292         }
 293       }
 294     }
 295 
 296     // If there is only one implementor of this interface then we
 297     // may be able to bind this invoke directly to the implementing
 298     // klass but we need both a dependence on the single interface
 299     // and on the method we bind to. Additionally since all we know
 300     // about the receiver type is that it&#39;s supposed to implement the
 301     // interface we have to insert a check that it&#39;s the class we
 302     // expect.  Interface types are not checked by the verifier so
 303     // they are roughly equivalent to Object.
 304     // The number of implementors for declared_interface is less or
 305     // equal to the number of implementors for target-&gt;holder() so
 306     // if number of implementors of target-&gt;holder() == 1 then
 307     // number of implementors for decl_interface is 0 or 1. If
 308     // it&#39;s 0 then no class implements decl_interface and there&#39;s
 309     // no point in inlining.
 310     if (call_does_dispatch &amp;&amp; bytecode == Bytecodes::_invokeinterface) {
 311       ciInstanceKlass* declared_interface =
 312           caller-&gt;get_declared_method_holder_at_bci(bci)-&gt;as_instance_klass();
 313 
 314       if (declared_interface-&gt;nof_implementors() == 1 &amp;&amp;
 315           (!callee-&gt;is_default_method() || callee-&gt;is_overpass()) /* CHA doesn&#39;t support default methods yet */) {
 316         ciInstanceKlass* singleton = declared_interface-&gt;implementor();
 317         ciMethod* cha_monomorphic_target =
 318             callee-&gt;find_monomorphic_target(caller-&gt;holder(), declared_interface, singleton);
 319 
 320         if (cha_monomorphic_target != NULL &amp;&amp;
 321             cha_monomorphic_target-&gt;holder() != env()-&gt;Object_klass()) { // subtype check against Object is useless
 322           ciKlass* holder = cha_monomorphic_target-&gt;holder();
 323 
 324           // Try to inline the method found by CHA. Inlined method is guarded by the type check.
 325           CallGenerator* hit_cg = call_generator(cha_monomorphic_target,
 326               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 327 
 328           // Deoptimize on type check fail. The interpreter will throw ICCE for us.
 329           CallGenerator* miss_cg = CallGenerator::for_uncommon_trap(callee,
 330               Deoptimization::Reason_class_check, Deoptimization::Action_none);
 331 
 332           CallGenerator* cg = CallGenerator::for_guarded_call(holder, miss_cg, hit_cg);
 333           if (hit_cg != NULL &amp;&amp; cg != NULL) {
 334             dependencies()-&gt;assert_unique_concrete_method(declared_interface, cha_monomorphic_target);
 335             return cg;
 336           }
 337         }
 338       }
 339     }
 340   }
 341 
 342   // Nothing claimed the intrinsic, we go with straight-forward inlining
 343   // for already discovered intrinsic.
 344   if (allow_inline &amp;&amp; allow_intrinsics &amp;&amp; cg_intrinsic != NULL) {
 345     assert(cg_intrinsic-&gt;does_virtual_dispatch(), &quot;sanity&quot;);
 346     return cg_intrinsic;
 347   }
 348 
 349   // There was no special inlining tactic, or it bailed out.
 350   // Use a more generic tactic, like a simple call.
 351   if (call_does_dispatch) {
 352     const char* msg = &quot;virtual call&quot;;
 353     if (PrintInlining) print_inlining(callee, jvms-&gt;depth() - 1, jvms-&gt;bci(), msg);
 354     C-&gt;log_inline_failure(msg);
 355     return CallGenerator::for_virtual_call(callee, vtable_index);
 356   } else {
 357     // Class Hierarchy Analysis or Type Profile reveals a unique target,
 358     // or it is a static or special call.
 359     return CallGenerator::for_direct_call(callee, should_delay_inlining(callee, jvms));
 360   }
 361 }
 362 
 363 // Return true for methods that shouldn&#39;t be inlined early so that
 364 // they are easier to analyze and optimize as intrinsics.
 365 bool Compile::should_delay_string_inlining(ciMethod* call_method, JVMState* jvms) {
 366   if (has_stringbuilder()) {
 367 
 368     if ((call_method-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 369          call_method-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass()) &amp;&amp;
 370         (jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 371          jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass())) {
 372       // Delay SB calls only when called from non-SB code
 373       return false;
 374     }
 375 
 376     switch (call_method-&gt;intrinsic_id()) {
 377       case vmIntrinsics::_StringBuilder_void:
 378       case vmIntrinsics::_StringBuilder_int:
 379       case vmIntrinsics::_StringBuilder_String:
 380       case vmIntrinsics::_StringBuilder_append_char:
 381       case vmIntrinsics::_StringBuilder_append_int:
 382       case vmIntrinsics::_StringBuilder_append_String:
 383       case vmIntrinsics::_StringBuilder_toString:
 384       case vmIntrinsics::_StringBuffer_void:
 385       case vmIntrinsics::_StringBuffer_int:
 386       case vmIntrinsics::_StringBuffer_String:
 387       case vmIntrinsics::_StringBuffer_append_char:
 388       case vmIntrinsics::_StringBuffer_append_int:
 389       case vmIntrinsics::_StringBuffer_append_String:
 390       case vmIntrinsics::_StringBuffer_toString:
 391       case vmIntrinsics::_Integer_toString:
 392         return true;
 393 
 394       case vmIntrinsics::_String_String:
 395         {
 396           Node* receiver = jvms-&gt;map()-&gt;in(jvms-&gt;argoff() + 1);
 397           if (receiver-&gt;is_Proj() &amp;&amp; receiver-&gt;in(0)-&gt;is_CallStaticJava()) {
 398             CallStaticJavaNode* csj = receiver-&gt;in(0)-&gt;as_CallStaticJava();
 399             ciMethod* m = csj-&gt;method();
 400             if (m != NULL &amp;&amp;
 401                 (m-&gt;intrinsic_id() == vmIntrinsics::_StringBuffer_toString ||
 402                  m-&gt;intrinsic_id() == vmIntrinsics::_StringBuilder_toString))
 403               // Delay String.&lt;init&gt;(new SB())
 404               return true;
 405           }
 406           return false;
 407         }
 408 
 409       default:
 410         return false;
 411     }
 412   }
 413   return false;
 414 }
 415 
 416 bool Compile::should_delay_boxing_inlining(ciMethod* call_method, JVMState* jvms) {
 417   if (eliminate_boxing() &amp;&amp; call_method-&gt;is_boxing_method()) {
 418     set_has_boxed_value(true);
 419     return aggressive_unboxing();
 420   }
 421   return false;
 422 }
 423 
 424 // uncommon-trap call-sites where callee is unloaded, uninitialized or will not link
 425 bool Parse::can_not_compile_call_site(ciMethod *dest_method, ciInstanceKlass* klass) {
 426   // Additional inputs to consider...
 427   // bc      = bc()
 428   // caller  = method()
 429   // iter().get_method_holder_index()
 430   assert( dest_method-&gt;is_loaded(), &quot;ciTypeFlow should not let us get here&quot; );
 431   // Interface classes can be loaded &amp; linked and never get around to
 432   // being initialized.  Uncommon-trap for not-initialized static or
 433   // v-calls.  Let interface calls happen.
 434   ciInstanceKlass* holder_klass = dest_method-&gt;holder();
 435   if (!holder_klass-&gt;is_being_initialized() &amp;&amp;
 436       !holder_klass-&gt;is_initialized() &amp;&amp;
 437       !holder_klass-&gt;is_interface()) {
 438     uncommon_trap(Deoptimization::Reason_uninitialized,
 439                   Deoptimization::Action_reinterpret,
 440                   holder_klass);
 441     return true;
 442   }
 443 
 444   assert(dest_method-&gt;is_loaded(), &quot;dest_method: typeflow responsibility&quot;);
 445   return false;
 446 }
 447 
 448 #ifdef ASSERT
 449 static bool check_call_consistency(JVMState* jvms, CallGenerator* cg) {
 450   ciMethod* symbolic_info = jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci());
 451   ciMethod* resolved_method = cg-&gt;method();
 452   if (!ciMethod::is_consistent_info(symbolic_info, resolved_method)) {
 453     tty-&gt;print_cr(&quot;JVMS:&quot;);
 454     jvms-&gt;dump();
 455     tty-&gt;print_cr(&quot;Bytecode info:&quot;);
 456     jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci())-&gt;print(); tty-&gt;cr();
 457     tty-&gt;print_cr(&quot;Resolved method:&quot;);
 458     cg-&gt;method()-&gt;print(); tty-&gt;cr();
 459     return false;
 460   }
 461   return true;
 462 }
 463 #endif // ASSERT
 464 
 465 //------------------------------do_call----------------------------------------
 466 // Handle your basic call.  Inline if we can &amp; want to, else just setup call.
 467 void Parse::do_call() {
 468   // It&#39;s likely we are going to add debug info soon.
 469   // Also, if we inline a guy who eventually needs debug info for this JVMS,
 470   // our contribution to it is cleaned up right here.
 471   kill_dead_locals();
 472 
 473   C-&gt;print_inlining_assert_ready();
 474 
 475   // Set frequently used booleans
 476   const bool is_virtual = bc() == Bytecodes::_invokevirtual;
 477   const bool is_virtual_or_interface = is_virtual || bc() == Bytecodes::_invokeinterface;
 478   const bool has_receiver = Bytecodes::has_receiver(bc());
 479 
 480   // Find target being called
 481   bool             will_link;
 482   ciSignature*     declared_signature = NULL;
 483   ciMethod*        orig_callee  = iter().get_method(will_link, &amp;declared_signature);  // callee in the bytecode
 484   ciInstanceKlass* holder_klass = orig_callee-&gt;holder();
 485   ciKlass*         holder       = iter().get_declared_method_holder();
 486   ciInstanceKlass* klass = ciEnv::get_instance_klass_for_declared_method_holder(holder);
 487   assert(declared_signature != NULL, &quot;cannot be null&quot;);
 488 
 489   // Bump max node limit for JSR292 users
 490   if (bc() == Bytecodes::_invokedynamic || orig_callee-&gt;is_method_handle_intrinsic()) {
 491     C-&gt;set_max_node_limit(3*MaxNodeLimit);
 492   }
 493 
 494   // uncommon-trap when callee is unloaded, uninitialized or will not link
 495   // bailout when too many arguments for register representation
 496   if (!will_link || can_not_compile_call_site(orig_callee, klass)) {
 497     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 498       method()-&gt;print_name(); tty-&gt;print_cr(&quot; can not compile call at bci %d to:&quot;, bci());
 499       orig_callee-&gt;print_name(); tty-&gt;cr();
 500     }
 501     return;
 502   }
 503   assert(holder_klass-&gt;is_loaded(), &quot;&quot;);
 504   //assert((bc_callee-&gt;is_static() || is_invokedynamic) == !has_receiver , &quot;must match bc&quot;);  // XXX invokehandle (cur_bc_raw)
 505   // Note: this takes into account invokeinterface of methods declared in java/lang/Object,
 506   // which should be invokevirtuals but according to the VM spec may be invokeinterfaces
 507   assert(holder_klass-&gt;is_interface() || holder_klass-&gt;super() == NULL || (bc() != Bytecodes::_invokeinterface), &quot;must match bc&quot;);
 508   // Note:  In the absence of miranda methods, an abstract class K can perform
 509   // an invokevirtual directly on an interface method I.m if K implements I.
 510 
 511   // orig_callee is the resolved callee which&#39;s signature includes the
 512   // appendix argument.
 513   const int nargs = orig_callee-&gt;arg_size();
 514   const bool is_signature_polymorphic = MethodHandles::is_signature_polymorphic(orig_callee-&gt;intrinsic_id());
 515 
 516   // Push appendix argument (MethodType, CallSite, etc.), if one.
 517   if (iter().has_appendix()) {
 518     ciObject* appendix_arg = iter().get_appendix();
 519     const TypeOopPtr* appendix_arg_type = TypeOopPtr::make_from_constant(appendix_arg, /* require_const= */ true);
 520     Node* appendix_arg_node = _gvn.makecon(appendix_arg_type);
 521     push(appendix_arg_node);
 522   }
 523 
 524   // ---------------------
 525   // Does Class Hierarchy Analysis reveal only a single target of a v-call?
 526   // Then we may inline or make a static call, but become dependent on there being only 1 target.
 527   // Does the call-site type profile reveal only one receiver?
 528   // Then we may introduce a run-time check and inline on the path where it succeeds.
 529   // The other path may uncommon_trap, check for another receiver, or do a v-call.
 530 
 531   // Try to get the most accurate receiver type
 532   ciMethod* callee             = orig_callee;
 533   int       vtable_index       = Method::invalid_vtable_index;
 534   bool      call_does_dispatch = false;
 535 
 536   // Speculative type of the receiver if any
 537   ciKlass* speculative_receiver_type = NULL;
 538   if (is_virtual_or_interface) {
 539     Node* receiver_node             = stack(sp() - nargs);
 540     const TypeOopPtr* receiver_type = _gvn.type(receiver_node)-&gt;isa_oopptr();
 541     // call_does_dispatch and vtable_index are out-parameters.  They might be changed.
 542     // For arrays, klass below is Object. When vtable calls are used,
 543     // resolving the call with Object would allow an illegal call to
 544     // finalize() on an array. We use holder instead: illegal calls to
 545     // finalize() won&#39;t be compiled as vtable calls (IC call
 546     // resolution will catch the illegal call) and the few legal calls
 547     // on array types won&#39;t be either.
 548     callee = C-&gt;optimize_virtual_call(method(), bci(), klass, holder, orig_callee,
 549                                       receiver_type, is_virtual,
 550                                       call_does_dispatch, vtable_index);  // out-parameters
 551     speculative_receiver_type = receiver_type != NULL ? receiver_type-&gt;speculative_type() : NULL;
 552   }
 553 
 554   // Additional receiver subtype checks for interface calls via invokespecial or invokeinterface.
 555   ciKlass* receiver_constraint = NULL;
 556   if (iter().cur_bc_raw() == Bytecodes::_invokespecial &amp;&amp; !orig_callee-&gt;is_object_initializer()) {
 557     ciInstanceKlass* calling_klass = method()-&gt;holder();
 558     ciInstanceKlass* sender_klass =
 559         calling_klass-&gt;is_unsafe_anonymous() ? calling_klass-&gt;unsafe_anonymous_host() :
 560                                                calling_klass;
 561     if (sender_klass-&gt;is_interface()) {
 562       receiver_constraint = sender_klass;
 563     }
 564   } else if (iter().cur_bc_raw() == Bytecodes::_invokeinterface &amp;&amp; orig_callee-&gt;is_private()) {
 565     assert(holder-&gt;is_interface(), &quot;How did we get a non-interface method here!&quot;);
 566     receiver_constraint = holder;
 567   }
 568 
 569   if (receiver_constraint != NULL) {
 570     Node* receiver_node = stack(sp() - nargs);
 571     Node* cls_node = makecon(TypeKlassPtr::make(receiver_constraint));
 572     Node* bad_type_ctrl = NULL;
 573     Node* casted_receiver = gen_checkcast(receiver_node, cls_node, &amp;bad_type_ctrl);
 574     if (bad_type_ctrl != NULL) {
 575       PreserveJVMState pjvms(this);
 576       set_control(bad_type_ctrl);
 577       uncommon_trap(Deoptimization::Reason_class_check,
 578                     Deoptimization::Action_none);
 579     }
 580     if (stopped()) {
 581       return; // MUST uncommon-trap?
 582     }
 583     set_stack(sp() - nargs, casted_receiver);
 584   }
 585 
 586   // Note:  It&#39;s OK to try to inline a virtual call.
 587   // The call generator will not attempt to inline a polymorphic call
 588   // unless it knows how to optimize the receiver dispatch.
 589   bool try_inline = (C-&gt;do_inlining() || InlineAccessors);
 590 
 591   // ---------------------
 592   dec_sp(nargs);              // Temporarily pop args for JVM state of call
 593   JVMState* jvms = sync_jvms();
 594 
 595   // ---------------------
 596   // Decide call tactic.
 597   // This call checks with CHA, the interpreter profile, intrinsics table, etc.
 598   // It decides whether inlining is desirable or not.
 599   CallGenerator* cg = C-&gt;call_generator(callee, vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type);
 600 
 601   // NOTE:  Don&#39;t use orig_callee and callee after this point!  Use cg-&gt;method() instead.
 602   orig_callee = callee = NULL;
 603 
 604   // ---------------------
 605   // Round double arguments before call
 606   round_double_arguments(cg-&gt;method());
 607 
 608   // Feed profiling data for arguments to the type system so it can
 609   // propagate it as speculative types
 610   record_profiled_arguments_for_speculation(cg-&gt;method(), bc());
 611 
 612 #ifndef PRODUCT
 613   // bump global counters for calls
 614   count_compiled_calls(/*at_method_entry*/ false, cg-&gt;is_inline());
 615 
 616   // Record first part of parsing work for this call
 617   parse_histogram()-&gt;record_change();
 618 #endif // not PRODUCT
 619 
 620   assert(jvms == this-&gt;jvms(), &quot;still operating on the right JVMS&quot;);
 621   assert(jvms_in_sync(),       &quot;jvms must carry full info into CG&quot;);
 622 
 623   // save across call, for a subsequent cast_not_null.
 624   Node* receiver = has_receiver ? argument(0) : NULL;
 625 
 626   // The extra CheckCastPPs for speculative types mess with PhaseStringOpts
 627   if (receiver != NULL &amp;&amp; !call_does_dispatch &amp;&amp; !cg-&gt;is_string_late_inline()) {
 628     // Feed profiling data for a single receiver to the type system so
 629     // it can propagate it as a speculative type
 630     receiver = record_profiled_receiver_for_speculation(receiver);
 631   }
 632 
 633   // Bump method data counters (We profile *before* the call is made
 634   // because exceptions don&#39;t return to the call site.)
 635   profile_call(receiver);
 636 
 637   JVMState* new_jvms = cg-&gt;generate(jvms);
 638   if (new_jvms == NULL) {
 639     // When inlining attempt fails (e.g., too many arguments),
 640     // it may contaminate the current compile state, making it
 641     // impossible to pull back and try again.  Once we call
 642     // cg-&gt;generate(), we are committed.  If it fails, the whole
 643     // compilation task is compromised.
 644     if (failing())  return;
 645 
 646     // This can happen if a library intrinsic is available, but refuses
 647     // the call site, perhaps because it did not match a pattern the
 648     // intrinsic was expecting to optimize. Should always be possible to
 649     // get a normal java call that may inline in that case
 650     cg = C-&gt;call_generator(cg-&gt;method(), vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type, /* allow_intrinsics= */ false);
 651     new_jvms = cg-&gt;generate(jvms);
 652     if (new_jvms == NULL) {
 653       guarantee(failing(), &quot;call failed to generate:  calls should work&quot;);
 654       return;
 655     }
 656   }
 657 
 658   if (cg-&gt;is_inline()) {
 659     // Accumulate has_loops estimate
 660     C-&gt;set_has_loops(C-&gt;has_loops() || cg-&gt;method()-&gt;has_loops());
 661     C-&gt;env()-&gt;notice_inlined_method(cg-&gt;method());
 662   }
 663 
 664   // Reset parser state from [new_]jvms, which now carries results of the call.
 665   // Return value (if any) is already pushed on the stack by the cg.
 666   add_exception_states_from(new_jvms);
 667   if (new_jvms-&gt;map()-&gt;control() == top()) {
 668     stop_and_kill_map();
 669   } else {
 670     assert(new_jvms-&gt;same_calls_as(jvms), &quot;method/bci left unchanged&quot;);
 671     set_jvms(new_jvms);
 672   }
 673 
 674   assert(check_call_consistency(jvms, cg), &quot;inconsistent info&quot;);
 675 
 676   if (!stopped()) {
 677     // This was some sort of virtual call, which did a null check for us.
 678     // Now we can assert receiver-not-null, on the normal return path.
 679     if (receiver != NULL &amp;&amp; cg-&gt;is_virtual()) {
 680       Node* cast = cast_not_null(receiver);
 681       // %%% assert(receiver == cast, &quot;should already have cast the receiver&quot;);
 682     }
 683 
 684     // Round double result after a call from strict to non-strict code
 685     round_double_result(cg-&gt;method());
 686 
 687     ciType* rtype = cg-&gt;method()-&gt;return_type();
 688     ciType* ctype = declared_signature-&gt;return_type();
 689 
 690     if (Bytecodes::has_optional_appendix(iter().cur_bc_raw()) || is_signature_polymorphic) {
 691       // Be careful here with return types.
 692       if (ctype != rtype) {
 693         BasicType rt = rtype-&gt;basic_type();
 694         BasicType ct = ctype-&gt;basic_type();
 695         if (ct == T_VOID) {
 696           // It&#39;s OK for a method  to return a value that is discarded.
 697           // The discarding does not require any special action from the caller.
 698           // The Java code knows this, at VerifyType.isNullConversion.
 699           pop_node(rt);  // whatever it was, pop it
 700         } else if (rt == T_INT || is_subword_type(rt)) {
 701           // Nothing.  These cases are handled in lambda form bytecode.
 702           assert(ct == T_INT || is_subword_type(ct), &quot;must match: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 703         } else if (rt == T_OBJECT || rt == T_ARRAY) {
 704           assert(ct == T_OBJECT || ct == T_ARRAY, &quot;rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 705           if (ctype-&gt;is_loaded()) {
 706             const TypeOopPtr* arg_type = TypeOopPtr::make_from_klass(rtype-&gt;as_klass());
 707             const Type*       sig_type = TypeOopPtr::make_from_klass(ctype-&gt;as_klass());
 708             if (arg_type != NULL &amp;&amp; !arg_type-&gt;higher_equal(sig_type)) {
 709               Node* retnode = pop();
 710               Node* cast_obj = _gvn.transform(new CheckCastPPNode(control(), retnode, sig_type));
 711               push(cast_obj);
 712             }
 713           }
 714         } else {
 715           assert(rt == ct, &quot;unexpected mismatch: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 716           // push a zero; it&#39;s better than getting an oop/int mismatch
 717           pop_node(rt);
 718           Node* retnode = zerocon(ct);
 719           push_node(ct, retnode);
 720         }
 721         // Now that the value is well-behaved, continue with the call-site type.
 722         rtype = ctype;
 723       }
 724     } else {
 725       // Symbolic resolution enforces the types to be the same.
 726       // NOTE: We must relax the assert for unloaded types because two
 727       // different ciType instances of the same unloaded class type
 728       // can appear to be &quot;loaded&quot; by different loaders (depending on
 729       // the accessing class).
 730       assert(!rtype-&gt;is_loaded() || !ctype-&gt;is_loaded() || rtype == ctype,
 731              &quot;mismatched return types: rtype=%s, ctype=%s&quot;, rtype-&gt;name(), ctype-&gt;name());
 732     }
 733 
 734     // If the return type of the method is not loaded, assert that the
 735     // value we got is a null.  Otherwise, we need to recompile.
 736     if (!rtype-&gt;is_loaded()) {
 737       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 738         method()-&gt;print_name(); tty-&gt;print_cr(&quot; asserting nullness of result at bci: %d&quot;, bci());
 739         cg-&gt;method()-&gt;print_name(); tty-&gt;cr();
 740       }
 741       if (C-&gt;log() != NULL) {
 742         C-&gt;log()-&gt;elem(&quot;assert_null reason=&#39;return&#39; klass=&#39;%d&#39;&quot;,
 743                        C-&gt;log()-&gt;identify(rtype));
 744       }
 745       // If there is going to be a trap, put it at the next bytecode:
 746       set_bci(iter().next_bci());
 747       null_assert(peek());
 748       set_bci(iter().cur_bci()); // put it back
 749     }
 750     BasicType ct = ctype-&gt;basic_type();
 751     if (ct == T_OBJECT || ct == T_ARRAY) {
 752       record_profiled_return_for_speculation();
 753     }
 754   }
 755 
 756   // Restart record of parsing work after possible inlining of call
 757 #ifndef PRODUCT
 758   parse_histogram()-&gt;set_initial_state(bc());
 759 #endif
 760 }
 761 
 762 //---------------------------catch_call_exceptions-----------------------------
 763 // Put a Catch and CatchProj nodes behind a just-created call.
 764 // Send their caught exceptions to the proper handler.
 765 // This may be used after a call to the rethrow VM stub,
 766 // when it is needed to process unloaded exception classes.
 767 void Parse::catch_call_exceptions(ciExceptionHandlerStream&amp; handlers) {
 768   // Exceptions are delivered through this channel:
 769   Node* i_o = this-&gt;i_o();
 770 
 771   // Add a CatchNode.
 772   GrowableArray&lt;int&gt;* bcis = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, -1);
 773   GrowableArray&lt;const Type*&gt;* extypes = new (C-&gt;node_arena()) GrowableArray&lt;const Type*&gt;(C-&gt;node_arena(), 8, 0, NULL);
 774   GrowableArray&lt;int&gt;* saw_unloaded = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, 0);
 775 
 776   bool default_handler = false;
 777   for (; !handlers.is_done(); handlers.next()) {
 778     ciExceptionHandler* h        = handlers.handler();
 779     int                 h_bci    = h-&gt;handler_bci();
 780     ciInstanceKlass*    h_klass  = h-&gt;is_catch_all() ? env()-&gt;Throwable_klass() : h-&gt;catch_klass();
 781     // Do not introduce unloaded exception types into the graph:
 782     if (!h_klass-&gt;is_loaded()) {
 783       if (saw_unloaded-&gt;contains(h_bci)) {
 784         /* We&#39;ve already seen an unloaded exception with h_bci,
 785            so don&#39;t duplicate. Duplication will cause the CatchNode to be
 786            unnecessarily large. See 4713716. */
 787         continue;
 788       } else {
 789         saw_unloaded-&gt;append(h_bci);
 790       }
 791     }
 792     const Type*         h_extype = TypeOopPtr::make_from_klass(h_klass);
 793     // (We use make_from_klass because it respects UseUniqueSubclasses.)
 794     h_extype = h_extype-&gt;join(TypeInstPtr::NOTNULL);
 795     assert(!h_extype-&gt;empty(), &quot;sanity&quot;);
 796     // Note:  It&#39;s OK if the BCIs repeat themselves.
 797     bcis-&gt;append(h_bci);
 798     extypes-&gt;append(h_extype);
 799     if (h_bci == -1) {
 800       default_handler = true;
 801     }
 802   }
 803 
 804   if (!default_handler) {
 805     bcis-&gt;append(-1);
 806     extypes-&gt;append(TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr());
 807   }
 808 
 809   int len = bcis-&gt;length();
 810   CatchNode *cn = new CatchNode(control(), i_o, len+1);
 811   Node *catch_ = _gvn.transform(cn);
 812 
 813   // now branch with the exception state to each of the (potential)
 814   // handlers
 815   for(int i=0; i &lt; len; i++) {
 816     // Setup JVM state to enter the handler.
 817     PreserveJVMState pjvms(this);
 818     // Locals are just copied from before the call.
 819     // Get control from the CatchNode.
 820     int handler_bci = bcis-&gt;at(i);
 821     Node* ctrl = _gvn.transform( new CatchProjNode(catch_, i+1,handler_bci));
 822     // This handler cannot happen?
 823     if (ctrl == top())  continue;
 824     set_control(ctrl);
 825 
 826     // Create exception oop
 827     const TypeInstPtr* extype = extypes-&gt;at(i)-&gt;is_instptr();
 828     Node *ex_oop = _gvn.transform(new CreateExNode(extypes-&gt;at(i), ctrl, i_o));
 829 
 830     // Handle unloaded exception classes.
 831     if (saw_unloaded-&gt;contains(handler_bci)) {
 832       // An unloaded exception type is coming here.  Do an uncommon trap.
 833 #ifndef PRODUCT
 834       // We do not expect the same handler bci to take both cold unloaded
 835       // and hot loaded exceptions.  But, watch for it.
 836       if ((Verbose || WizardMode) &amp;&amp; extype-&gt;is_loaded()) {
 837         tty-&gt;print(&quot;Warning: Handler @%d takes mixed loaded/unloaded exceptions in &quot;, bci());
 838         method()-&gt;print_name(); tty-&gt;cr();
 839       } else if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 840         tty-&gt;print(&quot;Bailing out on unloaded exception type &quot;);
 841         extype-&gt;klass()-&gt;print_name();
 842         tty-&gt;print(&quot; at bci:%d in &quot;, bci());
 843         method()-&gt;print_name(); tty-&gt;cr();
 844       }
 845 #endif
 846       // Emit an uncommon trap instead of processing the block.
 847       set_bci(handler_bci);
 848       push_ex_oop(ex_oop);
 849       uncommon_trap(Deoptimization::Reason_unloaded,
 850                     Deoptimization::Action_reinterpret,
 851                     extype-&gt;klass(), &quot;!loaded exception&quot;);
 852       set_bci(iter().cur_bci()); // put it back
 853       continue;
 854     }
 855 
 856     // go to the exception handler
 857     if (handler_bci &lt; 0) {     // merge with corresponding rethrow node
 858       throw_to_exit(make_exception_state(ex_oop));
 859     } else {                      // Else jump to corresponding handle
 860       push_ex_oop(ex_oop);        // Clear stack and push just the oop.
 861       merge_exception(handler_bci);
 862     }
 863   }
 864 
 865   // The first CatchProj is for the normal return.
 866   // (Note:  If this is a call to rethrow_Java, this node goes dead.)
 867   set_control(_gvn.transform( new CatchProjNode(catch_, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci)));
 868 }
 869 
 870 
 871 //----------------------------catch_inline_exceptions--------------------------
 872 // Handle all exceptions thrown by an inlined method or individual bytecode.
 873 // Common case 1: we have no handler, so all exceptions merge right into
 874 // the rethrow case.
 875 // Case 2: we have some handlers, with loaded exception klasses that have
 876 // no subklasses.  We do a Deutsch-Shiffman style type-check on the incoming
 877 // exception oop and branch to the handler directly.
 878 // Case 3: We have some handlers with subklasses or are not loaded at
 879 // compile-time.  We have to call the runtime to resolve the exception.
 880 // So we insert a RethrowCall and all the logic that goes with it.
 881 void Parse::catch_inline_exceptions(SafePointNode* ex_map) {
 882   // Caller is responsible for saving away the map for normal control flow!
 883   assert(stopped(), &quot;call set_map(NULL) first&quot;);
 884   assert(method()-&gt;has_exception_handlers(), &quot;don&#39;t come here w/o work to do&quot;);
 885 
 886   Node* ex_node = saved_ex_oop(ex_map);
 887   if (ex_node == top()) {
 888     // No action needed.
 889     return;
 890   }
 891   const TypeInstPtr* ex_type = _gvn.type(ex_node)-&gt;isa_instptr();
 892   NOT_PRODUCT(if (ex_type==NULL) tty-&gt;print_cr(&quot;*** Exception not InstPtr&quot;));
 893   if (ex_type == NULL)
 894     ex_type = TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr();
 895 
 896   // determine potential exception handlers
 897   ciExceptionHandlerStream handlers(method(), bci(),
 898                                     ex_type-&gt;klass()-&gt;as_instance_klass(),
 899                                     ex_type-&gt;klass_is_exact());
 900 
 901   // Start executing from the given throw state.  (Keep its stack, for now.)
 902   // Get the exception oop as known at compile time.
 903   ex_node = use_exception_state(ex_map);
 904 
 905   // Get the exception oop klass from its header
 906   Node* ex_klass_node = NULL;
 907   if (has_ex_handler() &amp;&amp; !ex_type-&gt;klass_is_exact()) {
 908     Node* p = basic_plus_adr( ex_node, ex_node, oopDesc::klass_offset_in_bytes());
 909     ex_klass_node = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 910 
 911     // Compute the exception klass a little more cleverly.
 912     // Obvious solution is to simple do a LoadKlass from the &#39;ex_node&#39;.
 913     // However, if the ex_node is a PhiNode, I&#39;m going to do a LoadKlass for
 914     // each arm of the Phi.  If I know something clever about the exceptions
 915     // I&#39;m loading the class from, I can replace the LoadKlass with the
 916     // klass constant for the exception oop.
 917     if (ex_node-&gt;is_Phi()) {
 918       ex_klass_node = new PhiNode(ex_node-&gt;in(0), TypeKlassPtr::OBJECT);
 919       for (uint i = 1; i &lt; ex_node-&gt;req(); i++) {
 920         Node* ex_in = ex_node-&gt;in(i);
 921         if (ex_in == top() || ex_in == NULL) {
 922           // This path was not taken.
 923           ex_klass_node-&gt;init_req(i, top());
 924           continue;
 925         }
 926         Node* p = basic_plus_adr(ex_in, ex_in, oopDesc::klass_offset_in_bytes());
 927         Node* k = _gvn.transform( LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 928         ex_klass_node-&gt;init_req( i, k );
 929       }
 930       _gvn.set_type(ex_klass_node, TypeKlassPtr::OBJECT);
 931 
 932     }
 933   }
 934 
 935   // Scan the exception table for applicable handlers.
 936   // If none, we can call rethrow() and be done!
 937   // If precise (loaded with no subklasses), insert a D.S. style
 938   // pointer compare to the correct handler and loop back.
 939   // If imprecise, switch to the Rethrow VM-call style handling.
 940 
 941   int remaining = handlers.count_remaining();
 942 
 943   // iterate through all entries sequentially
 944   for (;!handlers.is_done(); handlers.next()) {
 945     ciExceptionHandler* handler = handlers.handler();
 946 
 947     if (handler-&gt;is_rethrow()) {
 948       // If we fell off the end of the table without finding an imprecise
 949       // exception klass (and without finding a generic handler) then we
 950       // know this exception is not handled in this method.  We just rethrow
 951       // the exception into the caller.
 952       throw_to_exit(make_exception_state(ex_node));
 953       return;
 954     }
 955 
 956     // exception handler bci range covers throw_bci =&gt; investigate further
 957     int handler_bci = handler-&gt;handler_bci();
 958 
 959     if (remaining == 1) {
 960       push_ex_oop(ex_node);        // Push exception oop for handler
 961       if (PrintOpto &amp;&amp; WizardMode) {
 962         tty-&gt;print_cr(&quot;  Catching every inline exception bci:%d -&gt; handler_bci:%d&quot;, bci(), handler_bci);
 963       }
 964       merge_exception(handler_bci); // jump to handler
 965       return;                   // No more handling to be done here!
 966     }
 967 
 968     // Get the handler&#39;s klass
 969     ciInstanceKlass* klass = handler-&gt;catch_klass();
 970 
 971     if (!klass-&gt;is_loaded()) {  // klass is not loaded?
 972       // fall through into catch_call_exceptions which will emit a
 973       // handler with an uncommon trap.
 974       break;
 975     }
 976 
 977     if (klass-&gt;is_interface())  // should not happen, but...
 978       break;                    // bail out
 979 
 980     // Check the type of the exception against the catch type
 981     const TypeKlassPtr *tk = TypeKlassPtr::make(klass);
 982     Node* con = _gvn.makecon(tk);
 983     Node* not_subtype_ctrl = gen_subtype_check(ex_klass_node, con);
 984     if (!stopped()) {
 985       PreserveJVMState pjvms(this);
 986       const TypeInstPtr* tinst = TypeOopPtr::make_from_klass_unique(klass)-&gt;cast_to_ptr_type(TypePtr::NotNull)-&gt;is_instptr();
 987       assert(klass-&gt;has_subklass() || tinst-&gt;klass_is_exact(), &quot;lost exactness&quot;);
 988       Node* ex_oop = _gvn.transform(new CheckCastPPNode(control(), ex_node, tinst));
 989       push_ex_oop(ex_oop);      // Push exception oop for handler
 990       if (PrintOpto &amp;&amp; WizardMode) {
 991         tty-&gt;print(&quot;  Catching inline exception bci:%d -&gt; handler_bci:%d -- &quot;, bci(), handler_bci);
 992         klass-&gt;print_name();
 993         tty-&gt;cr();
 994       }
 995       merge_exception(handler_bci);
 996     }
 997     set_control(not_subtype_ctrl);
 998 
 999     // Come here if exception does not match handler.
1000     // Carry on with more handler checks.
1001     --remaining;
1002   }
1003 
1004   assert(!stopped(), &quot;you should return if you finish the chain&quot;);
1005 
1006   // Oops, need to call into the VM to resolve the klasses at runtime.
1007   // Note:  This call must not deoptimize, since it is not a real at this bci!
1008   kill_dead_locals();
1009 
1010   make_runtime_call(RC_NO_LEAF | RC_MUST_THROW,
1011                     OptoRuntime::rethrow_Type(),
1012                     OptoRuntime::rethrow_stub(),
1013                     NULL, NULL,
1014                     ex_node);
1015 
1016   // Rethrow is a pure call, no side effects, only a result.
1017   // The result cannot be allocated, so we use I_O
1018 
1019   // Catch exceptions from the rethrow
1020   catch_call_exceptions(handlers);
1021 }
1022 
1023 
1024 // (Note:  Moved add_debug_info into GraphKit::add_safepoint_edges.)
1025 
1026 
1027 #ifndef PRODUCT
1028 void Parse::count_compiled_calls(bool at_method_entry, bool is_inline) {
1029   if( CountCompiledCalls ) {
1030     if( at_method_entry ) {
1031       // bump invocation counter if top method (for statistics)
1032       if (CountCompiledCalls &amp;&amp; depth() == 1) {
1033         const TypePtr* addr_type = TypeMetadataPtr::make(method());
1034         Node* adr1 = makecon(addr_type);
1035         Node* adr2 = basic_plus_adr(adr1, adr1, in_bytes(Method::compiled_invocation_counter_offset()));
1036         increment_counter(adr2);
1037       }
1038     } else if (is_inline) {
1039       switch (bc()) {
1040       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_inlined_calls_addr()); break;
1041       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_inlined_interface_calls_addr()); break;
1042       case Bytecodes::_invokestatic:
1043       case Bytecodes::_invokedynamic:
1044       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_inlined_static_calls_addr()); break;
1045       default: fatal(&quot;unexpected call bytecode&quot;);
1046       }
1047     } else {
1048       switch (bc()) {
1049       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_normal_calls_addr()); break;
1050       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_interface_calls_addr()); break;
1051       case Bytecodes::_invokestatic:
1052       case Bytecodes::_invokedynamic:
1053       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_static_calls_addr()); break;
1054       default: fatal(&quot;unexpected call bytecode&quot;);
1055       }
1056     }
1057   }
1058 }
1059 #endif //PRODUCT
1060 
1061 
1062 ciMethod* Compile::optimize_virtual_call(ciMethod* caller, int bci, ciInstanceKlass* klass,
1063                                          ciKlass* holder, ciMethod* callee,
1064                                          const TypeOopPtr* receiver_type, bool is_virtual,
1065                                          bool&amp; call_does_dispatch, int&amp; vtable_index,
1066                                          bool check_access) {
1067   // Set default values for out-parameters.
1068   call_does_dispatch = true;
1069   vtable_index       = Method::invalid_vtable_index;
1070 
1071   // Choose call strategy.
1072   ciMethod* optimized_virtual_method = optimize_inlining(caller, bci, klass, callee,
1073                                                          receiver_type, check_access);
1074 
1075   // Have the call been sufficiently improved such that it is no longer a virtual?
1076   if (optimized_virtual_method != NULL) {
1077     callee             = optimized_virtual_method;
1078     call_does_dispatch = false;
1079   } else if (!UseInlineCaches &amp;&amp; is_virtual &amp;&amp; callee-&gt;is_loaded()) {
1080     // We can make a vtable call at this site
1081     vtable_index = callee-&gt;resolve_vtable_index(caller-&gt;holder(), holder);
1082   }
1083   return callee;
1084 }
1085 
1086 // Identify possible target method and inlining style
1087 ciMethod* Compile::optimize_inlining(ciMethod* caller, int bci, ciInstanceKlass* klass,
1088                                      ciMethod* callee, const TypeOopPtr* receiver_type,
1089                                      bool check_access) {
1090   // only use for virtual or interface calls
1091 
1092   // If it is obviously final, do not bother to call find_monomorphic_target,
1093   // because the class hierarchy checks are not needed, and may fail due to
1094   // incompletely loaded classes.  Since we do our own class loading checks
1095   // in this module, we may confidently bind to any method.
1096   if (callee-&gt;can_be_statically_bound()) {
1097     return callee;
1098   }
1099 
1100   // Attempt to improve the receiver
1101   bool actual_receiver_is_exact = false;
1102   ciInstanceKlass* actual_receiver = klass;
1103   if (receiver_type != NULL) {
1104     // Array methods are all inherited from Object, and are monomorphic.
1105     // finalize() call on array is not allowed.
1106     if (receiver_type-&gt;isa_aryptr() &amp;&amp;
1107         callee-&gt;holder() == env()-&gt;Object_klass() &amp;&amp;
1108         callee-&gt;name() != ciSymbol::finalize_method_name()) {
1109       return callee;
1110     }
1111 
1112     // All other interesting cases are instance klasses.
1113     if (!receiver_type-&gt;isa_instptr()) {
1114       return NULL;
1115     }
1116 
1117     ciInstanceKlass *ikl = receiver_type-&gt;klass()-&gt;as_instance_klass();
1118     if (ikl-&gt;is_loaded() &amp;&amp; ikl-&gt;is_initialized() &amp;&amp; !ikl-&gt;is_interface() &amp;&amp;
1119         (ikl == actual_receiver || ikl-&gt;is_subtype_of(actual_receiver))) {
1120       // ikl is a same or better type than the original actual_receiver,
1121       // e.g. static receiver from bytecodes.
1122       actual_receiver = ikl;
1123       // Is the actual_receiver exact?
1124       actual_receiver_is_exact = receiver_type-&gt;klass_is_exact();
1125     }
1126   }
1127 
1128   ciInstanceKlass*   calling_klass = caller-&gt;holder();
1129   ciMethod* cha_monomorphic_target = callee-&gt;find_monomorphic_target(calling_klass, klass, actual_receiver, check_access);
1130   if (cha_monomorphic_target != NULL) {
1131     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1132     // Look at the method-receiver type.  Does it add &quot;too much information&quot;?
1133     ciKlass*    mr_klass = cha_monomorphic_target-&gt;holder();
1134     const Type* mr_type  = TypeInstPtr::make(TypePtr::BotPTR, mr_klass);
1135     if (receiver_type == NULL || !receiver_type-&gt;higher_equal(mr_type)) {
1136       // Calling this method would include an implicit cast to its holder.
1137       // %%% Not yet implemented.  Would throw minor asserts at present.
1138       // %%% The most common wins are already gained by +UseUniqueSubclasses.
1139       // To fix, put the higher_equal check at the call of this routine,
1140       // and add a CheckCastPP to the receiver.
1141       if (TraceDependencies) {
1142         tty-&gt;print_cr(&quot;found unique CHA method, but could not cast up&quot;);
1143         tty-&gt;print(&quot;  method  = &quot;);
1144         cha_monomorphic_target-&gt;print();
1145         tty-&gt;cr();
1146       }
1147       if (log() != NULL) {
1148         log()-&gt;elem(&quot;missed_CHA_opportunity klass=&#39;%d&#39; method=&#39;%d&#39;&quot;,
1149                        log()-&gt;identify(klass),
1150                        log()-&gt;identify(cha_monomorphic_target));
1151       }
1152       cha_monomorphic_target = NULL;
1153     }
1154   }
1155   if (cha_monomorphic_target != NULL) {
1156     // Hardwiring a virtual.
1157     // If we inlined because CHA revealed only a single target method,
1158     // then we are dependent on that target method not getting overridden
1159     // by dynamic class loading.  Be sure to test the &quot;static&quot; receiver
1160     // dest_method here, as opposed to the actual receiver, which may
1161     // falsely lead us to believe that the receiver is final or private.
1162     dependencies()-&gt;assert_unique_concrete_method(actual_receiver, cha_monomorphic_target);
1163     return cha_monomorphic_target;
1164   }
1165 
1166   // If the type is exact, we can still bind the method w/o a vcall.
1167   // (This case comes after CHA so we can see how much extra work it does.)
1168   if (actual_receiver_is_exact) {
1169     // In case of evolution, there is a dependence on every inlined method, since each
1170     // such method can be changed when its class is redefined.
1171     ciMethod* exact_method = callee-&gt;resolve_invoke(calling_klass, actual_receiver);
1172     if (exact_method != NULL) {
1173       if (PrintOpto) {
1174         tty-&gt;print(&quot;  Calling method via exact type @%d --- &quot;, bci);
1175         exact_method-&gt;print_name();
1176         tty-&gt;cr();
1177       }
1178       return exact_method;
1179     }
1180   }
1181 
1182   return NULL;
1183 }
    </pre>
  </body>
</html>