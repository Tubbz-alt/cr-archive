<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/parse1.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileLog.hpp&quot;
  27 #include &quot;interpreter/linkResolver.hpp&quot;
  28 #include &quot;memory/resourceArea.hpp&quot;
  29 #include &quot;oops/method.hpp&quot;
  30 #include &quot;opto/addnode.hpp&quot;
  31 #include &quot;opto/c2compiler.hpp&quot;
  32 #include &quot;opto/castnode.hpp&quot;
  33 #include &quot;opto/idealGraphPrinter.hpp&quot;
  34 #include &quot;opto/locknode.hpp&quot;
  35 #include &quot;opto/memnode.hpp&quot;
  36 #include &quot;opto/opaquenode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/handles.inline.hpp&quot;
  42 #include &quot;runtime/safepointMechanism.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  44 #include &quot;utilities/bitMap.inline.hpp&quot;</span>
  45 #include &quot;utilities/copy.hpp&quot;
  46 
  47 // Static array so we can figure out which bytecodes stop us from compiling
  48 // the most. Some of the non-static variables are needed in bytecodeInfo.cpp
  49 // and eventually should be encapsulated in a proper class (gri 8/18/98).
  50 
  51 #ifndef PRODUCT
  52 int nodes_created              = 0;
  53 int methods_parsed             = 0;
  54 int methods_seen               = 0;
  55 int blocks_parsed              = 0;
  56 int blocks_seen                = 0;
  57 
  58 int explicit_null_checks_inserted = 0;
  59 int explicit_null_checks_elided   = 0;
  60 int all_null_checks_found         = 0;
  61 int implicit_null_checks          = 0;
  62 
  63 bool Parse::BytecodeParseHistogram::_initialized = false;
  64 uint Parse::BytecodeParseHistogram::_bytecodes_parsed [Bytecodes::number_of_codes];
  65 uint Parse::BytecodeParseHistogram::_nodes_constructed[Bytecodes::number_of_codes];
  66 uint Parse::BytecodeParseHistogram::_nodes_transformed[Bytecodes::number_of_codes];
  67 uint Parse::BytecodeParseHistogram::_new_values       [Bytecodes::number_of_codes];
  68 
  69 //------------------------------print_statistics-------------------------------
  70 void Parse::print_statistics() {
  71   tty-&gt;print_cr(&quot;--- Compiler Statistics ---&quot;);
  72   tty-&gt;print(&quot;Methods seen: %d  Methods parsed: %d&quot;, methods_seen, methods_parsed);
  73   tty-&gt;print(&quot;  Nodes created: %d&quot;, nodes_created);
  74   tty-&gt;cr();
  75   if (methods_seen != methods_parsed) {
  76     tty-&gt;print_cr(&quot;Reasons for parse failures (NOT cumulative):&quot;);
  77   }
  78   tty-&gt;print_cr(&quot;Blocks parsed: %d  Blocks seen: %d&quot;, blocks_parsed, blocks_seen);
  79 
  80   if (explicit_null_checks_inserted) {
  81     tty-&gt;print_cr(&quot;%d original NULL checks - %d elided (%2d%%); optimizer leaves %d,&quot;,
  82                   explicit_null_checks_inserted, explicit_null_checks_elided,
  83                   (100*explicit_null_checks_elided)/explicit_null_checks_inserted,
  84                   all_null_checks_found);
  85   }
  86   if (all_null_checks_found) {
  87     tty-&gt;print_cr(&quot;%d made implicit (%2d%%)&quot;, implicit_null_checks,
  88                   (100*implicit_null_checks)/all_null_checks_found);
  89   }
  90   if (SharedRuntime::_implicit_null_throws) {
  91     tty-&gt;print_cr(&quot;%d implicit null exceptions at runtime&quot;,
  92                   SharedRuntime::_implicit_null_throws);
  93   }
  94 
  95   if (PrintParseStatistics &amp;&amp; BytecodeParseHistogram::initialized()) {
  96     BytecodeParseHistogram::print();
  97   }
  98 }
  99 #endif
 100 
 101 //------------------------------ON STACK REPLACEMENT---------------------------
 102 
 103 // Construct a node which can be used to get incoming state for
 104 // on stack replacement.
 105 Node *Parse::fetch_interpreter_state(int index,
 106                                      BasicType bt,
 107                                      Node *local_addrs,
 108                                      Node *local_addrs_base) {
 109   Node *mem = memory(Compile::AliasIdxRaw);
 110   Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );
 111   Node *ctl = control();
 112 
 113   // Very similar to LoadNode::make, except we handle un-aligned longs and
 114   // doubles on Sparc.  Intel can handle them just fine directly.
 115   Node *l = NULL;
 116   switch (bt) {                // Signature is flattened
 117   case T_INT:     l = new LoadINode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInt::INT,        MemNode::unordered); break;
 118   case T_FLOAT:   l = new LoadFNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::FLOAT,         MemNode::unordered); break;
 119   case T_ADDRESS: l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeRawPtr::BOTTOM,  MemNode::unordered); break;
 120   case T_OBJECT:  l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInstPtr::BOTTOM, MemNode::unordered); break;
 121   case T_LONG:
 122   case T_DOUBLE: {
 123     // Since arguments are in reverse order, the argument address &#39;adr&#39;
 124     // refers to the back half of the long/double.  Recompute adr.
 125     adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);
 126     if (Matcher::misaligned_doubles_ok) {
 127       l = (bt == T_DOUBLE)
 128         ? (Node*)new LoadDNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::DOUBLE, MemNode::unordered)
 129         : (Node*)new LoadLNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeLong::LONG, MemNode::unordered);
 130     } else {
 131       l = (bt == T_DOUBLE)
 132         ? (Node*)new LoadD_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered)
 133         : (Node*)new LoadL_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered);
 134     }
 135     break;
 136   }
 137   default: ShouldNotReachHere();
 138   }
 139   return _gvn.transform(l);
 140 }
 141 
 142 // Helper routine to prevent the interpreter from handing
 143 // unexpected typestate to an OSR method.
 144 // The Node l is a value newly dug out of the interpreter frame.
 145 // The type is the type predicted by ciTypeFlow.  Note that it is
 146 // not a general type, but can only come from Type::get_typeflow_type.
 147 // The safepoint is a map which will feed an uncommon trap.
 148 Node* Parse::check_interpreter_type(Node* l, const Type* type,
 149                                     SafePointNode* &amp;bad_type_exit) {
 150 
 151   const TypeOopPtr* tp = type-&gt;isa_oopptr();
 152 
 153   // TypeFlow may assert null-ness if a type appears unloaded.
 154   if (type == TypePtr::NULL_PTR ||
 155       (tp != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded())) {
 156     // Value must be null, not a real oop.
 157     Node* chk = _gvn.transform( new CmpPNode(l, null()) );
 158     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 159     IfNode* iff = create_and_map_if(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 160     set_control(_gvn.transform( new IfTrueNode(iff) ));
 161     Node* bad_type = _gvn.transform( new IfFalseNode(iff) );
 162     bad_type_exit-&gt;control()-&gt;add_req(bad_type);
 163     l = null();
 164   }
 165 
 166   // Typeflow can also cut off paths from the CFG, based on
 167   // types which appear unloaded, or call sites which appear unlinked.
 168   // When paths are cut off, values at later merge points can rise
 169   // toward more specific classes.  Make sure these specific classes
 170   // are still in effect.
 171   if (tp != NULL &amp;&amp; tp-&gt;klass() != C-&gt;env()-&gt;Object_klass()) {
 172     // TypeFlow asserted a specific object type.  Value must have that type.
 173     Node* bad_type_ctrl = NULL;
 174     l = gen_checkcast(l, makecon(TypeKlassPtr::make(tp-&gt;klass())), &amp;bad_type_ctrl);
 175     bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 176   }
 177 
 178   BasicType bt_l = _gvn.type(l)-&gt;basic_type();
 179   BasicType bt_t = type-&gt;basic_type();
 180   assert(_gvn.type(l)-&gt;higher_equal(type), &quot;must constrain OSR typestate&quot;);
 181   return l;
 182 }
 183 
 184 // Helper routine which sets up elements of the initial parser map when
 185 // performing a parse for on stack replacement.  Add values into map.
 186 // The only parameter contains the address of a interpreter arguments.
 187 void Parse::load_interpreter_state(Node* osr_buf) {
 188   int index;
 189   int max_locals = jvms()-&gt;loc_size();
 190   int max_stack  = jvms()-&gt;stk_size();
 191 
 192 
 193   // Mismatch between method and jvms can occur since map briefly held
 194   // an OSR entry state (which takes up one RawPtr word).
 195   assert(max_locals == method()-&gt;max_locals(), &quot;sanity&quot;);
 196   assert(max_stack  &gt;= method()-&gt;max_stack(),  &quot;sanity&quot;);
 197   assert((int)jvms()-&gt;endoff() == TypeFunc::Parms + max_locals + max_stack, &quot;sanity&quot;);
 198   assert((int)jvms()-&gt;endoff() == (int)map()-&gt;req(), &quot;sanity&quot;);
 199 
 200   // Find the start block.
 201   Block* osr_block = start_block();
 202   assert(osr_block-&gt;start() == osr_bci(), &quot;sanity&quot;);
 203 
 204   // Set initial BCI.
 205   set_parse_bci(osr_block-&gt;start());
 206 
 207   // Set initial stack depth.
 208   set_sp(osr_block-&gt;start_sp());
 209 
 210   // Check bailouts.  We currently do not perform on stack replacement
 211   // of loops in catch blocks or loops which branch with a non-empty stack.
 212   if (sp() != 0) {
 213     C-&gt;record_method_not_compilable(&quot;OSR starts with non-empty stack&quot;);
 214     return;
 215   }
 216   // Do not OSR inside finally clauses:
 217   if (osr_block-&gt;has_trap_at(osr_block-&gt;start())) {
 218     C-&gt;record_method_not_compilable(&quot;OSR starts with an immediate trap&quot;);
 219     return;
 220   }
 221 
 222   // Commute monitors from interpreter frame to compiler frame.
 223   assert(jvms()-&gt;monitor_depth() == 0, &quot;should be no active locks at beginning of osr&quot;);
 224   int mcnt = osr_block-&gt;flow()-&gt;monitor_count();
 225   Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);
 226   for (index = 0; index &lt; mcnt; index++) {
 227     // Make a BoxLockNode for the monitor.
 228     Node *box = _gvn.transform(new BoxLockNode(next_monitor()));
 229 
 230 
 231     // Displaced headers and locked objects are interleaved in the
 232     // temp OSR buffer.  We only copy the locked objects out here.
 233     // Fetch the locked object from the OSR temp buffer and copy to our fastlock node.
 234     Node *lock_object = fetch_interpreter_state(index*2, T_OBJECT, monitors_addr, osr_buf);
 235     // Try and copy the displaced header to the BoxNode
 236     Node *displaced_hdr = fetch_interpreter_state((index*2) + 1, T_ADDRESS, monitors_addr, osr_buf);
 237 
 238 
 239     store_to_memory(control(), box, displaced_hdr, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
 240 
 241     // Build a bogus FastLockNode (no code will be generated) and push the
 242     // monitor into our debug info.
 243     const FastLockNode *flock = _gvn.transform(new FastLockNode( 0, lock_object, box ))-&gt;as_FastLock();
 244     map()-&gt;push_monitor(flock);
 245 
 246     // If the lock is our method synchronization lock, tuck it away in
 247     // _sync_lock for return and rethrow exit paths.
 248     if (index == 0 &amp;&amp; method()-&gt;is_synchronized()) {
 249       _synch_lock = flock;
 250     }
 251   }
 252 
 253   // Use the raw liveness computation to make sure that unexpected
 254   // values don&#39;t propagate into the OSR frame.
 255   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(osr_bci());
 256   if (!live_locals.is_valid()) {
 257     // Degenerate or breakpointed method.
 258     C-&gt;record_method_not_compilable(&quot;OSR in empty or breakpointed method&quot;);
 259     return;
 260   }
 261 
 262   // Extract the needed locals from the interpreter frame.
 263   Node *locals_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals-1)*wordSize);
 264 
 265   // find all the locals that the interpreter thinks contain live oops
 266   const ResourceBitMap live_oops = method()-&gt;live_local_oops_at_bci(osr_bci());
 267   for (index = 0; index &lt; max_locals; index++) {
 268 
 269     if (!live_locals.at(index)) {
 270       continue;
 271     }
 272 
 273     const Type *type = osr_block-&gt;local_type_at(index);
 274 
 275     if (type-&gt;isa_oopptr() != NULL) {
 276 
 277       // 6403625: Verify that the interpreter oopMap thinks that the oop is live
 278       // else we might load a stale oop if the MethodLiveness disagrees with the
 279       // result of the interpreter. If the interpreter says it is dead we agree
 280       // by making the value go to top.
 281       //
 282 
 283       if (!live_oops.at(index)) {
 284         if (C-&gt;log() != NULL) {
 285           C-&gt;log()-&gt;elem(&quot;OSR_mismatch local_index=&#39;%d&#39;&quot;,index);
 286         }
 287         set_local(index, null());
 288         // and ignore it for the loads
 289         continue;
 290       }
 291     }
 292 
 293     // Filter out TOP, HALF, and BOTTOM.  (Cf. ensure_phi.)
 294     if (type == Type::TOP || type == Type::HALF) {
 295       continue;
 296     }
 297     // If the type falls to bottom, then this must be a local that
 298     // is mixing ints and oops or some such.  Forcing it to top
 299     // makes it go dead.
 300     if (type == Type::BOTTOM) {
 301       continue;
 302     }
 303     // Construct code to access the appropriate local.
 304     BasicType bt = type-&gt;basic_type();
 305     if (type == TypePtr::NULL_PTR) {
 306       // Ptr types are mixed together with T_ADDRESS but NULL is
 307       // really for T_OBJECT types so correct it.
 308       bt = T_OBJECT;
 309     }
 310     Node *value = fetch_interpreter_state(index, bt, locals_addr, osr_buf);
 311     set_local(index, value);
 312   }
 313 
 314   // Extract the needed stack entries from the interpreter frame.
 315   for (index = 0; index &lt; sp(); index++) {
 316     const Type *type = osr_block-&gt;stack_type_at(index);
 317     if (type != Type::TOP) {
 318       // Currently the compiler bails out when attempting to on stack replace
 319       // at a bci with a non-empty stack.  We should not reach here.
 320       ShouldNotReachHere();
 321     }
 322   }
 323 
 324   // End the OSR migration
 325   make_runtime_call(RC_LEAF, OptoRuntime::osr_end_Type(),
 326                     CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
 327                     &quot;OSR_migration_end&quot;, TypeRawPtr::BOTTOM,
 328                     osr_buf);
 329 
 330   // Now that the interpreter state is loaded, make sure it will match
 331   // at execution time what the compiler is expecting now:
 332   SafePointNode* bad_type_exit = clone_map();
 333   bad_type_exit-&gt;set_control(new RegionNode(1));
 334 
 335   assert(osr_block-&gt;flow()-&gt;jsrs()-&gt;size() == 0, &quot;should be no jsrs live at osr point&quot;);
 336   for (index = 0; index &lt; max_locals; index++) {
 337     if (stopped())  break;
 338     Node* l = local(index);
 339     if (l-&gt;is_top())  continue;  // nothing here
 340     const Type *type = osr_block-&gt;local_type_at(index);
 341     if (type-&gt;isa_oopptr() != NULL) {
 342       if (!live_oops.at(index)) {
 343         // skip type check for dead oops
 344         continue;
 345       }
 346     }
 347     if (osr_block-&gt;flow()-&gt;local_type_at(index)-&gt;is_return_address()) {
 348       // In our current system it&#39;s illegal for jsr addresses to be
 349       // live into an OSR entry point because the compiler performs
 350       // inlining of jsrs.  ciTypeFlow has a bailout that detect this
 351       // case and aborts the compile if addresses are live into an OSR
 352       // entry point.  Because of that we can assume that any address
 353       // locals at the OSR entry point are dead.  Method liveness
 354       // isn&#39;t precise enought to figure out that they are dead in all
 355       // cases so simply skip checking address locals all
 356       // together. Any type check is guaranteed to fail since the
 357       // interpreter type is the result of a load which might have any
 358       // value and the expected type is a constant.
 359       continue;
 360     }
 361     set_local(index, check_interpreter_type(l, type, bad_type_exit));
 362   }
 363 
 364   for (index = 0; index &lt; sp(); index++) {
 365     if (stopped())  break;
 366     Node* l = stack(index);
 367     if (l-&gt;is_top())  continue;  // nothing here
 368     const Type *type = osr_block-&gt;stack_type_at(index);
 369     set_stack(index, check_interpreter_type(l, type, bad_type_exit));
 370   }
 371 
 372   if (bad_type_exit-&gt;control()-&gt;req() &gt; 1) {
 373     // Build an uncommon trap here, if any inputs can be unexpected.
 374     bad_type_exit-&gt;set_control(_gvn.transform( bad_type_exit-&gt;control() ));
 375     record_for_igvn(bad_type_exit-&gt;control());
 376     SafePointNode* types_are_good = map();
 377     set_map(bad_type_exit);
 378     // The unexpected type happens because a new edge is active
 379     // in the CFG, which typeflow had previously ignored.
 380     // E.g., Object x = coldAtFirst() &amp;&amp; notReached()? &quot;str&quot;: new Integer(123).
 381     // This x will be typed as Integer if notReached is not yet linked.
 382     // It could also happen due to a problem in ciTypeFlow analysis.
 383     uncommon_trap(Deoptimization::Reason_constraint,
 384                   Deoptimization::Action_reinterpret);
 385     set_map(types_are_good);
 386   }
 387 }
 388 
 389 //------------------------------Parse------------------------------------------
 390 // Main parser constructor.
 391 Parse::Parse(JVMState* caller, ciMethod* parse_method, float expected_uses)
 392   : _exits(caller)
 393 {
 394   // Init some variables
 395   _caller = caller;
 396   _method = parse_method;
 397   _expected_uses = expected_uses;
 398   _depth = 1 + (caller-&gt;has_method() ? caller-&gt;depth() : 0);
 399   _wrote_final = false;
 400   _wrote_volatile = false;
 401   _wrote_stable = false;
 402   _wrote_fields = false;
 403   _alloc_with_final = NULL;
 404   _entry_bci = InvocationEntryBci;
 405   _tf = NULL;
 406   _block = NULL;
 407   _first_return = true;
 408   _replaced_nodes_for_exceptions = false;
 409   _new_idx = C-&gt;unique();
 410   debug_only(_block_count = -1);
 411   debug_only(_blocks = (Block*)-1);
 412 #ifndef PRODUCT
 413   if (PrintCompilation || PrintOpto) {
 414     // Make sure I have an inline tree, so I can print messages about it.
 415     JVMState* ilt_caller = is_osr_parse() ? caller-&gt;caller() : caller;
 416     InlineTree::find_subtree_from_root(C-&gt;ilt(), ilt_caller, parse_method);
 417   }
 418   _max_switch_depth = 0;
 419   _est_switch_depth = 0;
 420 #endif
 421 
 422   if (parse_method-&gt;has_reserved_stack_access()) {
 423     C-&gt;set_has_reserved_stack_access(true);
 424   }
 425 
 426   _tf = TypeFunc::make(method());
 427   _iter.reset_to_method(method());
 428   _flow = method()-&gt;get_flow_analysis();
 429   if (_flow-&gt;failing()) {
 430     C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 431   }
 432 
 433 #ifndef PRODUCT
 434   if (_flow-&gt;has_irreducible_entry()) {
 435     C-&gt;set_parsed_irreducible_loop(true);
 436   }
 437 #endif
 438 
 439   if (_expected_uses &lt;= 0) {
 440     _prof_factor = 1;
 441   } else {
 442     float prof_total = parse_method-&gt;interpreter_invocation_count();
 443     if (prof_total &lt;= _expected_uses) {
 444       _prof_factor = 1;
 445     } else {
 446       _prof_factor = _expected_uses / prof_total;
 447     }
 448   }
 449 
 450   CompileLog* log = C-&gt;log();
 451   if (log != NULL) {
 452     log-&gt;begin_head(&quot;parse method=&#39;%d&#39; uses=&#39;%f&#39;&quot;,
 453                     log-&gt;identify(parse_method), expected_uses);
 454     if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 455       log-&gt;print(&quot; osr_bci=&#39;%d&#39;&quot;, C-&gt;entry_bci());
 456     }
 457     log-&gt;stamp();
 458     log-&gt;end_head();
 459   }
 460 
 461   // Accumulate deoptimization counts.
 462   // (The range_check and store_check counts are checked elsewhere.)
 463   ciMethodData* md = method()-&gt;method_data();
 464   for (uint reason = 0; reason &lt; md-&gt;trap_reason_limit(); reason++) {
 465     uint md_count = md-&gt;trap_count(reason);
 466     if (md_count != 0) {
 467       if (md_count == md-&gt;trap_count_limit())
 468         md_count += md-&gt;overflow_trap_count();
 469       uint total_count = C-&gt;trap_count(reason);
 470       uint old_count   = total_count;
 471       total_count += md_count;
 472       // Saturate the add if it overflows.
 473       if (total_count &lt; old_count || total_count &lt; md_count)
 474         total_count = (uint)-1;
 475       C-&gt;set_trap_count(reason, total_count);
 476       if (log != NULL)
 477         log-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39; total=&#39;%d&#39;&quot;,
 478                   Deoptimization::trap_reason_name(reason),
 479                   md_count, total_count);
 480     }
 481   }
 482   // Accumulate total sum of decompilations, also.
 483   C-&gt;set_decompile_count(C-&gt;decompile_count() + md-&gt;decompile_count());
 484 
 485   _count_invocations = C-&gt;do_count_invocations();
 486   _method_data_update = C-&gt;do_method_data_update();
 487 
 488   if (log != NULL &amp;&amp; method()-&gt;has_exception_handlers()) {
 489     log-&gt;elem(&quot;observe that=&#39;has_exception_handlers&#39;&quot;);
 490   }
 491 
 492   assert(InlineTree::check_can_parse(method()) == NULL, &quot;Can not parse this method, cutout earlier&quot;);
 493   assert(method()-&gt;has_balanced_monitors(), &quot;Can not parse unbalanced monitors, cutout earlier&quot;);
 494 
 495   // Always register dependence if JVMTI is enabled, because
 496   // either breakpoint setting or hotswapping of methods may
 497   // cause deoptimization.
 498   if (C-&gt;env()-&gt;jvmti_can_hotswap_or_post_breakpoint()) {
 499     C-&gt;dependencies()-&gt;assert_evol_method(method());
 500   }
 501 
 502   NOT_PRODUCT(methods_seen++);
 503 
 504   // Do some special top-level things.
 505   if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 506     _entry_bci = C-&gt;entry_bci();
 507     _flow = method()-&gt;get_osr_flow_analysis(osr_bci());
 508     if (_flow-&gt;failing()) {
 509       C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 510 #ifndef PRODUCT
 511       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 512         tty-&gt;print_cr(&quot;OSR @%d type flow bailout: %s&quot;, _entry_bci, _flow-&gt;failure_reason());
 513         if (Verbose) {
 514           method()-&gt;print();
 515           method()-&gt;print_codes();
 516           _flow-&gt;print();
 517         }
 518       }
 519 #endif
 520     }
 521     _tf = C-&gt;tf();     // the OSR entry type is different
 522   }
 523 
 524 #ifdef ASSERT
 525   if (depth() == 1) {
 526     assert(C-&gt;is_osr_compilation() == this-&gt;is_osr_parse(), &quot;OSR in sync&quot;);
<a name="2" id="anc2"></a>



 527   } else {
 528     assert(!this-&gt;is_osr_parse(), &quot;no recursive OSR&quot;);
 529   }
 530 #endif
 531 
 532 #ifndef PRODUCT
 533   methods_parsed++;
 534   // add method size here to guarantee that inlined methods are added too
 535   if (CITime)
 536     _total_bytes_compiled += method()-&gt;code_size();
 537 
 538   show_parse_info();
 539 #endif
 540 
 541   if (failing()) {
 542     if (log)  log-&gt;done(&quot;parse&quot;);
 543     return;
 544   }
 545 
 546   gvn().set_type(root(), root()-&gt;bottom_type());
 547   gvn().transform(top());
 548 
 549   // Import the results of the ciTypeFlow.
 550   init_blocks();
 551 
 552   // Merge point for all normal exits
 553   build_exits();
 554 
 555   // Setup the initial JVM state map.
 556   SafePointNode* entry_map = create_entry_map();
 557 
 558   // Check for bailouts during map initialization
 559   if (failing() || entry_map == NULL) {
 560     if (log)  log-&gt;done(&quot;parse&quot;);
 561     return;
 562   }
 563 
 564   Node_Notes* caller_nn = C-&gt;default_node_notes();
 565   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
 566   if (DebugInlinedCalls || depth() == 1) {
 567     C-&gt;set_default_node_notes(make_node_notes(caller_nn));
 568   }
 569 
 570   if (is_osr_parse()) {
 571     Node* osr_buf = entry_map-&gt;in(TypeFunc::Parms+0);
 572     entry_map-&gt;set_req(TypeFunc::Parms+0, top());
 573     set_map(entry_map);
 574     load_interpreter_state(osr_buf);
 575   } else {
 576     set_map(entry_map);
 577     do_method_entry();
 578     if (depth() == 1 &amp;&amp; C-&gt;age_code()) {
 579       decrement_age();
 580     }
 581   }
 582 
 583   if (depth() == 1 &amp;&amp; !failing()) {
<a name="3" id="anc3"></a><span class="line-added"> 584     if (C-&gt;clinit_barrier_on_entry()) {</span>
<span class="line-added"> 585       // Add check to deoptimize the nmethod once the holder class is fully initialized</span>
<span class="line-added"> 586       clinit_deopt();</span>
<span class="line-added"> 587     }</span>
<span class="line-added"> 588 </span>
 589     // Add check to deoptimize the nmethod if RTM state was changed
 590     rtm_deopt();
 591   }
 592 
 593   // Check for bailouts during method entry or RTM state check setup.
 594   if (failing()) {
 595     if (log)  log-&gt;done(&quot;parse&quot;);
 596     C-&gt;set_default_node_notes(caller_nn);
 597     return;
 598   }
 599 
 600   entry_map = map();  // capture any changes performed by method setup code
 601   assert(jvms()-&gt;endoff() == map()-&gt;req(), &quot;map matches JVMS layout&quot;);
 602 
 603   // We begin parsing as if we have just encountered a jump to the
 604   // method entry.
 605   Block* entry_block = start_block();
 606   assert(entry_block-&gt;start() == (is_osr_parse() ? osr_bci() : 0), &quot;&quot;);
 607   set_map_clone(entry_map);
 608   merge_common(entry_block, entry_block-&gt;next_path_num());
 609 
 610 #ifndef PRODUCT
 611   BytecodeParseHistogram *parse_histogram_obj = new (C-&gt;env()-&gt;arena()) BytecodeParseHistogram(this, C);
 612   set_parse_histogram( parse_histogram_obj );
 613 #endif
 614 
 615   // Parse all the basic blocks.
 616   do_all_blocks();
 617 
 618   C-&gt;set_default_node_notes(caller_nn);
 619 
 620   // Check for bailouts during conversion to graph
 621   if (failing()) {
 622     if (log)  log-&gt;done(&quot;parse&quot;);
 623     return;
 624   }
 625 
 626   // Fix up all exiting control flow.
 627   set_map(entry_map);
 628   do_exits();
 629 
 630   if (log)  log-&gt;done(&quot;parse nodes=&#39;%d&#39; live=&#39;%d&#39; memory=&#39;&quot; SIZE_FORMAT &quot;&#39;&quot;,
 631                       C-&gt;unique(), C-&gt;live_nodes(), C-&gt;node_arena()-&gt;used());
 632 }
 633 
 634 //---------------------------do_all_blocks-------------------------------------
 635 void Parse::do_all_blocks() {
 636   bool has_irreducible = flow()-&gt;has_irreducible_entry();
 637 
 638   // Walk over all blocks in Reverse Post-Order.
 639   while (true) {
 640     bool progress = false;
 641     for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 642       Block* block = rpo_at(rpo);
 643 
 644       if (block-&gt;is_parsed()) continue;
 645 
 646       if (!block-&gt;is_merged()) {
 647         // Dead block, no state reaches this block
 648         continue;
 649       }
 650 
 651       // Prepare to parse this block.
 652       load_state_from(block);
 653 
 654       if (stopped()) {
 655         // Block is dead.
 656         continue;
 657       }
 658 
 659       NOT_PRODUCT(blocks_parsed++);
 660 
 661       progress = true;
 662       if (block-&gt;is_loop_head() || block-&gt;is_handler() || (has_irreducible &amp;&amp; !block-&gt;is_ready())) {
 663         // Not all preds have been parsed.  We must build phis everywhere.
 664         // (Note that dead locals do not get phis built, ever.)
 665         ensure_phis_everywhere();
 666 
 667         if (block-&gt;is_SEL_head()) {
 668           // Add predicate to single entry (not irreducible) loop head.
 669           assert(!block-&gt;has_merged_backedge(), &quot;only entry paths should be merged for now&quot;);
 670           // Predicates may have been added after a dominating if
 671           if (!block-&gt;has_predicates()) {
 672             // Need correct bci for predicate.
 673             // It is fine to set it here since do_one_block() will set it anyway.
 674             set_parse_bci(block-&gt;start());
 675             add_predicate();
 676           }
 677           // Add new region for back branches.
 678           int edges = block-&gt;pred_count() - block-&gt;preds_parsed() + 1; // +1 for original region
 679           RegionNode *r = new RegionNode(edges+1);
 680           _gvn.set_type(r, Type::CONTROL);
 681           record_for_igvn(r);
 682           r-&gt;init_req(edges, control());
 683           set_control(r);
 684           // Add new phis.
 685           ensure_phis_everywhere();
 686         }
 687 
 688         // Leave behind an undisturbed copy of the map, for future merges.
 689         set_map(clone_map());
 690       }
 691 
 692       if (control()-&gt;is_Region() &amp;&amp; !block-&gt;is_loop_head() &amp;&amp; !has_irreducible &amp;&amp; !block-&gt;is_handler()) {
 693         // In the absence of irreducible loops, the Region and Phis
 694         // associated with a merge that doesn&#39;t involve a backedge can
 695         // be simplified now since the RPO parsing order guarantees
 696         // that any path which was supposed to reach here has already
 697         // been parsed or must be dead.
 698         Node* c = control();
 699         Node* result = _gvn.transform_no_reclaim(control());
 700         if (c != result &amp;&amp; TraceOptoParse) {
 701           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block-&gt;rpo(), c-&gt;_idx, result-&gt;_idx);
 702         }
 703         if (result != top()) {
 704           record_for_igvn(result);
 705         }
 706       }
 707 
 708       // Parse the block.
 709       do_one_block();
 710 
 711       // Check for bailouts.
 712       if (failing())  return;
 713     }
 714 
 715     // with irreducible loops multiple passes might be necessary to parse everything
 716     if (!has_irreducible || !progress) {
 717       break;
 718     }
 719   }
 720 
 721 #ifndef PRODUCT
 722   blocks_seen += block_count();
 723 
 724   // Make sure there are no half-processed blocks remaining.
 725   // Every remaining unprocessed block is dead and may be ignored now.
 726   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 727     Block* block = rpo_at(rpo);
 728     if (!block-&gt;is_parsed()) {
 729       if (TraceOptoParse) {
 730         tty-&gt;print_cr(&quot;Skipped dead block %d at bci:%d&quot;, rpo, block-&gt;start());
 731       }
 732       assert(!block-&gt;is_merged(), &quot;no half-processed blocks&quot;);
 733     }
 734   }
 735 #endif
 736 }
 737 
 738 static Node* mask_int_value(Node* v, BasicType bt, PhaseGVN* gvn) {
 739   switch (bt) {
 740   case T_BYTE:
 741     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(24)));
 742     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(24)));
 743     break;
 744   case T_SHORT:
 745     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(16)));
 746     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(16)));
 747     break;
 748   case T_CHAR:
 749     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0xFFFF)));
 750     break;
 751   case T_BOOLEAN:
 752     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0x1)));
 753     break;
 754   default:
 755     break;
 756   }
 757   return v;
 758 }
 759 
 760 //-------------------------------build_exits----------------------------------
 761 // Build normal and exceptional exit merge points.
 762 void Parse::build_exits() {
 763   // make a clone of caller to prevent sharing of side-effects
 764   _exits.set_map(_exits.clone_map());
 765   _exits.clean_stack(_exits.sp());
 766   _exits.sync_jvms();
 767 
 768   RegionNode* region = new RegionNode(1);
 769   record_for_igvn(region);
 770   gvn().set_type_bottom(region);
 771   _exits.set_control(region);
 772 
 773   // Note:  iophi and memphi are not transformed until do_exits.
 774   Node* iophi  = new PhiNode(region, Type::ABIO);
 775   Node* memphi = new PhiNode(region, Type::MEMORY, TypePtr::BOTTOM);
 776   gvn().set_type_bottom(iophi);
 777   gvn().set_type_bottom(memphi);
 778   _exits.set_i_o(iophi);
 779   _exits.set_all_memory(memphi);
 780 
 781   // Add a return value to the exit state.  (Do not push it yet.)
 782   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {
 783     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);
 784     if (ret_type-&gt;isa_int()) {
 785       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
 786       if (ret_bt == T_BOOLEAN ||
 787           ret_bt == T_CHAR ||
 788           ret_bt == T_BYTE ||
 789           ret_bt == T_SHORT) {
 790         ret_type = TypeInt::INT;
 791       }
 792     }
 793 
 794     // Don&#39;t &quot;bind&quot; an unloaded return klass to the ret_phi. If the klass
 795     // becomes loaded during the subsequent parsing, the loaded and unloaded
 796     // types will not join when we transform and push in do_exits().
 797     const TypeOopPtr* ret_oop_type = ret_type-&gt;isa_oopptr();
 798     if (ret_oop_type &amp;&amp; !ret_oop_type-&gt;klass()-&gt;is_loaded()) {
 799       ret_type = TypeOopPtr::BOTTOM;
 800     }
 801     int         ret_size = type2size[ret_type-&gt;basic_type()];
 802     Node*       ret_phi  = new PhiNode(region, ret_type);
 803     gvn().set_type_bottom(ret_phi);
 804     _exits.ensure_stack(ret_size);
 805     assert((int)(tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms) == ret_size, &quot;good tf range&quot;);
 806     assert(method()-&gt;return_type()-&gt;size() == ret_size, &quot;tf agrees w/ method&quot;);
 807     _exits.set_argument(0, ret_phi);  // here is where the parser finds it
 808     // Note:  ret_phi is not yet pushed, until do_exits.
 809   }
 810 }
 811 
 812 
 813 //----------------------------build_start_state-------------------------------
 814 // Construct a state which contains only the incoming arguments from an
 815 // unknown caller.  The method &amp; bci will be NULL &amp; InvocationEntryBci.
 816 JVMState* Compile::build_start_state(StartNode* start, const TypeFunc* tf) {
 817   int        arg_size = tf-&gt;domain()-&gt;cnt();
 818   int        max_size = MAX2(arg_size, (int)tf-&gt;range()-&gt;cnt());
 819   JVMState*  jvms     = new (this) JVMState(max_size - TypeFunc::Parms);
 820   SafePointNode* map  = new SafePointNode(max_size, NULL);
 821   record_for_igvn(map);
 822   assert(arg_size == TypeFunc::Parms + (is_osr_compilation() ? 1 : method()-&gt;arg_size()), &quot;correct arg_size&quot;);
 823   Node_Notes* old_nn = default_node_notes();
 824   if (old_nn != NULL &amp;&amp; has_method()) {
 825     Node_Notes* entry_nn = old_nn-&gt;clone(this);
 826     JVMState* entry_jvms = new(this) JVMState(method(), old_nn-&gt;jvms());
 827     entry_jvms-&gt;set_offsets(0);
 828     entry_jvms-&gt;set_bci(entry_bci());
 829     entry_nn-&gt;set_jvms(entry_jvms);
 830     set_default_node_notes(entry_nn);
 831   }
 832   uint i;
 833   for (i = 0; i &lt; (uint)arg_size; i++) {
 834     Node* parm = initial_gvn()-&gt;transform(new ParmNode(start, i));
 835     map-&gt;init_req(i, parm);
 836     // Record all these guys for later GVN.
 837     record_for_igvn(parm);
 838   }
 839   for (; i &lt; map-&gt;req(); i++) {
 840     map-&gt;init_req(i, top());
 841   }
 842   assert(jvms-&gt;argoff() == TypeFunc::Parms, &quot;parser gets arguments here&quot;);
 843   set_default_node_notes(old_nn);
 844   map-&gt;set_jvms(jvms);
 845   jvms-&gt;set_map(map);
 846   return jvms;
 847 }
 848 
 849 //-----------------------------make_node_notes---------------------------------
 850 Node_Notes* Parse::make_node_notes(Node_Notes* caller_nn) {
 851   if (caller_nn == NULL)  return NULL;
 852   Node_Notes* nn = caller_nn-&gt;clone(C);
 853   JVMState* caller_jvms = nn-&gt;jvms();
 854   JVMState* jvms = new (C) JVMState(method(), caller_jvms);
 855   jvms-&gt;set_offsets(0);
 856   jvms-&gt;set_bci(_entry_bci);
 857   nn-&gt;set_jvms(jvms);
 858   return nn;
 859 }
 860 
 861 
 862 //--------------------------return_values--------------------------------------
 863 void Compile::return_values(JVMState* jvms) {
 864   GraphKit kit(jvms);
 865   Node* ret = new ReturnNode(TypeFunc::Parms,
 866                              kit.control(),
 867                              kit.i_o(),
 868                              kit.reset_memory(),
 869                              kit.frameptr(),
 870                              kit.returnadr());
 871   // Add zero or 1 return values
 872   int ret_size = tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms;
 873   if (ret_size &gt; 0) {
 874     kit.inc_sp(-ret_size);  // pop the return value(s)
 875     kit.sync_jvms();
 876     ret-&gt;add_req(kit.argument(0));
 877     // Note:  The second dummy edge is not needed by a ReturnNode.
 878   }
 879   // bind it to root
 880   root()-&gt;add_req(ret);
 881   record_for_igvn(ret);
 882   initial_gvn()-&gt;transform_no_reclaim(ret);
 883 }
 884 
 885 //------------------------rethrow_exceptions-----------------------------------
 886 // Bind all exception states in the list into a single RethrowNode.
 887 void Compile::rethrow_exceptions(JVMState* jvms) {
 888   GraphKit kit(jvms);
 889   if (!kit.has_exceptions())  return;  // nothing to generate
 890   // Load my combined exception state into the kit, with all phis transformed:
 891   SafePointNode* ex_map = kit.combine_and_pop_all_exception_states();
 892   Node* ex_oop = kit.use_exception_state(ex_map);
 893   RethrowNode* exit = new RethrowNode(kit.control(),
 894                                       kit.i_o(), kit.reset_memory(),
 895                                       kit.frameptr(), kit.returnadr(),
 896                                       // like a return but with exception input
 897                                       ex_oop);
 898   // bind to root
 899   root()-&gt;add_req(exit);
 900   record_for_igvn(exit);
 901   initial_gvn()-&gt;transform_no_reclaim(exit);
 902 }
 903 
 904 //---------------------------do_exceptions-------------------------------------
 905 // Process exceptions arising from the current bytecode.
 906 // Send caught exceptions to the proper handler within this method.
 907 // Unhandled exceptions feed into _exit.
 908 void Parse::do_exceptions() {
 909   if (!has_exceptions())  return;
 910 
 911   if (failing()) {
 912     // Pop them all off and throw them away.
 913     while (pop_exception_state() != NULL) ;
 914     return;
 915   }
 916 
 917   PreserveJVMState pjvms(this, false);
 918 
 919   SafePointNode* ex_map;
 920   while ((ex_map = pop_exception_state()) != NULL) {
 921     if (!method()-&gt;has_exception_handlers()) {
 922       // Common case:  Transfer control outward.
 923       // Doing it this early allows the exceptions to common up
 924       // even between adjacent method calls.
 925       throw_to_exit(ex_map);
 926     } else {
 927       // Have to look at the exception first.
 928       assert(stopped(), &quot;catch_inline_exceptions trashes the map&quot;);
 929       catch_inline_exceptions(ex_map);
 930       stop_and_kill_map();      // we used up this exception state; kill it
 931     }
 932   }
 933 
 934   // We now return to our regularly scheduled program:
 935 }
 936 
 937 //---------------------------throw_to_exit-------------------------------------
 938 // Merge the given map into an exception exit from this method.
 939 // The exception exit will handle any unlocking of receiver.
 940 // The ex_oop must be saved within the ex_map, unlike merge_exception.
 941 void Parse::throw_to_exit(SafePointNode* ex_map) {
 942   // Pop the JVMS to (a copy of) the caller.
 943   GraphKit caller;
 944   caller.set_map_clone(_caller-&gt;map());
 945   caller.set_bci(_caller-&gt;bci());
 946   caller.set_sp(_caller-&gt;sp());
 947   // Copy out the standard machine state:
 948   for (uint i = 0; i &lt; TypeFunc::Parms; i++) {
 949     caller.map()-&gt;set_req(i, ex_map-&gt;in(i));
 950   }
 951   if (ex_map-&gt;has_replaced_nodes()) {
 952     _replaced_nodes_for_exceptions = true;
 953   }
 954   caller.map()-&gt;transfer_replaced_nodes_from(ex_map, _new_idx);
 955   // ...and the exception:
 956   Node*          ex_oop        = saved_ex_oop(ex_map);
 957   SafePointNode* caller_ex_map = caller.make_exception_state(ex_oop);
 958   // Finally, collect the new exception state in my exits:
 959   _exits.add_exception_state(caller_ex_map);
 960 }
 961 
 962 //------------------------------do_exits---------------------------------------
 963 void Parse::do_exits() {
 964   set_parse_bci(InvocationEntryBci);
 965 
 966   // Now peephole on the return bits
 967   Node* region = _exits.control();
 968   _exits.set_control(gvn().transform(region));
 969 
 970   Node* iophi = _exits.i_o();
 971   _exits.set_i_o(gvn().transform(iophi));
 972 
 973   // Figure out if we need to emit the trailing barrier. The barrier is only
 974   // needed in the constructors, and only in three cases:
 975   //
 976   // 1. The constructor wrote a final. The effects of all initializations
 977   //    must be committed to memory before any code after the constructor
 978   //    publishes the reference to the newly constructed object. Rather
 979   //    than wait for the publication, we simply block the writes here.
 980   //    Rather than put a barrier on only those writes which are required
 981   //    to complete, we force all writes to complete.
 982   //
<a name="4" id="anc4"></a><span class="line-modified"> 983   // 2. Experimental VM option is used to force the barrier if any field</span>







 984   //    was written out in the constructor.
 985   //
<a name="5" id="anc5"></a><span class="line-added"> 986   // 3. On processors which are not CPU_MULTI_COPY_ATOMIC (e.g. PPC64),</span>
<span class="line-added"> 987   //    support_IRIW_for_not_multiple_copy_atomic_cpu selects that</span>
<span class="line-added"> 988   //    MemBarVolatile is used before volatile load instead of after volatile</span>
<span class="line-added"> 989   //    store, so there&#39;s no barrier after the store.</span>
<span class="line-added"> 990   //    We want to guarantee the same behavior as on platforms with total store</span>
<span class="line-added"> 991   //    order, although this is not required by the Java memory model.</span>
<span class="line-added"> 992   //    In this case, we want to enforce visibility of volatile field</span>
<span class="line-added"> 993   //    initializations which are performed in constructors.</span>
<span class="line-added"> 994   //    So as with finals, we add a barrier here.</span>
<span class="line-added"> 995   //</span>
 996   // &quot;All bets are off&quot; unless the first publication occurs after a
 997   // normal return from the constructor.  We do not attempt to detect
 998   // such unusual early publications.  But no barrier is needed on
 999   // exceptional returns, since they cannot publish normally.
1000   //
1001   if (method()-&gt;is_initializer() &amp;&amp;
<a name="6" id="anc6"></a><span class="line-modified">1002        (wrote_final() ||</span>
<span class="line-modified">1003          (AlwaysSafeConstructors &amp;&amp; wrote_fields()) ||</span>
<span class="line-modified">1004          (support_IRIW_for_not_multiple_copy_atomic_cpu &amp;&amp; wrote_volatile()))) {</span>
1005     _exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());
1006 
1007     // If Memory barrier is created for final fields write
1008     // and allocation node does not escape the initialize method,
1009     // then barrier introduced by allocation node can be removed.
1010     if (DoEscapeAnalysis &amp;&amp; alloc_with_final()) {
1011       AllocateNode *alloc = AllocateNode::Ideal_allocation(alloc_with_final(), &amp;_gvn);
1012       alloc-&gt;compute_MemBar_redundancy(method());
1013     }
1014     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1015       method()-&gt;print_name();
1016       tty-&gt;print_cr(&quot; writes finals and needs a memory barrier&quot;);
1017     }
1018   }
1019 
1020   // Any method can write a @Stable field; insert memory barriers
1021   // after those also. Can&#39;t bind predecessor allocation node (if any)
1022   // with barrier because allocation doesn&#39;t always dominate
1023   // MemBarRelease.
1024   if (wrote_stable()) {
1025     _exits.insert_mem_bar(Op_MemBarRelease);
1026     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1027       method()-&gt;print_name();
1028       tty-&gt;print_cr(&quot; writes @Stable and needs a memory barrier&quot;);
1029     }
1030   }
1031 
1032   for (MergeMemStream mms(_exits.merged_memory()); mms.next_non_empty(); ) {
1033     // transform each slice of the original memphi:
1034     mms.set_memory(_gvn.transform(mms.memory()));
1035   }
<a name="7" id="anc7"></a><span class="line-added">1036   // Clean up input MergeMems created by transforming the slices</span>
<span class="line-added">1037   _gvn.transform(_exits.merged_memory());</span>
1038 
1039   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {
1040     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);
1041     Node*       ret_phi  = _gvn.transform( _exits.argument(0) );
1042     if (!_exits.control()-&gt;is_top() &amp;&amp; _gvn.type(ret_phi)-&gt;empty()) {
<a name="8" id="anc8"></a><span class="line-modified">1043       // If the type we set for the ret_phi in build_exits() is too optimistic and</span>
<span class="line-modified">1044       // the ret_phi is top now, there&#39;s an extremely small chance that it may be due to class</span>
<span class="line-modified">1045       // loading.  It could also be due to an error, so mark this method as not compilable because</span>
<span class="line-modified">1046       // otherwise this could lead to an infinite compile loop.</span>
<span class="line-modified">1047       // In any case, this code path is rarely (and never in my testing) reached.</span>
<span class="line-modified">1048       C-&gt;record_method_not_compilable(&quot;Can&#39;t determine return type.&quot;);</span>







1049       return;
1050     }
1051     if (ret_type-&gt;isa_int()) {
1052       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
1053       ret_phi = mask_int_value(ret_phi, ret_bt, &amp;_gvn);
1054     }
1055     _exits.push_node(ret_type-&gt;basic_type(), ret_phi);
1056   }
1057 
1058   // Note:  Logic for creating and optimizing the ReturnNode is in Compile.
1059 
1060   // Unlock along the exceptional paths.
1061   // This is done late so that we can common up equivalent exceptions
1062   // (e.g., null checks) arising from multiple points within this method.
1063   // See GraphKit::add_exception_state, which performs the commoning.
1064   bool do_synch = method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode;
1065 
1066   // record exit from a method if compiled while Dtrace is turned on.
1067   if (do_synch || C-&gt;env()-&gt;dtrace_method_probes() || _replaced_nodes_for_exceptions) {
1068     // First move the exception list out of _exits:
1069     GraphKit kit(_exits.transfer_exceptions_into_jvms());
1070     SafePointNode* normal_map = kit.map();  // keep this guy safe
1071     // Now re-collect the exceptions into _exits:
1072     SafePointNode* ex_map;
1073     while ((ex_map = kit.pop_exception_state()) != NULL) {
1074       Node* ex_oop = kit.use_exception_state(ex_map);
1075       // Force the exiting JVM state to have this method at InvocationEntryBci.
1076       // The exiting JVM state is otherwise a copy of the calling JVMS.
1077       JVMState* caller = kit.jvms();
1078       JVMState* ex_jvms = caller-&gt;clone_shallow(C);
1079       ex_jvms-&gt;set_map(kit.clone_map());
1080       ex_jvms-&gt;map()-&gt;set_jvms(ex_jvms);
1081       ex_jvms-&gt;set_bci(   InvocationEntryBci);
1082       kit.set_jvms(ex_jvms);
1083       if (do_synch) {
1084         // Add on the synchronized-method box/object combo
1085         kit.map()-&gt;push_monitor(_synch_lock);
1086         // Unlock!
1087         kit.shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
1088       }
1089       if (C-&gt;env()-&gt;dtrace_method_probes()) {
1090         kit.make_dtrace_method_exit(method());
1091       }
1092       if (_replaced_nodes_for_exceptions) {
1093         kit.map()-&gt;apply_replaced_nodes(_new_idx);
1094       }
1095       // Done with exception-path processing.
1096       ex_map = kit.make_exception_state(ex_oop);
1097       assert(ex_jvms-&gt;same_calls_as(ex_map-&gt;jvms()), &quot;sanity&quot;);
1098       // Pop the last vestige of this method:
1099       ex_map-&gt;set_jvms(caller-&gt;clone_shallow(C));
1100       ex_map-&gt;jvms()-&gt;set_map(ex_map);
1101       _exits.push_exception_state(ex_map);
1102     }
1103     assert(_exits.map() == normal_map, &quot;keep the same return state&quot;);
1104   }
1105 
1106   {
1107     // Capture very early exceptions (receiver null checks) from caller JVMS
1108     GraphKit caller(_caller);
1109     SafePointNode* ex_map;
1110     while ((ex_map = caller.pop_exception_state()) != NULL) {
1111       _exits.add_exception_state(ex_map);
1112     }
1113   }
1114   _exits.map()-&gt;apply_replaced_nodes(_new_idx);
1115 }
1116 
1117 //-----------------------------create_entry_map-------------------------------
1118 // Initialize our parser map to contain the types at method entry.
1119 // For OSR, the map contains a single RawPtr parameter.
1120 // Initial monitor locking for sync. methods is performed by do_method_entry.
1121 SafePointNode* Parse::create_entry_map() {
1122   // Check for really stupid bail-out cases.
1123   uint len = TypeFunc::Parms + method()-&gt;max_locals() + method()-&gt;max_stack();
1124   if (len &gt;= 32760) {
1125     C-&gt;record_method_not_compilable(&quot;too many local variables&quot;);
1126     return NULL;
1127   }
1128 
1129   // clear current replaced nodes that are of no use from here on (map was cloned in build_exits).
1130   _caller-&gt;map()-&gt;delete_replaced_nodes();
1131 
1132   // If this is an inlined method, we may have to do a receiver null check.
1133   if (_caller-&gt;has_method() &amp;&amp; is_normal_parse() &amp;&amp; !method()-&gt;is_static()) {
1134     GraphKit kit(_caller);
1135     kit.null_check_receiver_before_call(method());
1136     _caller = kit.transfer_exceptions_into_jvms();
1137     if (kit.stopped()) {
1138       _exits.add_exception_states_from(_caller);
1139       _exits.set_jvms(_caller);
1140       return NULL;
1141     }
1142   }
1143 
1144   assert(method() != NULL, &quot;parser must have a method&quot;);
1145 
1146   // Create an initial safepoint to hold JVM state during parsing
1147   JVMState* jvms = new (C) JVMState(method(), _caller-&gt;has_method() ? _caller : NULL);
1148   set_map(new SafePointNode(len, jvms));
1149   jvms-&gt;set_map(map());
1150   record_for_igvn(map());
1151   assert(jvms-&gt;endoff() == len, &quot;correct jvms sizing&quot;);
1152 
1153   SafePointNode* inmap = _caller-&gt;map();
1154   assert(inmap != NULL, &quot;must have inmap&quot;);
1155   // In case of null check on receiver above
1156   map()-&gt;transfer_replaced_nodes_from(inmap, _new_idx);
1157 
1158   uint i;
1159 
1160   // Pass thru the predefined input parameters.
1161   for (i = 0; i &lt; TypeFunc::Parms; i++) {
1162     map()-&gt;init_req(i, inmap-&gt;in(i));
1163   }
1164 
1165   if (depth() == 1) {
1166     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
1167     // Insert the memory aliasing node
1168     set_all_memory(reset_memory());
1169   }
1170   assert(merged_memory(), &quot;&quot;);
1171 
1172   // Now add the locals which are initially bound to arguments:
1173   uint arg_size = tf()-&gt;domain()-&gt;cnt();
1174   ensure_stack(arg_size - TypeFunc::Parms);  // OSR methods have funny args
1175   for (i = TypeFunc::Parms; i &lt; arg_size; i++) {
1176     map()-&gt;init_req(i, inmap-&gt;argument(_caller, i - TypeFunc::Parms));
1177   }
1178 
1179   // Clear out the rest of the map (locals and stack)
1180   for (i = arg_size; i &lt; len; i++) {
1181     map()-&gt;init_req(i, top());
1182   }
1183 
1184   SafePointNode* entry_map = stop();
1185   return entry_map;
1186 }
1187 
1188 //-----------------------------do_method_entry--------------------------------
1189 // Emit any code needed in the pseudo-block before BCI zero.
1190 // The main thing to do is lock the receiver of a synchronized method.
1191 void Parse::do_method_entry() {
1192   set_parse_bci(InvocationEntryBci); // Pseudo-BCP
<a name="9" id="anc9"></a><span class="line-modified">1193   set_sp(0);                         // Java Stack Pointer</span>
1194 
1195   NOT_PRODUCT( count_compiled_calls(true/*at_method_entry*/, false/*is_inline*/); )
1196 
1197   if (C-&gt;env()-&gt;dtrace_method_probes()) {
1198     make_dtrace_method_entry(method());
1199   }
1200 
1201   // If the method is synchronized, we need to construct a lock node, attach
1202   // it to the Start node, and pin it there.
1203   if (method()-&gt;is_synchronized()) {
1204     // Insert a FastLockNode right after the Start which takes as arguments
1205     // the current thread pointer, the &quot;this&quot; pointer &amp; the address of the
1206     // stack slot pair used for the lock.  The &quot;this&quot; pointer is a projection
1207     // off the start node, but the locking spot has to be constructed by
1208     // creating a ConLNode of 0, and boxing it with a BoxLockNode.  The BoxLockNode
1209     // becomes the second argument to the FastLockNode call.  The
1210     // FastLockNode becomes the new control parent to pin it to the start.
1211 
1212     // Setup Object Pointer
1213     Node *lock_obj = NULL;
1214     if(method()-&gt;is_static()) {
1215       ciInstance* mirror = _method-&gt;holder()-&gt;java_mirror();
1216       const TypeInstPtr *t_lock = TypeInstPtr::make(mirror);
1217       lock_obj = makecon(t_lock);
1218     } else {                  // Else pass the &quot;this&quot; pointer,
1219       lock_obj = local(0);    // which is Parm0 from StartNode
1220     }
1221     // Clear out dead values from the debug info.
1222     kill_dead_locals();
1223     // Build the FastLockNode
1224     _synch_lock = shared_lock(lock_obj);
1225   }
1226 
1227   // Feed profiling data for parameters to the type system so it can
1228   // propagate it as speculative types
1229   record_profiled_parameters_for_speculation();
1230 
1231   if (depth() == 1) {
1232     increment_and_test_invocation_counter(Tier2CompileThreshold);
1233   }
1234 }
1235 
1236 //------------------------------init_blocks------------------------------------
1237 // Initialize our parser map to contain the types/monitors at method entry.
1238 void Parse::init_blocks() {
1239   // Create the blocks.
1240   _block_count = flow()-&gt;block_count();
1241   _blocks = NEW_RESOURCE_ARRAY(Block, _block_count);
1242 
1243   // Initialize the structs.
1244   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1245     Block* block = rpo_at(rpo);
1246     new(block) Block(this, rpo);
1247   }
1248 
1249   // Collect predecessor and successor information.
1250   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1251     Block* block = rpo_at(rpo);
1252     block-&gt;init_graph(this);
1253   }
1254 }
1255 
1256 //-------------------------------init_node-------------------------------------
1257 Parse::Block::Block(Parse* outer, int rpo) : _live_locals() {
1258   _flow = outer-&gt;flow()-&gt;rpo_at(rpo);
1259   _pred_count = 0;
1260   _preds_parsed = 0;
1261   _count = 0;
1262   _is_parsed = false;
1263   _is_handler = false;
1264   _has_merged_backedge = false;
1265   _start_map = NULL;
1266   _has_predicates = false;
1267   _num_successors = 0;
1268   _all_successors = 0;
1269   _successors = NULL;
1270   assert(pred_count() == 0 &amp;&amp; preds_parsed() == 0, &quot;sanity&quot;);
1271   assert(!(is_merged() || is_parsed() || is_handler() || has_merged_backedge()), &quot;sanity&quot;);
1272   assert(_live_locals.size() == 0, &quot;sanity&quot;);
1273 
1274   // entry point has additional predecessor
1275   if (flow()-&gt;is_start())  _pred_count++;
1276   assert(flow()-&gt;is_start() == (this == outer-&gt;start_block()), &quot;&quot;);
1277 }
1278 
1279 //-------------------------------init_graph------------------------------------
1280 void Parse::Block::init_graph(Parse* outer) {
1281   // Create the successor list for this parser block.
1282   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfs = flow()-&gt;successors();
1283   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfe = flow()-&gt;exceptions();
1284   int ns = tfs-&gt;length();
1285   int ne = tfe-&gt;length();
1286   _num_successors = ns;
1287   _all_successors = ns+ne;
1288   _successors = (ns+ne == 0) ? NULL : NEW_RESOURCE_ARRAY(Block*, ns+ne);
1289   int p = 0;
1290   for (int i = 0; i &lt; ns+ne; i++) {
1291     ciTypeFlow::Block* tf2 = (i &lt; ns) ? tfs-&gt;at(i) : tfe-&gt;at(i-ns);
1292     Block* block2 = outer-&gt;rpo_at(tf2-&gt;rpo());
1293     _successors[i] = block2;
1294 
1295     // Accumulate pred info for the other block, too.
1296     if (i &lt; ns) {
1297       block2-&gt;_pred_count++;
1298     } else {
1299       block2-&gt;_is_handler = true;
1300     }
1301 
1302     #ifdef ASSERT
1303     // A block&#39;s successors must be distinguishable by BCI.
1304     // That is, no bytecode is allowed to branch to two different
1305     // clones of the same code location.
1306     for (int j = 0; j &lt; i; j++) {
1307       Block* block1 = _successors[j];
1308       if (block1 == block2)  continue;  // duplicates are OK
1309       assert(block1-&gt;start() != block2-&gt;start(), &quot;successors have unique bcis&quot;);
1310     }
1311     #endif
1312   }
1313 
1314   // Note: We never call next_path_num along exception paths, so they
1315   // never get processed as &quot;ready&quot;.  Also, the input phis of exception
1316   // handlers get specially processed, so that
1317 }
1318 
1319 //---------------------------successor_for_bci---------------------------------
1320 Parse::Block* Parse::Block::successor_for_bci(int bci) {
1321   for (int i = 0; i &lt; all_successors(); i++) {
1322     Block* block2 = successor_at(i);
1323     if (block2-&gt;start() == bci)  return block2;
1324   }
1325   // We can actually reach here if ciTypeFlow traps out a block
1326   // due to an unloaded class, and concurrently with compilation the
1327   // class is then loaded, so that a later phase of the parser is
1328   // able to see more of the bytecode CFG.  Or, the flow pass and
1329   // the parser can have a minor difference of opinion about executability
1330   // of bytecodes.  For example, &quot;obj.field = null&quot; is executable even
1331   // if the field&#39;s type is an unloaded class; the flow pass used to
1332   // make a trap for such code.
1333   return NULL;
1334 }
1335 
1336 
1337 //-----------------------------stack_type_at-----------------------------------
1338 const Type* Parse::Block::stack_type_at(int i) const {
1339   return get_type(flow()-&gt;stack_type_at(i));
1340 }
1341 
1342 
1343 //-----------------------------local_type_at-----------------------------------
1344 const Type* Parse::Block::local_type_at(int i) const {
1345   // Make dead locals fall to bottom.
1346   if (_live_locals.size() == 0) {
1347     MethodLivenessResult live_locals = flow()-&gt;outer()-&gt;method()-&gt;liveness_at_bci(start());
1348     // This bitmap can be zero length if we saw a breakpoint.
1349     // In such cases, pretend they are all live.
1350     ((Block*)this)-&gt;_live_locals = live_locals;
1351   }
1352   if (_live_locals.size() &gt; 0 &amp;&amp; !_live_locals.at(i))
1353     return Type::BOTTOM;
1354 
1355   return get_type(flow()-&gt;local_type_at(i));
1356 }
1357 
1358 
1359 #ifndef PRODUCT
1360 
1361 //----------------------------name_for_bc--------------------------------------
1362 // helper method for BytecodeParseHistogram
1363 static const char* name_for_bc(int i) {
1364   return Bytecodes::is_defined(i) ? Bytecodes::name(Bytecodes::cast(i)) : &quot;xxxunusedxxx&quot;;
1365 }
1366 
1367 //----------------------------BytecodeParseHistogram------------------------------------
1368 Parse::BytecodeParseHistogram::BytecodeParseHistogram(Parse *p, Compile *c) {
1369   _parser   = p;
1370   _compiler = c;
1371   if( ! _initialized ) { _initialized = true; reset(); }
1372 }
1373 
1374 //----------------------------current_count------------------------------------
1375 int Parse::BytecodeParseHistogram::current_count(BPHType bph_type) {
1376   switch( bph_type ) {
1377   case BPH_transforms: { return _parser-&gt;gvn().made_progress(); }
1378   case BPH_values:     { return _parser-&gt;gvn().made_new_values(); }
1379   default: { ShouldNotReachHere(); return 0; }
1380   }
1381 }
1382 
1383 //----------------------------initialized--------------------------------------
1384 bool Parse::BytecodeParseHistogram::initialized() { return _initialized; }
1385 
1386 //----------------------------reset--------------------------------------------
1387 void Parse::BytecodeParseHistogram::reset() {
1388   int i = Bytecodes::number_of_codes;
1389   while (i-- &gt; 0) { _bytecodes_parsed[i] = 0; _nodes_constructed[i] = 0; _nodes_transformed[i] = 0; _new_values[i] = 0; }
1390 }
1391 
1392 //----------------------------set_initial_state--------------------------------
1393 // Record info when starting to parse one bytecode
1394 void Parse::BytecodeParseHistogram::set_initial_state( Bytecodes::Code bc ) {
1395   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1396     _initial_bytecode    = bc;
1397     _initial_node_count  = _compiler-&gt;unique();
1398     _initial_transforms  = current_count(BPH_transforms);
1399     _initial_values      = current_count(BPH_values);
1400   }
1401 }
1402 
1403 //----------------------------record_change--------------------------------
1404 // Record results of parsing one bytecode
1405 void Parse::BytecodeParseHistogram::record_change() {
1406   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1407     ++_bytecodes_parsed[_initial_bytecode];
1408     _nodes_constructed [_initial_bytecode] += (_compiler-&gt;unique() - _initial_node_count);
1409     _nodes_transformed [_initial_bytecode] += (current_count(BPH_transforms) - _initial_transforms);
1410     _new_values        [_initial_bytecode] += (current_count(BPH_values)     - _initial_values);
1411   }
1412 }
1413 
1414 
1415 //----------------------------print--------------------------------------------
1416 void Parse::BytecodeParseHistogram::print(float cutoff) {
1417   ResourceMark rm;
1418   // print profile
1419   int total  = 0;
1420   int i      = 0;
1421   for( i = 0; i &lt; Bytecodes::number_of_codes; ++i ) { total += _bytecodes_parsed[i]; }
1422   int abs_sum = 0;
1423   tty-&gt;cr();   //0123456789012345678901234567890123456789012345678901234567890123456789
1424   tty-&gt;print_cr(&quot;Histogram of %d parsed bytecodes:&quot;, total);
1425   if( total == 0 ) { return; }
1426   tty-&gt;cr();
1427   tty-&gt;print_cr(&quot;absolute:  count of compiled bytecodes of this type&quot;);
1428   tty-&gt;print_cr(&quot;relative:  percentage contribution to compiled nodes&quot;);
1429   tty-&gt;print_cr(&quot;nodes   :  Average number of nodes constructed per bytecode&quot;);
1430   tty-&gt;print_cr(&quot;rnodes  :  Significance towards total nodes constructed, (nodes*relative)&quot;);
1431   tty-&gt;print_cr(&quot;transforms: Average amount of tranform progress per bytecode compiled&quot;);
1432   tty-&gt;print_cr(&quot;values  :  Average number of node values improved per bytecode&quot;);
1433   tty-&gt;print_cr(&quot;name    :  Bytecode name&quot;);
1434   tty-&gt;cr();
1435   tty-&gt;print_cr(&quot;  absolute  relative   nodes  rnodes  transforms  values   name&quot;);
1436   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1437   while (--i &gt; 0) {
1438     int       abs = _bytecodes_parsed[i];
1439     float     rel = abs * 100.0F / total;
1440     float   nodes = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_constructed[i])/_bytecodes_parsed[i];
1441     float  rnodes = _bytecodes_parsed[i] == 0 ? 0 :  rel * nodes;
1442     float  xforms = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_transformed[i])/_bytecodes_parsed[i];
1443     float  values = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _new_values       [i])/_bytecodes_parsed[i];
1444     if (cutoff &lt;= rel) {
1445       tty-&gt;print_cr(&quot;%10d  %7.2f%%  %6.1f  %6.2f   %6.1f   %6.1f     %s&quot;, abs, rel, nodes, rnodes, xforms, values, name_for_bc(i));
1446       abs_sum += abs;
1447     }
1448   }
1449   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1450   float rel_sum = abs_sum * 100.0F / total;
1451   tty-&gt;print_cr(&quot;%10d  %7.2f%%    (cutoff = %.2f%%)&quot;, abs_sum, rel_sum, cutoff);
1452   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1453   tty-&gt;cr();
1454 }
1455 #endif
1456 
1457 //----------------------------load_state_from----------------------------------
1458 // Load block/map/sp.  But not do not touch iter/bci.
1459 void Parse::load_state_from(Block* block) {
1460   set_block(block);
1461   // load the block&#39;s JVM state:
1462   set_map(block-&gt;start_map());
1463   set_sp( block-&gt;start_sp());
1464 }
1465 
1466 
1467 //-----------------------------record_state------------------------------------
1468 void Parse::Block::record_state(Parse* p) {
1469   assert(!is_merged(), &quot;can only record state once, on 1st inflow&quot;);
1470   assert(start_sp() == p-&gt;sp(), &quot;stack pointer must agree with ciTypeFlow&quot;);
1471   set_start_map(p-&gt;stop());
1472 }
1473 
1474 
1475 //------------------------------do_one_block-----------------------------------
1476 void Parse::do_one_block() {
1477   if (TraceOptoParse) {
1478     Block *b = block();
1479     int ns = b-&gt;num_successors();
1480     int nt = b-&gt;all_successors();
1481 
1482     tty-&gt;print(&quot;Parsing block #%d at bci [%d,%d), successors: &quot;,
1483                   block()-&gt;rpo(), block()-&gt;start(), block()-&gt;limit());
1484     for (int i = 0; i &lt; nt; i++) {
1485       tty-&gt;print((( i &lt; ns) ? &quot; %d&quot; : &quot; %d(e)&quot;), b-&gt;successor_at(i)-&gt;rpo());
1486     }
1487     if (b-&gt;is_loop_head()) tty-&gt;print(&quot;  lphd&quot;);
1488     tty-&gt;cr();
1489   }
1490 
1491   assert(block()-&gt;is_merged(), &quot;must be merged before being parsed&quot;);
1492   block()-&gt;mark_parsed();
1493 
1494   // Set iterator to start of block.
1495   iter().reset_to_bci(block()-&gt;start());
1496 
1497   CompileLog* log = C-&gt;log();
1498 
1499   // Parse bytecodes
1500   while (!stopped() &amp;&amp; !failing()) {
1501     iter().next();
1502 
1503     // Learn the current bci from the iterator:
1504     set_parse_bci(iter().cur_bci());
1505 
1506     if (bci() == block()-&gt;limit()) {
1507       // Do not walk into the next block until directed by do_all_blocks.
1508       merge(bci());
1509       break;
1510     }
1511     assert(bci() &lt; block()-&gt;limit(), &quot;bci still in block&quot;);
1512 
1513     if (log != NULL) {
1514       // Output an optional context marker, to help place actions
1515       // that occur during parsing of this BC.  If there is no log
1516       // output until the next context string, this context string
1517       // will be silently ignored.
1518       log-&gt;set_context(&quot;bc code=&#39;%d&#39; bci=&#39;%d&#39;&quot;, (int)bc(), bci());
1519     }
1520 
1521     if (block()-&gt;has_trap_at(bci())) {
1522       // We must respect the flow pass&#39;s traps, because it will refuse
1523       // to produce successors for trapping blocks.
1524       int trap_index = block()-&gt;flow()-&gt;trap_index();
1525       assert(trap_index != 0, &quot;trap index must be valid&quot;);
1526       uncommon_trap(trap_index);
1527       break;
1528     }
1529 
1530     NOT_PRODUCT( parse_histogram()-&gt;set_initial_state(bc()); );
1531 
1532 #ifdef ASSERT
1533     int pre_bc_sp = sp();
1534     int inputs, depth;
1535     bool have_se = !stopped() &amp;&amp; compute_stack_effects(inputs, depth);
1536     assert(!have_se || pre_bc_sp &gt;= inputs, &quot;have enough stack to execute this BC: pre_bc_sp=%d, inputs=%d&quot;, pre_bc_sp, inputs);
1537 #endif //ASSERT
1538 
1539     do_one_bytecode();
1540 
1541     assert(!have_se || stopped() || failing() || (sp() - pre_bc_sp) == depth,
1542            &quot;incorrect depth prediction: sp=%d, pre_bc_sp=%d, depth=%d&quot;, sp(), pre_bc_sp, depth);
1543 
1544     do_exceptions();
1545 
1546     NOT_PRODUCT( parse_histogram()-&gt;record_change(); );
1547 
1548     if (log != NULL)
1549       log-&gt;clear_context();  // skip marker if nothing was printed
1550 
1551     // Fall into next bytecode.  Each bytecode normally has 1 sequential
1552     // successor which is typically made ready by visiting this bytecode.
1553     // If the successor has several predecessors, then it is a merge
1554     // point, starts a new basic block, and is handled like other basic blocks.
1555   }
1556 }
1557 
1558 
1559 //------------------------------merge------------------------------------------
1560 void Parse::set_parse_bci(int bci) {
1561   set_bci(bci);
1562   Node_Notes* nn = C-&gt;default_node_notes();
1563   if (nn == NULL)  return;
1564 
1565   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
1566   if (!DebugInlinedCalls &amp;&amp; depth() &gt; 1) {
1567     return;
1568   }
1569 
1570   // Update the JVMS annotation, if present.
1571   JVMState* jvms = nn-&gt;jvms();
1572   if (jvms != NULL &amp;&amp; jvms-&gt;bci() != bci) {
1573     // Update the JVMS.
1574     jvms = jvms-&gt;clone_shallow(C);
1575     jvms-&gt;set_bci(bci);
1576     nn-&gt;set_jvms(jvms);
1577   }
1578 }
1579 
1580 //------------------------------merge------------------------------------------
1581 // Merge the current mapping into the basic block starting at bci
1582 void Parse::merge(int target_bci) {
1583   Block* target = successor_for_bci(target_bci);
1584   if (target == NULL) { handle_missing_successor(target_bci); return; }
1585   assert(!target-&gt;is_ready(), &quot;our arrival must be expected&quot;);
1586   int pnum = target-&gt;next_path_num();
1587   merge_common(target, pnum);
1588 }
1589 
1590 //-------------------------merge_new_path--------------------------------------
1591 // Merge the current mapping into the basic block, using a new path
1592 void Parse::merge_new_path(int target_bci) {
1593   Block* target = successor_for_bci(target_bci);
1594   if (target == NULL) { handle_missing_successor(target_bci); return; }
1595   assert(!target-&gt;is_ready(), &quot;new path into frozen graph&quot;);
1596   int pnum = target-&gt;add_new_path();
1597   merge_common(target, pnum);
1598 }
1599 
1600 //-------------------------merge_exception-------------------------------------
1601 // Merge the current mapping into the basic block starting at bci
1602 // The ex_oop must be pushed on the stack, unlike throw_to_exit.
1603 void Parse::merge_exception(int target_bci) {
1604   assert(sp() == 1, &quot;must have only the throw exception on the stack&quot;);
1605   Block* target = successor_for_bci(target_bci);
1606   if (target == NULL) { handle_missing_successor(target_bci); return; }
1607   assert(target-&gt;is_handler(), &quot;exceptions are handled by special blocks&quot;);
1608   int pnum = target-&gt;add_new_path();
1609   merge_common(target, pnum);
1610 }
1611 
1612 //--------------------handle_missing_successor---------------------------------
1613 void Parse::handle_missing_successor(int target_bci) {
1614 #ifndef PRODUCT
1615   Block* b = block();
1616   int trap_bci = b-&gt;flow()-&gt;has_trap()? b-&gt;flow()-&gt;trap_bci(): -1;
1617   tty-&gt;print_cr(&quot;### Missing successor at bci:%d for block #%d (trap_bci:%d)&quot;, target_bci, b-&gt;rpo(), trap_bci);
1618 #endif
1619   ShouldNotReachHere();
1620 }
1621 
1622 //--------------------------merge_common---------------------------------------
1623 void Parse::merge_common(Parse::Block* target, int pnum) {
1624   if (TraceOptoParse) {
1625     tty-&gt;print(&quot;Merging state at block #%d bci:%d&quot;, target-&gt;rpo(), target-&gt;start());
1626   }
1627 
1628   // Zap extra stack slots to top
1629   assert(sp() == target-&gt;start_sp(), &quot;&quot;);
1630   clean_stack(sp());
1631 
1632   if (!target-&gt;is_merged()) {   // No prior mapping at this bci
1633     if (TraceOptoParse) { tty-&gt;print(&quot; with empty state&quot;);  }
1634 
1635     // If this path is dead, do not bother capturing it as a merge.
1636     // It is &quot;as if&quot; we had 1 fewer predecessors from the beginning.
1637     if (stopped()) {
1638       if (TraceOptoParse)  tty-&gt;print_cr(&quot;, but path is dead and doesn&#39;t count&quot;);
1639       return;
1640     }
1641 
1642     // Make a region if we know there are multiple or unpredictable inputs.
1643     // (Also, if this is a plain fall-through, we might see another region,
1644     // which must not be allowed into this block&#39;s map.)
1645     if (pnum &gt; PhiNode::Input         // Known multiple inputs.
1646         || target-&gt;is_handler()       // These have unpredictable inputs.
1647         || target-&gt;is_loop_head()     // Known multiple inputs
1648         || control()-&gt;is_Region()) {  // We must hide this guy.
1649 
1650       int current_bci = bci();
1651       set_parse_bci(target-&gt;start()); // Set target bci
1652       if (target-&gt;is_SEL_head()) {
1653         DEBUG_ONLY( target-&gt;mark_merged_backedge(block()); )
1654         if (target-&gt;start() == 0) {
1655           // Add loop predicate for the special case when
1656           // there are backbranches to the method entry.
1657           add_predicate();
1658         }
1659       }
1660       // Add a Region to start the new basic block.  Phis will be added
1661       // later lazily.
1662       int edges = target-&gt;pred_count();
1663       if (edges &lt; pnum)  edges = pnum;  // might be a new path!
1664       RegionNode *r = new RegionNode(edges+1);
1665       gvn().set_type(r, Type::CONTROL);
1666       record_for_igvn(r);
1667       // zap all inputs to NULL for debugging (done in Node(uint) constructor)
1668       // for (int j = 1; j &lt; edges+1; j++) { r-&gt;init_req(j, NULL); }
1669       r-&gt;init_req(pnum, control());
1670       set_control(r);
1671       set_parse_bci(current_bci); // Restore bci
1672     }
1673 
1674     // Convert the existing Parser mapping into a mapping at this bci.
1675     store_state_to(target);
1676     assert(target-&gt;is_merged(), &quot;do not come here twice&quot;);
1677 
1678   } else {                      // Prior mapping at this bci
1679     if (TraceOptoParse) {  tty-&gt;print(&quot; with previous state&quot;); }
1680 #ifdef ASSERT
1681     if (target-&gt;is_SEL_head()) {
1682       target-&gt;mark_merged_backedge(block());
1683     }
1684 #endif
1685     // We must not manufacture more phis if the target is already parsed.
1686     bool nophi = target-&gt;is_parsed();
1687 
1688     SafePointNode* newin = map();// Hang on to incoming mapping
1689     Block* save_block = block(); // Hang on to incoming block;
1690     load_state_from(target);    // Get prior mapping
1691 
1692     assert(newin-&gt;jvms()-&gt;locoff() == jvms()-&gt;locoff(), &quot;JVMS layouts agree&quot;);
1693     assert(newin-&gt;jvms()-&gt;stkoff() == jvms()-&gt;stkoff(), &quot;JVMS layouts agree&quot;);
1694     assert(newin-&gt;jvms()-&gt;monoff() == jvms()-&gt;monoff(), &quot;JVMS layouts agree&quot;);
1695     assert(newin-&gt;jvms()-&gt;endoff() == jvms()-&gt;endoff(), &quot;JVMS layouts agree&quot;);
1696 
1697     // Iterate over my current mapping and the old mapping.
1698     // Where different, insert Phi functions.
1699     // Use any existing Phi functions.
1700     assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1701     RegionNode* r = control()-&gt;as_Region();
1702 
1703     // Compute where to merge into
1704     // Merge incoming control path
1705     r-&gt;init_req(pnum, newin-&gt;control());
1706 
1707     if (pnum == 1) {            // Last merge for this Region?
1708       if (!block()-&gt;flow()-&gt;is_irreducible_entry()) {
1709         Node* result = _gvn.transform_no_reclaim(r);
1710         if (r != result &amp;&amp; TraceOptoParse) {
1711           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block()-&gt;rpo(), r-&gt;_idx, result-&gt;_idx);
1712         }
1713       }
1714       record_for_igvn(r);
1715     }
1716 
1717     // Update all the non-control inputs to map:
1718     assert(TypeFunc::Parms == newin-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1719     bool check_elide_phi = target-&gt;is_SEL_backedge(save_block);
1720     for (uint j = 1; j &lt; newin-&gt;req(); j++) {
1721       Node* m = map()-&gt;in(j);   // Current state of target.
1722       Node* n = newin-&gt;in(j);   // Incoming change to target state.
1723       PhiNode* phi;
1724       if (m-&gt;is_Phi() &amp;&amp; m-&gt;as_Phi()-&gt;region() == r)
1725         phi = m-&gt;as_Phi();
1726       else
1727         phi = NULL;
1728       if (m != n) {             // Different; must merge
1729         switch (j) {
1730         // Frame pointer and Return Address never changes
1731         case TypeFunc::FramePtr:// Drop m, use the original value
1732         case TypeFunc::ReturnAdr:
1733           break;
1734         case TypeFunc::Memory:  // Merge inputs to the MergeMem node
1735           assert(phi == NULL, &quot;the merge contains phis, not vice versa&quot;);
1736           merge_memory_edges(n-&gt;as_MergeMem(), pnum, nophi);
1737           continue;
1738         default:                // All normal stuff
1739           if (phi == NULL) {
1740             const JVMState* jvms = map()-&gt;jvms();
1741             if (EliminateNestedLocks &amp;&amp;
1742                 jvms-&gt;is_mon(j) &amp;&amp; jvms-&gt;is_monitor_box(j)) {
1743               // BoxLock nodes are not commoning.
1744               // Use old BoxLock node as merged box.
1745               assert(newin-&gt;jvms()-&gt;is_monitor_box(j), &quot;sanity&quot;);
1746               // This assert also tests that nodes are BoxLock.
1747               assert(BoxLockNode::same_slot(n, m), &quot;sanity&quot;);
1748               C-&gt;gvn_replace_by(n, m);
1749             } else if (!check_elide_phi || !target-&gt;can_elide_SEL_phi(j)) {
1750               phi = ensure_phi(j, nophi);
1751             }
1752           }
1753           break;
1754         }
1755       }
1756       // At this point, n might be top if:
1757       //  - there is no phi (because TypeFlow detected a conflict), or
1758       //  - the corresponding control edges is top (a dead incoming path)
1759       // It is a bug if we create a phi which sees a garbage value on a live path.
1760 
1761       if (phi != NULL) {
1762         assert(n != top() || r-&gt;in(pnum) == top(), &quot;live value must not be garbage&quot;);
1763         assert(phi-&gt;region() == r, &quot;&quot;);
1764         phi-&gt;set_req(pnum, n);  // Then add &#39;n&#39; to the merge
1765         if (pnum == PhiNode::Input) {
1766           // Last merge for this Phi.
1767           // So far, Phis have had a reasonable type from ciTypeFlow.
1768           // Now _gvn will join that with the meet of current inputs.
1769           // BOTTOM is never permissible here, &#39;cause pessimistically
1770           // Phis of pointers cannot lose the basic pointer type.
1771           debug_only(const Type* bt1 = phi-&gt;bottom_type());
1772           assert(bt1 != Type::BOTTOM, &quot;should not be building conflict phis&quot;);
1773           map()-&gt;set_req(j, _gvn.transform_no_reclaim(phi));
1774           debug_only(const Type* bt2 = phi-&gt;bottom_type());
1775           assert(bt2-&gt;higher_equal_speculative(bt1), &quot;must be consistent with type-flow&quot;);
1776           record_for_igvn(phi);
1777         }
1778       }
1779     } // End of for all values to be merged
1780 
1781     if (pnum == PhiNode::Input &amp;&amp;
1782         !r-&gt;in(0)) {         // The occasional useless Region
1783       assert(control() == r, &quot;&quot;);
1784       set_control(r-&gt;nonnull_req());
1785     }
1786 
1787     map()-&gt;merge_replaced_nodes_with(newin);
1788 
1789     // newin has been subsumed into the lazy merge, and is now dead.
1790     set_block(save_block);
1791 
1792     stop();                     // done with this guy, for now
1793   }
1794 
1795   if (TraceOptoParse) {
1796     tty-&gt;print_cr(&quot; on path %d&quot;, pnum);
1797   }
1798 
1799   // Done with this parser state.
1800   assert(stopped(), &quot;&quot;);
1801 }
1802 
1803 
1804 //--------------------------merge_memory_edges---------------------------------
1805 void Parse::merge_memory_edges(MergeMemNode* n, int pnum, bool nophi) {
1806   // (nophi means we must not create phis, because we already parsed here)
1807   assert(n != NULL, &quot;&quot;);
1808   // Merge the inputs to the MergeMems
1809   MergeMemNode* m = merged_memory();
1810 
1811   assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1812   RegionNode* r = control()-&gt;as_Region();
1813 
1814   PhiNode* base = NULL;
1815   MergeMemNode* remerge = NULL;
1816   for (MergeMemStream mms(m, n); mms.next_non_empty2(); ) {
1817     Node *p = mms.force_memory();
1818     Node *q = mms.memory2();
1819     if (mms.is_empty() &amp;&amp; nophi) {
1820       // Trouble:  No new splits allowed after a loop body is parsed.
1821       // Instead, wire the new split into a MergeMem on the backedge.
1822       // The optimizer will sort it out, slicing the phi.
1823       if (remerge == NULL) {
1824         guarantee(base != NULL, &quot;&quot;);
1825         assert(base-&gt;in(0) != NULL, &quot;should not be xformed away&quot;);
1826         remerge = MergeMemNode::make(base-&gt;in(pnum));
1827         gvn().set_type(remerge, Type::MEMORY);
1828         base-&gt;set_req(pnum, remerge);
1829       }
1830       remerge-&gt;set_memory_at(mms.alias_idx(), q);
1831       continue;
1832     }
1833     assert(!q-&gt;is_MergeMem(), &quot;&quot;);
1834     PhiNode* phi;
1835     if (p != q) {
1836       phi = ensure_memory_phi(mms.alias_idx(), nophi);
1837     } else {
1838       if (p-&gt;is_Phi() &amp;&amp; p-&gt;as_Phi()-&gt;region() == r)
1839         phi = p-&gt;as_Phi();
1840       else
1841         phi = NULL;
1842     }
1843     // Insert q into local phi
1844     if (phi != NULL) {
1845       assert(phi-&gt;region() == r, &quot;&quot;);
1846       p = phi;
1847       phi-&gt;set_req(pnum, q);
1848       if (mms.at_base_memory()) {
1849         base = phi;  // delay transforming it
1850       } else if (pnum == 1) {
1851         record_for_igvn(phi);
1852         p = _gvn.transform_no_reclaim(phi);
1853       }
1854       mms.set_memory(p);// store back through the iterator
1855     }
1856   }
1857   // Transform base last, in case we must fiddle with remerging.
1858   if (base != NULL &amp;&amp; pnum == 1) {
1859     record_for_igvn(base);
1860     m-&gt;set_base_memory( _gvn.transform_no_reclaim(base) );
1861   }
1862 }
1863 
1864 
1865 //------------------------ensure_phis_everywhere-------------------------------
1866 void Parse::ensure_phis_everywhere() {
1867   ensure_phi(TypeFunc::I_O);
1868 
1869   // Ensure a phi on all currently known memories.
1870   for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
1871     ensure_memory_phi(mms.alias_idx());
1872     debug_only(mms.set_memory());  // keep the iterator happy
1873   }
1874 
1875   // Note:  This is our only chance to create phis for memory slices.
1876   // If we miss a slice that crops up later, it will have to be
1877   // merged into the base-memory phi that we are building here.
1878   // Later, the optimizer will comb out the knot, and build separate
1879   // phi-loops for each memory slice that matters.
1880 
1881   // Monitors must nest nicely and not get confused amongst themselves.
1882   // Phi-ify everything up to the monitors, though.
1883   uint monoff = map()-&gt;jvms()-&gt;monoff();
1884   uint nof_monitors = map()-&gt;jvms()-&gt;nof_monitors();
1885 
1886   assert(TypeFunc::Parms == map()-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1887   bool check_elide_phi = block()-&gt;is_SEL_head();
1888   for (uint i = TypeFunc::Parms; i &lt; monoff; i++) {
1889     if (!check_elide_phi || !block()-&gt;can_elide_SEL_phi(i)) {
1890       ensure_phi(i);
1891     }
1892   }
1893 
1894   // Even monitors need Phis, though they are well-structured.
1895   // This is true for OSR methods, and also for the rare cases where
1896   // a monitor object is the subject of a replace_in_map operation.
1897   // See bugs 4426707 and 5043395.
1898   for (uint m = 0; m &lt; nof_monitors; m++) {
1899     ensure_phi(map()-&gt;jvms()-&gt;monitor_obj_offset(m));
1900   }
1901 }
1902 
1903 
1904 //-----------------------------add_new_path------------------------------------
1905 // Add a previously unaccounted predecessor to this block.
1906 int Parse::Block::add_new_path() {
1907   // If there is no map, return the lowest unused path number.
1908   if (!is_merged())  return pred_count()+1;  // there will be a map shortly
1909 
1910   SafePointNode* map = start_map();
1911   if (!map-&gt;control()-&gt;is_Region())
1912     return pred_count()+1;  // there may be a region some day
1913   RegionNode* r = map-&gt;control()-&gt;as_Region();
1914 
1915   // Add new path to the region.
1916   uint pnum = r-&gt;req();
1917   r-&gt;add_req(NULL);
1918 
1919   for (uint i = 1; i &lt; map-&gt;req(); i++) {
1920     Node* n = map-&gt;in(i);
1921     if (i == TypeFunc::Memory) {
1922       // Ensure a phi on all currently known memories.
1923       for (MergeMemStream mms(n-&gt;as_MergeMem()); mms.next_non_empty(); ) {
1924         Node* phi = mms.memory();
1925         if (phi-&gt;is_Phi() &amp;&amp; phi-&gt;as_Phi()-&gt;region() == r) {
1926           assert(phi-&gt;req() == pnum, &quot;must be same size as region&quot;);
1927           phi-&gt;add_req(NULL);
1928         }
1929       }
1930     } else {
1931       if (n-&gt;is_Phi() &amp;&amp; n-&gt;as_Phi()-&gt;region() == r) {
1932         assert(n-&gt;req() == pnum, &quot;must be same size as region&quot;);
1933         n-&gt;add_req(NULL);
1934       }
1935     }
1936   }
1937 
1938   return pnum;
1939 }
1940 
1941 //------------------------------ensure_phi-------------------------------------
1942 // Turn the idx&#39;th entry of the current map into a Phi
1943 PhiNode *Parse::ensure_phi(int idx, bool nocreate) {
1944   SafePointNode* map = this-&gt;map();
1945   Node* region = map-&gt;control();
1946   assert(region-&gt;is_Region(), &quot;&quot;);
1947 
1948   Node* o = map-&gt;in(idx);
1949   assert(o != NULL, &quot;&quot;);
1950 
1951   if (o == top())  return NULL; // TOP always merges into TOP
1952 
1953   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
1954     return o-&gt;as_Phi();
1955   }
1956 
1957   // Now use a Phi here for merging
1958   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
1959   const JVMState* jvms = map-&gt;jvms();
1960   const Type* t = NULL;
1961   if (jvms-&gt;is_loc(idx)) {
1962     t = block()-&gt;local_type_at(idx - jvms-&gt;locoff());
1963   } else if (jvms-&gt;is_stk(idx)) {
1964     t = block()-&gt;stack_type_at(idx - jvms-&gt;stkoff());
1965   } else if (jvms-&gt;is_mon(idx)) {
1966     assert(!jvms-&gt;is_monitor_box(idx), &quot;no phis for boxes&quot;);
1967     t = TypeInstPtr::BOTTOM; // this is sufficient for a lock object
1968   } else if ((uint)idx &lt; TypeFunc::Parms) {
1969     t = o-&gt;bottom_type();  // Type::RETURN_ADDRESS or such-like.
1970   } else {
1971     assert(false, &quot;no type information for this phi&quot;);
1972   }
1973 
1974   // If the type falls to bottom, then this must be a local that
1975   // is mixing ints and oops or some such.  Forcing it to top
1976   // makes it go dead.
1977   if (t == Type::BOTTOM) {
1978     map-&gt;set_req(idx, top());
1979     return NULL;
1980   }
1981 
1982   // Do not create phis for top either.
1983   // A top on a non-null control flow must be an unused even after the.phi.
1984   if (t == Type::TOP || t == Type::HALF) {
1985     map-&gt;set_req(idx, top());
1986     return NULL;
1987   }
1988 
1989   PhiNode* phi = PhiNode::make(region, o, t);
1990   gvn().set_type(phi, t);
1991   if (C-&gt;do_escape_analysis()) record_for_igvn(phi);
1992   map-&gt;set_req(idx, phi);
1993   return phi;
1994 }
1995 
1996 //--------------------------ensure_memory_phi----------------------------------
1997 // Turn the idx&#39;th slice of the current memory into a Phi
1998 PhiNode *Parse::ensure_memory_phi(int idx, bool nocreate) {
1999   MergeMemNode* mem = merged_memory();
2000   Node* region = control();
2001   assert(region-&gt;is_Region(), &quot;&quot;);
2002 
2003   Node *o = (idx == Compile::AliasIdxBot)? mem-&gt;base_memory(): mem-&gt;memory_at(idx);
2004   assert(o != NULL &amp;&amp; o != top(), &quot;&quot;);
2005 
2006   PhiNode* phi;
2007   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2008     phi = o-&gt;as_Phi();
2009     if (phi == mem-&gt;base_memory() &amp;&amp; idx &gt;= Compile::AliasIdxRaw) {
2010       // clone the shared base memory phi to make a new memory split
2011       assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2012       const Type* t = phi-&gt;bottom_type();
2013       const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2014       phi = phi-&gt;slice_memory(adr_type);
2015       gvn().set_type(phi, t);
2016     }
2017     return phi;
2018   }
2019 
2020   // Now use a Phi here for merging
2021   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2022   const Type* t = o-&gt;bottom_type();
2023   const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2024   phi = PhiNode::make(region, o, t, adr_type);
2025   gvn().set_type(phi, t);
2026   if (idx == Compile::AliasIdxBot)
2027     mem-&gt;set_base_memory(phi);
2028   else
2029     mem-&gt;set_memory_at(idx, phi);
2030   return phi;
2031 }
2032 
2033 //------------------------------call_register_finalizer-----------------------
2034 // Check the klass of the receiver and call register_finalizer if the
2035 // class need finalization.
2036 void Parse::call_register_finalizer() {
2037   Node* receiver = local(0);
2038   assert(receiver != NULL &amp;&amp; receiver-&gt;bottom_type()-&gt;isa_instptr() != NULL,
2039          &quot;must have non-null instance type&quot;);
2040 
2041   const TypeInstPtr *tinst = receiver-&gt;bottom_type()-&gt;isa_instptr();
2042   if (tinst != NULL &amp;&amp; tinst-&gt;klass()-&gt;is_loaded() &amp;&amp; !tinst-&gt;klass_is_exact()) {
2043     // The type isn&#39;t known exactly so see if CHA tells us anything.
2044     ciInstanceKlass* ik = tinst-&gt;klass()-&gt;as_instance_klass();
2045     if (!Dependencies::has_finalizable_subclass(ik)) {
2046       // No finalizable subclasses so skip the dynamic check.
2047       C-&gt;dependencies()-&gt;assert_has_no_finalizable_subclasses(ik);
2048       return;
2049     }
2050   }
2051 
2052   // Insert a dynamic test for whether the instance needs
2053   // finalization.  In general this will fold up since the concrete
2054   // class is often visible so the access flags are constant.
2055   Node* klass_addr = basic_plus_adr( receiver, receiver, oopDesc::klass_offset_in_bytes() );
2056   Node* klass = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), klass_addr, TypeInstPtr::KLASS));
2057 
2058   Node* access_flags_addr = basic_plus_adr(klass, klass, in_bytes(Klass::access_flags_offset()));
2059   Node* access_flags = make_load(NULL, access_flags_addr, TypeInt::INT, T_INT, MemNode::unordered);
2060 
2061   Node* mask  = _gvn.transform(new AndINode(access_flags, intcon(JVM_ACC_HAS_FINALIZER)));
2062   Node* check = _gvn.transform(new CmpINode(mask, intcon(0)));
2063   Node* test  = _gvn.transform(new BoolNode(check, BoolTest::ne));
2064 
2065   IfNode* iff = create_and_map_if(control(), test, PROB_MAX, COUNT_UNKNOWN);
2066 
2067   RegionNode* result_rgn = new RegionNode(3);
2068   record_for_igvn(result_rgn);
2069 
2070   Node *skip_register = _gvn.transform(new IfFalseNode(iff));
2071   result_rgn-&gt;init_req(1, skip_register);
2072 
2073   Node *needs_register = _gvn.transform(new IfTrueNode(iff));
2074   set_control(needs_register);
2075   if (stopped()) {
2076     // There is no slow path.
2077     result_rgn-&gt;init_req(2, top());
2078   } else {
2079     Node *call = make_runtime_call(RC_NO_LEAF,
2080                                    OptoRuntime::register_finalizer_Type(),
2081                                    OptoRuntime::register_finalizer_Java(),
2082                                    NULL, TypePtr::BOTTOM,
2083                                    receiver);
2084     make_slow_call_ex(call, env()-&gt;Throwable_klass(), true);
2085 
2086     Node* fast_io  = call-&gt;in(TypeFunc::I_O);
2087     Node* fast_mem = call-&gt;in(TypeFunc::Memory);
2088     // These two phis are pre-filled with copies of of the fast IO and Memory
2089     Node* io_phi   = PhiNode::make(result_rgn, fast_io,  Type::ABIO);
2090     Node* mem_phi  = PhiNode::make(result_rgn, fast_mem, Type::MEMORY, TypePtr::BOTTOM);
2091 
2092     result_rgn-&gt;init_req(2, control());
2093     io_phi    -&gt;init_req(2, i_o());
2094     mem_phi   -&gt;init_req(2, reset_memory());
2095 
2096     set_all_memory( _gvn.transform(mem_phi) );
2097     set_i_o(        _gvn.transform(io_phi) );
2098   }
2099 
2100   set_control( _gvn.transform(result_rgn) );
2101 }
2102 
<a name="10" id="anc10"></a><span class="line-added">2103 // Add check to deoptimize once holder klass is fully initialized.</span>
<span class="line-added">2104 void Parse::clinit_deopt() {</span>
<span class="line-added">2105   assert(C-&gt;has_method(), &quot;only for normal compilations&quot;);</span>
<span class="line-added">2106   assert(depth() == 1, &quot;only for main compiled method&quot;);</span>
<span class="line-added">2107   assert(is_normal_parse(), &quot;no barrier needed on osr entry&quot;);</span>
<span class="line-added">2108   assert(!method()-&gt;holder()-&gt;is_not_initialized(), &quot;initialization should have been started&quot;);</span>
<span class="line-added">2109 </span>
<span class="line-added">2110   set_parse_bci(0);</span>
<span class="line-added">2111 </span>
<span class="line-added">2112   Node* holder = makecon(TypeKlassPtr::make(method()-&gt;holder()));</span>
<span class="line-added">2113   guard_klass_being_initialized(holder);</span>
<span class="line-added">2114 }</span>
<span class="line-added">2115 </span>
2116 // Add check to deoptimize if RTM state is not ProfileRTM
2117 void Parse::rtm_deopt() {
2118 #if INCLUDE_RTM_OPT
2119   if (C-&gt;profile_rtm()) {
<a name="11" id="anc11"></a><span class="line-modified">2120     assert(C-&gt;has_method(), &quot;only for normal compilations&quot;);</span>
2121     assert(!C-&gt;method()-&gt;method_data()-&gt;is_empty(), &quot;MDO is needed to record RTM state&quot;);
2122     assert(depth() == 1, &quot;generate check only for main compiled method&quot;);
2123 
2124     // Set starting bci for uncommon trap.
2125     set_parse_bci(is_osr_parse() ? osr_bci() : 0);
2126 
2127     // Load the rtm_state from the MethodData.
2128     const TypePtr* adr_type = TypeMetadataPtr::make(C-&gt;method()-&gt;method_data());
2129     Node* mdo = makecon(adr_type);
2130     int offset = MethodData::rtm_state_offset_in_bytes();
2131     Node* adr_node = basic_plus_adr(mdo, mdo, offset);
2132     Node* rtm_state = make_load(control(), adr_node, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2133 
2134     // Separate Load from Cmp by Opaque.
2135     // In expand_macro_nodes() it will be replaced either
2136     // with this load when there are locks in the code
2137     // or with ProfileRTM (cmp-&gt;in(2)) otherwise so that
2138     // the check will fold.
2139     Node* profile_state = makecon(TypeInt::make(ProfileRTM));
2140     Node* opq   = _gvn.transform( new Opaque3Node(C, rtm_state, Opaque3Node::RTM_OPT) );
2141     Node* chk   = _gvn.transform( new CmpINode(opq, profile_state) );
2142     Node* tst   = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
2143     // Branch to failure if state was changed
2144     { BuildCutout unless(this, tst, PROB_ALWAYS);
2145       uncommon_trap(Deoptimization::Reason_rtm_state_change,
2146                     Deoptimization::Action_make_not_entrant);
2147     }
2148   }
2149 #endif
2150 }
2151 
2152 void Parse::decrement_age() {
2153   MethodCounters* mc = method()-&gt;ensure_method_counters();
2154   if (mc == NULL) {
2155     C-&gt;record_failure(&quot;Must have MCs&quot;);
2156     return;
2157   }
2158   assert(!is_osr_parse(), &quot;Not doing this for OSRs&quot;);
2159 
2160   // Set starting bci for uncommon trap.
2161   set_parse_bci(0);
2162 
2163   const TypePtr* adr_type = TypeRawPtr::make((address)mc);
2164   Node* mc_adr = makecon(adr_type);
2165   Node* cnt_adr = basic_plus_adr(mc_adr, mc_adr, in_bytes(MethodCounters::nmethod_age_offset()));
2166   Node* cnt = make_load(control(), cnt_adr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2167   Node* decr = _gvn.transform(new SubINode(cnt, makecon(TypeInt::ONE)));
2168   store_to_memory(control(), cnt_adr, decr, T_INT, adr_type, MemNode::unordered);
2169   Node *chk   = _gvn.transform(new CmpINode(decr, makecon(TypeInt::ZERO)));
2170   Node* tst   = _gvn.transform(new BoolNode(chk, BoolTest::gt));
2171   { BuildCutout unless(this, tst, PROB_ALWAYS);
2172     uncommon_trap(Deoptimization::Reason_tenured,
2173                   Deoptimization::Action_make_not_entrant);
2174   }
2175 }
2176 
2177 //------------------------------return_current---------------------------------
2178 // Append current _map to _exit_return
2179 void Parse::return_current(Node* value) {
2180   if (RegisterFinalizersAtInit &amp;&amp;
2181       method()-&gt;intrinsic_id() == vmIntrinsics::_Object_init) {
2182     call_register_finalizer();
2183   }
2184 
2185   // Do not set_parse_bci, so that return goo is credited to the return insn.
2186   set_bci(InvocationEntryBci);
2187   if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
2188     shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
2189   }
2190   if (C-&gt;env()-&gt;dtrace_method_probes()) {
2191     make_dtrace_method_exit(method());
2192   }
2193   SafePointNode* exit_return = _exits.map();
2194   exit_return-&gt;in( TypeFunc::Control  )-&gt;add_req( control() );
2195   exit_return-&gt;in( TypeFunc::I_O      )-&gt;add_req( i_o    () );
2196   Node *mem = exit_return-&gt;in( TypeFunc::Memory   );
2197   for (MergeMemStream mms(mem-&gt;as_MergeMem(), merged_memory()); mms.next_non_empty2(); ) {
2198     if (mms.is_empty()) {
2199       // get a copy of the base memory, and patch just this one input
2200       const TypePtr* adr_type = mms.adr_type(C);
2201       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
2202       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
2203       gvn().set_type_bottom(phi);
2204       phi-&gt;del_req(phi-&gt;req()-1);  // prepare to re-patch
2205       mms.set_memory(phi);
2206     }
2207     mms.memory()-&gt;add_req(mms.memory2());
2208   }
2209 
2210   // frame pointer is always same, already captured
2211   if (value != NULL) {
2212     // If returning oops to an interface-return, there is a silent free
2213     // cast from oop to interface allowed by the Verifier.  Make it explicit
2214     // here.
2215     Node* phi = _exits.argument(0);
2216     const TypeInstPtr *tr = phi-&gt;bottom_type()-&gt;isa_instptr();
2217     if (tr &amp;&amp; tr-&gt;klass()-&gt;is_loaded() &amp;&amp;
2218         tr-&gt;klass()-&gt;is_interface()) {
2219       const TypeInstPtr *tp = value-&gt;bottom_type()-&gt;isa_instptr();
2220       if (tp &amp;&amp; tp-&gt;klass()-&gt;is_loaded() &amp;&amp;
2221           !tp-&gt;klass()-&gt;is_interface()) {
2222         // sharpen the type eagerly; this eases certain assert checking
2223         if (tp-&gt;higher_equal(TypeInstPtr::NOTNULL))
2224           tr = tr-&gt;join_speculative(TypeInstPtr::NOTNULL)-&gt;is_instptr();
2225         value = _gvn.transform(new CheckCastPPNode(0, value, tr));
2226       }
2227     } else {
2228       // Also handle returns of oop-arrays to an arrays-of-interface return
2229       const TypeInstPtr* phi_tip;
2230       const TypeInstPtr* val_tip;
2231       Type::get_arrays_base_elements(phi-&gt;bottom_type(), value-&gt;bottom_type(), &amp;phi_tip, &amp;val_tip);
2232       if (phi_tip != NULL &amp;&amp; phi_tip-&gt;is_loaded() &amp;&amp; phi_tip-&gt;klass()-&gt;is_interface() &amp;&amp;
2233           val_tip != NULL &amp;&amp; val_tip-&gt;is_loaded() &amp;&amp; !val_tip-&gt;klass()-&gt;is_interface()) {
2234         value = _gvn.transform(new CheckCastPPNode(0, value, phi-&gt;bottom_type()));
2235       }
2236     }
2237     phi-&gt;add_req(value);
2238   }
2239 
2240   if (_first_return) {
2241     _exits.map()-&gt;transfer_replaced_nodes_from(map(), _new_idx);
2242     _first_return = false;
2243   } else {
2244     _exits.map()-&gt;merge_replaced_nodes_with(map());
2245   }
2246 
2247   stop_and_kill_map();          // This CFG path dies here
2248 }
2249 
2250 
2251 //------------------------------add_safepoint----------------------------------
2252 void Parse::add_safepoint() {
2253   // See if we can avoid this safepoint.  No need for a SafePoint immediately
2254   // after a Call (except Leaf Call) or another SafePoint.
2255   Node *proj = control();
2256   bool add_poll_param = SafePointNode::needs_polling_address_input();
2257   uint parms = add_poll_param ? TypeFunc::Parms+1 : TypeFunc::Parms;
2258   if( proj-&gt;is_Proj() ) {
2259     Node *n0 = proj-&gt;in(0);
2260     if( n0-&gt;is_Catch() ) {
2261       n0 = n0-&gt;in(0)-&gt;in(0);
2262       assert( n0-&gt;is_Call(), &quot;expect a call here&quot; );
2263     }
2264     if( n0-&gt;is_Call() ) {
2265       if( n0-&gt;as_Call()-&gt;guaranteed_safepoint() )
2266         return;
2267     } else if( n0-&gt;is_SafePoint() &amp;&amp; n0-&gt;req() &gt;= parms ) {
2268       return;
2269     }
2270   }
2271 
2272   // Clear out dead values from the debug info.
2273   kill_dead_locals();
2274 
2275   // Clone the JVM State
2276   SafePointNode *sfpnt = new SafePointNode(parms, NULL);
2277 
2278   // Capture memory state BEFORE a SafePoint.  Since we can block at a
2279   // SafePoint we need our GC state to be safe; i.e. we need all our current
2280   // write barriers (card marks) to not float down after the SafePoint so we
2281   // must read raw memory.  Likewise we need all oop stores to match the card
2282   // marks.  If deopt can happen, we need ALL stores (we need the correct JVM
2283   // state on a deopt).
2284 
2285   // We do not need to WRITE the memory state after a SafePoint.  The control
2286   // edge will keep card-marks and oop-stores from floating up from below a
2287   // SafePoint and our true dependency added here will keep them from floating
2288   // down below a SafePoint.
2289 
2290   // Clone the current memory state
2291   Node* mem = MergeMemNode::make(map()-&gt;memory());
2292 
2293   mem = _gvn.transform(mem);
2294 
2295   // Pass control through the safepoint
2296   sfpnt-&gt;init_req(TypeFunc::Control  , control());
2297   // Fix edges normally used by a call
2298   sfpnt-&gt;init_req(TypeFunc::I_O      , top() );
2299   sfpnt-&gt;init_req(TypeFunc::Memory   , mem   );
2300   sfpnt-&gt;init_req(TypeFunc::ReturnAdr, top() );
2301   sfpnt-&gt;init_req(TypeFunc::FramePtr , top() );
2302 
2303   // Create a node for the polling address
2304   if( add_poll_param ) {
2305     Node *polladr;
2306     if (SafepointMechanism::uses_thread_local_poll()) {
2307       Node *thread = _gvn.transform(new ThreadLocalNode());
2308       Node *polling_page_load_addr = _gvn.transform(basic_plus_adr(top(), thread, in_bytes(Thread::polling_page_offset())));
2309       polladr = make_load(control(), polling_page_load_addr, TypeRawPtr::BOTTOM, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
2310     } else {
2311       polladr = ConPNode::make((address)os::get_polling_page());
2312     }
2313     sfpnt-&gt;init_req(TypeFunc::Parms+0, _gvn.transform(polladr));
2314   }
2315 
2316   // Fix up the JVM State edges
2317   add_safepoint_edges(sfpnt);
2318   Node *transformed_sfpnt = _gvn.transform(sfpnt);
2319   set_control(transformed_sfpnt);
2320 
2321   // Provide an edge from root to safepoint.  This makes the safepoint
2322   // appear useful until the parse has completed.
2323   if( OptoRemoveUseless &amp;&amp; transformed_sfpnt-&gt;is_SafePoint() ) {
2324     assert(C-&gt;root() != NULL, &quot;Expect parse is still valid&quot;);
2325     C-&gt;root()-&gt;add_prec(transformed_sfpnt);
2326   }
2327 }
2328 
2329 #ifndef PRODUCT
2330 //------------------------show_parse_info--------------------------------------
2331 void Parse::show_parse_info() {
2332   InlineTree* ilt = NULL;
2333   if (C-&gt;ilt() != NULL) {
2334     JVMState* caller_jvms = is_osr_parse() ? caller()-&gt;caller() : caller();
2335     ilt = InlineTree::find_subtree_from_root(C-&gt;ilt(), caller_jvms, method());
2336   }
2337   if (PrintCompilation &amp;&amp; Verbose) {
2338     if (depth() == 1) {
2339       if( ilt-&gt;count_inlines() ) {
2340         tty-&gt;print(&quot;    __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2341                      ilt-&gt;count_inline_bcs());
2342         tty-&gt;cr();
2343       }
2344     } else {
2345       if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2346       if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2347       // Check this is not the final compiled version
2348       if (C-&gt;trap_can_recompile()) {
2349         tty-&gt;print(&quot;-&quot;);
2350       } else {
2351         tty-&gt;print(&quot; &quot;);
2352       }
2353       method()-&gt;print_short_name();
2354       if (is_osr_parse()) {
2355         tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2356       }
2357       tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2358       if (ilt-&gt;count_inlines()) {
2359         tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2360                    ilt-&gt;count_inline_bcs());
2361       }
2362       tty-&gt;cr();
2363     }
2364   }
2365   if (PrintOpto &amp;&amp; (depth() == 1 || PrintOptoInlining)) {
2366     // Print that we succeeded; suppress this message on the first osr parse.
2367 
2368     if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2369     if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2370     // Check this is not the final compiled version
2371     if (C-&gt;trap_can_recompile() &amp;&amp; depth() == 1) {
2372       tty-&gt;print(&quot;-&quot;);
2373     } else {
2374       tty-&gt;print(&quot; &quot;);
2375     }
2376     if( depth() != 1 ) { tty-&gt;print(&quot;   &quot;); }  // missing compile count
2377     for (int i = 1; i &lt; depth(); ++i) { tty-&gt;print(&quot;  &quot;); }
2378     method()-&gt;print_short_name();
2379     if (is_osr_parse()) {
2380       tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2381     }
2382     if (ilt-&gt;caller_bci() != -1) {
2383       tty-&gt;print(&quot; @ %d&quot;, ilt-&gt;caller_bci());
2384     }
2385     tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2386     if (ilt-&gt;count_inlines()) {
2387       tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2388                  ilt-&gt;count_inline_bcs());
2389     }
2390     tty-&gt;cr();
2391   }
2392 }
2393 
2394 
2395 //------------------------------dump-------------------------------------------
2396 // Dump information associated with the bytecodes of current _method
2397 void Parse::dump() {
2398   if( method() != NULL ) {
2399     // Iterate over bytecodes
2400     ciBytecodeStream iter(method());
2401     for( Bytecodes::Code bc = iter.next(); bc != ciBytecodeStream::EOBC() ; bc = iter.next() ) {
2402       dump_bci( iter.cur_bci() );
2403       tty-&gt;cr();
2404     }
2405   }
2406 }
2407 
2408 // Dump information associated with a byte code index, &#39;bci&#39;
2409 void Parse::dump_bci(int bci) {
2410   // Output info on merge-points, cloning, and within _jsr..._ret
2411   // NYI
2412   tty-&gt;print(&quot; bci:%d&quot;, bci);
2413 }
2414 
2415 #endif
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>