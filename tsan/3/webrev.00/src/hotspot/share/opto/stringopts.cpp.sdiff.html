<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/opto/stringopts.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="split_if.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="subnode.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/stringopts.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 362   // Eliminate Initialize node.
 363   assert(init-&gt;outcnt() &lt;= 2, &quot;only a control and memory projection expected&quot;);
 364   assert(init-&gt;req() &lt;= InitializeNode::RawStores, &quot;no pending inits&quot;);
 365   Node *ctrl_proj = init-&gt;proj_out_or_null(TypeFunc::Control);
 366   if (ctrl_proj != NULL) {
 367     C-&gt;gvn_replace_by(ctrl_proj, init-&gt;in(TypeFunc::Control));
 368   }
 369   Node *mem_proj = init-&gt;proj_out_or_null(TypeFunc::Memory);
 370   if (mem_proj != NULL) {
 371     Node *mem = init-&gt;in(TypeFunc::Memory);
 372     C-&gt;gvn_replace_by(mem_proj, mem);
 373   }
 374   C-&gt;gvn_replace_by(init, C-&gt;top());
 375   init-&gt;disconnect_inputs(NULL, C);
 376 }
 377 
 378 Node_List PhaseStringOpts::collect_toString_calls() {
 379   Node_List string_calls;
 380   Node_List worklist;
 381 
<span class="line-modified"> 382   _visited.Clear();</span>
 383 
 384   // Prime the worklist
 385   for (uint i = 1; i &lt; C-&gt;root()-&gt;len(); i++) {
 386     Node* n = C-&gt;root()-&gt;in(i);
 387     if (n != NULL &amp;&amp; !_visited.test_set(n-&gt;_idx)) {
 388       worklist.push(n);
 389     }
 390   }
 391 
 392   while (worklist.size() &gt; 0) {
 393     Node* ctrl = worklist.pop();
 394     if (StringConcat::is_SB_toString(ctrl)) {
 395       CallStaticJavaNode* csj = ctrl-&gt;as_CallStaticJava();
 396       string_calls.push(csj);
 397     }
 398     if (ctrl-&gt;in(0) != NULL &amp;&amp; !_visited.test_set(ctrl-&gt;in(0)-&gt;_idx)) {
 399       worklist.push(ctrl-&gt;in(0));
 400     }
 401     if (ctrl-&gt;is_Region()) {
 402       for (uint i = 1; i &lt; ctrl-&gt;len(); i++) {
</pre>
<hr />
<pre>
1016         fail = true;
1017       }
1018 #ifndef PRODUCT
1019       if (PrintOptimizeStringConcat) {
1020         ptr-&gt;dump();
1021       }
1022 #endif
1023       ptr = ptr-&gt;in(0);
1024     }
1025   }
1026 #ifndef PRODUCT
1027   if (PrintOptimizeStringConcat &amp;&amp; fail) {
1028     tty-&gt;cr();
1029   }
1030 #endif
1031   if (fail) return !fail;
1032 
1033   // Validate that all these results produced are contained within
1034   // this cluster of objects.  First collect all the results produced
1035   // by calls in the region.
<span class="line-modified">1036   _stringopts-&gt;_visited.Clear();</span>
1037   Node_List worklist;
1038   Node* final_result = _end-&gt;proj_out_or_null(TypeFunc::Parms);
1039   for (uint i = 0; i &lt; _control.size(); i++) {
1040     CallNode* cnode = _control.at(i)-&gt;isa_Call();
1041     if (cnode != NULL) {
1042       _stringopts-&gt;_visited.test_set(cnode-&gt;_idx);
1043     }
1044     Node* result = cnode != NULL ? cnode-&gt;proj_out_or_null(TypeFunc::Parms) : NULL;
1045     if (result != NULL &amp;&amp; result != final_result) {
1046       worklist.push(result);
1047     }
1048   }
1049 
1050   Node* last_result = NULL;
1051   while (worklist.size() &gt; 0) {
1052     Node* result = worklist.pop();
1053     if (_stringopts-&gt;_visited.test_set(result-&gt;_idx))
1054       continue;
1055     for (SimpleDUIterator i(result); i.has_next(); i.next()) {
1056       Node *use = i.get();
</pre>
<hr />
<pre>
1195     C-&gt;record_for_igvn(phi);
1196     C-&gt;record_for_igvn(size);
1197 
1198     // for (int i=0; ; i++)
1199     //   if (x &lt;= sizeTable[i])
1200     //     return i+1;
1201 
1202     // Add loop predicate first.
1203     kit.add_predicate();
1204 
1205     RegionNode *loop = new RegionNode(3);
1206     loop-&gt;init_req(1, kit.control());
1207     kit.gvn().set_type(loop, Type::CONTROL);
1208 
1209     Node *index = new PhiNode(loop, TypeInt::INT);
1210     index-&gt;init_req(1, __ intcon(0));
1211     kit.gvn().set_type(index, TypeInt::INT);
1212     kit.set_control(loop);
1213     Node* sizeTable = fetch_static_field(kit, size_table_field);
1214 
<span class="line-removed">1215     sizeTable = kit.access_resolve(sizeTable, ACCESS_READ);</span>
1216     Node* value = kit.load_array_element(NULL, sizeTable, index, TypeAryPtr::INTS);
1217     C-&gt;record_for_igvn(value);
1218     Node* limit = __ CmpI(phi, value);
1219     Node* limitb = __ Bool(limit, BoolTest::le);
1220     IfNode* iff2 = kit.create_and_map_if(kit.control(), limitb, PROB_MIN, COUNT_UNKNOWN);
1221     Node* lessEqual = __ IfTrue(iff2);
1222     Node* greater = __ IfFalse(iff2);
1223 
1224     loop-&gt;init_req(2, greater);
1225     index-&gt;init_req(2, __ AddI(index, __ intcon(1)));
1226 
1227     kit.set_control(lessEqual);
1228     C-&gt;record_for_igvn(loop);
1229     C-&gt;record_for_igvn(index);
1230 
1231     final_merge-&gt;init_req(2, kit.control());
1232     final_size-&gt;init_req(2, __ AddI(__ AddI(index, size), __ intcon(1)));
1233   }
1234 
1235   kit.set_control(final_merge);
</pre>
<hr />
<pre>
1531         val = src_array-&gt;byte_at(i) &amp; 0xff;
1532       } else {
1533         val = readChar(src_array, i++);
1534       }
1535       __ store(__ ctrl(), adr, __ ConI(val), T_CHAR, byte_adr_idx, MemNode::unordered, true /* mismatched */);
1536       index = __ AddI(index, __ ConI(2));
1537     }
1538     if (src_is_byte) {
1539       // Multiply count by two since we now need two bytes per char
1540       __ set(count, __ ConI(2 * length));
1541     }
1542   }
1543   if (!dcon) {
1544     __ end_if();
1545   }
1546 }
1547 
1548 // Compress copy contents of the byte/char String str into dst_array starting at index start.
1549 Node* PhaseStringOpts::copy_string(GraphKit&amp; kit, Node* str, Node* dst_array, Node* dst_coder, Node* start) {
1550   Node* src_array = kit.load_String_value(str, true);
<span class="line-removed">1551   src_array = kit.access_resolve(src_array, ACCESS_READ);</span>
1552 
1553   IdealKit ideal(&amp;kit, true, true);
1554   IdealVariable count(ideal); __ declarations_done();
1555 
1556   if (str-&gt;is_Con()) {
1557     // Constant source string
1558     ciTypeArray* src_array_type = get_constant_value(kit, str);
1559 
1560     // Check encoding of constant string
1561     bool src_is_byte = (get_constant_coder(kit, str) == java_lang_String::CODER_LATIN1);
1562 
1563     // For small constant strings just emit individual stores.
1564     // A length of 6 seems like a good space/speed tradeof.
1565     __ set(count, __ ConI(src_array_type-&gt;length()));
1566     int src_len = src_array_type-&gt;length() / (src_is_byte ? 1 : 2);
1567     if (src_len &lt; unroll_string_copy_length) {
1568       // Small constant string
1569       copy_constant_string(kit, ideal, src_array_type, count, src_is_byte, dst_array, dst_coder, start);
1570     } else if (src_is_byte) {
1571       // Source is Latin1
</pre>
</td>
<td>
<hr />
<pre>
 362   // Eliminate Initialize node.
 363   assert(init-&gt;outcnt() &lt;= 2, &quot;only a control and memory projection expected&quot;);
 364   assert(init-&gt;req() &lt;= InitializeNode::RawStores, &quot;no pending inits&quot;);
 365   Node *ctrl_proj = init-&gt;proj_out_or_null(TypeFunc::Control);
 366   if (ctrl_proj != NULL) {
 367     C-&gt;gvn_replace_by(ctrl_proj, init-&gt;in(TypeFunc::Control));
 368   }
 369   Node *mem_proj = init-&gt;proj_out_or_null(TypeFunc::Memory);
 370   if (mem_proj != NULL) {
 371     Node *mem = init-&gt;in(TypeFunc::Memory);
 372     C-&gt;gvn_replace_by(mem_proj, mem);
 373   }
 374   C-&gt;gvn_replace_by(init, C-&gt;top());
 375   init-&gt;disconnect_inputs(NULL, C);
 376 }
 377 
 378 Node_List PhaseStringOpts::collect_toString_calls() {
 379   Node_List string_calls;
 380   Node_List worklist;
 381 
<span class="line-modified"> 382   _visited.clear();</span>
 383 
 384   // Prime the worklist
 385   for (uint i = 1; i &lt; C-&gt;root()-&gt;len(); i++) {
 386     Node* n = C-&gt;root()-&gt;in(i);
 387     if (n != NULL &amp;&amp; !_visited.test_set(n-&gt;_idx)) {
 388       worklist.push(n);
 389     }
 390   }
 391 
 392   while (worklist.size() &gt; 0) {
 393     Node* ctrl = worklist.pop();
 394     if (StringConcat::is_SB_toString(ctrl)) {
 395       CallStaticJavaNode* csj = ctrl-&gt;as_CallStaticJava();
 396       string_calls.push(csj);
 397     }
 398     if (ctrl-&gt;in(0) != NULL &amp;&amp; !_visited.test_set(ctrl-&gt;in(0)-&gt;_idx)) {
 399       worklist.push(ctrl-&gt;in(0));
 400     }
 401     if (ctrl-&gt;is_Region()) {
 402       for (uint i = 1; i &lt; ctrl-&gt;len(); i++) {
</pre>
<hr />
<pre>
1016         fail = true;
1017       }
1018 #ifndef PRODUCT
1019       if (PrintOptimizeStringConcat) {
1020         ptr-&gt;dump();
1021       }
1022 #endif
1023       ptr = ptr-&gt;in(0);
1024     }
1025   }
1026 #ifndef PRODUCT
1027   if (PrintOptimizeStringConcat &amp;&amp; fail) {
1028     tty-&gt;cr();
1029   }
1030 #endif
1031   if (fail) return !fail;
1032 
1033   // Validate that all these results produced are contained within
1034   // this cluster of objects.  First collect all the results produced
1035   // by calls in the region.
<span class="line-modified">1036   _stringopts-&gt;_visited.clear();</span>
1037   Node_List worklist;
1038   Node* final_result = _end-&gt;proj_out_or_null(TypeFunc::Parms);
1039   for (uint i = 0; i &lt; _control.size(); i++) {
1040     CallNode* cnode = _control.at(i)-&gt;isa_Call();
1041     if (cnode != NULL) {
1042       _stringopts-&gt;_visited.test_set(cnode-&gt;_idx);
1043     }
1044     Node* result = cnode != NULL ? cnode-&gt;proj_out_or_null(TypeFunc::Parms) : NULL;
1045     if (result != NULL &amp;&amp; result != final_result) {
1046       worklist.push(result);
1047     }
1048   }
1049 
1050   Node* last_result = NULL;
1051   while (worklist.size() &gt; 0) {
1052     Node* result = worklist.pop();
1053     if (_stringopts-&gt;_visited.test_set(result-&gt;_idx))
1054       continue;
1055     for (SimpleDUIterator i(result); i.has_next(); i.next()) {
1056       Node *use = i.get();
</pre>
<hr />
<pre>
1195     C-&gt;record_for_igvn(phi);
1196     C-&gt;record_for_igvn(size);
1197 
1198     // for (int i=0; ; i++)
1199     //   if (x &lt;= sizeTable[i])
1200     //     return i+1;
1201 
1202     // Add loop predicate first.
1203     kit.add_predicate();
1204 
1205     RegionNode *loop = new RegionNode(3);
1206     loop-&gt;init_req(1, kit.control());
1207     kit.gvn().set_type(loop, Type::CONTROL);
1208 
1209     Node *index = new PhiNode(loop, TypeInt::INT);
1210     index-&gt;init_req(1, __ intcon(0));
1211     kit.gvn().set_type(index, TypeInt::INT);
1212     kit.set_control(loop);
1213     Node* sizeTable = fetch_static_field(kit, size_table_field);
1214 

1215     Node* value = kit.load_array_element(NULL, sizeTable, index, TypeAryPtr::INTS);
1216     C-&gt;record_for_igvn(value);
1217     Node* limit = __ CmpI(phi, value);
1218     Node* limitb = __ Bool(limit, BoolTest::le);
1219     IfNode* iff2 = kit.create_and_map_if(kit.control(), limitb, PROB_MIN, COUNT_UNKNOWN);
1220     Node* lessEqual = __ IfTrue(iff2);
1221     Node* greater = __ IfFalse(iff2);
1222 
1223     loop-&gt;init_req(2, greater);
1224     index-&gt;init_req(2, __ AddI(index, __ intcon(1)));
1225 
1226     kit.set_control(lessEqual);
1227     C-&gt;record_for_igvn(loop);
1228     C-&gt;record_for_igvn(index);
1229 
1230     final_merge-&gt;init_req(2, kit.control());
1231     final_size-&gt;init_req(2, __ AddI(__ AddI(index, size), __ intcon(1)));
1232   }
1233 
1234   kit.set_control(final_merge);
</pre>
<hr />
<pre>
1530         val = src_array-&gt;byte_at(i) &amp; 0xff;
1531       } else {
1532         val = readChar(src_array, i++);
1533       }
1534       __ store(__ ctrl(), adr, __ ConI(val), T_CHAR, byte_adr_idx, MemNode::unordered, true /* mismatched */);
1535       index = __ AddI(index, __ ConI(2));
1536     }
1537     if (src_is_byte) {
1538       // Multiply count by two since we now need two bytes per char
1539       __ set(count, __ ConI(2 * length));
1540     }
1541   }
1542   if (!dcon) {
1543     __ end_if();
1544   }
1545 }
1546 
1547 // Compress copy contents of the byte/char String str into dst_array starting at index start.
1548 Node* PhaseStringOpts::copy_string(GraphKit&amp; kit, Node* str, Node* dst_array, Node* dst_coder, Node* start) {
1549   Node* src_array = kit.load_String_value(str, true);

1550 
1551   IdealKit ideal(&amp;kit, true, true);
1552   IdealVariable count(ideal); __ declarations_done();
1553 
1554   if (str-&gt;is_Con()) {
1555     // Constant source string
1556     ciTypeArray* src_array_type = get_constant_value(kit, str);
1557 
1558     // Check encoding of constant string
1559     bool src_is_byte = (get_constant_coder(kit, str) == java_lang_String::CODER_LATIN1);
1560 
1561     // For small constant strings just emit individual stores.
1562     // A length of 6 seems like a good space/speed tradeof.
1563     __ set(count, __ ConI(src_array_type-&gt;length()));
1564     int src_len = src_array_type-&gt;length() / (src_is_byte ? 1 : 2);
1565     if (src_len &lt; unroll_string_copy_length) {
1566       // Small constant string
1567       copy_constant_string(kit, ideal, src_array_type, count, src_is_byte, dst_array, dst_coder, start);
1568     } else if (src_is_byte) {
1569       // Source is Latin1
</pre>
</td>
</tr>
</table>
<center><a href="split_if.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="subnode.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>