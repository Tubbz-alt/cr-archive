<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/opto/split_if.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="runtime.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="stringopts.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/split_if.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 108,87 ***</span>
        if( PrintOpto &amp;&amp; VerifyLoopOptimizations ) {
          tty-&gt;print(&quot;Cloning down: &quot;);
          n-&gt;dump();
        }
  #endif
<span class="line-modified">!       // Clone down any block-local BoolNode uses of this CmpNode</span>
<span class="line-modified">!       for (DUIterator i = n-&gt;outs(); n-&gt;has_out(i); i++) {</span>
<span class="line-modified">!         Node* bol = n-&gt;out(i);</span>
<span class="line-modified">!         assert( bol-&gt;is_Bool(), &quot;&quot; );</span>
<span class="line-modified">!         if (bol-&gt;outcnt() == 1) {</span>
<span class="line-modified">!           Node* use = bol-&gt;unique_out();</span>
<span class="line-modified">!           if (use-&gt;Opcode() == Op_Opaque4) {</span>
<span class="line-modified">!             if (use-&gt;outcnt() == 1) {</span>
<span class="line-modified">!               Node* iff = use-&gt;unique_out();</span>
<span class="line-modified">!               assert(iff-&gt;is_If(), &quot;unexpected node type&quot;);</span>
<span class="line-modified">!               Node *use_c = iff-&gt;in(0);</span>
                if (use_c == blk1 || use_c == blk2) {
                  continue;
                }
              }
<span class="line-removed">-           } else {</span>
<span class="line-removed">-             // We might see an Opaque1 from a loop limit check here</span>
<span class="line-removed">-             assert(use-&gt;is_If() || use-&gt;is_CMove() || use-&gt;Opcode() == Op_Opaque1, &quot;unexpected node type&quot;);</span>
<span class="line-removed">-             Node *use_c = use-&gt;is_If() ? use-&gt;in(0) : get_ctrl(use);</span>
<span class="line-removed">-             if (use_c == blk1 || use_c == blk2) {</span>
<span class="line-removed">-               assert(use-&gt;is_CMove(), &quot;unexpected node type&quot;);</span>
<span class="line-removed">-               continue;</span>
<span class="line-removed">-             }</span>
            }
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (get_ctrl(bol) == blk1 || get_ctrl(bol) == blk2) {</span>
<span class="line-removed">-           // Recursively sink any BoolNode</span>
  #ifndef PRODUCT
<span class="line-modified">!           if( PrintOpto &amp;&amp; VerifyLoopOptimizations ) {</span>
<span class="line-modified">!             tty-&gt;print(&quot;Cloning down: &quot;);</span>
<span class="line-modified">!             bol-&gt;dump();</span>
<span class="line-modified">!           }</span>
  #endif
<span class="line-modified">!           for (DUIterator j = bol-&gt;outs(); bol-&gt;has_out(j); j++) {</span>
<span class="line-modified">!             Node* u = bol-&gt;out(j);</span>
<span class="line-modified">!             // Uses are either IfNodes, CMoves or Opaque4</span>
<span class="line-modified">!             if (u-&gt;Opcode() == Op_Opaque4) {</span>
<span class="line-modified">!               assert(u-&gt;in(1) == bol, &quot;bad input&quot;);</span>
<span class="line-modified">!               for (DUIterator_Last kmin, k = u-&gt;last_outs(kmin); k &gt;= kmin; --k) {</span>
<span class="line-modified">!                 Node* iff = u-&gt;last_out(k);</span>
<span class="line-modified">!                 assert(iff-&gt;is_If() || iff-&gt;is_CMove(), &quot;unexpected node type&quot;);</span>
<span class="line-modified">!                 assert( iff-&gt;in(1) == u, &quot;&quot; );</span>
                  // Get control block of either the CMove or the If input
<span class="line-modified">!                 Node *iff_ctrl = iff-&gt;is_If() ? iff-&gt;in(0) : get_ctrl(iff);</span>
<span class="line-modified">!                 Node *x1 = bol-&gt;clone();</span>
<span class="line-modified">!                 Node *x2 = u-&gt;clone();</span>
<span class="line-modified">!                 register_new_node(x1, iff_ctrl);</span>
<span class="line-modified">!                 register_new_node(x2, iff_ctrl);</span>
<span class="line-modified">!                 _igvn.replace_input_of(x2, 1, x1);</span>
<span class="line-removed">-                 _igvn.replace_input_of(iff, 1, x2);</span>
                }
<span class="line-removed">-               _igvn.remove_dead_node(u);</span>
<span class="line-removed">-               --j;</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-               // We might see an Opaque1 from a loop limit check here</span>
<span class="line-removed">-               assert(u-&gt;is_If() || u-&gt;is_CMove() || u-&gt;Opcode() == Op_Opaque1, &quot;unexpected node type&quot;);</span>
<span class="line-removed">-               assert(u-&gt;in(1) == bol, &quot;&quot;);</span>
<span class="line-removed">-               // Get control block of either the CMove or the If input</span>
<span class="line-removed">-               Node *u_ctrl = u-&gt;is_If() ? u-&gt;in(0) : get_ctrl(u);</span>
<span class="line-removed">-               assert((u_ctrl != blk1 &amp;&amp; u_ctrl != blk2) || u-&gt;is_CMove(), &quot;won&#39;t converge&quot;);</span>
<span class="line-removed">-               Node *x = bol-&gt;clone();</span>
<span class="line-removed">-               register_new_node(x, u_ctrl);</span>
<span class="line-removed">-               _igvn.replace_input_of(u, 1, x);</span>
<span class="line-removed">-               --j;</span>
              }
            }
<span class="line-removed">-           _igvn.remove_dead_node(bol);</span>
<span class="line-removed">-           --i;</span>
          }
        }
        // Clone down this CmpNode
        for (DUIterator_Last jmin, j = n-&gt;last_outs(jmin); j &gt;= jmin; --j) {
<span class="line-modified">!         Node* bol = n-&gt;last_out(j);</span>
<span class="line-modified">!         assert( bol-&gt;in(1) == n, &quot;&quot; );</span>
          Node *x = n-&gt;clone();
<span class="line-modified">!         register_new_node(x, get_ctrl(bol));</span>
<span class="line-modified">!         _igvn.replace_input_of(bol, 1, x);</span>
        }
        _igvn.remove_dead_node( n );
  
        return true;
      }
<span class="line-new-header">--- 108,94 ---</span>
        if( PrintOpto &amp;&amp; VerifyLoopOptimizations ) {
          tty-&gt;print(&quot;Cloning down: &quot;);
          n-&gt;dump();
        }
  #endif
<span class="line-modified">!       if (!n-&gt;is_FastLock()) {</span>
<span class="line-modified">!         // Clone down any block-local BoolNode uses of this CmpNode</span>
<span class="line-modified">!         for (DUIterator i = n-&gt;outs(); n-&gt;has_out(i); i++) {</span>
<span class="line-modified">!           Node* bol = n-&gt;out(i);</span>
<span class="line-modified">!           assert( bol-&gt;is_Bool(), &quot;&quot; );</span>
<span class="line-modified">!           if (bol-&gt;outcnt() == 1) {</span>
<span class="line-modified">!             Node* use = bol-&gt;unique_out();</span>
<span class="line-modified">!             if (use-&gt;Opcode() == Op_Opaque4) {</span>
<span class="line-modified">!               if (use-&gt;outcnt() == 1) {</span>
<span class="line-modified">!                 Node* iff = use-&gt;unique_out();</span>
<span class="line-modified">!                 assert(iff-&gt;is_If(), &quot;unexpected node type&quot;);</span>
<span class="line-added">+                 Node *use_c = iff-&gt;in(0);</span>
<span class="line-added">+                 if (use_c == blk1 || use_c == blk2) {</span>
<span class="line-added">+                   continue;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+               }</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+               // We might see an Opaque1 from a loop limit check here</span>
<span class="line-added">+               assert(use-&gt;is_If() || use-&gt;is_CMove() || use-&gt;Opcode() == Op_Opaque1, &quot;unexpected node type&quot;);</span>
<span class="line-added">+               Node *use_c = use-&gt;is_If() ? use-&gt;in(0) : get_ctrl(use);</span>
                if (use_c == blk1 || use_c == blk2) {
<span class="line-added">+                 assert(use-&gt;is_CMove(), &quot;unexpected node type&quot;);</span>
                  continue;
                }
              }
            }
<span class="line-modified">!           if (get_ctrl(bol) == blk1 || get_ctrl(bol) == blk2) {</span>
<span class="line-modified">!             // Recursively sink any BoolNode</span>
  #ifndef PRODUCT
<span class="line-modified">!             if( PrintOpto &amp;&amp; VerifyLoopOptimizations ) {</span>
<span class="line-modified">!               tty-&gt;print(&quot;Cloning down: &quot;);</span>
<span class="line-modified">!               bol-&gt;dump();</span>
<span class="line-modified">!             }</span>
  #endif
<span class="line-modified">!             for (DUIterator j = bol-&gt;outs(); bol-&gt;has_out(j); j++) {</span>
<span class="line-modified">!               Node* u = bol-&gt;out(j);</span>
<span class="line-modified">!               // Uses are either IfNodes, CMoves or Opaque4</span>
<span class="line-modified">!               if (u-&gt;Opcode() == Op_Opaque4) {</span>
<span class="line-modified">!                 assert(u-&gt;in(1) == bol, &quot;bad input&quot;);</span>
<span class="line-modified">!                 for (DUIterator_Last kmin, k = u-&gt;last_outs(kmin); k &gt;= kmin; --k) {</span>
<span class="line-modified">!                   Node* iff = u-&gt;last_out(k);</span>
<span class="line-modified">!                   assert(iff-&gt;is_If() || iff-&gt;is_CMove(), &quot;unexpected node type&quot;);</span>
<span class="line-modified">!                   assert( iff-&gt;in(1) == u, &quot;&quot; );</span>
<span class="line-added">+                   // Get control block of either the CMove or the If input</span>
<span class="line-added">+                   Node *iff_ctrl = iff-&gt;is_If() ? iff-&gt;in(0) : get_ctrl(iff);</span>
<span class="line-added">+                   Node *x1 = bol-&gt;clone();</span>
<span class="line-added">+                   Node *x2 = u-&gt;clone();</span>
<span class="line-added">+                   register_new_node(x1, iff_ctrl);</span>
<span class="line-added">+                   register_new_node(x2, iff_ctrl);</span>
<span class="line-added">+                   _igvn.replace_input_of(x2, 1, x1);</span>
<span class="line-added">+                   _igvn.replace_input_of(iff, 1, x2);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 _igvn.remove_dead_node(u);</span>
<span class="line-added">+                 --j;</span>
<span class="line-added">+               } else {</span>
<span class="line-added">+                 // We might see an Opaque1 from a loop limit check here</span>
<span class="line-added">+                 assert(u-&gt;is_If() || u-&gt;is_CMove() || u-&gt;Opcode() == Op_Opaque1, &quot;unexpected node type&quot;);</span>
<span class="line-added">+                 assert(u-&gt;in(1) == bol, &quot;&quot;);</span>
                  // Get control block of either the CMove or the If input
<span class="line-modified">!                 Node *u_ctrl = u-&gt;is_If() ? u-&gt;in(0) : get_ctrl(u);</span>
<span class="line-modified">!                 assert((u_ctrl != blk1 &amp;&amp; u_ctrl != blk2) || u-&gt;is_CMove(), &quot;won&#39;t converge&quot;);</span>
<span class="line-modified">!                 Node *x = bol-&gt;clone();</span>
<span class="line-modified">!                 register_new_node(x, u_ctrl);</span>
<span class="line-modified">!                 _igvn.replace_input_of(u, 1, x);</span>
<span class="line-modified">!                 --j;</span>
                }
              }
<span class="line-added">+             _igvn.remove_dead_node(bol);</span>
<span class="line-added">+             --i;</span>
            }
          }
        }
        // Clone down this CmpNode
        for (DUIterator_Last jmin, j = n-&gt;last_outs(jmin); j &gt;= jmin; --j) {
<span class="line-modified">!         Node* use = n-&gt;last_out(j);</span>
<span class="line-modified">!         uint pos = 1;</span>
<span class="line-added">+         if (n-&gt;is_FastLock()) {</span>
<span class="line-added">+           pos = TypeFunc::Parms + 2;</span>
<span class="line-added">+           assert(use-&gt;is_Lock(), &quot;FastLock only used by LockNode&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         assert(use-&gt;in(pos) == n, &quot;&quot; );</span>
          Node *x = n-&gt;clone();
<span class="line-modified">!         register_new_node(x, ctrl_or_self(use));</span>
<span class="line-modified">!         _igvn.replace_input_of(use, pos, x);</span>
        }
        _igvn.remove_dead_node( n );
  
        return true;
      }
</pre>
<center><a href="runtime.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="stringopts.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>