<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/graphKit.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciUtilities.hpp&quot;
  27 #include &quot;compiler/compileLog.hpp&quot;
  28 #include &quot;gc/shared/barrierSet.hpp&quot;
  29 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
  30 #include &quot;interpreter/interpreter.hpp&quot;
  31 #include &quot;memory/resourceArea.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/castnode.hpp&quot;
  34 #include &quot;opto/convertnode.hpp&quot;
  35 #include &quot;opto/graphKit.hpp&quot;
  36 #include &quot;opto/idealKit.hpp&quot;
  37 #include &quot;opto/intrinsicnode.hpp&quot;
  38 #include &quot;opto/locknode.hpp&quot;
  39 #include &quot;opto/machnode.hpp&quot;
  40 #include &quot;opto/opaquenode.hpp&quot;
  41 #include &quot;opto/parse.hpp&quot;
  42 #include &quot;opto/rootnode.hpp&quot;
  43 #include &quot;opto/runtime.hpp&quot;
<a name="1" id="anc1"></a>
  44 #include &quot;runtime/deoptimization.hpp&quot;
  45 #include &quot;runtime/sharedRuntime.hpp&quot;
<a name="2" id="anc2"></a>

  46 
  47 //----------------------------GraphKit-----------------------------------------
  48 // Main utility constructor.
  49 GraphKit::GraphKit(JVMState* jvms)
  50   : Phase(Phase::Parser),
  51     _env(C-&gt;env()),
  52     _gvn(*C-&gt;initial_gvn()),
  53     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  54 {
  55   _exceptions = jvms-&gt;map()-&gt;next_exception();
  56   if (_exceptions != NULL)  jvms-&gt;map()-&gt;set_next_exception(NULL);
  57   set_jvms(jvms);
  58 }
  59 
  60 // Private constructor for parser.
  61 GraphKit::GraphKit()
  62   : Phase(Phase::Parser),
  63     _env(C-&gt;env()),
  64     _gvn(*C-&gt;initial_gvn()),
  65     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  66 {
  67   _exceptions = NULL;
  68   set_map(NULL);
  69   debug_only(_sp = -99);
  70   debug_only(set_bci(-99));
  71 }
  72 
  73 
  74 
  75 //---------------------------clean_stack---------------------------------------
  76 // Clear away rubbish from the stack area of the JVM state.
  77 // This destroys any arguments that may be waiting on the stack.
  78 void GraphKit::clean_stack(int from_sp) {
  79   SafePointNode* map      = this-&gt;map();
  80   JVMState*      jvms     = this-&gt;jvms();
  81   int            stk_size = jvms-&gt;stk_size();
  82   int            stkoff   = jvms-&gt;stkoff();
  83   Node*          top      = this-&gt;top();
  84   for (int i = from_sp; i &lt; stk_size; i++) {
  85     if (map-&gt;in(stkoff + i) != top) {
  86       map-&gt;set_req(stkoff + i, top);
  87     }
  88   }
  89 }
  90 
  91 
  92 //--------------------------------sync_jvms-----------------------------------
  93 // Make sure our current jvms agrees with our parse state.
  94 JVMState* GraphKit::sync_jvms() const {
  95   JVMState* jvms = this-&gt;jvms();
  96   jvms-&gt;set_bci(bci());       // Record the new bci in the JVMState
  97   jvms-&gt;set_sp(sp());         // Record the new sp in the JVMState
  98   assert(jvms_in_sync(), &quot;jvms is now in sync&quot;);
  99   return jvms;
 100 }
 101 
 102 //--------------------------------sync_jvms_for_reexecute---------------------
 103 // Make sure our current jvms agrees with our parse state.  This version
 104 // uses the reexecute_sp for reexecuting bytecodes.
 105 JVMState* GraphKit::sync_jvms_for_reexecute() {
 106   JVMState* jvms = this-&gt;jvms();
 107   jvms-&gt;set_bci(bci());          // Record the new bci in the JVMState
 108   jvms-&gt;set_sp(reexecute_sp());  // Record the new sp in the JVMState
 109   return jvms;
 110 }
 111 
 112 #ifdef ASSERT
 113 bool GraphKit::jvms_in_sync() const {
 114   Parse* parse = is_Parse();
 115   if (parse == NULL) {
 116     if (bci() !=      jvms()-&gt;bci())          return false;
 117     if (sp()  != (int)jvms()-&gt;sp())           return false;
 118     return true;
 119   }
 120   if (jvms()-&gt;method() != parse-&gt;method())    return false;
 121   if (jvms()-&gt;bci()    != parse-&gt;bci())       return false;
 122   int jvms_sp = jvms()-&gt;sp();
 123   if (jvms_sp          != parse-&gt;sp())        return false;
 124   int jvms_depth = jvms()-&gt;depth();
 125   if (jvms_depth       != parse-&gt;depth())     return false;
 126   return true;
 127 }
 128 
 129 // Local helper checks for special internal merge points
 130 // used to accumulate and merge exception states.
 131 // They are marked by the region&#39;s in(0) edge being the map itself.
 132 // Such merge points must never &quot;escape&quot; into the parser at large,
 133 // until they have been handed to gvn.transform.
 134 static bool is_hidden_merge(Node* reg) {
 135   if (reg == NULL)  return false;
 136   if (reg-&gt;is_Phi()) {
 137     reg = reg-&gt;in(0);
 138     if (reg == NULL)  return false;
 139   }
 140   return reg-&gt;is_Region() &amp;&amp; reg-&gt;in(0) != NULL &amp;&amp; reg-&gt;in(0)-&gt;is_Root();
 141 }
 142 
 143 void GraphKit::verify_map() const {
 144   if (map() == NULL)  return;  // null map is OK
 145   assert(map()-&gt;req() &lt;= jvms()-&gt;endoff(), &quot;no extra garbage on map&quot;);
 146   assert(!map()-&gt;has_exceptions(),    &quot;call add_exception_states_from 1st&quot;);
 147   assert(!is_hidden_merge(control()), &quot;call use_exception_state, not set_map&quot;);
 148 }
 149 
 150 void GraphKit::verify_exception_state(SafePointNode* ex_map) {
 151   assert(ex_map-&gt;next_exception() == NULL, &quot;not already part of a chain&quot;);
 152   assert(has_saved_ex_oop(ex_map), &quot;every exception state has an ex_oop&quot;);
 153 }
 154 #endif
 155 
 156 //---------------------------stop_and_kill_map---------------------------------
 157 // Set _map to NULL, signalling a stop to further bytecode execution.
 158 // First smash the current map&#39;s control to a constant, to mark it dead.
 159 void GraphKit::stop_and_kill_map() {
 160   SafePointNode* dead_map = stop();
 161   if (dead_map != NULL) {
 162     dead_map-&gt;disconnect_inputs(NULL, C); // Mark the map as killed.
 163     assert(dead_map-&gt;is_killed(), &quot;must be so marked&quot;);
 164   }
 165 }
 166 
 167 
 168 //--------------------------------stopped--------------------------------------
 169 // Tell if _map is NULL, or control is top.
 170 bool GraphKit::stopped() {
 171   if (map() == NULL)           return true;
 172   else if (control() == top()) return true;
 173   else                         return false;
 174 }
 175 
 176 
 177 //-----------------------------has_ex_handler----------------------------------
 178 // Tell if this method or any caller method has exception handlers.
 179 bool GraphKit::has_ex_handler() {
 180   for (JVMState* jvmsp = jvms(); jvmsp != NULL; jvmsp = jvmsp-&gt;caller()) {
 181     if (jvmsp-&gt;has_method() &amp;&amp; jvmsp-&gt;method()-&gt;has_exception_handlers()) {
 182       return true;
 183     }
 184   }
 185   return false;
 186 }
 187 
 188 //------------------------------save_ex_oop------------------------------------
 189 // Save an exception without blowing stack contents or other JVM state.
 190 void GraphKit::set_saved_ex_oop(SafePointNode* ex_map, Node* ex_oop) {
 191   assert(!has_saved_ex_oop(ex_map), &quot;clear ex-oop before setting again&quot;);
 192   ex_map-&gt;add_req(ex_oop);
 193   debug_only(verify_exception_state(ex_map));
 194 }
 195 
 196 inline static Node* common_saved_ex_oop(SafePointNode* ex_map, bool clear_it) {
 197   assert(GraphKit::has_saved_ex_oop(ex_map), &quot;ex_oop must be there&quot;);
 198   Node* ex_oop = ex_map-&gt;in(ex_map-&gt;req()-1);
 199   if (clear_it)  ex_map-&gt;del_req(ex_map-&gt;req()-1);
 200   return ex_oop;
 201 }
 202 
 203 //-----------------------------saved_ex_oop------------------------------------
 204 // Recover a saved exception from its map.
 205 Node* GraphKit::saved_ex_oop(SafePointNode* ex_map) {
 206   return common_saved_ex_oop(ex_map, false);
 207 }
 208 
 209 //--------------------------clear_saved_ex_oop---------------------------------
 210 // Erase a previously saved exception from its map.
 211 Node* GraphKit::clear_saved_ex_oop(SafePointNode* ex_map) {
 212   return common_saved_ex_oop(ex_map, true);
 213 }
 214 
 215 #ifdef ASSERT
 216 //---------------------------has_saved_ex_oop----------------------------------
 217 // Erase a previously saved exception from its map.
 218 bool GraphKit::has_saved_ex_oop(SafePointNode* ex_map) {
 219   return ex_map-&gt;req() == ex_map-&gt;jvms()-&gt;endoff()+1;
 220 }
 221 #endif
 222 
 223 //-------------------------make_exception_state--------------------------------
 224 // Turn the current JVM state into an exception state, appending the ex_oop.
 225 SafePointNode* GraphKit::make_exception_state(Node* ex_oop) {
 226   sync_jvms();
 227   SafePointNode* ex_map = stop();  // do not manipulate this map any more
 228   set_saved_ex_oop(ex_map, ex_oop);
 229   return ex_map;
 230 }
 231 
 232 
 233 //--------------------------add_exception_state--------------------------------
 234 // Add an exception to my list of exceptions.
 235 void GraphKit::add_exception_state(SafePointNode* ex_map) {
 236   if (ex_map == NULL || ex_map-&gt;control() == top()) {
 237     return;
 238   }
 239 #ifdef ASSERT
 240   verify_exception_state(ex_map);
 241   if (has_exceptions()) {
 242     assert(ex_map-&gt;jvms()-&gt;same_calls_as(_exceptions-&gt;jvms()), &quot;all collected exceptions must come from the same place&quot;);
 243   }
 244 #endif
 245 
 246   // If there is already an exception of exactly this type, merge with it.
 247   // In particular, null-checks and other low-level exceptions common up here.
 248   Node*       ex_oop  = saved_ex_oop(ex_map);
 249   const Type* ex_type = _gvn.type(ex_oop);
 250   if (ex_oop == top()) {
 251     // No action needed.
 252     return;
 253   }
 254   assert(ex_type-&gt;isa_instptr(), &quot;exception must be an instance&quot;);
 255   for (SafePointNode* e2 = _exceptions; e2 != NULL; e2 = e2-&gt;next_exception()) {
 256     const Type* ex_type2 = _gvn.type(saved_ex_oop(e2));
 257     // We check sp also because call bytecodes can generate exceptions
 258     // both before and after arguments are popped!
 259     if (ex_type2 == ex_type
 260         &amp;&amp; e2-&gt;_jvms-&gt;sp() == ex_map-&gt;_jvms-&gt;sp()) {
 261       combine_exception_states(ex_map, e2);
 262       return;
 263     }
 264   }
 265 
 266   // No pre-existing exception of the same type.  Chain it on the list.
 267   push_exception_state(ex_map);
 268 }
 269 
 270 //-----------------------add_exception_states_from-----------------------------
 271 void GraphKit::add_exception_states_from(JVMState* jvms) {
 272   SafePointNode* ex_map = jvms-&gt;map()-&gt;next_exception();
 273   if (ex_map != NULL) {
 274     jvms-&gt;map()-&gt;set_next_exception(NULL);
 275     for (SafePointNode* next_map; ex_map != NULL; ex_map = next_map) {
 276       next_map = ex_map-&gt;next_exception();
 277       ex_map-&gt;set_next_exception(NULL);
 278       add_exception_state(ex_map);
 279     }
 280   }
 281 }
 282 
 283 //-----------------------transfer_exceptions_into_jvms-------------------------
 284 JVMState* GraphKit::transfer_exceptions_into_jvms() {
 285   if (map() == NULL) {
 286     // We need a JVMS to carry the exceptions, but the map has gone away.
 287     // Create a scratch JVMS, cloned from any of the exception states...
 288     if (has_exceptions()) {
 289       _map = _exceptions;
 290       _map = clone_map();
 291       _map-&gt;set_next_exception(NULL);
 292       clear_saved_ex_oop(_map);
 293       debug_only(verify_map());
 294     } else {
 295       // ...or created from scratch
 296       JVMState* jvms = new (C) JVMState(_method, NULL);
 297       jvms-&gt;set_bci(_bci);
 298       jvms-&gt;set_sp(_sp);
 299       jvms-&gt;set_map(new SafePointNode(TypeFunc::Parms, jvms));
 300       set_jvms(jvms);
 301       for (uint i = 0; i &lt; map()-&gt;req(); i++)  map()-&gt;init_req(i, top());
 302       set_all_memory(top());
 303       while (map()-&gt;req() &lt; jvms-&gt;endoff())  map()-&gt;add_req(top());
 304     }
 305     // (This is a kludge, in case you didn&#39;t notice.)
 306     set_control(top());
 307   }
 308   JVMState* jvms = sync_jvms();
 309   assert(!jvms-&gt;map()-&gt;has_exceptions(), &quot;no exceptions on this map yet&quot;);
 310   jvms-&gt;map()-&gt;set_next_exception(_exceptions);
 311   _exceptions = NULL;   // done with this set of exceptions
 312   return jvms;
 313 }
 314 
 315 static inline void add_n_reqs(Node* dstphi, Node* srcphi) {
 316   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 317   assert(is_hidden_merge(srcphi), &quot;must be a special merge node&quot;);
 318   uint limit = srcphi-&gt;req();
 319   for (uint i = PhiNode::Input; i &lt; limit; i++) {
 320     dstphi-&gt;add_req(srcphi-&gt;in(i));
 321   }
 322 }
 323 static inline void add_one_req(Node* dstphi, Node* src) {
 324   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 325   assert(!is_hidden_merge(src), &quot;must not be a special merge node&quot;);
 326   dstphi-&gt;add_req(src);
 327 }
 328 
 329 //-----------------------combine_exception_states------------------------------
 330 // This helper function combines exception states by building phis on a
 331 // specially marked state-merging region.  These regions and phis are
 332 // untransformed, and can build up gradually.  The region is marked by
 333 // having a control input of its exception map, rather than NULL.  Such
 334 // regions do not appear except in this function, and in use_exception_state.
 335 void GraphKit::combine_exception_states(SafePointNode* ex_map, SafePointNode* phi_map) {
 336   if (failing())  return;  // dying anyway...
 337   JVMState* ex_jvms = ex_map-&gt;_jvms;
 338   assert(ex_jvms-&gt;same_calls_as(phi_map-&gt;_jvms), &quot;consistent call chains&quot;);
 339   assert(ex_jvms-&gt;stkoff() == phi_map-&gt;_jvms-&gt;stkoff(), &quot;matching locals&quot;);
 340   assert(ex_jvms-&gt;sp() == phi_map-&gt;_jvms-&gt;sp(), &quot;matching stack sizes&quot;);
 341   assert(ex_jvms-&gt;monoff() == phi_map-&gt;_jvms-&gt;monoff(), &quot;matching JVMS&quot;);
 342   assert(ex_jvms-&gt;scloff() == phi_map-&gt;_jvms-&gt;scloff(), &quot;matching scalar replaced objects&quot;);
 343   assert(ex_map-&gt;req() == phi_map-&gt;req(), &quot;matching maps&quot;);
 344   uint tos = ex_jvms-&gt;stkoff() + ex_jvms-&gt;sp();
 345   Node*         hidden_merge_mark = root();
 346   Node*         region  = phi_map-&gt;control();
 347   MergeMemNode* phi_mem = phi_map-&gt;merged_memory();
 348   MergeMemNode* ex_mem  = ex_map-&gt;merged_memory();
 349   if (region-&gt;in(0) != hidden_merge_mark) {
 350     // The control input is not (yet) a specially-marked region in phi_map.
 351     // Make it so, and build some phis.
 352     region = new RegionNode(2);
 353     _gvn.set_type(region, Type::CONTROL);
 354     region-&gt;set_req(0, hidden_merge_mark);  // marks an internal ex-state
 355     region-&gt;init_req(1, phi_map-&gt;control());
 356     phi_map-&gt;set_control(region);
 357     Node* io_phi = PhiNode::make(region, phi_map-&gt;i_o(), Type::ABIO);
 358     record_for_igvn(io_phi);
 359     _gvn.set_type(io_phi, Type::ABIO);
 360     phi_map-&gt;set_i_o(io_phi);
 361     for (MergeMemStream mms(phi_mem); mms.next_non_empty(); ) {
 362       Node* m = mms.memory();
 363       Node* m_phi = PhiNode::make(region, m, Type::MEMORY, mms.adr_type(C));
 364       record_for_igvn(m_phi);
 365       _gvn.set_type(m_phi, Type::MEMORY);
 366       mms.set_memory(m_phi);
 367     }
 368   }
 369 
 370   // Either or both of phi_map and ex_map might already be converted into phis.
 371   Node* ex_control = ex_map-&gt;control();
 372   // if there is special marking on ex_map also, we add multiple edges from src
 373   bool add_multiple = (ex_control-&gt;in(0) == hidden_merge_mark);
 374   // how wide was the destination phi_map, originally?
 375   uint orig_width = region-&gt;req();
 376 
 377   if (add_multiple) {
 378     add_n_reqs(region, ex_control);
 379     add_n_reqs(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 380   } else {
 381     // ex_map has no merges, so we just add single edges everywhere
 382     add_one_req(region, ex_control);
 383     add_one_req(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 384   }
 385   for (MergeMemStream mms(phi_mem, ex_mem); mms.next_non_empty2(); ) {
 386     if (mms.is_empty()) {
 387       // get a copy of the base memory, and patch some inputs into it
 388       const TypePtr* adr_type = mms.adr_type(C);
 389       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
 390       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
 391       mms.set_memory(phi);
 392       // Prepare to append interesting stuff onto the newly sliced phi:
 393       while (phi-&gt;req() &gt; orig_width)  phi-&gt;del_req(phi-&gt;req()-1);
 394     }
 395     // Append stuff from ex_map:
 396     if (add_multiple) {
 397       add_n_reqs(mms.memory(), mms.memory2());
 398     } else {
 399       add_one_req(mms.memory(), mms.memory2());
 400     }
 401   }
 402   uint limit = ex_map-&gt;req();
 403   for (uint i = TypeFunc::Parms; i &lt; limit; i++) {
 404     // Skip everything in the JVMS after tos.  (The ex_oop follows.)
 405     if (i == tos)  i = ex_jvms-&gt;monoff();
 406     Node* src = ex_map-&gt;in(i);
 407     Node* dst = phi_map-&gt;in(i);
 408     if (src != dst) {
 409       PhiNode* phi;
 410       if (dst-&gt;in(0) != region) {
 411         dst = phi = PhiNode::make(region, dst, _gvn.type(dst));
 412         record_for_igvn(phi);
 413         _gvn.set_type(phi, phi-&gt;type());
 414         phi_map-&gt;set_req(i, dst);
 415         // Prepare to append interesting stuff onto the new phi:
 416         while (dst-&gt;req() &gt; orig_width)  dst-&gt;del_req(dst-&gt;req()-1);
 417       } else {
 418         assert(dst-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 419         phi = dst-&gt;as_Phi();
 420       }
 421       if (add_multiple &amp;&amp; src-&gt;in(0) == ex_control) {
 422         // Both are phis.
 423         add_n_reqs(dst, src);
 424       } else {
 425         while (dst-&gt;req() &lt; region-&gt;req())  add_one_req(dst, src);
 426       }
 427       const Type* srctype = _gvn.type(src);
 428       if (phi-&gt;type() != srctype) {
 429         const Type* dsttype = phi-&gt;type()-&gt;meet_speculative(srctype);
 430         if (phi-&gt;type() != dsttype) {
 431           phi-&gt;set_type(dsttype);
 432           _gvn.set_type(phi, dsttype);
 433         }
 434       }
 435     }
 436   }
 437   phi_map-&gt;merge_replaced_nodes_with(ex_map);
 438 }
 439 
 440 //--------------------------use_exception_state--------------------------------
 441 Node* GraphKit::use_exception_state(SafePointNode* phi_map) {
 442   if (failing()) { stop(); return top(); }
 443   Node* region = phi_map-&gt;control();
 444   Node* hidden_merge_mark = root();
 445   assert(phi_map-&gt;jvms()-&gt;map() == phi_map, &quot;sanity: 1-1 relation&quot;);
 446   Node* ex_oop = clear_saved_ex_oop(phi_map);
 447   if (region-&gt;in(0) == hidden_merge_mark) {
 448     // Special marking for internal ex-states.  Process the phis now.
 449     region-&gt;set_req(0, region);  // now it&#39;s an ordinary region
 450     set_jvms(phi_map-&gt;jvms());   // ...so now we can use it as a map
 451     // Note: Setting the jvms also sets the bci and sp.
 452     set_control(_gvn.transform(region));
 453     uint tos = jvms()-&gt;stkoff() + sp();
 454     for (uint i = 1; i &lt; tos; i++) {
 455       Node* x = phi_map-&gt;in(i);
 456       if (x-&gt;in(0) == region) {
 457         assert(x-&gt;is_Phi(), &quot;expected a special phi&quot;);
 458         phi_map-&gt;set_req(i, _gvn.transform(x));
 459       }
 460     }
 461     for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
 462       Node* x = mms.memory();
 463       if (x-&gt;in(0) == region) {
 464         assert(x-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 465         mms.set_memory(_gvn.transform(x));
 466       }
 467     }
 468     if (ex_oop-&gt;in(0) == region) {
 469       assert(ex_oop-&gt;is_Phi(), &quot;expected a special phi&quot;);
 470       ex_oop = _gvn.transform(ex_oop);
 471     }
 472   } else {
 473     set_jvms(phi_map-&gt;jvms());
 474   }
 475 
 476   assert(!is_hidden_merge(phi_map-&gt;control()), &quot;hidden ex. states cleared&quot;);
 477   assert(!is_hidden_merge(phi_map-&gt;i_o()), &quot;hidden ex. states cleared&quot;);
 478   return ex_oop;
 479 }
 480 
 481 //---------------------------------java_bc-------------------------------------
 482 Bytecodes::Code GraphKit::java_bc() const {
 483   ciMethod* method = this-&gt;method();
 484   int       bci    = this-&gt;bci();
 485   if (method != NULL &amp;&amp; bci != InvocationEntryBci)
 486     return method-&gt;java_code_at_bci(bci);
 487   else
 488     return Bytecodes::_illegal;
 489 }
 490 
 491 void GraphKit::uncommon_trap_if_should_post_on_exceptions(Deoptimization::DeoptReason reason,
 492                                                           bool must_throw) {
 493     // if the exception capability is set, then we will generate code
 494     // to check the JavaThread.should_post_on_exceptions flag to see
 495     // if we actually need to report exception events (for this
 496     // thread).  If we don&#39;t need to report exception events, we will
 497     // take the normal fast path provided by add_exception_events.  If
 498     // exception event reporting is enabled for this thread, we will
 499     // take the uncommon_trap in the BuildCutout below.
 500 
 501     // first must access the should_post_on_exceptions_flag in this thread&#39;s JavaThread
 502     Node* jthread = _gvn.transform(new ThreadLocalNode());
 503     Node* adr = basic_plus_adr(top(), jthread, in_bytes(JavaThread::should_post_on_exceptions_flag_offset()));
 504     Node* should_post_flag = make_load(control(), adr, TypeInt::INT, T_INT, Compile::AliasIdxRaw, MemNode::unordered);
 505 
 506     // Test the should_post_on_exceptions_flag vs. 0
 507     Node* chk = _gvn.transform( new CmpINode(should_post_flag, intcon(0)) );
 508     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 509 
 510     // Branch to slow_path if should_post_on_exceptions_flag was true
 511     { BuildCutout unless(this, tst, PROB_MAX);
 512       // Do not try anything fancy if we&#39;re notifying the VM on every throw.
 513       // Cf. case Bytecodes::_athrow in parse2.cpp.
 514       uncommon_trap(reason, Deoptimization::Action_none,
 515                     (ciKlass*)NULL, (char*)NULL, must_throw);
 516     }
 517 
 518 }
 519 
 520 //------------------------------builtin_throw----------------------------------
 521 void GraphKit::builtin_throw(Deoptimization::DeoptReason reason, Node* arg) {
 522   bool must_throw = true;
 523 
 524   if (env()-&gt;jvmti_can_post_on_exceptions()) {
 525     // check if we must post exception events, take uncommon trap if so
 526     uncommon_trap_if_should_post_on_exceptions(reason, must_throw);
 527     // here if should_post_on_exceptions is false
 528     // continue on with the normal codegen
 529   }
 530 
 531   // If this particular condition has not yet happened at this
 532   // bytecode, then use the uncommon trap mechanism, and allow for
 533   // a future recompilation if several traps occur here.
 534   // If the throw is hot, try to use a more complicated inline mechanism
 535   // which keeps execution inside the compiled code.
 536   bool treat_throw_as_hot = false;
 537   ciMethodData* md = method()-&gt;method_data();
 538 
 539   if (ProfileTraps) {
 540     if (too_many_traps(reason)) {
 541       treat_throw_as_hot = true;
 542     }
 543     // (If there is no MDO at all, assume it is early in
 544     // execution, and that any deopts are part of the
 545     // startup transient, and don&#39;t need to be remembered.)
 546 
 547     // Also, if there is a local exception handler, treat all throws
 548     // as hot if there has been at least one in this method.
 549     if (C-&gt;trap_count(reason) != 0
 550         &amp;&amp; method()-&gt;method_data()-&gt;trap_count(reason) != 0
 551         &amp;&amp; has_ex_handler()) {
 552         treat_throw_as_hot = true;
 553     }
 554   }
 555 
 556   // If this throw happens frequently, an uncommon trap might cause
 557   // a performance pothole.  If there is a local exception handler,
 558   // and if this particular bytecode appears to be deoptimizing often,
 559   // let us handle the throw inline, with a preconstructed instance.
 560   // Note:   If the deopt count has blown up, the uncommon trap
 561   // runtime is going to flush this nmethod, not matter what.
 562   if (treat_throw_as_hot
 563       &amp;&amp; (!StackTraceInThrowable || OmitStackTraceInFastThrow)) {
 564     // If the throw is local, we use a pre-existing instance and
 565     // punt on the backtrace.  This would lead to a missing backtrace
 566     // (a repeat of 4292742) if the backtrace object is ever asked
 567     // for its backtrace.
 568     // Fixing this remaining case of 4292742 requires some flavor of
 569     // escape analysis.  Leave that for the future.
 570     ciInstance* ex_obj = NULL;
 571     switch (reason) {
 572     case Deoptimization::Reason_null_check:
 573       ex_obj = env()-&gt;NullPointerException_instance();
 574       break;
 575     case Deoptimization::Reason_div0_check:
 576       ex_obj = env()-&gt;ArithmeticException_instance();
 577       break;
 578     case Deoptimization::Reason_range_check:
 579       ex_obj = env()-&gt;ArrayIndexOutOfBoundsException_instance();
 580       break;
 581     case Deoptimization::Reason_class_check:
 582       if (java_bc() == Bytecodes::_aastore) {
 583         ex_obj = env()-&gt;ArrayStoreException_instance();
 584       } else {
 585         ex_obj = env()-&gt;ClassCastException_instance();
 586       }
 587       break;
 588     default:
 589       break;
 590     }
 591     if (failing()) { stop(); return; }  // exception allocation might fail
 592     if (ex_obj != NULL) {
 593       // Cheat with a preallocated exception object.
 594       if (C-&gt;log() != NULL)
 595         C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;1&#39; reason=&#39;%s&#39;&quot;,
 596                        Deoptimization::trap_reason_name(reason));
 597       const TypeInstPtr* ex_con  = TypeInstPtr::make(ex_obj);
 598       Node*              ex_node = _gvn.transform(ConNode::make(ex_con));
 599 
 600       // Clear the detail message of the preallocated exception object.
 601       // Weblogic sometimes mutates the detail message of exceptions
 602       // using reflection.
 603       int offset = java_lang_Throwable::get_detailMessage_offset();
 604       const TypePtr* adr_typ = ex_con-&gt;add_offset(offset);
 605 
 606       Node *adr = basic_plus_adr(ex_node, ex_node, offset);
 607       const TypeOopPtr* val_type = TypeOopPtr::make_from_klass(env()-&gt;String_klass());
 608       Node *store = access_store_at(ex_node, adr, adr_typ, null(), val_type, T_OBJECT, IN_HEAP);
 609 
 610       add_exception_state(make_exception_state(ex_node));
 611       return;
 612     }
 613   }
 614 
 615   // %%% Maybe add entry to OptoRuntime which directly throws the exc.?
 616   // It won&#39;t be much cheaper than bailing to the interp., since we&#39;ll
 617   // have to pass up all the debug-info, and the runtime will have to
 618   // create the stack trace.
 619 
 620   // Usual case:  Bail to interpreter.
 621   // Reserve the right to recompile if we haven&#39;t seen anything yet.
 622 
 623   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? C-&gt;method() : NULL;
 624   Deoptimization::DeoptAction action = Deoptimization::Action_maybe_recompile;
 625   if (treat_throw_as_hot
 626       &amp;&amp; (method()-&gt;method_data()-&gt;trap_recompiled_at(bci(), m)
 627           || C-&gt;too_many_traps(reason))) {
 628     // We cannot afford to take more traps here.  Suffer in the interpreter.
 629     if (C-&gt;log() != NULL)
 630       C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;0&#39; reason=&#39;%s&#39; mcount=&#39;%d&#39;&quot;,
 631                      Deoptimization::trap_reason_name(reason),
 632                      C-&gt;trap_count(reason));
 633     action = Deoptimization::Action_none;
 634   }
 635 
 636   // &quot;must_throw&quot; prunes the JVM state to include only the stack, if there
 637   // are no local exception handlers.  This should cut down on register
 638   // allocation time and code size, by drastically reducing the number
 639   // of in-edges on the call to the uncommon trap.
 640 
 641   uncommon_trap(reason, action, (ciKlass*)NULL, (char*)NULL, must_throw);
 642 }
 643 
 644 
 645 //----------------------------PreserveJVMState---------------------------------
 646 PreserveJVMState::PreserveJVMState(GraphKit* kit, bool clone_map) {
 647   debug_only(kit-&gt;verify_map());
 648   _kit    = kit;
 649   _map    = kit-&gt;map();   // preserve the map
 650   _sp     = kit-&gt;sp();
 651   kit-&gt;set_map(clone_map ? kit-&gt;clone_map() : NULL);
 652 #ifdef ASSERT
 653   _bci    = kit-&gt;bci();
 654   Parse* parser = kit-&gt;is_Parse();
 655   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 656   _block  = block;
 657 #endif
 658 }
 659 PreserveJVMState::~PreserveJVMState() {
 660   GraphKit* kit = _kit;
 661 #ifdef ASSERT
 662   assert(kit-&gt;bci() == _bci, &quot;bci must not shift&quot;);
 663   Parse* parser = kit-&gt;is_Parse();
 664   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 665   assert(block == _block,    &quot;block must not shift&quot;);
 666 #endif
 667   kit-&gt;set_map(_map);
 668   kit-&gt;set_sp(_sp);
 669 }
 670 
 671 
 672 //-----------------------------BuildCutout-------------------------------------
 673 BuildCutout::BuildCutout(GraphKit* kit, Node* p, float prob, float cnt)
 674   : PreserveJVMState(kit)
 675 {
 676   assert(p-&gt;is_Con() || p-&gt;is_Bool(), &quot;test must be a bool&quot;);
 677   SafePointNode* outer_map = _map;   // preserved map is caller&#39;s
 678   SafePointNode* inner_map = kit-&gt;map();
 679   IfNode* iff = kit-&gt;create_and_map_if(outer_map-&gt;control(), p, prob, cnt);
 680   outer_map-&gt;set_control(kit-&gt;gvn().transform( new IfTrueNode(iff) ));
 681   inner_map-&gt;set_control(kit-&gt;gvn().transform( new IfFalseNode(iff) ));
 682 }
 683 BuildCutout::~BuildCutout() {
 684   GraphKit* kit = _kit;
 685   assert(kit-&gt;stopped(), &quot;cutout code must stop, throw, return, etc.&quot;);
 686 }
 687 
 688 //---------------------------PreserveReexecuteState----------------------------
 689 PreserveReexecuteState::PreserveReexecuteState(GraphKit* kit) {
 690   assert(!kit-&gt;stopped(), &quot;must call stopped() before&quot;);
 691   _kit    =    kit;
 692   _sp     =    kit-&gt;sp();
 693   _reexecute = kit-&gt;jvms()-&gt;_reexecute;
 694 }
 695 PreserveReexecuteState::~PreserveReexecuteState() {
 696   if (_kit-&gt;stopped()) return;
 697   _kit-&gt;jvms()-&gt;_reexecute = _reexecute;
 698   _kit-&gt;set_sp(_sp);
 699 }
 700 
 701 //------------------------------clone_map--------------------------------------
 702 // Implementation of PreserveJVMState
 703 //
 704 // Only clone_map(...) here. If this function is only used in the
 705 // PreserveJVMState class we may want to get rid of this extra
 706 // function eventually and do it all there.
 707 
 708 SafePointNode* GraphKit::clone_map() {
 709   if (map() == NULL)  return NULL;
 710 
 711   // Clone the memory edge first
 712   Node* mem = MergeMemNode::make(map()-&gt;memory());
 713   gvn().set_type_bottom(mem);
 714 
 715   SafePointNode *clonemap = (SafePointNode*)map()-&gt;clone();
 716   JVMState* jvms = this-&gt;jvms();
 717   JVMState* clonejvms = jvms-&gt;clone_shallow(C);
 718   clonemap-&gt;set_memory(mem);
 719   clonemap-&gt;set_jvms(clonejvms);
 720   clonejvms-&gt;set_map(clonemap);
 721   record_for_igvn(clonemap);
 722   gvn().set_type_bottom(clonemap);
 723   return clonemap;
 724 }
 725 
 726 
 727 //-----------------------------set_map_clone-----------------------------------
 728 void GraphKit::set_map_clone(SafePointNode* m) {
 729   _map = m;
 730   _map = clone_map();
 731   _map-&gt;set_next_exception(NULL);
 732   debug_only(verify_map());
 733 }
 734 
 735 
 736 //----------------------------kill_dead_locals---------------------------------
 737 // Detect any locals which are known to be dead, and force them to top.
 738 void GraphKit::kill_dead_locals() {
 739   // Consult the liveness information for the locals.  If any
 740   // of them are unused, then they can be replaced by top().  This
 741   // should help register allocation time and cut down on the size
 742   // of the deoptimization information.
 743 
 744   // This call is made from many of the bytecode handling
 745   // subroutines called from the Big Switch in do_one_bytecode.
 746   // Every bytecode which might include a slow path is responsible
 747   // for killing its dead locals.  The more consistent we
 748   // are about killing deads, the fewer useless phis will be
 749   // constructed for them at various merge points.
 750 
 751   // bci can be -1 (InvocationEntryBci).  We return the entry
 752   // liveness for the method.
 753 
 754   if (method() == NULL || method()-&gt;code_size() == 0) {
 755     // We are building a graph for a call to a native method.
 756     // All locals are live.
 757     return;
 758   }
 759 
 760   ResourceMark rm;
 761 
 762   // Consult the liveness information for the locals.  If any
 763   // of them are unused, then they can be replaced by top().  This
 764   // should help register allocation time and cut down on the size
 765   // of the deoptimization information.
 766   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(bci());
 767 
 768   int len = (int)live_locals.size();
 769   assert(len &lt;= jvms()-&gt;loc_size(), &quot;too many live locals&quot;);
 770   for (int local = 0; local &lt; len; local++) {
 771     if (!live_locals.at(local)) {
 772       set_local(local, top());
 773     }
 774   }
 775 }
 776 
 777 #ifdef ASSERT
 778 //-------------------------dead_locals_are_killed------------------------------
 779 // Return true if all dead locals are set to top in the map.
 780 // Used to assert &quot;clean&quot; debug info at various points.
 781 bool GraphKit::dead_locals_are_killed() {
 782   if (method() == NULL || method()-&gt;code_size() == 0) {
 783     // No locals need to be dead, so all is as it should be.
 784     return true;
 785   }
 786 
 787   // Make sure somebody called kill_dead_locals upstream.
 788   ResourceMark rm;
 789   for (JVMState* jvms = this-&gt;jvms(); jvms != NULL; jvms = jvms-&gt;caller()) {
 790     if (jvms-&gt;loc_size() == 0)  continue;  // no locals to consult
 791     SafePointNode* map = jvms-&gt;map();
 792     ciMethod* method = jvms-&gt;method();
 793     int       bci    = jvms-&gt;bci();
 794     if (jvms == this-&gt;jvms()) {
 795       bci = this-&gt;bci();  // it might not yet be synched
 796     }
 797     MethodLivenessResult live_locals = method-&gt;liveness_at_bci(bci);
 798     int len = (int)live_locals.size();
 799     if (!live_locals.is_valid() || len == 0)
 800       // This method is trivial, or is poisoned by a breakpoint.
 801       return true;
 802     assert(len == jvms-&gt;loc_size(), &quot;live map consistent with locals map&quot;);
 803     for (int local = 0; local &lt; len; local++) {
 804       if (!live_locals.at(local) &amp;&amp; map-&gt;local(jvms, local) != top()) {
 805         if (PrintMiscellaneous &amp;&amp; (Verbose || WizardMode)) {
 806           tty-&gt;print_cr(&quot;Zombie local %d: &quot;, local);
 807           jvms-&gt;dump();
 808         }
 809         return false;
 810       }
 811     }
 812   }
 813   return true;
 814 }
 815 
 816 #endif //ASSERT
 817 
 818 // Helper function for enforcing certain bytecodes to reexecute if
 819 // deoptimization happens
 820 static bool should_reexecute_implied_by_bytecode(JVMState *jvms, bool is_anewarray) {
 821   ciMethod* cur_method = jvms-&gt;method();
 822   int       cur_bci   = jvms-&gt;bci();
 823   if (cur_method != NULL &amp;&amp; cur_bci != InvocationEntryBci) {
 824     Bytecodes::Code code = cur_method-&gt;java_code_at_bci(cur_bci);
 825     return Interpreter::bytecode_should_reexecute(code) ||
 826            (is_anewarray &amp;&amp; code == Bytecodes::_multianewarray);
 827     // Reexecute _multianewarray bytecode which was replaced with
 828     // sequence of [a]newarray. See Parse::do_multianewarray().
 829     //
 830     // Note: interpreter should not have it set since this optimization
 831     // is limited by dimensions and guarded by flag so in some cases
 832     // multianewarray() runtime calls will be generated and
 833     // the bytecode should not be reexecutes (stack will not be reset).
 834   } else
 835     return false;
 836 }
 837 
 838 // Helper function for adding JVMState and debug information to node
 839 void GraphKit::add_safepoint_edges(SafePointNode* call, bool must_throw) {
 840   // Add the safepoint edges to the call (or other safepoint).
 841 
 842   // Make sure dead locals are set to top.  This
 843   // should help register allocation time and cut down on the size
 844   // of the deoptimization information.
 845   assert(dead_locals_are_killed(), &quot;garbage in debug info before safepoint&quot;);
 846 
 847   // Walk the inline list to fill in the correct set of JVMState&#39;s
 848   // Also fill in the associated edges for each JVMState.
 849 
 850   // If the bytecode needs to be reexecuted we need to put
 851   // the arguments back on the stack.
 852   const bool should_reexecute = jvms()-&gt;should_reexecute();
 853   JVMState* youngest_jvms = should_reexecute ? sync_jvms_for_reexecute() : sync_jvms();
 854 
 855   // NOTE: set_bci (called from sync_jvms) might reset the reexecute bit to
 856   // undefined if the bci is different.  This is normal for Parse but it
 857   // should not happen for LibraryCallKit because only one bci is processed.
 858   assert(!is_LibraryCallKit() || (jvms()-&gt;should_reexecute() == should_reexecute),
 859          &quot;in LibraryCallKit the reexecute bit should not change&quot;);
 860 
 861   // If we are guaranteed to throw, we can prune everything but the
 862   // input to the current bytecode.
 863   bool can_prune_locals = false;
 864   uint stack_slots_not_pruned = 0;
 865   int inputs = 0, depth = 0;
 866   if (must_throw) {
 867     assert(method() == youngest_jvms-&gt;method(), &quot;sanity&quot;);
 868     if (compute_stack_effects(inputs, depth)) {
 869       can_prune_locals = true;
 870       stack_slots_not_pruned = inputs;
 871     }
 872   }
 873 
 874   if (env()-&gt;should_retain_local_variables()) {
 875     // At any safepoint, this method can get breakpointed, which would
 876     // then require an immediate deoptimization.
 877     can_prune_locals = false;  // do not prune locals
 878     stack_slots_not_pruned = 0;
 879   }
 880 
 881   // do not scribble on the input jvms
 882   JVMState* out_jvms = youngest_jvms-&gt;clone_deep(C);
 883   call-&gt;set_jvms(out_jvms); // Start jvms list for call node
 884 
 885   // For a known set of bytecodes, the interpreter should reexecute them if
 886   // deoptimization happens. We set the reexecute state for them here
 887   if (out_jvms-&gt;is_reexecute_undefined() &amp;&amp; //don&#39;t change if already specified
 888       should_reexecute_implied_by_bytecode(out_jvms, call-&gt;is_AllocateArray())) {
 889     out_jvms-&gt;set_should_reexecute(true); //NOTE: youngest_jvms not changed
 890   }
 891 
 892   // Presize the call:
 893   DEBUG_ONLY(uint non_debug_edges = call-&gt;req());
 894   call-&gt;add_req_batch(top(), youngest_jvms-&gt;debug_depth());
 895   assert(call-&gt;req() == non_debug_edges + youngest_jvms-&gt;debug_depth(), &quot;&quot;);
 896 
 897   // Set up edges so that the call looks like this:
 898   //  Call [state:] ctl io mem fptr retadr
 899   //       [parms:] parm0 ... parmN
 900   //       [root:]  loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 901   //    [...mid:]   loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN [...]
 902   //       [young:] loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 903   // Note that caller debug info precedes callee debug info.
 904 
 905   // Fill pointer walks backwards from &quot;young:&quot; to &quot;root:&quot; in the diagram above:
 906   uint debug_ptr = call-&gt;req();
 907 
 908   // Loop over the map input edges associated with jvms, add them
 909   // to the call node, &amp; reset all offsets to match call node array.
 910   for (JVMState* in_jvms = youngest_jvms; in_jvms != NULL; ) {
 911     uint debug_end   = debug_ptr;
 912     uint debug_start = debug_ptr - in_jvms-&gt;debug_size();
 913     debug_ptr = debug_start;  // back up the ptr
 914 
 915     uint p = debug_start;  // walks forward in [debug_start, debug_end)
 916     uint j, k, l;
 917     SafePointNode* in_map = in_jvms-&gt;map();
 918     out_jvms-&gt;set_map(call);
 919 
 920     if (can_prune_locals) {
 921       assert(in_jvms-&gt;method() == out_jvms-&gt;method(), &quot;sanity&quot;);
 922       // If the current throw can reach an exception handler in this JVMS,
 923       // then we must keep everything live that can reach that handler.
 924       // As a quick and dirty approximation, we look for any handlers at all.
 925       if (in_jvms-&gt;method()-&gt;has_exception_handlers()) {
 926         can_prune_locals = false;
 927       }
 928     }
 929 
 930     // Add the Locals
 931     k = in_jvms-&gt;locoff();
 932     l = in_jvms-&gt;loc_size();
 933     out_jvms-&gt;set_locoff(p);
 934     if (!can_prune_locals) {
 935       for (j = 0; j &lt; l; j++)
 936         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 937     } else {
 938       p += l;  // already set to top above by add_req_batch
 939     }
 940 
 941     // Add the Expression Stack
 942     k = in_jvms-&gt;stkoff();
 943     l = in_jvms-&gt;sp();
 944     out_jvms-&gt;set_stkoff(p);
 945     if (!can_prune_locals) {
 946       for (j = 0; j &lt; l; j++)
 947         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 948     } else if (can_prune_locals &amp;&amp; stack_slots_not_pruned != 0) {
 949       // Divide stack into {S0,...,S1}, where S0 is set to top.
 950       uint s1 = stack_slots_not_pruned;
 951       stack_slots_not_pruned = 0;  // for next iteration
 952       if (s1 &gt; l)  s1 = l;
 953       uint s0 = l - s1;
 954       p += s0;  // skip the tops preinstalled by add_req_batch
 955       for (j = s0; j &lt; l; j++)
 956         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 957     } else {
 958       p += l;  // already set to top above by add_req_batch
 959     }
 960 
 961     // Add the Monitors
 962     k = in_jvms-&gt;monoff();
 963     l = in_jvms-&gt;mon_size();
 964     out_jvms-&gt;set_monoff(p);
 965     for (j = 0; j &lt; l; j++)
 966       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 967 
 968     // Copy any scalar object fields.
 969     k = in_jvms-&gt;scloff();
 970     l = in_jvms-&gt;scl_size();
 971     out_jvms-&gt;set_scloff(p);
 972     for (j = 0; j &lt; l; j++)
 973       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 974 
 975     // Finish the new jvms.
 976     out_jvms-&gt;set_endoff(p);
 977 
 978     assert(out_jvms-&gt;endoff()     == debug_end,             &quot;fill ptr must match&quot;);
 979     assert(out_jvms-&gt;depth()      == in_jvms-&gt;depth(),      &quot;depth must match&quot;);
 980     assert(out_jvms-&gt;loc_size()   == in_jvms-&gt;loc_size(),   &quot;size must match&quot;);
 981     assert(out_jvms-&gt;mon_size()   == in_jvms-&gt;mon_size(),   &quot;size must match&quot;);
 982     assert(out_jvms-&gt;scl_size()   == in_jvms-&gt;scl_size(),   &quot;size must match&quot;);
 983     assert(out_jvms-&gt;debug_size() == in_jvms-&gt;debug_size(), &quot;size must match&quot;);
 984 
 985     // Update the two tail pointers in parallel.
 986     out_jvms = out_jvms-&gt;caller();
 987     in_jvms  = in_jvms-&gt;caller();
 988   }
 989 
 990   assert(debug_ptr == non_debug_edges, &quot;debug info must fit exactly&quot;);
 991 
 992   // Test the correctness of JVMState::debug_xxx accessors:
 993   assert(call-&gt;jvms()-&gt;debug_start() == non_debug_edges, &quot;&quot;);
 994   assert(call-&gt;jvms()-&gt;debug_end()   == call-&gt;req(), &quot;&quot;);
 995   assert(call-&gt;jvms()-&gt;debug_depth() == call-&gt;req() - non_debug_edges, &quot;&quot;);
 996 }
 997 
 998 bool GraphKit::compute_stack_effects(int&amp; inputs, int&amp; depth) {
 999   Bytecodes::Code code = java_bc();
1000   if (code == Bytecodes::_wide) {
1001     code = method()-&gt;java_code_at_bci(bci() + 1);
1002   }
1003 
1004   BasicType rtype = T_ILLEGAL;
1005   int       rsize = 0;
1006 
1007   if (code != Bytecodes::_illegal) {
1008     depth = Bytecodes::depth(code); // checkcast=0, athrow=-1
1009     rtype = Bytecodes::result_type(code); // checkcast=P, athrow=V
1010     if (rtype &lt; T_CONFLICT)
1011       rsize = type2size[rtype];
1012   }
1013 
1014   switch (code) {
1015   case Bytecodes::_illegal:
1016     return false;
1017 
1018   case Bytecodes::_ldc:
1019   case Bytecodes::_ldc_w:
1020   case Bytecodes::_ldc2_w:
1021     inputs = 0;
1022     break;
1023 
1024   case Bytecodes::_dup:         inputs = 1;  break;
1025   case Bytecodes::_dup_x1:      inputs = 2;  break;
1026   case Bytecodes::_dup_x2:      inputs = 3;  break;
1027   case Bytecodes::_dup2:        inputs = 2;  break;
1028   case Bytecodes::_dup2_x1:     inputs = 3;  break;
1029   case Bytecodes::_dup2_x2:     inputs = 4;  break;
1030   case Bytecodes::_swap:        inputs = 2;  break;
1031   case Bytecodes::_arraylength: inputs = 1;  break;
1032 
1033   case Bytecodes::_getstatic:
1034   case Bytecodes::_putstatic:
1035   case Bytecodes::_getfield:
1036   case Bytecodes::_putfield:
1037     {
1038       bool ignored_will_link;
1039       ciField* field = method()-&gt;get_field_at_bci(bci(), ignored_will_link);
1040       int      size  = field-&gt;type()-&gt;size();
1041       bool is_get = (depth &gt;= 0), is_static = (depth &amp; 1);
1042       inputs = (is_static ? 0 : 1);
1043       if (is_get) {
1044         depth = size - inputs;
1045       } else {
1046         inputs += size;        // putxxx pops the value from the stack
1047         depth = - inputs;
1048       }
1049     }
1050     break;
1051 
1052   case Bytecodes::_invokevirtual:
1053   case Bytecodes::_invokespecial:
1054   case Bytecodes::_invokestatic:
1055   case Bytecodes::_invokedynamic:
1056   case Bytecodes::_invokeinterface:
1057     {
1058       bool ignored_will_link;
1059       ciSignature* declared_signature = NULL;
1060       ciMethod* ignored_callee = method()-&gt;get_method_at_bci(bci(), ignored_will_link, &amp;declared_signature);
1061       assert(declared_signature != NULL, &quot;cannot be null&quot;);
1062       inputs   = declared_signature-&gt;arg_size_for_bc(code);
1063       int size = declared_signature-&gt;return_type()-&gt;size();
1064       depth = size - inputs;
1065     }
1066     break;
1067 
1068   case Bytecodes::_multianewarray:
1069     {
1070       ciBytecodeStream iter(method());
1071       iter.reset_to_bci(bci());
1072       iter.next();
1073       inputs = iter.get_dimensions();
1074       assert(rsize == 1, &quot;&quot;);
1075       depth = rsize - inputs;
1076     }
1077     break;
1078 
1079   case Bytecodes::_ireturn:
1080   case Bytecodes::_lreturn:
1081   case Bytecodes::_freturn:
1082   case Bytecodes::_dreturn:
1083   case Bytecodes::_areturn:
1084     assert(rsize == -depth, &quot;&quot;);
1085     inputs = rsize;
1086     break;
1087 
1088   case Bytecodes::_jsr:
1089   case Bytecodes::_jsr_w:
1090     inputs = 0;
1091     depth  = 1;                  // S.B. depth=1, not zero
1092     break;
1093 
1094   default:
1095     // bytecode produces a typed result
1096     inputs = rsize - depth;
1097     assert(inputs &gt;= 0, &quot;&quot;);
1098     break;
1099   }
1100 
1101 #ifdef ASSERT
1102   // spot check
1103   int outputs = depth + inputs;
1104   assert(outputs &gt;= 0, &quot;sanity&quot;);
1105   switch (code) {
1106   case Bytecodes::_checkcast: assert(inputs == 1 &amp;&amp; outputs == 1, &quot;&quot;); break;
1107   case Bytecodes::_athrow:    assert(inputs == 1 &amp;&amp; outputs == 0, &quot;&quot;); break;
1108   case Bytecodes::_aload_0:   assert(inputs == 0 &amp;&amp; outputs == 1, &quot;&quot;); break;
1109   case Bytecodes::_return:    assert(inputs == 0 &amp;&amp; outputs == 0, &quot;&quot;); break;
1110   case Bytecodes::_drem:      assert(inputs == 4 &amp;&amp; outputs == 2, &quot;&quot;); break;
1111   default:                    break;
1112   }
1113 #endif //ASSERT
1114 
1115   return true;
1116 }
1117 
1118 
1119 
1120 //------------------------------basic_plus_adr---------------------------------
1121 Node* GraphKit::basic_plus_adr(Node* base, Node* ptr, Node* offset) {
1122   // short-circuit a common case
1123   if (offset == intcon(0))  return ptr;
1124   return _gvn.transform( new AddPNode(base, ptr, offset) );
1125 }
1126 
1127 Node* GraphKit::ConvI2L(Node* offset) {
1128   // short-circuit a common case
1129   jint offset_con = find_int_con(offset, Type::OffsetBot);
1130   if (offset_con != Type::OffsetBot) {
1131     return longcon((jlong) offset_con);
1132   }
1133   return _gvn.transform( new ConvI2LNode(offset));
1134 }
1135 
1136 Node* GraphKit::ConvI2UL(Node* offset) {
1137   juint offset_con = (juint) find_int_con(offset, Type::OffsetBot);
1138   if (offset_con != (juint) Type::OffsetBot) {
1139     return longcon((julong) offset_con);
1140   }
1141   Node* conv = _gvn.transform( new ConvI2LNode(offset));
1142   Node* mask = _gvn.transform(ConLNode::make((julong) max_juint));
1143   return _gvn.transform( new AndLNode(conv, mask) );
1144 }
1145 
1146 Node* GraphKit::ConvL2I(Node* offset) {
1147   // short-circuit a common case
1148   jlong offset_con = find_long_con(offset, (jlong)Type::OffsetBot);
1149   if (offset_con != (jlong)Type::OffsetBot) {
1150     return intcon((int) offset_con);
1151   }
1152   return _gvn.transform( new ConvL2INode(offset));
1153 }
1154 
1155 //-------------------------load_object_klass-----------------------------------
1156 Node* GraphKit::load_object_klass(Node* obj) {
1157   // Special-case a fresh allocation to avoid building nodes:
1158   Node* akls = AllocateNode::Ideal_klass(obj, &amp;_gvn);
1159   if (akls != NULL)  return akls;
1160   Node* k_adr = basic_plus_adr(obj, oopDesc::klass_offset_in_bytes());
1161   return _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS));
1162 }
1163 
1164 //-------------------------load_array_length-----------------------------------
1165 Node* GraphKit::load_array_length(Node* array) {
1166   // Special-case a fresh allocation to avoid building nodes:
1167   AllocateArrayNode* alloc = AllocateArrayNode::Ideal_array_allocation(array, &amp;_gvn);
1168   Node *alen;
1169   if (alloc == NULL) {
1170     Node *r_adr = basic_plus_adr(array, arrayOopDesc::length_offset_in_bytes());
1171     alen = _gvn.transform( new LoadRangeNode(0, immutable_memory(), r_adr, TypeInt::POS));
1172   } else {
1173     alen = alloc-&gt;Ideal_length();
1174     Node* ccast = alloc-&gt;make_ideal_length(_gvn.type(array)-&gt;is_oopptr(), &amp;_gvn);
1175     if (ccast != alen) {
1176       alen = _gvn.transform(ccast);
1177     }
1178   }
1179   return alen;
1180 }
1181 
1182 //------------------------------do_null_check----------------------------------
1183 // Helper function to do a NULL pointer check.  Returned value is
1184 // the incoming address with NULL casted away.  You are allowed to use the
1185 // not-null value only if you are control dependent on the test.
1186 #ifndef PRODUCT
1187 extern int explicit_null_checks_inserted,
1188            explicit_null_checks_elided;
1189 #endif
1190 Node* GraphKit::null_check_common(Node* value, BasicType type,
1191                                   // optional arguments for variations:
1192                                   bool assert_null,
1193                                   Node* *null_control,
1194                                   bool speculative) {
1195   assert(!assert_null || null_control == NULL, &quot;not both at once&quot;);
1196   if (stopped())  return top();
1197   NOT_PRODUCT(explicit_null_checks_inserted++);
1198 
1199   // Construct NULL check
1200   Node *chk = NULL;
1201   switch(type) {
1202     case T_LONG   : chk = new CmpLNode(value, _gvn.zerocon(T_LONG)); break;
1203     case T_INT    : chk = new CmpINode(value, _gvn.intcon(0)); break;
1204     case T_ARRAY  : // fall through
1205       type = T_OBJECT;  // simplify further tests
1206     case T_OBJECT : {
1207       const Type *t = _gvn.type( value );
1208 
1209       const TypeOopPtr* tp = t-&gt;isa_oopptr();
1210       if (tp != NULL &amp;&amp; tp-&gt;klass() != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded()
1211           // Only for do_null_check, not any of its siblings:
1212           &amp;&amp; !assert_null &amp;&amp; null_control == NULL) {
1213         // Usually, any field access or invocation on an unloaded oop type
1214         // will simply fail to link, since the statically linked class is
1215         // likely also to be unloaded.  However, in -Xcomp mode, sometimes
1216         // the static class is loaded but the sharper oop type is not.
1217         // Rather than checking for this obscure case in lots of places,
1218         // we simply observe that a null check on an unloaded class
1219         // will always be followed by a nonsense operation, so we
1220         // can just issue the uncommon trap here.
1221         // Our access to the unloaded class will only be correct
1222         // after it has been loaded and initialized, which requires
1223         // a trip through the interpreter.
1224 #ifndef PRODUCT
1225         if (WizardMode) { tty-&gt;print(&quot;Null check of unloaded &quot;); tp-&gt;klass()-&gt;print(); tty-&gt;cr(); }
1226 #endif
1227         uncommon_trap(Deoptimization::Reason_unloaded,
1228                       Deoptimization::Action_reinterpret,
1229                       tp-&gt;klass(), &quot;!loaded&quot;);
1230         return top();
1231       }
1232 
1233       if (assert_null) {
1234         // See if the type is contained in NULL_PTR.
1235         // If so, then the value is already null.
1236         if (t-&gt;higher_equal(TypePtr::NULL_PTR)) {
1237           NOT_PRODUCT(explicit_null_checks_elided++);
1238           return value;           // Elided null assert quickly!
1239         }
1240       } else {
1241         // See if mixing in the NULL pointer changes type.
1242         // If so, then the NULL pointer was not allowed in the original
1243         // type.  In other words, &quot;value&quot; was not-null.
1244         if (t-&gt;meet(TypePtr::NULL_PTR) != t-&gt;remove_speculative()) {
1245           // same as: if (!TypePtr::NULL_PTR-&gt;higher_equal(t)) ...
1246           NOT_PRODUCT(explicit_null_checks_elided++);
1247           return value;           // Elided null check quickly!
1248         }
1249       }
1250       chk = new CmpPNode( value, null() );
1251       break;
1252     }
1253 
1254     default:
1255       fatal(&quot;unexpected type: %s&quot;, type2name(type));
1256   }
1257   assert(chk != NULL, &quot;sanity check&quot;);
1258   chk = _gvn.transform(chk);
1259 
1260   BoolTest::mask btest = assert_null ? BoolTest::eq : BoolTest::ne;
1261   BoolNode *btst = new BoolNode( chk, btest);
1262   Node   *tst = _gvn.transform( btst );
1263 
1264   //-----------
1265   // if peephole optimizations occurred, a prior test existed.
1266   // If a prior test existed, maybe it dominates as we can avoid this test.
1267   if (tst != btst &amp;&amp; type == T_OBJECT) {
1268     // At this point we want to scan up the CFG to see if we can
1269     // find an identical test (and so avoid this test altogether).
1270     Node *cfg = control();
1271     int depth = 0;
1272     while( depth &lt; 16 ) {       // Limit search depth for speed
1273       if( cfg-&gt;Opcode() == Op_IfTrue &amp;&amp;
1274           cfg-&gt;in(0)-&gt;in(1) == tst ) {
1275         // Found prior test.  Use &quot;cast_not_null&quot; to construct an identical
1276         // CastPP (and hence hash to) as already exists for the prior test.
1277         // Return that casted value.
1278         if (assert_null) {
1279           replace_in_map(value, null());
1280           return null();  // do not issue the redundant test
1281         }
1282         Node *oldcontrol = control();
1283         set_control(cfg);
1284         Node *res = cast_not_null(value);
1285         set_control(oldcontrol);
1286         NOT_PRODUCT(explicit_null_checks_elided++);
1287         return res;
1288       }
1289       cfg = IfNode::up_one_dom(cfg, /*linear_only=*/ true);
1290       if (cfg == NULL)  break;  // Quit at region nodes
1291       depth++;
1292     }
1293   }
1294 
1295   //-----------
1296   // Branch to failure if null
1297   float ok_prob = PROB_MAX;  // a priori estimate:  nulls never happen
1298   Deoptimization::DeoptReason reason;
1299   if (assert_null) {
1300     reason = Deoptimization::reason_null_assert(speculative);
1301   } else if (type == T_OBJECT) {
1302     reason = Deoptimization::reason_null_check(speculative);
1303   } else {
1304     reason = Deoptimization::Reason_div0_check;
1305   }
1306   // %%% Since Reason_unhandled is not recorded on a per-bytecode basis,
1307   // ciMethodData::has_trap_at will return a conservative -1 if any
1308   // must-be-null assertion has failed.  This could cause performance
1309   // problems for a method after its first do_null_assert failure.
1310   // Consider using &#39;Reason_class_check&#39; instead?
1311 
1312   // To cause an implicit null check, we set the not-null probability
1313   // to the maximum (PROB_MAX).  For an explicit check the probability
1314   // is set to a smaller value.
1315   if (null_control != NULL || too_many_traps(reason)) {
1316     // probability is less likely
1317     ok_prob =  PROB_LIKELY_MAG(3);
1318   } else if (!assert_null &amp;&amp;
1319              (ImplicitNullCheckThreshold &gt; 0) &amp;&amp;
1320              method() != NULL &amp;&amp;
1321              (method()-&gt;method_data()-&gt;trap_count(reason)
1322               &gt;= (uint)ImplicitNullCheckThreshold)) {
1323     ok_prob =  PROB_LIKELY_MAG(3);
1324   }
1325 
1326   if (null_control != NULL) {
1327     IfNode* iff = create_and_map_if(control(), tst, ok_prob, COUNT_UNKNOWN);
1328     Node* null_true = _gvn.transform( new IfFalseNode(iff));
1329     set_control(      _gvn.transform( new IfTrueNode(iff)));
1330 #ifndef PRODUCT
1331     if (null_true == top()) {
1332       explicit_null_checks_elided++;
1333     }
1334 #endif
1335     (*null_control) = null_true;
1336   } else {
1337     BuildCutout unless(this, tst, ok_prob);
1338     // Check for optimizer eliding test at parse time
1339     if (stopped()) {
1340       // Failure not possible; do not bother making uncommon trap.
1341       NOT_PRODUCT(explicit_null_checks_elided++);
1342     } else if (assert_null) {
1343       uncommon_trap(reason,
1344                     Deoptimization::Action_make_not_entrant,
1345                     NULL, &quot;assert_null&quot;);
1346     } else {
1347       replace_in_map(value, zerocon(type));
1348       builtin_throw(reason);
1349     }
1350   }
1351 
1352   // Must throw exception, fall-thru not possible?
1353   if (stopped()) {
1354     return top();               // No result
1355   }
1356 
1357   if (assert_null) {
1358     // Cast obj to null on this path.
1359     replace_in_map(value, zerocon(type));
1360     return zerocon(type);
1361   }
1362 
1363   // Cast obj to not-null on this path, if there is no null_control.
1364   // (If there is a null_control, a non-null value may come back to haunt us.)
<a name="3" id="anc3"></a><span class="line-modified">1365   if (type == T_OBJECT) {</span>
<span class="line-removed">1366     Node* cast = cast_not_null(value, false);</span>
<span class="line-removed">1367     if (null_control == NULL || (*null_control) == top())</span>
<span class="line-removed">1368       replace_in_map(value, cast);</span>
<span class="line-removed">1369     value = cast;</span>
<span class="line-removed">1370   }</span>
<span class="line-removed">1371 </span>
<span class="line-removed">1372   return value;</span>
1373 }
1374 
1375 
1376 //------------------------------cast_not_null----------------------------------
1377 // Cast obj to not-null on this path
1378 Node* GraphKit::cast_not_null(Node* obj, bool do_replace_in_map) {
<a name="4" id="anc4"></a><span class="line-modified">1379   const Type *t = _gvn.type(obj);</span>
<span class="line-modified">1380   const Type *t_not_null = t-&gt;join_speculative(TypePtr::NOTNULL);</span>
<span class="line-modified">1381   // Object is already not-null?</span>
<span class="line-modified">1382   if( t == t_not_null ) return obj;</span>
<span class="line-modified">1383 </span>
<span class="line-modified">1384   Node *cast = new CastPPNode(obj,t_not_null);</span>
<span class="line-modified">1385   cast-&gt;init_req(0, control());</span>
<span class="line-modified">1386   cast = _gvn.transform( cast );</span>









1387 
1388   // Scan for instances of &#39;obj&#39; in the current JVM mapping.
1389   // These instances are known to be not-null after the test.
<a name="5" id="anc5"></a><span class="line-modified">1390   if (do_replace_in_map)</span>
1391     replace_in_map(obj, cast);
<a name="6" id="anc6"></a><span class="line-modified">1392 </span>
<span class="line-modified">1393   return cast;                  // Return casted value</span>
1394 }
1395 
1396 // Sometimes in intrinsics, we implicitly know an object is not null
1397 // (there&#39;s no actual null check) so we can cast it to not null. In
1398 // the course of optimizations, the input to the cast can become null.
1399 // In that case that data path will die and we need the control path
1400 // to become dead as well to keep the graph consistent. So we have to
1401 // add a check for null for which one branch can&#39;t be taken. It uses
1402 // an Opaque4 node that will cause the check to be removed after loop
1403 // opts so the test goes away and the compiled code doesn&#39;t execute a
1404 // useless check.
1405 Node* GraphKit::must_be_not_null(Node* value, bool do_replace_in_map) {
<a name="7" id="anc7"></a>


1406   Node* chk = _gvn.transform(new CmpPNode(value, null()));
1407   Node *tst = _gvn.transform(new BoolNode(chk, BoolTest::ne));
1408   Node* opaq = _gvn.transform(new Opaque4Node(C, tst, intcon(1)));
1409   IfNode *iff = new IfNode(control(), opaq, PROB_MAX, COUNT_UNKNOWN);
1410   _gvn.set_type(iff, iff-&gt;Value(&amp;_gvn));
1411   Node *if_f = _gvn.transform(new IfFalseNode(iff));
1412   Node *frame = _gvn.transform(new ParmNode(C-&gt;start(), TypeFunc::FramePtr));
<a name="8" id="anc8"></a><span class="line-modified">1413   Node *halt = _gvn.transform(new HaltNode(if_f, frame));</span>
1414   C-&gt;root()-&gt;add_req(halt);
1415   Node *if_t = _gvn.transform(new IfTrueNode(iff));
1416   set_control(if_t);
1417   return cast_not_null(value, do_replace_in_map);
1418 }
1419 
1420 
1421 //--------------------------replace_in_map-------------------------------------
1422 void GraphKit::replace_in_map(Node* old, Node* neww) {
1423   if (old == neww) {
1424     return;
1425   }
1426 
1427   map()-&gt;replace_edge(old, neww);
1428 
1429   // Note: This operation potentially replaces any edge
1430   // on the map.  This includes locals, stack, and monitors
1431   // of the current (innermost) JVM state.
1432 
1433   // don&#39;t let inconsistent types from profiling escape this
1434   // method
1435 
1436   const Type* told = _gvn.type(old);
1437   const Type* tnew = _gvn.type(neww);
1438 
1439   if (!tnew-&gt;higher_equal(told)) {
1440     return;
1441   }
1442 
1443   map()-&gt;record_replaced_node(old, neww);
1444 }
1445 
1446 
1447 //=============================================================================
1448 //--------------------------------memory---------------------------------------
1449 Node* GraphKit::memory(uint alias_idx) {
1450   MergeMemNode* mem = merged_memory();
1451   Node* p = mem-&gt;memory_at(alias_idx);
1452   _gvn.set_type(p, Type::MEMORY);  // must be mapped
1453   return p;
1454 }
1455 
1456 //-----------------------------reset_memory------------------------------------
1457 Node* GraphKit::reset_memory() {
1458   Node* mem = map()-&gt;memory();
1459   // do not use this node for any more parsing!
1460   debug_only( map()-&gt;set_memory((Node*)NULL) );
1461   return _gvn.transform( mem );
1462 }
1463 
1464 //------------------------------set_all_memory---------------------------------
1465 void GraphKit::set_all_memory(Node* newmem) {
1466   Node* mergemem = MergeMemNode::make(newmem);
1467   gvn().set_type_bottom(mergemem);
1468   map()-&gt;set_memory(mergemem);
1469 }
1470 
1471 //------------------------------set_all_memory_call----------------------------
1472 void GraphKit::set_all_memory_call(Node* call, bool separate_io_proj) {
1473   Node* newmem = _gvn.transform( new ProjNode(call, TypeFunc::Memory, separate_io_proj) );
1474   set_all_memory(newmem);
1475 }
1476 
1477 //=============================================================================
1478 //
1479 // parser factory methods for MemNodes
1480 //
1481 // These are layered on top of the factory methods in LoadNode and StoreNode,
1482 // and integrate with the parser&#39;s memory state and _gvn engine.
1483 //
1484 
1485 // factory methods in &quot;int adr_idx&quot;
1486 Node* GraphKit::make_load(Node* ctl, Node* adr, const Type* t, BasicType bt,
1487                           int adr_idx,
1488                           MemNode::MemOrd mo,
1489                           LoadNode::ControlDependency control_dependency,
1490                           bool require_atomic_access,
1491                           bool unaligned,
1492                           bool mismatched,
<a name="9" id="anc9"></a><span class="line-modified">1493                           bool unsafe) {</span>

1494   assert(adr_idx != Compile::AliasIdxTop, &quot;use other make_load factory&quot; );
1495   const TypePtr* adr_type = NULL; // debug-mode-only argument
1496   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1497   Node* mem = memory(adr_idx);
1498   Node* ld;
1499   if (require_atomic_access &amp;&amp; bt == T_LONG) {
<a name="10" id="anc10"></a><span class="line-modified">1500     ld = LoadLNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe);</span>
1501   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
<a name="11" id="anc11"></a><span class="line-modified">1502     ld = LoadDNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe);</span>
1503   } else {
<a name="12" id="anc12"></a><span class="line-modified">1504     ld = LoadNode::make(_gvn, ctl, mem, adr, adr_type, t, bt, mo, control_dependency, unaligned, mismatched, unsafe);</span>
1505   }
1506   ld = _gvn.transform(ld);
1507   if (((bt == T_OBJECT) &amp;&amp; C-&gt;do_escape_analysis()) || C-&gt;eliminate_boxing()) {
1508     // Improve graph before escape analysis and boxing elimination.
1509     record_for_igvn(ld);
1510   }
1511   return ld;
1512 }
1513 
1514 Node* GraphKit::store_to_memory(Node* ctl, Node* adr, Node *val, BasicType bt,
1515                                 int adr_idx,
1516                                 MemNode::MemOrd mo,
1517                                 bool require_atomic_access,
1518                                 bool unaligned,
1519                                 bool mismatched,
1520                                 bool unsafe) {
1521   assert(adr_idx != Compile::AliasIdxTop, &quot;use other store_to_memory factory&quot; );
1522   const TypePtr* adr_type = NULL;
1523   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1524   Node *mem = memory(adr_idx);
1525   Node* st;
1526   if (require_atomic_access &amp;&amp; bt == T_LONG) {
1527     st = StoreLNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1528   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
1529     st = StoreDNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1530   } else {
1531     st = StoreNode::make(_gvn, ctl, mem, adr, adr_type, val, bt, mo);
1532   }
1533   if (unaligned) {
1534     st-&gt;as_Store()-&gt;set_unaligned_access();
1535   }
1536   if (mismatched) {
1537     st-&gt;as_Store()-&gt;set_mismatched_access();
1538   }
1539   if (unsafe) {
1540     st-&gt;as_Store()-&gt;set_unsafe_access();
1541   }
1542   st = _gvn.transform(st);
1543   set_memory(st, adr_idx);
1544   // Back-to-back stores can only remove intermediate store with DU info
1545   // so push on worklist for optimizer.
1546   if (mem-&gt;req() &gt; MemNode::Address &amp;&amp; adr == mem-&gt;in(MemNode::Address))
1547     record_for_igvn(st);
1548 
1549   return st;
1550 }
1551 
1552 Node* GraphKit::access_store_at(Node* obj,
1553                                 Node* adr,
1554                                 const TypePtr* adr_type,
1555                                 Node* val,
1556                                 const Type* val_type,
1557                                 BasicType bt,
1558                                 DecoratorSet decorators) {
1559   // Transformation of a value which could be NULL pointer (CastPP #NULL)
1560   // could be delayed during Parse (for example, in adjust_map_after_if()).
1561   // Execute transformation here to avoid barrier generation in such case.
1562   if (_gvn.type(val) == TypePtr::NULL_PTR) {
1563     val = _gvn.makecon(TypePtr::NULL_PTR);
1564   }
1565 
1566   if (stopped()) {
1567     return top(); // Dead path ?
1568   }
1569 
1570   assert(val != NULL, &quot;not dead path&quot;);
1571 
1572   C2AccessValuePtr addr(adr, adr_type);
1573   C2AccessValue value(val, val_type);
1574   C2ParseAccess access(this, decorators | C2_WRITE_ACCESS, bt, obj, addr);
1575   if (access.is_raw()) {
1576     return _barrier_set-&gt;BarrierSetC2::store_at(access, value);
1577   } else {
1578     return _barrier_set-&gt;store_at(access, value);
1579   }
1580 }
1581 
1582 Node* GraphKit::access_load_at(Node* obj,   // containing obj
1583                                Node* adr,   // actual adress to store val at
1584                                const TypePtr* adr_type,
1585                                const Type* val_type,
1586                                BasicType bt,
1587                                DecoratorSet decorators) {
1588   if (stopped()) {
1589     return top(); // Dead path ?
1590   }
1591 
1592   C2AccessValuePtr addr(adr, adr_type);
1593   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, obj, addr);
1594   if (access.is_raw()) {
1595     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1596   } else {
1597     return _barrier_set-&gt;load_at(access, val_type);
1598   }
1599 }
1600 
1601 Node* GraphKit::access_load(Node* adr,   // actual adress to load val at
1602                             const Type* val_type,
1603                             BasicType bt,
1604                             DecoratorSet decorators) {
1605   if (stopped()) {
1606     return top(); // Dead path ?
1607   }
1608 
1609   C2AccessValuePtr addr(adr, NULL);
1610   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, NULL, addr);
1611   if (access.is_raw()) {
1612     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1613   } else {
1614     return _barrier_set-&gt;load_at(access, val_type);
1615   }
1616 }
1617 
1618 Node* GraphKit::access_atomic_cmpxchg_val_at(Node* obj,
1619                                              Node* adr,
1620                                              const TypePtr* adr_type,
1621                                              int alias_idx,
1622                                              Node* expected_val,
1623                                              Node* new_val,
1624                                              const Type* value_type,
1625                                              BasicType bt,
1626                                              DecoratorSet decorators) {
1627   C2AccessValuePtr addr(adr, adr_type);
1628   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1629                         bt, obj, addr, alias_idx);
1630   if (access.is_raw()) {
1631     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1632   } else {
1633     return _barrier_set-&gt;atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1634   }
1635 }
1636 
1637 Node* GraphKit::access_atomic_cmpxchg_bool_at(Node* obj,
1638                                               Node* adr,
1639                                               const TypePtr* adr_type,
1640                                               int alias_idx,
1641                                               Node* expected_val,
1642                                               Node* new_val,
1643                                               const Type* value_type,
1644                                               BasicType bt,
1645                                               DecoratorSet decorators) {
1646   C2AccessValuePtr addr(adr, adr_type);
1647   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1648                         bt, obj, addr, alias_idx);
1649   if (access.is_raw()) {
1650     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1651   } else {
1652     return _barrier_set-&gt;atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1653   }
1654 }
1655 
1656 Node* GraphKit::access_atomic_xchg_at(Node* obj,
1657                                       Node* adr,
1658                                       const TypePtr* adr_type,
1659                                       int alias_idx,
1660                                       Node* new_val,
1661                                       const Type* value_type,
1662                                       BasicType bt,
1663                                       DecoratorSet decorators) {
1664   C2AccessValuePtr addr(adr, adr_type);
1665   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1666                         bt, obj, addr, alias_idx);
1667   if (access.is_raw()) {
1668     return _barrier_set-&gt;BarrierSetC2::atomic_xchg_at(access, new_val, value_type);
1669   } else {
1670     return _barrier_set-&gt;atomic_xchg_at(access, new_val, value_type);
1671   }
1672 }
1673 
1674 Node* GraphKit::access_atomic_add_at(Node* obj,
1675                                      Node* adr,
1676                                      const TypePtr* adr_type,
1677                                      int alias_idx,
1678                                      Node* new_val,
1679                                      const Type* value_type,
1680                                      BasicType bt,
1681                                      DecoratorSet decorators) {
1682   C2AccessValuePtr addr(adr, adr_type);
1683   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS, bt, obj, addr, alias_idx);
1684   if (access.is_raw()) {
1685     return _barrier_set-&gt;BarrierSetC2::atomic_add_at(access, new_val, value_type);
1686   } else {
1687     return _barrier_set-&gt;atomic_add_at(access, new_val, value_type);
1688   }
1689 }
1690 
1691 void GraphKit::access_clone(Node* src, Node* dst, Node* size, bool is_array) {
1692   return _barrier_set-&gt;clone(this, src, dst, size, is_array);
1693 }
1694 
<a name="13" id="anc13"></a><span class="line-removed">1695 Node* GraphKit::access_resolve(Node* n, DecoratorSet decorators) {</span>
<span class="line-removed">1696   // Use stronger ACCESS_WRITE|ACCESS_READ by default.</span>
<span class="line-removed">1697   if ((decorators &amp; (ACCESS_READ | ACCESS_WRITE)) == 0) {</span>
<span class="line-removed">1698     decorators |= ACCESS_READ | ACCESS_WRITE;</span>
<span class="line-removed">1699   }</span>
<span class="line-removed">1700   return _barrier_set-&gt;resolve(this, n, decorators);</span>
<span class="line-removed">1701 }</span>
<span class="line-removed">1702 </span>
1703 //-------------------------array_element_address-------------------------
1704 Node* GraphKit::array_element_address(Node* ary, Node* idx, BasicType elembt,
1705                                       const TypeInt* sizetype, Node* ctrl) {
1706   uint shift  = exact_log2(type2aelembytes(elembt));
1707   uint header = arrayOopDesc::base_offset_in_bytes(elembt);
1708 
1709   // short-circuit a common case (saves lots of confusing waste motion)
1710   jint idx_con = find_int_con(idx, -1);
1711   if (idx_con &gt;= 0) {
1712     intptr_t offset = header + ((intptr_t)idx_con &lt;&lt; shift);
1713     return basic_plus_adr(ary, offset);
1714   }
1715 
1716   // must be correct type for alignment purposes
1717   Node* base  = basic_plus_adr(ary, header);
1718   idx = Compile::conv_I2X_index(&amp;_gvn, idx, sizetype, ctrl);
1719   Node* scale = _gvn.transform( new LShiftXNode(idx, intcon(shift)) );
1720   return basic_plus_adr(ary, base, scale);
1721 }
1722 
1723 //-------------------------load_array_element-------------------------
1724 Node* GraphKit::load_array_element(Node* ctl, Node* ary, Node* idx, const TypeAryPtr* arytype) {
1725   const Type* elemtype = arytype-&gt;elem();
1726   BasicType elembt = elemtype-&gt;array_element_basic_type();
1727   Node* adr = array_element_address(ary, idx, elembt, arytype-&gt;size());
1728   if (elembt == T_NARROWOOP) {
1729     elembt = T_OBJECT; // To satisfy switch in LoadNode::make()
1730   }
1731   Node* ld = make_load(ctl, adr, elemtype, elembt, arytype, MemNode::unordered);
1732   return ld;
1733 }
1734 
1735 //-------------------------set_arguments_for_java_call-------------------------
1736 // Arguments (pre-popped from the stack) are taken from the JVMS.
1737 void GraphKit::set_arguments_for_java_call(CallJavaNode* call) {
1738   // Add the call arguments:
1739   uint nargs = call-&gt;method()-&gt;arg_size();
1740   for (uint i = 0; i &lt; nargs; i++) {
1741     Node* arg = argument(i);
1742     call-&gt;init_req(i + TypeFunc::Parms, arg);
1743   }
1744 }
1745 
1746 //---------------------------set_edges_for_java_call---------------------------
1747 // Connect a newly created call into the current JVMS.
1748 // A return value node (if any) is returned from set_edges_for_java_call.
1749 void GraphKit::set_edges_for_java_call(CallJavaNode* call, bool must_throw, bool separate_io_proj) {
1750 
1751   // Add the predefined inputs:
1752   call-&gt;init_req( TypeFunc::Control, control() );
1753   call-&gt;init_req( TypeFunc::I_O    , i_o() );
1754   call-&gt;init_req( TypeFunc::Memory , reset_memory() );
1755   call-&gt;init_req( TypeFunc::FramePtr, frameptr() );
1756   call-&gt;init_req( TypeFunc::ReturnAdr, top() );
1757 
1758   add_safepoint_edges(call, must_throw);
1759 
1760   Node* xcall = _gvn.transform(call);
1761 
1762   if (xcall == top()) {
1763     set_control(top());
1764     return;
1765   }
1766   assert(xcall == call, &quot;call identity is stable&quot;);
1767 
1768   // Re-use the current map to produce the result.
1769 
1770   set_control(_gvn.transform(new ProjNode(call, TypeFunc::Control)));
1771   set_i_o(    _gvn.transform(new ProjNode(call, TypeFunc::I_O    , separate_io_proj)));
1772   set_all_memory_call(xcall, separate_io_proj);
1773 
1774   //return xcall;   // no need, caller already has it
1775 }
1776 
1777 Node* GraphKit::set_results_for_java_call(CallJavaNode* call, bool separate_io_proj, bool deoptimize) {
1778   if (stopped())  return top();  // maybe the call folded up?
1779 
1780   // Capture the return value, if any.
1781   Node* ret;
1782   if (call-&gt;method() == NULL ||
1783       call-&gt;method()-&gt;return_type()-&gt;basic_type() == T_VOID)
1784         ret = top();
1785   else  ret = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
1786 
1787   // Note:  Since any out-of-line call can produce an exception,
1788   // we always insert an I_O projection from the call into the result.
1789 
1790   make_slow_call_ex(call, env()-&gt;Throwable_klass(), separate_io_proj, deoptimize);
1791 
1792   if (separate_io_proj) {
1793     // The caller requested separate projections be used by the fall
1794     // through and exceptional paths, so replace the projections for
1795     // the fall through path.
1796     set_i_o(_gvn.transform( new ProjNode(call, TypeFunc::I_O) ));
1797     set_all_memory(_gvn.transform( new ProjNode(call, TypeFunc::Memory) ));
1798   }
1799   return ret;
1800 }
1801 
1802 //--------------------set_predefined_input_for_runtime_call--------------------
1803 // Reading and setting the memory state is way conservative here.
1804 // The real problem is that I am not doing real Type analysis on memory,
1805 // so I cannot distinguish card mark stores from other stores.  Across a GC
1806 // point the Store Barrier and the card mark memory has to agree.  I cannot
1807 // have a card mark store and its barrier split across the GC point from
1808 // either above or below.  Here I get that to happen by reading ALL of memory.
1809 // A better answer would be to separate out card marks from other memory.
1810 // For now, return the input memory state, so that it can be reused
1811 // after the call, if this call has restricted memory effects.
1812 Node* GraphKit::set_predefined_input_for_runtime_call(SafePointNode* call, Node* narrow_mem) {
1813   // Set fixed predefined input arguments
1814   Node* memory = reset_memory();
1815   Node* m = narrow_mem == NULL ? memory : narrow_mem;
1816   call-&gt;init_req( TypeFunc::Control,   control()  );
1817   call-&gt;init_req( TypeFunc::I_O,       top()      ); // does no i/o
1818   call-&gt;init_req( TypeFunc::Memory,    m          ); // may gc ptrs
1819   call-&gt;init_req( TypeFunc::FramePtr,  frameptr() );
1820   call-&gt;init_req( TypeFunc::ReturnAdr, top()      );
1821   return memory;
1822 }
1823 
1824 //-------------------set_predefined_output_for_runtime_call--------------------
1825 // Set control and memory (not i_o) from the call.
1826 // If keep_mem is not NULL, use it for the output state,
1827 // except for the RawPtr output of the call, if hook_mem is TypeRawPtr::BOTTOM.
1828 // If hook_mem is NULL, this call produces no memory effects at all.
1829 // If hook_mem is a Java-visible memory slice (such as arraycopy operands),
1830 // then only that memory slice is taken from the call.
1831 // In the last case, we must put an appropriate memory barrier before
1832 // the call, so as to create the correct anti-dependencies on loads
1833 // preceding the call.
1834 void GraphKit::set_predefined_output_for_runtime_call(Node* call,
1835                                                       Node* keep_mem,
1836                                                       const TypePtr* hook_mem) {
1837   // no i/o
1838   set_control(_gvn.transform( new ProjNode(call,TypeFunc::Control) ));
1839   if (keep_mem) {
1840     // First clone the existing memory state
1841     set_all_memory(keep_mem);
1842     if (hook_mem != NULL) {
1843       // Make memory for the call
1844       Node* mem = _gvn.transform( new ProjNode(call, TypeFunc::Memory) );
1845       // Set the RawPtr memory state only.  This covers all the heap top/GC stuff
1846       // We also use hook_mem to extract specific effects from arraycopy stubs.
1847       set_memory(mem, hook_mem);
1848     }
1849     // ...else the call has NO memory effects.
1850 
1851     // Make sure the call advertises its memory effects precisely.
1852     // This lets us build accurate anti-dependences in gcm.cpp.
1853     assert(C-&gt;alias_type(call-&gt;adr_type()) == C-&gt;alias_type(hook_mem),
1854            &quot;call node must be constructed correctly&quot;);
1855   } else {
1856     assert(hook_mem == NULL, &quot;&quot;);
1857     // This is not a &quot;slow path&quot; call; all memory comes from the call.
1858     set_all_memory_call(call);
1859   }
1860 }
1861 
<a name="14" id="anc14"></a>











1862 
1863 // Replace the call with the current state of the kit.
1864 void GraphKit::replace_call(CallNode* call, Node* result, bool do_replaced_nodes) {
1865   JVMState* ejvms = NULL;
1866   if (has_exceptions()) {
1867     ejvms = transfer_exceptions_into_jvms();
1868   }
1869 
1870   ReplacedNodes replaced_nodes = map()-&gt;replaced_nodes();
1871   ReplacedNodes replaced_nodes_exception;
1872   Node* ex_ctl = top();
1873 
1874   SafePointNode* final_state = stop();
1875 
1876   // Find all the needed outputs of this call
1877   CallProjections callprojs;
1878   call-&gt;extract_projections(&amp;callprojs, true);
1879 
<a name="15" id="anc15"></a>
1880   Node* init_mem = call-&gt;in(TypeFunc::Memory);
1881   Node* final_mem = final_state-&gt;in(TypeFunc::Memory);
1882   Node* final_ctl = final_state-&gt;in(TypeFunc::Control);
1883   Node* final_io = final_state-&gt;in(TypeFunc::I_O);
1884 
1885   // Replace all the old call edges with the edges from the inlining result
1886   if (callprojs.fallthrough_catchproj != NULL) {
1887     C-&gt;gvn_replace_by(callprojs.fallthrough_catchproj, final_ctl);
1888   }
1889   if (callprojs.fallthrough_memproj != NULL) {
1890     if (final_mem-&gt;is_MergeMem()) {
1891       // Parser&#39;s exits MergeMem was not transformed but may be optimized
1892       final_mem = _gvn.transform(final_mem);
1893     }
1894     C-&gt;gvn_replace_by(callprojs.fallthrough_memproj,   final_mem);
<a name="16" id="anc16"></a>
1895   }
1896   if (callprojs.fallthrough_ioproj != NULL) {
1897     C-&gt;gvn_replace_by(callprojs.fallthrough_ioproj,    final_io);
1898   }
1899 
1900   // Replace the result with the new result if it exists and is used
1901   if (callprojs.resproj != NULL &amp;&amp; result != NULL) {
1902     C-&gt;gvn_replace_by(callprojs.resproj, result);
1903   }
1904 
1905   if (ejvms == NULL) {
1906     // No exception edges to simply kill off those paths
1907     if (callprojs.catchall_catchproj != NULL) {
1908       C-&gt;gvn_replace_by(callprojs.catchall_catchproj, C-&gt;top());
1909     }
1910     if (callprojs.catchall_memproj != NULL) {
1911       C-&gt;gvn_replace_by(callprojs.catchall_memproj,   C-&gt;top());
1912     }
1913     if (callprojs.catchall_ioproj != NULL) {
1914       C-&gt;gvn_replace_by(callprojs.catchall_ioproj,    C-&gt;top());
1915     }
1916     // Replace the old exception object with top
1917     if (callprojs.exobj != NULL) {
1918       C-&gt;gvn_replace_by(callprojs.exobj, C-&gt;top());
1919     }
1920   } else {
1921     GraphKit ekit(ejvms);
1922 
1923     // Load my combined exception state into the kit, with all phis transformed:
1924     SafePointNode* ex_map = ekit.combine_and_pop_all_exception_states();
1925     replaced_nodes_exception = ex_map-&gt;replaced_nodes();
1926 
1927     Node* ex_oop = ekit.use_exception_state(ex_map);
1928 
1929     if (callprojs.catchall_catchproj != NULL) {
1930       C-&gt;gvn_replace_by(callprojs.catchall_catchproj, ekit.control());
1931       ex_ctl = ekit.control();
1932     }
1933     if (callprojs.catchall_memproj != NULL) {
<a name="17" id="anc17"></a><span class="line-modified">1934       C-&gt;gvn_replace_by(callprojs.catchall_memproj,   ekit.reset_memory());</span>


1935     }
1936     if (callprojs.catchall_ioproj != NULL) {
1937       C-&gt;gvn_replace_by(callprojs.catchall_ioproj,    ekit.i_o());
1938     }
1939 
1940     // Replace the old exception object with the newly created one
1941     if (callprojs.exobj != NULL) {
1942       C-&gt;gvn_replace_by(callprojs.exobj, ex_oop);
1943     }
1944   }
1945 
1946   // Disconnect the call from the graph
1947   call-&gt;disconnect_inputs(NULL, C);
1948   C-&gt;gvn_replace_by(call, C-&gt;top());
1949 
1950   // Clean up any MergeMems that feed other MergeMems since the
1951   // optimizer doesn&#39;t like that.
<a name="18" id="anc18"></a><span class="line-modified">1952   if (final_mem-&gt;is_MergeMem()) {</span>
<span class="line-modified">1953     Node_List wl;</span>
<span class="line-removed">1954     for (SimpleDUIterator i(final_mem); i.has_next(); i.next()) {</span>
<span class="line-removed">1955       Node* m = i.get();</span>
<span class="line-removed">1956       if (m-&gt;is_MergeMem() &amp;&amp; !wl.contains(m)) {</span>
<span class="line-removed">1957         wl.push(m);</span>
<span class="line-removed">1958       }</span>
<span class="line-removed">1959     }</span>
<span class="line-removed">1960     while (wl.size()  &gt; 0) {</span>
<span class="line-removed">1961       _gvn.transform(wl.pop());</span>
<span class="line-removed">1962     }</span>
1963   }
1964 
1965   if (callprojs.fallthrough_catchproj != NULL &amp;&amp; !final_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
1966     replaced_nodes.apply(C, final_ctl);
1967   }
1968   if (!ex_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
1969     replaced_nodes_exception.apply(C, ex_ctl);
1970   }
1971 }
1972 
1973 
1974 //------------------------------increment_counter------------------------------
1975 // for statistics: increment a VM counter by 1
1976 
1977 void GraphKit::increment_counter(address counter_addr) {
1978   Node* adr1 = makecon(TypeRawPtr::make(counter_addr));
1979   increment_counter(adr1);
1980 }
1981 
1982 void GraphKit::increment_counter(Node* counter_addr) {
1983   int adr_type = Compile::AliasIdxRaw;
1984   Node* ctrl = control();
1985   Node* cnt  = make_load(ctrl, counter_addr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
1986   Node* incr = _gvn.transform(new AddINode(cnt, _gvn.intcon(1)));
1987   store_to_memory(ctrl, counter_addr, incr, T_INT, adr_type, MemNode::unordered);
1988 }
1989 
1990 
1991 //------------------------------uncommon_trap----------------------------------
1992 // Bail out to the interpreter in mid-method.  Implemented by calling the
1993 // uncommon_trap blob.  This helper function inserts a runtime call with the
1994 // right debug info.
1995 void GraphKit::uncommon_trap(int trap_request,
1996                              ciKlass* klass, const char* comment,
1997                              bool must_throw,
1998                              bool keep_exact_action) {
1999   if (failing())  stop();
2000   if (stopped())  return; // trap reachable?
2001 
2002   // Note:  If ProfileTraps is true, and if a deopt. actually
2003   // occurs here, the runtime will make sure an MDO exists.  There is
2004   // no need to call method()-&gt;ensure_method_data() at this point.
2005 
2006   // Set the stack pointer to the right value for reexecution:
2007   set_sp(reexecute_sp());
2008 
2009 #ifdef ASSERT
2010   if (!must_throw) {
2011     // Make sure the stack has at least enough depth to execute
2012     // the current bytecode.
2013     int inputs, ignored_depth;
2014     if (compute_stack_effects(inputs, ignored_depth)) {
2015       assert(sp() &gt;= inputs, &quot;must have enough JVMS stack to execute %s: sp=%d, inputs=%d&quot;,
2016              Bytecodes::name(java_bc()), sp(), inputs);
2017     }
2018   }
2019 #endif
2020 
2021   Deoptimization::DeoptReason reason = Deoptimization::trap_request_reason(trap_request);
2022   Deoptimization::DeoptAction action = Deoptimization::trap_request_action(trap_request);
2023 
2024   switch (action) {
2025   case Deoptimization::Action_maybe_recompile:
2026   case Deoptimization::Action_reinterpret:
2027     // Temporary fix for 6529811 to allow virtual calls to be sure they
2028     // get the chance to go from mono-&gt;bi-&gt;mega
2029     if (!keep_exact_action &amp;&amp;
2030         Deoptimization::trap_request_index(trap_request) &lt; 0 &amp;&amp;
2031         too_many_recompiles(reason)) {
2032       // This BCI is causing too many recompilations.
2033       if (C-&gt;log() != NULL) {
2034         C-&gt;log()-&gt;elem(&quot;observe that=&#39;trap_action_change&#39; reason=&#39;%s&#39; from=&#39;%s&#39; to=&#39;none&#39;&quot;,
2035                 Deoptimization::trap_reason_name(reason),
2036                 Deoptimization::trap_action_name(action));
2037       }
2038       action = Deoptimization::Action_none;
2039       trap_request = Deoptimization::make_trap_request(reason, action);
2040     } else {
2041       C-&gt;set_trap_can_recompile(true);
2042     }
2043     break;
2044   case Deoptimization::Action_make_not_entrant:
2045     C-&gt;set_trap_can_recompile(true);
2046     break;
2047   case Deoptimization::Action_none:
2048   case Deoptimization::Action_make_not_compilable:
2049     break;
2050   default:
2051 #ifdef ASSERT
2052     fatal(&quot;unknown action %d: %s&quot;, action, Deoptimization::trap_action_name(action));
2053 #endif
2054     break;
2055   }
2056 
2057   if (TraceOptoParse) {
2058     char buf[100];
2059     tty-&gt;print_cr(&quot;Uncommon trap %s at bci:%d&quot;,
2060                   Deoptimization::format_trap_request(buf, sizeof(buf),
2061                                                       trap_request), bci());
2062   }
2063 
2064   CompileLog* log = C-&gt;log();
2065   if (log != NULL) {
2066     int kid = (klass == NULL)? -1: log-&gt;identify(klass);
2067     log-&gt;begin_elem(&quot;uncommon_trap bci=&#39;%d&#39;&quot;, bci());
2068     char buf[100];
2069     log-&gt;print(&quot; %s&quot;, Deoptimization::format_trap_request(buf, sizeof(buf),
2070                                                           trap_request));
2071     if (kid &gt;= 0)         log-&gt;print(&quot; klass=&#39;%d&#39;&quot;, kid);
2072     if (comment != NULL)  log-&gt;print(&quot; comment=&#39;%s&#39;&quot;, comment);
2073     log-&gt;end_elem();
2074   }
2075 
2076   // Make sure any guarding test views this path as very unlikely
2077   Node *i0 = control()-&gt;in(0);
2078   if (i0 != NULL &amp;&amp; i0-&gt;is_If()) {        // Found a guarding if test?
2079     IfNode *iff = i0-&gt;as_If();
2080     float f = iff-&gt;_prob;   // Get prob
2081     if (control()-&gt;Opcode() == Op_IfTrue) {
2082       if (f &gt; PROB_UNLIKELY_MAG(4))
2083         iff-&gt;_prob = PROB_MIN;
2084     } else {
2085       if (f &lt; PROB_LIKELY_MAG(4))
2086         iff-&gt;_prob = PROB_MAX;
2087     }
2088   }
2089 
2090   // Clear out dead values from the debug info.
2091   kill_dead_locals();
2092 
2093   // Now insert the uncommon trap subroutine call
2094   address call_addr = SharedRuntime::uncommon_trap_blob()-&gt;entry_point();
2095   const TypePtr* no_memory_effects = NULL;
2096   // Pass the index of the class to be loaded
2097   Node* call = make_runtime_call(RC_NO_LEAF | RC_UNCOMMON |
2098                                  (must_throw ? RC_MUST_THROW : 0),
2099                                  OptoRuntime::uncommon_trap_Type(),
2100                                  call_addr, &quot;uncommon_trap&quot;, no_memory_effects,
2101                                  intcon(trap_request));
2102   assert(call-&gt;as_CallStaticJava()-&gt;uncommon_trap_request() == trap_request,
2103          &quot;must extract request correctly from the graph&quot;);
2104   assert(trap_request != 0, &quot;zero value reserved by uncommon_trap_request&quot;);
2105 
2106   call-&gt;set_req(TypeFunc::ReturnAdr, returnadr());
2107   // The debug info is the only real input to this call.
2108 
2109   // Halt-and-catch fire here.  The above call should never return!
<a name="19" id="anc19"></a><span class="line-modified">2110   HaltNode* halt = new HaltNode(control(), frameptr());</span>
2111   _gvn.set_type_bottom(halt);
2112   root()-&gt;add_req(halt);
2113 
2114   stop_and_kill_map();
2115 }
2116 
2117 
2118 //--------------------------just_allocated_object------------------------------
2119 // Report the object that was just allocated.
2120 // It must be the case that there are no intervening safepoints.
2121 // We use this to determine if an object is so &quot;fresh&quot; that
2122 // it does not require card marks.
2123 Node* GraphKit::just_allocated_object(Node* current_control) {
2124   Node* ctrl = current_control;
2125   // Object::&lt;init&gt; is invoked after allocation, most of invoke nodes
2126   // will be reduced, but a region node is kept in parse time, we check
2127   // the pattern and skip the region node if it degraded to a copy.
2128   if (ctrl != NULL &amp;&amp; ctrl-&gt;is_Region() &amp;&amp; ctrl-&gt;req() == 2 &amp;&amp;
2129       ctrl-&gt;as_Region()-&gt;is_copy()) {
2130     ctrl = ctrl-&gt;as_Region()-&gt;is_copy();
2131   }
2132   if (C-&gt;recent_alloc_ctl() == ctrl) {
2133    return C-&gt;recent_alloc_obj();
2134   }
2135   return NULL;
2136 }
2137 
2138 
<a name="20" id="anc20"></a><span class="line-removed">2139 void GraphKit::round_double_arguments(ciMethod* dest_method) {</span>
<span class="line-removed">2140   // (Note:  TypeFunc::make has a cache that makes this fast.)</span>
<span class="line-removed">2141   const TypeFunc* tf    = TypeFunc::make(dest_method);</span>
<span class="line-removed">2142   int             nargs = tf-&gt;domain()-&gt;cnt() - TypeFunc::Parms;</span>
<span class="line-removed">2143   for (int j = 0; j &lt; nargs; j++) {</span>
<span class="line-removed">2144     const Type *targ = tf-&gt;domain()-&gt;field_at(j + TypeFunc::Parms);</span>
<span class="line-removed">2145     if( targ-&gt;basic_type() == T_DOUBLE ) {</span>
<span class="line-removed">2146       // If any parameters are doubles, they must be rounded before</span>
<span class="line-removed">2147       // the call, dstore_rounding does gvn.transform</span>
<span class="line-removed">2148       Node *arg = argument(j);</span>
<span class="line-removed">2149       arg = dstore_rounding(arg);</span>
<span class="line-removed">2150       set_argument(j, arg);</span>
<span class="line-removed">2151     }</span>
<span class="line-removed">2152   }</span>
<span class="line-removed">2153 }</span>
<span class="line-removed">2154 </span>
2155 /**
2156  * Record profiling data exact_kls for Node n with the type system so
2157  * that it can propagate it (speculation)
2158  *
2159  * @param n          node that the type applies to
2160  * @param exact_kls  type from profiling
2161  * @param maybe_null did profiling see null?
2162  *
2163  * @return           node with improved type
2164  */
2165 Node* GraphKit::record_profile_for_speculation(Node* n, ciKlass* exact_kls, ProfilePtrKind ptr_kind) {
2166   const Type* current_type = _gvn.type(n);
2167   assert(UseTypeSpeculation, &quot;type speculation must be on&quot;);
2168 
2169   const TypePtr* speculative = current_type-&gt;speculative();
2170 
2171   // Should the klass from the profile be recorded in the speculative type?
2172   if (current_type-&gt;would_improve_type(exact_kls, jvms()-&gt;depth())) {
2173     const TypeKlassPtr* tklass = TypeKlassPtr::make(exact_kls);
2174     const TypeOopPtr* xtype = tklass-&gt;as_instance_type();
2175     assert(xtype-&gt;klass_is_exact(), &quot;Should be exact&quot;);
2176     // Any reason to believe n is not null (from this profiling or a previous one)?
2177     assert(ptr_kind != ProfileAlwaysNull, &quot;impossible here&quot;);
2178     const TypePtr* ptr = (ptr_kind == ProfileMaybeNull &amp;&amp; current_type-&gt;speculative_maybe_null()) ? TypePtr::BOTTOM : TypePtr::NOTNULL;
2179     // record the new speculative type&#39;s depth
2180     speculative = xtype-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2181     speculative = speculative-&gt;with_inline_depth(jvms()-&gt;depth());
2182   } else if (current_type-&gt;would_improve_ptr(ptr_kind)) {
2183     // Profiling report that null was never seen so we can change the
2184     // speculative type to non null ptr.
2185     if (ptr_kind == ProfileAlwaysNull) {
2186       speculative = TypePtr::NULL_PTR;
2187     } else {
2188       assert(ptr_kind == ProfileNeverNull, &quot;nothing else is an improvement&quot;);
2189       const TypePtr* ptr = TypePtr::NOTNULL;
2190       if (speculative != NULL) {
2191         speculative = speculative-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2192       } else {
2193         speculative = ptr;
2194       }
2195     }
2196   }
2197 
2198   if (speculative != current_type-&gt;speculative()) {
2199     // Build a type with a speculative type (what we think we know
2200     // about the type but will need a guard when we use it)
2201     const TypeOopPtr* spec_type = TypeOopPtr::make(TypePtr::BotPTR, Type::OffsetBot, TypeOopPtr::InstanceBot, speculative);
2202     // We&#39;re changing the type, we need a new CheckCast node to carry
2203     // the new type. The new type depends on the control: what
2204     // profiling tells us is only valid from here as far as we can
2205     // tell.
2206     Node* cast = new CheckCastPPNode(control(), n, current_type-&gt;remove_speculative()-&gt;join_speculative(spec_type));
2207     cast = _gvn.transform(cast);
2208     replace_in_map(n, cast);
2209     n = cast;
2210   }
2211 
2212   return n;
2213 }
2214 
2215 /**
2216  * Record profiling data from receiver profiling at an invoke with the
2217  * type system so that it can propagate it (speculation)
2218  *
2219  * @param n  receiver node
2220  *
2221  * @return   node with improved type
2222  */
2223 Node* GraphKit::record_profiled_receiver_for_speculation(Node* n) {
2224   if (!UseTypeSpeculation) {
2225     return n;
2226   }
2227   ciKlass* exact_kls = profile_has_unique_klass();
2228   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2229   if ((java_bc() == Bytecodes::_checkcast ||
2230        java_bc() == Bytecodes::_instanceof ||
2231        java_bc() == Bytecodes::_aastore) &amp;&amp;
2232       method()-&gt;method_data()-&gt;is_mature()) {
2233     ciProfileData* data = method()-&gt;method_data()-&gt;bci_to_data(bci());
2234     if (data != NULL) {
2235       if (!data-&gt;as_BitData()-&gt;null_seen()) {
2236         ptr_kind = ProfileNeverNull;
2237       } else {
2238         assert(data-&gt;is_ReceiverTypeData(), &quot;bad profile data type&quot;);
2239         ciReceiverTypeData* call = (ciReceiverTypeData*)data-&gt;as_ReceiverTypeData();
2240         uint i = 0;
2241         for (; i &lt; call-&gt;row_limit(); i++) {
2242           ciKlass* receiver = call-&gt;receiver(i);
2243           if (receiver != NULL) {
2244             break;
2245           }
2246         }
2247         ptr_kind = (i == call-&gt;row_limit()) ? ProfileAlwaysNull : ProfileMaybeNull;
2248       }
2249     }
2250   }
2251   return record_profile_for_speculation(n, exact_kls, ptr_kind);
2252 }
2253 
2254 /**
2255  * Record profiling data from argument profiling at an invoke with the
2256  * type system so that it can propagate it (speculation)
2257  *
2258  * @param dest_method  target method for the call
2259  * @param bc           what invoke bytecode is this?
2260  */
2261 void GraphKit::record_profiled_arguments_for_speculation(ciMethod* dest_method, Bytecodes::Code bc) {
2262   if (!UseTypeSpeculation) {
2263     return;
2264   }
2265   const TypeFunc* tf    = TypeFunc::make(dest_method);
2266   int             nargs = tf-&gt;domain()-&gt;cnt() - TypeFunc::Parms;
2267   int skip = Bytecodes::has_receiver(bc) ? 1 : 0;
2268   for (int j = skip, i = 0; j &lt; nargs &amp;&amp; i &lt; TypeProfileArgsLimit; j++) {
2269     const Type *targ = tf-&gt;domain()-&gt;field_at(j + TypeFunc::Parms);
<a name="21" id="anc21"></a><span class="line-modified">2270     if (targ-&gt;basic_type() == T_OBJECT || targ-&gt;basic_type() == T_ARRAY) {</span>
2271       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2272       ciKlass* better_type = NULL;
2273       if (method()-&gt;argument_profiled_type(bci(), i, better_type, ptr_kind)) {
2274         record_profile_for_speculation(argument(j), better_type, ptr_kind);
2275       }
2276       i++;
2277     }
2278   }
2279 }
2280 
2281 /**
2282  * Record profiling data from parameter profiling at an invoke with
2283  * the type system so that it can propagate it (speculation)
2284  */
2285 void GraphKit::record_profiled_parameters_for_speculation() {
2286   if (!UseTypeSpeculation) {
2287     return;
2288   }
2289   for (int i = 0, j = 0; i &lt; method()-&gt;arg_size() ; i++) {
2290     if (_gvn.type(local(i))-&gt;isa_oopptr()) {
2291       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2292       ciKlass* better_type = NULL;
2293       if (method()-&gt;parameter_profiled_type(j, better_type, ptr_kind)) {
2294         record_profile_for_speculation(local(i), better_type, ptr_kind);
2295       }
2296       j++;
2297     }
2298   }
2299 }
2300 
2301 /**
2302  * Record profiling data from return value profiling at an invoke with
2303  * the type system so that it can propagate it (speculation)
2304  */
2305 void GraphKit::record_profiled_return_for_speculation() {
2306   if (!UseTypeSpeculation) {
2307     return;
2308   }
2309   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2310   ciKlass* better_type = NULL;
2311   if (method()-&gt;return_profiled_type(bci(), better_type, ptr_kind)) {
2312     // If profiling reports a single type for the return value,
2313     // feed it to the type system so it can propagate it as a
2314     // speculative type
2315     record_profile_for_speculation(stack(sp()-1), better_type, ptr_kind);
2316   }
2317 }
2318 
2319 void GraphKit::round_double_result(ciMethod* dest_method) {
<a name="22" id="anc22"></a><span class="line-modified">2320   // A non-strict method may return a double value which has an extended</span>
<span class="line-modified">2321   // exponent, but this must not be visible in a caller which is &#39;strict&#39;</span>
<span class="line-modified">2322   // If a strict caller invokes a non-strict callee, round a double result</span>












2323 
<a name="23" id="anc23"></a><span class="line-modified">2324   BasicType result_type = dest_method-&gt;return_type()-&gt;basic_type();</span>
<span class="line-modified">2325   assert( method() != NULL, &quot;must have caller context&quot;);</span>
<span class="line-modified">2326   if( result_type == T_DOUBLE &amp;&amp; method()-&gt;is_strict() &amp;&amp; !dest_method-&gt;is_strict() ) {</span>
<span class="line-modified">2327     // Destination method&#39;s return value is on top of stack</span>
<span class="line-modified">2328     // dstore_rounding() does gvn.transform</span>
<span class="line-modified">2329     Node *result = pop_pair();</span>
<span class="line-modified">2330     result = dstore_rounding(result);</span>
<span class="line-modified">2331     push_pair(result);</span>







2332   }
2333 }
2334 
2335 // rounding for strict float precision conformance
2336 Node* GraphKit::precision_rounding(Node* n) {
<a name="24" id="anc24"></a><span class="line-modified">2337   return UseStrictFP &amp;&amp; _method-&gt;flags().is_strict()</span>
<span class="line-modified">2338     &amp;&amp; UseSSE == 0 &amp;&amp; Matcher::strict_fp_requires_explicit_rounding</span>
<span class="line-modified">2339     ? _gvn.transform( new RoundFloatNode(0, n) )</span>
<span class="line-modified">2340     : n;</span>






2341 }
2342 
2343 // rounding for strict double precision conformance
2344 Node* GraphKit::dprecision_rounding(Node *n) {
<a name="25" id="anc25"></a><span class="line-modified">2345   return UseStrictFP &amp;&amp; _method-&gt;flags().is_strict()</span>
<span class="line-modified">2346     &amp;&amp; UseSSE &lt;= 1 &amp;&amp; Matcher::strict_fp_requires_explicit_rounding</span>
<span class="line-modified">2347     ? _gvn.transform( new RoundDoubleNode(0, n) )</span>
<span class="line-modified">2348     : n;</span>






2349 }
2350 
2351 // rounding for non-strict double stores
2352 Node* GraphKit::dstore_rounding(Node* n) {
<a name="26" id="anc26"></a><span class="line-modified">2353   return Matcher::strict_fp_requires_explicit_rounding</span>
<span class="line-modified">2354     &amp;&amp; UseSSE &lt;= 1</span>
<span class="line-modified">2355     ? _gvn.transform( new RoundDoubleNode(0, n) )</span>
<span class="line-modified">2356     : n;</span>






2357 }
2358 
2359 //=============================================================================
2360 // Generate a fast path/slow path idiom.  Graph looks like:
2361 // [foo] indicates that &#39;foo&#39; is a parameter
2362 //
2363 //              [in]     NULL
2364 //                 \    /
2365 //                  CmpP
2366 //                  Bool ne
2367 //                   If
2368 //                  /  \
2369 //              True    False-&lt;2&gt;
2370 //              / |
2371 //             /  cast_not_null
2372 //           Load  |    |   ^
2373 //        [fast_test]   |   |
2374 // gvn to   opt_test    |   |
2375 //          /    \      |  &lt;1&gt;
2376 //      True     False  |
2377 //        |         \\  |
2378 //   [slow_call]     \[fast_result]
2379 //    Ctl   Val       \      \
2380 //     |               \      \
2381 //    Catch       &lt;1&gt;   \      \
2382 //   /    \        ^     \      \
2383 //  Ex    No_Ex    |      \      \
2384 //  |       \   \  |       \ &lt;2&gt;  \
2385 //  ...      \  [slow_res] |  |    \   [null_result]
2386 //            \         \--+--+---  |  |
2387 //             \           | /    \ | /
2388 //              --------Region     Phi
2389 //
2390 //=============================================================================
2391 // Code is structured as a series of driver functions all called &#39;do_XXX&#39; that
2392 // call a set of helper functions.  Helper functions first, then drivers.
2393 
2394 //------------------------------null_check_oop---------------------------------
2395 // Null check oop.  Set null-path control into Region in slot 3.
2396 // Make a cast-not-nullness use the other not-null control.  Return cast.
2397 Node* GraphKit::null_check_oop(Node* value, Node* *null_control,
2398                                bool never_see_null,
2399                                bool safe_for_replace,
2400                                bool speculative) {
2401   // Initial NULL check taken path
2402   (*null_control) = top();
2403   Node* cast = null_check_common(value, T_OBJECT, false, null_control, speculative);
2404 
2405   // Generate uncommon_trap:
2406   if (never_see_null &amp;&amp; (*null_control) != top()) {
2407     // If we see an unexpected null at a check-cast we record it and force a
2408     // recompile; the offending check-cast will be compiled to handle NULLs.
2409     // If we see more than one offending BCI, then all checkcasts in the
2410     // method will be compiled to handle NULLs.
2411     PreserveJVMState pjvms(this);
2412     set_control(*null_control);
2413     replace_in_map(value, null());
2414     Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculative);
2415     uncommon_trap(reason,
2416                   Deoptimization::Action_make_not_entrant);
2417     (*null_control) = top();    // NULL path is dead
2418   }
2419   if ((*null_control) == top() &amp;&amp; safe_for_replace) {
2420     replace_in_map(value, cast);
2421   }
2422 
2423   // Cast away null-ness on the result
2424   return cast;
2425 }
2426 
2427 //------------------------------opt_iff----------------------------------------
2428 // Optimize the fast-check IfNode.  Set the fast-path region slot 2.
2429 // Return slow-path control.
2430 Node* GraphKit::opt_iff(Node* region, Node* iff) {
2431   IfNode *opt_iff = _gvn.transform(iff)-&gt;as_If();
2432 
2433   // Fast path taken; set region slot 2
2434   Node *fast_taken = _gvn.transform( new IfFalseNode(opt_iff) );
2435   region-&gt;init_req(2,fast_taken); // Capture fast-control
2436 
2437   // Fast path not-taken, i.e. slow path
2438   Node *slow_taken = _gvn.transform( new IfTrueNode(opt_iff) );
2439   return slow_taken;
2440 }
2441 
2442 //-----------------------------make_runtime_call-------------------------------
2443 Node* GraphKit::make_runtime_call(int flags,
2444                                   const TypeFunc* call_type, address call_addr,
2445                                   const char* call_name,
2446                                   const TypePtr* adr_type,
2447                                   // The following parms are all optional.
2448                                   // The first NULL ends the list.
2449                                   Node* parm0, Node* parm1,
2450                                   Node* parm2, Node* parm3,
2451                                   Node* parm4, Node* parm5,
2452                                   Node* parm6, Node* parm7) {
<a name="27" id="anc27"></a>

2453   // Slow-path call
2454   bool is_leaf = !(flags &amp; RC_NO_LEAF);
2455   bool has_io  = (!is_leaf &amp;&amp; !(flags &amp; RC_NO_IO));
2456   if (call_name == NULL) {
2457     assert(!is_leaf, &quot;must supply name for leaf&quot;);
2458     call_name = OptoRuntime::stub_name(call_addr);
2459   }
2460   CallNode* call;
2461   if (!is_leaf) {
2462     call = new CallStaticJavaNode(call_type, call_addr, call_name,
2463                                            bci(), adr_type);
2464   } else if (flags &amp; RC_NO_FP) {
2465     call = new CallLeafNoFPNode(call_type, call_addr, call_name, adr_type);
2466   } else {
2467     call = new CallLeafNode(call_type, call_addr, call_name, adr_type);
2468   }
2469 
2470   // The following is similar to set_edges_for_java_call,
2471   // except that the memory effects of the call are restricted to AliasIdxRaw.
2472 
2473   // Slow path call has no side-effects, uses few values
2474   bool wide_in  = !(flags &amp; RC_NARROW_MEM);
2475   bool wide_out = (C-&gt;get_alias_index(adr_type) == Compile::AliasIdxBot);
2476 
2477   Node* prev_mem = NULL;
2478   if (wide_in) {
2479     prev_mem = set_predefined_input_for_runtime_call(call);
2480   } else {
2481     assert(!wide_out, &quot;narrow in =&gt; narrow out&quot;);
2482     Node* narrow_mem = memory(adr_type);
2483     prev_mem = set_predefined_input_for_runtime_call(call, narrow_mem);
2484   }
2485 
2486   // Hook each parm in order.  Stop looking at the first NULL.
2487   if (parm0 != NULL) { call-&gt;init_req(TypeFunc::Parms+0, parm0);
2488   if (parm1 != NULL) { call-&gt;init_req(TypeFunc::Parms+1, parm1);
2489   if (parm2 != NULL) { call-&gt;init_req(TypeFunc::Parms+2, parm2);
2490   if (parm3 != NULL) { call-&gt;init_req(TypeFunc::Parms+3, parm3);
2491   if (parm4 != NULL) { call-&gt;init_req(TypeFunc::Parms+4, parm4);
2492   if (parm5 != NULL) { call-&gt;init_req(TypeFunc::Parms+5, parm5);
2493   if (parm6 != NULL) { call-&gt;init_req(TypeFunc::Parms+6, parm6);
2494   if (parm7 != NULL) { call-&gt;init_req(TypeFunc::Parms+7, parm7);
2495     /* close each nested if ===&gt; */  } } } } } } } }
2496   assert(call-&gt;in(call-&gt;req()-1) != NULL, &quot;must initialize all parms&quot;);
2497 
2498   if (!is_leaf) {
2499     // Non-leaves can block and take safepoints:
2500     add_safepoint_edges(call, ((flags &amp; RC_MUST_THROW) != 0));
2501   }
2502   // Non-leaves can throw exceptions:
2503   if (has_io) {
2504     call-&gt;set_req(TypeFunc::I_O, i_o());
2505   }
2506 
2507   if (flags &amp; RC_UNCOMMON) {
2508     // Set the count to a tiny probability.  Cf. Estimate_Block_Frequency.
2509     // (An &quot;if&quot; probability corresponds roughly to an unconditional count.
2510     // Sort of.)
2511     call-&gt;set_cnt(PROB_UNLIKELY_MAG(4));
2512   }
2513 
2514   Node* c = _gvn.transform(call);
2515   assert(c == call, &quot;cannot disappear&quot;);
2516 
2517   if (wide_out) {
2518     // Slow path call has full side-effects.
2519     set_predefined_output_for_runtime_call(call);
2520   } else {
2521     // Slow path call has few side-effects, and/or sets few values.
2522     set_predefined_output_for_runtime_call(call, prev_mem, adr_type);
2523   }
2524 
2525   if (has_io) {
2526     set_i_o(_gvn.transform(new ProjNode(call, TypeFunc::I_O)));
2527   }
2528   return call;
2529 
2530 }
2531 
2532 //------------------------------merge_memory-----------------------------------
2533 // Merge memory from one path into the current memory state.
2534 void GraphKit::merge_memory(Node* new_mem, Node* region, int new_path) {
2535   for (MergeMemStream mms(merged_memory(), new_mem-&gt;as_MergeMem()); mms.next_non_empty2(); ) {
2536     Node* old_slice = mms.force_memory();
2537     Node* new_slice = mms.memory2();
2538     if (old_slice != new_slice) {
2539       PhiNode* phi;
2540       if (old_slice-&gt;is_Phi() &amp;&amp; old_slice-&gt;as_Phi()-&gt;region() == region) {
2541         if (mms.is_empty()) {
2542           // clone base memory Phi&#39;s inputs for this memory slice
2543           assert(old_slice == mms.base_memory(), &quot;sanity&quot;);
2544           phi = PhiNode::make(region, NULL, Type::MEMORY, mms.adr_type(C));
2545           _gvn.set_type(phi, Type::MEMORY);
2546           for (uint i = 1; i &lt; phi-&gt;req(); i++) {
2547             phi-&gt;init_req(i, old_slice-&gt;in(i));
2548           }
2549         } else {
2550           phi = old_slice-&gt;as_Phi(); // Phi was generated already
2551         }
2552       } else {
2553         phi = PhiNode::make(region, old_slice, Type::MEMORY, mms.adr_type(C));
2554         _gvn.set_type(phi, Type::MEMORY);
2555       }
2556       phi-&gt;set_req(new_path, new_slice);
2557       mms.set_memory(phi);
2558     }
2559   }
2560 }
2561 
2562 //------------------------------make_slow_call_ex------------------------------
2563 // Make the exception handler hookups for the slow call
2564 void GraphKit::make_slow_call_ex(Node* call, ciInstanceKlass* ex_klass, bool separate_io_proj, bool deoptimize) {
2565   if (stopped())  return;
2566 
2567   // Make a catch node with just two handlers:  fall-through and catch-all
2568   Node* i_o  = _gvn.transform( new ProjNode(call, TypeFunc::I_O, separate_io_proj) );
2569   Node* catc = _gvn.transform( new CatchNode(control(), i_o, 2) );
2570   Node* norm = _gvn.transform( new CatchProjNode(catc, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci) );
2571   Node* excp = _gvn.transform( new CatchProjNode(catc, CatchProjNode::catch_all_index,    CatchProjNode::no_handler_bci) );
2572 
2573   { PreserveJVMState pjvms(this);
2574     set_control(excp);
2575     set_i_o(i_o);
2576 
2577     if (excp != top()) {
2578       if (deoptimize) {
2579         // Deoptimize if an exception is caught. Don&#39;t construct exception state in this case.
2580         uncommon_trap(Deoptimization::Reason_unhandled,
2581                       Deoptimization::Action_none);
2582       } else {
2583         // Create an exception state also.
2584         // Use an exact type if the caller has a specific exception.
2585         const Type* ex_type = TypeOopPtr::make_from_klass_unique(ex_klass)-&gt;cast_to_ptr_type(TypePtr::NotNull);
2586         Node*       ex_oop  = new CreateExNode(ex_type, control(), i_o);
2587         add_exception_state(make_exception_state(_gvn.transform(ex_oop)));
2588       }
2589     }
2590   }
2591 
2592   // Get the no-exception control from the CatchNode.
2593   set_control(norm);
2594 }
2595 
<a name="28" id="anc28"></a><span class="line-modified">2596 static IfNode* gen_subtype_check_compare(Node* ctrl, Node* in1, Node* in2, BoolTest::mask test, float p, PhaseGVN* gvn, BasicType bt) {</span>
2597   Node* cmp = NULL;
2598   switch(bt) {
2599   case T_INT: cmp = new CmpINode(in1, in2); break;
2600   case T_ADDRESS: cmp = new CmpPNode(in1, in2); break;
2601   default: fatal(&quot;unexpected comparison type %s&quot;, type2name(bt));
2602   }
<a name="29" id="anc29"></a><span class="line-modified">2603   gvn-&gt;transform(cmp);</span>
<span class="line-modified">2604   Node* bol = gvn-&gt;transform(new BoolNode(cmp, test));</span>
2605   IfNode* iff = new IfNode(ctrl, bol, p, COUNT_UNKNOWN);
<a name="30" id="anc30"></a><span class="line-modified">2606   gvn-&gt;transform(iff);</span>
<span class="line-modified">2607   if (!bol-&gt;is_Con()) gvn-&gt;record_for_igvn(iff);</span>
2608   return iff;
2609 }
2610 
<a name="31" id="anc31"></a>








































































2611 
2612 //-------------------------------gen_subtype_check-----------------------------
2613 // Generate a subtyping check.  Takes as input the subtype and supertype.
2614 // Returns 2 values: sets the default control() to the true path and returns
2615 // the false path.  Only reads invariant memory; sets no (visible) memory.
2616 // The PartialSubtypeCheckNode sets the hidden 1-word cache in the encoding
2617 // but that&#39;s not exposed to the optimizer.  This call also doesn&#39;t take in an
2618 // Object; if you wish to check an Object you need to load the Object&#39;s class
2619 // prior to coming here.
<a name="32" id="anc32"></a><span class="line-modified">2620 Node* Phase::gen_subtype_check(Node* subklass, Node* superklass, Node** ctrl, MergeMemNode* mem, PhaseGVN* gvn) {</span>
<span class="line-modified">2621   Compile* C = gvn-&gt;C;</span>
<span class="line-removed">2622 </span>
2623   if ((*ctrl)-&gt;is_top()) {
2624     return C-&gt;top();
2625   }
2626 
2627   // Fast check for identical types, perhaps identical constants.
2628   // The types can even be identical non-constants, in cases
2629   // involving Array.newInstance, Object.clone, etc.
2630   if (subklass == superklass)
2631     return C-&gt;top();             // false path is dead; no test needed.
2632 
<a name="33" id="anc33"></a><span class="line-modified">2633   if (gvn-&gt;type(superklass)-&gt;singleton()) {</span>
<span class="line-modified">2634     ciKlass* superk = gvn-&gt;type(superklass)-&gt;is_klassptr()-&gt;klass();</span>
<span class="line-modified">2635     ciKlass* subk   = gvn-&gt;type(subklass)-&gt;is_klassptr()-&gt;klass();</span>
2636 
2637     // In the common case of an exact superklass, try to fold up the
2638     // test before generating code.  You may ask, why not just generate
2639     // the code and then let it fold up?  The answer is that the generated
2640     // code will necessarily include null checks, which do not always
2641     // completely fold away.  If they are also needless, then they turn
2642     // into a performance loss.  Example:
2643     //    Foo[] fa = blah(); Foo x = fa[0]; fa[1] = x;
2644     // Here, the type of &#39;fa&#39; is often exact, so the store check
2645     // of fa[1]=x will fold up, without testing the nullness of x.
2646     switch (C-&gt;static_subtype_check(superk, subk)) {
2647     case Compile::SSC_always_false:
2648       {
2649         Node* always_fail = *ctrl;
<a name="34" id="anc34"></a><span class="line-modified">2650         *ctrl = gvn-&gt;C-&gt;top();</span>
2651         return always_fail;
2652       }
2653     case Compile::SSC_always_true:
2654       return C-&gt;top();
2655     case Compile::SSC_easy_test:
2656       {
2657         // Just do a direct pointer compare and be done.
2658         IfNode* iff = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_STATIC_FREQUENT, gvn, T_ADDRESS);
<a name="35" id="anc35"></a><span class="line-modified">2659         *ctrl = gvn-&gt;transform(new IfTrueNode(iff));</span>
<span class="line-modified">2660         return gvn-&gt;transform(new IfFalseNode(iff));</span>
2661       }
2662     case Compile::SSC_full_test:
2663       break;
2664     default:
2665       ShouldNotReachHere();
2666     }
2667   }
2668 
2669   // %%% Possible further optimization:  Even if the superklass is not exact,
2670   // if the subklass is the unique subtype of the superklass, the check
2671   // will always succeed.  We could leave a dependency behind to ensure this.
2672 
2673   // First load the super-klass&#39;s check-offset
<a name="36" id="anc36"></a><span class="line-modified">2674   Node *p1 = gvn-&gt;transform(new AddPNode(superklass, superklass, gvn-&gt;MakeConX(in_bytes(Klass::super_check_offset_offset()))));</span>
<span class="line-modified">2675   Node* m = mem-&gt;memory_at(C-&gt;get_alias_index(gvn-&gt;type(p1)-&gt;is_ptr()));</span>
<span class="line-modified">2676   Node *chk_off = gvn-&gt;transform(new LoadINode(NULL, m, p1, gvn-&gt;type(p1)-&gt;is_ptr(), TypeInt::INT, MemNode::unordered));</span>
2677   int cacheoff_con = in_bytes(Klass::secondary_super_cache_offset());
<a name="37" id="anc37"></a><span class="line-modified">2678   bool might_be_cache = (gvn-&gt;find_int_con(chk_off, cacheoff_con) == cacheoff_con);</span>
2679 
2680   // Load from the sub-klass&#39;s super-class display list, or a 1-word cache of
2681   // the secondary superclass list, or a failing value with a sentinel offset
2682   // if the super-klass is an interface or exceptionally deep in the Java
2683   // hierarchy and we have to scan the secondary superclass list the hard way.
2684   // Worst-case type is a little odd: NULL is allowed as a result (usually
2685   // klass loads can never produce a NULL).
2686   Node *chk_off_X = chk_off;
2687 #ifdef _LP64
<a name="38" id="anc38"></a><span class="line-modified">2688   chk_off_X = gvn-&gt;transform(new ConvI2LNode(chk_off_X));</span>
2689 #endif
<a name="39" id="anc39"></a><span class="line-modified">2690   Node *p2 = gvn-&gt;transform(new AddPNode(subklass,subklass,chk_off_X));</span>
2691   // For some types like interfaces the following loadKlass is from a 1-word
2692   // cache which is mutable so can&#39;t use immutable memory.  Other
2693   // types load from the super-class display table which is immutable.
<a name="40" id="anc40"></a><span class="line-modified">2694   m = mem-&gt;memory_at(C-&gt;get_alias_index(gvn-&gt;type(p2)-&gt;is_ptr()));</span>
<span class="line-modified">2695   Node *kmem = might_be_cache ? m : C-&gt;immutable_memory();</span>
<span class="line-modified">2696   Node *nkls = gvn-&gt;transform(LoadKlassNode::make(*gvn, NULL, kmem, p2, gvn-&gt;type(p2)-&gt;is_ptr(), TypeKlassPtr::OBJECT_OR_NULL));</span>







2697 
2698   // Compile speed common case: ARE a subtype and we canNOT fail
2699   if( superklass == nkls )
2700     return C-&gt;top();             // false path is dead; no test needed.
2701 
2702   // See if we get an immediate positive hit.  Happens roughly 83% of the
2703   // time.  Test to see if the value loaded just previously from the subklass
2704   // is exactly the superklass.
2705   IfNode *iff1 = gen_subtype_check_compare(*ctrl, superklass, nkls, BoolTest::eq, PROB_LIKELY(0.83f), gvn, T_ADDRESS);
<a name="41" id="anc41"></a><span class="line-modified">2706   Node *iftrue1 = gvn-&gt;transform( new IfTrueNode (iff1));</span>
<span class="line-modified">2707   *ctrl = gvn-&gt;transform(new IfFalseNode(iff1));</span>
2708 
2709   // Compile speed common case: Check for being deterministic right now.  If
2710   // chk_off is a constant and not equal to cacheoff then we are NOT a
2711   // subklass.  In this case we need exactly the 1 test above and we can
2712   // return those results immediately.
2713   if (!might_be_cache) {
2714     Node* not_subtype_ctrl = *ctrl;
2715     *ctrl = iftrue1; // We need exactly the 1 test above
2716     return not_subtype_ctrl;
2717   }
2718 
2719   // Gather the various success &amp; failures here
2720   RegionNode *r_ok_subtype = new RegionNode(4);
<a name="42" id="anc42"></a><span class="line-modified">2721   gvn-&gt;record_for_igvn(r_ok_subtype);</span>
2722   RegionNode *r_not_subtype = new RegionNode(3);
<a name="43" id="anc43"></a><span class="line-modified">2723   gvn-&gt;record_for_igvn(r_not_subtype);</span>
2724 
2725   r_ok_subtype-&gt;init_req(1, iftrue1);
2726 
2727   // Check for immediate negative hit.  Happens roughly 11% of the time (which
2728   // is roughly 63% of the remaining cases).  Test to see if the loaded
2729   // check-offset points into the subklass display list or the 1-element
2730   // cache.  If it points to the display (and NOT the cache) and the display
2731   // missed then it&#39;s not a subtype.
<a name="44" id="anc44"></a><span class="line-modified">2732   Node *cacheoff = gvn-&gt;intcon(cacheoff_con);</span>
2733   IfNode *iff2 = gen_subtype_check_compare(*ctrl, chk_off, cacheoff, BoolTest::ne, PROB_LIKELY(0.63f), gvn, T_INT);
<a name="45" id="anc45"></a><span class="line-modified">2734   r_not_subtype-&gt;init_req(1, gvn-&gt;transform(new IfTrueNode (iff2)));</span>
<span class="line-modified">2735   *ctrl = gvn-&gt;transform(new IfFalseNode(iff2));</span>
2736 
2737   // Check for self.  Very rare to get here, but it is taken 1/3 the time.
2738   // No performance impact (too rare) but allows sharing of secondary arrays
2739   // which has some footprint reduction.
2740   IfNode *iff3 = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_LIKELY(0.36f), gvn, T_ADDRESS);
<a name="46" id="anc46"></a><span class="line-modified">2741   r_ok_subtype-&gt;init_req(2, gvn-&gt;transform(new IfTrueNode(iff3)));</span>
<span class="line-modified">2742   *ctrl = gvn-&gt;transform(new IfFalseNode(iff3));</span>
2743 
2744   // -- Roads not taken here: --
2745   // We could also have chosen to perform the self-check at the beginning
2746   // of this code sequence, as the assembler does.  This would not pay off
2747   // the same way, since the optimizer, unlike the assembler, can perform
2748   // static type analysis to fold away many successful self-checks.
2749   // Non-foldable self checks work better here in second position, because
2750   // the initial primary superclass check subsumes a self-check for most
2751   // types.  An exception would be a secondary type like array-of-interface,
2752   // which does not appear in its own primary supertype display.
2753   // Finally, we could have chosen to move the self-check into the
2754   // PartialSubtypeCheckNode, and from there out-of-line in a platform
2755   // dependent manner.  But it is worthwhile to have the check here,
2756   // where it can be perhaps be optimized.  The cost in code space is
2757   // small (register compare, branch).
2758 
2759   // Now do a linear scan of the secondary super-klass array.  Again, no real
2760   // performance impact (too rare) but it&#39;s gotta be done.
2761   // Since the code is rarely used, there is no penalty for moving it
2762   // out of line, and it can only improve I-cache density.
2763   // The decision to inline or out-of-line this final check is platform
2764   // dependent, and is found in the AD file definition of PartialSubtypeCheck.
<a name="47" id="anc47"></a><span class="line-modified">2765   Node* psc = gvn-&gt;transform(</span>
2766     new PartialSubtypeCheckNode(*ctrl, subklass, superklass));
2767 
<a name="48" id="anc48"></a><span class="line-modified">2768   IfNode *iff4 = gen_subtype_check_compare(*ctrl, psc, gvn-&gt;zerocon(T_OBJECT), BoolTest::ne, PROB_FAIR, gvn, T_ADDRESS);</span>
<span class="line-modified">2769   r_not_subtype-&gt;init_req(2, gvn-&gt;transform(new IfTrueNode (iff4)));</span>
<span class="line-modified">2770   r_ok_subtype -&gt;init_req(3, gvn-&gt;transform(new IfFalseNode(iff4)));</span>
2771 
2772   // Return false path; set default control to true path.
<a name="49" id="anc49"></a><span class="line-modified">2773   *ctrl = gvn-&gt;transform(r_ok_subtype);</span>
<span class="line-modified">2774   return gvn-&gt;transform(r_not_subtype);</span>






















2775 }
2776 
2777 // Profile-driven exact type check:
2778 Node* GraphKit::type_check_receiver(Node* receiver, ciKlass* klass,
2779                                     float prob,
2780                                     Node* *casted_receiver) {
2781   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
2782   Node* recv_klass = load_object_klass(receiver);
2783   Node* want_klass = makecon(tklass);
2784   Node* cmp = _gvn.transform( new CmpPNode(recv_klass, want_klass) );
2785   Node* bol = _gvn.transform( new BoolNode(cmp, BoolTest::eq) );
2786   IfNode* iff = create_and_xform_if(control(), bol, prob, COUNT_UNKNOWN);
2787   set_control( _gvn.transform( new IfTrueNode (iff) ));
2788   Node* fail = _gvn.transform( new IfFalseNode(iff) );
2789 
2790   const TypeOopPtr* recv_xtype = tklass-&gt;as_instance_type();
2791   assert(recv_xtype-&gt;klass_is_exact(), &quot;&quot;);
2792 
2793   // Subsume downstream occurrences of receiver with a cast to
2794   // recv_xtype, since now we know what the type will be.
2795   Node* cast = new CheckCastPPNode(control(), receiver, recv_xtype);
2796   (*casted_receiver) = _gvn.transform(cast);
2797   // (User must make the replace_in_map call.)
2798 
2799   return fail;
2800 }
2801 
2802 //------------------------------subtype_check_receiver-------------------------
2803 Node* GraphKit::subtype_check_receiver(Node* receiver, ciKlass* klass,
2804                                        Node** casted_receiver) {
2805   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
<a name="50" id="anc50"></a><span class="line-removed">2806   Node* recv_klass = load_object_klass(receiver);</span>
2807   Node* want_klass = makecon(tklass);
2808 
<a name="51" id="anc51"></a><span class="line-modified">2809   Node* slow_ctl = gen_subtype_check(recv_klass, want_klass);</span>
2810 
2811   // Cast receiver after successful check
2812   const TypeOopPtr* recv_type = tklass-&gt;cast_to_exactness(false)-&gt;is_klassptr()-&gt;as_instance_type();
2813   Node* cast = new CheckCastPPNode(control(), receiver, recv_type);
2814   (*casted_receiver) = _gvn.transform(cast);
2815 
2816   return slow_ctl;
2817 }
2818 
2819 //------------------------------seems_never_null-------------------------------
2820 // Use null_seen information if it is available from the profile.
2821 // If we see an unexpected null at a type check we record it and force a
2822 // recompile; the offending check will be recompiled to handle NULLs.
2823 // If we see several offending BCIs, then all checks in the
2824 // method will be recompiled.
2825 bool GraphKit::seems_never_null(Node* obj, ciProfileData* data, bool&amp; speculating) {
2826   speculating = !_gvn.type(obj)-&gt;speculative_maybe_null();
2827   Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculating);
2828   if (UncommonNullCast               // Cutout for this technique
2829       &amp;&amp; obj != null()               // And not the -Xcomp stupid case?
2830       &amp;&amp; !too_many_traps(reason)
2831       ) {
2832     if (speculating) {
2833       return true;
2834     }
2835     if (data == NULL)
2836       // Edge case:  no mature data.  Be optimistic here.
2837       return true;
2838     // If the profile has not seen a null, assume it won&#39;t happen.
2839     assert(java_bc() == Bytecodes::_checkcast ||
2840            java_bc() == Bytecodes::_instanceof ||
2841            java_bc() == Bytecodes::_aastore, &quot;MDO must collect null_seen bit here&quot;);
2842     return !data-&gt;as_BitData()-&gt;null_seen();
2843   }
2844   speculating = false;
2845   return false;
2846 }
2847 
<a name="52" id="anc52"></a>





















































2848 //------------------------maybe_cast_profiled_receiver-------------------------
2849 // If the profile has seen exactly one type, narrow to exactly that type.
2850 // Subsequent type checks will always fold up.
2851 Node* GraphKit::maybe_cast_profiled_receiver(Node* not_null_obj,
2852                                              ciKlass* require_klass,
2853                                              ciKlass* spec_klass,
2854                                              bool safe_for_replace) {
2855   if (!UseTypeProfile || !TypeProfileCasts) return NULL;
2856 
2857   Deoptimization::DeoptReason reason = Deoptimization::reason_class_check(spec_klass != NULL);
2858 
2859   // Make sure we haven&#39;t already deoptimized from this tactic.
2860   if (too_many_traps_or_recompiles(reason))
2861     return NULL;
2862 
2863   // (No, this isn&#39;t a call, but it&#39;s enough like a virtual call
2864   // to use the same ciMethod accessor to get the profile info...)
2865   // If we have a speculative type use it instead of profiling (which
2866   // may not help us)
2867   ciKlass* exact_kls = spec_klass == NULL ? profile_has_unique_klass() : spec_klass;
2868   if (exact_kls != NULL) {// no cast failures here
2869     if (require_klass == NULL ||
2870         C-&gt;static_subtype_check(require_klass, exact_kls) == Compile::SSC_always_true) {
2871       // If we narrow the type to match what the type profile sees or
2872       // the speculative type, we can then remove the rest of the
2873       // cast.
2874       // This is a win, even if the exact_kls is very specific,
2875       // because downstream operations, such as method calls,
2876       // will often benefit from the sharper type.
2877       Node* exact_obj = not_null_obj; // will get updated in place...
2878       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
2879                                             &amp;exact_obj);
2880       { PreserveJVMState pjvms(this);
2881         set_control(slow_ctl);
2882         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
2883       }
2884       if (safe_for_replace) {
2885         replace_in_map(not_null_obj, exact_obj);
2886       }
2887       return exact_obj;
2888     }
2889     // assert(ssc == Compile::SSC_always_true)... except maybe the profile lied to us.
2890   }
2891 
2892   return NULL;
2893 }
2894 
2895 /**
2896  * Cast obj to type and emit guard unless we had too many traps here
2897  * already
2898  *
2899  * @param obj       node being casted
2900  * @param type      type to cast the node to
2901  * @param not_null  true if we know node cannot be null
2902  */
2903 Node* GraphKit::maybe_cast_profiled_obj(Node* obj,
2904                                         ciKlass* type,
2905                                         bool not_null) {
2906   if (stopped()) {
2907     return obj;
2908   }
2909 
2910   // type == NULL if profiling tells us this object is always null
2911   if (type != NULL) {
2912     Deoptimization::DeoptReason class_reason = Deoptimization::Reason_speculate_class_check;
2913     Deoptimization::DeoptReason null_reason = Deoptimization::Reason_speculate_null_check;
2914 
2915     if (!too_many_traps_or_recompiles(null_reason) &amp;&amp;
2916         !too_many_traps_or_recompiles(class_reason)) {
2917       Node* not_null_obj = NULL;
2918       // not_null is true if we know the object is not null and
2919       // there&#39;s no need for a null check
2920       if (!not_null) {
2921         Node* null_ctl = top();
2922         not_null_obj = null_check_oop(obj, &amp;null_ctl, true, true, true);
2923         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
2924       } else {
2925         not_null_obj = obj;
2926       }
2927 
2928       Node* exact_obj = not_null_obj;
2929       ciKlass* exact_kls = type;
2930       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
2931                                             &amp;exact_obj);
2932       {
2933         PreserveJVMState pjvms(this);
2934         set_control(slow_ctl);
2935         uncommon_trap_exact(class_reason, Deoptimization::Action_maybe_recompile);
2936       }
2937       replace_in_map(not_null_obj, exact_obj);
2938       obj = exact_obj;
2939     }
2940   } else {
2941     if (!too_many_traps_or_recompiles(Deoptimization::Reason_null_assert)) {
2942       Node* exact_obj = null_assert(obj);
2943       replace_in_map(obj, exact_obj);
2944       obj = exact_obj;
2945     }
2946   }
2947   return obj;
2948 }
2949 
2950 //-------------------------------gen_instanceof--------------------------------
2951 // Generate an instance-of idiom.  Used by both the instance-of bytecode
2952 // and the reflective instance-of call.
2953 Node* GraphKit::gen_instanceof(Node* obj, Node* superklass, bool safe_for_replace) {
2954   kill_dead_locals();           // Benefit all the uncommon traps
2955   assert( !stopped(), &quot;dead parse path should be checked in callers&quot; );
2956   assert(!TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(superklass)-&gt;is_klassptr()),
2957          &quot;must check for not-null not-dead klass in callers&quot;);
2958 
2959   // Make the merge point
2960   enum { _obj_path = 1, _fail_path, _null_path, PATH_LIMIT };
2961   RegionNode* region = new RegionNode(PATH_LIMIT);
2962   Node*       phi    = new PhiNode(region, TypeInt::BOOL);
2963   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
2964 
2965   ciProfileData* data = NULL;
2966   if (java_bc() == Bytecodes::_instanceof) {  // Only for the bytecode
2967     data = method()-&gt;method_data()-&gt;bci_to_data(bci());
2968   }
2969   bool speculative_not_null = false;
2970   bool never_see_null = (ProfileDynamicTypes  // aggressive use of profile
2971                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
2972 
2973   // Null check; get casted pointer; set region slot 3
2974   Node* null_ctl = top();
2975   Node* not_null_obj = null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
2976 
2977   // If not_null_obj is dead, only null-path is taken
2978   if (stopped()) {              // Doing instance-of on a NULL?
2979     set_control(null_ctl);
2980     return intcon(0);
2981   }
2982   region-&gt;init_req(_null_path, null_ctl);
2983   phi   -&gt;init_req(_null_path, intcon(0)); // Set null path value
2984   if (null_ctl == top()) {
2985     // Do this eagerly, so that pattern matches like is_diamond_phi
2986     // will work even during parsing.
2987     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
2988     region-&gt;del_req(_null_path);
2989     phi   -&gt;del_req(_null_path);
2990   }
2991 
2992   // Do we know the type check always succeed?
2993   bool known_statically = false;
2994   if (_gvn.type(superklass)-&gt;singleton()) {
2995     ciKlass* superk = _gvn.type(superklass)-&gt;is_klassptr()-&gt;klass();
2996     ciKlass* subk = _gvn.type(obj)-&gt;is_oopptr()-&gt;klass();
2997     if (subk != NULL &amp;&amp; subk-&gt;is_loaded()) {
2998       int static_res = C-&gt;static_subtype_check(superk, subk);
2999       known_statically = (static_res == Compile::SSC_always_true || static_res == Compile::SSC_always_false);
3000     }
3001   }
3002 
3003   if (!known_statically) {
3004     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3005     // We may not have profiling here or it may not help us. If we
3006     // have a speculative type use it to perform an exact cast.
3007     ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3008     if (spec_obj_type != NULL || (ProfileDynamicTypes &amp;&amp; data != NULL)) {
3009       Node* cast_obj = maybe_cast_profiled_receiver(not_null_obj, NULL, spec_obj_type, safe_for_replace);
3010       if (stopped()) {            // Profile disagrees with this path.
3011         set_control(null_ctl);    // Null is the only remaining possibility.
3012         return intcon(0);
3013       }
3014       if (cast_obj != NULL) {
3015         not_null_obj = cast_obj;
3016       }
3017     }
3018   }
3019 
<a name="53" id="anc53"></a><span class="line-removed">3020   // Load the object&#39;s klass</span>
<span class="line-removed">3021   Node* obj_klass = load_object_klass(not_null_obj);</span>
<span class="line-removed">3022 </span>
3023   // Generate the subtype check
<a name="54" id="anc54"></a><span class="line-modified">3024   Node* not_subtype_ctrl = gen_subtype_check(obj_klass, superklass);</span>
3025 
3026   // Plug in the success path to the general merge in slot 1.
3027   region-&gt;init_req(_obj_path, control());
3028   phi   -&gt;init_req(_obj_path, intcon(1));
3029 
3030   // Plug in the failing path to the general merge in slot 2.
3031   region-&gt;init_req(_fail_path, not_subtype_ctrl);
3032   phi   -&gt;init_req(_fail_path, intcon(0));
3033 
3034   // Return final merged results
3035   set_control( _gvn.transform(region) );
3036   record_for_igvn(region);
3037 
3038   // If we know the type check always succeeds then we don&#39;t use the
3039   // profiling data at this bytecode. Don&#39;t lose it, feed it to the
3040   // type system as a speculative type.
3041   if (safe_for_replace) {
3042     Node* casted_obj = record_profiled_receiver_for_speculation(obj);
3043     replace_in_map(obj, casted_obj);
3044   }
3045 
3046   return _gvn.transform(phi);
3047 }
3048 
3049 //-------------------------------gen_checkcast---------------------------------
3050 // Generate a checkcast idiom.  Used by both the checkcast bytecode and the
3051 // array store bytecode.  Stack must be as-if BEFORE doing the bytecode so the
3052 // uncommon-trap paths work.  Adjust stack after this call.
3053 // If failure_control is supplied and not null, it is filled in with
3054 // the control edge for the cast failure.  Otherwise, an appropriate
3055 // uncommon trap or exception is thrown.
3056 Node* GraphKit::gen_checkcast(Node *obj, Node* superklass,
3057                               Node* *failure_control) {
3058   kill_dead_locals();           // Benefit all the uncommon traps
3059   const TypeKlassPtr *tk = _gvn.type(superklass)-&gt;is_klassptr();
3060   const Type *toop = TypeOopPtr::make_from_klass(tk-&gt;klass());
3061 
3062   // Fast cutout:  Check the case that the cast is vacuously true.
3063   // This detects the common cases where the test will short-circuit
3064   // away completely.  We do this before we perform the null check,
3065   // because if the test is going to turn into zero code, we don&#39;t
3066   // want a residual null check left around.  (Causes a slowdown,
3067   // for example, in some objArray manipulations, such as a[i]=a[j].)
3068   if (tk-&gt;singleton()) {
3069     const TypeOopPtr* objtp = _gvn.type(obj)-&gt;isa_oopptr();
3070     if (objtp != NULL &amp;&amp; objtp-&gt;klass() != NULL) {
3071       switch (C-&gt;static_subtype_check(tk-&gt;klass(), objtp-&gt;klass())) {
3072       case Compile::SSC_always_true:
3073         // If we know the type check always succeed then we don&#39;t use
3074         // the profiling data at this bytecode. Don&#39;t lose it, feed it
3075         // to the type system as a speculative type.
3076         return record_profiled_receiver_for_speculation(obj);
3077       case Compile::SSC_always_false:
3078         // It needs a null check because a null will *pass* the cast check.
3079         // A non-null value will always produce an exception.
3080         return null_assert(obj);
3081       }
3082     }
3083   }
3084 
3085   ciProfileData* data = NULL;
3086   bool safe_for_replace = false;
3087   if (failure_control == NULL) {        // use MDO in regular case only
3088     assert(java_bc() == Bytecodes::_aastore ||
3089            java_bc() == Bytecodes::_checkcast,
3090            &quot;interpreter profiles type checks only for these BCs&quot;);
3091     data = method()-&gt;method_data()-&gt;bci_to_data(bci());
3092     safe_for_replace = true;
3093   }
3094 
3095   // Make the merge point
3096   enum { _obj_path = 1, _null_path, PATH_LIMIT };
3097   RegionNode* region = new RegionNode(PATH_LIMIT);
3098   Node*       phi    = new PhiNode(region, toop);
3099   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3100 
3101   // Use null-cast information if it is available
3102   bool speculative_not_null = false;
3103   bool never_see_null = ((failure_control == NULL)  // regular case only
3104                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
3105 
3106   // Null check; get casted pointer; set region slot 3
3107   Node* null_ctl = top();
3108   Node* not_null_obj = null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
3109 
3110   // If not_null_obj is dead, only null-path is taken
3111   if (stopped()) {              // Doing instance-of on a NULL?
3112     set_control(null_ctl);
3113     return null();
3114   }
3115   region-&gt;init_req(_null_path, null_ctl);
3116   phi   -&gt;init_req(_null_path, null());  // Set null path value
3117   if (null_ctl == top()) {
3118     // Do this eagerly, so that pattern matches like is_diamond_phi
3119     // will work even during parsing.
3120     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
3121     region-&gt;del_req(_null_path);
3122     phi   -&gt;del_req(_null_path);
3123   }
3124 
3125   Node* cast_obj = NULL;
3126   if (tk-&gt;klass_is_exact()) {
3127     // The following optimization tries to statically cast the speculative type of the object
3128     // (for example obtained during profiling) to the type of the superklass and then do a
3129     // dynamic check that the type of the object is what we expect. To work correctly
3130     // for checkcast and aastore the type of superklass should be exact.
3131     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3132     // We may not have profiling here or it may not help us. If we have
3133     // a speculative type use it to perform an exact cast.
3134     ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3135     if (spec_obj_type != NULL || data != NULL) {
3136       cast_obj = maybe_cast_profiled_receiver(not_null_obj, tk-&gt;klass(), spec_obj_type, safe_for_replace);
3137       if (cast_obj != NULL) {
3138         if (failure_control != NULL) // failure is now impossible
3139           (*failure_control) = top();
3140         // adjust the type of the phi to the exact klass:
3141         phi-&gt;raise_bottom_type(_gvn.type(cast_obj)-&gt;meet_speculative(TypePtr::NULL_PTR));
3142       }
3143     }
3144   }
3145 
3146   if (cast_obj == NULL) {
<a name="55" id="anc55"></a><span class="line-removed">3147     // Load the object&#39;s klass</span>
<span class="line-removed">3148     Node* obj_klass = load_object_klass(not_null_obj);</span>
<span class="line-removed">3149 </span>
3150     // Generate the subtype check
<a name="56" id="anc56"></a><span class="line-modified">3151     Node* not_subtype_ctrl = gen_subtype_check( obj_klass, superklass );</span>
3152 
3153     // Plug in success path into the merge
3154     cast_obj = _gvn.transform(new CheckCastPPNode(control(), not_null_obj, toop));
3155     // Failure path ends in uncommon trap (or may be dead - failure impossible)
3156     if (failure_control == NULL) {
3157       if (not_subtype_ctrl != top()) { // If failure is possible
3158         PreserveJVMState pjvms(this);
3159         set_control(not_subtype_ctrl);
<a name="57" id="anc57"></a><span class="line-modified">3160         builtin_throw(Deoptimization::Reason_class_check, obj_klass);</span>
3161       }
3162     } else {
3163       (*failure_control) = not_subtype_ctrl;
3164     }
3165   }
3166 
3167   region-&gt;init_req(_obj_path, control());
3168   phi   -&gt;init_req(_obj_path, cast_obj);
3169 
3170   // A merge of NULL or Casted-NotNull obj
3171   Node* res = _gvn.transform(phi);
3172 
3173   // Note I do NOT always &#39;replace_in_map(obj,result)&#39; here.
3174   //  if( tk-&gt;klass()-&gt;can_be_primary_super()  )
3175     // This means that if I successfully store an Object into an array-of-String
3176     // I &#39;forget&#39; that the Object is really now known to be a String.  I have to
3177     // do this because we don&#39;t have true union types for interfaces - if I store
3178     // a Baz into an array-of-Interface and then tell the optimizer it&#39;s an
3179     // Interface, I forget that it&#39;s also a Baz and cannot do Baz-like field
3180     // references to it.  FIX THIS WHEN UNION TYPES APPEAR!
3181   //  replace_in_map( obj, res );
3182 
3183   // Return final merged results
3184   set_control( _gvn.transform(region) );
3185   record_for_igvn(region);
3186 
3187   return record_profiled_receiver_for_speculation(res);
3188 }
3189 
3190 //------------------------------next_monitor-----------------------------------
3191 // What number should be given to the next monitor?
3192 int GraphKit::next_monitor() {
3193   int current = jvms()-&gt;monitor_depth()* C-&gt;sync_stack_slots();
3194   int next = current + C-&gt;sync_stack_slots();
3195   // Keep the toplevel high water mark current:
3196   if (C-&gt;fixed_slots() &lt; next)  C-&gt;set_fixed_slots(next);
3197   return current;
3198 }
3199 
3200 //------------------------------insert_mem_bar---------------------------------
3201 // Memory barrier to avoid floating things around
3202 // The membar serves as a pinch point between both control and all memory slices.
3203 Node* GraphKit::insert_mem_bar(int opcode, Node* precedent) {
3204   MemBarNode* mb = MemBarNode::make(C, opcode, Compile::AliasIdxBot, precedent);
3205   mb-&gt;init_req(TypeFunc::Control, control());
3206   mb-&gt;init_req(TypeFunc::Memory,  reset_memory());
3207   Node* membar = _gvn.transform(mb);
3208   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3209   set_all_memory_call(membar);
3210   return membar;
3211 }
3212 
3213 //-------------------------insert_mem_bar_volatile----------------------------
3214 // Memory barrier to avoid floating things around
3215 // The membar serves as a pinch point between both control and memory(alias_idx).
3216 // If you want to make a pinch point on all memory slices, do not use this
3217 // function (even with AliasIdxBot); use insert_mem_bar() instead.
3218 Node* GraphKit::insert_mem_bar_volatile(int opcode, int alias_idx, Node* precedent) {
3219   // When Parse::do_put_xxx updates a volatile field, it appends a series
3220   // of MemBarVolatile nodes, one for *each* volatile field alias category.
3221   // The first membar is on the same memory slice as the field store opcode.
3222   // This forces the membar to follow the store.  (Bug 6500685 broke this.)
3223   // All the other membars (for other volatile slices, including AliasIdxBot,
3224   // which stands for all unknown volatile slices) are control-dependent
3225   // on the first membar.  This prevents later volatile loads or stores
3226   // from sliding up past the just-emitted store.
3227 
3228   MemBarNode* mb = MemBarNode::make(C, opcode, alias_idx, precedent);
3229   mb-&gt;set_req(TypeFunc::Control,control());
3230   if (alias_idx == Compile::AliasIdxBot) {
3231     mb-&gt;set_req(TypeFunc::Memory, merged_memory()-&gt;base_memory());
3232   } else {
3233     assert(!(opcode == Op_Initialize &amp;&amp; alias_idx != Compile::AliasIdxRaw), &quot;fix caller&quot;);
3234     mb-&gt;set_req(TypeFunc::Memory, memory(alias_idx));
3235   }
3236   Node* membar = _gvn.transform(mb);
3237   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3238   if (alias_idx == Compile::AliasIdxBot) {
3239     merged_memory()-&gt;set_base_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)));
3240   } else {
3241     set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)),alias_idx);
3242   }
3243   return membar;
3244 }
3245 
3246 //------------------------------shared_lock------------------------------------
3247 // Emit locking code.
3248 FastLockNode* GraphKit::shared_lock(Node* obj) {
3249   // bci is either a monitorenter bc or InvocationEntryBci
3250   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3251   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3252 
3253   if( !GenerateSynchronizationCode )
3254     return NULL;                // Not locking things?
3255   if (stopped())                // Dead monitor?
3256     return NULL;
3257 
3258   assert(dead_locals_are_killed(), &quot;should kill locals before sync. point&quot;);
3259 
<a name="58" id="anc58"></a><span class="line-removed">3260   obj = access_resolve(obj, ACCESS_READ | ACCESS_WRITE);</span>
<span class="line-removed">3261 </span>
3262   // Box the stack location
3263   Node* box = _gvn.transform(new BoxLockNode(next_monitor()));
3264   Node* mem = reset_memory();
3265 
3266   FastLockNode * flock = _gvn.transform(new FastLockNode(0, obj, box) )-&gt;as_FastLock();
3267   if (UseBiasedLocking &amp;&amp; PrintPreciseBiasedLockingStatistics) {
3268     // Create the counters for this fast lock.
3269     flock-&gt;create_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3270   }
3271 
3272   // Create the rtm counters for this fast lock if needed.
3273   flock-&gt;create_rtm_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3274 
3275   // Add monitor to debug info for the slow path.  If we block inside the
3276   // slow path and de-opt, we need the monitor hanging around
3277   map()-&gt;push_monitor( flock );
3278 
3279   const TypeFunc *tf = LockNode::lock_type();
3280   LockNode *lock = new LockNode(C, tf);
3281 
3282   lock-&gt;init_req( TypeFunc::Control, control() );
3283   lock-&gt;init_req( TypeFunc::Memory , mem );
3284   lock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3285   lock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3286   lock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3287 
3288   lock-&gt;init_req(TypeFunc::Parms + 0, obj);
3289   lock-&gt;init_req(TypeFunc::Parms + 1, box);
3290   lock-&gt;init_req(TypeFunc::Parms + 2, flock);
3291   add_safepoint_edges(lock);
3292 
3293   lock = _gvn.transform( lock )-&gt;as_Lock();
3294 
3295   // lock has no side-effects, sets few values
3296   set_predefined_output_for_runtime_call(lock, mem, TypeRawPtr::BOTTOM);
3297 
3298   insert_mem_bar(Op_MemBarAcquireLock);
3299 
3300   // Add this to the worklist so that the lock can be eliminated
3301   record_for_igvn(lock);
3302 
3303 #ifndef PRODUCT
3304   if (PrintLockStatistics) {
3305     // Update the counter for this lock.  Don&#39;t bother using an atomic
3306     // operation since we don&#39;t require absolute accuracy.
3307     lock-&gt;create_lock_counter(map()-&gt;jvms());
3308     increment_counter(lock-&gt;counter()-&gt;addr());
3309   }
3310 #endif
3311 
3312   return flock;
3313 }
3314 
3315 
3316 //------------------------------shared_unlock----------------------------------
3317 // Emit unlocking code.
3318 void GraphKit::shared_unlock(Node* box, Node* obj) {
3319   // bci is either a monitorenter bc or InvocationEntryBci
3320   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3321   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3322 
3323   if( !GenerateSynchronizationCode )
3324     return;
3325   if (stopped()) {               // Dead monitor?
3326     map()-&gt;pop_monitor();        // Kill monitor from debug info
3327     return;
3328   }
3329 
3330   // Memory barrier to avoid floating things down past the locked region
3331   insert_mem_bar(Op_MemBarReleaseLock);
3332 
3333   const TypeFunc *tf = OptoRuntime::complete_monitor_exit_Type();
3334   UnlockNode *unlock = new UnlockNode(C, tf);
3335 #ifdef ASSERT
3336   unlock-&gt;set_dbg_jvms(sync_jvms());
3337 #endif
3338   uint raw_idx = Compile::AliasIdxRaw;
3339   unlock-&gt;init_req( TypeFunc::Control, control() );
3340   unlock-&gt;init_req( TypeFunc::Memory , memory(raw_idx) );
3341   unlock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3342   unlock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3343   unlock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3344 
3345   unlock-&gt;init_req(TypeFunc::Parms + 0, obj);
3346   unlock-&gt;init_req(TypeFunc::Parms + 1, box);
3347   unlock = _gvn.transform(unlock)-&gt;as_Unlock();
3348 
3349   Node* mem = reset_memory();
3350 
3351   // unlock has no side-effects, sets few values
3352   set_predefined_output_for_runtime_call(unlock, mem, TypeRawPtr::BOTTOM);
3353 
3354   // Kill monitor from debug info
3355   map()-&gt;pop_monitor( );
3356 }
3357 
3358 //-------------------------------get_layout_helper-----------------------------
3359 // If the given klass is a constant or known to be an array,
3360 // fetch the constant layout helper value into constant_value
3361 // and return (Node*)NULL.  Otherwise, load the non-constant
3362 // layout helper value, and return the node which represents it.
3363 // This two-faced routine is useful because allocation sites
3364 // almost always feature constant types.
3365 Node* GraphKit::get_layout_helper(Node* klass_node, jint&amp; constant_value) {
3366   const TypeKlassPtr* inst_klass = _gvn.type(klass_node)-&gt;isa_klassptr();
3367   if (!StressReflectiveCode &amp;&amp; inst_klass != NULL) {
3368     ciKlass* klass = inst_klass-&gt;klass();
3369     bool    xklass = inst_klass-&gt;klass_is_exact();
3370     if (xklass || klass-&gt;is_array_klass()) {
3371       jint lhelper = klass-&gt;layout_helper();
3372       if (lhelper != Klass::_lh_neutral_value) {
3373         constant_value = lhelper;
3374         return (Node*) NULL;
3375       }
3376     }
3377   }
3378   constant_value = Klass::_lh_neutral_value;  // put in a known value
3379   Node* lhp = basic_plus_adr(klass_node, klass_node, in_bytes(Klass::layout_helper_offset()));
3380   return make_load(NULL, lhp, TypeInt::INT, T_INT, MemNode::unordered);
3381 }
3382 
3383 // We just put in an allocate/initialize with a big raw-memory effect.
3384 // Hook selected additional alias categories on the initialization.
3385 static void hook_memory_on_init(GraphKit&amp; kit, int alias_idx,
3386                                 MergeMemNode* init_in_merge,
3387                                 Node* init_out_raw) {
3388   DEBUG_ONLY(Node* init_in_raw = init_in_merge-&gt;base_memory());
3389   assert(init_in_merge-&gt;memory_at(alias_idx) == init_in_raw, &quot;&quot;);
3390 
3391   Node* prevmem = kit.memory(alias_idx);
3392   init_in_merge-&gt;set_memory_at(alias_idx, prevmem);
3393   kit.set_memory(init_out_raw, alias_idx);
3394 }
3395 
3396 //---------------------------set_output_for_allocation-------------------------
3397 Node* GraphKit::set_output_for_allocation(AllocateNode* alloc,
3398                                           const TypeOopPtr* oop_type,
3399                                           bool deoptimize_on_exception) {
3400   int rawidx = Compile::AliasIdxRaw;
3401   alloc-&gt;set_req( TypeFunc::FramePtr, frameptr() );
3402   add_safepoint_edges(alloc);
3403   Node* allocx = _gvn.transform(alloc);
3404   set_control( _gvn.transform(new ProjNode(allocx, TypeFunc::Control) ) );
3405   // create memory projection for i_o
3406   set_memory ( _gvn.transform( new ProjNode(allocx, TypeFunc::Memory, true) ), rawidx );
3407   make_slow_call_ex(allocx, env()-&gt;Throwable_klass(), true, deoptimize_on_exception);
3408 
3409   // create a memory projection as for the normal control path
3410   Node* malloc = _gvn.transform(new ProjNode(allocx, TypeFunc::Memory));
3411   set_memory(malloc, rawidx);
3412 
3413   // a normal slow-call doesn&#39;t change i_o, but an allocation does
3414   // we create a separate i_o projection for the normal control path
3415   set_i_o(_gvn.transform( new ProjNode(allocx, TypeFunc::I_O, false) ) );
3416   Node* rawoop = _gvn.transform( new ProjNode(allocx, TypeFunc::Parms) );
3417 
3418   // put in an initialization barrier
3419   InitializeNode* init = insert_mem_bar_volatile(Op_Initialize, rawidx,
3420                                                  rawoop)-&gt;as_Initialize();
3421   assert(alloc-&gt;initialization() == init,  &quot;2-way macro link must work&quot;);
3422   assert(init -&gt;allocation()     == alloc, &quot;2-way macro link must work&quot;);
3423   {
3424     // Extract memory strands which may participate in the new object&#39;s
3425     // initialization, and source them from the new InitializeNode.
3426     // This will allow us to observe initializations when they occur,
3427     // and link them properly (as a group) to the InitializeNode.
3428     assert(init-&gt;in(InitializeNode::Memory) == malloc, &quot;&quot;);
3429     MergeMemNode* minit_in = MergeMemNode::make(malloc);
3430     init-&gt;set_req(InitializeNode::Memory, minit_in);
3431     record_for_igvn(minit_in); // fold it up later, if possible
3432     Node* minit_out = memory(rawidx);
3433     assert(minit_out-&gt;is_Proj() &amp;&amp; minit_out-&gt;in(0) == init, &quot;&quot;);
3434     // Add an edge in the MergeMem for the header fields so an access
3435     // to one of those has correct memory state
3436     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::mark_offset_in_bytes())));
3437     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::klass_offset_in_bytes())));
3438     if (oop_type-&gt;isa_aryptr()) {
3439       const TypePtr* telemref = oop_type-&gt;add_offset(Type::OffsetBot);
3440       int            elemidx  = C-&gt;get_alias_index(telemref);
3441       hook_memory_on_init(*this, elemidx, minit_in, minit_out);
3442     } else if (oop_type-&gt;isa_instptr()) {
3443       ciInstanceKlass* ik = oop_type-&gt;klass()-&gt;as_instance_klass();
3444       for (int i = 0, len = ik-&gt;nof_nonstatic_fields(); i &lt; len; i++) {
3445         ciField* field = ik-&gt;nonstatic_field_at(i);
3446         if (field-&gt;offset() &gt;= TrackedInitializationLimit * HeapWordSize)
3447           continue;  // do not bother to track really large numbers of fields
3448         // Find (or create) the alias category for this field:
3449         int fieldidx = C-&gt;alias_type(field)-&gt;index();
3450         hook_memory_on_init(*this, fieldidx, minit_in, minit_out);
3451       }
3452     }
3453   }
3454 
3455   // Cast raw oop to the real thing...
3456   Node* javaoop = new CheckCastPPNode(control(), rawoop, oop_type);
3457   javaoop = _gvn.transform(javaoop);
3458   C-&gt;set_recent_alloc(control(), javaoop);
3459   assert(just_allocated_object(control()) == javaoop, &quot;just allocated&quot;);
3460 
3461 #ifdef ASSERT
3462   { // Verify that the AllocateNode::Ideal_allocation recognizers work:
3463     assert(AllocateNode::Ideal_allocation(rawoop, &amp;_gvn) == alloc,
3464            &quot;Ideal_allocation works&quot;);
3465     assert(AllocateNode::Ideal_allocation(javaoop, &amp;_gvn) == alloc,
3466            &quot;Ideal_allocation works&quot;);
3467     if (alloc-&gt;is_AllocateArray()) {
3468       assert(AllocateArrayNode::Ideal_array_allocation(rawoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
3469              &quot;Ideal_allocation works&quot;);
3470       assert(AllocateArrayNode::Ideal_array_allocation(javaoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
3471              &quot;Ideal_allocation works&quot;);
3472     } else {
3473       assert(alloc-&gt;in(AllocateNode::ALength)-&gt;is_top(), &quot;no length, please&quot;);
3474     }
3475   }
3476 #endif //ASSERT
3477 
3478   return javaoop;
3479 }
3480 
3481 //---------------------------new_instance--------------------------------------
3482 // This routine takes a klass_node which may be constant (for a static type)
3483 // or may be non-constant (for reflective code).  It will work equally well
3484 // for either, and the graph will fold nicely if the optimizer later reduces
3485 // the type to a constant.
3486 // The optional arguments are for specialized use by intrinsics:
3487 //  - If &#39;extra_slow_test&#39; if not null is an extra condition for the slow-path.
3488 //  - If &#39;return_size_val&#39;, report the the total object size to the caller.
3489 //  - deoptimize_on_exception controls how Java exceptions are handled (rethrow vs deoptimize)
3490 Node* GraphKit::new_instance(Node* klass_node,
3491                              Node* extra_slow_test,
3492                              Node* *return_size_val,
3493                              bool deoptimize_on_exception) {
3494   // Compute size in doublewords
3495   // The size is always an integral number of doublewords, represented
3496   // as a positive bytewise size stored in the klass&#39;s layout_helper.
3497   // The layout_helper also encodes (in a low bit) the need for a slow path.
3498   jint  layout_con = Klass::_lh_neutral_value;
3499   Node* layout_val = get_layout_helper(klass_node, layout_con);
3500   int   layout_is_con = (layout_val == NULL);
3501 
3502   if (extra_slow_test == NULL)  extra_slow_test = intcon(0);
3503   // Generate the initial go-slow test.  It&#39;s either ALWAYS (return a
3504   // Node for 1) or NEVER (return a NULL) or perhaps (in the reflective
3505   // case) a computed value derived from the layout_helper.
3506   Node* initial_slow_test = NULL;
3507   if (layout_is_con) {
3508     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
3509     bool must_go_slow = Klass::layout_helper_needs_slow_path(layout_con);
3510     initial_slow_test = must_go_slow ? intcon(1) : extra_slow_test;
3511   } else {   // reflective case
3512     // This reflective path is used by Unsafe.allocateInstance.
3513     // (It may be stress-tested by specifying StressReflectiveCode.)
3514     // Basically, we want to get into the VM is there&#39;s an illegal argument.
3515     Node* bit = intcon(Klass::_lh_instance_slow_path_bit);
3516     initial_slow_test = _gvn.transform( new AndINode(layout_val, bit) );
3517     if (extra_slow_test != intcon(0)) {
3518       initial_slow_test = _gvn.transform( new OrINode(initial_slow_test, extra_slow_test) );
3519     }
3520     // (Macro-expander will further convert this to a Bool, if necessary.)
3521   }
3522 
3523   // Find the size in bytes.  This is easy; it&#39;s the layout_helper.
3524   // The size value must be valid even if the slow path is taken.
3525   Node* size = NULL;
3526   if (layout_is_con) {
3527     size = MakeConX(Klass::layout_helper_size_in_bytes(layout_con));
3528   } else {   // reflective case
3529     // This reflective path is used by clone and Unsafe.allocateInstance.
3530     size = ConvI2X(layout_val);
3531 
3532     // Clear the low bits to extract layout_helper_size_in_bytes:
3533     assert((int)Klass::_lh_instance_slow_path_bit &lt; BytesPerLong, &quot;clear bit&quot;);
3534     Node* mask = MakeConX(~ (intptr_t)right_n_bits(LogBytesPerLong));
3535     size = _gvn.transform( new AndXNode(size, mask) );
3536   }
3537   if (return_size_val != NULL) {
3538     (*return_size_val) = size;
3539   }
3540 
3541   // This is a precise notnull oop of the klass.
3542   // (Actually, it need not be precise if this is a reflective allocation.)
3543   // It&#39;s what we cast the result to.
3544   const TypeKlassPtr* tklass = _gvn.type(klass_node)-&gt;isa_klassptr();
3545   if (!tklass)  tklass = TypeKlassPtr::OBJECT;
3546   const TypeOopPtr* oop_type = tklass-&gt;as_instance_type();
3547 
3548   // Now generate allocation code
3549 
3550   // The entire memory state is needed for slow path of the allocation
3551   // since GC and deoptimization can happened.
3552   Node *mem = reset_memory();
3553   set_all_memory(mem); // Create new memory state
3554 
3555   AllocateNode* alloc = new AllocateNode(C, AllocateNode::alloc_type(Type::TOP),
3556                                          control(), mem, i_o(),
3557                                          size, klass_node,
3558                                          initial_slow_test);
3559 
3560   return set_output_for_allocation(alloc, oop_type, deoptimize_on_exception);
3561 }
3562 
3563 //-------------------------------new_array-------------------------------------
3564 // helper for both newarray and anewarray
3565 // The &#39;length&#39; parameter is (obviously) the length of the array.
3566 // See comments on new_instance for the meaning of the other arguments.
3567 Node* GraphKit::new_array(Node* klass_node,     // array klass (maybe variable)
3568                           Node* length,         // number of array elements
3569                           int   nargs,          // number of arguments to push back for uncommon trap
3570                           Node* *return_size_val,
3571                           bool deoptimize_on_exception) {
3572   jint  layout_con = Klass::_lh_neutral_value;
3573   Node* layout_val = get_layout_helper(klass_node, layout_con);
3574   int   layout_is_con = (layout_val == NULL);
3575 
3576   if (!layout_is_con &amp;&amp; !StressReflectiveCode &amp;&amp;
3577       !too_many_traps(Deoptimization::Reason_class_check)) {
3578     // This is a reflective array creation site.
3579     // Optimistically assume that it is a subtype of Object[],
3580     // so that we can fold up all the address arithmetic.
3581     layout_con = Klass::array_layout_helper(T_OBJECT);
3582     Node* cmp_lh = _gvn.transform( new CmpINode(layout_val, intcon(layout_con)) );
3583     Node* bol_lh = _gvn.transform( new BoolNode(cmp_lh, BoolTest::eq) );
3584     { BuildCutout unless(this, bol_lh, PROB_MAX);
3585       inc_sp(nargs);
3586       uncommon_trap(Deoptimization::Reason_class_check,
3587                     Deoptimization::Action_maybe_recompile);
3588     }
3589     layout_val = NULL;
3590     layout_is_con = true;
3591   }
3592 
3593   // Generate the initial go-slow test.  Make sure we do not overflow
3594   // if length is huge (near 2Gig) or negative!  We do not need
3595   // exact double-words here, just a close approximation of needed
3596   // double-words.  We can&#39;t add any offset or rounding bits, lest we
3597   // take a size -1 of bytes and make it positive.  Use an unsigned
3598   // compare, so negative sizes look hugely positive.
3599   int fast_size_limit = FastAllocateSizeLimit;
3600   if (layout_is_con) {
3601     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
3602     // Increase the size limit if we have exact knowledge of array type.
3603     int log2_esize = Klass::layout_helper_log2_element_size(layout_con);
3604     fast_size_limit &lt;&lt;= (LogBytesPerLong - log2_esize);
3605   }
3606 
3607   Node* initial_slow_cmp  = _gvn.transform( new CmpUNode( length, intcon( fast_size_limit ) ) );
3608   Node* initial_slow_test = _gvn.transform( new BoolNode( initial_slow_cmp, BoolTest::gt ) );
3609 
3610   // --- Size Computation ---
3611   // array_size = round_to_heap(array_header + (length &lt;&lt; elem_shift));
3612   // where round_to_heap(x) == align_to(x, MinObjAlignmentInBytes)
3613   // and align_to(x, y) == ((x + y-1) &amp; ~(y-1))
3614   // The rounding mask is strength-reduced, if possible.
3615   int round_mask = MinObjAlignmentInBytes - 1;
3616   Node* header_size = NULL;
3617   int   header_size_min  = arrayOopDesc::base_offset_in_bytes(T_BYTE);
3618   // (T_BYTE has the weakest alignment and size restrictions...)
3619   if (layout_is_con) {
3620     int       hsize  = Klass::layout_helper_header_size(layout_con);
3621     int       eshift = Klass::layout_helper_log2_element_size(layout_con);
3622     BasicType etype  = Klass::layout_helper_element_type(layout_con);
3623     if ((round_mask &amp; ~right_n_bits(eshift)) == 0)
3624       round_mask = 0;  // strength-reduce it if it goes away completely
3625     assert((hsize &amp; right_n_bits(eshift)) == 0, &quot;hsize is pre-rounded&quot;);
3626     assert(header_size_min &lt;= hsize, &quot;generic minimum is smallest&quot;);
3627     header_size_min = hsize;
3628     header_size = intcon(hsize + round_mask);
3629   } else {
3630     Node* hss   = intcon(Klass::_lh_header_size_shift);
3631     Node* hsm   = intcon(Klass::_lh_header_size_mask);
3632     Node* hsize = _gvn.transform( new URShiftINode(layout_val, hss) );
3633     hsize       = _gvn.transform( new AndINode(hsize, hsm) );
3634     Node* mask  = intcon(round_mask);
3635     header_size = _gvn.transform( new AddINode(hsize, mask) );
3636   }
3637 
3638   Node* elem_shift = NULL;
3639   if (layout_is_con) {
3640     int eshift = Klass::layout_helper_log2_element_size(layout_con);
3641     if (eshift != 0)
3642       elem_shift = intcon(eshift);
3643   } else {
3644     // There is no need to mask or shift this value.
3645     // The semantics of LShiftINode include an implicit mask to 0x1F.
3646     assert(Klass::_lh_log2_element_size_shift == 0, &quot;use shift in place&quot;);
3647     elem_shift = layout_val;
3648   }
3649 
3650   // Transition to native address size for all offset calculations:
3651   Node* lengthx = ConvI2X(length);
3652   Node* headerx = ConvI2X(header_size);
3653 #ifdef _LP64
3654   { const TypeInt* tilen = _gvn.find_int_type(length);
3655     if (tilen != NULL &amp;&amp; tilen-&gt;_lo &lt; 0) {
3656       // Add a manual constraint to a positive range.  Cf. array_element_address.
3657       jint size_max = fast_size_limit;
3658       if (size_max &gt; tilen-&gt;_hi)  size_max = tilen-&gt;_hi;
3659       const TypeInt* tlcon = TypeInt::make(0, size_max, Type::WidenMin);
3660 
3661       // Only do a narrow I2L conversion if the range check passed.
3662       IfNode* iff = new IfNode(control(), initial_slow_test, PROB_MIN, COUNT_UNKNOWN);
3663       _gvn.transform(iff);
3664       RegionNode* region = new RegionNode(3);
3665       _gvn.set_type(region, Type::CONTROL);
3666       lengthx = new PhiNode(region, TypeLong::LONG);
3667       _gvn.set_type(lengthx, TypeLong::LONG);
3668 
3669       // Range check passed. Use ConvI2L node with narrow type.
3670       Node* passed = IfFalse(iff);
3671       region-&gt;init_req(1, passed);
3672       // Make I2L conversion control dependent to prevent it from
3673       // floating above the range check during loop optimizations.
3674       lengthx-&gt;init_req(1, C-&gt;constrained_convI2L(&amp;_gvn, length, tlcon, passed));
3675 
3676       // Range check failed. Use ConvI2L with wide type because length may be invalid.
3677       region-&gt;init_req(2, IfTrue(iff));
3678       lengthx-&gt;init_req(2, ConvI2X(length));
3679 
3680       set_control(region);
3681       record_for_igvn(region);
3682       record_for_igvn(lengthx);
3683     }
3684   }
3685 #endif
3686 
3687   // Combine header size (plus rounding) and body size.  Then round down.
3688   // This computation cannot overflow, because it is used only in two
3689   // places, one where the length is sharply limited, and the other
3690   // after a successful allocation.
3691   Node* abody = lengthx;
3692   if (elem_shift != NULL)
3693     abody     = _gvn.transform( new LShiftXNode(lengthx, elem_shift) );
3694   Node* size  = _gvn.transform( new AddXNode(headerx, abody) );
3695   if (round_mask != 0) {
3696     Node* mask = MakeConX(~round_mask);
3697     size       = _gvn.transform( new AndXNode(size, mask) );
3698   }
3699   // else if round_mask == 0, the size computation is self-rounding
3700 
3701   if (return_size_val != NULL) {
3702     // This is the size
3703     (*return_size_val) = size;
3704   }
3705 
3706   // Now generate allocation code
3707 
3708   // The entire memory state is needed for slow path of the allocation
3709   // since GC and deoptimization can happened.
3710   Node *mem = reset_memory();
3711   set_all_memory(mem); // Create new memory state
3712 
3713   if (initial_slow_test-&gt;is_Bool()) {
3714     // Hide it behind a CMoveI, or else PhaseIdealLoop::split_up will get sick.
3715     initial_slow_test = initial_slow_test-&gt;as_Bool()-&gt;as_int_value(&amp;_gvn);
3716   }
3717 
3718   // Create the AllocateArrayNode and its result projections
3719   AllocateArrayNode* alloc
3720     = new AllocateArrayNode(C, AllocateArrayNode::alloc_type(TypeInt::INT),
3721                             control(), mem, i_o(),
3722                             size, klass_node,
3723                             initial_slow_test,
3724                             length);
3725 
3726   // Cast to correct type.  Note that the klass_node may be constant or not,
3727   // and in the latter case the actual array type will be inexact also.
3728   // (This happens via a non-constant argument to inline_native_newArray.)
3729   // In any case, the value of klass_node provides the desired array type.
3730   const TypeInt* length_type = _gvn.find_int_type(length);
3731   const TypeOopPtr* ary_type = _gvn.type(klass_node)-&gt;is_klassptr()-&gt;as_instance_type();
3732   if (ary_type-&gt;isa_aryptr() &amp;&amp; length_type != NULL) {
3733     // Try to get a better type than POS for the size
3734     ary_type = ary_type-&gt;is_aryptr()-&gt;cast_to_size(length_type);
3735   }
3736 
3737   Node* javaoop = set_output_for_allocation(alloc, ary_type, deoptimize_on_exception);
3738 
3739   // Cast length on remaining path to be as narrow as possible
3740   if (map()-&gt;find_edge(length) &gt;= 0) {
3741     Node* ccast = alloc-&gt;make_ideal_length(ary_type, &amp;_gvn);
3742     if (ccast != length) {
3743       _gvn.set_type_bottom(ccast);
3744       record_for_igvn(ccast);
3745       replace_in_map(length, ccast);
3746     }
3747   }
3748 
3749   return javaoop;
3750 }
3751 
3752 // The following &quot;Ideal_foo&quot; functions are placed here because they recognize
3753 // the graph shapes created by the functions immediately above.
3754 
3755 //---------------------------Ideal_allocation----------------------------------
3756 // Given an oop pointer or raw pointer, see if it feeds from an AllocateNode.
3757 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase) {
3758   if (ptr == NULL) {     // reduce dumb test in callers
3759     return NULL;
3760   }
3761 
3762   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
3763   ptr = bs-&gt;step_over_gc_barrier(ptr);
3764 
3765   if (ptr-&gt;is_CheckCastPP()) { // strip only one raw-to-oop cast
3766     ptr = ptr-&gt;in(1);
3767     if (ptr == NULL) return NULL;
3768   }
3769   // Return NULL for allocations with several casts:
3770   //   j.l.reflect.Array.newInstance(jobject, jint)
3771   //   Object.clone()
3772   // to keep more precise type from last cast.
3773   if (ptr-&gt;is_Proj()) {
3774     Node* allo = ptr-&gt;in(0);
3775     if (allo != NULL &amp;&amp; allo-&gt;is_Allocate()) {
3776       return allo-&gt;as_Allocate();
3777     }
3778   }
3779   // Report failure to match.
3780   return NULL;
3781 }
3782 
3783 // Fancy version which also strips off an offset (and reports it to caller).
3784 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase,
3785                                              intptr_t&amp; offset) {
3786   Node* base = AddPNode::Ideal_base_and_offset(ptr, phase, offset);
3787   if (base == NULL)  return NULL;
3788   return Ideal_allocation(base, phase);
3789 }
3790 
3791 // Trace Initialize &lt;- Proj[Parm] &lt;- Allocate
3792 AllocateNode* InitializeNode::allocation() {
3793   Node* rawoop = in(InitializeNode::RawAddress);
3794   if (rawoop-&gt;is_Proj()) {
3795     Node* alloc = rawoop-&gt;in(0);
3796     if (alloc-&gt;is_Allocate()) {
3797       return alloc-&gt;as_Allocate();
3798     }
3799   }
3800   return NULL;
3801 }
3802 
3803 // Trace Allocate -&gt; Proj[Parm] -&gt; Initialize
3804 InitializeNode* AllocateNode::initialization() {
3805   ProjNode* rawoop = proj_out_or_null(AllocateNode::RawAddress);
3806   if (rawoop == NULL)  return NULL;
3807   for (DUIterator_Fast imax, i = rawoop-&gt;fast_outs(imax); i &lt; imax; i++) {
3808     Node* init = rawoop-&gt;fast_out(i);
3809     if (init-&gt;is_Initialize()) {
3810       assert(init-&gt;as_Initialize()-&gt;allocation() == this, &quot;2-way link&quot;);
3811       return init-&gt;as_Initialize();
3812     }
3813   }
3814   return NULL;
3815 }
3816 
3817 //----------------------------- loop predicates ---------------------------
3818 
3819 //------------------------------add_predicate_impl----------------------------
3820 void GraphKit::add_predicate_impl(Deoptimization::DeoptReason reason, int nargs) {
3821   // Too many traps seen?
3822   if (too_many_traps(reason)) {
3823 #ifdef ASSERT
3824     if (TraceLoopPredicate) {
3825       int tc = C-&gt;trap_count(reason);
3826       tty-&gt;print(&quot;too many traps=%s tcount=%d in &quot;,
3827                     Deoptimization::trap_reason_name(reason), tc);
3828       method()-&gt;print(); // which method has too many predicate traps
3829       tty-&gt;cr();
3830     }
3831 #endif
3832     // We cannot afford to take more traps here,
3833     // do not generate predicate.
3834     return;
3835   }
3836 
3837   Node *cont    = _gvn.intcon(1);
3838   Node* opq     = _gvn.transform(new Opaque1Node(C, cont));
3839   Node *bol     = _gvn.transform(new Conv2BNode(opq));
3840   IfNode* iff   = create_and_map_if(control(), bol, PROB_MAX, COUNT_UNKNOWN);
3841   Node* iffalse = _gvn.transform(new IfFalseNode(iff));
3842   C-&gt;add_predicate_opaq(opq);
3843   {
3844     PreserveJVMState pjvms(this);
3845     set_control(iffalse);
3846     inc_sp(nargs);
3847     uncommon_trap(reason, Deoptimization::Action_maybe_recompile);
3848   }
3849   Node* iftrue = _gvn.transform(new IfTrueNode(iff));
3850   set_control(iftrue);
3851 }
3852 
3853 //------------------------------add_predicate---------------------------------
3854 void GraphKit::add_predicate(int nargs) {
3855   if (UseLoopPredicate) {
3856     add_predicate_impl(Deoptimization::Reason_predicate, nargs);
3857   }
3858   if (UseProfiledLoopPredicate) {
3859     add_predicate_impl(Deoptimization::Reason_profile_predicate, nargs);
3860   }
3861   // loop&#39;s limit check predicate should be near the loop.
3862   add_predicate_impl(Deoptimization::Reason_loop_limit_check, nargs);
3863 }
3864 
3865 void GraphKit::sync_kit(IdealKit&amp; ideal) {
3866   set_all_memory(ideal.merged_memory());
3867   set_i_o(ideal.i_o());
3868   set_control(ideal.ctrl());
3869 }
3870 
3871 void GraphKit::final_sync(IdealKit&amp; ideal) {
3872   // Final sync IdealKit and graphKit.
3873   sync_kit(ideal);
3874 }
3875 
3876 Node* GraphKit::load_String_length(Node* str, bool set_ctrl) {
3877   Node* len = load_array_length(load_String_value(str, set_ctrl));
3878   Node* coder = load_String_coder(str, set_ctrl);
3879   // Divide length by 2 if coder is UTF16
3880   return _gvn.transform(new RShiftINode(len, coder));
3881 }
3882 
3883 Node* GraphKit::load_String_value(Node* str, bool set_ctrl) {
3884   int value_offset = java_lang_String::value_offset_in_bytes();
3885   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
3886                                                      false, NULL, 0);
3887   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
3888   const TypeAryPtr* value_type = TypeAryPtr::make(TypePtr::NotNull,
3889                                                   TypeAry::make(TypeInt::BYTE, TypeInt::POS),
3890                                                   ciTypeArrayKlass::make(T_BYTE), true, 0);
3891   Node* p = basic_plus_adr(str, str, value_offset);
3892   Node* load = access_load_at(str, p, value_field_type, value_type, T_OBJECT,
3893                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
3894   return load;
3895 }
3896 
3897 Node* GraphKit::load_String_coder(Node* str, bool set_ctrl) {
3898   if (!CompactStrings) {
3899     return intcon(java_lang_String::CODER_UTF16);
3900   }
3901   int coder_offset = java_lang_String::coder_offset_in_bytes();
3902   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
3903                                                      false, NULL, 0);
3904   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
3905 
3906   Node* p = basic_plus_adr(str, str, coder_offset);
3907   Node* load = access_load_at(str, p, coder_field_type, TypeInt::BYTE, T_BYTE,
3908                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
3909   return load;
3910 }
3911 
3912 void GraphKit::store_String_value(Node* str, Node* value) {
3913   int value_offset = java_lang_String::value_offset_in_bytes();
3914   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
3915                                                      false, NULL, 0);
3916   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
3917 
3918   access_store_at(str,  basic_plus_adr(str, value_offset), value_field_type,
3919                   value, TypeAryPtr::BYTES, T_OBJECT, IN_HEAP | MO_UNORDERED);
3920 }
3921 
3922 void GraphKit::store_String_coder(Node* str, Node* value) {
3923   int coder_offset = java_lang_String::coder_offset_in_bytes();
3924   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
3925                                                      false, NULL, 0);
3926   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
3927 
3928   access_store_at(str, basic_plus_adr(str, coder_offset), coder_field_type,
3929                   value, TypeInt::BYTE, T_BYTE, IN_HEAP | MO_UNORDERED);
3930 }
3931 
3932 // Capture src and dst memory state with a MergeMemNode
3933 Node* GraphKit::capture_memory(const TypePtr* src_type, const TypePtr* dst_type) {
3934   if (src_type == dst_type) {
3935     // Types are equal, we don&#39;t need a MergeMemNode
3936     return memory(src_type);
3937   }
3938   MergeMemNode* merge = MergeMemNode::make(map()-&gt;memory());
3939   record_for_igvn(merge); // fold it up later, if possible
3940   int src_idx = C-&gt;get_alias_index(src_type);
3941   int dst_idx = C-&gt;get_alias_index(dst_type);
3942   merge-&gt;set_memory_at(src_idx, memory(src_idx));
3943   merge-&gt;set_memory_at(dst_idx, memory(dst_idx));
3944   return merge;
3945 }
3946 
3947 Node* GraphKit::compress_string(Node* src, const TypeAryPtr* src_type, Node* dst, Node* count) {
3948   assert(Matcher::match_rule_supported(Op_StrCompressedCopy), &quot;Intrinsic not supported&quot;);
3949   assert(src_type == TypeAryPtr::BYTES || src_type == TypeAryPtr::CHARS, &quot;invalid source type&quot;);
3950   // If input and output memory types differ, capture both states to preserve
3951   // the dependency between preceding and subsequent loads/stores.
3952   // For example, the following program:
3953   //  StoreB
3954   //  compress_string
3955   //  LoadB
3956   // has this memory graph (use-&gt;def):
3957   //  LoadB -&gt; compress_string -&gt; CharMem
3958   //             ... -&gt; StoreB -&gt; ByteMem
3959   // The intrinsic hides the dependency between LoadB and StoreB, causing
3960   // the load to read from memory not containing the result of the StoreB.
3961   // The correct memory graph should look like this:
3962   //  LoadB -&gt; compress_string -&gt; MergeMem(CharMem, StoreB(ByteMem))
3963   Node* mem = capture_memory(src_type, TypeAryPtr::BYTES);
3964   StrCompressedCopyNode* str = new StrCompressedCopyNode(control(), mem, src, dst, count);
3965   Node* res_mem = _gvn.transform(new SCMemProjNode(str));
3966   set_memory(res_mem, TypeAryPtr::BYTES);
3967   return str;
3968 }
3969 
3970 void GraphKit::inflate_string(Node* src, Node* dst, const TypeAryPtr* dst_type, Node* count) {
3971   assert(Matcher::match_rule_supported(Op_StrInflatedCopy), &quot;Intrinsic not supported&quot;);
3972   assert(dst_type == TypeAryPtr::BYTES || dst_type == TypeAryPtr::CHARS, &quot;invalid dest type&quot;);
3973   // Capture src and dst memory (see comment in &#39;compress_string&#39;).
3974   Node* mem = capture_memory(TypeAryPtr::BYTES, dst_type);
3975   StrInflatedCopyNode* str = new StrInflatedCopyNode(control(), mem, src, dst, count);
3976   set_memory(_gvn.transform(str), dst_type);
3977 }
3978 
3979 void GraphKit::inflate_string_slow(Node* src, Node* dst, Node* start, Node* count) {
3980   /**
3981    * int i_char = start;
3982    * for (int i_byte = 0; i_byte &lt; count; i_byte++) {
3983    *   dst[i_char++] = (char)(src[i_byte] &amp; 0xff);
3984    * }
3985    */
<a name="59" id="anc59"></a><span class="line-removed">3986   src = access_resolve(src, ACCESS_READ);</span>
<span class="line-removed">3987   dst = access_resolve(dst, ACCESS_WRITE);</span>
3988   add_predicate();
3989   RegionNode* head = new RegionNode(3);
3990   head-&gt;init_req(1, control());
3991   gvn().set_type(head, Type::CONTROL);
3992   record_for_igvn(head);
3993 
3994   Node* i_byte = new PhiNode(head, TypeInt::INT);
3995   i_byte-&gt;init_req(1, intcon(0));
3996   gvn().set_type(i_byte, TypeInt::INT);
3997   record_for_igvn(i_byte);
3998 
3999   Node* i_char = new PhiNode(head, TypeInt::INT);
4000   i_char-&gt;init_req(1, start);
4001   gvn().set_type(i_char, TypeInt::INT);
4002   record_for_igvn(i_char);
4003 
4004   Node* mem = PhiNode::make(head, memory(TypeAryPtr::BYTES), Type::MEMORY, TypeAryPtr::BYTES);
4005   gvn().set_type(mem, Type::MEMORY);
4006   record_for_igvn(mem);
4007   set_control(head);
4008   set_memory(mem, TypeAryPtr::BYTES);
4009   Node* ch = load_array_element(control(), src, i_byte, TypeAryPtr::BYTES);
4010   Node* st = store_to_memory(control(), array_element_address(dst, i_char, T_BYTE),
4011                              AndI(ch, intcon(0xff)), T_CHAR, TypeAryPtr::BYTES, MemNode::unordered,
4012                              false, false, true /* mismatched */);
4013 
4014   IfNode* iff = create_and_map_if(head, Bool(CmpI(i_byte, count), BoolTest::lt), PROB_FAIR, COUNT_UNKNOWN);
4015   head-&gt;init_req(2, IfTrue(iff));
4016   mem-&gt;init_req(2, st);
4017   i_byte-&gt;init_req(2, AddI(i_byte, intcon(1)));
4018   i_char-&gt;init_req(2, AddI(i_char, intcon(2)));
4019 
4020   set_control(IfFalse(iff));
4021   set_memory(st, TypeAryPtr::BYTES);
4022 }
4023 
4024 Node* GraphKit::make_constant_from_field(ciField* field, Node* obj) {
4025   if (!field-&gt;is_constant()) {
4026     return NULL; // Field not marked as constant.
4027   }
4028   ciInstance* holder = NULL;
4029   if (!field-&gt;is_static()) {
4030     ciObject* const_oop = obj-&gt;bottom_type()-&gt;is_oopptr()-&gt;const_oop();
4031     if (const_oop != NULL &amp;&amp; const_oop-&gt;is_instance()) {
4032       holder = const_oop-&gt;as_instance();
4033     }
4034   }
4035   const Type* con_type = Type::make_constant_from_field(field, holder, field-&gt;layout_type(),
4036                                                         /*is_unsigned_load=*/false);
4037   if (con_type != NULL) {
4038     return makecon(con_type);
4039   }
4040   return NULL;
4041 }
<a name="60" id="anc60"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="60" type="hidden" />
</body>
</html>