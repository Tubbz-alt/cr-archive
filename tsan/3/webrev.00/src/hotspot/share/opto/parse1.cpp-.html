<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/parse1.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileLog.hpp&quot;
  27 #include &quot;interpreter/linkResolver.hpp&quot;
  28 #include &quot;memory/resourceArea.hpp&quot;
  29 #include &quot;oops/method.hpp&quot;
  30 #include &quot;opto/addnode.hpp&quot;
  31 #include &quot;opto/c2compiler.hpp&quot;
  32 #include &quot;opto/castnode.hpp&quot;
  33 #include &quot;opto/idealGraphPrinter.hpp&quot;
  34 #include &quot;opto/locknode.hpp&quot;
  35 #include &quot;opto/memnode.hpp&quot;
  36 #include &quot;opto/opaquenode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/handles.inline.hpp&quot;
  42 #include &quot;runtime/safepointMechanism.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;utilities/copy.hpp&quot;
  45 
  46 // Static array so we can figure out which bytecodes stop us from compiling
  47 // the most. Some of the non-static variables are needed in bytecodeInfo.cpp
  48 // and eventually should be encapsulated in a proper class (gri 8/18/98).
  49 
  50 #ifndef PRODUCT
  51 int nodes_created              = 0;
  52 int methods_parsed             = 0;
  53 int methods_seen               = 0;
  54 int blocks_parsed              = 0;
  55 int blocks_seen                = 0;
  56 
  57 int explicit_null_checks_inserted = 0;
  58 int explicit_null_checks_elided   = 0;
  59 int all_null_checks_found         = 0;
  60 int implicit_null_checks          = 0;
  61 
  62 bool Parse::BytecodeParseHistogram::_initialized = false;
  63 uint Parse::BytecodeParseHistogram::_bytecodes_parsed [Bytecodes::number_of_codes];
  64 uint Parse::BytecodeParseHistogram::_nodes_constructed[Bytecodes::number_of_codes];
  65 uint Parse::BytecodeParseHistogram::_nodes_transformed[Bytecodes::number_of_codes];
  66 uint Parse::BytecodeParseHistogram::_new_values       [Bytecodes::number_of_codes];
  67 
  68 //------------------------------print_statistics-------------------------------
  69 void Parse::print_statistics() {
  70   tty-&gt;print_cr(&quot;--- Compiler Statistics ---&quot;);
  71   tty-&gt;print(&quot;Methods seen: %d  Methods parsed: %d&quot;, methods_seen, methods_parsed);
  72   tty-&gt;print(&quot;  Nodes created: %d&quot;, nodes_created);
  73   tty-&gt;cr();
  74   if (methods_seen != methods_parsed) {
  75     tty-&gt;print_cr(&quot;Reasons for parse failures (NOT cumulative):&quot;);
  76   }
  77   tty-&gt;print_cr(&quot;Blocks parsed: %d  Blocks seen: %d&quot;, blocks_parsed, blocks_seen);
  78 
  79   if (explicit_null_checks_inserted) {
  80     tty-&gt;print_cr(&quot;%d original NULL checks - %d elided (%2d%%); optimizer leaves %d,&quot;,
  81                   explicit_null_checks_inserted, explicit_null_checks_elided,
  82                   (100*explicit_null_checks_elided)/explicit_null_checks_inserted,
  83                   all_null_checks_found);
  84   }
  85   if (all_null_checks_found) {
  86     tty-&gt;print_cr(&quot;%d made implicit (%2d%%)&quot;, implicit_null_checks,
  87                   (100*implicit_null_checks)/all_null_checks_found);
  88   }
  89   if (SharedRuntime::_implicit_null_throws) {
  90     tty-&gt;print_cr(&quot;%d implicit null exceptions at runtime&quot;,
  91                   SharedRuntime::_implicit_null_throws);
  92   }
  93 
  94   if (PrintParseStatistics &amp;&amp; BytecodeParseHistogram::initialized()) {
  95     BytecodeParseHistogram::print();
  96   }
  97 }
  98 #endif
  99 
 100 //------------------------------ON STACK REPLACEMENT---------------------------
 101 
 102 // Construct a node which can be used to get incoming state for
 103 // on stack replacement.
 104 Node *Parse::fetch_interpreter_state(int index,
 105                                      BasicType bt,
 106                                      Node *local_addrs,
 107                                      Node *local_addrs_base) {
 108   Node *mem = memory(Compile::AliasIdxRaw);
 109   Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );
 110   Node *ctl = control();
 111 
 112   // Very similar to LoadNode::make, except we handle un-aligned longs and
 113   // doubles on Sparc.  Intel can handle them just fine directly.
 114   Node *l = NULL;
 115   switch (bt) {                // Signature is flattened
 116   case T_INT:     l = new LoadINode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInt::INT,        MemNode::unordered); break;
 117   case T_FLOAT:   l = new LoadFNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::FLOAT,         MemNode::unordered); break;
 118   case T_ADDRESS: l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeRawPtr::BOTTOM,  MemNode::unordered); break;
 119   case T_OBJECT:  l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInstPtr::BOTTOM, MemNode::unordered); break;
 120   case T_LONG:
 121   case T_DOUBLE: {
 122     // Since arguments are in reverse order, the argument address &#39;adr&#39;
 123     // refers to the back half of the long/double.  Recompute adr.
 124     adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);
 125     if (Matcher::misaligned_doubles_ok) {
 126       l = (bt == T_DOUBLE)
 127         ? (Node*)new LoadDNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::DOUBLE, MemNode::unordered)
 128         : (Node*)new LoadLNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeLong::LONG, MemNode::unordered);
 129     } else {
 130       l = (bt == T_DOUBLE)
 131         ? (Node*)new LoadD_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered)
 132         : (Node*)new LoadL_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered);
 133     }
 134     break;
 135   }
 136   default: ShouldNotReachHere();
 137   }
 138   return _gvn.transform(l);
 139 }
 140 
 141 // Helper routine to prevent the interpreter from handing
 142 // unexpected typestate to an OSR method.
 143 // The Node l is a value newly dug out of the interpreter frame.
 144 // The type is the type predicted by ciTypeFlow.  Note that it is
 145 // not a general type, but can only come from Type::get_typeflow_type.
 146 // The safepoint is a map which will feed an uncommon trap.
 147 Node* Parse::check_interpreter_type(Node* l, const Type* type,
 148                                     SafePointNode* &amp;bad_type_exit) {
 149 
 150   const TypeOopPtr* tp = type-&gt;isa_oopptr();
 151 
 152   // TypeFlow may assert null-ness if a type appears unloaded.
 153   if (type == TypePtr::NULL_PTR ||
 154       (tp != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded())) {
 155     // Value must be null, not a real oop.
 156     Node* chk = _gvn.transform( new CmpPNode(l, null()) );
 157     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 158     IfNode* iff = create_and_map_if(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 159     set_control(_gvn.transform( new IfTrueNode(iff) ));
 160     Node* bad_type = _gvn.transform( new IfFalseNode(iff) );
 161     bad_type_exit-&gt;control()-&gt;add_req(bad_type);
 162     l = null();
 163   }
 164 
 165   // Typeflow can also cut off paths from the CFG, based on
 166   // types which appear unloaded, or call sites which appear unlinked.
 167   // When paths are cut off, values at later merge points can rise
 168   // toward more specific classes.  Make sure these specific classes
 169   // are still in effect.
 170   if (tp != NULL &amp;&amp; tp-&gt;klass() != C-&gt;env()-&gt;Object_klass()) {
 171     // TypeFlow asserted a specific object type.  Value must have that type.
 172     Node* bad_type_ctrl = NULL;
 173     l = gen_checkcast(l, makecon(TypeKlassPtr::make(tp-&gt;klass())), &amp;bad_type_ctrl);
 174     bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 175   }
 176 
 177   BasicType bt_l = _gvn.type(l)-&gt;basic_type();
 178   BasicType bt_t = type-&gt;basic_type();
 179   assert(_gvn.type(l)-&gt;higher_equal(type), &quot;must constrain OSR typestate&quot;);
 180   return l;
 181 }
 182 
 183 // Helper routine which sets up elements of the initial parser map when
 184 // performing a parse for on stack replacement.  Add values into map.
 185 // The only parameter contains the address of a interpreter arguments.
 186 void Parse::load_interpreter_state(Node* osr_buf) {
 187   int index;
 188   int max_locals = jvms()-&gt;loc_size();
 189   int max_stack  = jvms()-&gt;stk_size();
 190 
 191 
 192   // Mismatch between method and jvms can occur since map briefly held
 193   // an OSR entry state (which takes up one RawPtr word).
 194   assert(max_locals == method()-&gt;max_locals(), &quot;sanity&quot;);
 195   assert(max_stack  &gt;= method()-&gt;max_stack(),  &quot;sanity&quot;);
 196   assert((int)jvms()-&gt;endoff() == TypeFunc::Parms + max_locals + max_stack, &quot;sanity&quot;);
 197   assert((int)jvms()-&gt;endoff() == (int)map()-&gt;req(), &quot;sanity&quot;);
 198 
 199   // Find the start block.
 200   Block* osr_block = start_block();
 201   assert(osr_block-&gt;start() == osr_bci(), &quot;sanity&quot;);
 202 
 203   // Set initial BCI.
 204   set_parse_bci(osr_block-&gt;start());
 205 
 206   // Set initial stack depth.
 207   set_sp(osr_block-&gt;start_sp());
 208 
 209   // Check bailouts.  We currently do not perform on stack replacement
 210   // of loops in catch blocks or loops which branch with a non-empty stack.
 211   if (sp() != 0) {
 212     C-&gt;record_method_not_compilable(&quot;OSR starts with non-empty stack&quot;);
 213     return;
 214   }
 215   // Do not OSR inside finally clauses:
 216   if (osr_block-&gt;has_trap_at(osr_block-&gt;start())) {
 217     C-&gt;record_method_not_compilable(&quot;OSR starts with an immediate trap&quot;);
 218     return;
 219   }
 220 
 221   // Commute monitors from interpreter frame to compiler frame.
 222   assert(jvms()-&gt;monitor_depth() == 0, &quot;should be no active locks at beginning of osr&quot;);
 223   int mcnt = osr_block-&gt;flow()-&gt;monitor_count();
 224   Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);
 225   for (index = 0; index &lt; mcnt; index++) {
 226     // Make a BoxLockNode for the monitor.
 227     Node *box = _gvn.transform(new BoxLockNode(next_monitor()));
 228 
 229 
 230     // Displaced headers and locked objects are interleaved in the
 231     // temp OSR buffer.  We only copy the locked objects out here.
 232     // Fetch the locked object from the OSR temp buffer and copy to our fastlock node.
 233     Node *lock_object = fetch_interpreter_state(index*2, T_OBJECT, monitors_addr, osr_buf);
 234     // Try and copy the displaced header to the BoxNode
 235     Node *displaced_hdr = fetch_interpreter_state((index*2) + 1, T_ADDRESS, monitors_addr, osr_buf);
 236 
 237 
 238     store_to_memory(control(), box, displaced_hdr, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
 239 
 240     // Build a bogus FastLockNode (no code will be generated) and push the
 241     // monitor into our debug info.
 242     const FastLockNode *flock = _gvn.transform(new FastLockNode( 0, lock_object, box ))-&gt;as_FastLock();
 243     map()-&gt;push_monitor(flock);
 244 
 245     // If the lock is our method synchronization lock, tuck it away in
 246     // _sync_lock for return and rethrow exit paths.
 247     if (index == 0 &amp;&amp; method()-&gt;is_synchronized()) {
 248       _synch_lock = flock;
 249     }
 250   }
 251 
 252   // Use the raw liveness computation to make sure that unexpected
 253   // values don&#39;t propagate into the OSR frame.
 254   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(osr_bci());
 255   if (!live_locals.is_valid()) {
 256     // Degenerate or breakpointed method.
 257     C-&gt;record_method_not_compilable(&quot;OSR in empty or breakpointed method&quot;);
 258     return;
 259   }
 260 
 261   // Extract the needed locals from the interpreter frame.
 262   Node *locals_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals-1)*wordSize);
 263 
 264   // find all the locals that the interpreter thinks contain live oops
 265   const ResourceBitMap live_oops = method()-&gt;live_local_oops_at_bci(osr_bci());
 266   for (index = 0; index &lt; max_locals; index++) {
 267 
 268     if (!live_locals.at(index)) {
 269       continue;
 270     }
 271 
 272     const Type *type = osr_block-&gt;local_type_at(index);
 273 
 274     if (type-&gt;isa_oopptr() != NULL) {
 275 
 276       // 6403625: Verify that the interpreter oopMap thinks that the oop is live
 277       // else we might load a stale oop if the MethodLiveness disagrees with the
 278       // result of the interpreter. If the interpreter says it is dead we agree
 279       // by making the value go to top.
 280       //
 281 
 282       if (!live_oops.at(index)) {
 283         if (C-&gt;log() != NULL) {
 284           C-&gt;log()-&gt;elem(&quot;OSR_mismatch local_index=&#39;%d&#39;&quot;,index);
 285         }
 286         set_local(index, null());
 287         // and ignore it for the loads
 288         continue;
 289       }
 290     }
 291 
 292     // Filter out TOP, HALF, and BOTTOM.  (Cf. ensure_phi.)
 293     if (type == Type::TOP || type == Type::HALF) {
 294       continue;
 295     }
 296     // If the type falls to bottom, then this must be a local that
 297     // is mixing ints and oops or some such.  Forcing it to top
 298     // makes it go dead.
 299     if (type == Type::BOTTOM) {
 300       continue;
 301     }
 302     // Construct code to access the appropriate local.
 303     BasicType bt = type-&gt;basic_type();
 304     if (type == TypePtr::NULL_PTR) {
 305       // Ptr types are mixed together with T_ADDRESS but NULL is
 306       // really for T_OBJECT types so correct it.
 307       bt = T_OBJECT;
 308     }
 309     Node *value = fetch_interpreter_state(index, bt, locals_addr, osr_buf);
 310     set_local(index, value);
 311   }
 312 
 313   // Extract the needed stack entries from the interpreter frame.
 314   for (index = 0; index &lt; sp(); index++) {
 315     const Type *type = osr_block-&gt;stack_type_at(index);
 316     if (type != Type::TOP) {
 317       // Currently the compiler bails out when attempting to on stack replace
 318       // at a bci with a non-empty stack.  We should not reach here.
 319       ShouldNotReachHere();
 320     }
 321   }
 322 
 323   // End the OSR migration
 324   make_runtime_call(RC_LEAF, OptoRuntime::osr_end_Type(),
 325                     CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
 326                     &quot;OSR_migration_end&quot;, TypeRawPtr::BOTTOM,
 327                     osr_buf);
 328 
 329   // Now that the interpreter state is loaded, make sure it will match
 330   // at execution time what the compiler is expecting now:
 331   SafePointNode* bad_type_exit = clone_map();
 332   bad_type_exit-&gt;set_control(new RegionNode(1));
 333 
 334   assert(osr_block-&gt;flow()-&gt;jsrs()-&gt;size() == 0, &quot;should be no jsrs live at osr point&quot;);
 335   for (index = 0; index &lt; max_locals; index++) {
 336     if (stopped())  break;
 337     Node* l = local(index);
 338     if (l-&gt;is_top())  continue;  // nothing here
 339     const Type *type = osr_block-&gt;local_type_at(index);
 340     if (type-&gt;isa_oopptr() != NULL) {
 341       if (!live_oops.at(index)) {
 342         // skip type check for dead oops
 343         continue;
 344       }
 345     }
 346     if (osr_block-&gt;flow()-&gt;local_type_at(index)-&gt;is_return_address()) {
 347       // In our current system it&#39;s illegal for jsr addresses to be
 348       // live into an OSR entry point because the compiler performs
 349       // inlining of jsrs.  ciTypeFlow has a bailout that detect this
 350       // case and aborts the compile if addresses are live into an OSR
 351       // entry point.  Because of that we can assume that any address
 352       // locals at the OSR entry point are dead.  Method liveness
 353       // isn&#39;t precise enought to figure out that they are dead in all
 354       // cases so simply skip checking address locals all
 355       // together. Any type check is guaranteed to fail since the
 356       // interpreter type is the result of a load which might have any
 357       // value and the expected type is a constant.
 358       continue;
 359     }
 360     set_local(index, check_interpreter_type(l, type, bad_type_exit));
 361   }
 362 
 363   for (index = 0; index &lt; sp(); index++) {
 364     if (stopped())  break;
 365     Node* l = stack(index);
 366     if (l-&gt;is_top())  continue;  // nothing here
 367     const Type *type = osr_block-&gt;stack_type_at(index);
 368     set_stack(index, check_interpreter_type(l, type, bad_type_exit));
 369   }
 370 
 371   if (bad_type_exit-&gt;control()-&gt;req() &gt; 1) {
 372     // Build an uncommon trap here, if any inputs can be unexpected.
 373     bad_type_exit-&gt;set_control(_gvn.transform( bad_type_exit-&gt;control() ));
 374     record_for_igvn(bad_type_exit-&gt;control());
 375     SafePointNode* types_are_good = map();
 376     set_map(bad_type_exit);
 377     // The unexpected type happens because a new edge is active
 378     // in the CFG, which typeflow had previously ignored.
 379     // E.g., Object x = coldAtFirst() &amp;&amp; notReached()? &quot;str&quot;: new Integer(123).
 380     // This x will be typed as Integer if notReached is not yet linked.
 381     // It could also happen due to a problem in ciTypeFlow analysis.
 382     uncommon_trap(Deoptimization::Reason_constraint,
 383                   Deoptimization::Action_reinterpret);
 384     set_map(types_are_good);
 385   }
 386 }
 387 
 388 //------------------------------Parse------------------------------------------
 389 // Main parser constructor.
 390 Parse::Parse(JVMState* caller, ciMethod* parse_method, float expected_uses)
 391   : _exits(caller)
 392 {
 393   // Init some variables
 394   _caller = caller;
 395   _method = parse_method;
 396   _expected_uses = expected_uses;
 397   _depth = 1 + (caller-&gt;has_method() ? caller-&gt;depth() : 0);
 398   _wrote_final = false;
 399   _wrote_volatile = false;
 400   _wrote_stable = false;
 401   _wrote_fields = false;
 402   _alloc_with_final = NULL;
 403   _entry_bci = InvocationEntryBci;
 404   _tf = NULL;
 405   _block = NULL;
 406   _first_return = true;
 407   _replaced_nodes_for_exceptions = false;
 408   _new_idx = C-&gt;unique();
 409   debug_only(_block_count = -1);
 410   debug_only(_blocks = (Block*)-1);
 411 #ifndef PRODUCT
 412   if (PrintCompilation || PrintOpto) {
 413     // Make sure I have an inline tree, so I can print messages about it.
 414     JVMState* ilt_caller = is_osr_parse() ? caller-&gt;caller() : caller;
 415     InlineTree::find_subtree_from_root(C-&gt;ilt(), ilt_caller, parse_method);
 416   }
 417   _max_switch_depth = 0;
 418   _est_switch_depth = 0;
 419 #endif
 420 
 421   if (parse_method-&gt;has_reserved_stack_access()) {
 422     C-&gt;set_has_reserved_stack_access(true);
 423   }
 424 
 425   _tf = TypeFunc::make(method());
 426   _iter.reset_to_method(method());
 427   _flow = method()-&gt;get_flow_analysis();
 428   if (_flow-&gt;failing()) {
 429     C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 430   }
 431 
 432 #ifndef PRODUCT
 433   if (_flow-&gt;has_irreducible_entry()) {
 434     C-&gt;set_parsed_irreducible_loop(true);
 435   }
 436 #endif
 437 
 438   if (_expected_uses &lt;= 0) {
 439     _prof_factor = 1;
 440   } else {
 441     float prof_total = parse_method-&gt;interpreter_invocation_count();
 442     if (prof_total &lt;= _expected_uses) {
 443       _prof_factor = 1;
 444     } else {
 445       _prof_factor = _expected_uses / prof_total;
 446     }
 447   }
 448 
 449   CompileLog* log = C-&gt;log();
 450   if (log != NULL) {
 451     log-&gt;begin_head(&quot;parse method=&#39;%d&#39; uses=&#39;%f&#39;&quot;,
 452                     log-&gt;identify(parse_method), expected_uses);
 453     if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 454       log-&gt;print(&quot; osr_bci=&#39;%d&#39;&quot;, C-&gt;entry_bci());
 455     }
 456     log-&gt;stamp();
 457     log-&gt;end_head();
 458   }
 459 
 460   // Accumulate deoptimization counts.
 461   // (The range_check and store_check counts are checked elsewhere.)
 462   ciMethodData* md = method()-&gt;method_data();
 463   for (uint reason = 0; reason &lt; md-&gt;trap_reason_limit(); reason++) {
 464     uint md_count = md-&gt;trap_count(reason);
 465     if (md_count != 0) {
 466       if (md_count == md-&gt;trap_count_limit())
 467         md_count += md-&gt;overflow_trap_count();
 468       uint total_count = C-&gt;trap_count(reason);
 469       uint old_count   = total_count;
 470       total_count += md_count;
 471       // Saturate the add if it overflows.
 472       if (total_count &lt; old_count || total_count &lt; md_count)
 473         total_count = (uint)-1;
 474       C-&gt;set_trap_count(reason, total_count);
 475       if (log != NULL)
 476         log-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39; total=&#39;%d&#39;&quot;,
 477                   Deoptimization::trap_reason_name(reason),
 478                   md_count, total_count);
 479     }
 480   }
 481   // Accumulate total sum of decompilations, also.
 482   C-&gt;set_decompile_count(C-&gt;decompile_count() + md-&gt;decompile_count());
 483 
 484   _count_invocations = C-&gt;do_count_invocations();
 485   _method_data_update = C-&gt;do_method_data_update();
 486 
 487   if (log != NULL &amp;&amp; method()-&gt;has_exception_handlers()) {
 488     log-&gt;elem(&quot;observe that=&#39;has_exception_handlers&#39;&quot;);
 489   }
 490 
 491   assert(InlineTree::check_can_parse(method()) == NULL, &quot;Can not parse this method, cutout earlier&quot;);
 492   assert(method()-&gt;has_balanced_monitors(), &quot;Can not parse unbalanced monitors, cutout earlier&quot;);
 493 
 494   // Always register dependence if JVMTI is enabled, because
 495   // either breakpoint setting or hotswapping of methods may
 496   // cause deoptimization.
 497   if (C-&gt;env()-&gt;jvmti_can_hotswap_or_post_breakpoint()) {
 498     C-&gt;dependencies()-&gt;assert_evol_method(method());
 499   }
 500 
 501   NOT_PRODUCT(methods_seen++);
 502 
 503   // Do some special top-level things.
 504   if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 505     _entry_bci = C-&gt;entry_bci();
 506     _flow = method()-&gt;get_osr_flow_analysis(osr_bci());
 507     if (_flow-&gt;failing()) {
 508       C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 509 #ifndef PRODUCT
 510       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 511         tty-&gt;print_cr(&quot;OSR @%d type flow bailout: %s&quot;, _entry_bci, _flow-&gt;failure_reason());
 512         if (Verbose) {
 513           method()-&gt;print();
 514           method()-&gt;print_codes();
 515           _flow-&gt;print();
 516         }
 517       }
 518 #endif
 519     }
 520     _tf = C-&gt;tf();     // the OSR entry type is different
 521   }
 522 
 523 #ifdef ASSERT
 524   if (depth() == 1) {
 525     assert(C-&gt;is_osr_compilation() == this-&gt;is_osr_parse(), &quot;OSR in sync&quot;);
 526     if (C-&gt;tf() != tf()) {
 527       assert(C-&gt;env()-&gt;system_dictionary_modification_counter_changed(),
 528              &quot;Must invalidate if TypeFuncs differ&quot;);
 529     }
 530   } else {
 531     assert(!this-&gt;is_osr_parse(), &quot;no recursive OSR&quot;);
 532   }
 533 #endif
 534 
 535 #ifndef PRODUCT
 536   methods_parsed++;
 537   // add method size here to guarantee that inlined methods are added too
 538   if (CITime)
 539     _total_bytes_compiled += method()-&gt;code_size();
 540 
 541   show_parse_info();
 542 #endif
 543 
 544   if (failing()) {
 545     if (log)  log-&gt;done(&quot;parse&quot;);
 546     return;
 547   }
 548 
 549   gvn().set_type(root(), root()-&gt;bottom_type());
 550   gvn().transform(top());
 551 
 552   // Import the results of the ciTypeFlow.
 553   init_blocks();
 554 
 555   // Merge point for all normal exits
 556   build_exits();
 557 
 558   // Setup the initial JVM state map.
 559   SafePointNode* entry_map = create_entry_map();
 560 
 561   // Check for bailouts during map initialization
 562   if (failing() || entry_map == NULL) {
 563     if (log)  log-&gt;done(&quot;parse&quot;);
 564     return;
 565   }
 566 
 567   Node_Notes* caller_nn = C-&gt;default_node_notes();
 568   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
 569   if (DebugInlinedCalls || depth() == 1) {
 570     C-&gt;set_default_node_notes(make_node_notes(caller_nn));
 571   }
 572 
 573   if (is_osr_parse()) {
 574     Node* osr_buf = entry_map-&gt;in(TypeFunc::Parms+0);
 575     entry_map-&gt;set_req(TypeFunc::Parms+0, top());
 576     set_map(entry_map);
 577     load_interpreter_state(osr_buf);
 578   } else {
 579     set_map(entry_map);
 580     do_method_entry();
 581     if (depth() == 1 &amp;&amp; C-&gt;age_code()) {
 582       decrement_age();
 583     }
 584   }
 585 
 586   if (depth() == 1 &amp;&amp; !failing()) {
 587     // Add check to deoptimize the nmethod if RTM state was changed
 588     rtm_deopt();
 589   }
 590 
 591   // Check for bailouts during method entry or RTM state check setup.
 592   if (failing()) {
 593     if (log)  log-&gt;done(&quot;parse&quot;);
 594     C-&gt;set_default_node_notes(caller_nn);
 595     return;
 596   }
 597 
 598   entry_map = map();  // capture any changes performed by method setup code
 599   assert(jvms()-&gt;endoff() == map()-&gt;req(), &quot;map matches JVMS layout&quot;);
 600 
 601   // We begin parsing as if we have just encountered a jump to the
 602   // method entry.
 603   Block* entry_block = start_block();
 604   assert(entry_block-&gt;start() == (is_osr_parse() ? osr_bci() : 0), &quot;&quot;);
 605   set_map_clone(entry_map);
 606   merge_common(entry_block, entry_block-&gt;next_path_num());
 607 
 608 #ifndef PRODUCT
 609   BytecodeParseHistogram *parse_histogram_obj = new (C-&gt;env()-&gt;arena()) BytecodeParseHistogram(this, C);
 610   set_parse_histogram( parse_histogram_obj );
 611 #endif
 612 
 613   // Parse all the basic blocks.
 614   do_all_blocks();
 615 
 616   C-&gt;set_default_node_notes(caller_nn);
 617 
 618   // Check for bailouts during conversion to graph
 619   if (failing()) {
 620     if (log)  log-&gt;done(&quot;parse&quot;);
 621     return;
 622   }
 623 
 624   // Fix up all exiting control flow.
 625   set_map(entry_map);
 626   do_exits();
 627 
 628   if (log)  log-&gt;done(&quot;parse nodes=&#39;%d&#39; live=&#39;%d&#39; memory=&#39;&quot; SIZE_FORMAT &quot;&#39;&quot;,
 629                       C-&gt;unique(), C-&gt;live_nodes(), C-&gt;node_arena()-&gt;used());
 630 }
 631 
 632 //---------------------------do_all_blocks-------------------------------------
 633 void Parse::do_all_blocks() {
 634   bool has_irreducible = flow()-&gt;has_irreducible_entry();
 635 
 636   // Walk over all blocks in Reverse Post-Order.
 637   while (true) {
 638     bool progress = false;
 639     for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 640       Block* block = rpo_at(rpo);
 641 
 642       if (block-&gt;is_parsed()) continue;
 643 
 644       if (!block-&gt;is_merged()) {
 645         // Dead block, no state reaches this block
 646         continue;
 647       }
 648 
 649       // Prepare to parse this block.
 650       load_state_from(block);
 651 
 652       if (stopped()) {
 653         // Block is dead.
 654         continue;
 655       }
 656 
 657       NOT_PRODUCT(blocks_parsed++);
 658 
 659       progress = true;
 660       if (block-&gt;is_loop_head() || block-&gt;is_handler() || (has_irreducible &amp;&amp; !block-&gt;is_ready())) {
 661         // Not all preds have been parsed.  We must build phis everywhere.
 662         // (Note that dead locals do not get phis built, ever.)
 663         ensure_phis_everywhere();
 664 
 665         if (block-&gt;is_SEL_head()) {
 666           // Add predicate to single entry (not irreducible) loop head.
 667           assert(!block-&gt;has_merged_backedge(), &quot;only entry paths should be merged for now&quot;);
 668           // Predicates may have been added after a dominating if
 669           if (!block-&gt;has_predicates()) {
 670             // Need correct bci for predicate.
 671             // It is fine to set it here since do_one_block() will set it anyway.
 672             set_parse_bci(block-&gt;start());
 673             add_predicate();
 674           }
 675           // Add new region for back branches.
 676           int edges = block-&gt;pred_count() - block-&gt;preds_parsed() + 1; // +1 for original region
 677           RegionNode *r = new RegionNode(edges+1);
 678           _gvn.set_type(r, Type::CONTROL);
 679           record_for_igvn(r);
 680           r-&gt;init_req(edges, control());
 681           set_control(r);
 682           // Add new phis.
 683           ensure_phis_everywhere();
 684         }
 685 
 686         // Leave behind an undisturbed copy of the map, for future merges.
 687         set_map(clone_map());
 688       }
 689 
 690       if (control()-&gt;is_Region() &amp;&amp; !block-&gt;is_loop_head() &amp;&amp; !has_irreducible &amp;&amp; !block-&gt;is_handler()) {
 691         // In the absence of irreducible loops, the Region and Phis
 692         // associated with a merge that doesn&#39;t involve a backedge can
 693         // be simplified now since the RPO parsing order guarantees
 694         // that any path which was supposed to reach here has already
 695         // been parsed or must be dead.
 696         Node* c = control();
 697         Node* result = _gvn.transform_no_reclaim(control());
 698         if (c != result &amp;&amp; TraceOptoParse) {
 699           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block-&gt;rpo(), c-&gt;_idx, result-&gt;_idx);
 700         }
 701         if (result != top()) {
 702           record_for_igvn(result);
 703         }
 704       }
 705 
 706       // Parse the block.
 707       do_one_block();
 708 
 709       // Check for bailouts.
 710       if (failing())  return;
 711     }
 712 
 713     // with irreducible loops multiple passes might be necessary to parse everything
 714     if (!has_irreducible || !progress) {
 715       break;
 716     }
 717   }
 718 
 719 #ifndef PRODUCT
 720   blocks_seen += block_count();
 721 
 722   // Make sure there are no half-processed blocks remaining.
 723   // Every remaining unprocessed block is dead and may be ignored now.
 724   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 725     Block* block = rpo_at(rpo);
 726     if (!block-&gt;is_parsed()) {
 727       if (TraceOptoParse) {
 728         tty-&gt;print_cr(&quot;Skipped dead block %d at bci:%d&quot;, rpo, block-&gt;start());
 729       }
 730       assert(!block-&gt;is_merged(), &quot;no half-processed blocks&quot;);
 731     }
 732   }
 733 #endif
 734 }
 735 
 736 static Node* mask_int_value(Node* v, BasicType bt, PhaseGVN* gvn) {
 737   switch (bt) {
 738   case T_BYTE:
 739     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(24)));
 740     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(24)));
 741     break;
 742   case T_SHORT:
 743     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(16)));
 744     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(16)));
 745     break;
 746   case T_CHAR:
 747     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0xFFFF)));
 748     break;
 749   case T_BOOLEAN:
 750     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0x1)));
 751     break;
 752   default:
 753     break;
 754   }
 755   return v;
 756 }
 757 
 758 //-------------------------------build_exits----------------------------------
 759 // Build normal and exceptional exit merge points.
 760 void Parse::build_exits() {
 761   // make a clone of caller to prevent sharing of side-effects
 762   _exits.set_map(_exits.clone_map());
 763   _exits.clean_stack(_exits.sp());
 764   _exits.sync_jvms();
 765 
 766   RegionNode* region = new RegionNode(1);
 767   record_for_igvn(region);
 768   gvn().set_type_bottom(region);
 769   _exits.set_control(region);
 770 
 771   // Note:  iophi and memphi are not transformed until do_exits.
 772   Node* iophi  = new PhiNode(region, Type::ABIO);
 773   Node* memphi = new PhiNode(region, Type::MEMORY, TypePtr::BOTTOM);
 774   gvn().set_type_bottom(iophi);
 775   gvn().set_type_bottom(memphi);
 776   _exits.set_i_o(iophi);
 777   _exits.set_all_memory(memphi);
 778 
 779   // Add a return value to the exit state.  (Do not push it yet.)
 780   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {
 781     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);
 782     if (ret_type-&gt;isa_int()) {
 783       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
 784       if (ret_bt == T_BOOLEAN ||
 785           ret_bt == T_CHAR ||
 786           ret_bt == T_BYTE ||
 787           ret_bt == T_SHORT) {
 788         ret_type = TypeInt::INT;
 789       }
 790     }
 791 
 792     // Don&#39;t &quot;bind&quot; an unloaded return klass to the ret_phi. If the klass
 793     // becomes loaded during the subsequent parsing, the loaded and unloaded
 794     // types will not join when we transform and push in do_exits().
 795     const TypeOopPtr* ret_oop_type = ret_type-&gt;isa_oopptr();
 796     if (ret_oop_type &amp;&amp; !ret_oop_type-&gt;klass()-&gt;is_loaded()) {
 797       ret_type = TypeOopPtr::BOTTOM;
 798     }
 799     int         ret_size = type2size[ret_type-&gt;basic_type()];
 800     Node*       ret_phi  = new PhiNode(region, ret_type);
 801     gvn().set_type_bottom(ret_phi);
 802     _exits.ensure_stack(ret_size);
 803     assert((int)(tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms) == ret_size, &quot;good tf range&quot;);
 804     assert(method()-&gt;return_type()-&gt;size() == ret_size, &quot;tf agrees w/ method&quot;);
 805     _exits.set_argument(0, ret_phi);  // here is where the parser finds it
 806     // Note:  ret_phi is not yet pushed, until do_exits.
 807   }
 808 }
 809 
 810 
 811 //----------------------------build_start_state-------------------------------
 812 // Construct a state which contains only the incoming arguments from an
 813 // unknown caller.  The method &amp; bci will be NULL &amp; InvocationEntryBci.
 814 JVMState* Compile::build_start_state(StartNode* start, const TypeFunc* tf) {
 815   int        arg_size = tf-&gt;domain()-&gt;cnt();
 816   int        max_size = MAX2(arg_size, (int)tf-&gt;range()-&gt;cnt());
 817   JVMState*  jvms     = new (this) JVMState(max_size - TypeFunc::Parms);
 818   SafePointNode* map  = new SafePointNode(max_size, NULL);
 819   record_for_igvn(map);
 820   assert(arg_size == TypeFunc::Parms + (is_osr_compilation() ? 1 : method()-&gt;arg_size()), &quot;correct arg_size&quot;);
 821   Node_Notes* old_nn = default_node_notes();
 822   if (old_nn != NULL &amp;&amp; has_method()) {
 823     Node_Notes* entry_nn = old_nn-&gt;clone(this);
 824     JVMState* entry_jvms = new(this) JVMState(method(), old_nn-&gt;jvms());
 825     entry_jvms-&gt;set_offsets(0);
 826     entry_jvms-&gt;set_bci(entry_bci());
 827     entry_nn-&gt;set_jvms(entry_jvms);
 828     set_default_node_notes(entry_nn);
 829   }
 830   uint i;
 831   for (i = 0; i &lt; (uint)arg_size; i++) {
 832     Node* parm = initial_gvn()-&gt;transform(new ParmNode(start, i));
 833     map-&gt;init_req(i, parm);
 834     // Record all these guys for later GVN.
 835     record_for_igvn(parm);
 836   }
 837   for (; i &lt; map-&gt;req(); i++) {
 838     map-&gt;init_req(i, top());
 839   }
 840   assert(jvms-&gt;argoff() == TypeFunc::Parms, &quot;parser gets arguments here&quot;);
 841   set_default_node_notes(old_nn);
 842   map-&gt;set_jvms(jvms);
 843   jvms-&gt;set_map(map);
 844   return jvms;
 845 }
 846 
 847 //-----------------------------make_node_notes---------------------------------
 848 Node_Notes* Parse::make_node_notes(Node_Notes* caller_nn) {
 849   if (caller_nn == NULL)  return NULL;
 850   Node_Notes* nn = caller_nn-&gt;clone(C);
 851   JVMState* caller_jvms = nn-&gt;jvms();
 852   JVMState* jvms = new (C) JVMState(method(), caller_jvms);
 853   jvms-&gt;set_offsets(0);
 854   jvms-&gt;set_bci(_entry_bci);
 855   nn-&gt;set_jvms(jvms);
 856   return nn;
 857 }
 858 
 859 
 860 //--------------------------return_values--------------------------------------
 861 void Compile::return_values(JVMState* jvms) {
 862   GraphKit kit(jvms);
 863   Node* ret = new ReturnNode(TypeFunc::Parms,
 864                              kit.control(),
 865                              kit.i_o(),
 866                              kit.reset_memory(),
 867                              kit.frameptr(),
 868                              kit.returnadr());
 869   // Add zero or 1 return values
 870   int ret_size = tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms;
 871   if (ret_size &gt; 0) {
 872     kit.inc_sp(-ret_size);  // pop the return value(s)
 873     kit.sync_jvms();
 874     ret-&gt;add_req(kit.argument(0));
 875     // Note:  The second dummy edge is not needed by a ReturnNode.
 876   }
 877   // bind it to root
 878   root()-&gt;add_req(ret);
 879   record_for_igvn(ret);
 880   initial_gvn()-&gt;transform_no_reclaim(ret);
 881 }
 882 
 883 //------------------------rethrow_exceptions-----------------------------------
 884 // Bind all exception states in the list into a single RethrowNode.
 885 void Compile::rethrow_exceptions(JVMState* jvms) {
 886   GraphKit kit(jvms);
 887   if (!kit.has_exceptions())  return;  // nothing to generate
 888   // Load my combined exception state into the kit, with all phis transformed:
 889   SafePointNode* ex_map = kit.combine_and_pop_all_exception_states();
 890   Node* ex_oop = kit.use_exception_state(ex_map);
 891   RethrowNode* exit = new RethrowNode(kit.control(),
 892                                       kit.i_o(), kit.reset_memory(),
 893                                       kit.frameptr(), kit.returnadr(),
 894                                       // like a return but with exception input
 895                                       ex_oop);
 896   // bind to root
 897   root()-&gt;add_req(exit);
 898   record_for_igvn(exit);
 899   initial_gvn()-&gt;transform_no_reclaim(exit);
 900 }
 901 
 902 //---------------------------do_exceptions-------------------------------------
 903 // Process exceptions arising from the current bytecode.
 904 // Send caught exceptions to the proper handler within this method.
 905 // Unhandled exceptions feed into _exit.
 906 void Parse::do_exceptions() {
 907   if (!has_exceptions())  return;
 908 
 909   if (failing()) {
 910     // Pop them all off and throw them away.
 911     while (pop_exception_state() != NULL) ;
 912     return;
 913   }
 914 
 915   PreserveJVMState pjvms(this, false);
 916 
 917   SafePointNode* ex_map;
 918   while ((ex_map = pop_exception_state()) != NULL) {
 919     if (!method()-&gt;has_exception_handlers()) {
 920       // Common case:  Transfer control outward.
 921       // Doing it this early allows the exceptions to common up
 922       // even between adjacent method calls.
 923       throw_to_exit(ex_map);
 924     } else {
 925       // Have to look at the exception first.
 926       assert(stopped(), &quot;catch_inline_exceptions trashes the map&quot;);
 927       catch_inline_exceptions(ex_map);
 928       stop_and_kill_map();      // we used up this exception state; kill it
 929     }
 930   }
 931 
 932   // We now return to our regularly scheduled program:
 933 }
 934 
 935 //---------------------------throw_to_exit-------------------------------------
 936 // Merge the given map into an exception exit from this method.
 937 // The exception exit will handle any unlocking of receiver.
 938 // The ex_oop must be saved within the ex_map, unlike merge_exception.
 939 void Parse::throw_to_exit(SafePointNode* ex_map) {
 940   // Pop the JVMS to (a copy of) the caller.
 941   GraphKit caller;
 942   caller.set_map_clone(_caller-&gt;map());
 943   caller.set_bci(_caller-&gt;bci());
 944   caller.set_sp(_caller-&gt;sp());
 945   // Copy out the standard machine state:
 946   for (uint i = 0; i &lt; TypeFunc::Parms; i++) {
 947     caller.map()-&gt;set_req(i, ex_map-&gt;in(i));
 948   }
 949   if (ex_map-&gt;has_replaced_nodes()) {
 950     _replaced_nodes_for_exceptions = true;
 951   }
 952   caller.map()-&gt;transfer_replaced_nodes_from(ex_map, _new_idx);
 953   // ...and the exception:
 954   Node*          ex_oop        = saved_ex_oop(ex_map);
 955   SafePointNode* caller_ex_map = caller.make_exception_state(ex_oop);
 956   // Finally, collect the new exception state in my exits:
 957   _exits.add_exception_state(caller_ex_map);
 958 }
 959 
 960 //------------------------------do_exits---------------------------------------
 961 void Parse::do_exits() {
 962   set_parse_bci(InvocationEntryBci);
 963 
 964   // Now peephole on the return bits
 965   Node* region = _exits.control();
 966   _exits.set_control(gvn().transform(region));
 967 
 968   Node* iophi = _exits.i_o();
 969   _exits.set_i_o(gvn().transform(iophi));
 970 
 971   // Figure out if we need to emit the trailing barrier. The barrier is only
 972   // needed in the constructors, and only in three cases:
 973   //
 974   // 1. The constructor wrote a final. The effects of all initializations
 975   //    must be committed to memory before any code after the constructor
 976   //    publishes the reference to the newly constructed object. Rather
 977   //    than wait for the publication, we simply block the writes here.
 978   //    Rather than put a barrier on only those writes which are required
 979   //    to complete, we force all writes to complete.
 980   //
 981   // 2. On PPC64, also add MemBarRelease for constructors which write
 982   //    volatile fields. As support_IRIW_for_not_multiple_copy_atomic_cpu
 983   //    is set on PPC64, no sync instruction is issued after volatile
 984   //    stores. We want to guarantee the same behavior as on platforms
 985   //    with total store order, although this is not required by the Java
 986   //    memory model. So as with finals, we add a barrier here.
 987   //
 988   // 3. Experimental VM option is used to force the barrier if any field
 989   //    was written out in the constructor.
 990   //
 991   // &quot;All bets are off&quot; unless the first publication occurs after a
 992   // normal return from the constructor.  We do not attempt to detect
 993   // such unusual early publications.  But no barrier is needed on
 994   // exceptional returns, since they cannot publish normally.
 995   //
 996   if (method()-&gt;is_initializer() &amp;&amp;
 997         (wrote_final() ||
 998            PPC64_ONLY(wrote_volatile() ||)
 999            (AlwaysSafeConstructors &amp;&amp; wrote_fields()))) {
1000     _exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());
1001 
1002     // If Memory barrier is created for final fields write
1003     // and allocation node does not escape the initialize method,
1004     // then barrier introduced by allocation node can be removed.
1005     if (DoEscapeAnalysis &amp;&amp; alloc_with_final()) {
1006       AllocateNode *alloc = AllocateNode::Ideal_allocation(alloc_with_final(), &amp;_gvn);
1007       alloc-&gt;compute_MemBar_redundancy(method());
1008     }
1009     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1010       method()-&gt;print_name();
1011       tty-&gt;print_cr(&quot; writes finals and needs a memory barrier&quot;);
1012     }
1013   }
1014 
1015   // Any method can write a @Stable field; insert memory barriers
1016   // after those also. Can&#39;t bind predecessor allocation node (if any)
1017   // with barrier because allocation doesn&#39;t always dominate
1018   // MemBarRelease.
1019   if (wrote_stable()) {
1020     _exits.insert_mem_bar(Op_MemBarRelease);
1021     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1022       method()-&gt;print_name();
1023       tty-&gt;print_cr(&quot; writes @Stable and needs a memory barrier&quot;);
1024     }
1025   }
1026 
1027   for (MergeMemStream mms(_exits.merged_memory()); mms.next_non_empty(); ) {
1028     // transform each slice of the original memphi:
1029     mms.set_memory(_gvn.transform(mms.memory()));
1030   }
1031 
1032   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {
1033     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);
1034     Node*       ret_phi  = _gvn.transform( _exits.argument(0) );
1035     if (!_exits.control()-&gt;is_top() &amp;&amp; _gvn.type(ret_phi)-&gt;empty()) {
1036       // In case of concurrent class loading, the type we set for the
1037       // ret_phi in build_exits() may have been too optimistic and the
1038       // ret_phi may be top now.
1039       // Otherwise, we&#39;ve encountered an error and have to mark the method as
1040       // not compilable. Just using an assertion instead would be dangerous
1041       // as this could lead to an infinite compile loop in non-debug builds.
1042       {
1043         if (C-&gt;env()-&gt;system_dictionary_modification_counter_changed()) {
1044           C-&gt;record_failure(C2Compiler::retry_class_loading_during_parsing());
1045         } else {
1046           C-&gt;record_method_not_compilable(&quot;Can&#39;t determine return type.&quot;);
1047         }
1048       }
1049       return;
1050     }
1051     if (ret_type-&gt;isa_int()) {
1052       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
1053       ret_phi = mask_int_value(ret_phi, ret_bt, &amp;_gvn);
1054     }
1055     _exits.push_node(ret_type-&gt;basic_type(), ret_phi);
1056   }
1057 
1058   // Note:  Logic for creating and optimizing the ReturnNode is in Compile.
1059 
1060   // Unlock along the exceptional paths.
1061   // This is done late so that we can common up equivalent exceptions
1062   // (e.g., null checks) arising from multiple points within this method.
1063   // See GraphKit::add_exception_state, which performs the commoning.
1064   bool do_synch = method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode;
1065 
1066   // record exit from a method if compiled while Dtrace is turned on.
1067   if (do_synch || C-&gt;env()-&gt;dtrace_method_probes() || _replaced_nodes_for_exceptions) {
1068     // First move the exception list out of _exits:
1069     GraphKit kit(_exits.transfer_exceptions_into_jvms());
1070     SafePointNode* normal_map = kit.map();  // keep this guy safe
1071     // Now re-collect the exceptions into _exits:
1072     SafePointNode* ex_map;
1073     while ((ex_map = kit.pop_exception_state()) != NULL) {
1074       Node* ex_oop = kit.use_exception_state(ex_map);
1075       // Force the exiting JVM state to have this method at InvocationEntryBci.
1076       // The exiting JVM state is otherwise a copy of the calling JVMS.
1077       JVMState* caller = kit.jvms();
1078       JVMState* ex_jvms = caller-&gt;clone_shallow(C);
1079       ex_jvms-&gt;set_map(kit.clone_map());
1080       ex_jvms-&gt;map()-&gt;set_jvms(ex_jvms);
1081       ex_jvms-&gt;set_bci(   InvocationEntryBci);
1082       kit.set_jvms(ex_jvms);
1083       if (do_synch) {
1084         // Add on the synchronized-method box/object combo
1085         kit.map()-&gt;push_monitor(_synch_lock);
1086         // Unlock!
1087         kit.shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
1088       }
1089       if (C-&gt;env()-&gt;dtrace_method_probes()) {
1090         kit.make_dtrace_method_exit(method());
1091       }
1092       if (_replaced_nodes_for_exceptions) {
1093         kit.map()-&gt;apply_replaced_nodes(_new_idx);
1094       }
1095       // Done with exception-path processing.
1096       ex_map = kit.make_exception_state(ex_oop);
1097       assert(ex_jvms-&gt;same_calls_as(ex_map-&gt;jvms()), &quot;sanity&quot;);
1098       // Pop the last vestige of this method:
1099       ex_map-&gt;set_jvms(caller-&gt;clone_shallow(C));
1100       ex_map-&gt;jvms()-&gt;set_map(ex_map);
1101       _exits.push_exception_state(ex_map);
1102     }
1103     assert(_exits.map() == normal_map, &quot;keep the same return state&quot;);
1104   }
1105 
1106   {
1107     // Capture very early exceptions (receiver null checks) from caller JVMS
1108     GraphKit caller(_caller);
1109     SafePointNode* ex_map;
1110     while ((ex_map = caller.pop_exception_state()) != NULL) {
1111       _exits.add_exception_state(ex_map);
1112     }
1113   }
1114   _exits.map()-&gt;apply_replaced_nodes(_new_idx);
1115 }
1116 
1117 //-----------------------------create_entry_map-------------------------------
1118 // Initialize our parser map to contain the types at method entry.
1119 // For OSR, the map contains a single RawPtr parameter.
1120 // Initial monitor locking for sync. methods is performed by do_method_entry.
1121 SafePointNode* Parse::create_entry_map() {
1122   // Check for really stupid bail-out cases.
1123   uint len = TypeFunc::Parms + method()-&gt;max_locals() + method()-&gt;max_stack();
1124   if (len &gt;= 32760) {
1125     C-&gt;record_method_not_compilable(&quot;too many local variables&quot;);
1126     return NULL;
1127   }
1128 
1129   // clear current replaced nodes that are of no use from here on (map was cloned in build_exits).
1130   _caller-&gt;map()-&gt;delete_replaced_nodes();
1131 
1132   // If this is an inlined method, we may have to do a receiver null check.
1133   if (_caller-&gt;has_method() &amp;&amp; is_normal_parse() &amp;&amp; !method()-&gt;is_static()) {
1134     GraphKit kit(_caller);
1135     kit.null_check_receiver_before_call(method());
1136     _caller = kit.transfer_exceptions_into_jvms();
1137     if (kit.stopped()) {
1138       _exits.add_exception_states_from(_caller);
1139       _exits.set_jvms(_caller);
1140       return NULL;
1141     }
1142   }
1143 
1144   assert(method() != NULL, &quot;parser must have a method&quot;);
1145 
1146   // Create an initial safepoint to hold JVM state during parsing
1147   JVMState* jvms = new (C) JVMState(method(), _caller-&gt;has_method() ? _caller : NULL);
1148   set_map(new SafePointNode(len, jvms));
1149   jvms-&gt;set_map(map());
1150   record_for_igvn(map());
1151   assert(jvms-&gt;endoff() == len, &quot;correct jvms sizing&quot;);
1152 
1153   SafePointNode* inmap = _caller-&gt;map();
1154   assert(inmap != NULL, &quot;must have inmap&quot;);
1155   // In case of null check on receiver above
1156   map()-&gt;transfer_replaced_nodes_from(inmap, _new_idx);
1157 
1158   uint i;
1159 
1160   // Pass thru the predefined input parameters.
1161   for (i = 0; i &lt; TypeFunc::Parms; i++) {
1162     map()-&gt;init_req(i, inmap-&gt;in(i));
1163   }
1164 
1165   if (depth() == 1) {
1166     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
1167     // Insert the memory aliasing node
1168     set_all_memory(reset_memory());
1169   }
1170   assert(merged_memory(), &quot;&quot;);
1171 
1172   // Now add the locals which are initially bound to arguments:
1173   uint arg_size = tf()-&gt;domain()-&gt;cnt();
1174   ensure_stack(arg_size - TypeFunc::Parms);  // OSR methods have funny args
1175   for (i = TypeFunc::Parms; i &lt; arg_size; i++) {
1176     map()-&gt;init_req(i, inmap-&gt;argument(_caller, i - TypeFunc::Parms));
1177   }
1178 
1179   // Clear out the rest of the map (locals and stack)
1180   for (i = arg_size; i &lt; len; i++) {
1181     map()-&gt;init_req(i, top());
1182   }
1183 
1184   SafePointNode* entry_map = stop();
1185   return entry_map;
1186 }
1187 
1188 //-----------------------------do_method_entry--------------------------------
1189 // Emit any code needed in the pseudo-block before BCI zero.
1190 // The main thing to do is lock the receiver of a synchronized method.
1191 void Parse::do_method_entry() {
1192   set_parse_bci(InvocationEntryBci); // Pseudo-BCP
1193   set_sp(0);                      // Java Stack Pointer
1194 
1195   NOT_PRODUCT( count_compiled_calls(true/*at_method_entry*/, false/*is_inline*/); )
1196 
1197   if (C-&gt;env()-&gt;dtrace_method_probes()) {
1198     make_dtrace_method_entry(method());
1199   }
1200 
1201   // If the method is synchronized, we need to construct a lock node, attach
1202   // it to the Start node, and pin it there.
1203   if (method()-&gt;is_synchronized()) {
1204     // Insert a FastLockNode right after the Start which takes as arguments
1205     // the current thread pointer, the &quot;this&quot; pointer &amp; the address of the
1206     // stack slot pair used for the lock.  The &quot;this&quot; pointer is a projection
1207     // off the start node, but the locking spot has to be constructed by
1208     // creating a ConLNode of 0, and boxing it with a BoxLockNode.  The BoxLockNode
1209     // becomes the second argument to the FastLockNode call.  The
1210     // FastLockNode becomes the new control parent to pin it to the start.
1211 
1212     // Setup Object Pointer
1213     Node *lock_obj = NULL;
1214     if(method()-&gt;is_static()) {
1215       ciInstance* mirror = _method-&gt;holder()-&gt;java_mirror();
1216       const TypeInstPtr *t_lock = TypeInstPtr::make(mirror);
1217       lock_obj = makecon(t_lock);
1218     } else {                  // Else pass the &quot;this&quot; pointer,
1219       lock_obj = local(0);    // which is Parm0 from StartNode
1220     }
1221     // Clear out dead values from the debug info.
1222     kill_dead_locals();
1223     // Build the FastLockNode
1224     _synch_lock = shared_lock(lock_obj);
1225   }
1226 
1227   // Feed profiling data for parameters to the type system so it can
1228   // propagate it as speculative types
1229   record_profiled_parameters_for_speculation();
1230 
1231   if (depth() == 1) {
1232     increment_and_test_invocation_counter(Tier2CompileThreshold);
1233   }
1234 }
1235 
1236 //------------------------------init_blocks------------------------------------
1237 // Initialize our parser map to contain the types/monitors at method entry.
1238 void Parse::init_blocks() {
1239   // Create the blocks.
1240   _block_count = flow()-&gt;block_count();
1241   _blocks = NEW_RESOURCE_ARRAY(Block, _block_count);
1242 
1243   // Initialize the structs.
1244   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1245     Block* block = rpo_at(rpo);
1246     new(block) Block(this, rpo);
1247   }
1248 
1249   // Collect predecessor and successor information.
1250   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1251     Block* block = rpo_at(rpo);
1252     block-&gt;init_graph(this);
1253   }
1254 }
1255 
1256 //-------------------------------init_node-------------------------------------
1257 Parse::Block::Block(Parse* outer, int rpo) : _live_locals() {
1258   _flow = outer-&gt;flow()-&gt;rpo_at(rpo);
1259   _pred_count = 0;
1260   _preds_parsed = 0;
1261   _count = 0;
1262   _is_parsed = false;
1263   _is_handler = false;
1264   _has_merged_backedge = false;
1265   _start_map = NULL;
1266   _has_predicates = false;
1267   _num_successors = 0;
1268   _all_successors = 0;
1269   _successors = NULL;
1270   assert(pred_count() == 0 &amp;&amp; preds_parsed() == 0, &quot;sanity&quot;);
1271   assert(!(is_merged() || is_parsed() || is_handler() || has_merged_backedge()), &quot;sanity&quot;);
1272   assert(_live_locals.size() == 0, &quot;sanity&quot;);
1273 
1274   // entry point has additional predecessor
1275   if (flow()-&gt;is_start())  _pred_count++;
1276   assert(flow()-&gt;is_start() == (this == outer-&gt;start_block()), &quot;&quot;);
1277 }
1278 
1279 //-------------------------------init_graph------------------------------------
1280 void Parse::Block::init_graph(Parse* outer) {
1281   // Create the successor list for this parser block.
1282   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfs = flow()-&gt;successors();
1283   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfe = flow()-&gt;exceptions();
1284   int ns = tfs-&gt;length();
1285   int ne = tfe-&gt;length();
1286   _num_successors = ns;
1287   _all_successors = ns+ne;
1288   _successors = (ns+ne == 0) ? NULL : NEW_RESOURCE_ARRAY(Block*, ns+ne);
1289   int p = 0;
1290   for (int i = 0; i &lt; ns+ne; i++) {
1291     ciTypeFlow::Block* tf2 = (i &lt; ns) ? tfs-&gt;at(i) : tfe-&gt;at(i-ns);
1292     Block* block2 = outer-&gt;rpo_at(tf2-&gt;rpo());
1293     _successors[i] = block2;
1294 
1295     // Accumulate pred info for the other block, too.
1296     if (i &lt; ns) {
1297       block2-&gt;_pred_count++;
1298     } else {
1299       block2-&gt;_is_handler = true;
1300     }
1301 
1302     #ifdef ASSERT
1303     // A block&#39;s successors must be distinguishable by BCI.
1304     // That is, no bytecode is allowed to branch to two different
1305     // clones of the same code location.
1306     for (int j = 0; j &lt; i; j++) {
1307       Block* block1 = _successors[j];
1308       if (block1 == block2)  continue;  // duplicates are OK
1309       assert(block1-&gt;start() != block2-&gt;start(), &quot;successors have unique bcis&quot;);
1310     }
1311     #endif
1312   }
1313 
1314   // Note: We never call next_path_num along exception paths, so they
1315   // never get processed as &quot;ready&quot;.  Also, the input phis of exception
1316   // handlers get specially processed, so that
1317 }
1318 
1319 //---------------------------successor_for_bci---------------------------------
1320 Parse::Block* Parse::Block::successor_for_bci(int bci) {
1321   for (int i = 0; i &lt; all_successors(); i++) {
1322     Block* block2 = successor_at(i);
1323     if (block2-&gt;start() == bci)  return block2;
1324   }
1325   // We can actually reach here if ciTypeFlow traps out a block
1326   // due to an unloaded class, and concurrently with compilation the
1327   // class is then loaded, so that a later phase of the parser is
1328   // able to see more of the bytecode CFG.  Or, the flow pass and
1329   // the parser can have a minor difference of opinion about executability
1330   // of bytecodes.  For example, &quot;obj.field = null&quot; is executable even
1331   // if the field&#39;s type is an unloaded class; the flow pass used to
1332   // make a trap for such code.
1333   return NULL;
1334 }
1335 
1336 
1337 //-----------------------------stack_type_at-----------------------------------
1338 const Type* Parse::Block::stack_type_at(int i) const {
1339   return get_type(flow()-&gt;stack_type_at(i));
1340 }
1341 
1342 
1343 //-----------------------------local_type_at-----------------------------------
1344 const Type* Parse::Block::local_type_at(int i) const {
1345   // Make dead locals fall to bottom.
1346   if (_live_locals.size() == 0) {
1347     MethodLivenessResult live_locals = flow()-&gt;outer()-&gt;method()-&gt;liveness_at_bci(start());
1348     // This bitmap can be zero length if we saw a breakpoint.
1349     // In such cases, pretend they are all live.
1350     ((Block*)this)-&gt;_live_locals = live_locals;
1351   }
1352   if (_live_locals.size() &gt; 0 &amp;&amp; !_live_locals.at(i))
1353     return Type::BOTTOM;
1354 
1355   return get_type(flow()-&gt;local_type_at(i));
1356 }
1357 
1358 
1359 #ifndef PRODUCT
1360 
1361 //----------------------------name_for_bc--------------------------------------
1362 // helper method for BytecodeParseHistogram
1363 static const char* name_for_bc(int i) {
1364   return Bytecodes::is_defined(i) ? Bytecodes::name(Bytecodes::cast(i)) : &quot;xxxunusedxxx&quot;;
1365 }
1366 
1367 //----------------------------BytecodeParseHistogram------------------------------------
1368 Parse::BytecodeParseHistogram::BytecodeParseHistogram(Parse *p, Compile *c) {
1369   _parser   = p;
1370   _compiler = c;
1371   if( ! _initialized ) { _initialized = true; reset(); }
1372 }
1373 
1374 //----------------------------current_count------------------------------------
1375 int Parse::BytecodeParseHistogram::current_count(BPHType bph_type) {
1376   switch( bph_type ) {
1377   case BPH_transforms: { return _parser-&gt;gvn().made_progress(); }
1378   case BPH_values:     { return _parser-&gt;gvn().made_new_values(); }
1379   default: { ShouldNotReachHere(); return 0; }
1380   }
1381 }
1382 
1383 //----------------------------initialized--------------------------------------
1384 bool Parse::BytecodeParseHistogram::initialized() { return _initialized; }
1385 
1386 //----------------------------reset--------------------------------------------
1387 void Parse::BytecodeParseHistogram::reset() {
1388   int i = Bytecodes::number_of_codes;
1389   while (i-- &gt; 0) { _bytecodes_parsed[i] = 0; _nodes_constructed[i] = 0; _nodes_transformed[i] = 0; _new_values[i] = 0; }
1390 }
1391 
1392 //----------------------------set_initial_state--------------------------------
1393 // Record info when starting to parse one bytecode
1394 void Parse::BytecodeParseHistogram::set_initial_state( Bytecodes::Code bc ) {
1395   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1396     _initial_bytecode    = bc;
1397     _initial_node_count  = _compiler-&gt;unique();
1398     _initial_transforms  = current_count(BPH_transforms);
1399     _initial_values      = current_count(BPH_values);
1400   }
1401 }
1402 
1403 //----------------------------record_change--------------------------------
1404 // Record results of parsing one bytecode
1405 void Parse::BytecodeParseHistogram::record_change() {
1406   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1407     ++_bytecodes_parsed[_initial_bytecode];
1408     _nodes_constructed [_initial_bytecode] += (_compiler-&gt;unique() - _initial_node_count);
1409     _nodes_transformed [_initial_bytecode] += (current_count(BPH_transforms) - _initial_transforms);
1410     _new_values        [_initial_bytecode] += (current_count(BPH_values)     - _initial_values);
1411   }
1412 }
1413 
1414 
1415 //----------------------------print--------------------------------------------
1416 void Parse::BytecodeParseHistogram::print(float cutoff) {
1417   ResourceMark rm;
1418   // print profile
1419   int total  = 0;
1420   int i      = 0;
1421   for( i = 0; i &lt; Bytecodes::number_of_codes; ++i ) { total += _bytecodes_parsed[i]; }
1422   int abs_sum = 0;
1423   tty-&gt;cr();   //0123456789012345678901234567890123456789012345678901234567890123456789
1424   tty-&gt;print_cr(&quot;Histogram of %d parsed bytecodes:&quot;, total);
1425   if( total == 0 ) { return; }
1426   tty-&gt;cr();
1427   tty-&gt;print_cr(&quot;absolute:  count of compiled bytecodes of this type&quot;);
1428   tty-&gt;print_cr(&quot;relative:  percentage contribution to compiled nodes&quot;);
1429   tty-&gt;print_cr(&quot;nodes   :  Average number of nodes constructed per bytecode&quot;);
1430   tty-&gt;print_cr(&quot;rnodes  :  Significance towards total nodes constructed, (nodes*relative)&quot;);
1431   tty-&gt;print_cr(&quot;transforms: Average amount of tranform progress per bytecode compiled&quot;);
1432   tty-&gt;print_cr(&quot;values  :  Average number of node values improved per bytecode&quot;);
1433   tty-&gt;print_cr(&quot;name    :  Bytecode name&quot;);
1434   tty-&gt;cr();
1435   tty-&gt;print_cr(&quot;  absolute  relative   nodes  rnodes  transforms  values   name&quot;);
1436   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1437   while (--i &gt; 0) {
1438     int       abs = _bytecodes_parsed[i];
1439     float     rel = abs * 100.0F / total;
1440     float   nodes = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_constructed[i])/_bytecodes_parsed[i];
1441     float  rnodes = _bytecodes_parsed[i] == 0 ? 0 :  rel * nodes;
1442     float  xforms = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_transformed[i])/_bytecodes_parsed[i];
1443     float  values = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _new_values       [i])/_bytecodes_parsed[i];
1444     if (cutoff &lt;= rel) {
1445       tty-&gt;print_cr(&quot;%10d  %7.2f%%  %6.1f  %6.2f   %6.1f   %6.1f     %s&quot;, abs, rel, nodes, rnodes, xforms, values, name_for_bc(i));
1446       abs_sum += abs;
1447     }
1448   }
1449   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1450   float rel_sum = abs_sum * 100.0F / total;
1451   tty-&gt;print_cr(&quot;%10d  %7.2f%%    (cutoff = %.2f%%)&quot;, abs_sum, rel_sum, cutoff);
1452   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1453   tty-&gt;cr();
1454 }
1455 #endif
1456 
1457 //----------------------------load_state_from----------------------------------
1458 // Load block/map/sp.  But not do not touch iter/bci.
1459 void Parse::load_state_from(Block* block) {
1460   set_block(block);
1461   // load the block&#39;s JVM state:
1462   set_map(block-&gt;start_map());
1463   set_sp( block-&gt;start_sp());
1464 }
1465 
1466 
1467 //-----------------------------record_state------------------------------------
1468 void Parse::Block::record_state(Parse* p) {
1469   assert(!is_merged(), &quot;can only record state once, on 1st inflow&quot;);
1470   assert(start_sp() == p-&gt;sp(), &quot;stack pointer must agree with ciTypeFlow&quot;);
1471   set_start_map(p-&gt;stop());
1472 }
1473 
1474 
1475 //------------------------------do_one_block-----------------------------------
1476 void Parse::do_one_block() {
1477   if (TraceOptoParse) {
1478     Block *b = block();
1479     int ns = b-&gt;num_successors();
1480     int nt = b-&gt;all_successors();
1481 
1482     tty-&gt;print(&quot;Parsing block #%d at bci [%d,%d), successors: &quot;,
1483                   block()-&gt;rpo(), block()-&gt;start(), block()-&gt;limit());
1484     for (int i = 0; i &lt; nt; i++) {
1485       tty-&gt;print((( i &lt; ns) ? &quot; %d&quot; : &quot; %d(e)&quot;), b-&gt;successor_at(i)-&gt;rpo());
1486     }
1487     if (b-&gt;is_loop_head()) tty-&gt;print(&quot;  lphd&quot;);
1488     tty-&gt;cr();
1489   }
1490 
1491   assert(block()-&gt;is_merged(), &quot;must be merged before being parsed&quot;);
1492   block()-&gt;mark_parsed();
1493 
1494   // Set iterator to start of block.
1495   iter().reset_to_bci(block()-&gt;start());
1496 
1497   CompileLog* log = C-&gt;log();
1498 
1499   // Parse bytecodes
1500   while (!stopped() &amp;&amp; !failing()) {
1501     iter().next();
1502 
1503     // Learn the current bci from the iterator:
1504     set_parse_bci(iter().cur_bci());
1505 
1506     if (bci() == block()-&gt;limit()) {
1507       // Do not walk into the next block until directed by do_all_blocks.
1508       merge(bci());
1509       break;
1510     }
1511     assert(bci() &lt; block()-&gt;limit(), &quot;bci still in block&quot;);
1512 
1513     if (log != NULL) {
1514       // Output an optional context marker, to help place actions
1515       // that occur during parsing of this BC.  If there is no log
1516       // output until the next context string, this context string
1517       // will be silently ignored.
1518       log-&gt;set_context(&quot;bc code=&#39;%d&#39; bci=&#39;%d&#39;&quot;, (int)bc(), bci());
1519     }
1520 
1521     if (block()-&gt;has_trap_at(bci())) {
1522       // We must respect the flow pass&#39;s traps, because it will refuse
1523       // to produce successors for trapping blocks.
1524       int trap_index = block()-&gt;flow()-&gt;trap_index();
1525       assert(trap_index != 0, &quot;trap index must be valid&quot;);
1526       uncommon_trap(trap_index);
1527       break;
1528     }
1529 
1530     NOT_PRODUCT( parse_histogram()-&gt;set_initial_state(bc()); );
1531 
1532 #ifdef ASSERT
1533     int pre_bc_sp = sp();
1534     int inputs, depth;
1535     bool have_se = !stopped() &amp;&amp; compute_stack_effects(inputs, depth);
1536     assert(!have_se || pre_bc_sp &gt;= inputs, &quot;have enough stack to execute this BC: pre_bc_sp=%d, inputs=%d&quot;, pre_bc_sp, inputs);
1537 #endif //ASSERT
1538 
1539     do_one_bytecode();
1540 
1541     assert(!have_se || stopped() || failing() || (sp() - pre_bc_sp) == depth,
1542            &quot;incorrect depth prediction: sp=%d, pre_bc_sp=%d, depth=%d&quot;, sp(), pre_bc_sp, depth);
1543 
1544     do_exceptions();
1545 
1546     NOT_PRODUCT( parse_histogram()-&gt;record_change(); );
1547 
1548     if (log != NULL)
1549       log-&gt;clear_context();  // skip marker if nothing was printed
1550 
1551     // Fall into next bytecode.  Each bytecode normally has 1 sequential
1552     // successor which is typically made ready by visiting this bytecode.
1553     // If the successor has several predecessors, then it is a merge
1554     // point, starts a new basic block, and is handled like other basic blocks.
1555   }
1556 }
1557 
1558 
1559 //------------------------------merge------------------------------------------
1560 void Parse::set_parse_bci(int bci) {
1561   set_bci(bci);
1562   Node_Notes* nn = C-&gt;default_node_notes();
1563   if (nn == NULL)  return;
1564 
1565   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
1566   if (!DebugInlinedCalls &amp;&amp; depth() &gt; 1) {
1567     return;
1568   }
1569 
1570   // Update the JVMS annotation, if present.
1571   JVMState* jvms = nn-&gt;jvms();
1572   if (jvms != NULL &amp;&amp; jvms-&gt;bci() != bci) {
1573     // Update the JVMS.
1574     jvms = jvms-&gt;clone_shallow(C);
1575     jvms-&gt;set_bci(bci);
1576     nn-&gt;set_jvms(jvms);
1577   }
1578 }
1579 
1580 //------------------------------merge------------------------------------------
1581 // Merge the current mapping into the basic block starting at bci
1582 void Parse::merge(int target_bci) {
1583   Block* target = successor_for_bci(target_bci);
1584   if (target == NULL) { handle_missing_successor(target_bci); return; }
1585   assert(!target-&gt;is_ready(), &quot;our arrival must be expected&quot;);
1586   int pnum = target-&gt;next_path_num();
1587   merge_common(target, pnum);
1588 }
1589 
1590 //-------------------------merge_new_path--------------------------------------
1591 // Merge the current mapping into the basic block, using a new path
1592 void Parse::merge_new_path(int target_bci) {
1593   Block* target = successor_for_bci(target_bci);
1594   if (target == NULL) { handle_missing_successor(target_bci); return; }
1595   assert(!target-&gt;is_ready(), &quot;new path into frozen graph&quot;);
1596   int pnum = target-&gt;add_new_path();
1597   merge_common(target, pnum);
1598 }
1599 
1600 //-------------------------merge_exception-------------------------------------
1601 // Merge the current mapping into the basic block starting at bci
1602 // The ex_oop must be pushed on the stack, unlike throw_to_exit.
1603 void Parse::merge_exception(int target_bci) {
1604   assert(sp() == 1, &quot;must have only the throw exception on the stack&quot;);
1605   Block* target = successor_for_bci(target_bci);
1606   if (target == NULL) { handle_missing_successor(target_bci); return; }
1607   assert(target-&gt;is_handler(), &quot;exceptions are handled by special blocks&quot;);
1608   int pnum = target-&gt;add_new_path();
1609   merge_common(target, pnum);
1610 }
1611 
1612 //--------------------handle_missing_successor---------------------------------
1613 void Parse::handle_missing_successor(int target_bci) {
1614 #ifndef PRODUCT
1615   Block* b = block();
1616   int trap_bci = b-&gt;flow()-&gt;has_trap()? b-&gt;flow()-&gt;trap_bci(): -1;
1617   tty-&gt;print_cr(&quot;### Missing successor at bci:%d for block #%d (trap_bci:%d)&quot;, target_bci, b-&gt;rpo(), trap_bci);
1618 #endif
1619   ShouldNotReachHere();
1620 }
1621 
1622 //--------------------------merge_common---------------------------------------
1623 void Parse::merge_common(Parse::Block* target, int pnum) {
1624   if (TraceOptoParse) {
1625     tty-&gt;print(&quot;Merging state at block #%d bci:%d&quot;, target-&gt;rpo(), target-&gt;start());
1626   }
1627 
1628   // Zap extra stack slots to top
1629   assert(sp() == target-&gt;start_sp(), &quot;&quot;);
1630   clean_stack(sp());
1631 
1632   if (!target-&gt;is_merged()) {   // No prior mapping at this bci
1633     if (TraceOptoParse) { tty-&gt;print(&quot; with empty state&quot;);  }
1634 
1635     // If this path is dead, do not bother capturing it as a merge.
1636     // It is &quot;as if&quot; we had 1 fewer predecessors from the beginning.
1637     if (stopped()) {
1638       if (TraceOptoParse)  tty-&gt;print_cr(&quot;, but path is dead and doesn&#39;t count&quot;);
1639       return;
1640     }
1641 
1642     // Make a region if we know there are multiple or unpredictable inputs.
1643     // (Also, if this is a plain fall-through, we might see another region,
1644     // which must not be allowed into this block&#39;s map.)
1645     if (pnum &gt; PhiNode::Input         // Known multiple inputs.
1646         || target-&gt;is_handler()       // These have unpredictable inputs.
1647         || target-&gt;is_loop_head()     // Known multiple inputs
1648         || control()-&gt;is_Region()) {  // We must hide this guy.
1649 
1650       int current_bci = bci();
1651       set_parse_bci(target-&gt;start()); // Set target bci
1652       if (target-&gt;is_SEL_head()) {
1653         DEBUG_ONLY( target-&gt;mark_merged_backedge(block()); )
1654         if (target-&gt;start() == 0) {
1655           // Add loop predicate for the special case when
1656           // there are backbranches to the method entry.
1657           add_predicate();
1658         }
1659       }
1660       // Add a Region to start the new basic block.  Phis will be added
1661       // later lazily.
1662       int edges = target-&gt;pred_count();
1663       if (edges &lt; pnum)  edges = pnum;  // might be a new path!
1664       RegionNode *r = new RegionNode(edges+1);
1665       gvn().set_type(r, Type::CONTROL);
1666       record_for_igvn(r);
1667       // zap all inputs to NULL for debugging (done in Node(uint) constructor)
1668       // for (int j = 1; j &lt; edges+1; j++) { r-&gt;init_req(j, NULL); }
1669       r-&gt;init_req(pnum, control());
1670       set_control(r);
1671       set_parse_bci(current_bci); // Restore bci
1672     }
1673 
1674     // Convert the existing Parser mapping into a mapping at this bci.
1675     store_state_to(target);
1676     assert(target-&gt;is_merged(), &quot;do not come here twice&quot;);
1677 
1678   } else {                      // Prior mapping at this bci
1679     if (TraceOptoParse) {  tty-&gt;print(&quot; with previous state&quot;); }
1680 #ifdef ASSERT
1681     if (target-&gt;is_SEL_head()) {
1682       target-&gt;mark_merged_backedge(block());
1683     }
1684 #endif
1685     // We must not manufacture more phis if the target is already parsed.
1686     bool nophi = target-&gt;is_parsed();
1687 
1688     SafePointNode* newin = map();// Hang on to incoming mapping
1689     Block* save_block = block(); // Hang on to incoming block;
1690     load_state_from(target);    // Get prior mapping
1691 
1692     assert(newin-&gt;jvms()-&gt;locoff() == jvms()-&gt;locoff(), &quot;JVMS layouts agree&quot;);
1693     assert(newin-&gt;jvms()-&gt;stkoff() == jvms()-&gt;stkoff(), &quot;JVMS layouts agree&quot;);
1694     assert(newin-&gt;jvms()-&gt;monoff() == jvms()-&gt;monoff(), &quot;JVMS layouts agree&quot;);
1695     assert(newin-&gt;jvms()-&gt;endoff() == jvms()-&gt;endoff(), &quot;JVMS layouts agree&quot;);
1696 
1697     // Iterate over my current mapping and the old mapping.
1698     // Where different, insert Phi functions.
1699     // Use any existing Phi functions.
1700     assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1701     RegionNode* r = control()-&gt;as_Region();
1702 
1703     // Compute where to merge into
1704     // Merge incoming control path
1705     r-&gt;init_req(pnum, newin-&gt;control());
1706 
1707     if (pnum == 1) {            // Last merge for this Region?
1708       if (!block()-&gt;flow()-&gt;is_irreducible_entry()) {
1709         Node* result = _gvn.transform_no_reclaim(r);
1710         if (r != result &amp;&amp; TraceOptoParse) {
1711           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block()-&gt;rpo(), r-&gt;_idx, result-&gt;_idx);
1712         }
1713       }
1714       record_for_igvn(r);
1715     }
1716 
1717     // Update all the non-control inputs to map:
1718     assert(TypeFunc::Parms == newin-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1719     bool check_elide_phi = target-&gt;is_SEL_backedge(save_block);
1720     for (uint j = 1; j &lt; newin-&gt;req(); j++) {
1721       Node* m = map()-&gt;in(j);   // Current state of target.
1722       Node* n = newin-&gt;in(j);   // Incoming change to target state.
1723       PhiNode* phi;
1724       if (m-&gt;is_Phi() &amp;&amp; m-&gt;as_Phi()-&gt;region() == r)
1725         phi = m-&gt;as_Phi();
1726       else
1727         phi = NULL;
1728       if (m != n) {             // Different; must merge
1729         switch (j) {
1730         // Frame pointer and Return Address never changes
1731         case TypeFunc::FramePtr:// Drop m, use the original value
1732         case TypeFunc::ReturnAdr:
1733           break;
1734         case TypeFunc::Memory:  // Merge inputs to the MergeMem node
1735           assert(phi == NULL, &quot;the merge contains phis, not vice versa&quot;);
1736           merge_memory_edges(n-&gt;as_MergeMem(), pnum, nophi);
1737           continue;
1738         default:                // All normal stuff
1739           if (phi == NULL) {
1740             const JVMState* jvms = map()-&gt;jvms();
1741             if (EliminateNestedLocks &amp;&amp;
1742                 jvms-&gt;is_mon(j) &amp;&amp; jvms-&gt;is_monitor_box(j)) {
1743               // BoxLock nodes are not commoning.
1744               // Use old BoxLock node as merged box.
1745               assert(newin-&gt;jvms()-&gt;is_monitor_box(j), &quot;sanity&quot;);
1746               // This assert also tests that nodes are BoxLock.
1747               assert(BoxLockNode::same_slot(n, m), &quot;sanity&quot;);
1748               C-&gt;gvn_replace_by(n, m);
1749             } else if (!check_elide_phi || !target-&gt;can_elide_SEL_phi(j)) {
1750               phi = ensure_phi(j, nophi);
1751             }
1752           }
1753           break;
1754         }
1755       }
1756       // At this point, n might be top if:
1757       //  - there is no phi (because TypeFlow detected a conflict), or
1758       //  - the corresponding control edges is top (a dead incoming path)
1759       // It is a bug if we create a phi which sees a garbage value on a live path.
1760 
1761       if (phi != NULL) {
1762         assert(n != top() || r-&gt;in(pnum) == top(), &quot;live value must not be garbage&quot;);
1763         assert(phi-&gt;region() == r, &quot;&quot;);
1764         phi-&gt;set_req(pnum, n);  // Then add &#39;n&#39; to the merge
1765         if (pnum == PhiNode::Input) {
1766           // Last merge for this Phi.
1767           // So far, Phis have had a reasonable type from ciTypeFlow.
1768           // Now _gvn will join that with the meet of current inputs.
1769           // BOTTOM is never permissible here, &#39;cause pessimistically
1770           // Phis of pointers cannot lose the basic pointer type.
1771           debug_only(const Type* bt1 = phi-&gt;bottom_type());
1772           assert(bt1 != Type::BOTTOM, &quot;should not be building conflict phis&quot;);
1773           map()-&gt;set_req(j, _gvn.transform_no_reclaim(phi));
1774           debug_only(const Type* bt2 = phi-&gt;bottom_type());
1775           assert(bt2-&gt;higher_equal_speculative(bt1), &quot;must be consistent with type-flow&quot;);
1776           record_for_igvn(phi);
1777         }
1778       }
1779     } // End of for all values to be merged
1780 
1781     if (pnum == PhiNode::Input &amp;&amp;
1782         !r-&gt;in(0)) {         // The occasional useless Region
1783       assert(control() == r, &quot;&quot;);
1784       set_control(r-&gt;nonnull_req());
1785     }
1786 
1787     map()-&gt;merge_replaced_nodes_with(newin);
1788 
1789     // newin has been subsumed into the lazy merge, and is now dead.
1790     set_block(save_block);
1791 
1792     stop();                     // done with this guy, for now
1793   }
1794 
1795   if (TraceOptoParse) {
1796     tty-&gt;print_cr(&quot; on path %d&quot;, pnum);
1797   }
1798 
1799   // Done with this parser state.
1800   assert(stopped(), &quot;&quot;);
1801 }
1802 
1803 
1804 //--------------------------merge_memory_edges---------------------------------
1805 void Parse::merge_memory_edges(MergeMemNode* n, int pnum, bool nophi) {
1806   // (nophi means we must not create phis, because we already parsed here)
1807   assert(n != NULL, &quot;&quot;);
1808   // Merge the inputs to the MergeMems
1809   MergeMemNode* m = merged_memory();
1810 
1811   assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1812   RegionNode* r = control()-&gt;as_Region();
1813 
1814   PhiNode* base = NULL;
1815   MergeMemNode* remerge = NULL;
1816   for (MergeMemStream mms(m, n); mms.next_non_empty2(); ) {
1817     Node *p = mms.force_memory();
1818     Node *q = mms.memory2();
1819     if (mms.is_empty() &amp;&amp; nophi) {
1820       // Trouble:  No new splits allowed after a loop body is parsed.
1821       // Instead, wire the new split into a MergeMem on the backedge.
1822       // The optimizer will sort it out, slicing the phi.
1823       if (remerge == NULL) {
1824         guarantee(base != NULL, &quot;&quot;);
1825         assert(base-&gt;in(0) != NULL, &quot;should not be xformed away&quot;);
1826         remerge = MergeMemNode::make(base-&gt;in(pnum));
1827         gvn().set_type(remerge, Type::MEMORY);
1828         base-&gt;set_req(pnum, remerge);
1829       }
1830       remerge-&gt;set_memory_at(mms.alias_idx(), q);
1831       continue;
1832     }
1833     assert(!q-&gt;is_MergeMem(), &quot;&quot;);
1834     PhiNode* phi;
1835     if (p != q) {
1836       phi = ensure_memory_phi(mms.alias_idx(), nophi);
1837     } else {
1838       if (p-&gt;is_Phi() &amp;&amp; p-&gt;as_Phi()-&gt;region() == r)
1839         phi = p-&gt;as_Phi();
1840       else
1841         phi = NULL;
1842     }
1843     // Insert q into local phi
1844     if (phi != NULL) {
1845       assert(phi-&gt;region() == r, &quot;&quot;);
1846       p = phi;
1847       phi-&gt;set_req(pnum, q);
1848       if (mms.at_base_memory()) {
1849         base = phi;  // delay transforming it
1850       } else if (pnum == 1) {
1851         record_for_igvn(phi);
1852         p = _gvn.transform_no_reclaim(phi);
1853       }
1854       mms.set_memory(p);// store back through the iterator
1855     }
1856   }
1857   // Transform base last, in case we must fiddle with remerging.
1858   if (base != NULL &amp;&amp; pnum == 1) {
1859     record_for_igvn(base);
1860     m-&gt;set_base_memory( _gvn.transform_no_reclaim(base) );
1861   }
1862 }
1863 
1864 
1865 //------------------------ensure_phis_everywhere-------------------------------
1866 void Parse::ensure_phis_everywhere() {
1867   ensure_phi(TypeFunc::I_O);
1868 
1869   // Ensure a phi on all currently known memories.
1870   for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
1871     ensure_memory_phi(mms.alias_idx());
1872     debug_only(mms.set_memory());  // keep the iterator happy
1873   }
1874 
1875   // Note:  This is our only chance to create phis for memory slices.
1876   // If we miss a slice that crops up later, it will have to be
1877   // merged into the base-memory phi that we are building here.
1878   // Later, the optimizer will comb out the knot, and build separate
1879   // phi-loops for each memory slice that matters.
1880 
1881   // Monitors must nest nicely and not get confused amongst themselves.
1882   // Phi-ify everything up to the monitors, though.
1883   uint monoff = map()-&gt;jvms()-&gt;monoff();
1884   uint nof_monitors = map()-&gt;jvms()-&gt;nof_monitors();
1885 
1886   assert(TypeFunc::Parms == map()-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1887   bool check_elide_phi = block()-&gt;is_SEL_head();
1888   for (uint i = TypeFunc::Parms; i &lt; monoff; i++) {
1889     if (!check_elide_phi || !block()-&gt;can_elide_SEL_phi(i)) {
1890       ensure_phi(i);
1891     }
1892   }
1893 
1894   // Even monitors need Phis, though they are well-structured.
1895   // This is true for OSR methods, and also for the rare cases where
1896   // a monitor object is the subject of a replace_in_map operation.
1897   // See bugs 4426707 and 5043395.
1898   for (uint m = 0; m &lt; nof_monitors; m++) {
1899     ensure_phi(map()-&gt;jvms()-&gt;monitor_obj_offset(m));
1900   }
1901 }
1902 
1903 
1904 //-----------------------------add_new_path------------------------------------
1905 // Add a previously unaccounted predecessor to this block.
1906 int Parse::Block::add_new_path() {
1907   // If there is no map, return the lowest unused path number.
1908   if (!is_merged())  return pred_count()+1;  // there will be a map shortly
1909 
1910   SafePointNode* map = start_map();
1911   if (!map-&gt;control()-&gt;is_Region())
1912     return pred_count()+1;  // there may be a region some day
1913   RegionNode* r = map-&gt;control()-&gt;as_Region();
1914 
1915   // Add new path to the region.
1916   uint pnum = r-&gt;req();
1917   r-&gt;add_req(NULL);
1918 
1919   for (uint i = 1; i &lt; map-&gt;req(); i++) {
1920     Node* n = map-&gt;in(i);
1921     if (i == TypeFunc::Memory) {
1922       // Ensure a phi on all currently known memories.
1923       for (MergeMemStream mms(n-&gt;as_MergeMem()); mms.next_non_empty(); ) {
1924         Node* phi = mms.memory();
1925         if (phi-&gt;is_Phi() &amp;&amp; phi-&gt;as_Phi()-&gt;region() == r) {
1926           assert(phi-&gt;req() == pnum, &quot;must be same size as region&quot;);
1927           phi-&gt;add_req(NULL);
1928         }
1929       }
1930     } else {
1931       if (n-&gt;is_Phi() &amp;&amp; n-&gt;as_Phi()-&gt;region() == r) {
1932         assert(n-&gt;req() == pnum, &quot;must be same size as region&quot;);
1933         n-&gt;add_req(NULL);
1934       }
1935     }
1936   }
1937 
1938   return pnum;
1939 }
1940 
1941 //------------------------------ensure_phi-------------------------------------
1942 // Turn the idx&#39;th entry of the current map into a Phi
1943 PhiNode *Parse::ensure_phi(int idx, bool nocreate) {
1944   SafePointNode* map = this-&gt;map();
1945   Node* region = map-&gt;control();
1946   assert(region-&gt;is_Region(), &quot;&quot;);
1947 
1948   Node* o = map-&gt;in(idx);
1949   assert(o != NULL, &quot;&quot;);
1950 
1951   if (o == top())  return NULL; // TOP always merges into TOP
1952 
1953   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
1954     return o-&gt;as_Phi();
1955   }
1956 
1957   // Now use a Phi here for merging
1958   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
1959   const JVMState* jvms = map-&gt;jvms();
1960   const Type* t = NULL;
1961   if (jvms-&gt;is_loc(idx)) {
1962     t = block()-&gt;local_type_at(idx - jvms-&gt;locoff());
1963   } else if (jvms-&gt;is_stk(idx)) {
1964     t = block()-&gt;stack_type_at(idx - jvms-&gt;stkoff());
1965   } else if (jvms-&gt;is_mon(idx)) {
1966     assert(!jvms-&gt;is_monitor_box(idx), &quot;no phis for boxes&quot;);
1967     t = TypeInstPtr::BOTTOM; // this is sufficient for a lock object
1968   } else if ((uint)idx &lt; TypeFunc::Parms) {
1969     t = o-&gt;bottom_type();  // Type::RETURN_ADDRESS or such-like.
1970   } else {
1971     assert(false, &quot;no type information for this phi&quot;);
1972   }
1973 
1974   // If the type falls to bottom, then this must be a local that
1975   // is mixing ints and oops or some such.  Forcing it to top
1976   // makes it go dead.
1977   if (t == Type::BOTTOM) {
1978     map-&gt;set_req(idx, top());
1979     return NULL;
1980   }
1981 
1982   // Do not create phis for top either.
1983   // A top on a non-null control flow must be an unused even after the.phi.
1984   if (t == Type::TOP || t == Type::HALF) {
1985     map-&gt;set_req(idx, top());
1986     return NULL;
1987   }
1988 
1989   PhiNode* phi = PhiNode::make(region, o, t);
1990   gvn().set_type(phi, t);
1991   if (C-&gt;do_escape_analysis()) record_for_igvn(phi);
1992   map-&gt;set_req(idx, phi);
1993   return phi;
1994 }
1995 
1996 //--------------------------ensure_memory_phi----------------------------------
1997 // Turn the idx&#39;th slice of the current memory into a Phi
1998 PhiNode *Parse::ensure_memory_phi(int idx, bool nocreate) {
1999   MergeMemNode* mem = merged_memory();
2000   Node* region = control();
2001   assert(region-&gt;is_Region(), &quot;&quot;);
2002 
2003   Node *o = (idx == Compile::AliasIdxBot)? mem-&gt;base_memory(): mem-&gt;memory_at(idx);
2004   assert(o != NULL &amp;&amp; o != top(), &quot;&quot;);
2005 
2006   PhiNode* phi;
2007   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2008     phi = o-&gt;as_Phi();
2009     if (phi == mem-&gt;base_memory() &amp;&amp; idx &gt;= Compile::AliasIdxRaw) {
2010       // clone the shared base memory phi to make a new memory split
2011       assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2012       const Type* t = phi-&gt;bottom_type();
2013       const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2014       phi = phi-&gt;slice_memory(adr_type);
2015       gvn().set_type(phi, t);
2016     }
2017     return phi;
2018   }
2019 
2020   // Now use a Phi here for merging
2021   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2022   const Type* t = o-&gt;bottom_type();
2023   const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2024   phi = PhiNode::make(region, o, t, adr_type);
2025   gvn().set_type(phi, t);
2026   if (idx == Compile::AliasIdxBot)
2027     mem-&gt;set_base_memory(phi);
2028   else
2029     mem-&gt;set_memory_at(idx, phi);
2030   return phi;
2031 }
2032 
2033 //------------------------------call_register_finalizer-----------------------
2034 // Check the klass of the receiver and call register_finalizer if the
2035 // class need finalization.
2036 void Parse::call_register_finalizer() {
2037   Node* receiver = local(0);
2038   assert(receiver != NULL &amp;&amp; receiver-&gt;bottom_type()-&gt;isa_instptr() != NULL,
2039          &quot;must have non-null instance type&quot;);
2040 
2041   const TypeInstPtr *tinst = receiver-&gt;bottom_type()-&gt;isa_instptr();
2042   if (tinst != NULL &amp;&amp; tinst-&gt;klass()-&gt;is_loaded() &amp;&amp; !tinst-&gt;klass_is_exact()) {
2043     // The type isn&#39;t known exactly so see if CHA tells us anything.
2044     ciInstanceKlass* ik = tinst-&gt;klass()-&gt;as_instance_klass();
2045     if (!Dependencies::has_finalizable_subclass(ik)) {
2046       // No finalizable subclasses so skip the dynamic check.
2047       C-&gt;dependencies()-&gt;assert_has_no_finalizable_subclasses(ik);
2048       return;
2049     }
2050   }
2051 
2052   // Insert a dynamic test for whether the instance needs
2053   // finalization.  In general this will fold up since the concrete
2054   // class is often visible so the access flags are constant.
2055   Node* klass_addr = basic_plus_adr( receiver, receiver, oopDesc::klass_offset_in_bytes() );
2056   Node* klass = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), klass_addr, TypeInstPtr::KLASS));
2057 
2058   Node* access_flags_addr = basic_plus_adr(klass, klass, in_bytes(Klass::access_flags_offset()));
2059   Node* access_flags = make_load(NULL, access_flags_addr, TypeInt::INT, T_INT, MemNode::unordered);
2060 
2061   Node* mask  = _gvn.transform(new AndINode(access_flags, intcon(JVM_ACC_HAS_FINALIZER)));
2062   Node* check = _gvn.transform(new CmpINode(mask, intcon(0)));
2063   Node* test  = _gvn.transform(new BoolNode(check, BoolTest::ne));
2064 
2065   IfNode* iff = create_and_map_if(control(), test, PROB_MAX, COUNT_UNKNOWN);
2066 
2067   RegionNode* result_rgn = new RegionNode(3);
2068   record_for_igvn(result_rgn);
2069 
2070   Node *skip_register = _gvn.transform(new IfFalseNode(iff));
2071   result_rgn-&gt;init_req(1, skip_register);
2072 
2073   Node *needs_register = _gvn.transform(new IfTrueNode(iff));
2074   set_control(needs_register);
2075   if (stopped()) {
2076     // There is no slow path.
2077     result_rgn-&gt;init_req(2, top());
2078   } else {
2079     Node *call = make_runtime_call(RC_NO_LEAF,
2080                                    OptoRuntime::register_finalizer_Type(),
2081                                    OptoRuntime::register_finalizer_Java(),
2082                                    NULL, TypePtr::BOTTOM,
2083                                    receiver);
2084     make_slow_call_ex(call, env()-&gt;Throwable_klass(), true);
2085 
2086     Node* fast_io  = call-&gt;in(TypeFunc::I_O);
2087     Node* fast_mem = call-&gt;in(TypeFunc::Memory);
2088     // These two phis are pre-filled with copies of of the fast IO and Memory
2089     Node* io_phi   = PhiNode::make(result_rgn, fast_io,  Type::ABIO);
2090     Node* mem_phi  = PhiNode::make(result_rgn, fast_mem, Type::MEMORY, TypePtr::BOTTOM);
2091 
2092     result_rgn-&gt;init_req(2, control());
2093     io_phi    -&gt;init_req(2, i_o());
2094     mem_phi   -&gt;init_req(2, reset_memory());
2095 
2096     set_all_memory( _gvn.transform(mem_phi) );
2097     set_i_o(        _gvn.transform(io_phi) );
2098   }
2099 
2100   set_control( _gvn.transform(result_rgn) );
2101 }
2102 
2103 // Add check to deoptimize if RTM state is not ProfileRTM
2104 void Parse::rtm_deopt() {
2105 #if INCLUDE_RTM_OPT
2106   if (C-&gt;profile_rtm()) {
2107     assert(C-&gt;method() != NULL, &quot;only for normal compilations&quot;);
2108     assert(!C-&gt;method()-&gt;method_data()-&gt;is_empty(), &quot;MDO is needed to record RTM state&quot;);
2109     assert(depth() == 1, &quot;generate check only for main compiled method&quot;);
2110 
2111     // Set starting bci for uncommon trap.
2112     set_parse_bci(is_osr_parse() ? osr_bci() : 0);
2113 
2114     // Load the rtm_state from the MethodData.
2115     const TypePtr* adr_type = TypeMetadataPtr::make(C-&gt;method()-&gt;method_data());
2116     Node* mdo = makecon(adr_type);
2117     int offset = MethodData::rtm_state_offset_in_bytes();
2118     Node* adr_node = basic_plus_adr(mdo, mdo, offset);
2119     Node* rtm_state = make_load(control(), adr_node, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2120 
2121     // Separate Load from Cmp by Opaque.
2122     // In expand_macro_nodes() it will be replaced either
2123     // with this load when there are locks in the code
2124     // or with ProfileRTM (cmp-&gt;in(2)) otherwise so that
2125     // the check will fold.
2126     Node* profile_state = makecon(TypeInt::make(ProfileRTM));
2127     Node* opq   = _gvn.transform( new Opaque3Node(C, rtm_state, Opaque3Node::RTM_OPT) );
2128     Node* chk   = _gvn.transform( new CmpINode(opq, profile_state) );
2129     Node* tst   = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
2130     // Branch to failure if state was changed
2131     { BuildCutout unless(this, tst, PROB_ALWAYS);
2132       uncommon_trap(Deoptimization::Reason_rtm_state_change,
2133                     Deoptimization::Action_make_not_entrant);
2134     }
2135   }
2136 #endif
2137 }
2138 
2139 void Parse::decrement_age() {
2140   MethodCounters* mc = method()-&gt;ensure_method_counters();
2141   if (mc == NULL) {
2142     C-&gt;record_failure(&quot;Must have MCs&quot;);
2143     return;
2144   }
2145   assert(!is_osr_parse(), &quot;Not doing this for OSRs&quot;);
2146 
2147   // Set starting bci for uncommon trap.
2148   set_parse_bci(0);
2149 
2150   const TypePtr* adr_type = TypeRawPtr::make((address)mc);
2151   Node* mc_adr = makecon(adr_type);
2152   Node* cnt_adr = basic_plus_adr(mc_adr, mc_adr, in_bytes(MethodCounters::nmethod_age_offset()));
2153   Node* cnt = make_load(control(), cnt_adr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2154   Node* decr = _gvn.transform(new SubINode(cnt, makecon(TypeInt::ONE)));
2155   store_to_memory(control(), cnt_adr, decr, T_INT, adr_type, MemNode::unordered);
2156   Node *chk   = _gvn.transform(new CmpINode(decr, makecon(TypeInt::ZERO)));
2157   Node* tst   = _gvn.transform(new BoolNode(chk, BoolTest::gt));
2158   { BuildCutout unless(this, tst, PROB_ALWAYS);
2159     uncommon_trap(Deoptimization::Reason_tenured,
2160                   Deoptimization::Action_make_not_entrant);
2161   }
2162 }
2163 
2164 //------------------------------return_current---------------------------------
2165 // Append current _map to _exit_return
2166 void Parse::return_current(Node* value) {
2167   if (RegisterFinalizersAtInit &amp;&amp;
2168       method()-&gt;intrinsic_id() == vmIntrinsics::_Object_init) {
2169     call_register_finalizer();
2170   }
2171 
2172   // Do not set_parse_bci, so that return goo is credited to the return insn.
2173   set_bci(InvocationEntryBci);
2174   if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
2175     shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
2176   }
2177   if (C-&gt;env()-&gt;dtrace_method_probes()) {
2178     make_dtrace_method_exit(method());
2179   }
2180   SafePointNode* exit_return = _exits.map();
2181   exit_return-&gt;in( TypeFunc::Control  )-&gt;add_req( control() );
2182   exit_return-&gt;in( TypeFunc::I_O      )-&gt;add_req( i_o    () );
2183   Node *mem = exit_return-&gt;in( TypeFunc::Memory   );
2184   for (MergeMemStream mms(mem-&gt;as_MergeMem(), merged_memory()); mms.next_non_empty2(); ) {
2185     if (mms.is_empty()) {
2186       // get a copy of the base memory, and patch just this one input
2187       const TypePtr* adr_type = mms.adr_type(C);
2188       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
2189       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
2190       gvn().set_type_bottom(phi);
2191       phi-&gt;del_req(phi-&gt;req()-1);  // prepare to re-patch
2192       mms.set_memory(phi);
2193     }
2194     mms.memory()-&gt;add_req(mms.memory2());
2195   }
2196 
2197   // frame pointer is always same, already captured
2198   if (value != NULL) {
2199     // If returning oops to an interface-return, there is a silent free
2200     // cast from oop to interface allowed by the Verifier.  Make it explicit
2201     // here.
2202     Node* phi = _exits.argument(0);
2203     const TypeInstPtr *tr = phi-&gt;bottom_type()-&gt;isa_instptr();
2204     if (tr &amp;&amp; tr-&gt;klass()-&gt;is_loaded() &amp;&amp;
2205         tr-&gt;klass()-&gt;is_interface()) {
2206       const TypeInstPtr *tp = value-&gt;bottom_type()-&gt;isa_instptr();
2207       if (tp &amp;&amp; tp-&gt;klass()-&gt;is_loaded() &amp;&amp;
2208           !tp-&gt;klass()-&gt;is_interface()) {
2209         // sharpen the type eagerly; this eases certain assert checking
2210         if (tp-&gt;higher_equal(TypeInstPtr::NOTNULL))
2211           tr = tr-&gt;join_speculative(TypeInstPtr::NOTNULL)-&gt;is_instptr();
2212         value = _gvn.transform(new CheckCastPPNode(0, value, tr));
2213       }
2214     } else {
2215       // Also handle returns of oop-arrays to an arrays-of-interface return
2216       const TypeInstPtr* phi_tip;
2217       const TypeInstPtr* val_tip;
2218       Type::get_arrays_base_elements(phi-&gt;bottom_type(), value-&gt;bottom_type(), &amp;phi_tip, &amp;val_tip);
2219       if (phi_tip != NULL &amp;&amp; phi_tip-&gt;is_loaded() &amp;&amp; phi_tip-&gt;klass()-&gt;is_interface() &amp;&amp;
2220           val_tip != NULL &amp;&amp; val_tip-&gt;is_loaded() &amp;&amp; !val_tip-&gt;klass()-&gt;is_interface()) {
2221         value = _gvn.transform(new CheckCastPPNode(0, value, phi-&gt;bottom_type()));
2222       }
2223     }
2224     phi-&gt;add_req(value);
2225   }
2226 
2227   if (_first_return) {
2228     _exits.map()-&gt;transfer_replaced_nodes_from(map(), _new_idx);
2229     _first_return = false;
2230   } else {
2231     _exits.map()-&gt;merge_replaced_nodes_with(map());
2232   }
2233 
2234   stop_and_kill_map();          // This CFG path dies here
2235 }
2236 
2237 
2238 //------------------------------add_safepoint----------------------------------
2239 void Parse::add_safepoint() {
2240   // See if we can avoid this safepoint.  No need for a SafePoint immediately
2241   // after a Call (except Leaf Call) or another SafePoint.
2242   Node *proj = control();
2243   bool add_poll_param = SafePointNode::needs_polling_address_input();
2244   uint parms = add_poll_param ? TypeFunc::Parms+1 : TypeFunc::Parms;
2245   if( proj-&gt;is_Proj() ) {
2246     Node *n0 = proj-&gt;in(0);
2247     if( n0-&gt;is_Catch() ) {
2248       n0 = n0-&gt;in(0)-&gt;in(0);
2249       assert( n0-&gt;is_Call(), &quot;expect a call here&quot; );
2250     }
2251     if( n0-&gt;is_Call() ) {
2252       if( n0-&gt;as_Call()-&gt;guaranteed_safepoint() )
2253         return;
2254     } else if( n0-&gt;is_SafePoint() &amp;&amp; n0-&gt;req() &gt;= parms ) {
2255       return;
2256     }
2257   }
2258 
2259   // Clear out dead values from the debug info.
2260   kill_dead_locals();
2261 
2262   // Clone the JVM State
2263   SafePointNode *sfpnt = new SafePointNode(parms, NULL);
2264 
2265   // Capture memory state BEFORE a SafePoint.  Since we can block at a
2266   // SafePoint we need our GC state to be safe; i.e. we need all our current
2267   // write barriers (card marks) to not float down after the SafePoint so we
2268   // must read raw memory.  Likewise we need all oop stores to match the card
2269   // marks.  If deopt can happen, we need ALL stores (we need the correct JVM
2270   // state on a deopt).
2271 
2272   // We do not need to WRITE the memory state after a SafePoint.  The control
2273   // edge will keep card-marks and oop-stores from floating up from below a
2274   // SafePoint and our true dependency added here will keep them from floating
2275   // down below a SafePoint.
2276 
2277   // Clone the current memory state
2278   Node* mem = MergeMemNode::make(map()-&gt;memory());
2279 
2280   mem = _gvn.transform(mem);
2281 
2282   // Pass control through the safepoint
2283   sfpnt-&gt;init_req(TypeFunc::Control  , control());
2284   // Fix edges normally used by a call
2285   sfpnt-&gt;init_req(TypeFunc::I_O      , top() );
2286   sfpnt-&gt;init_req(TypeFunc::Memory   , mem   );
2287   sfpnt-&gt;init_req(TypeFunc::ReturnAdr, top() );
2288   sfpnt-&gt;init_req(TypeFunc::FramePtr , top() );
2289 
2290   // Create a node for the polling address
2291   if( add_poll_param ) {
2292     Node *polladr;
2293     if (SafepointMechanism::uses_thread_local_poll()) {
2294       Node *thread = _gvn.transform(new ThreadLocalNode());
2295       Node *polling_page_load_addr = _gvn.transform(basic_plus_adr(top(), thread, in_bytes(Thread::polling_page_offset())));
2296       polladr = make_load(control(), polling_page_load_addr, TypeRawPtr::BOTTOM, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
2297     } else {
2298       polladr = ConPNode::make((address)os::get_polling_page());
2299     }
2300     sfpnt-&gt;init_req(TypeFunc::Parms+0, _gvn.transform(polladr));
2301   }
2302 
2303   // Fix up the JVM State edges
2304   add_safepoint_edges(sfpnt);
2305   Node *transformed_sfpnt = _gvn.transform(sfpnt);
2306   set_control(transformed_sfpnt);
2307 
2308   // Provide an edge from root to safepoint.  This makes the safepoint
2309   // appear useful until the parse has completed.
2310   if( OptoRemoveUseless &amp;&amp; transformed_sfpnt-&gt;is_SafePoint() ) {
2311     assert(C-&gt;root() != NULL, &quot;Expect parse is still valid&quot;);
2312     C-&gt;root()-&gt;add_prec(transformed_sfpnt);
2313   }
2314 }
2315 
2316 #ifndef PRODUCT
2317 //------------------------show_parse_info--------------------------------------
2318 void Parse::show_parse_info() {
2319   InlineTree* ilt = NULL;
2320   if (C-&gt;ilt() != NULL) {
2321     JVMState* caller_jvms = is_osr_parse() ? caller()-&gt;caller() : caller();
2322     ilt = InlineTree::find_subtree_from_root(C-&gt;ilt(), caller_jvms, method());
2323   }
2324   if (PrintCompilation &amp;&amp; Verbose) {
2325     if (depth() == 1) {
2326       if( ilt-&gt;count_inlines() ) {
2327         tty-&gt;print(&quot;    __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2328                      ilt-&gt;count_inline_bcs());
2329         tty-&gt;cr();
2330       }
2331     } else {
2332       if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2333       if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2334       // Check this is not the final compiled version
2335       if (C-&gt;trap_can_recompile()) {
2336         tty-&gt;print(&quot;-&quot;);
2337       } else {
2338         tty-&gt;print(&quot; &quot;);
2339       }
2340       method()-&gt;print_short_name();
2341       if (is_osr_parse()) {
2342         tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2343       }
2344       tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2345       if (ilt-&gt;count_inlines()) {
2346         tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2347                    ilt-&gt;count_inline_bcs());
2348       }
2349       tty-&gt;cr();
2350     }
2351   }
2352   if (PrintOpto &amp;&amp; (depth() == 1 || PrintOptoInlining)) {
2353     // Print that we succeeded; suppress this message on the first osr parse.
2354 
2355     if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2356     if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2357     // Check this is not the final compiled version
2358     if (C-&gt;trap_can_recompile() &amp;&amp; depth() == 1) {
2359       tty-&gt;print(&quot;-&quot;);
2360     } else {
2361       tty-&gt;print(&quot; &quot;);
2362     }
2363     if( depth() != 1 ) { tty-&gt;print(&quot;   &quot;); }  // missing compile count
2364     for (int i = 1; i &lt; depth(); ++i) { tty-&gt;print(&quot;  &quot;); }
2365     method()-&gt;print_short_name();
2366     if (is_osr_parse()) {
2367       tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2368     }
2369     if (ilt-&gt;caller_bci() != -1) {
2370       tty-&gt;print(&quot; @ %d&quot;, ilt-&gt;caller_bci());
2371     }
2372     tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2373     if (ilt-&gt;count_inlines()) {
2374       tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2375                  ilt-&gt;count_inline_bcs());
2376     }
2377     tty-&gt;cr();
2378   }
2379 }
2380 
2381 
2382 //------------------------------dump-------------------------------------------
2383 // Dump information associated with the bytecodes of current _method
2384 void Parse::dump() {
2385   if( method() != NULL ) {
2386     // Iterate over bytecodes
2387     ciBytecodeStream iter(method());
2388     for( Bytecodes::Code bc = iter.next(); bc != ciBytecodeStream::EOBC() ; bc = iter.next() ) {
2389       dump_bci( iter.cur_bci() );
2390       tty-&gt;cr();
2391     }
2392   }
2393 }
2394 
2395 // Dump information associated with a byte code index, &#39;bci&#39;
2396 void Parse::dump_bci(int bci) {
2397   // Output info on merge-points, cloning, and within _jsr..._ret
2398   // NYI
2399   tty-&gt;print(&quot; bci:%d&quot;, bci);
2400 }
2401 
2402 #endif
    </pre>
  </body>
</html>