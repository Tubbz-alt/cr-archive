<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/compile.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;ci/ciReplay.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/exceptionHandlerTable.hpp&quot;
  31 #include &quot;code/nmethod.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/compileLog.hpp&quot;
  34 #include &quot;compiler/disassembler.hpp&quot;
  35 #include &quot;compiler/oopMap.hpp&quot;
  36 #include &quot;gc/shared/barrierSet.hpp&quot;
  37 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;opto/addnode.hpp&quot;
  40 #include &quot;opto/block.hpp&quot;
  41 #include &quot;opto/c2compiler.hpp&quot;
  42 #include &quot;opto/callGenerator.hpp&quot;
  43 #include &quot;opto/callnode.hpp&quot;
  44 #include &quot;opto/castnode.hpp&quot;
  45 #include &quot;opto/cfgnode.hpp&quot;
  46 #include &quot;opto/chaitin.hpp&quot;
  47 #include &quot;opto/compile.hpp&quot;
  48 #include &quot;opto/connode.hpp&quot;
  49 #include &quot;opto/convertnode.hpp&quot;
  50 #include &quot;opto/divnode.hpp&quot;
  51 #include &quot;opto/escape.hpp&quot;
  52 #include &quot;opto/idealGraphPrinter.hpp&quot;
  53 #include &quot;opto/loopnode.hpp&quot;
  54 #include &quot;opto/machnode.hpp&quot;
  55 #include &quot;opto/macro.hpp&quot;
  56 #include &quot;opto/matcher.hpp&quot;
  57 #include &quot;opto/mathexactnode.hpp&quot;
  58 #include &quot;opto/memnode.hpp&quot;
  59 #include &quot;opto/mulnode.hpp&quot;
  60 #include &quot;opto/narrowptrnode.hpp&quot;
  61 #include &quot;opto/node.hpp&quot;
  62 #include &quot;opto/opcodes.hpp&quot;
  63 #include &quot;opto/output.hpp&quot;
  64 #include &quot;opto/parse.hpp&quot;
  65 #include &quot;opto/phaseX.hpp&quot;
  66 #include &quot;opto/rootnode.hpp&quot;
  67 #include &quot;opto/runtime.hpp&quot;
  68 #include &quot;opto/stringopts.hpp&quot;
  69 #include &quot;opto/type.hpp&quot;
  70 #include &quot;opto/vectornode.hpp&quot;
  71 #include &quot;runtime/arguments.hpp&quot;
  72 #include &quot;runtime/sharedRuntime.hpp&quot;
  73 #include &quot;runtime/signature.hpp&quot;
  74 #include &quot;runtime/stubRoutines.hpp&quot;
  75 #include &quot;runtime/timer.hpp&quot;
  76 #include &quot;utilities/align.hpp&quot;
  77 #include &quot;utilities/copy.hpp&quot;
  78 #include &quot;utilities/macros.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed">  79 #if INCLUDE_ZGC</span>
<span class="line-removed">  80 #include &quot;gc/z/c2/zBarrierSetC2.hpp&quot;</span>
<span class="line-removed">  81 #endif</span>
  82 
  83 
  84 // -------------------- Compile::mach_constant_base_node -----------------------
  85 // Constant table base node singleton.
  86 MachConstantBaseNode* Compile::mach_constant_base_node() {
  87   if (_mach_constant_base_node == NULL) {
  88     _mach_constant_base_node = new MachConstantBaseNode();
  89     _mach_constant_base_node-&gt;add_req(C-&gt;root());
  90   }
  91   return _mach_constant_base_node;
  92 }
  93 
  94 
  95 /// Support for intrinsics.
  96 
  97 // Return the index at which m must be inserted (or already exists).
  98 // The sort order is by the address of the ciMethod, with is_virtual as minor key.
  99 class IntrinsicDescPair {
 100  private:
 101   ciMethod* _m;
 102   bool _is_virtual;
 103  public:
 104   IntrinsicDescPair(ciMethod* m, bool is_virtual) : _m(m), _is_virtual(is_virtual) {}
 105   static int compare(IntrinsicDescPair* const&amp; key, CallGenerator* const&amp; elt) {
 106     ciMethod* m= elt-&gt;method();
 107     ciMethod* key_m = key-&gt;_m;
 108     if (key_m &lt; m)      return -1;
 109     else if (key_m &gt; m) return 1;
 110     else {
 111       bool is_virtual = elt-&gt;is_virtual();
 112       bool key_virtual = key-&gt;_is_virtual;
 113       if (key_virtual &lt; is_virtual)      return -1;
 114       else if (key_virtual &gt; is_virtual) return 1;
 115       else                               return 0;
 116     }
 117   }
 118 };
 119 int Compile::intrinsic_insertion_index(ciMethod* m, bool is_virtual, bool&amp; found) {
 120 #ifdef ASSERT
 121   for (int i = 1; i &lt; _intrinsics-&gt;length(); i++) {
 122     CallGenerator* cg1 = _intrinsics-&gt;at(i-1);
 123     CallGenerator* cg2 = _intrinsics-&gt;at(i);
 124     assert(cg1-&gt;method() != cg2-&gt;method()
 125            ? cg1-&gt;method()     &lt; cg2-&gt;method()
 126            : cg1-&gt;is_virtual() &lt; cg2-&gt;is_virtual(),
 127            &quot;compiler intrinsics list must stay sorted&quot;);
 128   }
 129 #endif
 130   IntrinsicDescPair pair(m, is_virtual);
 131   return _intrinsics-&gt;find_sorted&lt;IntrinsicDescPair*, IntrinsicDescPair::compare&gt;(&amp;pair, found);
 132 }
 133 
 134 void Compile::register_intrinsic(CallGenerator* cg) {
 135   if (_intrinsics == NULL) {
 136     _intrinsics = new (comp_arena())GrowableArray&lt;CallGenerator*&gt;(comp_arena(), 60, 0, NULL);
 137   }
 138   int len = _intrinsics-&gt;length();
 139   bool found = false;
 140   int index = intrinsic_insertion_index(cg-&gt;method(), cg-&gt;is_virtual(), found);
 141   assert(!found, &quot;registering twice&quot;);
 142   _intrinsics-&gt;insert_before(index, cg);
 143   assert(find_intrinsic(cg-&gt;method(), cg-&gt;is_virtual()) == cg, &quot;registration worked&quot;);
 144 }
 145 
 146 CallGenerator* Compile::find_intrinsic(ciMethod* m, bool is_virtual) {
 147   assert(m-&gt;is_loaded(), &quot;don&#39;t try this on unloaded methods&quot;);
 148   if (_intrinsics != NULL) {
 149     bool found = false;
 150     int index = intrinsic_insertion_index(m, is_virtual, found);
 151      if (found) {
 152       return _intrinsics-&gt;at(index);
 153     }
 154   }
 155   // Lazily create intrinsics for intrinsic IDs well-known in the runtime.
 156   if (m-&gt;intrinsic_id() != vmIntrinsics::_none &amp;&amp;
 157       m-&gt;intrinsic_id() &lt;= vmIntrinsics::LAST_COMPILER_INLINE) {
 158     CallGenerator* cg = make_vm_intrinsic(m, is_virtual);
 159     if (cg != NULL) {
 160       // Save it for next time:
 161       register_intrinsic(cg);
 162       return cg;
 163     } else {
 164       gather_intrinsic_statistics(m-&gt;intrinsic_id(), is_virtual, _intrinsic_disabled);
 165     }
 166   }
 167   return NULL;
 168 }
 169 
 170 // Compile:: register_library_intrinsics and make_vm_intrinsic are defined
 171 // in library_call.cpp.
 172 
 173 
 174 #ifndef PRODUCT
 175 // statistics gathering...
 176 
 177 juint  Compile::_intrinsic_hist_count[vmIntrinsics::ID_LIMIT] = {0};
 178 jubyte Compile::_intrinsic_hist_flags[vmIntrinsics::ID_LIMIT] = {0};
 179 
 180 bool Compile::gather_intrinsic_statistics(vmIntrinsics::ID id, bool is_virtual, int flags) {
 181   assert(id &gt; vmIntrinsics::_none &amp;&amp; id &lt; vmIntrinsics::ID_LIMIT, &quot;oob&quot;);
 182   int oflags = _intrinsic_hist_flags[id];
 183   assert(flags != 0, &quot;what happened?&quot;);
 184   if (is_virtual) {
 185     flags |= _intrinsic_virtual;
 186   }
 187   bool changed = (flags != oflags);
 188   if ((flags &amp; _intrinsic_worked) != 0) {
 189     juint count = (_intrinsic_hist_count[id] += 1);
 190     if (count == 1) {
 191       changed = true;           // first time
 192     }
 193     // increment the overall count also:
 194     _intrinsic_hist_count[vmIntrinsics::_none] += 1;
 195   }
 196   if (changed) {
 197     if (((oflags ^ flags) &amp; _intrinsic_virtual) != 0) {
 198       // Something changed about the intrinsic&#39;s virtuality.
 199       if ((flags &amp; _intrinsic_virtual) != 0) {
 200         // This is the first use of this intrinsic as a virtual call.
 201         if (oflags != 0) {
 202           // We already saw it as a non-virtual, so note both cases.
 203           flags |= _intrinsic_both;
 204         }
 205       } else if ((oflags &amp; _intrinsic_both) == 0) {
 206         // This is the first use of this intrinsic as a non-virtual
 207         flags |= _intrinsic_both;
 208       }
 209     }
 210     _intrinsic_hist_flags[id] = (jubyte) (oflags | flags);
 211   }
 212   // update the overall flags also:
 213   _intrinsic_hist_flags[vmIntrinsics::_none] |= (jubyte) flags;
 214   return changed;
 215 }
 216 
 217 static char* format_flags(int flags, char* buf) {
 218   buf[0] = 0;
 219   if ((flags &amp; Compile::_intrinsic_worked) != 0)    strcat(buf, &quot;,worked&quot;);
 220   if ((flags &amp; Compile::_intrinsic_failed) != 0)    strcat(buf, &quot;,failed&quot;);
 221   if ((flags &amp; Compile::_intrinsic_disabled) != 0)  strcat(buf, &quot;,disabled&quot;);
 222   if ((flags &amp; Compile::_intrinsic_virtual) != 0)   strcat(buf, &quot;,virtual&quot;);
 223   if ((flags &amp; Compile::_intrinsic_both) != 0)      strcat(buf, &quot;,nonvirtual&quot;);
 224   if (buf[0] == 0)  strcat(buf, &quot;,&quot;);
 225   assert(buf[0] == &#39;,&#39;, &quot;must be&quot;);
 226   return &amp;buf[1];
 227 }
 228 
 229 void Compile::print_intrinsic_statistics() {
 230   char flagsbuf[100];
 231   ttyLocker ttyl;
 232   if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;intrinsic&#39;&quot;);
 233   tty-&gt;print_cr(&quot;Compiler intrinsic usage:&quot;);
 234   juint total = _intrinsic_hist_count[vmIntrinsics::_none];
 235   if (total == 0)  total = 1;  // avoid div0 in case of no successes
 236   #define PRINT_STAT_LINE(name, c, f) \
 237     tty-&gt;print_cr(&quot;  %4d (%4.1f%%) %s (%s)&quot;, (int)(c), ((c) * 100.0) / total, name, f);
 238   for (int index = 1 + (int)vmIntrinsics::_none; index &lt; (int)vmIntrinsics::ID_LIMIT; index++) {
 239     vmIntrinsics::ID id = (vmIntrinsics::ID) index;
 240     int   flags = _intrinsic_hist_flags[id];
 241     juint count = _intrinsic_hist_count[id];
 242     if ((flags | count) != 0) {
 243       PRINT_STAT_LINE(vmIntrinsics::name_at(id), count, format_flags(flags, flagsbuf));
 244     }
 245   }
 246   PRINT_STAT_LINE(&quot;total&quot;, total, format_flags(_intrinsic_hist_flags[vmIntrinsics::_none], flagsbuf));
 247   if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
 248 }
 249 
 250 void Compile::print_statistics() {
 251   { ttyLocker ttyl;
 252     if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;opto&#39;&quot;);
 253     Parse::print_statistics();
 254     PhaseCCP::print_statistics();
 255     PhaseRegAlloc::print_statistics();
 256     Scheduling::print_statistics();
 257     PhasePeephole::print_statistics();
 258     PhaseIdealLoop::print_statistics();
 259     if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
 260   }
 261   if (_intrinsic_hist_flags[vmIntrinsics::_none] != 0) {
 262     // put this under its own &lt;statistics&gt; element.
 263     print_intrinsic_statistics();
 264   }
 265 }
 266 #endif //PRODUCT
 267 
 268 // Support for bundling info
 269 Bundle* Compile::node_bundling(const Node *n) {
 270   assert(valid_bundle_info(n), &quot;oob&quot;);
 271   return &amp;_node_bundling_base[n-&gt;_idx];
 272 }
 273 
 274 bool Compile::valid_bundle_info(const Node *n) {
 275   return (_node_bundling_limit &gt; n-&gt;_idx);
 276 }
 277 
 278 
 279 void Compile::gvn_replace_by(Node* n, Node* nn) {
 280   for (DUIterator_Last imin, i = n-&gt;last_outs(imin); i &gt;= imin; ) {
 281     Node* use = n-&gt;last_out(i);
 282     bool is_in_table = initial_gvn()-&gt;hash_delete(use);
 283     uint uses_found = 0;
 284     for (uint j = 0; j &lt; use-&gt;len(); j++) {
 285       if (use-&gt;in(j) == n) {
 286         if (j &lt; use-&gt;req())
 287           use-&gt;set_req(j, nn);
 288         else
 289           use-&gt;set_prec(j, nn);
 290         uses_found++;
 291       }
 292     }
 293     if (is_in_table) {
 294       // reinsert into table
 295       initial_gvn()-&gt;hash_find_insert(use);
 296     }
 297     record_for_igvn(use);
 298     i -= uses_found;    // we deleted 1 or more copies of this edge
 299   }
 300 }
 301 
 302 
 303 static inline bool not_a_node(const Node* n) {
 304   if (n == NULL)                   return true;
 305   if (((intptr_t)n &amp; 1) != 0)      return true;  // uninitialized, etc.
 306   if (*(address*)n == badAddress)  return true;  // kill by Node::destruct
 307   return false;
 308 }
 309 
 310 // Identify all nodes that are reachable from below, useful.
 311 // Use breadth-first pass that records state in a Unique_Node_List,
 312 // recursive traversal is slower.
 313 void Compile::identify_useful_nodes(Unique_Node_List &amp;useful) {
 314   int estimated_worklist_size = live_nodes();
 315   useful.map( estimated_worklist_size, NULL );  // preallocate space
 316 
 317   // Initialize worklist
 318   if (root() != NULL)     { useful.push(root()); }
 319   // If &#39;top&#39; is cached, declare it useful to preserve cached node
 320   if( cached_top_node() ) { useful.push(cached_top_node()); }
 321 
 322   // Push all useful nodes onto the list, breadthfirst
 323   for( uint next = 0; next &lt; useful.size(); ++next ) {
 324     assert( next &lt; unique(), &quot;Unique useful nodes &lt; total nodes&quot;);
 325     Node *n  = useful.at(next);
 326     uint max = n-&gt;len();
 327     for( uint i = 0; i &lt; max; ++i ) {
 328       Node *m = n-&gt;in(i);
 329       if (not_a_node(m))  continue;
 330       useful.push(m);
 331     }
 332   }
 333 }
 334 
 335 // Update dead_node_list with any missing dead nodes using useful
 336 // list. Consider all non-useful nodes to be useless i.e., dead nodes.
 337 void Compile::update_dead_node_list(Unique_Node_List &amp;useful) {
 338   uint max_idx = unique();
 339   VectorSet&amp; useful_node_set = useful.member_set();
 340 
 341   for (uint node_idx = 0; node_idx &lt; max_idx; node_idx++) {
 342     // If node with index node_idx is not in useful set,
 343     // mark it as dead in dead node list.
<a name="3" id="anc3"></a><span class="line-modified"> 344     if (! useful_node_set.test(node_idx) ) {</span>
 345       record_dead_node(node_idx);
 346     }
 347   }
 348 }
 349 
 350 void Compile::remove_useless_late_inlines(GrowableArray&lt;CallGenerator*&gt;* inlines, Unique_Node_List &amp;useful) {
 351   int shift = 0;
 352   for (int i = 0; i &lt; inlines-&gt;length(); i++) {
 353     CallGenerator* cg = inlines-&gt;at(i);
 354     CallNode* call = cg-&gt;call_node();
 355     if (shift &gt; 0) {
 356       inlines-&gt;at_put(i-shift, cg);
 357     }
 358     if (!useful.member(call)) {
 359       shift++;
 360     }
 361   }
 362   inlines-&gt;trunc_to(inlines-&gt;length()-shift);
 363 }
 364 
 365 // Disconnect all useless nodes by disconnecting those at the boundary.
 366 void Compile::remove_useless_nodes(Unique_Node_List &amp;useful) {
 367   uint next = 0;
 368   while (next &lt; useful.size()) {
 369     Node *n = useful.at(next++);
 370     if (n-&gt;is_SafePoint()) {
 371       // We&#39;re done with a parsing phase. Replaced nodes are not valid
 372       // beyond that point.
 373       n-&gt;as_SafePoint()-&gt;delete_replaced_nodes();
 374     }
 375     // Use raw traversal of out edges since this code removes out edges
 376     int max = n-&gt;outcnt();
 377     for (int j = 0; j &lt; max; ++j) {
 378       Node* child = n-&gt;raw_out(j);
 379       if (! useful.member(child)) {
 380         assert(!child-&gt;is_top() || child != top(),
 381                &quot;If top is cached in Compile object it is in useful list&quot;);
 382         // Only need to remove this out-edge to the useless node
 383         n-&gt;raw_del_out(j);
 384         --j;
 385         --max;
 386       }
 387     }
 388     if (n-&gt;outcnt() == 1 &amp;&amp; n-&gt;has_special_unique_user()) {
 389       record_for_igvn(n-&gt;unique_out());
 390     }
 391   }
 392   // Remove useless macro and predicate opaq nodes
 393   for (int i = C-&gt;macro_count()-1; i &gt;= 0; i--) {
 394     Node* n = C-&gt;macro_node(i);
 395     if (!useful.member(n)) {
 396       remove_macro_node(n);
 397     }
 398   }
 399   // Remove useless CastII nodes with range check dependency
 400   for (int i = range_check_cast_count() - 1; i &gt;= 0; i--) {
 401     Node* cast = range_check_cast_node(i);
 402     if (!useful.member(cast)) {
 403       remove_range_check_cast(cast);
 404     }
 405   }
 406   // Remove useless expensive nodes
 407   for (int i = C-&gt;expensive_count()-1; i &gt;= 0; i--) {
 408     Node* n = C-&gt;expensive_node(i);
 409     if (!useful.member(n)) {
 410       remove_expensive_node(n);
 411     }
 412   }
 413   // Remove useless Opaque4 nodes
 414   for (int i = opaque4_count() - 1; i &gt;= 0; i--) {
 415     Node* opaq = opaque4_node(i);
 416     if (!useful.member(opaq)) {
 417       remove_opaque4_node(opaq);
 418     }
 419   }
 420   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 421   bs-&gt;eliminate_useless_gc_barriers(useful, this);
 422   // clean up the late inline lists
 423   remove_useless_late_inlines(&amp;_string_late_inlines, useful);
 424   remove_useless_late_inlines(&amp;_boxing_late_inlines, useful);
 425   remove_useless_late_inlines(&amp;_late_inlines, useful);
 426   debug_only(verify_graph_edges(true/*check for no_dead_code*/);)
 427 }
 428 
 429 //------------------------------frame_size_in_words-----------------------------
 430 // frame_slots in units of words
 431 int Compile::frame_size_in_words() const {
 432   // shift is 0 in LP32 and 1 in LP64
 433   const int shift = (LogBytesPerWord - LogBytesPerInt);
 434   int words = _frame_slots &gt;&gt; shift;
 435   assert( words &lt;&lt; shift == _frame_slots, &quot;frame size must be properly aligned in LP64&quot; );
 436   return words;
 437 }
 438 
 439 // To bang the stack of this compiled method we use the stack size
 440 // that the interpreter would need in case of a deoptimization. This
 441 // removes the need to bang the stack in the deoptimization blob which
 442 // in turn simplifies stack overflow handling.
 443 int Compile::bang_size_in_bytes() const {
 444   return MAX2(frame_size_in_bytes() + os::extra_bang_size_in_bytes(), _interpreter_frame_size);
 445 }
 446 
 447 // ============================================================================
 448 //------------------------------CompileWrapper---------------------------------
 449 class CompileWrapper : public StackObj {
 450   Compile *const _compile;
 451  public:
 452   CompileWrapper(Compile* compile);
 453 
 454   ~CompileWrapper();
 455 };
 456 
 457 CompileWrapper::CompileWrapper(Compile* compile) : _compile(compile) {
 458   // the Compile* pointer is stored in the current ciEnv:
 459   ciEnv* env = compile-&gt;env();
 460   assert(env == ciEnv::current(), &quot;must already be a ciEnv active&quot;);
 461   assert(env-&gt;compiler_data() == NULL, &quot;compile already active?&quot;);
 462   env-&gt;set_compiler_data(compile);
 463   assert(compile == Compile::current(), &quot;sanity&quot;);
 464 
 465   compile-&gt;set_type_dict(NULL);
 466   compile-&gt;set_clone_map(new Dict(cmpkey, hashkey, _compile-&gt;comp_arena()));
 467   compile-&gt;clone_map().set_clone_idx(0);
<a name="4" id="anc4"></a><span class="line-removed"> 468   compile-&gt;set_type_hwm(NULL);</span>
 469   compile-&gt;set_type_last_size(0);
 470   compile-&gt;set_last_tf(NULL, NULL);
 471   compile-&gt;set_indexSet_arena(NULL);
 472   compile-&gt;set_indexSet_free_block_list(NULL);
 473   compile-&gt;init_type_arena();
 474   Type::Initialize(compile);
 475   _compile-&gt;set_scratch_buffer_blob(NULL);
 476   _compile-&gt;begin_method();
 477   _compile-&gt;clone_map().set_debug(_compile-&gt;has_method() &amp;&amp; _compile-&gt;directive()-&gt;CloneMapDebugOption);
 478 }
 479 CompileWrapper::~CompileWrapper() {
 480   _compile-&gt;end_method();
 481   if (_compile-&gt;scratch_buffer_blob() != NULL)
 482     BufferBlob::free(_compile-&gt;scratch_buffer_blob());
 483   _compile-&gt;env()-&gt;set_compiler_data(NULL);
 484 }
 485 
 486 
 487 //----------------------------print_compile_messages---------------------------
 488 void Compile::print_compile_messages() {
 489 #ifndef PRODUCT
 490   // Check if recompiling
 491   if (_subsume_loads == false &amp;&amp; PrintOpto) {
 492     // Recompiling without allowing machine instructions to subsume loads
 493     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 494     tty-&gt;print_cr(&quot;** Bailout: Recompile without subsuming loads          **&quot;);
 495     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 496   }
 497   if (_do_escape_analysis != DoEscapeAnalysis &amp;&amp; PrintOpto) {
 498     // Recompiling without escape analysis
 499     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 500     tty-&gt;print_cr(&quot;** Bailout: Recompile without escape analysis          **&quot;);
 501     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 502   }
 503   if (_eliminate_boxing != EliminateAutoBox &amp;&amp; PrintOpto) {
 504     // Recompiling without boxing elimination
 505     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 506     tty-&gt;print_cr(&quot;** Bailout: Recompile without boxing elimination       **&quot;);
 507     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 508   }
 509   if (C-&gt;directive()-&gt;BreakAtCompileOption) {
 510     // Open the debugger when compiling this method.
 511     tty-&gt;print(&quot;### Breaking when compiling: &quot;);
 512     method()-&gt;print_short_name();
 513     tty-&gt;cr();
 514     BREAKPOINT;
 515   }
 516 
 517   if( PrintOpto ) {
 518     if (is_osr_compilation()) {
 519       tty-&gt;print(&quot;[OSR]%3d&quot;, _compile_id);
 520     } else {
 521       tty-&gt;print(&quot;%3d&quot;, _compile_id);
 522     }
 523   }
 524 #endif
 525 }
 526 
 527 
 528 //-----------------------init_scratch_buffer_blob------------------------------
 529 // Construct a temporary BufferBlob and cache it for this compile.
 530 void Compile::init_scratch_buffer_blob(int const_size) {
 531   // If there is already a scratch buffer blob allocated and the
 532   // constant section is big enough, use it.  Otherwise free the
 533   // current and allocate a new one.
 534   BufferBlob* blob = scratch_buffer_blob();
 535   if ((blob != NULL) &amp;&amp; (const_size &lt;= _scratch_const_size)) {
 536     // Use the current blob.
 537   } else {
 538     if (blob != NULL) {
 539       BufferBlob::free(blob);
 540     }
 541 
 542     ResourceMark rm;
 543     _scratch_const_size = const_size;
 544     int size = C2Compiler::initial_code_buffer_size(const_size);
 545     blob = BufferBlob::create(&quot;Compile::scratch_buffer&quot;, size);
 546     // Record the buffer blob for next time.
 547     set_scratch_buffer_blob(blob);
 548     // Have we run out of code space?
 549     if (scratch_buffer_blob() == NULL) {
 550       // Let CompilerBroker disable further compilations.
 551       record_failure(&quot;Not enough space for scratch buffer in CodeCache&quot;);
 552       return;
 553     }
 554   }
 555 
 556   // Initialize the relocation buffers
 557   relocInfo* locs_buf = (relocInfo*) blob-&gt;content_end() - MAX_locs_size;
 558   set_scratch_locs_memory(locs_buf);
 559 }
 560 
 561 
 562 //-----------------------scratch_emit_size-------------------------------------
 563 // Helper function that computes size by emitting code
 564 uint Compile::scratch_emit_size(const Node* n) {
 565   // Start scratch_emit_size section.
 566   set_in_scratch_emit_size(true);
 567 
 568   // Emit into a trash buffer and count bytes emitted.
 569   // This is a pretty expensive way to compute a size,
 570   // but it works well enough if seldom used.
 571   // All common fixed-size instructions are given a size
 572   // method by the AD file.
 573   // Note that the scratch buffer blob and locs memory are
 574   // allocated at the beginning of the compile task, and
 575   // may be shared by several calls to scratch_emit_size.
 576   // The allocation of the scratch buffer blob is particularly
 577   // expensive, since it has to grab the code cache lock.
 578   BufferBlob* blob = this-&gt;scratch_buffer_blob();
 579   assert(blob != NULL, &quot;Initialize BufferBlob at start&quot;);
 580   assert(blob-&gt;size() &gt; MAX_inst_size, &quot;sanity&quot;);
 581   relocInfo* locs_buf = scratch_locs_memory();
 582   address blob_begin = blob-&gt;content_begin();
 583   address blob_end   = (address)locs_buf;
 584   assert(blob-&gt;contains(blob_end), &quot;sanity&quot;);
 585   CodeBuffer buf(blob_begin, blob_end - blob_begin);
 586   buf.initialize_consts_size(_scratch_const_size);
 587   buf.initialize_stubs_size(MAX_stubs_size);
 588   assert(locs_buf != NULL, &quot;sanity&quot;);
 589   int lsize = MAX_locs_size / 3;
 590   buf.consts()-&gt;initialize_shared_locs(&amp;locs_buf[lsize * 0], lsize);
 591   buf.insts()-&gt;initialize_shared_locs( &amp;locs_buf[lsize * 1], lsize);
 592   buf.stubs()-&gt;initialize_shared_locs( &amp;locs_buf[lsize * 2], lsize);
 593   // Mark as scratch buffer.
 594   buf.consts()-&gt;set_scratch_emit();
 595   buf.insts()-&gt;set_scratch_emit();
 596   buf.stubs()-&gt;set_scratch_emit();
 597 
 598   // Do the emission.
 599 
 600   Label fakeL; // Fake label for branch instructions.
 601   Label*   saveL = NULL;
 602   uint save_bnum = 0;
 603   bool is_branch = n-&gt;is_MachBranch();
 604   if (is_branch) {
 605     MacroAssembler masm(&amp;buf);
 606     masm.bind(fakeL);
 607     n-&gt;as_MachBranch()-&gt;save_label(&amp;saveL, &amp;save_bnum);
 608     n-&gt;as_MachBranch()-&gt;label_set(&amp;fakeL, 0);
 609   }
 610   n-&gt;emit(buf, this-&gt;regalloc());
 611 
 612   // Emitting into the scratch buffer should not fail
 613   assert (!failing(), &quot;Must not have pending failure. Reason is: %s&quot;, failure_reason());
 614 
 615   if (is_branch) // Restore label.
 616     n-&gt;as_MachBranch()-&gt;label_set(saveL, save_bnum);
 617 
 618   // End scratch_emit_size section.
 619   set_in_scratch_emit_size(false);
 620 
 621   return buf.insts_size();
 622 }
 623 
 624 
 625 // ============================================================================
 626 //------------------------------Compile standard-------------------------------
 627 debug_only( int Compile::_debug_idx = 100000; )
 628 
 629 // Compile a method.  entry_bci is -1 for normal compilations and indicates
 630 // the continuation bci for on stack replacement.
 631 
 632 
 633 Compile::Compile( ciEnv* ci_env, C2Compiler* compiler, ciMethod* target, int osr_bci,
 634                   bool subsume_loads, bool do_escape_analysis, bool eliminate_boxing, DirectiveSet* directive)
 635                 : Phase(Compiler),
 636                   _compile_id(ci_env-&gt;compile_id()),
 637                   _save_argument_registers(false),
 638                   _subsume_loads(subsume_loads),
 639                   _do_escape_analysis(do_escape_analysis),
 640                   _eliminate_boxing(eliminate_boxing),
 641                   _method(target),
 642                   _entry_bci(osr_bci),
 643                   _stub_function(NULL),
 644                   _stub_name(NULL),
 645                   _stub_entry_point(NULL),
 646                   _max_node_limit(MaxNodeLimit),
 647                   _orig_pc_slot(0),
 648                   _orig_pc_slot_offset_in_bytes(0),
 649                   _inlining_progress(false),
 650                   _inlining_incrementally(false),
 651                   _do_cleanup(false),
 652                   _has_reserved_stack_access(target-&gt;has_reserved_stack_access()),
 653 #ifndef PRODUCT
 654                   _trace_opto_output(directive-&gt;TraceOptoOutputOption),
<a name="5" id="anc5"></a>
 655 #endif
 656                   _has_method_handle_invokes(false),
<a name="6" id="anc6"></a>
 657                   _comp_arena(mtCompiler),
 658                   _barrier_set_state(BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;create_barrier_state(comp_arena())),
 659                   _env(ci_env),
 660                   _directive(directive),
 661                   _log(ci_env-&gt;log()),
 662                   _failure_reason(NULL),
 663                   _congraph(NULL),
 664 #ifndef PRODUCT
 665                   _printer(IdealGraphPrinter::printer()),
 666 #endif
 667                   _dead_node_list(comp_arena()),
 668                   _dead_node_count(0),
 669                   _node_arena(mtCompiler),
 670                   _old_arena(mtCompiler),
 671                   _mach_constant_base_node(NULL),
 672                   _Compile_types(mtCompiler),
 673                   _initial_gvn(NULL),
 674                   _for_igvn(NULL),
 675                   _warm_calls(NULL),
 676                   _late_inlines(comp_arena(), 2, 0, NULL),
 677                   _string_late_inlines(comp_arena(), 2, 0, NULL),
 678                   _boxing_late_inlines(comp_arena(), 2, 0, NULL),
 679                   _late_inlines_pos(0),
 680                   _number_of_mh_late_inlines(0),
 681                   _print_inlining_stream(NULL),
 682                   _print_inlining_list(NULL),
 683                   _print_inlining_idx(0),
 684                   _print_inlining_output(NULL),
 685                   _replay_inline_data(NULL),
 686                   _java_calls(0),
 687                   _inner_loops(0),
 688                   _interpreter_frame_size(0),
 689                   _node_bundling_limit(0),
 690                   _node_bundling_base(NULL),
 691                   _code_buffer(&quot;Compile::Fill_buffer&quot;),
 692                   _scratch_const_size(-1),
 693                   _in_scratch_emit_size(false)
 694 #ifndef PRODUCT
 695                   , _in_dump_cnt(0)
 696 #endif
 697 {
 698   C = this;
 699 #ifndef PRODUCT
 700   if (_printer != NULL) {
 701     _printer-&gt;set_compile(this);
 702   }
 703 #endif
 704   CompileWrapper cw(this);
 705 
 706   if (CITimeVerbose) {
 707     tty-&gt;print(&quot; &quot;);
 708     target-&gt;holder()-&gt;name()-&gt;print();
 709     tty-&gt;print(&quot;.&quot;);
 710     target-&gt;print_short_name();
 711     tty-&gt;print(&quot;  &quot;);
 712   }
 713   TraceTime t1(&quot;Total compilation time&quot;, &amp;_t_totalCompilation, CITime, CITimeVerbose);
 714   TraceTime t2(NULL, &amp;_t_methodCompilation, CITime, false);
 715 
<a name="7" id="anc7"></a><span class="line-modified"> 716 #ifndef PRODUCT</span>
 717   bool print_opto_assembly = directive-&gt;PrintOptoAssemblyOption;
<a name="8" id="anc8"></a><span class="line-modified"> 718   if (!print_opto_assembly) {</span>
<span class="line-modified"> 719     bool print_assembly = directive-&gt;PrintAssemblyOption;</span>
<span class="line-modified"> 720     if (print_assembly &amp;&amp; !Disassembler::can_decode()) {</span>
<span class="line-modified"> 721       tty-&gt;print_cr(&quot;PrintAssembly request changed to PrintOptoAssembly&quot;);</span>
<span class="line-modified"> 722       print_opto_assembly = true;</span>
<span class="line-modified"> 723     }</span>
<span class="line-modified"> 724   }</span>
<span class="line-modified"> 725   set_print_assembly(print_opto_assembly);</span>



 726   set_parsed_irreducible_loop(false);
 727 
 728   if (directive-&gt;ReplayInlineOption) {
 729     _replay_inline_data = ciReplay::load_inline_data(method(), entry_bci(), ci_env-&gt;comp_level());
 730   }
 731 #endif
 732   set_print_inlining(directive-&gt;PrintInliningOption || PrintOptoInlining);
 733   set_print_intrinsics(directive-&gt;PrintIntrinsicsOption);
 734   set_has_irreducible_loop(true); // conservative until build_loop_tree() reset it
 735 
 736   if (ProfileTraps RTM_OPT_ONLY( || UseRTMLocking )) {
 737     // Make sure the method being compiled gets its own MDO,
 738     // so we can at least track the decompile_count().
 739     // Need MDO to record RTM code generation state.
 740     method()-&gt;ensure_method_data();
 741   }
 742 
 743   Init(::AliasLevel);
 744 
 745 
 746   print_compile_messages();
 747 
 748   _ilt = InlineTree::build_inline_tree_root();
 749 
 750   // Even if NO memory addresses are used, MergeMem nodes must have at least 1 slice
 751   assert(num_alias_types() &gt;= AliasIdxRaw, &quot;&quot;);
 752 
 753 #define MINIMUM_NODE_HASH  1023
 754   // Node list that Iterative GVN will start with
 755   Unique_Node_List for_igvn(comp_arena());
 756   set_for_igvn(&amp;for_igvn);
 757 
 758   // GVN that will be run immediately on new nodes
 759   uint estimated_size = method()-&gt;code_size()*4+64;
 760   estimated_size = (estimated_size &lt; MINIMUM_NODE_HASH ? MINIMUM_NODE_HASH : estimated_size);
 761   PhaseGVN gvn(node_arena(), estimated_size);
 762   set_initial_gvn(&amp;gvn);
 763 
 764   print_inlining_init();
 765   { // Scope for timing the parser
 766     TracePhase tp(&quot;parse&quot;, &amp;timers[_t_parser]);
 767 
 768     // Put top into the hash table ASAP.
 769     initial_gvn()-&gt;transform_no_reclaim(top());
 770 
 771     // Set up tf(), start(), and find a CallGenerator.
 772     CallGenerator* cg = NULL;
 773     if (is_osr_compilation()) {
 774       const TypeTuple *domain = StartOSRNode::osr_domain();
 775       const TypeTuple *range = TypeTuple::make_range(method()-&gt;signature());
 776       init_tf(TypeFunc::make(domain, range));
 777       StartNode* s = new StartOSRNode(root(), domain);
 778       initial_gvn()-&gt;set_type_bottom(s);
 779       init_start(s);
 780       cg = CallGenerator::for_osr(method(), entry_bci());
 781     } else {
 782       // Normal case.
 783       init_tf(TypeFunc::make(method()));
 784       StartNode* s = new StartNode(root(), tf()-&gt;domain());
 785       initial_gvn()-&gt;set_type_bottom(s);
 786       init_start(s);
 787       if (method()-&gt;intrinsic_id() == vmIntrinsics::_Reference_get) {
 788         // With java.lang.ref.reference.get() we must go through the
 789         // intrinsic - even when get() is the root
 790         // method of the compile - so that, if necessary, the value in
 791         // the referent field of the reference object gets recorded by
 792         // the pre-barrier code.
 793         cg = find_intrinsic(method(), false);
 794       }
 795       if (cg == NULL) {
 796         float past_uses = method()-&gt;interpreter_invocation_count();
 797         float expected_uses = past_uses;
 798         cg = CallGenerator::for_inline(method(), expected_uses);
 799       }
 800     }
 801     if (failing())  return;
 802     if (cg == NULL) {
 803       record_method_not_compilable(&quot;cannot parse method&quot;);
 804       return;
 805     }
 806     JVMState* jvms = build_start_state(start(), tf());
 807     if ((jvms = cg-&gt;generate(jvms)) == NULL) {
 808       if (!failure_reason_is(C2Compiler::retry_class_loading_during_parsing())) {
 809         record_method_not_compilable(&quot;method parse failed&quot;);
 810       }
 811       return;
 812     }
 813     GraphKit kit(jvms);
 814 
 815     if (!kit.stopped()) {
 816       // Accept return values, and transfer control we know not where.
 817       // This is done by a special, unique ReturnNode bound to root.
 818       return_values(kit.jvms());
 819     }
 820 
 821     if (kit.has_exceptions()) {
 822       // Any exceptions that escape from this call must be rethrown
 823       // to whatever caller is dynamically above us on the stack.
 824       // This is done by a special, unique RethrowNode bound to root.
 825       rethrow_exceptions(kit.transfer_exceptions_into_jvms());
 826     }
 827 
 828     assert(IncrementalInline || (_late_inlines.length() == 0 &amp;&amp; !has_mh_late_inlines()), &quot;incremental inlining is off&quot;);
 829 
 830     if (_late_inlines.length() == 0 &amp;&amp; !has_mh_late_inlines() &amp;&amp; !failing() &amp;&amp; has_stringbuilder()) {
 831       inline_string_calls(true);
 832     }
 833 
 834     if (failing())  return;
 835 
 836     print_method(PHASE_BEFORE_REMOVEUSELESS, 3);
 837 
 838     // Remove clutter produced by parsing.
 839     if (!failing()) {
 840       ResourceMark rm;
 841       PhaseRemoveUseless pru(initial_gvn(), &amp;for_igvn);
 842     }
 843   }
 844 
 845   // Note:  Large methods are capped off in do_one_bytecode().
 846   if (failing())  return;
 847 
 848   // After parsing, node notes are no longer automagic.
 849   // They must be propagated by register_new_node_with_optimizer(),
 850   // clone(), or the like.
 851   set_default_node_notes(NULL);
 852 
 853   for (;;) {
 854     int successes = Inline_Warm();
 855     if (failing())  return;
 856     if (successes == 0)  break;
 857   }
 858 
 859   // Drain the list.
 860   Finish_Warm();
 861 #ifndef PRODUCT
 862   if (_printer &amp;&amp; _printer-&gt;should_print(1)) {
 863     _printer-&gt;print_inlining();
 864   }
 865 #endif
 866 
 867   if (failing())  return;
 868   NOT_PRODUCT( verify_graph_edges(); )
 869 
 870   // Now optimize
 871   Optimize();
 872   if (failing())  return;
 873   NOT_PRODUCT( verify_graph_edges(); )
 874 
 875 #ifndef PRODUCT
<a name="9" id="anc9"></a><span class="line-modified"> 876   if (PrintIdeal) {</span>
 877     ttyLocker ttyl;  // keep the following output all in one block
 878     // This output goes directly to the tty, not the compiler log.
 879     // To enable tools to match it up with the compilation activity,
 880     // be sure to tag this tty output with the compile ID.
 881     if (xtty != NULL) {
 882       xtty-&gt;head(&quot;ideal compile_id=&#39;%d&#39;%s&quot;, compile_id(),
 883                  is_osr_compilation()    ? &quot; compile_kind=&#39;osr&#39;&quot; :
 884                  &quot;&quot;);
 885     }
 886     root()-&gt;dump(9999);
 887     if (xtty != NULL) {
 888       xtty-&gt;tail(&quot;ideal&quot;);
 889     }
 890   }
 891 #endif
 892 
 893 #ifdef ASSERT
 894   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 895   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeCodeGen);
 896 #endif
 897 
 898   // Dump compilation data to replay it.
 899   if (directive-&gt;DumpReplayOption) {
 900     env()-&gt;dump_replay_data(_compile_id);
 901   }
 902   if (directive-&gt;DumpInlineOption &amp;&amp; (ilt() != NULL)) {
 903     env()-&gt;dump_inline_data(_compile_id);
 904   }
 905 
 906   // Now that we know the size of all the monitors we can add a fixed slot
 907   // for the original deopt pc.
 908 
 909   _orig_pc_slot =  fixed_slots();
 910   int next_slot = _orig_pc_slot + (sizeof(address) / VMRegImpl::stack_slot_size);
 911   set_fixed_slots(next_slot);
 912 
 913   // Compute when to use implicit null checks. Used by matching trap based
 914   // nodes and NullCheck optimization.
 915   set_allowed_deopt_reasons();
 916 
 917   // Now generate code
 918   Code_Gen();
 919   if (failing())  return;
 920 
 921   // Check if we want to skip execution of all compiled code.
 922   {
 923 #ifndef PRODUCT
 924     if (OptoNoExecute) {
 925       record_method_not_compilable(&quot;+OptoNoExecute&quot;);  // Flag as failed
 926       return;
 927     }
 928 #endif
 929     TracePhase tp(&quot;install_code&quot;, &amp;timers[_t_registerMethod]);
 930 
 931     if (is_osr_compilation()) {
 932       _code_offsets.set_value(CodeOffsets::Verified_Entry, 0);
 933       _code_offsets.set_value(CodeOffsets::OSR_Entry, _first_block_size);
 934     } else {
 935       _code_offsets.set_value(CodeOffsets::Verified_Entry, _first_block_size);
 936       _code_offsets.set_value(CodeOffsets::OSR_Entry, 0);
 937     }
 938 
 939     env()-&gt;register_method(_method, _entry_bci,
 940                            &amp;_code_offsets,
 941                            _orig_pc_slot_offset_in_bytes,
 942                            code_buffer(),
 943                            frame_size_in_words(), _oop_map_set,
 944                            &amp;_handler_table, &amp;_inc_table,
 945                            compiler,
 946                            has_unsafe_access(),
 947                            SharedRuntime::is_wide_vector(max_vector_size()),
 948                            rtm_state()
 949                            );
 950 
 951     if (log() != NULL) // Print code cache state into compiler log
 952       log()-&gt;code_cache_state();
 953   }
 954 }
 955 
 956 //------------------------------Compile----------------------------------------
 957 // Compile a runtime stub
 958 Compile::Compile( ciEnv* ci_env,
 959                   TypeFunc_generator generator,
 960                   address stub_function,
 961                   const char *stub_name,
 962                   int is_fancy_jump,
 963                   bool pass_tls,
 964                   bool save_arg_registers,
 965                   bool return_pc,
 966                   DirectiveSet* directive)
 967   : Phase(Compiler),
 968     _compile_id(0),
 969     _save_argument_registers(save_arg_registers),
 970     _subsume_loads(true),
 971     _do_escape_analysis(false),
 972     _eliminate_boxing(false),
 973     _method(NULL),
 974     _entry_bci(InvocationEntryBci),
 975     _stub_function(stub_function),
 976     _stub_name(stub_name),
 977     _stub_entry_point(NULL),
 978     _max_node_limit(MaxNodeLimit),
 979     _orig_pc_slot(0),
 980     _orig_pc_slot_offset_in_bytes(0),
 981     _inlining_progress(false),
 982     _inlining_incrementally(false),
 983     _has_reserved_stack_access(false),
 984 #ifndef PRODUCT
 985     _trace_opto_output(directive-&gt;TraceOptoOutputOption),
<a name="10" id="anc10"></a>
 986 #endif
 987     _has_method_handle_invokes(false),
<a name="11" id="anc11"></a>
 988     _comp_arena(mtCompiler),
<a name="12" id="anc12"></a>
 989     _env(ci_env),
 990     _directive(directive),
 991     _log(ci_env-&gt;log()),
 992     _failure_reason(NULL),
 993     _congraph(NULL),
 994 #ifndef PRODUCT
 995     _printer(NULL),
 996 #endif
 997     _dead_node_list(comp_arena()),
 998     _dead_node_count(0),
 999     _node_arena(mtCompiler),
1000     _old_arena(mtCompiler),
1001     _mach_constant_base_node(NULL),
1002     _Compile_types(mtCompiler),
1003     _initial_gvn(NULL),
1004     _for_igvn(NULL),
1005     _warm_calls(NULL),
1006     _number_of_mh_late_inlines(0),
1007     _print_inlining_stream(NULL),
1008     _print_inlining_list(NULL),
1009     _print_inlining_idx(0),
1010     _print_inlining_output(NULL),
1011     _replay_inline_data(NULL),
1012     _java_calls(0),
1013     _inner_loops(0),
1014     _interpreter_frame_size(0),
1015     _node_bundling_limit(0),
1016     _node_bundling_base(NULL),
1017     _code_buffer(&quot;Compile::Fill_buffer&quot;),
1018 #ifndef PRODUCT
1019     _in_dump_cnt(0),
1020 #endif
1021     _allowed_reasons(0) {
1022   C = this;
1023 
1024   TraceTime t1(NULL, &amp;_t_totalCompilation, CITime, false);
1025   TraceTime t2(NULL, &amp;_t_stubCompilation, CITime, false);
1026 
1027 #ifndef PRODUCT
1028   set_print_assembly(PrintFrameConverterAssembly);
1029   set_parsed_irreducible_loop(false);
<a name="13" id="anc13"></a>

1030 #endif
1031   set_has_irreducible_loop(false); // no loops
1032 
1033   CompileWrapper cw(this);
1034   Init(/*AliasLevel=*/ 0);
1035   init_tf((*generator)());
1036 
1037   {
1038     // The following is a dummy for the sake of GraphKit::gen_stub
1039     Unique_Node_List for_igvn(comp_arena());
1040     set_for_igvn(&amp;for_igvn);  // not used, but some GraphKit guys push on this
1041     PhaseGVN gvn(Thread::current()-&gt;resource_area(),255);
1042     set_initial_gvn(&amp;gvn);    // not significant, but GraphKit guys use it pervasively
1043     gvn.transform_no_reclaim(top());
1044 
1045     GraphKit kit;
1046     kit.gen_stub(stub_function, stub_name, is_fancy_jump, pass_tls, return_pc);
1047   }
1048 
1049   NOT_PRODUCT( verify_graph_edges(); )
1050   Code_Gen();
1051   if (failing())  return;
1052 
1053 
1054   // Entry point will be accessed using compile-&gt;stub_entry_point();
1055   if (code_buffer() == NULL) {
1056     Matcher::soft_match_failure();
1057   } else {
1058     if (PrintAssembly &amp;&amp; (WizardMode || Verbose))
1059       tty-&gt;print_cr(&quot;### Stub::%s&quot;, stub_name);
1060 
1061     if (!failing()) {
1062       assert(_fixed_slots == 0, &quot;no fixed slots used for runtime stubs&quot;);
1063 
1064       // Make the NMethod
1065       // For now we mark the frame as never safe for profile stackwalking
1066       RuntimeStub *rs = RuntimeStub::new_runtime_stub(stub_name,
1067                                                       code_buffer(),
1068                                                       CodeOffsets::frame_never_safe,
1069                                                       // _code_offsets.value(CodeOffsets::Frame_Complete),
1070                                                       frame_size_in_words(),
1071                                                       _oop_map_set,
1072                                                       save_arg_registers);
1073       assert(rs != NULL &amp;&amp; rs-&gt;is_runtime_stub(), &quot;sanity check&quot;);
1074 
1075       _stub_entry_point = rs-&gt;entry_point();
1076     }
1077   }
1078 }
1079 
1080 //------------------------------Init-------------------------------------------
1081 // Prepare for a single compilation
1082 void Compile::Init(int aliaslevel) {
1083   _unique  = 0;
1084   _regalloc = NULL;
1085 
1086   _tf      = NULL;  // filled in later
1087   _top     = NULL;  // cached later
1088   _matcher = NULL;  // filled in later
1089   _cfg     = NULL;  // filled in later
1090 
<a name="14" id="anc14"></a><span class="line-modified">1091   set_24_bit_selection_and_mode(Use24BitFP, false);</span>
1092 
1093   _node_note_array = NULL;
1094   _default_node_notes = NULL;
1095   DEBUG_ONLY( _modified_nodes = NULL; ) // Used in Optimize()
1096 
1097   _immutable_memory = NULL; // filled in at first inquiry
1098 
1099   // Globally visible Nodes
1100   // First set TOP to NULL to give safe behavior during creation of RootNode
1101   set_cached_top_node(NULL);
1102   set_root(new RootNode());
1103   // Now that you have a Root to point to, create the real TOP
1104   set_cached_top_node( new ConNode(Type::TOP) );
1105   set_recent_alloc(NULL, NULL);
1106 
1107   // Create Debug Information Recorder to record scopes, oopmaps, etc.
1108   env()-&gt;set_oop_recorder(new OopRecorder(env()-&gt;arena()));
1109   env()-&gt;set_debug_info(new DebugInformationRecorder(env()-&gt;oop_recorder()));
1110   env()-&gt;set_dependencies(new Dependencies(env()));
1111 
1112   _fixed_slots = 0;
1113   set_has_split_ifs(false);
1114   set_has_loops(has_method() &amp;&amp; method()-&gt;has_loops()); // first approximation
1115   set_has_stringbuilder(false);
1116   set_has_boxed_value(false);
1117   _trap_can_recompile = false;  // no traps emitted yet
1118   _major_progress = true; // start out assuming good things will happen
1119   set_has_unsafe_access(false);
1120   set_max_vector_size(0);
1121   set_clear_upper_avx(false);  //false as default for clear upper bits of ymm registers
1122   Copy::zero_to_bytes(_trap_hist, sizeof(_trap_hist));
1123   set_decompile_count(0);
1124 
1125   set_do_freq_based_layout(_directive-&gt;BlockLayoutByFrequencyOption);
1126   _loop_opts_cnt = LoopOptsCount;
1127   set_do_inlining(Inline);
1128   set_max_inline_size(MaxInlineSize);
1129   set_freq_inline_size(FreqInlineSize);
1130   set_do_scheduling(OptoScheduling);
1131   set_do_count_invocations(false);
1132   set_do_method_data_update(false);
1133 
1134   set_do_vector_loop(false);
1135 
1136   if (AllowVectorizeOnDemand) {
1137     if (has_method() &amp;&amp; (_directive-&gt;VectorizeOption || _directive-&gt;VectorizeDebugOption)) {
1138       set_do_vector_loop(true);
1139       NOT_PRODUCT(if (do_vector_loop() &amp;&amp; Verbose) {tty-&gt;print(&quot;Compile::Init: do vectorized loops (SIMD like) for method %s\n&quot;,  method()-&gt;name()-&gt;as_quoted_ascii());})
1140     } else if (has_method() &amp;&amp; method()-&gt;name() != 0 &amp;&amp;
1141                method()-&gt;intrinsic_id() == vmIntrinsics::_forEachRemaining) {
1142       set_do_vector_loop(true);
1143     }
1144   }
1145   set_use_cmove(UseCMoveUnconditionally /* || do_vector_loop()*/); //TODO: consider do_vector_loop() mandate use_cmove unconditionally
1146   NOT_PRODUCT(if (use_cmove() &amp;&amp; Verbose &amp;&amp; has_method()) {tty-&gt;print(&quot;Compile::Init: use CMove without profitability tests for method %s\n&quot;,  method()-&gt;name()-&gt;as_quoted_ascii());})
1147 
1148   set_age_code(has_method() &amp;&amp; method()-&gt;profile_aging());
1149   set_rtm_state(NoRTM); // No RTM lock eliding by default
1150   _max_node_limit = _directive-&gt;MaxNodeLimitOption;
1151 
1152 #if INCLUDE_RTM_OPT
1153   if (UseRTMLocking &amp;&amp; has_method() &amp;&amp; (method()-&gt;method_data_or_null() != NULL)) {
1154     int rtm_state = method()-&gt;method_data()-&gt;rtm_state();
1155     if (method_has_option(&quot;NoRTMLockEliding&quot;) || ((rtm_state &amp; NoRTM) != 0)) {
1156       // Don&#39;t generate RTM lock eliding code.
1157       set_rtm_state(NoRTM);
1158     } else if (method_has_option(&quot;UseRTMLockEliding&quot;) || ((rtm_state &amp; UseRTM) != 0) || !UseRTMDeopt) {
1159       // Generate RTM lock eliding code without abort ratio calculation code.
1160       set_rtm_state(UseRTM);
1161     } else if (UseRTMDeopt) {
1162       // Generate RTM lock eliding code and include abort ratio calculation
1163       // code if UseRTMDeopt is on.
1164       set_rtm_state(ProfileRTM);
1165     }
1166   }
1167 #endif
<a name="15" id="anc15"></a>


1168   if (debug_info()-&gt;recording_non_safepoints()) {
1169     set_node_note_array(new(comp_arena()) GrowableArray&lt;Node_Notes*&gt;
1170                         (comp_arena(), 8, 0, NULL));
1171     set_default_node_notes(Node_Notes::make(this));
1172   }
1173 
1174   // // -- Initialize types before each compile --
1175   // // Update cached type information
1176   // if( _method &amp;&amp; _method-&gt;constants() )
1177   //   Type::update_loaded_types(_method, _method-&gt;constants());
1178 
1179   // Init alias_type map.
1180   if (!_do_escape_analysis &amp;&amp; aliaslevel == 3)
1181     aliaslevel = 2;  // No unique types without escape analysis
1182   _AliasLevel = aliaslevel;
1183   const int grow_ats = 16;
1184   _max_alias_types = grow_ats;
1185   _alias_types   = NEW_ARENA_ARRAY(comp_arena(), AliasType*, grow_ats);
1186   AliasType* ats = NEW_ARENA_ARRAY(comp_arena(), AliasType,  grow_ats);
1187   Copy::zero_to_bytes(ats, sizeof(AliasType)*grow_ats);
1188   {
1189     for (int i = 0; i &lt; grow_ats; i++)  _alias_types[i] = &amp;ats[i];
1190   }
1191   // Initialize the first few types.
1192   _alias_types[AliasIdxTop]-&gt;Init(AliasIdxTop, NULL);
1193   _alias_types[AliasIdxBot]-&gt;Init(AliasIdxBot, TypePtr::BOTTOM);
1194   _alias_types[AliasIdxRaw]-&gt;Init(AliasIdxRaw, TypeRawPtr::BOTTOM);
1195   _num_alias_types = AliasIdxRaw+1;
1196   // Zero out the alias type cache.
1197   Copy::zero_to_bytes(_alias_cache, sizeof(_alias_cache));
1198   // A NULL adr_type hits in the cache right away.  Preload the right answer.
1199   probe_alias_cache(NULL)-&gt;_index = AliasIdxTop;
1200 
1201   _intrinsics = NULL;
1202   _macro_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1203   _predicate_opaqs = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1204   _expensive_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1205   _range_check_casts = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1206   _opaque4_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1207   register_library_intrinsics();
1208 }
1209 
1210 //---------------------------init_start----------------------------------------
1211 // Install the StartNode on this compile object.
1212 void Compile::init_start(StartNode* s) {
1213   if (failing())
1214     return; // already failing
1215   assert(s == start(), &quot;&quot;);
1216 }
1217 
1218 /**
1219  * Return the &#39;StartNode&#39;. We must not have a pending failure, since the ideal graph
1220  * can be in an inconsistent state, i.e., we can get segmentation faults when traversing
1221  * the ideal graph.
1222  */
1223 StartNode* Compile::start() const {
1224   assert (!failing(), &quot;Must not have pending failure. Reason is: %s&quot;, failure_reason());
1225   for (DUIterator_Fast imax, i = root()-&gt;fast_outs(imax); i &lt; imax; i++) {
1226     Node* start = root()-&gt;fast_out(i);
1227     if (start-&gt;is_Start()) {
1228       return start-&gt;as_Start();
1229     }
1230   }
1231   fatal(&quot;Did not find Start node!&quot;);
1232   return NULL;
1233 }
1234 
1235 //-------------------------------immutable_memory-------------------------------------
1236 // Access immutable memory
1237 Node* Compile::immutable_memory() {
1238   if (_immutable_memory != NULL) {
1239     return _immutable_memory;
1240   }
1241   StartNode* s = start();
1242   for (DUIterator_Fast imax, i = s-&gt;fast_outs(imax); true; i++) {
1243     Node *p = s-&gt;fast_out(i);
1244     if (p != s &amp;&amp; p-&gt;as_Proj()-&gt;_con == TypeFunc::Memory) {
1245       _immutable_memory = p;
1246       return _immutable_memory;
1247     }
1248   }
1249   ShouldNotReachHere();
1250   return NULL;
1251 }
1252 
1253 //----------------------set_cached_top_node------------------------------------
1254 // Install the cached top node, and make sure Node::is_top works correctly.
1255 void Compile::set_cached_top_node(Node* tn) {
1256   if (tn != NULL)  verify_top(tn);
1257   Node* old_top = _top;
1258   _top = tn;
1259   // Calling Node::setup_is_top allows the nodes the chance to adjust
1260   // their _out arrays.
1261   if (_top != NULL)     _top-&gt;setup_is_top();
1262   if (old_top != NULL)  old_top-&gt;setup_is_top();
1263   assert(_top == NULL || top()-&gt;is_top(), &quot;&quot;);
1264 }
1265 
1266 #ifdef ASSERT
1267 uint Compile::count_live_nodes_by_graph_walk() {
1268   Unique_Node_List useful(comp_arena());
1269   // Get useful node list by walking the graph.
1270   identify_useful_nodes(useful);
1271   return useful.size();
1272 }
1273 
1274 void Compile::print_missing_nodes() {
1275 
1276   // Return if CompileLog is NULL and PrintIdealNodeCount is false.
1277   if ((_log == NULL) &amp;&amp; (! PrintIdealNodeCount)) {
1278     return;
1279   }
1280 
1281   // This is an expensive function. It is executed only when the user
1282   // specifies VerifyIdealNodeCount option or otherwise knows the
1283   // additional work that needs to be done to identify reachable nodes
1284   // by walking the flow graph and find the missing ones using
1285   // _dead_node_list.
1286 
1287   Unique_Node_List useful(comp_arena());
1288   // Get useful node list by walking the graph.
1289   identify_useful_nodes(useful);
1290 
1291   uint l_nodes = C-&gt;live_nodes();
1292   uint l_nodes_by_walk = useful.size();
1293 
1294   if (l_nodes != l_nodes_by_walk) {
1295     if (_log != NULL) {
1296       _log-&gt;begin_head(&quot;mismatched_nodes count=&#39;%d&#39;&quot;, abs((int) (l_nodes - l_nodes_by_walk)));
1297       _log-&gt;stamp();
1298       _log-&gt;end_head();
1299     }
1300     VectorSet&amp; useful_member_set = useful.member_set();
1301     int last_idx = l_nodes_by_walk;
1302     for (int i = 0; i &lt; last_idx; i++) {
1303       if (useful_member_set.test(i)) {
1304         if (_dead_node_list.test(i)) {
1305           if (_log != NULL) {
1306             _log-&gt;elem(&quot;mismatched_node_info node_idx=&#39;%d&#39; type=&#39;both live and dead&#39;&quot;, i);
1307           }
1308           if (PrintIdealNodeCount) {
1309             // Print the log message to tty
1310               tty-&gt;print_cr(&quot;mismatched_node idx=&#39;%d&#39; both live and dead&#39;&quot;, i);
1311               useful.at(i)-&gt;dump();
1312           }
1313         }
1314       }
1315       else if (! _dead_node_list.test(i)) {
1316         if (_log != NULL) {
1317           _log-&gt;elem(&quot;mismatched_node_info node_idx=&#39;%d&#39; type=&#39;neither live nor dead&#39;&quot;, i);
1318         }
1319         if (PrintIdealNodeCount) {
1320           // Print the log message to tty
1321           tty-&gt;print_cr(&quot;mismatched_node idx=&#39;%d&#39; type=&#39;neither live nor dead&#39;&quot;, i);
1322         }
1323       }
1324     }
1325     if (_log != NULL) {
1326       _log-&gt;tail(&quot;mismatched_nodes&quot;);
1327     }
1328   }
1329 }
1330 void Compile::record_modified_node(Node* n) {
1331   if (_modified_nodes != NULL &amp;&amp; !_inlining_incrementally &amp;&amp;
1332       n-&gt;outcnt() != 0 &amp;&amp; !n-&gt;is_Con()) {
1333     _modified_nodes-&gt;push(n);
1334   }
1335 }
1336 
1337 void Compile::remove_modified_node(Node* n) {
1338   if (_modified_nodes != NULL) {
1339     _modified_nodes-&gt;remove(n);
1340   }
1341 }
1342 #endif
1343 
1344 #ifndef PRODUCT
1345 void Compile::verify_top(Node* tn) const {
1346   if (tn != NULL) {
1347     assert(tn-&gt;is_Con(), &quot;top node must be a constant&quot;);
1348     assert(((ConNode*)tn)-&gt;type() == Type::TOP, &quot;top node must have correct type&quot;);
1349     assert(tn-&gt;in(0) != NULL, &quot;must have live top node&quot;);
1350   }
1351 }
1352 #endif
1353 
1354 
1355 ///-------------------Managing Per-Node Debug &amp; Profile Info-------------------
1356 
1357 void Compile::grow_node_notes(GrowableArray&lt;Node_Notes*&gt;* arr, int grow_by) {
1358   guarantee(arr != NULL, &quot;&quot;);
1359   int num_blocks = arr-&gt;length();
1360   if (grow_by &lt; num_blocks)  grow_by = num_blocks;
1361   int num_notes = grow_by * _node_notes_block_size;
1362   Node_Notes* notes = NEW_ARENA_ARRAY(node_arena(), Node_Notes, num_notes);
1363   Copy::zero_to_bytes(notes, num_notes * sizeof(Node_Notes));
1364   while (num_notes &gt; 0) {
1365     arr-&gt;append(notes);
1366     notes     += _node_notes_block_size;
1367     num_notes -= _node_notes_block_size;
1368   }
1369   assert(num_notes == 0, &quot;exact multiple, please&quot;);
1370 }
1371 
1372 bool Compile::copy_node_notes_to(Node* dest, Node* source) {
1373   if (source == NULL || dest == NULL)  return false;
1374 
1375   if (dest-&gt;is_Con())
1376     return false;               // Do not push debug info onto constants.
1377 
1378 #ifdef ASSERT
1379   // Leave a bread crumb trail pointing to the original node:
1380   if (dest != NULL &amp;&amp; dest != source &amp;&amp; dest-&gt;debug_orig() == NULL) {
1381     dest-&gt;set_debug_orig(source);
1382   }
1383 #endif
1384 
1385   if (node_note_array() == NULL)
1386     return false;               // Not collecting any notes now.
1387 
1388   // This is a copy onto a pre-existing node, which may already have notes.
1389   // If both nodes have notes, do not overwrite any pre-existing notes.
1390   Node_Notes* source_notes = node_notes_at(source-&gt;_idx);
1391   if (source_notes == NULL || source_notes-&gt;is_clear())  return false;
1392   Node_Notes* dest_notes   = node_notes_at(dest-&gt;_idx);
1393   if (dest_notes == NULL || dest_notes-&gt;is_clear()) {
1394     return set_node_notes_at(dest-&gt;_idx, source_notes);
1395   }
1396 
1397   Node_Notes merged_notes = (*source_notes);
1398   // The order of operations here ensures that dest notes will win...
1399   merged_notes.update_from(dest_notes);
1400   return set_node_notes_at(dest-&gt;_idx, &amp;merged_notes);
1401 }
1402 
1403 
1404 //--------------------------allow_range_check_smearing-------------------------
1405 // Gating condition for coalescing similar range checks.
1406 // Sometimes we try &#39;speculatively&#39; replacing a series of a range checks by a
1407 // single covering check that is at least as strong as any of them.
1408 // If the optimization succeeds, the simplified (strengthened) range check
1409 // will always succeed.  If it fails, we will deopt, and then give up
1410 // on the optimization.
1411 bool Compile::allow_range_check_smearing() const {
1412   // If this method has already thrown a range-check,
1413   // assume it was because we already tried range smearing
1414   // and it failed.
1415   uint already_trapped = trap_count(Deoptimization::Reason_range_check);
1416   return !already_trapped;
1417 }
1418 
1419 
1420 //------------------------------flatten_alias_type-----------------------------
1421 const TypePtr *Compile::flatten_alias_type( const TypePtr *tj ) const {
1422   int offset = tj-&gt;offset();
1423   TypePtr::PTR ptr = tj-&gt;ptr();
1424 
1425   // Known instance (scalarizable allocation) alias only with itself.
1426   bool is_known_inst = tj-&gt;isa_oopptr() != NULL &amp;&amp;
1427                        tj-&gt;is_oopptr()-&gt;is_known_instance();
1428 
1429   // Process weird unsafe references.
1430   if (offset == Type::OffsetBot &amp;&amp; (tj-&gt;isa_instptr() /*|| tj-&gt;isa_klassptr()*/)) {
1431     assert(InlineUnsafeOps, &quot;indeterminate pointers come only from unsafe ops&quot;);
1432     assert(!is_known_inst, &quot;scalarizable allocation should not have unsafe references&quot;);
1433     tj = TypeOopPtr::BOTTOM;
1434     ptr = tj-&gt;ptr();
1435     offset = tj-&gt;offset();
1436   }
1437 
1438   // Array pointers need some flattening
1439   const TypeAryPtr *ta = tj-&gt;isa_aryptr();
1440   if (ta &amp;&amp; ta-&gt;is_stable()) {
1441     // Erase stability property for alias analysis.
1442     tj = ta = ta-&gt;cast_to_stable(false);
1443   }
1444   if( ta &amp;&amp; is_known_inst ) {
1445     if ( offset != Type::OffsetBot &amp;&amp;
1446          offset &gt; arrayOopDesc::length_offset_in_bytes() ) {
1447       offset = Type::OffsetBot; // Flatten constant access into array body only
1448       tj = ta = TypeAryPtr::make(ptr, ta-&gt;ary(), ta-&gt;klass(), true, offset, ta-&gt;instance_id());
1449     }
1450   } else if( ta &amp;&amp; _AliasLevel &gt;= 2 ) {
1451     // For arrays indexed by constant indices, we flatten the alias
1452     // space to include all of the array body.  Only the header, klass
1453     // and array length can be accessed un-aliased.
1454     if( offset != Type::OffsetBot ) {
1455       if( ta-&gt;const_oop() ) { // MethodData* or Method*
1456         offset = Type::OffsetBot;   // Flatten constant access into array body
1457         tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),ta-&gt;ary(),ta-&gt;klass(),false,offset);
1458       } else if( offset == arrayOopDesc::length_offset_in_bytes() ) {
1459         // range is OK as-is.
1460         tj = ta = TypeAryPtr::RANGE;
1461       } else if( offset == oopDesc::klass_offset_in_bytes() ) {
1462         tj = TypeInstPtr::KLASS; // all klass loads look alike
1463         ta = TypeAryPtr::RANGE; // generic ignored junk
1464         ptr = TypePtr::BotPTR;
1465       } else if( offset == oopDesc::mark_offset_in_bytes() ) {
1466         tj = TypeInstPtr::MARK;
1467         ta = TypeAryPtr::RANGE; // generic ignored junk
1468         ptr = TypePtr::BotPTR;
<a name="16" id="anc16"></a><span class="line-removed">1469       } else if (BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;flatten_gc_alias_type(tj)) {</span>
<span class="line-removed">1470         ta = tj-&gt;isa_aryptr();</span>
1471       } else {                  // Random constant offset into array body
1472         offset = Type::OffsetBot;   // Flatten constant access into array body
1473         tj = ta = TypeAryPtr::make(ptr,ta-&gt;ary(),ta-&gt;klass(),false,offset);
1474       }
1475     }
1476     // Arrays of fixed size alias with arrays of unknown size.
1477     if (ta-&gt;size() != TypeInt::POS) {
1478       const TypeAry *tary = TypeAry::make(ta-&gt;elem(), TypeInt::POS);
1479       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,ta-&gt;klass(),false,offset);
1480     }
1481     // Arrays of known objects become arrays of unknown objects.
1482     if (ta-&gt;elem()-&gt;isa_narrowoop() &amp;&amp; ta-&gt;elem() != TypeNarrowOop::BOTTOM) {
1483       const TypeAry *tary = TypeAry::make(TypeNarrowOop::BOTTOM, ta-&gt;size());
1484       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,NULL,false,offset);
1485     }
1486     if (ta-&gt;elem()-&gt;isa_oopptr() &amp;&amp; ta-&gt;elem() != TypeInstPtr::BOTTOM) {
1487       const TypeAry *tary = TypeAry::make(TypeInstPtr::BOTTOM, ta-&gt;size());
1488       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,NULL,false,offset);
1489     }
1490     // Arrays of bytes and of booleans both use &#39;bastore&#39; and &#39;baload&#39; so
1491     // cannot be distinguished by bytecode alone.
1492     if (ta-&gt;elem() == TypeInt::BOOL) {
1493       const TypeAry *tary = TypeAry::make(TypeInt::BYTE, ta-&gt;size());
1494       ciKlass* aklass = ciTypeArrayKlass::make(T_BYTE);
1495       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,aklass,false,offset);
1496     }
1497     // During the 2nd round of IterGVN, NotNull castings are removed.
1498     // Make sure the Bottom and NotNull variants alias the same.
1499     // Also, make sure exact and non-exact variants alias the same.
1500     if (ptr == TypePtr::NotNull || ta-&gt;klass_is_exact() || ta-&gt;speculative() != NULL) {
1501       tj = ta = TypeAryPtr::make(TypePtr::BotPTR,ta-&gt;ary(),ta-&gt;klass(),false,offset);
1502     }
1503   }
1504 
1505   // Oop pointers need some flattening
1506   const TypeInstPtr *to = tj-&gt;isa_instptr();
1507   if( to &amp;&amp; _AliasLevel &gt;= 2 &amp;&amp; to != TypeOopPtr::BOTTOM ) {
1508     ciInstanceKlass *k = to-&gt;klass()-&gt;as_instance_klass();
1509     if( ptr == TypePtr::Constant ) {
1510       if (to-&gt;klass() != ciEnv::current()-&gt;Class_klass() ||
1511           offset &lt; k-&gt;size_helper() * wordSize) {
1512         // No constant oop pointers (such as Strings); they alias with
1513         // unknown strings.
1514         assert(!is_known_inst, &quot;not scalarizable allocation&quot;);
1515         tj = to = TypeInstPtr::make(TypePtr::BotPTR,to-&gt;klass(),false,0,offset);
1516       }
1517     } else if( is_known_inst ) {
1518       tj = to; // Keep NotNull and klass_is_exact for instance type
1519     } else if( ptr == TypePtr::NotNull || to-&gt;klass_is_exact() ) {
1520       // During the 2nd round of IterGVN, NotNull castings are removed.
1521       // Make sure the Bottom and NotNull variants alias the same.
1522       // Also, make sure exact and non-exact variants alias the same.
1523       tj = to = TypeInstPtr::make(TypePtr::BotPTR,to-&gt;klass(),false,0,offset);
1524     }
1525     if (to-&gt;speculative() != NULL) {
1526       tj = to = TypeInstPtr::make(to-&gt;ptr(),to-&gt;klass(),to-&gt;klass_is_exact(),to-&gt;const_oop(),to-&gt;offset(), to-&gt;instance_id());
1527     }
1528     // Canonicalize the holder of this field
1529     if (offset &gt;= 0 &amp;&amp; offset &lt; instanceOopDesc::base_offset_in_bytes()) {
1530       // First handle header references such as a LoadKlassNode, even if the
1531       // object&#39;s klass is unloaded at compile time (4965979).
1532       if (!is_known_inst) { // Do it only for non-instance types
1533         tj = to = TypeInstPtr::make(TypePtr::BotPTR, env()-&gt;Object_klass(), false, NULL, offset);
1534       }
<a name="17" id="anc17"></a><span class="line-removed">1535     } else if (BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;flatten_gc_alias_type(tj)) {</span>
<span class="line-removed">1536       to = tj-&gt;is_instptr();</span>
1537     } else if (offset &lt; 0 || offset &gt;= k-&gt;size_helper() * wordSize) {
1538       // Static fields are in the space above the normal instance
1539       // fields in the java.lang.Class instance.
1540       if (to-&gt;klass() != ciEnv::current()-&gt;Class_klass()) {
1541         to = NULL;
1542         tj = TypeOopPtr::BOTTOM;
1543         offset = tj-&gt;offset();
1544       }
1545     } else {
1546       ciInstanceKlass *canonical_holder = k-&gt;get_canonical_holder(offset);
1547       if (!k-&gt;equals(canonical_holder) || tj-&gt;offset() != offset) {
1548         if( is_known_inst ) {
1549           tj = to = TypeInstPtr::make(to-&gt;ptr(), canonical_holder, true, NULL, offset, to-&gt;instance_id());
1550         } else {
1551           tj = to = TypeInstPtr::make(to-&gt;ptr(), canonical_holder, false, NULL, offset);
1552         }
1553       }
1554     }
1555   }
1556 
1557   // Klass pointers to object array klasses need some flattening
1558   const TypeKlassPtr *tk = tj-&gt;isa_klassptr();
1559   if( tk ) {
1560     // If we are referencing a field within a Klass, we need
1561     // to assume the worst case of an Object.  Both exact and
1562     // inexact types must flatten to the same alias class so
1563     // use NotNull as the PTR.
1564     if ( offset == Type::OffsetBot || (offset &gt;= 0 &amp;&amp; (size_t)offset &lt; sizeof(Klass)) ) {
1565 
1566       tj = tk = TypeKlassPtr::make(TypePtr::NotNull,
1567                                    TypeKlassPtr::OBJECT-&gt;klass(),
1568                                    offset);
1569     }
1570 
1571     ciKlass* klass = tk-&gt;klass();
1572     if( klass-&gt;is_obj_array_klass() ) {
1573       ciKlass* k = TypeAryPtr::OOPS-&gt;klass();
1574       if( !k || !k-&gt;is_loaded() )                  // Only fails for some -Xcomp runs
1575         k = TypeInstPtr::BOTTOM-&gt;klass();
1576       tj = tk = TypeKlassPtr::make( TypePtr::NotNull, k, offset );
1577     }
1578 
1579     // Check for precise loads from the primary supertype array and force them
1580     // to the supertype cache alias index.  Check for generic array loads from
1581     // the primary supertype array and also force them to the supertype cache
1582     // alias index.  Since the same load can reach both, we need to merge
1583     // these 2 disparate memories into the same alias class.  Since the
1584     // primary supertype array is read-only, there&#39;s no chance of confusion
1585     // where we bypass an array load and an array store.
1586     int primary_supers_offset = in_bytes(Klass::primary_supers_offset());
1587     if (offset == Type::OffsetBot ||
1588         (offset &gt;= primary_supers_offset &amp;&amp;
1589          offset &lt; (int)(primary_supers_offset + Klass::primary_super_limit() * wordSize)) ||
1590         offset == (int)in_bytes(Klass::secondary_super_cache_offset())) {
1591       offset = in_bytes(Klass::secondary_super_cache_offset());
1592       tj = tk = TypeKlassPtr::make( TypePtr::NotNull, tk-&gt;klass(), offset );
1593     }
1594   }
1595 
1596   // Flatten all Raw pointers together.
1597   if (tj-&gt;base() == Type::RawPtr)
1598     tj = TypeRawPtr::BOTTOM;
1599 
1600   if (tj-&gt;base() == Type::AnyPtr)
1601     tj = TypePtr::BOTTOM;      // An error, which the caller must check for.
1602 
1603   // Flatten all to bottom for now
1604   switch( _AliasLevel ) {
1605   case 0:
1606     tj = TypePtr::BOTTOM;
1607     break;
1608   case 1:                       // Flatten to: oop, static, field or array
1609     switch (tj-&gt;base()) {
1610     //case Type::AryPtr: tj = TypeAryPtr::RANGE;    break;
1611     case Type::RawPtr:   tj = TypeRawPtr::BOTTOM;   break;
1612     case Type::AryPtr:   // do not distinguish arrays at all
1613     case Type::InstPtr:  tj = TypeInstPtr::BOTTOM;  break;
1614     case Type::KlassPtr: tj = TypeKlassPtr::OBJECT; break;
1615     case Type::AnyPtr:   tj = TypePtr::BOTTOM;      break;  // caller checks it
1616     default: ShouldNotReachHere();
1617     }
1618     break;
1619   case 2:                       // No collapsing at level 2; keep all splits
1620   case 3:                       // No collapsing at level 3; keep all splits
1621     break;
1622   default:
1623     Unimplemented();
1624   }
1625 
1626   offset = tj-&gt;offset();
1627   assert( offset != Type::OffsetTop, &quot;Offset has fallen from constant&quot; );
1628 
1629   assert( (offset != Type::OffsetBot &amp;&amp; tj-&gt;base() != Type::AryPtr) ||
1630           (offset == Type::OffsetBot &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
1631           (offset == Type::OffsetBot &amp;&amp; tj == TypeOopPtr::BOTTOM) ||
1632           (offset == Type::OffsetBot &amp;&amp; tj == TypePtr::BOTTOM) ||
1633           (offset == oopDesc::mark_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
1634           (offset == oopDesc::klass_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
<a name="18" id="anc18"></a><span class="line-modified">1635           (offset == arrayOopDesc::length_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr) ||</span>
<span class="line-removed">1636           (BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;verify_gc_alias_type(tj, offset)),</span>
1637           &quot;For oops, klasses, raw offset must be constant; for arrays the offset is never known&quot; );
1638   assert( tj-&gt;ptr() != TypePtr::TopPTR &amp;&amp;
1639           tj-&gt;ptr() != TypePtr::AnyNull &amp;&amp;
1640           tj-&gt;ptr() != TypePtr::Null, &quot;No imprecise addresses&quot; );
1641 //    assert( tj-&gt;ptr() != TypePtr::Constant ||
1642 //            tj-&gt;base() == Type::RawPtr ||
1643 //            tj-&gt;base() == Type::KlassPtr, &quot;No constant oop addresses&quot; );
1644 
1645   return tj;
1646 }
1647 
1648 void Compile::AliasType::Init(int i, const TypePtr* at) {
<a name="19" id="anc19"></a>
1649   _index = i;
1650   _adr_type = at;
1651   _field = NULL;
1652   _element = NULL;
1653   _is_rewritable = true; // default
1654   const TypeOopPtr *atoop = (at != NULL) ? at-&gt;isa_oopptr() : NULL;
1655   if (atoop != NULL &amp;&amp; atoop-&gt;is_known_instance()) {
1656     const TypeOopPtr *gt = atoop-&gt;cast_to_instance_id(TypeOopPtr::InstanceBot);
1657     _general_index = Compile::current()-&gt;get_alias_index(gt);
1658   } else {
1659     _general_index = 0;
1660   }
1661 }
1662 
1663 BasicType Compile::AliasType::basic_type() const {
1664   if (element() != NULL) {
1665     const Type* element = adr_type()-&gt;is_aryptr()-&gt;elem();
1666     return element-&gt;isa_narrowoop() ? T_OBJECT : element-&gt;array_element_basic_type();
1667   } if (field() != NULL) {
1668     return field()-&gt;layout_type();
1669   } else {
1670     return T_ILLEGAL; // unknown
1671   }
1672 }
1673 
1674 //---------------------------------print_on------------------------------------
1675 #ifndef PRODUCT
1676 void Compile::AliasType::print_on(outputStream* st) {
1677   if (index() &lt; 10)
1678         st-&gt;print(&quot;@ &lt;%d&gt; &quot;, index());
1679   else  st-&gt;print(&quot;@ &lt;%d&gt;&quot;,  index());
1680   st-&gt;print(is_rewritable() ? &quot;   &quot; : &quot; RO&quot;);
1681   int offset = adr_type()-&gt;offset();
1682   if (offset == Type::OffsetBot)
1683         st-&gt;print(&quot; +any&quot;);
1684   else  st-&gt;print(&quot; +%-3d&quot;, offset);
1685   st-&gt;print(&quot; in &quot;);
1686   adr_type()-&gt;dump_on(st);
1687   const TypeOopPtr* tjp = adr_type()-&gt;isa_oopptr();
1688   if (field() != NULL &amp;&amp; tjp) {
1689     if (tjp-&gt;klass()  != field()-&gt;holder() ||
1690         tjp-&gt;offset() != field()-&gt;offset_in_bytes()) {
1691       st-&gt;print(&quot; != &quot;);
1692       field()-&gt;print();
1693       st-&gt;print(&quot; ***&quot;);
1694     }
1695   }
1696 }
1697 
1698 void print_alias_types() {
1699   Compile* C = Compile::current();
1700   tty-&gt;print_cr(&quot;--- Alias types, AliasIdxBot .. %d&quot;, C-&gt;num_alias_types()-1);
1701   for (int idx = Compile::AliasIdxBot; idx &lt; C-&gt;num_alias_types(); idx++) {
1702     C-&gt;alias_type(idx)-&gt;print_on(tty);
1703     tty-&gt;cr();
1704   }
1705 }
1706 #endif
1707 
1708 
1709 //----------------------------probe_alias_cache--------------------------------
1710 Compile::AliasCacheEntry* Compile::probe_alias_cache(const TypePtr* adr_type) {
1711   intptr_t key = (intptr_t) adr_type;
1712   key ^= key &gt;&gt; logAliasCacheSize;
1713   return &amp;_alias_cache[key &amp; right_n_bits(logAliasCacheSize)];
1714 }
1715 
1716 
1717 //-----------------------------grow_alias_types--------------------------------
1718 void Compile::grow_alias_types() {
1719   const int old_ats  = _max_alias_types; // how many before?
1720   const int new_ats  = old_ats;          // how many more?
1721   const int grow_ats = old_ats+new_ats;  // how many now?
1722   _max_alias_types = grow_ats;
1723   _alias_types =  REALLOC_ARENA_ARRAY(comp_arena(), AliasType*, _alias_types, old_ats, grow_ats);
1724   AliasType* ats =    NEW_ARENA_ARRAY(comp_arena(), AliasType, new_ats);
1725   Copy::zero_to_bytes(ats, sizeof(AliasType)*new_ats);
1726   for (int i = 0; i &lt; new_ats; i++)  _alias_types[old_ats+i] = &amp;ats[i];
1727 }
1728 
1729 
1730 //--------------------------------find_alias_type------------------------------
1731 Compile::AliasType* Compile::find_alias_type(const TypePtr* adr_type, bool no_create, ciField* original_field) {
1732   if (_AliasLevel == 0)
1733     return alias_type(AliasIdxBot);
1734 
1735   AliasCacheEntry* ace = probe_alias_cache(adr_type);
1736   if (ace-&gt;_adr_type == adr_type) {
1737     return alias_type(ace-&gt;_index);
1738   }
1739 
1740   // Handle special cases.
1741   if (adr_type == NULL)             return alias_type(AliasIdxTop);
1742   if (adr_type == TypePtr::BOTTOM)  return alias_type(AliasIdxBot);
1743 
1744   // Do it the slow way.
1745   const TypePtr* flat = flatten_alias_type(adr_type);
1746 
1747 #ifdef ASSERT
1748   {
1749     ResourceMark rm;
1750     assert(flat == flatten_alias_type(flat), &quot;not idempotent: adr_type = %s; flat = %s =&gt; %s&quot;,
1751            Type::str(adr_type), Type::str(flat), Type::str(flatten_alias_type(flat)));
1752     assert(flat != TypePtr::BOTTOM, &quot;cannot alias-analyze an untyped ptr: adr_type = %s&quot;,
1753            Type::str(adr_type));
1754     if (flat-&gt;isa_oopptr() &amp;&amp; !flat-&gt;isa_klassptr()) {
1755       const TypeOopPtr* foop = flat-&gt;is_oopptr();
1756       // Scalarizable allocations have exact klass always.
1757       bool exact = !foop-&gt;klass_is_exact() || foop-&gt;is_known_instance();
1758       const TypePtr* xoop = foop-&gt;cast_to_exactness(exact)-&gt;is_ptr();
1759       assert(foop == flatten_alias_type(xoop), &quot;exactness must not affect alias type: foop = %s; xoop = %s&quot;,
1760              Type::str(foop), Type::str(xoop));
1761     }
1762   }
1763 #endif
1764 
1765   int idx = AliasIdxTop;
1766   for (int i = 0; i &lt; num_alias_types(); i++) {
1767     if (alias_type(i)-&gt;adr_type() == flat) {
1768       idx = i;
1769       break;
1770     }
1771   }
1772 
1773   if (idx == AliasIdxTop) {
1774     if (no_create)  return NULL;
1775     // Grow the array if necessary.
1776     if (_num_alias_types == _max_alias_types)  grow_alias_types();
1777     // Add a new alias type.
1778     idx = _num_alias_types++;
1779     _alias_types[idx]-&gt;Init(idx, flat);
1780     if (flat == TypeInstPtr::KLASS)  alias_type(idx)-&gt;set_rewritable(false);
1781     if (flat == TypeAryPtr::RANGE)   alias_type(idx)-&gt;set_rewritable(false);
1782     if (flat-&gt;isa_instptr()) {
1783       if (flat-&gt;offset() == java_lang_Class::klass_offset_in_bytes()
1784           &amp;&amp; flat-&gt;is_instptr()-&gt;klass() == env()-&gt;Class_klass())
1785         alias_type(idx)-&gt;set_rewritable(false);
1786     }
1787     if (flat-&gt;isa_aryptr()) {
1788 #ifdef ASSERT
1789       const int header_size_min  = arrayOopDesc::base_offset_in_bytes(T_BYTE);
1790       // (T_BYTE has the weakest alignment and size restrictions...)
1791       assert(flat-&gt;offset() &lt; header_size_min, &quot;array body reference must be OffsetBot&quot;);
1792 #endif
1793       if (flat-&gt;offset() == TypePtr::OffsetBot) {
1794         alias_type(idx)-&gt;set_element(flat-&gt;is_aryptr()-&gt;elem());
1795       }
1796     }
1797     if (flat-&gt;isa_klassptr()) {
1798       if (flat-&gt;offset() == in_bytes(Klass::super_check_offset_offset()))
1799         alias_type(idx)-&gt;set_rewritable(false);
1800       if (flat-&gt;offset() == in_bytes(Klass::modifier_flags_offset()))
1801         alias_type(idx)-&gt;set_rewritable(false);
1802       if (flat-&gt;offset() == in_bytes(Klass::access_flags_offset()))
1803         alias_type(idx)-&gt;set_rewritable(false);
1804       if (flat-&gt;offset() == in_bytes(Klass::java_mirror_offset()))
1805         alias_type(idx)-&gt;set_rewritable(false);
1806     }
1807     // %%% (We would like to finalize JavaThread::threadObj_offset(),
1808     // but the base pointer type is not distinctive enough to identify
1809     // references into JavaThread.)
1810 
1811     // Check for final fields.
1812     const TypeInstPtr* tinst = flat-&gt;isa_instptr();
1813     if (tinst &amp;&amp; tinst-&gt;offset() &gt;= instanceOopDesc::base_offset_in_bytes()) {
1814       ciField* field;
1815       if (tinst-&gt;const_oop() != NULL &amp;&amp;
1816           tinst-&gt;klass() == ciEnv::current()-&gt;Class_klass() &amp;&amp;
1817           tinst-&gt;offset() &gt;= (tinst-&gt;klass()-&gt;as_instance_klass()-&gt;size_helper() * wordSize)) {
1818         // static field
1819         ciInstanceKlass* k = tinst-&gt;const_oop()-&gt;as_instance()-&gt;java_lang_Class_klass()-&gt;as_instance_klass();
1820         field = k-&gt;get_field_by_offset(tinst-&gt;offset(), true);
1821       } else {
1822         ciInstanceKlass *k = tinst-&gt;klass()-&gt;as_instance_klass();
1823         field = k-&gt;get_field_by_offset(tinst-&gt;offset(), false);
1824       }
1825       assert(field == NULL ||
1826              original_field == NULL ||
1827              (field-&gt;holder() == original_field-&gt;holder() &amp;&amp;
1828               field-&gt;offset() == original_field-&gt;offset() &amp;&amp;
1829               field-&gt;is_static() == original_field-&gt;is_static()), &quot;wrong field?&quot;);
1830       // Set field() and is_rewritable() attributes.
1831       if (field != NULL)  alias_type(idx)-&gt;set_field(field);
1832     }
1833   }
1834 
1835   // Fill the cache for next time.
1836   ace-&gt;_adr_type = adr_type;
1837   ace-&gt;_index    = idx;
1838   assert(alias_type(adr_type) == alias_type(idx),  &quot;type must be installed&quot;);
1839 
1840   // Might as well try to fill the cache for the flattened version, too.
1841   AliasCacheEntry* face = probe_alias_cache(flat);
1842   if (face-&gt;_adr_type == NULL) {
1843     face-&gt;_adr_type = flat;
1844     face-&gt;_index    = idx;
1845     assert(alias_type(flat) == alias_type(idx), &quot;flat type must work too&quot;);
1846   }
1847 
1848   return alias_type(idx);
1849 }
1850 
1851 
1852 Compile::AliasType* Compile::alias_type(ciField* field) {
1853   const TypeOopPtr* t;
1854   if (field-&gt;is_static())
1855     t = TypeInstPtr::make(field-&gt;holder()-&gt;java_mirror());
1856   else
1857     t = TypeOopPtr::make_from_klass_raw(field-&gt;holder());
1858   AliasType* atp = alias_type(t-&gt;add_offset(field-&gt;offset_in_bytes()), field);
1859   assert((field-&gt;is_final() || field-&gt;is_stable()) == !atp-&gt;is_rewritable(), &quot;must get the rewritable bits correct&quot;);
1860   return atp;
1861 }
1862 
1863 
1864 //------------------------------have_alias_type--------------------------------
1865 bool Compile::have_alias_type(const TypePtr* adr_type) {
1866   AliasCacheEntry* ace = probe_alias_cache(adr_type);
1867   if (ace-&gt;_adr_type == adr_type) {
1868     return true;
1869   }
1870 
1871   // Handle special cases.
1872   if (adr_type == NULL)             return true;
1873   if (adr_type == TypePtr::BOTTOM)  return true;
1874 
1875   return find_alias_type(adr_type, true, NULL) != NULL;
1876 }
1877 
1878 //-----------------------------must_alias--------------------------------------
1879 // True if all values of the given address type are in the given alias category.
1880 bool Compile::must_alias(const TypePtr* adr_type, int alias_idx) {
1881   if (alias_idx == AliasIdxBot)         return true;  // the universal category
1882   if (adr_type == NULL)                 return true;  // NULL serves as TypePtr::TOP
1883   if (alias_idx == AliasIdxTop)         return false; // the empty category
1884   if (adr_type-&gt;base() == Type::AnyPtr) return false; // TypePtr::BOTTOM or its twins
1885 
1886   // the only remaining possible overlap is identity
1887   int adr_idx = get_alias_index(adr_type);
1888   assert(adr_idx != AliasIdxBot &amp;&amp; adr_idx != AliasIdxTop, &quot;&quot;);
1889   assert(adr_idx == alias_idx ||
1890          (alias_type(alias_idx)-&gt;adr_type() != TypeOopPtr::BOTTOM
1891           &amp;&amp; adr_type                       != TypeOopPtr::BOTTOM),
1892          &quot;should not be testing for overlap with an unsafe pointer&quot;);
1893   return adr_idx == alias_idx;
1894 }
1895 
1896 //------------------------------can_alias--------------------------------------
1897 // True if any values of the given address type are in the given alias category.
1898 bool Compile::can_alias(const TypePtr* adr_type, int alias_idx) {
1899   if (alias_idx == AliasIdxTop)         return false; // the empty category
1900   if (adr_type == NULL)                 return false; // NULL serves as TypePtr::TOP
1901   if (alias_idx == AliasIdxBot)         return true;  // the universal category
1902   if (adr_type-&gt;base() == Type::AnyPtr) return true;  // TypePtr::BOTTOM or its twins
1903 
1904   // the only remaining possible overlap is identity
1905   int adr_idx = get_alias_index(adr_type);
1906   assert(adr_idx != AliasIdxBot &amp;&amp; adr_idx != AliasIdxTop, &quot;&quot;);
1907   return adr_idx == alias_idx;
1908 }
1909 
1910 
1911 
1912 //---------------------------pop_warm_call-------------------------------------
1913 WarmCallInfo* Compile::pop_warm_call() {
1914   WarmCallInfo* wci = _warm_calls;
1915   if (wci != NULL)  _warm_calls = wci-&gt;remove_from(wci);
1916   return wci;
1917 }
1918 
1919 //----------------------------Inline_Warm--------------------------------------
1920 int Compile::Inline_Warm() {
1921   // If there is room, try to inline some more warm call sites.
1922   // %%% Do a graph index compaction pass when we think we&#39;re out of space?
1923   if (!InlineWarmCalls)  return 0;
1924 
1925   int calls_made_hot = 0;
1926   int room_to_grow   = NodeCountInliningCutoff - unique();
1927   int amount_to_grow = MIN2(room_to_grow, (int)NodeCountInliningStep);
1928   int amount_grown   = 0;
1929   WarmCallInfo* call;
1930   while (amount_to_grow &gt; 0 &amp;&amp; (call = pop_warm_call()) != NULL) {
1931     int est_size = (int)call-&gt;size();
1932     if (est_size &gt; (room_to_grow - amount_grown)) {
1933       // This one won&#39;t fit anyway.  Get rid of it.
1934       call-&gt;make_cold();
1935       continue;
1936     }
1937     call-&gt;make_hot();
1938     calls_made_hot++;
1939     amount_grown   += est_size;
1940     amount_to_grow -= est_size;
1941   }
1942 
1943   if (calls_made_hot &gt; 0)  set_major_progress();
1944   return calls_made_hot;
1945 }
1946 
1947 
1948 //----------------------------Finish_Warm--------------------------------------
1949 void Compile::Finish_Warm() {
1950   if (!InlineWarmCalls)  return;
1951   if (failing())  return;
1952   if (warm_calls() == NULL)  return;
1953 
1954   // Clean up loose ends, if we are out of space for inlining.
1955   WarmCallInfo* call;
1956   while ((call = pop_warm_call()) != NULL) {
1957     call-&gt;make_cold();
1958   }
1959 }
1960 
1961 //---------------------cleanup_loop_predicates-----------------------
1962 // Remove the opaque nodes that protect the predicates so that all unused
1963 // checks and uncommon_traps will be eliminated from the ideal graph
1964 void Compile::cleanup_loop_predicates(PhaseIterGVN &amp;igvn) {
1965   if (predicate_count()==0) return;
1966   for (int i = predicate_count(); i &gt; 0; i--) {
1967     Node * n = predicate_opaque1_node(i-1);
1968     assert(n-&gt;Opcode() == Op_Opaque1, &quot;must be&quot;);
1969     igvn.replace_node(n, n-&gt;in(1));
1970   }
1971   assert(predicate_count()==0, &quot;should be clean!&quot;);
1972 }
1973 
1974 void Compile::add_range_check_cast(Node* n) {
1975   assert(n-&gt;isa_CastII()-&gt;has_range_check(), &quot;CastII should have range check dependency&quot;);
1976   assert(!_range_check_casts-&gt;contains(n), &quot;duplicate entry in range check casts&quot;);
1977   _range_check_casts-&gt;append(n);
1978 }
1979 
1980 // Remove all range check dependent CastIINodes.
1981 void Compile::remove_range_check_casts(PhaseIterGVN &amp;igvn) {
1982   for (int i = range_check_cast_count(); i &gt; 0; i--) {
1983     Node* cast = range_check_cast_node(i-1);
1984     assert(cast-&gt;isa_CastII()-&gt;has_range_check(), &quot;CastII should have range check dependency&quot;);
1985     igvn.replace_node(cast, cast-&gt;in(1));
1986   }
1987   assert(range_check_cast_count() == 0, &quot;should be empty&quot;);
1988 }
1989 
1990 void Compile::add_opaque4_node(Node* n) {
1991   assert(n-&gt;Opcode() == Op_Opaque4, &quot;Opaque4 only&quot;);
1992   assert(!_opaque4_nodes-&gt;contains(n), &quot;duplicate entry in Opaque4 list&quot;);
1993   _opaque4_nodes-&gt;append(n);
1994 }
1995 
1996 // Remove all Opaque4 nodes.
1997 void Compile::remove_opaque4_nodes(PhaseIterGVN &amp;igvn) {
1998   for (int i = opaque4_count(); i &gt; 0; i--) {
1999     Node* opaq = opaque4_node(i-1);
2000     assert(opaq-&gt;Opcode() == Op_Opaque4, &quot;Opaque4 only&quot;);
2001     igvn.replace_node(opaq, opaq-&gt;in(2));
2002   }
2003   assert(opaque4_count() == 0, &quot;should be empty&quot;);
2004 }
2005 
2006 // StringOpts and late inlining of string methods
2007 void Compile::inline_string_calls(bool parse_time) {
2008   {
2009     // remove useless nodes to make the usage analysis simpler
2010     ResourceMark rm;
2011     PhaseRemoveUseless pru(initial_gvn(), for_igvn());
2012   }
2013 
2014   {
2015     ResourceMark rm;
2016     print_method(PHASE_BEFORE_STRINGOPTS, 3);
2017     PhaseStringOpts pso(initial_gvn(), for_igvn());
2018     print_method(PHASE_AFTER_STRINGOPTS, 3);
2019   }
2020 
2021   // now inline anything that we skipped the first time around
2022   if (!parse_time) {
2023     _late_inlines_pos = _late_inlines.length();
2024   }
2025 
2026   while (_string_late_inlines.length() &gt; 0) {
2027     CallGenerator* cg = _string_late_inlines.pop();
2028     cg-&gt;do_late_inline();
2029     if (failing())  return;
2030   }
2031   _string_late_inlines.trunc_to(0);
2032 }
2033 
2034 // Late inlining of boxing methods
2035 void Compile::inline_boxing_calls(PhaseIterGVN&amp; igvn) {
2036   if (_boxing_late_inlines.length() &gt; 0) {
2037     assert(has_boxed_value(), &quot;inconsistent&quot;);
2038 
2039     PhaseGVN* gvn = initial_gvn();
2040     set_inlining_incrementally(true);
2041 
2042     assert( igvn._worklist.size() == 0, &quot;should be done with igvn&quot; );
2043     for_igvn()-&gt;clear();
2044     gvn-&gt;replace_with(&amp;igvn);
2045 
2046     _late_inlines_pos = _late_inlines.length();
2047 
2048     while (_boxing_late_inlines.length() &gt; 0) {
2049       CallGenerator* cg = _boxing_late_inlines.pop();
2050       cg-&gt;do_late_inline();
2051       if (failing())  return;
2052     }
2053     _boxing_late_inlines.trunc_to(0);
2054 
2055     inline_incrementally_cleanup(igvn);
2056 
2057     set_inlining_incrementally(false);
2058   }
2059 }
2060 
2061 bool Compile::inline_incrementally_one() {
2062   assert(IncrementalInline, &quot;incremental inlining should be on&quot;);
2063 
2064   TracePhase tp(&quot;incrementalInline_inline&quot;, &amp;timers[_t_incrInline_inline]);
2065   set_inlining_progress(false);
2066   set_do_cleanup(false);
2067   int i = 0;
2068   for (; i &lt;_late_inlines.length() &amp;&amp; !inlining_progress(); i++) {
2069     CallGenerator* cg = _late_inlines.at(i);
2070     _late_inlines_pos = i+1;
2071     cg-&gt;do_late_inline();
2072     if (failing())  return false;
2073   }
2074   int j = 0;
2075   for (; i &lt; _late_inlines.length(); i++, j++) {
2076     _late_inlines.at_put(j, _late_inlines.at(i));
2077   }
2078   _late_inlines.trunc_to(j);
2079   assert(inlining_progress() || _late_inlines.length() == 0, &quot;&quot;);
2080 
2081   bool needs_cleanup = do_cleanup() || over_inlining_cutoff();
2082 
2083   set_inlining_progress(false);
2084   set_do_cleanup(false);
2085   return (_late_inlines.length() &gt; 0) &amp;&amp; !needs_cleanup;
2086 }
2087 
2088 void Compile::inline_incrementally_cleanup(PhaseIterGVN&amp; igvn) {
2089   {
2090     TracePhase tp(&quot;incrementalInline_pru&quot;, &amp;timers[_t_incrInline_pru]);
2091     ResourceMark rm;
2092     PhaseRemoveUseless pru(initial_gvn(), for_igvn());
2093   }
2094   {
2095     TracePhase tp(&quot;incrementalInline_igvn&quot;, &amp;timers[_t_incrInline_igvn]);
2096     igvn = PhaseIterGVN(initial_gvn());
2097     igvn.optimize();
2098   }
2099 }
2100 
2101 // Perform incremental inlining until bound on number of live nodes is reached
2102 void Compile::inline_incrementally(PhaseIterGVN&amp; igvn) {
2103   TracePhase tp(&quot;incrementalInline&quot;, &amp;timers[_t_incrInline]);
2104 
2105   set_inlining_incrementally(true);
2106   uint low_live_nodes = 0;
2107 
2108   while (_late_inlines.length() &gt; 0) {
2109     if (live_nodes() &gt; (uint)LiveNodeCountInliningCutoff) {
2110       if (low_live_nodes &lt; (uint)LiveNodeCountInliningCutoff * 8 / 10) {
2111         TracePhase tp(&quot;incrementalInline_ideal&quot;, &amp;timers[_t_incrInline_ideal]);
2112         // PhaseIdealLoop is expensive so we only try it once we are
2113         // out of live nodes and we only try it again if the previous
2114         // helped got the number of nodes down significantly
2115         PhaseIdealLoop::optimize(igvn, LoopOptsNone);
2116         if (failing())  return;
2117         low_live_nodes = live_nodes();
2118         _major_progress = true;
2119       }
2120 
2121       if (live_nodes() &gt; (uint)LiveNodeCountInliningCutoff) {
2122         break; // finish
2123       }
2124     }
2125 
2126     for_igvn()-&gt;clear();
2127     initial_gvn()-&gt;replace_with(&amp;igvn);
2128 
2129     while (inline_incrementally_one()) {
2130       assert(!failing(), &quot;inconsistent&quot;);
2131     }
2132 
2133     if (failing())  return;
2134 
2135     inline_incrementally_cleanup(igvn);
2136 
2137     if (failing())  return;
2138   }
2139   assert( igvn._worklist.size() == 0, &quot;should be done with igvn&quot; );
2140 
2141   if (_string_late_inlines.length() &gt; 0) {
2142     assert(has_stringbuilder(), &quot;inconsistent&quot;);
2143     for_igvn()-&gt;clear();
2144     initial_gvn()-&gt;replace_with(&amp;igvn);
2145 
2146     inline_string_calls(false);
2147 
2148     if (failing())  return;
2149 
2150     inline_incrementally_cleanup(igvn);
2151   }
2152 
2153   set_inlining_incrementally(false);
2154 }
2155 
2156 
2157 bool Compile::optimize_loops(PhaseIterGVN&amp; igvn, LoopOptsMode mode) {
2158   if(_loop_opts_cnt &gt; 0) {
2159     debug_only( int cnt = 0; );
2160     while(major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2161       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2162       assert( cnt++ &lt; 40, &quot;infinite cycle in loop optimization&quot; );
2163       PhaseIdealLoop::optimize(igvn, mode);
2164       _loop_opts_cnt--;
2165       if (failing())  return false;
2166       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP_ITERATIONS, 2);
2167     }
2168   }
2169   return true;
2170 }
2171 
2172 // Remove edges from &quot;root&quot; to each SafePoint at a backward branch.
2173 // They were inserted during parsing (see add_safepoint()) to make
2174 // infinite loops without calls or exceptions visible to root, i.e.,
2175 // useful.
2176 void Compile::remove_root_to_sfpts_edges(PhaseIterGVN&amp; igvn) {
2177   Node *r = root();
2178   if (r != NULL) {
2179     for (uint i = r-&gt;req(); i &lt; r-&gt;len(); ++i) {
2180       Node *n = r-&gt;in(i);
2181       if (n != NULL &amp;&amp; n-&gt;is_SafePoint()) {
2182         r-&gt;rm_prec(i);
2183         if (n-&gt;outcnt() == 0) {
2184           igvn.remove_dead_node(n);
2185         }
2186         --i;
2187       }
2188     }
<a name="20" id="anc20"></a>




2189   }
2190 }
2191 
2192 //------------------------------Optimize---------------------------------------
2193 // Given a graph, optimize it.
2194 void Compile::Optimize() {
2195   TracePhase tp(&quot;optimizer&quot;, &amp;timers[_t_optimizer]);
2196 
2197 #ifndef PRODUCT
2198   if (_directive-&gt;BreakAtCompileOption) {
2199     BREAKPOINT;
2200   }
2201 
2202 #endif
2203 
<a name="21" id="anc21"></a><span class="line-removed">2204 #ifdef ASSERT</span>
2205   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
<a name="22" id="anc22"></a>
2206   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeOptimize);
2207 #endif
2208 
2209   ResourceMark rm;
2210 
2211   print_inlining_reinit();
2212 
2213   NOT_PRODUCT( verify_graph_edges(); )
2214 
2215   print_method(PHASE_AFTER_PARSING);
2216 
2217  {
2218   // Iterative Global Value Numbering, including ideal transforms
2219   // Initialize IterGVN with types and values from parse-time GVN
2220   PhaseIterGVN igvn(initial_gvn());
2221 #ifdef ASSERT
2222   _modified_nodes = new (comp_arena()) Unique_Node_List(comp_arena());
2223 #endif
2224   {
2225     TracePhase tp(&quot;iterGVN&quot;, &amp;timers[_t_iterGVN]);
2226     igvn.optimize();
2227   }
2228 
2229   if (failing())  return;
2230 
2231   print_method(PHASE_ITER_GVN1, 2);
2232 
2233   inline_incrementally(igvn);
2234 
2235   print_method(PHASE_INCREMENTAL_INLINE, 2);
2236 
2237   if (failing())  return;
2238 
2239   if (eliminate_boxing()) {
2240     // Inline valueOf() methods now.
2241     inline_boxing_calls(igvn);
2242 
2243     if (AlwaysIncrementalInline) {
2244       inline_incrementally(igvn);
2245     }
2246 
2247     print_method(PHASE_INCREMENTAL_BOXING_INLINE, 2);
2248 
2249     if (failing())  return;
2250   }
2251 
2252   // Now that all inlining is over, cut edge from root to loop
2253   // safepoints
2254   remove_root_to_sfpts_edges(igvn);
2255 
2256   // Remove the speculative part of types and clean up the graph from
2257   // the extra CastPP nodes whose only purpose is to carry them. Do
2258   // that early so that optimizations are not disrupted by the extra
2259   // CastPP nodes.
2260   remove_speculative_types(igvn);
2261 
2262   // No more new expensive nodes will be added to the list from here
2263   // so keep only the actual candidates for optimizations.
2264   cleanup_expensive_nodes(igvn);
2265 
2266   if (!failing() &amp;&amp; RenumberLiveNodes &amp;&amp; live_nodes() + NodeLimitFudgeFactor &lt; unique()) {
2267     Compile::TracePhase tp(&quot;&quot;, &amp;timers[_t_renumberLive]);
2268     initial_gvn()-&gt;replace_with(&amp;igvn);
2269     for_igvn()-&gt;clear();
2270     Unique_Node_List new_worklist(C-&gt;comp_arena());
2271     {
2272       ResourceMark rm;
2273       PhaseRenumberLive prl = PhaseRenumberLive(initial_gvn(), for_igvn(), &amp;new_worklist);
2274     }
2275     set_for_igvn(&amp;new_worklist);
2276     igvn = PhaseIterGVN(initial_gvn());
2277     igvn.optimize();
2278   }
2279 
2280   // Perform escape analysis
2281   if (_do_escape_analysis &amp;&amp; ConnectionGraph::has_candidates(this)) {
2282     if (has_loops()) {
2283       // Cleanup graph (remove dead nodes).
2284       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
<a name="23" id="anc23"></a><span class="line-modified">2285       PhaseIdealLoop::optimize(igvn, LoopOptsNone);</span>
2286       if (major_progress()) print_method(PHASE_PHASEIDEAL_BEFORE_EA, 2);
2287       if (failing())  return;
2288     }
2289     ConnectionGraph::do_analysis(this, &amp;igvn);
2290 
2291     if (failing())  return;
2292 
2293     // Optimize out fields loads from scalar replaceable allocations.
2294     igvn.optimize();
2295     print_method(PHASE_ITER_GVN_AFTER_EA, 2);
2296 
2297     if (failing())  return;
2298 
2299     if (congraph() != NULL &amp;&amp; macro_count() &gt; 0) {
2300       TracePhase tp(&quot;macroEliminate&quot;, &amp;timers[_t_macroEliminate]);
2301       PhaseMacroExpand mexp(igvn);
2302       mexp.eliminate_macro_nodes();
2303       igvn.set_delay_transform(false);
2304 
2305       igvn.optimize();
2306       print_method(PHASE_ITER_GVN_AFTER_ELIMINATION, 2);
2307 
2308       if (failing())  return;
2309     }
2310   }
2311 
2312   // Loop transforms on the ideal graph.  Range Check Elimination,
2313   // peeling, unrolling, etc.
2314 
2315   // Set loop opts counter
2316   if((_loop_opts_cnt &gt; 0) &amp;&amp; (has_loops() || has_split_ifs())) {
2317     {
2318       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2319       PhaseIdealLoop::optimize(igvn, LoopOptsDefault);
2320       _loop_opts_cnt--;
2321       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP1, 2);
2322       if (failing())  return;
2323     }
2324     // Loop opts pass if partial peeling occurred in previous pass
2325     if(PartialPeelLoop &amp;&amp; major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2326       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2327       PhaseIdealLoop::optimize(igvn, LoopOptsSkipSplitIf);
2328       _loop_opts_cnt--;
2329       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP2, 2);
2330       if (failing())  return;
2331     }
2332     // Loop opts pass for loop-unrolling before CCP
2333     if(major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2334       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2335       PhaseIdealLoop::optimize(igvn, LoopOptsSkipSplitIf);
2336       _loop_opts_cnt--;
2337       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP3, 2);
2338     }
2339     if (!failing()) {
2340       // Verify that last round of loop opts produced a valid graph
2341       TracePhase tp(&quot;idealLoopVerify&quot;, &amp;timers[_t_idealLoopVerify]);
2342       PhaseIdealLoop::verify(igvn);
2343     }
2344   }
2345   if (failing())  return;
2346 
2347   // Conditional Constant Propagation;
2348   PhaseCCP ccp( &amp;igvn );
2349   assert( true, &quot;Break here to ccp.dump_nodes_and_types(_root,999,1)&quot;);
2350   {
2351     TracePhase tp(&quot;ccp&quot;, &amp;timers[_t_ccp]);
2352     ccp.do_transform();
2353   }
2354   print_method(PHASE_CPP1, 2);
2355 
2356   assert( true, &quot;Break here to ccp.dump_old2new_map()&quot;);
2357 
2358   // Iterative Global Value Numbering, including ideal transforms
2359   {
2360     TracePhase tp(&quot;iterGVN2&quot;, &amp;timers[_t_iterGVN2]);
2361     igvn = ccp;
2362     igvn.optimize();
2363   }
<a name="24" id="anc24"></a><span class="line-removed">2364 </span>
2365   print_method(PHASE_ITER_GVN2, 2);
2366 
2367   if (failing())  return;
2368 
2369   // Loop transforms on the ideal graph.  Range Check Elimination,
2370   // peeling, unrolling, etc.
2371   if (!optimize_loops(igvn, LoopOptsDefault)) {
2372     return;
2373   }
2374 
<a name="25" id="anc25"></a><span class="line-removed">2375 #if INCLUDE_ZGC</span>
<span class="line-removed">2376   if (UseZGC) {</span>
<span class="line-removed">2377     ZBarrierSetC2::find_dominating_barriers(igvn);</span>
<span class="line-removed">2378   }</span>
<span class="line-removed">2379 #endif</span>
<span class="line-removed">2380 </span>
2381   if (failing())  return;
2382 
2383   // Ensure that major progress is now clear
2384   C-&gt;clear_major_progress();
2385 
2386   {
2387     // Verify that all previous optimizations produced a valid graph
2388     // at least to this point, even if no loop optimizations were done.
2389     TracePhase tp(&quot;idealLoopVerify&quot;, &amp;timers[_t_idealLoopVerify]);
2390     PhaseIdealLoop::verify(igvn);
2391   }
2392 
2393   if (range_check_cast_count() &gt; 0) {
2394     // No more loop optimizations. Remove all range check dependent CastIINodes.
2395     C-&gt;remove_range_check_casts(igvn);
2396     igvn.optimize();
2397   }
2398 
2399 #ifdef ASSERT
<a name="26" id="anc26"></a><span class="line-modified">2400   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();</span>
<span class="line-removed">2401   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeExpand);</span>
2402 #endif
2403 
2404   {
2405     TracePhase tp(&quot;macroExpand&quot;, &amp;timers[_t_macroExpand]);
2406     PhaseMacroExpand  mex(igvn);
<a name="27" id="anc27"></a><span class="line-removed">2407     print_method(PHASE_BEFORE_MACRO_EXPANSION, 2);</span>
2408     if (mex.expand_macro_nodes()) {
2409       assert(failing(), &quot;must bail out w/ explicit message&quot;);
2410       return;
2411     }
<a name="28" id="anc28"></a>
2412   }
2413 
2414   {
2415     TracePhase tp(&quot;barrierExpand&quot;, &amp;timers[_t_barrierExpand]);
<a name="29" id="anc29"></a><span class="line-removed">2416     print_method(PHASE_BEFORE_BARRIER_EXPAND, 2);</span>
<span class="line-removed">2417     BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();</span>
2418     if (bs-&gt;expand_barriers(this, igvn)) {
2419       assert(failing(), &quot;must bail out w/ explicit message&quot;);
2420       return;
2421     }
<a name="30" id="anc30"></a>
2422   }
2423 
2424   if (opaque4_count() &gt; 0) {
2425     C-&gt;remove_opaque4_nodes(igvn);
2426     igvn.optimize();
2427   }
2428 
2429   DEBUG_ONLY( _modified_nodes = NULL; )
2430  } // (End scope of igvn; run destructor if necessary for asserts.)
2431 
2432  process_print_inlining();
2433  // A method with only infinite loops has no edges entering loops from root
2434  {
2435    TracePhase tp(&quot;graphReshape&quot;, &amp;timers[_t_graphReshaping]);
2436    if (final_graph_reshaping()) {
2437      assert(failing(), &quot;must bail out w/ explicit message&quot;);
2438      return;
2439    }
2440  }
2441 
2442  print_method(PHASE_OPTIMIZE_FINISHED, 2);
2443 }
2444 
2445 
2446 //------------------------------Code_Gen---------------------------------------
2447 // Given a graph, generate code for it
2448 void Compile::Code_Gen() {
2449   if (failing()) {
2450     return;
2451   }
2452 
2453   // Perform instruction selection.  You might think we could reclaim Matcher
2454   // memory PDQ, but actually the Matcher is used in generating spill code.
2455   // Internals of the Matcher (including some VectorSets) must remain live
2456   // for awhile - thus I cannot reclaim Matcher memory lest a VectorSet usage
2457   // set a bit in reclaimed memory.
2458 
2459   // In debug mode can dump m._nodes.dump() for mapping of ideal to machine
2460   // nodes.  Mapping is only valid at the root of each matched subtree.
2461   NOT_PRODUCT( verify_graph_edges(); )
2462 
2463   Matcher matcher;
2464   _matcher = &amp;matcher;
2465   {
2466     TracePhase tp(&quot;matcher&quot;, &amp;timers[_t_matcher]);
2467     matcher.match();
<a name="31" id="anc31"></a>


2468   }
<a name="32" id="anc32"></a>
2469   // In debug mode can dump m._nodes.dump() for mapping of ideal to machine
2470   // nodes.  Mapping is only valid at the root of each matched subtree.
2471   NOT_PRODUCT( verify_graph_edges(); )
2472 
2473   // If you have too many nodes, or if matching has failed, bail out
2474   check_node_count(0, &quot;out of nodes matching instructions&quot;);
2475   if (failing()) {
2476     return;
2477   }
2478 
2479   print_method(PHASE_MATCHING, 2);
2480 
2481   // Build a proper-looking CFG
2482   PhaseCFG cfg(node_arena(), root(), matcher);
2483   _cfg = &amp;cfg;
2484   {
2485     TracePhase tp(&quot;scheduler&quot;, &amp;timers[_t_scheduler]);
2486     bool success = cfg.do_global_code_motion();
2487     if (!success) {
2488       return;
2489     }
2490 
2491     print_method(PHASE_GLOBAL_CODE_MOTION, 2);
2492     NOT_PRODUCT( verify_graph_edges(); )
2493     debug_only( cfg.verify(); )
2494   }
2495 
2496   PhaseChaitin regalloc(unique(), cfg, matcher, false);
2497   _regalloc = &amp;regalloc;
2498   {
2499     TracePhase tp(&quot;regalloc&quot;, &amp;timers[_t_registerAllocation]);
2500     // Perform register allocation.  After Chaitin, use-def chains are
2501     // no longer accurate (at spill code) and so must be ignored.
2502     // Node-&gt;LRG-&gt;reg mappings are still accurate.
2503     _regalloc-&gt;Register_Allocate();
2504 
2505     // Bail out if the allocator builds too many nodes
2506     if (failing()) {
2507       return;
2508     }
2509   }
2510 
2511   // Prior to register allocation we kept empty basic blocks in case the
2512   // the allocator needed a place to spill.  After register allocation we
2513   // are not adding any new instructions.  If any basic block is empty, we
2514   // can now safely remove it.
2515   {
2516     TracePhase tp(&quot;blockOrdering&quot;, &amp;timers[_t_blockOrdering]);
2517     cfg.remove_empty_blocks();
2518     if (do_freq_based_layout()) {
2519       PhaseBlockLayout layout(cfg);
2520     } else {
2521       cfg.set_loop_alignment();
2522     }
2523     cfg.fixup_flow();
2524   }
2525 
2526   // Apply peephole optimizations
2527   if( OptoPeephole ) {
2528     TracePhase tp(&quot;peephole&quot;, &amp;timers[_t_peephole]);
2529     PhasePeephole peep( _regalloc, cfg);
2530     peep.do_transform();
2531   }
2532 
2533   // Do late expand if CPU requires this.
2534   if (Matcher::require_postalloc_expand) {
2535     TracePhase tp(&quot;postalloc_expand&quot;, &amp;timers[_t_postalloc_expand]);
2536     cfg.postalloc_expand(_regalloc);
2537   }
2538 
2539   // Convert Nodes to instruction bits in a buffer
2540   {
2541     TraceTime tp(&quot;output&quot;, &amp;timers[_t_output], CITime);
2542     Output();
2543   }
2544 
2545   print_method(PHASE_FINAL_CODE);
2546 
2547   // He&#39;s dead, Jim.
2548   _cfg     = (PhaseCFG*)((intptr_t)0xdeadbeef);
2549   _regalloc = (PhaseChaitin*)((intptr_t)0xdeadbeef);
2550 }
2551 
2552 
2553 //------------------------------dump_asm---------------------------------------
2554 // Dump formatted assembly
<a name="33" id="anc33"></a><span class="line-modified">2555 #ifndef PRODUCT</span>
<span class="line-modified">2556 void Compile::dump_asm(int *pcs, uint pc_limit) {</span>













2557   bool cut_short = false;
<a name="34" id="anc34"></a><span class="line-modified">2558   tty-&gt;print_cr(&quot;#&quot;);</span>
<span class="line-modified">2559   tty-&gt;print(&quot;#  &quot;);  _tf-&gt;dump();  tty-&gt;cr();</span>
<span class="line-modified">2560   tty-&gt;print_cr(&quot;#&quot;);</span>
2561 
2562   // For all blocks
2563   int pc = 0x0;                 // Program counter
2564   char starts_bundle = &#39; &#39;;
2565   _regalloc-&gt;dump_frame();
2566 
2567   Node *n = NULL;
2568   for (uint i = 0; i &lt; _cfg-&gt;number_of_blocks(); i++) {
2569     if (VMThread::should_terminate()) {
2570       cut_short = true;
2571       break;
2572     }
2573     Block* block = _cfg-&gt;get_block(i);
2574     if (block-&gt;is_connector() &amp;&amp; !Verbose) {
2575       continue;
2576     }
2577     n = block-&gt;head();
<a name="35" id="anc35"></a><span class="line-modified">2578     if (pcs &amp;&amp; n-&gt;_idx &lt; pc_limit) {</span>
<span class="line-modified">2579       tty-&gt;print(&quot;%3.3x   &quot;, pcs[n-&gt;_idx]);</span>
<span class="line-modified">2580     } else {</span>
<span class="line-removed">2581       tty-&gt;print(&quot;      &quot;);</span>
2582     }
<a name="36" id="anc36"></a><span class="line-modified">2583     block-&gt;dump_head(_cfg);</span>

2584     if (block-&gt;is_connector()) {
<a name="37" id="anc37"></a><span class="line-modified">2585       tty-&gt;print_cr(&quot;        # Empty connector block&quot;);</span>

2586     } else if (block-&gt;num_preds() == 2 &amp;&amp; block-&gt;pred(1)-&gt;is_CatchProj() &amp;&amp; block-&gt;pred(1)-&gt;as_CatchProj()-&gt;_con == CatchProjNode::fall_through_index) {
<a name="38" id="anc38"></a><span class="line-modified">2587       tty-&gt;print_cr(&quot;        # Block is sole successor of call&quot;);</span>

2588     }
2589 
2590     // For all instructions
2591     Node *delay = NULL;
2592     for (uint j = 0; j &lt; block-&gt;number_of_nodes(); j++) {
2593       if (VMThread::should_terminate()) {
2594         cut_short = true;
2595         break;
2596       }
2597       n = block-&gt;get_node(j);
2598       if (valid_bundle_info(n)) {
2599         Bundle* bundle = node_bundling(n);
2600         if (bundle-&gt;used_in_unconditional_delay()) {
2601           delay = n;
2602           continue;
2603         }
2604         if (bundle-&gt;starts_bundle()) {
2605           starts_bundle = &#39;+&#39;;
2606         }
2607       }
2608 
2609       if (WizardMode) {
2610         n-&gt;dump();
2611       }
2612 
2613       if( !n-&gt;is_Region() &amp;&amp;    // Dont print in the Assembly
2614           !n-&gt;is_Phi() &amp;&amp;       // a few noisely useless nodes
2615           !n-&gt;is_Proj() &amp;&amp;
2616           !n-&gt;is_MachTemp() &amp;&amp;
2617           !n-&gt;is_SafePointScalarObject() &amp;&amp;
2618           !n-&gt;is_Catch() &amp;&amp;     // Would be nice to print exception table targets
2619           !n-&gt;is_MergeMem() &amp;&amp;  // Not very interesting
2620           !n-&gt;is_top() &amp;&amp;       // Debug info table constants
2621           !(n-&gt;is_Con() &amp;&amp; !n-&gt;is_Mach())// Debug info table constants
2622           ) {
<a name="39" id="anc39"></a><span class="line-modified">2623         if (pcs &amp;&amp; n-&gt;_idx &lt; pc_limit)</span>
<span class="line-modified">2624           tty-&gt;print(&quot;%3.3x&quot;, pcs[n-&gt;_idx]);</span>
<span class="line-modified">2625         else</span>
<span class="line-modified">2626           tty-&gt;print(&quot;   &quot;);</span>
<span class="line-modified">2627         tty-&gt;print(&quot; %c &quot;, starts_bundle);</span>


2628         starts_bundle = &#39; &#39;;
<a name="40" id="anc40"></a><span class="line-modified">2629         tty-&gt;print(&quot;\t&quot;);</span>
<span class="line-modified">2630         n-&gt;format(_regalloc, tty);</span>
<span class="line-modified">2631         tty-&gt;cr();</span>
2632       }
2633 
2634       // If we have an instruction with a delay slot, and have seen a delay,
2635       // then back up and print it
2636       if (valid_bundle_info(n) &amp;&amp; node_bundling(n)-&gt;use_unconditional_delay()) {
<a name="41" id="anc41"></a><span class="line-modified">2637         assert(delay != NULL, &quot;no unconditional delay instruction&quot;);</span>

2638         if (WizardMode) delay-&gt;dump();
2639 
2640         if (node_bundling(delay)-&gt;starts_bundle())
2641           starts_bundle = &#39;+&#39;;
<a name="42" id="anc42"></a><span class="line-modified">2642         if (pcs &amp;&amp; n-&gt;_idx &lt; pc_limit)</span>
<span class="line-modified">2643           tty-&gt;print(&quot;%3.3x&quot;, pcs[n-&gt;_idx]);</span>
<span class="line-modified">2644         else</span>
<span class="line-modified">2645           tty-&gt;print(&quot;   &quot;);</span>
<span class="line-modified">2646         tty-&gt;print(&quot; %c &quot;, starts_bundle);</span>


2647         starts_bundle = &#39; &#39;;
<a name="43" id="anc43"></a><span class="line-modified">2648         tty-&gt;print(&quot;\t&quot;);</span>
<span class="line-modified">2649         delay-&gt;format(_regalloc, tty);</span>
<span class="line-modified">2650         tty-&gt;cr();</span>
2651         delay = NULL;
2652       }
2653 
2654       // Dump the exception table as well
2655       if( n-&gt;is_Catch() &amp;&amp; (Verbose || WizardMode) ) {
2656         // Print the exception table for this offset
2657         _handler_table.print_subtable_for(pc);
2658       }
<a name="44" id="anc44"></a>
2659     }
<a name="45" id="anc45"></a><span class="line-modified">2660 </span>
<span class="line-removed">2661     if (pcs &amp;&amp; n-&gt;_idx &lt; pc_limit)</span>
<span class="line-removed">2662       tty-&gt;print_cr(&quot;%3.3x&quot;, pcs[n-&gt;_idx]);</span>
<span class="line-removed">2663     else</span>
<span class="line-removed">2664       tty-&gt;cr();</span>
<span class="line-removed">2665 </span>
2666     assert(cut_short || delay == NULL, &quot;no unconditional delay branch&quot;);
<a name="46" id="anc46"></a><span class="line-removed">2667 </span>
2668   } // End of per-block dump
<a name="47" id="anc47"></a><span class="line-removed">2669   tty-&gt;cr();</span>
2670 
<a name="48" id="anc48"></a><span class="line-modified">2671   if (cut_short)  tty-&gt;print_cr(&quot;*** disassembly is cut short ***&quot;);</span>
2672 }
2673 #endif
2674 
2675 //------------------------------Final_Reshape_Counts---------------------------
2676 // This class defines counters to help identify when a method
2677 // may/must be executed using hardware with only 24-bit precision.
2678 struct Final_Reshape_Counts : public StackObj {
2679   int  _call_count;             // count non-inlined &#39;common&#39; calls
2680   int  _float_count;            // count float ops requiring 24-bit precision
2681   int  _double_count;           // count double ops requiring more precision
2682   int  _java_call_count;        // count non-inlined &#39;java&#39; calls
2683   int  _inner_loop_count;       // count loops which need alignment
2684   VectorSet _visited;           // Visitation flags
2685   Node_List _tests;             // Set of IfNodes &amp; PCTableNodes
2686 
2687   Final_Reshape_Counts() :
2688     _call_count(0), _float_count(0), _double_count(0),
2689     _java_call_count(0), _inner_loop_count(0),
2690     _visited( Thread::current()-&gt;resource_area() ) { }
2691 
2692   void inc_call_count  () { _call_count  ++; }
2693   void inc_float_count () { _float_count ++; }
2694   void inc_double_count() { _double_count++; }
2695   void inc_java_call_count() { _java_call_count++; }
2696   void inc_inner_loop_count() { _inner_loop_count++; }
2697 
2698   int  get_call_count  () const { return _call_count  ; }
2699   int  get_float_count () const { return _float_count ; }
2700   int  get_double_count() const { return _double_count; }
2701   int  get_java_call_count() const { return _java_call_count; }
2702   int  get_inner_loop_count() const { return _inner_loop_count; }
2703 };
2704 
2705 #ifdef ASSERT
2706 static bool oop_offset_is_sane(const TypeInstPtr* tp) {
2707   ciInstanceKlass *k = tp-&gt;klass()-&gt;as_instance_klass();
2708   // Make sure the offset goes inside the instance layout.
2709   return k-&gt;contains_field_offset(tp-&gt;offset());
2710   // Note that OffsetBot and OffsetTop are very negative.
2711 }
2712 #endif
2713 
2714 // Eliminate trivially redundant StoreCMs and accumulate their
2715 // precedence edges.
2716 void Compile::eliminate_redundant_card_marks(Node* n) {
2717   assert(n-&gt;Opcode() == Op_StoreCM, &quot;expected StoreCM&quot;);
2718   if (n-&gt;in(MemNode::Address)-&gt;outcnt() &gt; 1) {
2719     // There are multiple users of the same address so it might be
2720     // possible to eliminate some of the StoreCMs
2721     Node* mem = n-&gt;in(MemNode::Memory);
2722     Node* adr = n-&gt;in(MemNode::Address);
2723     Node* val = n-&gt;in(MemNode::ValueIn);
2724     Node* prev = n;
2725     bool done = false;
2726     // Walk the chain of StoreCMs eliminating ones that match.  As
2727     // long as it&#39;s a chain of single users then the optimization is
2728     // safe.  Eliminating partially redundant StoreCMs would require
2729     // cloning copies down the other paths.
2730     while (mem-&gt;Opcode() == Op_StoreCM &amp;&amp; mem-&gt;outcnt() == 1 &amp;&amp; !done) {
2731       if (adr == mem-&gt;in(MemNode::Address) &amp;&amp;
2732           val == mem-&gt;in(MemNode::ValueIn)) {
2733         // redundant StoreCM
2734         if (mem-&gt;req() &gt; MemNode::OopStore) {
2735           // Hasn&#39;t been processed by this code yet.
2736           n-&gt;add_prec(mem-&gt;in(MemNode::OopStore));
2737         } else {
2738           // Already converted to precedence edge
2739           for (uint i = mem-&gt;req(); i &lt; mem-&gt;len(); i++) {
2740             // Accumulate any precedence edges
2741             if (mem-&gt;in(i) != NULL) {
2742               n-&gt;add_prec(mem-&gt;in(i));
2743             }
2744           }
2745           // Everything above this point has been processed.
2746           done = true;
2747         }
2748         // Eliminate the previous StoreCM
2749         prev-&gt;set_req(MemNode::Memory, mem-&gt;in(MemNode::Memory));
2750         assert(mem-&gt;outcnt() == 0, &quot;should be dead&quot;);
2751         mem-&gt;disconnect_inputs(NULL, this);
2752       } else {
2753         prev = mem;
2754       }
2755       mem = prev-&gt;in(MemNode::Memory);
2756     }
2757   }
2758 }
2759 
2760 //------------------------------final_graph_reshaping_impl----------------------
2761 // Implement items 1-5 from final_graph_reshaping below.
2762 void Compile::final_graph_reshaping_impl( Node *n, Final_Reshape_Counts &amp;frc) {
2763 
2764   if ( n-&gt;outcnt() == 0 ) return; // dead node
2765   uint nop = n-&gt;Opcode();
2766 
2767   // Check for 2-input instruction with &quot;last use&quot; on right input.
2768   // Swap to left input.  Implements item (2).
2769   if( n-&gt;req() == 3 &amp;&amp;          // two-input instruction
2770       n-&gt;in(1)-&gt;outcnt() &gt; 1 &amp;&amp; // left use is NOT a last use
2771       (!n-&gt;in(1)-&gt;is_Phi() || n-&gt;in(1)-&gt;in(2) != n) &amp;&amp; // it is not data loop
2772       n-&gt;in(2)-&gt;outcnt() == 1 &amp;&amp;// right use IS a last use
2773       !n-&gt;in(2)-&gt;is_Con() ) {   // right use is not a constant
2774     // Check for commutative opcode
2775     switch( nop ) {
2776     case Op_AddI:  case Op_AddF:  case Op_AddD:  case Op_AddL:
2777     case Op_MaxI:  case Op_MinI:
2778     case Op_MulI:  case Op_MulF:  case Op_MulD:  case Op_MulL:
2779     case Op_AndL:  case Op_XorL:  case Op_OrL:
2780     case Op_AndI:  case Op_XorI:  case Op_OrI: {
2781       // Move &quot;last use&quot; input to left by swapping inputs
2782       n-&gt;swap_edges(1, 2);
2783       break;
2784     }
2785     default:
2786       break;
2787     }
2788   }
2789 
2790 #ifdef ASSERT
2791   if( n-&gt;is_Mem() ) {
2792     int alias_idx = get_alias_index(n-&gt;as_Mem()-&gt;adr_type());
2793     assert( n-&gt;in(0) != NULL || alias_idx != Compile::AliasIdxRaw ||
2794             // oop will be recorded in oop map if load crosses safepoint
2795             n-&gt;is_Load() &amp;&amp; (n-&gt;as_Load()-&gt;bottom_type()-&gt;isa_oopptr() ||
2796                              LoadNode::is_immutable_value(n-&gt;in(MemNode::Address))),
2797             &quot;raw memory operations should have control edge&quot;);
2798   }
2799   if (n-&gt;is_MemBar()) {
2800     MemBarNode* mb = n-&gt;as_MemBar();
2801     if (mb-&gt;trailing_store() || mb-&gt;trailing_load_store()) {
2802       assert(mb-&gt;leading_membar()-&gt;trailing_membar() == mb, &quot;bad membar pair&quot;);
<a name="49" id="anc49"></a><span class="line-modified">2803       Node* mem = mb-&gt;in(MemBarNode::Precedent);</span>
2804       assert((mb-&gt;trailing_store() &amp;&amp; mem-&gt;is_Store() &amp;&amp; mem-&gt;as_Store()-&gt;is_release()) ||
2805              (mb-&gt;trailing_load_store() &amp;&amp; mem-&gt;is_LoadStore()), &quot;missing mem op&quot;);
2806     } else if (mb-&gt;leading()) {
2807       assert(mb-&gt;trailing_membar()-&gt;leading_membar() == mb, &quot;bad membar pair&quot;);
2808     }
2809   }
2810 #endif
2811   // Count FPU ops and common calls, implements item (3)
2812   bool gc_handled = BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;final_graph_reshaping(this, n, nop);
2813   if (!gc_handled) {
2814     final_graph_reshaping_main_switch(n, frc, nop);
2815   }
2816 
2817   // Collect CFG split points
2818   if (n-&gt;is_MultiBranch() &amp;&amp; !n-&gt;is_RangeCheck()) {
2819     frc._tests.push(n);
2820   }
2821 }
2822 
2823 void Compile::final_graph_reshaping_main_switch(Node* n, Final_Reshape_Counts&amp; frc, uint nop) {
2824   switch( nop ) {
2825   // Count all float operations that may use FPU
2826   case Op_AddF:
2827   case Op_SubF:
2828   case Op_MulF:
2829   case Op_DivF:
2830   case Op_NegF:
2831   case Op_ModF:
2832   case Op_ConvI2F:
2833   case Op_ConF:
2834   case Op_CmpF:
2835   case Op_CmpF3:
2836   // case Op_ConvL2F: // longs are split into 32-bit halves
2837     frc.inc_float_count();
2838     break;
2839 
2840   case Op_ConvF2D:
2841   case Op_ConvD2F:
2842     frc.inc_float_count();
2843     frc.inc_double_count();
2844     break;
2845 
2846   // Count all double operations that may use FPU
2847   case Op_AddD:
2848   case Op_SubD:
2849   case Op_MulD:
2850   case Op_DivD:
2851   case Op_NegD:
2852   case Op_ModD:
2853   case Op_ConvI2D:
2854   case Op_ConvD2I:
2855   // case Op_ConvL2D: // handled by leaf call
2856   // case Op_ConvD2L: // handled by leaf call
2857   case Op_ConD:
2858   case Op_CmpD:
2859   case Op_CmpD3:
2860     frc.inc_double_count();
2861     break;
2862   case Op_Opaque1:              // Remove Opaque Nodes before matching
2863   case Op_Opaque2:              // Remove Opaque Nodes before matching
2864   case Op_Opaque3:
2865     n-&gt;subsume_by(n-&gt;in(1), this);
2866     break;
2867   case Op_CallStaticJava:
2868   case Op_CallJava:
2869   case Op_CallDynamicJava:
2870     frc.inc_java_call_count(); // Count java call site;
2871   case Op_CallRuntime:
2872   case Op_CallLeaf:
2873   case Op_CallLeafNoFP: {
2874     assert (n-&gt;is_Call(), &quot;&quot;);
2875     CallNode *call = n-&gt;as_Call();
2876     // Count call sites where the FP mode bit would have to be flipped.
2877     // Do not count uncommon runtime calls:
2878     // uncommon_trap, _complete_monitor_locking, _complete_monitor_unlocking,
2879     // _new_Java, _new_typeArray, _new_objArray, _rethrow_Java, ...
2880     if (!call-&gt;is_CallStaticJava() || !call-&gt;as_CallStaticJava()-&gt;_name) {
2881       frc.inc_call_count();   // Count the call site
2882     } else {                  // See if uncommon argument is shared
2883       Node *n = call-&gt;in(TypeFunc::Parms);
2884       int nop = n-&gt;Opcode();
2885       // Clone shared simple arguments to uncommon calls, item (1).
2886       if (n-&gt;outcnt() &gt; 1 &amp;&amp;
2887           !n-&gt;is_Proj() &amp;&amp;
2888           nop != Op_CreateEx &amp;&amp;
2889           nop != Op_CheckCastPP &amp;&amp;
2890           nop != Op_DecodeN &amp;&amp;
2891           nop != Op_DecodeNKlass &amp;&amp;
2892           !n-&gt;is_Mem() &amp;&amp;
2893           !n-&gt;is_Phi()) {
2894         Node *x = n-&gt;clone();
2895         call-&gt;set_req(TypeFunc::Parms, x);
2896       }
2897     }
2898     break;
2899   }
2900 
2901   case Op_StoreD:
2902   case Op_LoadD:
2903   case Op_LoadD_unaligned:
2904     frc.inc_double_count();
2905     goto handle_mem;
2906   case Op_StoreF:
2907   case Op_LoadF:
2908     frc.inc_float_count();
2909     goto handle_mem;
2910 
2911   case Op_StoreCM:
2912     {
2913       // Convert OopStore dependence into precedence edge
2914       Node* prec = n-&gt;in(MemNode::OopStore);
2915       n-&gt;del_req(MemNode::OopStore);
2916       n-&gt;add_prec(prec);
2917       eliminate_redundant_card_marks(n);
2918     }
2919 
2920     // fall through
2921 
2922   case Op_StoreB:
2923   case Op_StoreC:
2924   case Op_StorePConditional:
2925   case Op_StoreI:
2926   case Op_StoreL:
2927   case Op_StoreIConditional:
2928   case Op_StoreLConditional:
2929   case Op_CompareAndSwapB:
2930   case Op_CompareAndSwapS:
2931   case Op_CompareAndSwapI:
2932   case Op_CompareAndSwapL:
2933   case Op_CompareAndSwapP:
2934   case Op_CompareAndSwapN:
2935   case Op_WeakCompareAndSwapB:
2936   case Op_WeakCompareAndSwapS:
2937   case Op_WeakCompareAndSwapI:
2938   case Op_WeakCompareAndSwapL:
2939   case Op_WeakCompareAndSwapP:
2940   case Op_WeakCompareAndSwapN:
2941   case Op_CompareAndExchangeB:
2942   case Op_CompareAndExchangeS:
2943   case Op_CompareAndExchangeI:
2944   case Op_CompareAndExchangeL:
2945   case Op_CompareAndExchangeP:
2946   case Op_CompareAndExchangeN:
2947   case Op_GetAndAddS:
2948   case Op_GetAndAddB:
2949   case Op_GetAndAddI:
2950   case Op_GetAndAddL:
2951   case Op_GetAndSetS:
2952   case Op_GetAndSetB:
2953   case Op_GetAndSetI:
2954   case Op_GetAndSetL:
2955   case Op_GetAndSetP:
2956   case Op_GetAndSetN:
2957   case Op_StoreP:
2958   case Op_StoreN:
2959   case Op_StoreNKlass:
2960   case Op_LoadB:
2961   case Op_LoadUB:
2962   case Op_LoadUS:
2963   case Op_LoadI:
2964   case Op_LoadKlass:
2965   case Op_LoadNKlass:
2966   case Op_LoadL:
2967   case Op_LoadL_unaligned:
2968   case Op_LoadPLocked:
2969   case Op_LoadP:
2970   case Op_LoadN:
2971   case Op_LoadRange:
2972   case Op_LoadS: {
2973   handle_mem:
2974 #ifdef ASSERT
2975     if( VerifyOptoOopOffsets ) {
2976       MemNode* mem  = n-&gt;as_Mem();
2977       // Check to see if address types have grounded out somehow.
2978       const TypeInstPtr *tp = mem-&gt;in(MemNode::Address)-&gt;bottom_type()-&gt;isa_instptr();
2979       assert( !tp || oop_offset_is_sane(tp), &quot;&quot; );
2980     }
2981 #endif
2982     break;
2983   }
2984 
2985   case Op_AddP: {               // Assert sane base pointers
2986     Node *addp = n-&gt;in(AddPNode::Address);
2987     assert( !addp-&gt;is_AddP() ||
2988             addp-&gt;in(AddPNode::Base)-&gt;is_top() || // Top OK for allocation
2989             addp-&gt;in(AddPNode::Base) == n-&gt;in(AddPNode::Base),
2990             &quot;Base pointers must match (addp %u)&quot;, addp-&gt;_idx );
2991 #ifdef _LP64
2992     if ((UseCompressedOops || UseCompressedClassPointers) &amp;&amp;
2993         addp-&gt;Opcode() == Op_ConP &amp;&amp;
2994         addp == n-&gt;in(AddPNode::Base) &amp;&amp;
2995         n-&gt;in(AddPNode::Offset)-&gt;is_Con()) {
2996       // If the transformation of ConP to ConN+DecodeN is beneficial depends
2997       // on the platform and on the compressed oops mode.
2998       // Use addressing with narrow klass to load with offset on x86.
2999       // Some platforms can use the constant pool to load ConP.
3000       // Do this transformation here since IGVN will convert ConN back to ConP.
3001       const Type* t = addp-&gt;bottom_type();
3002       bool is_oop   = t-&gt;isa_oopptr() != NULL;
3003       bool is_klass = t-&gt;isa_klassptr() != NULL;
3004 
3005       if ((is_oop   &amp;&amp; Matcher::const_oop_prefer_decode()  ) ||
3006           (is_klass &amp;&amp; Matcher::const_klass_prefer_decode())) {
3007         Node* nn = NULL;
3008 
3009         int op = is_oop ? Op_ConN : Op_ConNKlass;
3010 
3011         // Look for existing ConN node of the same exact type.
3012         Node* r  = root();
3013         uint cnt = r-&gt;outcnt();
3014         for (uint i = 0; i &lt; cnt; i++) {
3015           Node* m = r-&gt;raw_out(i);
3016           if (m!= NULL &amp;&amp; m-&gt;Opcode() == op &amp;&amp;
3017               m-&gt;bottom_type()-&gt;make_ptr() == t) {
3018             nn = m;
3019             break;
3020           }
3021         }
3022         if (nn != NULL) {
3023           // Decode a narrow oop to match address
3024           // [R12 + narrow_oop_reg&lt;&lt;3 + offset]
3025           if (is_oop) {
3026             nn = new DecodeNNode(nn, t);
3027           } else {
3028             nn = new DecodeNKlassNode(nn, t);
3029           }
3030           // Check for succeeding AddP which uses the same Base.
3031           // Otherwise we will run into the assertion above when visiting that guy.
3032           for (uint i = 0; i &lt; n-&gt;outcnt(); ++i) {
3033             Node *out_i = n-&gt;raw_out(i);
3034             if (out_i &amp;&amp; out_i-&gt;is_AddP() &amp;&amp; out_i-&gt;in(AddPNode::Base) == addp) {
3035               out_i-&gt;set_req(AddPNode::Base, nn);
3036 #ifdef ASSERT
3037               for (uint j = 0; j &lt; out_i-&gt;outcnt(); ++j) {
3038                 Node *out_j = out_i-&gt;raw_out(j);
3039                 assert(out_j == NULL || !out_j-&gt;is_AddP() || out_j-&gt;in(AddPNode::Base) != addp,
3040                        &quot;more than 2 AddP nodes in a chain (out_j %u)&quot;, out_j-&gt;_idx);
3041               }
3042 #endif
3043             }
3044           }
3045           n-&gt;set_req(AddPNode::Base, nn);
3046           n-&gt;set_req(AddPNode::Address, nn);
3047           if (addp-&gt;outcnt() == 0) {
3048             addp-&gt;disconnect_inputs(NULL, this);
3049           }
3050         }
3051       }
3052     }
3053 #endif
3054     // platform dependent reshaping of the address expression
3055     reshape_address(n-&gt;as_AddP());
3056     break;
3057   }
3058 
3059   case Op_CastPP: {
3060     // Remove CastPP nodes to gain more freedom during scheduling but
3061     // keep the dependency they encode as control or precedence edges
3062     // (if control is set already) on memory operations. Some CastPP
3063     // nodes don&#39;t have a control (don&#39;t carry a dependency): skip
3064     // those.
3065     if (n-&gt;in(0) != NULL) {
3066       ResourceMark rm;
3067       Unique_Node_List wq;
3068       wq.push(n);
3069       for (uint next = 0; next &lt; wq.size(); ++next) {
3070         Node *m = wq.at(next);
3071         for (DUIterator_Fast imax, i = m-&gt;fast_outs(imax); i &lt; imax; i++) {
3072           Node* use = m-&gt;fast_out(i);
<a name="50" id="anc50"></a><span class="line-modified">3073           if (use-&gt;is_Mem() || use-&gt;is_EncodeNarrowPtr() || use-&gt;is_ShenandoahBarrier()) {</span>
3074             use-&gt;ensure_control_or_add_prec(n-&gt;in(0));
3075           } else {
3076             switch(use-&gt;Opcode()) {
3077             case Op_AddP:
3078             case Op_DecodeN:
3079             case Op_DecodeNKlass:
3080             case Op_CheckCastPP:
3081             case Op_CastPP:
3082               wq.push(use);
3083               break;
3084             }
3085           }
3086         }
3087       }
3088     }
3089     const bool is_LP64 = LP64_ONLY(true) NOT_LP64(false);
3090     if (is_LP64 &amp;&amp; n-&gt;in(1)-&gt;is_DecodeN() &amp;&amp; Matcher::gen_narrow_oop_implicit_null_checks()) {
3091       Node* in1 = n-&gt;in(1);
3092       const Type* t = n-&gt;bottom_type();
3093       Node* new_in1 = in1-&gt;clone();
3094       new_in1-&gt;as_DecodeN()-&gt;set_type(t);
3095 
3096       if (!Matcher::narrow_oop_use_complex_address()) {
3097         //
3098         // x86, ARM and friends can handle 2 adds in addressing mode
3099         // and Matcher can fold a DecodeN node into address by using
3100         // a narrow oop directly and do implicit NULL check in address:
3101         //
3102         // [R12 + narrow_oop_reg&lt;&lt;3 + offset]
3103         // NullCheck narrow_oop_reg
3104         //
3105         // On other platforms (Sparc) we have to keep new DecodeN node and
3106         // use it to do implicit NULL check in address:
3107         //
3108         // decode_not_null narrow_oop_reg, base_reg
3109         // [base_reg + offset]
3110         // NullCheck base_reg
3111         //
3112         // Pin the new DecodeN node to non-null path on these platform (Sparc)
3113         // to keep the information to which NULL check the new DecodeN node
3114         // corresponds to use it as value in implicit_null_check().
3115         //
3116         new_in1-&gt;set_req(0, n-&gt;in(0));
3117       }
3118 
3119       n-&gt;subsume_by(new_in1, this);
3120       if (in1-&gt;outcnt() == 0) {
3121         in1-&gt;disconnect_inputs(NULL, this);
3122       }
3123     } else {
3124       n-&gt;subsume_by(n-&gt;in(1), this);
3125       if (n-&gt;outcnt() == 0) {
3126         n-&gt;disconnect_inputs(NULL, this);
3127       }
3128     }
3129     break;
3130   }
3131 #ifdef _LP64
3132   case Op_CmpP:
3133     // Do this transformation here to preserve CmpPNode::sub() and
3134     // other TypePtr related Ideal optimizations (for example, ptr nullness).
3135     if (n-&gt;in(1)-&gt;is_DecodeNarrowPtr() || n-&gt;in(2)-&gt;is_DecodeNarrowPtr()) {
3136       Node* in1 = n-&gt;in(1);
3137       Node* in2 = n-&gt;in(2);
3138       if (!in1-&gt;is_DecodeNarrowPtr()) {
3139         in2 = in1;
3140         in1 = n-&gt;in(2);
3141       }
3142       assert(in1-&gt;is_DecodeNarrowPtr(), &quot;sanity&quot;);
3143 
3144       Node* new_in2 = NULL;
3145       if (in2-&gt;is_DecodeNarrowPtr()) {
3146         assert(in2-&gt;Opcode() == in1-&gt;Opcode(), &quot;must be same node type&quot;);
3147         new_in2 = in2-&gt;in(1);
3148       } else if (in2-&gt;Opcode() == Op_ConP) {
3149         const Type* t = in2-&gt;bottom_type();
3150         if (t == TypePtr::NULL_PTR) {
3151           assert(in1-&gt;is_DecodeN(), &quot;compare klass to null?&quot;);
3152           // Don&#39;t convert CmpP null check into CmpN if compressed
3153           // oops implicit null check is not generated.
3154           // This will allow to generate normal oop implicit null check.
3155           if (Matcher::gen_narrow_oop_implicit_null_checks())
3156             new_in2 = ConNode::make(TypeNarrowOop::NULL_PTR);
3157           //
3158           // This transformation together with CastPP transformation above
3159           // will generated code for implicit NULL checks for compressed oops.
3160           //
3161           // The original code after Optimize()
3162           //
3163           //    LoadN memory, narrow_oop_reg
3164           //    decode narrow_oop_reg, base_reg
3165           //    CmpP base_reg, NULL
3166           //    CastPP base_reg // NotNull
3167           //    Load [base_reg + offset], val_reg
3168           //
3169           // after these transformations will be
3170           //
3171           //    LoadN memory, narrow_oop_reg
3172           //    CmpN narrow_oop_reg, NULL
3173           //    decode_not_null narrow_oop_reg, base_reg
3174           //    Load [base_reg + offset], val_reg
3175           //
3176           // and the uncommon path (== NULL) will use narrow_oop_reg directly
3177           // since narrow oops can be used in debug info now (see the code in
3178           // final_graph_reshaping_walk()).
3179           //
3180           // At the end the code will be matched to
3181           // on x86:
3182           //
3183           //    Load_narrow_oop memory, narrow_oop_reg
3184           //    Load [R12 + narrow_oop_reg&lt;&lt;3 + offset], val_reg
3185           //    NullCheck narrow_oop_reg
3186           //
3187           // and on sparc:
3188           //
3189           //    Load_narrow_oop memory, narrow_oop_reg
3190           //    decode_not_null narrow_oop_reg, base_reg
3191           //    Load [base_reg + offset], val_reg
3192           //    NullCheck base_reg
3193           //
3194         } else if (t-&gt;isa_oopptr()) {
3195           new_in2 = ConNode::make(t-&gt;make_narrowoop());
3196         } else if (t-&gt;isa_klassptr()) {
3197           new_in2 = ConNode::make(t-&gt;make_narrowklass());
3198         }
3199       }
3200       if (new_in2 != NULL) {
3201         Node* cmpN = new CmpNNode(in1-&gt;in(1), new_in2);
3202         n-&gt;subsume_by(cmpN, this);
3203         if (in1-&gt;outcnt() == 0) {
3204           in1-&gt;disconnect_inputs(NULL, this);
3205         }
3206         if (in2-&gt;outcnt() == 0) {
3207           in2-&gt;disconnect_inputs(NULL, this);
3208         }
3209       }
3210     }
3211     break;
3212 
3213   case Op_DecodeN:
3214   case Op_DecodeNKlass:
3215     assert(!n-&gt;in(1)-&gt;is_EncodeNarrowPtr(), &quot;should be optimized out&quot;);
3216     // DecodeN could be pinned when it can&#39;t be fold into
3217     // an address expression, see the code for Op_CastPP above.
3218     assert(n-&gt;in(0) == NULL || (UseCompressedOops &amp;&amp; !Matcher::narrow_oop_use_complex_address()), &quot;no control&quot;);
3219     break;
3220 
3221   case Op_EncodeP:
3222   case Op_EncodePKlass: {
3223     Node* in1 = n-&gt;in(1);
3224     if (in1-&gt;is_DecodeNarrowPtr()) {
3225       n-&gt;subsume_by(in1-&gt;in(1), this);
3226     } else if (in1-&gt;Opcode() == Op_ConP) {
3227       const Type* t = in1-&gt;bottom_type();
3228       if (t == TypePtr::NULL_PTR) {
3229         assert(t-&gt;isa_oopptr(), &quot;null klass?&quot;);
3230         n-&gt;subsume_by(ConNode::make(TypeNarrowOop::NULL_PTR), this);
3231       } else if (t-&gt;isa_oopptr()) {
3232         n-&gt;subsume_by(ConNode::make(t-&gt;make_narrowoop()), this);
3233       } else if (t-&gt;isa_klassptr()) {
3234         n-&gt;subsume_by(ConNode::make(t-&gt;make_narrowklass()), this);
3235       }
3236     }
3237     if (in1-&gt;outcnt() == 0) {
3238       in1-&gt;disconnect_inputs(NULL, this);
3239     }
3240     break;
3241   }
3242 
3243   case Op_Proj: {
3244     if (OptimizeStringConcat) {
3245       ProjNode* p = n-&gt;as_Proj();
3246       if (p-&gt;_is_io_use) {
3247         // Separate projections were used for the exception path which
3248         // are normally removed by a late inline.  If it wasn&#39;t inlined
3249         // then they will hang around and should just be replaced with
3250         // the original one.
3251         Node* proj = NULL;
3252         // Replace with just one
3253         for (SimpleDUIterator i(p-&gt;in(0)); i.has_next(); i.next()) {
3254           Node *use = i.get();
3255           if (use-&gt;is_Proj() &amp;&amp; p != use &amp;&amp; use-&gt;as_Proj()-&gt;_con == p-&gt;_con) {
3256             proj = use;
3257             break;
3258           }
3259         }
3260         assert(proj != NULL || p-&gt;_con == TypeFunc::I_O, &quot;io may be dropped at an infinite loop&quot;);
3261         if (proj != NULL) {
3262           p-&gt;subsume_by(proj, this);
3263         }
3264       }
3265     }
3266     break;
3267   }
3268 
3269   case Op_Phi:
3270     if (n-&gt;as_Phi()-&gt;bottom_type()-&gt;isa_narrowoop() || n-&gt;as_Phi()-&gt;bottom_type()-&gt;isa_narrowklass()) {
3271       // The EncodeP optimization may create Phi with the same edges
3272       // for all paths. It is not handled well by Register Allocator.
3273       Node* unique_in = n-&gt;in(1);
3274       assert(unique_in != NULL, &quot;&quot;);
3275       uint cnt = n-&gt;req();
3276       for (uint i = 2; i &lt; cnt; i++) {
3277         Node* m = n-&gt;in(i);
3278         assert(m != NULL, &quot;&quot;);
3279         if (unique_in != m)
3280           unique_in = NULL;
3281       }
3282       if (unique_in != NULL) {
3283         n-&gt;subsume_by(unique_in, this);
3284       }
3285     }
3286     break;
3287 
3288 #endif
3289 
3290 #ifdef ASSERT
3291   case Op_CastII:
3292     // Verify that all range check dependent CastII nodes were removed.
3293     if (n-&gt;isa_CastII()-&gt;has_range_check()) {
3294       n-&gt;dump(3);
3295       assert(false, &quot;Range check dependent CastII node was not removed&quot;);
3296     }
3297     break;
3298 #endif
3299 
3300   case Op_ModI:
3301     if (UseDivMod) {
3302       // Check if a%b and a/b both exist
3303       Node* d = n-&gt;find_similar(Op_DivI);
3304       if (d) {
3305         // Replace them with a fused divmod if supported
3306         if (Matcher::has_match_rule(Op_DivModI)) {
3307           DivModINode* divmod = DivModINode::make(n);
3308           d-&gt;subsume_by(divmod-&gt;div_proj(), this);
3309           n-&gt;subsume_by(divmod-&gt;mod_proj(), this);
3310         } else {
3311           // replace a%b with a-((a/b)*b)
3312           Node* mult = new MulINode(d, d-&gt;in(2));
3313           Node* sub  = new SubINode(d-&gt;in(1), mult);
3314           n-&gt;subsume_by(sub, this);
3315         }
3316       }
3317     }
3318     break;
3319 
3320   case Op_ModL:
3321     if (UseDivMod) {
3322       // Check if a%b and a/b both exist
3323       Node* d = n-&gt;find_similar(Op_DivL);
3324       if (d) {
3325         // Replace them with a fused divmod if supported
3326         if (Matcher::has_match_rule(Op_DivModL)) {
3327           DivModLNode* divmod = DivModLNode::make(n);
3328           d-&gt;subsume_by(divmod-&gt;div_proj(), this);
3329           n-&gt;subsume_by(divmod-&gt;mod_proj(), this);
3330         } else {
3331           // replace a%b with a-((a/b)*b)
3332           Node* mult = new MulLNode(d, d-&gt;in(2));
3333           Node* sub  = new SubLNode(d-&gt;in(1), mult);
3334           n-&gt;subsume_by(sub, this);
3335         }
3336       }
3337     }
3338     break;
3339 
3340   case Op_LoadVector:
3341   case Op_StoreVector:
3342     break;
3343 
3344   case Op_AddReductionVI:
3345   case Op_AddReductionVL:
3346   case Op_AddReductionVF:
3347   case Op_AddReductionVD:
3348   case Op_MulReductionVI:
3349   case Op_MulReductionVL:
3350   case Op_MulReductionVF:
3351   case Op_MulReductionVD:
3352   case Op_MinReductionV:
3353   case Op_MaxReductionV:
3354     break;
3355 
3356   case Op_PackB:
3357   case Op_PackS:
3358   case Op_PackI:
3359   case Op_PackF:
3360   case Op_PackL:
3361   case Op_PackD:
3362     if (n-&gt;req()-1 &gt; 2) {
3363       // Replace many operand PackNodes with a binary tree for matching
3364       PackNode* p = (PackNode*) n;
3365       Node* btp = p-&gt;binary_tree_pack(1, n-&gt;req());
3366       n-&gt;subsume_by(btp, this);
3367     }
3368     break;
3369   case Op_Loop:
3370   case Op_CountedLoop:
3371   case Op_OuterStripMinedLoop:
3372     if (n-&gt;as_Loop()-&gt;is_inner_loop()) {
3373       frc.inc_inner_loop_count();
3374     }
3375     n-&gt;as_Loop()-&gt;verify_strip_mined(0);
3376     break;
3377   case Op_LShiftI:
3378   case Op_RShiftI:
3379   case Op_URShiftI:
3380   case Op_LShiftL:
3381   case Op_RShiftL:
3382   case Op_URShiftL:
3383     if (Matcher::need_masked_shift_count) {
3384       // The cpu&#39;s shift instructions don&#39;t restrict the count to the
3385       // lower 5/6 bits. We need to do the masking ourselves.
3386       Node* in2 = n-&gt;in(2);
3387       juint mask = (n-&gt;bottom_type() == TypeInt::INT) ? (BitsPerInt - 1) : (BitsPerLong - 1);
3388       const TypeInt* t = in2-&gt;find_int_type();
3389       if (t != NULL &amp;&amp; t-&gt;is_con()) {
3390         juint shift = t-&gt;get_con();
3391         if (shift &gt; mask) { // Unsigned cmp
3392           n-&gt;set_req(2, ConNode::make(TypeInt::make(shift &amp; mask)));
3393         }
3394       } else {
3395         if (t == NULL || t-&gt;_lo &lt; 0 || t-&gt;_hi &gt; (int)mask) {
3396           Node* shift = new AndINode(in2, ConNode::make(TypeInt::make(mask)));
3397           n-&gt;set_req(2, shift);
3398         }
3399       }
3400       if (in2-&gt;outcnt() == 0) { // Remove dead node
3401         in2-&gt;disconnect_inputs(NULL, this);
3402       }
3403     }
3404     break;
3405   case Op_MemBarStoreStore:
3406   case Op_MemBarRelease:
3407     // Break the link with AllocateNode: it is no longer useful and
3408     // confuses register allocation.
3409     if (n-&gt;req() &gt; MemBarNode::Precedent) {
3410       n-&gt;set_req(MemBarNode::Precedent, top());
3411     }
3412     break;
3413   case Op_MemBarAcquire: {
3414     if (n-&gt;as_MemBar()-&gt;trailing_load() &amp;&amp; n-&gt;req() &gt; MemBarNode::Precedent) {
3415       // At parse time, the trailing MemBarAcquire for a volatile load
3416       // is created with an edge to the load. After optimizations,
3417       // that input may be a chain of Phis. If those phis have no
3418       // other use, then the MemBarAcquire keeps them alive and
3419       // register allocation can be confused.
3420       ResourceMark rm;
3421       Unique_Node_List wq;
3422       wq.push(n-&gt;in(MemBarNode::Precedent));
3423       n-&gt;set_req(MemBarNode::Precedent, top());
3424       while (wq.size() &gt; 0) {
3425         Node* m = wq.pop();
3426         if (m-&gt;outcnt() == 0) {
3427           for (uint j = 0; j &lt; m-&gt;req(); j++) {
3428             Node* in = m-&gt;in(j);
3429             if (in != NULL) {
3430               wq.push(in);
3431             }
3432           }
3433           m-&gt;disconnect_inputs(NULL, this);
3434         }
3435       }
3436     }
3437     break;
3438   }
3439   case Op_RangeCheck: {
3440     RangeCheckNode* rc = n-&gt;as_RangeCheck();
3441     Node* iff = new IfNode(rc-&gt;in(0), rc-&gt;in(1), rc-&gt;_prob, rc-&gt;_fcnt);
3442     n-&gt;subsume_by(iff, this);
3443     frc._tests.push(iff);
3444     break;
3445   }
3446   case Op_ConvI2L: {
3447     if (!Matcher::convi2l_type_required) {
3448       // Code generation on some platforms doesn&#39;t need accurate
3449       // ConvI2L types. Widening the type can help remove redundant
3450       // address computations.
3451       n-&gt;as_Type()-&gt;set_type(TypeLong::INT);
3452       ResourceMark rm;
<a name="51" id="anc51"></a><span class="line-modified">3453       Node_List wq;</span>
3454       wq.push(n);
3455       for (uint next = 0; next &lt; wq.size(); next++) {
3456         Node *m = wq.at(next);
3457 
3458         for(;;) {
3459           // Loop over all nodes with identical inputs edges as m
3460           Node* k = m-&gt;find_similar(m-&gt;Opcode());
3461           if (k == NULL) {
3462             break;
3463           }
3464           // Push their uses so we get a chance to remove node made
3465           // redundant
3466           for (DUIterator_Fast imax, i = k-&gt;fast_outs(imax); i &lt; imax; i++) {
3467             Node* u = k-&gt;fast_out(i);
<a name="52" id="anc52"></a><span class="line-removed">3468             assert(!wq.contains(u), &quot;shouldn&#39;t process one node several times&quot;);</span>
3469             if (u-&gt;Opcode() == Op_LShiftL ||
3470                 u-&gt;Opcode() == Op_AddL ||
3471                 u-&gt;Opcode() == Op_SubL ||
3472                 u-&gt;Opcode() == Op_AddP) {
3473               wq.push(u);
3474             }
3475           }
3476           // Replace all nodes with identical edges as m with m
3477           k-&gt;subsume_by(m, this);
3478         }
3479       }
3480     }
3481     break;
3482   }
3483   case Op_CmpUL: {
3484     if (!Matcher::has_match_rule(Op_CmpUL)) {
3485       // No support for unsigned long comparisons
3486       ConINode* sign_pos = new ConINode(TypeInt::make(BitsPerLong - 1));
3487       Node* sign_bit_mask = new RShiftLNode(n-&gt;in(1), sign_pos);
3488       Node* orl = new OrLNode(n-&gt;in(1), sign_bit_mask);
3489       ConLNode* remove_sign_mask = new ConLNode(TypeLong::make(max_jlong));
3490       Node* andl = new AndLNode(orl, remove_sign_mask);
3491       Node* cmp = new CmpLNode(andl, n-&gt;in(2));
3492       n-&gt;subsume_by(cmp, this);
3493     }
3494     break;
3495   }
3496   default:
3497     assert(!n-&gt;is_Call(), &quot;&quot;);
3498     assert(!n-&gt;is_Mem(), &quot;&quot;);
3499     assert(nop != Op_ProfileBoolean, &quot;should be eliminated during IGVN&quot;);
3500     break;
3501   }
3502 }
3503 
3504 //------------------------------final_graph_reshaping_walk---------------------
3505 // Replacing Opaque nodes with their input in final_graph_reshaping_impl(),
3506 // requires that the walk visits a node&#39;s inputs before visiting the node.
3507 void Compile::final_graph_reshaping_walk( Node_Stack &amp;nstack, Node *root, Final_Reshape_Counts &amp;frc ) {
3508   ResourceArea *area = Thread::current()-&gt;resource_area();
3509   Unique_Node_List sfpt(area);
3510 
3511   frc._visited.set(root-&gt;_idx); // first, mark node as visited
3512   uint cnt = root-&gt;req();
3513   Node *n = root;
3514   uint  i = 0;
3515   while (true) {
3516     if (i &lt; cnt) {
3517       // Place all non-visited non-null inputs onto stack
3518       Node* m = n-&gt;in(i);
3519       ++i;
3520       if (m != NULL &amp;&amp; !frc._visited.test_set(m-&gt;_idx)) {
3521         if (m-&gt;is_SafePoint() &amp;&amp; m-&gt;as_SafePoint()-&gt;jvms() != NULL) {
3522           // compute worst case interpreter size in case of a deoptimization
3523           update_interpreter_frame_size(m-&gt;as_SafePoint()-&gt;jvms()-&gt;interpreter_frame_size());
3524 
3525           sfpt.push(m);
3526         }
3527         cnt = m-&gt;req();
3528         nstack.push(n, i); // put on stack parent and next input&#39;s index
3529         n = m;
3530         i = 0;
3531       }
3532     } else {
3533       // Now do post-visit work
3534       final_graph_reshaping_impl( n, frc );
3535       if (nstack.is_empty())
3536         break;             // finished
3537       n = nstack.node();   // Get node from stack
3538       cnt = n-&gt;req();
3539       i = nstack.index();
3540       nstack.pop();        // Shift to the next node on stack
3541     }
3542   }
3543 
3544   // Skip next transformation if compressed oops are not used.
3545   if ((UseCompressedOops &amp;&amp; !Matcher::gen_narrow_oop_implicit_null_checks()) ||
3546       (!UseCompressedOops &amp;&amp; !UseCompressedClassPointers))
3547     return;
3548 
3549   // Go over safepoints nodes to skip DecodeN/DecodeNKlass nodes for debug edges.
3550   // It could be done for an uncommon traps or any safepoints/calls
3551   // if the DecodeN/DecodeNKlass node is referenced only in a debug info.
3552   while (sfpt.size() &gt; 0) {
3553     n = sfpt.pop();
3554     JVMState *jvms = n-&gt;as_SafePoint()-&gt;jvms();
3555     assert(jvms != NULL, &quot;sanity&quot;);
3556     int start = jvms-&gt;debug_start();
3557     int end   = n-&gt;req();
3558     bool is_uncommon = (n-&gt;is_CallStaticJava() &amp;&amp;
3559                         n-&gt;as_CallStaticJava()-&gt;uncommon_trap_request() != 0);
3560     for (int j = start; j &lt; end; j++) {
3561       Node* in = n-&gt;in(j);
3562       if (in-&gt;is_DecodeNarrowPtr()) {
3563         bool safe_to_skip = true;
3564         if (!is_uncommon ) {
3565           // Is it safe to skip?
3566           for (uint i = 0; i &lt; in-&gt;outcnt(); i++) {
3567             Node* u = in-&gt;raw_out(i);
3568             if (!u-&gt;is_SafePoint() ||
3569                 (u-&gt;is_Call() &amp;&amp; u-&gt;as_Call()-&gt;has_non_debug_use(n))) {
3570               safe_to_skip = false;
3571             }
3572           }
3573         }
3574         if (safe_to_skip) {
3575           n-&gt;set_req(j, in-&gt;in(1));
3576         }
3577         if (in-&gt;outcnt() == 0) {
3578           in-&gt;disconnect_inputs(NULL, this);
3579         }
3580       }
3581     }
3582   }
3583 }
3584 
3585 //------------------------------final_graph_reshaping--------------------------
3586 // Final Graph Reshaping.
3587 //
3588 // (1) Clone simple inputs to uncommon calls, so they can be scheduled late
3589 //     and not commoned up and forced early.  Must come after regular
3590 //     optimizations to avoid GVN undoing the cloning.  Clone constant
3591 //     inputs to Loop Phis; these will be split by the allocator anyways.
3592 //     Remove Opaque nodes.
3593 // (2) Move last-uses by commutative operations to the left input to encourage
3594 //     Intel update-in-place two-address operations and better register usage
3595 //     on RISCs.  Must come after regular optimizations to avoid GVN Ideal
3596 //     calls canonicalizing them back.
3597 // (3) Count the number of double-precision FP ops, single-precision FP ops
3598 //     and call sites.  On Intel, we can get correct rounding either by
3599 //     forcing singles to memory (requires extra stores and loads after each
3600 //     FP bytecode) or we can set a rounding mode bit (requires setting and
3601 //     clearing the mode bit around call sites).  The mode bit is only used
3602 //     if the relative frequency of single FP ops to calls is low enough.
3603 //     This is a key transform for SPEC mpeg_audio.
3604 // (4) Detect infinite loops; blobs of code reachable from above but not
3605 //     below.  Several of the Code_Gen algorithms fail on such code shapes,
3606 //     so we simply bail out.  Happens a lot in ZKM.jar, but also happens
3607 //     from time to time in other codes (such as -Xcomp finalizer loops, etc).
3608 //     Detection is by looking for IfNodes where only 1 projection is
3609 //     reachable from below or CatchNodes missing some targets.
3610 // (5) Assert for insane oop offsets in debug mode.
3611 
3612 bool Compile::final_graph_reshaping() {
3613   // an infinite loop may have been eliminated by the optimizer,
3614   // in which case the graph will be empty.
3615   if (root()-&gt;req() == 1) {
3616     record_method_not_compilable(&quot;trivial infinite loop&quot;);
3617     return true;
3618   }
3619 
3620   // Expensive nodes have their control input set to prevent the GVN
3621   // from freely commoning them. There&#39;s no GVN beyond this point so
3622   // no need to keep the control input. We want the expensive nodes to
3623   // be freely moved to the least frequent code path by gcm.
3624   assert(OptimizeExpensiveOps || expensive_count() == 0, &quot;optimization off but list non empty?&quot;);
3625   for (int i = 0; i &lt; expensive_count(); i++) {
3626     _expensive_nodes-&gt;at(i)-&gt;set_req(0, NULL);
3627   }
3628 
3629   Final_Reshape_Counts frc;
3630 
3631   // Visit everybody reachable!
3632   // Allocate stack of size C-&gt;live_nodes()/2 to avoid frequent realloc
3633   Node_Stack nstack(live_nodes() &gt;&gt; 1);
3634   final_graph_reshaping_walk(nstack, root(), frc);
3635 
3636   // Check for unreachable (from below) code (i.e., infinite loops).
3637   for( uint i = 0; i &lt; frc._tests.size(); i++ ) {
3638     MultiBranchNode *n = frc._tests[i]-&gt;as_MultiBranch();
3639     // Get number of CFG targets.
3640     // Note that PCTables include exception targets after calls.
3641     uint required_outcnt = n-&gt;required_outcnt();
3642     if (n-&gt;outcnt() != required_outcnt) {
3643       // Check for a few special cases.  Rethrow Nodes never take the
3644       // &#39;fall-thru&#39; path, so expected kids is 1 less.
3645       if (n-&gt;is_PCTable() &amp;&amp; n-&gt;in(0) &amp;&amp; n-&gt;in(0)-&gt;in(0)) {
3646         if (n-&gt;in(0)-&gt;in(0)-&gt;is_Call()) {
3647           CallNode *call = n-&gt;in(0)-&gt;in(0)-&gt;as_Call();
3648           if (call-&gt;entry_point() == OptoRuntime::rethrow_stub()) {
3649             required_outcnt--;      // Rethrow always has 1 less kid
3650           } else if (call-&gt;req() &gt; TypeFunc::Parms &amp;&amp;
3651                      call-&gt;is_CallDynamicJava()) {
3652             // Check for null receiver. In such case, the optimizer has
3653             // detected that the virtual call will always result in a null
3654             // pointer exception. The fall-through projection of this CatchNode
3655             // will not be populated.
3656             Node *arg0 = call-&gt;in(TypeFunc::Parms);
3657             if (arg0-&gt;is_Type() &amp;&amp;
3658                 arg0-&gt;as_Type()-&gt;type()-&gt;higher_equal(TypePtr::NULL_PTR)) {
3659               required_outcnt--;
3660             }
3661           } else if (call-&gt;entry_point() == OptoRuntime::new_array_Java() &amp;&amp;
3662                      call-&gt;req() &gt; TypeFunc::Parms+1 &amp;&amp;
3663                      call-&gt;is_CallStaticJava()) {
3664             // Check for negative array length. In such case, the optimizer has
3665             // detected that the allocation attempt will always result in an
3666             // exception. There is no fall-through projection of this CatchNode .
3667             Node *arg1 = call-&gt;in(TypeFunc::Parms+1);
3668             if (arg1-&gt;is_Type() &amp;&amp;
3669                 arg1-&gt;as_Type()-&gt;type()-&gt;join(TypeInt::POS)-&gt;empty()) {
3670               required_outcnt--;
3671             }
3672           }
3673         }
3674       }
3675       // Recheck with a better notion of &#39;required_outcnt&#39;
3676       if (n-&gt;outcnt() != required_outcnt) {
3677         record_method_not_compilable(&quot;malformed control flow&quot;);
3678         return true;            // Not all targets reachable!
3679       }
3680     }
3681     // Check that I actually visited all kids.  Unreached kids
3682     // must be infinite loops.
3683     for (DUIterator_Fast jmax, j = n-&gt;fast_outs(jmax); j &lt; jmax; j++)
3684       if (!frc._visited.test(n-&gt;fast_out(j)-&gt;_idx)) {
3685         record_method_not_compilable(&quot;infinite loop&quot;);
3686         return true;            // Found unvisited kid; must be unreach
3687       }
3688 
3689     // Here so verification code in final_graph_reshaping_walk()
3690     // always see an OuterStripMinedLoopEnd
3691     if (n-&gt;is_OuterStripMinedLoopEnd()) {
3692       IfNode* init_iff = n-&gt;as_If();
3693       Node* iff = new IfNode(init_iff-&gt;in(0), init_iff-&gt;in(1), init_iff-&gt;_prob, init_iff-&gt;_fcnt);
3694       n-&gt;subsume_by(iff, this);
3695     }
3696   }
3697 
<a name="53" id="anc53"></a>
3698   // If original bytecodes contained a mixture of floats and doubles
3699   // check if the optimizer has made it homogenous, item (3).
<a name="54" id="anc54"></a><span class="line-modified">3700   if( Use24BitFPMode &amp;&amp; Use24BitFP &amp;&amp; UseSSE == 0 &amp;&amp;</span>
3701       frc.get_float_count() &gt; 32 &amp;&amp;
3702       frc.get_double_count() == 0 &amp;&amp;
3703       (10 * frc.get_call_count() &lt; frc.get_float_count()) ) {
<a name="55" id="anc55"></a><span class="line-modified">3704     set_24_bit_selection_and_mode( false,  true );</span>
3705   }
<a name="56" id="anc56"></a>
3706 
3707   set_java_calls(frc.get_java_call_count());
3708   set_inner_loops(frc.get_inner_loop_count());
3709 
3710   // No infinite loops, no reason to bail out.
3711   return false;
3712 }
3713 
3714 //-----------------------------too_many_traps----------------------------------
3715 // Report if there are too many traps at the current method and bci.
3716 // Return true if there was a trap, and/or PerMethodTrapLimit is exceeded.
3717 bool Compile::too_many_traps(ciMethod* method,
3718                              int bci,
3719                              Deoptimization::DeoptReason reason) {
3720   ciMethodData* md = method-&gt;method_data();
3721   if (md-&gt;is_empty()) {
3722     // Assume the trap has not occurred, or that it occurred only
3723     // because of a transient condition during start-up in the interpreter.
3724     return false;
3725   }
3726   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? this-&gt;method() : NULL;
3727   if (md-&gt;has_trap_at(bci, m, reason) != 0) {
3728     // Assume PerBytecodeTrapLimit==0, for a more conservative heuristic.
3729     // Also, if there are multiple reasons, or if there is no per-BCI record,
3730     // assume the worst.
3731     if (log())
3732       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39;&quot;,
3733                   Deoptimization::trap_reason_name(reason),
3734                   md-&gt;trap_count(reason));
3735     return true;
3736   } else {
3737     // Ignore method/bci and see if there have been too many globally.
3738     return too_many_traps(reason, md);
3739   }
3740 }
3741 
3742 // Less-accurate variant which does not require a method and bci.
3743 bool Compile::too_many_traps(Deoptimization::DeoptReason reason,
3744                              ciMethodData* logmd) {
3745   if (trap_count(reason) &gt;= Deoptimization::per_method_trap_limit(reason)) {
3746     // Too many traps globally.
3747     // Note that we use cumulative trap_count, not just md-&gt;trap_count.
3748     if (log()) {
3749       int mcount = (logmd == NULL)? -1: (int)logmd-&gt;trap_count(reason);
3750       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;0&#39; mcount=&#39;%d&#39; ccount=&#39;%d&#39;&quot;,
3751                   Deoptimization::trap_reason_name(reason),
3752                   mcount, trap_count(reason));
3753     }
3754     return true;
3755   } else {
3756     // The coast is clear.
3757     return false;
3758   }
3759 }
3760 
3761 //--------------------------too_many_recompiles--------------------------------
3762 // Report if there are too many recompiles at the current method and bci.
3763 // Consults PerBytecodeRecompilationCutoff and PerMethodRecompilationCutoff.
3764 // Is not eager to return true, since this will cause the compiler to use
3765 // Action_none for a trap point, to avoid too many recompilations.
3766 bool Compile::too_many_recompiles(ciMethod* method,
3767                                   int bci,
3768                                   Deoptimization::DeoptReason reason) {
3769   ciMethodData* md = method-&gt;method_data();
3770   if (md-&gt;is_empty()) {
3771     // Assume the trap has not occurred, or that it occurred only
3772     // because of a transient condition during start-up in the interpreter.
3773     return false;
3774   }
3775   // Pick a cutoff point well within PerBytecodeRecompilationCutoff.
3776   uint bc_cutoff = (uint) PerBytecodeRecompilationCutoff / 8;
3777   uint m_cutoff  = (uint) PerMethodRecompilationCutoff / 2 + 1;  // not zero
3778   Deoptimization::DeoptReason per_bc_reason
3779     = Deoptimization::reason_recorded_per_bytecode_if_any(reason);
3780   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? this-&gt;method() : NULL;
3781   if ((per_bc_reason == Deoptimization::Reason_none
3782        || md-&gt;has_trap_at(bci, m, reason) != 0)
3783       // The trap frequency measure we care about is the recompile count:
3784       &amp;&amp; md-&gt;trap_recompiled_at(bci, m)
3785       &amp;&amp; md-&gt;overflow_recompile_count() &gt;= bc_cutoff) {
3786     // Do not emit a trap here if it has already caused recompilations.
3787     // Also, if there are multiple reasons, or if there is no per-BCI record,
3788     // assume the worst.
3789     if (log())
3790       log()-&gt;elem(&quot;observe trap=&#39;%s recompiled&#39; count=&#39;%d&#39; recompiles2=&#39;%d&#39;&quot;,
3791                   Deoptimization::trap_reason_name(reason),
3792                   md-&gt;trap_count(reason),
3793                   md-&gt;overflow_recompile_count());
3794     return true;
3795   } else if (trap_count(reason) != 0
3796              &amp;&amp; decompile_count() &gt;= m_cutoff) {
3797     // Too many recompiles globally, and we have seen this sort of trap.
3798     // Use cumulative decompile_count, not just md-&gt;decompile_count.
3799     if (log())
3800       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39; mcount=&#39;%d&#39; decompiles=&#39;%d&#39; mdecompiles=&#39;%d&#39;&quot;,
3801                   Deoptimization::trap_reason_name(reason),
3802                   md-&gt;trap_count(reason), trap_count(reason),
3803                   md-&gt;decompile_count(), decompile_count());
3804     return true;
3805   } else {
3806     // The coast is clear.
3807     return false;
3808   }
3809 }
3810 
3811 // Compute when not to trap. Used by matching trap based nodes and
3812 // NullCheck optimization.
3813 void Compile::set_allowed_deopt_reasons() {
3814   _allowed_reasons = 0;
3815   if (is_method_compilation()) {
3816     for (int rs = (int)Deoptimization::Reason_none+1; rs &lt; Compile::trapHistLength; rs++) {
3817       assert(rs &lt; BitsPerInt, &quot;recode bit map&quot;);
3818       if (!too_many_traps((Deoptimization::DeoptReason) rs)) {
3819         _allowed_reasons |= nth_bit(rs);
3820       }
3821     }
3822   }
3823 }
3824 
<a name="57" id="anc57"></a><span class="line-modified">3825 bool Compile::is_compiling_clinit_for(ciKlass* k) {</span>
<span class="line-modified">3826   ciMethod* root = method(); // the root method of compilation</span>
<span class="line-modified">3827   return root-&gt;is_static_initializer() &amp;&amp; root-&gt;holder() == k; // access in the context of clinit</span>

































3828 }
3829 
3830 #ifndef PRODUCT
3831 //------------------------------verify_graph_edges---------------------------
3832 // Walk the Graph and verify that there is a one-to-one correspondence
3833 // between Use-Def edges and Def-Use edges in the graph.
3834 void Compile::verify_graph_edges(bool no_dead_code) {
3835   if (VerifyGraphEdges) {
3836     ResourceArea *area = Thread::current()-&gt;resource_area();
3837     Unique_Node_List visited(area);
3838     // Call recursive graph walk to check edges
3839     _root-&gt;verify_edges(visited);
3840     if (no_dead_code) {
3841       // Now make sure that no visited node is used by an unvisited node.
3842       bool dead_nodes = false;
3843       Unique_Node_List checked(area);
3844       while (visited.size() &gt; 0) {
3845         Node* n = visited.pop();
3846         checked.push(n);
3847         for (uint i = 0; i &lt; n-&gt;outcnt(); i++) {
3848           Node* use = n-&gt;raw_out(i);
3849           if (checked.member(use))  continue;  // already checked
3850           if (visited.member(use))  continue;  // already in the graph
3851           if (use-&gt;is_Con())        continue;  // a dead ConNode is OK
3852           // At this point, we have found a dead node which is DU-reachable.
3853           if (!dead_nodes) {
3854             tty-&gt;print_cr(&quot;*** Dead nodes reachable via DU edges:&quot;);
3855             dead_nodes = true;
3856           }
3857           use-&gt;dump(2);
3858           tty-&gt;print_cr(&quot;---&quot;);
3859           checked.push(use);  // No repeats; pretend it is now checked.
3860         }
3861       }
3862       assert(!dead_nodes, &quot;using nodes must be reachable from root&quot;);
3863     }
3864   }
3865 }
3866 #endif
3867 
3868 // The Compile object keeps track of failure reasons separately from the ciEnv.
3869 // This is required because there is not quite a 1-1 relation between the
3870 // ciEnv and its compilation task and the Compile object.  Note that one
3871 // ciEnv might use two Compile objects, if C2Compiler::compile_method decides
3872 // to backtrack and retry without subsuming loads.  Other than this backtracking
3873 // behavior, the Compile&#39;s failure reason is quietly copied up to the ciEnv
3874 // by the logic in C2Compiler.
3875 void Compile::record_failure(const char* reason) {
3876   if (log() != NULL) {
3877     log()-&gt;elem(&quot;failure reason=&#39;%s&#39; phase=&#39;compile&#39;&quot;, reason);
3878   }
3879   if (_failure_reason == NULL) {
3880     // Record the first failure reason.
3881     _failure_reason = reason;
3882   }
3883 
3884   if (!C-&gt;failure_reason_is(C2Compiler::retry_no_subsuming_loads())) {
3885     C-&gt;print_method(PHASE_FAILURE);
3886   }
3887   _root = NULL;  // flush the graph, too
3888 }
3889 
3890 Compile::TracePhase::TracePhase(const char* name, elapsedTimer* accumulator)
3891   : TraceTime(name, accumulator, CITime, CITimeVerbose),
3892     _phase_name(name), _dolog(CITimeVerbose)
3893 {
3894   if (_dolog) {
3895     C = Compile::current();
3896     _log = C-&gt;log();
3897   } else {
3898     C = NULL;
3899     _log = NULL;
3900   }
3901   if (_log != NULL) {
3902     _log-&gt;begin_head(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39;&quot;, _phase_name, C-&gt;unique(), C-&gt;live_nodes());
3903     _log-&gt;stamp();
3904     _log-&gt;end_head();
3905   }
3906 }
3907 
3908 Compile::TracePhase::~TracePhase() {
3909 
3910   C = Compile::current();
3911   if (_dolog) {
3912     _log = C-&gt;log();
3913   } else {
3914     _log = NULL;
3915   }
3916 
3917 #ifdef ASSERT
3918   if (PrintIdealNodeCount) {
3919     tty-&gt;print_cr(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39; live_graph_walk=&#39;%d&#39;&quot;,
3920                   _phase_name, C-&gt;unique(), C-&gt;live_nodes(), C-&gt;count_live_nodes_by_graph_walk());
3921   }
3922 
3923   if (VerifyIdealNodeCount) {
3924     Compile::current()-&gt;print_missing_nodes();
3925   }
3926 #endif
3927 
3928   if (_log != NULL) {
3929     _log-&gt;done(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39;&quot;, _phase_name, C-&gt;unique(), C-&gt;live_nodes());
3930   }
3931 }
3932 
3933 //=============================================================================
3934 // Two Constant&#39;s are equal when the type and the value are equal.
3935 bool Compile::Constant::operator==(const Constant&amp; other) {
3936   if (type()          != other.type()         )  return false;
3937   if (can_be_reused() != other.can_be_reused())  return false;
3938   // For floating point values we compare the bit pattern.
3939   switch (type()) {
3940   case T_INT:
3941   case T_FLOAT:   return (_v._value.i == other._v._value.i);
3942   case T_LONG:
3943   case T_DOUBLE:  return (_v._value.j == other._v._value.j);
3944   case T_OBJECT:
3945   case T_ADDRESS: return (_v._value.l == other._v._value.l);
3946   case T_VOID:    return (_v._value.l == other._v._value.l);  // jump-table entries
3947   case T_METADATA: return (_v._metadata == other._v._metadata);
3948   default: ShouldNotReachHere(); return false;
3949   }
3950 }
3951 
3952 static int type_to_size_in_bytes(BasicType t) {
3953   switch (t) {
3954   case T_INT:     return sizeof(jint   );
3955   case T_LONG:    return sizeof(jlong  );
3956   case T_FLOAT:   return sizeof(jfloat );
3957   case T_DOUBLE:  return sizeof(jdouble);
3958   case T_METADATA: return sizeof(Metadata*);
3959     // We use T_VOID as marker for jump-table entries (labels) which
3960     // need an internal word relocation.
3961   case T_VOID:
3962   case T_ADDRESS:
3963   case T_OBJECT:  return sizeof(jobject);
3964   default:
3965     ShouldNotReachHere();
3966     return -1;
3967   }
3968 }
3969 
3970 int Compile::ConstantTable::qsort_comparator(Constant* a, Constant* b) {
3971   // sort descending
3972   if (a-&gt;freq() &gt; b-&gt;freq())  return -1;
3973   if (a-&gt;freq() &lt; b-&gt;freq())  return  1;
3974   return 0;
3975 }
3976 
3977 void Compile::ConstantTable::calculate_offsets_and_size() {
3978   // First, sort the array by frequencies.
3979   _constants.sort(qsort_comparator);
3980 
3981 #ifdef ASSERT
3982   // Make sure all jump-table entries were sorted to the end of the
3983   // array (they have a negative frequency).
3984   bool found_void = false;
3985   for (int i = 0; i &lt; _constants.length(); i++) {
3986     Constant con = _constants.at(i);
3987     if (con.type() == T_VOID)
3988       found_void = true;  // jump-tables
3989     else
3990       assert(!found_void, &quot;wrong sorting&quot;);
3991   }
3992 #endif
3993 
3994   int offset = 0;
3995   for (int i = 0; i &lt; _constants.length(); i++) {
3996     Constant* con = _constants.adr_at(i);
3997 
3998     // Align offset for type.
3999     int typesize = type_to_size_in_bytes(con-&gt;type());
4000     offset = align_up(offset, typesize);
4001     con-&gt;set_offset(offset);   // set constant&#39;s offset
4002 
4003     if (con-&gt;type() == T_VOID) {
4004       MachConstantNode* n = (MachConstantNode*) con-&gt;get_jobject();
4005       offset = offset + typesize * n-&gt;outcnt();  // expand jump-table
4006     } else {
4007       offset = offset + typesize;
4008     }
4009   }
4010 
4011   // Align size up to the next section start (which is insts; see
4012   // CodeBuffer::align_at_start).
4013   assert(_size == -1, &quot;already set?&quot;);
4014   _size = align_up(offset, (int)CodeEntryAlignment);
4015 }
4016 
4017 void Compile::ConstantTable::emit(CodeBuffer&amp; cb) {
4018   MacroAssembler _masm(&amp;cb);
4019   for (int i = 0; i &lt; _constants.length(); i++) {
4020     Constant con = _constants.at(i);
4021     address constant_addr = NULL;
4022     switch (con.type()) {
4023     case T_INT:    constant_addr = _masm.int_constant(   con.get_jint()   ); break;
4024     case T_LONG:   constant_addr = _masm.long_constant(  con.get_jlong()  ); break;
4025     case T_FLOAT:  constant_addr = _masm.float_constant( con.get_jfloat() ); break;
4026     case T_DOUBLE: constant_addr = _masm.double_constant(con.get_jdouble()); break;
4027     case T_OBJECT: {
4028       jobject obj = con.get_jobject();
4029       int oop_index = _masm.oop_recorder()-&gt;find_index(obj);
4030       constant_addr = _masm.address_constant((address) obj, oop_Relocation::spec(oop_index));
4031       break;
4032     }
4033     case T_ADDRESS: {
4034       address addr = (address) con.get_jobject();
4035       constant_addr = _masm.address_constant(addr);
4036       break;
4037     }
4038     // We use T_VOID as marker for jump-table entries (labels) which
4039     // need an internal word relocation.
4040     case T_VOID: {
4041       MachConstantNode* n = (MachConstantNode*) con.get_jobject();
4042       // Fill the jump-table with a dummy word.  The real value is
4043       // filled in later in fill_jump_table.
4044       address dummy = (address) n;
4045       constant_addr = _masm.address_constant(dummy);
4046       // Expand jump-table
4047       for (uint i = 1; i &lt; n-&gt;outcnt(); i++) {
4048         address temp_addr = _masm.address_constant(dummy + i);
4049         assert(temp_addr, &quot;consts section too small&quot;);
4050       }
4051       break;
4052     }
4053     case T_METADATA: {
4054       Metadata* obj = con.get_metadata();
4055       int metadata_index = _masm.oop_recorder()-&gt;find_index(obj);
4056       constant_addr = _masm.address_constant((address) obj, metadata_Relocation::spec(metadata_index));
4057       break;
4058     }
4059     default: ShouldNotReachHere();
4060     }
4061     assert(constant_addr, &quot;consts section too small&quot;);
4062     assert((constant_addr - _masm.code()-&gt;consts()-&gt;start()) == con.offset(),
4063             &quot;must be: %d == %d&quot;, (int) (constant_addr - _masm.code()-&gt;consts()-&gt;start()), (int)(con.offset()));
4064   }
4065 }
4066 
4067 int Compile::ConstantTable::find_offset(Constant&amp; con) const {
4068   int idx = _constants.find(con);
4069   guarantee(idx != -1, &quot;constant must be in constant table&quot;);
4070   int offset = _constants.at(idx).offset();
4071   guarantee(offset != -1, &quot;constant table not emitted yet?&quot;);
4072   return offset;
4073 }
4074 
4075 void Compile::ConstantTable::add(Constant&amp; con) {
4076   if (con.can_be_reused()) {
4077     int idx = _constants.find(con);
4078     if (idx != -1 &amp;&amp; _constants.at(idx).can_be_reused()) {
4079       _constants.adr_at(idx)-&gt;inc_freq(con.freq());  // increase the frequency by the current value
4080       return;
4081     }
4082   }
4083   (void) _constants.append(con);
4084 }
4085 
4086 Compile::Constant Compile::ConstantTable::add(MachConstantNode* n, BasicType type, jvalue value) {
4087   Block* b = Compile::current()-&gt;cfg()-&gt;get_block_for_node(n);
4088   Constant con(type, value, b-&gt;_freq);
4089   add(con);
4090   return con;
4091 }
4092 
4093 Compile::Constant Compile::ConstantTable::add(Metadata* metadata) {
4094   Constant con(metadata);
4095   add(con);
4096   return con;
4097 }
4098 
4099 Compile::Constant Compile::ConstantTable::add(MachConstantNode* n, MachOper* oper) {
4100   jvalue value;
4101   BasicType type = oper-&gt;type()-&gt;basic_type();
4102   switch (type) {
4103   case T_LONG:    value.j = oper-&gt;constantL(); break;
4104   case T_FLOAT:   value.f = oper-&gt;constantF(); break;
4105   case T_DOUBLE:  value.d = oper-&gt;constantD(); break;
4106   case T_OBJECT:
4107   case T_ADDRESS: value.l = (jobject) oper-&gt;constant(); break;
4108   case T_METADATA: return add((Metadata*)oper-&gt;constant()); break;
4109   default: guarantee(false, &quot;unhandled type: %s&quot;, type2name(type));
4110   }
4111   return add(n, type, value);
4112 }
4113 
4114 Compile::Constant Compile::ConstantTable::add_jump_table(MachConstantNode* n) {
4115   jvalue value;
4116   // We can use the node pointer here to identify the right jump-table
4117   // as this method is called from Compile::Fill_buffer right before
4118   // the MachNodes are emitted and the jump-table is filled (means the
4119   // MachNode pointers do not change anymore).
4120   value.l = (jobject) n;
4121   Constant con(T_VOID, value, next_jump_table_freq(), false);  // Labels of a jump-table cannot be reused.
4122   add(con);
4123   return con;
4124 }
4125 
4126 void Compile::ConstantTable::fill_jump_table(CodeBuffer&amp; cb, MachConstantNode* n, GrowableArray&lt;Label*&gt; labels) const {
4127   // If called from Compile::scratch_emit_size do nothing.
4128   if (Compile::current()-&gt;in_scratch_emit_size())  return;
4129 
4130   assert(labels.is_nonempty(), &quot;must be&quot;);
4131   assert((uint) labels.length() == n-&gt;outcnt(), &quot;must be equal: %d == %d&quot;, labels.length(), n-&gt;outcnt());
4132 
4133   // Since MachConstantNode::constant_offset() also contains
4134   // table_base_offset() we need to subtract the table_base_offset()
4135   // to get the plain offset into the constant table.
4136   int offset = n-&gt;constant_offset() - table_base_offset();
4137 
4138   MacroAssembler _masm(&amp;cb);
4139   address* jump_table_base = (address*) (_masm.code()-&gt;consts()-&gt;start() + offset);
4140 
4141   for (uint i = 0; i &lt; n-&gt;outcnt(); i++) {
4142     address* constant_addr = &amp;jump_table_base[i];
4143     assert(*constant_addr == (((address) n) + i), &quot;all jump-table entries must contain adjusted node pointer: &quot; INTPTR_FORMAT &quot; == &quot; INTPTR_FORMAT, p2i(*constant_addr), p2i(((address) n) + i));
4144     *constant_addr = cb.consts()-&gt;target(*labels.at(i), (address) constant_addr);
4145     cb.consts()-&gt;relocate((address) constant_addr, relocInfo::internal_word_type);
4146   }
4147 }
4148 
4149 //----------------------------static_subtype_check-----------------------------
4150 // Shortcut important common cases when superklass is exact:
4151 // (0) superklass is java.lang.Object (can occur in reflective code)
4152 // (1) subklass is already limited to a subtype of superklass =&gt; always ok
4153 // (2) subklass does not overlap with superklass =&gt; always fail
4154 // (3) superklass has NO subtypes and we can check with a simple compare.
4155 int Compile::static_subtype_check(ciKlass* superk, ciKlass* subk) {
4156   if (StressReflectiveCode) {
4157     return SSC_full_test;       // Let caller generate the general case.
4158   }
4159 
4160   if (superk == env()-&gt;Object_klass()) {
4161     return SSC_always_true;     // (0) this test cannot fail
4162   }
4163 
4164   ciType* superelem = superk;
4165   if (superelem-&gt;is_array_klass())
4166     superelem = superelem-&gt;as_array_klass()-&gt;base_element_type();
4167 
4168   if (!subk-&gt;is_interface()) {  // cannot trust static interface types yet
4169     if (subk-&gt;is_subtype_of(superk)) {
4170       return SSC_always_true;   // (1) false path dead; no dynamic test needed
4171     }
4172     if (!(superelem-&gt;is_klass() &amp;&amp; superelem-&gt;as_klass()-&gt;is_interface()) &amp;&amp;
4173         !superk-&gt;is_subtype_of(subk)) {
4174       return SSC_always_false;
4175     }
4176   }
4177 
4178   // If casting to an instance klass, it must have no subtypes
4179   if (superk-&gt;is_interface()) {
4180     // Cannot trust interfaces yet.
4181     // %%% S.B. superk-&gt;nof_implementors() == 1
4182   } else if (superelem-&gt;is_instance_klass()) {
4183     ciInstanceKlass* ik = superelem-&gt;as_instance_klass();
4184     if (!ik-&gt;has_subklass() &amp;&amp; !ik-&gt;is_interface()) {
4185       if (!ik-&gt;is_final()) {
4186         // Add a dependency if there is a chance of a later subclass.
4187         dependencies()-&gt;assert_leaf_type(ik);
4188       }
<a name="58" id="anc58"></a>


4189       return SSC_easy_test;     // (3) caller can do a simple ptr comparison
4190     }
4191   } else {
4192     // A primitive array type has no subtypes.
4193     return SSC_easy_test;       // (3) caller can do a simple ptr comparison
4194   }
4195 
4196   return SSC_full_test;
4197 }
4198 
4199 Node* Compile::conv_I2X_index(PhaseGVN* phase, Node* idx, const TypeInt* sizetype, Node* ctrl) {
4200 #ifdef _LP64
4201   // The scaled index operand to AddP must be a clean 64-bit value.
4202   // Java allows a 32-bit int to be incremented to a negative
4203   // value, which appears in a 64-bit register as a large
4204   // positive number.  Using that large positive number as an
4205   // operand in pointer arithmetic has bad consequences.
4206   // On the other hand, 32-bit overflow is rare, and the possibility
4207   // can often be excluded, if we annotate the ConvI2L node with
4208   // a type assertion that its value is known to be a small positive
4209   // number.  (The prior range check has ensured this.)
4210   // This assertion is used by ConvI2LNode::Ideal.
4211   int index_max = max_jint - 1;  // array size is max_jint, index is one less
4212   if (sizetype != NULL) index_max = sizetype-&gt;_hi - 1;
4213   const TypeInt* iidxtype = TypeInt::make(0, index_max, Type::WidenMax);
4214   idx = constrained_convI2L(phase, idx, iidxtype, ctrl);
4215 #endif
4216   return idx;
4217 }
4218 
4219 // Convert integer value to a narrowed long type dependent on ctrl (for example, a range check)
4220 Node* Compile::constrained_convI2L(PhaseGVN* phase, Node* value, const TypeInt* itype, Node* ctrl) {
4221   if (ctrl != NULL) {
4222     // Express control dependency by a CastII node with a narrow type.
4223     value = new CastIINode(value, itype, false, true /* range check dependency */);
4224     // Make the CastII node dependent on the control input to prevent the narrowed ConvI2L
4225     // node from floating above the range check during loop optimizations. Otherwise, the
4226     // ConvI2L node may be eliminated independently of the range check, causing the data path
4227     // to become TOP while the control path is still there (although it&#39;s unreachable).
4228     value-&gt;set_req(0, ctrl);
4229     // Save CastII node to remove it after loop optimizations.
4230     phase-&gt;C-&gt;add_range_check_cast(value);
4231     value = phase-&gt;transform(value);
4232   }
4233   const TypeLong* ltype = TypeLong::make(itype-&gt;_lo, itype-&gt;_hi, itype-&gt;_widen);
4234   return phase-&gt;transform(new ConvI2LNode(value, ltype));
4235 }
4236 
<a name="59" id="anc59"></a>






4237 // The message about the current inlining is accumulated in
4238 // _print_inlining_stream and transfered into the _print_inlining_list
4239 // once we know whether inlining succeeds or not. For regular
4240 // inlining, messages are appended to the buffer pointed by
4241 // _print_inlining_idx in the _print_inlining_list. For late inlining,
4242 // a new buffer is added after _print_inlining_idx in the list. This
4243 // way we can update the inlining message for late inlining call site
4244 // when the inlining is attempted again.
4245 void Compile::print_inlining_init() {
4246   if (print_inlining() || print_intrinsics()) {
<a name="60" id="anc60"></a>

4247     _print_inlining_stream = new stringStream();
<a name="61" id="anc61"></a>




4248     _print_inlining_list = new (comp_arena())GrowableArray&lt;PrintInliningBuffer&gt;(comp_arena(), 1, 1, PrintInliningBuffer());
4249   }
4250 }
4251 
4252 void Compile::print_inlining_reinit() {
4253   if (print_inlining() || print_intrinsics()) {
<a name="62" id="anc62"></a>
4254     // Re allocate buffer when we change ResourceMark
4255     _print_inlining_stream = new stringStream();
4256   }
4257 }
4258 
4259 void Compile::print_inlining_reset() {
4260   _print_inlining_stream-&gt;reset();
4261 }
4262 
4263 void Compile::print_inlining_commit() {
4264   assert(print_inlining() || print_intrinsics(), &quot;PrintInlining off?&quot;);
4265   // Transfer the message from _print_inlining_stream to the current
4266   // _print_inlining_list buffer and clear _print_inlining_stream.
<a name="63" id="anc63"></a><span class="line-modified">4267   _print_inlining_list-&gt;at(_print_inlining_idx).ss()-&gt;write(_print_inlining_stream-&gt;as_string(), _print_inlining_stream-&gt;size());</span>
4268   print_inlining_reset();
4269 }
4270 
4271 void Compile::print_inlining_push() {
4272   // Add new buffer to the _print_inlining_list at current position
4273   _print_inlining_idx++;
4274   _print_inlining_list-&gt;insert_before(_print_inlining_idx, PrintInliningBuffer());
4275 }
4276 
4277 Compile::PrintInliningBuffer&amp; Compile::print_inlining_current() {
4278   return _print_inlining_list-&gt;at(_print_inlining_idx);
4279 }
4280 
4281 void Compile::print_inlining_update(CallGenerator* cg) {
4282   if (print_inlining() || print_intrinsics()) {
4283     if (!cg-&gt;is_late_inline()) {
4284       if (print_inlining_current().cg() != NULL) {
4285         print_inlining_push();
4286       }
4287       print_inlining_commit();
4288     } else {
4289       if (print_inlining_current().cg() != cg &amp;&amp;
4290           (print_inlining_current().cg() != NULL ||
4291            print_inlining_current().ss()-&gt;size() != 0)) {
4292         print_inlining_push();
4293       }
4294       print_inlining_commit();
4295       print_inlining_current().set_cg(cg);
4296     }
4297   }
4298 }
4299 
4300 void Compile::print_inlining_move_to(CallGenerator* cg) {
4301   // We resume inlining at a late inlining call site. Locate the
4302   // corresponding inlining buffer so that we can update it.
4303   if (print_inlining()) {
4304     for (int i = 0; i &lt; _print_inlining_list-&gt;length(); i++) {
4305       if (_print_inlining_list-&gt;adr_at(i)-&gt;cg() == cg) {
4306         _print_inlining_idx = i;
4307         return;
4308       }
4309     }
4310     ShouldNotReachHere();
4311   }
4312 }
4313 
4314 void Compile::print_inlining_update_delayed(CallGenerator* cg) {
4315   if (print_inlining()) {
4316     assert(_print_inlining_stream-&gt;size() &gt; 0, &quot;missing inlining msg&quot;);
4317     assert(print_inlining_current().cg() == cg, &quot;wrong entry&quot;);
4318     // replace message with new message
4319     _print_inlining_list-&gt;at_put(_print_inlining_idx, PrintInliningBuffer());
4320     print_inlining_commit();
4321     print_inlining_current().set_cg(cg);
4322   }
4323 }
4324 
4325 void Compile::print_inlining_assert_ready() {
4326   assert(!_print_inlining || _print_inlining_stream-&gt;size() == 0, &quot;loosing data&quot;);
4327 }
4328 
4329 void Compile::process_print_inlining() {
4330   bool do_print_inlining = print_inlining() || print_intrinsics();
4331   if (do_print_inlining || log() != NULL) {
4332     // Print inlining message for candidates that we couldn&#39;t inline
4333     // for lack of space
4334     for (int i = 0; i &lt; _late_inlines.length(); i++) {
4335       CallGenerator* cg = _late_inlines.at(i);
4336       if (!cg-&gt;is_mh_late_inline()) {
4337         const char* msg = &quot;live nodes &gt; LiveNodeCountInliningCutoff&quot;;
4338         if (do_print_inlining) {
4339           cg-&gt;print_inlining_late(msg);
4340         }
4341         log_late_inline_failure(cg, msg);
4342       }
4343     }
4344   }
4345   if (do_print_inlining) {
4346     ResourceMark rm;
4347     stringStream ss;
<a name="64" id="anc64"></a>
4348     for (int i = 0; i &lt; _print_inlining_list-&gt;length(); i++) {
4349       ss.print(&quot;%s&quot;, _print_inlining_list-&gt;adr_at(i)-&gt;ss()-&gt;as_string());
<a name="65" id="anc65"></a>
4350     }
<a name="66" id="anc66"></a>




4351     size_t end = ss.size();
4352     _print_inlining_output = NEW_ARENA_ARRAY(comp_arena(), char, end+1);
4353     strncpy(_print_inlining_output, ss.base(), end+1);
4354     _print_inlining_output[end] = 0;
4355   }
4356 }
4357 
4358 void Compile::dump_print_inlining() {
4359   if (_print_inlining_output != NULL) {
4360     tty-&gt;print_raw(_print_inlining_output);
4361   }
4362 }
4363 
4364 void Compile::log_late_inline(CallGenerator* cg) {
4365   if (log() != NULL) {
4366     log()-&gt;head(&quot;late_inline method=&#39;%d&#39;  inline_id=&#39;&quot; JLONG_FORMAT &quot;&#39;&quot;, log()-&gt;identify(cg-&gt;method()),
4367                 cg-&gt;unique_id());
4368     JVMState* p = cg-&gt;call_node()-&gt;jvms();
4369     while (p != NULL) {
4370       log()-&gt;elem(&quot;jvms bci=&#39;%d&#39; method=&#39;%d&#39;&quot;, p-&gt;bci(), log()-&gt;identify(p-&gt;method()));
4371       p = p-&gt;caller();
4372     }
4373     log()-&gt;tail(&quot;late_inline&quot;);
4374   }
4375 }
4376 
4377 void Compile::log_late_inline_failure(CallGenerator* cg, const char* msg) {
4378   log_late_inline(cg);
4379   if (log() != NULL) {
4380     log()-&gt;inline_fail(msg);
4381   }
4382 }
4383 
4384 void Compile::log_inline_id(CallGenerator* cg) {
4385   if (log() != NULL) {
4386     // The LogCompilation tool needs a unique way to identify late
4387     // inline call sites. This id must be unique for this call site in
4388     // this compilation. Try to have it unique across compilations as
4389     // well because it can be convenient when grepping through the log
4390     // file.
4391     // Distinguish OSR compilations from others in case CICountOSR is
4392     // on.
4393     jlong id = ((jlong)unique()) + (((jlong)compile_id()) &lt;&lt; 33) + (CICountOSR &amp;&amp; is_osr_compilation() ? ((jlong)1) &lt;&lt; 32 : 0);
4394     cg-&gt;set_unique_id(id);
4395     log()-&gt;elem(&quot;inline_id id=&#39;&quot; JLONG_FORMAT &quot;&#39;&quot;, id);
4396   }
4397 }
4398 
4399 void Compile::log_inline_failure(const char* msg) {
4400   if (C-&gt;log() != NULL) {
4401     C-&gt;log()-&gt;inline_fail(msg);
4402   }
4403 }
4404 
4405 
4406 // Dump inlining replay data to the stream.
4407 // Don&#39;t change thread state and acquire any locks.
4408 void Compile::dump_inline_data(outputStream* out) {
4409   InlineTree* inl_tree = ilt();
4410   if (inl_tree != NULL) {
4411     out-&gt;print(&quot; inline %d&quot;, inl_tree-&gt;count());
4412     inl_tree-&gt;dump_replay_data(out);
4413   }
4414 }
4415 
4416 int Compile::cmp_expensive_nodes(Node* n1, Node* n2) {
4417   if (n1-&gt;Opcode() &lt; n2-&gt;Opcode())      return -1;
4418   else if (n1-&gt;Opcode() &gt; n2-&gt;Opcode()) return 1;
4419 
4420   assert(n1-&gt;req() == n2-&gt;req(), &quot;can&#39;t compare %s nodes: n1-&gt;req() = %d, n2-&gt;req() = %d&quot;, NodeClassNames[n1-&gt;Opcode()], n1-&gt;req(), n2-&gt;req());
4421   for (uint i = 1; i &lt; n1-&gt;req(); i++) {
4422     if (n1-&gt;in(i) &lt; n2-&gt;in(i))      return -1;
4423     else if (n1-&gt;in(i) &gt; n2-&gt;in(i)) return 1;
4424   }
4425 
4426   return 0;
4427 }
4428 
4429 int Compile::cmp_expensive_nodes(Node** n1p, Node** n2p) {
4430   Node* n1 = *n1p;
4431   Node* n2 = *n2p;
4432 
4433   return cmp_expensive_nodes(n1, n2);
4434 }
4435 
4436 void Compile::sort_expensive_nodes() {
4437   if (!expensive_nodes_sorted()) {
4438     _expensive_nodes-&gt;sort(cmp_expensive_nodes);
4439   }
4440 }
4441 
4442 bool Compile::expensive_nodes_sorted() const {
4443   for (int i = 1; i &lt; _expensive_nodes-&gt;length(); i++) {
4444     if (cmp_expensive_nodes(_expensive_nodes-&gt;adr_at(i), _expensive_nodes-&gt;adr_at(i-1)) &lt; 0) {
4445       return false;
4446     }
4447   }
4448   return true;
4449 }
4450 
4451 bool Compile::should_optimize_expensive_nodes(PhaseIterGVN &amp;igvn) {
4452   if (_expensive_nodes-&gt;length() == 0) {
4453     return false;
4454   }
4455 
4456   assert(OptimizeExpensiveOps, &quot;optimization off?&quot;);
4457 
4458   // Take this opportunity to remove dead nodes from the list
4459   int j = 0;
4460   for (int i = 0; i &lt; _expensive_nodes-&gt;length(); i++) {
4461     Node* n = _expensive_nodes-&gt;at(i);
4462     if (!n-&gt;is_unreachable(igvn)) {
4463       assert(n-&gt;is_expensive(), &quot;should be expensive&quot;);
4464       _expensive_nodes-&gt;at_put(j, n);
4465       j++;
4466     }
4467   }
4468   _expensive_nodes-&gt;trunc_to(j);
4469 
4470   // Then sort the list so that similar nodes are next to each other
4471   // and check for at least two nodes of identical kind with same data
4472   // inputs.
4473   sort_expensive_nodes();
4474 
4475   for (int i = 0; i &lt; _expensive_nodes-&gt;length()-1; i++) {
4476     if (cmp_expensive_nodes(_expensive_nodes-&gt;adr_at(i), _expensive_nodes-&gt;adr_at(i+1)) == 0) {
4477       return true;
4478     }
4479   }
4480 
4481   return false;
4482 }
4483 
4484 void Compile::cleanup_expensive_nodes(PhaseIterGVN &amp;igvn) {
4485   if (_expensive_nodes-&gt;length() == 0) {
4486     return;
4487   }
4488 
4489   assert(OptimizeExpensiveOps, &quot;optimization off?&quot;);
4490 
4491   // Sort to bring similar nodes next to each other and clear the
4492   // control input of nodes for which there&#39;s only a single copy.
4493   sort_expensive_nodes();
4494 
4495   int j = 0;
4496   int identical = 0;
4497   int i = 0;
4498   bool modified = false;
4499   for (; i &lt; _expensive_nodes-&gt;length()-1; i++) {
4500     assert(j &lt;= i, &quot;can&#39;t write beyond current index&quot;);
4501     if (_expensive_nodes-&gt;at(i)-&gt;Opcode() == _expensive_nodes-&gt;at(i+1)-&gt;Opcode()) {
4502       identical++;
4503       _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4504       continue;
4505     }
4506     if (identical &gt; 0) {
4507       _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4508       identical = 0;
4509     } else {
4510       Node* n = _expensive_nodes-&gt;at(i);
4511       igvn.replace_input_of(n, 0, NULL);
4512       igvn.hash_insert(n);
4513       modified = true;
4514     }
4515   }
4516   if (identical &gt; 0) {
4517     _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4518   } else if (_expensive_nodes-&gt;length() &gt;= 1) {
4519     Node* n = _expensive_nodes-&gt;at(i);
4520     igvn.replace_input_of(n, 0, NULL);
4521     igvn.hash_insert(n);
4522     modified = true;
4523   }
4524   _expensive_nodes-&gt;trunc_to(j);
4525   if (modified) {
4526     igvn.optimize();
4527   }
4528 }
4529 
4530 void Compile::add_expensive_node(Node * n) {
4531   assert(!_expensive_nodes-&gt;contains(n), &quot;duplicate entry in expensive list&quot;);
4532   assert(n-&gt;is_expensive(), &quot;expensive nodes with non-null control here only&quot;);
4533   assert(!n-&gt;is_CFG() &amp;&amp; !n-&gt;is_Mem(), &quot;no cfg or memory nodes here&quot;);
4534   if (OptimizeExpensiveOps) {
4535     _expensive_nodes-&gt;append(n);
4536   } else {
4537     // Clear control input and let IGVN optimize expensive nodes if
4538     // OptimizeExpensiveOps is off.
4539     n-&gt;set_req(0, NULL);
4540   }
4541 }
4542 
4543 /**
4544  * Remove the speculative part of types and clean up the graph
4545  */
4546 void Compile::remove_speculative_types(PhaseIterGVN &amp;igvn) {
4547   if (UseTypeSpeculation) {
4548     Unique_Node_List worklist;
4549     worklist.push(root());
4550     int modified = 0;
4551     // Go over all type nodes that carry a speculative type, drop the
4552     // speculative part of the type and enqueue the node for an igvn
4553     // which may optimize it out.
4554     for (uint next = 0; next &lt; worklist.size(); ++next) {
4555       Node *n  = worklist.at(next);
4556       if (n-&gt;is_Type()) {
4557         TypeNode* tn = n-&gt;as_Type();
4558         const Type* t = tn-&gt;type();
4559         const Type* t_no_spec = t-&gt;remove_speculative();
4560         if (t_no_spec != t) {
4561           bool in_hash = igvn.hash_delete(n);
4562           assert(in_hash, &quot;node should be in igvn hash table&quot;);
4563           tn-&gt;set_type(t_no_spec);
4564           igvn.hash_insert(n);
4565           igvn._worklist.push(n); // give it a chance to go away
4566           modified++;
4567         }
4568       }
4569       uint max = n-&gt;len();
4570       for( uint i = 0; i &lt; max; ++i ) {
4571         Node *m = n-&gt;in(i);
4572         if (not_a_node(m))  continue;
4573         worklist.push(m);
4574       }
4575     }
4576     // Drop the speculative part of all types in the igvn&#39;s type table
4577     igvn.remove_speculative_types();
4578     if (modified &gt; 0) {
4579       igvn.optimize();
4580     }
4581 #ifdef ASSERT
4582     // Verify that after the IGVN is over no speculative type has resurfaced
4583     worklist.clear();
4584     worklist.push(root());
4585     for (uint next = 0; next &lt; worklist.size(); ++next) {
4586       Node *n  = worklist.at(next);
4587       const Type* t = igvn.type_or_null(n);
4588       assert((t == NULL) || (t == t-&gt;remove_speculative()), &quot;no more speculative types&quot;);
4589       if (n-&gt;is_Type()) {
4590         t = n-&gt;as_Type()-&gt;type();
4591         assert(t == t-&gt;remove_speculative(), &quot;no more speculative types&quot;);
4592       }
4593       uint max = n-&gt;len();
4594       for( uint i = 0; i &lt; max; ++i ) {
4595         Node *m = n-&gt;in(i);
4596         if (not_a_node(m))  continue;
4597         worklist.push(m);
4598       }
4599     }
4600     igvn.check_no_speculative_types();
4601 #endif
4602   }
4603 }
4604 
4605 // Auxiliary method to support randomized stressing/fuzzing.
4606 //
4607 // This method can be called the arbitrary number of times, with current count
4608 // as the argument. The logic allows selecting a single candidate from the
4609 // running list of candidates as follows:
4610 //    int count = 0;
4611 //    Cand* selected = null;
4612 //    while(cand = cand-&gt;next()) {
4613 //      if (randomized_select(++count)) {
4614 //        selected = cand;
4615 //      }
4616 //    }
4617 //
4618 // Including count equalizes the chances any candidate is &quot;selected&quot;.
4619 // This is useful when we don&#39;t have the complete list of candidates to choose
4620 // from uniformly. In this case, we need to adjust the randomicity of the
4621 // selection, or else we will end up biasing the selection towards the latter
4622 // candidates.
4623 //
4624 // Quick back-envelope calculation shows that for the list of n candidates
4625 // the equal probability for the candidate to persist as &quot;best&quot; can be
4626 // achieved by replacing it with &quot;next&quot; k-th candidate with the probability
4627 // of 1/k. It can be easily shown that by the end of the run, the
4628 // probability for any candidate is converged to 1/n, thus giving the
4629 // uniform distribution among all the candidates.
4630 //
4631 // We don&#39;t care about the domain size as long as (RANDOMIZED_DOMAIN / count) is large.
4632 #define RANDOMIZED_DOMAIN_POW 29
4633 #define RANDOMIZED_DOMAIN (1 &lt;&lt; RANDOMIZED_DOMAIN_POW)
4634 #define RANDOMIZED_DOMAIN_MASK ((1 &lt;&lt; (RANDOMIZED_DOMAIN_POW + 1)) - 1)
4635 bool Compile::randomized_select(int count) {
4636   assert(count &gt; 0, &quot;only positive&quot;);
4637   return (os::random() &amp; RANDOMIZED_DOMAIN_MASK) &lt; (RANDOMIZED_DOMAIN / count);
4638 }
4639 
4640 CloneMap&amp;     Compile::clone_map()                 { return _clone_map; }
4641 void          Compile::set_clone_map(Dict* d)      { _clone_map._dict = d; }
4642 
4643 void NodeCloneInfo::dump() const {
4644   tty-&gt;print(&quot; {%d:%d} &quot;, idx(), gen());
4645 }
4646 
4647 void CloneMap::clone(Node* old, Node* nnn, int gen) {
4648   uint64_t val = value(old-&gt;_idx);
4649   NodeCloneInfo cio(val);
4650   assert(val != 0, &quot;old node should be in the map&quot;);
4651   NodeCloneInfo cin(cio.idx(), gen + cio.gen());
4652   insert(nnn-&gt;_idx, cin.get());
4653 #ifndef PRODUCT
4654   if (is_debug()) {
4655     tty-&gt;print_cr(&quot;CloneMap::clone inserted node %d info {%d:%d} into CloneMap&quot;, nnn-&gt;_idx, cin.idx(), cin.gen());
4656   }
4657 #endif
4658 }
4659 
4660 void CloneMap::verify_insert_and_clone(Node* old, Node* nnn, int gen) {
4661   NodeCloneInfo cio(value(old-&gt;_idx));
4662   if (cio.get() == 0) {
4663     cio.set(old-&gt;_idx, 0);
4664     insert(old-&gt;_idx, cio.get());
4665 #ifndef PRODUCT
4666     if (is_debug()) {
4667       tty-&gt;print_cr(&quot;CloneMap::verify_insert_and_clone inserted node %d info {%d:%d} into CloneMap&quot;, old-&gt;_idx, cio.idx(), cio.gen());
4668     }
4669 #endif
4670   }
4671   clone(old, nnn, gen);
4672 }
4673 
4674 int CloneMap::max_gen() const {
4675   int g = 0;
4676   DictI di(_dict);
4677   for(; di.test(); ++di) {
4678     int t = gen(di._key);
4679     if (g &lt; t) {
4680       g = t;
4681 #ifndef PRODUCT
4682       if (is_debug()) {
4683         tty-&gt;print_cr(&quot;CloneMap::max_gen() update max=%d from %d&quot;, g, _2_node_idx_t(di._key));
4684       }
4685 #endif
4686     }
4687   }
4688   return g;
4689 }
4690 
4691 void CloneMap::dump(node_idx_t key) const {
4692   uint64_t val = value(key);
4693   if (val != 0) {
4694     NodeCloneInfo ni(val);
4695     ni.dump();
4696   }
4697 }
<a name="67" id="anc67"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="67" type="hidden" />
</body>
</html>