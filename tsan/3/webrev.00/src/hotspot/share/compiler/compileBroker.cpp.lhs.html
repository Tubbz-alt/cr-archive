<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/compiler/compileBroker.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/symbolTable.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/codeHeapState.hpp&quot;
  32 #include &quot;code/dependencyContext.hpp&quot;
<a name="2" id="anc2"></a>
  33 #include &quot;compiler/compileBroker.hpp&quot;
  34 #include &quot;compiler/compileLog.hpp&quot;
  35 #include &quot;compiler/compilerOracle.hpp&quot;
  36 #include &quot;compiler/directivesParser.hpp&quot;
  37 #include &quot;interpreter/linkResolver.hpp&quot;
  38 #include &quot;jfr/jfrEvents.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;logging/logStream.hpp&quot;
  41 #include &quot;memory/allocation.inline.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
<a name="3" id="anc3"></a>
  43 #include &quot;oops/methodData.hpp&quot;
  44 #include &quot;oops/method.inline.hpp&quot;
  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;prims/nativeLookup.hpp&quot;
  47 #include &quot;prims/whitebox.hpp&quot;
  48 #include &quot;runtime/arguments.hpp&quot;
  49 #include &quot;runtime/atomic.hpp&quot;
<a name="4" id="anc4"></a><span class="line-removed">  50 #include &quot;runtime/compilationPolicy.hpp&quot;</span>
  51 #include &quot;runtime/handles.inline.hpp&quot;
  52 #include &quot;runtime/init.hpp&quot;
  53 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  54 #include &quot;runtime/javaCalls.hpp&quot;
  55 #include &quot;runtime/jniHandles.inline.hpp&quot;
  56 #include &quot;runtime/os.hpp&quot;
  57 #include &quot;runtime/safepointVerifiers.hpp&quot;
  58 #include &quot;runtime/sharedRuntime.hpp&quot;
  59 #include &quot;runtime/sweeper.hpp&quot;
  60 #include &quot;runtime/timerTrace.hpp&quot;
  61 #include &quot;runtime/vframe.inline.hpp&quot;
  62 #include &quot;utilities/debug.hpp&quot;
  63 #include &quot;utilities/dtrace.hpp&quot;
  64 #include &quot;utilities/events.hpp&quot;
  65 #include &quot;utilities/formatBuffer.hpp&quot;
  66 #include &quot;utilities/macros.hpp&quot;
  67 #ifdef COMPILER1
  68 #include &quot;c1/c1_Compiler.hpp&quot;
  69 #endif
  70 #if INCLUDE_JVMCI
<a name="5" id="anc5"></a><span class="line-modified">  71 #include &quot;jvmci/jvmciCompiler.hpp&quot;</span>
  72 #include &quot;jvmci/jvmciRuntime.hpp&quot;
<a name="6" id="anc6"></a><span class="line-removed">  73 #include &quot;jvmci/jvmciJavaClasses.hpp&quot;</span>
<span class="line-removed">  74 #include &quot;runtime/vframe.hpp&quot;</span>
  75 #endif
  76 #ifdef COMPILER2
  77 #include &quot;opto/c2compiler.hpp&quot;
  78 #endif
  79 
  80 #ifdef DTRACE_ENABLED
  81 
  82 // Only bother with this argument setup if dtrace is available
  83 
  84 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  85   {                                                                      \
  86     Symbol* klass_name = (method)-&gt;klass_name();                         \
  87     Symbol* name = (method)-&gt;name();                                     \
  88     Symbol* signature = (method)-&gt;signature();                           \
  89     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  90       (char *) comp_name, strlen(comp_name),                             \
  91       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  92       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  93       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  94   }
  95 
  96 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  97   {                                                                      \
  98     Symbol* klass_name = (method)-&gt;klass_name();                         \
  99     Symbol* name = (method)-&gt;name();                                     \
 100     Symbol* signature = (method)-&gt;signature();                           \
 101     HOTSPOT_METHOD_COMPILE_END(                                          \
 102       (char *) comp_name, strlen(comp_name),                             \
 103       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
 104       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
 105       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
 106   }
 107 
 108 #else //  ndef DTRACE_ENABLED
 109 
 110 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 111 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 112 
 113 #endif // ndef DTRACE_ENABLED
 114 
 115 bool CompileBroker::_initialized = false;
 116 volatile bool CompileBroker::_should_block = false;
 117 volatile int  CompileBroker::_print_compilation_warning = 0;
 118 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 119 
 120 // The installed compiler(s)
 121 AbstractCompiler* CompileBroker::_compilers[2];
 122 
 123 // The maximum numbers of compiler threads to be determined during startup.
 124 int CompileBroker::_c1_count = 0;
 125 int CompileBroker::_c2_count = 0;
 126 
 127 // An array of compiler names as Java String objects
 128 jobject* CompileBroker::_compiler1_objects = NULL;
 129 jobject* CompileBroker::_compiler2_objects = NULL;
 130 
 131 CompileLog** CompileBroker::_compiler1_logs = NULL;
 132 CompileLog** CompileBroker::_compiler2_logs = NULL;
 133 
 134 // These counters are used to assign an unique ID to each compilation.
 135 volatile jint CompileBroker::_compilation_id     = 0;
 136 volatile jint CompileBroker::_osr_compilation_id = 0;
 137 
<a name="7" id="anc7"></a><span class="line-removed"> 138 // Debugging information</span>
<span class="line-removed"> 139 int  CompileBroker::_last_compile_type     = no_compile;</span>
<span class="line-removed"> 140 int  CompileBroker::_last_compile_level    = CompLevel_none;</span>
<span class="line-removed"> 141 char CompileBroker::_last_method_compiled[CompileBroker::name_buffer_length];</span>
<span class="line-removed"> 142 </span>
 143 // Performance counters
 144 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 145 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 146 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 147 
 148 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 149 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 150 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 151 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 152 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 153 
 154 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 155 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 156 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 157 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 158 
 159 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 160 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 161 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 162 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 163 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 164 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 165 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 166 
 167 // Timers and counters for generating statistics
 168 elapsedTimer CompileBroker::_t_total_compilation;
 169 elapsedTimer CompileBroker::_t_osr_compilation;
 170 elapsedTimer CompileBroker::_t_standard_compilation;
 171 elapsedTimer CompileBroker::_t_invalidated_compilation;
 172 elapsedTimer CompileBroker::_t_bailedout_compilation;
 173 
 174 int CompileBroker::_total_bailout_count            = 0;
 175 int CompileBroker::_total_invalidated_count        = 0;
 176 int CompileBroker::_total_compile_count            = 0;
 177 int CompileBroker::_total_osr_compile_count        = 0;
 178 int CompileBroker::_total_standard_compile_count   = 0;
 179 int CompileBroker::_total_compiler_stopped_count   = 0;
 180 int CompileBroker::_total_compiler_restarted_count = 0;
 181 
 182 int CompileBroker::_sum_osr_bytes_compiled         = 0;
 183 int CompileBroker::_sum_standard_bytes_compiled    = 0;
 184 int CompileBroker::_sum_nmethod_size               = 0;
 185 int CompileBroker::_sum_nmethod_code_size          = 0;
 186 
 187 long CompileBroker::_peak_compilation_time         = 0;
 188 
 189 CompileQueue* CompileBroker::_c2_compile_queue     = NULL;
 190 CompileQueue* CompileBroker::_c1_compile_queue     = NULL;
 191 
 192 
 193 
 194 class CompilationLog : public StringEventLog {
 195  public:
<a name="8" id="anc8"></a><span class="line-modified"> 196   CompilationLog() : StringEventLog(&quot;Compilation events&quot;) {</span>
 197   }
 198 
 199   void log_compile(JavaThread* thread, CompileTask* task) {
 200     StringLogMessage lm;
<a name="9" id="anc9"></a><span class="line-modified"> 201     stringStream sstr = lm.stream();</span>
 202     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 203     task-&gt;print(&amp;sstr, NULL, true, false);
 204     log(thread, &quot;%s&quot;, (const char*)lm);
 205   }
 206 
 207   void log_nmethod(JavaThread* thread, nmethod* nm) {
 208     log(thread, &quot;nmethod %d%s &quot; INTPTR_FORMAT &quot; code [&quot; INTPTR_FORMAT &quot;, &quot; INTPTR_FORMAT &quot;]&quot;,
 209         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? &quot;%&quot; : &quot;&quot;,
 210         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 211   }
 212 
 213   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 214     StringLogMessage lm;
 215     lm.print(&quot;%4d   COMPILE SKIPPED: %s&quot;, task-&gt;compile_id(), reason);
 216     if (retry_message != NULL) {
 217       lm.append(&quot; (%s)&quot;, retry_message);
 218     }
 219     lm.print(&quot;\n&quot;);
 220     log(thread, &quot;%s&quot;, (const char*)lm);
 221   }
 222 
 223   void log_metaspace_failure(const char* reason) {
 224     ResourceMark rm;
 225     StringLogMessage lm;
 226     lm.print(&quot;%4d   COMPILE PROFILING SKIPPED: %s&quot;, -1, reason);
 227     lm.print(&quot;\n&quot;);
 228     log(JavaThread::current(), &quot;%s&quot;, (const char*)lm);
 229   }
 230 };
 231 
 232 static CompilationLog* _compilation_log = NULL;
 233 
 234 bool compileBroker_init() {
 235   if (LogEvents) {
 236     _compilation_log = new CompilationLog();
 237   }
 238 
 239   // init directives stack, adding default directive
 240   DirectivesStack::init();
 241 
 242   if (DirectivesParser::has_file()) {
 243     return DirectivesParser::parse_from_flag();
 244   } else if (CompilerDirectivesPrint) {
 245     // Print default directive even when no other was added
 246     DirectivesStack::print(tty);
 247   }
 248 
 249   return true;
 250 }
 251 
 252 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 253   CompilerThread* thread = CompilerThread::current();
 254   thread-&gt;set_task(task);
 255 #if INCLUDE_JVMCI
 256   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 257     task-&gt;set_jvmci_compiler_thread(thread);
 258   }
 259 #endif
 260   CompileLog*     log  = thread-&gt;log();
 261   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_start(log);
 262 }
 263 
 264 CompileTaskWrapper::~CompileTaskWrapper() {
 265   CompilerThread* thread = CompilerThread::current();
 266   CompileTask* task = thread-&gt;task();
 267   CompileLog*  log  = thread-&gt;log();
 268   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_done(log);
 269   thread-&gt;set_task(NULL);
 270   task-&gt;set_code_handle(NULL);
 271   thread-&gt;set_env(NULL);
 272   if (task-&gt;is_blocking()) {
 273     bool free_task = false;
 274     {
<a name="10" id="anc10"></a><span class="line-modified"> 275       MutexLocker notifier(task-&gt;lock(), thread);</span>
 276       task-&gt;mark_complete();
 277 #if INCLUDE_JVMCI
 278       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 279         if (!task-&gt;has_waiter()) {
 280           // The waiting thread timed out and thus did not free the task.
 281           free_task = true;
 282         }
 283         task-&gt;set_jvmci_compiler_thread(NULL);
 284       }
 285 #endif
 286       if (!free_task) {
 287         // Notify the waiting thread that the compilation has completed
 288         // so that it can free the task.
 289         task-&gt;lock()-&gt;notify_all();
 290       }
 291     }
 292     if (free_task) {
 293       // The task can only be freed once the task lock is released.
 294       CompileTask::free(task);
 295     }
 296   } else {
 297     task-&gt;mark_complete();
 298 
 299     // By convention, the compiling thread is responsible for
 300     // recycling a non-blocking CompileTask.
 301     CompileTask::free(task);
 302   }
 303 }
 304 
 305 /**
 306  * Check if a CompilerThread can be removed and update count if requested.
 307  */
<a name="11" id="anc11"></a><span class="line-modified"> 308 static bool can_remove(CompilerThread *ct, bool do_it) {</span>
 309   assert(UseDynamicNumberOfCompilerThreads, &quot;or shouldn&#39;t be here&quot;);
 310   if (!ReduceNumberOfCompilerThreads) return false;
 311 
 312   AbstractCompiler *compiler = ct-&gt;compiler();
 313   int compiler_count = compiler-&gt;num_compiler_threads();
 314   bool c1 = compiler-&gt;is_c1();
 315 
 316   // Keep at least 1 compiler thread of each type.
 317   if (compiler_count &lt; 2) return false;
 318 
 319   // Keep thread alive for at least some time.
 320   if (ct-&gt;idle_time_millis() &lt; (c1 ? 500 : 100)) return false;
 321 
<a name="12" id="anc12"></a>











 322   // We only allow the last compiler thread of each type to get removed.
<a name="13" id="anc13"></a><span class="line-modified"> 323   jobject last_compiler = c1 ? CompileBroker::compiler1_object(compiler_count - 1)</span>
<span class="line-modified"> 324                              : CompileBroker::compiler2_object(compiler_count - 1);</span>
<span class="line-modified"> 325   if (oopDesc::equals(ct-&gt;threadObj(), JNIHandles::resolve_non_null(last_compiler))) {</span>
 326     if (do_it) {
 327       assert_locked_or_safepoint(CompileThread_lock); // Update must be consistent.
 328       compiler-&gt;set_num_compiler_threads(compiler_count - 1);
<a name="14" id="anc14"></a>






 329     }
 330     return true;
 331   }
 332   return false;
 333 }
 334 
 335 /**
 336  * Add a CompileTask to a CompileQueue.
 337  */
 338 void CompileQueue::add(CompileTask* task) {
 339   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 340 
 341   task-&gt;set_next(NULL);
 342   task-&gt;set_prev(NULL);
 343 
 344   if (_last == NULL) {
 345     // The compile queue is empty.
 346     assert(_first == NULL, &quot;queue is empty&quot;);
 347     _first = task;
 348     _last = task;
 349   } else {
 350     // Append the task to the queue.
 351     assert(_last-&gt;next() == NULL, &quot;not last&quot;);
 352     _last-&gt;set_next(task);
 353     task-&gt;set_prev(_last);
 354     _last = task;
 355   }
 356   ++_size;
 357 
 358   // Mark the method as being in the compile queue.
 359   task-&gt;method()-&gt;set_queued_for_compilation();
 360 
 361   if (CIPrintCompileQueue) {
 362     print_tty();
 363   }
 364 
 365   if (LogCompilation &amp;&amp; xtty != NULL) {
 366     task-&gt;log_task_queued();
 367   }
 368 
 369   // Notify CompilerThreads that a task is available.
 370   MethodCompileQueue_lock-&gt;notify_all();
 371 }
 372 
 373 /**
 374  * Empties compilation queue by putting all compilation tasks onto
 375  * a freelist. Furthermore, the method wakes up all threads that are
 376  * waiting on a compilation task to finish. This can happen if background
 377  * compilation is disabled.
 378  */
 379 void CompileQueue::free_all() {
 380   MutexLocker mu(MethodCompileQueue_lock);
 381   CompileTask* next = _first;
 382 
 383   // Iterate over all tasks in the compile queue
 384   while (next != NULL) {
 385     CompileTask* current = next;
 386     next = current-&gt;next();
 387     {
 388       // Wake up thread that blocks on the compile task.
 389       MutexLocker ct_lock(current-&gt;lock());
 390       current-&gt;lock()-&gt;notify();
 391     }
 392     // Put the task back on the freelist.
 393     CompileTask::free(current);
 394   }
 395   _first = NULL;
 396 
 397   // Wake up all threads that block on the queue.
 398   MethodCompileQueue_lock-&gt;notify_all();
 399 }
 400 
 401 /**
 402  * Get the next CompileTask from a CompileQueue
 403  */
 404 CompileTask* CompileQueue::get() {
 405   // save methods from RedefineClasses across safepoint
 406   // across MethodCompileQueue_lock below.
 407   methodHandle save_method;
 408   methodHandle save_hot_method;
 409 
<a name="15" id="anc15"></a><span class="line-modified"> 410   MutexLocker locker(MethodCompileQueue_lock);</span>
 411   // If _first is NULL we have no more compile jobs. There are two reasons for
 412   // having no compile jobs: First, we compiled everything we wanted. Second,
 413   // we ran out of code cache so compilation has been disabled. In the latter
 414   // case we perform code cache sweeps to free memory such that we can re-enable
 415   // compilation.
 416   while (_first == NULL) {
 417     // Exit loop if compilation is disabled forever
 418     if (CompileBroker::is_compilation_disabled_forever()) {
 419       return NULL;
 420     }
 421 
 422     // If there are no compilation tasks and we can compile new jobs
 423     // (i.e., there is enough free space in the code cache) there is
 424     // no need to invoke the sweeper. As a result, the hotness of methods
 425     // remains unchanged. This behavior is desired, since we want to keep
 426     // the stable state, i.e., we do not want to evict methods from the
 427     // code cache if it is unnecessary.
 428     // We need a timed wait here, since compiler threads can exit if compilation
 429     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 430     // is not critical and we do not want idle compiler threads to wake up too often.
<a name="16" id="anc16"></a><span class="line-modified"> 431     MethodCompileQueue_lock-&gt;wait(!Mutex::_no_safepoint_check_flag, 5*1000);</span>
 432 
 433     if (UseDynamicNumberOfCompilerThreads &amp;&amp; _first == NULL) {
 434       // Still nothing to compile. Give caller a chance to stop this thread.
<a name="17" id="anc17"></a><span class="line-modified"> 435       if (can_remove(CompilerThread::current(), false)) return NULL;</span>
 436     }
 437   }
 438 
 439   if (CompileBroker::is_compilation_disabled_forever()) {
 440     return NULL;
 441   }
 442 
 443   CompileTask* task;
 444   {
 445     NoSafepointVerifier nsv;
 446     task = CompilationPolicy::policy()-&gt;select_task(this);
 447     if (task != NULL) {
 448       task = task-&gt;select_for_compilation();
 449     }
 450   }
 451 
 452   if (task != NULL) {
 453     // Save method pointers across unlock safepoint.  The task is removed from
 454     // the compilation queue, which is walked during RedefineClasses.
<a name="18" id="anc18"></a><span class="line-modified"> 455     save_method = methodHandle(task-&gt;method());</span>
<span class="line-modified"> 456     save_hot_method = methodHandle(task-&gt;hot_method());</span>

 457 
 458     remove(task);
<a name="19" id="anc19"></a><span class="line-removed"> 459     purge_stale_tasks(); // may temporarily release MCQ lock</span>
 460   }
<a name="20" id="anc20"></a>
 461   return task;
 462 }
 463 
 464 // Clean &amp; deallocate stale compile tasks.
 465 // Temporarily releases MethodCompileQueue lock.
 466 void CompileQueue::purge_stale_tasks() {
 467   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 468   if (_first_stale != NULL) {
 469     // Stale tasks are purged when MCQ lock is released,
 470     // but _first_stale updates are protected by MCQ lock.
 471     // Once task processing starts and MCQ lock is released,
 472     // other compiler threads can reuse _first_stale.
 473     CompileTask* head = _first_stale;
 474     _first_stale = NULL;
 475     {
 476       MutexUnlocker ul(MethodCompileQueue_lock);
 477       for (CompileTask* task = head; task != NULL; ) {
 478         CompileTask* next_task = task-&gt;next();
 479         CompileTaskWrapper ctw(task); // Frees the task
 480         task-&gt;set_failure_reason(&quot;stale task&quot;);
 481         task = next_task;
 482       }
 483     }
 484   }
 485 }
 486 
 487 void CompileQueue::remove(CompileTask* task) {
 488   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 489   if (task-&gt;prev() != NULL) {
 490     task-&gt;prev()-&gt;set_next(task-&gt;next());
 491   } else {
 492     // max is the first element
 493     assert(task == _first, &quot;Sanity&quot;);
 494     _first = task-&gt;next();
 495   }
 496 
 497   if (task-&gt;next() != NULL) {
 498     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 499   } else {
 500     // max is the last element
 501     assert(task == _last, &quot;Sanity&quot;);
 502     _last = task-&gt;prev();
 503   }
 504   --_size;
 505 }
 506 
 507 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 508   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 509   remove(task);
 510 
 511   // Enqueue the task for reclamation (should be done outside MCQ lock)
 512   task-&gt;set_next(_first_stale);
 513   task-&gt;set_prev(NULL);
 514   _first_stale = task;
 515 }
 516 
 517 // methods in the compile queue need to be marked as used on the stack
 518 // so that they don&#39;t get reclaimed by Redefine Classes
 519 void CompileQueue::mark_on_stack() {
 520   CompileTask* task = _first;
 521   while (task != NULL) {
 522     task-&gt;mark_on_stack();
 523     task = task-&gt;next();
 524   }
 525 }
 526 
 527 
 528 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 529   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 530   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 531   return NULL;
 532 }
 533 
 534 void CompileBroker::print_compile_queues(outputStream* st) {
 535   st-&gt;print_cr(&quot;Current compiles: &quot;);
 536 
 537   char buf[2000];
 538   int buflen = sizeof(buf);
 539   Threads::print_threads_compiling(st, buf, buflen, /* short_form = */ true);
 540 
 541   st-&gt;cr();
 542   if (_c1_compile_queue != NULL) {
 543     _c1_compile_queue-&gt;print(st);
 544   }
 545   if (_c2_compile_queue != NULL) {
 546     _c2_compile_queue-&gt;print(st);
 547   }
 548 }
 549 
 550 void CompileQueue::print(outputStream* st) {
 551   assert_locked_or_safepoint(MethodCompileQueue_lock);
 552   st-&gt;print_cr(&quot;%s:&quot;, name());
 553   CompileTask* task = _first;
 554   if (task == NULL) {
 555     st-&gt;print_cr(&quot;Empty&quot;);
 556   } else {
 557     while (task != NULL) {
 558       task-&gt;print(st, NULL, true, true);
 559       task = task-&gt;next();
 560     }
 561   }
 562   st-&gt;cr();
 563 }
 564 
 565 void CompileQueue::print_tty() {
<a name="21" id="anc21"></a><span class="line-modified"> 566   ttyLocker ttyl;</span>
<span class="line-modified"> 567   print(tty);</span>






 568 }
 569 
 570 CompilerCounters::CompilerCounters() {
 571   _current_method[0] = &#39;\0&#39;;
 572   _compile_type = CompileBroker::no_compile;
 573 }
 574 
 575 // ------------------------------------------------------------------
 576 // CompileBroker::compilation_init
 577 //
 578 // Initialize the Compilation object
<a name="22" id="anc22"></a><span class="line-modified"> 579 void CompileBroker::compilation_init_phase1(TRAPS) {</span>
<span class="line-removed"> 580   _last_method_compiled[0] = &#39;\0&#39;;</span>
<span class="line-removed"> 581 </span>
 582   // No need to initialize compilation system if we do not use it.
 583   if (!UseCompiler) {
 584     return;
 585   }
 586   // Set the interface to the current compiler(s).
 587   _c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 588   _c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 589 
 590 #if INCLUDE_JVMCI
 591   if (EnableJVMCI) {
 592     // This is creating a JVMCICompiler singleton.
 593     JVMCICompiler* jvmci = new JVMCICompiler();
 594 
 595     if (UseJVMCICompiler) {
 596       _compilers[1] = jvmci;
 597       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 598         if (BootstrapJVMCI) {
 599           // JVMCI will bootstrap so give it more threads
 600           _c2_count = MIN2(32, os::active_processor_count());
 601         }
 602       } else {
 603         _c2_count = JVMCIThreads;
 604       }
 605       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 606       } else {
 607         _c1_count = JVMCIHostThreads;
 608       }
 609     }
 610   }
 611 #endif // INCLUDE_JVMCI
 612 
 613 #ifdef COMPILER1
 614   if (_c1_count &gt; 0) {
 615     _compilers[0] = new Compiler();
 616   }
 617 #endif // COMPILER1
 618 
 619 #ifdef COMPILER2
 620   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 621     if (_c2_count &gt; 0) {
 622       _compilers[1] = new C2Compiler();
 623     }
 624   }
 625 #endif // COMPILER2
 626 
 627   // Start the compiler thread(s) and the sweeper thread
 628   init_compiler_sweeper_threads();
 629   // totalTime performance counter is always created as it is required
 630   // by the implementation of java.lang.management.CompilationMBean.
 631   {
<a name="23" id="anc23"></a>
 632     EXCEPTION_MARK;
 633     _perf_total_compilation =
 634                  PerfDataManager::create_counter(JAVA_CI, &quot;totalTime&quot;,
 635                                                  PerfData::U_Ticks, CHECK);
 636   }
 637 
 638   if (UsePerfData) {
 639 
 640     EXCEPTION_MARK;
 641 
 642     // create the jvmstat performance counters
 643     _perf_osr_compilation =
 644                  PerfDataManager::create_counter(SUN_CI, &quot;osrTime&quot;,
 645                                                  PerfData::U_Ticks, CHECK);
 646 
 647     _perf_standard_compilation =
 648                  PerfDataManager::create_counter(SUN_CI, &quot;standardTime&quot;,
 649                                                  PerfData::U_Ticks, CHECK);
 650 
 651     _perf_total_bailout_count =
 652                  PerfDataManager::create_counter(SUN_CI, &quot;totalBailouts&quot;,
 653                                                  PerfData::U_Events, CHECK);
 654 
 655     _perf_total_invalidated_count =
 656                  PerfDataManager::create_counter(SUN_CI, &quot;totalInvalidates&quot;,
 657                                                  PerfData::U_Events, CHECK);
 658 
 659     _perf_total_compile_count =
 660                  PerfDataManager::create_counter(SUN_CI, &quot;totalCompiles&quot;,
 661                                                  PerfData::U_Events, CHECK);
 662     _perf_total_osr_compile_count =
 663                  PerfDataManager::create_counter(SUN_CI, &quot;osrCompiles&quot;,
 664                                                  PerfData::U_Events, CHECK);
 665 
 666     _perf_total_standard_compile_count =
 667                  PerfDataManager::create_counter(SUN_CI, &quot;standardCompiles&quot;,
 668                                                  PerfData::U_Events, CHECK);
 669 
 670     _perf_sum_osr_bytes_compiled =
 671                  PerfDataManager::create_counter(SUN_CI, &quot;osrBytes&quot;,
 672                                                  PerfData::U_Bytes, CHECK);
 673 
 674     _perf_sum_standard_bytes_compiled =
 675                  PerfDataManager::create_counter(SUN_CI, &quot;standardBytes&quot;,
 676                                                  PerfData::U_Bytes, CHECK);
 677 
 678     _perf_sum_nmethod_size =
 679                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodSize&quot;,
 680                                                  PerfData::U_Bytes, CHECK);
 681 
 682     _perf_sum_nmethod_code_size =
 683                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodCodeSize&quot;,
 684                                                  PerfData::U_Bytes, CHECK);
 685 
 686     _perf_last_method =
 687                  PerfDataManager::create_string_variable(SUN_CI, &quot;lastMethod&quot;,
 688                                        CompilerCounters::cmname_buffer_length,
 689                                        &quot;&quot;, CHECK);
 690 
 691     _perf_last_failed_method =
 692             PerfDataManager::create_string_variable(SUN_CI, &quot;lastFailedMethod&quot;,
 693                                        CompilerCounters::cmname_buffer_length,
 694                                        &quot;&quot;, CHECK);
 695 
 696     _perf_last_invalidated_method =
 697         PerfDataManager::create_string_variable(SUN_CI, &quot;lastInvalidatedMethod&quot;,
 698                                      CompilerCounters::cmname_buffer_length,
 699                                      &quot;&quot;, CHECK);
 700 
 701     _perf_last_compile_type =
 702              PerfDataManager::create_variable(SUN_CI, &quot;lastType&quot;,
 703                                               PerfData::U_None,
 704                                               (jlong)CompileBroker::no_compile,
 705                                               CHECK);
 706 
 707     _perf_last_compile_size =
 708              PerfDataManager::create_variable(SUN_CI, &quot;lastSize&quot;,
 709                                               PerfData::U_Bytes,
 710                                               (jlong)CompileBroker::no_compile,
 711                                               CHECK);
 712 
 713 
 714     _perf_last_failed_type =
 715              PerfDataManager::create_variable(SUN_CI, &quot;lastFailedType&quot;,
 716                                               PerfData::U_None,
 717                                               (jlong)CompileBroker::no_compile,
 718                                               CHECK);
 719 
 720     _perf_last_invalidated_type =
 721          PerfDataManager::create_variable(SUN_CI, &quot;lastInvalidatedType&quot;,
 722                                           PerfData::U_None,
 723                                           (jlong)CompileBroker::no_compile,
 724                                           CHECK);
 725   }
 726 }
 727 
 728 // Completes compiler initialization. Compilation requests submitted
 729 // prior to this will be silently ignored.
 730 void CompileBroker::compilation_init_phase2() {
 731   _initialized = true;
 732 }
 733 
 734 Handle CompileBroker::create_thread_oop(const char* name, TRAPS) {
 735   Handle string = java_lang_String::create_from_str(name, CHECK_NH);
 736   Handle thread_group(THREAD, Universe::system_thread_group());
 737   return JavaCalls::construct_new_instance(
 738                        SystemDictionary::Thread_klass(),
 739                        vmSymbols::threadgroup_string_void_signature(),
 740                        thread_group,
 741                        string,
 742                        CHECK_NH);
 743 }
 744 
 745 
<a name="24" id="anc24"></a><span class="line-modified"> 746 JavaThread* CompileBroker::make_thread(jobject thread_handle, CompileQueue* queue, AbstractCompiler* comp, TRAPS) {</span>
<span class="line-modified"> 747   JavaThread* thread = NULL;</span>
 748   {
<a name="25" id="anc25"></a><span class="line-modified"> 749     MutexLocker mu(Threads_lock, THREAD);</span>
 750     if (comp != NULL) {
 751       if (!InjectCompilerCreationFailure || comp-&gt;num_compiler_threads() == 0) {
 752         CompilerCounters* counters = new CompilerCounters();
<a name="26" id="anc26"></a><span class="line-modified"> 753         thread = new CompilerThread(queue, counters);</span>
 754       }
 755     } else {
<a name="27" id="anc27"></a><span class="line-modified"> 756       thread = new CodeCacheSweeperThread();</span>
 757     }
 758     // At this point the new CompilerThread data-races with this startup
 759     // thread (which I believe is the primoridal thread and NOT the VM
 760     // thread).  This means Java bytecodes being executed at startup can
 761     // queue compile jobs which will run at whatever default priority the
 762     // newly created CompilerThread runs at.
 763 
 764 
 765     // At this point it may be possible that no osthread was created for the
 766     // JavaThread due to lack of memory. We would have to throw an exception
 767     // in that case. However, since this must work and we do not allow
 768     // exceptions anyway, check and abort if this fails. But first release the
 769     // lock.
 770 
<a name="28" id="anc28"></a><span class="line-modified"> 771     if (thread != NULL &amp;&amp; thread-&gt;osthread() != NULL) {</span>
 772 
<a name="29" id="anc29"></a><span class="line-modified"> 773       java_lang_Thread::set_thread(JNIHandles::resolve_non_null(thread_handle), thread);</span>
 774 
 775       // Note that this only sets the JavaThread _priority field, which by
 776       // definition is limited to Java priorities and not OS priorities.
 777       // The os-priority is set in the CompilerThread startup code itself
 778 
 779       java_lang_Thread::set_priority(JNIHandles::resolve_non_null(thread_handle), NearMaxPriority);
 780 
 781       // Note that we cannot call os::set_priority because it expects Java
 782       // priorities and we are *explicitly* using OS priorities so that it&#39;s
 783       // possible to set the compiler thread priority higher than any Java
 784       // thread.
 785 
 786       int native_prio = CompilerThreadPriority;
 787       if (native_prio == -1) {
 788         if (UseCriticalCompilerThreadPriority) {
 789           native_prio = os::java_to_os_priority[CriticalPriority];
 790         } else {
 791           native_prio = os::java_to_os_priority[NearMaxPriority];
 792         }
 793       }
<a name="30" id="anc30"></a><span class="line-modified"> 794       os::set_native_priority(thread, native_prio);</span>
 795 
 796       java_lang_Thread::set_daemon(JNIHandles::resolve_non_null(thread_handle));
 797 
<a name="31" id="anc31"></a><span class="line-modified"> 798       thread-&gt;set_threadObj(JNIHandles::resolve_non_null(thread_handle));</span>
 799       if (comp != NULL) {
<a name="32" id="anc32"></a><span class="line-modified"> 800         thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);</span>
 801       }
<a name="33" id="anc33"></a><span class="line-modified"> 802       Threads::add(thread);</span>
<span class="line-modified"> 803       Thread::start(thread);</span>
 804     }
 805   }
 806 
 807   // First release lock before aborting VM.
<a name="34" id="anc34"></a><span class="line-modified"> 808   if (thread == NULL || thread-&gt;osthread() == NULL) {</span>
 809     if (UseDynamicNumberOfCompilerThreads &amp;&amp; comp != NULL &amp;&amp; comp-&gt;num_compiler_threads() &gt; 0) {
<a name="35" id="anc35"></a><span class="line-modified"> 810       if (thread != NULL) {</span>
<span class="line-modified"> 811         thread-&gt;smr_delete();</span>
 812       }
 813       return NULL;
 814     }
 815     vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 816                                   os::native_thread_creation_failed_msg());
 817   }
 818 
 819   // Let go of Threads_lock before yielding
 820   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 821 
<a name="36" id="anc36"></a><span class="line-modified"> 822   return thread;</span>
 823 }
 824 
 825 
 826 void CompileBroker::init_compiler_sweeper_threads() {
<a name="37" id="anc37"></a>
 827   EXCEPTION_MARK;
 828 #if !defined(ZERO)
 829   assert(_c2_count &gt; 0 || _c1_count &gt; 0, &quot;No compilers?&quot;);
 830 #endif // !ZERO
 831   // Initialize the compilation queue
 832   if (_c2_count &gt; 0) {
 833     const char* name = JVMCI_ONLY(UseJVMCICompiler ? &quot;JVMCI compile queue&quot; :) &quot;C2 compile queue&quot;;
 834     _c2_compile_queue  = new CompileQueue(name);
 835     _compiler2_objects = NEW_C_HEAP_ARRAY(jobject, _c2_count, mtCompiler);
 836     _compiler2_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c2_count, mtCompiler);
 837   }
 838   if (_c1_count &gt; 0) {
 839     _c1_compile_queue  = new CompileQueue(&quot;C1 compile queue&quot;);
 840     _compiler1_objects = NEW_C_HEAP_ARRAY(jobject, _c1_count, mtCompiler);
 841     _compiler1_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c1_count, mtCompiler);
 842   }
 843 
 844   char name_buffer[256];
 845 
 846   for (int i = 0; i &lt; _c2_count; i++) {
<a name="38" id="anc38"></a>



 847     // Create a name for our thread.
 848     sprintf(name_buffer, &quot;%s CompilerThread%d&quot;, _compilers[1]-&gt;name(), i);
 849     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
<a name="39" id="anc39"></a><span class="line-modified"> 850     jobject thread_handle = JNIHandles::make_global(thread_oop);</span>

 851     _compiler2_objects[i] = thread_handle;
 852     _compiler2_logs[i] = NULL;
 853 
 854     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
<a name="40" id="anc40"></a><span class="line-modified"> 855       JavaThread *ct = make_thread(thread_handle, _c2_compile_queue, _compilers[1], CHECK);</span>
 856       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 857       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 858       if (TraceCompilerThreads) {
 859         ResourceMark rm;
 860         MutexLocker mu(Threads_lock);
 861         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 862       }
 863     }
 864   }
 865 
 866   for (int i = 0; i &lt; _c1_count; i++) {
 867     // Create a name for our thread.
 868     sprintf(name_buffer, &quot;C1 CompilerThread%d&quot;, i);
 869     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 870     jobject thread_handle = JNIHandles::make_global(thread_oop);
 871     _compiler1_objects[i] = thread_handle;
 872     _compiler1_logs[i] = NULL;
 873 
 874     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
<a name="41" id="anc41"></a><span class="line-modified"> 875       JavaThread *ct = make_thread(thread_handle, _c1_compile_queue, _compilers[0], CHECK);</span>
 876       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 877       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 878       if (TraceCompilerThreads) {
 879         ResourceMark rm;
 880         MutexLocker mu(Threads_lock);
 881         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 882       }
 883     }
 884   }
 885 
 886   if (UsePerfData) {
 887     PerfDataManager::create_constant(SUN_CI, &quot;threads&quot;, PerfData::U_Bytes, _c1_count + _c2_count, CHECK);
 888   }
 889 
 890   if (MethodFlushing) {
 891     // Initialize the sweeper thread
 892     Handle thread_oop = create_thread_oop(&quot;Sweeper thread&quot;, CHECK);
 893     jobject thread_handle = JNIHandles::make_local(THREAD, thread_oop());
<a name="42" id="anc42"></a><span class="line-modified"> 894     make_thread(thread_handle, NULL, NULL, CHECK);</span>
 895   }
 896 }
 897 
<a name="43" id="anc43"></a><span class="line-modified"> 898 void CompileBroker::possibly_add_compiler_threads() {</span>
<span class="line-removed"> 899   EXCEPTION_MARK;</span>
 900 
 901   julong available_memory = os::available_memory();
 902   // If SegmentedCodeCache is off, both values refer to the single heap (with type CodeBlobType::All).
 903   size_t available_cc_np  = CodeCache::unallocated_capacity(CodeBlobType::MethodNonProfiled),
 904          available_cc_p   = CodeCache::unallocated_capacity(CodeBlobType::MethodProfiled);
 905 
 906   // Only do attempt to start additional threads if the lock is free.
 907   if (!CompileThread_lock-&gt;try_lock()) return;
 908 
 909   if (_c2_compile_queue != NULL) {
 910     int old_c2_count = _compilers[1]-&gt;num_compiler_threads();
 911     int new_c2_count = MIN4(_c2_count,
 912         _c2_compile_queue-&gt;size() / 2,
 913         (int)(available_memory / (200*M)),
 914         (int)(available_cc_np / (128*K)));
 915 
 916     for (int i = old_c2_count; i &lt; new_c2_count; i++) {
<a name="44" id="anc44"></a><span class="line-modified"> 917       JavaThread *ct = make_thread(compiler2_object(i), _c2_compile_queue, _compilers[1], CHECK);</span>

































 918       if (ct == NULL) break;
 919       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 920       if (TraceCompilerThreads) {
 921         ResourceMark rm;
 922         MutexLocker mu(Threads_lock);
 923         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available non-profiled code cache: %dMB)&quot;,
 924                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_np/M));
 925       }
 926     }
 927   }
 928 
 929   if (_c1_compile_queue != NULL) {
 930     int old_c1_count = _compilers[0]-&gt;num_compiler_threads();
 931     int new_c1_count = MIN4(_c1_count,
 932         _c1_compile_queue-&gt;size() / 4,
 933         (int)(available_memory / (100*M)),
 934         (int)(available_cc_p / (128*K)));
 935 
 936     for (int i = old_c1_count; i &lt; new_c1_count; i++) {
<a name="45" id="anc45"></a><span class="line-modified"> 937       JavaThread *ct = make_thread(compiler1_object(i), _c1_compile_queue, _compilers[0], CHECK);</span>
 938       if (ct == NULL) break;
 939       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 940       if (TraceCompilerThreads) {
 941         ResourceMark rm;
 942         MutexLocker mu(Threads_lock);
 943         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available profiled code cache: %dMB)&quot;,
 944                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_p/M));
 945       }
 946     }
 947   }
 948 
 949   CompileThread_lock-&gt;unlock();
 950 }
 951 
 952 
 953 /**
 954  * Set the methods on the stack as on_stack so that redefine classes doesn&#39;t
 955  * reclaim them. This method is executed at a safepoint.
 956  */
 957 void CompileBroker::mark_on_stack() {
 958   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 959   // Since we are at a safepoint, we do not need a lock to access
 960   // the compile queues.
 961   if (_c2_compile_queue != NULL) {
 962     _c2_compile_queue-&gt;mark_on_stack();
 963   }
 964   if (_c1_compile_queue != NULL) {
 965     _c1_compile_queue-&gt;mark_on_stack();
 966   }
 967 }
 968 
 969 // ------------------------------------------------------------------
 970 // CompileBroker::compile_method
 971 //
 972 // Request compilation of a method.
 973 void CompileBroker::compile_method_base(const methodHandle&amp; method,
 974                                         int osr_bci,
 975                                         int comp_level,
 976                                         const methodHandle&amp; hot_method,
 977                                         int hot_count,
 978                                         CompileTask::CompileReason compile_reason,
 979                                         bool blocking,
 980                                         Thread* thread) {
 981   guarantee(!method-&gt;is_abstract(), &quot;cannot compile abstract methods&quot;);
 982   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
 983          &quot;sanity check&quot;);
 984   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
 985          &quot;method holder must be initialized&quot;);
 986   assert(!method-&gt;is_method_handle_intrinsic(), &quot;do not enqueue these guys&quot;);
 987 
 988   if (CIPrintRequests) {
 989     tty-&gt;print(&quot;request: &quot;);
 990     method-&gt;print_short_name(tty);
 991     if (osr_bci != InvocationEntryBci) {
 992       tty-&gt;print(&quot; osr_bci: %d&quot;, osr_bci);
 993     }
 994     tty-&gt;print(&quot; level: %d comment: %s count: %d&quot;, comp_level, CompileTask::reason_name(compile_reason), hot_count);
 995     if (!hot_method.is_null()) {
 996       tty-&gt;print(&quot; hot: &quot;);
 997       if (hot_method() != method()) {
 998           hot_method-&gt;print_short_name(tty);
 999       } else {
1000         tty-&gt;print(&quot;yes&quot;);
1001       }
1002     }
1003     tty-&gt;cr();
1004   }
1005 
1006   // A request has been made for compilation.  Before we do any
1007   // real work, check to see if the method has been compiled
1008   // in the meantime with a definitive result.
1009   if (compilation_is_complete(method, osr_bci, comp_level)) {
1010     return;
1011   }
1012 
1013 #ifndef PRODUCT
1014   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
1015     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
1016       // Positive OSROnlyBCI means only compile that bci.  Negative means don&#39;t compile that BCI.
1017       return;
1018     }
1019   }
1020 #endif
1021 
1022   // If this method is already in the compile queue, then
1023   // we do not block the current thread.
1024   if (compilation_is_in_queue(method)) {
1025     // We may want to decay our counter a bit here to prevent
1026     // multiple denied requests for compilation.  This is an
1027     // open compilation policy issue. Note: The other possibility,
1028     // in the case that this is a blocking compile request, is to have
1029     // all subsequent blocking requesters wait for completion of
1030     // ongoing compiles. Note that in this case we&#39;ll need a protocol
1031     // for freeing the associated compile tasks. [Or we could have
1032     // a single static monitor on which all these waiters sleep.]
1033     return;
1034   }
1035 
1036   if (TieredCompilation) {
1037     // Tiered policy requires MethodCounters to exist before adding a method to
1038     // the queue. Create if we don&#39;t have them yet.
1039     method-&gt;get_method_counters(thread);
1040   }
1041 
1042   // Outputs from the following MutexLocker block:
1043   CompileTask* task     = NULL;
1044   CompileQueue* queue  = compile_queue(comp_level);
1045 
1046   // Acquire our lock.
1047   {
<a name="46" id="anc46"></a><span class="line-modified">1048     MutexLocker locker(MethodCompileQueue_lock, thread);</span>
1049 
1050     // Make sure the method has not slipped into the queues since
1051     // last we checked; note that those checks were &quot;fast bail-outs&quot;.
1052     // Here we need to be more careful, see 14012000 below.
1053     if (compilation_is_in_queue(method)) {
1054       return;
1055     }
1056 
1057     // We need to check again to see if the compilation has
1058     // completed.  A previous compilation may have registered
1059     // some result.
1060     if (compilation_is_complete(method, osr_bci, comp_level)) {
1061       return;
1062     }
1063 
1064     // We now know that this compilation is not pending, complete,
1065     // or prohibited.  Assign a compile_id to this compilation
1066     // and check to see if it is in our [Start..Stop) range.
1067     int compile_id = assign_compile_id(method, osr_bci);
1068     if (compile_id == 0) {
1069       // The compilation falls outside the allowed range.
1070       return;
1071     }
1072 
1073 #if INCLUDE_JVMCI
<a name="47" id="anc47"></a><span class="line-modified">1074     if (UseJVMCICompiler) {</span>
<span class="line-modified">1075       if (blocking) {</span>
<span class="line-modified">1076         // Don&#39;t allow blocking compiles for requests triggered by JVMCI.</span>
<span class="line-modified">1077         if (thread-&gt;is_Compiler_thread()) {</span>
<span class="line-modified">1078           blocking = false;</span>
<span class="line-removed">1079         }</span>
1080 
<a name="48" id="anc48"></a>
1081         // Don&#39;t allow blocking compiles if inside a class initializer or while performing class loading
1082         vframeStream vfst((JavaThread*) thread);
1083         for (; !vfst.at_end(); vfst.next()) {
1084           if (vfst.method()-&gt;is_static_initializer() ||
1085               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
1086                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
1087             blocking = false;
1088             break;
1089           }
1090         }
<a name="49" id="anc49"></a>
1091 
<a name="50" id="anc50"></a><span class="line-modified">1092         // Don&#39;t allow blocking compilation requests to JVMCI</span>
<span class="line-modified">1093         // if JVMCI itself is not yet initialized</span>
<span class="line-modified">1094         if (!JVMCIRuntime::is_HotSpotJVMCIRuntime_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {</span>
<span class="line-modified">1095           blocking = false;</span>
<span class="line-modified">1096         }</span>
1097 
<a name="51" id="anc51"></a><span class="line-modified">1098         // Don&#39;t allow blocking compilation requests if we are in JVMCIRuntime::shutdown</span>
<span class="line-modified">1099         // to avoid deadlock between compiler thread(s) and threads run at shutdown</span>
<span class="line-modified">1100         // such as the DestroyJavaVM thread.</span>
<span class="line-modified">1101         if (JVMCIRuntime::shutdown_called()) {</span>
<span class="line-modified">1102           blocking = false;</span>
<span class="line-removed">1103         }</span>
1104       }
1105     }
1106 #endif // INCLUDE_JVMCI
1107 
1108     // We will enter the compilation in the queue.
1109     // 14012000: Note that this sets the queued_for_compile bits in
1110     // the target method. We can now reason that a method cannot be
1111     // queued for compilation more than once, as follows:
1112     // Before a thread queues a task for compilation, it first acquires
1113     // the compile queue lock, then checks if the method&#39;s queued bits
1114     // are set or it has already been compiled. Thus there can not be two
1115     // instances of a compilation task for the same method on the
1116     // compilation queue. Consider now the case where the compilation
1117     // thread has already removed a task for that method from the queue
1118     // and is in the midst of compiling it. In this case, the
1119     // queued_for_compile bits must be set in the method (and these
1120     // will be visible to the current thread, since the bits were set
1121     // under protection of the compile queue lock, which we hold now.
1122     // When the compilation completes, the compiler thread first sets
1123     // the compilation result and then clears the queued_for_compile
1124     // bits. Neither of these actions are protected by a barrier (or done
1125     // under the protection of a lock), so the only guarantee we have
1126     // (on machines with TSO (Total Store Order)) is that these values
1127     // will update in that order. As a result, the only combinations of
1128     // these bits that the current thread will see are, in temporal order:
1129     // &lt;RESULT, QUEUE&gt; :
1130     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1131     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1132     //     &lt;1, 0&gt; : compiled and queue bit cleared
1133     // Because we first check the queue bits then check the result bits,
1134     // we are assured that we cannot introduce a duplicate task.
1135     // Note that if we did the tests in the reverse order (i.e. check
1136     // result then check queued bit), we could get the result bit before
1137     // the compilation completed, and the queue bit after the compilation
1138     // completed, and end up introducing a &quot;duplicate&quot; (redundant) task.
1139     // In that case, the compiler thread should first check if a method
1140     // has already been compiled before trying to compile it.
1141     // NOTE: in the event that there are multiple compiler threads and
1142     // there is de-optimization/recompilation, things will get hairy,
1143     // and in that case it&#39;s best to protect both the testing (here) of
1144     // these bits, and their updating (here and elsewhere) under a
1145     // common lock.
1146     task = create_compile_task(queue,
1147                                compile_id, method,
1148                                osr_bci, comp_level,
1149                                hot_method, hot_count, compile_reason,
1150                                blocking);
1151   }
1152 
1153   if (blocking) {
1154     wait_for_completion(task);
1155   }
1156 }
1157 
1158 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1159                                        int comp_level,
1160                                        const methodHandle&amp; hot_method, int hot_count,
1161                                        CompileTask::CompileReason compile_reason,
1162                                        Thread* THREAD) {
1163   // Do nothing if compilebroker is not initalized or compiles are submitted on level none
1164   if (!_initialized || comp_level == CompLevel_none) {
1165     return NULL;
1166   }
1167 
1168   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1169   assert(comp != NULL, &quot;Ensure we have a compiler&quot;);
1170 
1171   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1172   nmethod* nm = CompileBroker::compile_method(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, directive, THREAD);
1173   DirectivesStack::release(directive);
1174   return nm;
1175 }
1176 
1177 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1178                                          int comp_level,
1179                                          const methodHandle&amp; hot_method, int hot_count,
1180                                          CompileTask::CompileReason compile_reason,
1181                                          DirectiveSet* directive,
1182                                          Thread* THREAD) {
1183 
1184   // make sure arguments make sense
1185   assert(method-&gt;method_holder()-&gt;is_instance_klass(), &quot;not an instance method&quot;);
1186   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), &quot;bci out of range&quot;);
1187   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), &quot;cannot compile abstract/native methods&quot;);
1188   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), &quot;method holder must be initialized&quot;);
1189   assert(!TieredCompilation || comp_level &lt;= TieredStopAtLevel, &quot;Invalid compilation level&quot;);
1190   // allow any levels for WhiteBox
1191   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, &quot;only CompLevel_highest_tier must be used in non-tiered&quot;);
1192   // return quickly if possible
1193 
1194   // lock, make sure that the compilation
1195   // isn&#39;t prohibited in a straightforward way.
1196   AbstractCompiler* comp = CompileBroker::compiler(comp_level);
1197   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1198       compilation_is_prohibited(method, osr_bci, comp_level, directive-&gt;ExcludeOption)) {
1199     return NULL;
1200   }
1201 
1202 #if INCLUDE_JVMCI
<a name="52" id="anc52"></a><span class="line-modified">1203   if (comp-&gt;is_jvmci() &amp;&amp; !JVMCIRuntime::can_initialize_JVMCI()) {</span>
1204     return NULL;
1205   }
1206 #endif
1207 
1208   if (osr_bci == InvocationEntryBci) {
1209     // standard compilation
1210     CompiledMethod* method_code = method-&gt;code();
1211     if (method_code != NULL &amp;&amp; method_code-&gt;is_nmethod()) {
1212       if (compilation_is_complete(method, osr_bci, comp_level)) {
1213         return (nmethod*) method_code;
1214       }
1215     }
1216     if (method-&gt;is_not_compilable(comp_level)) {
1217       return NULL;
1218     }
1219   } else {
1220     // osr compilation
1221 #ifndef TIERED
1222     // seems like an assert of dubious value
1223     assert(comp_level == CompLevel_highest_tier,
1224            &quot;all OSR compiles are assumed to be at a single compilation level&quot;);
1225 #endif // TIERED
1226     // We accept a higher level osr method
1227     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1228     if (nm != NULL) return nm;
1229     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1230   }
1231 
1232   assert(!HAS_PENDING_EXCEPTION, &quot;No exception should be present&quot;);
1233   // some prerequisites that are compiler specific
1234   if (comp-&gt;is_c2()) {
1235     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1236     // Resolve all classes seen in the signature of the method
1237     // we are compiling.
1238     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1239   }
1240 
1241   // If the method is native, do the lookup in the thread requesting
1242   // the compilation. Native lookups can load code, which is not
1243   // permitted during compilation.
1244   //
1245   // Note: A native method implies non-osr compilation which is
1246   //       checked with an assertion at the entry of this method.
1247   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1248     bool in_base_library;
1249     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1250     if (HAS_PENDING_EXCEPTION) {
1251       // In case of an exception looking up the method, we just forget
1252       // about it. The interpreter will kick-in and throw the exception.
<a name="53" id="anc53"></a><span class="line-modified">1253       method-&gt;set_not_compilable(); // implies is_not_osr_compilable()</span>
1254       CLEAR_PENDING_EXCEPTION;
1255       return NULL;
1256     }
1257     assert(method-&gt;has_native_function(), &quot;must have native code by now&quot;);
1258   }
1259 
1260   // RedefineClasses() has replaced this method; just return
1261   if (method-&gt;is_old()) {
1262     return NULL;
1263   }
1264 
1265   // JVMTI -- post_compile_event requires jmethod_id() that may require
1266   // a lock the compiling thread can not acquire. Prefetch it here.
1267   if (JvmtiExport::should_post_compiled_method_load()) {
1268     method-&gt;jmethod_id();
1269   }
1270 
1271   // do the compilation
1272   if (method-&gt;is_native()) {
1273     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1274       // The following native methods:
1275       //
1276       // java.lang.Float.intBitsToFloat
1277       // java.lang.Float.floatToRawIntBits
1278       // java.lang.Double.longBitsToDouble
1279       // java.lang.Double.doubleToRawLongBits
1280       //
1281       // are called through the interpreter even if interpreter native stubs
1282       // are not preferred (i.e., calling through adapter handlers is preferred).
1283       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1284       // if the version of the methods from the native libraries is called.
1285       // As the interpreter and the C2-intrinsified version of the methods preserves
1286       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1287       if ((UseSSE &gt;= 1 &amp;&amp;
1288           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1289            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1290           (UseSSE &gt;= 2 &amp;&amp;
1291            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1292             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1293         return NULL;
1294       }
1295 
1296       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1297       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1298       //
1299       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1300       // in this case.  If we can&#39;t generate one and use it we can not execute the out-of-line method handle calls.
1301       AdapterHandlerLibrary::create_native_wrapper(method);
1302     } else {
1303       return NULL;
1304     }
1305   } else {
1306     // If the compiler is shut off due to code cache getting full
1307     // fail out now so blocking compiles dont hang the java thread
1308     if (!should_compile_new_jobs()) {
1309       CompilationPolicy::policy()-&gt;delay_compilation(method());
1310       return NULL;
1311     }
1312     bool is_blocking = !directive-&gt;BackgroundCompilationOption || ReplayCompiles;
1313     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, is_blocking, THREAD);
1314   }
1315 
1316   // return requested nmethod
1317   // We accept a higher level osr method
1318   if (osr_bci == InvocationEntryBci) {
1319     CompiledMethod* code = method-&gt;code();
1320     if (code == NULL) {
1321       return (nmethod*) code;
1322     } else {
1323       return code-&gt;as_nmethod_or_null();
1324     }
1325   }
1326   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1327 }
1328 
1329 
1330 // ------------------------------------------------------------------
1331 // CompileBroker::compilation_is_complete
1332 //
1333 // See if compilation of this method is already complete.
1334 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1335                                             int                 osr_bci,
1336                                             int                 comp_level) {
1337   bool is_osr = (osr_bci != standard_entry_bci);
1338   if (is_osr) {
1339     if (method-&gt;is_not_osr_compilable(comp_level)) {
1340       return true;
1341     } else {
1342       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1343       return (result != NULL);
1344     }
1345   } else {
1346     if (method-&gt;is_not_compilable(comp_level)) {
1347       return true;
1348     } else {
1349       CompiledMethod* result = method-&gt;code();
1350       if (result == NULL) return false;
1351       return comp_level == result-&gt;comp_level();
1352     }
1353   }
1354 }
1355 
1356 
1357 /**
1358  * See if this compilation is already requested.
1359  *
1360  * Implementation note: there is only a single &quot;is in queue&quot; bit
1361  * for each method.  This means that the check below is overly
1362  * conservative in the sense that an osr compilation in the queue
1363  * will block a normal compilation from entering the queue (and vice
1364  * versa).  This can be remedied by a full queue search to disambiguate
1365  * cases.  If it is deemed profitable, this may be done.
1366  */
1367 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1368   return method-&gt;queued_for_compilation();
1369 }
1370 
1371 // ------------------------------------------------------------------
1372 // CompileBroker::compilation_is_prohibited
1373 //
1374 // See if this compilation is not allowed.
1375 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded) {
1376   bool is_native = method-&gt;is_native();
1377   // Some compilers may not support the compilation of natives.
1378   AbstractCompiler *comp = compiler(comp_level);
1379   if (is_native &amp;&amp;
1380       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
<a name="54" id="anc54"></a><span class="line-modified">1381     method-&gt;set_not_compilable_quietly(comp_level);</span>
1382     return true;
1383   }
1384 
1385   bool is_osr = (osr_bci != standard_entry_bci);
1386   // Some compilers may not support on stack replacement.
1387   if (is_osr &amp;&amp;
1388       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
<a name="55" id="anc55"></a><span class="line-modified">1389     method-&gt;set_not_osr_compilable(comp_level);</span>
1390     return true;
1391   }
1392 
1393   // The method may be explicitly excluded by the user.
1394   double scale;
1395   if (excluded || (CompilerOracle::has_option_value(method, &quot;CompileThresholdScaling&quot;, scale) &amp;&amp; scale == 0)) {
1396     bool quietly = CompilerOracle::should_exclude_quietly();
1397     if (PrintCompilation &amp;&amp; !quietly) {
1398       // This does not happen quietly...
1399       ResourceMark rm;
1400       tty-&gt;print(&quot;### Excluding %s:%s&quot;,
1401                  method-&gt;is_native() ? &quot;generation of native wrapper&quot; : &quot;compile&quot;,
1402                  (method-&gt;is_static() ? &quot; static&quot; : &quot;&quot;));
1403       method-&gt;print_short_name(tty);
1404       tty-&gt;cr();
1405     }
<a name="56" id="anc56"></a><span class="line-modified">1406     method-&gt;set_not_compilable(comp_level, !quietly, &quot;excluded by CompileCommand&quot;);</span>
1407   }
1408 
1409   return false;
1410 }
1411 
1412 /**
1413  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1414  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1415  * The function also allows to generate separate compilation IDs for OSR compilations.
1416  */
1417 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1418 #ifdef ASSERT
1419   bool is_osr = (osr_bci != standard_entry_bci);
1420   int id;
1421   if (method-&gt;is_native()) {
1422     assert(!is_osr, &quot;can&#39;t be osr&quot;);
1423     // Adapters, native wrappers and method handle intrinsics
1424     // should be generated always.
<a name="57" id="anc57"></a><span class="line-modified">1425     return Atomic::add(1, &amp;_compilation_id);</span>
1426   } else if (CICountOSR &amp;&amp; is_osr) {
<a name="58" id="anc58"></a><span class="line-modified">1427     id = Atomic::add(1, &amp;_osr_compilation_id);</span>
1428     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1429       return id;
1430     }
1431   } else {
<a name="59" id="anc59"></a><span class="line-modified">1432     id = Atomic::add(1, &amp;_compilation_id);</span>
1433     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1434       return id;
1435     }
1436   }
1437 
1438   // Method was not in the appropriate compilation range.
<a name="60" id="anc60"></a><span class="line-modified">1439   method-&gt;set_not_compilable_quietly();</span>
1440   return 0;
1441 #else
1442   // CICountOSR is a develop flag and set to &#39;false&#39; by default. In a product built,
1443   // only _compilation_id is incremented.
<a name="61" id="anc61"></a><span class="line-modified">1444   return Atomic::add(1, &amp;_compilation_id);</span>
1445 #endif
1446 }
1447 
1448 // ------------------------------------------------------------------
1449 // CompileBroker::assign_compile_id_unlocked
1450 //
1451 // Public wrapper for assign_compile_id that acquires the needed locks
1452 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
<a name="62" id="anc62"></a><span class="line-modified">1453   MutexLocker locker(MethodCompileQueue_lock, thread);</span>
1454   return assign_compile_id(method, osr_bci);
1455 }
1456 
<a name="63" id="anc63"></a><span class="line-removed">1457 // ------------------------------------------------------------------</span>
<span class="line-removed">1458 // CompileBroker::preload_classes</span>
<span class="line-removed">1459 void CompileBroker::preload_classes(const methodHandle&amp; method, TRAPS) {</span>
<span class="line-removed">1460   // Move this code over from c1_Compiler.cpp</span>
<span class="line-removed">1461   ShouldNotReachHere();</span>
<span class="line-removed">1462 }</span>
<span class="line-removed">1463 </span>
<span class="line-removed">1464 </span>
1465 // ------------------------------------------------------------------
1466 // CompileBroker::create_compile_task
1467 //
1468 // Create a CompileTask object representing the current request for
1469 // compilation.  Add this task to the queue.
1470 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1471                                                 int                 compile_id,
1472                                                 const methodHandle&amp; method,
1473                                                 int                 osr_bci,
1474                                                 int                 comp_level,
1475                                                 const methodHandle&amp; hot_method,
1476                                                 int                 hot_count,
1477                                                 CompileTask::CompileReason compile_reason,
1478                                                 bool                blocking) {
1479   CompileTask* new_task = CompileTask::allocate();
1480   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1481                        hot_method, hot_count, compile_reason,
1482                        blocking);
1483   queue-&gt;add(new_task);
1484   return new_task;
1485 }
1486 
1487 #if INCLUDE_JVMCI
1488 // The number of milliseconds to wait before checking if
1489 // JVMCI compilation has made progress.
1490 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 1000;
1491 
1492 // The number of JVMCI compilation progress checks that must fail
1493 // before unblocking a thread waiting for a blocking compilation.
1494 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 10;
1495 
1496 /**
1497  * Waits for a JVMCI compiler to complete a given task. This thread
1498  * waits until either the task completes or it sees no JVMCI compilation
1499  * progress for N consecutive milliseconds where N is
1500  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1501  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1502  *
1503  * @return true if this thread needs to free/recycle the task
1504  */
1505 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
<a name="64" id="anc64"></a><span class="line-modified">1506   MutexLocker waiter(task-&gt;lock(), thread);</span>
1507   int progress_wait_attempts = 0;
1508   int methods_compiled = jvmci-&gt;methods_compiled();
1509   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
<a name="65" id="anc65"></a><span class="line-modified">1510          task-&gt;lock()-&gt;wait(!Mutex::_no_safepoint_check_flag, JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {</span>
1511     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1512 
1513     bool progress;
1514     if (jvmci_compiler_thread != NULL) {
1515       // If the JVMCI compiler thread is not blocked or suspended, we deem it to be making progress.
1516       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked &amp;&amp;
1517         !jvmci_compiler_thread-&gt;is_external_suspend();
1518     } else {
1519       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1520       // that all JVMCI compiler threads are blocked on. We use the counter for
1521       // successful JVMCI compilations to determine whether JVMCI compilation
1522       // is still making progress through the JVMCI compiler queue.
1523       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1524     }
1525 
1526     if (!progress) {
1527       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1528         if (PrintCompilation) {
1529           task-&gt;print(tty, &quot;wait for blocking compilation timed out&quot;);
1530         }
1531         break;
1532       }
1533     } else {
1534       progress_wait_attempts = 0;
1535       if (jvmci_compiler_thread == NULL) {
1536         methods_compiled = jvmci-&gt;methods_compiled();
1537       }
1538     }
1539   }
1540   task-&gt;clear_waiter();
1541   return task-&gt;is_complete();
1542 }
1543 #endif
1544 
1545 /**
1546  *  Wait for the compilation task to complete.
1547  */
1548 void CompileBroker::wait_for_completion(CompileTask* task) {
1549   if (CIPrintCompileQueue) {
1550     ttyLocker ttyl;
1551     tty-&gt;print_cr(&quot;BLOCKING FOR COMPILE&quot;);
1552   }
1553 
1554   assert(task-&gt;is_blocking(), &quot;can only wait on blocking task&quot;);
1555 
1556   JavaThread* thread = JavaThread::current();
<a name="66" id="anc66"></a><span class="line-removed">1557   thread-&gt;set_blocked_on_compilation(true);</span>
1558 
1559   methodHandle method(thread, task-&gt;method());
1560   bool free_task;
1561 #if INCLUDE_JVMCI
1562   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1563   if (comp-&gt;is_jvmci()) {
1564     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1565   } else
1566 #endif
1567   {
<a name="67" id="anc67"></a><span class="line-modified">1568     MutexLocker waiter(task-&gt;lock(), thread);</span>
1569     free_task = true;
1570     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
<a name="68" id="anc68"></a><span class="line-modified">1571       task-&gt;lock()-&gt;wait();</span>
1572     }
1573   }
1574 
<a name="69" id="anc69"></a><span class="line-removed">1575   thread-&gt;set_blocked_on_compilation(false);</span>
1576   if (free_task) {
1577     if (is_compilation_disabled_forever()) {
1578       CompileTask::free(task);
1579       return;
1580     }
1581 
1582     // It is harmless to check this status without the lock, because
1583     // completion is a stable property (until the task object is recycled).
1584     assert(task-&gt;is_complete(), &quot;Compilation should have completed&quot;);
1585     assert(task-&gt;code_handle() == NULL, &quot;must be reset&quot;);
1586 
1587     // By convention, the waiter is responsible for recycling a
1588     // blocking CompileTask. Since there is only one waiter ever
1589     // waiting on a CompileTask, we know that no one else will
1590     // be using this CompileTask; we can free it.
1591     CompileTask::free(task);
1592   }
1593 }
1594 
1595 /**
1596  * Initialize compiler thread(s) + compiler object(s). The postcondition
1597  * of this function is that the compiler runtimes are initialized and that
1598  * compiler threads can start compiling.
1599  */
1600 bool CompileBroker::init_compiler_runtime() {
1601   CompilerThread* thread = CompilerThread::current();
1602   AbstractCompiler* comp = thread-&gt;compiler();
1603   // Final sanity check - the compiler object must exist
1604   guarantee(comp != NULL, &quot;Compiler object must exist&quot;);
1605 
<a name="70" id="anc70"></a><span class="line-removed">1606   int system_dictionary_modification_counter;</span>
<span class="line-removed">1607   {</span>
<span class="line-removed">1608     MutexLocker locker(Compile_lock, thread);</span>
<span class="line-removed">1609     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();</span>
<span class="line-removed">1610   }</span>
<span class="line-removed">1611 </span>
1612   {
1613     // Must switch to native to allocate ci_env
1614     ThreadToNativeFromVM ttn(thread);
<a name="71" id="anc71"></a><span class="line-modified">1615     ciEnv ci_env(NULL, system_dictionary_modification_counter);</span>
1616     // Cache Jvmti state
1617     ci_env.cache_jvmti_state();
1618     // Cache DTrace flags
1619     ci_env.cache_dtrace_flags();
1620 
1621     // Switch back to VM state to do compiler initialization
1622     ThreadInVMfromNative tv(thread);
1623     ResetNoHandleMark rnhm;
1624 
1625     // Perform per-thread and global initializations
1626     comp-&gt;initialize();
1627   }
1628 
1629   if (comp-&gt;is_failed()) {
1630     disable_compilation_forever();
1631     // If compiler initialization failed, no compiler thread that is specific to a
1632     // particular compiler runtime will ever start to compile methods.
1633     shutdown_compiler_runtime(comp, thread);
1634     return false;
1635   }
1636 
1637   // C1 specific check
1638   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1639     warning(&quot;Initialization of %s thread failed (no space to run compilers)&quot;, thread-&gt;name());
1640     return false;
1641   }
1642 
1643   return true;
1644 }
1645 
1646 /**
1647  * If C1 and/or C2 initialization failed, we shut down all compilation.
1648  * We do this to keep things simple. This can be changed if it ever turns
1649  * out to be a problem.
1650  */
1651 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1652   // Free buffer blob, if allocated
1653   if (thread-&gt;get_buffer_blob() != NULL) {
<a name="72" id="anc72"></a><span class="line-modified">1654     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
1655     CodeCache::free(thread-&gt;get_buffer_blob());
1656   }
1657 
1658   if (comp-&gt;should_perform_shutdown()) {
1659     // There are two reasons for shutting down the compiler
1660     // 1) compiler runtime initialization failed
1661     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1662     warning(&quot;%s initialization failed. Shutting down all compilers&quot;, comp-&gt;name());
1663 
1664     // Only one thread per compiler runtime object enters here
1665     // Set state to shut down
1666     comp-&gt;set_shut_down();
1667 
1668     // Delete all queued compilation tasks to make compiler threads exit faster.
1669     if (_c1_compile_queue != NULL) {
1670       _c1_compile_queue-&gt;free_all();
1671     }
1672 
1673     if (_c2_compile_queue != NULL) {
1674       _c2_compile_queue-&gt;free_all();
1675     }
1676 
1677     // Set flags so that we continue execution with using interpreter only.
1678     UseCompiler    = false;
1679     UseInterpreter = true;
1680 
1681     // We could delete compiler runtimes also. However, there are references to
1682     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1683     // fail. This can be done later if necessary.
1684   }
1685 }
1686 
1687 /**
1688  * Helper function to create new or reuse old CompileLog.
1689  */
1690 CompileLog* CompileBroker::get_log(CompilerThread* ct) {
1691   if (!LogCompilation) return NULL;
1692 
1693   AbstractCompiler *compiler = ct-&gt;compiler();
1694   bool c1 = compiler-&gt;is_c1();
1695   jobject* compiler_objects = c1 ? _compiler1_objects : _compiler2_objects;
1696   assert(compiler_objects != NULL, &quot;must be initialized at this point&quot;);
1697   CompileLog** logs = c1 ? _compiler1_logs : _compiler2_logs;
1698   assert(logs != NULL, &quot;must be initialized at this point&quot;);
1699   int count = c1 ? _c1_count : _c2_count;
1700 
1701   // Find Compiler number by its threadObj.
1702   oop compiler_obj = ct-&gt;threadObj();
1703   int compiler_number = 0;
1704   bool found = false;
1705   for (; compiler_number &lt; count; compiler_number++) {
<a name="73" id="anc73"></a><span class="line-modified">1706     if (oopDesc::equals(JNIHandles::resolve_non_null(compiler_objects[compiler_number]), compiler_obj)) {</span>
1707       found = true;
1708       break;
1709     }
1710   }
1711   assert(found, &quot;Compiler must exist at this point&quot;);
1712 
1713   // Determine pointer for this thread&#39;s log.
1714   CompileLog** log_ptr = &amp;logs[compiler_number];
1715 
1716   // Return old one if it exists.
1717   CompileLog* log = *log_ptr;
1718   if (log != NULL) {
1719     ct-&gt;init_log(log);
1720     return log;
1721   }
1722 
1723   // Create a new one and remember it.
1724   init_compiler_thread_log();
1725   log = ct-&gt;log();
1726   *log_ptr = log;
1727   return log;
1728 }
1729 
1730 // ------------------------------------------------------------------
1731 // CompileBroker::compiler_thread_loop
1732 //
1733 // The main loop run by a CompilerThread.
1734 void CompileBroker::compiler_thread_loop() {
1735   CompilerThread* thread = CompilerThread::current();
1736   CompileQueue* queue = thread-&gt;queue();
1737   // For the thread that initializes the ciObjectFactory
1738   // this resource mark holds all the shared objects
1739   ResourceMark rm;
1740 
1741   // First thread to get here will initialize the compiler interface
1742 
1743   {
1744     ASSERT_IN_VM;
<a name="74" id="anc74"></a><span class="line-modified">1745     MutexLocker only_one (CompileThread_lock, thread);</span>
1746     if (!ciObjectFactory::is_initialized()) {
1747       ciObjectFactory::initialize();
1748     }
1749   }
1750 
1751   // Open a log.
1752   CompileLog* log = get_log(thread);
1753   if (log != NULL) {
1754     log-&gt;begin_elem(&quot;start_compile_thread name=&#39;%s&#39; thread=&#39;&quot; UINTX_FORMAT &quot;&#39; process=&#39;%d&#39;&quot;,
1755                     thread-&gt;name(),
1756                     os::current_thread_id(),
1757                     os::current_process_id());
1758     log-&gt;stamp();
1759     log-&gt;end_elem();
1760   }
1761 
1762   // If compiler thread/runtime initialization fails, exit the compiler thread
1763   if (!init_compiler_runtime()) {
1764     return;
1765   }
1766 
1767   thread-&gt;start_idle_timer();
1768 
1769   // Poll for new compilation tasks as long as the JVM runs. Compilation
1770   // should only be disabled if something went wrong while initializing the
1771   // compiler runtimes. This, in turn, should not happen. The only known case
1772   // when compiler runtime initialization fails is if there is not enough free
1773   // space in the code cache to generate the necessary stubs, etc.
1774   while (!is_compilation_disabled_forever()) {
1775     // We need this HandleMark to avoid leaking VM handles.
1776     HandleMark hm(thread);
1777 
1778     CompileTask* task = queue-&gt;get();
1779     if (task == NULL) {
1780       if (UseDynamicNumberOfCompilerThreads) {
1781         // Access compiler_count under lock to enforce consistency.
1782         MutexLocker only_one(CompileThread_lock);
1783         if (can_remove(thread, true)) {
1784           if (TraceCompilerThreads) {
1785             tty-&gt;print_cr(&quot;Removing compiler thread %s after &quot; JLONG_FORMAT &quot; ms idle time&quot;,
1786                           thread-&gt;name(), thread-&gt;idle_time_millis());
1787           }
1788           // Free buffer blob, if allocated
1789           if (thread-&gt;get_buffer_blob() != NULL) {
<a name="75" id="anc75"></a><span class="line-modified">1790             MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
1791             CodeCache::free(thread-&gt;get_buffer_blob());
1792           }
1793           return; // Stop this thread.
1794         }
1795       }
1796     } else {
1797       // Assign the task to the current thread.  Mark this compilation
1798       // thread as active for the profiler.
1799       // CompileTaskWrapper also keeps the Method* from being deallocated if redefinition
1800       // occurs after fetching the compile task off the queue.
1801       CompileTaskWrapper ctw(task);
1802       nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1803       task-&gt;set_code_handle(&amp;result_handle);
1804       methodHandle method(thread, task-&gt;method());
1805 
1806       // Never compile a method if breakpoints are present in it
1807       if (method()-&gt;number_of_breakpoints() == 0) {
1808         // Compile the method.
1809         if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1810           invoke_compiler_on_method(task);
1811           thread-&gt;start_idle_timer();
1812         } else {
1813           // After compilation is disabled, remove remaining methods from queue
1814           method-&gt;clear_queued_for_compilation();
1815           task-&gt;set_failure_reason(&quot;compilation is disabled&quot;);
1816         }
1817       }
1818 
1819       if (UseDynamicNumberOfCompilerThreads) {
<a name="76" id="anc76"></a><span class="line-modified">1820         possibly_add_compiler_threads();</span>

1821       }
1822     }
1823   }
1824 
1825   // Shut down compiler runtime
1826   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1827 }
1828 
1829 // ------------------------------------------------------------------
1830 // CompileBroker::init_compiler_thread_log
1831 //
1832 // Set up state required by +LogCompilation.
1833 void CompileBroker::init_compiler_thread_log() {
1834     CompilerThread* thread = CompilerThread::current();
1835     char  file_name[4*K];
1836     FILE* fp = NULL;
1837     intx thread_id = os::current_thread_id();
1838     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1839       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1840       if (dir == NULL) {
1841         jio_snprintf(file_name, sizeof(file_name), &quot;hs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;,
1842                      thread_id, os::current_process_id());
1843       } else {
1844         jio_snprintf(file_name, sizeof(file_name),
1845                      &quot;%s%shs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;, dir,
1846                      os::file_separator(), thread_id, os::current_process_id());
1847       }
1848 
1849       fp = fopen(file_name, &quot;wt&quot;);
1850       if (fp != NULL) {
1851         if (LogCompilation &amp;&amp; Verbose) {
1852           tty-&gt;print_cr(&quot;Opening compilation log %s&quot;, file_name);
1853         }
1854         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1855         if (log == NULL) {
1856           fclose(fp);
1857           return;
1858         }
1859         thread-&gt;init_log(log);
1860 
1861         if (xtty != NULL) {
1862           ttyLocker ttyl;
1863           // Record any per thread log files
1864           xtty-&gt;elem(&quot;thread_logfile thread=&#39;&quot; INTX_FORMAT &quot;&#39; filename=&#39;%s&#39;&quot;, thread_id, file_name);
1865         }
1866         return;
1867       }
1868     }
1869     warning(&quot;Cannot open log file: %s&quot;, file_name);
1870 }
1871 
1872 void CompileBroker::log_metaspace_failure() {
1873   const char* message = &quot;some methods may not be compiled because metaspace &quot;
1874                         &quot;is out of memory&quot;;
1875   if (_compilation_log != NULL) {
1876     _compilation_log-&gt;log_metaspace_failure(message);
1877   }
1878   if (PrintCompilation) {
1879     tty-&gt;print_cr(&quot;COMPILE PROFILING SKIPPED: %s&quot;, message);
1880   }
1881 }
1882 
1883 
1884 // ------------------------------------------------------------------
1885 // CompileBroker::set_should_block
1886 //
1887 // Set _should_block.
1888 // Call this from the VM, with Threads_lock held and a safepoint requested.
1889 void CompileBroker::set_should_block() {
1890   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
1891   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at a safepoint already&quot;);
1892 #ifndef PRODUCT
1893   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1894     tty-&gt;print_cr(&quot;notifying compiler thread pool to block&quot;);
1895 #endif
1896   _should_block = true;
1897 }
1898 
1899 // ------------------------------------------------------------------
1900 // CompileBroker::maybe_block
1901 //
1902 // Call this from the compiler at convenient points, to poll for _should_block.
1903 void CompileBroker::maybe_block() {
1904   if (_should_block) {
1905 #ifndef PRODUCT
1906     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1907       tty-&gt;print_cr(&quot;compiler thread &quot; INTPTR_FORMAT &quot; poll detects block request&quot;, p2i(Thread::current()));
1908 #endif
1909     ThreadInVMfromNative tivfn(JavaThread::current());
1910   }
1911 }
1912 
1913 // wrapper for CodeCache::print_summary()
1914 static void codecache_print(bool detailed)
1915 {
1916   ResourceMark rm;
1917   stringStream s;
1918   // Dump code cache  into a buffer before locking the tty,
1919   {
<a name="77" id="anc77"></a><span class="line-modified">1920     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
1921     CodeCache::print_summary(&amp;s, detailed);
1922   }
1923   ttyLocker ttyl;
1924   tty-&gt;print(&quot;%s&quot;, s.as_string());
1925 }
1926 
1927 // wrapper for CodeCache::print_summary() using outputStream
1928 static void codecache_print(outputStream* out, bool detailed) {
1929   ResourceMark rm;
1930   stringStream s;
1931 
1932   // Dump code cache into a buffer
1933   {
<a name="78" id="anc78"></a><span class="line-modified">1934     MutexLockerEx mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);</span>
1935     CodeCache::print_summary(&amp;s, detailed);
1936   }
1937 
1938   char* remaining_log = s.as_string();
1939   while (*remaining_log != &#39;\0&#39;) {
1940     char* eol = strchr(remaining_log, &#39;\n&#39;);
1941     if (eol == NULL) {
1942       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
1943       remaining_log = remaining_log + strlen(remaining_log);
1944     } else {
1945       *eol = &#39;\0&#39;;
1946       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
1947       remaining_log = eol + 1;
1948     }
1949   }
1950 }
1951 
1952 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, bool success, ciEnv* ci_env,
1953                                  int compilable, const char* failure_reason) {
1954   if (success) {
1955     task-&gt;mark_success();
1956     if (ci_env != NULL) {
1957       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
1958     }
1959     if (_compilation_log != NULL) {
1960       nmethod* code = task-&gt;code();
1961       if (code != NULL) {
1962         _compilation_log-&gt;log_nmethod(thread, code);
1963       }
1964     }
1965   } else if (AbortVMOnCompilationFailure) {
1966     if (compilable == ciEnv::MethodCompilable_not_at_tier) {
1967       fatal(&quot;Not compilable at tier %d: %s&quot;, task-&gt;comp_level(), failure_reason);
1968     }
1969     if (compilable == ciEnv::MethodCompilable_never) {
1970       fatal(&quot;Never compilable: %s&quot;, failure_reason);
1971     }
1972   }
1973   // simulate crash during compilation
1974   assert(task-&gt;compile_id() != CICrashAt, &quot;just as planned&quot;);
1975 }
1976 
1977 static void post_compilation_event(EventCompilation* event, CompileTask* task) {
1978   assert(event != NULL, &quot;invariant&quot;);
1979   assert(event-&gt;should_commit(), &quot;invariant&quot;);
<a name="79" id="anc79"></a><span class="line-modified">1980   event-&gt;set_method(task-&gt;method());</span>
1981   event-&gt;set_compileId(task-&gt;compile_id());
<a name="80" id="anc80"></a>

1982   event-&gt;set_compileLevel(task-&gt;comp_level());
1983   event-&gt;set_succeded(task-&gt;is_success());
1984   event-&gt;set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
1985   event-&gt;set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
1986   event-&gt;set_inlinedBytes(task-&gt;num_inlined_bytecodes());
1987   event-&gt;commit();
1988 }
1989 
1990 int DirectivesStack::_depth = 0;
1991 CompilerDirectives* DirectivesStack::_top = NULL;
1992 CompilerDirectives* DirectivesStack::_bottom = NULL;
1993 
1994 // ------------------------------------------------------------------
1995 // CompileBroker::invoke_compiler_on_method
1996 //
1997 // Compile a method.
1998 //
1999 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
2000   task-&gt;print_ul();
2001   if (PrintCompilation) {
2002     ResourceMark rm;
2003     task-&gt;print_tty();
2004   }
2005   elapsedTimer time;
2006 
2007   CompilerThread* thread = CompilerThread::current();
2008   ResourceMark rm(thread);
2009 
2010   if (LogEvents) {
2011     _compilation_log-&gt;log_compile(thread, task);
2012   }
2013 
2014   // Common flags.
2015   uint compile_id = task-&gt;compile_id();
2016   int osr_bci = task-&gt;osr_bci();
2017   bool is_osr = (osr_bci != standard_entry_bci);
2018   bool should_log = (thread-&gt;log() != NULL);
2019   bool should_break = false;
2020   const int task_level = task-&gt;comp_level();
2021   AbstractCompiler* comp = task-&gt;compiler();
2022 
2023   DirectiveSet* directive;
2024   {
2025     // create the handle inside it&#39;s own block so it can&#39;t
2026     // accidentally be referenced once the thread transitions to
2027     // native.  The NoHandleMark before the transition should catch
2028     // any cases where this occurs in the future.
2029     methodHandle method(thread, task-&gt;method());
2030     assert(!method-&gt;is_native(), &quot;no longer compile natives&quot;);
2031 
2032     // Look up matching directives
2033     directive = DirectivesStack::getMatchingDirective(method, comp);
2034 
<a name="81" id="anc81"></a><span class="line-modified">2035     // Save information about this method in case of failure.</span>
<span class="line-modified">2036     set_last_compile(thread, method, is_osr, task_level);</span>


2037 
2038     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
2039   }
2040 
2041   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
2042   if (should_log &amp;&amp; !directive-&gt;LogOption) {
2043     should_log = false;
2044   }
2045 
2046   // Allocate a new set of JNI handles.
2047   push_jni_handle_block();
2048   Method* target_handle = task-&gt;method();
2049   int compilable = ciEnv::MethodCompilable;
2050   const char* failure_reason = NULL;
2051   bool failure_reason_on_C_heap = false;
2052   const char* retry_message = NULL;
2053 
<a name="82" id="anc82"></a><span class="line-removed">2054   int system_dictionary_modification_counter;</span>
<span class="line-removed">2055   {</span>
<span class="line-removed">2056     MutexLocker locker(Compile_lock, thread);</span>
<span class="line-removed">2057     system_dictionary_modification_counter = SystemDictionary::number_of_modifications();</span>
<span class="line-removed">2058   }</span>
<span class="line-removed">2059 </span>
2060 #if INCLUDE_JVMCI
2061   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
2062     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
2063 
2064     TraceTime t1(&quot;compilation&quot;, &amp;time);
2065     EventCompilation event;
2066 
2067     // Skip redefined methods
2068     if (target_handle-&gt;is_old()) {
<a name="83" id="anc83"></a><span class="line-modified">2069         failure_reason = &quot;redefined method&quot;;</span>
<span class="line-modified">2070         retry_message = &quot;not retryable&quot;;</span>
<span class="line-modified">2071         compilable = ciEnv::MethodCompilable_never;</span>
2072     } else {
<a name="84" id="anc84"></a><span class="line-modified">2073         JVMCIEnv env(task, system_dictionary_modification_counter);</span>
<span class="line-modified">2074         methodHandle method(thread, target_handle);</span>
<span class="line-modified">2075         jvmci-&gt;compile_method(method, osr_bci, &amp;env);</span>
<span class="line-modified">2076 </span>
<span class="line-modified">2077         failure_reason = env.failure_reason();</span>
<span class="line-modified">2078         failure_reason_on_C_heap = env.failure_reason_on_C_heap();</span>
<span class="line-modified">2079         if (!env.retryable()) {</span>
<span class="line-modified">2080           retry_message = &quot;not retryable&quot;;</span>
<span class="line-modified">2081           compilable = ciEnv::MethodCompilable_not_at_tier;</span>
<span class="line-modified">2082         }</span>




2083     }
2084     post_compile(thread, task, task-&gt;code() != NULL, NULL, compilable, failure_reason);
2085     if (event.should_commit()) {
2086       post_compilation_event(&amp;event, task);
2087     }
2088 
2089   } else
2090 #endif // INCLUDE_JVMCI
2091   {
2092     NoHandleMark  nhm;
2093     ThreadToNativeFromVM ttn(thread);
2094 
<a name="85" id="anc85"></a><span class="line-modified">2095     ciEnv ci_env(task, system_dictionary_modification_counter);</span>
2096     if (should_break) {
2097       ci_env.set_break_at_compile(true);
2098     }
2099     if (should_log) {
2100       ci_env.set_log(thread-&gt;log());
2101     }
2102     assert(thread-&gt;env() == &amp;ci_env, &quot;set by ci_env&quot;);
2103     // The thread-env() field is cleared in ~CompileTaskWrapper.
2104 
2105     // Cache Jvmti state
2106     ci_env.cache_jvmti_state();
2107 
2108     // Cache DTrace flags
2109     ci_env.cache_dtrace_flags();
2110 
2111     ciMethod* target = ci_env.get_method_from_handle(target_handle);
2112 
2113     TraceTime t1(&quot;compilation&quot;, &amp;time);
2114     EventCompilation event;
2115 
2116     if (comp == NULL) {
2117       ci_env.record_method_not_compilable(&quot;no compiler&quot;, !TieredCompilation);
2118     } else {
2119       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
<a name="86" id="anc86"></a><span class="line-modified">2120         MonitorLockerEx locker(Compilation_lock, Mutex::_no_safepoint_check_flag);</span>
2121         while (WhiteBox::compilation_locked) {
<a name="87" id="anc87"></a><span class="line-modified">2122           locker.wait(Mutex::_no_safepoint_check_flag);</span>
2123         }
2124       }
2125       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
2126     }
2127 
2128     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
2129       //assert(false, &quot;compiler should always document failure&quot;);
2130       // The compiler elected, without comment, not to register a result.
2131       // Do not attempt further compilations of this method.
2132       ci_env.record_method_not_compilable(&quot;compile failed&quot;, !TieredCompilation);
2133     }
2134 
2135     // Copy this bit to the enclosing block:
2136     compilable = ci_env.compilable();
2137 
2138     if (ci_env.failing()) {
2139       failure_reason = ci_env.failure_reason();
2140       retry_message = ci_env.retry_message();
2141       ci_env.report_failure(failure_reason);
2142     }
2143 
2144     post_compile(thread, task, !ci_env.failing(), &amp;ci_env, compilable, failure_reason);
2145     if (event.should_commit()) {
2146       post_compilation_event(&amp;event, task);
2147     }
2148   }
2149   // Remove the JNI handle block after the ciEnv destructor has run in
2150   // the previous block.
2151   pop_jni_handle_block();
2152 
2153   if (failure_reason != NULL) {
2154     task-&gt;set_failure_reason(failure_reason, failure_reason_on_C_heap);
2155     if (_compilation_log != NULL) {
2156       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
2157     }
2158     if (PrintCompilation) {
2159       FormatBufferResource msg = retry_message != NULL ?
2160         FormatBufferResource(&quot;COMPILE SKIPPED: %s (%s)&quot;, failure_reason, retry_message) :
2161         FormatBufferResource(&quot;COMPILE SKIPPED: %s&quot;,      failure_reason);
2162       task-&gt;print(tty, msg);
2163     }
2164   }
2165 
2166   methodHandle method(thread, task-&gt;method());
2167 
2168   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
2169 
2170   collect_statistics(thread, time, task);
2171 
2172   nmethod* nm = task-&gt;code();
2173   if (nm != NULL) {
2174     nm-&gt;maybe_print_nmethod(directive);
2175   }
2176   DirectivesStack::release(directive);
2177 
2178   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2179     tty-&gt;print(&quot;%7d &quot;, (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2180     tty-&gt;print(&quot;%4d &quot;, compile_id);    // print compilation number
2181     tty-&gt;print(&quot;%s &quot;, (is_osr ? &quot;%&quot; : &quot; &quot;));
2182     if (task-&gt;code() != NULL) {
2183       tty-&gt;print(&quot;size: %d(%d) &quot;, task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2184     }
2185     tty-&gt;print_cr(&quot;time: %d inlined: %d bytes&quot;, (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2186   }
2187 
2188   Log(compilation, codecache) log;
2189   if (log.is_debug()) {
2190     LogStream ls(log.debug());
2191     codecache_print(&amp;ls, /* detailed= */ false);
2192   }
2193   if (PrintCodeCacheOnCompilation) {
2194     codecache_print(/* detailed= */ false);
2195   }
2196   // Disable compilation, if required.
2197   switch (compilable) {
2198   case ciEnv::MethodCompilable_never:
2199     if (is_osr)
<a name="88" id="anc88"></a><span class="line-modified">2200       method-&gt;set_not_osr_compilable_quietly();</span>
2201     else
<a name="89" id="anc89"></a><span class="line-modified">2202       method-&gt;set_not_compilable_quietly();</span>
2203     break;
2204   case ciEnv::MethodCompilable_not_at_tier:
2205     if (is_osr)
<a name="90" id="anc90"></a><span class="line-modified">2206       method-&gt;set_not_osr_compilable_quietly(task_level);</span>
2207     else
<a name="91" id="anc91"></a><span class="line-modified">2208       method-&gt;set_not_compilable_quietly(task_level);</span>
2209     break;
2210   }
2211 
2212   // Note that the queued_for_compilation bits are cleared without
2213   // protection of a mutex. [They were set by the requester thread,
2214   // when adding the task to the compile queue -- at which time the
2215   // compile queue lock was held. Subsequently, we acquired the compile
2216   // queue lock to get this task off the compile queue; thus (to belabour
2217   // the point somewhat) our clearing of the bits must be occurring
2218   // only after the setting of the bits. See also 14012000 above.
2219   method-&gt;clear_queued_for_compilation();
2220 }
2221 
2222 /**
2223  * The CodeCache is full. Print warning and disable compilation.
2224  * Schedule code cache cleaning so compilation can continue later.
2225  * This function needs to be called only from CodeCache::allocate(),
2226  * since we currently handle a full code cache uniformly.
2227  */
2228 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2229   UseInterpreter = true;
2230   if (UseCompiler || AlwaysCompileLoopMethods ) {
2231     if (xtty != NULL) {
2232       ResourceMark rm;
2233       stringStream s;
2234       // Dump code cache state into a buffer before locking the tty,
2235       // because log_state() will use locks causing lock conflicts.
2236       CodeCache::log_state(&amp;s);
2237       // Lock to prevent tearing
2238       ttyLocker ttyl;
2239       xtty-&gt;begin_elem(&quot;code_cache_full&quot;);
2240       xtty-&gt;print(&quot;%s&quot;, s.as_string());
2241       xtty-&gt;stamp();
2242       xtty-&gt;end_elem();
2243     }
2244 
2245 #ifndef PRODUCT
2246     if (ExitOnFullCodeCache) {
2247       codecache_print(/* detailed= */ true);
2248       before_exit(JavaThread::current());
2249       exit_globals(); // will delete tty
2250       vm_direct_exit(1);
2251     }
2252 #endif
2253     if (UseCodeCacheFlushing) {
2254       // Since code cache is full, immediately stop new compiles
2255       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2256         NMethodSweeper::log_sweep(&quot;disable_compiler&quot;);
2257       }
2258     } else {
2259       disable_compilation_forever();
2260     }
2261 
2262     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2263   }
2264 }
2265 
2266 // ------------------------------------------------------------------
<a name="92" id="anc92"></a><span class="line-modified">2267 // CompileBroker::set_last_compile</span>
2268 //
2269 // Record this compilation for debugging purposes.
<a name="93" id="anc93"></a><span class="line-modified">2270 void CompileBroker::set_last_compile(CompilerThread* thread, const methodHandle&amp; method, bool is_osr, int comp_level) {</span>
2271   ResourceMark rm;
2272   char* method_name = method-&gt;name()-&gt;as_C_string();
<a name="94" id="anc94"></a><span class="line-removed">2273   strncpy(_last_method_compiled, method_name, CompileBroker::name_buffer_length);</span>
<span class="line-removed">2274   _last_method_compiled[CompileBroker::name_buffer_length - 1] = &#39;\0&#39;; // ensure null terminated</span>
2275   char current_method[CompilerCounters::cmname_buffer_length];
2276   size_t maxLen = CompilerCounters::cmname_buffer_length;
2277 
<a name="95" id="anc95"></a><span class="line-modified">2278   if (UsePerfData) {</span>
<span class="line-removed">2279     const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();</span>
2280 
<a name="96" id="anc96"></a><span class="line-modified">2281     size_t s1len = strlen(class_name);</span>
<span class="line-modified">2282     size_t s2len = strlen(method_name);</span>
2283 
<a name="97" id="anc97"></a><span class="line-modified">2284     // check if we need to truncate the string</span>
<span class="line-modified">2285     if (s1len + s2len + 2 &gt; maxLen) {</span>
2286 
<a name="98" id="anc98"></a><span class="line-modified">2287       // the strategy is to lop off the leading characters of the</span>
<span class="line-modified">2288       // class name and the trailing characters of the method name.</span>
2289 
<a name="99" id="anc99"></a><span class="line-modified">2290       if (s2len + 2 &gt; maxLen) {</span>
<span class="line-modified">2291         // lop of the entire class name string, let snprintf handle</span>
<span class="line-modified">2292         // truncation of the method name.</span>
<span class="line-modified">2293         class_name += s1len; // null string</span>
<span class="line-modified">2294       }</span>
<span class="line-modified">2295       else {</span>
<span class="line-modified">2296         // lop off the extra characters from the front of the class name</span>
<span class="line-modified">2297         class_name += ((s1len + s2len + 2) - maxLen);</span>
<span class="line-removed">2298       }</span>
2299     }
<a name="100" id="anc100"></a><span class="line-removed">2300 </span>
<span class="line-removed">2301     jio_snprintf(current_method, maxLen, &quot;%s %s&quot;, class_name, method_name);</span>
2302   }
2303 
<a name="101" id="anc101"></a>


2304   if (CICountOSR &amp;&amp; is_osr) {
<a name="102" id="anc102"></a><span class="line-modified">2305     _last_compile_type = osr_compile;</span>
<span class="line-removed">2306   } else {</span>
<span class="line-removed">2307     _last_compile_type = normal_compile;</span>
2308   }
<a name="103" id="anc103"></a><span class="line-removed">2309   _last_compile_level = comp_level;</span>
2310 
<a name="104" id="anc104"></a><span class="line-modified">2311   if (UsePerfData) {</span>
<span class="line-modified">2312     CompilerCounters* counters = thread-&gt;counters();</span>
<span class="line-modified">2313     counters-&gt;set_current_method(current_method);</span>
<span class="line-removed">2314     counters-&gt;set_compile_type((jlong)_last_compile_type);</span>
<span class="line-removed">2315   }</span>
2316 }
2317 
<a name="105" id="anc105"></a><span class="line-removed">2318 </span>
2319 // ------------------------------------------------------------------
2320 // CompileBroker::push_jni_handle_block
2321 //
2322 // Push on a new block of JNI handles.
2323 void CompileBroker::push_jni_handle_block() {
2324   JavaThread* thread = JavaThread::current();
2325 
2326   // Allocate a new block for JNI handles.
2327   // Inlined code from jni_PushLocalFrame()
2328   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2329   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2330   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, &quot;should not be NULL&quot;);
2331   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc&#39;d.
2332   thread-&gt;set_active_handles(compile_handles);
2333 }
2334 
2335 
2336 // ------------------------------------------------------------------
2337 // CompileBroker::pop_jni_handle_block
2338 //
2339 // Pop off the current block of JNI handles.
2340 void CompileBroker::pop_jni_handle_block() {
2341   JavaThread* thread = JavaThread::current();
2342 
2343   // Release our JNI handle block
2344   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2345   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2346   thread-&gt;set_active_handles(java_handles);
2347   compile_handles-&gt;set_pop_frame_link(NULL);
2348   JNIHandleBlock::release_block(compile_handles, thread); // may block
2349 }
2350 
2351 // ------------------------------------------------------------------
2352 // CompileBroker::collect_statistics
2353 //
2354 // Collect statistics about the compilation.
2355 
2356 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2357   bool success = task-&gt;is_success();
2358   methodHandle method (thread, task-&gt;method());
2359   uint compile_id = task-&gt;compile_id();
2360   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2361   nmethod* code = task-&gt;code();
2362   CompilerCounters* counters = thread-&gt;counters();
2363 
2364   assert(code == NULL || code-&gt;is_locked_by_vm(), &quot;will survive the MutexLocker&quot;);
2365   MutexLocker locker(CompileStatistics_lock);
2366 
2367   // _perf variables are production performance counters which are
2368   // updated regardless of the setting of the CITime and CITimeEach flags
2369   //
2370 
2371   // account all time, including bailouts and failures in this counter;
2372   // C1 and C2 counters are counting both successful and unsuccessful compiles
2373   _t_total_compilation.add(time);
2374 
2375   if (!success) {
2376     _total_bailout_count++;
2377     if (UsePerfData) {
2378       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2379       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2380       _perf_total_bailout_count-&gt;inc();
2381     }
2382     _t_bailedout_compilation.add(time);
2383   } else if (code == NULL) {
2384     if (UsePerfData) {
2385       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2386       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2387       _perf_total_invalidated_count-&gt;inc();
2388     }
2389     _total_invalidated_count++;
2390     _t_invalidated_compilation.add(time);
2391   } else {
2392     // Compilation succeeded
2393 
2394     // update compilation ticks - used by the implementation of
2395     // java.lang.management.CompilationMBean
2396     _perf_total_compilation-&gt;inc(time.ticks());
2397     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2398 
2399     if (CITime) {
2400       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2401       if (is_osr) {
2402         _t_osr_compilation.add(time);
2403         _sum_osr_bytes_compiled += bytes_compiled;
2404       } else {
2405         _t_standard_compilation.add(time);
2406         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2407       }
2408 
2409 #if INCLUDE_JVMCI
2410       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2411       if (comp) {
2412         CompilerStatistics* stats = comp-&gt;stats();
2413         if (stats) {
2414           if (is_osr) {
2415             stats-&gt;_osr.update(time, bytes_compiled);
2416           } else {
2417             stats-&gt;_standard.update(time, bytes_compiled);
2418           }
2419           stats-&gt;_nmethods_size += code-&gt;total_size();
2420           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2421         } else { // if (!stats)
2422           assert(false, &quot;Compiler statistics object must exist&quot;);
2423         }
2424       } else { // if (!comp)
2425         assert(false, &quot;Compiler object must exist&quot;);
2426       }
2427 #endif // INCLUDE_JVMCI
2428     }
2429 
2430     if (UsePerfData) {
2431       // save the name of the last method compiled
2432       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2433       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2434       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2435                                          task-&gt;num_inlined_bytecodes());
2436       if (is_osr) {
2437         _perf_osr_compilation-&gt;inc(time.ticks());
2438         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2439       } else {
2440         _perf_standard_compilation-&gt;inc(time.ticks());
2441         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2442       }
2443     }
2444 
2445     if (CITimeEach) {
2446       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2447       tty-&gt;print_cr(&quot;%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)&quot;,
2448                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2449     }
2450 
2451     // Collect counts of successful compilations
2452     _sum_nmethod_size      += code-&gt;total_size();
2453     _sum_nmethod_code_size += code-&gt;insts_size();
2454     _total_compile_count++;
2455 
2456     if (UsePerfData) {
2457       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2458       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2459       _perf_total_compile_count-&gt;inc();
2460     }
2461 
2462     if (is_osr) {
2463       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2464       _total_osr_compile_count++;
2465     } else {
2466       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2467       _total_standard_compile_count++;
2468     }
2469   }
2470   // set the current method for the thread to null
2471   if (UsePerfData) counters-&gt;set_current_method(&quot;&quot;);
2472 }
2473 
2474 const char* CompileBroker::compiler_name(int comp_level) {
2475   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2476   if (comp == NULL) {
2477     return &quot;no compiler&quot;;
2478   } else {
2479     return (comp-&gt;name());
2480   }
2481 }
2482 
2483 #if INCLUDE_JVMCI
2484 void CompileBroker::print_times(AbstractCompiler* comp) {
2485   CompilerStatistics* stats = comp-&gt;stats();
2486   if (stats) {
2487     tty-&gt;print_cr(&quot;  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}&quot;,
2488                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2489                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2490                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2491                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2492   } else { // if (!stats)
2493     assert(false, &quot;Compiler statistics object must exist&quot;);
2494   }
2495   comp-&gt;print_timers();
2496 }
2497 #endif // INCLUDE_JVMCI
2498 
2499 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2500 #if INCLUDE_JVMCI
2501   elapsedTimer standard_compilation;
2502   elapsedTimer total_compilation;
2503   elapsedTimer osr_compilation;
2504 
2505   int standard_bytes_compiled = 0;
2506   int osr_bytes_compiled = 0;
2507 
2508   int standard_compile_count = 0;
2509   int osr_compile_count = 0;
2510   int total_compile_count = 0;
2511 
2512   int nmethods_size = 0;
2513   int nmethods_code_size = 0;
2514   bool printedHeader = false;
2515 
2516   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2517     AbstractCompiler* comp = _compilers[i];
2518     if (comp != NULL) {
2519       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2520         printedHeader = true;
2521         tty-&gt;cr();
2522         tty-&gt;print_cr(&quot;Individual compiler times (for compiled methods only)&quot;);
2523         tty-&gt;print_cr(&quot;------------------------------------------------&quot;);
2524         tty-&gt;cr();
2525       }
2526       CompilerStatistics* stats = comp-&gt;stats();
2527 
2528       if (stats) {
2529         standard_compilation.add(stats-&gt;_standard._time);
2530         osr_compilation.add(stats-&gt;_osr._time);
2531 
2532         standard_bytes_compiled += stats-&gt;_standard._bytes;
2533         osr_bytes_compiled += stats-&gt;_osr._bytes;
2534 
2535         standard_compile_count += stats-&gt;_standard._count;
2536         osr_compile_count += stats-&gt;_osr._count;
2537 
2538         nmethods_size += stats-&gt;_nmethods_size;
2539         nmethods_code_size += stats-&gt;_nmethods_code_size;
2540       } else { // if (!stats)
2541         assert(false, &quot;Compiler statistics object must exist&quot;);
2542       }
2543 
2544       if (per_compiler) {
2545         print_times(comp);
2546       }
2547     }
2548   }
2549   total_compile_count = osr_compile_count + standard_compile_count;
2550   total_compilation.add(osr_compilation);
2551   total_compilation.add(standard_compilation);
2552 
2553   // In hosted mode, print the JVMCI compiler specific counters manually.
2554   if (!UseJVMCICompiler) {
2555     JVMCICompiler::print_compilation_timers();
2556   }
2557 #else // INCLUDE_JVMCI
2558   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2559   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2560   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2561 
2562   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2563   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2564 
2565   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2566   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2567   int total_compile_count = CompileBroker::_total_compile_count;
2568 
2569   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2570   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2571 #endif // INCLUDE_JVMCI
2572 
2573   if (!aggregate) {
2574     return;
2575   }
2576   tty-&gt;cr();
2577   tty-&gt;print_cr(&quot;Accumulated compiler times&quot;);
2578   tty-&gt;print_cr(&quot;----------------------------------------------------------&quot;);
2579                //0000000000111111111122222222223333333333444444444455555555556666666666
2580                //0123456789012345678901234567890123456789012345678901234567890123456789
2581   tty-&gt;print_cr(&quot;  Total compilation time   : %7.3f s&quot;, total_compilation.seconds());
2582   tty-&gt;print_cr(&quot;    Standard compilation   : %7.3f s, Average : %2.3f s&quot;,
2583                 standard_compilation.seconds(),
2584                 standard_compilation.seconds() / standard_compile_count);
2585   tty-&gt;print_cr(&quot;    Bailed out compilation : %7.3f s, Average : %2.3f s&quot;,
2586                 CompileBroker::_t_bailedout_compilation.seconds(),
2587                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2588   tty-&gt;print_cr(&quot;    On stack replacement   : %7.3f s, Average : %2.3f s&quot;,
2589                 osr_compilation.seconds(),
2590                 osr_compilation.seconds() / osr_compile_count);
2591   tty-&gt;print_cr(&quot;    Invalidated            : %7.3f s, Average : %2.3f s&quot;,
2592                 CompileBroker::_t_invalidated_compilation.seconds(),
2593                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2594 
2595   AbstractCompiler *comp = compiler(CompLevel_simple);
2596   if (comp != NULL) {
2597     tty-&gt;cr();
2598     comp-&gt;print_timers();
2599   }
2600   comp = compiler(CompLevel_full_optimization);
2601   if (comp != NULL) {
2602     tty-&gt;cr();
2603     comp-&gt;print_timers();
2604   }
2605   tty-&gt;cr();
2606   tty-&gt;print_cr(&quot;  Total compiled methods    : %8d methods&quot;, total_compile_count);
2607   tty-&gt;print_cr(&quot;    Standard compilation    : %8d methods&quot;, standard_compile_count);
2608   tty-&gt;print_cr(&quot;    On stack replacement    : %8d methods&quot;, osr_compile_count);
2609   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2610   tty-&gt;print_cr(&quot;  Total compiled bytecodes  : %8d bytes&quot;, tcb);
2611   tty-&gt;print_cr(&quot;    Standard compilation    : %8d bytes&quot;, standard_bytes_compiled);
2612   tty-&gt;print_cr(&quot;    On stack replacement    : %8d bytes&quot;, osr_bytes_compiled);
2613   double tcs = total_compilation.seconds();
2614   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2615   tty-&gt;print_cr(&quot;  Average compilation speed : %8d bytes/s&quot;, bps);
2616   tty-&gt;cr();
2617   tty-&gt;print_cr(&quot;  nmethod code size         : %8d bytes&quot;, nmethods_code_size);
2618   tty-&gt;print_cr(&quot;  nmethod total size        : %8d bytes&quot;, nmethods_size);
2619 }
2620 
<a name="106" id="anc106"></a><span class="line-removed">2621 // Debugging output for failure</span>
<span class="line-removed">2622 void CompileBroker::print_last_compile() {</span>
<span class="line-removed">2623   if (_last_compile_level != CompLevel_none &amp;&amp;</span>
<span class="line-removed">2624       compiler(_last_compile_level) != NULL &amp;&amp;</span>
<span class="line-removed">2625       _last_compile_type != no_compile) {</span>
<span class="line-removed">2626     if (_last_compile_type == osr_compile) {</span>
<span class="line-removed">2627       tty-&gt;print_cr(&quot;Last parse:  [osr]%d+++(%d) %s&quot;,</span>
<span class="line-removed">2628                     _osr_compilation_id, _last_compile_level, _last_method_compiled);</span>
<span class="line-removed">2629     } else {</span>
<span class="line-removed">2630       tty-&gt;print_cr(&quot;Last parse:  %d+++(%d) %s&quot;,</span>
<span class="line-removed">2631                     _compilation_id, _last_compile_level, _last_method_compiled);</span>
<span class="line-removed">2632     }</span>
<span class="line-removed">2633   }</span>
<span class="line-removed">2634 }</span>
<span class="line-removed">2635 </span>
2636 // Print general/accumulated JIT information.
2637 void CompileBroker::print_info(outputStream *out) {
2638   if (out == NULL) out = tty;
2639   out-&gt;cr();
2640   out-&gt;print_cr(&quot;======================&quot;);
2641   out-&gt;print_cr(&quot;   General JIT info   &quot;);
2642   out-&gt;print_cr(&quot;======================&quot;);
2643   out-&gt;cr();
2644   out-&gt;print_cr(&quot;            JIT is : %7s&quot;,     should_compile_new_jobs() ? &quot;on&quot; : &quot;off&quot;);
2645   out-&gt;print_cr(&quot;  Compiler threads : %7d&quot;,     (int)CICompilerCount);
2646   out-&gt;cr();
2647   out-&gt;print_cr(&quot;CodeCache overview&quot;);
2648   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2649   out-&gt;cr();
2650   out-&gt;print_cr(&quot;         Reserved size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::max_capacity() / K);
2651   out-&gt;print_cr(&quot;        Committed size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::capacity() / K);
2652   out-&gt;print_cr(&quot;  Unallocated capacity : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::unallocated_capacity() / K);
2653   out-&gt;cr();
2654 
2655   out-&gt;cr();
2656   out-&gt;print_cr(&quot;CodeCache cleaning overview&quot;);
2657   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2658   out-&gt;cr();
2659   NMethodSweeper::print(out);
2660   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2661   out-&gt;cr();
2662 }
2663 
2664 // Note: tty_lock must not be held upon entry to this function.
2665 //       Print functions called from herein do &quot;micro-locking&quot; on tty_lock.
2666 //       That&#39;s a tradeoff which keeps together important blocks of output.
2667 //       At the same time, continuous tty_lock hold time is kept in check,
2668 //       preventing concurrently printing threads from stalling a long time.
<a name="107" id="anc107"></a><span class="line-modified">2669 void CompileBroker::print_heapinfo(outputStream* out, const char* function, const char* granularity) {</span>
2670   TimeStamp ts_total;
2671   TimeStamp ts_global;
2672   TimeStamp ts;
2673 
2674   bool allFun = !strcmp(function, &quot;all&quot;);
2675   bool aggregate = !strcmp(function, &quot;aggregate&quot;) || !strcmp(function, &quot;analyze&quot;) || allFun;
2676   bool usedSpace = !strcmp(function, &quot;UsedSpace&quot;) || allFun;
2677   bool freeSpace = !strcmp(function, &quot;FreeSpace&quot;) || allFun;
2678   bool methodCount = !strcmp(function, &quot;MethodCount&quot;) || allFun;
2679   bool methodSpace = !strcmp(function, &quot;MethodSpace&quot;) || allFun;
2680   bool methodAge = !strcmp(function, &quot;MethodAge&quot;) || allFun;
2681   bool methodNames = !strcmp(function, &quot;MethodNames&quot;) || allFun;
2682   bool discard = !strcmp(function, &quot;discard&quot;) || allFun;
2683 
2684   if (out == NULL) {
2685     out = tty;
2686   }
2687 
2688   if (!(aggregate || usedSpace || freeSpace || methodCount || methodSpace || methodAge || methodNames || discard)) {
2689     out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics: Function %s is not supported&quot;, function);
2690     out-&gt;cr();
2691     return;
2692   }
2693 
2694   ts_total.update(); // record starting point
2695 
2696   if (aggregate) {
2697     print_info(out);
2698   }
2699 
2700   // We hold the CodeHeapStateAnalytics_lock all the time, from here until we leave this function.
2701   // That prevents another thread from destroying our view on the CodeHeap.
2702   // When we request individual parts of the analysis via the jcmd interface, it is possible
2703   // that in between another thread (another jcmd user or the vm running into CodeCache OOM)
2704   // updated the aggregated data. That&#39;s a tolerable tradeoff because we can&#39;t hold a lock
2705   // across user interaction.
2706   // Acquire this lock before acquiring the CodeCache_lock.
2707   // CodeHeapStateAnalytics_lock could be held by a concurrent thread for a long time,
2708   // leading to an unnecessarily long hold time of the CodeCache_lock.
2709   ts.update(); // record starting point
<a name="108" id="anc108"></a><span class="line-modified">2710   MutexLockerEx mu1(CodeHeapStateAnalytics_lock, Mutex::_no_safepoint_check_flag);</span>
2711   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2712 
2713   // If we serve an &quot;allFun&quot; call, it is beneficial to hold the CodeCache_lock
2714   // for the entire duration of aggregation and printing. That makes sure
2715   // we see a consistent picture and do not run into issues caused by
2716   // the CodeHeap being altered concurrently.
<a name="109" id="anc109"></a><span class="line-modified">2717   Monitor* global_lock   = allFun ? CodeCache_lock : NULL;</span>
<span class="line-modified">2718   Monitor* function_lock = allFun ? NULL : CodeCache_lock;</span>
2719   ts_global.update(); // record starting point
<a name="110" id="anc110"></a><span class="line-modified">2720   MutexLockerEx mu2(global_lock, Mutex::_no_safepoint_check_flag);</span>
2721   if (global_lock != NULL) {
2722     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock wait took %10.3f seconds _________\n&quot;, ts_global.seconds());
2723     ts_global.update(); // record starting point
2724   }
2725 
2726   if (aggregate) {
2727     ts.update(); // record starting point
<a name="111" id="anc111"></a><span class="line-modified">2728     MutexLockerEx mu3(function_lock, Mutex::_no_safepoint_check_flag);</span>
2729     if (function_lock != NULL) {
2730       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2731     }
2732 
2733     ts.update(); // record starting point
2734     CodeCache::aggregate(out, granularity);
2735     if (function_lock != NULL) {
2736       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock hold took %10.3f seconds _________\n&quot;, ts.seconds());
2737     }
2738   }
2739 
2740   if (usedSpace) CodeCache::print_usedSpace(out);
2741   if (freeSpace) CodeCache::print_freeSpace(out);
2742   if (methodCount) CodeCache::print_count(out);
2743   if (methodSpace) CodeCache::print_space(out);
2744   if (methodAge) CodeCache::print_age(out);
2745   if (methodNames) {
2746     // print_names() has shown to be sensitive to concurrent CodeHeap modifications.
2747     // Therefore, request  the CodeCache_lock before calling...
<a name="112" id="anc112"></a><span class="line-modified">2748     MutexLockerEx mu3(function_lock, Mutex::_no_safepoint_check_flag);</span>
2749     CodeCache::print_names(out);
2750   }
2751   if (discard) CodeCache::discard(out);
2752 
2753   if (global_lock != NULL) {
2754     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock hold took %10.3f seconds _________\n&quot;, ts_global.seconds());
2755   }
2756   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics total duration %10.3f seconds _________\n&quot;, ts_total.seconds());
2757 }
<a name="113" id="anc113"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="113" type="hidden" />
</body>
</html>