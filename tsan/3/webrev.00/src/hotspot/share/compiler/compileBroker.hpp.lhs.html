<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/compiler/compileBroker.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_COMPILER_COMPILEBROKER_HPP
 26 #define SHARE_COMPILER_COMPILEBROKER_HPP
 27 
 28 #include &quot;ci/compilerInterface.hpp&quot;
 29 #include &quot;compiler/abstractCompiler.hpp&quot;
 30 #include &quot;compiler/compileTask.hpp&quot;
 31 #include &quot;compiler/compilerDirectives.hpp&quot;
<a name="1" id="anc1"></a>
 32 #include &quot;runtime/perfData.hpp&quot;
 33 #include &quot;utilities/stack.hpp&quot;
 34 #if INCLUDE_JVMCI
 35 #include &quot;jvmci/jvmciCompiler.hpp&quot;
 36 #endif
 37 
 38 class nmethod;
 39 class nmethodLocker;
 40 
 41 // CompilerCounters
 42 //
 43 // Per Compiler Performance Counters.
 44 //
 45 class CompilerCounters : public CHeapObj&lt;mtCompiler&gt; {
 46 
 47   public:
 48     enum {
 49       cmname_buffer_length = 160
 50     };
 51 
 52   private:
 53 
 54     char _current_method[cmname_buffer_length];
 55     int  _compile_type;
 56 
 57   public:
 58     CompilerCounters();
 59 
 60     // these methods should be called in a thread safe context
 61 
 62     void set_current_method(const char* method) {
 63       strncpy(_current_method, method, (size_t)cmname_buffer_length-1);
 64       _current_method[cmname_buffer_length-1] = &#39;\0&#39;;
 65     }
 66 
 67     char* current_method()                  { return _current_method; }
 68 
 69     void set_compile_type(int compile_type) {
 70       _compile_type = compile_type;
 71     }
 72 
 73     int compile_type()                       { return _compile_type; }
 74 
 75 };
 76 
 77 // CompileQueue
 78 //
 79 // A list of CompileTasks.
 80 class CompileQueue : public CHeapObj&lt;mtCompiler&gt; {
 81  private:
 82   const char* _name;
 83 
 84   CompileTask* _first;
 85   CompileTask* _last;
 86 
 87   CompileTask* _first_stale;
 88 
 89   int _size;
 90 
 91   void purge_stale_tasks();
 92  public:
 93   CompileQueue(const char* name) {
 94     _name = name;
 95     _first = NULL;
 96     _last = NULL;
 97     _size = 0;
 98     _first_stale = NULL;
 99   }
100 
101   const char*  name() const                      { return _name; }
102 
103   void         add(CompileTask* task);
104   void         remove(CompileTask* task);
105   void         remove_and_mark_stale(CompileTask* task);
106   CompileTask* first()                           { return _first; }
107   CompileTask* last()                            { return _last;  }
108 
109   CompileTask* get();
110 
111   bool         is_empty() const                  { return _first == NULL; }
112   int          size()     const                  { return _size;          }
113 
114 
115   // Redefine Classes support
116   void mark_on_stack();
117   void free_all();
118   void print_tty();
119   void print(outputStream* st = tty);
120 
121   ~CompileQueue() {
122     assert (is_empty(), &quot; Compile Queue must be empty&quot;);
123   }
124 };
125 
126 // CompileTaskWrapper
127 //
128 // Assign this task to the current thread.  Deallocate the task
129 // when the compilation is complete.
130 class CompileTaskWrapper : StackObj {
131 public:
132   CompileTaskWrapper(CompileTask* task);
133   ~CompileTaskWrapper();
134 };
135 
136 // Compilation
137 //
138 // The broker for all compilation requests.
139 class CompileBroker: AllStatic {
140  friend class Threads;
141  friend class CompileTaskWrapper;
142 
143  public:
144   enum {
145     name_buffer_length = 100
146   };
147 
148   // Compile type Information for print_last_compile() and CompilerCounters
149   enum { no_compile, normal_compile, osr_compile, native_compile };
150   static int assign_compile_id (const methodHandle&amp; method, int osr_bci);
151 
152 
153  private:
154   static bool _initialized;
155   static volatile bool _should_block;
156 
157   // This flag can be used to stop compilation or turn it back on
158   static volatile jint _should_compile_new_jobs;
159 
160   // The installed compiler(s)
161   static AbstractCompiler* _compilers[2];
162 
163   // The maximum numbers of compiler threads to be determined during startup.
164   static int _c1_count, _c2_count;
165 
166   // An array of compiler thread Java objects
167   static jobject *_compiler1_objects, *_compiler2_objects;
168 
169   // An array of compiler logs
170   static CompileLog **_compiler1_logs, **_compiler2_logs;
171 
172   // These counters are used for assigning id&#39;s to each compilation
173   static volatile jint _compilation_id;
174   static volatile jint _osr_compilation_id;
175 
<a name="2" id="anc2"></a><span class="line-removed">176   static int  _last_compile_type;</span>
<span class="line-removed">177   static int  _last_compile_level;</span>
<span class="line-removed">178   static char _last_method_compiled[name_buffer_length];</span>
<span class="line-removed">179 </span>
180   static CompileQueue* _c2_compile_queue;
181   static CompileQueue* _c1_compile_queue;
182 
183   // performance counters
184   static PerfCounter* _perf_total_compilation;
185   static PerfCounter* _perf_native_compilation;
186   static PerfCounter* _perf_osr_compilation;
187   static PerfCounter* _perf_standard_compilation;
188 
189   static PerfCounter* _perf_total_bailout_count;
190   static PerfCounter* _perf_total_invalidated_count;
191   static PerfCounter* _perf_total_compile_count;
192   static PerfCounter* _perf_total_native_compile_count;
193   static PerfCounter* _perf_total_osr_compile_count;
194   static PerfCounter* _perf_total_standard_compile_count;
195 
196   static PerfCounter* _perf_sum_osr_bytes_compiled;
197   static PerfCounter* _perf_sum_standard_bytes_compiled;
198   static PerfCounter* _perf_sum_nmethod_size;
199   static PerfCounter* _perf_sum_nmethod_code_size;
200 
201   static PerfStringVariable* _perf_last_method;
202   static PerfStringVariable* _perf_last_failed_method;
203   static PerfStringVariable* _perf_last_invalidated_method;
204   static PerfVariable*       _perf_last_compile_type;
205   static PerfVariable*       _perf_last_compile_size;
206   static PerfVariable*       _perf_last_failed_type;
207   static PerfVariable*       _perf_last_invalidated_type;
208 
209   // Timers and counters for generating statistics
210   static elapsedTimer _t_total_compilation;
211   static elapsedTimer _t_osr_compilation;
212   static elapsedTimer _t_standard_compilation;
213   static elapsedTimer _t_invalidated_compilation;
214   static elapsedTimer _t_bailedout_compilation;
215 
216   static int _total_compile_count;
217   static int _total_bailout_count;
218   static int _total_invalidated_count;
219   static int _total_native_compile_count;
220   static int _total_osr_compile_count;
221   static int _total_standard_compile_count;
222   static int _total_compiler_stopped_count;
223   static int _total_compiler_restarted_count;
224   static int _sum_osr_bytes_compiled;
225   static int _sum_standard_bytes_compiled;
226   static int _sum_nmethod_size;
227   static int _sum_nmethod_code_size;
228   static long _peak_compilation_time;
229 
230   static volatile int _print_compilation_warning;
231 
232   static Handle create_thread_oop(const char* name, TRAPS);
<a name="3" id="anc3"></a><span class="line-modified">233   static JavaThread* make_thread(jobject thread_oop, CompileQueue* queue, AbstractCompiler* comp, TRAPS);</span>
234   static void init_compiler_sweeper_threads();
<a name="4" id="anc4"></a><span class="line-modified">235   static void possibly_add_compiler_threads();</span>
<span class="line-removed">236   static bool compilation_is_complete  (const methodHandle&amp; method, int osr_bci, int comp_level);</span>
237   static bool compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded);
<a name="5" id="anc5"></a><span class="line-removed">238   static void preload_classes          (const methodHandle&amp; method, TRAPS);</span>
239 
240   static CompileTask* create_compile_task(CompileQueue*       queue,
241                                           int                 compile_id,
242                                           const methodHandle&amp; method,
243                                           int                 osr_bci,
244                                           int                 comp_level,
245                                           const methodHandle&amp; hot_method,
246                                           int                 hot_count,
247                                           CompileTask::CompileReason compile_reason,
248                                           bool                blocking);
249   static void wait_for_completion(CompileTask* task);
250 #if INCLUDE_JVMCI
251   static bool wait_for_jvmci_completion(JVMCICompiler* comp, CompileTask* task, JavaThread* thread);
252 #endif
253 
254   static void invoke_compiler_on_method(CompileTask* task);
255   static void post_compile(CompilerThread* thread, CompileTask* task, bool success, ciEnv* ci_env,
256                            int compilable, const char* failure_reason);
<a name="6" id="anc6"></a><span class="line-modified">257   static void set_last_compile(CompilerThread *thread, const methodHandle&amp; method, bool is_osr, int comp_level);</span>

258   static void push_jni_handle_block();
259   static void pop_jni_handle_block();
260   static void collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task);
261 
262   static void compile_method_base(const methodHandle&amp; method,
263                                   int osr_bci,
264                                   int comp_level,
265                                   const methodHandle&amp; hot_method,
266                                   int hot_count,
267                                   CompileTask::CompileReason compile_reason,
268                                   bool blocking,
269                                   Thread* thread);
270 
271   static CompileQueue* compile_queue(int comp_level);
272   static bool init_compiler_runtime();
273   static void shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread);
274 
275 public:
276 
277   static DirectivesStack* dirstack();
278   static void set_dirstack(DirectivesStack* stack);
279 
280   enum {
281     // The entry bci used for non-OSR compilations.
282     standard_entry_bci = InvocationEntryBci
283   };
284 
285   static AbstractCompiler* compiler(int comp_level) {
286     if (is_c2_compile(comp_level)) return _compilers[1]; // C2
287     if (is_c1_compile(comp_level)) return _compilers[0]; // C1
288     return NULL;
289   }
290 
<a name="7" id="anc7"></a>
291   static bool compilation_is_in_queue(const methodHandle&amp; method);
292   static void print_compile_queues(outputStream* st);
293   static void print_directives(outputStream* st);
294   static int queue_size(int comp_level) {
295     CompileQueue *q = compile_queue(comp_level);
296     return q != NULL ? q-&gt;size() : 0;
297   }
<a name="8" id="anc8"></a><span class="line-modified">298   static void compilation_init_phase1(TRAPS);</span>
299   static void compilation_init_phase2();
300   static void init_compiler_thread_log();
301   static nmethod* compile_method(const methodHandle&amp; method,
302                                  int osr_bci,
303                                  int comp_level,
304                                  const methodHandle&amp; hot_method,
305                                  int hot_count,
306                                  CompileTask::CompileReason compile_reason,
307                                  Thread* thread);
308 
309   static nmethod* compile_method(const methodHandle&amp; method,
310                                    int osr_bci,
311                                    int comp_level,
312                                    const methodHandle&amp; hot_method,
313                                    int hot_count,
314                                    CompileTask::CompileReason compile_reason,
315                                    DirectiveSet* directive,
316                                    Thread* thread);
317 
318   // Acquire any needed locks and assign a compile id
319   static uint assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci);
320 
321   static void compiler_thread_loop();
322   static uint get_compilation_id() { return _compilation_id; }
323 
324   // Set _should_block.
325   // Call this from the VM, with Threads_lock held and a safepoint requested.
326   static void set_should_block();
327 
328   // Call this from the compiler at convenient points, to poll for _should_block.
329   static void maybe_block();
330 
331   enum CompilerActivity {
332     // Flags for toggling compiler activity
333     stop_compilation     = 0,
334     run_compilation      = 1,
335     shutdown_compilation = 2
336   };
337 
338   static jint get_compilation_activity_mode() { return _should_compile_new_jobs; }
339   static bool should_compile_new_jobs() { return UseCompiler &amp;&amp; (_should_compile_new_jobs == run_compilation); }
340   static bool set_should_compile_new_jobs(jint new_state) {
341     // Return success if the current caller set it
<a name="9" id="anc9"></a><span class="line-modified">342     jint old = Atomic::cmpxchg(new_state, &amp;_should_compile_new_jobs, 1-new_state);</span>
343     bool success = (old == (1-new_state));
344     if (success) {
345       if (new_state == run_compilation) {
346         _total_compiler_restarted_count++;
347       } else {
348         _total_compiler_stopped_count++;
349       }
350     }
351     return success;
352   }
353 
354   static void disable_compilation_forever() {
355     UseCompiler               = false;
356     AlwaysCompileLoopMethods  = false;
<a name="10" id="anc10"></a><span class="line-modified">357     Atomic::xchg(jint(shutdown_compilation), &amp;_should_compile_new_jobs);</span>
358   }
359 
360   static bool is_compilation_disabled_forever() {
361     return _should_compile_new_jobs == shutdown_compilation;
362   }
363   static void handle_full_code_cache(int code_blob_type);
364   // Ensures that warning is only printed once.
365   static bool should_print_compiler_warning() {
<a name="11" id="anc11"></a><span class="line-modified">366     jint old = Atomic::cmpxchg(1, &amp;_print_compilation_warning, 0);</span>
367     return old == 0;
368   }
369   // Return total compilation ticks
370   static jlong total_compilation_ticks() {
371     return _perf_total_compilation != NULL ? _perf_total_compilation-&gt;get_value() : 0;
372   }
373 
374   // Redefine Classes support
375   static void mark_on_stack();
376 
377 #if INCLUDE_JVMCI
378   // Print curent compilation time stats for a given compiler
379   static void print_times(AbstractCompiler* comp);
380 #endif
381 
382   // Print a detailed accounting of compilation time
383   static void print_times(bool per_compiler = true, bool aggregate = true);
384 
<a name="12" id="anc12"></a><span class="line-removed">385   // Debugging output for failure</span>
<span class="line-removed">386   static void print_last_compile();</span>
<span class="line-removed">387 </span>
388   // compiler name for debugging
389   static const char* compiler_name(int comp_level);
390 
391   // Provide access to compiler thread Java objects
392   static jobject compiler1_object(int idx) {
393     assert(_compiler1_objects != NULL, &quot;must be initialized&quot;);
394     assert(idx &lt; _c1_count, &quot;oob&quot;);
395     return _compiler1_objects[idx];
396   }
397 
398   static jobject compiler2_object(int idx) {
399     assert(_compiler2_objects != NULL, &quot;must be initialized&quot;);
400     assert(idx &lt; _c2_count, &quot;oob&quot;);
401     return _compiler2_objects[idx];
402   }
403 
<a name="13" id="anc13"></a>

404   static CompileLog* get_log(CompilerThread* ct);
405 
406   static int get_total_compile_count() {            return _total_compile_count; }
407   static int get_total_bailout_count() {            return _total_bailout_count; }
408   static int get_total_invalidated_count() {        return _total_invalidated_count; }
409   static int get_total_native_compile_count() {     return _total_native_compile_count; }
410   static int get_total_osr_compile_count() {        return _total_osr_compile_count; }
411   static int get_total_standard_compile_count() {   return _total_standard_compile_count; }
412   static int get_total_compiler_stopped_count() {   return _total_compiler_stopped_count; }
413   static int get_total_compiler_restarted_count() { return _total_compiler_restarted_count; }
414   static int get_sum_osr_bytes_compiled() {         return _sum_osr_bytes_compiled; }
415   static int get_sum_standard_bytes_compiled() {    return _sum_standard_bytes_compiled; }
416   static int get_sum_nmethod_size() {               return _sum_nmethod_size;}
417   static int get_sum_nmethod_code_size() {          return _sum_nmethod_code_size; }
418   static long get_peak_compilation_time() {         return _peak_compilation_time; }
419   static long get_total_compilation_time() {        return _t_total_compilation.milliseconds(); }
420 
421   // Log that compilation profiling is skipped because metaspace is full.
422   static void log_metaspace_failure();
423 
424   // CodeHeap State Analytics.
425   static void print_info(outputStream *out);
<a name="14" id="anc14"></a><span class="line-modified">426   static void print_heapinfo(outputStream *out, const char* function, const char* granularity );</span>
427 };
428 
429 #endif // SHARE_COMPILER_COMPILEBROKER_HPP
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>