<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/compiler/compileTask.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="compileBroker.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="compileTask.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/compiler/compileTask.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
180   _code_handle-&gt;set_code(nm);
181   if (nm == NULL)  _code_handle = NULL;  // drop the handle also
182 }
183 
184 void CompileTask::mark_on_stack() {
185   if (is_unloaded()) {
186     return;
187   }
188   // Mark these methods as something redefine classes cannot remove.
189   _method-&gt;set_on_stack(true);
190   if (_hot_method != NULL) {
191     _hot_method-&gt;set_on_stack(true);
192   }
193 }
194 
195 bool CompileTask::is_unloaded() const {
196   return _method_holder != NULL &amp;&amp; JNIHandles::is_weak_global_handle(_method_holder) &amp;&amp; JNIHandles::is_global_weak_cleared(_method_holder);
197 }
198 
199 // RedefineClasses support
<span class="line-modified">200 void CompileTask::metadata_do(void f(Metadata*)) {</span>
201   if (is_unloaded()) {
202     return;
203   }
<span class="line-modified">204   f(method());</span>
205   if (hot_method() != NULL &amp;&amp; hot_method() != method()) {
<span class="line-modified">206     f(hot_method());</span>
207   }
208 }
209 
210 // ------------------------------------------------------------------
211 // CompileTask::print_line_on_error
212 //
213 // This function is called by fatal error handler when the thread
214 // causing troubles is a compiler thread.
215 //
216 // Do not grab any lock, do not allocate memory.
217 //
218 // Otherwise it&#39;s the same as CompileTask::print_line()
219 //
220 void CompileTask::print_line_on_error(outputStream* st, char* buf, int buflen) {
221   // print compiler name
222   st-&gt;print(&quot;%s:&quot;, CompileBroker::compiler_name(comp_level()));
223   print(st);
224 }
225 
226 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
323 
324 // ------------------------------------------------------------------
325 // CompileTask::print_compilation
326 void CompileTask::print(outputStream* st, const char* msg, bool short_form, bool cr) {
327   bool is_osr_method = osr_bci() != InvocationEntryBci;
328   print_impl(st, is_unloaded() ? NULL : method(), compile_id(), comp_level(), is_osr_method, osr_bci(), is_blocking(), msg, short_form, cr, _time_queued, _time_started);
329 }
330 
331 // ------------------------------------------------------------------
332 // CompileTask::log_task
333 void CompileTask::log_task(xmlStream* log) {
334   Thread* thread = Thread::current();
335   methodHandle method(thread, this-&gt;method());
336   ResourceMark rm(thread);
337 
338   // &lt;task id=&#39;9&#39; method=&#39;M&#39; osr_bci=&#39;X&#39; level=&#39;1&#39; blocking=&#39;1&#39; stamp=&#39;1.234&#39;&gt;
339   log-&gt;print(&quot; compile_id=&#39;%d&#39;&quot;, _compile_id);
340   if (_osr_bci != CompileBroker::standard_entry_bci) {
341     log-&gt;print(&quot; compile_kind=&#39;osr&#39;&quot;);  // same as nmethod::compile_kind
342   } // else compile_kind=&#39;c2c&#39;
<span class="line-modified">343   if (!method.is_null())  log-&gt;method(method);</span>
344   if (_osr_bci != CompileBroker::standard_entry_bci) {
345     log-&gt;print(&quot; osr_bci=&#39;%d&#39;&quot;, _osr_bci);
346   }
347   if (_comp_level != CompLevel_highest_tier) {
348     log-&gt;print(&quot; level=&#39;%d&#39;&quot;, _comp_level);
349   }
350   if (_is_blocking) {
351     log-&gt;print(&quot; blocking=&#39;1&#39;&quot;);
352   }
353   log-&gt;stamp();
354 }
355 
356 // ------------------------------------------------------------------
357 // CompileTask::log_task_queued
358 void CompileTask::log_task_queued() {
<span class="line-removed">359   Thread* thread = Thread::current();</span>
360   ttyLocker ttyl;
<span class="line-modified">361   ResourceMark rm(thread);</span>
362 
363   xtty-&gt;begin_elem(&quot;task_queued&quot;);
364   log_task(xtty);
365   assert(_compile_reason &gt; CompileTask::Reason_None &amp;&amp; _compile_reason &lt; CompileTask::Reason_Count, &quot;Valid values&quot;);
366   xtty-&gt;print(&quot; comment=&#39;%s&#39;&quot;, reason_name(_compile_reason));
367 
<span class="line-modified">368   if (_hot_method != NULL) {</span>
<span class="line-modified">369     methodHandle hot(thread, _hot_method);</span>
<span class="line-removed">370     methodHandle method(thread, _method);</span>
<span class="line-removed">371     if (hot() != method()) {</span>
<span class="line-removed">372       xtty-&gt;method(hot);</span>
<span class="line-removed">373     }</span>
374   }
375   if (_hot_count != 0) {
376     xtty-&gt;print(&quot; hot_count=&#39;%d&#39;&quot;, _hot_count);
377   }
378   xtty-&gt;end_elem();
379 }
380 
381 
382 // ------------------------------------------------------------------
383 // CompileTask::log_task_start
384 void CompileTask::log_task_start(CompileLog* log)   {
385   log-&gt;begin_head(&quot;task&quot;);
386   log_task(log);
387   log-&gt;end_head();
388 }
389 
390 
391 // ------------------------------------------------------------------
392 // CompileTask::log_task_done
393 void CompileTask::log_task_done(CompileLog* log) {
394   Thread* thread = Thread::current();
395   methodHandle method(thread, this-&gt;method());
396   ResourceMark rm(thread);
397 
398   if (!_is_success) {

399     const char* reason = _failure_reason != NULL ? _failure_reason : &quot;unknown&quot;;
400     log-&gt;elem(&quot;failure reason=&#39;%s&#39;&quot;, reason);
401   }
402 
403   // &lt;task_done ... stamp=&#39;1.234&#39;&gt;  &lt;/task&gt;
404   nmethod* nm = code();
405   log-&gt;begin_elem(&quot;task_done success=&#39;%d&#39; nmsize=&#39;%d&#39; count=&#39;%d&#39;&quot;,
406                   _is_success, nm == NULL ? 0 : nm-&gt;content_size(),
407                   method-&gt;invocation_count());
408   int bec = method-&gt;backedge_count();
409   if (bec != 0)  log-&gt;print(&quot; backedge_count=&#39;%d&#39;&quot;, bec);
410   // Note:  &quot;_is_complete&quot; is about to be set, but is not.
411   if (_num_inlined_bytecodes != 0) {
412     log-&gt;print(&quot; inlined_bytes=&#39;%d&#39;&quot;, _num_inlined_bytecodes);
413   }
414   log-&gt;stamp();
415   log-&gt;end_elem();
416   log-&gt;clear_identities();   // next task will have different CI
417   log-&gt;tail(&quot;task&quot;);
<span class="line-modified">418   if (log-&gt;unflushed_count() &gt; 2000) {</span>
<span class="line-removed">419     log-&gt;flush();</span>
<span class="line-removed">420   }</span>
421   log-&gt;mark_file_end();
422 }
423 
424 // ------------------------------------------------------------------
425 // CompileTask::check_break_at_flags
426 bool CompileTask::check_break_at_flags() {
427   int compile_id = this-&gt;_compile_id;
428   bool is_osr = (_osr_bci != CompileBroker::standard_entry_bci);
429 
430   if (CICountOSR &amp;&amp; is_osr &amp;&amp; (compile_id == CIBreakAtOSR)) {
431     return true;
432   } else {
433     return (compile_id == CIBreakAt);
434   }
435 }
436 
437 // ------------------------------------------------------------------
438 // CompileTask::print_inlining
439 void CompileTask::print_inlining_inner(outputStream* st, ciMethod* method, int inline_level, int bci, const char* msg) {
440   //         1234567
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
180   _code_handle-&gt;set_code(nm);
181   if (nm == NULL)  _code_handle = NULL;  // drop the handle also
182 }
183 
184 void CompileTask::mark_on_stack() {
185   if (is_unloaded()) {
186     return;
187   }
188   // Mark these methods as something redefine classes cannot remove.
189   _method-&gt;set_on_stack(true);
190   if (_hot_method != NULL) {
191     _hot_method-&gt;set_on_stack(true);
192   }
193 }
194 
195 bool CompileTask::is_unloaded() const {
196   return _method_holder != NULL &amp;&amp; JNIHandles::is_weak_global_handle(_method_holder) &amp;&amp; JNIHandles::is_global_weak_cleared(_method_holder);
197 }
198 
199 // RedefineClasses support
<span class="line-modified">200 void CompileTask::metadata_do(MetadataClosure* f) {</span>
201   if (is_unloaded()) {
202     return;
203   }
<span class="line-modified">204   f-&gt;do_metadata(method());</span>
205   if (hot_method() != NULL &amp;&amp; hot_method() != method()) {
<span class="line-modified">206     f-&gt;do_metadata(hot_method());</span>
207   }
208 }
209 
210 // ------------------------------------------------------------------
211 // CompileTask::print_line_on_error
212 //
213 // This function is called by fatal error handler when the thread
214 // causing troubles is a compiler thread.
215 //
216 // Do not grab any lock, do not allocate memory.
217 //
218 // Otherwise it&#39;s the same as CompileTask::print_line()
219 //
220 void CompileTask::print_line_on_error(outputStream* st, char* buf, int buflen) {
221   // print compiler name
222   st-&gt;print(&quot;%s:&quot;, CompileBroker::compiler_name(comp_level()));
223   print(st);
224 }
225 
226 // ------------------------------------------------------------------
</pre>
<hr />
<pre>
323 
324 // ------------------------------------------------------------------
325 // CompileTask::print_compilation
326 void CompileTask::print(outputStream* st, const char* msg, bool short_form, bool cr) {
327   bool is_osr_method = osr_bci() != InvocationEntryBci;
328   print_impl(st, is_unloaded() ? NULL : method(), compile_id(), comp_level(), is_osr_method, osr_bci(), is_blocking(), msg, short_form, cr, _time_queued, _time_started);
329 }
330 
331 // ------------------------------------------------------------------
332 // CompileTask::log_task
333 void CompileTask::log_task(xmlStream* log) {
334   Thread* thread = Thread::current();
335   methodHandle method(thread, this-&gt;method());
336   ResourceMark rm(thread);
337 
338   // &lt;task id=&#39;9&#39; method=&#39;M&#39; osr_bci=&#39;X&#39; level=&#39;1&#39; blocking=&#39;1&#39; stamp=&#39;1.234&#39;&gt;
339   log-&gt;print(&quot; compile_id=&#39;%d&#39;&quot;, _compile_id);
340   if (_osr_bci != CompileBroker::standard_entry_bci) {
341     log-&gt;print(&quot; compile_kind=&#39;osr&#39;&quot;);  // same as nmethod::compile_kind
342   } // else compile_kind=&#39;c2c&#39;
<span class="line-modified">343   if (!method.is_null())  log-&gt;method(method());</span>
344   if (_osr_bci != CompileBroker::standard_entry_bci) {
345     log-&gt;print(&quot; osr_bci=&#39;%d&#39;&quot;, _osr_bci);
346   }
347   if (_comp_level != CompLevel_highest_tier) {
348     log-&gt;print(&quot; level=&#39;%d&#39;&quot;, _comp_level);
349   }
350   if (_is_blocking) {
351     log-&gt;print(&quot; blocking=&#39;1&#39;&quot;);
352   }
353   log-&gt;stamp();
354 }
355 
356 // ------------------------------------------------------------------
357 // CompileTask::log_task_queued
358 void CompileTask::log_task_queued() {

359   ttyLocker ttyl;
<span class="line-modified">360   ResourceMark rm;</span>
361 
362   xtty-&gt;begin_elem(&quot;task_queued&quot;);
363   log_task(xtty);
364   assert(_compile_reason &gt; CompileTask::Reason_None &amp;&amp; _compile_reason &lt; CompileTask::Reason_Count, &quot;Valid values&quot;);
365   xtty-&gt;print(&quot; comment=&#39;%s&#39;&quot;, reason_name(_compile_reason));
366 
<span class="line-modified">367   if (_hot_method != NULL &amp;&amp; _hot_method != _method) {</span>
<span class="line-modified">368     xtty-&gt;method(_hot_method);</span>




369   }
370   if (_hot_count != 0) {
371     xtty-&gt;print(&quot; hot_count=&#39;%d&#39;&quot;, _hot_count);
372   }
373   xtty-&gt;end_elem();
374 }
375 
376 
377 // ------------------------------------------------------------------
378 // CompileTask::log_task_start
379 void CompileTask::log_task_start(CompileLog* log)   {
380   log-&gt;begin_head(&quot;task&quot;);
381   log_task(log);
382   log-&gt;end_head();
383 }
384 
385 
386 // ------------------------------------------------------------------
387 // CompileTask::log_task_done
388 void CompileTask::log_task_done(CompileLog* log) {
389   Thread* thread = Thread::current();
390   methodHandle method(thread, this-&gt;method());
391   ResourceMark rm(thread);
392 
393   if (!_is_success) {
<span class="line-added">394     assert(_failure_reason != NULL, &quot;missing&quot;);</span>
395     const char* reason = _failure_reason != NULL ? _failure_reason : &quot;unknown&quot;;
396     log-&gt;elem(&quot;failure reason=&#39;%s&#39;&quot;, reason);
397   }
398 
399   // &lt;task_done ... stamp=&#39;1.234&#39;&gt;  &lt;/task&gt;
400   nmethod* nm = code();
401   log-&gt;begin_elem(&quot;task_done success=&#39;%d&#39; nmsize=&#39;%d&#39; count=&#39;%d&#39;&quot;,
402                   _is_success, nm == NULL ? 0 : nm-&gt;content_size(),
403                   method-&gt;invocation_count());
404   int bec = method-&gt;backedge_count();
405   if (bec != 0)  log-&gt;print(&quot; backedge_count=&#39;%d&#39;&quot;, bec);
406   // Note:  &quot;_is_complete&quot; is about to be set, but is not.
407   if (_num_inlined_bytecodes != 0) {
408     log-&gt;print(&quot; inlined_bytes=&#39;%d&#39;&quot;, _num_inlined_bytecodes);
409   }
410   log-&gt;stamp();
411   log-&gt;end_elem();
412   log-&gt;clear_identities();   // next task will have different CI
413   log-&gt;tail(&quot;task&quot;);
<span class="line-modified">414   log-&gt;flush();</span>


415   log-&gt;mark_file_end();
416 }
417 
418 // ------------------------------------------------------------------
419 // CompileTask::check_break_at_flags
420 bool CompileTask::check_break_at_flags() {
421   int compile_id = this-&gt;_compile_id;
422   bool is_osr = (_osr_bci != CompileBroker::standard_entry_bci);
423 
424   if (CICountOSR &amp;&amp; is_osr &amp;&amp; (compile_id == CIBreakAtOSR)) {
425     return true;
426   } else {
427     return (compile_id == CIBreakAt);
428   }
429 }
430 
431 // ------------------------------------------------------------------
432 // CompileTask::print_inlining
433 void CompileTask::print_inlining_inner(outputStream* st, ciMethod* method, int inline_level, int bci, const char* msg) {
434   //         1234567
</pre>
</td>
</tr>
</table>
<center><a href="compileBroker.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="compileTask.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>