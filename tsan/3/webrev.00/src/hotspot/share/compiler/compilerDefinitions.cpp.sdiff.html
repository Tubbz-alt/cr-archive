<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/compiler/compilerDefinitions.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="compileTask.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="compilerDefinitions.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/compiler/compilerDefinitions.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;code/codeCache.hpp&quot;
 27 #include &quot;runtime/globals.hpp&quot;
 28 #include &quot;runtime/globals_extension.hpp&quot;
 29 #include &quot;compiler/compilerDefinitions.hpp&quot;
 30 #include &quot;gc/shared/gcConfig.hpp&quot;
 31 #include &quot;utilities/defaultStream.hpp&quot;
 32 
 33 const char* compilertype2name_tab[compiler_number_of_types] = {
 34   &quot;&quot;,
 35   &quot;c1&quot;,
 36   &quot;c2&quot;,
 37   &quot;jvmci&quot;
 38 };
 39 


























 40 #if defined(COMPILER2)
 41 CompLevel  CompLevel_highest_tier      = CompLevel_full_optimization;  // pure C2 and tiered or JVMCI and tiered
 42 #elif defined(COMPILER1)
 43 CompLevel  CompLevel_highest_tier      = CompLevel_simple;             // pure C1 or JVMCI
 44 #else
 45 CompLevel  CompLevel_highest_tier      = CompLevel_none;
 46 #endif
 47 
<span class="line-removed"> 48 #if defined(TIERED)</span>
<span class="line-removed"> 49 CompLevel  CompLevel_initial_compile   = CompLevel_full_profile;        // tiered</span>
<span class="line-removed"> 50 #elif defined(COMPILER1) || INCLUDE_JVMCI</span>
<span class="line-removed"> 51 CompLevel  CompLevel_initial_compile   = CompLevel_simple;              // pure C1 or JVMCI</span>
<span class="line-removed"> 52 #elif defined(COMPILER2)</span>
<span class="line-removed"> 53 CompLevel  CompLevel_initial_compile   = CompLevel_full_optimization;   // pure C2</span>
<span class="line-removed"> 54 #else</span>
<span class="line-removed"> 55 CompLevel  CompLevel_initial_compile   = CompLevel_none;</span>
<span class="line-removed"> 56 #endif</span>
<span class="line-removed"> 57 </span>
 58 #if defined(COMPILER2)
 59 CompMode  Compilation_mode             = CompMode_server;
 60 #elif defined(COMPILER1)
 61 CompMode  Compilation_mode             = CompMode_client;
 62 #else
 63 CompMode  Compilation_mode             = CompMode_none;
 64 #endif
 65 
 66 // Returns threshold scaled with CompileThresholdScaling
 67 intx CompilerConfig::scaled_compile_threshold(intx threshold) {
 68   return scaled_compile_threshold(threshold, CompileThresholdScaling);
 69 }
 70 
 71 // Returns freq_log scaled with CompileThresholdScaling
 72 intx CompilerConfig::scaled_freq_log(intx freq_log) {
 73   return scaled_freq_log(freq_log, CompileThresholdScaling);
 74 }
 75 
 76 // Returns threshold scaled with the value of scale.
 77 // If scale &lt; 0.0, threshold is returned without scaling.
</pre>
<hr />
<pre>
 99   // The largest mask value that the interpreter/C1 can handle is
100   // of length InvocationCounter::number_of_count_bits. Mask values are always
101   // one bit shorter then the value of the notification frequency. Set
102   // max_freq_bits accordingly.
103   intx max_freq_bits = InvocationCounter::number_of_count_bits + 1;
104   intx scaled_freq = scaled_compile_threshold((intx)1 &lt;&lt; freq_log, scale);
105   if (scaled_freq == 0) {
106     // Return 0 right away to avoid calculating log2 of 0.
107     return 0;
108   } else if (scaled_freq &gt; nth_bit(max_freq_bits)) {
109     return max_freq_bits;
110   } else {
111     return log2_intptr(scaled_freq);
112   }
113 }
114 
115 #ifdef TIERED
116 void set_client_compilation_mode() {
117   Compilation_mode = CompMode_client;
118   CompLevel_highest_tier = CompLevel_simple;
<span class="line-modified">119   CompLevel_initial_compile = CompLevel_simple;</span>
<span class="line-modified">120   FLAG_SET_ERGO(bool, TieredCompilation, false);</span>
<span class="line-removed">121   FLAG_SET_ERGO(bool, ProfileInterpreter, false);</span>
122 #if INCLUDE_JVMCI
<span class="line-modified">123   FLAG_SET_ERGO(bool, EnableJVMCI, false);</span>
<span class="line-modified">124   FLAG_SET_ERGO(bool, UseJVMCICompiler, false);</span>
125 #endif
126 #if INCLUDE_AOT
<span class="line-modified">127   FLAG_SET_ERGO(bool, UseAOT, false);</span>
128 #endif
129   if (FLAG_IS_DEFAULT(NeverActAsServerClassMachine)) {
<span class="line-modified">130     FLAG_SET_ERGO(bool, NeverActAsServerClassMachine, true);</span>
131   }
132   if (FLAG_IS_DEFAULT(InitialCodeCacheSize)) {
<span class="line-modified">133     FLAG_SET_ERGO(uintx, InitialCodeCacheSize, 160*K);</span>
134   }
135   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
<span class="line-modified">136     FLAG_SET_ERGO(uintx, ReservedCodeCacheSize, 32*M);</span>
137   }
138   if (FLAG_IS_DEFAULT(NonProfiledCodeHeapSize)) {
<span class="line-modified">139     FLAG_SET_ERGO(uintx, NonProfiledCodeHeapSize, 27*M);</span>
140   }
141   if (FLAG_IS_DEFAULT(ProfiledCodeHeapSize)) {
<span class="line-modified">142     FLAG_SET_ERGO(uintx, ProfiledCodeHeapSize, 0);</span>
143   }
144   if (FLAG_IS_DEFAULT(NonNMethodCodeHeapSize)) {
<span class="line-modified">145     FLAG_SET_ERGO(uintx, NonNMethodCodeHeapSize, 5*M);</span>
146   }
147   if (FLAG_IS_DEFAULT(CodeCacheExpansionSize)) {
<span class="line-modified">148     FLAG_SET_ERGO(uintx, CodeCacheExpansionSize, 32*K);</span>
149   }
150   if (FLAG_IS_DEFAULT(MetaspaceSize)) {
<span class="line-modified">151     FLAG_SET_ERGO(size_t, MetaspaceSize, MIN2(12*M, MaxMetaspaceSize));</span>
152   }
153   if (FLAG_IS_DEFAULT(MaxRAM)) {
154     // Do not use FLAG_SET_ERGO to update MaxRAM, as this will impact
155     // heap setting done based on available phys_mem (see Arguments::set_heap_size).
156     FLAG_SET_DEFAULT(MaxRAM, 1ULL*G);
157   }
158   if (FLAG_IS_DEFAULT(CompileThreshold)) {
<span class="line-modified">159     FLAG_SET_ERGO(intx, CompileThreshold, 1500);</span>
160   }
161   if (FLAG_IS_DEFAULT(OnStackReplacePercentage)) {
<span class="line-modified">162     FLAG_SET_ERGO(intx, OnStackReplacePercentage, 933);</span>
163   }
164   if (FLAG_IS_DEFAULT(CICompilerCount)) {
<span class="line-modified">165     FLAG_SET_ERGO(intx, CICompilerCount, 1);</span>
166   }
167 }
168 
169 bool compilation_mode_selected() {
170   return !FLAG_IS_DEFAULT(TieredCompilation) ||
171          !FLAG_IS_DEFAULT(TieredStopAtLevel) ||
172          !FLAG_IS_DEFAULT(UseAOT)
173          JVMCI_ONLY(|| !FLAG_IS_DEFAULT(EnableJVMCI)
174                     || !FLAG_IS_DEFAULT(UseJVMCICompiler));
175 }
176 
177 void select_compilation_mode_ergonomically() {
178 #if defined(_WINDOWS) &amp;&amp; !defined(_LP64)
179   if (FLAG_IS_DEFAULT(NeverActAsServerClassMachine)) {
<span class="line-modified">180     FLAG_SET_ERGO(bool, NeverActAsServerClassMachine, true);</span>
181   }
182 #endif
183   if (NeverActAsServerClassMachine) {
184     set_client_compilation_mode();
185   }
186 }
187 
<span class="line-removed">188 #endif // TIERED</span>
189 
190 void CompilerConfig::set_tiered_flags() {
<span class="line-removed">191   // With tiered, set default policy to SimpleThresholdPolicy, which is 2.</span>
<span class="line-removed">192   if (FLAG_IS_DEFAULT(CompilationPolicyChoice)) {</span>
<span class="line-removed">193     FLAG_SET_DEFAULT(CompilationPolicyChoice, 2);</span>
<span class="line-removed">194   }</span>
<span class="line-removed">195   if (CompilationPolicyChoice &lt; 2) {</span>
<span class="line-removed">196     vm_exit_during_initialization(</span>
<span class="line-removed">197       &quot;Incompatible compilation policy selected&quot;, NULL);</span>
<span class="line-removed">198   }</span>
199   // Increase the code cache size - tiered compiles a lot more.
200   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
<span class="line-modified">201     FLAG_SET_ERGO(uintx, ReservedCodeCacheSize,</span>
202                   MIN2(CODE_CACHE_DEFAULT_LIMIT, (size_t)ReservedCodeCacheSize * 5));
203   }
204   // Enable SegmentedCodeCache if TieredCompilation is enabled, ReservedCodeCacheSize &gt;= 240M
205   // and the code cache contains at least 8 pages (segmentation disables advantage of huge pages).
206   if (FLAG_IS_DEFAULT(SegmentedCodeCache) &amp;&amp; ReservedCodeCacheSize &gt;= 240*M &amp;&amp;
207       8 * CodeCache::page_size() &lt;= ReservedCodeCacheSize) {
<span class="line-modified">208     FLAG_SET_ERGO(bool, SegmentedCodeCache, true);</span>
209   }
210   if (!UseInterpreter) { // -Xcomp
211     Tier3InvokeNotifyFreqLog = 0;
212     Tier4InvocationThreshold = 0;
213   }
214 
215   if (CompileThresholdScaling &lt; 0) {
216     vm_exit_during_initialization(&quot;Negative value specified for CompileThresholdScaling&quot;, NULL);
217   }
218 






219   // Scale tiered compilation thresholds.
220   // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves compilation thresholds unchanged.
221   if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
<span class="line-modified">222     FLAG_SET_ERGO(intx, Tier0InvokeNotifyFreqLog, scaled_freq_log(Tier0InvokeNotifyFreqLog));</span>
<span class="line-modified">223     FLAG_SET_ERGO(intx, Tier0BackedgeNotifyFreqLog, scaled_freq_log(Tier0BackedgeNotifyFreqLog));</span>
224 
<span class="line-modified">225     FLAG_SET_ERGO(intx, Tier3InvocationThreshold, scaled_compile_threshold(Tier3InvocationThreshold));</span>
<span class="line-modified">226     FLAG_SET_ERGO(intx, Tier3MinInvocationThreshold, scaled_compile_threshold(Tier3MinInvocationThreshold));</span>
<span class="line-modified">227     FLAG_SET_ERGO(intx, Tier3CompileThreshold, scaled_compile_threshold(Tier3CompileThreshold));</span>
<span class="line-modified">228     FLAG_SET_ERGO(intx, Tier3BackEdgeThreshold, scaled_compile_threshold(Tier3BackEdgeThreshold));</span>
229 
230     // Tier2{Invocation,MinInvocation,Compile,Backedge}Threshold should be scaled here
231     // once these thresholds become supported.
232 
<span class="line-modified">233     FLAG_SET_ERGO(intx, Tier2InvokeNotifyFreqLog, scaled_freq_log(Tier2InvokeNotifyFreqLog));</span>
<span class="line-modified">234     FLAG_SET_ERGO(intx, Tier2BackedgeNotifyFreqLog, scaled_freq_log(Tier2BackedgeNotifyFreqLog));</span>



235 
<span class="line-modified">236     FLAG_SET_ERGO(intx, Tier3InvokeNotifyFreqLog, scaled_freq_log(Tier3InvokeNotifyFreqLog));</span>
<span class="line-removed">237     FLAG_SET_ERGO(intx, Tier3BackedgeNotifyFreqLog, scaled_freq_log(Tier3BackedgeNotifyFreqLog));</span>
238 
<span class="line-modified">239     FLAG_SET_ERGO(intx, Tier23InlineeNotifyFreqLog, scaled_freq_log(Tier23InlineeNotifyFreqLog));</span>



240 
<span class="line-modified">241     FLAG_SET_ERGO(intx, Tier4InvocationThreshold, scaled_compile_threshold(Tier4InvocationThreshold));</span>
<span class="line-modified">242     FLAG_SET_ERGO(intx, Tier4MinInvocationThreshold, scaled_compile_threshold(Tier4MinInvocationThreshold));</span>
<span class="line-modified">243     FLAG_SET_ERGO(intx, Tier4CompileThreshold, scaled_compile_threshold(Tier4CompileThreshold));</span>
<span class="line-modified">244     FLAG_SET_ERGO(intx, Tier4BackEdgeThreshold, scaled_compile_threshold(Tier4BackEdgeThreshold));</span>


















245   }
246 }
247 


248 #if INCLUDE_JVMCI
249 void set_jvmci_specific_flags() {
250   if (UseJVMCICompiler) {
251     Compilation_mode = CompMode_server;
252 
253     if (FLAG_IS_DEFAULT(TypeProfileWidth)) {
254       FLAG_SET_DEFAULT(TypeProfileWidth, 8);
255     }
<span class="line-removed">256     if (FLAG_IS_DEFAULT(OnStackReplacePercentage)) {</span>
<span class="line-removed">257       FLAG_SET_DEFAULT(OnStackReplacePercentage, 933);</span>
<span class="line-removed">258     }</span>
<span class="line-removed">259     // JVMCI needs values not less than defaults</span>
<span class="line-removed">260     if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {</span>
<span class="line-removed">261       FLAG_SET_DEFAULT(ReservedCodeCacheSize, MAX2(64*M, ReservedCodeCacheSize));</span>
<span class="line-removed">262     }</span>
<span class="line-removed">263     if (FLAG_IS_DEFAULT(InitialCodeCacheSize)) {</span>
<span class="line-removed">264       FLAG_SET_DEFAULT(InitialCodeCacheSize, MAX2(16*M, InitialCodeCacheSize));</span>
<span class="line-removed">265     }</span>
<span class="line-removed">266     if (FLAG_IS_DEFAULT(MetaspaceSize)) {</span>
<span class="line-removed">267       FLAG_SET_DEFAULT(MetaspaceSize, MIN2(MAX2(12*M, MetaspaceSize), MaxMetaspaceSize));</span>
<span class="line-removed">268     }</span>
<span class="line-removed">269     if (FLAG_IS_DEFAULT(NewSizeThreadIncrease)) {</span>
<span class="line-removed">270       FLAG_SET_DEFAULT(NewSizeThreadIncrease, MAX2(4*K, NewSizeThreadIncrease));</span>
<span class="line-removed">271     }</span>
<span class="line-removed">272     if (TieredStopAtLevel != CompLevel_full_optimization) {</span>
<span class="line-removed">273       // Currently JVMCI compiler can only work at the full optimization level</span>
<span class="line-removed">274       warning(&quot;forcing TieredStopAtLevel to full optimization because JVMCI is enabled&quot;);</span>
<span class="line-removed">275       FLAG_SET_ERGO(intx, TieredStopAtLevel, CompLevel_full_optimization);</span>
<span class="line-removed">276     }</span>
277     if (FLAG_IS_DEFAULT(TypeProfileLevel)) {
278       FLAG_SET_DEFAULT(TypeProfileLevel, 0);
279     }
<span class="line-modified">280   }</span>



















































281 }
282 #endif // INCLUDE_JVMCI
283 
284 bool CompilerConfig::check_args_consistency(bool status) {
285   // Check lower bounds of the code cache
286   // Template Interpreter code is approximately 3X larger in debug builds.
287   uint min_code_cache_size = CodeCacheMinimumUseSpace DEBUG_ONLY(* 3);
288   if (ReservedCodeCacheSize &lt; InitialCodeCacheSize) {
289     jio_fprintf(defaultStream::error_stream(),
290                 &quot;Invalid ReservedCodeCacheSize: %dK. Must be at least InitialCodeCacheSize=%dK.\n&quot;,
291                 ReservedCodeCacheSize/K, InitialCodeCacheSize/K);
292     status = false;
293   } else if (ReservedCodeCacheSize &lt; min_code_cache_size) {
294     jio_fprintf(defaultStream::error_stream(),
295                 &quot;Invalid ReservedCodeCacheSize=%dK. Must be at least %uK.\n&quot;, ReservedCodeCacheSize/K,
296                 min_code_cache_size/K);
297     status = false;
298   } else if (ReservedCodeCacheSize &gt; CODE_CACHE_SIZE_LIMIT) {
299     // Code cache size larger than CODE_CACHE_SIZE_LIMIT is not supported.
300     jio_fprintf(defaultStream::error_stream(),
301                 &quot;Invalid ReservedCodeCacheSize=%dM. Must be at most %uM.\n&quot;, ReservedCodeCacheSize/M,
302                 CODE_CACHE_SIZE_LIMIT/M);
303     status = false;
304   } else if (NonNMethodCodeHeapSize &lt; min_code_cache_size) {
305     jio_fprintf(defaultStream::error_stream(),
306                 &quot;Invalid NonNMethodCodeHeapSize=%dK. Must be at least %uK.\n&quot;, NonNMethodCodeHeapSize/K,
307                 min_code_cache_size/K);
308     status = false;
309   }
310 
311 #ifdef _LP64
312   if (!FLAG_IS_DEFAULT(CICompilerCount) &amp;&amp; !FLAG_IS_DEFAULT(CICompilerCountPerCPU) &amp;&amp; CICompilerCountPerCPU) {
313     warning(&quot;The VM option CICompilerCountPerCPU overrides CICompilerCount.&quot;);
314   }
315 #endif
316 
317   if (BackgroundCompilation &amp;&amp; ReplayCompiles) {
318     if (!FLAG_IS_DEFAULT(BackgroundCompilation)) {
319       warning(&quot;BackgroundCompilation disabled due to ReplayCompiles option.&quot;);
320     }
<span class="line-modified">321     FLAG_SET_CMDLINE(bool, BackgroundCompilation, false);</span>
322   }
323 
324 #ifdef COMPILER2
325   if (PostLoopMultiversioning &amp;&amp; !RangeCheckElimination) {
326     if (!FLAG_IS_DEFAULT(PostLoopMultiversioning)) {
327       warning(&quot;PostLoopMultiversioning disabled because RangeCheckElimination is disabled.&quot;);
328     }
<span class="line-modified">329     FLAG_SET_CMDLINE(bool, PostLoopMultiversioning, false);</span>
330   }
331   if (UseCountedLoopSafepoints &amp;&amp; LoopStripMiningIter == 0) {
332     if (!FLAG_IS_DEFAULT(UseCountedLoopSafepoints) || !FLAG_IS_DEFAULT(LoopStripMiningIter)) {
333       warning(&quot;When counted loop safepoints are enabled, LoopStripMiningIter must be at least 1 (a safepoint every 1 iteration): setting it to 1&quot;);
334     }
335     LoopStripMiningIter = 1;
336   } else if (!UseCountedLoopSafepoints &amp;&amp; LoopStripMiningIter &gt; 0) {
337     if (!FLAG_IS_DEFAULT(UseCountedLoopSafepoints) || !FLAG_IS_DEFAULT(LoopStripMiningIter)) {
338       warning(&quot;Disabling counted safepoints implies no loop strip mining: setting LoopStripMiningIter to 0&quot;);
339     }
340     LoopStripMiningIter = 0;
341   }
342 #endif // COMPILER2
343 
344   if (Arguments::is_interpreter_only()) {
345     if (UseCompiler) {
346       if (!FLAG_IS_DEFAULT(UseCompiler)) {
347         warning(&quot;UseCompiler disabled due to -Xint.&quot;);
348       }
<span class="line-modified">349       FLAG_SET_CMDLINE(bool, UseCompiler, false);</span>
350     }
351     if (ProfileInterpreter) {
352       if (!FLAG_IS_DEFAULT(ProfileInterpreter)) {
353         warning(&quot;ProfileInterpreter disabled due to -Xint.&quot;);
354       }
<span class="line-modified">355       FLAG_SET_CMDLINE(bool, ProfileInterpreter, false);</span>
356     }
357     if (TieredCompilation) {
358       if (!FLAG_IS_DEFAULT(TieredCompilation)) {
359         warning(&quot;TieredCompilation disabled due to -Xint.&quot;);
360       }
<span class="line-modified">361       FLAG_SET_CMDLINE(bool, TieredCompilation, false);</span>
362     }
363 #if INCLUDE_JVMCI
364     if (EnableJVMCI) {
365       if (!FLAG_IS_DEFAULT(EnableJVMCI) || !FLAG_IS_DEFAULT(UseJVMCICompiler)) {
366         warning(&quot;JVMCI Compiler disabled due to -Xint.&quot;);
367       }
<span class="line-modified">368       FLAG_SET_CMDLINE(bool, EnableJVMCI, false);</span>
<span class="line-modified">369       FLAG_SET_CMDLINE(bool, UseJVMCICompiler, false);</span>
370     }
371 #endif
372   } else {
373 #if INCLUDE_JVMCI
374     status = status &amp;&amp; JVMCIGlobals::check_jvmci_flags_are_consistent();
375 #endif
376   }
377   return status;
378 }
379 
380 void CompilerConfig::ergo_initialize() {
381   if (Arguments::is_interpreter_only()) {
382     return; // Nothing to do.
383   }
384 
385 #ifdef TIERED
386   if (!compilation_mode_selected()) {
387     select_compilation_mode_ergonomically();
388   }
389 #endif
390 
391 #if INCLUDE_JVMCI
392   // Check that JVMCI compiler supports selested GC.
393   // Should be done after GCConfig::initialize() was called.
394   JVMCIGlobals::check_jvmci_supported_gc();


395   set_jvmci_specific_flags();
396 #endif
397 

398   if (TieredCompilation) {
399     set_tiered_flags();
<span class="line-modified">400   } else {</span>
<span class="line-removed">401     int max_compilation_policy_choice = 1;</span>
<span class="line-removed">402 #ifdef COMPILER2</span>
<span class="line-removed">403     if (is_server_compilation_mode_vm()) {</span>
<span class="line-removed">404       max_compilation_policy_choice = 2;</span>
<span class="line-removed">405     }</span>
406 #endif
<span class="line-modified">407     // Check if the policy is valid.</span>
<span class="line-removed">408     if (CompilationPolicyChoice &gt;= max_compilation_policy_choice) {</span>
<span class="line-removed">409       vm_exit_during_initialization(</span>
<span class="line-removed">410         &quot;Incompatible compilation policy selected&quot;, NULL);</span>
<span class="line-removed">411     }</span>
412     // Scale CompileThreshold
413     // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves CompileThreshold unchanged.
414     if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
<span class="line-modified">415       FLAG_SET_ERGO(intx, CompileThreshold, scaled_compile_threshold(CompileThreshold));</span>
416     }
417   }
418 
419   if (UseOnStackReplacement &amp;&amp; !UseLoopCounter) {
420     warning(&quot;On-stack-replacement requires loop counters; enabling loop counters&quot;);
421     FLAG_SET_DEFAULT(UseLoopCounter, true);
422   }
423 
424 #ifdef COMPILER2
425   if (!EliminateLocks) {
426     EliminateNestedLocks = false;
427   }
428   if (!Inline) {
429     IncrementalInline = false;
430   }
431 #ifndef PRODUCT
432   if (!IncrementalInline) {
433     AlwaysIncrementalInline = false;
434   }
435   if (PrintIdealGraphLevel &gt; 0) {
<span class="line-modified">436     FLAG_SET_ERGO(bool, PrintIdealGraph, true);</span>
437   }
438 #endif
439   if (!UseTypeSpeculation &amp;&amp; FLAG_IS_DEFAULT(TypeProfileLevel)) {
440     // nothing to use the profiling, turn if off
441     FLAG_SET_DEFAULT(TypeProfileLevel, 0);
442   }
443   if (!FLAG_IS_DEFAULT(OptoLoopAlignment) &amp;&amp; FLAG_IS_DEFAULT(MaxLoopPad)) {
444     FLAG_SET_DEFAULT(MaxLoopPad, OptoLoopAlignment-1);
445   }
446   if (FLAG_IS_DEFAULT(LoopStripMiningIterShortLoop)) {
447     // blind guess
448     LoopStripMiningIterShortLoop = LoopStripMiningIter / 10;
449   }
450 #endif // COMPILER2
451 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;code/codeCache.hpp&quot;
 27 #include &quot;runtime/globals.hpp&quot;
 28 #include &quot;runtime/globals_extension.hpp&quot;
 29 #include &quot;compiler/compilerDefinitions.hpp&quot;
 30 #include &quot;gc/shared/gcConfig.hpp&quot;
 31 #include &quot;utilities/defaultStream.hpp&quot;
 32 
 33 const char* compilertype2name_tab[compiler_number_of_types] = {
 34   &quot;&quot;,
 35   &quot;c1&quot;,
 36   &quot;c2&quot;,
 37   &quot;jvmci&quot;
 38 };
 39 
<span class="line-added"> 40 #ifdef TIERED</span>
<span class="line-added"> 41 bool CompilationModeFlag::_quick_only = false;</span>
<span class="line-added"> 42 bool CompilationModeFlag::_high_only = false;</span>
<span class="line-added"> 43 bool CompilationModeFlag::_high_only_quick_internal = false;</span>
<span class="line-added"> 44 </span>
<span class="line-added"> 45 </span>
<span class="line-added"> 46 bool CompilationModeFlag::initialize() {</span>
<span class="line-added"> 47   if (CompilationMode != NULL) {</span>
<span class="line-added"> 48     if (strcmp(CompilationMode, &quot;default&quot;) == 0) {</span>
<span class="line-added"> 49       // Do nothing, just support the &quot;default&quot; keyword.</span>
<span class="line-added"> 50     } else if (strcmp(CompilationMode, &quot;quick-only&quot;) == 0) {</span>
<span class="line-added"> 51       _quick_only = true;</span>
<span class="line-added"> 52     } else if (strcmp(CompilationMode, &quot;high-only&quot;) == 0) {</span>
<span class="line-added"> 53       _high_only = true;</span>
<span class="line-added"> 54     } else if (strcmp(CompilationMode, &quot;high-only-quick-internal&quot;) == 0) {</span>
<span class="line-added"> 55       _high_only_quick_internal = true;</span>
<span class="line-added"> 56     } else {</span>
<span class="line-added"> 57       jio_fprintf(defaultStream::error_stream(), &quot;Unsupported compilation mode &#39;%s&#39;, supported modes are: quick-only, high-only, high-only-quick-internal\n&quot;, CompilationMode);</span>
<span class="line-added"> 58       return false;</span>
<span class="line-added"> 59     }</span>
<span class="line-added"> 60   }</span>
<span class="line-added"> 61   return true;</span>
<span class="line-added"> 62 }</span>
<span class="line-added"> 63 </span>
<span class="line-added"> 64 #endif</span>
<span class="line-added"> 65 </span>
 66 #if defined(COMPILER2)
 67 CompLevel  CompLevel_highest_tier      = CompLevel_full_optimization;  // pure C2 and tiered or JVMCI and tiered
 68 #elif defined(COMPILER1)
 69 CompLevel  CompLevel_highest_tier      = CompLevel_simple;             // pure C1 or JVMCI
 70 #else
 71 CompLevel  CompLevel_highest_tier      = CompLevel_none;
 72 #endif
 73 










 74 #if defined(COMPILER2)
 75 CompMode  Compilation_mode             = CompMode_server;
 76 #elif defined(COMPILER1)
 77 CompMode  Compilation_mode             = CompMode_client;
 78 #else
 79 CompMode  Compilation_mode             = CompMode_none;
 80 #endif
 81 
 82 // Returns threshold scaled with CompileThresholdScaling
 83 intx CompilerConfig::scaled_compile_threshold(intx threshold) {
 84   return scaled_compile_threshold(threshold, CompileThresholdScaling);
 85 }
 86 
 87 // Returns freq_log scaled with CompileThresholdScaling
 88 intx CompilerConfig::scaled_freq_log(intx freq_log) {
 89   return scaled_freq_log(freq_log, CompileThresholdScaling);
 90 }
 91 
 92 // Returns threshold scaled with the value of scale.
 93 // If scale &lt; 0.0, threshold is returned without scaling.
</pre>
<hr />
<pre>
115   // The largest mask value that the interpreter/C1 can handle is
116   // of length InvocationCounter::number_of_count_bits. Mask values are always
117   // one bit shorter then the value of the notification frequency. Set
118   // max_freq_bits accordingly.
119   intx max_freq_bits = InvocationCounter::number_of_count_bits + 1;
120   intx scaled_freq = scaled_compile_threshold((intx)1 &lt;&lt; freq_log, scale);
121   if (scaled_freq == 0) {
122     // Return 0 right away to avoid calculating log2 of 0.
123     return 0;
124   } else if (scaled_freq &gt; nth_bit(max_freq_bits)) {
125     return max_freq_bits;
126   } else {
127     return log2_intptr(scaled_freq);
128   }
129 }
130 
131 #ifdef TIERED
132 void set_client_compilation_mode() {
133   Compilation_mode = CompMode_client;
134   CompLevel_highest_tier = CompLevel_simple;
<span class="line-modified">135   FLAG_SET_ERGO(TieredCompilation, false);</span>
<span class="line-modified">136   FLAG_SET_ERGO(ProfileInterpreter, false);</span>

137 #if INCLUDE_JVMCI
<span class="line-modified">138   FLAG_SET_ERGO(EnableJVMCI, false);</span>
<span class="line-modified">139   FLAG_SET_ERGO(UseJVMCICompiler, false);</span>
140 #endif
141 #if INCLUDE_AOT
<span class="line-modified">142   FLAG_SET_ERGO(UseAOT, false);</span>
143 #endif
144   if (FLAG_IS_DEFAULT(NeverActAsServerClassMachine)) {
<span class="line-modified">145     FLAG_SET_ERGO(NeverActAsServerClassMachine, true);</span>
146   }
147   if (FLAG_IS_DEFAULT(InitialCodeCacheSize)) {
<span class="line-modified">148     FLAG_SET_ERGO(InitialCodeCacheSize, 160*K);</span>
149   }
150   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
<span class="line-modified">151     FLAG_SET_ERGO(ReservedCodeCacheSize, 32*M);</span>
152   }
153   if (FLAG_IS_DEFAULT(NonProfiledCodeHeapSize)) {
<span class="line-modified">154     FLAG_SET_ERGO(NonProfiledCodeHeapSize, 27*M);</span>
155   }
156   if (FLAG_IS_DEFAULT(ProfiledCodeHeapSize)) {
<span class="line-modified">157     FLAG_SET_ERGO(ProfiledCodeHeapSize, 0);</span>
158   }
159   if (FLAG_IS_DEFAULT(NonNMethodCodeHeapSize)) {
<span class="line-modified">160     FLAG_SET_ERGO(NonNMethodCodeHeapSize, 5*M);</span>
161   }
162   if (FLAG_IS_DEFAULT(CodeCacheExpansionSize)) {
<span class="line-modified">163     FLAG_SET_ERGO(CodeCacheExpansionSize, 32*K);</span>
164   }
165   if (FLAG_IS_DEFAULT(MetaspaceSize)) {
<span class="line-modified">166     FLAG_SET_ERGO(MetaspaceSize, MIN2(12*M, MaxMetaspaceSize));</span>
167   }
168   if (FLAG_IS_DEFAULT(MaxRAM)) {
169     // Do not use FLAG_SET_ERGO to update MaxRAM, as this will impact
170     // heap setting done based on available phys_mem (see Arguments::set_heap_size).
171     FLAG_SET_DEFAULT(MaxRAM, 1ULL*G);
172   }
173   if (FLAG_IS_DEFAULT(CompileThreshold)) {
<span class="line-modified">174     FLAG_SET_ERGO(CompileThreshold, 1500);</span>
175   }
176   if (FLAG_IS_DEFAULT(OnStackReplacePercentage)) {
<span class="line-modified">177     FLAG_SET_ERGO(OnStackReplacePercentage, 933);</span>
178   }
179   if (FLAG_IS_DEFAULT(CICompilerCount)) {
<span class="line-modified">180     FLAG_SET_ERGO(CICompilerCount, 1);</span>
181   }
182 }
183 
184 bool compilation_mode_selected() {
185   return !FLAG_IS_DEFAULT(TieredCompilation) ||
186          !FLAG_IS_DEFAULT(TieredStopAtLevel) ||
187          !FLAG_IS_DEFAULT(UseAOT)
188          JVMCI_ONLY(|| !FLAG_IS_DEFAULT(EnableJVMCI)
189                     || !FLAG_IS_DEFAULT(UseJVMCICompiler));
190 }
191 
192 void select_compilation_mode_ergonomically() {
193 #if defined(_WINDOWS) &amp;&amp; !defined(_LP64)
194   if (FLAG_IS_DEFAULT(NeverActAsServerClassMachine)) {
<span class="line-modified">195     FLAG_SET_ERGO(NeverActAsServerClassMachine, true);</span>
196   }
197 #endif
198   if (NeverActAsServerClassMachine) {
199     set_client_compilation_mode();
200   }
201 }
202 

203 
204 void CompilerConfig::set_tiered_flags() {








205   // Increase the code cache size - tiered compiles a lot more.
206   if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {
<span class="line-modified">207     FLAG_SET_ERGO(ReservedCodeCacheSize,</span>
208                   MIN2(CODE_CACHE_DEFAULT_LIMIT, (size_t)ReservedCodeCacheSize * 5));
209   }
210   // Enable SegmentedCodeCache if TieredCompilation is enabled, ReservedCodeCacheSize &gt;= 240M
211   // and the code cache contains at least 8 pages (segmentation disables advantage of huge pages).
212   if (FLAG_IS_DEFAULT(SegmentedCodeCache) &amp;&amp; ReservedCodeCacheSize &gt;= 240*M &amp;&amp;
213       8 * CodeCache::page_size() &lt;= ReservedCodeCacheSize) {
<span class="line-modified">214     FLAG_SET_ERGO(SegmentedCodeCache, true);</span>
215   }
216   if (!UseInterpreter) { // -Xcomp
217     Tier3InvokeNotifyFreqLog = 0;
218     Tier4InvocationThreshold = 0;
219   }
220 
221   if (CompileThresholdScaling &lt; 0) {
222     vm_exit_during_initialization(&quot;Negative value specified for CompileThresholdScaling&quot;, NULL);
223   }
224 
<span class="line-added">225   if (CompilationModeFlag::disable_intermediate()) {</span>
<span class="line-added">226     if (FLAG_IS_DEFAULT(Tier0ProfilingStartPercentage)) {</span>
<span class="line-added">227       FLAG_SET_DEFAULT(Tier0ProfilingStartPercentage, 33);</span>
<span class="line-added">228     }</span>
<span class="line-added">229   }</span>
<span class="line-added">230 </span>
231   // Scale tiered compilation thresholds.
232   // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves compilation thresholds unchanged.
233   if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
<span class="line-modified">234     FLAG_SET_ERGO(Tier0InvokeNotifyFreqLog, scaled_freq_log(Tier0InvokeNotifyFreqLog));</span>
<span class="line-modified">235     FLAG_SET_ERGO(Tier0BackedgeNotifyFreqLog, scaled_freq_log(Tier0BackedgeNotifyFreqLog));</span>
236 
<span class="line-modified">237     FLAG_SET_ERGO(Tier3InvocationThreshold, scaled_compile_threshold(Tier3InvocationThreshold));</span>
<span class="line-modified">238     FLAG_SET_ERGO(Tier3MinInvocationThreshold, scaled_compile_threshold(Tier3MinInvocationThreshold));</span>
<span class="line-modified">239     FLAG_SET_ERGO(Tier3CompileThreshold, scaled_compile_threshold(Tier3CompileThreshold));</span>
<span class="line-modified">240     FLAG_SET_ERGO(Tier3BackEdgeThreshold, scaled_compile_threshold(Tier3BackEdgeThreshold));</span>
241 
242     // Tier2{Invocation,MinInvocation,Compile,Backedge}Threshold should be scaled here
243     // once these thresholds become supported.
244 
<span class="line-modified">245     FLAG_SET_ERGO(Tier2InvokeNotifyFreqLog, scaled_freq_log(Tier2InvokeNotifyFreqLog));</span>
<span class="line-modified">246     FLAG_SET_ERGO(Tier2BackedgeNotifyFreqLog, scaled_freq_log(Tier2BackedgeNotifyFreqLog));</span>
<span class="line-added">247 </span>
<span class="line-added">248     FLAG_SET_ERGO(Tier3InvokeNotifyFreqLog, scaled_freq_log(Tier3InvokeNotifyFreqLog));</span>
<span class="line-added">249     FLAG_SET_ERGO(Tier3BackedgeNotifyFreqLog, scaled_freq_log(Tier3BackedgeNotifyFreqLog));</span>
250 
<span class="line-modified">251     FLAG_SET_ERGO(Tier23InlineeNotifyFreqLog, scaled_freq_log(Tier23InlineeNotifyFreqLog));</span>

252 
<span class="line-modified">253     FLAG_SET_ERGO(Tier4InvocationThreshold, scaled_compile_threshold(Tier4InvocationThreshold));</span>
<span class="line-added">254     FLAG_SET_ERGO(Tier4MinInvocationThreshold, scaled_compile_threshold(Tier4MinInvocationThreshold));</span>
<span class="line-added">255     FLAG_SET_ERGO(Tier4CompileThreshold, scaled_compile_threshold(Tier4CompileThreshold));</span>
<span class="line-added">256     FLAG_SET_ERGO(Tier4BackEdgeThreshold, scaled_compile_threshold(Tier4BackEdgeThreshold));</span>
257 
<span class="line-modified">258     if (CompilationModeFlag::disable_intermediate()) {</span>
<span class="line-modified">259       FLAG_SET_ERGO(Tier40InvocationThreshold, scaled_compile_threshold(Tier40InvocationThreshold));</span>
<span class="line-modified">260       FLAG_SET_ERGO(Tier40MinInvocationThreshold, scaled_compile_threshold(Tier40MinInvocationThreshold));</span>
<span class="line-modified">261       FLAG_SET_ERGO(Tier40CompileThreshold, scaled_compile_threshold(Tier40CompileThreshold));</span>
<span class="line-added">262       FLAG_SET_ERGO(Tier40BackEdgeThreshold, scaled_compile_threshold(Tier40BackEdgeThreshold));</span>
<span class="line-added">263     }</span>
<span class="line-added">264 </span>
<span class="line-added">265 #if INCLUDE_AOT</span>
<span class="line-added">266     if (UseAOT) {</span>
<span class="line-added">267       FLAG_SET_ERGO(Tier3AOTInvocationThreshold, scaled_compile_threshold(Tier3AOTInvocationThreshold));</span>
<span class="line-added">268       FLAG_SET_ERGO(Tier3AOTMinInvocationThreshold, scaled_compile_threshold(Tier3AOTMinInvocationThreshold));</span>
<span class="line-added">269       FLAG_SET_ERGO(Tier3AOTCompileThreshold, scaled_compile_threshold(Tier3AOTCompileThreshold));</span>
<span class="line-added">270       FLAG_SET_ERGO(Tier3AOTBackEdgeThreshold, scaled_compile_threshold(Tier3AOTBackEdgeThreshold));</span>
<span class="line-added">271 </span>
<span class="line-added">272       if (CompilationModeFlag::disable_intermediate()) {</span>
<span class="line-added">273         FLAG_SET_ERGO(Tier0AOTInvocationThreshold, scaled_compile_threshold(Tier0AOTInvocationThreshold));</span>
<span class="line-added">274         FLAG_SET_ERGO(Tier0AOTMinInvocationThreshold, scaled_compile_threshold(Tier0AOTMinInvocationThreshold));</span>
<span class="line-added">275         FLAG_SET_ERGO(Tier0AOTCompileThreshold, scaled_compile_threshold(Tier0AOTCompileThreshold));</span>
<span class="line-added">276         FLAG_SET_ERGO(Tier0AOTBackEdgeThreshold, scaled_compile_threshold(Tier0AOTBackEdgeThreshold));</span>
<span class="line-added">277       }</span>
<span class="line-added">278     }</span>
<span class="line-added">279 #endif // INCLUDE_AOT</span>
280   }
281 }
282 
<span class="line-added">283 #endif // TIERED</span>
<span class="line-added">284 </span>
285 #if INCLUDE_JVMCI
286 void set_jvmci_specific_flags() {
287   if (UseJVMCICompiler) {
288     Compilation_mode = CompMode_server;
289 
290     if (FLAG_IS_DEFAULT(TypeProfileWidth)) {
291       FLAG_SET_DEFAULT(TypeProfileWidth, 8);
292     }





















293     if (FLAG_IS_DEFAULT(TypeProfileLevel)) {
294       FLAG_SET_DEFAULT(TypeProfileLevel, 0);
295     }
<span class="line-modified">296 </span>
<span class="line-added">297     if (UseJVMCINativeLibrary) {</span>
<span class="line-added">298       // SVM compiled code requires more stack space</span>
<span class="line-added">299       if (FLAG_IS_DEFAULT(CompilerThreadStackSize)) {</span>
<span class="line-added">300         // Duplicate logic in the implementations of os::create_thread</span>
<span class="line-added">301         // so that we can then double the computed stack size. Once</span>
<span class="line-added">302         // the stack size requirements of SVM are better understood,</span>
<span class="line-added">303         // this logic can be pushed down into os::create_thread.</span>
<span class="line-added">304         int stack_size = CompilerThreadStackSize;</span>
<span class="line-added">305         if (stack_size == 0) {</span>
<span class="line-added">306           stack_size = VMThreadStackSize;</span>
<span class="line-added">307         }</span>
<span class="line-added">308         if (stack_size != 0) {</span>
<span class="line-added">309           FLAG_SET_DEFAULT(CompilerThreadStackSize, stack_size * 2);</span>
<span class="line-added">310         }</span>
<span class="line-added">311       }</span>
<span class="line-added">312     } else {</span>
<span class="line-added">313 #ifdef TIERED</span>
<span class="line-added">314       if (!TieredCompilation) {</span>
<span class="line-added">315          warning(&quot;Disabling tiered compilation with non-native JVMCI compiler is not recommended. &quot;</span>
<span class="line-added">316                  &quot;Turning on tiered compilation and disabling intermediate compilation levels instead. &quot;);</span>
<span class="line-added">317          FLAG_SET_ERGO(TieredCompilation, true);</span>
<span class="line-added">318          if (CompilationModeFlag::normal()) {</span>
<span class="line-added">319            CompilationModeFlag::set_high_only_quick_internal(true);</span>
<span class="line-added">320          }</span>
<span class="line-added">321          if (CICompilerCount &lt; 2 &amp;&amp; CompilationModeFlag::quick_internal()) {</span>
<span class="line-added">322             warning(&quot;Increasing number of compiler threads for JVMCI compiler.&quot;);</span>
<span class="line-added">323             FLAG_SET_ERGO(CICompilerCount, 2);</span>
<span class="line-added">324          }</span>
<span class="line-added">325       }</span>
<span class="line-added">326 #else // TIERED</span>
<span class="line-added">327       // Adjust the on stack replacement percentage to avoid early</span>
<span class="line-added">328       // OSR compilations while JVMCI itself is warming up</span>
<span class="line-added">329       if (FLAG_IS_DEFAULT(OnStackReplacePercentage)) {</span>
<span class="line-added">330         FLAG_SET_DEFAULT(OnStackReplacePercentage, 933);</span>
<span class="line-added">331       }</span>
<span class="line-added">332 #endif // !TIERED</span>
<span class="line-added">333       // JVMCI needs values not less than defaults</span>
<span class="line-added">334       if (FLAG_IS_DEFAULT(ReservedCodeCacheSize)) {</span>
<span class="line-added">335         FLAG_SET_DEFAULT(ReservedCodeCacheSize, MAX2(64*M, ReservedCodeCacheSize));</span>
<span class="line-added">336       }</span>
<span class="line-added">337       if (FLAG_IS_DEFAULT(InitialCodeCacheSize)) {</span>
<span class="line-added">338         FLAG_SET_DEFAULT(InitialCodeCacheSize, MAX2(16*M, InitialCodeCacheSize));</span>
<span class="line-added">339       }</span>
<span class="line-added">340       if (FLAG_IS_DEFAULT(MetaspaceSize)) {</span>
<span class="line-added">341         FLAG_SET_DEFAULT(MetaspaceSize, MIN2(MAX2(12*M, MetaspaceSize), MaxMetaspaceSize));</span>
<span class="line-added">342       }</span>
<span class="line-added">343       if (FLAG_IS_DEFAULT(NewSizeThreadIncrease)) {</span>
<span class="line-added">344         FLAG_SET_DEFAULT(NewSizeThreadIncrease, MAX2(4*K, NewSizeThreadIncrease));</span>
<span class="line-added">345       }</span>
<span class="line-added">346     } // !UseJVMCINativeLibrary</span>
<span class="line-added">347   } // UseJVMCICompiler</span>
348 }
349 #endif // INCLUDE_JVMCI
350 
351 bool CompilerConfig::check_args_consistency(bool status) {
352   // Check lower bounds of the code cache
353   // Template Interpreter code is approximately 3X larger in debug builds.
354   uint min_code_cache_size = CodeCacheMinimumUseSpace DEBUG_ONLY(* 3);
355   if (ReservedCodeCacheSize &lt; InitialCodeCacheSize) {
356     jio_fprintf(defaultStream::error_stream(),
357                 &quot;Invalid ReservedCodeCacheSize: %dK. Must be at least InitialCodeCacheSize=%dK.\n&quot;,
358                 ReservedCodeCacheSize/K, InitialCodeCacheSize/K);
359     status = false;
360   } else if (ReservedCodeCacheSize &lt; min_code_cache_size) {
361     jio_fprintf(defaultStream::error_stream(),
362                 &quot;Invalid ReservedCodeCacheSize=%dK. Must be at least %uK.\n&quot;, ReservedCodeCacheSize/K,
363                 min_code_cache_size/K);
364     status = false;
365   } else if (ReservedCodeCacheSize &gt; CODE_CACHE_SIZE_LIMIT) {
366     // Code cache size larger than CODE_CACHE_SIZE_LIMIT is not supported.
367     jio_fprintf(defaultStream::error_stream(),
368                 &quot;Invalid ReservedCodeCacheSize=%dM. Must be at most %uM.\n&quot;, ReservedCodeCacheSize/M,
369                 CODE_CACHE_SIZE_LIMIT/M);
370     status = false;
371   } else if (NonNMethodCodeHeapSize &lt; min_code_cache_size) {
372     jio_fprintf(defaultStream::error_stream(),
373                 &quot;Invalid NonNMethodCodeHeapSize=%dK. Must be at least %uK.\n&quot;, NonNMethodCodeHeapSize/K,
374                 min_code_cache_size/K);
375     status = false;
376   }
377 
378 #ifdef _LP64
379   if (!FLAG_IS_DEFAULT(CICompilerCount) &amp;&amp; !FLAG_IS_DEFAULT(CICompilerCountPerCPU) &amp;&amp; CICompilerCountPerCPU) {
380     warning(&quot;The VM option CICompilerCountPerCPU overrides CICompilerCount.&quot;);
381   }
382 #endif
383 
384   if (BackgroundCompilation &amp;&amp; ReplayCompiles) {
385     if (!FLAG_IS_DEFAULT(BackgroundCompilation)) {
386       warning(&quot;BackgroundCompilation disabled due to ReplayCompiles option.&quot;);
387     }
<span class="line-modified">388     FLAG_SET_CMDLINE(BackgroundCompilation, false);</span>
389   }
390 
391 #ifdef COMPILER2
392   if (PostLoopMultiversioning &amp;&amp; !RangeCheckElimination) {
393     if (!FLAG_IS_DEFAULT(PostLoopMultiversioning)) {
394       warning(&quot;PostLoopMultiversioning disabled because RangeCheckElimination is disabled.&quot;);
395     }
<span class="line-modified">396     FLAG_SET_CMDLINE(PostLoopMultiversioning, false);</span>
397   }
398   if (UseCountedLoopSafepoints &amp;&amp; LoopStripMiningIter == 0) {
399     if (!FLAG_IS_DEFAULT(UseCountedLoopSafepoints) || !FLAG_IS_DEFAULT(LoopStripMiningIter)) {
400       warning(&quot;When counted loop safepoints are enabled, LoopStripMiningIter must be at least 1 (a safepoint every 1 iteration): setting it to 1&quot;);
401     }
402     LoopStripMiningIter = 1;
403   } else if (!UseCountedLoopSafepoints &amp;&amp; LoopStripMiningIter &gt; 0) {
404     if (!FLAG_IS_DEFAULT(UseCountedLoopSafepoints) || !FLAG_IS_DEFAULT(LoopStripMiningIter)) {
405       warning(&quot;Disabling counted safepoints implies no loop strip mining: setting LoopStripMiningIter to 0&quot;);
406     }
407     LoopStripMiningIter = 0;
408   }
409 #endif // COMPILER2
410 
411   if (Arguments::is_interpreter_only()) {
412     if (UseCompiler) {
413       if (!FLAG_IS_DEFAULT(UseCompiler)) {
414         warning(&quot;UseCompiler disabled due to -Xint.&quot;);
415       }
<span class="line-modified">416       FLAG_SET_CMDLINE(UseCompiler, false);</span>
417     }
418     if (ProfileInterpreter) {
419       if (!FLAG_IS_DEFAULT(ProfileInterpreter)) {
420         warning(&quot;ProfileInterpreter disabled due to -Xint.&quot;);
421       }
<span class="line-modified">422       FLAG_SET_CMDLINE(ProfileInterpreter, false);</span>
423     }
424     if (TieredCompilation) {
425       if (!FLAG_IS_DEFAULT(TieredCompilation)) {
426         warning(&quot;TieredCompilation disabled due to -Xint.&quot;);
427       }
<span class="line-modified">428       FLAG_SET_CMDLINE(TieredCompilation, false);</span>
429     }
430 #if INCLUDE_JVMCI
431     if (EnableJVMCI) {
432       if (!FLAG_IS_DEFAULT(EnableJVMCI) || !FLAG_IS_DEFAULT(UseJVMCICompiler)) {
433         warning(&quot;JVMCI Compiler disabled due to -Xint.&quot;);
434       }
<span class="line-modified">435       FLAG_SET_CMDLINE(EnableJVMCI, false);</span>
<span class="line-modified">436       FLAG_SET_CMDLINE(UseJVMCICompiler, false);</span>
437     }
438 #endif
439   } else {
440 #if INCLUDE_JVMCI
441     status = status &amp;&amp; JVMCIGlobals::check_jvmci_flags_are_consistent();
442 #endif
443   }
444   return status;
445 }
446 
447 void CompilerConfig::ergo_initialize() {
448   if (Arguments::is_interpreter_only()) {
449     return; // Nothing to do.
450   }
451 
452 #ifdef TIERED
453   if (!compilation_mode_selected()) {
454     select_compilation_mode_ergonomically();
455   }
456 #endif
457 
458 #if INCLUDE_JVMCI
459   // Check that JVMCI compiler supports selested GC.
460   // Should be done after GCConfig::initialize() was called.
461   JVMCIGlobals::check_jvmci_supported_gc();
<span class="line-added">462 </span>
<span class="line-added">463   // Do JVMCI specific settings</span>
464   set_jvmci_specific_flags();
465 #endif
466 
<span class="line-added">467 #ifdef TIERED</span>
468   if (TieredCompilation) {
469     set_tiered_flags();
<span class="line-modified">470   } else</span>





471 #endif
<span class="line-modified">472   {</span>




473     // Scale CompileThreshold
474     // CompileThresholdScaling == 0.0 is equivalent to -Xint and leaves CompileThreshold unchanged.
475     if (!FLAG_IS_DEFAULT(CompileThresholdScaling) &amp;&amp; CompileThresholdScaling &gt; 0.0) {
<span class="line-modified">476       FLAG_SET_ERGO(CompileThreshold, scaled_compile_threshold(CompileThreshold));</span>
477     }
478   }
479 
480   if (UseOnStackReplacement &amp;&amp; !UseLoopCounter) {
481     warning(&quot;On-stack-replacement requires loop counters; enabling loop counters&quot;);
482     FLAG_SET_DEFAULT(UseLoopCounter, true);
483   }
484 
485 #ifdef COMPILER2
486   if (!EliminateLocks) {
487     EliminateNestedLocks = false;
488   }
489   if (!Inline) {
490     IncrementalInline = false;
491   }
492 #ifndef PRODUCT
493   if (!IncrementalInline) {
494     AlwaysIncrementalInline = false;
495   }
496   if (PrintIdealGraphLevel &gt; 0) {
<span class="line-modified">497     FLAG_SET_ERGO(PrintIdealGraph, true);</span>
498   }
499 #endif
500   if (!UseTypeSpeculation &amp;&amp; FLAG_IS_DEFAULT(TypeProfileLevel)) {
501     // nothing to use the profiling, turn if off
502     FLAG_SET_DEFAULT(TypeProfileLevel, 0);
503   }
504   if (!FLAG_IS_DEFAULT(OptoLoopAlignment) &amp;&amp; FLAG_IS_DEFAULT(MaxLoopPad)) {
505     FLAG_SET_DEFAULT(MaxLoopPad, OptoLoopAlignment-1);
506   }
507   if (FLAG_IS_DEFAULT(LoopStripMiningIterShortLoop)) {
508     // blind guess
509     LoopStripMiningIterShortLoop = LoopStripMiningIter / 10;
510   }
511 #endif // COMPILER2
512 }
</pre>
</td>
</tr>
</table>
<center><a href="compileTask.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="compilerDefinitions.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>