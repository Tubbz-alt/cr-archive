<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os_cpu/linux_sparc/os_linux_sparc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 // no precompiled headers
 26 #include &quot;jvm.h&quot;
 27 #include &quot;asm/macroAssembler.hpp&quot;
 28 #include &quot;classfile/classLoader.hpp&quot;
 29 #include &quot;classfile/systemDictionary.hpp&quot;
 30 #include &quot;classfile/vmSymbols.hpp&quot;
 31 #include &quot;code/codeCache.hpp&quot;
 32 #include &quot;code/icBuffer.hpp&quot;
 33 #include &quot;code/vtableStubs.hpp&quot;
 34 #include &quot;interpreter/interpreter.hpp&quot;
 35 #include &quot;memory/allocation.inline.hpp&quot;
 36 #include &quot;nativeInst_sparc.hpp&quot;
 37 #include &quot;os_share_linux.hpp&quot;
 38 #include &quot;prims/jniFastGetField.hpp&quot;
 39 #include &quot;prims/jvm_misc.hpp&quot;
 40 #include &quot;runtime/arguments.hpp&quot;
 41 #include &quot;runtime/extendedPC.hpp&quot;
 42 #include &quot;runtime/frame.inline.hpp&quot;
 43 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
 44 #include &quot;runtime/java.hpp&quot;
 45 #include &quot;runtime/javaCalls.hpp&quot;
 46 #include &quot;runtime/mutexLocker.hpp&quot;
 47 #include &quot;runtime/osThread.hpp&quot;
 48 #include &quot;runtime/sharedRuntime.hpp&quot;
 49 #include &quot;runtime/stubRoutines.hpp&quot;
 50 #include &quot;runtime/thread.inline.hpp&quot;
 51 #include &quot;runtime/timer.hpp&quot;
 52 #include &quot;utilities/debug.hpp&quot;
 53 #include &quot;utilities/events.hpp&quot;
 54 #include &quot;utilities/vmError.hpp&quot;
 55 
 56 // Linux/Sparc has rather obscure naming of registers in sigcontext
 57 // different between 32 and 64 bits
 58 #define SIG_PC(x) ((x)-&gt;sigc_regs.tpc)
 59 #define SIG_NPC(x) ((x)-&gt;sigc_regs.tnpc)
 60 #define SIG_REGS(x) ((x)-&gt;sigc_regs)
 61 
 62 // those are to reference registers in sigcontext
 63 enum {
 64   CON_G0 = 0,
 65   CON_G1,
 66   CON_G2,
 67   CON_G3,
 68   CON_G4,
 69   CON_G5,
 70   CON_G6,
 71   CON_G7,
 72   CON_O0,
 73   CON_O1,
 74   CON_O2,
 75   CON_O3,
 76   CON_O4,
 77   CON_O5,
 78   CON_O6,
 79   CON_O7,
 80 };
 81 
 82 // For Forte Analyzer AsyncGetCallTrace profiling support - thread is
 83 // currently interrupted by SIGPROF.
 84 // os::Solaris::fetch_frame_from_ucontext() tries to skip nested
 85 // signal frames. Currently we don&#39;t do that on Linux, so it&#39;s the
 86 // same as os::fetch_frame_from_context().
 87 ExtendedPC os::Linux::fetch_frame_from_ucontext(Thread* thread,
 88                                                 const ucontext_t* uc,
 89                                                 intptr_t** ret_sp,
 90                                                 intptr_t** ret_fp) {
 91   assert(thread != NULL, &quot;just checking&quot;);
 92   assert(ret_sp != NULL, &quot;just checking&quot;);
 93   assert(ret_fp != NULL, &quot;just checking&quot;);
 94 
 95   return os::fetch_frame_from_context(uc, ret_sp, ret_fp);
 96 }
 97 
 98 ExtendedPC os::fetch_frame_from_context(const void* ucVoid,
 99                                         intptr_t** ret_sp,
100                                         intptr_t** ret_fp) {
101   const ucontext_t* uc = (const ucontext_t*) ucVoid;
102   ExtendedPC  epc;
103 
104   if (uc != NULL) {
105     epc = ExtendedPC(os::Linux::ucontext_get_pc(uc));
106     if (ret_sp) {
107       *ret_sp = os::Linux::ucontext_get_sp(uc);
108     }
109     if (ret_fp) {
110       *ret_fp = (intptr_t*)NULL;
111     }
112   } else {
113     // construct empty ExtendedPC for return value checking
114     epc = ExtendedPC(NULL);
115     if (ret_sp) {
116       *ret_sp = (intptr_t*) NULL;
117     }
118     if (ret_fp) {
119       *ret_fp = (intptr_t*) NULL;
120     }
121   }
122 
123   return epc;
124 }
125 
126 frame os::fetch_frame_from_context(const void* ucVoid) {
127   intptr_t* sp;
128   ExtendedPC epc = fetch_frame_from_context(ucVoid, &amp;sp, NULL);
129   return frame(sp, frame::unpatchable, epc.pc());
130 }
131 
132 frame os::get_sender_for_C_frame(frame* fr) {
133   return frame(fr-&gt;sender_sp(), frame::unpatchable, fr-&gt;sender_pc());
134 }
135 
136 frame os::current_frame() {
137   intptr_t* sp = StubRoutines::Sparc::flush_callers_register_windows_func()();
138   frame myframe(sp, frame::unpatchable,
139                 CAST_FROM_FN_PTR(address, os::current_frame));
140   if (os::is_first_C_frame(&amp;myframe)) {
141     // stack is not walkable
142     return frame(NULL, frame::unpatchable, NULL);
143   } else {
144     return os::get_sender_for_C_frame(&amp;myframe);
145   }
146 }
147 
148 address os::current_stack_pointer() {
149   register void *sp __asm__ (&quot;sp&quot;);
150   return (address)sp;
151 }
152 
153 char* os::non_memory_address_word() {
154   // Must never look like an address returned by reserve_memory,
155   // even in its subfields (as defined by the CPU immediate fields,
156   // if the CPU splits constants across multiple instructions).
157   // On SPARC, 0 != %hi(any real address), because there is no
158   // allocation in the first 1Kb of the virtual address space.
159   return (char*) 0;
160 }
161 
162 void os::print_context(outputStream *st, const void *context) {
163   if (context == NULL) return;
164 
165   const ucontext_t* uc = (const ucontext_t*)context;
166   sigcontext* sc = (sigcontext*)context;
167   st-&gt;print_cr(&quot;Registers:&quot;);
168 
169   st-&gt;print_cr(&quot; G1=&quot; INTPTR_FORMAT &quot; G2=&quot; INTPTR_FORMAT
170                &quot; G3=&quot; INTPTR_FORMAT &quot; G4=&quot; INTPTR_FORMAT,
171                SIG_REGS(sc).u_regs[CON_G1],
172                SIG_REGS(sc).u_regs[CON_G2],
173                SIG_REGS(sc).u_regs[CON_G3],
174                SIG_REGS(sc).u_regs[CON_G4]);
175   st-&gt;print_cr(&quot; G5=&quot; INTPTR_FORMAT &quot; G6=&quot; INTPTR_FORMAT
176                &quot; G7=&quot; INTPTR_FORMAT &quot; Y=0x%x&quot;,
177                SIG_REGS(sc).u_regs[CON_G5],
178                SIG_REGS(sc).u_regs[CON_G6],
179                SIG_REGS(sc).u_regs[CON_G7],
180                SIG_REGS(sc).y);
181   st-&gt;print_cr(&quot; O0=&quot; INTPTR_FORMAT &quot; O1=&quot; INTPTR_FORMAT
182                &quot; O2=&quot; INTPTR_FORMAT &quot; O3=&quot; INTPTR_FORMAT,
183                SIG_REGS(sc).u_regs[CON_O0],
184                SIG_REGS(sc).u_regs[CON_O1],
185                SIG_REGS(sc).u_regs[CON_O2],
186                SIG_REGS(sc).u_regs[CON_O3]);
187   st-&gt;print_cr(&quot; O4=&quot; INTPTR_FORMAT &quot; O5=&quot; INTPTR_FORMAT
188                &quot; O6=&quot; INTPTR_FORMAT &quot; O7=&quot; INTPTR_FORMAT,
189                SIG_REGS(sc).u_regs[CON_O4],
190                SIG_REGS(sc).u_regs[CON_O5],
191                SIG_REGS(sc).u_regs[CON_O6],
192                SIG_REGS(sc).u_regs[CON_O7]);
193 
194 
195   intptr_t *sp = (intptr_t *)os::Linux::ucontext_get_sp(uc);
196   st-&gt;print_cr(&quot; L0=&quot; INTPTR_FORMAT &quot; L1=&quot; INTPTR_FORMAT
197                &quot; L2=&quot; INTPTR_FORMAT &quot; L3=&quot; INTPTR_FORMAT,
198                sp[L0-&gt;sp_offset_in_saved_window()],
199                sp[L1-&gt;sp_offset_in_saved_window()],
200                sp[L2-&gt;sp_offset_in_saved_window()],
201                sp[L3-&gt;sp_offset_in_saved_window()]);
202   st-&gt;print_cr(&quot; L4=&quot; INTPTR_FORMAT &quot; L5=&quot; INTPTR_FORMAT
203                &quot; L6=&quot; INTPTR_FORMAT &quot; L7=&quot; INTPTR_FORMAT,
204                sp[L4-&gt;sp_offset_in_saved_window()],
205                sp[L5-&gt;sp_offset_in_saved_window()],
206                sp[L6-&gt;sp_offset_in_saved_window()],
207                sp[L7-&gt;sp_offset_in_saved_window()]);
208   st-&gt;print_cr(&quot; I0=&quot; INTPTR_FORMAT &quot; I1=&quot; INTPTR_FORMAT
209                &quot; I2=&quot; INTPTR_FORMAT &quot; I3=&quot; INTPTR_FORMAT,
210                sp[I0-&gt;sp_offset_in_saved_window()],
211                sp[I1-&gt;sp_offset_in_saved_window()],
212                sp[I2-&gt;sp_offset_in_saved_window()],
213                sp[I3-&gt;sp_offset_in_saved_window()]);
214   st-&gt;print_cr(&quot; I4=&quot; INTPTR_FORMAT &quot; I5=&quot; INTPTR_FORMAT
215                &quot; I6=&quot; INTPTR_FORMAT &quot; I7=&quot; INTPTR_FORMAT,
216                sp[I4-&gt;sp_offset_in_saved_window()],
217                sp[I5-&gt;sp_offset_in_saved_window()],
218                sp[I6-&gt;sp_offset_in_saved_window()],
219                sp[I7-&gt;sp_offset_in_saved_window()]);
220 
221   st-&gt;print_cr(&quot; PC=&quot; INTPTR_FORMAT &quot; nPC=&quot; INTPTR_FORMAT,
222                SIG_PC(sc),
223                SIG_NPC(sc));
224   st-&gt;cr();
225   st-&gt;cr();
226 
227   st-&gt;print_cr(&quot;Top of Stack: (sp=&quot; INTPTR_FORMAT &quot;)&quot;, p2i(sp));
228   print_hex_dump(st, (address)sp, (address)(sp + 32), sizeof(intptr_t));
229   st-&gt;cr();
230 
231   // Note: it may be unsafe to inspect memory near pc. For example, pc may
232   // point to garbage if entry point in an nmethod is corrupted. Leave
233   // this at the end, and hope for the best.
234   address pc = os::Linux::ucontext_get_pc(uc);
235   print_instructions(st, pc, sizeof(char));
236   st-&gt;cr();
237 }
238 
239 
240 void os::print_register_info(outputStream *st, const void *context) {
241   if (context == NULL) return;
242 
243   const ucontext_t *uc = (const ucontext_t*)context;
244   const sigcontext* sc = (const sigcontext*)context;
245   intptr_t *sp = (intptr_t *)os::Linux::ucontext_get_sp(uc);
246 
247   st-&gt;print_cr(&quot;Register to memory mapping:&quot;);
248   st-&gt;cr();
249 
250   // this is only for the &quot;general purpose&quot; registers
251   st-&gt;print(&quot;G1=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G1]);
252   st-&gt;print(&quot;G2=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G2]);
253   st-&gt;print(&quot;G3=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G3]);
254   st-&gt;print(&quot;G4=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G4]);
255   st-&gt;print(&quot;G5=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G5]);
256   st-&gt;print(&quot;G6=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G6]);
257   st-&gt;print(&quot;G7=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_G7]);
258   st-&gt;cr();
259 
260   st-&gt;print(&quot;O0=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O0]);
261   st-&gt;print(&quot;O1=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O1]);
262   st-&gt;print(&quot;O2=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O2]);
263   st-&gt;print(&quot;O3=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O3]);
264   st-&gt;print(&quot;O4=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O4]);
265   st-&gt;print(&quot;O5=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O5]);
266   st-&gt;print(&quot;O6=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O6]);
267   st-&gt;print(&quot;O7=&quot;); print_location(st, SIG_REGS(sc).u_regs[CON_O7]);
268   st-&gt;cr();
269 
270   st-&gt;print(&quot;L0=&quot;); print_location(st, sp[L0-&gt;sp_offset_in_saved_window()]);
271   st-&gt;print(&quot;L1=&quot;); print_location(st, sp[L1-&gt;sp_offset_in_saved_window()]);
272   st-&gt;print(&quot;L2=&quot;); print_location(st, sp[L2-&gt;sp_offset_in_saved_window()]);
273   st-&gt;print(&quot;L3=&quot;); print_location(st, sp[L3-&gt;sp_offset_in_saved_window()]);
274   st-&gt;print(&quot;L4=&quot;); print_location(st, sp[L4-&gt;sp_offset_in_saved_window()]);
275   st-&gt;print(&quot;L5=&quot;); print_location(st, sp[L5-&gt;sp_offset_in_saved_window()]);
276   st-&gt;print(&quot;L6=&quot;); print_location(st, sp[L6-&gt;sp_offset_in_saved_window()]);
277   st-&gt;print(&quot;L7=&quot;); print_location(st, sp[L7-&gt;sp_offset_in_saved_window()]);
278   st-&gt;cr();
279 
280   st-&gt;print(&quot;I0=&quot;); print_location(st, sp[I0-&gt;sp_offset_in_saved_window()]);
281   st-&gt;print(&quot;I1=&quot;); print_location(st, sp[I1-&gt;sp_offset_in_saved_window()]);
282   st-&gt;print(&quot;I2=&quot;); print_location(st, sp[I2-&gt;sp_offset_in_saved_window()]);
283   st-&gt;print(&quot;I3=&quot;); print_location(st, sp[I3-&gt;sp_offset_in_saved_window()]);
284   st-&gt;print(&quot;I4=&quot;); print_location(st, sp[I4-&gt;sp_offset_in_saved_window()]);
285   st-&gt;print(&quot;I5=&quot;); print_location(st, sp[I5-&gt;sp_offset_in_saved_window()]);
286   st-&gt;print(&quot;I6=&quot;); print_location(st, sp[I6-&gt;sp_offset_in_saved_window()]);
287   st-&gt;print(&quot;I7=&quot;); print_location(st, sp[I7-&gt;sp_offset_in_saved_window()]);
288   st-&gt;cr();
289 }
290 
291 
292 address os::Linux::ucontext_get_pc(const ucontext_t* uc) {
293   return (address) SIG_PC((sigcontext*)uc);
294 }
295 
296 void os::Linux::ucontext_set_pc(ucontext_t* uc, address pc) {
297   sigcontext* ctx = (sigcontext*) uc;
298   SIG_PC(ctx)  = (intptr_t)pc;
299   SIG_NPC(ctx) = (intptr_t)(pc+4);
300 }
301 
302 intptr_t* os::Linux::ucontext_get_sp(const ucontext_t *uc) {
303   return (intptr_t*)
304     ((intptr_t)SIG_REGS((sigcontext*)uc).u_regs[CON_O6] + STACK_BIAS);
305 }
306 
307 // not used on Sparc
308 intptr_t* os::Linux::ucontext_get_fp(const ucontext_t *uc) {
309   ShouldNotReachHere();
310   return NULL;
311 }
312 
313 // Utility functions
314 
315 inline static bool checkPrefetch(sigcontext* uc, address pc) {
316   if (StubRoutines::is_safefetch_fault(pc)) {
317     os::Linux::ucontext_set_pc((ucontext_t*)uc, StubRoutines::continuation_for_safefetch_fault(pc));
318     return true;
319   }
320   return false;
321 }
322 
323 inline static bool checkOverflow(sigcontext* uc,
324                                  address pc,
325                                  address addr,
326                                  JavaThread* thread,
327                                  address* stub) {
328   // check if fault address is within thread stack
329   if (thread-&gt;on_local_stack(addr)) {
330     // stack overflow
331     if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
332       thread-&gt;disable_stack_yellow_reserved_zone();
333       if (thread-&gt;thread_state() == _thread_in_Java) {
334         // Throw a stack overflow exception.  Guard pages will be reenabled
335         // while unwinding the stack.
336         *stub =
337           SharedRuntime::continuation_for_implicit_exception(thread,
338                                                              pc,
339                                                              SharedRuntime::STACK_OVERFLOW);
340       } else {
341         // Thread was in the vm or native code.  Return and try to finish.
342         return true;
343       }
344     } else if (thread-&gt;in_stack_red_zone(addr)) {
345       // Fatal red zone violation.  Disable the guard pages and fall through
346       // to handle_unexpected_exception way down below.
347       thread-&gt;disable_stack_red_zone();
348       tty-&gt;print_raw_cr(&quot;An irrecoverable stack overflow has occurred.&quot;);
349 
350       // This is a likely cause, but hard to verify. Let&#39;s just print
351       // it as a hint.
352       tty-&gt;print_raw_cr(&quot;Please check if any of your loaded .so files has &quot;
353                         &quot;enabled executable stack (see man page execstack(8))&quot;);
354     } else {
355       // Accessing stack address below sp may cause SEGV if current
356       // thread has MAP_GROWSDOWN stack. This should only happen when
357       // current thread was created by user code with MAP_GROWSDOWN flag
358       // and then attached to VM. See notes in os_linux.cpp.
359       if (thread-&gt;osthread()-&gt;expanding_stack() == 0) {
360         thread-&gt;osthread()-&gt;set_expanding_stack();
361         if (os::Linux::manually_expand_stack(thread, addr)) {
362           thread-&gt;osthread()-&gt;clear_expanding_stack();
363           return true;
364         }
365         thread-&gt;osthread()-&gt;clear_expanding_stack();
366       } else {
367         fatal(&quot;recursive segv. expanding stack.&quot;);
368       }
369     }
370   }
371   return false;
372 }
373 
374 inline static bool checkPollingPage(address pc, address fault, address* stub) {
375   if (os::is_poll_address(fault)) {
376     *stub = SharedRuntime::get_poll_stub(pc);
377     return true;
378   }
379   return false;
380 }
381 
382 inline static bool checkByteBuffer(address pc, address npc, JavaThread * thread, address* stub) {
383   // BugId 4454115: A read from a MappedByteBuffer can fault
384   // here if the underlying file has been truncated.
385   // Do not crash the VM in such a case.
386   CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
387   CompiledMethod* nm = cb-&gt;as_compiled_method_or_null();
388   if (nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) {
389     *stub = SharedRuntime::handle_unsafe_access(thread, npc);
390     return true;
391   }
392   return false;
393 }
394 
395 inline static bool checkVerifyOops(address pc, address fault, address* stub) {
396   if (pc &gt;= MacroAssembler::_verify_oop_implicit_branch[0]
397       &amp;&amp; pc &lt;  MacroAssembler::_verify_oop_implicit_branch[1] ) {
398     *stub     =  MacroAssembler::_verify_oop_implicit_branch[2];
399     warning(&quot;fixed up memory fault in +VerifyOops at address &quot;
400             INTPTR_FORMAT, p2i(fault));
401     return true;
402   }
403   return false;
404 }
405 
406 inline static bool checkFPFault(address pc, int code,
407                                 JavaThread* thread, address* stub) {
408   if (code == FPE_INTDIV || code == FPE_FLTDIV) {
409     *stub =
410       SharedRuntime::
411       continuation_for_implicit_exception(thread,
412                                           pc,
413                                           SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
414     return true;
415   }
416   return false;
417 }
418 
419 inline static bool checkNullPointer(address pc, void* fault,
420                                     JavaThread* thread, address* stub) {
421   if (MacroAssembler::uses_implicit_null_check(fault)) {
422     // Determination of interpreter/vtable stub/compiled code null
423     // exception
424     *stub =
425       SharedRuntime::
426       continuation_for_implicit_exception(thread, pc,
427                                           SharedRuntime::IMPLICIT_NULL);
428     return true;
429   }
430   return false;
431 }
432 
433 inline static bool checkFastJNIAccess(address pc, address* stub) {
434   address addr = JNI_FastGetField::find_slowcase_pc(pc);
435   if (addr != (address)-1) {
436     *stub = addr;
437     return true;
438   }
439   return false;
440 }
441 
442 inline static bool checkZombie(sigcontext* uc, address* pc, address* stub) {
443   if (nativeInstruction_at(*pc)-&gt;is_zombie()) {
444     // zombie method (ld [%g0],%o7 instruction)
445     *stub = SharedRuntime::get_handle_wrong_method_stub();
446 
447     // At the stub it needs to look like a call from the caller of this
448     // method (not a call from the segv site).
449     *pc = (address)SIG_REGS(uc).u_regs[CON_O7];
450     return true;
451   }
452   return false;
453 }
454 
455 inline static bool checkICMiss(sigcontext* uc, address* pc, address* stub) {
456 #ifdef COMPILER2
457   if (nativeInstruction_at(*pc)-&gt;is_ic_miss_trap()) {
458 #ifdef ASSERT
459 #ifdef TIERED
460     CodeBlob* cb = CodeCache::find_blob_unsafe(*pc);
461     assert(cb-&gt;is_compiled_by_c2(), &quot;Wrong compiler&quot;);
462 #endif // TIERED
463 #endif // ASSERT
464     // Inline cache missed and user trap &quot;Tne G0+ST_RESERVED_FOR_USER_0+2&quot; taken.
465     *stub = SharedRuntime::get_ic_miss_stub();
466     // At the stub it needs to look like a call from the caller of this
467     // method (not a call from the segv site).
468     *pc = (address)SIG_REGS(uc).u_regs[CON_O7];
469     return true;
470   }
471 #endif  // COMPILER2
472   return false;
473 }
474 
475 extern &quot;C&quot; JNIEXPORT int
476 JVM_handle_linux_signal(int sig,
477                         siginfo_t* info,
478                         void* ucVoid,
479                         int abort_if_unrecognized) {
480   // in fact this isn&#39;t ucontext_t* at all, but struct sigcontext*
481   // but Linux porting layer uses ucontext_t, so to minimize code change
482   // we cast as needed
483   ucontext_t* ucFake = (ucontext_t*) ucVoid;
484   sigcontext* uc = (sigcontext*)ucVoid;
485 
486   Thread* t = Thread::current_or_null_safe();
487 
488   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
489   // (no destructors can be run)
490   os::ThreadCrashProtection::check_crash_protection(sig, t);
491 
492   SignalHandlerMark shm(t);
493 
494   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
495   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
496   // or have a SIGILL handler when detecting CPU type). When that happens,
497   // JVM_handle_linux_signal() might be invoked with junk info/ucVoid. To
498   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
499   // that do not require siginfo/ucontext first.
500 
501   if (sig == SIGPIPE || sig == SIGXFSZ) {
502     // allow chained handler to go first
503     if (os::Linux::chained_handler(sig, info, ucVoid)) {
504       return true;
505     } else {
506       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
507       return true;
508     }
509   }
510 
511 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
512   if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; info != NULL &amp;&amp; info-&gt;si_addr == g_assert_poison) {
513     handle_assert_poison_fault(ucVoid, info-&gt;si_addr);
514     return 1;
515   }
516 #endif
517 
518   JavaThread* thread = NULL;
519   VMThread* vmthread = NULL;
520   if (os::Linux::signal_handlers_are_installed) {
521     if (t != NULL ){
522       if(t-&gt;is_Java_thread()) {
523         thread = (JavaThread*)t;
524       }
525       else if(t-&gt;is_VM_thread()){
526         vmthread = (VMThread *)t;
527       }
528     }
529   }
530 
531   // decide if this trap can be handled by a stub
532   address stub = NULL;
533   address pc = NULL;
534   address npc = NULL;
535 
536   //%note os_trap_1
537   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
538     pc = address(SIG_PC(uc));
539     npc = address(SIG_NPC(uc));
540 
541     if (checkPrefetch(uc, pc)) {
542       return 1;
543     }
544 
545     // Handle ALL stack overflow variations here
546     if (sig == SIGSEGV) {
547       if (checkOverflow(uc, pc, (address)info-&gt;si_addr, thread, &amp;stub)) {
548         return 1;
549       }
550     }
551 
552     if (sig == SIGBUS &amp;&amp;
553         thread-&gt;thread_state() == _thread_in_vm &amp;&amp;
554         thread-&gt;doing_unsafe_access()) {
555       stub = SharedRuntime::handle_unsafe_access(thread, npc);
556     }
557 
558     if (thread-&gt;thread_state() == _thread_in_Java) {
559       do {
560         // Java thread running in Java code =&gt; find exception handler if any
561         // a fault inside compiled code, the interpreter, or a stub
562 
563         if ((sig == SIGSEGV) &amp;&amp; checkPollingPage(pc, (address)info-&gt;si_addr, &amp;stub)) {
564           break;
565         }
566 
567         if ((sig == SIGBUS) &amp;&amp; checkByteBuffer(pc, npc, thread, &amp;stub)) {
568           break;
569         }
570 
571         if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
572             checkVerifyOops(pc, (address)info-&gt;si_addr, &amp;stub)) {
573           break;
574         }
575 
576         if ((sig == SIGSEGV) &amp;&amp; checkZombie(uc, &amp;pc, &amp;stub)) {
577           break;
578         }
579 
580         if ((sig == SIGILL) &amp;&amp; checkICMiss(uc, &amp;pc, &amp;stub)) {
581           break;
582         }
583 
584         if ((sig == SIGFPE) &amp;&amp; checkFPFault(pc, info-&gt;si_code, thread, &amp;stub)) {
585           break;
586         }
587 
588         if ((sig == SIGSEGV) &amp;&amp;
589             checkNullPointer(pc, info-&gt;si_addr, thread, &amp;stub)) {
590           break;
591         }
592       } while (0);
593 
594       // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
595       // and the heap gets shrunk before the field access.
596       if ((sig == SIGSEGV) || (sig == SIGBUS)) {
597         checkFastJNIAccess(pc, &amp;stub);
598       }
599     }
600 
601     if (stub != NULL) {
602       // save all thread context in case we need to restore it
603       thread-&gt;set_saved_exception_pc(pc);
604       thread-&gt;set_saved_exception_npc(npc);
605       os::Linux::ucontext_set_pc((ucontext_t*)uc, stub);
606       return true;
607     }
608   }
609 
610   // signal-chaining
611   if (os::Linux::chained_handler(sig, info, ucVoid)) {
612     return true;
613   }
614 
615   if (!abort_if_unrecognized) {
616     // caller wants another chance, so give it to him
617     return false;
618   }
619 
620   if (pc == NULL &amp;&amp; uc != NULL) {
621     pc = os::Linux::ucontext_get_pc((const ucontext_t*)uc);
622   }
623 
624   // unmask current signal
625   sigset_t newset;
626   sigemptyset(&amp;newset);
627   sigaddset(&amp;newset, sig);
628   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
629 
630   VMError::report_and_die(t, sig, pc, info, ucVoid);
631 
632   ShouldNotReachHere();
633   return false;
634 }
635 
636 void os::Linux::init_thread_fpu_state(void) {
637   // Nothing to do
638 }
639 
640 int os::Linux::get_fpu_control_word() {
641   return 0;
642 }
643 
644 void os::Linux::set_fpu_control_word(int fpu) {
645   // nothing
646 }
647 
648 bool os::is_allocatable(size_t bytes) {
649   return true;
650 }
651 
652 ///////////////////////////////////////////////////////////////////////////////
653 // thread stack
654 
655 // Minimum usable stack sizes required to get to user code. Space for
656 // HotSpot guard pages is added later.
657 size_t os::Posix::_compiler_thread_min_stack_allowed = 64 * K;
658 size_t os::Posix::_java_thread_min_stack_allowed = 64 * K;
659 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 128 * K;
660 
661 // return default stack size for thr_type
662 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
663   // default stack size (compiler thread needs larger stack)
664   size_t s = (thr_type == os::compiler_thread ? 4 * M : 1 * M);
665   return s;
666 }
667 
668 #ifndef PRODUCT
669 void os::verify_stack_alignment() {
670 }
671 #endif
672 
673 int os::extra_bang_size_in_bytes() {
674   // SPARC does not require the additional stack bang.
675   return 0;
676 }
    </pre>
  </body>
</html>