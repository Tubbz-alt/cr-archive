<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os_cpu/bsd_x86/os_bsd_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;asm/macroAssembler.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/icBuffer.hpp&quot;
  33 #include &quot;code/vtableStubs.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;memory/allocation.inline.hpp&quot;
  37 #include &quot;os_share_bsd.hpp&quot;
  38 #include &quot;prims/jniFastGetField.hpp&quot;
  39 #include &quot;prims/jvm_misc.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/extendedPC.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  44 #include &quot;runtime/java.hpp&quot;
  45 #include &quot;runtime/javaCalls.hpp&quot;
  46 #include &quot;runtime/mutexLocker.hpp&quot;
  47 #include &quot;runtime/osThread.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/thread.inline.hpp&quot;
  51 #include &quot;runtime/timer.hpp&quot;
  52 #include &quot;utilities/align.hpp&quot;
  53 #include &quot;utilities/events.hpp&quot;
  54 #include &quot;utilities/vmError.hpp&quot;
  55 
  56 // put OS-includes here
  57 # include &lt;sys/types.h&gt;
  58 # include &lt;sys/mman.h&gt;
  59 # include &lt;pthread.h&gt;
  60 # include &lt;signal.h&gt;
  61 # include &lt;errno.h&gt;
  62 # include &lt;dlfcn.h&gt;
  63 # include &lt;stdlib.h&gt;
  64 # include &lt;stdio.h&gt;
  65 # include &lt;unistd.h&gt;
  66 # include &lt;sys/resource.h&gt;
  67 # include &lt;pthread.h&gt;
  68 # include &lt;sys/stat.h&gt;
  69 # include &lt;sys/time.h&gt;
  70 # include &lt;sys/utsname.h&gt;
  71 # include &lt;sys/socket.h&gt;
  72 # include &lt;sys/wait.h&gt;
  73 # include &lt;pwd.h&gt;
  74 # include &lt;poll.h&gt;
  75 #ifndef __OpenBSD__
  76 # include &lt;ucontext.h&gt;
  77 #endif
  78 
  79 #if !defined(__APPLE__) &amp;&amp; !defined(__NetBSD__)
  80 # include &lt;pthread_np.h&gt;
  81 #endif
  82 
  83 // needed by current_stack_region() workaround for Mavericks
  84 #if defined(__APPLE__)
  85 # include &lt;errno.h&gt;
  86 # include &lt;sys/types.h&gt;
  87 # include &lt;sys/sysctl.h&gt;
  88 # define DEFAULT_MAIN_THREAD_STACK_PAGES 2048
  89 # define OS_X_10_9_0_KERNEL_MAJOR_VERSION 13
  90 #endif
  91 
  92 #ifdef AMD64
  93 #define SPELL_REG_SP &quot;rsp&quot;
  94 #define SPELL_REG_FP &quot;rbp&quot;
  95 #else
  96 #define SPELL_REG_SP &quot;esp&quot;
  97 #define SPELL_REG_FP &quot;ebp&quot;
  98 #endif // AMD64
  99 
 100 #ifdef __FreeBSD__
 101 # define context_trapno uc_mcontext.mc_trapno
 102 # ifdef AMD64
 103 #  define context_pc uc_mcontext.mc_rip
 104 #  define context_sp uc_mcontext.mc_rsp
 105 #  define context_fp uc_mcontext.mc_rbp
 106 #  define context_rip uc_mcontext.mc_rip
 107 #  define context_rsp uc_mcontext.mc_rsp
 108 #  define context_rbp uc_mcontext.mc_rbp
 109 #  define context_rax uc_mcontext.mc_rax
 110 #  define context_rbx uc_mcontext.mc_rbx
 111 #  define context_rcx uc_mcontext.mc_rcx
 112 #  define context_rdx uc_mcontext.mc_rdx
 113 #  define context_rsi uc_mcontext.mc_rsi
 114 #  define context_rdi uc_mcontext.mc_rdi
 115 #  define context_r8  uc_mcontext.mc_r8
 116 #  define context_r9  uc_mcontext.mc_r9
 117 #  define context_r10 uc_mcontext.mc_r10
 118 #  define context_r11 uc_mcontext.mc_r11
 119 #  define context_r12 uc_mcontext.mc_r12
 120 #  define context_r13 uc_mcontext.mc_r13
 121 #  define context_r14 uc_mcontext.mc_r14
 122 #  define context_r15 uc_mcontext.mc_r15
 123 #  define context_flags uc_mcontext.mc_flags
 124 #  define context_err uc_mcontext.mc_err
 125 # else
 126 #  define context_pc uc_mcontext.mc_eip
 127 #  define context_sp uc_mcontext.mc_esp
 128 #  define context_fp uc_mcontext.mc_ebp
 129 #  define context_eip uc_mcontext.mc_eip
 130 #  define context_esp uc_mcontext.mc_esp
 131 #  define context_eax uc_mcontext.mc_eax
 132 #  define context_ebx uc_mcontext.mc_ebx
 133 #  define context_ecx uc_mcontext.mc_ecx
 134 #  define context_edx uc_mcontext.mc_edx
 135 #  define context_ebp uc_mcontext.mc_ebp
 136 #  define context_esi uc_mcontext.mc_esi
 137 #  define context_edi uc_mcontext.mc_edi
 138 #  define context_eflags uc_mcontext.mc_eflags
 139 #  define context_trapno uc_mcontext.mc_trapno
 140 # endif
 141 #endif
 142 
 143 #ifdef __APPLE__
 144 # if __DARWIN_UNIX03 &amp;&amp; (MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_5)
 145   // 10.5 UNIX03 member name prefixes
 146   #define DU3_PREFIX(s, m) __ ## s.__ ## m
 147 # else
 148   #define DU3_PREFIX(s, m) s ## . ## m
 149 # endif
 150 
 151 # ifdef AMD64
 152 #  define context_pc context_rip
 153 #  define context_sp context_rsp
 154 #  define context_fp context_rbp
 155 #  define context_rip uc_mcontext-&gt;DU3_PREFIX(ss,rip)
 156 #  define context_rsp uc_mcontext-&gt;DU3_PREFIX(ss,rsp)
 157 #  define context_rax uc_mcontext-&gt;DU3_PREFIX(ss,rax)
 158 #  define context_rbx uc_mcontext-&gt;DU3_PREFIX(ss,rbx)
 159 #  define context_rcx uc_mcontext-&gt;DU3_PREFIX(ss,rcx)
 160 #  define context_rdx uc_mcontext-&gt;DU3_PREFIX(ss,rdx)
 161 #  define context_rbp uc_mcontext-&gt;DU3_PREFIX(ss,rbp)
 162 #  define context_rsi uc_mcontext-&gt;DU3_PREFIX(ss,rsi)
 163 #  define context_rdi uc_mcontext-&gt;DU3_PREFIX(ss,rdi)
 164 #  define context_r8  uc_mcontext-&gt;DU3_PREFIX(ss,r8)
 165 #  define context_r9  uc_mcontext-&gt;DU3_PREFIX(ss,r9)
 166 #  define context_r10 uc_mcontext-&gt;DU3_PREFIX(ss,r10)
 167 #  define context_r11 uc_mcontext-&gt;DU3_PREFIX(ss,r11)
 168 #  define context_r12 uc_mcontext-&gt;DU3_PREFIX(ss,r12)
 169 #  define context_r13 uc_mcontext-&gt;DU3_PREFIX(ss,r13)
 170 #  define context_r14 uc_mcontext-&gt;DU3_PREFIX(ss,r14)
 171 #  define context_r15 uc_mcontext-&gt;DU3_PREFIX(ss,r15)
 172 #  define context_flags uc_mcontext-&gt;DU3_PREFIX(ss,rflags)
 173 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 174 #  define context_err uc_mcontext-&gt;DU3_PREFIX(es,err)
 175 # else
 176 #  define context_pc context_eip
 177 #  define context_sp context_esp
 178 #  define context_fp context_ebp
 179 #  define context_eip uc_mcontext-&gt;DU3_PREFIX(ss,eip)
 180 #  define context_esp uc_mcontext-&gt;DU3_PREFIX(ss,esp)
 181 #  define context_eax uc_mcontext-&gt;DU3_PREFIX(ss,eax)
 182 #  define context_ebx uc_mcontext-&gt;DU3_PREFIX(ss,ebx)
 183 #  define context_ecx uc_mcontext-&gt;DU3_PREFIX(ss,ecx)
 184 #  define context_edx uc_mcontext-&gt;DU3_PREFIX(ss,edx)
 185 #  define context_ebp uc_mcontext-&gt;DU3_PREFIX(ss,ebp)
 186 #  define context_esi uc_mcontext-&gt;DU3_PREFIX(ss,esi)
 187 #  define context_edi uc_mcontext-&gt;DU3_PREFIX(ss,edi)
 188 #  define context_eflags uc_mcontext-&gt;DU3_PREFIX(ss,eflags)
 189 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 190 # endif
 191 #endif
 192 
 193 #ifdef __OpenBSD__
 194 # define context_trapno sc_trapno
 195 # ifdef AMD64
 196 #  define context_pc sc_rip
 197 #  define context_sp sc_rsp
 198 #  define context_fp sc_rbp
 199 #  define context_rip sc_rip
 200 #  define context_rsp sc_rsp
 201 #  define context_rbp sc_rbp
 202 #  define context_rax sc_rax
 203 #  define context_rbx sc_rbx
 204 #  define context_rcx sc_rcx
 205 #  define context_rdx sc_rdx
 206 #  define context_rsi sc_rsi
 207 #  define context_rdi sc_rdi
 208 #  define context_r8  sc_r8
 209 #  define context_r9  sc_r9
 210 #  define context_r10 sc_r10
 211 #  define context_r11 sc_r11
 212 #  define context_r12 sc_r12
 213 #  define context_r13 sc_r13
 214 #  define context_r14 sc_r14
 215 #  define context_r15 sc_r15
 216 #  define context_flags sc_rflags
 217 #  define context_err sc_err
 218 # else
 219 #  define context_pc sc_eip
 220 #  define context_sp sc_esp
 221 #  define context_fp sc_ebp
 222 #  define context_eip sc_eip
 223 #  define context_esp sc_esp
 224 #  define context_eax sc_eax
 225 #  define context_ebx sc_ebx
 226 #  define context_ecx sc_ecx
 227 #  define context_edx sc_edx
 228 #  define context_ebp sc_ebp
 229 #  define context_esi sc_esi
 230 #  define context_edi sc_edi
 231 #  define context_eflags sc_eflags
 232 #  define context_trapno sc_trapno
 233 # endif
 234 #endif
 235 
 236 #ifdef __NetBSD__
 237 # define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 238 # ifdef AMD64
 239 #  define __register_t __greg_t
 240 #  define context_pc uc_mcontext.__gregs[_REG_RIP]
 241 #  define context_sp uc_mcontext.__gregs[_REG_URSP]
 242 #  define context_fp uc_mcontext.__gregs[_REG_RBP]
 243 #  define context_rip uc_mcontext.__gregs[_REG_RIP]
 244 #  define context_rsp uc_mcontext.__gregs[_REG_URSP]
 245 #  define context_rax uc_mcontext.__gregs[_REG_RAX]
 246 #  define context_rbx uc_mcontext.__gregs[_REG_RBX]
 247 #  define context_rcx uc_mcontext.__gregs[_REG_RCX]
 248 #  define context_rdx uc_mcontext.__gregs[_REG_RDX]
 249 #  define context_rbp uc_mcontext.__gregs[_REG_RBP]
 250 #  define context_rsi uc_mcontext.__gregs[_REG_RSI]
 251 #  define context_rdi uc_mcontext.__gregs[_REG_RDI]
 252 #  define context_r8  uc_mcontext.__gregs[_REG_R8]
 253 #  define context_r9  uc_mcontext.__gregs[_REG_R9]
 254 #  define context_r10 uc_mcontext.__gregs[_REG_R10]
 255 #  define context_r11 uc_mcontext.__gregs[_REG_R11]
 256 #  define context_r12 uc_mcontext.__gregs[_REG_R12]
 257 #  define context_r13 uc_mcontext.__gregs[_REG_R13]
 258 #  define context_r14 uc_mcontext.__gregs[_REG_R14]
 259 #  define context_r15 uc_mcontext.__gregs[_REG_R15]
 260 #  define context_flags uc_mcontext.__gregs[_REG_RFL]
 261 #  define context_err uc_mcontext.__gregs[_REG_ERR]
 262 # else
 263 #  define context_pc uc_mcontext.__gregs[_REG_EIP]
 264 #  define context_sp uc_mcontext.__gregs[_REG_UESP]
 265 #  define context_fp uc_mcontext.__gregs[_REG_EBP]
 266 #  define context_eip uc_mcontext.__gregs[_REG_EIP]
 267 #  define context_esp uc_mcontext.__gregs[_REG_UESP]
 268 #  define context_eax uc_mcontext.__gregs[_REG_EAX]
 269 #  define context_ebx uc_mcontext.__gregs[_REG_EBX]
 270 #  define context_ecx uc_mcontext.__gregs[_REG_ECX]
 271 #  define context_edx uc_mcontext.__gregs[_REG_EDX]
 272 #  define context_ebp uc_mcontext.__gregs[_REG_EBP]
 273 #  define context_esi uc_mcontext.__gregs[_REG_ESI]
 274 #  define context_edi uc_mcontext.__gregs[_REG_EDI]
 275 #  define context_eflags uc_mcontext.__gregs[_REG_EFL]
 276 #  define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 277 # endif
 278 #endif
 279 
 280 address os::current_stack_pointer() {
 281 #if defined(__clang__) || defined(__llvm__)
 282   void *esp;
 283   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));
 284   return (address) esp;
 285 #elif defined(SPARC_WORKS)
 286   void *esp;
 287   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));
 288   return (address) ((char*)esp + sizeof(long)*2);
 289 #else
 290   register void *esp __asm__ (SPELL_REG_SP);
 291   return (address) esp;
 292 #endif
 293 }
 294 
 295 char* os::non_memory_address_word() {
 296   // Must never look like an address returned by reserve_memory,
 297   // even in its subfields (as defined by the CPU immediate fields,
 298   // if the CPU splits constants across multiple instructions).
 299 
 300   return (char*) -1;
 301 }
 302 
 303 address os::Bsd::ucontext_get_pc(const ucontext_t * uc) {
 304   return (address)uc-&gt;context_pc;
 305 }
 306 
 307 void os::Bsd::ucontext_set_pc(ucontext_t * uc, address pc) {
 308   uc-&gt;context_pc = (intptr_t)pc ;
 309 }
 310 
 311 intptr_t* os::Bsd::ucontext_get_sp(const ucontext_t * uc) {
 312   return (intptr_t*)uc-&gt;context_sp;
 313 }
 314 
 315 intptr_t* os::Bsd::ucontext_get_fp(const ucontext_t * uc) {
 316   return (intptr_t*)uc-&gt;context_fp;
 317 }
 318 
 319 // For Forte Analyzer AsyncGetCallTrace profiling support - thread
 320 // is currently interrupted by SIGPROF.
 321 // os::Solaris::fetch_frame_from_ucontext() tries to skip nested signal
 322 // frames. Currently we don&#39;t do that on Bsd, so it&#39;s the same as
 323 // os::fetch_frame_from_context().
 324 // This method is also used for stack overflow signal handling.
 325 ExtendedPC os::Bsd::fetch_frame_from_ucontext(Thread* thread,
 326   const ucontext_t* uc, intptr_t** ret_sp, intptr_t** ret_fp) {
 327 
 328   assert(thread != NULL, &quot;just checking&quot;);
 329   assert(ret_sp != NULL, &quot;just checking&quot;);
 330   assert(ret_fp != NULL, &quot;just checking&quot;);
 331 
 332   return os::fetch_frame_from_context(uc, ret_sp, ret_fp);
 333 }
 334 
 335 ExtendedPC os::fetch_frame_from_context(const void* ucVoid,
 336                     intptr_t** ret_sp, intptr_t** ret_fp) {
 337 
 338   ExtendedPC  epc;
 339   const ucontext_t* uc = (const ucontext_t*)ucVoid;
 340 
 341   if (uc != NULL) {
 342     epc = ExtendedPC(os::Bsd::ucontext_get_pc(uc));
 343     if (ret_sp) *ret_sp = os::Bsd::ucontext_get_sp(uc);
 344     if (ret_fp) *ret_fp = os::Bsd::ucontext_get_fp(uc);
 345   } else {
 346     // construct empty ExtendedPC for return value checking
 347     epc = ExtendedPC(NULL);
 348     if (ret_sp) *ret_sp = (intptr_t *)NULL;
 349     if (ret_fp) *ret_fp = (intptr_t *)NULL;
 350   }
 351 
 352   return epc;
 353 }
 354 
 355 frame os::fetch_frame_from_context(const void* ucVoid) {
 356   intptr_t* sp;
 357   intptr_t* fp;
 358   ExtendedPC epc = fetch_frame_from_context(ucVoid, &amp;sp, &amp;fp);
 359   return frame(sp, fp, epc.pc());
 360 }
 361 
 362 frame os::fetch_frame_from_ucontext(Thread* thread, void* ucVoid) {
 363   intptr_t* sp;
 364   intptr_t* fp;
 365   ExtendedPC epc = os::Bsd::fetch_frame_from_ucontext(thread, (ucontext_t*)ucVoid, &amp;sp, &amp;fp);
 366   return frame(sp, fp, epc.pc());
 367 }
 368 
 369 bool os::Bsd::get_frame_at_stack_banging_point(JavaThread* thread, ucontext_t* uc, frame* fr) {
 370   address pc = (address) os::Bsd::ucontext_get_pc(uc);
 371   if (Interpreter::contains(pc)) {
 372     // interpreter performs stack banging after the fixed frame header has
 373     // been generated while the compilers perform it before. To maintain
 374     // semantic consistency between interpreted and compiled frames, the
 375     // method returns the Java sender of the current frame.
 376     *fr = os::fetch_frame_from_ucontext(thread, uc);
 377     if (!fr-&gt;is_first_java_frame()) {
 378       // get_frame_at_stack_banging_point() is only called when we
 379       // have well defined stacks so java_sender() calls do not need
 380       // to assert safe_for_sender() first.
 381       *fr = fr-&gt;java_sender();
 382     }
 383   } else {
 384     // more complex code with compiled code
 385     assert(!Interpreter::contains(pc), &quot;Interpreted methods should have been handled above&quot;);
 386     CodeBlob* cb = CodeCache::find_blob(pc);
 387     if (cb == NULL || !cb-&gt;is_nmethod() || cb-&gt;is_frame_complete_at(pc)) {
 388       // Not sure where the pc points to, fallback to default
 389       // stack overflow handling
 390       return false;
 391     } else {
 392       *fr = os::fetch_frame_from_ucontext(thread, uc);
 393       // in compiled code, the stack banging is performed just after the return pc
 394       // has been pushed on the stack
 395       *fr = frame(fr-&gt;sp() + 1, fr-&gt;fp(), (address)*(fr-&gt;sp()));
 396       if (!fr-&gt;is_java_frame()) {
 397         // See java_sender() comment above.
 398         *fr = fr-&gt;java_sender();
 399       }
 400     }
 401   }
 402   assert(fr-&gt;is_java_frame(), &quot;Safety check&quot;);
 403   return true;
 404 }
 405 
 406 // By default, gcc always save frame pointer (%ebp/%rbp) on stack. It may get
 407 // turned off by -fomit-frame-pointer,
 408 frame os::get_sender_for_C_frame(frame* fr) {
 409   return frame(fr-&gt;sender_sp(), fr-&gt;link(), fr-&gt;sender_pc());
 410 }
 411 
 412 intptr_t* _get_previous_fp() {
 413 #if defined(SPARC_WORKS) || defined(__clang__) || defined(__llvm__)
 414   intptr_t **ebp;
 415   __asm__(&quot;mov %%&quot; SPELL_REG_FP &quot;, %0&quot;:&quot;=r&quot;(ebp));
 416 #else
 417   register intptr_t **ebp __asm__ (SPELL_REG_FP);
 418 #endif
 419   // ebp is for this frame (_get_previous_fp). We want the ebp for the
 420   // caller of os::current_frame*(), so go up two frames. However, for
 421   // optimized builds, _get_previous_fp() will be inlined, so only go
 422   // up 1 frame in that case.
 423 #ifdef _NMT_NOINLINE_
 424   return **(intptr_t***)ebp;
 425 #else
 426   return *ebp;
 427 #endif
 428 }
 429 
 430 
 431 frame os::current_frame() {
 432   intptr_t* fp = _get_previous_fp();
 433   frame myframe((intptr_t*)os::current_stack_pointer(),
 434                 (intptr_t*)fp,
 435                 CAST_FROM_FN_PTR(address, os::current_frame));
 436   if (os::is_first_C_frame(&amp;myframe)) {
 437     // stack is not walkable
 438     return frame();
 439   } else {
 440     return os::get_sender_for_C_frame(&amp;myframe);
 441   }
 442 }
 443 
 444 // Utility functions
 445 
 446 // From IA32 System Programming Guide
 447 enum {
 448   trap_page_fault = 0xE
 449 };
 450 
 451 extern &quot;C&quot; JNIEXPORT int
 452 JVM_handle_bsd_signal(int sig,
 453                         siginfo_t* info,
 454                         void* ucVoid,
 455                         int abort_if_unrecognized) {
 456   ucontext_t* uc = (ucontext_t*) ucVoid;
 457 
 458   Thread* t = Thread::current_or_null_safe();
 459 
 460   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
 461   // (no destructors can be run)
 462   os::ThreadCrashProtection::check_crash_protection(sig, t);
 463 
 464   SignalHandlerMark shm(t);
 465 
 466   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
 467   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
 468   // or have a SIGILL handler when detecting CPU type). When that happens,
 469   // JVM_handle_bsd_signal() might be invoked with junk info/ucVoid. To
 470   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
 471   // that do not require siginfo/ucontext first.
 472 
 473   if (sig == SIGPIPE || sig == SIGXFSZ) {
 474     // allow chained handler to go first
 475     if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 476       return true;
 477     } else {
 478       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
 479       return true;
 480     }
 481   }
 482 
 483   JavaThread* thread = NULL;
 484   VMThread* vmthread = NULL;
 485   if (os::Bsd::signal_handlers_are_installed) {
 486     if (t != NULL ){
 487       if(t-&gt;is_Java_thread()) {
 488         thread = (JavaThread*)t;
 489       }
 490       else if(t-&gt;is_VM_thread()){
 491         vmthread = (VMThread *)t;
 492       }
 493     }
 494   }
 495 /*
 496   NOTE: does not seem to work on bsd.
 497   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
 498     // can&#39;t decode this kind of signal
 499     info = NULL;
 500   } else {
 501     assert(sig == info-&gt;si_signo, &quot;bad siginfo&quot;);
 502   }
 503 */
 504   // decide if this trap can be handled by a stub
 505   address stub = NULL;
 506 
 507   address pc          = NULL;
 508 
 509   //%note os_trap_1
 510   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
 511     pc = (address) os::Bsd::ucontext_get_pc(uc);
 512 
 513     if (StubRoutines::is_safefetch_fault(pc)) {
 514       os::Bsd::ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
 515       return 1;
 516     }
 517 
 518     // Handle ALL stack overflow variations here
 519     if (sig == SIGSEGV || sig == SIGBUS) {
 520       address addr = (address) info-&gt;si_addr;
 521 
 522       // check if fault address is within thread stack
 523       if (thread-&gt;on_local_stack(addr)) {
 524         // stack overflow
 525         if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
 526           if (thread-&gt;thread_state() == _thread_in_Java) {
 527             if (thread-&gt;in_stack_reserved_zone(addr)) {
 528               frame fr;
 529               if (os::Bsd::get_frame_at_stack_banging_point(thread, uc, &amp;fr)) {
 530                 assert(fr.is_java_frame(), &quot;Must be a Java frame&quot;);
 531                 frame activation = SharedRuntime::look_for_reserved_stack_annotated_method(thread, fr);
 532                 if (activation.sp() != NULL) {
 533                   thread-&gt;disable_stack_reserved_zone();
 534                   if (activation.is_interpreted_frame()) {
 535                     thread-&gt;set_reserved_stack_activation((address)(
 536                       activation.fp() + frame::interpreter_frame_initial_sp_offset));
 537                   } else {
 538                     thread-&gt;set_reserved_stack_activation((address)activation.unextended_sp());
 539                   }
 540                   return 1;
 541                 }
 542               }
 543             }
 544             // Throw a stack overflow exception.  Guard pages will be reenabled
 545             // while unwinding the stack.
 546             thread-&gt;disable_stack_yellow_reserved_zone();
 547             stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::STACK_OVERFLOW);
 548           } else {
 549             // Thread was in the vm or native code.  Return and try to finish.
 550             thread-&gt;disable_stack_yellow_reserved_zone();
 551             return 1;
 552           }
 553         } else if (thread-&gt;in_stack_red_zone(addr)) {
 554           // Fatal red zone violation.  Disable the guard pages and fall through
 555           // to handle_unexpected_exception way down below.
 556           thread-&gt;disable_stack_red_zone();
 557           tty-&gt;print_raw_cr(&quot;An irrecoverable stack overflow has occurred.&quot;);
 558         }
 559       }
 560     }
 561 
 562     if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
 563       // Verify that OS save/restore AVX registers.
 564       stub = VM_Version::cpuinfo_cont_addr();
 565     }
 566 
 567     // We test if stub is already set (by the stack overflow code
 568     // above) so it is not overwritten by the code that follows. This
 569     // check is not required on other platforms, because on other
 570     // platforms we check for SIGSEGV only or SIGBUS only, where here
 571     // we have to check for both SIGSEGV and SIGBUS.
 572     if (thread-&gt;thread_state() == _thread_in_Java &amp;&amp; stub == NULL) {
 573       // Java thread running in Java code =&gt; find exception handler if any
 574       // a fault inside compiled code, the interpreter, or a stub
 575 
 576       if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; os::is_poll_address((address)info-&gt;si_addr)) {
 577         stub = SharedRuntime::get_poll_stub(pc);
 578 #if defined(__APPLE__)
 579       // 32-bit Darwin reports a SIGBUS for nearly all memory access exceptions.
 580       // 64-bit Darwin may also use a SIGBUS (seen with compressed oops).
 581       // Catching SIGBUS here prevents the implicit SIGBUS NULL check below from
 582       // being called, so only do so if the implicit NULL check is not necessary.
 583       } else if (sig == SIGBUS &amp;&amp; !MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 584 #else
 585       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
 586 #endif
 587         // BugId 4454115: A read from a MappedByteBuffer can fault
 588         // here if the underlying file has been truncated.
 589         // Do not crash the VM in such a case.
 590         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
 591         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
 592         if (nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) {
 593           address next_pc = Assembler::locate_next_instruction(pc);
 594           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 595         }
 596       }
 597       else
 598 
 599 #ifdef AMD64
 600       if (sig == SIGFPE  &amp;&amp;
 601           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
 602         stub =
 603           SharedRuntime::
 604           continuation_for_implicit_exception(thread,
 605                                               pc,
 606                                               SharedRuntime::
 607                                               IMPLICIT_DIVIDE_BY_ZERO);
 608 #ifdef __APPLE__
 609       } else if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_NOOP) {
 610         int op = pc[0];
 611 
 612         // Skip REX
 613         if ((pc[0] &amp; 0xf0) == 0x40) {
 614           op = pc[1];
 615         } else {
 616           op = pc[0];
 617         }
 618 
 619         // Check for IDIV
 620         if (op == 0xF7) {
 621           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime:: IMPLICIT_DIVIDE_BY_ZERO);
 622         } else {
 623           // TODO: handle more cases if we are using other x86 instructions
 624           //   that can generate SIGFPE signal.
 625           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 626           fatal(&quot;please update this code.&quot;);
 627         }
 628 #endif /* __APPLE__ */
 629 
 630 #else
 631       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
 632         // HACK: si_code does not work on bsd 2.2.12-20!!!
 633         int op = pc[0];
 634         if (op == 0xDB) {
 635           // FIST
 636           // TODO: The encoding of D2I in i486.ad can cause an exception
 637           // prior to the fist instruction if there was an invalid operation
 638           // pending. We want to dismiss that exception. From the win_32
 639           // side it also seems that if it really was the fist causing
 640           // the exception that we do the d2i by hand with different
 641           // rounding. Seems kind of weird.
 642           // NOTE: that we take the exception at the NEXT floating point instruction.
 643           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
 644           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
 645           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
 646           return true;
 647         } else if (op == 0xF7) {
 648           // IDIV
 649           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
 650         } else {
 651           // TODO: handle more cases if we are using other x86 instructions
 652           //   that can generate SIGFPE signal on bsd.
 653           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 654           fatal(&quot;please update this code.&quot;);
 655         }
 656 #endif // AMD64
 657       } else if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 658                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 659           // Determination of interpreter/vtable stub/compiled code null exception
 660           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
 661       }
 662     } else if (thread-&gt;thread_state() == _thread_in_vm &amp;&amp;
 663                sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */
 664                thread-&gt;doing_unsafe_access()) {
 665         address next_pc = Assembler::locate_next_instruction(pc);
 666         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 667     }
 668 
 669     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
 670     // and the heap gets shrunk before the field access.
 671     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
 672       address addr = JNI_FastGetField::find_slowcase_pc(pc);
 673       if (addr != (address)-1) {
 674         stub = addr;
 675       }
 676     }
 677   }
 678 
 679 #ifndef AMD64
 680   // Execution protection violation
 681   //
 682   // This should be kept as the last step in the triage.  We don&#39;t
 683   // have a dedicated trap number for a no-execute fault, so be
 684   // conservative and allow other handlers the first shot.
 685   //
 686   // Note: We don&#39;t test that info-&gt;si_code == SEGV_ACCERR here.
 687   // this si_code is so generic that it is almost meaningless; and
 688   // the si_code for this condition may change in the future.
 689   // Furthermore, a false-positive should be harmless.
 690   if (UnguardOnExecutionViolation &gt; 0 &amp;&amp;
 691       (sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 692       uc-&gt;context_trapno == trap_page_fault) {
 693     int page_size = os::vm_page_size();
 694     address addr = (address) info-&gt;si_addr;
 695     address pc = os::Bsd::ucontext_get_pc(uc);
 696     // Make sure the pc and the faulting address are sane.
 697     //
 698     // If an instruction spans a page boundary, and the page containing
 699     // the beginning of the instruction is executable but the following
 700     // page is not, the pc and the faulting address might be slightly
 701     // different - we still want to unguard the 2nd page in this case.
 702     //
 703     // 15 bytes seems to be a (very) safe value for max instruction size.
 704     bool pc_is_near_addr =
 705       (pointer_delta((void*) addr, (void*) pc, sizeof(char)) &lt; 15);
 706     bool instr_spans_page_boundary =
 707       (align_down((intptr_t) pc ^ (intptr_t) addr,
 708                        (intptr_t) page_size) &gt; 0);
 709 
 710     if (pc == addr || (pc_is_near_addr &amp;&amp; instr_spans_page_boundary)) {
 711       static volatile address last_addr =
 712         (address) os::non_memory_address_word();
 713 
 714       // In conservative mode, don&#39;t unguard unless the address is in the VM
 715       if (addr != last_addr &amp;&amp;
 716           (UnguardOnExecutionViolation &gt; 1 || os::address_is_in_vm(addr))) {
 717 
 718         // Set memory to RWX and retry
 719         address page_start = align_down(addr, page_size);
 720         bool res = os::protect_memory((char*) page_start, page_size,
 721                                       os::MEM_PROT_RWX);
 722 
 723         log_debug(os)(&quot;Execution protection violation &quot;
 724                       &quot;at &quot; INTPTR_FORMAT
 725                       &quot;, unguarding &quot; INTPTR_FORMAT &quot;: %s, errno=%d&quot;, p2i(addr),
 726                       p2i(page_start), (res ? &quot;success&quot; : &quot;failed&quot;), errno);
 727         stub = pc;
 728 
 729         // Set last_addr so if we fault again at the same address, we don&#39;t end
 730         // up in an endless loop.
 731         //
 732         // There are two potential complications here.  Two threads trapping at
 733         // the same address at the same time could cause one of the threads to
 734         // think it already unguarded, and abort the VM.  Likely very rare.
 735         //
 736         // The other race involves two threads alternately trapping at
 737         // different addresses and failing to unguard the page, resulting in
 738         // an endless loop.  This condition is probably even more unlikely than
 739         // the first.
 740         //
 741         // Although both cases could be avoided by using locks or thread local
 742         // last_addr, these solutions are unnecessary complication: this
 743         // handler is a best-effort safety net, not a complete solution.  It is
 744         // disabled by default and should only be used as a workaround in case
 745         // we missed any no-execute-unsafe VM code.
 746 
 747         last_addr = addr;
 748       }
 749     }
 750   }
 751 #endif // !AMD64
 752 
 753   if (stub != NULL) {
 754     // save all thread context in case we need to restore it
 755     if (thread != NULL) thread-&gt;set_saved_exception_pc(pc);
 756 
 757     os::Bsd::ucontext_set_pc(uc, stub);
 758     return true;
 759   }
 760 
 761   // signal-chaining
 762   if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 763      return true;
 764   }
 765 
 766   if (!abort_if_unrecognized) {
 767     // caller wants another chance, so give it to him
 768     return false;
 769   }
 770 
 771   if (pc == NULL &amp;&amp; uc != NULL) {
 772     pc = os::Bsd::ucontext_get_pc(uc);
 773   }
 774 
 775   // unmask current signal
 776   sigset_t newset;
 777   sigemptyset(&amp;newset);
 778   sigaddset(&amp;newset, sig);
 779   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
 780 
 781   VMError::report_and_die(t, sig, pc, info, ucVoid);
 782 
 783   ShouldNotReachHere();
 784   return false;
 785 }
 786 
 787 // From solaris_i486.s ported to bsd_i486.s
 788 extern &quot;C&quot; void fixcw();
 789 
 790 void os::Bsd::init_thread_fpu_state(void) {
 791 #ifndef AMD64
 792   // Set fpu to 53 bit precision. This happens too early to use a stub.
 793   fixcw();
 794 #endif // !AMD64
 795 }
 796 
 797 
 798 // Check that the bsd kernel version is 2.4 or higher since earlier
 799 // versions do not support SSE without patches.
 800 bool os::supports_sse() {
 801   return true;
 802 }
 803 
 804 bool os::is_allocatable(size_t bytes) {
 805 #ifdef AMD64
 806   // unused on amd64?
 807   return true;
 808 #else
 809 
 810   if (bytes &lt; 2 * G) {
 811     return true;
 812   }
 813 
 814   char* addr = reserve_memory(bytes, NULL);
 815 
 816   if (addr != NULL) {
 817     release_memory(addr, bytes);
 818   }
 819 
 820   return addr != NULL;
 821 #endif // AMD64
 822 }
 823 
 824 ////////////////////////////////////////////////////////////////////////////////
 825 // thread stack
 826 
 827 // Minimum usable stack sizes required to get to user code. Space for
 828 // HotSpot guard pages is added later.
 829 size_t os::Posix::_compiler_thread_min_stack_allowed = 48 * K;
 830 size_t os::Posix::_java_thread_min_stack_allowed = 48 * K;
 831 #ifdef _LP64
 832 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 64 * K;
 833 #else
 834 size_t os::Posix::_vm_internal_thread_min_stack_allowed = (48 DEBUG_ONLY(+ 4)) * K;
 835 #endif // _LP64
 836 
 837 #ifndef AMD64
 838 #ifdef __GNUC__
 839 #define GET_GS() ({int gs; __asm__ volatile(&quot;movw %%gs, %w0&quot;:&quot;=q&quot;(gs)); gs&amp;0xffff;})
 840 #endif
 841 #endif // AMD64
 842 
 843 // return default stack size for thr_type
 844 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 845   // default stack size (compiler thread needs larger stack)
 846 #ifdef AMD64
 847   size_t s = (thr_type == os::compiler_thread ? 4 * M : 1 * M);
 848 #else
 849   size_t s = (thr_type == os::compiler_thread ? 2 * M : 512 * K);
 850 #endif // AMD64
 851   return s;
 852 }
 853 
 854 
 855 // Java thread:
 856 //
 857 //   Low memory addresses
 858 //    +------------------------+
 859 //    |                        |\  Java thread created by VM does not have glibc
 860 //    |    glibc guard page    | - guard, attached Java thread usually has
 861 //    |                        |/  1 glibc guard page.
 862 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 863 //    |                        |\
 864 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
 865 //    |                        |/
 866 //    +------------------------+ JavaThread::stack_reserved_zone_base()
 867 //    |                        |\
 868 //    |      Normal Stack      | -
 869 //    |                        |/
 870 // P2 +------------------------+ Thread::stack_base()
 871 //
 872 // Non-Java thread:
 873 //
 874 //   Low memory addresses
 875 //    +------------------------+
 876 //    |                        |\
 877 //    |  glibc guard page      | - usually 1 page
 878 //    |                        |/
 879 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 880 //    |                        |\
 881 //    |      Normal Stack      | -
 882 //    |                        |/
 883 // P2 +------------------------+ Thread::stack_base()
 884 //
 885 // ** P1 (aka bottom) and size ( P2 = P1 - size) are the address and stack size returned from
 886 //    pthread_attr_getstack()
 887 
 888 static void current_stack_region(address * bottom, size_t * size) {
 889 #ifdef __APPLE__
 890   pthread_t self = pthread_self();
 891   void *stacktop = pthread_get_stackaddr_np(self);
 892   *size = pthread_get_stacksize_np(self);
 893   // workaround for OS X 10.9.0 (Mavericks)
 894   // pthread_get_stacksize_np returns 128 pages even though the actual size is 2048 pages
 895   if (pthread_main_np() == 1) {
 896     // At least on Mac OS 10.12 we have observed stack sizes not aligned
 897     // to pages boundaries. This can be provoked by e.g. setrlimit() (ulimit -s xxxx in the
 898     // shell). Apparently Mac OS actually rounds upwards to next multiple of page size,
 899     // however, we round downwards here to be on the safe side.
 900     *size = align_down(*size, getpagesize());
 901 
 902     if ((*size) &lt; (DEFAULT_MAIN_THREAD_STACK_PAGES * (size_t)getpagesize())) {
 903       char kern_osrelease[256];
 904       size_t kern_osrelease_size = sizeof(kern_osrelease);
 905       int ret = sysctlbyname(&quot;kern.osrelease&quot;, kern_osrelease, &amp;kern_osrelease_size, NULL, 0);
 906       if (ret == 0) {
 907         // get the major number, atoi will ignore the minor amd micro portions of the version string
 908         if (atoi(kern_osrelease) &gt;= OS_X_10_9_0_KERNEL_MAJOR_VERSION) {
 909           *size = (DEFAULT_MAIN_THREAD_STACK_PAGES*getpagesize());
 910         }
 911       }
 912     }
 913   }
 914   *bottom = (address) stacktop - *size;
 915 #elif defined(__OpenBSD__)
 916   stack_t ss;
 917   int rslt = pthread_stackseg_np(pthread_self(), &amp;ss);
 918 
 919   if (rslt != 0)
 920     fatal(&quot;pthread_stackseg_np failed with error = %d&quot;, rslt);
 921 
 922   *bottom = (address)((char *)ss.ss_sp - ss.ss_size);
 923   *size   = ss.ss_size;
 924 #else
 925   pthread_attr_t attr;
 926 
 927   int rslt = pthread_attr_init(&amp;attr);
 928 
 929   // JVM needs to know exact stack location, abort if it fails
 930   if (rslt != 0)
 931     fatal(&quot;pthread_attr_init failed with error = %d&quot;, rslt);
 932 
 933   rslt = pthread_attr_get_np(pthread_self(), &amp;attr);
 934 
 935   if (rslt != 0)
 936     fatal(&quot;pthread_attr_get_np failed with error = %d&quot;, rslt);
 937 
 938   if (pthread_attr_getstackaddr(&amp;attr, (void **)bottom) != 0 ||
 939     pthread_attr_getstacksize(&amp;attr, size) != 0) {
 940     fatal(&quot;Can not locate current stack attributes!&quot;);
 941   }
 942 
 943   pthread_attr_destroy(&amp;attr);
 944 #endif
 945   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
 946          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
 947 }
 948 
 949 address os::current_stack_base() {
 950   address bottom;
 951   size_t size;
 952   current_stack_region(&amp;bottom, &amp;size);
 953   return (bottom + size);
 954 }
 955 
 956 size_t os::current_stack_size() {
 957   // stack size includes normal stack and HotSpot guard pages
 958   address bottom;
 959   size_t size;
 960   current_stack_region(&amp;bottom, &amp;size);
 961   return size;
 962 }
 963 
 964 /////////////////////////////////////////////////////////////////////////////
 965 // helper functions for fatal error handler
 966 
 967 void os::print_context(outputStream *st, const void *context) {
 968   if (context == NULL) return;
 969 
 970   const ucontext_t *uc = (const ucontext_t*)context;
 971   st-&gt;print_cr(&quot;Registers:&quot;);
 972 #ifdef AMD64
 973   st-&gt;print(  &quot;RAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rax);
 974   st-&gt;print(&quot;, RBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbx);
 975   st-&gt;print(&quot;, RCX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rcx);
 976   st-&gt;print(&quot;, RDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdx);
 977   st-&gt;cr();
 978   st-&gt;print(  &quot;RSP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsp);
 979   st-&gt;print(&quot;, RBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbp);
 980   st-&gt;print(&quot;, RSI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsi);
 981   st-&gt;print(&quot;, RDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdi);
 982   st-&gt;cr();
 983   st-&gt;print(  &quot;R8 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r8);
 984   st-&gt;print(&quot;, R9 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r9);
 985   st-&gt;print(&quot;, R10=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r10);
 986   st-&gt;print(&quot;, R11=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r11);
 987   st-&gt;cr();
 988   st-&gt;print(  &quot;R12=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r12);
 989   st-&gt;print(&quot;, R13=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r13);
 990   st-&gt;print(&quot;, R14=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r14);
 991   st-&gt;print(&quot;, R15=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r15);
 992   st-&gt;cr();
 993   st-&gt;print(  &quot;RIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rip);
 994   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_flags);
 995   st-&gt;print(&quot;, ERR=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_err);
 996   st-&gt;cr();
 997   st-&gt;print(&quot;  TRAPNO=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_trapno);
 998 #else
 999   st-&gt;print(  &quot;EAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eax);
1000   st-&gt;print(&quot;, EBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebx);
1001   st-&gt;print(&quot;, ECX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ecx);
1002   st-&gt;print(&quot;, EDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edx);
1003   st-&gt;cr();
1004   st-&gt;print(  &quot;ESP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esp);
1005   st-&gt;print(&quot;, EBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebp);
1006   st-&gt;print(&quot;, ESI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esi);
1007   st-&gt;print(&quot;, EDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edi);
1008   st-&gt;cr();
1009   st-&gt;print(  &quot;EIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eip);
1010   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eflags);
1011 #endif // AMD64
1012   st-&gt;cr();
1013   st-&gt;cr();
1014 
1015   intptr_t *sp = (intptr_t *)os::Bsd::ucontext_get_sp(uc);
1016   st-&gt;print_cr(&quot;Top of Stack: (sp=&quot; INTPTR_FORMAT &quot;)&quot;, (intptr_t)sp);
1017   print_hex_dump(st, (address)sp, (address)(sp + 8*sizeof(intptr_t)), sizeof(intptr_t));
1018   st-&gt;cr();
1019 
1020   // Note: it may be unsafe to inspect memory near pc. For example, pc may
1021   // point to garbage if entry point in an nmethod is corrupted. Leave
1022   // this at the end, and hope for the best.
1023   address pc = os::Bsd::ucontext_get_pc(uc);
1024   print_instructions(st, pc, sizeof(char));
1025   st-&gt;cr();
1026 }
1027 
1028 void os::print_register_info(outputStream *st, const void *context) {
1029   if (context == NULL) return;
1030 
1031   const ucontext_t *uc = (const ucontext_t*)context;
1032 
1033   st-&gt;print_cr(&quot;Register to memory mapping:&quot;);
1034   st-&gt;cr();
1035 
1036   // this is horrendously verbose but the layout of the registers in the
1037   // context does not match how we defined our abstract Register set, so
1038   // we can&#39;t just iterate through the gregs area
1039 
1040   // this is only for the &quot;general purpose&quot; registers
1041 
1042 #ifdef AMD64
1043   st-&gt;print(&quot;RAX=&quot;); print_location(st, uc-&gt;context_rax);
1044   st-&gt;print(&quot;RBX=&quot;); print_location(st, uc-&gt;context_rbx);
1045   st-&gt;print(&quot;RCX=&quot;); print_location(st, uc-&gt;context_rcx);
1046   st-&gt;print(&quot;RDX=&quot;); print_location(st, uc-&gt;context_rdx);
1047   st-&gt;print(&quot;RSP=&quot;); print_location(st, uc-&gt;context_rsp);
1048   st-&gt;print(&quot;RBP=&quot;); print_location(st, uc-&gt;context_rbp);
1049   st-&gt;print(&quot;RSI=&quot;); print_location(st, uc-&gt;context_rsi);
1050   st-&gt;print(&quot;RDI=&quot;); print_location(st, uc-&gt;context_rdi);
1051   st-&gt;print(&quot;R8 =&quot;); print_location(st, uc-&gt;context_r8);
1052   st-&gt;print(&quot;R9 =&quot;); print_location(st, uc-&gt;context_r9);
1053   st-&gt;print(&quot;R10=&quot;); print_location(st, uc-&gt;context_r10);
1054   st-&gt;print(&quot;R11=&quot;); print_location(st, uc-&gt;context_r11);
1055   st-&gt;print(&quot;R12=&quot;); print_location(st, uc-&gt;context_r12);
1056   st-&gt;print(&quot;R13=&quot;); print_location(st, uc-&gt;context_r13);
1057   st-&gt;print(&quot;R14=&quot;); print_location(st, uc-&gt;context_r14);
1058   st-&gt;print(&quot;R15=&quot;); print_location(st, uc-&gt;context_r15);
1059 #else
1060   st-&gt;print(&quot;EAX=&quot;); print_location(st, uc-&gt;context_eax);
1061   st-&gt;print(&quot;EBX=&quot;); print_location(st, uc-&gt;context_ebx);
1062   st-&gt;print(&quot;ECX=&quot;); print_location(st, uc-&gt;context_ecx);
1063   st-&gt;print(&quot;EDX=&quot;); print_location(st, uc-&gt;context_edx);
1064   st-&gt;print(&quot;ESP=&quot;); print_location(st, uc-&gt;context_esp);
1065   st-&gt;print(&quot;EBP=&quot;); print_location(st, uc-&gt;context_ebp);
1066   st-&gt;print(&quot;ESI=&quot;); print_location(st, uc-&gt;context_esi);
1067   st-&gt;print(&quot;EDI=&quot;); print_location(st, uc-&gt;context_edi);
1068 #endif // AMD64
1069 
1070   st-&gt;cr();
1071 }
1072 
1073 void os::setup_fpu() {
1074 #ifndef AMD64
1075   address fpu_cntrl = StubRoutines::addr_fpu_cntrl_wrd_std();
1076   __asm__ volatile (  &quot;fldcw (%0)&quot; :
1077                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
1078 #endif // !AMD64
1079 }
1080 
1081 #ifndef PRODUCT
1082 void os::verify_stack_alignment() {
1083 }
1084 #endif
1085 
1086 int os::extra_bang_size_in_bytes() {
1087   // JDK-8050147 requires the full cache line bang for x86.
1088   return VM_Version::L1_line_size();
1089 }
    </pre>
  </body>
</html>