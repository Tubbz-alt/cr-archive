<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.scripting.nashorn/share/classes/jdk/nashorn/internal/runtime/doubleconv/FixedDtoa.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BignumDtoa.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IeeeDouble.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.scripting.nashorn/share/classes/jdk/nashorn/internal/runtime/doubleconv/FixedDtoa.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
269                 if (fractionals == 0) break;
270                 // Instead of multiplying by 10 we multiply by 5 and adjust the point
271                 // location. This way the fractionals variable will not overflow.
272                 // Invariant at the beginning of the loop: fractionals &lt; 2^point.
273                 // Initially we have: point &lt;= 64 and fractionals &lt; 2^56
274                 // After each iteration the point is decremented by one.
275                 // Note that 5^3 = 125 &lt; 128 = 2^7.
276                 // Therefore three iterations of this loop will not overflow fractionals
277                 // (even without the subtraction at the end of the loop body). At this
278                 // time point will satisfy point &lt;= 61 and therefore fractionals &lt; 2^point
279                 // and any further multiplication of fractionals by 5 will not overflow.
280                 fractionals *= 5;
281                 point--;
282                 final int digit = (int) (fractionals &gt;&gt;&gt; point);
283                 assert (digit &lt;= 9);
284                 buffer.chars[buffer.length] = (char) (&#39;0&#39; + digit);
285                 buffer.length++;
286                 fractionals -= (long) (digit) &lt;&lt; point;
287             }
288             // If the first bit after the point is set we have to round up.
<span class="line-modified">289             if (((fractionals &gt;&gt;&gt; (point - 1)) &amp; 1) == 1) {</span>

290                 roundUp(buffer);
291             }
292         } else {  // We need 128 bits.
293             assert (64 &lt; -exponent &amp;&amp; -exponent &lt;= 128);
294             final UInt128 fractionals128 = new UInt128(fractionals, 0);
295             fractionals128.shift(-exponent - 64);
296             int point = 128;
297             for (int i = 0; i &lt; fractional_count; ++i) {
298                 if (fractionals128.isZero()) break;
299                 // As before: instead of multiplying by 10 we multiply by 5 and adjust the
300                 // point location.
301                 // This multiplication will not overflow for the same reasons as before.
302                 fractionals128.multiply(5);
303                 point--;
304                 final int digit = fractionals128.divModPowerOf2(point);
305                 assert (digit &lt;= 9);
306                 buffer.chars[buffer.length] = (char) (&#39;0&#39; + digit);
307                 buffer.length++;
308             }
309             if (fractionals128.bitAt(point - 1) == 1) {
</pre>
</td>
<td>
<hr />
<pre>
269                 if (fractionals == 0) break;
270                 // Instead of multiplying by 10 we multiply by 5 and adjust the point
271                 // location. This way the fractionals variable will not overflow.
272                 // Invariant at the beginning of the loop: fractionals &lt; 2^point.
273                 // Initially we have: point &lt;= 64 and fractionals &lt; 2^56
274                 // After each iteration the point is decremented by one.
275                 // Note that 5^3 = 125 &lt; 128 = 2^7.
276                 // Therefore three iterations of this loop will not overflow fractionals
277                 // (even without the subtraction at the end of the loop body). At this
278                 // time point will satisfy point &lt;= 61 and therefore fractionals &lt; 2^point
279                 // and any further multiplication of fractionals by 5 will not overflow.
280                 fractionals *= 5;
281                 point--;
282                 final int digit = (int) (fractionals &gt;&gt;&gt; point);
283                 assert (digit &lt;= 9);
284                 buffer.chars[buffer.length] = (char) (&#39;0&#39; + digit);
285                 buffer.length++;
286                 fractionals -= (long) (digit) &lt;&lt; point;
287             }
288             // If the first bit after the point is set we have to round up.
<span class="line-modified">289             assert (fractionals == 0 || point - 1 &gt;= 0);</span>
<span class="line-added">290             if ((fractionals != 0) &amp;&amp; ((fractionals &gt;&gt;&gt; (point - 1)) &amp; 1) == 1) {</span>
291                 roundUp(buffer);
292             }
293         } else {  // We need 128 bits.
294             assert (64 &lt; -exponent &amp;&amp; -exponent &lt;= 128);
295             final UInt128 fractionals128 = new UInt128(fractionals, 0);
296             fractionals128.shift(-exponent - 64);
297             int point = 128;
298             for (int i = 0; i &lt; fractional_count; ++i) {
299                 if (fractionals128.isZero()) break;
300                 // As before: instead of multiplying by 10 we multiply by 5 and adjust the
301                 // point location.
302                 // This multiplication will not overflow for the same reasons as before.
303                 fractionals128.multiply(5);
304                 point--;
305                 final int digit = fractionals128.divModPowerOf2(point);
306                 assert (digit &lt;= 9);
307                 buffer.chars[buffer.length] = (char) (&#39;0&#39; + digit);
308                 buffer.length++;
309             }
310             if (fractionals128.bitAt(point - 1) == 1) {
</pre>
</td>
</tr>
</table>
<center><a href="BignumDtoa.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IeeeDouble.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>