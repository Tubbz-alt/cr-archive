<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.sctp/unix/classes/sun/nio/ch/sctp/SctpChannelImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AssociationChange.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SctpMultiChannelImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.sctp/unix/classes/sun/nio/ch/sctp/SctpChannelImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2009, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 51,10 ***</span>
<span class="line-new-header">--- 51,11 ---</span>
  import com.sun.nio.sctp.IllegalUnbindException;
  import com.sun.nio.sctp.MessageInfo;
  import com.sun.nio.sctp.NotificationHandler;
  import com.sun.nio.sctp.SctpChannel;
  import com.sun.nio.sctp.SctpSocketOption;
<span class="line-added">+ import sun.net.util.IPAddressUtil;</span>
  import sun.nio.ch.DirectBuffer;
  import sun.nio.ch.IOStatus;
  import sun.nio.ch.IOUtil;
  import sun.nio.ch.NativeThread;
  import sun.nio.ch.Net;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 463,11 ***</span>
                      if (isConnected())
                          return true;
                      if (state != ChannelState.PENDING)
                          throw new NoConnectionPendingException();
                  }
<span class="line-modified">!                 int n = 0;</span>
                  try {
                      try {
                          begin();
                          synchronized (blockingLock()) {
                              synchronized (stateLock) {
<span class="line-new-header">--- 464,11 ---</span>
                      if (isConnected())
                          return true;
                      if (state != ChannelState.PENDING)
                          throw new NoConnectionPendingException();
                  }
<span class="line-modified">!                 boolean connected = false;</span>
                  try {
                      try {
                          begin();
                          synchronized (blockingLock()) {
                              synchronized (stateLock) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 475,57 ***</span>
                                      return false;
                                  }
                                  receiverThread = NativeThread.current();
                              }
                              if (!isBlocking()) {
<span class="line-modified">!                                 for (;;) {</span>
<span class="line-removed">-                                     n = Net.pollConnect(fd, 0);</span>
<span class="line-removed">-                                     if (  (n == IOStatus.INTERRUPTED)</span>
<span class="line-removed">-                                           &amp;&amp; isOpen())</span>
<span class="line-removed">-                                         continue;</span>
<span class="line-removed">-                                     break;</span>
<span class="line-removed">-                                 }</span>
                              } else {
<span class="line-modified">!                                 for (;;) {</span>
<span class="line-modified">!                                     n = Net.pollConnect(fd, -1);</span>
<span class="line-modified">!                                     if (n == 0) {</span>
<span class="line-removed">-                                         // Loop in case of</span>
<span class="line-removed">-                                         // spurious notifications</span>
<span class="line-removed">-                                         continue;</span>
<span class="line-removed">-                                     }</span>
<span class="line-removed">-                                     if (  (n == IOStatus.INTERRUPTED)</span>
<span class="line-removed">-                                           &amp;&amp; isOpen())</span>
<span class="line-removed">-                                         continue;</span>
<span class="line-removed">-                                     break;</span>
<span class="line-removed">-                                 }</span>
                              }
                          }
                      } finally {
                          synchronized (stateLock) {
                              receiverThread = 0;
                              if (state == ChannelState.KILLPENDING) {
                                  kill();
<span class="line-modified">!                                 /* poll()/getsockopt() does not report</span>
<span class="line-removed">-                                  * error (throws exception, with n = 0)</span>
<span class="line-removed">-                                  * on Linux platform after dup2 and</span>
<span class="line-removed">-                                  * signal-wakeup. Force n to 0 so the</span>
<span class="line-removed">-                                  * end() can throw appropriate exception */</span>
<span class="line-removed">-                                 n = 0;</span>
                              }
                          }
<span class="line-modified">!                         end((n &gt; 0) || (n == IOStatus.UNAVAILABLE));</span>
<span class="line-removed">-                         assert IOStatus.check(n);</span>
                      }
                  } catch (IOException x) {
                      /* If an exception was thrown, close the channel after
                       * invoking end() so as to avoid bogus
                       * AsynchronousCloseExceptions */
                      close();
                      throw x;
                  }
  
<span class="line-modified">!                 if (n &gt; 0) {</span>
                      synchronized (stateLock) {
                          state = ChannelState.CONNECTED;
                          if (!isBound()) {
                              InetSocketAddress boundIsa =
                                      Net.localAddress(fd);
<span class="line-new-header">--- 476,36 ---</span>
                                      return false;
                                  }
                                  receiverThread = NativeThread.current();
                              }
                              if (!isBlocking()) {
<span class="line-modified">!                                 connected = Net.pollConnect(fd, 0);</span>
                              } else {
<span class="line-modified">!                                 do {</span>
<span class="line-modified">!                                     connected = Net.pollConnect(fd, -1);</span>
<span class="line-modified">!                                 } while (!connected &amp;&amp; isOpen());</span>
                              }
                          }
                      } finally {
                          synchronized (stateLock) {
                              receiverThread = 0;
                              if (state == ChannelState.KILLPENDING) {
                                  kill();
<span class="line-modified">!                                 connected = false;</span>
                              }
                          }
<span class="line-modified">!                         end(connected);</span>
                      }
                  } catch (IOException x) {
                      /* If an exception was thrown, close the channel after
                       * invoking end() so as to avoid bogus
                       * AsynchronousCloseExceptions */
                      close();
                      throw x;
                  }
  
<span class="line-modified">!                 if (connected) {</span>
                      synchronized (stateLock) {
                          state = ChannelState.CONNECTED;
                          if (!isBound()) {
                              InetSocketAddress boundIsa =
                                      Net.localAddress(fd);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1031,10 ***</span>
<span class="line-new-header">--- 1011,13 ---</span>
          InetAddress addr = null;     // no preferred address
          int port = 0;
          if (target != null) {
              InetSocketAddress isa = Net.checkAddress(target);
              addr = isa.getAddress();
<span class="line-added">+             if (addr.isLinkLocalAddress()) {</span>
<span class="line-added">+                 addr = IPAddressUtil.toScopedAddress(addr);</span>
<span class="line-added">+             }</span>
              port = isa.getPort();
          }
  
          int pos = bb.position();
          int lim = bb.limit();
</pre>
<center><a href="AssociationChange.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SctpMultiChannelImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>