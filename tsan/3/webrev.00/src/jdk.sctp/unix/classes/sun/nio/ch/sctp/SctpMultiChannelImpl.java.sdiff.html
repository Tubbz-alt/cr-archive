<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.sctp/unix/classes/sun/nio/ch/sctp/SctpMultiChannelImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SctpChannelImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SctpNet.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.sctp/unix/classes/sun/nio/ch/sctp/SctpMultiChannelImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2009, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  36 import java.util.Set;
  37 import java.util.HashSet;
  38 import java.util.HashMap;
  39 import java.nio.ByteBuffer;
  40 import java.nio.channels.SelectionKey;
  41 import java.nio.channels.ClosedChannelException;
  42 import java.nio.channels.NotYetBoundException;
  43 import java.nio.channels.spi.SelectorProvider;
  44 import com.sun.nio.sctp.AbstractNotificationHandler;
  45 import com.sun.nio.sctp.Association;
  46 import com.sun.nio.sctp.AssociationChangeNotification;
  47 import com.sun.nio.sctp.HandlerResult;
  48 import com.sun.nio.sctp.IllegalReceiveException;
  49 import com.sun.nio.sctp.InvalidStreamException;
  50 import com.sun.nio.sctp.IllegalUnbindException;
  51 import com.sun.nio.sctp.NotificationHandler;
  52 import com.sun.nio.sctp.MessageInfo;
  53 import com.sun.nio.sctp.SctpChannel;
  54 import com.sun.nio.sctp.SctpMultiChannel;
  55 import com.sun.nio.sctp.SctpSocketOption;

  56 import sun.nio.ch.DirectBuffer;
  57 import sun.nio.ch.NativeThread;
  58 import sun.nio.ch.IOStatus;
  59 import sun.nio.ch.IOUtil;
  60 import sun.nio.ch.Net;
  61 import sun.nio.ch.SelChImpl;
  62 import sun.nio.ch.SelectionKeyImpl;
  63 import sun.nio.ch.Util;
  64 import static com.sun.nio.sctp.SctpStandardSocketOptions.*;
  65 import static sun.nio.ch.sctp.ResultContainer.*;
  66 
  67 /**
  68  * An implementation of SctpMultiChannel
  69  */
  70 public class SctpMultiChannelImpl extends SctpMultiChannel
  71     implements SelChImpl
  72 {
  73     private final FileDescriptor fd;
  74 
  75     private final int fdVal;
</pre>
<hr />
<pre>
 875             }
 876             return n;
 877         } finally {
 878             Util.releaseTemporaryDirectBuffer(bb);
 879         }
 880     }
 881 
 882     private int sendFromNativeBuffer(int fd,
 883                                      ByteBuffer bb,
 884                                      SocketAddress target,
 885                                      int assocId,
 886                                      int streamNumber,
 887                                      boolean unordered,
 888                                      int ppid)
 889             throws IOException {
 890         InetAddress addr = null;     // no preferred address
 891         int port = 0;
 892         if (target != null) {
 893             InetSocketAddress isa = Net.checkAddress(target);
 894             addr = isa.getAddress();



 895             port = isa.getPort();
 896         }
 897         int pos = bb.position();
 898         int lim = bb.limit();
 899         assert (pos &lt;= lim);
 900         int rem = (pos &lt;= lim ? lim - pos : 0);
 901 
 902         int written = send0(fd, ((DirectBuffer)bb).address() + pos, rem, addr,
 903                             port, assocId, streamNumber, unordered, ppid);
 904         if (written &gt; 0)
 905             bb.position(pos + written);
 906         return written;
 907     }
 908 
 909     @Override
 910     public SctpMultiChannel shutdown(Association association)
 911             throws IOException {
 912         synchronized (stateLock) {
 913             checkAssociation(association);
 914             if (!isOpen())
</pre>
<hr />
<pre>
 974                                 long address,
 975                                 int length)
 976             throws IOException{
 977         return SctpChannelImpl.receive0(fd, resultContainer, address,
 978                 length, false /*peek */);
 979     }
 980 
 981     private static int send0(int fd,
 982                              long address,
 983                              int length,
 984                              InetAddress addr,
 985                              int port,
 986                              int assocId,
 987                              int streamNumber,
 988                              boolean unordered,
 989                              int ppid)
 990             throws IOException {
 991         return SctpChannelImpl.send0(fd, address, length, addr, port, assocId,
 992                 streamNumber, unordered, ppid);
 993     }
<span class="line-removed"> 994 </span>
<span class="line-removed"> 995     static {</span>
<span class="line-removed"> 996         IOUtil.load();   /* loads nio &amp; net native libraries */</span>
<span class="line-removed"> 997         java.security.AccessController.doPrivileged(</span>
<span class="line-removed"> 998             new java.security.PrivilegedAction&lt;Void&gt;() {</span>
<span class="line-removed"> 999                 public Void run() {</span>
<span class="line-removed">1000                     System.loadLibrary(&quot;sctp&quot;);</span>
<span class="line-removed">1001                     return null;</span>
<span class="line-removed">1002                 }</span>
<span class="line-removed">1003             });</span>
<span class="line-removed">1004     }</span>
1005 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  36 import java.util.Set;
  37 import java.util.HashSet;
  38 import java.util.HashMap;
  39 import java.nio.ByteBuffer;
  40 import java.nio.channels.SelectionKey;
  41 import java.nio.channels.ClosedChannelException;
  42 import java.nio.channels.NotYetBoundException;
  43 import java.nio.channels.spi.SelectorProvider;
  44 import com.sun.nio.sctp.AbstractNotificationHandler;
  45 import com.sun.nio.sctp.Association;
  46 import com.sun.nio.sctp.AssociationChangeNotification;
  47 import com.sun.nio.sctp.HandlerResult;
  48 import com.sun.nio.sctp.IllegalReceiveException;
  49 import com.sun.nio.sctp.InvalidStreamException;
  50 import com.sun.nio.sctp.IllegalUnbindException;
  51 import com.sun.nio.sctp.NotificationHandler;
  52 import com.sun.nio.sctp.MessageInfo;
  53 import com.sun.nio.sctp.SctpChannel;
  54 import com.sun.nio.sctp.SctpMultiChannel;
  55 import com.sun.nio.sctp.SctpSocketOption;
<span class="line-added">  56 import sun.net.util.IPAddressUtil;</span>
  57 import sun.nio.ch.DirectBuffer;
  58 import sun.nio.ch.NativeThread;
  59 import sun.nio.ch.IOStatus;
  60 import sun.nio.ch.IOUtil;
  61 import sun.nio.ch.Net;
  62 import sun.nio.ch.SelChImpl;
  63 import sun.nio.ch.SelectionKeyImpl;
  64 import sun.nio.ch.Util;
  65 import static com.sun.nio.sctp.SctpStandardSocketOptions.*;
  66 import static sun.nio.ch.sctp.ResultContainer.*;
  67 
  68 /**
  69  * An implementation of SctpMultiChannel
  70  */
  71 public class SctpMultiChannelImpl extends SctpMultiChannel
  72     implements SelChImpl
  73 {
  74     private final FileDescriptor fd;
  75 
  76     private final int fdVal;
</pre>
<hr />
<pre>
 876             }
 877             return n;
 878         } finally {
 879             Util.releaseTemporaryDirectBuffer(bb);
 880         }
 881     }
 882 
 883     private int sendFromNativeBuffer(int fd,
 884                                      ByteBuffer bb,
 885                                      SocketAddress target,
 886                                      int assocId,
 887                                      int streamNumber,
 888                                      boolean unordered,
 889                                      int ppid)
 890             throws IOException {
 891         InetAddress addr = null;     // no preferred address
 892         int port = 0;
 893         if (target != null) {
 894             InetSocketAddress isa = Net.checkAddress(target);
 895             addr = isa.getAddress();
<span class="line-added"> 896             if (addr.isLinkLocalAddress()) {</span>
<span class="line-added"> 897                 addr = IPAddressUtil.toScopedAddress(addr);</span>
<span class="line-added"> 898             }</span>
 899             port = isa.getPort();
 900         }
 901         int pos = bb.position();
 902         int lim = bb.limit();
 903         assert (pos &lt;= lim);
 904         int rem = (pos &lt;= lim ? lim - pos : 0);
 905 
 906         int written = send0(fd, ((DirectBuffer)bb).address() + pos, rem, addr,
 907                             port, assocId, streamNumber, unordered, ppid);
 908         if (written &gt; 0)
 909             bb.position(pos + written);
 910         return written;
 911     }
 912 
 913     @Override
 914     public SctpMultiChannel shutdown(Association association)
 915             throws IOException {
 916         synchronized (stateLock) {
 917             checkAssociation(association);
 918             if (!isOpen())
</pre>
<hr />
<pre>
 978                                 long address,
 979                                 int length)
 980             throws IOException{
 981         return SctpChannelImpl.receive0(fd, resultContainer, address,
 982                 length, false /*peek */);
 983     }
 984 
 985     private static int send0(int fd,
 986                              long address,
 987                              int length,
 988                              InetAddress addr,
 989                              int port,
 990                              int assocId,
 991                              int streamNumber,
 992                              boolean unordered,
 993                              int ppid)
 994             throws IOException {
 995         return SctpChannelImpl.send0(fd, address, length, addr, port, assocId,
 996                 streamNumber, unordered, ppid);
 997     }











 998 }
</pre>
</td>
</tr>
</table>
<center><a href="SctpChannelImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SctpNet.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>