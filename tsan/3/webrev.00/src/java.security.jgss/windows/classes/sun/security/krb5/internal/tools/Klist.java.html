<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.security.jgss/windows/classes/sun/security/krb5/internal/tools/Klist.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 28  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 29  */
 30 
 31 package sun.security.krb5.internal.tools;
 32 
 33 import java.net.InetAddress;
 34 import java.util.List;
 35 
 36 import sun.security.krb5.*;
 37 import sun.security.krb5.internal.*;
 38 import sun.security.krb5.internal.ccache.*;
 39 import sun.security.krb5.internal.ktab.*;
 40 import sun.security.krb5.internal.crypto.EType;
 41 
 42 /**
 43  * This class can execute as a command-line tool to list entries in
 44  * credential cache and key tab.
 45  *
 46  * @author Yanni Zhang
 47  * @author Ram Marti
 48  */
 49 public class Klist {
 50     Object target;
 51     // for credentials cache, options are &#39;f&#39;, &#39;e&#39;, &#39;a&#39; and &#39;n&#39;;
 52     // for  keytab, optionsare &#39;t&#39; and &#39;K&#39; and &#39;e&#39;
 53     char[] options = new char[4];
 54     String name;       // the name of credentials cache and keytable.
 55     char action;       // actions would be &#39;c&#39; for credentials cache
 56     // and &#39;k&#39; for keytable.
 57     private static boolean DEBUG = Krb5.DEBUG;
 58 
 59     /**
 60      * The main program that can be invoked at command line.
 61      * &lt;br&gt;Usage: klist
 62      * [[-c] [-f] [-e] [-a [-n]]] [-k [-t] [-K]] [name]
 63      * -c specifies that credential cache is to be listed
 64      * -k specifies that key tab is to be listed
 65      * name name of the credentials cache or keytab
 66      * &lt;br&gt;available options for credential caches:
 67      * &lt;ul&gt;
 68      * &lt;li&gt;&lt;b&gt;-f&lt;/b&gt;  shows credentials flags
 69      * &lt;li&gt;&lt;b&gt;-e&lt;/b&gt;  shows the encryption type
 70      * &lt;li&gt;&lt;b&gt;-a&lt;/b&gt;  shows addresses
 71      * &lt;li&gt;&lt;b&gt;-n&lt;/b&gt;  do not reverse-resolve addresses
 72      * &lt;/ul&gt;
 73      * available options for keytabs:
 74      * &lt;ul&gt;
 75      * &lt;li&gt;&lt;b&gt;-t&lt;/b&gt; shows keytab entry timestamps
 76      * &lt;li&gt;&lt;b&gt;-K&lt;/b&gt; shows keytab entry DES keys
 77      * &lt;/ul&gt;
 78      */
 79     public static void main(String[] args) {
 80         Klist klist = new Klist();
 81         if ((args == null) || (args.length == 0)) {
 82             klist.action = &#39;c&#39;; // default will list default credentials cache.
 83         } else {
 84             klist.processArgs(args);
 85         }
 86         switch (klist.action) {
 87         case &#39;c&#39;:
 88             if (klist.name == null) {
 89                 klist.target = CredentialsCache.getInstance();
 90                 klist.name = CredentialsCache.cacheName();
 91             } else
 92                 klist.target = CredentialsCache.getInstance(klist.name);
 93 
 94             if (klist.target != null)  {
 95                 klist.displayCache();
 96             } else {
 97                 klist.displayMessage(&quot;Credentials cache&quot;);
 98                 System.exit(-1);
 99             }
100             break;
101         case &#39;k&#39;:
102             KeyTab ktab = KeyTab.getInstance(klist.name);
103             if (ktab.isMissing()) {
104                 System.out.println(&quot;KeyTab &quot; + klist.name + &quot; not found.&quot;);
105                 System.exit(-1);
106             } else if (!ktab.isValid()) {
107                 System.out.println(&quot;KeyTab &quot; + klist.name
108                         + &quot; format not supported.&quot;);
109                 System.exit(-1);
110             }
111             klist.target = ktab;
112             klist.name = ktab.tabName();
113             klist.displayTab();
114             break;
115         default:
116             if (klist.name != null) {
117                 klist.printHelp();
118                 System.exit(-1);
119             } else {
120                 klist.target = CredentialsCache.getInstance();
121                 klist.name = CredentialsCache.cacheName();
122                 if (klist.target != null) {
123                     klist.displayCache();
124                 } else {
125                     klist.displayMessage(&quot;Credentials cache&quot;);
126                     System.exit(-1);
127                 }
128             }
129         }
130     }
131 
132     /**
133      * Parses the command line arguments.
134      */
135     void processArgs(String[] args) {
136         Character arg;
137         for (int i = 0; i &lt; args.length; i++) {
138             if (args[i].equals(&quot;-?&quot;) ||
139                 args[i].equals(&quot;-h&quot;) ||
140                 args[i].equals(&quot;--help&quot;)) {
141                 printHelp();
142                 System.exit(0);
143             }
144             if ((args[i].length() &gt;= 2) &amp;&amp; (args[i].startsWith(&quot;-&quot;))) {
145                 arg = Character.valueOf(args[i].charAt(1));
146                 switch (arg.charValue()) {
147                 case &#39;c&#39;:
148                     action = &#39;c&#39;;
149                     break;
150                 case &#39;k&#39;:
151                     action = &#39;k&#39;;
152                     break;
153                 case &#39;a&#39;:
154                     options[2] = &#39;a&#39;;
155                     break;
156                 case &#39;n&#39;:
157                     options[3] = &#39;n&#39;;
158                     break;
159                 case &#39;f&#39;:
160                     options[1] = &#39;f&#39;;
161                     break;
162                 case &#39;e&#39;:
163                     options[0] = &#39;e&#39;;
164                     break;
165                 case &#39;K&#39;:
166                     options[1] = &#39;K&#39;;
167                     break;
168                 case &#39;t&#39;:
169                     options[2] = &#39;t&#39;;
170                     break;
171                 default:
172                     printHelp();
173                     System.exit(-1);
174                 }
175 
176             } else {
177                 if (!args[i].startsWith(&quot;-&quot;) &amp;&amp; (i == args.length - 1)) {
178                     // the argument is the last one.
179                     name = args[i];
180                     arg = null;
181                 } else {
182                     printHelp(); // incorrect input format.
183                     System.exit(-1);
184                 }
185             }
186         }
187     }
188 
189     void displayTab() {
190         KeyTab table = (KeyTab)target;
191         KeyTabEntry[] entries = table.getEntries();
192         if (entries.length == 0) {
193             System.out.println(&quot;\nKey tab: &quot; + name +
194                                &quot;, &quot; + &quot; 0 entries found.\n&quot;);
195         } else {
196             if (entries.length == 1)
197                 System.out.println(&quot;\nKey tab: &quot; + name +
198                                    &quot;, &quot; + entries.length + &quot; entry found.\n&quot;);
199             else
200                 System.out.println(&quot;\nKey tab: &quot; + name + &quot;, &quot; +
201                                    entries.length + &quot; entries found.\n&quot;);
202             for (int i = 0; i &lt; entries.length; i++) {
203                 System.out.println(&quot;[&quot; + (i + 1) + &quot;] &quot; +
204                                    &quot;Service principal: &quot;  +
205                                    entries[i].getService().toString());
206                 System.out.println(&quot;\t KVNO: &quot; +
207                                    entries[i].getKey().getKeyVersionNumber());
208                 if (options[0] == &#39;e&#39;) {
209                     EncryptionKey key = entries[i].getKey();
210                     System.out.println(&quot;\t Key type: &quot; +
211                                        key.getEType());
212                 }
213                 if (options[1] == &#39;K&#39;) {
214                     EncryptionKey key = entries[i].getKey();
215                     System.out.println(&quot;\t Key: &quot; +
216                                        entries[i].getKeyString());
217                 }
218                 if (options[2] == &#39;t&#39;) {
219                     System.out.println(&quot;\t Time stamp: &quot; +
220                             format(entries[i].getTimeStamp()));
221                 }
222             }
223         }
224     }
225 
226     void displayCache() {
227         CredentialsCache cache = (CredentialsCache)target;
228         sun.security.krb5.internal.ccache.Credentials[] creds =
229             cache.getCredsList();
230         if (creds == null) {
231             System.out.println (&quot;No credentials available in the cache &quot; +
232                                 name);
233             System.exit(-1);
234         }
235         System.out.println(&quot;\nCredentials cache: &quot; +  name);
236         String defaultPrincipal = cache.getPrimaryPrincipal().toString();
237         int num = creds.length;
238 
239         if (num == 1)
240             System.out.println(&quot;\nDefault principal: &quot; +
241                                defaultPrincipal + &quot;, &quot; +
242                                creds.length + &quot; entry found.\n&quot;);
243         else
244             System.out.println(&quot;\nDefault principal: &quot; +
245                                defaultPrincipal + &quot;, &quot; +
246                                creds.length + &quot; entries found.\n&quot;);
247         if (creds != null) {
248             for (int i = 0; i &lt; creds.length; i++) {
249                 try {
250                     String starttime;
251                     String endtime;
252                     String renewTill;
253                     String servicePrincipal;
254                     PrincipalName servicePrincipal2;
255                     String clientPrincipal;
256                     if (creds[i].getStartTime() != null) {
257                         starttime = format(creds[i].getStartTime());
258                     } else {
259                         starttime = format(creds[i].getAuthTime());
260                     }
261                     endtime = format(creds[i].getEndTime());
262                     servicePrincipal =
263                         creds[i].getServicePrincipal().toString();
264                     System.out.println(&quot;[&quot; + (i + 1) + &quot;] &quot; +
265                                        &quot; Service Principal:  &quot; +
266                                        servicePrincipal);
267                     servicePrincipal2 =
268                             creds[i].getServicePrincipal2();
269                     if (servicePrincipal2 != null) {
270                         System.out.println(&quot;     Second Service:     &quot;
271                                 + servicePrincipal2);
272                     }
273                     clientPrincipal =
274                             creds[i].getClientPrincipal().toString();
275                     if (!clientPrincipal.equals(defaultPrincipal)) {
276                         System.out.println(&quot;     Client Principal:   &quot; +
277                                 clientPrincipal);
278                     }
279                     System.out.println(&quot;     Valid starting:     &quot; + starttime);
280                     System.out.println(&quot;     Expires:            &quot; + endtime);
281                     if (creds[i].getRenewTill() != null) {
282                         renewTill = format(creds[i].getRenewTill());
283                         System.out.println(
284                                 &quot;     Renew until:        &quot; + renewTill);
285                     }
286                     if (options[0] == &#39;e&#39;) {
287                         String eskey = EType.toString(creds[i].getEType());
288                         String etkt = EType.toString(creds[i].getTktEType());
289                         if (creds[i].getTktEType2() == 0) {
290                             System.out.println(&quot;     EType (skey, tkt):  &quot;
291                                     + eskey + &quot;, &quot; + etkt);
292                         } else {
293                             String etkt2 = EType.toString(creds[i].getTktEType2());
294                             System.out.println(&quot;     EType (skey, tkts): &quot;
295                                     + eskey + &quot;, &quot; + etkt
296                                     + &quot;, &quot; + etkt2);
297                         }
298                     }
299                     if (options[1] == &#39;f&#39;) {
300                         System.out.println(&quot;     Flags:              &quot; +
301                                            creds[i].getTicketFlags().toString());
302                     }
303                     if (options[2] == &#39;a&#39;) {
304                         boolean first = true;
305                         InetAddress[] caddr
306                                 = creds[i].setKrbCreds().getClientAddresses();
307                         if (caddr != null) {
308                             for (InetAddress ia: caddr) {
309                                 String out;
310                                 if (options[3] == &#39;n&#39;) {
311                                     out = ia.getHostAddress();
312                                 } else {
313                                     out = ia.getCanonicalHostName();
314                                 }
315                                 System.out.println(&quot;     &quot; +
316                                         (first?&quot;Addresses:&quot;:&quot;          &quot;) +
317                                         &quot;       &quot; + out);
318                                 first = false;
319                             }
320                         } else {
321                             System.out.println(&quot;     [No host addresses info]&quot;);
322                         }
323                     }
324                 } catch (RealmException e) {
325                     System.out.println(&quot;Error reading principal from &quot;+
326                                        &quot;the entry.&quot;);
327                     if (DEBUG) {
328                         e.printStackTrace();
329                     }
330                     System.exit(-1);
331                 }
332             }
333         } else {
334             System.out.println(&quot;\nNo entries found.&quot;);
335         }
336 
337         List&lt;CredentialsCache.ConfigEntry&gt; configEntries
338                 = cache.getConfigEntries();
339         if (configEntries != null &amp;&amp; !configEntries.isEmpty()) {
340             System.out.println(&quot;\nConfig entries:&quot;);
341             for (CredentialsCache.ConfigEntry e : configEntries) {
342                 System.out.println(&quot;     &quot; + e);
343             }
344         }
345     }
346 
347     void displayMessage(String target) {
348         if (name == null) {
349             System.out.println(&quot;Default &quot; + target + &quot; not found.&quot;);
350         } else {
351             System.out.println(target + &quot; &quot; + name + &quot; not found.&quot;);
352         }
353     }
354     /**
355      * Reformats the date from the form -
356      *     dow mon dd hh:mm:ss zzz yyyy to mon/dd/yyyy hh:mm
357      * where dow is the day of the week, mon is the month,
358      * dd is the day of the month, hh is the hour of
359      * the day, mm is the minute within the hour,
360      * ss is the second within the minute, zzz is the time zone,
361      * and yyyy is the year.
362      * @param date the string form of Date object.
363      */
364     private String format(KerberosTime kt) {
365         String date = kt.toDate().toString();
366         return (date.substring(4, 7) + &quot; &quot; + date.substring(8, 10) +
367                 &quot;, &quot; + date.substring(24)
368                 + &quot; &quot; + date.substring(11, 19));
369     }
370     /**
371      * Prints out the help information.
372      */
373     void printHelp() {
374         System.out.println(&quot;\nUsage: klist &quot; +
375                            &quot;[[-c] [-f] [-e] [-a [-n]]] [-k [-t] [-K]] [name]&quot;);
376         System.out.println(&quot;   name\t name of credentials cache or &quot; +
377                            &quot; keytab with the prefix. File-based cache or &quot;
378                            + &quot;keytab&#39;s prefix is FILE:.&quot;);
379         System.out.println(&quot;   -c specifies that credential cache is to be &quot; +
380                            &quot;listed&quot;);
381         System.out.println(&quot;   -k specifies that key tab is to be listed&quot;);
382         System.out.println(&quot;   options for credentials caches:&quot;);
383         System.out.println(&quot;\t-f \t shows credentials flags&quot;);
384         System.out.println(&quot;\t-e \t shows the encryption type&quot;);
385         System.out.println(&quot;\t-a \t shows addresses&quot;);
386         System.out.println(&quot;\t  -n \t   do not reverse-resolve addresses&quot;);
387         System.out.println(&quot;   options for keytabs:&quot;);
388         System.out.println(&quot;\t-t \t shows keytab entry timestamps&quot;);
389         System.out.println(&quot;\t-K \t shows keytab entry key value&quot;);
390         System.out.println(&quot;\t-e \t shows keytab entry key type&quot;);
391     }
392 }
    </pre>
  </body>
</html>