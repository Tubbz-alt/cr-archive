<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/windows/native/libw2k_lsa_auth/NativeCreds.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/sun/security/krb5/internal/tools/Klist.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../java.security.sasl/share/classes/com/sun/security/sasl/ClientFactoryImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/windows/native/libw2k_lsa_auth/NativeCreds.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  37 #include &lt;string.h&gt;
  38 #define SECURITY_WIN32
  39 #include &lt;security.h&gt;
  40 #include &lt;ntsecapi.h&gt;
  41 #include &lt;dsgetdc.h&gt;
  42 #include &lt;lmcons.h&gt;
  43 #include &lt;lmapibuf.h&gt;
  44 #include &lt;jni.h&gt;
  45 #include &quot;jni_util.h&quot;
  46 #include &lt;winsock.h&gt;
  47 #include &quot;sun_security_krb5_Credentials.h&quot;
  48 
  49 #undef LSA_SUCCESS
  50 #define LSA_SUCCESS(Status) ((Status) &gt;= 0)
  51 #define EXIT_FAILURE -1 // mdu
  52 
  53 /*
  54  * Library-wide static references
  55  */
  56 
<span class="line-removed">  57 jclass derValueClass = NULL;</span>
  58 jclass ticketClass = NULL;
  59 jclass principalNameClass = NULL;
  60 jclass encryptionKeyClass = NULL;
  61 jclass ticketFlagsClass = NULL;
  62 jclass kerberosTimeClass = NULL;
  63 jclass javaLangStringClass = NULL;
  64 
<span class="line-removed">  65 jmethodID derValueConstructor = 0;</span>
  66 jmethodID ticketConstructor = 0;
  67 jmethodID principalNameConstructor = 0;
  68 jmethodID encryptionKeyConstructor = 0;
  69 jmethodID ticketFlagsConstructor = 0;
  70 jmethodID kerberosTimeConstructor = 0;
  71 jmethodID krbcredsConstructor = 0;
  72 
  73 /*
  74  * Function prototypes for internal routines
  75  *
  76  */
  77 BOOL native_debug = 0;
  78 
  79 BOOL PackageConnectLookup(PHANDLE,PULONG);
  80 
  81 NTSTATUS ConstructTicketRequest(JNIEnv *env,
  82                                 UNICODE_STRING DomainName,
  83                                 PKERB_RETRIEVE_TKT_REQUEST *outRequest,
  84                                 ULONG *outSize);
  85 
</pre>
<hr />
<pre>
 155     }
 156 
 157     cls = (*env)-&gt;FindClass(env, &quot;sun/security/krb5/PrincipalName&quot;);
 158 
 159     if (cls == NULL) {
 160         printf(&quot;LSA: Couldn&#39;t find PrincipalName\n&quot;);
 161         return JNI_ERR;
 162     }
 163     if (native_debug) {
 164         printf(&quot;LSA: Found PrincipalName\n&quot;);
 165     }
 166 
 167     principalNameClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 168     if (principalNameClass == NULL) {
 169         return JNI_ERR;
 170     }
 171     if (native_debug) {
 172         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 173     }
 174 
<span class="line-removed"> 175     cls = (*env)-&gt;FindClass(env,&quot;sun/security/util/DerValue&quot;);</span>
<span class="line-removed"> 176 </span>
<span class="line-removed"> 177     if (cls == NULL) {</span>
<span class="line-removed"> 178         printf(&quot;LSA: Couldn&#39;t find DerValue\n&quot;);</span>
<span class="line-removed"> 179         return JNI_ERR;</span>
<span class="line-removed"> 180     }</span>
<span class="line-removed"> 181     if (native_debug) {</span>
<span class="line-removed"> 182         printf(&quot;LSA: Found DerValue\n&quot;);</span>
<span class="line-removed"> 183     }</span>
<span class="line-removed"> 184 </span>
<span class="line-removed"> 185     derValueClass = (*env)-&gt;NewWeakGlobalRef(env,cls);</span>
<span class="line-removed"> 186     if (derValueClass == NULL) {</span>
<span class="line-removed"> 187         return JNI_ERR;</span>
<span class="line-removed"> 188     }</span>
<span class="line-removed"> 189     if (native_debug) {</span>
<span class="line-removed"> 190         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);</span>
<span class="line-removed"> 191     }</span>
<span class="line-removed"> 192 </span>
 193     cls = (*env)-&gt;FindClass(env,&quot;sun/security/krb5/EncryptionKey&quot;);
 194 
 195     if (cls == NULL) {
 196         printf(&quot;LSA: Couldn&#39;t find EncryptionKey\n&quot;);
 197         return JNI_ERR;
 198     }
 199     if (native_debug) {
 200         printf(&quot;LSA: Found EncryptionKey\n&quot;);
 201     }
 202 
 203     encryptionKeyClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 204     if (encryptionKeyClass == NULL) {
 205         return JNI_ERR;
 206     }
 207     if (native_debug) {
 208         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 209     }
 210 
 211     cls = (*env)-&gt;FindClass(env,&quot;sun/security/krb5/internal/TicketFlags&quot;);
 212 
</pre>
<hr />
<pre>
 245     }
 246 
 247     cls = (*env)-&gt;FindClass(env,&quot;java/lang/String&quot;);
 248 
 249     if (cls == NULL) {
 250         printf(&quot;LSA: Couldn&#39;t find String\n&quot;);
 251         return JNI_ERR;
 252     }
 253     if (native_debug) {
 254         printf(&quot;LSA: Found String\n&quot;);
 255     }
 256 
 257     javaLangStringClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 258     if (javaLangStringClass == NULL) {
 259         return JNI_ERR;
 260     }
 261     if (native_debug) {
 262         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 263     }
 264 
<span class="line-removed"> 265     derValueConstructor = (*env)-&gt;GetMethodID(env, derValueClass,</span>
<span class="line-removed"> 266                                             &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);</span>
<span class="line-removed"> 267     if (derValueConstructor == 0) {</span>
<span class="line-removed"> 268         printf(&quot;LSA: Couldn&#39;t find DerValue constructor\n&quot;);</span>
<span class="line-removed"> 269         return JNI_ERR;</span>
<span class="line-removed"> 270     }</span>
<span class="line-removed"> 271     if (native_debug) {</span>
<span class="line-removed"> 272         printf(&quot;LSA: Found DerValue constructor\n&quot;);</span>
<span class="line-removed"> 273     }</span>
<span class="line-removed"> 274 </span>
 275     ticketConstructor = (*env)-&gt;GetMethodID(env, ticketClass,
<span class="line-modified"> 276                             &quot;&lt;init&gt;&quot;, &quot;(Lsun/security/util/DerValue;)V&quot;);</span>
 277     if (ticketConstructor == 0) {
 278         printf(&quot;LSA: Couldn&#39;t find Ticket constructor\n&quot;);
 279         return JNI_ERR;
 280     }
 281     if (native_debug) {
 282         printf(&quot;LSA: Found Ticket constructor\n&quot;);
 283     }
 284 
 285     principalNameConstructor = (*env)-&gt;GetMethodID(env, principalNameClass,
 286                         &quot;&lt;init&gt;&quot;, &quot;([Ljava/lang/String;Ljava/lang/String;)V&quot;);
 287     if (principalNameConstructor == 0) {
 288         printf(&quot;LSA: Couldn&#39;t find PrincipalName constructor\n&quot;);
 289         return JNI_ERR;
 290     }
 291     if (native_debug) {
 292         printf(&quot;LSA: Found PrincipalName constructor\n&quot;);
 293     }
 294 
 295     encryptionKeyConstructor = (*env)-&gt;GetMethodID(env, encryptionKeyClass,
 296                                             &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
</pre>
<hr />
<pre>
 330 }
 331 
 332 /*
 333  * Class:     sun_security_jgss_KrbCreds
 334  * Method:    JNI_OnUnload
 335  */
 336 
 337 JNIEXPORT void JNICALL DEF_JNI_OnUnload(
 338         JavaVM  *jvm,
 339         void    *reserved) {
 340 
 341     JNIEnv *env;
 342 
 343     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
 344         return; /* Nothing else we can do */
 345     }
 346 
 347     if (ticketClass != NULL) {
 348         (*env)-&gt;DeleteWeakGlobalRef(env,ticketClass);
 349     }
<span class="line-removed"> 350     if (derValueClass != NULL) {</span>
<span class="line-removed"> 351         (*env)-&gt;DeleteWeakGlobalRef(env,derValueClass);</span>
<span class="line-removed"> 352     }</span>
 353     if (principalNameClass != NULL) {
 354         (*env)-&gt;DeleteWeakGlobalRef(env,principalNameClass);
 355     }
 356     if (encryptionKeyClass != NULL) {
 357         (*env)-&gt;DeleteWeakGlobalRef(env,encryptionKeyClass);
 358     }
 359     if (ticketFlagsClass != NULL) {
 360         (*env)-&gt;DeleteWeakGlobalRef(env,ticketFlagsClass);
 361     }
 362     if (kerberosTimeClass != NULL) {
 363         (*env)-&gt;DeleteWeakGlobalRef(env,kerberosTimeClass);
 364     }
 365     if (javaLangStringClass != NULL) {
 366         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangStringClass);
 367     }
 368 
 369     return;
 370 }
 371 
 372 /*
</pre>
<hr />
<pre>
 389     ULONG rspSize = 0;
 390     HANDLE LogonHandle = NULL;
 391     ULONG PackageId;
 392     jobject ticket, clientPrincipal, targetPrincipal, encryptionKey;
 393     jobject ticketFlags, startTime, endTime, krbCreds = NULL;
 394     jobject authTime, renewTillTime, hostAddresses = NULL;
 395     KERB_EXTERNAL_TICKET *msticket;
 396     int found = 0;
 397     FILETIME Now, EndTime;
 398 
 399     int i, netypes;
 400     jint *etypes = NULL;
 401 
 402     while (TRUE) {
 403 
 404         if (krbcredsConstructor == 0) {
 405             krbcredsConstructor = (*env)-&gt;GetMethodID(env, krbcredsClass, &quot;&lt;init&gt;&quot;,
 406                     &quot;(Lsun/security/krb5/internal/Ticket;&quot;
 407                     &quot;Lsun/security/krb5/PrincipalName;&quot;
 408                     &quot;Lsun/security/krb5/PrincipalName;&quot;


 409                     &quot;Lsun/security/krb5/EncryptionKey;&quot;
 410                     &quot;Lsun/security/krb5/internal/TicketFlags;&quot;
 411                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 412                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 413                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 414                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 415                     &quot;Lsun/security/krb5/internal/HostAddresses;)V&quot;);
 416             if (krbcredsConstructor == 0) {
 417                 printf(&quot;LSA: Couldn&#39;t find sun.security.krb5.Credentials constructor\n&quot;);
 418                 break;
 419             }
 420         }
 421 
 422         if (native_debug) {
 423             printf(&quot;LSA: Found KrbCreds constructor\n&quot;);
 424         }
 425 
 426         //
 427         // Get the logon handle and package ID from the
 428         // Kerberos package
</pre>
<hr />
<pre>
 650 
 651         // and the end time
 652         endTime = BuildKerberosTime(env, &amp;(msticket-&gt;EndTime));
 653         if (endTime == NULL) {
 654             break;
 655         }
 656 
 657         // Get the renew till time
 658         renewTillTime = BuildKerberosTime(env, &amp;(msticket-&gt;RenewUntil));
 659         if (renewTillTime == NULL) {
 660             break;
 661         }
 662 
 663         // and now go build a KrbCreds object
 664         krbCreds = (*env)-&gt;NewObject(
 665                 env,
 666                 krbcredsClass,
 667                 krbcredsConstructor,
 668                 ticket,
 669                 clientPrincipal,

 670                 targetPrincipal,

 671                 encryptionKey,
 672                 ticketFlags,
 673                 authTime, // mdu
 674                 startTime,
 675                 endTime,
 676                 renewTillTime, //mdu
 677                 hostAddresses);
 678 
 679         break;
 680     } // end of WHILE. This WHILE will never loop.
 681 
 682     // clean up resources
 683     if (TktCacheResponse != NULL) {
 684         LsaFreeReturnBuffer(TktCacheResponse);
 685     }
 686     if (pTicketRequest) {
 687         LocalFree(pTicketRequest);
 688     }
 689     if (pTicketResponse != NULL) {
 690         LsaFreeReturnBuffer(pTicketResponse);
</pre>
<hr />
<pre>
 876         PUNICODE_STRING DestinationString,
 877     PCWSTR SourceString OPTIONAL
 878     )
 879 {
 880     ULONG Length;
 881 
 882     DestinationString-&gt;Buffer = (PWSTR)SourceString;
 883     if (SourceString != NULL) {
 884         Length = (ULONG)wcslen( SourceString ) * sizeof( WCHAR );
 885         DestinationString-&gt;Length = (USHORT)Length;
 886         DestinationString-&gt;MaximumLength = (USHORT)(Length + sizeof(UNICODE_NULL));
 887     }
 888     else {
 889         DestinationString-&gt;MaximumLength = 0;
 890         DestinationString-&gt;Length = 0;
 891     }
 892 }
 893 
 894 jobject BuildTicket(JNIEnv *env, PUCHAR encodedTicket, ULONG encodedTicketSize) {
 895 
<span class="line-modified"> 896     /* To build a Ticket, we first need to build a DerValue out of the EncodedTicket.</span>
<span class="line-removed"> 897      * But before we can do that, we need to make a byte array out of the ET.</span>
<span class="line-removed"> 898      */</span>
 899 
<span class="line-modified"> 900     jobject derValue, ticket;</span>
 901     jbyteArray ary;
 902 
 903     ary = (*env)-&gt;NewByteArray(env,encodedTicketSize);
 904     if (ary == NULL) {
 905         return (jobject) NULL;
 906     }
 907 
 908     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, encodedTicketSize,
 909                                     (jbyte *)encodedTicket);
 910     if ((*env)-&gt;ExceptionOccurred(env)) {
 911         (*env)-&gt;DeleteLocalRef(env, ary);
 912         return (jobject) NULL;
 913     }
 914 
<span class="line-modified"> 915     derValue = (*env)-&gt;NewObject(env, derValueClass, derValueConstructor, ary);</span>
 916     if ((*env)-&gt;ExceptionOccurred(env)) {
 917         (*env)-&gt;DeleteLocalRef(env, ary);
 918         return (jobject) NULL;
 919     }
<span class="line-removed"> 920 </span>
 921     (*env)-&gt;DeleteLocalRef(env, ary);
<span class="line-removed"> 922     ticket = (*env)-&gt;NewObject(env, ticketClass, ticketConstructor, derValue);</span>
<span class="line-removed"> 923     if ((*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="line-removed"> 924         (*env)-&gt;DeleteLocalRef(env, derValue);</span>
<span class="line-removed"> 925         return (jobject) NULL;</span>
<span class="line-removed"> 926     }</span>
<span class="line-removed"> 927     (*env)-&gt;DeleteLocalRef(env, derValue);</span>
 928     return ticket;
 929 }
 930 
 931 // mdu
 932 jobject BuildPrincipal(JNIEnv *env, PKERB_EXTERNAL_NAME principalName,
 933                                 UNICODE_STRING domainName) {
 934 
 935     /*
 936      * To build the Principal, we need to get the names out of
 937      * this goofy MS structure
 938      */
 939     jobject principal = NULL;
 940     jobject realmStr = NULL;
 941     jobjectArray stringArray;
 942     jstring tempString;
 943     int nameCount,i;
 944     PUNICODE_STRING scanner;
 945     WCHAR *realm;
 946     ULONG realmLen;
 947 
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  37 #include &lt;string.h&gt;
  38 #define SECURITY_WIN32
  39 #include &lt;security.h&gt;
  40 #include &lt;ntsecapi.h&gt;
  41 #include &lt;dsgetdc.h&gt;
  42 #include &lt;lmcons.h&gt;
  43 #include &lt;lmapibuf.h&gt;
  44 #include &lt;jni.h&gt;
  45 #include &quot;jni_util.h&quot;
  46 #include &lt;winsock.h&gt;
  47 #include &quot;sun_security_krb5_Credentials.h&quot;
  48 
  49 #undef LSA_SUCCESS
  50 #define LSA_SUCCESS(Status) ((Status) &gt;= 0)
  51 #define EXIT_FAILURE -1 // mdu
  52 
  53 /*
  54  * Library-wide static references
  55  */
  56 

  57 jclass ticketClass = NULL;
  58 jclass principalNameClass = NULL;
  59 jclass encryptionKeyClass = NULL;
  60 jclass ticketFlagsClass = NULL;
  61 jclass kerberosTimeClass = NULL;
  62 jclass javaLangStringClass = NULL;
  63 

  64 jmethodID ticketConstructor = 0;
  65 jmethodID principalNameConstructor = 0;
  66 jmethodID encryptionKeyConstructor = 0;
  67 jmethodID ticketFlagsConstructor = 0;
  68 jmethodID kerberosTimeConstructor = 0;
  69 jmethodID krbcredsConstructor = 0;
  70 
  71 /*
  72  * Function prototypes for internal routines
  73  *
  74  */
  75 BOOL native_debug = 0;
  76 
  77 BOOL PackageConnectLookup(PHANDLE,PULONG);
  78 
  79 NTSTATUS ConstructTicketRequest(JNIEnv *env,
  80                                 UNICODE_STRING DomainName,
  81                                 PKERB_RETRIEVE_TKT_REQUEST *outRequest,
  82                                 ULONG *outSize);
  83 
</pre>
<hr />
<pre>
 153     }
 154 
 155     cls = (*env)-&gt;FindClass(env, &quot;sun/security/krb5/PrincipalName&quot;);
 156 
 157     if (cls == NULL) {
 158         printf(&quot;LSA: Couldn&#39;t find PrincipalName\n&quot;);
 159         return JNI_ERR;
 160     }
 161     if (native_debug) {
 162         printf(&quot;LSA: Found PrincipalName\n&quot;);
 163     }
 164 
 165     principalNameClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 166     if (principalNameClass == NULL) {
 167         return JNI_ERR;
 168     }
 169     if (native_debug) {
 170         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 171     }
 172 


















 173     cls = (*env)-&gt;FindClass(env,&quot;sun/security/krb5/EncryptionKey&quot;);
 174 
 175     if (cls == NULL) {
 176         printf(&quot;LSA: Couldn&#39;t find EncryptionKey\n&quot;);
 177         return JNI_ERR;
 178     }
 179     if (native_debug) {
 180         printf(&quot;LSA: Found EncryptionKey\n&quot;);
 181     }
 182 
 183     encryptionKeyClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 184     if (encryptionKeyClass == NULL) {
 185         return JNI_ERR;
 186     }
 187     if (native_debug) {
 188         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 189     }
 190 
 191     cls = (*env)-&gt;FindClass(env,&quot;sun/security/krb5/internal/TicketFlags&quot;);
 192 
</pre>
<hr />
<pre>
 225     }
 226 
 227     cls = (*env)-&gt;FindClass(env,&quot;java/lang/String&quot;);
 228 
 229     if (cls == NULL) {
 230         printf(&quot;LSA: Couldn&#39;t find String\n&quot;);
 231         return JNI_ERR;
 232     }
 233     if (native_debug) {
 234         printf(&quot;LSA: Found String\n&quot;);
 235     }
 236 
 237     javaLangStringClass = (*env)-&gt;NewWeakGlobalRef(env,cls);
 238     if (javaLangStringClass == NULL) {
 239         return JNI_ERR;
 240     }
 241     if (native_debug) {
 242         printf(&quot;LSA: Made NewWeakGlobalRef\n&quot;);
 243     }
 244 










 245     ticketConstructor = (*env)-&gt;GetMethodID(env, ticketClass,
<span class="line-modified"> 246                             &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);</span>
 247     if (ticketConstructor == 0) {
 248         printf(&quot;LSA: Couldn&#39;t find Ticket constructor\n&quot;);
 249         return JNI_ERR;
 250     }
 251     if (native_debug) {
 252         printf(&quot;LSA: Found Ticket constructor\n&quot;);
 253     }
 254 
 255     principalNameConstructor = (*env)-&gt;GetMethodID(env, principalNameClass,
 256                         &quot;&lt;init&gt;&quot;, &quot;([Ljava/lang/String;Ljava/lang/String;)V&quot;);
 257     if (principalNameConstructor == 0) {
 258         printf(&quot;LSA: Couldn&#39;t find PrincipalName constructor\n&quot;);
 259         return JNI_ERR;
 260     }
 261     if (native_debug) {
 262         printf(&quot;LSA: Found PrincipalName constructor\n&quot;);
 263     }
 264 
 265     encryptionKeyConstructor = (*env)-&gt;GetMethodID(env, encryptionKeyClass,
 266                                             &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
</pre>
<hr />
<pre>
 300 }
 301 
 302 /*
 303  * Class:     sun_security_jgss_KrbCreds
 304  * Method:    JNI_OnUnload
 305  */
 306 
 307 JNIEXPORT void JNICALL DEF_JNI_OnUnload(
 308         JavaVM  *jvm,
 309         void    *reserved) {
 310 
 311     JNIEnv *env;
 312 
 313     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
 314         return; /* Nothing else we can do */
 315     }
 316 
 317     if (ticketClass != NULL) {
 318         (*env)-&gt;DeleteWeakGlobalRef(env,ticketClass);
 319     }



 320     if (principalNameClass != NULL) {
 321         (*env)-&gt;DeleteWeakGlobalRef(env,principalNameClass);
 322     }
 323     if (encryptionKeyClass != NULL) {
 324         (*env)-&gt;DeleteWeakGlobalRef(env,encryptionKeyClass);
 325     }
 326     if (ticketFlagsClass != NULL) {
 327         (*env)-&gt;DeleteWeakGlobalRef(env,ticketFlagsClass);
 328     }
 329     if (kerberosTimeClass != NULL) {
 330         (*env)-&gt;DeleteWeakGlobalRef(env,kerberosTimeClass);
 331     }
 332     if (javaLangStringClass != NULL) {
 333         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangStringClass);
 334     }
 335 
 336     return;
 337 }
 338 
 339 /*
</pre>
<hr />
<pre>
 356     ULONG rspSize = 0;
 357     HANDLE LogonHandle = NULL;
 358     ULONG PackageId;
 359     jobject ticket, clientPrincipal, targetPrincipal, encryptionKey;
 360     jobject ticketFlags, startTime, endTime, krbCreds = NULL;
 361     jobject authTime, renewTillTime, hostAddresses = NULL;
 362     KERB_EXTERNAL_TICKET *msticket;
 363     int found = 0;
 364     FILETIME Now, EndTime;
 365 
 366     int i, netypes;
 367     jint *etypes = NULL;
 368 
 369     while (TRUE) {
 370 
 371         if (krbcredsConstructor == 0) {
 372             krbcredsConstructor = (*env)-&gt;GetMethodID(env, krbcredsClass, &quot;&lt;init&gt;&quot;,
 373                     &quot;(Lsun/security/krb5/internal/Ticket;&quot;
 374                     &quot;Lsun/security/krb5/PrincipalName;&quot;
 375                     &quot;Lsun/security/krb5/PrincipalName;&quot;
<span class="line-added"> 376                     &quot;Lsun/security/krb5/PrincipalName;&quot;</span>
<span class="line-added"> 377                     &quot;Lsun/security/krb5/PrincipalName;&quot;</span>
 378                     &quot;Lsun/security/krb5/EncryptionKey;&quot;
 379                     &quot;Lsun/security/krb5/internal/TicketFlags;&quot;
 380                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 381                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 382                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 383                     &quot;Lsun/security/krb5/internal/KerberosTime;&quot;
 384                     &quot;Lsun/security/krb5/internal/HostAddresses;)V&quot;);
 385             if (krbcredsConstructor == 0) {
 386                 printf(&quot;LSA: Couldn&#39;t find sun.security.krb5.Credentials constructor\n&quot;);
 387                 break;
 388             }
 389         }
 390 
 391         if (native_debug) {
 392             printf(&quot;LSA: Found KrbCreds constructor\n&quot;);
 393         }
 394 
 395         //
 396         // Get the logon handle and package ID from the
 397         // Kerberos package
</pre>
<hr />
<pre>
 619 
 620         // and the end time
 621         endTime = BuildKerberosTime(env, &amp;(msticket-&gt;EndTime));
 622         if (endTime == NULL) {
 623             break;
 624         }
 625 
 626         // Get the renew till time
 627         renewTillTime = BuildKerberosTime(env, &amp;(msticket-&gt;RenewUntil));
 628         if (renewTillTime == NULL) {
 629             break;
 630         }
 631 
 632         // and now go build a KrbCreds object
 633         krbCreds = (*env)-&gt;NewObject(
 634                 env,
 635                 krbcredsClass,
 636                 krbcredsConstructor,
 637                 ticket,
 638                 clientPrincipal,
<span class="line-added"> 639                 NULL,</span>
 640                 targetPrincipal,
<span class="line-added"> 641                 NULL,</span>
 642                 encryptionKey,
 643                 ticketFlags,
 644                 authTime, // mdu
 645                 startTime,
 646                 endTime,
 647                 renewTillTime, //mdu
 648                 hostAddresses);
 649 
 650         break;
 651     } // end of WHILE. This WHILE will never loop.
 652 
 653     // clean up resources
 654     if (TktCacheResponse != NULL) {
 655         LsaFreeReturnBuffer(TktCacheResponse);
 656     }
 657     if (pTicketRequest) {
 658         LocalFree(pTicketRequest);
 659     }
 660     if (pTicketResponse != NULL) {
 661         LsaFreeReturnBuffer(pTicketResponse);
</pre>
<hr />
<pre>
 847         PUNICODE_STRING DestinationString,
 848     PCWSTR SourceString OPTIONAL
 849     )
 850 {
 851     ULONG Length;
 852 
 853     DestinationString-&gt;Buffer = (PWSTR)SourceString;
 854     if (SourceString != NULL) {
 855         Length = (ULONG)wcslen( SourceString ) * sizeof( WCHAR );
 856         DestinationString-&gt;Length = (USHORT)Length;
 857         DestinationString-&gt;MaximumLength = (USHORT)(Length + sizeof(UNICODE_NULL));
 858     }
 859     else {
 860         DestinationString-&gt;MaximumLength = 0;
 861         DestinationString-&gt;Length = 0;
 862     }
 863 }
 864 
 865 jobject BuildTicket(JNIEnv *env, PUCHAR encodedTicket, ULONG encodedTicketSize) {
 866 
<span class="line-modified"> 867     // To build a Ticket, we need to make a byte array out of the EncodedTicket.</span>


 868 
<span class="line-modified"> 869     jobject ticket;</span>
 870     jbyteArray ary;
 871 
 872     ary = (*env)-&gt;NewByteArray(env,encodedTicketSize);
 873     if (ary == NULL) {
 874         return (jobject) NULL;
 875     }
 876 
 877     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, encodedTicketSize,
 878                                     (jbyte *)encodedTicket);
 879     if ((*env)-&gt;ExceptionOccurred(env)) {
 880         (*env)-&gt;DeleteLocalRef(env, ary);
 881         return (jobject) NULL;
 882     }
 883 
<span class="line-modified"> 884     ticket = (*env)-&gt;NewObject(env, ticketClass, ticketConstructor, ary);</span>
 885     if ((*env)-&gt;ExceptionOccurred(env)) {
 886         (*env)-&gt;DeleteLocalRef(env, ary);
 887         return (jobject) NULL;
 888     }

 889     (*env)-&gt;DeleteLocalRef(env, ary);






 890     return ticket;
 891 }
 892 
 893 // mdu
 894 jobject BuildPrincipal(JNIEnv *env, PKERB_EXTERNAL_NAME principalName,
 895                                 UNICODE_STRING domainName) {
 896 
 897     /*
 898      * To build the Principal, we need to get the names out of
 899      * this goofy MS structure
 900      */
 901     jobject principal = NULL;
 902     jobject realmStr = NULL;
 903     jobjectArray stringArray;
 904     jstring tempString;
 905     int nameCount,i;
 906     PUNICODE_STRING scanner;
 907     WCHAR *realm;
 908     ULONG realmLen;
 909 
</pre>
</td>
</tr>
</table>
<center><a href="../../classes/sun/security/krb5/internal/tools/Klist.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../java.security.sasl/share/classes/com/sun/security/sasl/ClientFactoryImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>