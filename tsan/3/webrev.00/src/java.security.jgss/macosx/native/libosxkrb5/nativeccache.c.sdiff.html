<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/macosx/native/libosxkrb5/nativeccache.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="SCDynamicStoreConfig.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/javax/security/auth/kerberos/DelegationPermission.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/macosx/native/libosxkrb5/nativeccache.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 26 #import &quot;sun_security_krb5_Credentials.h&quot;
 27 #import &lt;Kerberos/Kerberos.h&gt;
 28 #import &lt;string.h&gt;
 29 #import &lt;time.h&gt;
 30 
 31 #include &quot;jni_util.h&quot;
 32 
 33 /*
 34  * Based largely on klist.c,
 35  *
 36  * Created by Scott Kovatch on 8/12/04.
 37  *
 38  * See http://www.opensource.apple.com/darwinsource/10.3.3/Kerberos-47/KerberosClients/klist/Sources/klist.c
 39 
 40  */
 41 
 42 /*
 43  * Statics for this module
 44  */
 45 
<span class="line-removed"> 46 static jclass derValueClass = NULL;</span>
 47 static jclass ticketClass = NULL;
 48 static jclass principalNameClass = NULL;
 49 static jclass encryptionKeyClass = NULL;
 50 static jclass ticketFlagsClass = NULL;
 51 static jclass kerberosTimeClass = NULL;
 52 static jclass javaLangStringClass = NULL;
 53 static jclass javaLangIntegerClass = NULL;
 54 static jclass hostAddressClass = NULL;
 55 static jclass hostAddressesClass = NULL;
 56 
<span class="line-removed"> 57 static jmethodID derValueConstructor = 0;</span>
 58 static jmethodID ticketConstructor = 0;
 59 static jmethodID principalNameConstructor = 0;
 60 static jmethodID encryptionKeyConstructor = 0;
 61 static jmethodID ticketFlagsConstructor = 0;
 62 static jmethodID kerberosTimeConstructor = 0;
 63 static jmethodID krbcredsConstructor = 0;
 64 static jmethodID integerConstructor = 0;
 65 static jmethodID hostAddressConstructor = 0;
 66 static jmethodID hostAddressesConstructor = 0;
 67 
 68 /*
 69  * Function prototypes for internal routines
 70  */
 71 
 72 static jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket);
 73 static jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName);
 74 static jobject BuildEncryptionKey(JNIEnv *env, krb5_keyblock *cryptoKey);
 75 static jobject BuildTicketFlags(JNIEnv *env, krb5_flags flags);
 76 static jobject BuildKerberosTime(JNIEnv *env, krb5_timestamp kerbtime);
 77 static jobject BuildAddressList(JNIEnv *env, krb5_address **kerbtime);
</pre>
<hr />
<pre>
 91     return returnValue;
 92 }
 93 /*
 94  * Class:     sun_security_krb5_KrbCreds
 95  * Method:    JNI_OnLoad
 96  */
 97 JNIEXPORT jint JNICALL DEF_JNI_OnLoad(JavaVM *jvm, void *reserved)
 98 {
 99     JNIEnv *env;
100 
101     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_4)) {
102         return JNI_EVERSION; /* JNI version not supported */
103     }
104 
105     ticketClass = FindClass(env, &quot;sun/security/krb5/internal/Ticket&quot;);
106     if (ticketClass == NULL) return JNI_ERR;
107 
108     principalNameClass = FindClass(env, &quot;sun/security/krb5/PrincipalName&quot;);
109     if (principalNameClass == NULL) return JNI_ERR;
110 
<span class="line-removed">111     derValueClass = FindClass(env, &quot;sun/security/util/DerValue&quot;);</span>
<span class="line-removed">112     if (derValueClass == NULL) return JNI_ERR;</span>
<span class="line-removed">113 </span>
114     encryptionKeyClass = FindClass(env, &quot;sun/security/krb5/EncryptionKey&quot;);
115     if (encryptionKeyClass == NULL) return JNI_ERR;
116 
117     ticketFlagsClass = FindClass(env,&quot;sun/security/krb5/internal/TicketFlags&quot;);
118     if (ticketFlagsClass == NULL) return JNI_ERR;
119 
120     kerberosTimeClass = FindClass(env,&quot;sun/security/krb5/internal/KerberosTime&quot;);
121     if (kerberosTimeClass == NULL) return JNI_ERR;
122 
123     javaLangStringClass = FindClass(env,&quot;java/lang/String&quot;);
124     if (javaLangStringClass == NULL) return JNI_ERR;
125 
126     javaLangIntegerClass = FindClass(env,&quot;java/lang/Integer&quot;);
127     if (javaLangIntegerClass == NULL) return JNI_ERR;
128 
129     hostAddressClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddress&quot;);
130     if (hostAddressClass == NULL) return JNI_ERR;
131 
132     hostAddressesClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddresses&quot;);
133     if (hostAddressesClass == NULL) return JNI_ERR;
134 
<span class="line-modified">135     derValueConstructor = (*env)-&gt;GetMethodID(env, derValueClass, &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);</span>
<span class="line-removed">136     if (derValueConstructor == 0) {</span>
<span class="line-removed">137         printf(&quot;Couldn&#39;t find DerValue constructor\n&quot;);</span>
<span class="line-removed">138         return JNI_ERR;</span>
<span class="line-removed">139     }</span>
<span class="line-removed">140 </span>
<span class="line-removed">141     ticketConstructor = (*env)-&gt;GetMethodID(env, ticketClass, &quot;&lt;init&gt;&quot;, &quot;(Lsun/security/util/DerValue;)V&quot;);</span>
142     if (ticketConstructor == 0) {
143         printf(&quot;Couldn&#39;t find Ticket constructor\n&quot;);
144         return JNI_ERR;
145     }
146 
147     principalNameConstructor = (*env)-&gt;GetMethodID(env, principalNameClass, &quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;I)V&quot;);
148     if (principalNameConstructor == 0) {
149         printf(&quot;Couldn&#39;t find PrincipalName constructor\n&quot;);
150         return JNI_ERR;
151     }
152 
153     encryptionKeyConstructor = (*env)-&gt;GetMethodID(env, encryptionKeyClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
154     if (encryptionKeyConstructor == 0) {
155         printf(&quot;Couldn&#39;t find EncryptionKey constructor\n&quot;);
156         return JNI_ERR;
157     }
158 
159     ticketFlagsConstructor = (*env)-&gt;GetMethodID(env, ticketFlagsClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
160     if (ticketFlagsConstructor == 0) {
161         printf(&quot;Couldn&#39;t find TicketFlags constructor\n&quot;);
</pre>
<hr />
<pre>
187     }
188 
189     return JNI_VERSION_1_2;
190 }
191 
192 /*
193  * Class:     sun_security_jgss_KrbCreds
194  * Method:    JNI_OnUnload
195  */
196 JNIEXPORT void JNICALL DEF_JNI_OnUnload(JavaVM *jvm, void *reserved)
197 {
198     JNIEnv *env;
199 
200     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
201         return; /* Nothing else we can do */
202     }
203 
204     if (ticketClass != NULL) {
205         (*env)-&gt;DeleteWeakGlobalRef(env,ticketClass);
206     }
<span class="line-removed">207     if (derValueClass != NULL) {</span>
<span class="line-removed">208         (*env)-&gt;DeleteWeakGlobalRef(env,derValueClass);</span>
<span class="line-removed">209     }</span>
210     if (principalNameClass != NULL) {
211         (*env)-&gt;DeleteWeakGlobalRef(env,principalNameClass);
212     }
213     if (encryptionKeyClass != NULL) {
214         (*env)-&gt;DeleteWeakGlobalRef(env,encryptionKeyClass);
215     }
216     if (ticketFlagsClass != NULL) {
217         (*env)-&gt;DeleteWeakGlobalRef(env,ticketFlagsClass);
218     }
219     if (kerberosTimeClass != NULL) {
220         (*env)-&gt;DeleteWeakGlobalRef(env,kerberosTimeClass);
221     }
222     if (javaLangStringClass != NULL) {
223         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangStringClass);
224     }
225     if (javaLangIntegerClass != NULL) {
226         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangIntegerClass);
227     }
228     if (hostAddressClass != NULL) {
229         (*env)-&gt;DeleteWeakGlobalRef(env,hostAddressClass);
</pre>
<hr />
<pre>
244 }
245 
246 /*
247  * Class:     sun_security_krb5_Credentials
248  * Method:    acquireDefaultNativeCreds
249  * Signature: ([I])Lsun/security/krb5/Credentials;
250  */
251 JNIEXPORT jobject JNICALL Java_sun_security_krb5_Credentials_acquireDefaultNativeCreds
252 (JNIEnv *env, jclass krbcredsClass, jintArray jetypes)
253 {
254     jobject krbCreds = NULL;
255     krb5_error_code err = 0;
256     krb5_ccache ccache = NULL;
257     krb5_cc_cursor cursor = NULL;
258     krb5_creds creds;
259     krb5_flags flags = 0;
260     krb5_context kcontext = NULL;
261 
262     int netypes;
263     jint *etypes = NULL;

264 
265     /* Initialize the Kerberos 5 context */
266     err = krb5_init_context (&amp;kcontext);
267 
268     if (!err) {
269         err = krb5_cc_default (kcontext, &amp;ccache);
270     }
271 
272     if (!err) {
273         err = krb5_cc_set_flags (kcontext, ccache, flags); /* turn off OPENCLOSE */
274     }
275 










































276     if (!err) {
277         err = krb5_cc_start_seq_get (kcontext, ccache, &amp;cursor);
278     }
279 
280     netypes = (*env)-&gt;GetArrayLength(env, jetypes);
281     etypes = (jint *) (*env)-&gt;GetIntArrayElements(env, jetypes, NULL);
282 
283     if (etypes != NULL &amp;&amp; !err) {
284         while ((err = krb5_cc_next_cred (kcontext, ccache, &amp;cursor, &amp;creds)) == 0) {
285             char *serverName = NULL;
286 
287             if (!err) {
288                 err = krb5_unparse_name (kcontext, creds.server, &amp;serverName);
289                 printiferr (err, &quot;while unparsing server name&quot;);
290             }
291 
292             if (!err) {
293                 char* slash = strchr(serverName, &#39;/&#39;);
294                 char* at = strchr(serverName, &#39;@&#39;);
295                 // Make sure the server&#39;s name is krbtgt/REALM@REALM, the etype
</pre>
<hr />
<pre>
328                     if (ticketFlags == NULL) goto cleanup;
329 
330                     // Get the timestamps out.
331                     startTime = BuildKerberosTime(env, creds.times.starttime);
332                     if (startTime == NULL) goto cleanup;
333 
334                     authTime = BuildKerberosTime(env, creds.times.authtime);
335                     if (authTime == NULL) goto cleanup;
336 
337                     endTime = BuildKerberosTime(env, creds.times.endtime);
338                     if (endTime == NULL) goto cleanup;
339 
340                     renewTillTime = BuildKerberosTime(env, creds.times.renew_till);
341                     if (renewTillTime == NULL) goto cleanup;
342 
343                     // Create the addresses object.
344                     hostAddresses = BuildAddressList(env, creds.addresses);
345 
346                     if (krbcredsConstructor == 0) {
347                         krbcredsConstructor = (*env)-&gt;GetMethodID(env, krbcredsClass, &quot;&lt;init&gt;&quot;,
<span class="line-modified">348                                                                   &quot;(Lsun/security/krb5/internal/Ticket;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/EncryptionKey;Lsun/security/krb5/internal/TicketFlags;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/HostAddresses;)V&quot;);</span>
349                         if (krbcredsConstructor == 0) {
350                             printf(&quot;Couldn&#39;t find sun.security.krb5.internal.Ticket constructor\n&quot;);
351                             break;
352                         }
353                     }
354 
355                     // and now go build a KrbCreds object
356                     krbCreds = (*env)-&gt;NewObject(
357                                                  env,
358                                                  krbcredsClass,
359                                                  krbcredsConstructor,
360                                                  ticket,
361                                                  clientPrincipal,

362                                                  targetPrincipal,

363                                                  encryptionKey,
364                                                  ticketFlags,
365                                                  authTime,
366                                                  startTime,
367                                                  endTime,
368                                                  renewTillTime,
369                                                  hostAddresses);
370 cleanup:
371                     if (ticket) (*env)-&gt;DeleteLocalRef(env, ticket);
372                     if (clientPrincipal) (*env)-&gt;DeleteLocalRef(env, clientPrincipal);
373                     if (targetPrincipal) (*env)-&gt;DeleteLocalRef(env, targetPrincipal);
374                     if (encryptionKey) (*env)-&gt;DeleteLocalRef(env, encryptionKey);
375                     if (ticketFlags) (*env)-&gt;DeleteLocalRef(env, ticketFlags);
376                     if (authTime) (*env)-&gt;DeleteLocalRef(env, authTime);
377                     if (startTime) (*env)-&gt;DeleteLocalRef(env, startTime);
378                     if (endTime) (*env)-&gt;DeleteLocalRef(env, endTime);
379                     if (renewTillTime) (*env)-&gt;DeleteLocalRef(env, renewTillTime);
380                     if (hostAddresses) (*env)-&gt;DeleteLocalRef(env, hostAddresses);
381 
382                     // Stop if there is an exception or we already found the initial TGT
383                     if ((*env)-&gt;ExceptionCheck(env) || krbCreds) {
384                         break;
385                     }
386                 }
387             }
388 
389             if (serverName != NULL) { krb5_free_unparsed_name (kcontext, serverName); }
390 
391             krb5_free_cred_contents (kcontext, &amp;creds);
392         }
393 
394         if (err == KRB5_CC_END) { err = 0; }
395         printiferr (err, &quot;while retrieving a ticket&quot;);
396     }
397 
398     if (!err) {
399         err = krb5_cc_end_seq_get (kcontext, ccache, &amp;cursor);
400         printiferr (err, &quot;while finishing ticket retrieval&quot;);
401     }
402 

403     if (!err) {
404         flags = KRB5_TC_OPENCLOSE; /* restore OPENCLOSE mode */
405         err = krb5_cc_set_flags (kcontext, ccache, flags);
406         printiferr (err, &quot;while finishing ticket retrieval&quot;);
407     }
408 
409     if (etypes != NULL) {
410         (*env)-&gt;ReleaseIntArrayElements(env, jetypes, etypes, 0);
411     }
412 
413     krb5_free_context (kcontext);
414     return krbCreds;
415 }
416 
417 
418 #pragma mark -
419 
420 jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket)
421 {
<span class="line-modified">422     /* To build a Ticket, we first need to build a DerValue out of the EncodedTicket.</span>
<span class="line-removed">423     * But before we can do that, we need to make a byte array out of the ET.</span>
<span class="line-removed">424     */</span>
425 
<span class="line-modified">426     jobject derValue, ticket;</span>
427     jbyteArray ary;
428 
429     ary = (*env)-&gt;NewByteArray(env, encodedTicket-&gt;length);
430     if ((*env)-&gt;ExceptionCheck(env)) {
431         return (jobject) NULL;
432     }
433 
434     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, encodedTicket-&gt;length, (jbyte *)encodedTicket-&gt;data);
435     if ((*env)-&gt;ExceptionCheck(env)) {
436         (*env)-&gt;DeleteLocalRef(env, ary);
437         return (jobject) NULL;
438     }
439 
<span class="line-modified">440     derValue = (*env)-&gt;NewObject(env, derValueClass, derValueConstructor, ary);</span>
441     if ((*env)-&gt;ExceptionCheck(env)) {
442         (*env)-&gt;DeleteLocalRef(env, ary);
443         return (jobject) NULL;
444     }
<span class="line-removed">445 </span>
446     (*env)-&gt;DeleteLocalRef(env, ary);
<span class="line-removed">447     ticket = (*env)-&gt;NewObject(env, ticketClass, ticketConstructor, derValue);</span>
<span class="line-removed">448     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">449         (*env)-&gt;DeleteLocalRef(env, derValue);</span>
<span class="line-removed">450         return (jobject) NULL;</span>
<span class="line-removed">451     }</span>
<span class="line-removed">452     (*env)-&gt;DeleteLocalRef(env, derValue);</span>
453     return ticket;
454 }
455 
456 jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName) {
457     // Get the full principal string.
458     char *principalString = NULL;
459     jobject principal = NULL;
460     int err = krb5_unparse_name (kcontext, principalName, &amp;principalString);
461 
462     if (!err) {
463         // Make a PrincipalName from the full string and the type.  Let the PrincipalName class parse it out.
464         jstring principalStringObj = (*env)-&gt;NewStringUTF(env, principalString);
465         if (principalStringObj == NULL) {
466             if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
467             return (jobject) NULL;
468         }
469         principal = (*env)-&gt;NewObject(env, principalNameClass, principalNameConstructor, principalStringObj, principalName-&gt;type);
470         if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
471         (*env)-&gt;DeleteLocalRef(env, principalStringObj);
472     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 26 #import &quot;sun_security_krb5_Credentials.h&quot;
 27 #import &lt;Kerberos/Kerberos.h&gt;
 28 #import &lt;string.h&gt;
 29 #import &lt;time.h&gt;
 30 
 31 #include &quot;jni_util.h&quot;
 32 
 33 /*
 34  * Based largely on klist.c,
 35  *
 36  * Created by Scott Kovatch on 8/12/04.
 37  *
 38  * See http://www.opensource.apple.com/darwinsource/10.3.3/Kerberos-47/KerberosClients/klist/Sources/klist.c
 39 
 40  */
 41 
 42 /*
 43  * Statics for this module
 44  */
 45 

 46 static jclass ticketClass = NULL;
 47 static jclass principalNameClass = NULL;
 48 static jclass encryptionKeyClass = NULL;
 49 static jclass ticketFlagsClass = NULL;
 50 static jclass kerberosTimeClass = NULL;
 51 static jclass javaLangStringClass = NULL;
 52 static jclass javaLangIntegerClass = NULL;
 53 static jclass hostAddressClass = NULL;
 54 static jclass hostAddressesClass = NULL;
 55 

 56 static jmethodID ticketConstructor = 0;
 57 static jmethodID principalNameConstructor = 0;
 58 static jmethodID encryptionKeyConstructor = 0;
 59 static jmethodID ticketFlagsConstructor = 0;
 60 static jmethodID kerberosTimeConstructor = 0;
 61 static jmethodID krbcredsConstructor = 0;
 62 static jmethodID integerConstructor = 0;
 63 static jmethodID hostAddressConstructor = 0;
 64 static jmethodID hostAddressesConstructor = 0;
 65 
 66 /*
 67  * Function prototypes for internal routines
 68  */
 69 
 70 static jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket);
 71 static jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName);
 72 static jobject BuildEncryptionKey(JNIEnv *env, krb5_keyblock *cryptoKey);
 73 static jobject BuildTicketFlags(JNIEnv *env, krb5_flags flags);
 74 static jobject BuildKerberosTime(JNIEnv *env, krb5_timestamp kerbtime);
 75 static jobject BuildAddressList(JNIEnv *env, krb5_address **kerbtime);
</pre>
<hr />
<pre>
 89     return returnValue;
 90 }
 91 /*
 92  * Class:     sun_security_krb5_KrbCreds
 93  * Method:    JNI_OnLoad
 94  */
 95 JNIEXPORT jint JNICALL DEF_JNI_OnLoad(JavaVM *jvm, void *reserved)
 96 {
 97     JNIEnv *env;
 98 
 99     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_4)) {
100         return JNI_EVERSION; /* JNI version not supported */
101     }
102 
103     ticketClass = FindClass(env, &quot;sun/security/krb5/internal/Ticket&quot;);
104     if (ticketClass == NULL) return JNI_ERR;
105 
106     principalNameClass = FindClass(env, &quot;sun/security/krb5/PrincipalName&quot;);
107     if (principalNameClass == NULL) return JNI_ERR;
108 



109     encryptionKeyClass = FindClass(env, &quot;sun/security/krb5/EncryptionKey&quot;);
110     if (encryptionKeyClass == NULL) return JNI_ERR;
111 
112     ticketFlagsClass = FindClass(env,&quot;sun/security/krb5/internal/TicketFlags&quot;);
113     if (ticketFlagsClass == NULL) return JNI_ERR;
114 
115     kerberosTimeClass = FindClass(env,&quot;sun/security/krb5/internal/KerberosTime&quot;);
116     if (kerberosTimeClass == NULL) return JNI_ERR;
117 
118     javaLangStringClass = FindClass(env,&quot;java/lang/String&quot;);
119     if (javaLangStringClass == NULL) return JNI_ERR;
120 
121     javaLangIntegerClass = FindClass(env,&quot;java/lang/Integer&quot;);
122     if (javaLangIntegerClass == NULL) return JNI_ERR;
123 
124     hostAddressClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddress&quot;);
125     if (hostAddressClass == NULL) return JNI_ERR;
126 
127     hostAddressesClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddresses&quot;);
128     if (hostAddressesClass == NULL) return JNI_ERR;
129 
<span class="line-modified">130     ticketConstructor = (*env)-&gt;GetMethodID(env, ticketClass, &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);</span>






131     if (ticketConstructor == 0) {
132         printf(&quot;Couldn&#39;t find Ticket constructor\n&quot;);
133         return JNI_ERR;
134     }
135 
136     principalNameConstructor = (*env)-&gt;GetMethodID(env, principalNameClass, &quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;I)V&quot;);
137     if (principalNameConstructor == 0) {
138         printf(&quot;Couldn&#39;t find PrincipalName constructor\n&quot;);
139         return JNI_ERR;
140     }
141 
142     encryptionKeyConstructor = (*env)-&gt;GetMethodID(env, encryptionKeyClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
143     if (encryptionKeyConstructor == 0) {
144         printf(&quot;Couldn&#39;t find EncryptionKey constructor\n&quot;);
145         return JNI_ERR;
146     }
147 
148     ticketFlagsConstructor = (*env)-&gt;GetMethodID(env, ticketFlagsClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
149     if (ticketFlagsConstructor == 0) {
150         printf(&quot;Couldn&#39;t find TicketFlags constructor\n&quot;);
</pre>
<hr />
<pre>
176     }
177 
178     return JNI_VERSION_1_2;
179 }
180 
181 /*
182  * Class:     sun_security_jgss_KrbCreds
183  * Method:    JNI_OnUnload
184  */
185 JNIEXPORT void JNICALL DEF_JNI_OnUnload(JavaVM *jvm, void *reserved)
186 {
187     JNIEnv *env;
188 
189     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
190         return; /* Nothing else we can do */
191     }
192 
193     if (ticketClass != NULL) {
194         (*env)-&gt;DeleteWeakGlobalRef(env,ticketClass);
195     }



196     if (principalNameClass != NULL) {
197         (*env)-&gt;DeleteWeakGlobalRef(env,principalNameClass);
198     }
199     if (encryptionKeyClass != NULL) {
200         (*env)-&gt;DeleteWeakGlobalRef(env,encryptionKeyClass);
201     }
202     if (ticketFlagsClass != NULL) {
203         (*env)-&gt;DeleteWeakGlobalRef(env,ticketFlagsClass);
204     }
205     if (kerberosTimeClass != NULL) {
206         (*env)-&gt;DeleteWeakGlobalRef(env,kerberosTimeClass);
207     }
208     if (javaLangStringClass != NULL) {
209         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangStringClass);
210     }
211     if (javaLangIntegerClass != NULL) {
212         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangIntegerClass);
213     }
214     if (hostAddressClass != NULL) {
215         (*env)-&gt;DeleteWeakGlobalRef(env,hostAddressClass);
</pre>
<hr />
<pre>
230 }
231 
232 /*
233  * Class:     sun_security_krb5_Credentials
234  * Method:    acquireDefaultNativeCreds
235  * Signature: ([I])Lsun/security/krb5/Credentials;
236  */
237 JNIEXPORT jobject JNICALL Java_sun_security_krb5_Credentials_acquireDefaultNativeCreds
238 (JNIEnv *env, jclass krbcredsClass, jintArray jetypes)
239 {
240     jobject krbCreds = NULL;
241     krb5_error_code err = 0;
242     krb5_ccache ccache = NULL;
243     krb5_cc_cursor cursor = NULL;
244     krb5_creds creds;
245     krb5_flags flags = 0;
246     krb5_context kcontext = NULL;
247 
248     int netypes;
249     jint *etypes = NULL;
<span class="line-added">250     int proxy_flag = 0;</span>
251 
252     /* Initialize the Kerberos 5 context */
253     err = krb5_init_context (&amp;kcontext);
254 
255     if (!err) {
256         err = krb5_cc_default (kcontext, &amp;ccache);
257     }
258 
259     if (!err) {
260         err = krb5_cc_set_flags (kcontext, ccache, flags); /* turn off OPENCLOSE */
261     }
262 
<span class="line-added">263     // First round read. The proxy_impersonator config flag is not supported.</span>
<span class="line-added">264     // This ccache will not be used if this flag exists.</span>
<span class="line-added">265     if (!err) {</span>
<span class="line-added">266         err = krb5_cc_start_seq_get (kcontext, ccache, &amp;cursor);</span>
<span class="line-added">267     }</span>
<span class="line-added">268 </span>
<span class="line-added">269     if (!err) {</span>
<span class="line-added">270         while ((err = krb5_cc_next_cred (kcontext, ccache, &amp;cursor, &amp;creds)) == 0) {</span>
<span class="line-added">271             char *serverName = NULL;</span>
<span class="line-added">272 </span>
<span class="line-added">273             if (!err) {</span>
<span class="line-added">274                 err = krb5_unparse_name (kcontext, creds.server, &amp;serverName);</span>
<span class="line-added">275                 printiferr (err, &quot;while unparsing server name&quot;);</span>
<span class="line-added">276             }</span>
<span class="line-added">277 </span>
<span class="line-added">278             if (!err) {</span>
<span class="line-added">279                 if (!strcmp(serverName, &quot;krb5_ccache_conf_data/proxy_impersonator@X-CACHECONF:&quot;)) {</span>
<span class="line-added">280                     proxy_flag = 1;</span>
<span class="line-added">281                 }</span>
<span class="line-added">282             }</span>
<span class="line-added">283 </span>
<span class="line-added">284             if (serverName != NULL) { krb5_free_unparsed_name (kcontext, serverName); }</span>
<span class="line-added">285 </span>
<span class="line-added">286             krb5_free_cred_contents (kcontext, &amp;creds);</span>
<span class="line-added">287 </span>
<span class="line-added">288             if (proxy_flag) break;</span>
<span class="line-added">289         }</span>
<span class="line-added">290 </span>
<span class="line-added">291         if (err == KRB5_CC_END) { err = 0; }</span>
<span class="line-added">292         printiferr (err, &quot;while retrieving a ticket&quot;);</span>
<span class="line-added">293     }</span>
<span class="line-added">294 </span>
<span class="line-added">295     if (!err) {</span>
<span class="line-added">296         err = krb5_cc_end_seq_get (kcontext, ccache, &amp;cursor);</span>
<span class="line-added">297         printiferr (err, &quot;while finishing ticket retrieval&quot;);</span>
<span class="line-added">298     }</span>
<span class="line-added">299 </span>
<span class="line-added">300     if (proxy_flag) {</span>
<span class="line-added">301         goto outer_cleanup;</span>
<span class="line-added">302     }</span>
<span class="line-added">303     // End of first round read</span>
<span class="line-added">304 </span>
305     if (!err) {
306         err = krb5_cc_start_seq_get (kcontext, ccache, &amp;cursor);
307     }
308 
309     netypes = (*env)-&gt;GetArrayLength(env, jetypes);
310     etypes = (jint *) (*env)-&gt;GetIntArrayElements(env, jetypes, NULL);
311 
312     if (etypes != NULL &amp;&amp; !err) {
313         while ((err = krb5_cc_next_cred (kcontext, ccache, &amp;cursor, &amp;creds)) == 0) {
314             char *serverName = NULL;
315 
316             if (!err) {
317                 err = krb5_unparse_name (kcontext, creds.server, &amp;serverName);
318                 printiferr (err, &quot;while unparsing server name&quot;);
319             }
320 
321             if (!err) {
322                 char* slash = strchr(serverName, &#39;/&#39;);
323                 char* at = strchr(serverName, &#39;@&#39;);
324                 // Make sure the server&#39;s name is krbtgt/REALM@REALM, the etype
</pre>
<hr />
<pre>
357                     if (ticketFlags == NULL) goto cleanup;
358 
359                     // Get the timestamps out.
360                     startTime = BuildKerberosTime(env, creds.times.starttime);
361                     if (startTime == NULL) goto cleanup;
362 
363                     authTime = BuildKerberosTime(env, creds.times.authtime);
364                     if (authTime == NULL) goto cleanup;
365 
366                     endTime = BuildKerberosTime(env, creds.times.endtime);
367                     if (endTime == NULL) goto cleanup;
368 
369                     renewTillTime = BuildKerberosTime(env, creds.times.renew_till);
370                     if (renewTillTime == NULL) goto cleanup;
371 
372                     // Create the addresses object.
373                     hostAddresses = BuildAddressList(env, creds.addresses);
374 
375                     if (krbcredsConstructor == 0) {
376                         krbcredsConstructor = (*env)-&gt;GetMethodID(env, krbcredsClass, &quot;&lt;init&gt;&quot;,
<span class="line-modified">377                                                                   &quot;(Lsun/security/krb5/internal/Ticket;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/EncryptionKey;Lsun/security/krb5/internal/TicketFlags;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/HostAddresses;)V&quot;);</span>
378                         if (krbcredsConstructor == 0) {
379                             printf(&quot;Couldn&#39;t find sun.security.krb5.internal.Ticket constructor\n&quot;);
380                             break;
381                         }
382                     }
383 
384                     // and now go build a KrbCreds object
385                     krbCreds = (*env)-&gt;NewObject(
386                                                  env,
387                                                  krbcredsClass,
388                                                  krbcredsConstructor,
389                                                  ticket,
390                                                  clientPrincipal,
<span class="line-added">391                                                  NULL,</span>
392                                                  targetPrincipal,
<span class="line-added">393                                                  NULL,</span>
394                                                  encryptionKey,
395                                                  ticketFlags,
396                                                  authTime,
397                                                  startTime,
398                                                  endTime,
399                                                  renewTillTime,
400                                                  hostAddresses);
401 cleanup:
402                     if (ticket) (*env)-&gt;DeleteLocalRef(env, ticket);
403                     if (clientPrincipal) (*env)-&gt;DeleteLocalRef(env, clientPrincipal);
404                     if (targetPrincipal) (*env)-&gt;DeleteLocalRef(env, targetPrincipal);
405                     if (encryptionKey) (*env)-&gt;DeleteLocalRef(env, encryptionKey);
406                     if (ticketFlags) (*env)-&gt;DeleteLocalRef(env, ticketFlags);
407                     if (authTime) (*env)-&gt;DeleteLocalRef(env, authTime);
408                     if (startTime) (*env)-&gt;DeleteLocalRef(env, startTime);
409                     if (endTime) (*env)-&gt;DeleteLocalRef(env, endTime);
410                     if (renewTillTime) (*env)-&gt;DeleteLocalRef(env, renewTillTime);
411                     if (hostAddresses) (*env)-&gt;DeleteLocalRef(env, hostAddresses);
412 
413                     // Stop if there is an exception or we already found the initial TGT
414                     if ((*env)-&gt;ExceptionCheck(env) || krbCreds) {
415                         break;
416                     }
417                 }
418             }
419 
420             if (serverName != NULL) { krb5_free_unparsed_name (kcontext, serverName); }
421 
422             krb5_free_cred_contents (kcontext, &amp;creds);
423         }
424 
425         if (err == KRB5_CC_END) { err = 0; }
426         printiferr (err, &quot;while retrieving a ticket&quot;);
427     }
428 
429     if (!err) {
430         err = krb5_cc_end_seq_get (kcontext, ccache, &amp;cursor);
431         printiferr (err, &quot;while finishing ticket retrieval&quot;);
432     }
433 
<span class="line-added">434 outer_cleanup:</span>
435     if (!err) {
436         flags = KRB5_TC_OPENCLOSE; /* restore OPENCLOSE mode */
437         err = krb5_cc_set_flags (kcontext, ccache, flags);
438         printiferr (err, &quot;while finishing ticket retrieval&quot;);
439     }
440 
441     if (etypes != NULL) {
442         (*env)-&gt;ReleaseIntArrayElements(env, jetypes, etypes, 0);
443     }
444 
445     krb5_free_context (kcontext);
446     return krbCreds;
447 }
448 
449 
450 #pragma mark -
451 
452 jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket)
453 {
<span class="line-modified">454     // To build a Ticket, we need to make a byte array out of the EncodedTicket.</span>


455 
<span class="line-modified">456     jobject ticket;</span>
457     jbyteArray ary;
458 
459     ary = (*env)-&gt;NewByteArray(env, encodedTicket-&gt;length);
460     if ((*env)-&gt;ExceptionCheck(env)) {
461         return (jobject) NULL;
462     }
463 
464     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, encodedTicket-&gt;length, (jbyte *)encodedTicket-&gt;data);
465     if ((*env)-&gt;ExceptionCheck(env)) {
466         (*env)-&gt;DeleteLocalRef(env, ary);
467         return (jobject) NULL;
468     }
469 
<span class="line-modified">470     ticket = (*env)-&gt;NewObject(env, ticketClass, ticketConstructor, ary);</span>
471     if ((*env)-&gt;ExceptionCheck(env)) {
472         (*env)-&gt;DeleteLocalRef(env, ary);
473         return (jobject) NULL;
474     }

475     (*env)-&gt;DeleteLocalRef(env, ary);






476     return ticket;
477 }
478 
479 jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName) {
480     // Get the full principal string.
481     char *principalString = NULL;
482     jobject principal = NULL;
483     int err = krb5_unparse_name (kcontext, principalName, &amp;principalString);
484 
485     if (!err) {
486         // Make a PrincipalName from the full string and the type.  Let the PrincipalName class parse it out.
487         jstring principalStringObj = (*env)-&gt;NewStringUTF(env, principalString);
488         if (principalStringObj == NULL) {
489             if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
490             return (jobject) NULL;
491         }
492         principal = (*env)-&gt;NewObject(env, principalNameClass, principalNameConstructor, principalStringObj, principalName-&gt;type);
493         if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
494         (*env)-&gt;DeleteLocalRef(env, principalStringObj);
495     }
</pre>
</td>
</tr>
</table>
<center><a href="SCDynamicStoreConfig.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/javax/security/auth/kerberos/DelegationPermission.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>