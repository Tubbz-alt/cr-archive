<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.security.jgss/macosx/native/libosxkrb5/nativeccache.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;sun_security_krb5_Credentials.h&quot;
 27 #import &lt;Kerberos/Kerberos.h&gt;
 28 #import &lt;string.h&gt;
 29 #import &lt;time.h&gt;
 30 
 31 #include &quot;jni_util.h&quot;
 32 
 33 /*
 34  * Based largely on klist.c,
 35  *
 36  * Created by Scott Kovatch on 8/12/04.
 37  *
 38  * See http://www.opensource.apple.com/darwinsource/10.3.3/Kerberos-47/KerberosClients/klist/Sources/klist.c
 39 
 40  */
 41 
 42 /*
 43  * Statics for this module
 44  */
 45 
<a name="2" id="anc2"></a>
 46 static jclass ticketClass = NULL;
 47 static jclass principalNameClass = NULL;
 48 static jclass encryptionKeyClass = NULL;
 49 static jclass ticketFlagsClass = NULL;
 50 static jclass kerberosTimeClass = NULL;
 51 static jclass javaLangStringClass = NULL;
 52 static jclass javaLangIntegerClass = NULL;
 53 static jclass hostAddressClass = NULL;
 54 static jclass hostAddressesClass = NULL;
 55 
<a name="3" id="anc3"></a>
 56 static jmethodID ticketConstructor = 0;
 57 static jmethodID principalNameConstructor = 0;
 58 static jmethodID encryptionKeyConstructor = 0;
 59 static jmethodID ticketFlagsConstructor = 0;
 60 static jmethodID kerberosTimeConstructor = 0;
 61 static jmethodID krbcredsConstructor = 0;
 62 static jmethodID integerConstructor = 0;
 63 static jmethodID hostAddressConstructor = 0;
 64 static jmethodID hostAddressesConstructor = 0;
 65 
 66 /*
 67  * Function prototypes for internal routines
 68  */
 69 
 70 static jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket);
 71 static jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName);
 72 static jobject BuildEncryptionKey(JNIEnv *env, krb5_keyblock *cryptoKey);
 73 static jobject BuildTicketFlags(JNIEnv *env, krb5_flags flags);
 74 static jobject BuildKerberosTime(JNIEnv *env, krb5_timestamp kerbtime);
 75 static jobject BuildAddressList(JNIEnv *env, krb5_address **kerbtime);
 76 
 77 static void printiferr (errcode_t err, const char *format, ...);
 78 
 79 static jclass FindClass(JNIEnv *env, char *className)
 80 {
 81     jclass cls = (*env)-&gt;FindClass(env, className);
 82 
 83     if (cls == NULL) {
 84         printf(&quot;Couldn&#39;t find %s\n&quot;, className);
 85         return NULL;
 86     }
 87 
 88     jobject returnValue = (*env)-&gt;NewWeakGlobalRef(env,cls);
 89     return returnValue;
 90 }
 91 /*
 92  * Class:     sun_security_krb5_KrbCreds
 93  * Method:    JNI_OnLoad
 94  */
 95 JNIEXPORT jint JNICALL DEF_JNI_OnLoad(JavaVM *jvm, void *reserved)
 96 {
 97     JNIEnv *env;
 98 
 99     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_4)) {
100         return JNI_EVERSION; /* JNI version not supported */
101     }
102 
103     ticketClass = FindClass(env, &quot;sun/security/krb5/internal/Ticket&quot;);
104     if (ticketClass == NULL) return JNI_ERR;
105 
106     principalNameClass = FindClass(env, &quot;sun/security/krb5/PrincipalName&quot;);
107     if (principalNameClass == NULL) return JNI_ERR;
108 
<a name="4" id="anc4"></a>


109     encryptionKeyClass = FindClass(env, &quot;sun/security/krb5/EncryptionKey&quot;);
110     if (encryptionKeyClass == NULL) return JNI_ERR;
111 
112     ticketFlagsClass = FindClass(env,&quot;sun/security/krb5/internal/TicketFlags&quot;);
113     if (ticketFlagsClass == NULL) return JNI_ERR;
114 
115     kerberosTimeClass = FindClass(env,&quot;sun/security/krb5/internal/KerberosTime&quot;);
116     if (kerberosTimeClass == NULL) return JNI_ERR;
117 
118     javaLangStringClass = FindClass(env,&quot;java/lang/String&quot;);
119     if (javaLangStringClass == NULL) return JNI_ERR;
120 
121     javaLangIntegerClass = FindClass(env,&quot;java/lang/Integer&quot;);
122     if (javaLangIntegerClass == NULL) return JNI_ERR;
123 
124     hostAddressClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddress&quot;);
125     if (hostAddressClass == NULL) return JNI_ERR;
126 
127     hostAddressesClass = FindClass(env,&quot;sun/security/krb5/internal/HostAddresses&quot;);
128     if (hostAddressesClass == NULL) return JNI_ERR;
129 
<a name="5" id="anc5"></a><span class="line-modified">130     ticketConstructor = (*env)-&gt;GetMethodID(env, ticketClass, &quot;&lt;init&gt;&quot;, &quot;([B)V&quot;);</span>






131     if (ticketConstructor == 0) {
132         printf(&quot;Couldn&#39;t find Ticket constructor\n&quot;);
133         return JNI_ERR;
134     }
135 
136     principalNameConstructor = (*env)-&gt;GetMethodID(env, principalNameClass, &quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;I)V&quot;);
137     if (principalNameConstructor == 0) {
138         printf(&quot;Couldn&#39;t find PrincipalName constructor\n&quot;);
139         return JNI_ERR;
140     }
141 
142     encryptionKeyConstructor = (*env)-&gt;GetMethodID(env, encryptionKeyClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
143     if (encryptionKeyConstructor == 0) {
144         printf(&quot;Couldn&#39;t find EncryptionKey constructor\n&quot;);
145         return JNI_ERR;
146     }
147 
148     ticketFlagsConstructor = (*env)-&gt;GetMethodID(env, ticketFlagsClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
149     if (ticketFlagsConstructor == 0) {
150         printf(&quot;Couldn&#39;t find TicketFlags constructor\n&quot;);
151         return JNI_ERR;
152     }
153 
154     kerberosTimeConstructor = (*env)-&gt;GetMethodID(env, kerberosTimeClass, &quot;&lt;init&gt;&quot;, &quot;(J)V&quot;);
155     if (kerberosTimeConstructor == 0) {
156         printf(&quot;Couldn&#39;t find KerberosTime constructor\n&quot;);
157         return JNI_ERR;
158     }
159 
160     integerConstructor = (*env)-&gt;GetMethodID(env, javaLangIntegerClass, &quot;&lt;init&gt;&quot;, &quot;(I)V&quot;);
161     if (integerConstructor == 0) {
162         printf(&quot;Couldn&#39;t find Integer constructor\n&quot;);
163         return JNI_ERR;
164     }
165 
166     hostAddressConstructor = (*env)-&gt;GetMethodID(env, hostAddressClass, &quot;&lt;init&gt;&quot;, &quot;(I[B)V&quot;);
167     if (hostAddressConstructor == 0) {
168         printf(&quot;Couldn&#39;t find HostAddress constructor\n&quot;);
169         return JNI_ERR;
170     }
171 
172     hostAddressesConstructor = (*env)-&gt;GetMethodID(env, hostAddressesClass, &quot;&lt;init&gt;&quot;, &quot;([Lsun/security/krb5/internal/HostAddress;)V&quot;);
173     if (hostAddressesConstructor == 0) {
174         printf(&quot;Couldn&#39;t find HostAddresses constructor\n&quot;);
175         return JNI_ERR;
176     }
177 
178     return JNI_VERSION_1_2;
179 }
180 
181 /*
182  * Class:     sun_security_jgss_KrbCreds
183  * Method:    JNI_OnUnload
184  */
185 JNIEXPORT void JNICALL DEF_JNI_OnUnload(JavaVM *jvm, void *reserved)
186 {
187     JNIEnv *env;
188 
189     if ((*jvm)-&gt;GetEnv(jvm, (void **)&amp;env, JNI_VERSION_1_2)) {
190         return; /* Nothing else we can do */
191     }
192 
193     if (ticketClass != NULL) {
194         (*env)-&gt;DeleteWeakGlobalRef(env,ticketClass);
195     }
<a name="6" id="anc6"></a>


196     if (principalNameClass != NULL) {
197         (*env)-&gt;DeleteWeakGlobalRef(env,principalNameClass);
198     }
199     if (encryptionKeyClass != NULL) {
200         (*env)-&gt;DeleteWeakGlobalRef(env,encryptionKeyClass);
201     }
202     if (ticketFlagsClass != NULL) {
203         (*env)-&gt;DeleteWeakGlobalRef(env,ticketFlagsClass);
204     }
205     if (kerberosTimeClass != NULL) {
206         (*env)-&gt;DeleteWeakGlobalRef(env,kerberosTimeClass);
207     }
208     if (javaLangStringClass != NULL) {
209         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangStringClass);
210     }
211     if (javaLangIntegerClass != NULL) {
212         (*env)-&gt;DeleteWeakGlobalRef(env,javaLangIntegerClass);
213     }
214     if (hostAddressClass != NULL) {
215         (*env)-&gt;DeleteWeakGlobalRef(env,hostAddressClass);
216     }
217     if (hostAddressesClass != NULL) {
218         (*env)-&gt;DeleteWeakGlobalRef(env,hostAddressesClass);
219     }
220 
221 }
222 
223 int isIn(krb5_enctype e, int n, jint* etypes)
224 {
225     int i;
226     for (i=0; i&lt;n; i++) {
227         if (e == etypes[i]) return 1;
228     }
229     return 0;
230 }
231 
232 /*
233  * Class:     sun_security_krb5_Credentials
234  * Method:    acquireDefaultNativeCreds
235  * Signature: ([I])Lsun/security/krb5/Credentials;
236  */
237 JNIEXPORT jobject JNICALL Java_sun_security_krb5_Credentials_acquireDefaultNativeCreds
238 (JNIEnv *env, jclass krbcredsClass, jintArray jetypes)
239 {
240     jobject krbCreds = NULL;
241     krb5_error_code err = 0;
242     krb5_ccache ccache = NULL;
243     krb5_cc_cursor cursor = NULL;
244     krb5_creds creds;
245     krb5_flags flags = 0;
246     krb5_context kcontext = NULL;
247 
248     int netypes;
249     jint *etypes = NULL;
<a name="7" id="anc7"></a><span class="line-added">250     int proxy_flag = 0;</span>
251 
252     /* Initialize the Kerberos 5 context */
253     err = krb5_init_context (&amp;kcontext);
254 
255     if (!err) {
256         err = krb5_cc_default (kcontext, &amp;ccache);
257     }
258 
259     if (!err) {
260         err = krb5_cc_set_flags (kcontext, ccache, flags); /* turn off OPENCLOSE */
261     }
262 
<a name="8" id="anc8"></a><span class="line-added">263     // First round read. The proxy_impersonator config flag is not supported.</span>
<span class="line-added">264     // This ccache will not be used if this flag exists.</span>
<span class="line-added">265     if (!err) {</span>
<span class="line-added">266         err = krb5_cc_start_seq_get (kcontext, ccache, &amp;cursor);</span>
<span class="line-added">267     }</span>
<span class="line-added">268 </span>
<span class="line-added">269     if (!err) {</span>
<span class="line-added">270         while ((err = krb5_cc_next_cred (kcontext, ccache, &amp;cursor, &amp;creds)) == 0) {</span>
<span class="line-added">271             char *serverName = NULL;</span>
<span class="line-added">272 </span>
<span class="line-added">273             if (!err) {</span>
<span class="line-added">274                 err = krb5_unparse_name (kcontext, creds.server, &amp;serverName);</span>
<span class="line-added">275                 printiferr (err, &quot;while unparsing server name&quot;);</span>
<span class="line-added">276             }</span>
<span class="line-added">277 </span>
<span class="line-added">278             if (!err) {</span>
<span class="line-added">279                 if (!strcmp(serverName, &quot;krb5_ccache_conf_data/proxy_impersonator@X-CACHECONF:&quot;)) {</span>
<span class="line-added">280                     proxy_flag = 1;</span>
<span class="line-added">281                 }</span>
<span class="line-added">282             }</span>
<span class="line-added">283 </span>
<span class="line-added">284             if (serverName != NULL) { krb5_free_unparsed_name (kcontext, serverName); }</span>
<span class="line-added">285 </span>
<span class="line-added">286             krb5_free_cred_contents (kcontext, &amp;creds);</span>
<span class="line-added">287 </span>
<span class="line-added">288             if (proxy_flag) break;</span>
<span class="line-added">289         }</span>
<span class="line-added">290 </span>
<span class="line-added">291         if (err == KRB5_CC_END) { err = 0; }</span>
<span class="line-added">292         printiferr (err, &quot;while retrieving a ticket&quot;);</span>
<span class="line-added">293     }</span>
<span class="line-added">294 </span>
<span class="line-added">295     if (!err) {</span>
<span class="line-added">296         err = krb5_cc_end_seq_get (kcontext, ccache, &amp;cursor);</span>
<span class="line-added">297         printiferr (err, &quot;while finishing ticket retrieval&quot;);</span>
<span class="line-added">298     }</span>
<span class="line-added">299 </span>
<span class="line-added">300     if (proxy_flag) {</span>
<span class="line-added">301         goto outer_cleanup;</span>
<span class="line-added">302     }</span>
<span class="line-added">303     // End of first round read</span>
<span class="line-added">304 </span>
305     if (!err) {
306         err = krb5_cc_start_seq_get (kcontext, ccache, &amp;cursor);
307     }
308 
309     netypes = (*env)-&gt;GetArrayLength(env, jetypes);
310     etypes = (jint *) (*env)-&gt;GetIntArrayElements(env, jetypes, NULL);
311 
312     if (etypes != NULL &amp;&amp; !err) {
313         while ((err = krb5_cc_next_cred (kcontext, ccache, &amp;cursor, &amp;creds)) == 0) {
314             char *serverName = NULL;
315 
316             if (!err) {
317                 err = krb5_unparse_name (kcontext, creds.server, &amp;serverName);
318                 printiferr (err, &quot;while unparsing server name&quot;);
319             }
320 
321             if (!err) {
322                 char* slash = strchr(serverName, &#39;/&#39;);
323                 char* at = strchr(serverName, &#39;@&#39;);
324                 // Make sure the server&#39;s name is krbtgt/REALM@REALM, the etype
325                 // is supported, and the ticket has not expired
326                 if (slash &amp;&amp; at &amp;&amp;
327                         strncmp (serverName, &quot;krbtgt&quot;, slash-serverName) == 0 &amp;&amp;
328                             // the ablove line shows at must be after slash
329                         strncmp (slash+1, at+1, at-slash-1) == 0 &amp;&amp;
330                         isIn (creds.keyblock.enctype, netypes, etypes) &amp;&amp;
331                         creds.times.endtime &gt; time(0)) {
332                     jobject ticket, clientPrincipal, targetPrincipal, encryptionKey;
333                     jobject ticketFlags, startTime, endTime;
334                     jobject authTime, renewTillTime, hostAddresses;
335 
336                     ticket = clientPrincipal = targetPrincipal = encryptionKey = NULL;
337                     ticketFlags = startTime = endTime = NULL;
338                     authTime = renewTillTime = hostAddresses = NULL;
339 
340                     // For the default credentials we&#39;re only interested in the krbtgt server.
341                     clientPrincipal = BuildClientPrincipal(env, kcontext, creds.client);
342                     if (clientPrincipal == NULL) goto cleanup;
343 
344                     targetPrincipal = BuildClientPrincipal(env, kcontext, creds.server);
345                     if (targetPrincipal == NULL) goto cleanup;
346 
347                     // Build a sun/security/krb5/internal/Ticket
348                     ticket = BuildTicket(env, &amp;creds.ticket);
349                     if (ticket == NULL) goto cleanup;
350 
351                     // Get the encryption key
352                     encryptionKey = BuildEncryptionKey(env, &amp;creds.keyblock);
353                     if (encryptionKey == NULL) goto cleanup;
354 
355                     // and the ticket flags
356                     ticketFlags = BuildTicketFlags(env, creds.ticket_flags);
357                     if (ticketFlags == NULL) goto cleanup;
358 
359                     // Get the timestamps out.
360                     startTime = BuildKerberosTime(env, creds.times.starttime);
361                     if (startTime == NULL) goto cleanup;
362 
363                     authTime = BuildKerberosTime(env, creds.times.authtime);
364                     if (authTime == NULL) goto cleanup;
365 
366                     endTime = BuildKerberosTime(env, creds.times.endtime);
367                     if (endTime == NULL) goto cleanup;
368 
369                     renewTillTime = BuildKerberosTime(env, creds.times.renew_till);
370                     if (renewTillTime == NULL) goto cleanup;
371 
372                     // Create the addresses object.
373                     hostAddresses = BuildAddressList(env, creds.addresses);
374 
375                     if (krbcredsConstructor == 0) {
376                         krbcredsConstructor = (*env)-&gt;GetMethodID(env, krbcredsClass, &quot;&lt;init&gt;&quot;,
<a name="9" id="anc9"></a><span class="line-modified">377                                                                   &quot;(Lsun/security/krb5/internal/Ticket;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/PrincipalName;Lsun/security/krb5/EncryptionKey;Lsun/security/krb5/internal/TicketFlags;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/KerberosTime;Lsun/security/krb5/internal/HostAddresses;)V&quot;);</span>
378                         if (krbcredsConstructor == 0) {
379                             printf(&quot;Couldn&#39;t find sun.security.krb5.internal.Ticket constructor\n&quot;);
380                             break;
381                         }
382                     }
383 
384                     // and now go build a KrbCreds object
385                     krbCreds = (*env)-&gt;NewObject(
386                                                  env,
387                                                  krbcredsClass,
388                                                  krbcredsConstructor,
389                                                  ticket,
390                                                  clientPrincipal,
<a name="10" id="anc10"></a><span class="line-added">391                                                  NULL,</span>
392                                                  targetPrincipal,
<a name="11" id="anc11"></a><span class="line-added">393                                                  NULL,</span>
394                                                  encryptionKey,
395                                                  ticketFlags,
396                                                  authTime,
397                                                  startTime,
398                                                  endTime,
399                                                  renewTillTime,
400                                                  hostAddresses);
401 cleanup:
402                     if (ticket) (*env)-&gt;DeleteLocalRef(env, ticket);
403                     if (clientPrincipal) (*env)-&gt;DeleteLocalRef(env, clientPrincipal);
404                     if (targetPrincipal) (*env)-&gt;DeleteLocalRef(env, targetPrincipal);
405                     if (encryptionKey) (*env)-&gt;DeleteLocalRef(env, encryptionKey);
406                     if (ticketFlags) (*env)-&gt;DeleteLocalRef(env, ticketFlags);
407                     if (authTime) (*env)-&gt;DeleteLocalRef(env, authTime);
408                     if (startTime) (*env)-&gt;DeleteLocalRef(env, startTime);
409                     if (endTime) (*env)-&gt;DeleteLocalRef(env, endTime);
410                     if (renewTillTime) (*env)-&gt;DeleteLocalRef(env, renewTillTime);
411                     if (hostAddresses) (*env)-&gt;DeleteLocalRef(env, hostAddresses);
412 
413                     // Stop if there is an exception or we already found the initial TGT
414                     if ((*env)-&gt;ExceptionCheck(env) || krbCreds) {
415                         break;
416                     }
417                 }
418             }
419 
420             if (serverName != NULL) { krb5_free_unparsed_name (kcontext, serverName); }
421 
422             krb5_free_cred_contents (kcontext, &amp;creds);
423         }
424 
425         if (err == KRB5_CC_END) { err = 0; }
426         printiferr (err, &quot;while retrieving a ticket&quot;);
427     }
428 
429     if (!err) {
430         err = krb5_cc_end_seq_get (kcontext, ccache, &amp;cursor);
431         printiferr (err, &quot;while finishing ticket retrieval&quot;);
432     }
433 
<a name="12" id="anc12"></a><span class="line-added">434 outer_cleanup:</span>
435     if (!err) {
436         flags = KRB5_TC_OPENCLOSE; /* restore OPENCLOSE mode */
437         err = krb5_cc_set_flags (kcontext, ccache, flags);
438         printiferr (err, &quot;while finishing ticket retrieval&quot;);
439     }
440 
441     if (etypes != NULL) {
442         (*env)-&gt;ReleaseIntArrayElements(env, jetypes, etypes, 0);
443     }
444 
445     krb5_free_context (kcontext);
446     return krbCreds;
447 }
448 
449 
450 #pragma mark -
451 
452 jobject BuildTicket(JNIEnv *env, krb5_data *encodedTicket)
453 {
<a name="13" id="anc13"></a><span class="line-modified">454     // To build a Ticket, we need to make a byte array out of the EncodedTicket.</span>


455 
<a name="14" id="anc14"></a><span class="line-modified">456     jobject ticket;</span>
457     jbyteArray ary;
458 
459     ary = (*env)-&gt;NewByteArray(env, encodedTicket-&gt;length);
460     if ((*env)-&gt;ExceptionCheck(env)) {
461         return (jobject) NULL;
462     }
463 
464     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, encodedTicket-&gt;length, (jbyte *)encodedTicket-&gt;data);
465     if ((*env)-&gt;ExceptionCheck(env)) {
466         (*env)-&gt;DeleteLocalRef(env, ary);
467         return (jobject) NULL;
468     }
469 
<a name="15" id="anc15"></a><span class="line-modified">470     ticket = (*env)-&gt;NewObject(env, ticketClass, ticketConstructor, ary);</span>
471     if ((*env)-&gt;ExceptionCheck(env)) {
472         (*env)-&gt;DeleteLocalRef(env, ary);
473         return (jobject) NULL;
474     }
<a name="16" id="anc16"></a>
475     (*env)-&gt;DeleteLocalRef(env, ary);
<a name="17" id="anc17"></a>





476     return ticket;
477 }
478 
479 jobject BuildClientPrincipal(JNIEnv *env, krb5_context kcontext, krb5_principal principalName) {
480     // Get the full principal string.
481     char *principalString = NULL;
482     jobject principal = NULL;
483     int err = krb5_unparse_name (kcontext, principalName, &amp;principalString);
484 
485     if (!err) {
486         // Make a PrincipalName from the full string and the type.  Let the PrincipalName class parse it out.
487         jstring principalStringObj = (*env)-&gt;NewStringUTF(env, principalString);
488         if (principalStringObj == NULL) {
489             if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
490             return (jobject) NULL;
491         }
492         principal = (*env)-&gt;NewObject(env, principalNameClass, principalNameConstructor, principalStringObj, principalName-&gt;type);
493         if (principalString != NULL) { krb5_free_unparsed_name (kcontext, principalString); }
494         (*env)-&gt;DeleteLocalRef(env, principalStringObj);
495     }
496 
497     return principal;
498 }
499 
500 jobject BuildEncryptionKey(JNIEnv *env, krb5_keyblock *cryptoKey) {
501     // First, need to build a byte array
502     jbyteArray ary;
503     jobject encryptionKey = NULL;
504 
505     ary = (*env)-&gt;NewByteArray(env,cryptoKey-&gt;length);
506 
507     if (ary == NULL) {
508         return (jobject) NULL;
509     }
510 
511     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, cryptoKey-&gt;length, (jbyte *)cryptoKey-&gt;contents);
512     if (!(*env)-&gt;ExceptionCheck(env)) {
513         encryptionKey = (*env)-&gt;NewObject(env, encryptionKeyClass, encryptionKeyConstructor, cryptoKey-&gt;enctype, ary);
514     }
515 
516     (*env)-&gt;DeleteLocalRef(env, ary);
517     return encryptionKey;
518 }
519 
520 jobject BuildTicketFlags(JNIEnv *env, krb5_flags flags) {
521     jobject ticketFlags = NULL;
522     jbyteArray ary;
523 
524     /*
525      * Convert the bytes to network byte order before copying
526      * them to a Java byte array.
527      */
528     unsigned long nlflags = htonl(flags);
529 
530     ary = (*env)-&gt;NewByteArray(env, sizeof(flags));
531 
532     if (ary == NULL) {
533         return (jobject) NULL;
534     }
535 
536     (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, sizeof(flags), (jbyte *)&amp;nlflags);
537 
538     if (!(*env)-&gt;ExceptionCheck(env)) {
539         ticketFlags = (*env)-&gt;NewObject(env, ticketFlagsClass, ticketFlagsConstructor, sizeof(flags)*8, ary);
540     }
541 
542     (*env)-&gt;DeleteLocalRef(env, ary);
543     return ticketFlags;
544 }
545 
546 jobject BuildKerberosTime(JNIEnv *env, krb5_timestamp kerbtime) {
547     jlong time = kerbtime;
548 
549     // Kerberos time is in seconds, but the KerberosTime class assumes milliseconds, so multiply by 1000.
550     time *= 1000;
551     return (*env)-&gt;NewObject(env, kerberosTimeClass, kerberosTimeConstructor, time);
552 }
553 
554 jobject BuildAddressList(JNIEnv *env, krb5_address **addresses) {
555 
556     if (addresses == NULL) {
557         return NULL;
558     }
559 
560     int addressCount = 0;
561 
562     // See how many we have.
563     krb5_address **p = addresses;
564 
565     while (*p != 0) {
566         addressCount++;
567         p++;
568     }
569 
570     jobject address_list = (*env)-&gt;NewObjectArray(env, addressCount, hostAddressClass, NULL);
571 
572     if (address_list == NULL) {
573         return (jobject) NULL;
574     }
575 
576     // Create a new HostAddress object for each address block.
577     // First, reset the iterator.
578     p = addresses;
579     jsize index = 0;
580     while (*p != 0) {
581         krb5_address *currAddress = *p;
582 
583         // HostAddres needs a byte array of the host data.
584         jbyteArray ary = (*env)-&gt;NewByteArray(env, currAddress-&gt;length);
585 
586         if (ary == NULL) return NULL;
587 
588         (*env)-&gt;SetByteArrayRegion(env, ary, (jsize) 0, currAddress-&gt;length, (jbyte *)currAddress-&gt;contents);
589         jobject address = (*env)-&gt;NewObject(env, hostAddressClass, hostAddressConstructor, currAddress-&gt;length, ary);
590 
591         (*env)-&gt;DeleteLocalRef(env, ary);
592 
593         if (address == NULL) {
594             return (jobject) NULL;
595         }
596         // Add the HostAddress to the arrray.
597         (*env)-&gt;SetObjectArrayElement(env, address_list, index, address);
598 
599         if ((*env)-&gt;ExceptionCheck(env)) {
600             return (jobject) NULL;
601         }
602 
603         index++;
604         p++;
605     }
606 
607     return address_list;
608 }
609 
610 #pragma mark - Utility methods -
611 
612 static void printiferr (errcode_t err, const char *format, ...)
613 {
614     if (err) {
615         va_list pvar;
616 
617         va_start (pvar, format);
618         com_err_va (&quot;ticketParser:&quot;, err, format, pvar);
619         va_end (pvar);
620     }
621 }
622 
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>