<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Context.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../GSSNameImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Krb5InitCredential.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Context.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 600             int errorCode = GSSException.FAILURE;
 601             if (DEBUG) {
 602                 System.out.println(&quot;Entered Krb5Context.initSecContext with &quot; +
 603                                    &quot;state=&quot; + printState(state));
 604             }
 605             if (!isInitiator()) {
 606                 throw new GSSException(GSSException.FAILURE, -1,
 607                                        &quot;initSecContext on an acceptor &quot; +
 608                                         &quot;GSSContext&quot;);
 609             }
 610 
 611             try {
 612                 if (state == STATE_NEW) {
 613                     state = STATE_IN_PROCESS;
 614 
 615                     errorCode = GSSException.NO_CRED;
 616 
 617                     if (myCred == null) {
 618                         myCred = Krb5InitCredential.getInstance(caller, myName,
 619                                               GSSCredential.DEFAULT_LIFETIME);


 620                     } else if (!myCred.isInitiatorCredential()) {
 621                         throw new GSSException(errorCode, -1,
 622                                            &quot;No TGT available&quot;);
 623                     }
 624                     myName = (Krb5NameElement) myCred.getName();
 625                     final Krb5ProxyCredential second;
 626                     if (myCred instanceof Krb5InitCredential) {
 627                         second = null;
 628                         tgt = ((Krb5InitCredential) myCred).getKrb5Credentials();
 629                     } else {
 630                         second = (Krb5ProxyCredential) myCred;
 631                         tgt = second.self.getKrb5Credentials();
 632                     }
 633 
 634                     checkPermission(peerName.getKrb5PrincipalName().getName(),
 635                                     &quot;initiate&quot;);
 636                     /*
 637                      * If useSubjectCredsonly is true then
 638                      * we check whether we already have the ticket
 639                      * for this service in the Subject and reuse it
 640                      */
 641 
 642                     final AccessControlContext acc =
 643                         AccessController.getContext();
 644 
 645                     if (GSSUtil.useSubjectCredsOnly(caller)) {
 646                         KerberosTicket kerbTicket = null;
 647                         try {
 648                            // get service ticket from caller&#39;s subject
 649                            kerbTicket = AccessController.doPrivileged(
 650                                 new PrivilegedExceptionAction&lt;KerberosTicket&gt;() {
 651                                 public KerberosTicket run() throws Exception {
 652                                     // XXX to be cleaned
 653                                     // highly consider just calling:
 654                                     // Subject.getSubject
 655                                     // SubjectComber.find
<span class="line-modified"> 656                                     // instead of Krb5Util.getTicket</span>
<span class="line-modified"> 657                                     return Krb5Util.getTicket(</span>
 658                                         GSSCaller.CALLER_UNKNOWN,
 659                                         // since it&#39;s useSubjectCredsOnly here,
 660                                         // don&#39;t worry about the null
 661                                         second == null ?
 662                                             myName.getKrb5PrincipalName().getName():
 663                                             second.getName().getKrb5PrincipalName().getName(),
 664                                         peerName.getKrb5PrincipalName().getName(),
 665                                         acc);
 666                                 }});
 667                         } catch (PrivilegedActionException e) {
 668                             if (DEBUG) {
 669                                 System.out.println(&quot;Attempt to obtain service&quot;
 670                                         + &quot; ticket from the subject failed!&quot;);
 671                             }
 672                         }
 673                         if (kerbTicket != null) {
 674                             if (DEBUG) {
 675                                 System.out.println(&quot;Found service ticket in &quot; +
 676                                                    &quot;the subject&quot; +
 677                                                    kerbTicket);
</pre>
<hr />
<pre>
 696                                      peerName.getKrb5PrincipalName().getName(),
 697                                      tgt);
 698                         } else {
 699                             serviceCreds = Credentials.acquireS4U2proxyCreds(
 700                                     peerName.getKrb5PrincipalName().getName(),
 701                                     second.tkt,
 702                                     second.getName().getKrb5PrincipalName(),
 703                                     tgt);
 704                         }
 705                         if (GSSUtil.useSubjectCredsOnly(caller)) {
 706                             final Subject subject =
 707                                 AccessController.doPrivileged(
 708                                 new java.security.PrivilegedAction&lt;Subject&gt;() {
 709                                     public Subject run() {
 710                                         return (Subject.getSubject(acc));
 711                                     }
 712                                 });
 713                             if (subject != null &amp;&amp;
 714                                 !subject.isReadOnly()) {
 715                                 /*
<span class="line-modified"> 716                              * Store the service credentials as</span>
<span class="line-modified"> 717                              * javax.security.auth.kerberos.KerberosTicket in</span>
<span class="line-modified"> 718                              * the Subject. We could wait till the context is</span>
<span class="line-modified"> 719                              * succesfully established; however it is easier</span>
<span class="line-modified"> 720                              * to do here and there is no harm indoing it here.</span>
<span class="line-modified"> 721                              */</span>
 722                                 final KerberosTicket kt =
<span class="line-modified"> 723                                     Krb5Util.credsToTicket(serviceCreds);</span>
 724                                 AccessController.doPrivileged (
 725                                     new java.security.PrivilegedAction&lt;Void&gt;() {
 726                                       public Void run() {
 727                                         subject.getPrivateCredentials().add(kt);
 728                                         return null;
 729                                       }
 730                                     });
 731                             } else {
 732                                 // log it for debugging purpose
 733                                 if (DEBUG) {
 734                                     System.out.println(&quot;Subject is &quot; +
 735                                         &quot;readOnly;Kerberos Service &quot;+
 736                                         &quot;ticket not stored&quot;);
 737                                 }
 738                             }
 739                         }
 740                     }
 741 
 742                     errorCode = GSSException.FAILURE;
 743                     token = new InitSecContextToken(this, tgt, serviceCreds);
</pre>
<hr />
<pre>
1374           case STATE_DONE:
1375                 return (&quot;STATE_DONE&quot;);
1376           case STATE_DELETED:
1377                 return (&quot;STATE_DELETED&quot;);
1378           default:
1379                 return (&quot;Unknown state &quot; + state);
1380         }
1381     }
1382 
1383     GSSCaller getCaller() {
1384         // Currently used by InitialToken only
1385         return caller;
1386     }
1387 
1388     /**
1389      * The session key returned by inquireSecContext(KRB5_INQ_SSPI_SESSION_KEY)
1390      */
1391     static class KerberosSessionKey implements Key {
1392         private static final long serialVersionUID = 699307378954123869L;
1393 

1394         private final EncryptionKey key;
1395 
1396         KerberosSessionKey(EncryptionKey key) {
1397             this.key = key;
1398         }
1399 
1400         @Override
1401         public String getAlgorithm() {
1402             return Integer.toString(key.getEType());
1403         }
1404 
1405         @Override
1406         public String getFormat() {
1407             return &quot;RAW&quot;;
1408         }
1409 
1410         @Override
1411         public byte[] getEncoded() {
1412             return key.getBytes().clone();
1413         }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 600             int errorCode = GSSException.FAILURE;
 601             if (DEBUG) {
 602                 System.out.println(&quot;Entered Krb5Context.initSecContext with &quot; +
 603                                    &quot;state=&quot; + printState(state));
 604             }
 605             if (!isInitiator()) {
 606                 throw new GSSException(GSSException.FAILURE, -1,
 607                                        &quot;initSecContext on an acceptor &quot; +
 608                                         &quot;GSSContext&quot;);
 609             }
 610 
 611             try {
 612                 if (state == STATE_NEW) {
 613                     state = STATE_IN_PROCESS;
 614 
 615                     errorCode = GSSException.NO_CRED;
 616 
 617                     if (myCred == null) {
 618                         myCred = Krb5InitCredential.getInstance(caller, myName,
 619                                               GSSCredential.DEFAULT_LIFETIME);
<span class="line-added"> 620                         myCred = Krb5ProxyCredential.tryImpersonation(</span>
<span class="line-added"> 621                                 caller, (Krb5InitCredential)myCred);</span>
 622                     } else if (!myCred.isInitiatorCredential()) {
 623                         throw new GSSException(errorCode, -1,
 624                                            &quot;No TGT available&quot;);
 625                     }
 626                     myName = (Krb5NameElement) myCred.getName();
 627                     final Krb5ProxyCredential second;
 628                     if (myCred instanceof Krb5InitCredential) {
 629                         second = null;
 630                         tgt = ((Krb5InitCredential) myCred).getKrb5Credentials();
 631                     } else {
 632                         second = (Krb5ProxyCredential) myCred;
 633                         tgt = second.self.getKrb5Credentials();
 634                     }
 635 
 636                     checkPermission(peerName.getKrb5PrincipalName().getName(),
 637                                     &quot;initiate&quot;);
 638                     /*
 639                      * If useSubjectCredsonly is true then
 640                      * we check whether we already have the ticket
 641                      * for this service in the Subject and reuse it
 642                      */
 643 
 644                     final AccessControlContext acc =
 645                         AccessController.getContext();
 646 
 647                     if (GSSUtil.useSubjectCredsOnly(caller)) {
 648                         KerberosTicket kerbTicket = null;
 649                         try {
 650                            // get service ticket from caller&#39;s subject
 651                            kerbTicket = AccessController.doPrivileged(
 652                                 new PrivilegedExceptionAction&lt;KerberosTicket&gt;() {
 653                                 public KerberosTicket run() throws Exception {
 654                                     // XXX to be cleaned
 655                                     // highly consider just calling:
 656                                     // Subject.getSubject
 657                                     // SubjectComber.find
<span class="line-modified"> 658                                     // instead of Krb5Util.getServiceTicket</span>
<span class="line-modified"> 659                                     return Krb5Util.getServiceTicket(</span>
 660                                         GSSCaller.CALLER_UNKNOWN,
 661                                         // since it&#39;s useSubjectCredsOnly here,
 662                                         // don&#39;t worry about the null
 663                                         second == null ?
 664                                             myName.getKrb5PrincipalName().getName():
 665                                             second.getName().getKrb5PrincipalName().getName(),
 666                                         peerName.getKrb5PrincipalName().getName(),
 667                                         acc);
 668                                 }});
 669                         } catch (PrivilegedActionException e) {
 670                             if (DEBUG) {
 671                                 System.out.println(&quot;Attempt to obtain service&quot;
 672                                         + &quot; ticket from the subject failed!&quot;);
 673                             }
 674                         }
 675                         if (kerbTicket != null) {
 676                             if (DEBUG) {
 677                                 System.out.println(&quot;Found service ticket in &quot; +
 678                                                    &quot;the subject&quot; +
 679                                                    kerbTicket);
</pre>
<hr />
<pre>
 698                                      peerName.getKrb5PrincipalName().getName(),
 699                                      tgt);
 700                         } else {
 701                             serviceCreds = Credentials.acquireS4U2proxyCreds(
 702                                     peerName.getKrb5PrincipalName().getName(),
 703                                     second.tkt,
 704                                     second.getName().getKrb5PrincipalName(),
 705                                     tgt);
 706                         }
 707                         if (GSSUtil.useSubjectCredsOnly(caller)) {
 708                             final Subject subject =
 709                                 AccessController.doPrivileged(
 710                                 new java.security.PrivilegedAction&lt;Subject&gt;() {
 711                                     public Subject run() {
 712                                         return (Subject.getSubject(acc));
 713                                     }
 714                                 });
 715                             if (subject != null &amp;&amp;
 716                                 !subject.isReadOnly()) {
 717                                 /*
<span class="line-modified"> 718                                 * Store the service credentials as</span>
<span class="line-modified"> 719                                 * javax.security.auth.kerberos.KerberosTicket in</span>
<span class="line-modified"> 720                                 * the Subject. We could wait until the context is</span>
<span class="line-modified"> 721                                 * successfully established; however it is easier</span>
<span class="line-modified"> 722                                 * to do it here and there is no harm.</span>
<span class="line-modified"> 723                                 */</span>
 724                                 final KerberosTicket kt =
<span class="line-modified"> 725                                         Krb5Util.credsToTicket(serviceCreds);</span>
 726                                 AccessController.doPrivileged (
 727                                     new java.security.PrivilegedAction&lt;Void&gt;() {
 728                                       public Void run() {
 729                                         subject.getPrivateCredentials().add(kt);
 730                                         return null;
 731                                       }
 732                                     });
 733                             } else {
 734                                 // log it for debugging purpose
 735                                 if (DEBUG) {
 736                                     System.out.println(&quot;Subject is &quot; +
 737                                         &quot;readOnly;Kerberos Service &quot;+
 738                                         &quot;ticket not stored&quot;);
 739                                 }
 740                             }
 741                         }
 742                     }
 743 
 744                     errorCode = GSSException.FAILURE;
 745                     token = new InitSecContextToken(this, tgt, serviceCreds);
</pre>
<hr />
<pre>
1376           case STATE_DONE:
1377                 return (&quot;STATE_DONE&quot;);
1378           case STATE_DELETED:
1379                 return (&quot;STATE_DELETED&quot;);
1380           default:
1381                 return (&quot;Unknown state &quot; + state);
1382         }
1383     }
1384 
1385     GSSCaller getCaller() {
1386         // Currently used by InitialToken only
1387         return caller;
1388     }
1389 
1390     /**
1391      * The session key returned by inquireSecContext(KRB5_INQ_SSPI_SESSION_KEY)
1392      */
1393     static class KerberosSessionKey implements Key {
1394         private static final long serialVersionUID = 699307378954123869L;
1395 
<span class="line-added">1396         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
1397         private final EncryptionKey key;
1398 
1399         KerberosSessionKey(EncryptionKey key) {
1400             this.key = key;
1401         }
1402 
1403         @Override
1404         public String getAlgorithm() {
1405             return Integer.toString(key.getEType());
1406         }
1407 
1408         @Override
1409         public String getFormat() {
1410             return &quot;RAW&quot;;
1411         }
1412 
1413         @Override
1414         public byte[] getEncoded() {
1415             return key.getBytes().clone();
1416         }
</pre>
</td>
</tr>
</table>
<center><a href="../GSSNameImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Krb5InitCredential.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>