<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.jgss/share/classes/sun/security/krb5/KrbAsReqBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbAsReq.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbCred.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbAsReqBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2010, 2012, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,10 +66,11 @@</span>
  public final class KrbAsReqBuilder {
  
      // Common data for AS-REQ fields
      private KDCOptions options;
      private PrincipalName cname;
<span class="udiff-line-added">+     private PrincipalName refCname; // May be changed by referrals</span>
      private PrincipalName sname;
      private KerberosTime from;
      private KerberosTime till;
      private KerberosTime rtime;
      private HostAddresses addresses;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,10 +99,11 @@</span>
  
      // Called by other constructors
      private void init(PrincipalName cname)
              throws KrbException {
          this.cname = cname;
<span class="udiff-line-added">+         this.refCname = cname;</span>
          state = State.INIT;
      }
  
      /**
       * Creates a builder to be used by {@code cname} with existing keys.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -260,29 +262,40 @@</span>
       * @param key null (initial AS-REQ) or pakey (with preauth)
       * @return the KrbAsReq object
       * @throws KrbException
       * @throws IOException
       */
<span class="udiff-line-modified-removed">-     private KrbAsReq build(EncryptionKey key) throws KrbException, IOException {</span>
<span class="udiff-line-modified-added">+     private KrbAsReq build(EncryptionKey key, ReferralsState referralsState)</span>
<span class="udiff-line-added">+             throws KrbException, IOException {</span>
<span class="udiff-line-added">+         PAData[] extraPAs = null;</span>
          int[] eTypes;
          if (password != null) {
              eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;);
          } else {
              EncryptionKey[] ks = Krb5Util.keysFromJavaxKeyTab(ktab, cname);
              eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;,
                      ks);
              for (EncryptionKey k: ks) k.destroy();
          }
<span class="udiff-line-added">+         options = (options == null) ? new KDCOptions() : options;</span>
<span class="udiff-line-added">+         if (referralsState.isEnabled()) {</span>
<span class="udiff-line-added">+             options.set(KDCOptions.CANONICALIZE, true);</span>
<span class="udiff-line-added">+             extraPAs = new PAData[]{ new PAData(Krb5.PA_REQ_ENC_PA_REP,</span>
<span class="udiff-line-added">+                     new byte[]{}) };</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             options.set(KDCOptions.CANONICALIZE, false);</span>
<span class="udiff-line-added">+         }</span>
          return new KrbAsReq(key,
              options,
<span class="udiff-line-modified-removed">-             cname,</span>
<span class="udiff-line-modified-added">+             refCname,</span>
              sname,
              from,
              till,
              rtime,
              eTypes,
<span class="udiff-line-modified-removed">-             addresses);</span>
<span class="udiff-line-modified-added">+             addresses,</span>
<span class="udiff-line-added">+             extraPAs);</span>
      }
  
      /**
       * Parses AS-REP, decrypts enc-part, retrieves ticket and session key
       * @throws KrbException
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -316,15 +329,19 @@</span>
       * @throws KrbException
       * @throws IOException
       */
      private KrbAsReqBuilder send() throws KrbException, IOException {
          boolean preAuthFailedOnce = false;
<span class="udiff-line-modified-removed">-         KdcComm comm = new KdcComm(cname.getRealmAsString());</span>
<span class="udiff-line-modified-added">+         KdcComm comm = null;</span>
          EncryptionKey pakey = null;
<span class="udiff-line-added">+         ReferralsState referralsState = new ReferralsState();</span>
          while (true) {
<span class="udiff-line-added">+             if (referralsState.refreshComm()) {</span>
<span class="udiff-line-added">+                 comm = new KdcComm(refCname.getRealmAsString());</span>
<span class="udiff-line-added">+             }</span>
              try {
<span class="udiff-line-modified-removed">-                 req = build(pakey);</span>
<span class="udiff-line-modified-added">+                 req = build(pakey, referralsState);</span>
                  rep = new KrbAsRep(comm.send(req.encoding()));
                  return this;
              } catch (KrbException ke) {
                  if (!preAuthFailedOnce &amp;&amp; (
                          ke.returnCode() == Krb5.KDC_ERR_PREAUTH_FAILED ||
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,16 +366,75 @@</span>
                                  PAData.getSaltAndParams(
                                      paEType, kerr.getPA()));
                      }
                      paList = kerr.getPA();  // Update current paList
                  } else {
<span class="udiff-line-added">+                     if (referralsState.handleError(ke)) {</span>
<span class="udiff-line-added">+                         pakey = null;</span>
<span class="udiff-line-added">+                         preAuthFailedOnce = false;</span>
<span class="udiff-line-added">+                         continue;</span>
<span class="udiff-line-added">+                     }</span>
                      throw ke;
                  }
              }
          }
      }
  
<span class="udiff-line-added">+     private final class ReferralsState {</span>
<span class="udiff-line-added">+         private boolean enabled;</span>
<span class="udiff-line-added">+         private int count;</span>
<span class="udiff-line-added">+         private boolean refreshComm;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ReferralsState() throws KrbException {</span>
<span class="udiff-line-added">+             if (Config.DISABLE_REFERRALS) {</span>
<span class="udiff-line-added">+                 if (refCname.getNameType() == PrincipalName.KRB_NT_ENTERPRISE) {</span>
<span class="udiff-line-added">+                     throw new KrbException(&quot;NT-ENTERPRISE principals only allowed&quot; +</span>
<span class="udiff-line-added">+                             &quot; when referrals are enabled.&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 enabled = false;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 enabled = true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             refreshComm = true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean handleError(KrbException ke) throws RealmException {</span>
<span class="udiff-line-added">+             if (enabled) {</span>
<span class="udiff-line-added">+                 if (ke.returnCode() == Krb5.KRB_ERR_WRONG_REALM) {</span>
<span class="udiff-line-added">+                     Realm referredRealm = ke.getError().getClientRealm();</span>
<span class="udiff-line-added">+                     if (req.getMessage().reqBody.kdcOptions.get(KDCOptions.CANONICALIZE) &amp;&amp;</span>
<span class="udiff-line-added">+                             referredRealm != null &amp;&amp; referredRealm.toString().length() &gt; 0 &amp;&amp;</span>
<span class="udiff-line-added">+                             count &lt; Config.MAX_REFERRALS) {</span>
<span class="udiff-line-added">+                         refCname = new PrincipalName(refCname.getNameType(),</span>
<span class="udiff-line-added">+                                 refCname.getNameStrings(), referredRealm);</span>
<span class="udiff-line-added">+                         refreshComm = true;</span>
<span class="udiff-line-added">+                         count++;</span>
<span class="udiff-line-added">+                         return true;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (count &lt; Config.MAX_REFERRALS &amp;&amp;</span>
<span class="udiff-line-added">+                         refCname.getNameType() != PrincipalName.KRB_NT_ENTERPRISE) {</span>
<span class="udiff-line-added">+                     // Server may raise an error if CANONICALIZE is true.</span>
<span class="udiff-line-added">+                     // Try CANONICALIZE false.</span>
<span class="udiff-line-added">+                     enabled = false;</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean refreshComm() {</span>
<span class="udiff-line-added">+             boolean retRefreshComm = refreshComm;</span>
<span class="udiff-line-added">+             refreshComm = false;</span>
<span class="udiff-line-added">+             return retRefreshComm;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean isEnabled() {</span>
<span class="udiff-line-added">+             return enabled;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Performs AS-REQ send and AS-REP receive.
       * Maybe a state is needed here, to divide prepare process and getCreds.
       * @throws KrbException
       * @throws Asn1Exception
</pre>
<center><a href="KrbAsReq.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbCred.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>