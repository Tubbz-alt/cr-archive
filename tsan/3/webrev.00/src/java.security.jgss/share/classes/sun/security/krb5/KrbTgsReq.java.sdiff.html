<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/KrbTgsReq.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbTgsRep.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PrincipalName.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbTgsReq.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5;
 33 
 34 import sun.security.krb5.internal.*;
 35 import sun.security.krb5.internal.crypto.*;
 36 import java.io.IOException;
 37 import java.net.UnknownHostException;
 38 import java.time.Instant;

 39 
 40 /**
 41  * This class encapsulates a Kerberos TGS-REQ that is sent from the
 42  * client to the KDC.
 43  */
 44 public class KrbTgsReq {
 45 
 46     private PrincipalName princName;

 47     private PrincipalName servName;

 48     private TGSReq tgsReqMessg;
 49     private KerberosTime ctime;
 50     private Ticket secondTicket = null;
 51     private boolean useSubkey = false;
 52     EncryptionKey tgsReqKey;
 53 
<span class="line-removed"> 54     private static final boolean DEBUG = Krb5.DEBUG;</span>
<span class="line-removed"> 55 </span>
 56     private byte[] obuf;
 57     private byte[] ibuf;
 58 
 59     // Used in CredentialsUtil
<span class="line-modified"> 60     public KrbTgsReq(Credentials asCreds,</span>
<span class="line-modified"> 61                      PrincipalName sname)</span>


 62         throws KrbException, IOException {
<span class="line-modified"> 63         this(new KDCOptions(),</span>
<span class="line-modified"> 64             asCreds,</span>
<span class="line-modified"> 65             sname,</span>
<span class="line-modified"> 66             null, // KerberosTime from</span>
<span class="line-modified"> 67             null, // KerberosTime till</span>
<span class="line-modified"> 68             null, // KerberosTime rtime</span>
<span class="line-modified"> 69             null, // eTypes, // null, // int[] eTypes</span>
<span class="line-modified"> 70             null, // HostAddresses addresses</span>
<span class="line-modified"> 71             null, // AuthorizationData authorizationData</span>
<span class="line-modified"> 72             null, // Ticket[] additionalTickets</span>
<span class="line-modified"> 73             null); // EncryptionKey subSessionKey</span>
<span class="line-modified"> 74     }</span>
<span class="line-modified"> 75 </span>
<span class="line-modified"> 76     // S4U2proxy</span>
<span class="line-modified"> 77     public KrbTgsReq(Credentials asCreds,</span>
<span class="line-removed"> 78                      Ticket second,</span>
<span class="line-removed"> 79                      PrincipalName sname)</span>
<span class="line-removed"> 80             throws KrbException, IOException {</span>
<span class="line-removed"> 81         this(KDCOptions.with(KDCOptions.CNAME_IN_ADDL_TKT,</span>
<span class="line-removed"> 82                 KDCOptions.FORWARDABLE),</span>
<span class="line-removed"> 83             asCreds,</span>
<span class="line-removed"> 84             sname,</span>
<span class="line-removed"> 85             null,</span>
<span class="line-removed"> 86             null,</span>
<span class="line-removed"> 87             null,</span>
<span class="line-removed"> 88             null,</span>
<span class="line-removed"> 89             null,</span>
<span class="line-removed"> 90             null,</span>
<span class="line-removed"> 91             new Ticket[] {second}, // the service ticket</span>
<span class="line-removed"> 92             null);</span>
<span class="line-removed"> 93     }</span>
<span class="line-removed"> 94 </span>
<span class="line-removed"> 95     // S4U2user</span>
<span class="line-removed"> 96     public KrbTgsReq(Credentials asCreds,</span>
<span class="line-removed"> 97                      PrincipalName sname,</span>
<span class="line-removed"> 98                      PAData extraPA)</span>
<span class="line-removed"> 99         throws KrbException, IOException {</span>
<span class="line-removed">100         this(KDCOptions.with(KDCOptions.FORWARDABLE),</span>
<span class="line-removed">101             asCreds,</span>
<span class="line-removed">102             asCreds.getClient(),</span>
<span class="line-removed">103             sname,</span>
<span class="line-removed">104             null,</span>
<span class="line-removed">105             null,</span>
<span class="line-removed">106             null,</span>
<span class="line-removed">107             null,</span>
<span class="line-removed">108             null,</span>
<span class="line-removed">109             null,</span>
<span class="line-removed">110             null,</span>
<span class="line-removed">111             null,</span>
<span class="line-removed">112             extraPA); // the PA-FOR-USER</span>
113     }
114 
115     // Called by Credentials, KrbCred
116     KrbTgsReq(
117             KDCOptions options,
118             Credentials asCreds,
119             PrincipalName sname,

120             KerberosTime from,
121             KerberosTime till,
122             KerberosTime rtime,
123             int[] eTypes,
124             HostAddresses addresses,
125             AuthorizationData authorizationData,
126             Ticket[] additionalTickets,
127             EncryptionKey subKey) throws KrbException, IOException {
<span class="line-modified">128         this(options, asCreds, asCreds.getClient(), sname,</span>
<span class="line-modified">129                 from, till, rtime, eTypes, addresses,</span>
<span class="line-modified">130                 authorizationData, additionalTickets, subKey, null);</span>
131     }
132 
133     private KrbTgsReq(
134             KDCOptions options,
135             Credentials asCreds,
136             PrincipalName cname,

137             PrincipalName sname,

138             KerberosTime from,
139             KerberosTime till,
140             KerberosTime rtime,
141             int[] eTypes,
142             HostAddresses addresses,
143             AuthorizationData authorizationData,
144             Ticket[] additionalTickets,
145             EncryptionKey subKey,
<span class="line-modified">146             PAData extraPA) throws KrbException, IOException {</span>
147 
148         princName = cname;

149         servName = sname;

150         ctime = KerberosTime.now();
151 
152         // check if they are valid arguments. The optional fields
153         // should be consistent with settings in KDCOptions.
154 
155         if (options.get(KDCOptions.FORWARDABLE) &amp;&amp;
156                 (!(asCreds.flags.get(Krb5.TKT_OPTS_FORWARDABLE)))) {
157             options.set(KDCOptions.FORWARDABLE, false);
158         }
159         if (options.get(KDCOptions.FORWARDED)) {
160             if (!(asCreds.flags.get(KDCOptions.FORWARDABLE)))
161                 throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
162         }
163         if (options.get(KDCOptions.PROXIABLE) &amp;&amp;
164                 (!(asCreds.flags.get(Krb5.TKT_OPTS_PROXIABLE)))) {
165             throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
166         }
167         if (options.get(KDCOptions.PROXY)) {
168             if (!(asCreds.flags.get(KDCOptions.PROXIABLE)))
169                 throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
</pre>
<hr />
<pre>
199         } else {
200             if (additionalTickets != null)
201                 additionalTickets = null;
202         }
203 
204         tgsReqMessg = createRequest(
205                 options,
206                 asCreds.ticket,
207                 asCreds.key,
208                 ctime,
209                 princName,
210                 servName,
211                 from,
212                 till,
213                 rtime,
214                 eTypes,
215                 addresses,
216                 authorizationData,
217                 additionalTickets,
218                 subKey,
<span class="line-modified">219                 extraPA);</span>
220         obuf = tgsReqMessg.asn1Encode();
221 
222         // XXX We need to revisit this to see if can&#39;t move it
223         // up such that FORWARDED flag set in the options
224         // is included in the marshaled request.
225         /*
226          * If this is based on a forwarded ticket, record that in the
227          * options, because the returned TgsRep will contain the
228          * FORWARDED flag set.
229          */
230         if (asCreds.flags.get(KDCOptions.FORWARDED))
231             options.set(KDCOptions.FORWARDED, true);
232 
233 
234     }
235 
236     /**
237      * Sends a TGS request to the realm of the target.
238      * @throws KrbException
239      * @throws IOException
</pre>
<hr />
<pre>
265 
266     KerberosTime getCtime() {
267         return ctime;
268     }
269 
270     private TGSReq createRequest(
271                          KDCOptions kdc_options,
272                          Ticket ticket,
273                          EncryptionKey key,
274                          KerberosTime ctime,
275                          PrincipalName cname,
276                          PrincipalName sname,
277                          KerberosTime from,
278                          KerberosTime till,
279                          KerberosTime rtime,
280                          int[] eTypes,
281                          HostAddresses addresses,
282                          AuthorizationData authorizationData,
283                          Ticket[] additionalTickets,
284                          EncryptionKey subKey,
<span class="line-modified">285                          PAData extraPA)</span>
286         throws IOException, KrbException, UnknownHostException {
287         KerberosTime req_till = null;
288         if (till == null) {
289             String d = Config.getInstance().get(&quot;libdefaults&quot;, &quot;ticket_lifetime&quot;);
290             if (d != null) {
291                 req_till = new KerberosTime(Instant.now().plusSeconds(Config.duration(d)));
292             } else {
293                 req_till = new KerberosTime(0); // Choose KDC maximum allowed
294             }
295         } else {
296             req_till = till;
297         }
298 
299         /*
300          * RFC 4120, Section 5.4.2.
301          * For KRB_TGS_REP, the ciphertext is encrypted in the
302          * sub-session key from the Authenticator, or if absent,
303          * the session key from the ticket-granting ticket used
304          * in the request.
305          *
</pre>
<hr />
<pre>
328                 encAuthorizationData = new EncryptedData(key, ad,
329                     KeyUsage.KU_TGS_REQ_AUTH_DATA_SESSKEY);
330         }
331 
332         KDCReqBody reqBody = new KDCReqBody(
333                                             kdc_options,
334                                             cname,
335                                             sname,
336                                             from,
337                                             req_till,
338                                             rtime,
339                                             Nonce.value(),
340                                             req_eTypes,
341                                             addresses,
342                                             encAuthorizationData,
343                                             additionalTickets);
344 
345         byte[] temp = reqBody.asn1Encode(Krb5.KRB_TGS_REQ);
346         // if the checksum type is one of the keyed checksum types,
347         // use session key.
<span class="line-modified">348         Checksum cksum;</span>
<span class="line-removed">349         switch (Checksum.CKSUMTYPE_DEFAULT) {</span>
<span class="line-removed">350         case Checksum.CKSUMTYPE_RSA_MD4_DES:</span>
<span class="line-removed">351         case Checksum.CKSUMTYPE_DES_MAC:</span>
<span class="line-removed">352         case Checksum.CKSUMTYPE_DES_MAC_K:</span>
<span class="line-removed">353         case Checksum.CKSUMTYPE_RSA_MD4_DES_K:</span>
<span class="line-removed">354         case Checksum.CKSUMTYPE_RSA_MD5_DES:</span>
<span class="line-removed">355         case Checksum.CKSUMTYPE_HMAC_SHA1_DES3_KD:</span>
<span class="line-removed">356         case Checksum.CKSUMTYPE_HMAC_MD5_ARCFOUR:</span>
<span class="line-removed">357         case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES128:</span>
<span class="line-removed">358         case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES256:</span>
<span class="line-removed">359         case Checksum.CKSUMTYPE_HMAC_SHA256_128_AES128:</span>
<span class="line-removed">360         case Checksum.CKSUMTYPE_HMAC_SHA384_192_AES256:</span>
<span class="line-removed">361             cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp, key,</span>
362                 KeyUsage.KU_PA_TGS_REQ_CKSUM);
<span class="line-removed">363             break;</span>
<span class="line-removed">364         case Checksum.CKSUMTYPE_CRC32:</span>
<span class="line-removed">365         case Checksum.CKSUMTYPE_RSA_MD4:</span>
<span class="line-removed">366         case Checksum.CKSUMTYPE_RSA_MD5:</span>
<span class="line-removed">367         default:</span>
<span class="line-removed">368             cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp);</span>
<span class="line-removed">369         }</span>
370 
371         // Usage will be KeyUsage.KU_PA_TGS_REQ_AUTHENTICATOR
372 
373         byte[] tgs_ap_req = new KrbApReq(
374                                          new APOptions(),
375                                          ticket,
376                                          key,
377                                          cname,
378                                          cksum,
379                                          ctime,
380                                          reqKey,
381                                          null,
382                                          null).getMessage();
383 
384         PAData tgsPAData = new PAData(Krb5.PA_TGS_REQ, tgs_ap_req);
<span class="line-modified">385         return new TGSReq(</span>
<span class="line-modified">386                 extraPA != null ?</span>
<span class="line-modified">387                     new PAData[] {extraPA, tgsPAData } :</span>
<span class="line-modified">388                     new PAData[] {tgsPAData},</span>
<span class="line-modified">389                 reqBody);</span>



390     }
391 
392     TGSReq getMessage() {
393         return tgsReqMessg;
394     }
395 
396     Ticket getSecondTicket() {
397         return secondTicket;
398     }
399 








400     private static void debug(String message) {
401         //      System.err.println(&quot;&gt;&gt;&gt; KrbTgsReq: &quot; + message);
402     }
403 
404     boolean usedSubkey() {
405         return useSubkey;
406     }
407 
408 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5;
 33 
 34 import sun.security.krb5.internal.*;
 35 import sun.security.krb5.internal.crypto.*;
 36 import java.io.IOException;
 37 import java.net.UnknownHostException;
 38 import java.time.Instant;
<span class="line-added"> 39 import java.util.Arrays;</span>
 40 
 41 /**
 42  * This class encapsulates a Kerberos TGS-REQ that is sent from the
 43  * client to the KDC.
 44  */
 45 public class KrbTgsReq {
 46 
 47     private PrincipalName princName;
<span class="line-added"> 48     private PrincipalName clientAlias;</span>
 49     private PrincipalName servName;
<span class="line-added"> 50     private PrincipalName serverAlias;</span>
 51     private TGSReq tgsReqMessg;
 52     private KerberosTime ctime;
 53     private Ticket secondTicket = null;
 54     private boolean useSubkey = false;
 55     EncryptionKey tgsReqKey;
 56 


 57     private byte[] obuf;
 58     private byte[] ibuf;
 59 
 60     // Used in CredentialsUtil
<span class="line-modified"> 61     public KrbTgsReq(KDCOptions options, Credentials asCreds,</span>
<span class="line-modified"> 62             PrincipalName cname, PrincipalName clientAlias,</span>
<span class="line-added"> 63             PrincipalName sname, PrincipalName serverAlias,</span>
<span class="line-added"> 64             Ticket[] additionalTickets, PAData[] extraPAs)</span>
 65         throws KrbException, IOException {
<span class="line-modified"> 66         this(options,</span>
<span class="line-modified"> 67              asCreds,</span>
<span class="line-modified"> 68              cname,</span>
<span class="line-modified"> 69              clientAlias,</span>
<span class="line-modified"> 70              sname,</span>
<span class="line-modified"> 71              serverAlias,</span>
<span class="line-modified"> 72              null, // KerberosTime from</span>
<span class="line-modified"> 73              null, // KerberosTime till</span>
<span class="line-modified"> 74              null, // KerberosTime rtime</span>
<span class="line-modified"> 75              null, // int[] eTypes</span>
<span class="line-modified"> 76              null, // HostAddresses addresses</span>
<span class="line-modified"> 77              null, // AuthorizationData authorizationData</span>
<span class="line-modified"> 78              additionalTickets,</span>
<span class="line-modified"> 79              null, // EncryptionKey subKey</span>
<span class="line-modified"> 80              extraPAs);</span>



































 81     }
 82 
 83     // Called by Credentials, KrbCred
 84     KrbTgsReq(
 85             KDCOptions options,
 86             Credentials asCreds,
 87             PrincipalName sname,
<span class="line-added"> 88             PrincipalName serverAlias,</span>
 89             KerberosTime from,
 90             KerberosTime till,
 91             KerberosTime rtime,
 92             int[] eTypes,
 93             HostAddresses addresses,
 94             AuthorizationData authorizationData,
 95             Ticket[] additionalTickets,
 96             EncryptionKey subKey) throws KrbException, IOException {
<span class="line-modified"> 97         this(options, asCreds, asCreds.getClient(), asCreds.getClientAlias(),</span>
<span class="line-modified"> 98                 sname, serverAlias, from, till, rtime, eTypes,</span>
<span class="line-modified"> 99                 addresses, authorizationData, additionalTickets, subKey, null);</span>
100     }
101 
102     private KrbTgsReq(
103             KDCOptions options,
104             Credentials asCreds,
105             PrincipalName cname,
<span class="line-added">106             PrincipalName clientAlias,</span>
107             PrincipalName sname,
<span class="line-added">108             PrincipalName serverAlias,</span>
109             KerberosTime from,
110             KerberosTime till,
111             KerberosTime rtime,
112             int[] eTypes,
113             HostAddresses addresses,
114             AuthorizationData authorizationData,
115             Ticket[] additionalTickets,
116             EncryptionKey subKey,
<span class="line-modified">117             PAData[] extraPAs) throws KrbException, IOException {</span>
118 
119         princName = cname;
<span class="line-added">120         this.clientAlias = clientAlias;</span>
121         servName = sname;
<span class="line-added">122         this.serverAlias = serverAlias;</span>
123         ctime = KerberosTime.now();
124 
125         // check if they are valid arguments. The optional fields
126         // should be consistent with settings in KDCOptions.
127 
128         if (options.get(KDCOptions.FORWARDABLE) &amp;&amp;
129                 (!(asCreds.flags.get(Krb5.TKT_OPTS_FORWARDABLE)))) {
130             options.set(KDCOptions.FORWARDABLE, false);
131         }
132         if (options.get(KDCOptions.FORWARDED)) {
133             if (!(asCreds.flags.get(KDCOptions.FORWARDABLE)))
134                 throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
135         }
136         if (options.get(KDCOptions.PROXIABLE) &amp;&amp;
137                 (!(asCreds.flags.get(Krb5.TKT_OPTS_PROXIABLE)))) {
138             throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
139         }
140         if (options.get(KDCOptions.PROXY)) {
141             if (!(asCreds.flags.get(KDCOptions.PROXIABLE)))
142                 throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);
</pre>
<hr />
<pre>
172         } else {
173             if (additionalTickets != null)
174                 additionalTickets = null;
175         }
176 
177         tgsReqMessg = createRequest(
178                 options,
179                 asCreds.ticket,
180                 asCreds.key,
181                 ctime,
182                 princName,
183                 servName,
184                 from,
185                 till,
186                 rtime,
187                 eTypes,
188                 addresses,
189                 authorizationData,
190                 additionalTickets,
191                 subKey,
<span class="line-modified">192                 extraPAs);</span>
193         obuf = tgsReqMessg.asn1Encode();
194 
195         // XXX We need to revisit this to see if can&#39;t move it
196         // up such that FORWARDED flag set in the options
197         // is included in the marshaled request.
198         /*
199          * If this is based on a forwarded ticket, record that in the
200          * options, because the returned TgsRep will contain the
201          * FORWARDED flag set.
202          */
203         if (asCreds.flags.get(KDCOptions.FORWARDED))
204             options.set(KDCOptions.FORWARDED, true);
205 
206 
207     }
208 
209     /**
210      * Sends a TGS request to the realm of the target.
211      * @throws KrbException
212      * @throws IOException
</pre>
<hr />
<pre>
238 
239     KerberosTime getCtime() {
240         return ctime;
241     }
242 
243     private TGSReq createRequest(
244                          KDCOptions kdc_options,
245                          Ticket ticket,
246                          EncryptionKey key,
247                          KerberosTime ctime,
248                          PrincipalName cname,
249                          PrincipalName sname,
250                          KerberosTime from,
251                          KerberosTime till,
252                          KerberosTime rtime,
253                          int[] eTypes,
254                          HostAddresses addresses,
255                          AuthorizationData authorizationData,
256                          Ticket[] additionalTickets,
257                          EncryptionKey subKey,
<span class="line-modified">258                          PAData[] extraPAs)</span>
259         throws IOException, KrbException, UnknownHostException {
260         KerberosTime req_till = null;
261         if (till == null) {
262             String d = Config.getInstance().get(&quot;libdefaults&quot;, &quot;ticket_lifetime&quot;);
263             if (d != null) {
264                 req_till = new KerberosTime(Instant.now().plusSeconds(Config.duration(d)));
265             } else {
266                 req_till = new KerberosTime(0); // Choose KDC maximum allowed
267             }
268         } else {
269             req_till = till;
270         }
271 
272         /*
273          * RFC 4120, Section 5.4.2.
274          * For KRB_TGS_REP, the ciphertext is encrypted in the
275          * sub-session key from the Authenticator, or if absent,
276          * the session key from the ticket-granting ticket used
277          * in the request.
278          *
</pre>
<hr />
<pre>
301                 encAuthorizationData = new EncryptedData(key, ad,
302                     KeyUsage.KU_TGS_REQ_AUTH_DATA_SESSKEY);
303         }
304 
305         KDCReqBody reqBody = new KDCReqBody(
306                                             kdc_options,
307                                             cname,
308                                             sname,
309                                             from,
310                                             req_till,
311                                             rtime,
312                                             Nonce.value(),
313                                             req_eTypes,
314                                             addresses,
315                                             encAuthorizationData,
316                                             additionalTickets);
317 
318         byte[] temp = reqBody.asn1Encode(Krb5.KRB_TGS_REQ);
319         // if the checksum type is one of the keyed checksum types,
320         // use session key.
<span class="line-modified">321         Checksum cksum  = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp, key,</span>













322                 KeyUsage.KU_PA_TGS_REQ_CKSUM);







323 
324         // Usage will be KeyUsage.KU_PA_TGS_REQ_AUTHENTICATOR
325 
326         byte[] tgs_ap_req = new KrbApReq(
327                                          new APOptions(),
328                                          ticket,
329                                          key,
330                                          cname,
331                                          cksum,
332                                          ctime,
333                                          reqKey,
334                                          null,
335                                          null).getMessage();
336 
337         PAData tgsPAData = new PAData(Krb5.PA_TGS_REQ, tgs_ap_req);
<span class="line-modified">338         PAData[] pa;</span>
<span class="line-modified">339         if (extraPAs != null) {</span>
<span class="line-modified">340             pa = Arrays.copyOf(extraPAs, extraPAs.length + 1);</span>
<span class="line-modified">341             pa[extraPAs.length] = tgsPAData;</span>
<span class="line-modified">342         } else {</span>
<span class="line-added">343             pa = new PAData[] {tgsPAData};</span>
<span class="line-added">344         }</span>
<span class="line-added">345         return new TGSReq(pa, reqBody);</span>
346     }
347 
348     TGSReq getMessage() {
349         return tgsReqMessg;
350     }
351 
352     Ticket getSecondTicket() {
353         return secondTicket;
354     }
355 
<span class="line-added">356     PrincipalName getClientAlias() {</span>
<span class="line-added">357         return clientAlias;</span>
<span class="line-added">358     }</span>
<span class="line-added">359 </span>
<span class="line-added">360     PrincipalName getServerAlias() {</span>
<span class="line-added">361         return serverAlias;</span>
<span class="line-added">362     }</span>
<span class="line-added">363 </span>
364     private static void debug(String message) {
365         //      System.err.println(&quot;&gt;&gt;&gt; KrbTgsReq: &quot; + message);
366     }
367 
368     boolean usedSubkey() {
369         return useSubkey;
370     }
371 
372 }
</pre>
</td>
</tr>
</table>
<center><a href="KrbTgsRep.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PrincipalName.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>