<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.jgss/share/classes/sun/security/krb5/Credentials.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Config.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EncryptionKey.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/Credentials.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -47,57 +47,77 @@</span>
   */
  public class Credentials {
  
      Ticket ticket;
      PrincipalName client;
<span class="udiff-line-added">+     PrincipalName clientAlias;</span>
      PrincipalName server;
<span class="udiff-line-added">+     PrincipalName serverAlias;</span>
      EncryptionKey key;
      TicketFlags flags;
      KerberosTime authTime;
      KerberosTime startTime;
      KerberosTime endTime;
      KerberosTime renewTill;
      HostAddresses cAddr;
<span class="udiff-line-removed">-     EncryptionKey serviceKey;</span>
      AuthorizationData authzData;
      private static boolean DEBUG = Krb5.DEBUG;
      private static CredentialsCache cache;
      static boolean alreadyLoaded = false;
      private static boolean alreadyTried = false;
  
<span class="udiff-line-added">+     private Credentials proxy = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public Credentials getProxy() {</span>
<span class="udiff-line-added">+         return proxy;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public Credentials setProxy(Credentials proxy) {</span>
<span class="udiff-line-added">+         this.proxy = proxy;</span>
<span class="udiff-line-added">+         return this;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // Read native ticket with session key type in the given list
      private static native Credentials acquireDefaultNativeCreds(int[] eTypes);
  
      public Credentials(Ticket new_ticket,
                         PrincipalName new_client,
<span class="udiff-line-added">+                        PrincipalName new_client_alias,</span>
                         PrincipalName new_server,
<span class="udiff-line-added">+                        PrincipalName new_server_alias,</span>
                         EncryptionKey new_key,
                         TicketFlags new_flags,
                         KerberosTime authTime,
                         KerberosTime new_startTime,
                         KerberosTime new_endTime,
                         KerberosTime renewTill,
                         HostAddresses cAddr,
                         AuthorizationData authzData) {
<span class="udiff-line-modified-removed">-         this(new_ticket, new_client, new_server, new_key, new_flags,</span>
<span class="udiff-line-modified-removed">-                 authTime, new_startTime, new_endTime, renewTill, cAddr);</span>
<span class="udiff-line-modified-added">+         this(new_ticket, new_client, new_client_alias, new_server,</span>
<span class="udiff-line-modified-added">+                 new_server_alias, new_key, new_flags, authTime,</span>
<span class="udiff-line-added">+                 new_startTime, new_endTime, renewTill, cAddr);</span>
          this.authzData = authzData;
      }
  
<span class="udiff-line-added">+     // Warning: called by NativeCreds.c and nativeccache.c</span>
      public Credentials(Ticket new_ticket,
                         PrincipalName new_client,
<span class="udiff-line-added">+                        PrincipalName new_client_alias,</span>
                         PrincipalName new_server,
<span class="udiff-line-added">+                        PrincipalName new_server_alias,</span>
                         EncryptionKey new_key,
                         TicketFlags new_flags,
                         KerberosTime authTime,
                         KerberosTime new_startTime,
                         KerberosTime new_endTime,
                         KerberosTime renewTill,
                         HostAddresses cAddr) {
          ticket = new_ticket;
          client = new_client;
<span class="udiff-line-added">+         clientAlias = new_client_alias;</span>
          server = new_server;
<span class="udiff-line-added">+         serverAlias = new_server_alias;</span>
          key = new_key;
          flags = new_flags;
          this.authTime = authTime;
          startTime = new_startTime;
          endTime = new_endTime;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -105,22 +125,28 @@</span>
          this.cAddr = cAddr;
      }
  
      public Credentials(byte[] encoding,
                         String client,
<span class="udiff-line-added">+                        String clientAlias,</span>
                         String server,
<span class="udiff-line-added">+                        String serverAlias,</span>
                         byte[] keyBytes,
                         int keyType,
                         boolean[] flags,
                         Date authTime,
                         Date startTime,
                         Date endTime,
                         Date renewTill,
                         InetAddress[] cAddrs) throws KrbException, IOException {
          this(new Ticket(encoding),
               new PrincipalName(client, PrincipalName.KRB_NT_PRINCIPAL),
<span class="udiff-line-added">+              (clientAlias == null? null : new PrincipalName(clientAlias,</span>
<span class="udiff-line-added">+                      PrincipalName.KRB_NT_PRINCIPAL)),</span>
               new PrincipalName(server, PrincipalName.KRB_NT_SRV_INST),
<span class="udiff-line-added">+              (serverAlias == null? null : new PrincipalName(serverAlias,</span>
<span class="udiff-line-added">+                      PrincipalName.KRB_NT_SRV_INST)),</span>
               new EncryptionKey(keyType, keyBytes),
               (flags == null? null: new TicketFlags(flags)),
               (authTime == null? null: new KerberosTime(authTime)),
               (startTime == null? null: new KerberosTime(startTime)),
               (endTime == null? null: new KerberosTime(endTime)),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,14 +167,22 @@</span>
  
      public final PrincipalName getClient() {
          return client;
      }
  
<span class="udiff-line-added">+     public final PrincipalName getClientAlias() {</span>
<span class="udiff-line-added">+         return clientAlias;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public final PrincipalName getServer() {
          return server;
      }
  
<span class="udiff-line-added">+     public final PrincipalName getServerAlias() {</span>
<span class="udiff-line-added">+         return serverAlias;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public final EncryptionKey getSessionKey() {
          return key;
      }
  
      public final Date getAuthTime() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -200,15 +234,17 @@</span>
      public final byte[] getEncoded() {
          byte[] retVal = null;
          try {
              retVal = ticket.asn1Encode();
          } catch (Asn1Exception e) {
<span class="udiff-line-modified-removed">-             if (DEBUG)</span>
<span class="udiff-line-modified-removed">-             System.out.println(e);</span>
<span class="udiff-line-modified-added">+             if (DEBUG) {</span>
<span class="udiff-line-modified-added">+                 System.out.println(e);</span>
<span class="udiff-line-added">+             }</span>
          } catch (IOException ioe) {
<span class="udiff-line-modified-removed">-             if (DEBUG)</span>
<span class="udiff-line-modified-removed">-             System.out.println(ioe);</span>
<span class="udiff-line-modified-added">+             if (DEBUG) {</span>
<span class="udiff-line-modified-added">+                 System.out.println(ioe);</span>
<span class="udiff-line-added">+             }</span>
          }
          return retVal;
      }
  
      public boolean isForwardable() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -260,10 +296,11 @@</span>
          options.set(KDCOptions.RENEWABLE, true);
  
          return new KrbTgsReq(options,
                               this,
                               server,
<span class="udiff-line-added">+                              serverAlias,</span>
                               null, // from
                               null, // till
                               null, // rtime
                               null, // eTypes
                               cAddr,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -293,33 +330,33 @@</span>
              if (os.toUpperCase(Locale.ENGLISH).startsWith(&quot;WINDOWS&quot;) ||
                      os.toUpperCase(Locale.ENGLISH).contains(&quot;OS X&quot;)) {
                  Credentials creds = acquireDefaultCreds();
                  if (creds == null) {
                      if (DEBUG) {
<span class="udiff-line-modified-removed">-                         System.out.println(&quot;&gt;&gt;&gt; Found no TGT&#39;s in LSA&quot;);</span>
<span class="udiff-line-modified-added">+                         System.out.println(&quot;&gt;&gt;&gt; Found no TGT&#39;s in native ccache&quot;);</span>
                      }
                      return null;
                  }
                  if (princ != null) {
                      if (creds.getClient().equals(princ)) {
                          if (DEBUG) {
<span class="udiff-line-modified-removed">-                             System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from LSA: &quot;</span>
<span class="udiff-line-modified-added">+                             System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from native ccache: &quot;</span>
                                                 + creds);
                          }
                          return creds;
                      } else {
                          if (DEBUG) {
<span class="udiff-line-modified-removed">-                             System.out.println(&quot;&gt;&gt;&gt; LSA contains TGT for &quot;</span>
<span class="udiff-line-modified-added">+                             System.out.println(&quot;&gt;&gt;&gt; native ccache contains TGT for &quot;</span>
                                                 + creds.getClient()
                                                 + &quot; not &quot;
                                                 + princ);
                          }
                          return null;
                      }
                  } else {
                      if (DEBUG) {
<span class="udiff-line-modified-removed">-                         System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from LSA: &quot;</span>
<span class="udiff-line-modified-added">+                         System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from native ccache: &quot;</span>
                                             + creds);
                      }
                      return creds;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -334,24 +371,23 @@</span>
  
          if (ccache == null) {
              return null;
          }
  
<span class="udiff-line-modified-removed">-         sun.security.krb5.internal.ccache.Credentials tgtCred  =</span>
<span class="udiff-line-removed">-             ccache.getDefaultCreds();</span>
<span class="udiff-line-modified-added">+         Credentials tgtCred = ccache.getInitialCreds();</span>
  
          if (tgtCred == null) {
              return null;
          }
  
<span class="udiff-line-modified-removed">-         if (EType.isSupported(tgtCred.getEType())) {</span>
<span class="udiff-line-modified-removed">-             return tgtCred.setKrbCreds();</span>
<span class="udiff-line-modified-added">+         if (EType.isSupported(tgtCred.key.getEType())) {</span>
<span class="udiff-line-modified-added">+             return tgtCred;</span>
          } else {
              if (DEBUG) {
                  System.out.println(
                      &quot;&gt;&gt;&gt; unsupported key type found the default TGT: &quot; +
<span class="udiff-line-modified-removed">-                     tgtCred.getEType());</span>
<span class="udiff-line-modified-added">+                     tgtCred.key.getEType());</span>
              }
              return null;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,24 +418,23 @@</span>
  
          if (cache == null) {
              cache = CredentialsCache.getInstance();
          }
          if (cache != null) {
<span class="udiff-line-modified-removed">-             sun.security.krb5.internal.ccache.Credentials temp =</span>
<span class="udiff-line-removed">-                 cache.getDefaultCreds();</span>
<span class="udiff-line-modified-added">+             Credentials temp = cache.getInitialCreds();</span>
              if (temp != null) {
                  if (DEBUG) {
                      System.out.println(&quot;&gt;&gt;&gt; KrbCreds found the default ticket&quot;
                              + &quot; granting ticket in credential cache.&quot;);
                  }
<span class="udiff-line-modified-removed">-                 if (EType.isSupported(temp.getEType())) {</span>
<span class="udiff-line-modified-removed">-                     result = temp.setKrbCreds();</span>
<span class="udiff-line-modified-added">+                 if (EType.isSupported(temp.key.getEType())) {</span>
<span class="udiff-line-modified-added">+                     result = temp;</span>
                  } else {
                      if (DEBUG) {
                          System.out.println(
                              &quot;&gt;&gt;&gt; unsupported key type found the default TGT: &quot; +
<span class="udiff-line-modified-removed">-                             temp.getEType());</span>
<span class="udiff-line-modified-added">+                             temp.key.getEType());</span>
                      }
                  }
              }
          }
          if (result == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -410,11 +445,11 @@</span>
                  // See if there&#39;s any native code to load
                  try {
                      ensureLoaded();
                  } catch (Exception e) {
                      if (DEBUG) {
<span class="udiff-line-modified-removed">-                         System.out.println(&quot;Can not load credentials cache&quot;);</span>
<span class="udiff-line-modified-added">+                         System.out.println(&quot;Can not load native ccache library&quot;);</span>
                          e.printStackTrace();
                      }
                      alreadyTried = true;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -472,21 +507,21 @@</span>
  
      public CredentialsCache getCache() {
          return cache;
      }
  
<span class="udiff-line-removed">-     public EncryptionKey getServiceKey() {</span>
<span class="udiff-line-removed">-         return serviceKey;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /*
       * Prints out debug info.
       */
      public static void printDebug(Credentials c) {
          System.out.println(&quot;&gt;&gt;&gt; DEBUG: ----Credentials----&quot;);
          System.out.println(&quot;\tclient: &quot; + c.client.toString());
<span class="udiff-line-added">+         if (c.clientAlias != null)</span>
<span class="udiff-line-added">+             System.out.println(&quot;\tclient alias: &quot; + c.clientAlias.toString());</span>
          System.out.println(&quot;\tserver: &quot; + c.server.toString());
<span class="udiff-line-added">+         if (c.serverAlias != null)</span>
<span class="udiff-line-added">+             System.out.println(&quot;\tserver alias: &quot; + c.serverAlias.toString());</span>
          System.out.println(&quot;\tticket: sname: &quot; + c.ticket.sname.toString());
          if (c.startTime != null) {
              System.out.println(&quot;\tstartTime: &quot; + c.startTime.getTime());
          }
          System.out.println(&quot;\tendTime: &quot; + c.endTime.getTime());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -510,11 +545,15 @@</span>
      }
  
      public String toString() {
          StringBuilder sb = new StringBuilder(&quot;Credentials:&quot;);
          sb.append(    &quot;\n      client=&quot;).append(client);
<span class="udiff-line-added">+         if (clientAlias != null)</span>
<span class="udiff-line-added">+             sb.append(    &quot;\n      clientAlias=&quot;).append(clientAlias);</span>
          sb.append(    &quot;\n      server=&quot;).append(server);
<span class="udiff-line-added">+         if (serverAlias != null)</span>
<span class="udiff-line-added">+             sb.append(    &quot;\n      serverAlias=&quot;).append(serverAlias);</span>
          if (authTime != null) {
              sb.append(&quot;\n    authTime=&quot;).append(authTime);
          }
          if (startTime != null) {
              sb.append(&quot;\n   startTime=&quot;).append(startTime);
</pre>
<center><a href="Config.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EncryptionKey.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>