<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/KrbAsRep.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbApReq.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbAsReq.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbAsRep.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
101             throws KrbException, Asn1Exception, IOException {
102         EncryptionKey dkey = null;
103         int encPartKeyType = rep.encPart.getEType();
104         Integer encPartKvno = rep.encPart.kvno;
105             try {
106                 dkey = EncryptionKey.findKey(encPartKeyType, encPartKvno,
107                         Krb5Util.keysFromJavaxKeyTab(ktab, cname));
108             } catch (KrbException ke) {
109                 if (ke.returnCode() == Krb5.KRB_AP_ERR_BADKEYVER) {
110                     // Fallback to no kvno. In some cases, keytab is generated
111                     // not by sysadmin but Java&#39;s ktab command
112                     dkey = EncryptionKey.findKey(encPartKeyType,
113                             Krb5Util.keysFromJavaxKeyTab(ktab, cname));
114                 }
115             }
116             if (dkey == null) {
117                 throw new KrbException(Krb5.API_INVALID_ARG,
118                     &quot;Cannot find key for type/kvno to decrypt AS REP - &quot; +
119                     EType.toString(encPartKeyType) + &quot;/&quot; + encPartKvno);
120             }
<span class="line-modified">121         decrypt(dkey, asReq);</span>
122     }
123 
124     /**
125      * Called by KrbAsReqBuilder to resolve a AS-REP message using a password.
126      * @param password user provided password. not null
127      * @param asReq the original AS-REQ sent, used to validate AS-REP
128      * @param cname the user principal name, used to provide salt
129      */
130     void decryptUsingPassword(char[] password,
131             KrbAsReq asReq, PrincipalName cname)
132             throws KrbException, Asn1Exception, IOException {
133         int encPartKeyType = rep.encPart.getEType();
134         EncryptionKey dkey = EncryptionKey.acquireSecretKey(
135                 cname,
136                 password,
137                 encPartKeyType,
138                 PAData.getSaltAndParams(encPartKeyType, rep.pAData));
<span class="line-modified">139         decrypt(dkey, asReq);</span>
140     }
141 
142     /**
143      * Decrypts encrypted content inside AS-REP. Called by initiator.
144      * @param dkey the decryption key to use
145      * @param asReq the original AS-REQ sent, used to validate AS-REP
146      */
<span class="line-modified">147     private void decrypt(EncryptionKey dkey, KrbAsReq asReq)</span>

148             throws KrbException, Asn1Exception, IOException {
149         byte[] enc_as_rep_bytes = rep.encPart.decrypt(dkey,
150             KeyUsage.KU_ENC_AS_REP_PART);
151         byte[] enc_as_rep_part = rep.encPart.reset(enc_as_rep_bytes);
152 
153         DerValue encoding = new DerValue(enc_as_rep_part);
154         EncASRepPart enc_part = new EncASRepPart(encoding);
155         rep.encKDCRepPart = enc_part;
156 
157         ASReq req = asReq.getMessage();
<span class="line-modified">158         check(true, req, rep);</span>




159 
160         creds = new Credentials(
161                                 rep.ticket,
<span class="line-modified">162                                 req.reqBody.cname,</span>

163                                 enc_part.sname,

164                                 enc_part.key,
165                                 enc_part.flags,
166                                 enc_part.authtime,
167                                 enc_part.starttime,
168                                 enc_part.endtime,
169                                 enc_part.renewTill,
170                                 enc_part.caddr);
171         if (DEBUG) {
172             System.out.println(&quot;&gt;&gt;&gt; KrbAsRep cons in KrbAsReq.getReply &quot; +
173                                req.reqBody.cname.getNameString());
174         }
175     }
176 
177     Credentials getCreds() {
178         return Objects.requireNonNull(creds, &quot;Creds not available yet.&quot;);
179     }
180 
181     sun.security.krb5.internal.ccache.Credentials getCCreds() {
182         return new sun.security.krb5.internal.ccache.Credentials(rep);
183     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
101             throws KrbException, Asn1Exception, IOException {
102         EncryptionKey dkey = null;
103         int encPartKeyType = rep.encPart.getEType();
104         Integer encPartKvno = rep.encPart.kvno;
105             try {
106                 dkey = EncryptionKey.findKey(encPartKeyType, encPartKvno,
107                         Krb5Util.keysFromJavaxKeyTab(ktab, cname));
108             } catch (KrbException ke) {
109                 if (ke.returnCode() == Krb5.KRB_AP_ERR_BADKEYVER) {
110                     // Fallback to no kvno. In some cases, keytab is generated
111                     // not by sysadmin but Java&#39;s ktab command
112                     dkey = EncryptionKey.findKey(encPartKeyType,
113                             Krb5Util.keysFromJavaxKeyTab(ktab, cname));
114                 }
115             }
116             if (dkey == null) {
117                 throw new KrbException(Krb5.API_INVALID_ARG,
118                     &quot;Cannot find key for type/kvno to decrypt AS REP - &quot; +
119                     EType.toString(encPartKeyType) + &quot;/&quot; + encPartKvno);
120             }
<span class="line-modified">121         decrypt(dkey, asReq, cname);</span>
122     }
123 
124     /**
125      * Called by KrbAsReqBuilder to resolve a AS-REP message using a password.
126      * @param password user provided password. not null
127      * @param asReq the original AS-REQ sent, used to validate AS-REP
128      * @param cname the user principal name, used to provide salt
129      */
130     void decryptUsingPassword(char[] password,
131             KrbAsReq asReq, PrincipalName cname)
132             throws KrbException, Asn1Exception, IOException {
133         int encPartKeyType = rep.encPart.getEType();
134         EncryptionKey dkey = EncryptionKey.acquireSecretKey(
135                 cname,
136                 password,
137                 encPartKeyType,
138                 PAData.getSaltAndParams(encPartKeyType, rep.pAData));
<span class="line-modified">139         decrypt(dkey, asReq, cname);</span>
140     }
141 
142     /**
143      * Decrypts encrypted content inside AS-REP. Called by initiator.
144      * @param dkey the decryption key to use
145      * @param asReq the original AS-REQ sent, used to validate AS-REP
146      */
<span class="line-modified">147     private void decrypt(EncryptionKey dkey, KrbAsReq asReq,</span>
<span class="line-added">148             PrincipalName cname)</span>
149             throws KrbException, Asn1Exception, IOException {
150         byte[] enc_as_rep_bytes = rep.encPart.decrypt(dkey,
151             KeyUsage.KU_ENC_AS_REP_PART);
152         byte[] enc_as_rep_part = rep.encPart.reset(enc_as_rep_bytes);
153 
154         DerValue encoding = new DerValue(enc_as_rep_part);
155         EncASRepPart enc_part = new EncASRepPart(encoding);
156         rep.encKDCRepPart = enc_part;
157 
158         ASReq req = asReq.getMessage();
<span class="line-modified">159         check(true, req, rep, dkey);</span>
<span class="line-added">160 </span>
<span class="line-added">161         PrincipalName clientAlias = cname;</span>
<span class="line-added">162         if (clientAlias.equals(rep.cname))</span>
<span class="line-added">163             clientAlias = null;</span>
164 
165         creds = new Credentials(
166                                 rep.ticket,
<span class="line-modified">167                                 rep.cname,</span>
<span class="line-added">168                                 clientAlias,</span>
169                                 enc_part.sname,
<span class="line-added">170                                 null, // No server alias expected in a TGT</span>
171                                 enc_part.key,
172                                 enc_part.flags,
173                                 enc_part.authtime,
174                                 enc_part.starttime,
175                                 enc_part.endtime,
176                                 enc_part.renewTill,
177                                 enc_part.caddr);
178         if (DEBUG) {
179             System.out.println(&quot;&gt;&gt;&gt; KrbAsRep cons in KrbAsReq.getReply &quot; +
180                                req.reqBody.cname.getNameString());
181         }
182     }
183 
184     Credentials getCreds() {
185         return Objects.requireNonNull(creds, &quot;Creds not available yet.&quot;);
186     }
187 
188     sun.security.krb5.internal.ccache.Credentials getCCreds() {
189         return new sun.security.krb5.internal.ccache.Credentials(rep);
190     }
</pre>
</td>
</tr>
</table>
<center><a href="KrbApReq.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbAsReq.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>