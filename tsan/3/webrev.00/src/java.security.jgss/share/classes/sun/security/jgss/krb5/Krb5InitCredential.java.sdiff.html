<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Krb5Context.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Krb5MechFactory.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5InitCredential.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 36 import java.util.Date;
 37 import java.security.AccessController;
 38 import java.security.AccessControlContext;
 39 import java.security.PrivilegedExceptionAction;
 40 import java.security.PrivilegedActionException;
 41 
 42 /**
 43  * Implements the krb5 initiator credential element.
 44  *
 45  * @author Mayank Upadhyay
 46  * @author Ram Marti
 47  * @since 1.4
 48  */
 49 
 50 public class Krb5InitCredential
 51     extends KerberosTicket
 52     implements Krb5CredElement {
 53 
 54     private static final long serialVersionUID = 7723415700837898232L;
 55 

 56     private Krb5NameElement name;

 57     private Credentials krb5Credentials;

 58 
 59     private Krb5InitCredential(Krb5NameElement name,
 60                                byte[] asn1Encoding,
 61                                KerberosPrincipal client,

 62                                KerberosPrincipal server,

 63                                byte[] sessionKey,
 64                                int keyType,
 65                                boolean[] flags,
 66                                Date authTime,
 67                                Date startTime,
 68                                Date endTime,
 69                                Date renewTill,
 70                                InetAddress[] clientAddresses)
 71                                throws GSSException {
 72         super(asn1Encoding,
 73               client,
 74               server,
 75               sessionKey,
 76               keyType,
 77               flags,
 78               authTime,
 79               startTime,
 80               endTime,
 81               renewTill,
 82               clientAddresses);
<span class="line-modified"> 83 </span>



 84         this.name = name;
 85 
 86         try {
 87             // Cache this for later use by the sun.security.krb5 package.
 88             krb5Credentials = new Credentials(asn1Encoding,
 89                                               client.getName(),


 90                                               server.getName(),


 91                                               sessionKey,
 92                                               keyType,
 93                                               flags,
 94                                               authTime,
 95                                               startTime,
 96                                               endTime,
 97                                               renewTill,
 98                                               clientAddresses);
 99         } catch (KrbException e) {
100             throw new GSSException(GSSException.NO_CRED, -1,
101                                    e.getMessage());
102         } catch (IOException e) {
103             throw new GSSException(GSSException.NO_CRED, -1,
104                                    e.getMessage());
105         }
106 
107     }
108 
109     private Krb5InitCredential(Krb5NameElement name,
110                                Credentials delegatedCred,
111                                byte[] asn1Encoding,
112                                KerberosPrincipal client,

113                                KerberosPrincipal server,

114                                byte[] sessionKey,
115                                int keyType,
116                                boolean[] flags,
117                                Date authTime,
118                                Date startTime,
119                                Date endTime,
120                                Date renewTill,
121                                InetAddress[] clientAddresses)
122                                throws GSSException {
123         super(asn1Encoding,
124               client,
125               server,
126               sessionKey,
127               keyType,
128               flags,
129               authTime,
130               startTime,
131               endTime,
132               renewTill,
133               clientAddresses);
<span class="line-modified">134 </span>



135         this.name = name;
136         // A delegated cred does not have all fields set. So do not try to
137         // creat new Credentials out of the delegatedCred.
138         this.krb5Credentials = delegatedCred;
139     }
140 
141     static Krb5InitCredential getInstance(GSSCaller caller, Krb5NameElement name,
142                                    int initLifetime)
143         throws GSSException {
144 
145         KerberosTicket tgt = getTgt(caller, name, initLifetime);
146         if (tgt == null)
147             throw new GSSException(GSSException.NO_CRED, -1,
148                                    &quot;Failed to find any Kerberos tgt&quot;);
149 
150         if (name == null) {
151             String fullName = tgt.getClient().getName();
152             name = Krb5NameElement.getInstance(fullName,
153                                        Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
154         }
155 
<span class="line-modified">156         return new Krb5InitCredential(name,</span>






157                                       tgt.getEncoded(),
158                                       tgt.getClient(),

159                                       tgt.getServer(),

160                                       tgt.getSessionKey().getEncoded(),
161                                       tgt.getSessionKeyType(),
162                                       tgt.getFlags(),
163                                       tgt.getAuthTime(),
164                                       tgt.getStartTime(),
165                                       tgt.getEndTime(),
166                                       tgt.getRenewTill(),
167                                       tgt.getClientAddresses());



168     }
169 
170     static Krb5InitCredential getInstance(Krb5NameElement name,
171                                    Credentials delegatedCred)
172         throws GSSException {
173 
174         EncryptionKey sessionKey = delegatedCred.getSessionKey();
175 
176         /*
177          * all of the following data is optional in a KRB-CRED
178          * messages. This check for each field.
179          */
180 
181         PrincipalName cPrinc = delegatedCred.getClient();

182         PrincipalName sPrinc = delegatedCred.getServer();

183 
184         KerberosPrincipal client = null;

185         KerberosPrincipal server = null;

186 
187         Krb5NameElement credName = null;
188 
189         if (cPrinc != null) {
190             String fullName = cPrinc.getName();
191             credName = Krb5NameElement.getInstance(fullName,
192                                Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
193             client =  new KerberosPrincipal(fullName);
194         }
195 




196         // XXX Compare name to credName
197 
198         if (sPrinc != null) {
199             server =
200                 new KerberosPrincipal(sPrinc.getName(),
201                                         KerberosPrincipal.KRB_NT_SRV_INST);
202         }
203 




204         return new Krb5InitCredential(credName,
205                                       delegatedCred,
206                                       delegatedCred.getEncoded(),
207                                       client,

208                                       server,

209                                       sessionKey.getBytes(),
210                                       sessionKey.getEType(),
211                                       delegatedCred.getFlags(),
212                                       delegatedCred.getAuthTime(),
213                                       delegatedCred.getStartTime(),
214                                       delegatedCred.getEndTime(),
215                                       delegatedCred.getRenewTill(),
216                                       delegatedCred.getClientAddresses());
217     }
218 
219     /**
220      * Returns the principal name for this credential. The name
221      * is in mechanism specific format.
222      *
223      * @return GSSNameSpi representing principal name of this credential
224      * @exception GSSException may be thrown
225      */
226     public final GSSNameSpi getName() throws GSSException {
227         return name;
228     }
</pre>
<hr />
<pre>
316          * Find the TGT for the realm that the client is in. If the client
317          * name is not available, then use the default realm.
318          */
319         if (name != null) {
320             clientPrincipal = (name.getKrb5PrincipalName()).getName();
321         } else {
322             clientPrincipal = null;
323         }
324 
325         final AccessControlContext acc = AccessController.getContext();
326 
327         try {
328             final GSSCaller realCaller = (caller == GSSCaller.CALLER_UNKNOWN)
329                                    ? GSSCaller.CALLER_INITIATE
330                                    : caller;
331             return AccessController.doPrivileged(
332                 new PrivilegedExceptionAction&lt;KerberosTicket&gt;() {
333                 public KerberosTicket run() throws Exception {
334                     // It&#39;s OK to use null as serverPrincipal. TGT is almost
335                     // the first ticket for a principal and we use list.
<span class="line-modified">336                     return Krb5Util.getTicket(</span>
337                         realCaller,
<span class="line-modified">338                         clientPrincipal, null, acc);</span>
339                         }});
340         } catch (PrivilegedActionException e) {
341             GSSException ge =
342                 new GSSException(GSSException.NO_CRED, -1,
343                     &quot;Attempt to obtain new INITIATE credentials failed!&quot; +
344                     &quot; (&quot; + e.getMessage() + &quot;)&quot;);
345             ge.initCause(e.getException());
346             throw ge;
347         }
348     }
349 
350     @Override
351     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
352         try {
353             Krb5NameElement kname = (Krb5NameElement)name;
354             Credentials newCred = Credentials.acquireS4U2selfCreds(
355                     kname.getKrb5PrincipalName(), krb5Credentials);
356             return new Krb5ProxyCredential(this, kname, newCred.getTicket());
357         } catch (IOException | KrbException ke) {
358             GSSException ge =
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 36 import java.util.Date;
 37 import java.security.AccessController;
 38 import java.security.AccessControlContext;
 39 import java.security.PrivilegedExceptionAction;
 40 import java.security.PrivilegedActionException;
 41 
 42 /**
 43  * Implements the krb5 initiator credential element.
 44  *
 45  * @author Mayank Upadhyay
 46  * @author Ram Marti
 47  * @since 1.4
 48  */
 49 
 50 public class Krb5InitCredential
 51     extends KerberosTicket
 52     implements Krb5CredElement {
 53 
 54     private static final long serialVersionUID = 7723415700837898232L;
 55 
<span class="line-added"> 56     @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
 57     private Krb5NameElement name;
<span class="line-added"> 58     @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
 59     private Credentials krb5Credentials;
<span class="line-added"> 60     public KerberosTicket proxyTicket;</span>
 61 
 62     private Krb5InitCredential(Krb5NameElement name,
 63                                byte[] asn1Encoding,
 64                                KerberosPrincipal client,
<span class="line-added"> 65                                KerberosPrincipal clientAlias,</span>
 66                                KerberosPrincipal server,
<span class="line-added"> 67                                KerberosPrincipal serverAlias,</span>
 68                                byte[] sessionKey,
 69                                int keyType,
 70                                boolean[] flags,
 71                                Date authTime,
 72                                Date startTime,
 73                                Date endTime,
 74                                Date renewTill,
 75                                InetAddress[] clientAddresses)
 76                                throws GSSException {
 77         super(asn1Encoding,
 78               client,
 79               server,
 80               sessionKey,
 81               keyType,
 82               flags,
 83               authTime,
 84               startTime,
 85               endTime,
 86               renewTill,
 87               clientAddresses);
<span class="line-modified"> 88         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added"> 89                 .kerberosTicketSetClientAlias(this, clientAlias);</span>
<span class="line-added"> 90         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added"> 91                 .kerberosTicketSetServerAlias(this, serverAlias);</span>
 92         this.name = name;
 93 
 94         try {
 95             // Cache this for later use by the sun.security.krb5 package.
 96             krb5Credentials = new Credentials(asn1Encoding,
 97                                               client.getName(),
<span class="line-added"> 98                                               (clientAlias != null ?</span>
<span class="line-added"> 99                                                       clientAlias.getName() : null),</span>
100                                               server.getName(),
<span class="line-added">101                                               (serverAlias != null ?</span>
<span class="line-added">102                                                       serverAlias.getName() : null),</span>
103                                               sessionKey,
104                                               keyType,
105                                               flags,
106                                               authTime,
107                                               startTime,
108                                               endTime,
109                                               renewTill,
110                                               clientAddresses);
111         } catch (KrbException e) {
112             throw new GSSException(GSSException.NO_CRED, -1,
113                                    e.getMessage());
114         } catch (IOException e) {
115             throw new GSSException(GSSException.NO_CRED, -1,
116                                    e.getMessage());
117         }
118 
119     }
120 
121     private Krb5InitCredential(Krb5NameElement name,
122                                Credentials delegatedCred,
123                                byte[] asn1Encoding,
124                                KerberosPrincipal client,
<span class="line-added">125                                KerberosPrincipal clientAlias,</span>
126                                KerberosPrincipal server,
<span class="line-added">127                                KerberosPrincipal serverAlias,</span>
128                                byte[] sessionKey,
129                                int keyType,
130                                boolean[] flags,
131                                Date authTime,
132                                Date startTime,
133                                Date endTime,
134                                Date renewTill,
135                                InetAddress[] clientAddresses)
136                                throws GSSException {
137         super(asn1Encoding,
138               client,
139               server,
140               sessionKey,
141               keyType,
142               flags,
143               authTime,
144               startTime,
145               endTime,
146               renewTill,
147               clientAddresses);
<span class="line-modified">148         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">149                 .kerberosTicketSetClientAlias(this, clientAlias);</span>
<span class="line-added">150         KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">151                 .kerberosTicketSetServerAlias(this, serverAlias);</span>
152         this.name = name;
153         // A delegated cred does not have all fields set. So do not try to
154         // creat new Credentials out of the delegatedCred.
155         this.krb5Credentials = delegatedCred;
156     }
157 
158     static Krb5InitCredential getInstance(GSSCaller caller, Krb5NameElement name,
159                                    int initLifetime)
160         throws GSSException {
161 
162         KerberosTicket tgt = getTgt(caller, name, initLifetime);
163         if (tgt == null)
164             throw new GSSException(GSSException.NO_CRED, -1,
165                                    &quot;Failed to find any Kerberos tgt&quot;);
166 
167         if (name == null) {
168             String fullName = tgt.getClient().getName();
169             name = Krb5NameElement.getInstance(fullName,
170                                        Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
171         }
172 
<span class="line-modified">173         KerberosPrincipal clientAlias = KerberosSecrets</span>
<span class="line-added">174                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">175                 .kerberosTicketGetClientAlias(tgt);</span>
<span class="line-added">176         KerberosPrincipal serverAlias = KerberosSecrets</span>
<span class="line-added">177                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">178                 .kerberosTicketGetServerAlias(tgt);</span>
<span class="line-added">179         Krb5InitCredential result = new Krb5InitCredential(name,</span>
180                                       tgt.getEncoded(),
181                                       tgt.getClient(),
<span class="line-added">182                                       clientAlias,</span>
183                                       tgt.getServer(),
<span class="line-added">184                                       serverAlias,</span>
185                                       tgt.getSessionKey().getEncoded(),
186                                       tgt.getSessionKeyType(),
187                                       tgt.getFlags(),
188                                       tgt.getAuthTime(),
189                                       tgt.getStartTime(),
190                                       tgt.getEndTime(),
191                                       tgt.getRenewTill(),
192                                       tgt.getClientAddresses());
<span class="line-added">193         result.proxyTicket = KerberosSecrets.getJavaxSecurityAuthKerberosAccess().</span>
<span class="line-added">194             kerberosTicketGetProxy(tgt);</span>
<span class="line-added">195         return result;</span>
196     }
197 
198     static Krb5InitCredential getInstance(Krb5NameElement name,
199                                    Credentials delegatedCred)
200         throws GSSException {
201 
202         EncryptionKey sessionKey = delegatedCred.getSessionKey();
203 
204         /*
205          * all of the following data is optional in a KRB-CRED
206          * messages. This check for each field.
207          */
208 
209         PrincipalName cPrinc = delegatedCred.getClient();
<span class="line-added">210         PrincipalName cAPrinc = delegatedCred.getClientAlias();</span>
211         PrincipalName sPrinc = delegatedCred.getServer();
<span class="line-added">212         PrincipalName sAPrinc = delegatedCred.getServerAlias();</span>
213 
214         KerberosPrincipal client = null;
<span class="line-added">215         KerberosPrincipal clientAlias = null;</span>
216         KerberosPrincipal server = null;
<span class="line-added">217         KerberosPrincipal serverAlias = null;</span>
218 
219         Krb5NameElement credName = null;
220 
221         if (cPrinc != null) {
222             String fullName = cPrinc.getName();
223             credName = Krb5NameElement.getInstance(fullName,
224                                Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
225             client =  new KerberosPrincipal(fullName);
226         }
227 
<span class="line-added">228         if (cAPrinc != null) {</span>
<span class="line-added">229             clientAlias = new KerberosPrincipal(cAPrinc.getName());</span>
<span class="line-added">230         }</span>
<span class="line-added">231 </span>
232         // XXX Compare name to credName
233 
234         if (sPrinc != null) {
235             server =
236                 new KerberosPrincipal(sPrinc.getName(),
237                                         KerberosPrincipal.KRB_NT_SRV_INST);
238         }
239 
<span class="line-added">240         if (sAPrinc != null) {</span>
<span class="line-added">241             serverAlias = new KerberosPrincipal(sAPrinc.getName());</span>
<span class="line-added">242         }</span>
<span class="line-added">243 </span>
244         return new Krb5InitCredential(credName,
245                                       delegatedCred,
246                                       delegatedCred.getEncoded(),
247                                       client,
<span class="line-added">248                                       clientAlias,</span>
249                                       server,
<span class="line-added">250                                       serverAlias,</span>
251                                       sessionKey.getBytes(),
252                                       sessionKey.getEType(),
253                                       delegatedCred.getFlags(),
254                                       delegatedCred.getAuthTime(),
255                                       delegatedCred.getStartTime(),
256                                       delegatedCred.getEndTime(),
257                                       delegatedCred.getRenewTill(),
258                                       delegatedCred.getClientAddresses());
259     }
260 
261     /**
262      * Returns the principal name for this credential. The name
263      * is in mechanism specific format.
264      *
265      * @return GSSNameSpi representing principal name of this credential
266      * @exception GSSException may be thrown
267      */
268     public final GSSNameSpi getName() throws GSSException {
269         return name;
270     }
</pre>
<hr />
<pre>
358          * Find the TGT for the realm that the client is in. If the client
359          * name is not available, then use the default realm.
360          */
361         if (name != null) {
362             clientPrincipal = (name.getKrb5PrincipalName()).getName();
363         } else {
364             clientPrincipal = null;
365         }
366 
367         final AccessControlContext acc = AccessController.getContext();
368 
369         try {
370             final GSSCaller realCaller = (caller == GSSCaller.CALLER_UNKNOWN)
371                                    ? GSSCaller.CALLER_INITIATE
372                                    : caller;
373             return AccessController.doPrivileged(
374                 new PrivilegedExceptionAction&lt;KerberosTicket&gt;() {
375                 public KerberosTicket run() throws Exception {
376                     // It&#39;s OK to use null as serverPrincipal. TGT is almost
377                     // the first ticket for a principal and we use list.
<span class="line-modified">378                     return Krb5Util.getInitialTicket(</span>
379                         realCaller,
<span class="line-modified">380                         clientPrincipal, acc);</span>
381                         }});
382         } catch (PrivilegedActionException e) {
383             GSSException ge =
384                 new GSSException(GSSException.NO_CRED, -1,
385                     &quot;Attempt to obtain new INITIATE credentials failed!&quot; +
386                     &quot; (&quot; + e.getMessage() + &quot;)&quot;);
387             ge.initCause(e.getException());
388             throw ge;
389         }
390     }
391 
392     @Override
393     public GSSCredentialSpi impersonate(GSSNameSpi name) throws GSSException {
394         try {
395             Krb5NameElement kname = (Krb5NameElement)name;
396             Credentials newCred = Credentials.acquireS4U2selfCreds(
397                     kname.getKrb5PrincipalName(), krb5Credentials);
398             return new Krb5ProxyCredential(this, kname, newCred.getTicket());
399         } catch (IOException | KrbException ke) {
400             GSSException ge =
</pre>
</td>
</tr>
</table>
<center><a href="Krb5Context.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Krb5MechFactory.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>