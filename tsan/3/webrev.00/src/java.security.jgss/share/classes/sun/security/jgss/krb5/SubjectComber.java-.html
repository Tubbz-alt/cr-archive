<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.security.jgss/share/classes/sun/security/jgss/krb5/SubjectComber.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2002, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.jgss.krb5;
 27 
 28 import javax.security.auth.kerberos.KerberosTicket;
 29 import javax.security.auth.kerberos.KerberosKey;
 30 import javax.security.auth.Subject;
 31 import javax.security.auth.DestroyFailedException;
 32 import java.util.Iterator;
 33 import java.util.ArrayList;
 34 import java.util.List;
 35 import java.util.Set;
 36 import javax.security.auth.kerberos.KerberosPrincipal;
 37 import javax.security.auth.kerberos.KeyTab;
 38 
 39 /**
 40  * This utility looks through the current Subject and retrieves private
 41  * credentials for the desired client/server principals.
 42  *
 43  * @author Ram Marti
 44  * @since 1.4.2
 45  */
 46 
 47 class SubjectComber {
 48 
 49     private static final boolean DEBUG = Krb5Util.DEBUG;
 50 
 51     /**
 52      * Default constructor
 53      */
 54     private SubjectComber() {  // Cannot create one of these
 55     }
 56 
 57     static &lt;T&gt; T find(Subject subject, String serverPrincipal,
 58         String clientPrincipal, Class&lt;T&gt; credClass) {
 59 
 60         // findAux returns T if oneOnly.
 61         return credClass.cast(findAux(subject, serverPrincipal,
 62                                       clientPrincipal, credClass, true));
 63     }
 64 
 65     @SuppressWarnings(&quot;unchecked&quot;) // findAux returns List&lt;T&gt; if !oneOnly.
 66     static &lt;T&gt; List&lt;T&gt; findMany(Subject subject, String serverPrincipal,
 67         String clientPrincipal, Class&lt;T&gt; credClass) {
 68 
 69         return (List&lt;T&gt;)findAux(subject, serverPrincipal, clientPrincipal,
 70             credClass, false);
 71     }
 72 
 73     /**
 74      * Find private credentials for the specified client/server principals
 75      * in the subject. Returns null if the subject is null.
 76      *
 77      * @return the private credentials
 78      */
 79     // Returns T if oneOnly and List&lt;T&gt; if !oneOnly.
 80     private static &lt;T&gt; Object findAux(Subject subject, String serverPrincipal,
 81         String clientPrincipal, Class&lt;T&gt; credClass, boolean oneOnly) {
 82 
 83         if (subject == null) {
 84             return null;
 85         } else {
 86             List&lt;T&gt; answer = (oneOnly ? null : new ArrayList&lt;T&gt;());
 87 
 88             if (credClass == KeyTab.class) {
 89                 Iterator&lt;KeyTab&gt; iterator =
 90                     subject.getPrivateCredentials(KeyTab.class).iterator();
 91                 while (iterator.hasNext()) {
 92                     KeyTab t = iterator.next();
 93                     if (serverPrincipal != null &amp;&amp; t.isBound()) {
 94                         KerberosPrincipal name = t.getPrincipal();
 95                         if (name != null) {
 96                             if (!serverPrincipal.equals(name.getName())) {
 97                                 continue;
 98                             }
 99                         } else {
100                             // legacy bound keytab. although we don&#39;t know who
101                             // the bound principal is, it must be in allPrincs
102                             boolean found = false;
103                             for (KerberosPrincipal princ:
104                                     subject.getPrincipals(KerberosPrincipal.class)) {
105                                 if (princ.getName().equals(serverPrincipal)) {
106                                     found = true;
107                                     break;
108                                 }
109                             }
110                             if (!found) continue;
111                         }
112                     }
113                     // Check passed, we can add now
114                     if (DEBUG) {
115                         System.out.println(&quot;Found &quot; + credClass.getSimpleName()
116                                 + &quot; &quot; + t);
117                     }
118                     if (oneOnly) {
119                         return t;
120                     } else {
121                         answer.add(credClass.cast(t));
122                     }
123                 }
124             } else if (credClass == KerberosKey.class) {
125                 // We are looking for credentials for the serverPrincipal
126                 Iterator&lt;KerberosKey&gt; iterator =
127                     subject.getPrivateCredentials(KerberosKey.class).iterator();
128                 while (iterator.hasNext()) {
129                     KerberosKey t = iterator.next();
130                     String name = t.getPrincipal().getName();
131                     if (serverPrincipal == null || serverPrincipal.equals(name)) {
132                          if (DEBUG) {
133                              System.out.println(&quot;Found &quot; +
134                                      credClass.getSimpleName() + &quot; for &quot; + name);
135                          }
136                          if (oneOnly) {
137                              return t;
138                          } else {
139                              answer.add(credClass.cast(t));
140                          }
141                     }
142                 }
143             } else if (credClass == KerberosTicket.class) {
144                 // we are looking for a KerberosTicket credentials
145                 // for client-service principal pair
146                 Set&lt;Object&gt; pcs = subject.getPrivateCredentials();
147                 synchronized (pcs) {
148                     Iterator&lt;Object&gt; iterator = pcs.iterator();
149                     while (iterator.hasNext()) {
150                         Object obj = iterator.next();
151                         if (obj instanceof KerberosTicket) {
152                             @SuppressWarnings(&quot;unchecked&quot;)
153                             KerberosTicket ticket = (KerberosTicket)obj;
154                             if (DEBUG) {
155                                 System.out.println(&quot;Found ticket for &quot;
156                                                     + ticket.getClient()
157                                                     + &quot; to go to &quot;
158                                                     + ticket.getServer()
159                                                     + &quot; expiring on &quot;
160                                                     + ticket.getEndTime());
161                             }
162                             if (!ticket.isCurrent()) {
163                                 // let us remove the ticket from the Subject
164                                 // Note that both TGT and service ticket will be
165                                 // removed  upon expiration
166                                 if (!subject.isReadOnly()) {
167                                     iterator.remove();
168                                     try {
169                                         ticket.destroy();
170                                         if (DEBUG) {
171                                             System.out.println(&quot;Removed and destroyed &quot;
172                                                         + &quot;the expired Ticket \n&quot;
173                                                         + ticket);
174 
175                                         }
176                                     } catch (DestroyFailedException dfe) {
177                                         if (DEBUG) {
178                                             System.out.println(&quot;Expired ticket not&quot; +
179                                                     &quot; detroyed successfully. &quot; + dfe);
180                                         }
181                                     }
182 
183                                 }
184                             } else {
185                                 if (serverPrincipal == null ||
186                                     ticket.getServer().getName().equals(serverPrincipal))  {
187 
188                                     if (clientPrincipal == null ||
189                                         clientPrincipal.equals(
190                                             ticket.getClient().getName())) {
191                                         if (oneOnly) {
192                                             return ticket;
193                                         } else {
194                                             // Record names so that tickets will
195                                             // all belong to same principals
196                                             if (clientPrincipal == null) {
197                                                 clientPrincipal =
198                                                 ticket.getClient().getName();
199                                             }
200                                             if (serverPrincipal == null) {
201                                                 serverPrincipal =
202                                                 ticket.getServer().getName();
203                                             }
204                                             answer.add(credClass.cast(ticket));
205                                         }
206                                     }
207                                 }
208                             }
209                         }
210                     }
211                 }
212             }
213             return answer;
214         }
215     }
216 }
    </pre>
  </body>
</html>