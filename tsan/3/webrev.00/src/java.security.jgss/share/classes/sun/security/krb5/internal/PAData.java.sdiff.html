<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/internal/PAData.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NetClient.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PAForUserEnc.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/internal/PAData.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5.internal;
 33 
<span class="line-removed"> 34 import sun.security.krb5.internal.crypto.EType;</span>
<span class="line-removed"> 35 import sun.security.util.*;</span>
<span class="line-removed"> 36 import sun.security.krb5.Asn1Exception;</span>
 37 import java.io.IOException;





 38 import sun.security.krb5.internal.util.KerberosString;


 39 
 40 /**
 41  * Implements the ASN.1 PA-DATA type.
 42  *
 43  * &lt;pre&gt;{@code
 44  * PA-DATA         ::= SEQUENCE {
 45  *         -- NOTE: first tag is [1], not [0]
 46  *         padata-type     [1] Int32,
 47  *         padata-value    [2] OCTET STRING -- might be encoded AP-REQ
 48  * }
 49  * }&lt;/pre&gt;
 50  *
 51  * &lt;p&gt;
 52  * This definition reflects the Network Working Group RFC 4120
 53  * specification available at
 54  * &lt;a href=&quot;http://www.ietf.org/rfc/rfc4120.txt&quot;&gt;
 55  * http://www.ietf.org/rfc/rfc4120.txt&lt;/a&gt;.
 56  */
 57 
 58 public class PAData {
</pre>
<hr />
<pre>
122         temp.putInteger(pADataType);
123         bytes.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_PATYPE), temp);
124         temp = new DerOutputStream();
125         temp.putOctetString(pADataValue);
126         bytes.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_PAVALUE), temp);
127 
128         temp = new DerOutputStream();
129         temp.write(DerValue.tag_Sequence, bytes);
130         return temp.toByteArray();
131     }
132 
133     // accessor methods
134     public int getType() {
135         return pADataType;
136     }
137 
138     public byte[] getValue() {
139         return ((pADataValue == null) ? null : pADataValue.clone());
140     }
141 



































142     /**
143      * Gets the preferred etype from the PAData array.
144      * &lt;ol&gt;
145      * &lt;li&gt;ETYPE-INFO2-ENTRY with unknown s2kparams ignored&lt;/li&gt;
146      * &lt;li&gt;ETYPE-INFO2 preferred to ETYPE-INFO&lt;/li&gt;
147      * &lt;li&gt;Multiple entries for same etype in one PA-DATA, use the first one.&lt;/li&gt;
148      * &lt;li&gt;Multiple PA-DATA with same type, choose the last one.&lt;/li&gt;
149      * &lt;/ol&gt;
150      * (This is useful when PA-DATAs from KRB-ERROR and AS-REP are combined).
151      *
152      * @return the etype, or defaultEType if not enough info
153      * @throws Asn1Exception|IOException if there is an encoding error
154      */
155     public static int getPreferredEType(PAData[] pas, int defaultEType)
156             throws IOException, Asn1Exception {
157 
158         if (pas == null) return defaultEType;
159 
160         DerValue d = null, d2 = null;
161         for (PAData p: pas) {
</pre>
<hr />
<pre>
209      * 1. ETYPE-INFO2-ENTRY with unknown s2kparams ignored
210      * 2. PA-ETYPE-INFO2 preferred to PA-ETYPE-INFO preferred to PA-PW-SALT.
211      * 3. multiple entries for same etype in one PA-DATA, use the first one.
212      * 4. Multiple PA-DATA with same type, choose the last one
213      * (This is useful when PA-DATAs from KRB-ERROR and AS-REP are combined).
214      * @return salt and s2kparams. can be null if not found
215      */
216     public static SaltAndParams getSaltAndParams(int eType, PAData[] pas)
217             throws Asn1Exception, IOException {
218 
219         if (pas == null) return null;
220 
221         DerValue d = null, d2 = null;
222         String paPwSalt = null;
223 
224         for (PAData p: pas) {
225             if (p.getValue() == null) continue;
226             switch (p.getType()) {
227                 case Krb5.PA_PW_SALT:
228                     paPwSalt = new String(p.getValue(),
<span class="line-modified">229                             KerberosString.MSNAME?&quot;UTF8&quot;:&quot;8859_1&quot;);</span>
230                     break;
231                 case Krb5.PA_ETYPE_INFO:
232                     d = new DerValue(p.getValue());
233                     break;
234                 case Krb5.PA_ETYPE_INFO2:
235                     d2 = new DerValue(p.getValue());
236                     break;
237             }
238         }
239         if (d2 != null) {
240             while (d2.data.available() &gt; 0) {
241                 DerValue value = d2.data.getDerValue();
242                 ETypeInfo2 tmp = new ETypeInfo2(value);
243                 if (tmp.getEType() == eType &amp;&amp;
244                         (EType.isNewer(eType) || tmp.getParams() == null)) {
245                     // we don&#39;t support non-null s2kparams for old etypes
246                     return new SaltAndParams(tmp.getSalt(), tmp.getParams());
247                 }
248             }
249         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5.internal;
 33 



 34 import java.io.IOException;
<span class="line-added"> 35 import java.util.Vector;</span>
<span class="line-added"> 36 </span>
<span class="line-added"> 37 import static java.nio.charset.StandardCharsets.*;</span>
<span class="line-added"> 38 </span>
<span class="line-added"> 39 import sun.security.krb5.Asn1Exception;</span>
 40 import sun.security.krb5.internal.util.KerberosString;
<span class="line-added"> 41 import sun.security.krb5.internal.crypto.EType;</span>
<span class="line-added"> 42 import sun.security.util.*;</span>
 43 
 44 /**
 45  * Implements the ASN.1 PA-DATA type.
 46  *
 47  * &lt;pre&gt;{@code
 48  * PA-DATA         ::= SEQUENCE {
 49  *         -- NOTE: first tag is [1], not [0]
 50  *         padata-type     [1] Int32,
 51  *         padata-value    [2] OCTET STRING -- might be encoded AP-REQ
 52  * }
 53  * }&lt;/pre&gt;
 54  *
 55  * &lt;p&gt;
 56  * This definition reflects the Network Working Group RFC 4120
 57  * specification available at
 58  * &lt;a href=&quot;http://www.ietf.org/rfc/rfc4120.txt&quot;&gt;
 59  * http://www.ietf.org/rfc/rfc4120.txt&lt;/a&gt;.
 60  */
 61 
 62 public class PAData {
</pre>
<hr />
<pre>
126         temp.putInteger(pADataType);
127         bytes.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_PATYPE), temp);
128         temp = new DerOutputStream();
129         temp.putOctetString(pADataValue);
130         bytes.write(DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_PAVALUE), temp);
131 
132         temp = new DerOutputStream();
133         temp.write(DerValue.tag_Sequence, bytes);
134         return temp.toByteArray();
135     }
136 
137     // accessor methods
138     public int getType() {
139         return pADataType;
140     }
141 
142     public byte[] getValue() {
143         return ((pADataValue == null) ? null : pADataValue.clone());
144     }
145 
<span class="line-added">146     /**</span>
<span class="line-added">147      * Parse (unmarshal) a PAData from a DER input stream.  This form</span>
<span class="line-added">148      * parsing might be used when expanding a value which is part of</span>
<span class="line-added">149      * a constructed sequence and uses explicitly tagged type.</span>
<span class="line-added">150      *</span>
<span class="line-added">151      * @exception Asn1Exception if an Asn1Exception occurs.</span>
<span class="line-added">152      * @param data the Der input stream value, which contains one or more</span>
<span class="line-added">153      *        marshaled values.</span>
<span class="line-added">154      * @param explicitTag tag number.</span>
<span class="line-added">155      * @param optional indicates if this data field is optional.</span>
<span class="line-added">156      * @return an array of PAData.</span>
<span class="line-added">157      */</span>
<span class="line-added">158     public static PAData[] parseSequence(DerInputStream data,</span>
<span class="line-added">159                                       byte explicitTag, boolean optional)</span>
<span class="line-added">160         throws Asn1Exception, IOException {</span>
<span class="line-added">161         if ((optional) &amp;&amp;</span>
<span class="line-added">162                 (((byte)data.peekByte() &amp; (byte)0x1F) != explicitTag))</span>
<span class="line-added">163                 return null;</span>
<span class="line-added">164         DerValue subDer = data.getDerValue();</span>
<span class="line-added">165         DerValue subsubDer = subDer.getData().getDerValue();</span>
<span class="line-added">166         if (subsubDer.getTag() != DerValue.tag_SequenceOf) {</span>
<span class="line-added">167             throw new Asn1Exception(Krb5.ASN1_BAD_ID);</span>
<span class="line-added">168         }</span>
<span class="line-added">169         Vector&lt;PAData&gt; v = new Vector&lt;&gt;();</span>
<span class="line-added">170         while (subsubDer.getData().available() &gt; 0) {</span>
<span class="line-added">171             v.addElement(new PAData(subsubDer.getData().getDerValue()));</span>
<span class="line-added">172         }</span>
<span class="line-added">173         if (v.size() &gt; 0) {</span>
<span class="line-added">174             PAData[] pas = new PAData[v.size()];</span>
<span class="line-added">175             v.copyInto(pas);</span>
<span class="line-added">176             return pas;</span>
<span class="line-added">177         }</span>
<span class="line-added">178         return null;</span>
<span class="line-added">179     }</span>
<span class="line-added">180 </span>
181     /**
182      * Gets the preferred etype from the PAData array.
183      * &lt;ol&gt;
184      * &lt;li&gt;ETYPE-INFO2-ENTRY with unknown s2kparams ignored&lt;/li&gt;
185      * &lt;li&gt;ETYPE-INFO2 preferred to ETYPE-INFO&lt;/li&gt;
186      * &lt;li&gt;Multiple entries for same etype in one PA-DATA, use the first one.&lt;/li&gt;
187      * &lt;li&gt;Multiple PA-DATA with same type, choose the last one.&lt;/li&gt;
188      * &lt;/ol&gt;
189      * (This is useful when PA-DATAs from KRB-ERROR and AS-REP are combined).
190      *
191      * @return the etype, or defaultEType if not enough info
192      * @throws Asn1Exception|IOException if there is an encoding error
193      */
194     public static int getPreferredEType(PAData[] pas, int defaultEType)
195             throws IOException, Asn1Exception {
196 
197         if (pas == null) return defaultEType;
198 
199         DerValue d = null, d2 = null;
200         for (PAData p: pas) {
</pre>
<hr />
<pre>
248      * 1. ETYPE-INFO2-ENTRY with unknown s2kparams ignored
249      * 2. PA-ETYPE-INFO2 preferred to PA-ETYPE-INFO preferred to PA-PW-SALT.
250      * 3. multiple entries for same etype in one PA-DATA, use the first one.
251      * 4. Multiple PA-DATA with same type, choose the last one
252      * (This is useful when PA-DATAs from KRB-ERROR and AS-REP are combined).
253      * @return salt and s2kparams. can be null if not found
254      */
255     public static SaltAndParams getSaltAndParams(int eType, PAData[] pas)
256             throws Asn1Exception, IOException {
257 
258         if (pas == null) return null;
259 
260         DerValue d = null, d2 = null;
261         String paPwSalt = null;
262 
263         for (PAData p: pas) {
264             if (p.getValue() == null) continue;
265             switch (p.getType()) {
266                 case Krb5.PA_PW_SALT:
267                     paPwSalt = new String(p.getValue(),
<span class="line-modified">268                             KerberosString.MSNAME ? UTF_8 : ISO_8859_1);</span>
269                     break;
270                 case Krb5.PA_ETYPE_INFO:
271                     d = new DerValue(p.getValue());
272                     break;
273                 case Krb5.PA_ETYPE_INFO2:
274                     d2 = new DerValue(p.getValue());
275                     break;
276             }
277         }
278         if (d2 != null) {
279             while (d2.data.available() &gt; 0) {
280                 DerValue value = d2.data.getDerValue();
281                 ETypeInfo2 tmp = new ETypeInfo2(value);
282                 if (tmp.getEType() == eType &amp;&amp;
283                         (EType.isNewer(eType) || tmp.getParams() == null)) {
284                     // we don&#39;t support non-null s2kparams for old etypes
285                     return new SaltAndParams(tmp.getSalt(), tmp.getParams());
286                 }
287             }
288         }
</pre>
</td>
</tr>
</table>
<center><a href="NetClient.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PAForUserEnc.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>