<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.jgss/share/classes/sun/security/krb5/internal/CredentialsUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Realm.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ETypeInfo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/internal/CredentialsUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2013, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,46 +30,76 @@</span>
   */
  
  package sun.security.krb5.internal;
  
  import sun.security.krb5.*;
<span class="udiff-line-added">+ import sun.security.util.DerValue;</span>
<span class="udiff-line-added">+ </span>
  import java.io.IOException;
<span class="udiff-line-added">+ import java.util.LinkedList;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
  
  /**
   * This class is a utility that contains much of the TGS-Exchange
   * protocol. It is used by ../Credentials.java for service ticket
   * acquisition in both the normal and the x-realm case.
   */
  public class CredentialsUtil {
  
      private static boolean DEBUG = sun.security.krb5.internal.Krb5.DEBUG;
  
<span class="udiff-line-added">+     private static enum S4U2Type {</span>
<span class="udiff-line-added">+         NONE, SELF, PROXY</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Used by a middle server to acquire credentials on behalf of a
       * client to itself using the S4U2self extension.
       * @param client the client to impersonate
       * @param ccreds the TGT of the middle service
       * @return the new creds (cname=client, sname=middle)
       */
      public static Credentials acquireS4U2selfCreds(PrincipalName client,
              Credentials ccreds) throws KrbException, IOException {
<span class="udiff-line-added">+         if (!ccreds.isForwardable()) {</span>
<span class="udiff-line-added">+             throw new KrbException(&quot;S4U2self needs a FORWARDABLE ticket&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         PrincipalName sname = ccreds.getClient();</span>
          String uRealm = client.getRealmString();
          String localRealm = ccreds.getClient().getRealmString();
          if (!uRealm.equals(localRealm)) {
<span class="udiff-line-modified-removed">-             // TODO: we do not support kerberos referral now</span>
<span class="udiff-line-modified-removed">-             throw new KrbException(&quot;Cross realm impersonation not supported&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (!ccreds.isForwardable()) {</span>
<span class="udiff-line-modified-removed">-             throw new KrbException(&quot;S4U2self needs a FORWARDABLE ticket&quot;);</span>
<span class="udiff-line-modified-added">+             // Referrals will be required because the middle service</span>
<span class="udiff-line-modified-added">+             // and the client impersonated are on different realms.</span>
<span class="udiff-line-modified-added">+             if (Config.DISABLE_REFERRALS) {</span>
<span class="udiff-line-modified-added">+                 throw new KrbException(&quot;Cross-realm S4U2Self request not&quot; +</span>
<span class="udiff-line-modified-added">+                         &quot; possible when referrals are disabled.&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (ccreds.getClientAlias() != null) {</span>
<span class="udiff-line-added">+                 // If the name was canonicalized, the user pick</span>
<span class="udiff-line-added">+                 // has preference. This gives the possibility of</span>
<span class="udiff-line-added">+                 // using FQDNs that KDCs may use to return referrals.</span>
<span class="udiff-line-added">+                 // I.e.: a SVC/host.realm-2.com@REALM-1.COM name</span>
<span class="udiff-line-added">+                 // may be used by REALM-1.COM KDC to return a</span>
<span class="udiff-line-added">+                 // referral to REALM-2.COM.</span>
<span class="udiff-line-added">+                 sname = ccreds.getClientAlias();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             sname = new PrincipalName(sname.getNameType(),</span>
<span class="udiff-line-added">+                     sname.getNameStrings(), new Realm(uRealm));</span>
          }
<span class="udiff-line-modified-removed">-         KrbTgsReq req = new KrbTgsReq(</span>
<span class="udiff-line-modified-removed">-                 ccreds,</span>
<span class="udiff-line-modified-removed">-                 ccreds.getClient(),</span>
<span class="udiff-line-modified-removed">-                 new PAData(Krb5.PA_FOR_USER,</span>
<span class="udiff-line-modified-removed">-                     new PAForUserEnc(client,</span>
<span class="udiff-line-modified-removed">-                         ccreds.getSessionKey()).asn1Encode()));</span>
<span class="udiff-line-modified-removed">-         Credentials creds = req.sendAndGetCreds();</span>
<span class="udiff-line-modified-added">+         Credentials creds = serviceCreds(</span>
<span class="udiff-line-modified-added">+                 KDCOptions.with(KDCOptions.FORWARDABLE),</span>
<span class="udiff-line-modified-added">+                 ccreds, ccreds.getClient(), sname, null,</span>
<span class="udiff-line-modified-added">+                 new PAData[] {</span>
<span class="udiff-line-modified-added">+                         new PAData(Krb5.PA_FOR_USER,</span>
<span class="udiff-line-modified-added">+                                 new PAForUserEnc(client,</span>
<span class="udiff-line-modified-added">+                                         ccreds.getSessionKey()).asn1Encode()),</span>
<span class="udiff-line-added">+                         new PAData(Krb5.PA_PAC_OPTIONS,</span>
<span class="udiff-line-added">+                                 new PaPacOptions()</span>
<span class="udiff-line-added">+                                         .setResourceBasedConstrainedDelegation(true)</span>
<span class="udiff-line-added">+                                         .setClaims(true)</span>
<span class="udiff-line-added">+                                         .asn1Encode())</span>
<span class="udiff-line-added">+                         }, S4U2Type.SELF);</span>
          if (!creds.getClient().equals(client)) {
              throw new KrbException(&quot;S4U2self request not honored by KDC&quot;);
          }
          if (!creds.isForwardable()) {
              throw new KrbException(&quot;S4U2self ticket must be FORWARDABLE&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,15 +117,35 @@</span>
       */
      public static Credentials acquireS4U2proxyCreds(
                  String backend, Ticket second,
                  PrincipalName client, Credentials ccreds)
              throws KrbException, IOException {
<span class="udiff-line-modified-removed">-         KrbTgsReq req = new KrbTgsReq(</span>
<span class="udiff-line-modified-removed">-                 ccreds,</span>
<span class="udiff-line-modified-removed">-                 second,</span>
<span class="udiff-line-modified-removed">-                 new PrincipalName(backend));</span>
<span class="udiff-line-modified-removed">-         Credentials creds = req.sendAndGetCreds();</span>
<span class="udiff-line-modified-added">+         PrincipalName backendPrincipal = new PrincipalName(backend);</span>
<span class="udiff-line-modified-added">+         String backendRealm = backendPrincipal.getRealmString();</span>
<span class="udiff-line-modified-added">+         String localRealm = ccreds.getClient().getRealmString();</span>
<span class="udiff-line-modified-added">+         if (!backendRealm.equals(localRealm)) {</span>
<span class="udiff-line-modified-added">+             // The middle service and the backend service are on</span>
<span class="udiff-line-added">+             // different realms, so referrals will be required.</span>
<span class="udiff-line-added">+             if (Config.DISABLE_REFERRALS) {</span>
<span class="udiff-line-added">+                 throw new KrbException(&quot;Cross-realm S4U2Proxy request not&quot; +</span>
<span class="udiff-line-added">+                         &quot; possible when referrals are disabled.&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             backendPrincipal = new PrincipalName(</span>
<span class="udiff-line-added">+                     backendPrincipal.getNameType(),</span>
<span class="udiff-line-added">+                     backendPrincipal.getNameStrings(),</span>
<span class="udiff-line-added">+                     new Realm(localRealm));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         Credentials creds = serviceCreds(KDCOptions.with(</span>
<span class="udiff-line-added">+                 KDCOptions.CNAME_IN_ADDL_TKT, KDCOptions.FORWARDABLE),</span>
<span class="udiff-line-added">+                 ccreds, ccreds.getClient(), backendPrincipal,</span>
<span class="udiff-line-added">+                 new Ticket[] {second}, new PAData[] {</span>
<span class="udiff-line-added">+                         new PAData(Krb5.PA_PAC_OPTIONS,</span>
<span class="udiff-line-added">+                                 new PaPacOptions()</span>
<span class="udiff-line-added">+                                         .setResourceBasedConstrainedDelegation(true)</span>
<span class="udiff-line-added">+                                         .setClaims(true)</span>
<span class="udiff-line-added">+                                         .asn1Encode())</span>
<span class="udiff-line-added">+                         }, S4U2Type.PROXY);</span>
          if (!creds.getClient().equals(client)) {
              throw new KrbException(&quot;S4U2proxy request not honored by KDC&quot;);
          }
          return creds;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,57 +162,13 @@</span>
       * @param ccreds client&#39;s initial credential
       */
      public static Credentials acquireServiceCreds(
                  String service, Credentials ccreds)
              throws KrbException, IOException {
<span class="udiff-line-modified-removed">-         PrincipalName sname = new PrincipalName(service);</span>
<span class="udiff-line-modified-removed">-         String serviceRealm = sname.getRealmString();</span>
<span class="udiff-line-modified-removed">-         String localRealm = ccreds.getClient().getRealmString();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (localRealm.equals(serviceRealm)) {</span>
<span class="udiff-line-removed">-             if (DEBUG) {</span>
<span class="udiff-line-removed">-                 System.out.println(</span>
<span class="udiff-line-removed">-                         &quot;&gt;&gt;&gt; Credentials acquireServiceCreds: same realm&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return serviceCreds(sname, ccreds);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         Credentials theCreds = null;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         boolean[] okAsDelegate = new boolean[1];</span>
<span class="udiff-line-removed">-         Credentials theTgt = getTGTforRealm(localRealm, serviceRealm,</span>
<span class="udiff-line-removed">-                 ccreds, okAsDelegate);</span>
<span class="udiff-line-removed">-         if (theTgt != null) {</span>
<span class="udiff-line-removed">-             if (DEBUG) {</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="udiff-line-removed">-                         + &quot;got right tgt&quot;);</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="udiff-line-removed">-                         + &quot;obtaining service creds for &quot; + sname);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             try {</span>
<span class="udiff-line-removed">-                 theCreds = serviceCreds(sname, theTgt);</span>
<span class="udiff-line-removed">-             } catch (Exception exc) {</span>
<span class="udiff-line-removed">-                 if (DEBUG) {</span>
<span class="udiff-line-removed">-                     System.out.println(exc);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 theCreds = null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (theCreds != null) {</span>
<span class="udiff-line-removed">-             if (DEBUG) {</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="udiff-line-removed">-                         + &quot;returning creds:&quot;);</span>
<span class="udiff-line-removed">-                 Credentials.printDebug(theCreds);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (!okAsDelegate[0]) {</span>
<span class="udiff-line-removed">-                 theCreds.resetDelegate();</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return theCreds;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         throw new KrbApErrException(Krb5.KRB_AP_ERR_GEN_CRED,</span>
<span class="udiff-line-removed">-                                     &quot;No service creds&quot;);</span>
<span class="udiff-line-modified-added">+         PrincipalName sname = new PrincipalName(service,</span>
<span class="udiff-line-modified-added">+                 PrincipalName.KRB_NT_SRV_HST);</span>
<span class="udiff-line-modified-added">+         return serviceCreds(sname, ccreds);</span>
      }
  
      /**
       * Gets a TGT to another realm
       * @param localRealm this realm
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -303,8 +309,261 @@</span>
      * This method does the real job to request the service credential.
      */
      private static Credentials serviceCreds(
              PrincipalName service, Credentials ccreds)
              throws KrbException, IOException {
<span class="udiff-line-modified-removed">-         return new KrbTgsReq(ccreds, service).sendAndGetCreds();</span>
<span class="udiff-line-modified-added">+         return serviceCreds(new KDCOptions(), ccreds,</span>
<span class="udiff-line-added">+                 ccreds.getClient(), service, null, null,</span>
<span class="udiff-line-added">+                 S4U2Type.NONE);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Obtains credentials for a service (TGS).</span>
<span class="udiff-line-added">+      * Cross-realm referrals are handled if enabled. A fallback scheme</span>
<span class="udiff-line-added">+      * without cross-realm referrals supports is used in case of server</span>
<span class="udiff-line-added">+      * error to maintain backward compatibility.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static Credentials serviceCreds(</span>
<span class="udiff-line-added">+             KDCOptions options, Credentials asCreds,</span>
<span class="udiff-line-added">+             PrincipalName cname, PrincipalName sname,</span>
<span class="udiff-line-added">+             Ticket[] additionalTickets, PAData[] extraPAs,</span>
<span class="udiff-line-added">+             S4U2Type s4u2Type)</span>
<span class="udiff-line-added">+             throws KrbException, IOException {</span>
<span class="udiff-line-added">+         if (!Config.DISABLE_REFERRALS) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 return serviceCredsReferrals(options, asCreds, cname, sname,</span>
<span class="udiff-line-added">+                         s4u2Type, additionalTickets, extraPAs);</span>
<span class="udiff-line-added">+             } catch (KrbException e) {</span>
<span class="udiff-line-added">+                 // Server may raise an error if CANONICALIZE is true.</span>
<span class="udiff-line-added">+                 // Try CANONICALIZE false.</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return serviceCredsSingle(options, asCreds, cname,</span>
<span class="udiff-line-added">+                 asCreds.getClientAlias(), sname, sname, s4u2Type,</span>
<span class="udiff-line-added">+                 additionalTickets, extraPAs);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Obtains credentials for a service (TGS).</span>
<span class="udiff-line-added">+      * May handle and follow cross-realm referrals as defined by RFC 6806.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static Credentials serviceCredsReferrals(</span>
<span class="udiff-line-added">+             KDCOptions options, Credentials asCreds,</span>
<span class="udiff-line-added">+             PrincipalName cname, PrincipalName sname,</span>
<span class="udiff-line-added">+             S4U2Type s4u2Type, Ticket[] additionalTickets,</span>
<span class="udiff-line-added">+             PAData[] extraPAs)</span>
<span class="udiff-line-added">+                     throws KrbException, IOException {</span>
<span class="udiff-line-added">+         options = new KDCOptions(options.toBooleanArray());</span>
<span class="udiff-line-added">+         options.set(KDCOptions.CANONICALIZE, true);</span>
<span class="udiff-line-added">+         PrincipalName cSname = sname;</span>
<span class="udiff-line-added">+         PrincipalName refSname = sname; // May change with referrals</span>
<span class="udiff-line-added">+         Credentials creds = null;</span>
<span class="udiff-line-added">+         boolean isReferral = false;</span>
<span class="udiff-line-added">+         List&lt;String&gt; referrals = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-added">+         PrincipalName clientAlias = asCreds.getClientAlias();</span>
<span class="udiff-line-added">+         while (referrals.size() &lt;= Config.MAX_REFERRALS) {</span>
<span class="udiff-line-added">+             ReferralsCache.ReferralCacheEntry ref =</span>
<span class="udiff-line-added">+                     ReferralsCache.get(cname, sname, refSname.getRealmString());</span>
<span class="udiff-line-added">+             String toRealm = null;</span>
<span class="udiff-line-added">+             if (ref == null) {</span>
<span class="udiff-line-added">+                 creds = serviceCredsSingle(options, asCreds, cname,</span>
<span class="udiff-line-added">+                         clientAlias, refSname, cSname, s4u2Type,</span>
<span class="udiff-line-added">+                         additionalTickets, extraPAs);</span>
<span class="udiff-line-added">+                 PrincipalName server = creds.getServer();</span>
<span class="udiff-line-added">+                 if (!refSname.equals(server)) {</span>
<span class="udiff-line-added">+                     String[] serverNameStrings = server.getNameStrings();</span>
<span class="udiff-line-added">+                     if (serverNameStrings.length == 2 &amp;&amp;</span>
<span class="udiff-line-added">+                         serverNameStrings[0].equals(</span>
<span class="udiff-line-added">+                                 PrincipalName.TGS_DEFAULT_SRV_NAME) &amp;&amp;</span>
<span class="udiff-line-added">+                         !refSname.getRealmAsString().equals(</span>
<span class="udiff-line-added">+                                 serverNameStrings[1])) {</span>
<span class="udiff-line-added">+                         // Server Name (sname) has the following format:</span>
<span class="udiff-line-added">+                         //      krbtgt/TO-REALM.COM@FROM-REALM.COM</span>
<span class="udiff-line-added">+                         if (s4u2Type == S4U2Type.NONE) {</span>
<span class="udiff-line-added">+                             // Do not store S4U2Self or S4U2Proxy referral</span>
<span class="udiff-line-added">+                             // TGTs in the cache. Caching such tickets is not</span>
<span class="udiff-line-added">+                             // defined in MS-SFU and may cause unexpected</span>
<span class="udiff-line-added">+                             // results when using them in a different context.</span>
<span class="udiff-line-added">+                             ReferralsCache.put(cname, sname,</span>
<span class="udiff-line-added">+                                     server.getRealmString(),</span>
<span class="udiff-line-added">+                                     serverNameStrings[1], creds);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         toRealm = serverNameStrings[1];</span>
<span class="udiff-line-added">+                         isReferral = true;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 creds = ref.getCreds();</span>
<span class="udiff-line-added">+                 toRealm = ref.getToRealm();</span>
<span class="udiff-line-added">+                 isReferral = true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (isReferral) {</span>
<span class="udiff-line-added">+                 if (s4u2Type == S4U2Type.PROXY) {</span>
<span class="udiff-line-added">+                     Credentials[] credsInOut =</span>
<span class="udiff-line-added">+                             new Credentials[] {creds, null};</span>
<span class="udiff-line-added">+                     toRealm = handleS4U2ProxyReferral(asCreds,</span>
<span class="udiff-line-added">+                             credsInOut, sname);</span>
<span class="udiff-line-added">+                     creds = credsInOut[0];</span>
<span class="udiff-line-added">+                     if (additionalTickets == null ||</span>
<span class="udiff-line-added">+                             additionalTickets.length == 0 ||</span>
<span class="udiff-line-added">+                             credsInOut[1] == null) {</span>
<span class="udiff-line-added">+                         throw new KrbException(&quot;Additional tickets expected&quot; +</span>
<span class="udiff-line-added">+                                 &quot; for S4U2Proxy.&quot;);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     additionalTickets[0] = credsInOut[1].getTicket();</span>
<span class="udiff-line-added">+                 } else if (s4u2Type == S4U2Type.SELF) {</span>
<span class="udiff-line-added">+                     handleS4U2SelfReferral(extraPAs, asCreds, creds);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (referrals.contains(toRealm)) {</span>
<span class="udiff-line-added">+                     // Referrals loop detected</span>
<span class="udiff-line-added">+                     return null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 asCreds = creds;</span>
<span class="udiff-line-added">+                 refSname = new PrincipalName(refSname.getNameString(),</span>
<span class="udiff-line-added">+                         refSname.getNameType(), toRealm);</span>
<span class="udiff-line-added">+                 referrals.add(toRealm);</span>
<span class="udiff-line-added">+                 isReferral = false;</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return creds;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Obtains credentials for a service (TGS).</span>
<span class="udiff-line-added">+      * If the service realm is different than the one in the TGT, a new TGT for</span>
<span class="udiff-line-added">+      * the service realm is obtained first (see getTGTforRealm call). This is</span>
<span class="udiff-line-added">+      * not expected when following cross-realm referrals because the referral</span>
<span class="udiff-line-added">+      * TGT realm matches the service realm.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static Credentials serviceCredsSingle(</span>
<span class="udiff-line-added">+             KDCOptions options, Credentials asCreds,</span>
<span class="udiff-line-added">+             PrincipalName cname, PrincipalName clientAlias,</span>
<span class="udiff-line-added">+             PrincipalName refSname, PrincipalName sname,</span>
<span class="udiff-line-added">+             S4U2Type s4u2Type, Ticket[] additionalTickets,</span>
<span class="udiff-line-added">+             PAData[] extraPAs)</span>
<span class="udiff-line-added">+                     throws KrbException, IOException {</span>
<span class="udiff-line-added">+         Credentials theCreds = null;</span>
<span class="udiff-line-added">+         boolean[] okAsDelegate = new boolean[]{true};</span>
<span class="udiff-line-added">+         String[] serverAsCredsNames = asCreds.getServer().getNameStrings();</span>
<span class="udiff-line-added">+         String tgtRealm = serverAsCredsNames[1];</span>
<span class="udiff-line-added">+         String serviceRealm = refSname.getRealmString();</span>
<span class="udiff-line-added">+         if (!serviceRealm.equals(tgtRealm)) {</span>
<span class="udiff-line-added">+             // This is a cross-realm service request</span>
<span class="udiff-line-added">+             if (DEBUG) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;&gt;&gt;&gt; serviceCredsSingle:&quot; +</span>
<span class="udiff-line-added">+                         &quot; cross-realm authentication&quot;);</span>
<span class="udiff-line-added">+                 System.out.println(&quot;&gt;&gt;&gt; serviceCredsSingle:&quot; +</span>
<span class="udiff-line-added">+                         &quot; obtaining credentials from &quot; + tgtRealm +</span>
<span class="udiff-line-added">+                         &quot; to &quot; + serviceRealm);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Credentials newTgt = getTGTforRealm(tgtRealm, serviceRealm,</span>
<span class="udiff-line-added">+                     asCreds, okAsDelegate);</span>
<span class="udiff-line-added">+             if (newTgt == null) {</span>
<span class="udiff-line-added">+                 throw new KrbApErrException(Krb5.KRB_AP_ERR_GEN_CRED,</span>
<span class="udiff-line-added">+                         &quot;No service creds&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (DEBUG) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;&gt;&gt;&gt; Cross-realm TGT Credentials&quot; +</span>
<span class="udiff-line-added">+                         &quot; serviceCredsSingle: &quot;);</span>
<span class="udiff-line-added">+                 Credentials.printDebug(newTgt);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (s4u2Type == S4U2Type.SELF) {</span>
<span class="udiff-line-added">+                 handleS4U2SelfReferral(extraPAs, asCreds, newTgt);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             asCreds = newTgt;</span>
<span class="udiff-line-added">+             cname = asCreds.getClient();</span>
<span class="udiff-line-added">+         } else if (DEBUG) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;&gt;&gt;&gt; Credentials serviceCredsSingle:&quot; +</span>
<span class="udiff-line-added">+                     &quot; same realm&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         KrbTgsReq req = new KrbTgsReq(options, asCreds, cname, clientAlias,</span>
<span class="udiff-line-added">+                 refSname, sname, additionalTickets, extraPAs);</span>
<span class="udiff-line-added">+         theCreds = req.sendAndGetCreds();</span>
<span class="udiff-line-added">+         if (theCreds != null) {</span>
<span class="udiff-line-added">+             if (DEBUG) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;&gt;&gt;&gt; TGS credentials serviceCredsSingle:&quot;);</span>
<span class="udiff-line-added">+                 Credentials.printDebug(theCreds);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!okAsDelegate[0]) {</span>
<span class="udiff-line-added">+                 theCreds.resetDelegate();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return theCreds;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * PA-FOR-USER may need to be regenerated if credentials</span>
<span class="udiff-line-added">+      * change. This may happen when obtaining a TGT for a</span>
<span class="udiff-line-added">+      * different realm or when using a referral TGT.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static void handleS4U2SelfReferral(PAData[] pas,</span>
<span class="udiff-line-added">+             Credentials oldCeds, Credentials newCreds)</span>
<span class="udiff-line-added">+                     throws Asn1Exception, KrbException, IOException {</span>
<span class="udiff-line-added">+         if (DEBUG) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;&gt;&gt;&gt; Handling S4U2Self referral&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; pas.length; i++) {</span>
<span class="udiff-line-added">+             PAData pa = pas[i];</span>
<span class="udiff-line-added">+             if (pa.getType() == Krb5.PA_FOR_USER) {</span>
<span class="udiff-line-added">+                 PAForUserEnc paForUser = new PAForUserEnc(</span>
<span class="udiff-line-added">+                         new DerValue(pa.getValue()),</span>
<span class="udiff-line-added">+                         oldCeds.getSessionKey());</span>
<span class="udiff-line-added">+                 pas[i] = new PAData(Krb5.PA_FOR_USER,</span>
<span class="udiff-line-added">+                         new PAForUserEnc(paForUser.getName(),</span>
<span class="udiff-line-added">+                                 newCreds.getSessionKey()).asn1Encode());</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * This method is called after receiving the first realm referral for</span>
<span class="udiff-line-added">+      * a S4U2Proxy request. The credentials and tickets needed for the</span>
<span class="udiff-line-added">+      * final S4U2Proxy request (in the referrals chain) are returned.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * Referrals are handled as described by MS-SFU (section 3.1.5.2.2</span>
<span class="udiff-line-added">+      * Receives Referral).</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param asCreds middle service credentials used for the first S4U2Proxy</span>
<span class="udiff-line-added">+      *        request</span>
<span class="udiff-line-added">+      * @param credsInOut (in/out parameter):</span>
<span class="udiff-line-added">+      *         * input: first S4U2Proxy referral TGT received, null</span>
<span class="udiff-line-added">+      *         * output: referral TGT for final S4U2Proxy service request,</span>
<span class="udiff-line-added">+      *                   client referral TGT for final S4U2Proxy service request</span>
<span class="udiff-line-added">+      *                   (to be sent as additional-ticket)</span>
<span class="udiff-line-added">+      * @param sname the backend service name</span>
<span class="udiff-line-added">+      * @param additionalTickets (out parameter): the additional ticket for the</span>
<span class="udiff-line-added">+      *        last S4U2Proxy request is returned</span>
<span class="udiff-line-added">+      * @return the backend realm for the last S4U2Proxy request</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static String handleS4U2ProxyReferral(Credentials asCreds,</span>
<span class="udiff-line-added">+             Credentials[] credsInOut, PrincipalName sname)</span>
<span class="udiff-line-added">+                     throws KrbException, IOException {</span>
<span class="udiff-line-added">+         if (DEBUG) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;&gt;&gt;&gt; Handling S4U2Proxy referral&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         Credentials refTGT = null;</span>
<span class="udiff-line-added">+         // Get a credential for the middle service to the backend so we know</span>
<span class="udiff-line-added">+         // the backend realm, as described in MS-SFU (section 3.1.5.2.2).</span>
<span class="udiff-line-added">+         Credentials middleSvcCredsInBackendRealm =</span>
<span class="udiff-line-added">+                 serviceCreds(sname, asCreds);</span>
<span class="udiff-line-added">+         String backendRealm =</span>
<span class="udiff-line-added">+                 middleSvcCredsInBackendRealm.getServer().getRealmString();</span>
<span class="udiff-line-added">+         String toRealm = credsInOut[0].getServer().getNameStrings()[1];</span>
<span class="udiff-line-added">+         if (!toRealm.equals(backendRealm)) {</span>
<span class="udiff-line-added">+             // More than 1 hop. Follow the referrals chain and obtain a</span>
<span class="udiff-line-added">+             // TGT for the backend realm.</span>
<span class="udiff-line-added">+             refTGT = getTGTforRealm(toRealm, backendRealm, credsInOut[0],</span>
<span class="udiff-line-added">+                     new boolean[1]);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             // There was only 1 hop. The referral TGT received is already</span>
<span class="udiff-line-added">+             // for the backend realm.</span>
<span class="udiff-line-added">+             refTGT = credsInOut[0];</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         credsInOut[0] = getTGTforRealm(asCreds.getClient().getRealmString(),</span>
<span class="udiff-line-added">+                 backendRealm, asCreds, new boolean[1]);</span>
<span class="udiff-line-added">+         credsInOut[1] = refTGT;</span>
<span class="udiff-line-added">+         return backendRealm;</span>
      }
  }
</pre>
<center><a href="../Realm.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ETypeInfo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>