<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/KrbAsReqBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbAsReq.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbCred.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbAsReqBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 51  *    a. Name of KDCs for a realm
 52  *    b. Server availability, timeout, UDP or TCP
 53  *    d. KRB_ERR_RESPONSE_TOO_BIG
 54  * 2. Stores its own copy of password, this means:
 55  *    a. Do not change/wipe it before Builder finish
 56  *    b. Builder will not wipe it for you
 57  *
 58  * With this class:
 59  * 1. KrbAsReq has only one constructor
 60  * 2. Krb5LoginModule and Kinit call a single builder
 61  * 3. Better handling of sensitive info
 62  *
 63  * @since 1.7
 64  */
 65 
 66 public final class KrbAsReqBuilder {
 67 
 68     // Common data for AS-REQ fields
 69     private KDCOptions options;
 70     private PrincipalName cname;

 71     private PrincipalName sname;
 72     private KerberosTime from;
 73     private KerberosTime till;
 74     private KerberosTime rtime;
 75     private HostAddresses addresses;
 76 
 77     // Secret source: can&#39;t be changed once assigned, only one (of the two
 78     // sources) can be set to non-null
 79     private final char[] password;
 80     private final KeyTab ktab;
 81 
 82     // Used to create a ENC-TIMESTAMP in the 2nd AS-REQ
 83     private PAData[] paList;        // PA-DATA from both KRB-ERROR and AS-REP.
 84                                     // Used by getKeys() only.
 85                                     // Only AS-REP should be enough per RFC,
 86                                     // combined in case etypes are different.
 87 
 88     // The generated and received:
 89     private KrbAsReq req;
 90     private KrbAsRep rep;
 91 
 92     private static enum State {
 93         INIT,       // Initialized, can still add more initialization info
 94         REQ_OK,     // AS-REQ performed
 95         DESTROYED,  // Destroyed, not usable anymore
 96     }
 97     private State state;
 98 
 99     // Called by other constructors
100     private void init(PrincipalName cname)
101             throws KrbException {
102         this.cname = cname;

103         state = State.INIT;
104     }
105 
106     /**
107      * Creates a builder to be used by {@code cname} with existing keys.
108      *
109      * @param cname the client of the AS-REQ. Must not be null. Might have no
110      * realm, where default realm will be used. This realm will be the target
111      * realm for AS-REQ. I believe a client should only get initial TGT from
112      * its own realm.
113      * @param ktab must not be null. If empty, might be quite useless.
114      * This argument will neither be modified nor stored by the method.
115      * @throws KrbException
116      */
117     public KrbAsReqBuilder(PrincipalName cname, KeyTab ktab)
118             throws KrbException {
119         init(cname);
120         this.ktab = ktab;
121         this.password = null;
122     }
</pre>
<hr />
<pre>
245     }
246 
247     /**
248      * Adds or clears addresses. KrbAsReq might add some if empty
249      * field not allowed
250      * @param addresses
251      */
252     public void setAddresses(HostAddresses addresses) {
253         checkState(State.INIT, &quot;Cannot specify addresses&quot;);
254         this.addresses = addresses;
255     }
256 
257     /**
258      * Build a KrbAsReq object from all info fed above. Normally this method
259      * will be called twice: initial AS-REQ and second with pakey
260      * @param key null (initial AS-REQ) or pakey (with preauth)
261      * @return the KrbAsReq object
262      * @throws KrbException
263      * @throws IOException
264      */
<span class="line-modified">265     private KrbAsReq build(EncryptionKey key) throws KrbException, IOException {</span>


266         int[] eTypes;
267         if (password != null) {
268             eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;);
269         } else {
270             EncryptionKey[] ks = Krb5Util.keysFromJavaxKeyTab(ktab, cname);
271             eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;,
272                     ks);
273             for (EncryptionKey k: ks) k.destroy();
274         }








275         return new KrbAsReq(key,
276             options,
<span class="line-modified">277             cname,</span>
278             sname,
279             from,
280             till,
281             rtime,
282             eTypes,
<span class="line-modified">283             addresses);</span>

284     }
285 
286     /**
287      * Parses AS-REP, decrypts enc-part, retrieves ticket and session key
288      * @throws KrbException
289      * @throws Asn1Exception
290      * @throws IOException
291      */
292     private KrbAsReqBuilder resolve()
293             throws KrbException, Asn1Exception, IOException {
294         if (ktab != null) {
295             rep.decryptUsingKeyTab(ktab, req, cname);
296         } else {
297             rep.decryptUsingPassword(password, req, cname);
298         }
299         if (rep.getPA() != null) {
300             if (paList == null || paList.length == 0) {
301                 paList = rep.getPA();
302             } else {
303                 int extraLen = rep.getPA().length;
304                 if (extraLen &gt; 0) {
305                     int oldLen = paList.length;
306                     paList = Arrays.copyOf(paList, paList.length + extraLen);
307                     System.arraycopy(rep.getPA(), 0, paList, oldLen, extraLen);
308                 }
309             }
310         }
311         return this;
312     }
313 
314     /**
315      * Communication until AS-REP or non preauth-related KRB-ERROR received
316      * @throws KrbException
317      * @throws IOException
318      */
319     private KrbAsReqBuilder send() throws KrbException, IOException {
320         boolean preAuthFailedOnce = false;
<span class="line-modified">321         KdcComm comm = new KdcComm(cname.getRealmAsString());</span>
322         EncryptionKey pakey = null;

323         while (true) {



324             try {
<span class="line-modified">325                 req = build(pakey);</span>
326                 rep = new KrbAsRep(comm.send(req.encoding()));
327                 return this;
328             } catch (KrbException ke) {
329                 if (!preAuthFailedOnce &amp;&amp; (
330                         ke.returnCode() == Krb5.KDC_ERR_PREAUTH_FAILED ||
331                         ke.returnCode() == Krb5.KDC_ERR_PREAUTH_REQUIRED)) {
332                     if (Krb5.DEBUG) {
333                         System.out.println(&quot;KrbAsReqBuilder: &quot; +
334                                 &quot;PREAUTH FAILED/REQ, re-send AS-REQ&quot;);
335                     }
336                     preAuthFailedOnce = true;
337                     KRBError kerr = ke.getError();
338                     int paEType = PAData.getPreferredEType(kerr.getPA(),
339                             EType.getDefaults(&quot;default_tkt_enctypes&quot;)[0]);
340                     if (password == null) {
341                         EncryptionKey[] ks = Krb5Util.keysFromJavaxKeyTab(ktab, cname);
342                         pakey = EncryptionKey.findKey(paEType, ks);
343                         if (pakey != null) pakey = (EncryptionKey)pakey.clone();
344                         for (EncryptionKey k: ks) k.destroy();
345                     } else {
346                         pakey = EncryptionKey.acquireSecretKey(cname,
347                                 password,
348                                 paEType,
349                                 PAData.getSaltAndParams(
350                                     paEType, kerr.getPA()));
351                     }
352                     paList = kerr.getPA();  // Update current paList
353                 } else {





354                     throw ke;
355                 }
356             }
357         }
358     }
359 






















































360     /**
361      * Performs AS-REQ send and AS-REP receive.
362      * Maybe a state is needed here, to divide prepare process and getCreds.
363      * @throws KrbException
364      * @throws Asn1Exception
365      * @throws IOException
366      */
367     public KrbAsReqBuilder action()
368             throws KrbException, Asn1Exception, IOException {
369         checkState(State.INIT, &quot;Cannot call action&quot;);
370         state = State.REQ_OK;
371         return send().resolve();
372     }
373 
374     /**
375      * Gets Credentials object after action
376      */
377     public Credentials getCreds() {
378         checkState(State.REQ_OK, &quot;Cannot retrieve creds&quot;);
379         return rep.getCreds();
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 51  *    a. Name of KDCs for a realm
 52  *    b. Server availability, timeout, UDP or TCP
 53  *    d. KRB_ERR_RESPONSE_TOO_BIG
 54  * 2. Stores its own copy of password, this means:
 55  *    a. Do not change/wipe it before Builder finish
 56  *    b. Builder will not wipe it for you
 57  *
 58  * With this class:
 59  * 1. KrbAsReq has only one constructor
 60  * 2. Krb5LoginModule and Kinit call a single builder
 61  * 3. Better handling of sensitive info
 62  *
 63  * @since 1.7
 64  */
 65 
 66 public final class KrbAsReqBuilder {
 67 
 68     // Common data for AS-REQ fields
 69     private KDCOptions options;
 70     private PrincipalName cname;
<span class="line-added"> 71     private PrincipalName refCname; // May be changed by referrals</span>
 72     private PrincipalName sname;
 73     private KerberosTime from;
 74     private KerberosTime till;
 75     private KerberosTime rtime;
 76     private HostAddresses addresses;
 77 
 78     // Secret source: can&#39;t be changed once assigned, only one (of the two
 79     // sources) can be set to non-null
 80     private final char[] password;
 81     private final KeyTab ktab;
 82 
 83     // Used to create a ENC-TIMESTAMP in the 2nd AS-REQ
 84     private PAData[] paList;        // PA-DATA from both KRB-ERROR and AS-REP.
 85                                     // Used by getKeys() only.
 86                                     // Only AS-REP should be enough per RFC,
 87                                     // combined in case etypes are different.
 88 
 89     // The generated and received:
 90     private KrbAsReq req;
 91     private KrbAsRep rep;
 92 
 93     private static enum State {
 94         INIT,       // Initialized, can still add more initialization info
 95         REQ_OK,     // AS-REQ performed
 96         DESTROYED,  // Destroyed, not usable anymore
 97     }
 98     private State state;
 99 
100     // Called by other constructors
101     private void init(PrincipalName cname)
102             throws KrbException {
103         this.cname = cname;
<span class="line-added">104         this.refCname = cname;</span>
105         state = State.INIT;
106     }
107 
108     /**
109      * Creates a builder to be used by {@code cname} with existing keys.
110      *
111      * @param cname the client of the AS-REQ. Must not be null. Might have no
112      * realm, where default realm will be used. This realm will be the target
113      * realm for AS-REQ. I believe a client should only get initial TGT from
114      * its own realm.
115      * @param ktab must not be null. If empty, might be quite useless.
116      * This argument will neither be modified nor stored by the method.
117      * @throws KrbException
118      */
119     public KrbAsReqBuilder(PrincipalName cname, KeyTab ktab)
120             throws KrbException {
121         init(cname);
122         this.ktab = ktab;
123         this.password = null;
124     }
</pre>
<hr />
<pre>
247     }
248 
249     /**
250      * Adds or clears addresses. KrbAsReq might add some if empty
251      * field not allowed
252      * @param addresses
253      */
254     public void setAddresses(HostAddresses addresses) {
255         checkState(State.INIT, &quot;Cannot specify addresses&quot;);
256         this.addresses = addresses;
257     }
258 
259     /**
260      * Build a KrbAsReq object from all info fed above. Normally this method
261      * will be called twice: initial AS-REQ and second with pakey
262      * @param key null (initial AS-REQ) or pakey (with preauth)
263      * @return the KrbAsReq object
264      * @throws KrbException
265      * @throws IOException
266      */
<span class="line-modified">267     private KrbAsReq build(EncryptionKey key, ReferralsState referralsState)</span>
<span class="line-added">268             throws KrbException, IOException {</span>
<span class="line-added">269         PAData[] extraPAs = null;</span>
270         int[] eTypes;
271         if (password != null) {
272             eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;);
273         } else {
274             EncryptionKey[] ks = Krb5Util.keysFromJavaxKeyTab(ktab, cname);
275             eTypes = EType.getDefaults(&quot;default_tkt_enctypes&quot;,
276                     ks);
277             for (EncryptionKey k: ks) k.destroy();
278         }
<span class="line-added">279         options = (options == null) ? new KDCOptions() : options;</span>
<span class="line-added">280         if (referralsState.isEnabled()) {</span>
<span class="line-added">281             options.set(KDCOptions.CANONICALIZE, true);</span>
<span class="line-added">282             extraPAs = new PAData[]{ new PAData(Krb5.PA_REQ_ENC_PA_REP,</span>
<span class="line-added">283                     new byte[]{}) };</span>
<span class="line-added">284         } else {</span>
<span class="line-added">285             options.set(KDCOptions.CANONICALIZE, false);</span>
<span class="line-added">286         }</span>
287         return new KrbAsReq(key,
288             options,
<span class="line-modified">289             refCname,</span>
290             sname,
291             from,
292             till,
293             rtime,
294             eTypes,
<span class="line-modified">295             addresses,</span>
<span class="line-added">296             extraPAs);</span>
297     }
298 
299     /**
300      * Parses AS-REP, decrypts enc-part, retrieves ticket and session key
301      * @throws KrbException
302      * @throws Asn1Exception
303      * @throws IOException
304      */
305     private KrbAsReqBuilder resolve()
306             throws KrbException, Asn1Exception, IOException {
307         if (ktab != null) {
308             rep.decryptUsingKeyTab(ktab, req, cname);
309         } else {
310             rep.decryptUsingPassword(password, req, cname);
311         }
312         if (rep.getPA() != null) {
313             if (paList == null || paList.length == 0) {
314                 paList = rep.getPA();
315             } else {
316                 int extraLen = rep.getPA().length;
317                 if (extraLen &gt; 0) {
318                     int oldLen = paList.length;
319                     paList = Arrays.copyOf(paList, paList.length + extraLen);
320                     System.arraycopy(rep.getPA(), 0, paList, oldLen, extraLen);
321                 }
322             }
323         }
324         return this;
325     }
326 
327     /**
328      * Communication until AS-REP or non preauth-related KRB-ERROR received
329      * @throws KrbException
330      * @throws IOException
331      */
332     private KrbAsReqBuilder send() throws KrbException, IOException {
333         boolean preAuthFailedOnce = false;
<span class="line-modified">334         KdcComm comm = null;</span>
335         EncryptionKey pakey = null;
<span class="line-added">336         ReferralsState referralsState = new ReferralsState();</span>
337         while (true) {
<span class="line-added">338             if (referralsState.refreshComm()) {</span>
<span class="line-added">339                 comm = new KdcComm(refCname.getRealmAsString());</span>
<span class="line-added">340             }</span>
341             try {
<span class="line-modified">342                 req = build(pakey, referralsState);</span>
343                 rep = new KrbAsRep(comm.send(req.encoding()));
344                 return this;
345             } catch (KrbException ke) {
346                 if (!preAuthFailedOnce &amp;&amp; (
347                         ke.returnCode() == Krb5.KDC_ERR_PREAUTH_FAILED ||
348                         ke.returnCode() == Krb5.KDC_ERR_PREAUTH_REQUIRED)) {
349                     if (Krb5.DEBUG) {
350                         System.out.println(&quot;KrbAsReqBuilder: &quot; +
351                                 &quot;PREAUTH FAILED/REQ, re-send AS-REQ&quot;);
352                     }
353                     preAuthFailedOnce = true;
354                     KRBError kerr = ke.getError();
355                     int paEType = PAData.getPreferredEType(kerr.getPA(),
356                             EType.getDefaults(&quot;default_tkt_enctypes&quot;)[0]);
357                     if (password == null) {
358                         EncryptionKey[] ks = Krb5Util.keysFromJavaxKeyTab(ktab, cname);
359                         pakey = EncryptionKey.findKey(paEType, ks);
360                         if (pakey != null) pakey = (EncryptionKey)pakey.clone();
361                         for (EncryptionKey k: ks) k.destroy();
362                     } else {
363                         pakey = EncryptionKey.acquireSecretKey(cname,
364                                 password,
365                                 paEType,
366                                 PAData.getSaltAndParams(
367                                     paEType, kerr.getPA()));
368                     }
369                     paList = kerr.getPA();  // Update current paList
370                 } else {
<span class="line-added">371                     if (referralsState.handleError(ke)) {</span>
<span class="line-added">372                         pakey = null;</span>
<span class="line-added">373                         preAuthFailedOnce = false;</span>
<span class="line-added">374                         continue;</span>
<span class="line-added">375                     }</span>
376                     throw ke;
377                 }
378             }
379         }
380     }
381 
<span class="line-added">382     private final class ReferralsState {</span>
<span class="line-added">383         private boolean enabled;</span>
<span class="line-added">384         private int count;</span>
<span class="line-added">385         private boolean refreshComm;</span>
<span class="line-added">386 </span>
<span class="line-added">387         ReferralsState() throws KrbException {</span>
<span class="line-added">388             if (Config.DISABLE_REFERRALS) {</span>
<span class="line-added">389                 if (refCname.getNameType() == PrincipalName.KRB_NT_ENTERPRISE) {</span>
<span class="line-added">390                     throw new KrbException(&quot;NT-ENTERPRISE principals only allowed&quot; +</span>
<span class="line-added">391                             &quot; when referrals are enabled.&quot;);</span>
<span class="line-added">392                 }</span>
<span class="line-added">393                 enabled = false;</span>
<span class="line-added">394             } else {</span>
<span class="line-added">395                 enabled = true;</span>
<span class="line-added">396             }</span>
<span class="line-added">397             refreshComm = true;</span>
<span class="line-added">398         }</span>
<span class="line-added">399 </span>
<span class="line-added">400         boolean handleError(KrbException ke) throws RealmException {</span>
<span class="line-added">401             if (enabled) {</span>
<span class="line-added">402                 if (ke.returnCode() == Krb5.KRB_ERR_WRONG_REALM) {</span>
<span class="line-added">403                     Realm referredRealm = ke.getError().getClientRealm();</span>
<span class="line-added">404                     if (req.getMessage().reqBody.kdcOptions.get(KDCOptions.CANONICALIZE) &amp;&amp;</span>
<span class="line-added">405                             referredRealm != null &amp;&amp; referredRealm.toString().length() &gt; 0 &amp;&amp;</span>
<span class="line-added">406                             count &lt; Config.MAX_REFERRALS) {</span>
<span class="line-added">407                         refCname = new PrincipalName(refCname.getNameType(),</span>
<span class="line-added">408                                 refCname.getNameStrings(), referredRealm);</span>
<span class="line-added">409                         refreshComm = true;</span>
<span class="line-added">410                         count++;</span>
<span class="line-added">411                         return true;</span>
<span class="line-added">412                     }</span>
<span class="line-added">413                 }</span>
<span class="line-added">414                 if (count &lt; Config.MAX_REFERRALS &amp;&amp;</span>
<span class="line-added">415                         refCname.getNameType() != PrincipalName.KRB_NT_ENTERPRISE) {</span>
<span class="line-added">416                     // Server may raise an error if CANONICALIZE is true.</span>
<span class="line-added">417                     // Try CANONICALIZE false.</span>
<span class="line-added">418                     enabled = false;</span>
<span class="line-added">419                     return true;</span>
<span class="line-added">420                 }</span>
<span class="line-added">421             }</span>
<span class="line-added">422             return false;</span>
<span class="line-added">423         }</span>
<span class="line-added">424 </span>
<span class="line-added">425         boolean refreshComm() {</span>
<span class="line-added">426             boolean retRefreshComm = refreshComm;</span>
<span class="line-added">427             refreshComm = false;</span>
<span class="line-added">428             return retRefreshComm;</span>
<span class="line-added">429         }</span>
<span class="line-added">430 </span>
<span class="line-added">431         boolean isEnabled() {</span>
<span class="line-added">432             return enabled;</span>
<span class="line-added">433         }</span>
<span class="line-added">434     }</span>
<span class="line-added">435 </span>
436     /**
437      * Performs AS-REQ send and AS-REP receive.
438      * Maybe a state is needed here, to divide prepare process and getCreds.
439      * @throws KrbException
440      * @throws Asn1Exception
441      * @throws IOException
442      */
443     public KrbAsReqBuilder action()
444             throws KrbException, Asn1Exception, IOException {
445         checkState(State.INIT, &quot;Cannot call action&quot;);
446         state = State.REQ_OK;
447         return send().resolve();
448     }
449 
450     /**
451      * Gets Credentials object after action
452      */
453     public Credentials getCreds() {
454         checkState(State.REQ_OK, &quot;Cannot retrieve creds&quot;);
455         return rep.getCreds();
</pre>
</td>
</tr>
</table>
<center><a href="KrbAsReq.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbCred.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>