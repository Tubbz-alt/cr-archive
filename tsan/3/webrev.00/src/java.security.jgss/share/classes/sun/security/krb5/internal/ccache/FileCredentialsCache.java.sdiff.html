<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/internal/ccache/FileCredentialsCache.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CredentialsCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../crypto/CksumType.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/internal/ccache/FileCredentialsCache.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  * ===========================================================================
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *
 30  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 31  * ===========================================================================
 32  *
 33  */
 34 package sun.security.krb5.internal.ccache;
 35 
 36 import sun.security.action.GetPropertyAction;
 37 import sun.security.krb5.*;
 38 import sun.security.krb5.internal.*;






 39 import java.util.StringTokenizer;
 40 import java.util.Vector;
 41 import java.io.IOException;
 42 import java.io.File;
 43 import java.io.FileInputStream;
 44 import java.io.FileOutputStream;
 45 import java.io.BufferedReader;
 46 import java.io.InputStreamReader;
 47 


 48 /**
 49  * CredentialsCache stores credentials(tickets, session keys, etc) in a
 50  * semi-permanent store
 51  * for later use by different program.
 52  *
 53  * @author Yanni Zhang
 54  * @author Ram Marti
 55  */
 56 
 57 public class FileCredentialsCache extends CredentialsCache
 58     implements FileCCacheConstants {
 59     public int version;
 60     public Tag tag; // optional
 61     public PrincipalName primaryPrincipal;
 62     private Vector&lt;Credentials&gt; credentialsList;
 63     private static String dir;
 64     private static boolean DEBUG = Krb5.DEBUG;
 65 
 66     public static synchronized FileCredentialsCache acquireInstance(
 67                 PrincipalName principal, String cache) {
</pre>
<hr />
<pre>
165              CCacheInputStream cis = new CCacheInputStream(fis)) {
166             version = cis.readVersion();
167             if (version == KRB5_FCC_FVNO_4) {
168                 tag = cis.readTag();
169             } else {
170                 tag = null;
171                 if (version == KRB5_FCC_FVNO_1 || version == KRB5_FCC_FVNO_2) {
172                     cis.setNativeByteOrder();
173                 }
174             }
175             p = cis.readPrincipal(version);
176 
177             if (primaryPrincipal != null) {
178                 if (!(primaryPrincipal.match(p))) {
179                     throw new IOException(&quot;Primary principals don&#39;t match.&quot;);
180                 }
181             } else
182                 primaryPrincipal = p;
183             credentialsList = new Vector&lt;Credentials&gt;();
184             while (cis.available() &gt; 0) {
<span class="line-modified">185                 Credentials cred = cis.readCred(version);</span>
186                 if (cred != null) {
<span class="line-modified">187                     credentialsList.addElement(cred);</span>




188                 }
189             }
190         }
191     }
192 
193 
194     /**
195      * Updates the credentials list. If the specified credentials for the
196      * service is new, add it to the list. If there is an entry in the list,
197      * replace the old credentials with the new one.
198      * @param c the credentials.
199      */
200 
201     public synchronized void update(Credentials c) {
202         if (credentialsList != null) {
203             if (credentialsList.isEmpty()) {
204                 credentialsList.addElement(c);
205             } else {
206                 Credentials tmp = null;
207                 boolean matched = false;
</pre>
<hr />
<pre>
238     }
239 
240     public synchronized PrincipalName getPrimaryPrincipal() {
241         return primaryPrincipal;
242     }
243 
244 
245     /**
246      * Saves the credentials cache file to the disk.
247      */
248     public synchronized void save() throws IOException, Asn1Exception {
249         try (FileOutputStream fos = new FileOutputStream(cacheName);
250              CCacheOutputStream cos = new CCacheOutputStream(fos)) {
251             cos.writeHeader(primaryPrincipal, version);
252             Credentials[] tmp = null;
253             if ((tmp = getCredsList()) != null) {
254                 for (int i = 0; i &lt; tmp.length; i++) {
255                     cos.addCreds(tmp[i]);
256                 }
257             }



258         }
259     }
260 
261     boolean match(String[] s1, String[] s2) {
262         if (s1.length != s2.length) {
263             return false;
264         } else {
265             for (int i = 0; i &lt; s1.length; i++) {
266                 if (!(s1[i].equalsIgnoreCase(s2[i]))) {
267                     return false;
268                 }
269             }
270         }
271         return true;
272     }
273 
274     /**
275      * Returns the list of credentials entries in the cache file.
276      */
277     public synchronized Credentials[] getCredsList() {
</pre>
<hr />
<pre>
290     public Credentials getCreds(LoginOptions options, PrincipalName sname) {
291         if (options == null) {
292             return getCreds(sname);
293         } else {
294             Credentials[] list = getCredsList();
295             if (list == null) {
296                 return null;
297             } else {
298                 for (int i = 0; i &lt; list.length; i++) {
299                     if (sname.match(list[i].sname)) {
300                         if (list[i].flags.match(options)) {
301                             return list[i];
302                         }
303                     }
304                 }
305             }
306             return null;
307         }
308     }
309 











310 
311     /**
312      * Gets a credentials for a specified service.
313      * @param sname service principal name.
314      */
315     public Credentials getCreds(PrincipalName sname) {
316         Credentials[] list = getCredsList();
317         if (list == null) {
318             return null;
319         } else {
320             for (int i = 0; i &lt; list.length; i++) {
321                 if (sname.match(list[i].sname)) {
322                     return list[i];
323                 }
324             }
325         }
326         return null;
327     }
328 











































































329     public Credentials getDefaultCreds() {
330         Credentials[] list = getCredsList();
331         if (list == null) {
332             return null;
333         } else {
334             for (int i = list.length-1; i &gt;= 0; i--) {
335                 if (list[i].sname.toString().startsWith(&quot;krbtgt&quot;)) {
336                     String[] nameStrings = list[i].sname.getNameStrings();
337                     // find the TGT for the current realm krbtgt/realm@realm
338                     if (nameStrings[1].equals(list[i].sname.getRealm().toString())) {
339                        return list[i];
340                     }
341                 }
342             }
343         }
344         return null;
345     }
346 
347     /*
348      * Returns path name of the credentials cache file.
</pre>
<hr />
<pre>
478                 java.security.AccessController.doPrivileged
479                 (new java.security.PrivilegedAction&lt;Process&gt; () {
480                         public Process run() {
481                             try {
482                                 return (Runtime.getRuntime().exec(command));
483                             } catch (java.io.IOException e) {
484                                 if (DEBUG) {
485                                     e.printStackTrace();
486                                 }
487                                 return null;
488                             }
489                         }
490                     });
491             if (p == null) {
492                 // exception occurred during executing the command
493                 return null;
494             }
495 
496             BufferedReader commandResult =
497                 new BufferedReader
<span class="line-modified">498                     (new InputStreamReader(p.getInputStream(), &quot;8859_1&quot;));</span>
499             String s1 = null;
500             if ((command.length == 1) &amp;&amp;
501                 (command[0].equals(&quot;/usr/bin/env&quot;))) {
502                 while ((s1 = commandResult.readLine()) != null) {
503                     if (s1.length() &gt;= 11) {
504                         if ((s1.substring(0, 11)).equalsIgnoreCase
505                             (&quot;KRB5CCNAME=&quot;)) {
506                             s1 = s1.substring(11);
507                             break;
508                         }
509                     }
510                 }
511             } else     s1 = commandResult.readLine();
512             commandResult.close();
513             return s1;
514         } catch (Exception e) {
515             if (DEBUG) {
516                 e.printStackTrace();
517             }
518         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  * ===========================================================================
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *
 30  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 31  * ===========================================================================
 32  *
 33  */
 34 package sun.security.krb5.internal.ccache;
 35 
 36 import sun.security.action.GetPropertyAction;
 37 import sun.security.krb5.*;
 38 import sun.security.krb5.internal.*;
<span class="line-added"> 39 import sun.security.util.SecurityProperties;</span>
<span class="line-added"> 40 </span>
<span class="line-added"> 41 import java.nio.charset.StandardCharsets;</span>
<span class="line-added"> 42 import java.util.ArrayList;</span>
<span class="line-added"> 43 import java.util.Collections;</span>
<span class="line-added"> 44 import java.util.List;</span>
 45 import java.util.StringTokenizer;
 46 import java.util.Vector;
 47 import java.io.IOException;
 48 import java.io.File;
 49 import java.io.FileInputStream;
 50 import java.io.FileOutputStream;
 51 import java.io.BufferedReader;
 52 import java.io.InputStreamReader;
 53 
<span class="line-added"> 54 import static java.nio.charset.StandardCharsets.ISO_8859_1;</span>
<span class="line-added"> 55 </span>
 56 /**
 57  * CredentialsCache stores credentials(tickets, session keys, etc) in a
 58  * semi-permanent store
 59  * for later use by different program.
 60  *
 61  * @author Yanni Zhang
 62  * @author Ram Marti
 63  */
 64 
 65 public class FileCredentialsCache extends CredentialsCache
 66     implements FileCCacheConstants {
 67     public int version;
 68     public Tag tag; // optional
 69     public PrincipalName primaryPrincipal;
 70     private Vector&lt;Credentials&gt; credentialsList;
 71     private static String dir;
 72     private static boolean DEBUG = Krb5.DEBUG;
 73 
 74     public static synchronized FileCredentialsCache acquireInstance(
 75                 PrincipalName principal, String cache) {
</pre>
<hr />
<pre>
173              CCacheInputStream cis = new CCacheInputStream(fis)) {
174             version = cis.readVersion();
175             if (version == KRB5_FCC_FVNO_4) {
176                 tag = cis.readTag();
177             } else {
178                 tag = null;
179                 if (version == KRB5_FCC_FVNO_1 || version == KRB5_FCC_FVNO_2) {
180                     cis.setNativeByteOrder();
181                 }
182             }
183             p = cis.readPrincipal(version);
184 
185             if (primaryPrincipal != null) {
186                 if (!(primaryPrincipal.match(p))) {
187                     throw new IOException(&quot;Primary principals don&#39;t match.&quot;);
188                 }
189             } else
190                 primaryPrincipal = p;
191             credentialsList = new Vector&lt;Credentials&gt;();
192             while (cis.available() &gt; 0) {
<span class="line-modified">193                 Object cred = cis.readCred(version);</span>
194                 if (cred != null) {
<span class="line-modified">195                     if (cred instanceof Credentials) {</span>
<span class="line-added">196                         credentialsList.addElement((Credentials)cred);</span>
<span class="line-added">197                     } else {</span>
<span class="line-added">198                         addConfigEntry((CredentialsCache.ConfigEntry)cred);</span>
<span class="line-added">199                     }</span>
200                 }
201             }
202         }
203     }
204 
205 
206     /**
207      * Updates the credentials list. If the specified credentials for the
208      * service is new, add it to the list. If there is an entry in the list,
209      * replace the old credentials with the new one.
210      * @param c the credentials.
211      */
212 
213     public synchronized void update(Credentials c) {
214         if (credentialsList != null) {
215             if (credentialsList.isEmpty()) {
216                 credentialsList.addElement(c);
217             } else {
218                 Credentials tmp = null;
219                 boolean matched = false;
</pre>
<hr />
<pre>
250     }
251 
252     public synchronized PrincipalName getPrimaryPrincipal() {
253         return primaryPrincipal;
254     }
255 
256 
257     /**
258      * Saves the credentials cache file to the disk.
259      */
260     public synchronized void save() throws IOException, Asn1Exception {
261         try (FileOutputStream fos = new FileOutputStream(cacheName);
262              CCacheOutputStream cos = new CCacheOutputStream(fos)) {
263             cos.writeHeader(primaryPrincipal, version);
264             Credentials[] tmp = null;
265             if ((tmp = getCredsList()) != null) {
266                 for (int i = 0; i &lt; tmp.length; i++) {
267                     cos.addCreds(tmp[i]);
268                 }
269             }
<span class="line-added">270             for (ConfigEntry e : getConfigEntries()) {</span>
<span class="line-added">271                 cos.addConfigEntry(primaryPrincipal, e);</span>
<span class="line-added">272             }</span>
273         }
274     }
275 
276     boolean match(String[] s1, String[] s2) {
277         if (s1.length != s2.length) {
278             return false;
279         } else {
280             for (int i = 0; i &lt; s1.length; i++) {
281                 if (!(s1[i].equalsIgnoreCase(s2[i]))) {
282                     return false;
283                 }
284             }
285         }
286         return true;
287     }
288 
289     /**
290      * Returns the list of credentials entries in the cache file.
291      */
292     public synchronized Credentials[] getCredsList() {
</pre>
<hr />
<pre>
305     public Credentials getCreds(LoginOptions options, PrincipalName sname) {
306         if (options == null) {
307             return getCreds(sname);
308         } else {
309             Credentials[] list = getCredsList();
310             if (list == null) {
311                 return null;
312             } else {
313                 for (int i = 0; i &lt; list.length; i++) {
314                     if (sname.match(list[i].sname)) {
315                         if (list[i].flags.match(options)) {
316                             return list[i];
317                         }
318                     }
319                 }
320             }
321             return null;
322         }
323     }
324 
<span class="line-added">325     private List&lt;ConfigEntry&gt; configEntries = new ArrayList&lt;&gt;();</span>
<span class="line-added">326 </span>
<span class="line-added">327     @Override</span>
<span class="line-added">328     public void addConfigEntry(ConfigEntry e) {</span>
<span class="line-added">329         configEntries.add(e);</span>
<span class="line-added">330     }</span>
<span class="line-added">331 </span>
<span class="line-added">332     @Override</span>
<span class="line-added">333     public List&lt;ConfigEntry&gt; getConfigEntries() {</span>
<span class="line-added">334         return Collections.unmodifiableList(configEntries);</span>
<span class="line-added">335     }</span>
336 
337     /**
338      * Gets a credentials for a specified service.
339      * @param sname service principal name.
340      */
341     public Credentials getCreds(PrincipalName sname) {
342         Credentials[] list = getCredsList();
343         if (list == null) {
344             return null;
345         } else {
346             for (int i = 0; i &lt; list.length; i++) {
347                 if (sname.match(list[i].sname)) {
348                     return list[i];
349                 }
350             }
351         }
352         return null;
353     }
354 
<span class="line-added">355     public sun.security.krb5.Credentials getInitialCreds() {</span>
<span class="line-added">356 </span>
<span class="line-added">357         Credentials defaultCreds = getDefaultCreds();</span>
<span class="line-added">358         if (defaultCreds == null) {</span>
<span class="line-added">359             return null;</span>
<span class="line-added">360         }</span>
<span class="line-added">361         sun.security.krb5.Credentials tgt = defaultCreds.setKrbCreds();</span>
<span class="line-added">362 </span>
<span class="line-added">363         CredentialsCache.ConfigEntry entry = getConfigEntry(&quot;proxy_impersonator&quot;);</span>
<span class="line-added">364         if (entry == null) {</span>
<span class="line-added">365             if (DEBUG) {</span>
<span class="line-added">366                 System.out.println(&quot;get normal credential&quot;);</span>
<span class="line-added">367             }</span>
<span class="line-added">368             return tgt;</span>
<span class="line-added">369         }</span>
<span class="line-added">370 </span>
<span class="line-added">371         boolean force;</span>
<span class="line-added">372         String prop = SecurityProperties.privilegedGetOverridable(</span>
<span class="line-added">373                 &quot;jdk.security.krb5.default.initiate.credential&quot;);</span>
<span class="line-added">374         if (prop == null) {</span>
<span class="line-added">375             prop = &quot;always-impersonate&quot;;</span>
<span class="line-added">376         }</span>
<span class="line-added">377         switch (prop) {</span>
<span class="line-added">378             case &quot;no-impersonate&quot;: // never try impersonation</span>
<span class="line-added">379                 if (DEBUG) {</span>
<span class="line-added">380                     System.out.println(&quot;get normal credential&quot;);</span>
<span class="line-added">381                 }</span>
<span class="line-added">382                 return tgt;</span>
<span class="line-added">383             case &quot;try-impersonate&quot;:</span>
<span class="line-added">384                 force = false;</span>
<span class="line-added">385                 break;</span>
<span class="line-added">386             case &quot;always-impersonate&quot;:</span>
<span class="line-added">387                 force = true;</span>
<span class="line-added">388                 break;</span>
<span class="line-added">389             default:</span>
<span class="line-added">390                 throw new RuntimeException(</span>
<span class="line-added">391                         &quot;Invalid jdk.security.krb5.default.initiate.credential&quot;);</span>
<span class="line-added">392         }</span>
<span class="line-added">393 </span>
<span class="line-added">394         try {</span>
<span class="line-added">395             PrincipalName service = new PrincipalName(</span>
<span class="line-added">396                     new String(entry.getData(), StandardCharsets.UTF_8));</span>
<span class="line-added">397             if (!tgt.getClient().equals(service)) {</span>
<span class="line-added">398                 if (DEBUG) {</span>
<span class="line-added">399                     System.out.println(&quot;proxy_impersonator does not match service name&quot;);</span>
<span class="line-added">400                 }</span>
<span class="line-added">401                 return force ? null : tgt;</span>
<span class="line-added">402             }</span>
<span class="line-added">403             PrincipalName client = getPrimaryPrincipal();</span>
<span class="line-added">404             Credentials proxy = null;</span>
<span class="line-added">405             for (Credentials c : getCredsList()) {</span>
<span class="line-added">406                 if (c.getClientPrincipal().equals(client)</span>
<span class="line-added">407                         &amp;&amp; c.getServicePrincipal().equals(service)) {</span>
<span class="line-added">408                     proxy = c;</span>
<span class="line-added">409                     break;</span>
<span class="line-added">410                 }</span>
<span class="line-added">411             }</span>
<span class="line-added">412             if (proxy == null) {</span>
<span class="line-added">413                 if (DEBUG) {</span>
<span class="line-added">414                     System.out.println(&quot;Cannot find evidence ticket in ccache&quot;);</span>
<span class="line-added">415                 }</span>
<span class="line-added">416                 return force ? null : tgt;</span>
<span class="line-added">417             }</span>
<span class="line-added">418             if (DEBUG) {</span>
<span class="line-added">419                 System.out.println(&quot;Get proxied credential&quot;);</span>
<span class="line-added">420             }</span>
<span class="line-added">421             return tgt.setProxy(proxy.setKrbCreds());</span>
<span class="line-added">422         } catch (KrbException e) {</span>
<span class="line-added">423             if (DEBUG) {</span>
<span class="line-added">424                 System.out.println(&quot;Impersonation with ccache failed&quot;);</span>
<span class="line-added">425             }</span>
<span class="line-added">426             return force ? null : tgt;</span>
<span class="line-added">427         }</span>
<span class="line-added">428     }</span>
<span class="line-added">429 </span>
430     public Credentials getDefaultCreds() {
431         Credentials[] list = getCredsList();
432         if (list == null) {
433             return null;
434         } else {
435             for (int i = list.length-1; i &gt;= 0; i--) {
436                 if (list[i].sname.toString().startsWith(&quot;krbtgt&quot;)) {
437                     String[] nameStrings = list[i].sname.getNameStrings();
438                     // find the TGT for the current realm krbtgt/realm@realm
439                     if (nameStrings[1].equals(list[i].sname.getRealm().toString())) {
440                        return list[i];
441                     }
442                 }
443             }
444         }
445         return null;
446     }
447 
448     /*
449      * Returns path name of the credentials cache file.
</pre>
<hr />
<pre>
579                 java.security.AccessController.doPrivileged
580                 (new java.security.PrivilegedAction&lt;Process&gt; () {
581                         public Process run() {
582                             try {
583                                 return (Runtime.getRuntime().exec(command));
584                             } catch (java.io.IOException e) {
585                                 if (DEBUG) {
586                                     e.printStackTrace();
587                                 }
588                                 return null;
589                             }
590                         }
591                     });
592             if (p == null) {
593                 // exception occurred during executing the command
594                 return null;
595             }
596 
597             BufferedReader commandResult =
598                 new BufferedReader
<span class="line-modified">599                     (new InputStreamReader(p.getInputStream(), ISO_8859_1));</span>
600             String s1 = null;
601             if ((command.length == 1) &amp;&amp;
602                 (command[0].equals(&quot;/usr/bin/env&quot;))) {
603                 while ((s1 = commandResult.readLine()) != null) {
604                     if (s1.length() &gt;= 11) {
605                         if ((s1.substring(0, 11)).equalsIgnoreCase
606                             (&quot;KRB5CCNAME=&quot;)) {
607                             s1 = s1.substring(11);
608                             break;
609                         }
610                     }
611                 }
612             } else     s1 = commandResult.readLine();
613             commandResult.close();
614             return s1;
615         } catch (Exception e) {
616             if (DEBUG) {
617                 e.printStackTrace();
618             }
619         }
</pre>
</td>
</tr>
</table>
<center><a href="CredentialsCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../crypto/CksumType.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>