<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/krb5/internal/CredentialsUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Realm.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ETypeInfo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/internal/CredentialsUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2013, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5.internal;
 33 
 34 import sun.security.krb5.*;


 35 import java.io.IOException;


 36 
 37 /**
 38  * This class is a utility that contains much of the TGS-Exchange
 39  * protocol. It is used by ../Credentials.java for service ticket
 40  * acquisition in both the normal and the x-realm case.
 41  */
 42 public class CredentialsUtil {
 43 
 44     private static boolean DEBUG = sun.security.krb5.internal.Krb5.DEBUG;
 45 




 46     /**
 47      * Used by a middle server to acquire credentials on behalf of a
 48      * client to itself using the S4U2self extension.
 49      * @param client the client to impersonate
 50      * @param ccreds the TGT of the middle service
 51      * @return the new creds (cname=client, sname=middle)
 52      */
 53     public static Credentials acquireS4U2selfCreds(PrincipalName client,
 54             Credentials ccreds) throws KrbException, IOException {




 55         String uRealm = client.getRealmString();
 56         String localRealm = ccreds.getClient().getRealmString();
 57         if (!uRealm.equals(localRealm)) {
<span class="line-modified"> 58             // TODO: we do not support kerberos referral now</span>
<span class="line-modified"> 59             throw new KrbException(&quot;Cross realm impersonation not supported&quot;);</span>
<span class="line-modified"> 60         }</span>
<span class="line-modified"> 61         if (!ccreds.isForwardable()) {</span>
<span class="line-modified"> 62             throw new KrbException(&quot;S4U2self needs a FORWARDABLE ticket&quot;);</span>












 63         }
<span class="line-modified"> 64         KrbTgsReq req = new KrbTgsReq(</span>
<span class="line-modified"> 65                 ccreds,</span>
<span class="line-modified"> 66                 ccreds.getClient(),</span>
<span class="line-modified"> 67                 new PAData(Krb5.PA_FOR_USER,</span>
<span class="line-modified"> 68                     new PAForUserEnc(client,</span>
<span class="line-modified"> 69                         ccreds.getSessionKey()).asn1Encode()));</span>
<span class="line-modified"> 70         Credentials creds = req.sendAndGetCreds();</span>






 71         if (!creds.getClient().equals(client)) {
 72             throw new KrbException(&quot;S4U2self request not honored by KDC&quot;);
 73         }
 74         if (!creds.isForwardable()) {
 75             throw new KrbException(&quot;S4U2self ticket must be FORWARDABLE&quot;);
 76         }
 77         return creds;
 78     }
 79 
 80     /**
 81      * Used by a middle server to acquire a service ticket to a backend
 82      * server using the S4U2proxy extension.
 83      * @param backend the name of the backend service
 84      * @param second the client&#39;s service ticket to the middle server
 85      * @param ccreds the TGT of the middle server
 86      * @return the creds (cname=client, sname=backend)
 87      */
 88     public static Credentials acquireS4U2proxyCreds(
 89                 String backend, Ticket second,
 90                 PrincipalName client, Credentials ccreds)
 91             throws KrbException, IOException {
<span class="line-modified"> 92         KrbTgsReq req = new KrbTgsReq(</span>
<span class="line-modified"> 93                 ccreds,</span>
<span class="line-modified"> 94                 second,</span>
<span class="line-modified"> 95                 new PrincipalName(backend));</span>
<span class="line-modified"> 96         Credentials creds = req.sendAndGetCreds();</span>




















 97         if (!creds.getClient().equals(client)) {
 98             throw new KrbException(&quot;S4U2proxy request not honored by KDC&quot;);
 99         }
100         return creds;
101     }
102 
103     /**
104      * Acquires credentials for a specified service using initial
105      * credential. When the service has a different realm from the initial
106      * credential, we do cross-realm authentication - first, we use the
107      * current credential to get a cross-realm credential from the local KDC,
108      * then use that cross-realm credential to request service credential
109      * from the foreign KDC.
110      *
111      * @param service the name of service principal
112      * @param ccreds client&#39;s initial credential
113      */
114     public static Credentials acquireServiceCreds(
115                 String service, Credentials ccreds)
116             throws KrbException, IOException {
<span class="line-modified">117         PrincipalName sname = new PrincipalName(service);</span>
<span class="line-modified">118         String serviceRealm = sname.getRealmString();</span>
<span class="line-modified">119         String localRealm = ccreds.getClient().getRealmString();</span>
<span class="line-removed">120 </span>
<span class="line-removed">121         if (localRealm.equals(serviceRealm)) {</span>
<span class="line-removed">122             if (DEBUG) {</span>
<span class="line-removed">123                 System.out.println(</span>
<span class="line-removed">124                         &quot;&gt;&gt;&gt; Credentials acquireServiceCreds: same realm&quot;);</span>
<span class="line-removed">125             }</span>
<span class="line-removed">126             return serviceCreds(sname, ccreds);</span>
<span class="line-removed">127         }</span>
<span class="line-removed">128         Credentials theCreds = null;</span>
<span class="line-removed">129 </span>
<span class="line-removed">130         boolean[] okAsDelegate = new boolean[1];</span>
<span class="line-removed">131         Credentials theTgt = getTGTforRealm(localRealm, serviceRealm,</span>
<span class="line-removed">132                 ccreds, okAsDelegate);</span>
<span class="line-removed">133         if (theTgt != null) {</span>
<span class="line-removed">134             if (DEBUG) {</span>
<span class="line-removed">135                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="line-removed">136                         + &quot;got right tgt&quot;);</span>
<span class="line-removed">137                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="line-removed">138                         + &quot;obtaining service creds for &quot; + sname);</span>
<span class="line-removed">139             }</span>
<span class="line-removed">140 </span>
<span class="line-removed">141             try {</span>
<span class="line-removed">142                 theCreds = serviceCreds(sname, theTgt);</span>
<span class="line-removed">143             } catch (Exception exc) {</span>
<span class="line-removed">144                 if (DEBUG) {</span>
<span class="line-removed">145                     System.out.println(exc);</span>
<span class="line-removed">146                 }</span>
<span class="line-removed">147                 theCreds = null;</span>
<span class="line-removed">148             }</span>
<span class="line-removed">149         }</span>
<span class="line-removed">150 </span>
<span class="line-removed">151         if (theCreds != null) {</span>
<span class="line-removed">152             if (DEBUG) {</span>
<span class="line-removed">153                 System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
<span class="line-removed">154                         + &quot;returning creds:&quot;);</span>
<span class="line-removed">155                 Credentials.printDebug(theCreds);</span>
<span class="line-removed">156             }</span>
<span class="line-removed">157             if (!okAsDelegate[0]) {</span>
<span class="line-removed">158                 theCreds.resetDelegate();</span>
<span class="line-removed">159             }</span>
<span class="line-removed">160             return theCreds;</span>
<span class="line-removed">161         }</span>
<span class="line-removed">162         throw new KrbApErrException(Krb5.KRB_AP_ERR_GEN_CRED,</span>
<span class="line-removed">163                                     &quot;No service creds&quot;);</span>
164     }
165 
166     /**
167      * Gets a TGT to another realm
168      * @param localRealm this realm
169      * @param serviceRealm the other realm, cannot equals to localRealm
170      * @param ccreds TGT in this realm
171      * @param okAsDelegate an [out] argument to receive the okAsDelegate
172      * property. True only if all realms allow delegation.
173      * @return the TGT for the other realm, null if cannot find a path
174      * @throws KrbException if something goes wrong
175      */
176     private static Credentials getTGTforRealm(String localRealm,
177             String serviceRealm, Credentials ccreds, boolean[] okAsDelegate)
178             throws KrbException {
179 
180         // Get a list of realms to traverse
181         String[] realms = Realm.getRealmsList(localRealm, serviceRealm);
182 
183         int i = 0, k = 0;
</pre>
<hr />
<pre>
288             else {
289                 /*
290                  * The new tgt&#39;s realm is not in the hierarchy of realms.
291                  * It&#39;s probably not safe to get a tgt from
292                  * a tgs that is outside the known list of realms.
293                  * Give up now.
294                  */
295                 break;
296             }
297         } // Ends outermost/main &#39;for&#39; loop
298 
299         return theTgt;
300     }
301 
302    /*
303     * This method does the real job to request the service credential.
304     */
305     private static Credentials serviceCreds(
306             PrincipalName service, Credentials ccreds)
307             throws KrbException, IOException {
<span class="line-modified">308         return new KrbTgsReq(ccreds, service).sendAndGetCreds();</span>





























































































































































































































































309     }
310 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5.internal;
 33 
 34 import sun.security.krb5.*;
<span class="line-added"> 35 import sun.security.util.DerValue;</span>
<span class="line-added"> 36 </span>
 37 import java.io.IOException;
<span class="line-added"> 38 import java.util.LinkedList;</span>
<span class="line-added"> 39 import java.util.List;</span>
 40 
 41 /**
 42  * This class is a utility that contains much of the TGS-Exchange
 43  * protocol. It is used by ../Credentials.java for service ticket
 44  * acquisition in both the normal and the x-realm case.
 45  */
 46 public class CredentialsUtil {
 47 
 48     private static boolean DEBUG = sun.security.krb5.internal.Krb5.DEBUG;
 49 
<span class="line-added"> 50     private static enum S4U2Type {</span>
<span class="line-added"> 51         NONE, SELF, PROXY</span>
<span class="line-added"> 52     }</span>
<span class="line-added"> 53 </span>
 54     /**
 55      * Used by a middle server to acquire credentials on behalf of a
 56      * client to itself using the S4U2self extension.
 57      * @param client the client to impersonate
 58      * @param ccreds the TGT of the middle service
 59      * @return the new creds (cname=client, sname=middle)
 60      */
 61     public static Credentials acquireS4U2selfCreds(PrincipalName client,
 62             Credentials ccreds) throws KrbException, IOException {
<span class="line-added"> 63         if (!ccreds.isForwardable()) {</span>
<span class="line-added"> 64             throw new KrbException(&quot;S4U2self needs a FORWARDABLE ticket&quot;);</span>
<span class="line-added"> 65         }</span>
<span class="line-added"> 66         PrincipalName sname = ccreds.getClient();</span>
 67         String uRealm = client.getRealmString();
 68         String localRealm = ccreds.getClient().getRealmString();
 69         if (!uRealm.equals(localRealm)) {
<span class="line-modified"> 70             // Referrals will be required because the middle service</span>
<span class="line-modified"> 71             // and the client impersonated are on different realms.</span>
<span class="line-modified"> 72             if (Config.DISABLE_REFERRALS) {</span>
<span class="line-modified"> 73                 throw new KrbException(&quot;Cross-realm S4U2Self request not&quot; +</span>
<span class="line-modified"> 74                         &quot; possible when referrals are disabled.&quot;);</span>
<span class="line-added"> 75             }</span>
<span class="line-added"> 76             if (ccreds.getClientAlias() != null) {</span>
<span class="line-added"> 77                 // If the name was canonicalized, the user pick</span>
<span class="line-added"> 78                 // has preference. This gives the possibility of</span>
<span class="line-added"> 79                 // using FQDNs that KDCs may use to return referrals.</span>
<span class="line-added"> 80                 // I.e.: a SVC/host.realm-2.com@REALM-1.COM name</span>
<span class="line-added"> 81                 // may be used by REALM-1.COM KDC to return a</span>
<span class="line-added"> 82                 // referral to REALM-2.COM.</span>
<span class="line-added"> 83                 sname = ccreds.getClientAlias();</span>
<span class="line-added"> 84             }</span>
<span class="line-added"> 85             sname = new PrincipalName(sname.getNameType(),</span>
<span class="line-added"> 86                     sname.getNameStrings(), new Realm(uRealm));</span>
 87         }
<span class="line-modified"> 88         Credentials creds = serviceCreds(</span>
<span class="line-modified"> 89                 KDCOptions.with(KDCOptions.FORWARDABLE),</span>
<span class="line-modified"> 90                 ccreds, ccreds.getClient(), sname, null,</span>
<span class="line-modified"> 91                 new PAData[] {</span>
<span class="line-modified"> 92                         new PAData(Krb5.PA_FOR_USER,</span>
<span class="line-modified"> 93                                 new PAForUserEnc(client,</span>
<span class="line-modified"> 94                                         ccreds.getSessionKey()).asn1Encode()),</span>
<span class="line-added"> 95                         new PAData(Krb5.PA_PAC_OPTIONS,</span>
<span class="line-added"> 96                                 new PaPacOptions()</span>
<span class="line-added"> 97                                         .setResourceBasedConstrainedDelegation(true)</span>
<span class="line-added"> 98                                         .setClaims(true)</span>
<span class="line-added"> 99                                         .asn1Encode())</span>
<span class="line-added">100                         }, S4U2Type.SELF);</span>
101         if (!creds.getClient().equals(client)) {
102             throw new KrbException(&quot;S4U2self request not honored by KDC&quot;);
103         }
104         if (!creds.isForwardable()) {
105             throw new KrbException(&quot;S4U2self ticket must be FORWARDABLE&quot;);
106         }
107         return creds;
108     }
109 
110     /**
111      * Used by a middle server to acquire a service ticket to a backend
112      * server using the S4U2proxy extension.
113      * @param backend the name of the backend service
114      * @param second the client&#39;s service ticket to the middle server
115      * @param ccreds the TGT of the middle server
116      * @return the creds (cname=client, sname=backend)
117      */
118     public static Credentials acquireS4U2proxyCreds(
119                 String backend, Ticket second,
120                 PrincipalName client, Credentials ccreds)
121             throws KrbException, IOException {
<span class="line-modified">122         PrincipalName backendPrincipal = new PrincipalName(backend);</span>
<span class="line-modified">123         String backendRealm = backendPrincipal.getRealmString();</span>
<span class="line-modified">124         String localRealm = ccreds.getClient().getRealmString();</span>
<span class="line-modified">125         if (!backendRealm.equals(localRealm)) {</span>
<span class="line-modified">126             // The middle service and the backend service are on</span>
<span class="line-added">127             // different realms, so referrals will be required.</span>
<span class="line-added">128             if (Config.DISABLE_REFERRALS) {</span>
<span class="line-added">129                 throw new KrbException(&quot;Cross-realm S4U2Proxy request not&quot; +</span>
<span class="line-added">130                         &quot; possible when referrals are disabled.&quot;);</span>
<span class="line-added">131             }</span>
<span class="line-added">132             backendPrincipal = new PrincipalName(</span>
<span class="line-added">133                     backendPrincipal.getNameType(),</span>
<span class="line-added">134                     backendPrincipal.getNameStrings(),</span>
<span class="line-added">135                     new Realm(localRealm));</span>
<span class="line-added">136         }</span>
<span class="line-added">137         Credentials creds = serviceCreds(KDCOptions.with(</span>
<span class="line-added">138                 KDCOptions.CNAME_IN_ADDL_TKT, KDCOptions.FORWARDABLE),</span>
<span class="line-added">139                 ccreds, ccreds.getClient(), backendPrincipal,</span>
<span class="line-added">140                 new Ticket[] {second}, new PAData[] {</span>
<span class="line-added">141                         new PAData(Krb5.PA_PAC_OPTIONS,</span>
<span class="line-added">142                                 new PaPacOptions()</span>
<span class="line-added">143                                         .setResourceBasedConstrainedDelegation(true)</span>
<span class="line-added">144                                         .setClaims(true)</span>
<span class="line-added">145                                         .asn1Encode())</span>
<span class="line-added">146                         }, S4U2Type.PROXY);</span>
147         if (!creds.getClient().equals(client)) {
148             throw new KrbException(&quot;S4U2proxy request not honored by KDC&quot;);
149         }
150         return creds;
151     }
152 
153     /**
154      * Acquires credentials for a specified service using initial
155      * credential. When the service has a different realm from the initial
156      * credential, we do cross-realm authentication - first, we use the
157      * current credential to get a cross-realm credential from the local KDC,
158      * then use that cross-realm credential to request service credential
159      * from the foreign KDC.
160      *
161      * @param service the name of service principal
162      * @param ccreds client&#39;s initial credential
163      */
164     public static Credentials acquireServiceCreds(
165                 String service, Credentials ccreds)
166             throws KrbException, IOException {
<span class="line-modified">167         PrincipalName sname = new PrincipalName(service,</span>
<span class="line-modified">168                 PrincipalName.KRB_NT_SRV_HST);</span>
<span class="line-modified">169         return serviceCreds(sname, ccreds);</span>












































170     }
171 
172     /**
173      * Gets a TGT to another realm
174      * @param localRealm this realm
175      * @param serviceRealm the other realm, cannot equals to localRealm
176      * @param ccreds TGT in this realm
177      * @param okAsDelegate an [out] argument to receive the okAsDelegate
178      * property. True only if all realms allow delegation.
179      * @return the TGT for the other realm, null if cannot find a path
180      * @throws KrbException if something goes wrong
181      */
182     private static Credentials getTGTforRealm(String localRealm,
183             String serviceRealm, Credentials ccreds, boolean[] okAsDelegate)
184             throws KrbException {
185 
186         // Get a list of realms to traverse
187         String[] realms = Realm.getRealmsList(localRealm, serviceRealm);
188 
189         int i = 0, k = 0;
</pre>
<hr />
<pre>
294             else {
295                 /*
296                  * The new tgt&#39;s realm is not in the hierarchy of realms.
297                  * It&#39;s probably not safe to get a tgt from
298                  * a tgs that is outside the known list of realms.
299                  * Give up now.
300                  */
301                 break;
302             }
303         } // Ends outermost/main &#39;for&#39; loop
304 
305         return theTgt;
306     }
307 
308    /*
309     * This method does the real job to request the service credential.
310     */
311     private static Credentials serviceCreds(
312             PrincipalName service, Credentials ccreds)
313             throws KrbException, IOException {
<span class="line-modified">314         return serviceCreds(new KDCOptions(), ccreds,</span>
<span class="line-added">315                 ccreds.getClient(), service, null, null,</span>
<span class="line-added">316                 S4U2Type.NONE);</span>
<span class="line-added">317     }</span>
<span class="line-added">318 </span>
<span class="line-added">319     /*</span>
<span class="line-added">320      * Obtains credentials for a service (TGS).</span>
<span class="line-added">321      * Cross-realm referrals are handled if enabled. A fallback scheme</span>
<span class="line-added">322      * without cross-realm referrals supports is used in case of server</span>
<span class="line-added">323      * error to maintain backward compatibility.</span>
<span class="line-added">324      */</span>
<span class="line-added">325     private static Credentials serviceCreds(</span>
<span class="line-added">326             KDCOptions options, Credentials asCreds,</span>
<span class="line-added">327             PrincipalName cname, PrincipalName sname,</span>
<span class="line-added">328             Ticket[] additionalTickets, PAData[] extraPAs,</span>
<span class="line-added">329             S4U2Type s4u2Type)</span>
<span class="line-added">330             throws KrbException, IOException {</span>
<span class="line-added">331         if (!Config.DISABLE_REFERRALS) {</span>
<span class="line-added">332             try {</span>
<span class="line-added">333                 return serviceCredsReferrals(options, asCreds, cname, sname,</span>
<span class="line-added">334                         s4u2Type, additionalTickets, extraPAs);</span>
<span class="line-added">335             } catch (KrbException e) {</span>
<span class="line-added">336                 // Server may raise an error if CANONICALIZE is true.</span>
<span class="line-added">337                 // Try CANONICALIZE false.</span>
<span class="line-added">338             }</span>
<span class="line-added">339         }</span>
<span class="line-added">340         return serviceCredsSingle(options, asCreds, cname,</span>
<span class="line-added">341                 asCreds.getClientAlias(), sname, sname, s4u2Type,</span>
<span class="line-added">342                 additionalTickets, extraPAs);</span>
<span class="line-added">343     }</span>
<span class="line-added">344 </span>
<span class="line-added">345     /*</span>
<span class="line-added">346      * Obtains credentials for a service (TGS).</span>
<span class="line-added">347      * May handle and follow cross-realm referrals as defined by RFC 6806.</span>
<span class="line-added">348      */</span>
<span class="line-added">349     private static Credentials serviceCredsReferrals(</span>
<span class="line-added">350             KDCOptions options, Credentials asCreds,</span>
<span class="line-added">351             PrincipalName cname, PrincipalName sname,</span>
<span class="line-added">352             S4U2Type s4u2Type, Ticket[] additionalTickets,</span>
<span class="line-added">353             PAData[] extraPAs)</span>
<span class="line-added">354                     throws KrbException, IOException {</span>
<span class="line-added">355         options = new KDCOptions(options.toBooleanArray());</span>
<span class="line-added">356         options.set(KDCOptions.CANONICALIZE, true);</span>
<span class="line-added">357         PrincipalName cSname = sname;</span>
<span class="line-added">358         PrincipalName refSname = sname; // May change with referrals</span>
<span class="line-added">359         Credentials creds = null;</span>
<span class="line-added">360         boolean isReferral = false;</span>
<span class="line-added">361         List&lt;String&gt; referrals = new LinkedList&lt;&gt;();</span>
<span class="line-added">362         PrincipalName clientAlias = asCreds.getClientAlias();</span>
<span class="line-added">363         while (referrals.size() &lt;= Config.MAX_REFERRALS) {</span>
<span class="line-added">364             ReferralsCache.ReferralCacheEntry ref =</span>
<span class="line-added">365                     ReferralsCache.get(cname, sname, refSname.getRealmString());</span>
<span class="line-added">366             String toRealm = null;</span>
<span class="line-added">367             if (ref == null) {</span>
<span class="line-added">368                 creds = serviceCredsSingle(options, asCreds, cname,</span>
<span class="line-added">369                         clientAlias, refSname, cSname, s4u2Type,</span>
<span class="line-added">370                         additionalTickets, extraPAs);</span>
<span class="line-added">371                 PrincipalName server = creds.getServer();</span>
<span class="line-added">372                 if (!refSname.equals(server)) {</span>
<span class="line-added">373                     String[] serverNameStrings = server.getNameStrings();</span>
<span class="line-added">374                     if (serverNameStrings.length == 2 &amp;&amp;</span>
<span class="line-added">375                         serverNameStrings[0].equals(</span>
<span class="line-added">376                                 PrincipalName.TGS_DEFAULT_SRV_NAME) &amp;&amp;</span>
<span class="line-added">377                         !refSname.getRealmAsString().equals(</span>
<span class="line-added">378                                 serverNameStrings[1])) {</span>
<span class="line-added">379                         // Server Name (sname) has the following format:</span>
<span class="line-added">380                         //      krbtgt/TO-REALM.COM@FROM-REALM.COM</span>
<span class="line-added">381                         if (s4u2Type == S4U2Type.NONE) {</span>
<span class="line-added">382                             // Do not store S4U2Self or S4U2Proxy referral</span>
<span class="line-added">383                             // TGTs in the cache. Caching such tickets is not</span>
<span class="line-added">384                             // defined in MS-SFU and may cause unexpected</span>
<span class="line-added">385                             // results when using them in a different context.</span>
<span class="line-added">386                             ReferralsCache.put(cname, sname,</span>
<span class="line-added">387                                     server.getRealmString(),</span>
<span class="line-added">388                                     serverNameStrings[1], creds);</span>
<span class="line-added">389                         }</span>
<span class="line-added">390                         toRealm = serverNameStrings[1];</span>
<span class="line-added">391                         isReferral = true;</span>
<span class="line-added">392                     }</span>
<span class="line-added">393                 }</span>
<span class="line-added">394             } else {</span>
<span class="line-added">395                 creds = ref.getCreds();</span>
<span class="line-added">396                 toRealm = ref.getToRealm();</span>
<span class="line-added">397                 isReferral = true;</span>
<span class="line-added">398             }</span>
<span class="line-added">399             if (isReferral) {</span>
<span class="line-added">400                 if (s4u2Type == S4U2Type.PROXY) {</span>
<span class="line-added">401                     Credentials[] credsInOut =</span>
<span class="line-added">402                             new Credentials[] {creds, null};</span>
<span class="line-added">403                     toRealm = handleS4U2ProxyReferral(asCreds,</span>
<span class="line-added">404                             credsInOut, sname);</span>
<span class="line-added">405                     creds = credsInOut[0];</span>
<span class="line-added">406                     if (additionalTickets == null ||</span>
<span class="line-added">407                             additionalTickets.length == 0 ||</span>
<span class="line-added">408                             credsInOut[1] == null) {</span>
<span class="line-added">409                         throw new KrbException(&quot;Additional tickets expected&quot; +</span>
<span class="line-added">410                                 &quot; for S4U2Proxy.&quot;);</span>
<span class="line-added">411                     }</span>
<span class="line-added">412                     additionalTickets[0] = credsInOut[1].getTicket();</span>
<span class="line-added">413                 } else if (s4u2Type == S4U2Type.SELF) {</span>
<span class="line-added">414                     handleS4U2SelfReferral(extraPAs, asCreds, creds);</span>
<span class="line-added">415                 }</span>
<span class="line-added">416                 if (referrals.contains(toRealm)) {</span>
<span class="line-added">417                     // Referrals loop detected</span>
<span class="line-added">418                     return null;</span>
<span class="line-added">419                 }</span>
<span class="line-added">420                 asCreds = creds;</span>
<span class="line-added">421                 refSname = new PrincipalName(refSname.getNameString(),</span>
<span class="line-added">422                         refSname.getNameType(), toRealm);</span>
<span class="line-added">423                 referrals.add(toRealm);</span>
<span class="line-added">424                 isReferral = false;</span>
<span class="line-added">425                 continue;</span>
<span class="line-added">426             }</span>
<span class="line-added">427             break;</span>
<span class="line-added">428         }</span>
<span class="line-added">429         return creds;</span>
<span class="line-added">430     }</span>
<span class="line-added">431 </span>
<span class="line-added">432     /*</span>
<span class="line-added">433      * Obtains credentials for a service (TGS).</span>
<span class="line-added">434      * If the service realm is different than the one in the TGT, a new TGT for</span>
<span class="line-added">435      * the service realm is obtained first (see getTGTforRealm call). This is</span>
<span class="line-added">436      * not expected when following cross-realm referrals because the referral</span>
<span class="line-added">437      * TGT realm matches the service realm.</span>
<span class="line-added">438      */</span>
<span class="line-added">439     private static Credentials serviceCredsSingle(</span>
<span class="line-added">440             KDCOptions options, Credentials asCreds,</span>
<span class="line-added">441             PrincipalName cname, PrincipalName clientAlias,</span>
<span class="line-added">442             PrincipalName refSname, PrincipalName sname,</span>
<span class="line-added">443             S4U2Type s4u2Type, Ticket[] additionalTickets,</span>
<span class="line-added">444             PAData[] extraPAs)</span>
<span class="line-added">445                     throws KrbException, IOException {</span>
<span class="line-added">446         Credentials theCreds = null;</span>
<span class="line-added">447         boolean[] okAsDelegate = new boolean[]{true};</span>
<span class="line-added">448         String[] serverAsCredsNames = asCreds.getServer().getNameStrings();</span>
<span class="line-added">449         String tgtRealm = serverAsCredsNames[1];</span>
<span class="line-added">450         String serviceRealm = refSname.getRealmString();</span>
<span class="line-added">451         if (!serviceRealm.equals(tgtRealm)) {</span>
<span class="line-added">452             // This is a cross-realm service request</span>
<span class="line-added">453             if (DEBUG) {</span>
<span class="line-added">454                 System.out.println(&quot;&gt;&gt;&gt; serviceCredsSingle:&quot; +</span>
<span class="line-added">455                         &quot; cross-realm authentication&quot;);</span>
<span class="line-added">456                 System.out.println(&quot;&gt;&gt;&gt; serviceCredsSingle:&quot; +</span>
<span class="line-added">457                         &quot; obtaining credentials from &quot; + tgtRealm +</span>
<span class="line-added">458                         &quot; to &quot; + serviceRealm);</span>
<span class="line-added">459             }</span>
<span class="line-added">460             Credentials newTgt = getTGTforRealm(tgtRealm, serviceRealm,</span>
<span class="line-added">461                     asCreds, okAsDelegate);</span>
<span class="line-added">462             if (newTgt == null) {</span>
<span class="line-added">463                 throw new KrbApErrException(Krb5.KRB_AP_ERR_GEN_CRED,</span>
<span class="line-added">464                         &quot;No service creds&quot;);</span>
<span class="line-added">465             }</span>
<span class="line-added">466             if (DEBUG) {</span>
<span class="line-added">467                 System.out.println(&quot;&gt;&gt;&gt; Cross-realm TGT Credentials&quot; +</span>
<span class="line-added">468                         &quot; serviceCredsSingle: &quot;);</span>
<span class="line-added">469                 Credentials.printDebug(newTgt);</span>
<span class="line-added">470             }</span>
<span class="line-added">471             if (s4u2Type == S4U2Type.SELF) {</span>
<span class="line-added">472                 handleS4U2SelfReferral(extraPAs, asCreds, newTgt);</span>
<span class="line-added">473             }</span>
<span class="line-added">474             asCreds = newTgt;</span>
<span class="line-added">475             cname = asCreds.getClient();</span>
<span class="line-added">476         } else if (DEBUG) {</span>
<span class="line-added">477             System.out.println(&quot;&gt;&gt;&gt; Credentials serviceCredsSingle:&quot; +</span>
<span class="line-added">478                     &quot; same realm&quot;);</span>
<span class="line-added">479         }</span>
<span class="line-added">480         KrbTgsReq req = new KrbTgsReq(options, asCreds, cname, clientAlias,</span>
<span class="line-added">481                 refSname, sname, additionalTickets, extraPAs);</span>
<span class="line-added">482         theCreds = req.sendAndGetCreds();</span>
<span class="line-added">483         if (theCreds != null) {</span>
<span class="line-added">484             if (DEBUG) {</span>
<span class="line-added">485                 System.out.println(&quot;&gt;&gt;&gt; TGS credentials serviceCredsSingle:&quot;);</span>
<span class="line-added">486                 Credentials.printDebug(theCreds);</span>
<span class="line-added">487             }</span>
<span class="line-added">488             if (!okAsDelegate[0]) {</span>
<span class="line-added">489                 theCreds.resetDelegate();</span>
<span class="line-added">490             }</span>
<span class="line-added">491         }</span>
<span class="line-added">492         return theCreds;</span>
<span class="line-added">493     }</span>
<span class="line-added">494 </span>
<span class="line-added">495     /**</span>
<span class="line-added">496      * PA-FOR-USER may need to be regenerated if credentials</span>
<span class="line-added">497      * change. This may happen when obtaining a TGT for a</span>
<span class="line-added">498      * different realm or when using a referral TGT.</span>
<span class="line-added">499      */</span>
<span class="line-added">500     private static void handleS4U2SelfReferral(PAData[] pas,</span>
<span class="line-added">501             Credentials oldCeds, Credentials newCreds)</span>
<span class="line-added">502                     throws Asn1Exception, KrbException, IOException {</span>
<span class="line-added">503         if (DEBUG) {</span>
<span class="line-added">504             System.out.println(&quot;&gt;&gt;&gt; Handling S4U2Self referral&quot;);</span>
<span class="line-added">505         }</span>
<span class="line-added">506         for (int i = 0; i &lt; pas.length; i++) {</span>
<span class="line-added">507             PAData pa = pas[i];</span>
<span class="line-added">508             if (pa.getType() == Krb5.PA_FOR_USER) {</span>
<span class="line-added">509                 PAForUserEnc paForUser = new PAForUserEnc(</span>
<span class="line-added">510                         new DerValue(pa.getValue()),</span>
<span class="line-added">511                         oldCeds.getSessionKey());</span>
<span class="line-added">512                 pas[i] = new PAData(Krb5.PA_FOR_USER,</span>
<span class="line-added">513                         new PAForUserEnc(paForUser.getName(),</span>
<span class="line-added">514                                 newCreds.getSessionKey()).asn1Encode());</span>
<span class="line-added">515                 break;</span>
<span class="line-added">516             }</span>
<span class="line-added">517         }</span>
<span class="line-added">518     }</span>
<span class="line-added">519 </span>
<span class="line-added">520     /**</span>
<span class="line-added">521      * This method is called after receiving the first realm referral for</span>
<span class="line-added">522      * a S4U2Proxy request. The credentials and tickets needed for the</span>
<span class="line-added">523      * final S4U2Proxy request (in the referrals chain) are returned.</span>
<span class="line-added">524      *</span>
<span class="line-added">525      * Referrals are handled as described by MS-SFU (section 3.1.5.2.2</span>
<span class="line-added">526      * Receives Referral).</span>
<span class="line-added">527      *</span>
<span class="line-added">528      * @param asCreds middle service credentials used for the first S4U2Proxy</span>
<span class="line-added">529      *        request</span>
<span class="line-added">530      * @param credsInOut (in/out parameter):</span>
<span class="line-added">531      *         * input: first S4U2Proxy referral TGT received, null</span>
<span class="line-added">532      *         * output: referral TGT for final S4U2Proxy service request,</span>
<span class="line-added">533      *                   client referral TGT for final S4U2Proxy service request</span>
<span class="line-added">534      *                   (to be sent as additional-ticket)</span>
<span class="line-added">535      * @param sname the backend service name</span>
<span class="line-added">536      * @param additionalTickets (out parameter): the additional ticket for the</span>
<span class="line-added">537      *        last S4U2Proxy request is returned</span>
<span class="line-added">538      * @return the backend realm for the last S4U2Proxy request</span>
<span class="line-added">539      */</span>
<span class="line-added">540     private static String handleS4U2ProxyReferral(Credentials asCreds,</span>
<span class="line-added">541             Credentials[] credsInOut, PrincipalName sname)</span>
<span class="line-added">542                     throws KrbException, IOException {</span>
<span class="line-added">543         if (DEBUG) {</span>
<span class="line-added">544             System.out.println(&quot;&gt;&gt;&gt; Handling S4U2Proxy referral&quot;);</span>
<span class="line-added">545         }</span>
<span class="line-added">546         Credentials refTGT = null;</span>
<span class="line-added">547         // Get a credential for the middle service to the backend so we know</span>
<span class="line-added">548         // the backend realm, as described in MS-SFU (section 3.1.5.2.2).</span>
<span class="line-added">549         Credentials middleSvcCredsInBackendRealm =</span>
<span class="line-added">550                 serviceCreds(sname, asCreds);</span>
<span class="line-added">551         String backendRealm =</span>
<span class="line-added">552                 middleSvcCredsInBackendRealm.getServer().getRealmString();</span>
<span class="line-added">553         String toRealm = credsInOut[0].getServer().getNameStrings()[1];</span>
<span class="line-added">554         if (!toRealm.equals(backendRealm)) {</span>
<span class="line-added">555             // More than 1 hop. Follow the referrals chain and obtain a</span>
<span class="line-added">556             // TGT for the backend realm.</span>
<span class="line-added">557             refTGT = getTGTforRealm(toRealm, backendRealm, credsInOut[0],</span>
<span class="line-added">558                     new boolean[1]);</span>
<span class="line-added">559         } else {</span>
<span class="line-added">560             // There was only 1 hop. The referral TGT received is already</span>
<span class="line-added">561             // for the backend realm.</span>
<span class="line-added">562             refTGT = credsInOut[0];</span>
<span class="line-added">563         }</span>
<span class="line-added">564         credsInOut[0] = getTGTforRealm(asCreds.getClient().getRealmString(),</span>
<span class="line-added">565                 backendRealm, asCreds, new boolean[1]);</span>
<span class="line-added">566         credsInOut[1] = refTGT;</span>
<span class="line-added">567         return backendRealm;</span>
568     }
569 }
</pre>
</td>
</tr>
</table>
<center><a href="../Realm.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ETypeInfo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>