<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5MechFactory.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.jgss.krb5;
 27 
 28 import org.ietf.jgss.*;
 29 import sun.security.jgss.GSSUtil;
 30 import sun.security.jgss.GSSCaller;
 31 import sun.security.jgss.spi.*;
 32 import javax.security.auth.kerberos.ServicePermission;
 33 import java.security.Provider;
 34 import java.util.Vector;
 35 
 36 /**
 37  * Krb5 Mechanism plug in for JGSS
 38  * This is the properties object required by the JGSS framework.
 39  * All mechanism specific information is defined here.
 40  *
 41  * @author Mayank Upadhyay
 42  */
 43 
 44 public final class Krb5MechFactory implements MechanismFactory {
 45 
 46     private static final boolean DEBUG = Krb5Util.DEBUG;
 47 
 48     static final Provider PROVIDER =
 49         new sun.security.jgss.SunProvider();
 50 
 51     static final Oid GSS_KRB5_MECH_OID =
 52         createOid(&quot;1.2.840.113554.1.2.2&quot;);
 53 
 54     static final Oid NT_GSS_KRB5_PRINCIPAL =
 55         createOid(&quot;1.2.840.113554.1.2.2.1&quot;);
 56 
 57     private static Oid[] nameTypes =
 58         new Oid[] { GSSName.NT_USER_NAME,
 59                         GSSName.NT_HOSTBASED_SERVICE,
 60                         GSSName.NT_EXPORT_NAME,
 61                         NT_GSS_KRB5_PRINCIPAL};
 62 
 63     final private GSSCaller caller;
 64 
 65     private static Krb5CredElement getCredFromSubject(GSSNameSpi name,
 66                                                       boolean initiate)
 67         throws GSSException {
 68         Vector&lt;Krb5CredElement&gt; creds =
 69             GSSUtil.searchSubject(name, GSS_KRB5_MECH_OID, initiate,
 70                                   (initiate ?
 71                                    Krb5InitCredential.class :
 72                                    Krb5AcceptCredential.class));
 73 
 74         Krb5CredElement result = ((creds == null || creds.isEmpty()) ?
 75                                   null : creds.firstElement());
 76 
 77         // Force permission check before returning the cred to caller
 78         if (result != null) {
 79             if (initiate) {
 80                 checkInitCredPermission((Krb5NameElement) result.getName());
 81             } else {
 82                 checkAcceptCredPermission
 83                     ((Krb5NameElement) result.getName(), name);
 84             }
 85         }
 86         return result;
 87     }
 88 
 89     public Krb5MechFactory() {
 90         this(GSSCaller.CALLER_UNKNOWN);
 91     }
 92 
 93     public Krb5MechFactory(GSSCaller caller) {
 94         this.caller = caller;
 95     }
 96 
 97     public GSSNameSpi getNameElement(String nameStr, Oid nameType)
 98         throws GSSException {
 99         return Krb5NameElement.getInstance(nameStr, nameType);
100     }
101 
102     public GSSNameSpi getNameElement(byte[] name, Oid nameType)
103         throws GSSException {
104         // At this point, even an exported name is stripped down to safe
105         // bytes only
106         // XXX Use encoding here
107         return Krb5NameElement.getInstance(new String(name), nameType);
108     }
109 
110     public GSSCredentialSpi getCredentialElement(GSSNameSpi name,
111            int initLifetime, int acceptLifetime,
112            int usage) throws GSSException {
113 
114         if (name != null &amp;&amp; !(name instanceof Krb5NameElement)) {
115             name = Krb5NameElement.getInstance(name.toString(),
116                                        name.getStringNameType());
117         }
118 
119         Krb5CredElement credElement = getCredFromSubject
120             (name, (usage != GSSCredential.ACCEPT_ONLY));
121 
122         if (credElement == null) {
123             if (usage == GSSCredential.INITIATE_ONLY ||
124                 usage == GSSCredential.INITIATE_AND_ACCEPT) {
125                 credElement = Krb5InitCredential.getInstance
126                     (caller, (Krb5NameElement) name, initLifetime);
<a name="2" id="anc2"></a>

127                 checkInitCredPermission
128                     ((Krb5NameElement) credElement.getName());
129             } else if (usage == GSSCredential.ACCEPT_ONLY) {
130                 credElement =
131                     Krb5AcceptCredential.getInstance(caller,
132                                                      (Krb5NameElement) name);
133                 checkAcceptCredPermission
134                     ((Krb5NameElement) credElement.getName(), name);
135             } else
136                 throw new GSSException(GSSException.FAILURE, -1,
137                                        &quot;Unknown usage mode requested&quot;);
138         }
139         return credElement;
140     }
141 
142     public static void checkInitCredPermission(Krb5NameElement name) {
143         SecurityManager sm = System.getSecurityManager();
144         if (sm != null) {
145             String realm = (name.getKrb5PrincipalName()).getRealmAsString();
146             String tgsPrincipal =
147                 new String(&quot;krbtgt/&quot; + realm + &#39;@&#39; + realm);
148             ServicePermission perm =
149                 new ServicePermission(tgsPrincipal, &quot;initiate&quot;);
150             try {
151                 sm.checkPermission(perm);
152             } catch (SecurityException e) {
153                 if (DEBUG) {
154                     System.out.println(&quot;Permission to initiate&quot; +
155                         &quot;kerberos init credential&quot; + e.getMessage());
156                 }
157                 throw e;
158             }
159         }
160     }
161 
162     public static void checkAcceptCredPermission(Krb5NameElement name,
163                                            GSSNameSpi originalName) {
164         SecurityManager sm = System.getSecurityManager();
165         if (sm != null &amp;&amp; name != null) {
166             ServicePermission perm = new ServicePermission
167                 (name.getKrb5PrincipalName().getName(), &quot;accept&quot;);
168             try {
169                 sm.checkPermission(perm);
170             } catch (SecurityException e) {
171                 if (originalName == null) {
172                     // Don&#39;t disclose the name of the principal
173                     e = new SecurityException(&quot;No permission to acquire &quot;
174                                       + &quot;Kerberos accept credential&quot;);
175                     // Don&#39;t call e.initCause() with caught exception
176                 }
177                 throw e;
178             }
179         }
180     }
181 
182     public GSSContextSpi getMechanismContext(GSSNameSpi peer,
183                              GSSCredentialSpi myInitiatorCred, int lifetime)
184         throws GSSException {
185         if (peer != null &amp;&amp; !(peer instanceof Krb5NameElement)) {
186             peer = Krb5NameElement.getInstance(peer.toString(),
187                                        peer.getStringNameType());
188         }
189         // XXX Convert myInitiatorCred to Krb5CredElement
190         if (myInitiatorCred == null) {
191             myInitiatorCred = getCredentialElement(null, lifetime, 0,
192                 GSSCredential.INITIATE_ONLY);
193         }
194         return new Krb5Context(caller, (Krb5NameElement)peer,
195                                (Krb5CredElement)myInitiatorCred, lifetime);
196     }
197 
198     public GSSContextSpi getMechanismContext(GSSCredentialSpi myAcceptorCred)
199         throws GSSException {
200         // XXX Convert myAcceptorCred to Krb5CredElement
201         if (myAcceptorCred == null) {
202             myAcceptorCred = getCredentialElement(null, 0,
203                 GSSCredential.INDEFINITE_LIFETIME, GSSCredential.ACCEPT_ONLY);
204         }
205         return new Krb5Context(caller, (Krb5CredElement)myAcceptorCred);
206     }
207 
208     public GSSContextSpi getMechanismContext(byte[] exportedContext)
209         throws GSSException {
210         return new Krb5Context(caller, exportedContext);
211     }
212 
213 
214     public final Oid getMechanismOid() {
215         return GSS_KRB5_MECH_OID;
216     }
217 
218     public Provider getProvider() {
219         return PROVIDER;
220     }
221 
222     public Oid[] getNameTypes() {
223         // nameTypes is cloned in GSSManager.getNamesForMech
224         return nameTypes;
225     }
226 
227     private static Oid createOid(String oidStr) {
228         Oid retVal = null;
229         try {
230             retVal = new Oid(oidStr);
231         } catch (GSSException e) {
232             // Should not happen!
233         }
234         return retVal;
235     }
236 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>