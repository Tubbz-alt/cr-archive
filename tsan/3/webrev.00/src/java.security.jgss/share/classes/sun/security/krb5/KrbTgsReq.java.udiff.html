<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.jgss/share/classes/sun/security/krb5/KrbTgsReq.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbTgsRep.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PrincipalName.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbTgsReq.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,121 +34,94 @@</span>
  import sun.security.krb5.internal.*;
  import sun.security.krb5.internal.crypto.*;
  import java.io.IOException;
  import java.net.UnknownHostException;
  import java.time.Instant;
<span class="udiff-line-added">+ import java.util.Arrays;</span>
  
  /**
   * This class encapsulates a Kerberos TGS-REQ that is sent from the
   * client to the KDC.
   */
  public class KrbTgsReq {
  
      private PrincipalName princName;
<span class="udiff-line-added">+     private PrincipalName clientAlias;</span>
      private PrincipalName servName;
<span class="udiff-line-added">+     private PrincipalName serverAlias;</span>
      private TGSReq tgsReqMessg;
      private KerberosTime ctime;
      private Ticket secondTicket = null;
      private boolean useSubkey = false;
      EncryptionKey tgsReqKey;
  
<span class="udiff-line-removed">-     private static final boolean DEBUG = Krb5.DEBUG;</span>
<span class="udiff-line-removed">- </span>
      private byte[] obuf;
      private byte[] ibuf;
  
      // Used in CredentialsUtil
<span class="udiff-line-modified-removed">-     public KrbTgsReq(Credentials asCreds,</span>
<span class="udiff-line-modified-removed">-                      PrincipalName sname)</span>
<span class="udiff-line-modified-added">+     public KrbTgsReq(KDCOptions options, Credentials asCreds,</span>
<span class="udiff-line-modified-added">+             PrincipalName cname, PrincipalName clientAlias,</span>
<span class="udiff-line-added">+             PrincipalName sname, PrincipalName serverAlias,</span>
<span class="udiff-line-added">+             Ticket[] additionalTickets, PAData[] extraPAs)</span>
          throws KrbException, IOException {
<span class="udiff-line-modified-removed">-         this(new KDCOptions(),</span>
<span class="udiff-line-modified-removed">-             asCreds,</span>
<span class="udiff-line-modified-removed">-             sname,</span>
<span class="udiff-line-modified-removed">-             null, // KerberosTime from</span>
<span class="udiff-line-modified-removed">-             null, // KerberosTime till</span>
<span class="udiff-line-modified-removed">-             null, // KerberosTime rtime</span>
<span class="udiff-line-modified-removed">-             null, // eTypes, // null, // int[] eTypes</span>
<span class="udiff-line-modified-removed">-             null, // HostAddresses addresses</span>
<span class="udiff-line-modified-removed">-             null, // AuthorizationData authorizationData</span>
<span class="udiff-line-modified-removed">-             null, // Ticket[] additionalTickets</span>
<span class="udiff-line-modified-removed">-             null); // EncryptionKey subSessionKey</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // S4U2proxy</span>
<span class="udiff-line-modified-removed">-     public KrbTgsReq(Credentials asCreds,</span>
<span class="udiff-line-removed">-                      Ticket second,</span>
<span class="udiff-line-removed">-                      PrincipalName sname)</span>
<span class="udiff-line-removed">-             throws KrbException, IOException {</span>
<span class="udiff-line-removed">-         this(KDCOptions.with(KDCOptions.CNAME_IN_ADDL_TKT,</span>
<span class="udiff-line-removed">-                 KDCOptions.FORWARDABLE),</span>
<span class="udiff-line-removed">-             asCreds,</span>
<span class="udiff-line-removed">-             sname,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             new Ticket[] {second}, // the service ticket</span>
<span class="udiff-line-removed">-             null);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // S4U2user</span>
<span class="udiff-line-removed">-     public KrbTgsReq(Credentials asCreds,</span>
<span class="udiff-line-removed">-                      PrincipalName sname,</span>
<span class="udiff-line-removed">-                      PAData extraPA)</span>
<span class="udiff-line-removed">-         throws KrbException, IOException {</span>
<span class="udiff-line-removed">-         this(KDCOptions.with(KDCOptions.FORWARDABLE),</span>
<span class="udiff-line-removed">-             asCreds,</span>
<span class="udiff-line-removed">-             asCreds.getClient(),</span>
<span class="udiff-line-removed">-             sname,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             null,</span>
<span class="udiff-line-removed">-             extraPA); // the PA-FOR-USER</span>
<span class="udiff-line-modified-added">+         this(options,</span>
<span class="udiff-line-modified-added">+              asCreds,</span>
<span class="udiff-line-modified-added">+              cname,</span>
<span class="udiff-line-modified-added">+              clientAlias,</span>
<span class="udiff-line-modified-added">+              sname,</span>
<span class="udiff-line-modified-added">+              serverAlias,</span>
<span class="udiff-line-modified-added">+              null, // KerberosTime from</span>
<span class="udiff-line-modified-added">+              null, // KerberosTime till</span>
<span class="udiff-line-modified-added">+              null, // KerberosTime rtime</span>
<span class="udiff-line-modified-added">+              null, // int[] eTypes</span>
<span class="udiff-line-modified-added">+              null, // HostAddresses addresses</span>
<span class="udiff-line-modified-added">+              null, // AuthorizationData authorizationData</span>
<span class="udiff-line-modified-added">+              additionalTickets,</span>
<span class="udiff-line-modified-added">+              null, // EncryptionKey subKey</span>
<span class="udiff-line-modified-added">+              extraPAs);</span>
      }
  
      // Called by Credentials, KrbCred
      KrbTgsReq(
              KDCOptions options,
              Credentials asCreds,
              PrincipalName sname,
<span class="udiff-line-added">+             PrincipalName serverAlias,</span>
              KerberosTime from,
              KerberosTime till,
              KerberosTime rtime,
              int[] eTypes,
              HostAddresses addresses,
              AuthorizationData authorizationData,
              Ticket[] additionalTickets,
              EncryptionKey subKey) throws KrbException, IOException {
<span class="udiff-line-modified-removed">-         this(options, asCreds, asCreds.getClient(), sname,</span>
<span class="udiff-line-modified-removed">-                 from, till, rtime, eTypes, addresses,</span>
<span class="udiff-line-modified-removed">-                 authorizationData, additionalTickets, subKey, null);</span>
<span class="udiff-line-modified-added">+         this(options, asCreds, asCreds.getClient(), asCreds.getClientAlias(),</span>
<span class="udiff-line-modified-added">+                 sname, serverAlias, from, till, rtime, eTypes,</span>
<span class="udiff-line-modified-added">+                 addresses, authorizationData, additionalTickets, subKey, null);</span>
      }
  
      private KrbTgsReq(
              KDCOptions options,
              Credentials asCreds,
              PrincipalName cname,
<span class="udiff-line-added">+             PrincipalName clientAlias,</span>
              PrincipalName sname,
<span class="udiff-line-added">+             PrincipalName serverAlias,</span>
              KerberosTime from,
              KerberosTime till,
              KerberosTime rtime,
              int[] eTypes,
              HostAddresses addresses,
              AuthorizationData authorizationData,
              Ticket[] additionalTickets,
              EncryptionKey subKey,
<span class="udiff-line-modified-removed">-             PAData extraPA) throws KrbException, IOException {</span>
<span class="udiff-line-modified-added">+             PAData[] extraPAs) throws KrbException, IOException {</span>
  
          princName = cname;
<span class="udiff-line-added">+         this.clientAlias = clientAlias;</span>
          servName = sname;
<span class="udiff-line-added">+         this.serverAlias = serverAlias;</span>
          ctime = KerberosTime.now();
  
          // check if they are valid arguments. The optional fields
          // should be consistent with settings in KDCOptions.
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,11 +187,11 @@</span>
                  eTypes,
                  addresses,
                  authorizationData,
                  additionalTickets,
                  subKey,
<span class="udiff-line-modified-removed">-                 extraPA);</span>
<span class="udiff-line-modified-added">+                 extraPAs);</span>
          obuf = tgsReqMessg.asn1Encode();
  
          // XXX We need to revisit this to see if can&#39;t move it
          // up such that FORWARDED flag set in the options
          // is included in the marshaled request.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -280,11 +253,11 @@</span>
                           int[] eTypes,
                           HostAddresses addresses,
                           AuthorizationData authorizationData,
                           Ticket[] additionalTickets,
                           EncryptionKey subKey,
<span class="udiff-line-modified-removed">-                          PAData extraPA)</span>
<span class="udiff-line-modified-added">+                          PAData[] extraPAs)</span>
          throws IOException, KrbException, UnknownHostException {
          KerberosTime req_till = null;
          if (till == null) {
              String d = Config.getInstance().get(&quot;libdefaults&quot;, &quot;ticket_lifetime&quot;);
              if (d != null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -343,32 +316,12 @@</span>
                                              additionalTickets);
  
          byte[] temp = reqBody.asn1Encode(Krb5.KRB_TGS_REQ);
          // if the checksum type is one of the keyed checksum types,
          // use session key.
<span class="udiff-line-modified-removed">-         Checksum cksum;</span>
<span class="udiff-line-removed">-         switch (Checksum.CKSUMTYPE_DEFAULT) {</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_RSA_MD4_DES:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_DES_MAC:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_DES_MAC_K:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_RSA_MD4_DES_K:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_RSA_MD5_DES:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_SHA1_DES3_KD:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_MD5_ARCFOUR:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES128:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES256:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_SHA256_128_AES128:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_HMAC_SHA384_192_AES256:</span>
<span class="udiff-line-removed">-             cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp, key,</span>
<span class="udiff-line-modified-added">+         Checksum cksum  = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp, key,</span>
                  KeyUsage.KU_PA_TGS_REQ_CKSUM);
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_CRC32:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_RSA_MD4:</span>
<span class="udiff-line-removed">-         case Checksum.CKSUMTYPE_RSA_MD5:</span>
<span class="udiff-line-removed">-         default:</span>
<span class="udiff-line-removed">-             cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp);</span>
<span class="udiff-line-removed">-         }</span>
  
          // Usage will be KeyUsage.KU_PA_TGS_REQ_AUTHENTICATOR
  
          byte[] tgs_ap_req = new KrbApReq(
                                           new APOptions(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,25 +333,36 @@</span>
                                           reqKey,
                                           null,
                                           null).getMessage();
  
          PAData tgsPAData = new PAData(Krb5.PA_TGS_REQ, tgs_ap_req);
<span class="udiff-line-modified-removed">-         return new TGSReq(</span>
<span class="udiff-line-modified-removed">-                 extraPA != null ?</span>
<span class="udiff-line-modified-removed">-                     new PAData[] {extraPA, tgsPAData } :</span>
<span class="udiff-line-modified-removed">-                     new PAData[] {tgsPAData},</span>
<span class="udiff-line-modified-removed">-                 reqBody);</span>
<span class="udiff-line-modified-added">+         PAData[] pa;</span>
<span class="udiff-line-modified-added">+         if (extraPAs != null) {</span>
<span class="udiff-line-modified-added">+             pa = Arrays.copyOf(extraPAs, extraPAs.length + 1);</span>
<span class="udiff-line-modified-added">+             pa[extraPAs.length] = tgsPAData;</span>
<span class="udiff-line-modified-added">+         } else {</span>
<span class="udiff-line-added">+             pa = new PAData[] {tgsPAData};</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return new TGSReq(pa, reqBody);</span>
      }
  
      TGSReq getMessage() {
          return tgsReqMessg;
      }
  
      Ticket getSecondTicket() {
          return secondTicket;
      }
  
<span class="udiff-line-added">+     PrincipalName getClientAlias() {</span>
<span class="udiff-line-added">+         return clientAlias;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     PrincipalName getServerAlias() {</span>
<span class="udiff-line-added">+         return serverAlias;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static void debug(String message) {
          //      System.err.println(&quot;&gt;&gt;&gt; KrbTgsReq: &quot; + message);
      }
  
      boolean usedSubkey() {
</pre>
<center><a href="KrbTgsRep.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PrincipalName.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>