<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.security.jgss/share/classes/sun/security/krb5/Credentials.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  *
 28  *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 29  *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 30  */
 31 
 32 package sun.security.krb5;
 33 
 34 import sun.security.action.GetPropertyAction;
 35 import sun.security.krb5.internal.*;
 36 import sun.security.krb5.internal.ccache.CredentialsCache;
 37 import sun.security.krb5.internal.crypto.EType;
 38 import java.io.IOException;
 39 import java.util.Date;
 40 import java.util.Locale;
 41 import java.net.InetAddress;
 42 
 43 /**
 44  * This class encapsulates the concept of a Kerberos service
 45  * credential. That includes a Kerberos ticket and an associated
 46  * session key.
 47  */
 48 public class Credentials {
 49 
 50     Ticket ticket;
 51     PrincipalName client;
<a name="2" id="anc2"></a><span class="line-added"> 52     PrincipalName clientAlias;</span>
 53     PrincipalName server;
<a name="3" id="anc3"></a><span class="line-added"> 54     PrincipalName serverAlias;</span>
 55     EncryptionKey key;
 56     TicketFlags flags;
 57     KerberosTime authTime;
 58     KerberosTime startTime;
 59     KerberosTime endTime;
 60     KerberosTime renewTill;
 61     HostAddresses cAddr;
<a name="4" id="anc4"></a>
 62     AuthorizationData authzData;
 63     private static boolean DEBUG = Krb5.DEBUG;
 64     private static CredentialsCache cache;
 65     static boolean alreadyLoaded = false;
 66     private static boolean alreadyTried = false;
 67 
<a name="5" id="anc5"></a><span class="line-added"> 68     private Credentials proxy = null;</span>
<span class="line-added"> 69 </span>
<span class="line-added"> 70     public Credentials getProxy() {</span>
<span class="line-added"> 71         return proxy;</span>
<span class="line-added"> 72     }</span>
<span class="line-added"> 73 </span>
<span class="line-added"> 74     public Credentials setProxy(Credentials proxy) {</span>
<span class="line-added"> 75         this.proxy = proxy;</span>
<span class="line-added"> 76         return this;</span>
<span class="line-added"> 77     }</span>
<span class="line-added"> 78 </span>
 79     // Read native ticket with session key type in the given list
 80     private static native Credentials acquireDefaultNativeCreds(int[] eTypes);
 81 
 82     public Credentials(Ticket new_ticket,
 83                        PrincipalName new_client,
<a name="6" id="anc6"></a><span class="line-added"> 84                        PrincipalName new_client_alias,</span>
 85                        PrincipalName new_server,
<a name="7" id="anc7"></a><span class="line-added"> 86                        PrincipalName new_server_alias,</span>
 87                        EncryptionKey new_key,
 88                        TicketFlags new_flags,
 89                        KerberosTime authTime,
 90                        KerberosTime new_startTime,
 91                        KerberosTime new_endTime,
 92                        KerberosTime renewTill,
 93                        HostAddresses cAddr,
 94                        AuthorizationData authzData) {
<a name="8" id="anc8"></a><span class="line-modified"> 95         this(new_ticket, new_client, new_client_alias, new_server,</span>
<span class="line-modified"> 96                 new_server_alias, new_key, new_flags, authTime,</span>
<span class="line-added"> 97                 new_startTime, new_endTime, renewTill, cAddr);</span>
 98         this.authzData = authzData;
 99     }
100 
<a name="9" id="anc9"></a><span class="line-added">101     // Warning: called by NativeCreds.c and nativeccache.c</span>
102     public Credentials(Ticket new_ticket,
103                        PrincipalName new_client,
<a name="10" id="anc10"></a><span class="line-added">104                        PrincipalName new_client_alias,</span>
105                        PrincipalName new_server,
<a name="11" id="anc11"></a><span class="line-added">106                        PrincipalName new_server_alias,</span>
107                        EncryptionKey new_key,
108                        TicketFlags new_flags,
109                        KerberosTime authTime,
110                        KerberosTime new_startTime,
111                        KerberosTime new_endTime,
112                        KerberosTime renewTill,
113                        HostAddresses cAddr) {
114         ticket = new_ticket;
115         client = new_client;
<a name="12" id="anc12"></a><span class="line-added">116         clientAlias = new_client_alias;</span>
117         server = new_server;
<a name="13" id="anc13"></a><span class="line-added">118         serverAlias = new_server_alias;</span>
119         key = new_key;
120         flags = new_flags;
121         this.authTime = authTime;
122         startTime = new_startTime;
123         endTime = new_endTime;
124         this.renewTill = renewTill;
125         this.cAddr = cAddr;
126     }
127 
128     public Credentials(byte[] encoding,
129                        String client,
<a name="14" id="anc14"></a><span class="line-added">130                        String clientAlias,</span>
131                        String server,
<a name="15" id="anc15"></a><span class="line-added">132                        String serverAlias,</span>
133                        byte[] keyBytes,
134                        int keyType,
135                        boolean[] flags,
136                        Date authTime,
137                        Date startTime,
138                        Date endTime,
139                        Date renewTill,
140                        InetAddress[] cAddrs) throws KrbException, IOException {
141         this(new Ticket(encoding),
142              new PrincipalName(client, PrincipalName.KRB_NT_PRINCIPAL),
<a name="16" id="anc16"></a><span class="line-added">143              (clientAlias == null? null : new PrincipalName(clientAlias,</span>
<span class="line-added">144                      PrincipalName.KRB_NT_PRINCIPAL)),</span>
145              new PrincipalName(server, PrincipalName.KRB_NT_SRV_INST),
<a name="17" id="anc17"></a><span class="line-added">146              (serverAlias == null? null : new PrincipalName(serverAlias,</span>
<span class="line-added">147                      PrincipalName.KRB_NT_SRV_INST)),</span>
148              new EncryptionKey(keyType, keyBytes),
149              (flags == null? null: new TicketFlags(flags)),
150              (authTime == null? null: new KerberosTime(authTime)),
151              (startTime == null? null: new KerberosTime(startTime)),
152              (endTime == null? null: new KerberosTime(endTime)),
153              (renewTill == null? null: new KerberosTime(renewTill)),
154              null); // caddrs are in the encoding at this point
155     }
156 
157     /**
158      * Acquires a service ticket for the specified service
159      * principal. If the service ticket is not already available, it
160      * obtains a new one from the KDC.
161      */
162     /*
163     public Credentials(Credentials tgt, PrincipalName service)
164         throws KrbException {
165     }
166     */
167 
168     public final PrincipalName getClient() {
169         return client;
170     }
171 
<a name="18" id="anc18"></a><span class="line-added">172     public final PrincipalName getClientAlias() {</span>
<span class="line-added">173         return clientAlias;</span>
<span class="line-added">174     }</span>
<span class="line-added">175 </span>
176     public final PrincipalName getServer() {
177         return server;
178     }
179 
<a name="19" id="anc19"></a><span class="line-added">180     public final PrincipalName getServerAlias() {</span>
<span class="line-added">181         return serverAlias;</span>
<span class="line-added">182     }</span>
<span class="line-added">183 </span>
184     public final EncryptionKey getSessionKey() {
185         return key;
186     }
187 
188     public final Date getAuthTime() {
189         if (authTime != null) {
190             return authTime.toDate();
191         } else {
192             return null;
193         }
194     }
195 
196     public final Date getStartTime() {
197         if (startTime != null)
198             {
199                 return startTime.toDate();
200             }
201         return null;
202     }
203 
204     public final Date getEndTime() {
205         if (endTime != null)
206             {
207                 return endTime.toDate();
208             }
209         return null;
210     }
211 
212     public final Date getRenewTill() {
213         if (renewTill != null)
214             {
215                 return renewTill.toDate();
216             }
217         return null;
218     }
219 
220     public final boolean[] getFlags() {
221         if (flags == null) // Can be in a KRB-CRED
222         return null;
223         return flags.toBooleanArray();
224     }
225 
226     public final InetAddress[] getClientAddresses() {
227 
228         if (cAddr == null)
229         return null;
230 
231         return cAddr.getInetAddresses();
232     }
233 
234     public final byte[] getEncoded() {
235         byte[] retVal = null;
236         try {
237             retVal = ticket.asn1Encode();
238         } catch (Asn1Exception e) {
<a name="20" id="anc20"></a><span class="line-modified">239             if (DEBUG) {</span>
<span class="line-modified">240                 System.out.println(e);</span>
<span class="line-added">241             }</span>
242         } catch (IOException ioe) {
<a name="21" id="anc21"></a><span class="line-modified">243             if (DEBUG) {</span>
<span class="line-modified">244                 System.out.println(ioe);</span>
<span class="line-added">245             }</span>
246         }
247         return retVal;
248     }
249 
250     public boolean isForwardable() {
251         return flags.get(Krb5.TKT_OPTS_FORWARDABLE);
252     }
253 
254     public boolean isRenewable() {
255         return flags.get(Krb5.TKT_OPTS_RENEWABLE);
256     }
257 
258     public Ticket getTicket() {
259         return ticket;
260     }
261 
262     public TicketFlags getTicketFlags() {
263         return flags;
264     }
265 
266     public AuthorizationData getAuthzData() {
267         return authzData;
268     }
269     /**
270      * Checks if the service ticket returned by the KDC has the OK-AS-DELEGATE
271      * flag set
272      * @return true if OK-AS_DELEGATE flag is set, otherwise, return false.
273      */
274     public boolean checkDelegate() {
275         return flags.get(Krb5.TKT_OPTS_DELEGATE);
276     }
277 
278     /**
279      * Reset TKT_OPTS_DELEGATE to false, called at credentials acquirement
280      * when one of the cross-realm TGTs does not have the OK-AS-DELEGATE
281      * flag set. This info must be preservable and restorable through
282      * the Krb5Util.credsToTicket/ticketToCreds() methods so that even if
283      * the service ticket is cached it still remembers the cross-realm
284      * authentication result.
285      */
286     public void resetDelegate() {
287         flags.set(Krb5.TKT_OPTS_DELEGATE, false);
288     }
289 
290     public Credentials renew() throws KrbException, IOException {
291         KDCOptions options = new KDCOptions();
292         options.set(KDCOptions.RENEW, true);
293         /*
294          * Added here to pass KrbKdcRep.check:73
295          */
296         options.set(KDCOptions.RENEWABLE, true);
297 
298         return new KrbTgsReq(options,
299                              this,
300                              server,
<a name="22" id="anc22"></a><span class="line-added">301                              serverAlias,</span>
302                              null, // from
303                              null, // till
304                              null, // rtime
305                              null, // eTypes
306                              cAddr,
307                              null,
308                              null,
309                              null).sendAndGetCreds();
310     }
311 
312     /**
313      * Returns a TGT for the given client principal from a ticket cache.
314      *
315      * @param princ the client principal. A value of null means that the
316      * default principal name in the credentials cache will be used.
317      * @param ticketCache the path to the tickets file. A value
318      * of null will be accepted to indicate that the default
319      * path should be searched
320      * @return the TGT credentials or null if none were found. If the tgt
321      * expired, it is the responsibility of the caller to determine this.
322      */
323     public static Credentials acquireTGTFromCache(PrincipalName princ,
324                                                   String ticketCache)
325         throws KrbException, IOException {
326 
327         if (ticketCache == null) {
328             // The default ticket cache on Windows and Mac is not a file.
329             String os = GetPropertyAction.privilegedGetProperty(&quot;os.name&quot;);
330             if (os.toUpperCase(Locale.ENGLISH).startsWith(&quot;WINDOWS&quot;) ||
331                     os.toUpperCase(Locale.ENGLISH).contains(&quot;OS X&quot;)) {
332                 Credentials creds = acquireDefaultCreds();
333                 if (creds == null) {
334                     if (DEBUG) {
<a name="23" id="anc23"></a><span class="line-modified">335                         System.out.println(&quot;&gt;&gt;&gt; Found no TGT&#39;s in native ccache&quot;);</span>
336                     }
337                     return null;
338                 }
339                 if (princ != null) {
340                     if (creds.getClient().equals(princ)) {
341                         if (DEBUG) {
<a name="24" id="anc24"></a><span class="line-modified">342                             System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from native ccache: &quot;</span>
343                                                + creds);
344                         }
345                         return creds;
346                     } else {
347                         if (DEBUG) {
<a name="25" id="anc25"></a><span class="line-modified">348                             System.out.println(&quot;&gt;&gt;&gt; native ccache contains TGT for &quot;</span>
349                                                + creds.getClient()
350                                                + &quot; not &quot;
351                                                + princ);
352                         }
353                         return null;
354                     }
355                 } else {
356                     if (DEBUG) {
<a name="26" id="anc26"></a><span class="line-modified">357                         System.out.println(&quot;&gt;&gt;&gt; Obtained TGT from native ccache: &quot;</span>
358                                            + creds);
359                     }
360                     return creds;
361                 }
362             }
363         }
364 
365         /*
366          * Returns the appropriate cache. If ticketCache is null, it is the
367          * default cache otherwise it is the cache filename contained in it.
368          */
369         CredentialsCache ccache =
370             CredentialsCache.getInstance(princ, ticketCache);
371 
372         if (ccache == null) {
373             return null;
374         }
375 
<a name="27" id="anc27"></a><span class="line-modified">376         Credentials tgtCred = ccache.getInitialCreds();</span>

377 
378         if (tgtCred == null) {
379             return null;
380         }
381 
<a name="28" id="anc28"></a><span class="line-modified">382         if (EType.isSupported(tgtCred.key.getEType())) {</span>
<span class="line-modified">383             return tgtCred;</span>
384         } else {
385             if (DEBUG) {
386                 System.out.println(
387                     &quot;&gt;&gt;&gt; unsupported key type found the default TGT: &quot; +
<a name="29" id="anc29"></a><span class="line-modified">388                     tgtCred.key.getEType());</span>
389             }
390             return null;
391         }
392     }
393 
394     /**
395      * Acquires default credentials.
396      * &lt;br&gt;The possible locations for default credentials cache is searched in
397      * the following order:
398      * &lt;ol&gt;
399      * &lt;li&gt; The directory and cache file name specified by &quot;KRB5CCNAME&quot; system.
400      * property.
401      * &lt;li&gt; The directory and cache file name specified by &quot;KRB5CCNAME&quot;
402      * environment variable.
403      * &lt;li&gt; A cache file named krb5cc_{user.name} at {user.home} directory.
404      * &lt;/ol&gt;
405      * @return a &lt;code&gt;KrbCreds&lt;/code&gt; object if the credential is found,
406      * otherwise return null.
407      */
408 
409     // this method is intentionally changed to not check if the caller&#39;s
410     // principal name matches cache file&#39;s principal name.
411     // It assumes that the GSS call has
412     // the privilege to access the default cache file.
413 
414     // This method is only called on Windows and Mac OS X, the native
415     // acquireDefaultNativeCreds is also available on these platforms.
416     public static synchronized Credentials acquireDefaultCreds() {
417         Credentials result = null;
418 
419         if (cache == null) {
420             cache = CredentialsCache.getInstance();
421         }
422         if (cache != null) {
<a name="30" id="anc30"></a><span class="line-modified">423             Credentials temp = cache.getInitialCreds();</span>

424             if (temp != null) {
425                 if (DEBUG) {
426                     System.out.println(&quot;&gt;&gt;&gt; KrbCreds found the default ticket&quot;
427                             + &quot; granting ticket in credential cache.&quot;);
428                 }
<a name="31" id="anc31"></a><span class="line-modified">429                 if (EType.isSupported(temp.key.getEType())) {</span>
<span class="line-modified">430                     result = temp;</span>
431                 } else {
432                     if (DEBUG) {
433                         System.out.println(
434                             &quot;&gt;&gt;&gt; unsupported key type found the default TGT: &quot; +
<a name="32" id="anc32"></a><span class="line-modified">435                             temp.key.getEType());</span>
436                     }
437                 }
438             }
439         }
440         if (result == null) {
441             // Doesn&#39;t seem to be a default cache on this system or
442             // TGT has unsupported encryption type
443 
444             if (!alreadyTried) {
445                 // See if there&#39;s any native code to load
446                 try {
447                     ensureLoaded();
448                 } catch (Exception e) {
449                     if (DEBUG) {
<a name="33" id="anc33"></a><span class="line-modified">450                         System.out.println(&quot;Can not load native ccache library&quot;);</span>
451                         e.printStackTrace();
452                     }
453                     alreadyTried = true;
454                 }
455             }
456             if (alreadyLoaded) {
457                 // There is some native code
458                 if (DEBUG) {
459                     System.out.println(&quot;&gt;&gt; Acquire default native Credentials&quot;);
460                 }
461                 try {
462                     result = acquireDefaultNativeCreds(
463                             EType.getDefaults(&quot;default_tkt_enctypes&quot;));
464                 } catch (KrbException ke) {
465                     // when there is no default_tkt_enctypes.
466                 }
467             }
468         }
469         return result;
470     }
471 
472     /**
473      * Acquires credentials for a specified service using initial credential.
474      * When the service has a different realm
475      * from the initial credential, we do cross-realm authentication
476      * - first, we use the current credential to get
477      * a cross-realm credential from the local KDC, then use that
478      * cross-realm credential to request service credential
479      * from the foreigh KDC.
480      *
481      * @param service the name of service principal using format
482      * components@realm
483      * @param ccreds client&#39;s initial credential.
484      * @exception IOException if an error occurs in reading the credentials
485      * cache
486      * @exception KrbException if an error occurs specific to Kerberos
487      * @return a &lt;code&gt;Credentials&lt;/code&gt; object.
488      */
489 
490     public static Credentials acquireServiceCreds(String service,
491                                                   Credentials ccreds)
492         throws KrbException, IOException {
493         return CredentialsUtil.acquireServiceCreds(service, ccreds);
494     }
495 
496     public static Credentials acquireS4U2selfCreds(PrincipalName user,
497             Credentials ccreds) throws KrbException, IOException {
498         return CredentialsUtil.acquireS4U2selfCreds(user, ccreds);
499     }
500 
501     public static Credentials acquireS4U2proxyCreds(String service,
502             Ticket second, PrincipalName client, Credentials ccreds)
503         throws KrbException, IOException {
504         return CredentialsUtil.acquireS4U2proxyCreds(
505                 service, second, client, ccreds);
506     }
507 
508     public CredentialsCache getCache() {
509         return cache;
510     }
511 
<a name="34" id="anc34"></a>



512     /*
513      * Prints out debug info.
514      */
515     public static void printDebug(Credentials c) {
516         System.out.println(&quot;&gt;&gt;&gt; DEBUG: ----Credentials----&quot;);
517         System.out.println(&quot;\tclient: &quot; + c.client.toString());
<a name="35" id="anc35"></a><span class="line-added">518         if (c.clientAlias != null)</span>
<span class="line-added">519             System.out.println(&quot;\tclient alias: &quot; + c.clientAlias.toString());</span>
520         System.out.println(&quot;\tserver: &quot; + c.server.toString());
<a name="36" id="anc36"></a><span class="line-added">521         if (c.serverAlias != null)</span>
<span class="line-added">522             System.out.println(&quot;\tserver alias: &quot; + c.serverAlias.toString());</span>
523         System.out.println(&quot;\tticket: sname: &quot; + c.ticket.sname.toString());
524         if (c.startTime != null) {
525             System.out.println(&quot;\tstartTime: &quot; + c.startTime.getTime());
526         }
527         System.out.println(&quot;\tendTime: &quot; + c.endTime.getTime());
528         System.out.println(&quot;        ----Credentials end----&quot;);
529     }
530 
531 
532     static void ensureLoaded() {
533         java.security.AccessController.doPrivileged(
534                 new java.security.PrivilegedAction&lt;Void&gt; () {
535                         public Void run() {
536                                 if (System.getProperty(&quot;os.name&quot;).contains(&quot;OS X&quot;)) {
537                                     System.loadLibrary(&quot;osxkrb5&quot;);
538                                 } else {
539                                     System.loadLibrary(&quot;w2k_lsa_auth&quot;);
540                                 }
541                                 return null;
542                         }
543                 });
544         alreadyLoaded = true;
545     }
546 
547     public String toString() {
548         StringBuilder sb = new StringBuilder(&quot;Credentials:&quot;);
549         sb.append(    &quot;\n      client=&quot;).append(client);
<a name="37" id="anc37"></a><span class="line-added">550         if (clientAlias != null)</span>
<span class="line-added">551             sb.append(    &quot;\n      clientAlias=&quot;).append(clientAlias);</span>
552         sb.append(    &quot;\n      server=&quot;).append(server);
<a name="38" id="anc38"></a><span class="line-added">553         if (serverAlias != null)</span>
<span class="line-added">554             sb.append(    &quot;\n      serverAlias=&quot;).append(serverAlias);</span>
555         if (authTime != null) {
556             sb.append(&quot;\n    authTime=&quot;).append(authTime);
557         }
558         if (startTime != null) {
559             sb.append(&quot;\n   startTime=&quot;).append(startTime);
560         }
561         sb.append(    &quot;\n     endTime=&quot;).append(endTime);
562         sb.append(    &quot;\n   renewTill=&quot;).append(renewTill);
563         sb.append(    &quot;\n       flags=&quot;).append(flags);
564         sb.append(    &quot;\nEType (skey)=&quot;).append(key.getEType());
565         sb.append(    &quot;\n   (tkt key)=&quot;).append(ticket.encPart.eType);
566         return sb.toString();
567     }
568 
569     public sun.security.krb5.internal.ccache.Credentials toCCacheCreds() {
570         return new sun.security.krb5.internal.ccache.Credentials(
571                 getClient(), getServer(),
572                 getSessionKey(),
573                 date2kt(getAuthTime()),
574                 date2kt(getStartTime()),
575                 date2kt(getEndTime()),
576                 date2kt(getRenewTill()),
577                 false,
578                 flags,
579                 new HostAddresses(getClientAddresses()),
580                 getAuthzData(),
581                 getTicket(),
582                 null);
583     }
584 
585     private static KerberosTime date2kt(Date d) {
586         return d == null ? null : new KerberosTime(d);
587     }
588 }
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>