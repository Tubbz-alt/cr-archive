<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Util.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Krb5ProxyCredential.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubjectComber.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Util.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 41 import sun.security.krb5.KrbException;
 42 import java.io.IOException;
 43 import sun.security.krb5.KerberosSecrets;
 44 import sun.security.krb5.PrincipalName;
 45 
 46 /**
 47  * Utilities for obtaining and converting Kerberos tickets.
 48  */
 49 public class Krb5Util {
 50 
 51     static final boolean DEBUG = GetBooleanAction
 52             .privilegedGetProperty(&quot;sun.security.krb5.debug&quot;);
 53 
 54     /**
 55      * Default constructor
 56      */
 57     private Krb5Util() {  // Cannot create one of these
 58     }
 59 
 60     /**
<span class="line-modified"> 61      * Retrieve the service ticket for serverPrincipal from caller&#39;s Subject</span>
<span class="line-modified"> 62      * or from Subject obtained by logging in, or if not found, via the</span>
<span class="line-removed"> 63      * Ticket Granting Service using the TGT obtained from the Subject.</span>
<span class="line-removed"> 64      *</span>
<span class="line-removed"> 65      * Caller must have permission to:</span>
<span class="line-removed"> 66      *    - access and update Subject&#39;s private credentials</span>
<span class="line-removed"> 67      *    - create LoginContext</span>
<span class="line-removed"> 68      *    - read the auth.login.defaultCallbackHandler security property</span>
<span class="line-removed"> 69      *</span>
<span class="line-removed"> 70      * NOTE: This method is used by JSSE Kerberos Cipher Suites</span>
 71      */
<span class="line-modified"> 72     public static KerberosTicket getTicketFromSubjectAndTgs(GSSCaller caller,</span>
<span class="line-modified"> 73         String clientPrincipal, String serverPrincipal, String tgsPrincipal,</span>
<span class="line-modified"> 74         AccessControlContext acc)</span>
<span class="line-removed"> 75         throws LoginException, KrbException, IOException {</span>
 76 
<span class="line-modified"> 77         // 1. Try to find service ticket in acc subject</span>
 78         Subject accSubj = Subject.getSubject(acc);
<span class="line-modified"> 79         KerberosTicket ticket = SubjectComber.find(accSubj,</span>
<span class="line-modified"> 80             serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-modified"> 81 </span>
<span class="line-removed"> 82         if (ticket != null) {</span>
<span class="line-removed"> 83             return ticket;  // found it</span>
<span class="line-removed"> 84         }</span>
<span class="line-removed"> 85 </span>
<span class="line-removed"> 86         Subject loginSubj = null;</span>
<span class="line-removed"> 87         if (!GSSUtil.useSubjectCredsOnly(caller)) {</span>
<span class="line-removed"> 88             // 2. Try to get ticket from login</span>
<span class="line-removed"> 89             try {</span>
<span class="line-removed"> 90                 loginSubj = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);</span>
<span class="line-removed"> 91                 ticket = SubjectComber.find(loginSubj,</span>
<span class="line-removed"> 92                     serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed"> 93                 if (ticket != null) {</span>
<span class="line-removed"> 94                     return ticket; // found it</span>
<span class="line-removed"> 95                 }</span>
<span class="line-removed"> 96             } catch (LoginException e) {</span>
<span class="line-removed"> 97                 // No login entry to use</span>
<span class="line-removed"> 98                 // ignore and continue</span>
<span class="line-removed"> 99             }</span>
<span class="line-removed">100         }</span>
<span class="line-removed">101 </span>
<span class="line-removed">102         // Service ticket not found in subject or login</span>
<span class="line-removed">103         // Try to get TGT to acquire service ticket</span>
<span class="line-removed">104 </span>
<span class="line-removed">105         // 3. Try to get TGT from acc subject</span>
<span class="line-removed">106         KerberosTicket tgt = SubjectComber.find(accSubj,</span>
<span class="line-removed">107             tgsPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed">108 </span>
<span class="line-removed">109         boolean fromAcc;</span>
<span class="line-removed">110         if (tgt == null &amp;&amp; loginSubj != null) {</span>
<span class="line-removed">111             // 4. Try to get TGT from login subject</span>
<span class="line-removed">112             tgt = SubjectComber.find(loginSubj,</span>
<span class="line-removed">113                 tgsPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed">114             fromAcc = false;</span>
<span class="line-removed">115         } else {</span>
<span class="line-removed">116             fromAcc = true;</span>
<span class="line-removed">117         }</span>
118 
<span class="line-removed">119         // 5. Try to get service ticket using TGT</span>
<span class="line-removed">120         if (tgt != null) {</span>
<span class="line-removed">121             Credentials tgtCreds = ticketToCreds(tgt);</span>
<span class="line-removed">122             Credentials serviceCreds = Credentials.acquireServiceCreds(</span>
<span class="line-removed">123                         serverPrincipal, tgtCreds);</span>
<span class="line-removed">124             if (serviceCreds != null) {</span>
<span class="line-removed">125                 ticket = credsToTicket(serviceCreds);</span>
<span class="line-removed">126 </span>
<span class="line-removed">127                 // Store service ticket in acc&#39;s Subject</span>
<span class="line-removed">128                 if (fromAcc &amp;&amp; accSubj != null &amp;&amp; !accSubj.isReadOnly()) {</span>
<span class="line-removed">129                     accSubj.getPrivateCredentials().add(ticket);</span>
<span class="line-removed">130                 }</span>
<span class="line-removed">131             }</span>
<span class="line-removed">132         }</span>
133         return ticket;
134     }
135 
136     /**
<span class="line-modified">137      * Retrieves the ticket corresponding to the client/server principal</span>
<span class="line-modified">138      * pair from the Subject in the specified AccessControlContext.</span>
139      * If the ticket can not be found in the Subject, and if
140      * useSubjectCredsOnly is false, then obtain ticket from
141      * a LoginContext.
142      */
<span class="line-modified">143     static KerberosTicket getTicket(GSSCaller caller,</span>
<span class="line-modified">144         String clientPrincipal, String serverPrincipal,</span>
<span class="line-modified">145         AccessControlContext acc) throws LoginException {</span>
146 
147         // Try to get ticket from acc&#39;s Subject
148         Subject accSubj = Subject.getSubject(acc);
149         KerberosTicket ticket =
<span class="line-modified">150             SubjectComber.find(accSubj, serverPrincipal, clientPrincipal,</span>
<span class="line-modified">151                   KerberosTicket.class);</span>
152 
153         // Try to get ticket from Subject obtained from GSSUtil
154         if (ticket == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
155             Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
156             ticket = SubjectComber.find(subject,
<span class="line-modified">157                 serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
158         }
159         return ticket;
160     }
161 
162     /**
163      * Retrieves the caller&#39;s Subject, or Subject obtained by logging in
164      * via the specified caller.
165      *
166      * Caller must have permission to:
167      *    - access the Subject
168      *    - create LoginContext
169      *    - read the auth.login.defaultCallbackHandler security property
170      *
171      * NOTE: This method is used by JSSE Kerberos Cipher Suites
172      */
173     public static Subject getSubject(GSSCaller caller,
174         AccessControlContext acc) throws LoginException {
175 
176         // Try to get the Subject from acc
177         Subject subject = Subject.getSubject(acc);
</pre>
<hr />
<pre>
191      * NOTE: This method is also used by JSSE Kerberos Cipher Suites
192      */
193     public static ServiceCreds getServiceCreds(GSSCaller caller,
194         String serverPrincipal, AccessControlContext acc)
195                 throws LoginException {
196 
197         Subject accSubj = Subject.getSubject(acc);
198         ServiceCreds sc = null;
199         if (accSubj != null) {
200             sc = ServiceCreds.getInstance(accSubj, serverPrincipal);
201         }
202         if (sc == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
203             Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
204             sc = ServiceCreds.getInstance(subject, serverPrincipal);
205         }
206         return sc;
207     }
208 
209     public static KerberosTicket credsToTicket(Credentials serviceCreds) {
210         EncryptionKey sessionKey =  serviceCreds.getSessionKey();
<span class="line-modified">211         return new KerberosTicket(</span>
212             serviceCreds.getEncoded(),
213             new KerberosPrincipal(serviceCreds.getClient().getName()),
214             new KerberosPrincipal(serviceCreds.getServer().getName(),
215                                 KerberosPrincipal.KRB_NT_SRV_INST),
216             sessionKey.getBytes(),
217             sessionKey.getEType(),
218             serviceCreds.getFlags(),
219             serviceCreds.getAuthTime(),
220             serviceCreds.getStartTime(),
221             serviceCreds.getEndTime(),
222             serviceCreds.getRenewTill(),
223             serviceCreds.getClientAddresses());













224     };
225 
226     public static Credentials ticketToCreds(KerberosTicket kerbTicket)
227             throws KrbException, IOException {






228         return new Credentials(
229             kerbTicket.getEncoded(),
230             kerbTicket.getClient().getName(),

231             kerbTicket.getServer().getName(),

232             kerbTicket.getSessionKey().getEncoded(),
233             kerbTicket.getSessionKeyType(),
234             kerbTicket.getFlags(),
235             kerbTicket.getAuthTime(),
236             kerbTicket.getStartTime(),
237             kerbTicket.getEndTime(),
238             kerbTicket.getRenewTill(),
239             kerbTicket.getClientAddresses());
240     }
241 
242     /**
243      * A helper method to get a sun..KeyTab from a javax..KeyTab
244      * @param ktab the javax..KeyTab object
245      * @return the sun..KeyTab object
246      */
247     public static sun.security.krb5.internal.ktab.KeyTab
248             snapshotFromJavaxKeyTab(KeyTab ktab) {
249         return KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
250                 .keyTabTakeSnapshot(ktab);
251     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 41 import sun.security.krb5.KrbException;
 42 import java.io.IOException;
 43 import sun.security.krb5.KerberosSecrets;
 44 import sun.security.krb5.PrincipalName;
 45 
 46 /**
 47  * Utilities for obtaining and converting Kerberos tickets.
 48  */
 49 public class Krb5Util {
 50 
 51     static final boolean DEBUG = GetBooleanAction
 52             .privilegedGetProperty(&quot;sun.security.krb5.debug&quot;);
 53 
 54     /**
 55      * Default constructor
 56      */
 57     private Krb5Util() {  // Cannot create one of these
 58     }
 59 
 60     /**
<span class="line-modified"> 61      * Retrieves the ticket corresponding to the client/server principal</span>
<span class="line-modified"> 62      * pair from the Subject in the specified AccessControlContext.</span>








 63      */
<span class="line-modified"> 64     static KerberosTicket getServiceTicket(GSSCaller caller,</span>
<span class="line-modified"> 65         String clientPrincipal, String serverPrincipal,</span>
<span class="line-modified"> 66         AccessControlContext acc) throws LoginException {</span>

 67 
<span class="line-modified"> 68         // Try to get ticket from acc&#39;s Subject</span>
 69         Subject accSubj = Subject.getSubject(acc);
<span class="line-modified"> 70         KerberosTicket ticket =</span>
<span class="line-modified"> 71             SubjectComber.find(accSubj, serverPrincipal, clientPrincipal,</span>
<span class="line-modified"> 72                   KerberosTicket.class);</span>




































 73 














 74         return ticket;
 75     }
 76 
 77     /**
<span class="line-modified"> 78      * Retrieves the initial TGT corresponding to the client principal</span>
<span class="line-modified"> 79      * from the Subject in the specified AccessControlContext.</span>
 80      * If the ticket can not be found in the Subject, and if
 81      * useSubjectCredsOnly is false, then obtain ticket from
 82      * a LoginContext.
 83      */
<span class="line-modified"> 84     static KerberosTicket getInitialTicket(GSSCaller caller,</span>
<span class="line-modified"> 85             String clientPrincipal,</span>
<span class="line-modified"> 86             AccessControlContext acc) throws LoginException {</span>
 87 
 88         // Try to get ticket from acc&#39;s Subject
 89         Subject accSubj = Subject.getSubject(acc);
 90         KerberosTicket ticket =
<span class="line-modified"> 91                 SubjectComber.find(accSubj, null, clientPrincipal,</span>
<span class="line-modified"> 92                         KerberosTicket.class);</span>
 93 
 94         // Try to get ticket from Subject obtained from GSSUtil
 95         if (ticket == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
 96             Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
 97             ticket = SubjectComber.find(subject,
<span class="line-modified"> 98                     null, clientPrincipal, KerberosTicket.class);</span>
 99         }
100         return ticket;
101     }
102 
103     /**
104      * Retrieves the caller&#39;s Subject, or Subject obtained by logging in
105      * via the specified caller.
106      *
107      * Caller must have permission to:
108      *    - access the Subject
109      *    - create LoginContext
110      *    - read the auth.login.defaultCallbackHandler security property
111      *
112      * NOTE: This method is used by JSSE Kerberos Cipher Suites
113      */
114     public static Subject getSubject(GSSCaller caller,
115         AccessControlContext acc) throws LoginException {
116 
117         // Try to get the Subject from acc
118         Subject subject = Subject.getSubject(acc);
</pre>
<hr />
<pre>
132      * NOTE: This method is also used by JSSE Kerberos Cipher Suites
133      */
134     public static ServiceCreds getServiceCreds(GSSCaller caller,
135         String serverPrincipal, AccessControlContext acc)
136                 throws LoginException {
137 
138         Subject accSubj = Subject.getSubject(acc);
139         ServiceCreds sc = null;
140         if (accSubj != null) {
141             sc = ServiceCreds.getInstance(accSubj, serverPrincipal);
142         }
143         if (sc == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
144             Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
145             sc = ServiceCreds.getInstance(subject, serverPrincipal);
146         }
147         return sc;
148     }
149 
150     public static KerberosTicket credsToTicket(Credentials serviceCreds) {
151         EncryptionKey sessionKey =  serviceCreds.getSessionKey();
<span class="line-modified">152         KerberosTicket kt = new KerberosTicket(</span>
153             serviceCreds.getEncoded(),
154             new KerberosPrincipal(serviceCreds.getClient().getName()),
155             new KerberosPrincipal(serviceCreds.getServer().getName(),
156                                 KerberosPrincipal.KRB_NT_SRV_INST),
157             sessionKey.getBytes(),
158             sessionKey.getEType(),
159             serviceCreds.getFlags(),
160             serviceCreds.getAuthTime(),
161             serviceCreds.getStartTime(),
162             serviceCreds.getEndTime(),
163             serviceCreds.getRenewTill(),
164             serviceCreds.getClientAddresses());
<span class="line-added">165         PrincipalName clientAlias = serviceCreds.getClientAlias();</span>
<span class="line-added">166         PrincipalName serverAlias = serviceCreds.getServerAlias();</span>
<span class="line-added">167         if (clientAlias != null) {</span>
<span class="line-added">168             KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">169                     .kerberosTicketSetClientAlias(kt, new KerberosPrincipal(</span>
<span class="line-added">170                             clientAlias.getName(), clientAlias.getNameType()));</span>
<span class="line-added">171         }</span>
<span class="line-added">172         if (serverAlias != null) {</span>
<span class="line-added">173             KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">174                     .kerberosTicketSetServerAlias(kt, new KerberosPrincipal(</span>
<span class="line-added">175                             serverAlias.getName(), serverAlias.getNameType()));</span>
<span class="line-added">176         }</span>
<span class="line-added">177         return kt;</span>
178     };
179 
180     public static Credentials ticketToCreds(KerberosTicket kerbTicket)
181             throws KrbException, IOException {
<span class="line-added">182         KerberosPrincipal clientAlias = KerberosSecrets</span>
<span class="line-added">183                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">184                 .kerberosTicketGetClientAlias(kerbTicket);</span>
<span class="line-added">185         KerberosPrincipal serverAlias = KerberosSecrets</span>
<span class="line-added">186                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">187                 .kerberosTicketGetServerAlias(kerbTicket);</span>
188         return new Credentials(
189             kerbTicket.getEncoded(),
190             kerbTicket.getClient().getName(),
<span class="line-added">191             (clientAlias != null ? clientAlias.getName() : null),</span>
192             kerbTicket.getServer().getName(),
<span class="line-added">193             (serverAlias != null ? serverAlias.getName() : null),</span>
194             kerbTicket.getSessionKey().getEncoded(),
195             kerbTicket.getSessionKeyType(),
196             kerbTicket.getFlags(),
197             kerbTicket.getAuthTime(),
198             kerbTicket.getStartTime(),
199             kerbTicket.getEndTime(),
200             kerbTicket.getRenewTill(),
201             kerbTicket.getClientAddresses());
202     }
203 
204     /**
205      * A helper method to get a sun..KeyTab from a javax..KeyTab
206      * @param ktab the javax..KeyTab object
207      * @return the sun..KeyTab object
208      */
209     public static sun.security.krb5.internal.ktab.KeyTab
210             snapshotFromJavaxKeyTab(KeyTab ktab) {
211         return KerberosSecrets.getJavaxSecurityAuthKerberosAccess()
212                 .keyTabTakeSnapshot(ktab);
213     }
</pre>
</td>
</tr>
</table>
<center><a href="Krb5ProxyCredential.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubjectComber.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>