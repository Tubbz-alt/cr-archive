<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.security.jgss/share/classes/sun/security/krb5/KrbAsRep.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbApReq.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbAsReq.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbAsRep.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,11 ***</span>
              if (dkey == null) {
                  throw new KrbException(Krb5.API_INVALID_ARG,
                      &quot;Cannot find key for type/kvno to decrypt AS REP - &quot; +
                      EType.toString(encPartKeyType) + &quot;/&quot; + encPartKvno);
              }
<span class="line-modified">!         decrypt(dkey, asReq);</span>
      }
  
      /**
       * Called by KrbAsReqBuilder to resolve a AS-REP message using a password.
       * @param password user provided password. not null
<span class="line-new-header">--- 116,11 ---</span>
              if (dkey == null) {
                  throw new KrbException(Krb5.API_INVALID_ARG,
                      &quot;Cannot find key for type/kvno to decrypt AS REP - &quot; +
                      EType.toString(encPartKeyType) + &quot;/&quot; + encPartKvno);
              }
<span class="line-modified">!         decrypt(dkey, asReq, cname);</span>
      }
  
      /**
       * Called by KrbAsReqBuilder to resolve a AS-REP message using a password.
       * @param password user provided password. not null
</pre>
<hr />
<pre>
<span class="line-old-header">*** 134,35 ***</span>
          EncryptionKey dkey = EncryptionKey.acquireSecretKey(
                  cname,
                  password,
                  encPartKeyType,
                  PAData.getSaltAndParams(encPartKeyType, rep.pAData));
<span class="line-modified">!         decrypt(dkey, asReq);</span>
      }
  
      /**
       * Decrypts encrypted content inside AS-REP. Called by initiator.
       * @param dkey the decryption key to use
       * @param asReq the original AS-REQ sent, used to validate AS-REP
       */
<span class="line-modified">!     private void decrypt(EncryptionKey dkey, KrbAsReq asReq)</span>
              throws KrbException, Asn1Exception, IOException {
          byte[] enc_as_rep_bytes = rep.encPart.decrypt(dkey,
              KeyUsage.KU_ENC_AS_REP_PART);
          byte[] enc_as_rep_part = rep.encPart.reset(enc_as_rep_bytes);
  
          DerValue encoding = new DerValue(enc_as_rep_part);
          EncASRepPart enc_part = new EncASRepPart(encoding);
          rep.encKDCRepPart = enc_part;
  
          ASReq req = asReq.getMessage();
<span class="line-modified">!         check(true, req, rep);</span>
  
          creds = new Credentials(
                                  rep.ticket,
<span class="line-modified">!                                 req.reqBody.cname,</span>
                                  enc_part.sname,
                                  enc_part.key,
                                  enc_part.flags,
                                  enc_part.authtime,
                                  enc_part.starttime,
                                  enc_part.endtime,
<span class="line-new-header">--- 134,42 ---</span>
          EncryptionKey dkey = EncryptionKey.acquireSecretKey(
                  cname,
                  password,
                  encPartKeyType,
                  PAData.getSaltAndParams(encPartKeyType, rep.pAData));
<span class="line-modified">!         decrypt(dkey, asReq, cname);</span>
      }
  
      /**
       * Decrypts encrypted content inside AS-REP. Called by initiator.
       * @param dkey the decryption key to use
       * @param asReq the original AS-REQ sent, used to validate AS-REP
       */
<span class="line-modified">!     private void decrypt(EncryptionKey dkey, KrbAsReq asReq,</span>
<span class="line-added">+             PrincipalName cname)</span>
              throws KrbException, Asn1Exception, IOException {
          byte[] enc_as_rep_bytes = rep.encPart.decrypt(dkey,
              KeyUsage.KU_ENC_AS_REP_PART);
          byte[] enc_as_rep_part = rep.encPart.reset(enc_as_rep_bytes);
  
          DerValue encoding = new DerValue(enc_as_rep_part);
          EncASRepPart enc_part = new EncASRepPart(encoding);
          rep.encKDCRepPart = enc_part;
  
          ASReq req = asReq.getMessage();
<span class="line-modified">!         check(true, req, rep, dkey);</span>
<span class="line-added">+ </span>
<span class="line-added">+         PrincipalName clientAlias = cname;</span>
<span class="line-added">+         if (clientAlias.equals(rep.cname))</span>
<span class="line-added">+             clientAlias = null;</span>
  
          creds = new Credentials(
                                  rep.ticket,
<span class="line-modified">!                                 rep.cname,</span>
<span class="line-added">+                                 clientAlias,</span>
                                  enc_part.sname,
<span class="line-added">+                                 null, // No server alias expected in a TGT</span>
                                  enc_part.key,
                                  enc_part.flags,
                                  enc_part.authtime,
                                  enc_part.starttime,
                                  enc_part.endtime,
</pre>
<center><a href="KrbApReq.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbAsReq.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>