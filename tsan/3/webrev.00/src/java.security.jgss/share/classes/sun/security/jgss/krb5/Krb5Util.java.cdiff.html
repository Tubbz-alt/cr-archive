<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Util.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Krb5ProxyCredential.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubjectComber.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/jgss/krb5/Krb5Util.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 56,107 ***</span>
       */
      private Krb5Util() {  // Cannot create one of these
      }
  
      /**
<span class="line-modified">!      * Retrieve the service ticket for serverPrincipal from caller&#39;s Subject</span>
<span class="line-modified">!      * or from Subject obtained by logging in, or if not found, via the</span>
<span class="line-removed">-      * Ticket Granting Service using the TGT obtained from the Subject.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * Caller must have permission to:</span>
<span class="line-removed">-      *    - access and update Subject&#39;s private credentials</span>
<span class="line-removed">-      *    - create LoginContext</span>
<span class="line-removed">-      *    - read the auth.login.defaultCallbackHandler security property</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * NOTE: This method is used by JSSE Kerberos Cipher Suites</span>
       */
<span class="line-modified">!     public static KerberosTicket getTicketFromSubjectAndTgs(GSSCaller caller,</span>
<span class="line-modified">!         String clientPrincipal, String serverPrincipal, String tgsPrincipal,</span>
<span class="line-modified">!         AccessControlContext acc)</span>
<span class="line-removed">-         throws LoginException, KrbException, IOException {</span>
  
<span class="line-modified">!         // 1. Try to find service ticket in acc subject</span>
          Subject accSubj = Subject.getSubject(acc);
<span class="line-modified">!         KerberosTicket ticket = SubjectComber.find(accSubj,</span>
<span class="line-modified">!             serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-modified">! </span>
<span class="line-removed">-         if (ticket != null) {</span>
<span class="line-removed">-             return ticket;  // found it</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         Subject loginSubj = null;</span>
<span class="line-removed">-         if (!GSSUtil.useSubjectCredsOnly(caller)) {</span>
<span class="line-removed">-             // 2. Try to get ticket from login</span>
<span class="line-removed">-             try {</span>
<span class="line-removed">-                 loginSubj = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);</span>
<span class="line-removed">-                 ticket = SubjectComber.find(loginSubj,</span>
<span class="line-removed">-                     serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed">-                 if (ticket != null) {</span>
<span class="line-removed">-                     return ticket; // found it</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } catch (LoginException e) {</span>
<span class="line-removed">-                 // No login entry to use</span>
<span class="line-removed">-                 // ignore and continue</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Service ticket not found in subject or login</span>
<span class="line-removed">-         // Try to get TGT to acquire service ticket</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // 3. Try to get TGT from acc subject</span>
<span class="line-removed">-         KerberosTicket tgt = SubjectComber.find(accSubj,</span>
<span class="line-removed">-             tgsPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         boolean fromAcc;</span>
<span class="line-removed">-         if (tgt == null &amp;&amp; loginSubj != null) {</span>
<span class="line-removed">-             // 4. Try to get TGT from login subject</span>
<span class="line-removed">-             tgt = SubjectComber.find(loginSubj,</span>
<span class="line-removed">-                 tgsPrincipal, clientPrincipal, KerberosTicket.class);</span>
<span class="line-removed">-             fromAcc = false;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             fromAcc = true;</span>
<span class="line-removed">-         }</span>
  
<span class="line-removed">-         // 5. Try to get service ticket using TGT</span>
<span class="line-removed">-         if (tgt != null) {</span>
<span class="line-removed">-             Credentials tgtCreds = ticketToCreds(tgt);</span>
<span class="line-removed">-             Credentials serviceCreds = Credentials.acquireServiceCreds(</span>
<span class="line-removed">-                         serverPrincipal, tgtCreds);</span>
<span class="line-removed">-             if (serviceCreds != null) {</span>
<span class="line-removed">-                 ticket = credsToTicket(serviceCreds);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 // Store service ticket in acc&#39;s Subject</span>
<span class="line-removed">-                 if (fromAcc &amp;&amp; accSubj != null &amp;&amp; !accSubj.isReadOnly()) {</span>
<span class="line-removed">-                     accSubj.getPrivateCredentials().add(ticket);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
          return ticket;
      }
  
      /**
<span class="line-modified">!      * Retrieves the ticket corresponding to the client/server principal</span>
<span class="line-modified">!      * pair from the Subject in the specified AccessControlContext.</span>
       * If the ticket can not be found in the Subject, and if
       * useSubjectCredsOnly is false, then obtain ticket from
       * a LoginContext.
       */
<span class="line-modified">!     static KerberosTicket getTicket(GSSCaller caller,</span>
<span class="line-modified">!         String clientPrincipal, String serverPrincipal,</span>
<span class="line-modified">!         AccessControlContext acc) throws LoginException {</span>
  
          // Try to get ticket from acc&#39;s Subject
          Subject accSubj = Subject.getSubject(acc);
          KerberosTicket ticket =
<span class="line-modified">!             SubjectComber.find(accSubj, serverPrincipal, clientPrincipal,</span>
<span class="line-modified">!                   KerberosTicket.class);</span>
  
          // Try to get ticket from Subject obtained from GSSUtil
          if (ticket == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
              Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
              ticket = SubjectComber.find(subject,
<span class="line-modified">!                 serverPrincipal, clientPrincipal, KerberosTicket.class);</span>
          }
          return ticket;
      }
  
      /**
<span class="line-new-header">--- 56,48 ---</span>
       */
      private Krb5Util() {  // Cannot create one of these
      }
  
      /**
<span class="line-modified">!      * Retrieves the ticket corresponding to the client/server principal</span>
<span class="line-modified">!      * pair from the Subject in the specified AccessControlContext.</span>
       */
<span class="line-modified">!     static KerberosTicket getServiceTicket(GSSCaller caller,</span>
<span class="line-modified">!         String clientPrincipal, String serverPrincipal,</span>
<span class="line-modified">!         AccessControlContext acc) throws LoginException {</span>
  
<span class="line-modified">!         // Try to get ticket from acc&#39;s Subject</span>
          Subject accSubj = Subject.getSubject(acc);
<span class="line-modified">!         KerberosTicket ticket =</span>
<span class="line-modified">!             SubjectComber.find(accSubj, serverPrincipal, clientPrincipal,</span>
<span class="line-modified">!                   KerberosTicket.class);</span>
  
          return ticket;
      }
  
      /**
<span class="line-modified">!      * Retrieves the initial TGT corresponding to the client principal</span>
<span class="line-modified">!      * from the Subject in the specified AccessControlContext.</span>
       * If the ticket can not be found in the Subject, and if
       * useSubjectCredsOnly is false, then obtain ticket from
       * a LoginContext.
       */
<span class="line-modified">!     static KerberosTicket getInitialTicket(GSSCaller caller,</span>
<span class="line-modified">!             String clientPrincipal,</span>
<span class="line-modified">!             AccessControlContext acc) throws LoginException {</span>
  
          // Try to get ticket from acc&#39;s Subject
          Subject accSubj = Subject.getSubject(acc);
          KerberosTicket ticket =
<span class="line-modified">!                 SubjectComber.find(accSubj, null, clientPrincipal,</span>
<span class="line-modified">!                         KerberosTicket.class);</span>
  
          // Try to get ticket from Subject obtained from GSSUtil
          if (ticket == null &amp;&amp; !GSSUtil.useSubjectCredsOnly(caller)) {
              Subject subject = GSSUtil.login(caller, GSSUtil.GSS_KRB5_MECH_OID);
              ticket = SubjectComber.find(subject,
<span class="line-modified">!                     null, clientPrincipal, KerberosTicket.class);</span>
          }
          return ticket;
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,11 ***</span>
          return sc;
      }
  
      public static KerberosTicket credsToTicket(Credentials serviceCreds) {
          EncryptionKey sessionKey =  serviceCreds.getSessionKey();
<span class="line-modified">!         return new KerberosTicket(</span>
              serviceCreds.getEncoded(),
              new KerberosPrincipal(serviceCreds.getClient().getName()),
              new KerberosPrincipal(serviceCreds.getServer().getName(),
                                  KerberosPrincipal.KRB_NT_SRV_INST),
              sessionKey.getBytes(),
<span class="line-new-header">--- 147,11 ---</span>
          return sc;
      }
  
      public static KerberosTicket credsToTicket(Credentials serviceCreds) {
          EncryptionKey sessionKey =  serviceCreds.getSessionKey();
<span class="line-modified">!         KerberosTicket kt = new KerberosTicket(</span>
              serviceCreds.getEncoded(),
              new KerberosPrincipal(serviceCreds.getClient().getName()),
              new KerberosPrincipal(serviceCreds.getServer().getName(),
                                  KerberosPrincipal.KRB_NT_SRV_INST),
              sessionKey.getBytes(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,18 ***</span>
<span class="line-new-header">--- 160,39 ---</span>
              serviceCreds.getAuthTime(),
              serviceCreds.getStartTime(),
              serviceCreds.getEndTime(),
              serviceCreds.getRenewTill(),
              serviceCreds.getClientAddresses());
<span class="line-added">+         PrincipalName clientAlias = serviceCreds.getClientAlias();</span>
<span class="line-added">+         PrincipalName serverAlias = serviceCreds.getServerAlias();</span>
<span class="line-added">+         if (clientAlias != null) {</span>
<span class="line-added">+             KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">+                     .kerberosTicketSetClientAlias(kt, new KerberosPrincipal(</span>
<span class="line-added">+                             clientAlias.getName(), clientAlias.getNameType()));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (serverAlias != null) {</span>
<span class="line-added">+             KerberosSecrets.getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">+                     .kerberosTicketSetServerAlias(kt, new KerberosPrincipal(</span>
<span class="line-added">+                             serverAlias.getName(), serverAlias.getNameType()));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return kt;</span>
      };
  
      public static Credentials ticketToCreds(KerberosTicket kerbTicket)
              throws KrbException, IOException {
<span class="line-added">+         KerberosPrincipal clientAlias = KerberosSecrets</span>
<span class="line-added">+                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">+                 .kerberosTicketGetClientAlias(kerbTicket);</span>
<span class="line-added">+         KerberosPrincipal serverAlias = KerberosSecrets</span>
<span class="line-added">+                 .getJavaxSecurityAuthKerberosAccess()</span>
<span class="line-added">+                 .kerberosTicketGetServerAlias(kerbTicket);</span>
          return new Credentials(
              kerbTicket.getEncoded(),
              kerbTicket.getClient().getName(),
<span class="line-added">+             (clientAlias != null ? clientAlias.getName() : null),</span>
              kerbTicket.getServer().getName(),
<span class="line-added">+             (serverAlias != null ? serverAlias.getName() : null),</span>
              kerbTicket.getSessionKey().getEncoded(),
              kerbTicket.getSessionKeyType(),
              kerbTicket.getFlags(),
              kerbTicket.getAuthTime(),
              kerbTicket.getStartTime(),
</pre>
<center><a href="Krb5ProxyCredential.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SubjectComber.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>