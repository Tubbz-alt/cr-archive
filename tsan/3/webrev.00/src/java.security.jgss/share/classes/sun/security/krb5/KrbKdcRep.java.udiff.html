<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.jgss/share/classes/sun/security/krb5/KrbKdcRep.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KrbCred.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbServiceLocator.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.jgss/share/classes/sun/security/krb5/KrbKdcRep.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,27 +29,45 @@</span>
   */
  
  package sun.security.krb5;
  
  import sun.security.krb5.internal.*;
<span class="udiff-line-added">+ import sun.security.krb5.internal.crypto.KeyUsage;</span>
<span class="udiff-line-added">+ import sun.security.util.DerInputStream;</span>
  
  abstract class KrbKdcRep {
  
      static void check(
                        boolean isAsReq,
                        KDCReq req,
<span class="udiff-line-modified-removed">-                       KDCRep rep</span>
<span class="udiff-line-modified-added">+                       KDCRep rep,</span>
<span class="udiff-line-added">+                       EncryptionKey replyKey</span>
                        ) throws KrbApErrException {
  
<span class="udiff-line-modified-removed">-         if (isAsReq &amp;&amp; !req.reqBody.cname.equals(rep.cname)) {</span>
<span class="udiff-line-modified-added">+         // cname change in AS-REP is allowed only if the client</span>
<span class="udiff-line-added">+         // sent CANONICALIZE and the server supports RFC 6806 - Section 11</span>
<span class="udiff-line-added">+         // FAST scheme (ENC-PA-REP flag).</span>
<span class="udiff-line-added">+         if (isAsReq &amp;&amp; !req.reqBody.cname.equals(rep.cname) &amp;&amp;</span>
<span class="udiff-line-added">+                 (!req.reqBody.kdcOptions.get(KDCOptions.CANONICALIZE) ||</span>
<span class="udiff-line-added">+                  !rep.encKDCRepPart.flags.get(Krb5.TKT_OPTS_ENC_PA_REP))) {</span>
              rep.encKDCRepPart.key.destroy();
              throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);
          }
  
<span class="udiff-line-added">+         // sname change in TGS-REP is allowed only if client</span>
<span class="udiff-line-added">+         // sent CANONICALIZE and new sname is a referral of</span>
<span class="udiff-line-added">+         // the form krbtgt/TO-REALM.COM@FROM-REALM.COM.</span>
          if (!req.reqBody.sname.equals(rep.encKDCRepPart.sname)) {
<span class="udiff-line-modified-removed">-             rep.encKDCRepPart.key.destroy();</span>
<span class="udiff-line-modified-removed">-             throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);</span>
<span class="udiff-line-modified-added">+             String[] snameStrings = rep.encKDCRepPart.sname.getNameStrings();</span>
<span class="udiff-line-modified-added">+             if (isAsReq || !req.reqBody.kdcOptions.get(KDCOptions.CANONICALIZE) ||</span>
<span class="udiff-line-added">+                     snameStrings == null || snameStrings.length != 2 ||</span>
<span class="udiff-line-added">+                     !snameStrings[0].equals(PrincipalName.TGS_DEFAULT_SRV_NAME) ||</span>
<span class="udiff-line-added">+                     !rep.encKDCRepPart.sname.getRealmString().equals(</span>
<span class="udiff-line-added">+                             req.reqBody.sname.getRealmString())) {</span>
<span class="udiff-line-added">+                 rep.encKDCRepPart.key.destroy();</span>
<span class="udiff-line-added">+                 throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);</span>
<span class="udiff-line-added">+             }</span>
          }
  
          if (req.reqBody.getNonce() != rep.encKDCRepPart.nonce) {
              rep.encKDCRepPart.key.destroy();
              throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,7 +134,49 @@</span>
                      rep.encKDCRepPart.key.destroy();
                      throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);
                  }
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // RFC 6806 - Section 11 mechanism check</span>
<span class="udiff-line-added">+         if (rep.encKDCRepPart.flags.get(Krb5.TKT_OPTS_ENC_PA_REP) &amp;&amp;</span>
<span class="udiff-line-added">+                 req.reqBody.kdcOptions.get(KDCOptions.CANONICALIZE)) {</span>
<span class="udiff-line-added">+             boolean reqPaReqEncPaRep = false;</span>
<span class="udiff-line-added">+             boolean repPaReqEncPaRepValid = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // PA_REQ_ENC_PA_REP only required for AS requests</span>
<span class="udiff-line-added">+             for (PAData pa : req.pAData) {</span>
<span class="udiff-line-added">+                 if (pa.getType() == Krb5.PA_REQ_ENC_PA_REP) {</span>
<span class="udiff-line-added">+                     reqPaReqEncPaRep = true;</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (rep.encKDCRepPart.pAData != null) {</span>
<span class="udiff-line-added">+                 for (PAData pa : rep.encKDCRepPart.pAData) {</span>
<span class="udiff-line-added">+                     if (pa.getType() == Krb5.PA_REQ_ENC_PA_REP) {</span>
<span class="udiff-line-added">+                         try {</span>
<span class="udiff-line-added">+                             Checksum repCksum = new Checksum(</span>
<span class="udiff-line-added">+                                     new DerInputStream(</span>
<span class="udiff-line-added">+                                             pa.getValue()).getDerValue());</span>
<span class="udiff-line-added">+                             // The checksum is inside encKDCRepPart so we don&#39;t</span>
<span class="udiff-line-added">+                             // care if it&#39;s keyed or not.</span>
<span class="udiff-line-added">+                             repPaReqEncPaRepValid =</span>
<span class="udiff-line-added">+                                     repCksum.verifyAnyChecksum(</span>
<span class="udiff-line-added">+                                             req.asn1Encode(), replyKey,</span>
<span class="udiff-line-added">+                                             KeyUsage.KU_AS_REQ);</span>
<span class="udiff-line-added">+                         } catch (Exception e) {</span>
<span class="udiff-line-added">+                             if (Krb5.DEBUG) {</span>
<span class="udiff-line-added">+                                 e.printStackTrace();</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (reqPaReqEncPaRep &amp;&amp; !repPaReqEncPaRepValid) {</span>
<span class="udiff-line-added">+                 throw new KrbApErrException(Krb5.KRB_AP_ERR_MODIFIED);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
      }
  }
</pre>
<center><a href="KrbCred.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="KrbServiceLocator.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>