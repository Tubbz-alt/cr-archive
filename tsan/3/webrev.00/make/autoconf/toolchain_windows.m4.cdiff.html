<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff make/autoconf/toolchain_windows.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="toolchain.m4.cdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="version-numbers.cdiff.html" target="_top">next &gt;</a></center>    <h2>make/autoconf/toolchain_windows.m4</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  #
<span class="line-modified">! # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  #
  # This code is free software; you can redistribute it and/or modify it
  # under the terms of the GNU General Public License version 2 only, as
  # published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  #
<span class="line-modified">! # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  #
  # This code is free software; you can redistribute it and/or modify it
  # under the terms of the GNU General Public License version 2 only, as
  # published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,11 ***</span>
  # questions.
  #
  
  ################################################################################
  # The order of these defines the priority by which we try to find them.
<span class="line-modified">! VALID_VS_VERSIONS=&quot;2017 2013 2015 2012 2010&quot;</span>
  
  VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
  VS_VERSION_INTERNAL_2010=100
  VS_MSVCR_2010=msvcr100.dll
  # We don&#39;t use msvcp on Visual Studio 2010
<span class="line-new-header">--- 23,11 ---</span>
  # questions.
  #
  
  ################################################################################
  # The order of these defines the priority by which we try to find them.
<span class="line-modified">! VALID_VS_VERSIONS=&quot;2017 2019 2013 2015 2012 2010&quot;</span>
  
  VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
  VS_VERSION_INTERNAL_2010=100
  VS_MSVCR_2010=msvcr100.dll
  # We don&#39;t use msvcp on Visual Studio 2010
</pre>
<hr />
<pre>
<span class="line-old-header">*** 85,10 ***</span>
<span class="line-new-header">--- 85,25 ---</span>
  VS_EDITIONS_2017=&quot;BuildTools Community Professional Enterprise&quot;
  VS_SDK_INSTALLDIR_2017=
  VS_VS_PLATFORM_NAME_2017=&quot;v141&quot;
  VS_SDK_PLATFORM_NAME_2017=
  VS_SUPPORTED_2017=true
<span class="line-added">+ VS_TOOLSET_SUPPORTED_2017=true</span>
<span class="line-added">+ </span>
<span class="line-added">+ VS_DESCRIPTION_2019=&quot;Microsoft Visual Studio 2019&quot;</span>
<span class="line-added">+ VS_VERSION_INTERNAL_2019=141</span>
<span class="line-added">+ VS_MSVCR_2019=vcruntime140.dll</span>
<span class="line-added">+ VS_MSVCP_2019=msvcp140.dll</span>
<span class="line-added">+ VS_ENVVAR_2019=&quot;VS160COMNTOOLS&quot;</span>
<span class="line-added">+ VS_USE_UCRT_2019=&quot;true&quot;</span>
<span class="line-added">+ VS_VS_INSTALLDIR_2019=&quot;Microsoft Visual Studio/2019&quot;</span>
<span class="line-added">+ VS_EDITIONS_2019=&quot;BuildTools Community Professional Enterprise&quot;</span>
<span class="line-added">+ VS_SDK_INSTALLDIR_2019=</span>
<span class="line-added">+ VS_VS_PLATFORM_NAME_2019=&quot;v142&quot;</span>
<span class="line-added">+ VS_SDK_PLATFORM_NAME_2019=</span>
<span class="line-added">+ VS_SUPPORTED_2019=false</span>
<span class="line-added">+ VS_TOOLSET_SUPPORTED_2019=false</span>
  
  ################################################################################
  
  AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT],
  [
</pre>
<hr />
<pre>
<span class="line-old-header">*** 96,11 ***</span>
      VS_VERSION=&quot;$1&quot;
      VS_BASE=&quot;$2&quot;
      METHOD=&quot;$3&quot;
  
      BASIC_WINDOWS_REWRITE_AS_UNIX_PATH(VS_BASE)
<span class="line-modified">!     # In VS 2017, the default installation is in a subdir named after the edition.</span>
      # Find the first one present and use that.
      if test &quot;x$VS_EDITIONS&quot; != x; then
        for edition in $VS_EDITIONS; do
          if test -d &quot;$VS_BASE/$edition&quot;; then
            VS_BASE=&quot;$VS_BASE/$edition&quot;
<span class="line-new-header">--- 111,11 ---</span>
      VS_VERSION=&quot;$1&quot;
      VS_BASE=&quot;$2&quot;
      METHOD=&quot;$3&quot;
  
      BASIC_WINDOWS_REWRITE_AS_UNIX_PATH(VS_BASE)
<span class="line-modified">!     # In VS 2017 and VS 2019, the default installation is in a subdir named after the edition.</span>
      # Find the first one present and use that.
      if test &quot;x$VS_EDITIONS&quot; != x; then
        for edition in $VS_EDITIONS; do
          if test -d &quot;$VS_BASE/$edition&quot;; then
            VS_BASE=&quot;$VS_BASE/$edition&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 175,17 ***</span>
<span class="line-new-header">--- 190,29 ---</span>
  ################################################################################
  # Finds the bat or cmd file in Visual Studio or the SDK that sets up a proper
  # build environment and assigns it to VS_ENV_CMD
  AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE],
  [
<span class="line-added">+   # VS2017 provides the option to install previous minor versions of the MSVC</span>
<span class="line-added">+   # toolsets. It is not possible to directly download earlier minor versions of</span>
<span class="line-added">+   # VS2017 and in order to build with a previous minor compiler toolset version,</span>
<span class="line-added">+   # it is now possible to compile with earlier minor versions by passing</span>
<span class="line-added">+   # -vcvars_ver=&lt;toolset_version&gt; argument to vcvarsall.bat.</span>
<span class="line-added">+   AC_ARG_WITH(msvc-toolset-version, [AS_HELP_STRING([--with-msvc-toolset-version],</span>
<span class="line-added">+       [specific MSVC toolset version to use, passed as -vcvars_ver argument to</span>
<span class="line-added">+        pass to vcvarsall.bat (Windows only)])])</span>
<span class="line-added">+ </span>
    VS_VERSION=&quot;$1&quot;
    eval VS_COMNTOOLS_VAR=&quot;\${VS_ENVVAR_${VS_VERSION}}&quot;
    eval VS_COMNTOOLS=&quot;\$${VS_COMNTOOLS_VAR}&quot;
    eval VS_INSTALL_DIR=&quot;\${VS_VS_INSTALLDIR_${VS_VERSION}}&quot;
    eval VS_EDITIONS=&quot;\${VS_EDITIONS_${VS_VERSION}}&quot;
    eval SDK_INSTALL_DIR=&quot;\${VS_SDK_INSTALLDIR_${VS_VERSION}}&quot;
    eval VS_ENV_ARGS=&quot;\${VS_ENV_ARGS_${VS_VERSION}}&quot;
<span class="line-added">+   eval VS_TOOLSET_SUPPORTED=&quot;\${VS_TOOLSET_SUPPORTED_${VS_VERSION}}&quot;</span>
<span class="line-added">+ </span>
<span class="line-added">+   VS_ENV_CMD=&quot;&quot;</span>
  
    # When using --with-tools-dir, assume it points to the correct and default
    # version of Visual Studio or that --with-toolchain-version was also set.
    if test &quot;x$with_tools_dir&quot; != x; then
      TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,12 ***</span>
        AC_MSG_NOTICE([directory within the Visual Studio installation])
        AC_MSG_ERROR([Cannot locate a valid Visual Studio installation])
      fi
    fi
  
<span class="line-removed">-   VS_ENV_CMD=&quot;&quot;</span>
<span class="line-removed">- </span>
    if test &quot;x$VS_COMNTOOLS&quot; != x; then
      TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
          [$VS_COMNTOOLS/../..], [$VS_COMNTOOLS_VAR variable])
    fi
    if test &quot;x$PROGRAMFILES&quot; != x; then
<span class="line-new-header">--- 227,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 238,10 ***</span>
<span class="line-new-header">--- 263,16 ---</span>
      TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
          [C:/Program Files/$SDK_INSTALL_DIR], [well-known name])
      TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
          [C:/Program Files (x86)/$SDK_INSTALL_DIR], [well-known name])
    fi
<span class="line-added">+ </span>
<span class="line-added">+   if test &quot;x$VS_TOOLSET_SUPPORTED&quot; != x; then</span>
<span class="line-added">+     if test &quot;x$with_msvc_toolset_version&quot; != x; then</span>
<span class="line-added">+       VS_ENV_ARGS=&quot;$VS_ENV_ARGS -vcvars_ver=$with_msvc_toolset_version&quot;</span>
<span class="line-added">+     fi</span>
<span class="line-added">+   fi</span>
  ])
  
  ################################################################################
  
  AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO],
</pre>
<hr />
<pre>
<span class="line-old-header">*** 421,10 ***</span>
<span class="line-new-header">--- 452,12 ---</span>
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &#39;echo VS_LIB=&quot;%LIB% &quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &#39;echo VCINSTALLDIR=&quot;%VCINSTALLDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
<span class="line-added">+         $ECHO &#39;echo VCToolsRedistDir=&quot;%VCToolsRedistDir% &quot; &gt;&gt; set-vs-env.sh&#39; \</span>
<span class="line-added">+             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE</span>
          $ECHO &#39;echo WindowsSdkDir=&quot;%WindowsSdkDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &#39;echo WINDOWSSDKDIR=&quot;%WINDOWSSDKDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
        else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 438,10 ***</span>
<span class="line-new-header">--- 471,12 ---</span>
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_LIB=&quot;&#39;\&quot;$LIB\;$lib \&quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &quot;$WINPATH_BASH -c &#39;echo VCINSTALLDIR=&quot;&#39;\&quot;$VCINSTALLDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
<span class="line-added">+         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCToolsRedistDir=&quot;&#39;\&quot;$VCToolsRedistDir \&quot; &gt;&gt; set-vs-env.sh&#39; \</span>
<span class="line-added">+             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE</span>
          $ECHO &quot;$WINPATH_BASH -c &#39;echo WindowsSdkDir=&quot;&#39;\&quot;$WindowsSdkDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
          $ECHO &quot;$WINPATH_BASH -c &#39;echo WINDOWSSDKDIR=&quot;&#39;\&quot;$WINDOWSSDKDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
              &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
        fi
</pre>
<hr />
<pre>
<span class="line-old-header">*** 449,11 ***</span>
        # Now execute the newly created bat file.
        # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
        # Change directory so we don&#39;t need to mess with Windows paths in redirects.
        cd $VS_ENV_TMP_DIR
        $CMD /c extract-vs-env.bat | $CAT
<span class="line-modified">!       cd $CURDIR</span>
  
        if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
          AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
          AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
          AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
<span class="line-new-header">--- 484,11 ---</span>
        # Now execute the newly created bat file.
        # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
        # Change directory so we don&#39;t need to mess with Windows paths in redirects.
        cd $VS_ENV_TMP_DIR
        $CMD /c extract-vs-env.bat | $CAT
<span class="line-modified">!       cd $CONFIGURE_START_DIR</span>
  
        if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
          AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
          AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
          AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
</pre>
<hr />
<pre>
<span class="line-old-header">*** 515,10 ***</span>
<span class="line-new-header">--- 550,11 ---</span>
        AC_MSG_RESULT([ok])
        # Remove any trailing &quot;\&quot; &quot;;&quot; and &quot; &quot; from the variables.
        VS_INCLUDE=`$ECHO &quot;$VS_INCLUDE&quot; | $SED -e &#39;s/\\\\*;* *$//&#39;`
        VS_LIB=`$ECHO &quot;$VS_LIB&quot; | $SED &#39;s/\\\\*;* *$//&#39;`
        VCINSTALLDIR=`$ECHO &quot;$VCINSTALLDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
<span class="line-added">+       VCToolsRedistDir=`$ECHO &quot;$VCToolsRedistDir&quot; | $SED &#39;s/\\\\* *$//&#39;`</span>
        WindowsSdkDir=`$ECHO &quot;$WindowsSdkDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
        WINDOWSSDKDIR=`$ECHO &quot;$WINDOWSSDKDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
        if test -z &quot;$WINDOWSSDKDIR&quot;; then
          WINDOWSSDKDIR=&quot;$WindowsSdkDir&quot;
        fi
</pre>
<hr />
<pre>
<span class="line-old-header">*** 636,15 ***</span>
            POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
          else
            POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
          fi
        else
<span class="line-modified">!         # Probe: Using well-known location from VS 2017</span>
          if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
<span class="line-modified">!           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_INSTALL_DIR/Redist/MSVC/*/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
          else
<span class="line-modified">!           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_INSTALL_DIR/Redist/MSVC/*/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
          fi
        fi
        # In case any of the above finds more than one file, loop over them.
        for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
          $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
<span class="line-new-header">--- 672,17 ---</span>
            POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
          else
            POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
          fi
        else
<span class="line-modified">!         CYGWIN_VC_TOOLS_REDIST_DIR=&quot;$VCToolsRedistDir&quot;</span>
<span class="line-added">+         BASIC_FIXUP_PATH(CYGWIN_VC_TOOLS_REDIST_DIR)</span>
<span class="line-added">+         # Probe: Using well-known location from VS 2017 and VS 2019</span>
          if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
<span class="line-modified">!           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
          else
<span class="line-modified">!           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
          fi
        fi
        # In case any of the above finds more than one file, loop over them.
        for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
          $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 768,11 ***</span>
        [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
  
    if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
      AC_MSG_CHECKING([for UCRT DLL dir])
      if test &quot;x$with_ucrt_dll_dir&quot; != x; then
<span class="line-modified">!       if test -z &quot;$(ls -d $with_ucrt_dll_dir/*.dll 2&gt; /dev/null)&quot;; then</span>
          AC_MSG_RESULT([no])
          AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
        else
          AC_MSG_RESULT([$with_ucrt_dll_dir])
          UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
<span class="line-new-header">--- 806,11 ---</span>
        [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
  
    if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
      AC_MSG_CHECKING([for UCRT DLL dir])
      if test &quot;x$with_ucrt_dll_dir&quot; != x; then
<span class="line-modified">!       if test -z &quot;$(ls -d &quot;$with_ucrt_dll_dir/&quot;*.dll 2&gt; /dev/null)&quot;; then</span>
          AC_MSG_RESULT([no])
          AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
        else
          AC_MSG_RESULT([$with_ucrt_dll_dir])
          UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
</pre>
<center><a href="toolchain.m4.cdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="version-numbers.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>