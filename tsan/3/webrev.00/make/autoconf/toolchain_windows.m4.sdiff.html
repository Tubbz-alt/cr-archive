<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/autoconf/toolchain_windows.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="toolchain.m4.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="version-numbers.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/autoconf/toolchain_windows.m4</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 #
<span class="line-modified">  2 # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # The order of these defines the priority by which we try to find them.
<span class="line-modified"> 28 VALID_VS_VERSIONS=&quot;2017 2013 2015 2012 2010&quot;</span>
 29 
 30 VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
 31 VS_VERSION_INTERNAL_2010=100
 32 VS_MSVCR_2010=msvcr100.dll
 33 # We don&#39;t use msvcp on Visual Studio 2010
 34 #VS_MSVCP_2010=msvcp100.dll
 35 VS_ENVVAR_2010=&quot;VS100COMNTOOLS&quot;
 36 VS_VS_INSTALLDIR_2010=&quot;Microsoft Visual Studio 10.0&quot;
 37 VS_SDK_INSTALLDIR_2010=&quot;Microsoft SDKs/Windows/v7.1&quot;
 38 VS_VS_PLATFORM_NAME_2010=&quot;v100&quot;
 39 VS_SDK_PLATFORM_NAME_2010=&quot;Windows7.1SDK&quot;
 40 VS_SUPPORTED_2010=false
 41 
 42 VS_DESCRIPTION_2012=&quot;Microsoft Visual Studio 2012&quot;
 43 VS_VERSION_INTERNAL_2012=110
 44 VS_MSVCR_2012=msvcr110.dll
 45 VS_MSVCP_2012=msvcp110.dll
 46 VS_ENVVAR_2012=&quot;VS110COMNTOOLS&quot;
 47 VS_VS_INSTALLDIR_2012=&quot;Microsoft Visual Studio 11.0&quot;
 48 VS_SDK_INSTALLDIR_2012=
</pre>
<hr />
<pre>
 70 VS_SDK_INSTALLDIR_2015=
 71 VS_VS_PLATFORM_NAME_2015=&quot;v140&quot;
 72 VS_SDK_PLATFORM_NAME_2015=
 73 # The vcvars of 2015 breaks if 2017 is also installed. Work around this by
 74 # explicitly specifying Windows Kit 8.1 to be used.
 75 VS_ENV_ARGS_2015=&quot;8.1&quot;
 76 VS_SUPPORTED_2015=false
 77 
 78 VS_DESCRIPTION_2017=&quot;Microsoft Visual Studio 2017&quot;
 79 VS_VERSION_INTERNAL_2017=141
 80 VS_MSVCR_2017=vcruntime140.dll
 81 VS_MSVCP_2017=msvcp140.dll
 82 VS_ENVVAR_2017=&quot;VS150COMNTOOLS&quot;
 83 VS_USE_UCRT_2017=&quot;true&quot;
 84 VS_VS_INSTALLDIR_2017=&quot;Microsoft Visual Studio/2017&quot;
 85 VS_EDITIONS_2017=&quot;BuildTools Community Professional Enterprise&quot;
 86 VS_SDK_INSTALLDIR_2017=
 87 VS_VS_PLATFORM_NAME_2017=&quot;v141&quot;
 88 VS_SDK_PLATFORM_NAME_2017=
 89 VS_SUPPORTED_2017=true















 90 
 91 ################################################################################
 92 
 93 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT],
 94 [
 95   if test &quot;x$VS_ENV_CMD&quot; = x; then
 96     VS_VERSION=&quot;$1&quot;
 97     VS_BASE=&quot;$2&quot;
 98     METHOD=&quot;$3&quot;
 99 
100     BASIC_WINDOWS_REWRITE_AS_UNIX_PATH(VS_BASE)
<span class="line-modified">101     # In VS 2017, the default installation is in a subdir named after the edition.</span>
102     # Find the first one present and use that.
103     if test &quot;x$VS_EDITIONS&quot; != x; then
104       for edition in $VS_EDITIONS; do
105         if test -d &quot;$VS_BASE/$edition&quot;; then
106           VS_BASE=&quot;$VS_BASE/$edition&quot;
107           break
108         fi
109       done
110     fi
111 
112     if test -d &quot;$VS_BASE&quot;; then
113       AC_MSG_NOTICE([Found Visual Studio installation at $VS_BASE using $METHOD])
114       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
115         VCVARSFILES=&quot;vc/bin/vcvars32.bat vc/auxiliary/build/vcvars32.bat&quot;
116       else
117         VCVARSFILES=&quot;vc/bin/amd64/vcvars64.bat vc/bin/x86_amd64/vcvarsx86_amd64.bat \
118             VC/Auxiliary/Build/vcvarsx86_amd64.bat VC/Auxiliary/Build/vcvars64.bat&quot;
119       fi
120 
121       for VCVARSFILE in $VCVARSFILES; do
</pre>
<hr />
<pre>
160         else
161           VS_ENV_ARGS=&quot;/x64&quot;
162         fi
163         # PLATFORM_TOOLSET is used during the compilation of the freetype sources (see
164         # &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be &#39;Windows7.1SDK&#39; for Windows7.1SDK
165         # TODO: improve detection for other versions of SDK
166         eval PLATFORM_TOOLSET=&quot;\${VS_SDK_PLATFORM_NAME_${VS_VERSION}}&quot;
167       else
168         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
169         AC_MSG_NOTICE([Warning: Installation is broken, SetEnv.Cmd is missing. Ignoring])
170       fi
171     fi
172   fi
173 ])
174 
175 ################################################################################
176 # Finds the bat or cmd file in Visual Studio or the SDK that sets up a proper
177 # build environment and assigns it to VS_ENV_CMD
178 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE],
179 [









180   VS_VERSION=&quot;$1&quot;
181   eval VS_COMNTOOLS_VAR=&quot;\${VS_ENVVAR_${VS_VERSION}}&quot;
182   eval VS_COMNTOOLS=&quot;\$${VS_COMNTOOLS_VAR}&quot;
183   eval VS_INSTALL_DIR=&quot;\${VS_VS_INSTALLDIR_${VS_VERSION}}&quot;
184   eval VS_EDITIONS=&quot;\${VS_EDITIONS_${VS_VERSION}}&quot;
185   eval SDK_INSTALL_DIR=&quot;\${VS_SDK_INSTALLDIR_${VS_VERSION}}&quot;
186   eval VS_ENV_ARGS=&quot;\${VS_ENV_ARGS_${VS_VERSION}}&quot;



187 
188   # When using --with-tools-dir, assume it points to the correct and default
189   # version of Visual Studio or that --with-toolchain-version was also set.
190   if test &quot;x$with_tools_dir&quot; != x; then
191     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
192         [$with_tools_dir/../..], [--with-tools-dir])
193     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
194         [$with_tools_dir/../../..], [--with-tools-dir])
195     if test &quot;x$VS_ENV_CMD&quot; = x; then
196       # Having specified an argument which is incorrect will produce an instant failure;
197       # we should not go on looking
198       AC_MSG_NOTICE([The path given by --with-tools-dir does not contain a valid])
199       AC_MSG_NOTICE([Visual Studio installation. Please point to the VC/bin or VC/bin/amd64])
200       AC_MSG_NOTICE([directory within the Visual Studio installation])
201       AC_MSG_ERROR([Cannot locate a valid Visual Studio installation])
202     fi
203   fi
204 
<span class="line-removed">205   VS_ENV_CMD=&quot;&quot;</span>
<span class="line-removed">206 </span>
207   if test &quot;x$VS_COMNTOOLS&quot; != x; then
208     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
209         [$VS_COMNTOOLS/../..], [$VS_COMNTOOLS_VAR variable])
210   fi
211   if test &quot;x$PROGRAMFILES&quot; != x; then
212     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
213         [$PROGRAMFILES/$VS_INSTALL_DIR], [well-known name])
214   fi
215   # Work around the insanely named ProgramFiles(x86) env variable
216   PROGRAMFILES_X86=&quot;`env | $SED -n &#39;s/^ProgramFiles(x86)=//p&#39;`&quot;
217   if test &quot;x$PROGRAMFILES_X86&quot; != x; then
218     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
219         [$PROGRAMFILES_X86/$VS_INSTALL_DIR], [well-known name])
220   fi
221   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
222       [C:/Program Files/$VS_INSTALL_DIR], [well-known name])
223   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
224       [C:/Program Files (x86)/$VS_INSTALL_DIR], [well-known name])
225   if test &quot;x$SDK_INSTALL_DIR&quot; != x; then
226     if test &quot;x$ProgramW6432&quot; != x; then
227       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
228           [$ProgramW6432/$SDK_INSTALL_DIR], [well-known name])
229     fi
230     if test &quot;x$PROGRAMW6432&quot; != x; then
231       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
232           [$PROGRAMW6432/$SDK_INSTALL_DIR], [well-known name])
233     fi
234     if test &quot;x$PROGRAMFILES&quot; != x; then
235       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
236           [$PROGRAMFILES/$SDK_INSTALL_DIR], [well-known name])
237     fi
238     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
239         [C:/Program Files/$SDK_INSTALL_DIR], [well-known name])
240     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
241         [C:/Program Files (x86)/$SDK_INSTALL_DIR], [well-known name])
242   fi






243 ])
244 
245 ################################################################################
246 
247 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO],
248 [
249   AC_ARG_WITH(toolchain-version, [AS_HELP_STRING([--with-toolchain-version],
250       [the version of the toolchain to look for, use &#39;--help&#39; to show possible values @&lt;:@platform dependent@:&gt;@])])
251 
252   if test &quot;x$with_toolchain_version&quot; = xlist; then
253     # List all toolchains
254     AC_MSG_NOTICE([The following toolchain versions are valid on this platform:])
255     for version in $VALID_VS_VERSIONS; do
256       eval VS_DESCRIPTION=\${VS_DESCRIPTION_$version}
257       $PRINTF &quot;  %-10s  %s\n&quot; $version &quot;$VS_DESCRIPTION&quot;
258     done
259 
260     exit 0
261   elif test &quot;x$DEVKIT_VS_VERSION&quot; != x; then
262     VS_VERSION=$DEVKIT_VS_VERSION
</pre>
<hr />
<pre>
406       # call C:/progra~2/micros~2.0/vc/bin/amd64/vcvars64.bat
407       $ECHO &quot;call \&quot;$WINPATH_VS_ENV_CMD\&quot; $VS_ENV_ARGS&quot; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
408       # In some cases, the VS_ENV_CMD will change directory, change back so
409       # the set-vs-env.sh ends up in the right place.
410       $ECHO &#39;cd %~dp0&#39; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
411       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
412         # These will end up something like:
413         # echo VS_PATH=\&quot;$PATH\&quot; &gt; set-vs-env.sh
414         # The trailing space for everyone except PATH is no typo, but is needed due
415         # to trailing \ in the Windows paths. These will be stripped later.
416         # Trying pure CMD extract. This results in windows paths that need to
417         # be converted post extraction, but a simpler script.
418         $ECHO &#39;echo VS_PATH=&quot;%PATH%&quot; &gt; set-vs-env.sh&#39; \
419             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
420         $ECHO &#39;echo VS_INCLUDE=&quot;%INCLUDE% &quot; &gt;&gt; set-vs-env.sh&#39; \
421             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
422         $ECHO &#39;echo VS_LIB=&quot;%LIB% &quot; &gt;&gt; set-vs-env.sh&#39; \
423             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
424         $ECHO &#39;echo VCINSTALLDIR=&quot;%VCINSTALLDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
425             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE


426         $ECHO &#39;echo WindowsSdkDir=&quot;%WindowsSdkDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
427             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
428         $ECHO &#39;echo WINDOWSSDKDIR=&quot;%WINDOWSSDKDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
429             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
430       else
431         # These will end up something like:
432         # C:/CygWin/bin/bash -c &#39;echo VS_PATH=\&quot;$PATH\&quot; &gt; localdevenv.sh
433         # The trailing space for everyone except PATH is no typo, but is needed due
434         # to trailing \ in the Windows paths. These will be stripped later.
435         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_PATH=&quot;&#39;\&quot;$PATH\&quot; &gt; set-vs-env.sh&#39; \
436             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
437         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_INCLUDE=&quot;&#39;\&quot;$INCLUDE\;$include \&quot; &gt;&gt; set-vs-env.sh&#39; \
438             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
439         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_LIB=&quot;&#39;\&quot;$LIB\;$lib \&quot; &gt;&gt; set-vs-env.sh&#39; \
440             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
441         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCINSTALLDIR=&quot;&#39;\&quot;$VCINSTALLDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
442             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE


443         $ECHO &quot;$WINPATH_BASH -c &#39;echo WindowsSdkDir=&quot;&#39;\&quot;$WindowsSdkDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
444             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
445         $ECHO &quot;$WINPATH_BASH -c &#39;echo WINDOWSSDKDIR=&quot;&#39;\&quot;$WINDOWSSDKDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
446             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
447       fi
448 
449       # Now execute the newly created bat file.
450       # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
451       # Change directory so we don&#39;t need to mess with Windows paths in redirects.
452       cd $VS_ENV_TMP_DIR
453       $CMD /c extract-vs-env.bat | $CAT
<span class="line-modified">454       cd $CURDIR</span>
455 
456       if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
457         AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
458         AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
459         AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
460         AC_MSG_ERROR([Cannot continue])
461       fi
462 
463       # Remove windows line endings
464       $SED -i -e &#39;s|\r||g&#39; $VS_ENV_TMP_DIR/set-vs-env.sh
465 
466       # Now set all paths and other env variables. This will allow the rest of
467       # the configure script to find and run the compiler in the proper way.
468       AC_MSG_NOTICE([Setting extracted environment variables])
469       . $VS_ENV_TMP_DIR/set-vs-env.sh
470       # Now we have VS_PATH, VS_INCLUDE, VS_LIB. For further checking, we
471       # also define VCINSTALLDIR, WindowsSdkDir and WINDOWSSDKDIR.
472 
473       # In WSL, the extracted VS_PATH is Windows style. This needs to be
474       # rewritten as Unix style and the Windows style version is saved
</pre>
<hr />
<pre>
500     else
501       # We did not find a vsvars bat file, let&#39;s hope we are run from a VS command prompt.
502       AC_MSG_NOTICE([Cannot locate a valid Visual Studio installation, checking current environment])
503     fi
504   fi
505 
506   # At this point, we should have correct variables in the environment, or we can&#39;t continue.
507   AC_MSG_CHECKING([for Visual Studio variables])
508 
509   if test &quot;x$VCINSTALLDIR&quot; != x || test &quot;x$WindowsSDKDir&quot; != x \
510       || test &quot;x$WINDOWSSDKDIR&quot; != x || test &quot;x$DEVKIT_NAME&quot; != x; then
511     if test &quot;x$VS_INCLUDE&quot; = x || test &quot;x$VS_LIB&quot; = x; then
512       AC_MSG_RESULT([present but broken])
513       AC_MSG_ERROR([Your VC command prompt seems broken, INCLUDE and/or LIB is missing.])
514     else
515       AC_MSG_RESULT([ok])
516       # Remove any trailing &quot;\&quot; &quot;;&quot; and &quot; &quot; from the variables.
517       VS_INCLUDE=`$ECHO &quot;$VS_INCLUDE&quot; | $SED -e &#39;s/\\\\*;* *$//&#39;`
518       VS_LIB=`$ECHO &quot;$VS_LIB&quot; | $SED &#39;s/\\\\*;* *$//&#39;`
519       VCINSTALLDIR=`$ECHO &quot;$VCINSTALLDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`

520       WindowsSdkDir=`$ECHO &quot;$WindowsSdkDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
521       WINDOWSSDKDIR=`$ECHO &quot;$WINDOWSSDKDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
522       if test -z &quot;$WINDOWSSDKDIR&quot;; then
523         WINDOWSSDKDIR=&quot;$WindowsSdkDir&quot;
524       fi
525       # Remove any paths containing # (typically F#) as that messes up make. This
526       # is needed if visual studio was installed with F# support.
527       VS_PATH=`$ECHO &quot;$VS_PATH&quot; | $SED &#39;s/[[^:#]]*#[^:]*://g&#39;`
528 
529       AC_SUBST(VS_PATH)
530       AC_SUBST(VS_INCLUDE)
531       AC_SUBST(VS_LIB)
532 
533       # Convert VS_INCLUDE into SYSROOT_CFLAGS
534       OLDIFS=&quot;$IFS&quot;
535       IFS=&quot;;&quot;
536       for i in $VS_INCLUDE; do
537         ipath=$i
538         # Only process non-empty elements
539         if test &quot;x$ipath&quot; != x; then
</pre>
<hr />
<pre>
621   fi
622 ])
623 
624 AC_DEFUN([TOOLCHAIN_SETUP_MSVC_DLL],
625 [
626   DLL_NAME=&quot;$1&quot;
627   MSVC_DLL=
628 
629   if test &quot;x$MSVC_DLL&quot; = x; then
630     if test &quot;x$VCINSTALLDIR&quot; != x; then
631       CYGWIN_VC_INSTALL_DIR=&quot;$VCINSTALLDIR&quot;
632       BASIC_FIXUP_PATH(CYGWIN_VC_INSTALL_DIR)
633       if test &quot;$VS_VERSION&quot; -lt 2017; then
634         # Probe: Using well-known location from Visual Studio 12.0 and older
635         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
636           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
637         else
638           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
639         fi
640       else
<span class="line-modified">641         # Probe: Using well-known location from VS 2017</span>


642         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
<span class="line-modified">643           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_INSTALL_DIR/Redist/MSVC/*/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
644         else
<span class="line-modified">645           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_INSTALL_DIR/Redist/MSVC/*/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
646         fi
647       fi
648       # In case any of the above finds more than one file, loop over them.
649       for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
650         $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
651         TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$possible_msvc_dll],
652             [well-known location in VCINSTALLDIR])
653       done
654     fi
655   fi
656 
657   if test &quot;x$MSVC_DLL&quot; = x; then
658     # Probe: Check in the Boot JDK directory.
659     POSSIBLE_MSVC_DLL=&quot;$BOOT_JDK/bin/$DLL_NAME&quot;
660     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
661         [well-known location in Boot JDK])
662   fi
663 
664   if test &quot;x$MSVC_DLL&quot; = x; then
665     # Probe: Look in the Windows system32 directory
</pre>
<hr />
<pre>
753       MSVCP_DLL=&quot;$MSVC_DLL&quot;
754     elif test &quot;x$DEVKIT_MSVCP_DLL&quot; != x; then
755       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$DEVKIT_MSVCP_DLL], [devkit])
756       if test &quot;x$MSVC_DLL&quot; = x; then
757         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by devkit])
758       fi
759       MSVCP_DLL=&quot;$MSVC_DLL&quot;
760     else
761       TOOLCHAIN_SETUP_MSVC_DLL([${MSVCP_NAME}])
762       MSVCP_DLL=&quot;$MSVC_DLL&quot;
763     fi
764     AC_SUBST(MSVCP_DLL)
765   fi
766 
767   AC_ARG_WITH(ucrt-dll-dir, [AS_HELP_STRING([--with-ucrt-dll-dir],
768       [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
769 
770   if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
771     AC_MSG_CHECKING([for UCRT DLL dir])
772     if test &quot;x$with_ucrt_dll_dir&quot; != x; then
<span class="line-modified">773       if test -z &quot;$(ls -d $with_ucrt_dll_dir/*.dll 2&gt; /dev/null)&quot;; then</span>
774         AC_MSG_RESULT([no])
775         AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
776       else
777         AC_MSG_RESULT([$with_ucrt_dll_dir])
778         UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
779         BASIC_FIXUP_PATH([UCRT_DLL_DIR])
780       fi
781     elif test &quot;x$DEVKIT_UCRT_DLL_DIR&quot; != &quot;x&quot;; then
782       UCRT_DLL_DIR=&quot;$DEVKIT_UCRT_DLL_DIR&quot;
783       AC_MSG_RESULT($UCRT_DLL_DIR)
784     else
785       CYGWIN_WINDOWSSDKDIR=&quot;${WINDOWSSDKDIR}&quot;
786       BASIC_FIXUP_PATH([CYGWIN_WINDOWSSDKDIR])
787       dll_subdir=$OPENJDK_TARGET_CPU
788       if test &quot;x$dll_subdir&quot; = &quot;xx86_64&quot;; then
789         dll_subdir=&quot;x64&quot;
790       fi
791       UCRT_DLL_DIR=&quot;$CYGWIN_WINDOWSSDKDIR/Redist/ucrt/DLLs/$dll_subdir&quot;
792       if test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
793         # Try with version subdir
</pre>
</td>
<td>
<hr />
<pre>
  1 #
<span class="line-modified">  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # The order of these defines the priority by which we try to find them.
<span class="line-modified"> 28 VALID_VS_VERSIONS=&quot;2017 2019 2013 2015 2012 2010&quot;</span>
 29 
 30 VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
 31 VS_VERSION_INTERNAL_2010=100
 32 VS_MSVCR_2010=msvcr100.dll
 33 # We don&#39;t use msvcp on Visual Studio 2010
 34 #VS_MSVCP_2010=msvcp100.dll
 35 VS_ENVVAR_2010=&quot;VS100COMNTOOLS&quot;
 36 VS_VS_INSTALLDIR_2010=&quot;Microsoft Visual Studio 10.0&quot;
 37 VS_SDK_INSTALLDIR_2010=&quot;Microsoft SDKs/Windows/v7.1&quot;
 38 VS_VS_PLATFORM_NAME_2010=&quot;v100&quot;
 39 VS_SDK_PLATFORM_NAME_2010=&quot;Windows7.1SDK&quot;
 40 VS_SUPPORTED_2010=false
 41 
 42 VS_DESCRIPTION_2012=&quot;Microsoft Visual Studio 2012&quot;
 43 VS_VERSION_INTERNAL_2012=110
 44 VS_MSVCR_2012=msvcr110.dll
 45 VS_MSVCP_2012=msvcp110.dll
 46 VS_ENVVAR_2012=&quot;VS110COMNTOOLS&quot;
 47 VS_VS_INSTALLDIR_2012=&quot;Microsoft Visual Studio 11.0&quot;
 48 VS_SDK_INSTALLDIR_2012=
</pre>
<hr />
<pre>
 70 VS_SDK_INSTALLDIR_2015=
 71 VS_VS_PLATFORM_NAME_2015=&quot;v140&quot;
 72 VS_SDK_PLATFORM_NAME_2015=
 73 # The vcvars of 2015 breaks if 2017 is also installed. Work around this by
 74 # explicitly specifying Windows Kit 8.1 to be used.
 75 VS_ENV_ARGS_2015=&quot;8.1&quot;
 76 VS_SUPPORTED_2015=false
 77 
 78 VS_DESCRIPTION_2017=&quot;Microsoft Visual Studio 2017&quot;
 79 VS_VERSION_INTERNAL_2017=141
 80 VS_MSVCR_2017=vcruntime140.dll
 81 VS_MSVCP_2017=msvcp140.dll
 82 VS_ENVVAR_2017=&quot;VS150COMNTOOLS&quot;
 83 VS_USE_UCRT_2017=&quot;true&quot;
 84 VS_VS_INSTALLDIR_2017=&quot;Microsoft Visual Studio/2017&quot;
 85 VS_EDITIONS_2017=&quot;BuildTools Community Professional Enterprise&quot;
 86 VS_SDK_INSTALLDIR_2017=
 87 VS_VS_PLATFORM_NAME_2017=&quot;v141&quot;
 88 VS_SDK_PLATFORM_NAME_2017=
 89 VS_SUPPORTED_2017=true
<span class="line-added"> 90 VS_TOOLSET_SUPPORTED_2017=true</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92 VS_DESCRIPTION_2019=&quot;Microsoft Visual Studio 2019&quot;</span>
<span class="line-added"> 93 VS_VERSION_INTERNAL_2019=141</span>
<span class="line-added"> 94 VS_MSVCR_2019=vcruntime140.dll</span>
<span class="line-added"> 95 VS_MSVCP_2019=msvcp140.dll</span>
<span class="line-added"> 96 VS_ENVVAR_2019=&quot;VS160COMNTOOLS&quot;</span>
<span class="line-added"> 97 VS_USE_UCRT_2019=&quot;true&quot;</span>
<span class="line-added"> 98 VS_VS_INSTALLDIR_2019=&quot;Microsoft Visual Studio/2019&quot;</span>
<span class="line-added"> 99 VS_EDITIONS_2019=&quot;BuildTools Community Professional Enterprise&quot;</span>
<span class="line-added">100 VS_SDK_INSTALLDIR_2019=</span>
<span class="line-added">101 VS_VS_PLATFORM_NAME_2019=&quot;v142&quot;</span>
<span class="line-added">102 VS_SDK_PLATFORM_NAME_2019=</span>
<span class="line-added">103 VS_SUPPORTED_2019=false</span>
<span class="line-added">104 VS_TOOLSET_SUPPORTED_2019=false</span>
105 
106 ################################################################################
107 
108 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT],
109 [
110   if test &quot;x$VS_ENV_CMD&quot; = x; then
111     VS_VERSION=&quot;$1&quot;
112     VS_BASE=&quot;$2&quot;
113     METHOD=&quot;$3&quot;
114 
115     BASIC_WINDOWS_REWRITE_AS_UNIX_PATH(VS_BASE)
<span class="line-modified">116     # In VS 2017 and VS 2019, the default installation is in a subdir named after the edition.</span>
117     # Find the first one present and use that.
118     if test &quot;x$VS_EDITIONS&quot; != x; then
119       for edition in $VS_EDITIONS; do
120         if test -d &quot;$VS_BASE/$edition&quot;; then
121           VS_BASE=&quot;$VS_BASE/$edition&quot;
122           break
123         fi
124       done
125     fi
126 
127     if test -d &quot;$VS_BASE&quot;; then
128       AC_MSG_NOTICE([Found Visual Studio installation at $VS_BASE using $METHOD])
129       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
130         VCVARSFILES=&quot;vc/bin/vcvars32.bat vc/auxiliary/build/vcvars32.bat&quot;
131       else
132         VCVARSFILES=&quot;vc/bin/amd64/vcvars64.bat vc/bin/x86_amd64/vcvarsx86_amd64.bat \
133             VC/Auxiliary/Build/vcvarsx86_amd64.bat VC/Auxiliary/Build/vcvars64.bat&quot;
134       fi
135 
136       for VCVARSFILE in $VCVARSFILES; do
</pre>
<hr />
<pre>
175         else
176           VS_ENV_ARGS=&quot;/x64&quot;
177         fi
178         # PLATFORM_TOOLSET is used during the compilation of the freetype sources (see
179         # &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be &#39;Windows7.1SDK&#39; for Windows7.1SDK
180         # TODO: improve detection for other versions of SDK
181         eval PLATFORM_TOOLSET=&quot;\${VS_SDK_PLATFORM_NAME_${VS_VERSION}}&quot;
182       else
183         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
184         AC_MSG_NOTICE([Warning: Installation is broken, SetEnv.Cmd is missing. Ignoring])
185       fi
186     fi
187   fi
188 ])
189 
190 ################################################################################
191 # Finds the bat or cmd file in Visual Studio or the SDK that sets up a proper
192 # build environment and assigns it to VS_ENV_CMD
193 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE],
194 [
<span class="line-added">195   # VS2017 provides the option to install previous minor versions of the MSVC</span>
<span class="line-added">196   # toolsets. It is not possible to directly download earlier minor versions of</span>
<span class="line-added">197   # VS2017 and in order to build with a previous minor compiler toolset version,</span>
<span class="line-added">198   # it is now possible to compile with earlier minor versions by passing</span>
<span class="line-added">199   # -vcvars_ver=&lt;toolset_version&gt; argument to vcvarsall.bat.</span>
<span class="line-added">200   AC_ARG_WITH(msvc-toolset-version, [AS_HELP_STRING([--with-msvc-toolset-version],</span>
<span class="line-added">201       [specific MSVC toolset version to use, passed as -vcvars_ver argument to</span>
<span class="line-added">202        pass to vcvarsall.bat (Windows only)])])</span>
<span class="line-added">203 </span>
204   VS_VERSION=&quot;$1&quot;
205   eval VS_COMNTOOLS_VAR=&quot;\${VS_ENVVAR_${VS_VERSION}}&quot;
206   eval VS_COMNTOOLS=&quot;\$${VS_COMNTOOLS_VAR}&quot;
207   eval VS_INSTALL_DIR=&quot;\${VS_VS_INSTALLDIR_${VS_VERSION}}&quot;
208   eval VS_EDITIONS=&quot;\${VS_EDITIONS_${VS_VERSION}}&quot;
209   eval SDK_INSTALL_DIR=&quot;\${VS_SDK_INSTALLDIR_${VS_VERSION}}&quot;
210   eval VS_ENV_ARGS=&quot;\${VS_ENV_ARGS_${VS_VERSION}}&quot;
<span class="line-added">211   eval VS_TOOLSET_SUPPORTED=&quot;\${VS_TOOLSET_SUPPORTED_${VS_VERSION}}&quot;</span>
<span class="line-added">212 </span>
<span class="line-added">213   VS_ENV_CMD=&quot;&quot;</span>
214 
215   # When using --with-tools-dir, assume it points to the correct and default
216   # version of Visual Studio or that --with-toolchain-version was also set.
217   if test &quot;x$with_tools_dir&quot; != x; then
218     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
219         [$with_tools_dir/../..], [--with-tools-dir])
220     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
221         [$with_tools_dir/../../..], [--with-tools-dir])
222     if test &quot;x$VS_ENV_CMD&quot; = x; then
223       # Having specified an argument which is incorrect will produce an instant failure;
224       # we should not go on looking
225       AC_MSG_NOTICE([The path given by --with-tools-dir does not contain a valid])
226       AC_MSG_NOTICE([Visual Studio installation. Please point to the VC/bin or VC/bin/amd64])
227       AC_MSG_NOTICE([directory within the Visual Studio installation])
228       AC_MSG_ERROR([Cannot locate a valid Visual Studio installation])
229     fi
230   fi
231 


232   if test &quot;x$VS_COMNTOOLS&quot; != x; then
233     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
234         [$VS_COMNTOOLS/../..], [$VS_COMNTOOLS_VAR variable])
235   fi
236   if test &quot;x$PROGRAMFILES&quot; != x; then
237     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
238         [$PROGRAMFILES/$VS_INSTALL_DIR], [well-known name])
239   fi
240   # Work around the insanely named ProgramFiles(x86) env variable
241   PROGRAMFILES_X86=&quot;`env | $SED -n &#39;s/^ProgramFiles(x86)=//p&#39;`&quot;
242   if test &quot;x$PROGRAMFILES_X86&quot; != x; then
243     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
244         [$PROGRAMFILES_X86/$VS_INSTALL_DIR], [well-known name])
245   fi
246   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
247       [C:/Program Files/$VS_INSTALL_DIR], [well-known name])
248   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
249       [C:/Program Files (x86)/$VS_INSTALL_DIR], [well-known name])
250   if test &quot;x$SDK_INSTALL_DIR&quot; != x; then
251     if test &quot;x$ProgramW6432&quot; != x; then
252       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
253           [$ProgramW6432/$SDK_INSTALL_DIR], [well-known name])
254     fi
255     if test &quot;x$PROGRAMW6432&quot; != x; then
256       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
257           [$PROGRAMW6432/$SDK_INSTALL_DIR], [well-known name])
258     fi
259     if test &quot;x$PROGRAMFILES&quot; != x; then
260       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
261           [$PROGRAMFILES/$SDK_INSTALL_DIR], [well-known name])
262     fi
263     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
264         [C:/Program Files/$SDK_INSTALL_DIR], [well-known name])
265     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
266         [C:/Program Files (x86)/$SDK_INSTALL_DIR], [well-known name])
267   fi
<span class="line-added">268 </span>
<span class="line-added">269   if test &quot;x$VS_TOOLSET_SUPPORTED&quot; != x; then</span>
<span class="line-added">270     if test &quot;x$with_msvc_toolset_version&quot; != x; then</span>
<span class="line-added">271       VS_ENV_ARGS=&quot;$VS_ENV_ARGS -vcvars_ver=$with_msvc_toolset_version&quot;</span>
<span class="line-added">272     fi</span>
<span class="line-added">273   fi</span>
274 ])
275 
276 ################################################################################
277 
278 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO],
279 [
280   AC_ARG_WITH(toolchain-version, [AS_HELP_STRING([--with-toolchain-version],
281       [the version of the toolchain to look for, use &#39;--help&#39; to show possible values @&lt;:@platform dependent@:&gt;@])])
282 
283   if test &quot;x$with_toolchain_version&quot; = xlist; then
284     # List all toolchains
285     AC_MSG_NOTICE([The following toolchain versions are valid on this platform:])
286     for version in $VALID_VS_VERSIONS; do
287       eval VS_DESCRIPTION=\${VS_DESCRIPTION_$version}
288       $PRINTF &quot;  %-10s  %s\n&quot; $version &quot;$VS_DESCRIPTION&quot;
289     done
290 
291     exit 0
292   elif test &quot;x$DEVKIT_VS_VERSION&quot; != x; then
293     VS_VERSION=$DEVKIT_VS_VERSION
</pre>
<hr />
<pre>
437       # call C:/progra~2/micros~2.0/vc/bin/amd64/vcvars64.bat
438       $ECHO &quot;call \&quot;$WINPATH_VS_ENV_CMD\&quot; $VS_ENV_ARGS&quot; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
439       # In some cases, the VS_ENV_CMD will change directory, change back so
440       # the set-vs-env.sh ends up in the right place.
441       $ECHO &#39;cd %~dp0&#39; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
442       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
443         # These will end up something like:
444         # echo VS_PATH=\&quot;$PATH\&quot; &gt; set-vs-env.sh
445         # The trailing space for everyone except PATH is no typo, but is needed due
446         # to trailing \ in the Windows paths. These will be stripped later.
447         # Trying pure CMD extract. This results in windows paths that need to
448         # be converted post extraction, but a simpler script.
449         $ECHO &#39;echo VS_PATH=&quot;%PATH%&quot; &gt; set-vs-env.sh&#39; \
450             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
451         $ECHO &#39;echo VS_INCLUDE=&quot;%INCLUDE% &quot; &gt;&gt; set-vs-env.sh&#39; \
452             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
453         $ECHO &#39;echo VS_LIB=&quot;%LIB% &quot; &gt;&gt; set-vs-env.sh&#39; \
454             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
455         $ECHO &#39;echo VCINSTALLDIR=&quot;%VCINSTALLDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
456             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
<span class="line-added">457         $ECHO &#39;echo VCToolsRedistDir=&quot;%VCToolsRedistDir% &quot; &gt;&gt; set-vs-env.sh&#39; \</span>
<span class="line-added">458             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE</span>
459         $ECHO &#39;echo WindowsSdkDir=&quot;%WindowsSdkDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
460             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
461         $ECHO &#39;echo WINDOWSSDKDIR=&quot;%WINDOWSSDKDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
462             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
463       else
464         # These will end up something like:
465         # C:/CygWin/bin/bash -c &#39;echo VS_PATH=\&quot;$PATH\&quot; &gt; localdevenv.sh
466         # The trailing space for everyone except PATH is no typo, but is needed due
467         # to trailing \ in the Windows paths. These will be stripped later.
468         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_PATH=&quot;&#39;\&quot;$PATH\&quot; &gt; set-vs-env.sh&#39; \
469             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
470         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_INCLUDE=&quot;&#39;\&quot;$INCLUDE\;$include \&quot; &gt;&gt; set-vs-env.sh&#39; \
471             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
472         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_LIB=&quot;&#39;\&quot;$LIB\;$lib \&quot; &gt;&gt; set-vs-env.sh&#39; \
473             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
474         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCINSTALLDIR=&quot;&#39;\&quot;$VCINSTALLDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
475             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
<span class="line-added">476         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCToolsRedistDir=&quot;&#39;\&quot;$VCToolsRedistDir \&quot; &gt;&gt; set-vs-env.sh&#39; \</span>
<span class="line-added">477             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE</span>
478         $ECHO &quot;$WINPATH_BASH -c &#39;echo WindowsSdkDir=&quot;&#39;\&quot;$WindowsSdkDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
479             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
480         $ECHO &quot;$WINPATH_BASH -c &#39;echo WINDOWSSDKDIR=&quot;&#39;\&quot;$WINDOWSSDKDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
481             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
482       fi
483 
484       # Now execute the newly created bat file.
485       # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
486       # Change directory so we don&#39;t need to mess with Windows paths in redirects.
487       cd $VS_ENV_TMP_DIR
488       $CMD /c extract-vs-env.bat | $CAT
<span class="line-modified">489       cd $CONFIGURE_START_DIR</span>
490 
491       if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
492         AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
493         AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
494         AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
495         AC_MSG_ERROR([Cannot continue])
496       fi
497 
498       # Remove windows line endings
499       $SED -i -e &#39;s|\r||g&#39; $VS_ENV_TMP_DIR/set-vs-env.sh
500 
501       # Now set all paths and other env variables. This will allow the rest of
502       # the configure script to find and run the compiler in the proper way.
503       AC_MSG_NOTICE([Setting extracted environment variables])
504       . $VS_ENV_TMP_DIR/set-vs-env.sh
505       # Now we have VS_PATH, VS_INCLUDE, VS_LIB. For further checking, we
506       # also define VCINSTALLDIR, WindowsSdkDir and WINDOWSSDKDIR.
507 
508       # In WSL, the extracted VS_PATH is Windows style. This needs to be
509       # rewritten as Unix style and the Windows style version is saved
</pre>
<hr />
<pre>
535     else
536       # We did not find a vsvars bat file, let&#39;s hope we are run from a VS command prompt.
537       AC_MSG_NOTICE([Cannot locate a valid Visual Studio installation, checking current environment])
538     fi
539   fi
540 
541   # At this point, we should have correct variables in the environment, or we can&#39;t continue.
542   AC_MSG_CHECKING([for Visual Studio variables])
543 
544   if test &quot;x$VCINSTALLDIR&quot; != x || test &quot;x$WindowsSDKDir&quot; != x \
545       || test &quot;x$WINDOWSSDKDIR&quot; != x || test &quot;x$DEVKIT_NAME&quot; != x; then
546     if test &quot;x$VS_INCLUDE&quot; = x || test &quot;x$VS_LIB&quot; = x; then
547       AC_MSG_RESULT([present but broken])
548       AC_MSG_ERROR([Your VC command prompt seems broken, INCLUDE and/or LIB is missing.])
549     else
550       AC_MSG_RESULT([ok])
551       # Remove any trailing &quot;\&quot; &quot;;&quot; and &quot; &quot; from the variables.
552       VS_INCLUDE=`$ECHO &quot;$VS_INCLUDE&quot; | $SED -e &#39;s/\\\\*;* *$//&#39;`
553       VS_LIB=`$ECHO &quot;$VS_LIB&quot; | $SED &#39;s/\\\\*;* *$//&#39;`
554       VCINSTALLDIR=`$ECHO &quot;$VCINSTALLDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
<span class="line-added">555       VCToolsRedistDir=`$ECHO &quot;$VCToolsRedistDir&quot; | $SED &#39;s/\\\\* *$//&#39;`</span>
556       WindowsSdkDir=`$ECHO &quot;$WindowsSdkDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
557       WINDOWSSDKDIR=`$ECHO &quot;$WINDOWSSDKDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
558       if test -z &quot;$WINDOWSSDKDIR&quot;; then
559         WINDOWSSDKDIR=&quot;$WindowsSdkDir&quot;
560       fi
561       # Remove any paths containing # (typically F#) as that messes up make. This
562       # is needed if visual studio was installed with F# support.
563       VS_PATH=`$ECHO &quot;$VS_PATH&quot; | $SED &#39;s/[[^:#]]*#[^:]*://g&#39;`
564 
565       AC_SUBST(VS_PATH)
566       AC_SUBST(VS_INCLUDE)
567       AC_SUBST(VS_LIB)
568 
569       # Convert VS_INCLUDE into SYSROOT_CFLAGS
570       OLDIFS=&quot;$IFS&quot;
571       IFS=&quot;;&quot;
572       for i in $VS_INCLUDE; do
573         ipath=$i
574         # Only process non-empty elements
575         if test &quot;x$ipath&quot; != x; then
</pre>
<hr />
<pre>
657   fi
658 ])
659 
660 AC_DEFUN([TOOLCHAIN_SETUP_MSVC_DLL],
661 [
662   DLL_NAME=&quot;$1&quot;
663   MSVC_DLL=
664 
665   if test &quot;x$MSVC_DLL&quot; = x; then
666     if test &quot;x$VCINSTALLDIR&quot; != x; then
667       CYGWIN_VC_INSTALL_DIR=&quot;$VCINSTALLDIR&quot;
668       BASIC_FIXUP_PATH(CYGWIN_VC_INSTALL_DIR)
669       if test &quot;$VS_VERSION&quot; -lt 2017; then
670         # Probe: Using well-known location from Visual Studio 12.0 and older
671         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
672           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
673         else
674           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
675         fi
676       else
<span class="line-modified">677         CYGWIN_VC_TOOLS_REDIST_DIR=&quot;$VCToolsRedistDir&quot;</span>
<span class="line-added">678         BASIC_FIXUP_PATH(CYGWIN_VC_TOOLS_REDIST_DIR)</span>
<span class="line-added">679         # Probe: Using well-known location from VS 2017 and VS 2019</span>
680         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
<span class="line-modified">681           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
682         else
<span class="line-modified">683           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;</span>
684         fi
685       fi
686       # In case any of the above finds more than one file, loop over them.
687       for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
688         $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
689         TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$possible_msvc_dll],
690             [well-known location in VCINSTALLDIR])
691       done
692     fi
693   fi
694 
695   if test &quot;x$MSVC_DLL&quot; = x; then
696     # Probe: Check in the Boot JDK directory.
697     POSSIBLE_MSVC_DLL=&quot;$BOOT_JDK/bin/$DLL_NAME&quot;
698     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
699         [well-known location in Boot JDK])
700   fi
701 
702   if test &quot;x$MSVC_DLL&quot; = x; then
703     # Probe: Look in the Windows system32 directory
</pre>
<hr />
<pre>
791       MSVCP_DLL=&quot;$MSVC_DLL&quot;
792     elif test &quot;x$DEVKIT_MSVCP_DLL&quot; != x; then
793       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$DEVKIT_MSVCP_DLL], [devkit])
794       if test &quot;x$MSVC_DLL&quot; = x; then
795         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by devkit])
796       fi
797       MSVCP_DLL=&quot;$MSVC_DLL&quot;
798     else
799       TOOLCHAIN_SETUP_MSVC_DLL([${MSVCP_NAME}])
800       MSVCP_DLL=&quot;$MSVC_DLL&quot;
801     fi
802     AC_SUBST(MSVCP_DLL)
803   fi
804 
805   AC_ARG_WITH(ucrt-dll-dir, [AS_HELP_STRING([--with-ucrt-dll-dir],
806       [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
807 
808   if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
809     AC_MSG_CHECKING([for UCRT DLL dir])
810     if test &quot;x$with_ucrt_dll_dir&quot; != x; then
<span class="line-modified">811       if test -z &quot;$(ls -d &quot;$with_ucrt_dll_dir/&quot;*.dll 2&gt; /dev/null)&quot;; then</span>
812         AC_MSG_RESULT([no])
813         AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
814       else
815         AC_MSG_RESULT([$with_ucrt_dll_dir])
816         UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
817         BASIC_FIXUP_PATH([UCRT_DLL_DIR])
818       fi
819     elif test &quot;x$DEVKIT_UCRT_DLL_DIR&quot; != &quot;x&quot;; then
820       UCRT_DLL_DIR=&quot;$DEVKIT_UCRT_DLL_DIR&quot;
821       AC_MSG_RESULT($UCRT_DLL_DIR)
822     else
823       CYGWIN_WINDOWSSDKDIR=&quot;${WINDOWSSDKDIR}&quot;
824       BASIC_FIXUP_PATH([CYGWIN_WINDOWSSDKDIR])
825       dll_subdir=$OPENJDK_TARGET_CPU
826       if test &quot;x$dll_subdir&quot; = &quot;xx86_64&quot;; then
827         dll_subdir=&quot;x64&quot;
828       fi
829       UCRT_DLL_DIR=&quot;$CYGWIN_WINDOWSSDKDIR/Redist/ucrt/DLLs/$dll_subdir&quot;
830       if test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
831         # Try with version subdir
</pre>
</td>
</tr>
</table>
<center><a href="toolchain.m4.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="version-numbers.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>