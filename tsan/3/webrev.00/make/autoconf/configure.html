<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/autoconf/configure</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #!/bin/bash
  2 #
  3 # Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.
  4 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5 #
  6 # This code is free software; you can redistribute it and/or modify it
  7 # under the terms of the GNU General Public License version 2 only, as
  8 # published by the Free Software Foundation.
  9 #
 10 # This code is distributed in the hope that it will be useful, but WITHOUT
 11 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13 # version 2 for more details (a copy is included in the LICENSE file that
 14 # accompanied this code).
 15 #
 16 # You should have received a copy of the GNU General Public License version
 17 # 2 along with this work; if not, write to the Free Software Foundation,
 18 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19 #
 20 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21 # or visit www.oracle.com if you need additional information or have any
 22 # questions.
 23 #
 24 
 25 if test &quot;x$1&quot; != xCHECKME; then
 26   echo &quot;ERROR: Calling this wrapper script directly is not supported.&quot;
 27   echo &quot;Use the &#39;configure&#39; script in the top-level directory instead.&quot;
 28   exit 1
 29 fi
 30 
 31 # The next argument is the absolute top-level directory path.
 32 # The TOPDIR variable is passed on to configure.ac.
 33 TOPDIR=&quot;$2&quot;
 34 # Remove these two arguments to get to the user supplied arguments
 35 shift
 36 shift
 37 
 38 if test &quot;x$BASH&quot; = x; then
 39   echo &quot;Error: This script must be run using bash.&quot; 1&gt;&amp;2
 40   exit 1
 41 fi
 42 # Force autoconf to use bash. This also means we must disable autoconf re-exec.
 43 export CONFIG_SHELL=$BASH
 44 export _as_can_reexec=no
 45 
 46 # Make sure all shell commands are executed with the C locale
 47 export LC_ALL=C
 48 
 49 if test &quot;x$CUSTOM_CONFIG_DIR&quot; != x; then
 50   custom_hook=$CUSTOM_CONFIG_DIR/custom-hook.m4
 51   if test ! -e $custom_hook; then
 52     echo &quot;CUSTOM_CONFIG_DIR not pointing to a proper custom config dir.&quot;
 53     echo &quot;Error: Cannot continue&quot; 1&gt;&amp;2
 54     exit 1
 55   fi
 56 fi
 57 
 58 CURRENT_DIR=`pwd`
 59 if test &quot;x$CURRENT_DIR&quot; = &quot;x$TOPDIR&quot;; then
 60   # We are running configure from the src root.
 61   # Create &#39;.configure-support&#39; under $TOPDIR/build
 62   build_support_dir=&quot;$TOPDIR/build/.configure-support&quot;
 63 elif test &quot;x$CURRENT_DIR&quot; = &quot;x$CUSTOM_ROOT&quot;; then
 64   # We are running configure from the custom root.
 65   # Create &#39;.configure-support&#39; under $CUSTOM_ROOT/build
 66   build_support_dir=&quot;$CUSTOM_ROOT/build/.configure-support&quot;
 67 else
 68   # We are running configure from outside of the src dir.
 69   # Create &#39;build_support_dir&#39; in the current directory.
 70   build_support_dir=&quot;$CURRENT_DIR/configure-support&quot;
 71 fi
 72 
 73 conf_script_dir=&quot;$TOPDIR/make/autoconf&quot;
 74 generated_script=&quot;$build_support_dir/generated-configure.sh&quot;
 75 
 76 ###
 77 ### Use autoconf to create a runnable configure script, if needed
 78 ###
 79 
 80 autoconf_missing_help() {
 81   APT_GET=&quot;`which apt-get 2&gt; /dev/null | grep -v &#39;^no apt-get in&#39;`&quot;
 82   YUM=&quot;`which yum 2&gt; /dev/null | grep -v &#39;^no yum in&#39;`&quot;
 83   BREW=&quot;`which brew 2&gt; /dev/null | grep -v &#39;^no brew in&#39;`&quot;
 84   ZYPPER=&quot;`which zypper 2&gt; /dev/null | grep -v &#39;^no zypper in&#39;`&quot;
 85   CYGWIN=&quot;`which cygpath 2&gt; /dev/null | grep -v &#39;^no cygpath in&#39;`&quot;
 86 
 87   if test &quot;x$ZYPPER&quot; != x; then
 88     PKGHANDLER_COMMAND=&quot;sudo zypper install autoconf&quot;
 89   elif test &quot;x$APT_GET&quot; != x; then
 90     PKGHANDLER_COMMAND=&quot;sudo apt-get install autoconf&quot;
 91   elif test &quot;x$YUM&quot; != x; then
 92     PKGHANDLER_COMMAND=&quot;sudo yum install autoconf&quot;
 93   elif test &quot;x$BREW&quot; != x; then
 94     PKGHANDLER_COMMAND=&quot;brew install autoconf&quot;
 95   elif test &quot;x$CYGWIN&quot; != x; then
 96     PKGHANDLER_COMMAND=&quot;( cd &lt;location of cygwin setup.exe&gt; &amp;&amp; cmd /c setup -q -P autoconf )&quot;
 97   fi
 98 
 99   if test &quot;x$PKGHANDLER_COMMAND&quot; != x; then
100     echo &quot;You might be able to fix this by running &#39;$PKGHANDLER_COMMAND&#39;.&quot;
101   fi
102 }
103 
104 generate_configure_script() {
105   if test &quot;x$AUTOCONF&quot; != x; then
106     if test ! -x &quot;$AUTOCONF&quot;; then
107       echo
108       echo &quot;The specified AUTOCONF variable does not point to a valid autoconf executable:&quot;
109       echo &quot;AUTOCONF=$AUTOCONF&quot;
110       echo &quot;Error: Cannot continue&quot; 1&gt;&amp;2
111       exit 1
112     fi
113   else
114     AUTOCONF=&quot;`which autoconf 2&gt; /dev/null | grep -v &#39;^no autoconf in&#39;`&quot;
115     if test &quot;x$AUTOCONF&quot; = x; then
116       echo
117       echo &quot;Autoconf is not found on the PATH, and AUTOCONF is not set.&quot;
118       echo &quot;You need autoconf to be able to generate a runnable configure script.&quot;
119       autoconf_missing_help
120       echo &quot;Error: Cannot find autoconf&quot; 1&gt;&amp;2
121       exit 1
122     fi
123   fi
124 
125   autoconf_version=`$AUTOCONF --version | head -1`
126   echo &quot;Using autoconf at ${AUTOCONF} [$autoconf_version]&quot;
127 
128   if test &quot;x$CUSTOM_CONFIG_DIR&quot; != x; then
129     # Generate configure script with custom hooks compiled in.
130     custom_patcher=&#39;sed -e &quot;s|#CUSTOM_AUTOCONF_INCLUDE|m4_include([$custom_hook])|&quot;&#39;
131     custom_script_dir_include=&quot;-I$CUSTOM_CONFIG_DIR&quot;
132   else
133     custom_patcher=&#39;cat&#39;
134     custom_script_dir_include=&quot;&quot;
135   fi
136 
137   mkdir -p $build_support_dir
138   # Call autoconf but replace the &quot;magic&quot; variable in configure.ac if requested.
139 
140   cat $conf_script_dir/configure.ac | eval $custom_patcher | \
141       ${AUTOCONF} -W all $custom_script_dir_include -I$conf_script_dir - \
142       &gt; $generated_script
143   rm -rf autom4te.cache
144 
145   # Sanity check
146   if test ! -s $generated_script; then
147     echo &quot;Error: Failed to generate runnable configure script&quot; 1&gt;&amp;2
148     rm -f $generated_script
149     exit 1
150   fi
151 }
152 
153 test_generated_up_to_date() {
154   conf_source_files=&quot;$conf_script_dir/configure.ac $conf_script_dir/*.m4&quot;
155   if test &quot;x$CUSTOM_CONFIG_DIR&quot; != x; then
156     conf_custom_source_files=&quot;$CUSTOM_CONFIG_DIR/*.m4&quot;
157   else
158     conf_custom_source_files=&quot;&quot;
159   fi
160 
161   for file in $conf_source_files $conf_custom_source_files ; do
162     if test $file -nt $generated_script; then
163       return 0
164     fi
165   done
166   return 1
167 }
168 
169 run_autoconf=false
170 if test &quot;x$1&quot; = xautogen; then
171   # User called us as &quot;configure autogen&quot;, so force regeneration
172   run_autoconf=true
173   shift
174 fi
175 
176 if test ! -s $generated_script; then
177   # Generated script is missing, so we need to create it
178   echo &quot;Runnable configure script is not present&quot;
179   run_autoconf=true
180 else
181   # File is present, but is it up to date?
182   if test_generated_up_to_date; then
183     echo &quot;Runnable configure script is not up to date&quot;
184     run_autoconf=true
185   fi
186 fi
187 
188 if test &quot;x$run_autoconf&quot; = xtrue; then
189   echo &quot;Generating runnable configure script at $generated_script&quot;
190   generate_configure_script
191 fi
192 
193 # Autoconf calls the configure script recursively sometimes.
194 # Don&#39;t start logging twice in that case
195 if test &quot;x$conf_debug_configure&quot; = xtrue; then
196   conf_debug_configure=recursive
197 fi
198 
199 ###
200 ### Process command-line arguments
201 ###
202 
203 # Returns a shell-escaped version of the argument given.
204 function shell_quote() {
205   if [[ -n &quot;$1&quot; ]]; then
206     # Uses only shell-safe characters?  No quoting needed.
207     # &#39;=&#39; is a zsh meta-character, but only in word-initial position.
208     if echo &quot;$1&quot; | grep &#39;^[ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\.:,%/+=_-]\{1,\}$&#39; &gt; /dev/null \
209         &amp;&amp; ! echo &quot;$1&quot; | grep &#39;^=&#39; &gt; /dev/null; then
210       quoted=&quot;$1&quot;
211     else
212       if echo &quot;$1&quot; | grep &quot;[\&#39;!]&quot; &gt; /dev/null; then
213         # csh does history expansion within single quotes, but not
214         # when backslash-escaped!
215         local quoted_quote=&quot;&#39;\\&#39;&#39;&quot; quoted_exclam=&quot;&#39;\\!&#39;&quot;
216         word=&quot;${1//\&#39;/${quoted_quote}}&quot;
217         word=&quot;${1//\!/${quoted_exclam}}&quot;
218       fi
219       quoted=&quot;&#39;$1&#39;&quot;
220     fi
221     echo &quot;$quoted&quot;
222   fi
223 }
224 
225 conf_processed_arguments=()
226 conf_quoted_arguments=()
227 conf_openjdk_target=
228 
229 for conf_option
230 do
231 
232   # Process (and remove) our own extensions that will not be passed to autoconf
233   case $conf_option in
234     --openjdk-target=*)
235       conf_openjdk_target=`expr &quot;X$conf_option&quot; : &#39;[^=]*=\(.*\)&#39;`
236       ;;
237     --debug-configure)
238       if test &quot;x$conf_debug_configure&quot; != xrecursive; then
239         conf_debug_configure=true
240         export conf_debug_configure
241       fi
242       ;;
243     *)
244       conf_processed_arguments=(&quot;${conf_processed_arguments[@]}&quot; &quot;$conf_option&quot;)
245       ;;
246   esac
247 
248   # Store all variables overridden on the command line
249   case $conf_option in
250     [^-]*=*)
251       # Add name of variable to CONFIGURE_OVERRIDDEN_VARIABLES list inside !...!.
252       conf_env_var=`expr &quot;x$conf_option&quot; : &#39;x\([^=]*\)=&#39;`
253       CONFIGURE_OVERRIDDEN_VARIABLES=&quot;$CONFIGURE_OVERRIDDEN_VARIABLES!$conf_env_var!&quot;
254       ;;
255   esac
256 
257   # Save the arguments, intelligently quoted for CONFIGURE_COMMAND_LINE.
258   case $conf_option in
259     *=*)
260       conf_option_name=`expr &quot;x$conf_option&quot; : &#39;x\([^=]*\)=&#39;`
261       conf_option_name=$(shell_quote &quot;$conf_option_name&quot;)
262       conf_option_value=`expr &quot;x$conf_option&quot; : &#39;x[^=]*=\(.*\)&#39;`
263       conf_option_value=$(shell_quote &quot;$conf_option_value&quot;)
264       conf_quoted_arguments=(&quot;${conf_quoted_arguments[@]}&quot; &quot;$conf_option_name=$conf_option_value&quot;)
265       ;;
266     *)
267       conf_quoted_arguments=(&quot;${conf_quoted_arguments[@]}&quot; &quot;$(shell_quote &quot;$conf_option&quot;)&quot;)
268       ;;
269   esac
270 
271   # Check for certain autoconf options that require extra action
272   case $conf_option in
273     -build | --build | --buil | --bui | --bu |-build=* | --build=* | --buil=* | --bui=* | --bu=*)
274       conf_legacy_crosscompile=&quot;$conf_legacy_crosscompile $conf_option&quot; ;;
275     -target | --target | --targe | --targ | --tar | --ta | --t | -target=* | --target=* | --targe=* | --targ=* | --tar=* | --ta=* | --t=*)
276       conf_legacy_crosscompile=&quot;$conf_legacy_crosscompile $conf_option&quot; ;;
277     -host | --host | --hos | --ho | -host=* | --host=* | --hos=* | --ho=*)
278       conf_legacy_crosscompile=&quot;$conf_legacy_crosscompile $conf_option&quot; ;;
279     -help | --help | --hel | --he | -h)
280       conf_print_help=true ;;
281   esac
282 done
283 
284 # Save the quoted command line
285 CONFIGURE_COMMAND_LINE=&quot;${conf_quoted_arguments[@]}&quot;
286 
287 if test &quot;x$conf_legacy_crosscompile&quot; != &quot;x&quot;; then
288   if test &quot;x$conf_openjdk_target&quot; != &quot;x&quot;; then
289     echo &quot;Error: Specifying --openjdk-target together with autoconf&quot;
290     echo &quot;legacy cross-compilation flags is not supported.&quot;
291     echo &quot;You specified: --openjdk-target=$conf_openjdk_target and $conf_legacy_crosscompile.&quot;
292     echo &quot;The recommended use is just --openjdk-target.&quot;
293     exit 1
294   else
295     echo &quot;Warning: You are using legacy autoconf cross-compilation flags.&quot;
296     echo &quot;It is recommended that you use --openjdk-target instead.&quot;
297     echo &quot;&quot;
298   fi
299 fi
300 
301 if test &quot;x$conf_openjdk_target&quot; != &quot;x&quot;; then
302   conf_build_platform=`sh $conf_script_dir/build-aux/config.guess`
303   conf_processed_arguments=(&quot;--build=$conf_build_platform&quot; &quot;--host=$conf_openjdk_target&quot; &quot;--target=$conf_openjdk_target&quot; &quot;${conf_processed_arguments[@]}&quot;)
304 fi
305 
306 # Make configure exit with error on invalid options as default.
307 # Can be overridden by --disable-option-checking, since we prepend our argument
308 # and later options override earlier.
309 conf_processed_arguments=(&quot;--enable-option-checking=fatal&quot; &quot;${conf_processed_arguments[@]}&quot;)
310 
311 ###
312 ### Call the configure script
313 ###
314 if test &quot;x$conf_debug_configure&quot; != x; then
315   # Turn on shell debug output if requested (initial or recursive)
316   set -x
317 fi
318 
319 # Now transfer control to the script generated by autoconf. This is where the
320 # main work is done.
321 RCDIR=`mktemp -dt jdk-build-configure.tmp.XXXXXX` || exit $?
322 trap &quot;rm -rf \&quot;$RCDIR\&quot;&quot; EXIT
323 conf_logfile=./configure.log
324 (exec 3&gt;&amp;1 ; ((. $generated_script &quot;${conf_processed_arguments[@]}&quot; 2&gt;&amp;1 1&gt;&amp;3 ) \
325     ; echo $? &gt; &quot;$RCDIR/rc&quot; ) \
326     | tee -a $conf_logfile 1&gt;&amp;2 ; exec 3&gt;&amp;-) | tee -a $conf_logfile
327 
328 conf_result_code=`cat &quot;$RCDIR/rc&quot;`
329 ###
330 ### Post-processing
331 ###
332 
333 if test $conf_result_code -eq 0; then
334   if test &quot;x$conf_print_help&quot; = xtrue; then
335     cat &lt;&lt;EOT
336 
337 Additional (non-autoconf) OpenJDK Options:
338   --openjdk-target=TARGET cross-compile with TARGET as target platform
339                           (i.e. the one you will run the resulting binary on).
340                           Equivalent to --host=TARGET --target=TARGET
341                           --build=&lt;current platform&gt;
342   --debug-configure       Run the configure script with additional debug
343                           logging enabled.
344 
345 EOT
346 
347     # Print additional help, e.g. a list of toolchains and JVM features.
348     # This must be done by the autoconf script.
349     ( CONFIGURE_PRINT_ADDITIONAL_HELP=true . $generated_script PRINTF=printf )
350 
351     cat &lt;&lt;EOT
352 
353 Please be aware that, when cross-compiling, the OpenJDK configure script will
354 generally use &#39;target&#39; where autoconf traditionally uses &#39;host&#39;.
355 
356 Also note that variables must be passed on the command line. Variables in the
357 environment will generally be ignored, unlike traditional autoconf scripts.
358 EOT
359   fi
360 else
361   echo configure exiting with result code $conf_result_code
362 fi
363 
364 exit $conf_result_code
    </pre>
  </body>
</html>