<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/InitSupport.gmk</title>
    <link rel="stylesheet" href="../style.css" />
    <script type="text/javascript" src="../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #
<a name="1" id="anc1"></a><span class="line-modified">  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # This file contains helper functions for Init.gmk.
 28 # It is divided in two parts, depending on if a SPEC is present or not
 29 # (HAS_SPEC is true or not).
 30 ################################################################################
 31 
 32 ifndef _INITSUPPORT_GMK
 33 _INITSUPPORT_GMK := 1
 34 
 35 ifeq ($(HAS_SPEC),)
 36 
 37   # COMMA is defined in spec.gmk, but that is not included yet
 38   COMMA := ,
 39 
 40   # Include the corresponding closed file, if present.
 41   ifneq ($(CUSTOM_MAKE_DIR), )
 42     -include $(CUSTOM_MAKE_DIR)/InitSupport.gmk
 43   endif
 44 
 45   ##############################################################################
 46   # Helper functions for the initial part of Init.gmk, before the spec file is
 47   # loaded. Most of these functions provide parsing and setting up make options
 48   # from the command-line.
 49   ##############################################################################
 50 
 51   # Make control variables, handled by Init.gmk
 52   INIT_CONTROL_VARIABLES += LOG CONF CONF_NAME SPEC JOBS TEST_JOBS CONF_CHECK \
 53       COMPARE_BUILD JTREG GTEST MICRO TEST_OPTS TEST_VM_OPTS
 54 
 55   # All known make control variables
<a name="2" id="anc2"></a><span class="line-modified"> 56   MAKE_CONTROL_VARIABLES := $(INIT_CONTROL_VARIABLES) TEST JDK_FILTER SPEC_FILTER</span>
 57 
 58   # Define a simple reverse function.
 59   # Should maybe move to MakeBase.gmk, but we can&#39;t include that file now.
 60   reverse = \
 61       $(if $(strip $(1)), $(call reverse, $(wordlist 2, $(words $(1)), $(1)))) \
 62           $(firstword $(1))
 63 
 64   # The variable MAKEOVERRIDES contains variable assignments from the command
 65   # line, but in reverse order to what the user entered.
 66   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 67   COMMAND_LINE_VARIABLES := $(subst \#,\ , $(call reverse, $(subst \ ,\#,$(MAKEOVERRIDES))))
 68 
 69   # A list like FOO=&quot;val1&quot; BAR=&quot;val2&quot; containing all user-supplied make
 70   # variables that we should propagate.
 71   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 72   USER_MAKE_VARS := $(subst \#,\ , $(filter-out $(addsuffix =%, $(INIT_CONTROL_VARIABLES)), \
 73       $(subst \ ,\#,$(MAKEOVERRIDES))))
 74 
 75   # Setup information about available configurations, if any.
 76   ifneq ($(CUSTOM_ROOT), )
 77     build_dir=$(CUSTOM_ROOT)/build
 78   else
 79     build_dir=$(topdir)/build
 80   endif
 81   all_spec_files=$(wildcard $(build_dir)/*/spec.gmk)
 82   # Extract the configuration names from the path
 83   all_confs=$(patsubst %/spec.gmk, %, $(patsubst $(build_dir)/%, %, $(all_spec_files)))
 84 
 85   # Check for unknown command-line variables
 86   define CheckControlVariables
 87     command_line_variables := $$(strip $$(foreach var, \
 88         $$(subst \ ,_,$$(MAKEOVERRIDES)), \
 89         $$(firstword $$(subst =, , $$(var)))))
 90     unknown_command_line_variables := $$(strip \
 91         $$(filter-out $$(MAKE_CONTROL_VARIABLES), $$(command_line_variables)))
 92     ifneq ($$(unknown_command_line_variables), )
 93       $$(info Note: Command line contains non-control variables:)
 94       $$(foreach var, $$(unknown_command_line_variables), $$(info * $$(var)=$$($$(var))))
 95       $$(info Make sure it is not mistyped, and that you intend to override this variable.)
 96       $$(info &#39;make help&#39; will list known control variables.)
 97       $$(info )
 98     endif
 99   endef
100 
101   # Check for deprecated ALT_ variables
102   define CheckDeprecatedEnvironment
103     defined_alt_variables := $$(filter ALT_%, $$(.VARIABLES))
104     ifneq ($$(defined_alt_variables), )
105       $$(info Warning: You have the following ALT_ variables set:)
106       $$(foreach var, $$(defined_alt_variables), $$(info * $$(var)=$$($$(var))))
107       $$(info ALT_ variables are deprecated, and may result in a failed build.)
108       $$(info Please clean your environment.)
109       $$(info )
110     endif
111   endef
112 
113   # Check for invalid make flags like -j
114   define CheckInvalidMakeFlags
115     # This is a trick to get this rule to execute before any other rules
116     # MAKEFLAGS only indicate -j if read in a recipe (!)
117     $$(topdir)/make/Init.gmk: .FORCE
118 	$$(if $$(findstring --jobserver, $$(MAKEFLAGS)), \
119 	    $$(info Error: &#39;make -jN&#39; is not supported, use &#39;make JOBS=N&#39;) \
120 	    $$(error Cannot continue) \
121 	)
122     .FORCE:
123     .PHONY: .FORCE
124   endef
125 
126   # Check that the CONF_CHECK option is valid and set up handling
127   define ParseConfCheckOption
128     ifeq ($$(CONF_CHECK), )
129       # Default behavior is fail
130       CONF_CHECK := fail
131     else ifneq ($$(filter-out auto fail ignore, $$(CONF_CHECK)),)
132       $$(info Error: CONF_CHECK must be one of: auto, fail or ignore.)
133       $$(error Cannot continue)
134     endif
135   endef
136 
137   define ParseConfAndSpec
138     ifneq ($$(origin SPEC), undefined)
139       # We have been given a SPEC, check that it works out properly
140       ifneq ($$(origin CONF), undefined)
141         # We also have a CONF argument. We can&#39;t have both.
142         $$(info Error: Cannot use CONF=$$(CONF) and SPEC=$$(SPEC) at the same time. Choose one.)
143         $$(error Cannot continue)
144       endif
145       ifneq ($$(origin CONF_NAME), undefined)
146         # We also have a CONF_NAME argument. We can&#39;t have both.
147         $$(info Error: Cannot use CONF_NAME=$$(CONF_NAME) and SPEC=$$(SPEC) at the same time. Choose one.)
148         $$(error Cannot continue)
149       endif
150       ifeq ($$(wildcard $$(SPEC)),)
151         $$(info Error: Cannot locate spec.gmk, given by SPEC=$$(SPEC).)
152         $$(error Cannot continue)
153       endif
154       ifeq ($$(filter /%, $$(SPEC)),)
155         # If given with relative path, make it absolute
156         SPECS := $$(CURDIR)/$$(strip $$(SPEC))
157       else
158         SPECS := $$(SPEC)
159       endif
160 
161       # For now, unset this SPEC variable.
162       override SPEC :=
163     else
164       # Use spec.gmk files in the build output directory
165       ifeq ($$(all_spec_files),)
166         ifneq ($(CUSTOM_ROOT), )
167           $$(info Error: No configurations found for $$(CUSTOM_ROOT).)
168         else
169           $$(info Error: No configurations found for $$(topdir).)
170         endif
171         $$(info Please run &#39;bash configure&#39; to create a configuration.)
172         $$(info )
173         $$(error Cannot continue)
174       endif
175 
176       ifneq ($$(origin CONF_NAME), undefined)
177         ifneq ($$(origin CONF), undefined)
178           # We also have a CONF argument. We can&#39;t have both.
179           $$(info Error: Cannot use CONF=$$(CONF) and CONF_NAME=$$(CONF_NAME) at the same time. Choose one.)
180           $$(error Cannot continue)
181         endif
182         matching_conf := $$(strip $$(filter $$(CONF_NAME), $$(all_confs)))
183         ifeq ($$(matching_conf),)
184           $$(info Error: No configurations found matching CONF_NAME=$$(CONF_NAME).)
185           $$(info Available configurations in $$(build_dir):)
186           $$(foreach var, $$(all_confs), $$(info * $$(var)))
187           $$(error Cannot continue)
188         else ifneq ($$(words $$(matching_conf)), 1)
189           $$(info Error: Matching more than one configuration CONF_NAME=$$(CONF_NAME).)
190           $$(info Available configurations in $$(build_dir):)
191           $$(foreach var, $$(all_confs), $$(info * $$(var)))
192           $$(error Cannot continue)
193         else
194           $$(info Building configuration &#39;$$(matching_conf)&#39; (matching CONF_NAME=$$(CONF_NAME)))
195         endif
196         # Create a SPEC definition. This will contain the path to exactly one spec file.
197         SPECS := $$(build_dir)/$$(matching_conf)/spec.gmk
198       else ifneq ($$(origin CONF), undefined)
199         # User have given a CONF= argument.
200         ifeq ($$(CONF),)
201           # If given CONF=, match all configurations
202           matching_confs := $$(strip $$(all_confs))
203         else
204           # Otherwise select those that contain the given CONF string
205           matching_confs := $$(strip $$(foreach var, $$(all_confs), \
206               $$(if $$(findstring $$(CONF), $$(var)), $$(var))))
207         endif
208         ifeq ($$(matching_confs),)
209           $$(info Error: No configurations found matching CONF=$$(CONF).)
210           $$(info Available configurations in $$(build_dir):)
211           $$(foreach var, $$(all_confs), $$(info * $$(var)))
212           $$(error Cannot continue)
213         else
214           # Don&#39;t repeat this output on make restarts caused by including
215           # generated files.
216           ifeq ($$(MAKE_RESTARTS),)
217             ifeq ($$(words $$(matching_confs)), 1)
218               ifneq ($$(findstring $$(LOG_LEVEL), info debug trace),)
219                 $$(info Building configuration &#39;$$(matching_confs)&#39; (matching CONF=$$(CONF)))
220               endif
221             else
222               $$(info Building these configurations (matching CONF=$$(CONF)):)
223               $$(foreach var, $$(matching_confs), $$(info * $$(var)))
224             endif
225           endif
226         endif
227 
228         # Create a SPEC definition. This will contain the path to one or more spec.gmk files.
229         SPECS := $$(addsuffix /spec.gmk, $$(addprefix $$(build_dir)/, $$(matching_confs)))
230       else
231         # No CONF or SPEC given, check the available configurations
232         ifneq ($$(words $$(all_spec_files)), 1)
233           $$(info Error: No CONF given, but more than one configuration found.)
234           $$(info Available configurations in $$(build_dir):)
235           $$(foreach var, $$(all_confs), $$(info * $$(var)))
236           $$(info Please retry building with CONF=&lt;config pattern&gt; (or SPEC=&lt;spec file&gt;).)
237           $$(info )
238           $$(error Cannot continue)
239         endif
240 
241         # We found exactly one configuration, use it
242         SPECS := $$(strip $$(all_spec_files))
243       endif
244     endif
245   endef
246 
247   # Extract main targets from Main.gmk using the spec provided in $2.
248   #
249   # Param 1: FORCE = force generation of main-targets.gmk or LAZY = do not force.
250   # Param 2: The SPEC file to use.
251   define DefineMainTargets
252 
253     # We will start by making sure the main-targets.gmk file is removed, if
254     # make has not been restarted. By the -include, we will trigger the
255     # rule for generating the file (which is never there since we removed it),
256     # thus generating it fresh, and make will restart, incrementing the restart
257     # count.
258     main_targets_file := $$(dir $(strip $2))make-support/main-targets.gmk
259 
260     ifeq ($$(MAKE_RESTARTS),)
261       # Only do this if make has not been restarted, and if we do not force it.
262       ifeq ($(strip $1), FORCE)
263         $$(shell rm -f $$(main_targets_file))
264       endif
265     endif
266 
<a name="3" id="anc3"></a>


267     $$(main_targets_file):
268 	@( cd $$(topdir) &amp;&amp; \
<a name="4" id="anc4"></a><span class="line-modified">269 	$$(MAKE) $$(MAKE_LOG_FLAGS) -r -R -f $$(topdir)/make/Main.gmk \</span>

270 	    -I $$(topdir)/make/common SPEC=$(strip $2) NO_RECIPES=true \
271 	    $$(MAKE_LOG_VARS) \
272 	    create-main-targets-include )
273 
274     # Now include main-targets.gmk. This will define ALL_MAIN_TARGETS.
275     -include $$(main_targets_file)
276   endef
277 
278   define PrintConfCheckFailed
279 	@echo &#39; &#39;
280 	@echo &quot;Please rerun configure! Easiest way to do this is by running&quot;
281 	@echo &quot;&#39;make reconfigure&#39;.&quot;
282 	@echo &quot;This behavior may also be changed using CONF_CHECK=&lt;ignore|auto&gt;.&quot;
283 	@echo &#39; &#39;
284   endef
285 
286 else # $(HAS_SPEC)=true
287   ##############################################################################
288   # Helper functions for the &#39;main&#39; target. These functions assume a single,
289   # proper and existing SPEC is included.
290   ##############################################################################
291 
292   include $(TOPDIR)/make/common/MakeBase.gmk
293 
294   # Define basic logging setup
295   BUILD_LOG := $(OUTPUTDIR)/build.log
296   BUILD_PROFILE_LOG := $(OUTPUTDIR)/build-profile.log
297 
298   BUILD_LOG_PIPE := &gt; &gt;($(TEE) -a $(BUILD_LOG)) 2&gt; &gt;($(TEE) -a $(BUILD_LOG) &gt;&amp;2) &amp;&amp; wait
<a name="5" id="anc5"></a><span class="line-added">299   # Use this for simple echo/printf commands that are never expected to print</span>
<span class="line-added">300   # to stderr.</span>
<span class="line-added">301   BUILD_LOG_PIPE_SIMPLE := | $(TEE) -a $(BUILD_LOG)</span>
302 
303   ifneq ($(CUSTOM_ROOT), )
304     topdir=$(CUSTOM_ROOT)
305   else
306     topdir=$(TOPDIR)
307   endif
308 
309   # Parse COMPARE_BUILD into COMPARE_BUILD_*
310   # Syntax: COMPARE_BUILD=CONF=&lt;configure options&gt;:PATCH=&lt;patch file&gt;:
311   #         MAKE=&lt;make targets&gt;:COMP_OPTS=&lt;compare script options&gt;:
312   #         COMP_DIR=&lt;compare script base dir&gt;|&lt;default&gt;:
313   #         FAIL=&lt;bool&gt;
314   # If neither CONF or PATCH is given, assume &lt;default&gt; means CONF if it
315   # begins with &quot;--&quot;, otherwise assume it means PATCH.
316   # MAKE and COMP_OPTS can only be used with CONF and/or PATCH specified.
317   # If any value contains &quot;+&quot;, it will be replaced by space.
318   # FAIL can be set to false to have the return value of compare be ignored.
319   define ParseCompareBuild
320     ifneq ($$(COMPARE_BUILD), )
321       COMPARE_BUILD_OUTPUTDIR := $(topdir)/build/compare-build/$(CONF_NAME)
322       COMPARE_BUILD_FAIL := true
323 
324       ifneq ($$(findstring :, $$(COMPARE_BUILD)), )
325         $$(foreach part, $$(subst :, , $$(COMPARE_BUILD)), \
326           $$(if $$(filter PATCH=%, $$(part)), \
327             $$(eval COMPARE_BUILD_PATCH=$$(strip $$(patsubst PATCH=%, %, $$(part)))) \
328           ) \
329           $$(if $$(filter CONF=%, $$(part)), \
330             $$(eval COMPARE_BUILD_CONF=$$(strip $$(subst +, , $$(patsubst CONF=%, %, $$(part))))) \
331           ) \
332           $$(if $$(filter MAKE=%, $$(part)), \
333             $$(eval COMPARE_BUILD_MAKE=$$(strip $$(subst +, , $$(patsubst MAKE=%, %, $$(part))))) \
334           ) \
335           $$(if $$(filter COMP_OPTS=%, $$(part)), \
336             $$(eval COMPARE_BUILD_COMP_OPTS=$$(strip $$(subst +, , $$(patsubst COMP_OPTS=%, %, $$(part))))) \
337           ) \
338           $$(if $$(filter COMP_DIR=%, $$(part)), \
339             $$(eval COMPARE_BUILD_COMP_DIR=$$(strip $$(subst +, , $$(patsubst COMP_DIR=%, %, $$(part))))) \
340           ) \
341           $$(if $$(filter FAIL=%, $$(part)), \
342             $$(eval COMPARE_BUILD_FAIL=$$(strip $$(subst +, , $$(patsubst FAIL=%, %, $$(part))))) \
343           ) \
344         )
345       else
346         # Separate handling for single field case, to allow for spaces in values.
347         ifneq ($$(filter PATCH=%, $$(COMPARE_BUILD)), )
348           COMPARE_BUILD_PATCH=$$(strip $$(patsubst PATCH=%, %, $$(COMPARE_BUILD)))
349         else ifneq ($$(filter CONF=%, $$(COMPARE_BUILD)), )
350           COMPARE_BUILD_CONF=$$(strip $$(subst +, , $$(patsubst CONF=%, %, $$(COMPARE_BUILD))))
351         else ifneq ($$(filter --%, $$(COMPARE_BUILD)), )
352           # Assume CONF if value begins with --
353           COMPARE_BUILD_CONF=$$(strip $$(subst +, , $$(COMPARE_BUILD)))
354         else
355           # Otherwise assume patch file
356           COMPARE_BUILD_PATCH=$$(strip $$(COMPARE_BUILD))
357         endif
358       endif
359       ifneq ($$(COMPARE_BUILD_PATCH), )
360         ifneq ($$(wildcard $$(topdir)/$$(COMPARE_BUILD_PATCH)), )
361           # Assume relative path, if file exists
362           COMPARE_BUILD_PATCH := $$(wildcard $$(topdir)/$$(COMPARE_BUILD_PATCH))
363         else ifeq ($$(wildcard $$(COMPARE_BUILD_PATCH)), )
364           $$(error Patch file $$(COMPARE_BUILD_PATCH) does not exist)
365         endif
366       endif
367       ifneq ($$(COMPARE_BUILD_FAIL), true)
368         COMPARE_BUILD_IGNORE_RESULT := || true
369       endif
370     endif
371   endef
372 
373   # Prepare for a comparison rebuild
374   define PrepareCompareBuild
375 	$(ECHO) &quot;Preparing for comparison rebuild&quot;
376         # Apply patch, if any
377 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -p1 &lt; $(COMPARE_BUILD_PATCH))
378         # Move the first build away temporarily
379 	$(RM) -r $(topdir)/build/.compare-build-temp
380 	$(MKDIR) -p $(topdir)/build/.compare-build-temp
381 	$(MV) $(OUTPUTDIR) $(topdir)/build/.compare-build-temp
382         # Restore an old compare-build, or create a new compare-build directory.
383 	if test -d $(COMPARE_BUILD_OUTPUTDIR); then \
384 	  $(MV) $(COMPARE_BUILD_OUTPUTDIR) $(OUTPUTDIR); \
385 	else \
386 	  $(MKDIR) -p $(OUTPUTDIR); \
387 	fi
388         # Re-run configure with the same arguments (and possibly some additional),
389         # must be done after patching.
<a name="6" id="anc6"></a><span class="line-modified">390 	( cd $(CONFIGURE_START_DIR) &amp;&amp; PATH=&quot;$(ORIGINAL_PATH)&quot; \</span>
391 	    $(BASH) $(topdir)/configure $(CONFIGURE_COMMAND_LINE) $(COMPARE_BUILD_CONF))
392   endef
393 
394   # Cleanup after a compare build
395   define CleanupCompareBuild
396         # If running with a COMPARE_BUILD patch, reverse-apply it
397 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -R -p1 &lt; $(COMPARE_BUILD_PATCH))
398         # Move this build away and restore the original build
399 	$(MKDIR) -p $(topdir)/build/compare-build
400 	$(MV) $(OUTPUTDIR) $(COMPARE_BUILD_OUTPUTDIR)
401 	$(MV) $(topdir)/build/.compare-build-temp/$(CONF_NAME) $(OUTPUTDIR)
402 	$(RM) -r $(topdir)/build/.compare-build-temp
403   endef
404 
405   # Do the actual comparison of two builds
406   define CompareBuildDoComparison
407         # Compare first and second build. Ignore any error code from compare.sh.
408 	$(ECHO) &quot;Comparing between comparison rebuild (this/new) and baseline (other/old)&quot;
409 	$(if $(COMPARE_BUILD_COMP_DIR), \
410 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
411 	      -2dirs $(COMPARE_BUILD_OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) \
412 	      $(OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) $(COMPARE_BUILD_IGNORE_RESULT)), \
413 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
414 	      -o $(OUTPUTDIR) $(COMPARE_BUILD_IGNORE_RESULT)) \
415 	)
416   endef
417 
418   define PrintFailureReports
419 	$(if $(filter none, $(LOG_REPORT)), , \
420 	  $(if $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log), \
421 	    $(PRINTF) &quot;\n=== Output from failing command(s) repeated here ===\n&quot; $(NEWLINE) \
422 	    $(foreach logfile, $(sort $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log)), \
423 	        $(PRINTF) &quot;* For target $(notdir $(basename $(logfile))):\n&quot; $(NEWLINE) \
424 	        $(if $(filter all, $(LOG_REPORT)), \
425 	          $(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true $(NEWLINE) \
426 	        , \
<a name="7" id="anc7"></a><span class="line-modified">427 	          ($(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true) | $(HEAD) -n 15 $(NEWLINE) \</span>
<span class="line-modified">428 	          if test `$(WC) -l &lt; $(logfile)` -gt 15; then \</span>
429 	            $(ECHO) &quot;   ... (rest of output omitted)&quot; ; \
430 	          fi $(NEWLINE) \
431 	        ) \
432 	    ) \
433 	    $(PRINTF) &quot;\n* All command lines available in $(MAKESUPPORT_OUTPUTDIR)/failure-logs.\n&quot; $(NEWLINE) \
434 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; \
435 	  ) \
436 	)
437   endef
438 
439   define PrintBuildLogFailures
440 	$(if $(filter none, $(LOG_REPORT)), , \
441 	  if $(GREP) -q &quot;recipe for target .* failed&quot; $(BUILD_LOG) 2&gt; /dev/null; then  \
442 	    $(PRINTF) &quot;\n=== Make failed targets repeated here ===\n&quot; ; \
443 	    $(GREP) &quot;recipe for target .* failed&quot; $(BUILD_LOG) ; \
444 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; ; \
445 	    $(PRINTF) &quot;\nHint: Try searching the build log for the name of the first failed target.\n&quot; ; \
446 	  else \
447 	    $(PRINTF) &quot;\nNo indication of failed target found.\n&quot; ; \
448 	    $(PRINTF) &quot;Hint: Try searching the build log for &#39;] Error&#39;.\n&quot; ; \
449 	  fi \
450 	)
451   endef
452 
453   define RotateLogFiles
454 	$(RM) $(BUILD_LOG).old 2&gt; /dev/null &amp;&amp; \
455 	$(MV) $(BUILD_LOG) $(BUILD_LOG).old 2&gt; /dev/null || true
456 	$(if $(findstring true, $(LOG_PROFILE_TIMES_FILE)), \
457 	  $(RM) $(BUILD_PROFILE_LOG).old 2&gt; /dev/null &amp;&amp; \
458 	  $(MV) $(BUILD_PROFILE_LOG) $(BUILD_PROFILE_LOG).old 2&gt; /dev/null || true \
459 	)
460   endef
461 
462   # Failure logs are only supported for &quot;parallel&quot; main targets, not the
463   # (trivial) sequential make targets (such as clean and reconfigure),
464   # since the failure-logs directory creation will conflict with clean.
465   define PrepareFailureLogs
466 	$(RM) -r $(MAKESUPPORT_OUTPUTDIR)/failure-logs 2&gt; /dev/null &amp;&amp; \
467 	$(MKDIR) -p $(MAKESUPPORT_OUTPUTDIR)/failure-logs
468 	$(RM) $(MAKESUPPORT_OUTPUTDIR)/exit-with-error 2&gt; /dev/null
469   endef
470 
471   # Remove any javac server logs and port files. This
472   # prevents a new make run to reuse the previous servers.
473   define PrepareSmartJavac
474 	$(if $(SJAVAC_SERVER_DIR), \
475 	  $(RM) -r $(SJAVAC_SERVER_DIR) 2&gt; /dev/null &amp;&amp; \
476 	  $(MKDIR) -p $(SJAVAC_SERVER_DIR) \
477 	)
478   endef
479 
480   define CleanupSmartJavac
481 	[ -f $(SJAVAC_SERVER_DIR)/server.port ] &amp;&amp; $(ECHO) Stopping sjavac server &amp;&amp; \
482 	    $(TOUCH) $(SJAVAC_SERVER_DIR)/server.port.stop; true
483   endef
484 
485   ifeq ($(call isBuildOs, windows), true)
486     # On windows we need to synchronize with the javac server to be able to
487     # move or remove the build output directory. Since we have no proper
488     # synchronization process, wait for a while and hope it helps. This is only
489     # used by build comparisons.
490     define WaitForSmartJavacFinish
491 	$(if $(SJAVAC_SERVER_DIR), \
492 	  sleep 5\
493 	)
494     endef
495   else
496     define WaitForSmartJavacFinish
497     endef
498   endif
499 
500   define StartGlobalTimer
501 	$(RM) -r $(BUILDTIMESDIR) 2&gt; /dev/null &amp;&amp; \
502 	$(MKDIR) -p $(BUILDTIMESDIR) &amp;&amp; \
503 	$(call RecordStartTime,TOTAL)
504   endef
505 
506   define StopGlobalTimer
507 	$(call RecordEndTime,TOTAL)
508   endef
509 
510   # Find all build_time_* files and print their contents in a list sorted
511   # on the name of the sub repository.
512   define ReportBuildTimes
513 	$(PRINTF) $(LOG_INFO) -- \
514 	    &quot;----- Build times -------\nStart %s\nEnd   %s\n%s\n%s\n-------------------------\n&quot; \
515 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_start_TOTAL_human_readable`&quot; \
516 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_end_TOTAL_human_readable`&quot; \
517 	    &quot;`$(LS) $(BUILDTIMESDIR)/build_time_diff_* | $(GREP) -v _TOTAL | \
518 	    $(XARGS) $(CAT) | $(SORT) -k 2`&quot; \
519 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_diff_TOTAL`&quot; \
<a name="8" id="anc8"></a><span class="line-modified">520 	    $(BUILD_LOG_PIPE_SIMPLE)</span>
521   endef
522 
523   define ReportProfileTimes
524     $(if $(findstring true, $(LOG_PROFILE_TIMES_LOG)), \
525       [ ! -f $(BUILD_PROFILE_LOG) ] || \
526       { $(ECHO) Begin $(notdir $(BUILD_PROFILE_LOG)) &amp;&amp; \
527         $(CAT) $(BUILD_PROFILE_LOG) &amp;&amp; \
528         $(ECHO) End $(notdir $(BUILD_PROFILE_LOG)); \
529       } \
<a name="9" id="anc9"></a><span class="line-modified">530       $(BUILD_LOG_PIPE_SIMPLE)</span>
531     )
532   endef
533 
534 endif # HAS_SPEC
535 
536 # Look for a given option in the LOG variable, and if found, set a variable
537 # and remove the option from the LOG variable
538 # $1: The option to look for
539 # $2: The variable to set to &quot;true&quot; if the option is found
540 define ParseLogOption
541   ifneq ($$(findstring $1, $$(LOG)),)
542     override $2 := true
543     # First try to remove &quot;,&lt;option&gt;&quot; if it exists, otherwise just remove &quot;&lt;option&gt;&quot;
544     LOG_STRIPPED := $$(subst $1,, $$(subst $$(COMMA)$$(strip $1),, $$(LOG)))
545     # We might have ended up with a leading comma. Remove it. Need override
546     # since LOG is set from the command line.
547     override LOG := $$(strip $$(patsubst $$(COMMA)%, %, $$(LOG_STRIPPED)))
548   endif
549 endef
550 
551 # Look for a given option with an assignment in the LOG variable, and if found,
552 # set a variable to that value and remove the option from the LOG variable
553 # $1: The option to look for
554 # $2: The variable to set to the value of the option, if found
555 define ParseLogValue
556   ifneq ($$(findstring $1=, $$(LOG)),)
557     # Make words of out comma-separated list and find the one with opt=val
558     value := $$(strip $$(subst $$(strip $1)=,, $$(filter $$(strip $1)=%, $$(subst $$(COMMA), , $$(LOG)))))
559     override $2 := $$(value)
560     # First try to remove &quot;,&lt;option&gt;&quot; if it exists, otherwise just remove &quot;&lt;option&gt;&quot;
561     LOG_STRIPPED := $$(subst $$(strip $1)=$$(value),, \
562         $$(subst $$(COMMA)$$(strip $1)=$$(value),, $$(LOG)))
563     # We might have ended up with a leading comma. Remove it. Need override
564     # since LOG is set from the command line.
565     override LOG := $$(strip $$(patsubst $$(COMMA)%, %, $$(LOG_STRIPPED)))
566   endif
567 endef
568 
569 
570 define ParseLogLevel
571   # Catch old-style VERBOSE= command lines.
572   ifneq ($$(origin VERBOSE), undefined)
573     $$(info Error: VERBOSE is deprecated. Use LOG=&lt;warn|info|debug|trace&gt; instead.)
574     $$(error Cannot continue)
575   endif
576 
577   # Setup logging according to LOG
578 
579   # If &quot;nofile&quot; is present, do not log to a file
580   $$(eval $$(call ParseLogOption, nofile, LOG_NOFILE))
581 
582   # If &quot;cmdline&quot; is present, print all executes &quot;important&quot; command lines.
583   $$(eval $$(call ParseLogOption, cmdlines, LOG_CMDLINES))
584 
585   # If &quot;report&quot; is present, use non-standard reporting options at build failure.
586   $$(eval $$(call ParseLogValue, report, LOG_REPORT))
587   ifneq ($$(LOG_REPORT), )
588     ifeq ($$(filter $$(LOG_REPORT), none all default), )
589       $$(info Error: LOG=report has invalid value: $$(LOG_REPORT).)
590       $$(info Valid values: LOG=report=&lt;none&gt;|&lt;all&gt;|&lt;default&gt;)
591       $$(error Cannot continue)
592     endif
593   endif
594 
595   # If &quot;profile-to-log&quot; is present, write shell times in build log
596   $$(eval $$(call ParseLogOption, profile-to-log, LOG_PROFILE_TIMES_LOG))
597 
598   # If &quot;profile&quot; is present, write shell times in separate log file
599   # IMPORTANT: $(ParseLogOption profile-to-log) should go first. Otherwise
600   # parsing of &#39;LOG=debug,profile-to-log,nofile&#39; ends up in the following error:
601   # Error: LOG contains unknown option or log level: debug-to-log.
602   $$(eval $$(call ParseLogOption, profile, LOG_PROFILE_TIMES_FILE))
603 
604   # Treat LOG=profile-to-log as if it were LOG=profile,profile-to-log
605   LOG_PROFILE_TIMES_FILE := $$(firstword $$(LOG_PROFILE_TIMES_FILE) $$(LOG_PROFILE_TIMES_LOG))
606 
607   override LOG_LEVEL := $$(LOG)
608 
609   ifeq ($$(LOG_LEVEL),)
610     # Set LOG to &quot;warn&quot; as default if not set
611     override LOG_LEVEL := warn
612   endif
613 
614   ifeq ($$(LOG_LEVEL), warn)
615     override MAKE_LOG_FLAGS := -s
616   else ifeq ($$(LOG_LEVEL), info)
617     override MAKE_LOG_FLAGS := -s
618   else ifeq ($$(LOG_LEVEL), debug)
619     override MAKE_LOG_FLAGS :=
620   else ifeq ($$(LOG_LEVEL), trace)
621     override MAKE_LOG_FLAGS :=
622   else
623     $$(info Error: LOG contains unknown option or log level: $$(LOG).)
624     $$(info LOG can be &lt;level&gt;[,&lt;opt&gt;[...]] where &lt;opt&gt; is nofile | cmdlines | profile | profile-to-log)
625     $$(info and &lt;level&gt; is warn | info | debug | trace)
626     $$(error Cannot continue)
627   endif
628 endef
629 
630 MAKE_LOG_VARS = $(foreach v, \
631     LOG_LEVEL LOG_NOFILE LOG_CMDLINES LOG_REPORT LOG_PROFILE_TIMES_LOG \
632     LOG_PROFILE_TIMES_FILE, \
633     $v=$($v) \
634 )
635 
636 endif # _INITSUPPORT_GMK
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>