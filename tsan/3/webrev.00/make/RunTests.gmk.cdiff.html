<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff make/RunTests.gmk</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
<body>
<center><a href="ModuleWrapper.gmk.cdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="RunTestsPrebuilt.gmk.cdiff.html" target="_top">next &gt;</a></center>    <h2>make/RunTests.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 96,17 ***</span>
  endif
  
  JTREG_FAILURE_HANDLER_DIR := $(TEST_IMAGE_DIR)/failure_handler
  JTREG_FAILURE_HANDLER := $(JTREG_FAILURE_HANDLER_DIR)/jtregFailureHandler.jar
  
  ifneq ($(wildcard $(JTREG_FAILURE_HANDLER)), )
    JTREG_FAILURE_HANDLER_OPTIONS := \
        -timeoutHandlerDir:$(JTREG_FAILURE_HANDLER) \
        -observerDir:$(JTREG_FAILURE_HANDLER) \
        -timeoutHandler:jdk.test.failurehandler.jtreg.GatherProcessInfoTimeoutHandler \
        -observer:jdk.test.failurehandler.jtreg.GatherDiagnosticInfoObserver \
<span class="line-modified">!       -timeoutHandlerTimeout:0</span>
  endif
  
  GTEST_LAUNCHER_DIRS := $(patsubst %/gtestLauncher, %, \
      $(wildcard $(TEST_IMAGE_DIR)/hotspot/gtest/*/gtestLauncher))
  GTEST_VARIANTS := $(strip $(patsubst $(TEST_IMAGE_DIR)/hotspot/gtest/%, %, \
<span class="line-new-header">--- 96,19 ---</span>
  endif
  
  JTREG_FAILURE_HANDLER_DIR := $(TEST_IMAGE_DIR)/failure_handler
  JTREG_FAILURE_HANDLER := $(JTREG_FAILURE_HANDLER_DIR)/jtregFailureHandler.jar
  
<span class="line-added">+ JTREG_FAILURE_HANDLER_TIMEOUT ?= 0</span>
<span class="line-added">+ </span>
  ifneq ($(wildcard $(JTREG_FAILURE_HANDLER)), )
    JTREG_FAILURE_HANDLER_OPTIONS := \
        -timeoutHandlerDir:$(JTREG_FAILURE_HANDLER) \
        -observerDir:$(JTREG_FAILURE_HANDLER) \
        -timeoutHandler:jdk.test.failurehandler.jtreg.GatherProcessInfoTimeoutHandler \
        -observer:jdk.test.failurehandler.jtreg.GatherDiagnosticInfoObserver \
<span class="line-modified">!       -timeoutHandlerTimeout:$(JTREG_FAILURE_HANDLER_TIMEOUT)</span>
  endif
  
  GTEST_LAUNCHER_DIRS := $(patsubst %/gtestLauncher, %, \
      $(wildcard $(TEST_IMAGE_DIR)/hotspot/gtest/*/gtestLauncher))
  GTEST_VARIANTS := $(strip $(patsubst $(TEST_IMAGE_DIR)/hotspot/gtest/%, %, \
</pre>
<hr />
<pre>
<span class="line-old-header">*** 181,18 ***</span>
  	$$(call ExecuteWithLog, $$@, \
  	    $((COV_ENVIRONMENT) \
  	    $$(FIXPATH) $$(JDK_UNDER_TEST)/bin/jaotc \
  	        $$($1_JAOTC_OPTS) --output $$@ --module $$($1_MODULE) \
  	)
<span class="line-modified">! 	$$(call ExecuteWithLog, $$@.check, \</span>
  	    $$(FIXPATH) $$(JDK_UNDER_TEST)/bin/java \
<span class="line-modified">! 	        $$($1_VM_OPTIONS) -XX:+UnlockDiagnosticVMOptions \</span>
  	        -XX:+PrintAOT -XX:+UseAOTStrictLoading \
  	        -XX:AOTLibrary=$$@ -version \
  	         &gt; $$@.verify-aot \
<span class="line-modified">! 	)</span>
  
    $1_AOT_OPTIONS += -XX:AOTLibrary=$$($1_AOT_LIB)
    $1_AOT_TARGETS += $$($1_AOT_LIB)
  endef
  
  # Parameter 1 is the name of the rule.
<span class="line-new-header">--- 183,19 ---</span>
  	$$(call ExecuteWithLog, $$@, \
  	    $((COV_ENVIRONMENT) \
  	    $$(FIXPATH) $$(JDK_UNDER_TEST)/bin/jaotc \
  	        $$($1_JAOTC_OPTS) --output $$@ --module $$($1_MODULE) \
  	)
<span class="line-modified">! 	$$(call ExecuteWithLog, $$@.check, ( \</span>
  	    $$(FIXPATH) $$(JDK_UNDER_TEST)/bin/java \
<span class="line-modified">! 	        $$($1_VM_OPTIONS) -XX:+UnlockDiagnosticVMOptions -XX:+UnlockExperimentalVMOptions \</span>
  	        -XX:+PrintAOT -XX:+UseAOTStrictLoading \
  	        -XX:AOTLibrary=$$@ -version \
  	         &gt; $$@.verify-aot \
<span class="line-modified">! 	))</span>
  
<span class="line-added">+   $1_AOT_OPTIONS += -XX:+UnlockExperimentalVMOptions</span>
    $1_AOT_OPTIONS += -XX:AOTLibrary=$$($1_AOT_LIB)
    $1_AOT_TARGETS += $$($1_AOT_LIB)
  endef
  
  # Parameter 1 is the name of the rule.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 242,15 ***</span>
<span class="line-new-header">--- 245,33 ---</span>
        CORES_DIVIDER := 5
      else
        CORES_DIVIDER := 4
      endif
    endif
<span class="line-added">+   # For some big multi-core machines with low ulimit -u setting we hit the max</span>
<span class="line-added">+   # threads/process limit. In such a setup the memory/cores-only-guided</span>
<span class="line-added">+   # TEST_JOBS config is insufficient. From experience a concurrency setting of</span>
<span class="line-added">+   # 14 works reasonably well for low ulimit values (&lt;= 4096). Thus, use</span>
<span class="line-added">+   # divider 4096/14. For high ulimit -u values this shouldn&#39;t make a difference.</span>
<span class="line-added">+   ULIMIT_DIVIDER := (4096/14)</span>
<span class="line-added">+   PROC_ULIMIT := -1</span>
<span class="line-added">+   ifneq ($(OPENJDK_TARGET_OS), windows)</span>
<span class="line-added">+     PROC_ULIMIT := $(shell $(ULIMIT) -u)</span>
<span class="line-added">+     ifeq ($(PROC_ULIMIT), unlimited)</span>
<span class="line-added">+       PROC_ULIMIT := -1</span>
<span class="line-added">+     endif</span>
<span class="line-added">+   endif</span>
    MEMORY_DIVIDER := 2048
    TEST_JOBS := $(shell $(AWK) \
      &#39;BEGIN { \
        c = $(NUM_CORES) / $(CORES_DIVIDER); \
        m = $(MEMORY_SIZE) / $(MEMORY_DIVIDER); \
<span class="line-added">+       u = $(PROC_ULIMIT); \</span>
<span class="line-added">+       if (u &gt; -1) { \</span>
<span class="line-added">+         u = u / $(ULIMIT_DIVIDER); \</span>
<span class="line-added">+         if (u &lt; c) c = u; \</span>
<span class="line-added">+       } \</span>
        if (c &gt; m) c = m; \
        c = c * $(TEST_JOBS_FACTOR); \
        c = c * $(TEST_JOBS_FACTOR_JDL); \
        c = c * $(TEST_JOBS_FACTOR_MACHINE); \
        if (c &lt; 1) c = 1; \
</pre>
<hr />
<pre>
<span class="line-old-header">*** 273,14 ***</span>
  $(eval $(call SetTestOpt,JAVA_OPTIONS,JTREG))
  $(eval $(call SetTestOpt,AOT_MODULES,JTREG))
  
  $(eval $(call SetTestOpt,JOBS,JTREG))
  $(eval $(call SetTestOpt,TIMEOUT_FACTOR,JTREG))
  
  $(eval $(call ParseKeywordVariable, JTREG, \
<span class="line-modified">!     SINGLE_KEYWORDS := JOBS TIMEOUT_FACTOR TEST_MODE ASSERT VERBOSE RETAIN \</span>
<span class="line-modified">!         MAX_MEM, \</span>
      STRING_KEYWORDS := OPTIONS JAVA_OPTIONS VM_OPTIONS KEYWORDS \
          EXTRA_PROBLEM_LISTS AOT_MODULES, \
  ))
  
  ifneq ($(JTREG), )
<span class="line-new-header">--- 294,16 ---</span>
  $(eval $(call SetTestOpt,JAVA_OPTIONS,JTREG))
  $(eval $(call SetTestOpt,AOT_MODULES,JTREG))
  
  $(eval $(call SetTestOpt,JOBS,JTREG))
  $(eval $(call SetTestOpt,TIMEOUT_FACTOR,JTREG))
<span class="line-added">+ $(eval $(call SetTestOpt,FAILURE_HANDLER_TIMEOUT,JTREG))</span>
  
  $(eval $(call ParseKeywordVariable, JTREG, \
<span class="line-modified">!     SINGLE_KEYWORDS := JOBS TIMEOUT_FACTOR FAILURE_HANDLER_TIMEOUT \</span>
<span class="line-modified">!         TEST_MODE ASSERT VERBOSE RETAIN MAX_MEM RUN_PROBLEM_LISTS \</span>
<span class="line-added">+         RETRY_COUNT, \</span>
      STRING_KEYWORDS := OPTIONS JAVA_OPTIONS VM_OPTIONS KEYWORDS \
          EXTRA_PROBLEM_LISTS AOT_MODULES, \
  ))
  
  ifneq ($(JTREG), )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 587,20 ***</span>
  
    run-test-$1: pre-run-test $$($1_AOT_TARGETS)
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/gtest, \</span>
  	    $$(FIXPATH) $$(TEST_IMAGE_DIR)/hotspot/gtest/$$($1_VARIANT)/gtestLauncher \
  	        -jdk $(JDK_UNDER_TEST) $$($1_GTEST_FILTER) \
  	        --gtest_output=xml:$$($1_TEST_RESULTS_DIR)/gtest.xml \
  	        $$($1_GTEST_REPEAT) $$(GTEST_OPTIONS) $$(GTEST_VM_OPTIONS) \
  	        $$(GTEST_JAVA_OPTIONS) $$($1_AOT_OPTIONS) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/gtest.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	)</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/gtest.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
<span class="line-new-header">--- 610,20 ---</span>
  
    run-test-$1: pre-run-test $$($1_AOT_TARGETS)
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/gtest, ( \</span>
  	    $$(FIXPATH) $$(TEST_IMAGE_DIR)/hotspot/gtest/$$($1_VARIANT)/gtestLauncher \
  	        -jdk $(JDK_UNDER_TEST) $$($1_GTEST_FILTER) \
  	        --gtest_output=xml:$$($1_TEST_RESULTS_DIR)/gtest.xml \
  	        $$($1_GTEST_REPEAT) $$(GTEST_OPTIONS) $$(GTEST_VM_OPTIONS) \
  	        $$(GTEST_JAVA_OPTIONS) $$($1_AOT_OPTIONS) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/gtest.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	))</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/gtest.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 676,11 ***</span>
      $1_MICRO_BASIC_OPTIONS += -rf $$(MICRO_RESULTS_FORMAT)
      $1_MICRO_BASIC_OPTIONS += -rff $$($1_TEST_RESULTS_DIR)/jmh-result.$(MICRO_RESULTS_FORMAT)
    endif
  
    ifneq ($$(MICRO_VM_OPTIONS)$$(MICRO_JAVA_OPTIONS), )
<span class="line-modified">!     $1_MICRO_VM_OPTIONS := -jvmArgs $$(MICRO_VM_OPTIONS) $$(MICRO_JAVA_OPTIONS)</span>
    endif
  
    ifneq ($$(MICRO_ITER), )
      $1_MICRO_ITER := -i $$(MICRO_ITER)
    endif
<span class="line-new-header">--- 699,12 ---</span>
      $1_MICRO_BASIC_OPTIONS += -rf $$(MICRO_RESULTS_FORMAT)
      $1_MICRO_BASIC_OPTIONS += -rff $$($1_TEST_RESULTS_DIR)/jmh-result.$(MICRO_RESULTS_FORMAT)
    endif
  
    ifneq ($$(MICRO_VM_OPTIONS)$$(MICRO_JAVA_OPTIONS), )
<span class="line-modified">!     JMH_JVM_ARGS := $$(MICRO_VM_OPTIONS) $$(MICRO_JAVA_OPTIONS)</span>
<span class="line-added">+     $1_MICRO_VM_OPTIONS := -jvmArgs $(call ShellQuote,$$(JMH_JVM_ARGS))</span>
    endif
  
    ifneq ($$(MICRO_ITER), )
      $1_MICRO_ITER := -i $$(MICRO_ITER)
    endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 699,21 ***</span>
  
    run-test-$1: pre-run-test
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/micro, \</span>
  	    $$(FIXPATH) $$($1_MICRO_TEST_JDK)/bin/java $$($1_MICRO_JAVA_OPTIONS) \
  	        -jar $$($1_MICRO_BENCHMARKS_JAR) \
  	        $$($1_MICRO_ITER) $$($1_MICRO_FORK) $$($1_MICRO_TIME) \
  	        $$($1_MICRO_WARMUP_ITER) $$($1_MICRO_WARMUP_TIME) \
  	        $$($1_MICRO_VM_OPTIONS) $$($1_MICRO_BASIC_OPTIONS) $$(MICRO_OPTIONS) \
  	        $$($1_TEST_NAME) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/micro.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	)</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/micro.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
<span class="line-new-header">--- 723,21 ---</span>
  
    run-test-$1: pre-run-test
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/micro, ( \</span>
  	    $$(FIXPATH) $$($1_MICRO_TEST_JDK)/bin/java $$($1_MICRO_JAVA_OPTIONS) \
  	        -jar $$($1_MICRO_BENCHMARKS_JAR) \
  	        $$($1_MICRO_ITER) $$($1_MICRO_FORK) $$($1_MICRO_TIME) \
  	        $$($1_MICRO_WARMUP_ITER) $$($1_MICRO_WARMUP_TIME) \
  	        $$($1_MICRO_VM_OPTIONS) $$($1_MICRO_BASIC_OPTIONS) $$(MICRO_OPTIONS) \
  	        $$($1_TEST_NAME) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/micro.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	))</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/micro.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 826,10 ***</span>
<span class="line-new-header">--- 850,12 ---</span>
    else
      JTREG_TIMEOUT_FACTOR ?= 4
    endif
    JTREG_VERBOSE ?= fail,error,summary
    JTREG_RETAIN ?= fail,error
<span class="line-added">+   JTREG_RUN_PROBLEM_LISTS ?= false</span>
<span class="line-added">+   JTREG_RETRY_COUNT ?= 0</span>
  
    ifneq ($$($1_JTREG_MAX_MEM), 0)
      $1_JTREG_BASIC_OPTIONS += -vmoption:-Xmx$$($1_JTREG_MAX_MEM)
      $1_JTREG_LAUNCHER_OPTIONS += -Xmx$$($1_JTREG_MAX_MEM)
    endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 863,27 ***</span>
  
    ifneq ($$($1_JTREG_NATIVEPATH), )
      $1_JTREG_BASIC_OPTIONS += -nativepath:$$($1_JTREG_NATIVEPATH)
    endif
  
    ifneq ($$($1_JTREG_PROBLEM_LIST), )
<span class="line-modified">!     $1_JTREG_BASIC_OPTIONS += $$(addprefix -exclude:, $$($1_JTREG_PROBLEM_LIST))</span>
    endif
  
    ifneq ($$(JTREG_EXTRA_PROBLEM_LISTS), )
      # Accept both absolute paths as well as relative to the current test root.
<span class="line-modified">!     $1_JTREG_BASIC_OPTIONS += $$(addprefix -exclude:, $$(wildcard \</span>
          $$(JTREG_EXTRA_PROBLEM_LISTS) \
          $$(addprefix $$($1_TEST_ROOT)/, $$(JTREG_EXTRA_PROBLEM_LISTS)) \
      ))
    endif
  
    ifneq ($$(JIB_HOME), )
      $1_JTREG_BASIC_OPTIONS += -e:JIB_HOME=$$(JIB_HOME)
    endif
  
<span class="line-modified">!   $1_JTREG_BASIC_OPTIONS += -e:TEST_IMAGE_GRAAL_DIR=${TEST_IMAGE_DIR}/hotspot/jtreg/graal</span>
  
    ifneq ($$(JTREG_FAILURE_HANDLER_OPTIONS), )
      $1_JTREG_LAUNCHER_OPTIONS += -Djava.library.path=&quot;$(JTREG_FAILURE_HANDLER_DIR)&quot;
    endif
  
<span class="line-new-header">--- 889,34 ---</span>
  
    ifneq ($$($1_JTREG_NATIVEPATH), )
      $1_JTREG_BASIC_OPTIONS += -nativepath:$$($1_JTREG_NATIVEPATH)
    endif
  
<span class="line-added">+   ifeq ($$(JTREG_RUN_PROBLEM_LISTS), true)</span>
<span class="line-added">+     JTREG_PROBLEM_LIST_PREFIX := -match:</span>
<span class="line-added">+   else</span>
<span class="line-added">+     JTREG_PROBLEM_LIST_PREFIX := -exclude:</span>
<span class="line-added">+   endif</span>
<span class="line-added">+ </span>
    ifneq ($$($1_JTREG_PROBLEM_LIST), )
<span class="line-modified">!     $1_JTREG_BASIC_OPTIONS += $$(addprefix $$(JTREG_PROBLEM_LIST_PREFIX), $$($1_JTREG_PROBLEM_LIST))</span>
    endif
  
    ifneq ($$(JTREG_EXTRA_PROBLEM_LISTS), )
      # Accept both absolute paths as well as relative to the current test root.
<span class="line-modified">!     $1_JTREG_BASIC_OPTIONS += $$(addprefix $$(JTREG_PROBLEM_LIST_PREFIX), $$(wildcard \</span>
          $$(JTREG_EXTRA_PROBLEM_LISTS) \
          $$(addprefix $$($1_TEST_ROOT)/, $$(JTREG_EXTRA_PROBLEM_LISTS)) \
      ))
    endif
  
    ifneq ($$(JIB_HOME), )
      $1_JTREG_BASIC_OPTIONS += -e:JIB_HOME=$$(JIB_HOME)
    endif
  
<span class="line-modified">!   $1_JTREG_BASIC_OPTIONS += -e:TEST_IMAGE_DIR=$(TEST_IMAGE_DIR)</span>
<span class="line-added">+   $1_JTREG_BASIC_OPTIONS += -e:TEST_IMAGE_GRAAL_DIR=$(TEST_IMAGE_DIR)/hotspot/jtreg/graal</span>
  
    ifneq ($$(JTREG_FAILURE_HANDLER_OPTIONS), )
      $1_JTREG_LAUNCHER_OPTIONS += -Djava.library.path=&quot;$(JTREG_FAILURE_HANDLER_DIR)&quot;
    endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 910,30 ***</span>
    endif
  
    clean-workdir-$1:
  	$$(RM) -r $$($1_TEST_SUPPORT_DIR)
  
    run-test-$1: pre-run-test clean-workdir-$1 $$($1_AOT_TARGETS)
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/jtreg, \</span>
<span class="line-modified">! 	    $$(COV_ENVIRONMENT) \</span>
<span class="line-modified">! 	    $$(JAVA) $$($1_JTREG_LAUNCHER_OPTIONS) \</span>
<span class="line-removed">- 	        -Dprogram=jtreg -jar $$(JT_HOME)/lib/jtreg.jar \</span>
<span class="line-removed">- 	        $$($1_JTREG_BASIC_OPTIONS) \</span>
<span class="line-removed">- 	        -testjdk:$$(JDK_UNDER_TEST) \</span>
<span class="line-removed">- 	        -dir:$$(JTREG_TOPDIR) \</span>
<span class="line-removed">- 	        -reportDir:$$($1_TEST_RESULTS_DIR) \</span>
<span class="line-removed">- 	        -workDir:$$($1_TEST_SUPPORT_DIR) \</span>
<span class="line-removed">- 	        $$(JTREG_OPTIONS) \</span>
<span class="line-removed">- 	        $$(JTREG_FAILURE_HANDLER_OPTIONS) \</span>
<span class="line-removed">- 	        $$(JTREG_COV_OPTIONS) \</span>
<span class="line-removed">- 	        $$($1_TEST_NAME) \</span>
<span class="line-removed">- 	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \</span>
<span class="line-removed">- 	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \</span>
<span class="line-removed">- 	)</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/text/stats.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
<span class="line-new-header">--- 943,48 ---</span>
    endif
  
    clean-workdir-$1:
  	$$(RM) -r $$($1_TEST_SUPPORT_DIR)
  
<span class="line-added">+   $1_COMMAND_LINE := \</span>
<span class="line-added">+       $$(JAVA) $$($1_JTREG_LAUNCHER_OPTIONS) \</span>
<span class="line-added">+           -Dprogram=jtreg -jar $$(JT_HOME)/lib/jtreg.jar \</span>
<span class="line-added">+           $$($1_JTREG_BASIC_OPTIONS) \</span>
<span class="line-added">+           -testjdk:$$(JDK_UNDER_TEST) \</span>
<span class="line-added">+           -dir:$$(JTREG_TOPDIR) \</span>
<span class="line-added">+           -reportDir:$$($1_TEST_RESULTS_DIR) \</span>
<span class="line-added">+           -workDir:$$($1_TEST_SUPPORT_DIR) \</span>
<span class="line-added">+           -status:$$$${JTREG_STATUS} \</span>
<span class="line-added">+           $$(JTREG_OPTIONS) \</span>
<span class="line-added">+           $$(JTREG_FAILURE_HANDLER_OPTIONS) \</span>
<span class="line-added">+           $$(JTREG_COV_OPTIONS) \</span>
<span class="line-added">+           $$($1_TEST_NAME) \</span>
<span class="line-added">+       &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \</span>
<span class="line-added">+       || $$(ECHO) $$$$? &gt; $$($1_EXITCODE)</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+   ifneq ($$(JTREG_RETRY_COUNT), 0)</span>
<span class="line-added">+     $1_COMMAND_LINE := \</span>
<span class="line-added">+         for i in {0..$$(JTREG_RETRY_COUNT)}; do \</span>
<span class="line-added">+           if [ &quot;$$$$i&quot; != 0 ]; then \</span>
<span class="line-added">+             $$(PRINTF) &quot;\nRetrying Jtreg run. Attempt: $$$$i\n&quot;; \</span>
<span class="line-added">+           fi; \</span>
<span class="line-added">+           $$($1_COMMAND_LINE); \</span>
<span class="line-added">+           if [ &quot;`$$(CAT) $$($1_EXITCODE)`&quot; = &quot;0&quot; ]; then \</span>
<span class="line-added">+             break; \</span>
<span class="line-added">+           fi; \</span>
<span class="line-added">+           export JTREG_STATUS=&quot;-status:error,fail&quot;; \</span>
<span class="line-added">+         done</span>
<span class="line-added">+   endif</span>
<span class="line-added">+ </span>
    run-test-$1: pre-run-test clean-workdir-$1 $$($1_AOT_TARGETS)
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/jtreg, ( \</span>
<span class="line-modified">!             $$(COV_ENVIRONMENT) $$($1_COMMAND_LINE) \</span>
<span class="line-modified">! 	))</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/text/stats.txt
  
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1005,29 ***</span>
  
    run-test-$1: pre-run-test
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/test-execution, \</span>
  	    $$($1_TEST_COMMAND_LINE) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/test-output.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	)</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/gtest.txt
  
    # We can not parse the various &quot;special&quot; tests.
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
  	$$(call LogWarn, Test report is stored in $$(strip \
  	    $$(subst $$(TOPDIR)/, , $$($1_TEST_RESULTS_DIR))))
  	$$(call LogWarn, Warning: Special test results are not properly parsed!)
<span class="line-modified">! 	$$(eval $1_PASSED := 0)</span>
<span class="line-modified">! 	$$(eval $1_FAILED := 0)</span>
  	$$(eval $1_ERROR := 0)
<span class="line-modified">! 	$$(eval $1_TOTAL := 0)</span>
  
    $1: run-test-$1 parse-test-$1
  
    TARGETS += $1 run-test-$1 parse-test-$1
    TEST_TARGETS += parse-test-$1
<span class="line-new-header">--- 1056,33 ---</span>
  
    run-test-$1: pre-run-test
  	$$(call LogWarn)
  	$$(call LogWarn, Running test &#39;$$($1_TEST)&#39;)
  	$$(call MakeDir, $$($1_TEST_RESULTS_DIR) $$($1_TEST_SUPPORT_DIR))
<span class="line-modified">! 	$$(call ExecuteWithLog, $$($1_TEST_SUPPORT_DIR)/test-execution, ( \</span>
  	    $$($1_TEST_COMMAND_LINE) \
  	        &gt; &gt;($(TEE) $$($1_TEST_RESULTS_DIR)/test-output.txt) \
  	    &amp;&amp; $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
  	    || $$(ECHO) $$$$? &gt; $$($1_EXITCODE) \
<span class="line-modified">! 	))</span>
  
    $1_RESULT_FILE := $$($1_TEST_RESULTS_DIR)/gtest.txt
  
    # We can not parse the various &quot;special&quot; tests.
    parse-test-$1: run-test-$1
  	$$(call LogWarn, Finished running test &#39;$$($1_TEST)&#39;)
  	$$(call LogWarn, Test report is stored in $$(strip \
  	    $$(subst $$(TOPDIR)/, , $$($1_TEST_RESULTS_DIR))))
  	$$(call LogWarn, Warning: Special test results are not properly parsed!)
<span class="line-modified">! 	$$(eval $1_PASSED := $$(shell \</span>
<span class="line-modified">! 	  if [ `$(CAT) $$($1_EXITCODE)` = &quot;0&quot; ]; then $(ECHO) 1; else $(ECHO) 0; fi \</span>
<span class="line-added">+ 	))</span>
<span class="line-added">+ 	$$(eval $1_FAILED := $$(shell \</span>
<span class="line-added">+ 	  if [ `$(CAT) $$($1_EXITCODE)` = &quot;0&quot; ]; then $(ECHO) 0; else $(ECHO) 1; fi \</span>
<span class="line-added">+ 	))</span>
  	$$(eval $1_ERROR := 0)
<span class="line-modified">! 	$$(eval $1_TOTAL := 1)</span>
  
    $1: run-test-$1 parse-test-$1
  
    TARGETS += $1 run-test-$1 parse-test-$1
    TEST_TARGETS += parse-test-$1
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1192,14 ***</span>
<span class="line-new-header">--- 1247,22 ---</span>
  
    jcov-stop-grabber:
  	$(call LogWarn, Stopping JCov Grabber...)
  	$(JAVA) -jar $(JCOV_HOME)/lib/jcov.jar GrabberManager -stop -stoptimeout 3600
  
<span class="line-added">+   JCOV_REPORT_TITLE := JDK code coverage report&lt;br/&gt;</span>
<span class="line-added">+   ifneq ($(JCOV_FILTERS), )</span>
<span class="line-added">+     JCOV_REPORT_TITLE += Code filters: $(JCOV_FILTERS)&lt;br&gt;</span>
<span class="line-added">+   endif</span>
<span class="line-added">+   JCOV_REPORT_TITLE += Tests: $(TEST)</span>
<span class="line-added">+ </span>
    jcov-gen-report: jcov-stop-grabber
  	$(call LogWarn, Generating JCov report ...)
  	$(JAVA) -Xmx4g -jar $(JCOV_HOME)/lib/jcov.jar RepGen -sourcepath \
  	    `$(ECHO) $(TOPDIR)/src/*/share/classes/ | $(TR) &#39; &#39; &#39;:&#39;` -fmt html \
<span class="line-added">+ 	    $(JCOV_FILTERS) \</span>
<span class="line-added">+ 	    -mainReportTitle &quot;$(JCOV_REPORT_TITLE)&quot; \</span>
  	    -o $(JCOV_REPORT) $(JCOV_RESULT_FILE)
  
    TARGETS += jcov-do-start-grabber jcov-start-grabber jcov-stop-grabber \
        jcov-gen-report
  
</pre>
<center><a href="ModuleWrapper.gmk.cdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="RunTestsPrebuilt.gmk.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>