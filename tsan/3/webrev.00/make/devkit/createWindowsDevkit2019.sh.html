<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/devkit/createWindowsDevkit2019.sh</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #!/bin/bash
  2 #
  3 # Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  4 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5 #
  6 # This code is free software; you can redistribute it and/or modify it
  7 # under the terms of the GNU General Public License version 2 only, as
  8 # published by the Free Software Foundation.  Oracle designates this
  9 # particular file as subject to the &quot;Classpath&quot; exception as provided
 10 # by Oracle in the LICENSE file that accompanied this code.
 11 #
 12 # This code is distributed in the hope that it will be useful, but WITHOUT
 13 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 14 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 15 # version 2 for more details (a copy is included in the LICENSE file that
 16 # accompanied this code).
 17 #
 18 # You should have received a copy of the GNU General Public License version
 19 # 2 along with this work; if not, write to the Free Software Foundation,
 20 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 21 #
 22 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 23 # or visit www.oracle.com if you need additional information or have any
 24 # questions.
 25 #
 26 
 27 # This script copies parts of a Visual Studio installation into a devkit
 28 # suitable for building OpenJDK and OracleJDK. Needs to run in Cygwin or WSL.
 29 # erik.joelsson@oracle.com
 30 
 31 VS_VERSION=&quot;2019&quot;
 32 VS_VERSION_NUM_NODOT=&quot;160&quot;
 33 VS_DLL_VERSION=&quot;140&quot;
 34 SDK_VERSION=&quot;10&quot;
 35 SDK_FULL_VERSION=&quot;10.0.17763.0&quot;
 36 MSVC_DIR=&quot;Microsoft.VC141.CRT&quot;
 37 MSVC_FULL_VERSION=&quot;14.12.27508&quot;
 38 REDIST_FULL_VERSION=&quot;14.20.27508&quot;
 39 
 40 SCRIPT_DIR=&quot;$(cd &quot;$(dirname $0)&quot; &gt; /dev/null &amp;&amp; pwd)&quot;
 41 BUILD_DIR=&quot;${SCRIPT_DIR}/../../build/devkit&quot;
 42 
 43 ################################################################################
 44 # Prepare settings
 45 
 46 UNAME_SYSTEM=`uname -s`
 47 UNAME_RELEASE=`uname -r`
 48 
 49 # Detect cygwin or WSL
 50 IS_CYGWIN=`echo $UNAME_SYSTEM | grep -i CYGWIN`
 51 IS_WSL=`echo $UNAME_RELEASE | grep Microsoft`
 52 if test &quot;x$IS_CYGWIN&quot; != &quot;x&quot;; then
 53     BUILD_ENV=&quot;cygwin&quot;
 54 elif test &quot;x$IS_WSL&quot; != &quot;x&quot;; then
 55     BUILD_ENV=&quot;wsl&quot;
 56 else
 57     echo &quot;Unknown environment; only Cygwin and WSL are supported.&quot;
 58     exit 1
 59 fi
 60 
 61 if test &quot;x$BUILD_ENV&quot; = &quot;xcygwin&quot;; then
 62     WINDOWS_PATH_TO_UNIX_PATH=&quot;cygpath -u&quot;
 63 elif test &quot;x$BUILD_ENV&quot; = &quot;xwsl&quot;; then
 64     WINDOWS_PATH_TO_UNIX_PATH=&quot;wslpath -u&quot;
 65 fi
 66 
 67 # Work around the insanely named ProgramFiles(x86) env variable
 68 PROGRAMFILES_X86=&quot;$($WINDOWS_PATH_TO_UNIX_PATH &quot;$(cmd.exe /c set | sed -n &#39;s/^ProgramFiles(x86)=//p&#39; | tr -d &#39;\r&#39;)&quot;)&quot;
 69 
 70 # Find Visual Studio installation dir
 71 VSNNNCOMNTOOLS=`cmd.exe /c echo %VS${VS_VERSION_NUM_NODOT}COMNTOOLS% | tr -d &#39;\r&#39;`
 72 if [ -d &quot;$VSNNNCOMNTOOLS&quot; ]; then
 73     VS_INSTALL_DIR=&quot;$($WINDOWS_PATH_TO_UNIX_PATH &quot;$VSNNNCOMNTOOLS/../..&quot;)&quot;
 74 else
 75     VS_INSTALL_DIR=&quot;${PROGRAMFILES_X86}/Microsoft Visual Studio/2019&quot;
 76     VS_INSTALL_DIR=&quot;$(ls -d &quot;${VS_INSTALL_DIR}/&quot;{Community,Professional,Enterprise} 2&gt;/dev/null | head -n1)&quot;
 77 fi
 78 echo &quot;VS_INSTALL_DIR: $VS_INSTALL_DIR&quot;
 79 
 80 # Extract semantic version
 81 POTENTIAL_INI_FILES=&quot;Common7/IDE/wdexpress.isolation.ini Common7/IDE/devenv.isolation.ini&quot;
 82 for f in $POTENTIAL_INI_FILES; do
 83     if [ -f &quot;$VS_INSTALL_DIR/$f&quot; ]; then
 84         VS_VERSION_SP=&quot;$(grep ^SemanticVersion= &quot;$VS_INSTALL_DIR/$f&quot;)&quot;
 85         # Remove SemnaticVersion=
 86         VS_VERSION_SP=&quot;${VS_VERSION_SP#*=}&quot;
 87         # Remove suffix of too detailed numbering starting with +
 88         VS_VERSION_SP=&quot;${VS_VERSION_SP%+*}&quot;
 89         break
 90     fi
 91 done
 92 if [ -z &quot;$VS_VERSION_SP&quot; ]; then
 93     echo &quot;Failed to find SP version&quot;
 94     exit 1
 95 fi
 96 echo &quot;Found Version SP: $VS_VERSION_SP&quot;
 97 
 98 # Setup output dirs
 99 DEVKIT_ROOT=&quot;${BUILD_DIR}/VS${VS_VERSION}-${VS_VERSION_SP}-devkit&quot;
100 DEVKIT_BUNDLE=&quot;${DEVKIT_ROOT}.tar.gz&quot;
101 
102 echo &quot;Creating devkit in $DEVKIT_ROOT&quot;
103 
104 MSVCR_DLL=${MSVC_DIR}/vcruntime${VS_DLL_VERSION}.dll
105 MSVCP_DLL=${MSVC_DIR}/msvcp${VS_DLL_VERSION}.dll
106 
107 ################################################################################
108 # Copy Visual Studio files
109 
110 TOOLS_VERSION=&quot;$(ls &quot;$VS_INSTALL_DIR/VC/Tools/MSVC&quot; | sort -r -n | head -n1)&quot;
111 echo &quot;Found Tools version: $TOOLS_VERSION&quot;
112 VC_SUBDIR=&quot;VC/Tools/MSVC/$TOOLS_VERSION&quot;
113 REDIST_VERSION=&quot;$(ls &quot;$VS_INSTALL_DIR/VC/Redist/MSVC&quot; | sort -r -n | head -n1)&quot;
114 echo &quot;Found Redist version: $REDIST_VERSION&quot;
115 REDIST_SUBDIR=&quot;VC/Redist/MSVC/$REDIST_VERSION&quot;
116 echo &quot;Copying VC...&quot;
117 rm -rf $DEVKIT_ROOT/VC
118 mkdir -p $DEVKIT_ROOT/VC/bin
119 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/bin/Hostx64/x64&quot; $DEVKIT_ROOT/VC/bin/
120 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/bin/Hostx86/x86&quot; $DEVKIT_ROOT/VC/bin/
121 mkdir -p $DEVKIT_ROOT/VC/lib
122 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/lib/x64&quot; $DEVKIT_ROOT/VC/lib/
123 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/lib/x86&quot; $DEVKIT_ROOT/VC/lib/
124 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/include&quot; $DEVKIT_ROOT/VC/
125 mkdir -p $DEVKIT_ROOT/VC/atlmfc/lib
126 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/lib/x64&quot; $DEVKIT_ROOT/VC/atlmfc/lib/
127 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/lib/x86&quot; $DEVKIT_ROOT/VC/atlmfc/lib/
128 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/include&quot; $DEVKIT_ROOT/VC/atlmfc/
129 mkdir -p $DEVKIT_ROOT/VC/Auxiliary
130 cp -r &quot;$VS_INSTALL_DIR/VC/Auxiliary/Build&quot; $DEVKIT_ROOT/VC/Auxiliary/
131 mkdir -p $DEVKIT_ROOT/VC/redist
132 cp -r &quot;$VS_INSTALL_DIR/$REDIST_SUBDIR/x64&quot; $DEVKIT_ROOT/VC/redist/
133 cp -r &quot;$VS_INSTALL_DIR/$REDIST_SUBDIR/x86&quot; $DEVKIT_ROOT/VC/redist/
134 
135 # The redist runtime libs are needed to run the compiler but may not be
136 # installed on the machine where the devkit will be used.
137 cp $DEVKIT_ROOT/VC/redist/x86/$MSVCR_DLL $DEVKIT_ROOT/VC/bin/x86
138 cp $DEVKIT_ROOT/VC/redist/x86/$MSVCP_DLL $DEVKIT_ROOT/VC/bin/x86
139 cp $DEVKIT_ROOT/VC/redist/x64/$MSVCR_DLL $DEVKIT_ROOT/VC/bin/x64
140 cp $DEVKIT_ROOT/VC/redist/x64/$MSVCP_DLL $DEVKIT_ROOT/VC/bin/x64
141 
142 ################################################################################
143 # Copy SDK files
144 
145 SDK_INSTALL_DIR=&quot;$PROGRAMFILES_X86/Windows Kits/$SDK_VERSION&quot;
146 echo &quot;SDK_INSTALL_DIR: $SDK_INSTALL_DIR&quot;
147 
148 SDK_FULL_VERSION=&quot;$(ls &quot;$SDK_INSTALL_DIR/bin&quot; | sort -r -n | head -n1)&quot;
149 echo &quot;Found SDK version: $SDK_FULL_VERSION&quot;
150 UCRT_VERSION=&quot;$(ls &quot;$SDK_INSTALL_DIR/Redist&quot; | grep $SDK_VERSION | sort -r -n | head -n1)&quot;
151 echo &quot;Found UCRT version: $UCRT_VERSION&quot;
152 echo &quot;Copying SDK...&quot;
153 rm -rf $DEVKIT_ROOT/$SDK_VERSION
154 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/bin
155 cp -r &quot;$SDK_INSTALL_DIR/bin/$SDK_FULL_VERSION/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/bin/
156 cp -r &quot;$SDK_INSTALL_DIR/bin/$SDK_FULL_VERSION/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/bin/
157 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/lib
158 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/um/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
159 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/um/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
160 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/ucrt/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
161 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/ucrt/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
162 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/Redist
163 cp -r &quot;$SDK_INSTALL_DIR/Redist/$UCRT_VERSION/ucrt&quot; $DEVKIT_ROOT/$SDK_VERSION/Redist/
164 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/include
165 cp -r &quot;$SDK_INSTALL_DIR/include/$SDK_FULL_VERSION/&quot;* $DEVKIT_ROOT/$SDK_VERSION/include/
166 
167 ################################################################################
168 # Generate devkit.info
169 
170 echo-info() {
171     echo &quot;$1&quot; &gt;&gt; $DEVKIT_ROOT/devkit.info
172 }
173 
174 echo &quot;Generating devkit.info...&quot;
175 rm -f $DEVKIT_ROOT/devkit.info
176 echo-info &quot;# This file describes to configure how to interpret the contents of this devkit&quot;
177 echo-info &quot;DEVKIT_NAME=\&quot;Microsoft Visual Studio $VS_VERSION $VS_VERSION_SP (devkit)\&quot;&quot;
178 echo-info &quot;DEVKIT_VS_VERSION=\&quot;$VS_VERSION\&quot;&quot;
179 echo-info &quot;&quot;
180 echo-info &quot;DEVKIT_TOOLCHAIN_PATH_x86=\&quot;\$DEVKIT_ROOT/VC/bin/x86:\$DEVKIT_ROOT/$SDK_VERSION/bin/x86\&quot;&quot;
181 echo-info &quot;DEVKIT_VS_INCLUDE_x86=\&quot;\$DEVKIT_ROOT/VC/include;\$DEVKIT_ROOT/VC/atlmfc/include;\$DEVKIT_ROOT/$SDK_VERSION/include/shared;\$DEVKIT_ROOT/$SDK_VERSION/include/ucrt;\$DEVKIT_ROOT/$SDK_VERSION/include/um;\$DEVKIT_ROOT/$SDK_VERSION/include/winrt\&quot;&quot;
182 echo-info &quot;DEVKIT_VS_LIB_x86=\&quot;\$DEVKIT_ROOT/VC/lib/x86;\$DEVKIT_ROOT/VC/atlmfc/lib/x86;\$DEVKIT_ROOT/$SDK_VERSION/lib/x86\&quot;&quot;
183 echo-info &quot;DEVKIT_MSVCR_DLL_x86=\&quot;\$DEVKIT_ROOT/VC/redist/x86/$MSVCR_DLL\&quot;&quot;
184 echo-info &quot;DEVKIT_MSVCP_DLL_x86=\&quot;\$DEVKIT_ROOT/VC/redist/x86/$MSVCP_DLL\&quot;&quot;
185 echo-info &quot;DEVKIT_UCRT_DLL_DIR_x86=\&quot;\$DEVKIT_ROOT/10/Redist/ucrt/DLLs/x86\&quot;&quot;
186 echo-info &quot;&quot;
187 echo-info &quot;DEVKIT_TOOLCHAIN_PATH_x86_64=\&quot;\$DEVKIT_ROOT/VC/bin/x64:\$DEVKIT_ROOT/$SDK_VERSION/bin/x64:\$DEVKIT_ROOT/$SDK_VERSION/bin/x86\&quot;&quot;
188 echo-info &quot;DEVKIT_VS_INCLUDE_x86_64=\&quot;\$DEVKIT_ROOT/VC/include;\$DEVKIT_ROOT/VC/atlmfc/include;\$DEVKIT_ROOT/$SDK_VERSION/include/shared;\$DEVKIT_ROOT/$SDK_VERSION/include/ucrt;\$DEVKIT_ROOT/$SDK_VERSION/include/um;\$DEVKIT_ROOT/$SDK_VERSION/include/winrt\&quot;&quot;
189 echo-info &quot;DEVKIT_VS_LIB_x86_64=\&quot;\$DEVKIT_ROOT/VC/lib/x64;\$DEVKIT_ROOT/VC/atlmfc/lib/x64;\$DEVKIT_ROOT/$SDK_VERSION/lib/x64\&quot;&quot;
190 echo-info &quot;DEVKIT_MSVCR_DLL_x86_64=\&quot;\$DEVKIT_ROOT/VC/redist/x64/$MSVCR_DLL\&quot;&quot;
191 echo-info &quot;DEVKIT_MSVCP_DLL_x86_64=\&quot;\$DEVKIT_ROOT/VC/redist/x64/$MSVCP_DLL\&quot;&quot;
192 echo-info &quot;DEVKIT_UCRT_DLL_DIR_x86_64=\&quot;\$DEVKIT_ROOT/10/Redist/ucrt/DLLs/x64\&quot;&quot;
193 echo-info &quot;&quot;
194 echo-info &quot;DEVKIT_TOOLS_VERSION=\&quot;$TOOLS_VERSION\&quot;&quot;
195 echo-info &quot;DEVKIT_REDIST_VERSION=\&quot;$REDIST_VERSION\&quot;&quot;
196 echo-info &quot;DEVKIT_SDK_VERSION=\&quot;$SDK_FULL_VERSION\&quot;&quot;
197 echo-info &quot;DEVKIT_UCRT_VERSION=\&quot;$UCRT_VERSION\&quot;&quot;
198 
199 ################################################################################
200 # Copy this script
201 
202 echo &quot;Copying this script...&quot;
203 cp $0 $DEVKIT_ROOT/
204 
205 ################################################################################
206 # Create bundle
207 
208 echo &quot;Creating bundle: $DEVKIT_BUNDLE&quot;
209 (cd &quot;$DEVKIT_ROOT&quot; &amp;&amp; tar zcf &quot;$DEVKIT_BUNDLE&quot; .)
    </pre>
  </body>
</html>