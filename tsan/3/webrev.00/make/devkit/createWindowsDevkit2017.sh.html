<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/devkit/createWindowsDevkit2017.sh</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #!/bin/bash
  2 #
  3 # Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
  4 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5 #
  6 # This code is free software; you can redistribute it and/or modify it
  7 # under the terms of the GNU General Public License version 2 only, as
  8 # published by the Free Software Foundation.  Oracle designates this
  9 # particular file as subject to the &quot;Classpath&quot; exception as provided
 10 # by Oracle in the LICENSE file that accompanied this code.
 11 #
 12 # This code is distributed in the hope that it will be useful, but WITHOUT
 13 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 14 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 15 # version 2 for more details (a copy is included in the LICENSE file that
 16 # accompanied this code).
 17 #
 18 # You should have received a copy of the GNU General Public License version
 19 # 2 along with this work; if not, write to the Free Software Foundation,
 20 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 21 #
 22 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 23 # or visit www.oracle.com if you need additional information or have any
 24 # questions.
 25 #
 26 
 27 # This script copies parts of a Visual Studio installation into a devkit
 28 # suitable for building OpenJDK and OracleJDK. Needs to run in Cygwin or WSL.
 29 # erik.joelsson@oracle.com
 30 
 31 VS_VERSION=&quot;2017&quot;
 32 VS_VERSION_NUM_NODOT=&quot;150&quot;
 33 VS_DLL_VERSION=&quot;140&quot;
 34 SDK_VERSION=&quot;10&quot;
 35 MSVC_DIR=&quot;Microsoft.VC141.CRT&quot;
 36 
 37 SCRIPT_DIR=&quot;$(cd &quot;$(dirname $0)&quot; &gt; /dev/null &amp;&amp; pwd)&quot;
 38 BUILD_DIR=&quot;${SCRIPT_DIR}/../../build/devkit&quot;
 39 
 40 ################################################################################
 41 # Prepare settings
 42 
 43 UNAME_SYSTEM=`uname -s`
 44 UNAME_RELEASE=`uname -r`
 45 
 46 # Detect cygwin or WSL
 47 IS_CYGWIN=`echo $UNAME_SYSTEM | grep -i CYGWIN`
 48 IS_WSL=`echo $UNAME_RELEASE | grep Microsoft`
 49 if test &quot;x$IS_CYGWIN&quot; != &quot;x&quot;; then
 50     BUILD_ENV=&quot;cygwin&quot;
 51 elif test &quot;x$IS_WSL&quot; != &quot;x&quot;; then
 52     BUILD_ENV=&quot;wsl&quot;
 53 else
 54     echo &quot;Unknown environment; only Cygwin and WSL are supported.&quot;
 55     exit 1
 56 fi
 57 
 58 if test &quot;x$BUILD_ENV&quot; = &quot;xcygwin&quot;; then
 59     WINDOWS_PATH_TO_UNIX_PATH=&quot;cygpath -u&quot;
 60 elif test &quot;x$BUILD_ENV&quot; = &quot;xwsl&quot;; then
 61     WINDOWS_PATH_TO_UNIX_PATH=&quot;wslpath -u&quot;
 62 fi
 63 
 64 # Work around the insanely named ProgramFiles(x86) env variable
 65 PROGRAMFILES_X86=&quot;$($WINDOWS_PATH_TO_UNIX_PATH &quot;$(cmd.exe /c set | sed -n &#39;s/^ProgramFiles(x86)=//p&#39; | tr -d &#39;\r&#39;)&quot;)&quot;
 66 
 67 # Find Visual Studio installation dir
 68 VSNNNCOMNTOOLS=`cmd.exe /c echo %VS${VS_VERSION_NUM_NODOT}COMNTOOLS% | tr -d &#39;\r&#39;`
 69 if [ -d &quot;$VSNNNCOMNTOOLS&quot; ]; then
 70     VS_INSTALL_DIR=&quot;$($WINDOWS_PATH_TO_UNIX_PATH &quot;$VSNNNCOMNTOOLS/../..&quot;)&quot;
 71 else
 72     VS_INSTALL_DIR=&quot;${PROGRAMFILES_X86}/Microsoft Visual Studio/2017&quot;
 73     VS_INSTALL_DIR=&quot;$(ls -d &quot;${VS_INSTALL_DIR}/&quot;{Community,Professional,Enterprise} 2&gt;/dev/null | head -n1)&quot;
 74 fi
 75 echo &quot;VS_INSTALL_DIR: $VS_INSTALL_DIR&quot;
 76 
 77 # Extract semantic version
 78 POTENTIAL_INI_FILES=&quot;Common7/IDE/wdexpress.isolation.ini Common7/IDE/devenv.isolation.ini&quot;
 79 for f in $POTENTIAL_INI_FILES; do
 80     if [ -f &quot;$VS_INSTALL_DIR/$f&quot; ]; then
 81         VS_VERSION_SP=&quot;$(grep ^SemanticVersion= &quot;$VS_INSTALL_DIR/$f&quot;)&quot;
 82         # Remove SemnaticVersion=
 83         VS_VERSION_SP=&quot;${VS_VERSION_SP#*=}&quot;
 84         # Remove suffix of too detailed numbering starting with +
 85         VS_VERSION_SP=&quot;${VS_VERSION_SP%+*}&quot;
 86         break
 87     fi
 88 done
 89 if [ -z &quot;$VS_VERSION_SP&quot; ]; then
 90     echo &quot;Failed to find SP version&quot;
 91     exit 1
 92 fi
 93 echo &quot;Found Version SP: $VS_VERSION_SP&quot;
 94 
 95 # Setup output dirs
 96 DEVKIT_ROOT=&quot;${BUILD_DIR}/VS${VS_VERSION}-${VS_VERSION_SP}-devkit&quot;
 97 DEVKIT_BUNDLE=&quot;${DEVKIT_ROOT}.tar.gz&quot;
 98 
 99 echo &quot;Creating devkit in $DEVKIT_ROOT&quot;
100 
101 MSVCR_DLL=${MSVC_DIR}/vcruntime${VS_DLL_VERSION}.dll
102 MSVCP_DLL=${MSVC_DIR}/msvcp${VS_DLL_VERSION}.dll
103 
104 ################################################################################
105 # Copy Visual Studio files
106 
107 TOOLS_VERSION=&quot;$(ls &quot;$VS_INSTALL_DIR/VC/Tools/MSVC&quot; | sort -r -n | head -n1)&quot;
108 echo &quot;Found Tools version: $TOOLS_VERSION&quot;
109 VC_SUBDIR=&quot;VC/Tools/MSVC/$TOOLS_VERSION&quot;
110 REDIST_VERSION=&quot;$(ls &quot;$VS_INSTALL_DIR/VC/Redist/MSVC&quot; | sort -r -n | head -n1)&quot;
111 echo &quot;Found Redist version: $REDIST_VERSION&quot;
112 REDIST_SUBDIR=&quot;VC/Redist/MSVC/$REDIST_VERSION&quot;
113 echo &quot;Copying VC...&quot;
114 rm -rf $DEVKIT_ROOT/VC
115 mkdir -p $DEVKIT_ROOT/VC/bin
116 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/bin/Hostx64/x64&quot; $DEVKIT_ROOT/VC/bin/
117 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/bin/Hostx86/x86&quot; $DEVKIT_ROOT/VC/bin/
118 mkdir -p $DEVKIT_ROOT/VC/lib
119 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/lib/x64&quot; $DEVKIT_ROOT/VC/lib/
120 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/lib/x86&quot; $DEVKIT_ROOT/VC/lib/
121 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/include&quot; $DEVKIT_ROOT/VC/
122 mkdir -p $DEVKIT_ROOT/VC/atlmfc/lib
123 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/lib/x64&quot; $DEVKIT_ROOT/VC/atlmfc/lib/
124 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/lib/x86&quot; $DEVKIT_ROOT/VC/atlmfc/lib/
125 cp -r &quot;$VS_INSTALL_DIR/${VC_SUBDIR}/atlmfc/include&quot; $DEVKIT_ROOT/VC/atlmfc/
126 mkdir -p $DEVKIT_ROOT/VC/Auxiliary
127 cp -r &quot;$VS_INSTALL_DIR/VC/Auxiliary/Build&quot; $DEVKIT_ROOT/VC/Auxiliary/
128 mkdir -p $DEVKIT_ROOT/VC/redist
129 cp -r &quot;$VS_INSTALL_DIR/$REDIST_SUBDIR/x64&quot; $DEVKIT_ROOT/VC/redist/
130 cp -r &quot;$VS_INSTALL_DIR/$REDIST_SUBDIR/x86&quot; $DEVKIT_ROOT/VC/redist/
131 
132 # The redist runtime libs are needed to run the compiler but may not be
133 # installed on the machine where the devkit will be used.
134 cp $DEVKIT_ROOT/VC/redist/x86/$MSVCR_DLL $DEVKIT_ROOT/VC/bin/x86
135 cp $DEVKIT_ROOT/VC/redist/x86/$MSVCP_DLL $DEVKIT_ROOT/VC/bin/x86
136 cp $DEVKIT_ROOT/VC/redist/x64/$MSVCR_DLL $DEVKIT_ROOT/VC/bin/x64
137 cp $DEVKIT_ROOT/VC/redist/x64/$MSVCP_DLL $DEVKIT_ROOT/VC/bin/x64
138 
139 ################################################################################
140 # Copy SDK files
141 
142 SDK_INSTALL_DIR=&quot;$PROGRAMFILES_X86/Windows Kits/$SDK_VERSION&quot;
143 echo &quot;SDK_INSTALL_DIR: $SDK_INSTALL_DIR&quot;
144 
145 SDK_FULL_VERSION=&quot;$(ls &quot;$SDK_INSTALL_DIR/bin&quot; | sort -r -n | head -n1)&quot;
146 echo &quot;Found SDK version: $SDK_FULL_VERSION&quot;
147 UCRT_VERSION=&quot;$(ls &quot;$SDK_INSTALL_DIR/Redist&quot; | grep $SDK_VERSION | sort -r -n | head -n1)&quot;
148 echo &quot;Found UCRT version: $UCRT_VERSION&quot;
149 echo &quot;Copying SDK...&quot;
150 rm -rf $DEVKIT_ROOT/$SDK_VERSION
151 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/bin
152 cp -r &quot;$SDK_INSTALL_DIR/bin/$SDK_FULL_VERSION/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/bin/
153 cp -r &quot;$SDK_INSTALL_DIR/bin/$SDK_FULL_VERSION/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/bin/
154 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/lib
155 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/um/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
156 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/um/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
157 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/ucrt/x64&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
158 cp -r &quot;$SDK_INSTALL_DIR/lib/$SDK_FULL_VERSION/ucrt/x86&quot; $DEVKIT_ROOT/$SDK_VERSION/lib/
159 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/Redist
160 cp -r &quot;$SDK_INSTALL_DIR/Redist/$UCRT_VERSION/ucrt&quot; $DEVKIT_ROOT/$SDK_VERSION/Redist/
161 mkdir -p $DEVKIT_ROOT/$SDK_VERSION/include
162 cp -r &quot;$SDK_INSTALL_DIR/include/$SDK_FULL_VERSION/&quot;* $DEVKIT_ROOT/$SDK_VERSION/include/
163 
164 ################################################################################
165 # Generate devkit.info
166 
167 echo-info() {
168     echo &quot;$1&quot; &gt;&gt; $DEVKIT_ROOT/devkit.info
169 }
170 
171 echo &quot;Generating devkit.info...&quot;
172 rm -f $DEVKIT_ROOT/devkit.info
173 echo-info &quot;# This file describes to configure how to interpret the contents of this devkit&quot;
174 echo-info &quot;DEVKIT_NAME=\&quot;Microsoft Visual Studio $VS_VERSION $VS_VERSION_SP (devkit)\&quot;&quot;
175 echo-info &quot;DEVKIT_VS_VERSION=\&quot;$VS_VERSION\&quot;&quot;
176 echo-info &quot;&quot;
177 echo-info &quot;DEVKIT_TOOLCHAIN_PATH_x86=\&quot;\$DEVKIT_ROOT/VC/bin/x86:\$DEVKIT_ROOT/$SDK_VERSION/bin/x86\&quot;&quot;
178 echo-info &quot;DEVKIT_VS_INCLUDE_x86=\&quot;\$DEVKIT_ROOT/VC/include;\$DEVKIT_ROOT/VC/atlmfc/include;\$DEVKIT_ROOT/$SDK_VERSION/include/shared;\$DEVKIT_ROOT/$SDK_VERSION/include/ucrt;\$DEVKIT_ROOT/$SDK_VERSION/include/um;\$DEVKIT_ROOT/$SDK_VERSION/include/winrt\&quot;&quot;
179 echo-info &quot;DEVKIT_VS_LIB_x86=\&quot;\$DEVKIT_ROOT/VC/lib/x86;\$DEVKIT_ROOT/VC/atlmfc/lib/x86;\$DEVKIT_ROOT/$SDK_VERSION/lib/x86\&quot;&quot;
180 echo-info &quot;DEVKIT_MSVCR_DLL_x86=\&quot;\$DEVKIT_ROOT/VC/redist/x86/$MSVCR_DLL\&quot;&quot;
181 echo-info &quot;DEVKIT_MSVCP_DLL_x86=\&quot;\$DEVKIT_ROOT/VC/redist/x86/$MSVCP_DLL\&quot;&quot;
182 echo-info &quot;DEVKIT_UCRT_DLL_DIR_x86=\&quot;\$DEVKIT_ROOT/10/Redist/ucrt/DLLs/x86\&quot;&quot;
183 echo-info &quot;&quot;
184 echo-info &quot;DEVKIT_TOOLCHAIN_PATH_x86_64=\&quot;\$DEVKIT_ROOT/VC/bin/x64:\$DEVKIT_ROOT/$SDK_VERSION/bin/x64:\$DEVKIT_ROOT/$SDK_VERSION/bin/x86\&quot;&quot;
185 echo-info &quot;DEVKIT_VS_INCLUDE_x86_64=\&quot;\$DEVKIT_ROOT/VC/include;\$DEVKIT_ROOT/VC/atlmfc/include;\$DEVKIT_ROOT/$SDK_VERSION/include/shared;\$DEVKIT_ROOT/$SDK_VERSION/include/ucrt;\$DEVKIT_ROOT/$SDK_VERSION/include/um;\$DEVKIT_ROOT/$SDK_VERSION/include/winrt\&quot;&quot;
186 echo-info &quot;DEVKIT_VS_LIB_x86_64=\&quot;\$DEVKIT_ROOT/VC/lib/x64;\$DEVKIT_ROOT/VC/atlmfc/lib/x64;\$DEVKIT_ROOT/$SDK_VERSION/lib/x64\&quot;&quot;
187 echo-info &quot;DEVKIT_MSVCR_DLL_x86_64=\&quot;\$DEVKIT_ROOT/VC/redist/x64/$MSVCR_DLL\&quot;&quot;
188 echo-info &quot;DEVKIT_MSVCP_DLL_x86_64=\&quot;\$DEVKIT_ROOT/VC/redist/x64/$MSVCP_DLL\&quot;&quot;
189 echo-info &quot;DEVKIT_UCRT_DLL_DIR_x86_64=\&quot;\$DEVKIT_ROOT/10/Redist/ucrt/DLLs/x64\&quot;&quot;
190 echo-info &quot;&quot;
191 echo-info &quot;DEVKIT_TOOLS_VERSION=\&quot;$TOOLS_VERSION\&quot;&quot;
192 echo-info &quot;DEVKIT_REDIST_VERSION=\&quot;$REDIST_VERSION\&quot;&quot;
193 echo-info &quot;DEVKIT_SDK_VERSION=\&quot;$SDK_FULL_VERSION\&quot;&quot;
194 echo-info &quot;DEVKIT_UCRT_VERSION=\&quot;$UCRT_VERSION\&quot;&quot;
195 
196 ################################################################################
197 # Copy this script
198 
199 echo &quot;Copying this script...&quot;
200 cp $0 $DEVKIT_ROOT/
201 
202 ################################################################################
203 # Create bundle
204 
205 echo &quot;Creating bundle: $DEVKIT_BUNDLE&quot;
206 (cd &quot;$DEVKIT_ROOT&quot; &amp;&amp; tar zcf &quot;$DEVKIT_BUNDLE&quot; .)
    </pre>
  </body>
</html>