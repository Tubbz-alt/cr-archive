<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/CreateJmods.gmk</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
<body>
<center><a href="Coverage.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="Docs.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/CreateJmods.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 36 $(eval $(call IncludeCustomExtension, CreateJmods.gmk))
 37 
 38 ################################################################################
 39 
 40 JMODS_DIR := $(IMAGES_OUTPUTDIR)/jmods
 41 JMODS_SUPPORT_DIR := $(SUPPORT_OUTPUTDIR)/images/jmods
 42 JMOD_FILE := $(MODULE).jmod
 43 
 44 LIBS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 45     $(SUPPORT_OUTPUTDIR)/modules_libs $(IMPORT_MODULES_LIBS))))
 46 CMDS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 47     $(SUPPORT_OUTPUTDIR)/modules_cmds $(IMPORT_MODULES_CMDS))))
 48 CONF_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 49     $(SUPPORT_OUTPUTDIR)/modules_conf $(IMPORT_MODULES_CONF))))
 50 CLASSES_DIR ?= $(wildcard $(JDK_OUTPUTDIR)/modules/$(MODULE))
 51 INCLUDE_HEADERS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 52     $(SUPPORT_OUTPUTDIR)/modules_include $(IMPORT_MODULES_INCLUDE_HEADERS))))
 53 MAN_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 54     $(SUPPORT_OUTPUTDIR)/modules_man $(IMPORT_MODULES_MAN))))
 55 
<span class="line-modified"> 56 $(eval $(call FillCacheFind, \</span>
 57     $(LIBS_DIR) $(CMDS_DIR) $(CONF_DIR) $(CLASSES_DIR) \
<span class="line-modified"> 58 ))</span>
 59 
 60 ifneq ($(LIBS_DIR), )
 61   JMOD_FLAGS += --libs $(LIBS_DIR)
<span class="line-modified"> 62   DEPS += $(call CacheFind, $(LIBS_DIR))</span>
 63 endif
 64 ifneq ($(CMDS_DIR), )
 65   JMOD_FLAGS += --cmds $(CMDS_DIR)
<span class="line-modified"> 66   DEPS += $(call CacheFind, $(CMDS_DIR))</span>
 67 endif
 68 ifneq ($(CONF_DIR), )
 69   JMOD_FLAGS += --config $(CONF_DIR)
<span class="line-modified"> 70   DEPS += $(call CacheFind, $(CONF_DIR))</span>
 71 endif
 72 ifneq ($(CLASSES_DIR), )
 73   JMOD_FLAGS += --class-path $(CLASSES_DIR)
<span class="line-modified"> 74   DEPS += $(call CacheFind, $(CLASSES_DIR))</span>
 75 endif
 76 ifneq ($(INCLUDE_HEADERS_DIR), )
 77   JMOD_FLAGS += --header-files $(INCLUDE_HEADERS_DIR)
<span class="line-modified"> 78   DEPS += $(call CacheFind, $(INCLUDE_HEADERS_DIR))</span>
 79 endif
 80 ifneq ($(MAN_DIR), )
 81   JMOD_FLAGS += --man-pages $(MAN_DIR)
<span class="line-modified"> 82   DEPS += $(call CacheFind, $(MAN_DIR))</span>
 83 endif
 84 
 85 # If a specific modules_legal dir exists for this module, only pick up files
 86 # from there. These files were explicitly filtered or modified in &lt;module&gt;-copy
 87 # targets. For the rest, just pick up everything from the source legal dirs.
 88 LEGAL_NOTICES := \
<span class="line-modified"> 89     $(SUPPORT_OUTPUTDIR)/modules_legal/common \</span>
 90     $(if $(wildcard $(SUPPORT_OUTPUTDIR)/modules_legal/$(MODULE)), \
 91       $(wildcard $(SUPPORT_OUTPUTDIR)/modules_legal/$(MODULE)), \
 92       $(call FindModuleLegalSrcDirs, $(MODULE)) \
 93     )
 94 
<span class="line-modified"> 95 LEGAL_NOTICES_PATH := $(call PathList, $(LEGAL_NOTICES))</span>
<span class="line-modified"> 96 DEPS += $(call CacheFind, $(LEGAL_NOTICES))</span>

 97 
<span class="line-modified"> 98 JMOD_FLAGS += --legal-notices $(LEGAL_NOTICES_PATH)</span>

 99 
100 ifeq ($(filter-out jdk.incubator.%, $(MODULE)), )
101   JMOD_FLAGS += --do-not-resolve-by-default
102   JMOD_FLAGS += --warn-if-resolved=incubating
103 endif
104 
105 # Add dependencies on other jmod files. Only java.base needs access to other
106 # jmods.
107 ifeq ($(MODULE), java.base)
108   # When creating a BUILDJDK, we don&#39;t need to add hashes to java.base
109   ifneq ($(CREATING_BUILDJDK), true)
110     # When creating interim versions of jmods, skip hashes
111     ifneq ($(INTERIM_JMOD), true)
112       ALL_UPGRADEABLE_MODULES := $(call FindAllUpgradeableModules)
113       DEPS += $(patsubst %, $(JMODS_DIR)/%.jmod, \
114           $(filter-out java.base $(ALL_UPGRADEABLE_MODULES), $(call FindAllModules)))
115 
116       EXCLUDE_PATTERN := $(strip $(subst $(SPACE),$$|,$(strip $(ALL_UPGRADEABLE_MODULES))))
117 
118       JMOD_FLAGS += --module-path $(JMODS_DIR) \
</pre>
<hr />
<pre>
130     endif
131     ifneq ($(MSVCP_DLL), )
132       ifneq ($(wildcard $(LIBS_DIR)/$(notdir $(MSVCP_DLL))), )
133         JMOD_FLAGS += --exclude &#39;$(notdir $(MSVCP_DLL))&#39;
134       endif
135     endif
136     ifneq ($(UCRT_DLL_DIR), )
137       UCRT_DLL_FILES := $(notdir $(wildcard $(UCRT_DLL_DIR)/*.dll))
138       ifneq ($(wildcard $(LIBS_DIR)/$(firstword $(UCRT_DLL_FILES))), )
139         JMOD_FLAGS += $(patsubst %, --exclude &#39;%&#39;, $(UCRT_DLL_FILES))
140       endif
141     endif
142   endif
143 endif
144 
145 # Changes to the jmod tool itself should also trigger a rebuild of all jmods.
146 # The variable JMOD_CMD could contain an environment variable assignment before
147 # the actual command. Filter that out using wildcard before adding to DEPS.
148 DEPS += $(wildcard $(JMOD_CMD))
149 ifeq ($(EXTERNAL_BUILDJDK), false)
<span class="line-modified">150   DEPS += $(call CacheFind, $(JDK_OUTPUTDIR)/modules/jdk.jlink/jdk/tools/jmod)</span>
151 endif
152 
153 # If creating interim versions of jmods, certain files need to be filtered out
154 # to avoid false incremental rebuilds.
155 ifeq ($(INTERIM_JMOD), true)
156   DEPS := $(filter-out $(SUPPORT_OUTPUTDIR)/modules_libs/java.base/classlist, $(DEPS))
157   INTERIM_MSG := interim$(SPACE)
158 endif
159 
160 JMOD_FLAGS += --exclude &#39;**{_the.*,_*.marker,*.diz,*.debuginfo,*.dSYM/**,*.dSYM,*.pdb,*.map}&#39;
161 
162 # Create jmods in the support dir and then move them into place to keep the
163 # module path in $(IMAGES_OUTPUTDIR)/jmods valid at all times.
164 $(eval $(call SetupExecute, create_$(JMOD_FILE), \
165     WARN := Creating $(INTERIM_MSG)$(JMOD_FILE), \
166     DEPS := $(DEPS), \
167     OUTPUT_FILE := $(JMODS_DIR)/$(JMOD_FILE), \
168     SUPPORT_DIR := $(JMODS_SUPPORT_DIR), \
169     PRE_COMMAND := $(RM) $(JMODS_DIR)/$(JMOD_FILE) $(JMODS_SUPPORT_DIR)/$(JMOD_FILE), \
170     COMMAND := $(JMOD) create --module-version $(VERSION_SHORT) \
</pre>
</td>
<td>
<hr />
<pre>
 36 $(eval $(call IncludeCustomExtension, CreateJmods.gmk))
 37 
 38 ################################################################################
 39 
 40 JMODS_DIR := $(IMAGES_OUTPUTDIR)/jmods
 41 JMODS_SUPPORT_DIR := $(SUPPORT_OUTPUTDIR)/images/jmods
 42 JMOD_FILE := $(MODULE).jmod
 43 
 44 LIBS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 45     $(SUPPORT_OUTPUTDIR)/modules_libs $(IMPORT_MODULES_LIBS))))
 46 CMDS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 47     $(SUPPORT_OUTPUTDIR)/modules_cmds $(IMPORT_MODULES_CMDS))))
 48 CONF_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 49     $(SUPPORT_OUTPUTDIR)/modules_conf $(IMPORT_MODULES_CONF))))
 50 CLASSES_DIR ?= $(wildcard $(JDK_OUTPUTDIR)/modules/$(MODULE))
 51 INCLUDE_HEADERS_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 52     $(SUPPORT_OUTPUTDIR)/modules_include $(IMPORT_MODULES_INCLUDE_HEADERS))))
 53 MAN_DIR ?= $(firstword $(wildcard $(addsuffix /$(MODULE), \
 54     $(SUPPORT_OUTPUTDIR)/modules_man $(IMPORT_MODULES_MAN))))
 55 
<span class="line-modified"> 56 $(call FillFindCache, \</span>
 57     $(LIBS_DIR) $(CMDS_DIR) $(CONF_DIR) $(CLASSES_DIR) \
<span class="line-modified"> 58 )</span>
 59 
 60 ifneq ($(LIBS_DIR), )
 61   JMOD_FLAGS += --libs $(LIBS_DIR)
<span class="line-modified"> 62   DEPS += $(call FindFiles, $(LIBS_DIR))</span>
 63 endif
 64 ifneq ($(CMDS_DIR), )
 65   JMOD_FLAGS += --cmds $(CMDS_DIR)
<span class="line-modified"> 66   DEPS += $(call FindFiles, $(CMDS_DIR))</span>
 67 endif
 68 ifneq ($(CONF_DIR), )
 69   JMOD_FLAGS += --config $(CONF_DIR)
<span class="line-modified"> 70   DEPS += $(call FindFiles, $(CONF_DIR))</span>
 71 endif
 72 ifneq ($(CLASSES_DIR), )
 73   JMOD_FLAGS += --class-path $(CLASSES_DIR)
<span class="line-modified"> 74   DEPS += $(call FindFiles, $(CLASSES_DIR))</span>
 75 endif
 76 ifneq ($(INCLUDE_HEADERS_DIR), )
 77   JMOD_FLAGS += --header-files $(INCLUDE_HEADERS_DIR)
<span class="line-modified"> 78   DEPS += $(call FindFiles, $(INCLUDE_HEADERS_DIR))</span>
 79 endif
 80 ifneq ($(MAN_DIR), )
 81   JMOD_FLAGS += --man-pages $(MAN_DIR)
<span class="line-modified"> 82   DEPS += $(call FindFiles, $(MAN_DIR))</span>
 83 endif
 84 
 85 # If a specific modules_legal dir exists for this module, only pick up files
 86 # from there. These files were explicitly filtered or modified in &lt;module&gt;-copy
 87 # targets. For the rest, just pick up everything from the source legal dirs.
 88 LEGAL_NOTICES := \
<span class="line-modified"> 89     $(wildcard $(SUPPORT_OUTPUTDIR)/modules_legal/common) \</span>
 90     $(if $(wildcard $(SUPPORT_OUTPUTDIR)/modules_legal/$(MODULE)), \
 91       $(wildcard $(SUPPORT_OUTPUTDIR)/modules_legal/$(MODULE)), \
 92       $(call FindModuleLegalSrcDirs, $(MODULE)) \
 93     )
 94 
<span class="line-modified"> 95 ifneq ($(strip $(LEGAL_NOTICES)), )</span>
<span class="line-modified"> 96   LEGAL_NOTICES_PATH := $(call PathList, $(LEGAL_NOTICES))</span>
<span class="line-added"> 97   DEPS += $(call FindFiles, $(LEGAL_NOTICES))</span>
 98 
<span class="line-modified"> 99   JMOD_FLAGS += --legal-notices $(LEGAL_NOTICES_PATH)</span>
<span class="line-added">100 endif</span>
101 
102 ifeq ($(filter-out jdk.incubator.%, $(MODULE)), )
103   JMOD_FLAGS += --do-not-resolve-by-default
104   JMOD_FLAGS += --warn-if-resolved=incubating
105 endif
106 
107 # Add dependencies on other jmod files. Only java.base needs access to other
108 # jmods.
109 ifeq ($(MODULE), java.base)
110   # When creating a BUILDJDK, we don&#39;t need to add hashes to java.base
111   ifneq ($(CREATING_BUILDJDK), true)
112     # When creating interim versions of jmods, skip hashes
113     ifneq ($(INTERIM_JMOD), true)
114       ALL_UPGRADEABLE_MODULES := $(call FindAllUpgradeableModules)
115       DEPS += $(patsubst %, $(JMODS_DIR)/%.jmod, \
116           $(filter-out java.base $(ALL_UPGRADEABLE_MODULES), $(call FindAllModules)))
117 
118       EXCLUDE_PATTERN := $(strip $(subst $(SPACE),$$|,$(strip $(ALL_UPGRADEABLE_MODULES))))
119 
120       JMOD_FLAGS += --module-path $(JMODS_DIR) \
</pre>
<hr />
<pre>
132     endif
133     ifneq ($(MSVCP_DLL), )
134       ifneq ($(wildcard $(LIBS_DIR)/$(notdir $(MSVCP_DLL))), )
135         JMOD_FLAGS += --exclude &#39;$(notdir $(MSVCP_DLL))&#39;
136       endif
137     endif
138     ifneq ($(UCRT_DLL_DIR), )
139       UCRT_DLL_FILES := $(notdir $(wildcard $(UCRT_DLL_DIR)/*.dll))
140       ifneq ($(wildcard $(LIBS_DIR)/$(firstword $(UCRT_DLL_FILES))), )
141         JMOD_FLAGS += $(patsubst %, --exclude &#39;%&#39;, $(UCRT_DLL_FILES))
142       endif
143     endif
144   endif
145 endif
146 
147 # Changes to the jmod tool itself should also trigger a rebuild of all jmods.
148 # The variable JMOD_CMD could contain an environment variable assignment before
149 # the actual command. Filter that out using wildcard before adding to DEPS.
150 DEPS += $(wildcard $(JMOD_CMD))
151 ifeq ($(EXTERNAL_BUILDJDK), false)
<span class="line-modified">152   DEPS += $(call FindFiles, $(JDK_OUTPUTDIR)/modules/jdk.jlink/jdk/tools/jmod)</span>
153 endif
154 
155 # If creating interim versions of jmods, certain files need to be filtered out
156 # to avoid false incremental rebuilds.
157 ifeq ($(INTERIM_JMOD), true)
158   DEPS := $(filter-out $(SUPPORT_OUTPUTDIR)/modules_libs/java.base/classlist, $(DEPS))
159   INTERIM_MSG := interim$(SPACE)
160 endif
161 
162 JMOD_FLAGS += --exclude &#39;**{_the.*,_*.marker,*.diz,*.debuginfo,*.dSYM/**,*.dSYM,*.pdb,*.map}&#39;
163 
164 # Create jmods in the support dir and then move them into place to keep the
165 # module path in $(IMAGES_OUTPUTDIR)/jmods valid at all times.
166 $(eval $(call SetupExecute, create_$(JMOD_FILE), \
167     WARN := Creating $(INTERIM_MSG)$(JMOD_FILE), \
168     DEPS := $(DEPS), \
169     OUTPUT_FILE := $(JMODS_DIR)/$(JMOD_FILE), \
170     SUPPORT_DIR := $(JMODS_SUPPORT_DIR), \
171     PRE_COMMAND := $(RM) $(JMODS_DIR)/$(JMOD_FILE) $(JMODS_SUPPORT_DIR)/$(JMOD_FILE), \
172     COMMAND := $(JMOD) create --module-version $(VERSION_SHORT) \
</pre>
</td>
</tr>
</table>
<center><a href="Coverage.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="Docs.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>