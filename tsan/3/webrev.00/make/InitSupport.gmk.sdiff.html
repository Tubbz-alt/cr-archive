<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/InitSupport.gmk</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
<body>
<center><a href="Init.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="MacBundles.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/InitSupport.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 #
<span class="line-modified">  2 # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 36 
 37   # COMMA is defined in spec.gmk, but that is not included yet
 38   COMMA := ,
 39 
 40   # Include the corresponding closed file, if present.
 41   ifneq ($(CUSTOM_MAKE_DIR), )
 42     -include $(CUSTOM_MAKE_DIR)/InitSupport.gmk
 43   endif
 44 
 45   ##############################################################################
 46   # Helper functions for the initial part of Init.gmk, before the spec file is
 47   # loaded. Most of these functions provide parsing and setting up make options
 48   # from the command-line.
 49   ##############################################################################
 50 
 51   # Make control variables, handled by Init.gmk
 52   INIT_CONTROL_VARIABLES += LOG CONF CONF_NAME SPEC JOBS TEST_JOBS CONF_CHECK \
 53       COMPARE_BUILD JTREG GTEST MICRO TEST_OPTS TEST_VM_OPTS
 54 
 55   # All known make control variables
<span class="line-modified"> 56   MAKE_CONTROL_VARIABLES := $(INIT_CONTROL_VARIABLES) TEST JDK_FILTER</span>
 57 
 58   # Define a simple reverse function.
 59   # Should maybe move to MakeBase.gmk, but we can&#39;t include that file now.
 60   reverse = \
 61       $(if $(strip $(1)), $(call reverse, $(wordlist 2, $(words $(1)), $(1)))) \
 62           $(firstword $(1))
 63 
 64   # The variable MAKEOVERRIDES contains variable assignments from the command
 65   # line, but in reverse order to what the user entered.
 66   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 67   COMMAND_LINE_VARIABLES := $(subst \#,\ , $(call reverse, $(subst \ ,\#,$(MAKEOVERRIDES))))
 68 
 69   # A list like FOO=&quot;val1&quot; BAR=&quot;val2&quot; containing all user-supplied make
 70   # variables that we should propagate.
 71   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 72   USER_MAKE_VARS := $(subst \#,\ , $(filter-out $(addsuffix =%, $(INIT_CONTROL_VARIABLES)), \
 73       $(subst \ ,\#,$(MAKEOVERRIDES))))
 74 
 75   # Setup information about available configurations, if any.
 76   ifneq ($(CUSTOM_ROOT), )
</pre>
<hr />
<pre>
247   # Extract main targets from Main.gmk using the spec provided in $2.
248   #
249   # Param 1: FORCE = force generation of main-targets.gmk or LAZY = do not force.
250   # Param 2: The SPEC file to use.
251   define DefineMainTargets
252 
253     # We will start by making sure the main-targets.gmk file is removed, if
254     # make has not been restarted. By the -include, we will trigger the
255     # rule for generating the file (which is never there since we removed it),
256     # thus generating it fresh, and make will restart, incrementing the restart
257     # count.
258     main_targets_file := $$(dir $(strip $2))make-support/main-targets.gmk
259 
260     ifeq ($$(MAKE_RESTARTS),)
261       # Only do this if make has not been restarted, and if we do not force it.
262       ifeq ($(strip $1), FORCE)
263         $$(shell rm -f $$(main_targets_file))
264       endif
265     endif
266 
<span class="line-removed">267     # The --no-print-directory is needed to make the call from</span>
<span class="line-removed">268     # FindTest.gmk to Test.gmk work with LOG=debug/trace. See</span>
<span class="line-removed">269     # JDK-8213736</span>
270     $$(main_targets_file):
271 	@( cd $$(topdir) &amp;&amp; \
<span class="line-modified">272 	$$(MAKE) $$(MAKE_LOG_FLAGS) -r -R --no-print-directory \</span>
<span class="line-removed">273 	    -f $$(topdir)/make/Main.gmk \</span>
274 	    -I $$(topdir)/make/common SPEC=$(strip $2) NO_RECIPES=true \
275 	    $$(MAKE_LOG_VARS) \
276 	    create-main-targets-include )
277 
278     # Now include main-targets.gmk. This will define ALL_MAIN_TARGETS.
279     -include $$(main_targets_file)
280   endef
281 
282   define PrintConfCheckFailed
283 	@echo &#39; &#39;
284 	@echo &quot;Please rerun configure! Easiest way to do this is by running&quot;
285 	@echo &quot;&#39;make reconfigure&#39;.&quot;
286 	@echo &quot;This behavior may also be changed using CONF_CHECK=&lt;ignore|auto&gt;.&quot;
287 	@echo &#39; &#39;
288   endef
289 
290 else # $(HAS_SPEC)=true
291   ##############################################################################
292   # Helper functions for the &#39;main&#39; target. These functions assume a single,
293   # proper and existing SPEC is included.
294   ##############################################################################
295 
296   include $(TOPDIR)/make/common/MakeBase.gmk
297 
298   # Define basic logging setup
299   BUILD_LOG := $(OUTPUTDIR)/build.log
300   BUILD_PROFILE_LOG := $(OUTPUTDIR)/build-profile.log
301 
302   BUILD_LOG_PIPE := &gt; &gt;($(TEE) -a $(BUILD_LOG)) 2&gt; &gt;($(TEE) -a $(BUILD_LOG) &gt;&amp;2) &amp;&amp; wait



303 
304   ifneq ($(CUSTOM_ROOT), )
305     topdir=$(CUSTOM_ROOT)
306   else
307     topdir=$(TOPDIR)
308   endif
309 
310   # Parse COMPARE_BUILD into COMPARE_BUILD_*
311   # Syntax: COMPARE_BUILD=CONF=&lt;configure options&gt;:PATCH=&lt;patch file&gt;:
312   #         MAKE=&lt;make targets&gt;:COMP_OPTS=&lt;compare script options&gt;:
313   #         COMP_DIR=&lt;compare script base dir&gt;|&lt;default&gt;:
314   #         FAIL=&lt;bool&gt;
315   # If neither CONF or PATCH is given, assume &lt;default&gt; means CONF if it
316   # begins with &quot;--&quot;, otherwise assume it means PATCH.
317   # MAKE and COMP_OPTS can only be used with CONF and/or PATCH specified.
318   # If any value contains &quot;+&quot;, it will be replaced by space.
319   # FAIL can be set to false to have the return value of compare be ignored.
320   define ParseCompareBuild
321     ifneq ($$(COMPARE_BUILD), )
322       COMPARE_BUILD_OUTPUTDIR := $(topdir)/build/compare-build/$(CONF_NAME)
</pre>
<hr />
<pre>
371     endif
372   endef
373 
374   # Prepare for a comparison rebuild
375   define PrepareCompareBuild
376 	$(ECHO) &quot;Preparing for comparison rebuild&quot;
377         # Apply patch, if any
378 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -p1 &lt; $(COMPARE_BUILD_PATCH))
379         # Move the first build away temporarily
380 	$(RM) -r $(topdir)/build/.compare-build-temp
381 	$(MKDIR) -p $(topdir)/build/.compare-build-temp
382 	$(MV) $(OUTPUTDIR) $(topdir)/build/.compare-build-temp
383         # Restore an old compare-build, or create a new compare-build directory.
384 	if test -d $(COMPARE_BUILD_OUTPUTDIR); then \
385 	  $(MV) $(COMPARE_BUILD_OUTPUTDIR) $(OUTPUTDIR); \
386 	else \
387 	  $(MKDIR) -p $(OUTPUTDIR); \
388 	fi
389         # Re-run configure with the same arguments (and possibly some additional),
390         # must be done after patching.
<span class="line-modified">391 	( cd $(OUTPUTDIR) &amp;&amp; PATH=&quot;$(ORIGINAL_PATH)&quot; \</span>
392 	    $(BASH) $(topdir)/configure $(CONFIGURE_COMMAND_LINE) $(COMPARE_BUILD_CONF))
393   endef
394 
395   # Cleanup after a compare build
396   define CleanupCompareBuild
397         # If running with a COMPARE_BUILD patch, reverse-apply it
398 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -R -p1 &lt; $(COMPARE_BUILD_PATCH))
399         # Move this build away and restore the original build
400 	$(MKDIR) -p $(topdir)/build/compare-build
401 	$(MV) $(OUTPUTDIR) $(COMPARE_BUILD_OUTPUTDIR)
402 	$(MV) $(topdir)/build/.compare-build-temp/$(CONF_NAME) $(OUTPUTDIR)
403 	$(RM) -r $(topdir)/build/.compare-build-temp
404   endef
405 
406   # Do the actual comparison of two builds
407   define CompareBuildDoComparison
408         # Compare first and second build. Ignore any error code from compare.sh.
409 	$(ECHO) &quot;Comparing between comparison rebuild (this/new) and baseline (other/old)&quot;
410 	$(if $(COMPARE_BUILD_COMP_DIR), \
411 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
412 	      -2dirs $(COMPARE_BUILD_OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) \
413 	      $(OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) $(COMPARE_BUILD_IGNORE_RESULT)), \
414 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
415 	      -o $(OUTPUTDIR) $(COMPARE_BUILD_IGNORE_RESULT)) \
416 	)
417   endef
418 
419   define PrintFailureReports
420 	$(if $(filter none, $(LOG_REPORT)), , \
421 	  $(if $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log), \
422 	    $(PRINTF) &quot;\n=== Output from failing command(s) repeated here ===\n&quot; $(NEWLINE) \
423 	    $(foreach logfile, $(sort $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log)), \
424 	        $(PRINTF) &quot;* For target $(notdir $(basename $(logfile))):\n&quot; $(NEWLINE) \
425 	        $(if $(filter all, $(LOG_REPORT)), \
426 	          $(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true $(NEWLINE) \
427 	        , \
<span class="line-modified">428 	          ($(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true) | $(HEAD) -n 12 $(NEWLINE) \</span>
<span class="line-modified">429 	          if test `$(WC) -l &lt; $(logfile)` -gt 12; then \</span>
430 	            $(ECHO) &quot;   ... (rest of output omitted)&quot; ; \
431 	          fi $(NEWLINE) \
432 	        ) \
433 	    ) \
434 	    $(PRINTF) &quot;\n* All command lines available in $(MAKESUPPORT_OUTPUTDIR)/failure-logs.\n&quot; $(NEWLINE) \
435 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; \
436 	  ) \
437 	)
438   endef
439 
440   define PrintBuildLogFailures
441 	$(if $(filter none, $(LOG_REPORT)), , \
442 	  if $(GREP) -q &quot;recipe for target .* failed&quot; $(BUILD_LOG) 2&gt; /dev/null; then  \
443 	    $(PRINTF) &quot;\n=== Make failed targets repeated here ===\n&quot; ; \
444 	    $(GREP) &quot;recipe for target .* failed&quot; $(BUILD_LOG) ; \
445 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; ; \
446 	    $(PRINTF) &quot;\nHint: Try searching the build log for the name of the first failed target.\n&quot; ; \
447 	  else \
448 	    $(PRINTF) &quot;\nNo indication of failed target found.\n&quot; ; \
449 	    $(PRINTF) &quot;Hint: Try searching the build log for &#39;] Error&#39;.\n&quot; ; \
</pre>
<hr />
<pre>
501   define StartGlobalTimer
502 	$(RM) -r $(BUILDTIMESDIR) 2&gt; /dev/null &amp;&amp; \
503 	$(MKDIR) -p $(BUILDTIMESDIR) &amp;&amp; \
504 	$(call RecordStartTime,TOTAL)
505   endef
506 
507   define StopGlobalTimer
508 	$(call RecordEndTime,TOTAL)
509   endef
510 
511   # Find all build_time_* files and print their contents in a list sorted
512   # on the name of the sub repository.
513   define ReportBuildTimes
514 	$(PRINTF) $(LOG_INFO) -- \
515 	    &quot;----- Build times -------\nStart %s\nEnd   %s\n%s\n%s\n-------------------------\n&quot; \
516 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_start_TOTAL_human_readable`&quot; \
517 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_end_TOTAL_human_readable`&quot; \
518 	    &quot;`$(LS) $(BUILDTIMESDIR)/build_time_diff_* | $(GREP) -v _TOTAL | \
519 	    $(XARGS) $(CAT) | $(SORT) -k 2`&quot; \
520 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_diff_TOTAL`&quot; \
<span class="line-modified">521 	    $(BUILD_LOG_PIPE)</span>
522   endef
523 
524   define ReportProfileTimes
525     $(if $(findstring true, $(LOG_PROFILE_TIMES_LOG)), \
526       [ ! -f $(BUILD_PROFILE_LOG) ] || \
527       { $(ECHO) Begin $(notdir $(BUILD_PROFILE_LOG)) &amp;&amp; \
528         $(CAT) $(BUILD_PROFILE_LOG) &amp;&amp; \
529         $(ECHO) End $(notdir $(BUILD_PROFILE_LOG)); \
530       } \
<span class="line-modified">531       $(BUILD_LOG_PIPE)</span>
532     )
533   endef
534 
535 endif # HAS_SPEC
536 
537 # Look for a given option in the LOG variable, and if found, set a variable
538 # and remove the option from the LOG variable
539 # $1: The option to look for
540 # $2: The variable to set to &quot;true&quot; if the option is found
541 define ParseLogOption
542   ifneq ($$(findstring $1, $$(LOG)),)
543     override $2 := true
544     # First try to remove &quot;,&lt;option&gt;&quot; if it exists, otherwise just remove &quot;&lt;option&gt;&quot;
545     LOG_STRIPPED := $$(subst $1,, $$(subst $$(COMMA)$$(strip $1),, $$(LOG)))
546     # We might have ended up with a leading comma. Remove it. Need override
547     # since LOG is set from the command line.
548     override LOG := $$(strip $$(patsubst $$(COMMA)%, %, $$(LOG_STRIPPED)))
549   endif
550 endef
551 
</pre>
</td>
<td>
<hr />
<pre>
  1 #
<span class="line-modified">  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 36 
 37   # COMMA is defined in spec.gmk, but that is not included yet
 38   COMMA := ,
 39 
 40   # Include the corresponding closed file, if present.
 41   ifneq ($(CUSTOM_MAKE_DIR), )
 42     -include $(CUSTOM_MAKE_DIR)/InitSupport.gmk
 43   endif
 44 
 45   ##############################################################################
 46   # Helper functions for the initial part of Init.gmk, before the spec file is
 47   # loaded. Most of these functions provide parsing and setting up make options
 48   # from the command-line.
 49   ##############################################################################
 50 
 51   # Make control variables, handled by Init.gmk
 52   INIT_CONTROL_VARIABLES += LOG CONF CONF_NAME SPEC JOBS TEST_JOBS CONF_CHECK \
 53       COMPARE_BUILD JTREG GTEST MICRO TEST_OPTS TEST_VM_OPTS
 54 
 55   # All known make control variables
<span class="line-modified"> 56   MAKE_CONTROL_VARIABLES := $(INIT_CONTROL_VARIABLES) TEST JDK_FILTER SPEC_FILTER</span>
 57 
 58   # Define a simple reverse function.
 59   # Should maybe move to MakeBase.gmk, but we can&#39;t include that file now.
 60   reverse = \
 61       $(if $(strip $(1)), $(call reverse, $(wordlist 2, $(words $(1)), $(1)))) \
 62           $(firstword $(1))
 63 
 64   # The variable MAKEOVERRIDES contains variable assignments from the command
 65   # line, but in reverse order to what the user entered.
 66   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 67   COMMAND_LINE_VARIABLES := $(subst \#,\ , $(call reverse, $(subst \ ,\#,$(MAKEOVERRIDES))))
 68 
 69   # A list like FOO=&quot;val1&quot; BAR=&quot;val2&quot; containing all user-supplied make
 70   # variables that we should propagate.
 71   # The &#39;\#&#39; &lt;=&gt; &#39;\ &#39;dance is needed to keep values with space in them connected.
 72   USER_MAKE_VARS := $(subst \#,\ , $(filter-out $(addsuffix =%, $(INIT_CONTROL_VARIABLES)), \
 73       $(subst \ ,\#,$(MAKEOVERRIDES))))
 74 
 75   # Setup information about available configurations, if any.
 76   ifneq ($(CUSTOM_ROOT), )
</pre>
<hr />
<pre>
247   # Extract main targets from Main.gmk using the spec provided in $2.
248   #
249   # Param 1: FORCE = force generation of main-targets.gmk or LAZY = do not force.
250   # Param 2: The SPEC file to use.
251   define DefineMainTargets
252 
253     # We will start by making sure the main-targets.gmk file is removed, if
254     # make has not been restarted. By the -include, we will trigger the
255     # rule for generating the file (which is never there since we removed it),
256     # thus generating it fresh, and make will restart, incrementing the restart
257     # count.
258     main_targets_file := $$(dir $(strip $2))make-support/main-targets.gmk
259 
260     ifeq ($$(MAKE_RESTARTS),)
261       # Only do this if make has not been restarted, and if we do not force it.
262       ifeq ($(strip $1), FORCE)
263         $$(shell rm -f $$(main_targets_file))
264       endif
265     endif
266 



267     $$(main_targets_file):
268 	@( cd $$(topdir) &amp;&amp; \
<span class="line-modified">269 	$$(MAKE) $$(MAKE_LOG_FLAGS) -r -R -f $$(topdir)/make/Main.gmk \</span>

270 	    -I $$(topdir)/make/common SPEC=$(strip $2) NO_RECIPES=true \
271 	    $$(MAKE_LOG_VARS) \
272 	    create-main-targets-include )
273 
274     # Now include main-targets.gmk. This will define ALL_MAIN_TARGETS.
275     -include $$(main_targets_file)
276   endef
277 
278   define PrintConfCheckFailed
279 	@echo &#39; &#39;
280 	@echo &quot;Please rerun configure! Easiest way to do this is by running&quot;
281 	@echo &quot;&#39;make reconfigure&#39;.&quot;
282 	@echo &quot;This behavior may also be changed using CONF_CHECK=&lt;ignore|auto&gt;.&quot;
283 	@echo &#39; &#39;
284   endef
285 
286 else # $(HAS_SPEC)=true
287   ##############################################################################
288   # Helper functions for the &#39;main&#39; target. These functions assume a single,
289   # proper and existing SPEC is included.
290   ##############################################################################
291 
292   include $(TOPDIR)/make/common/MakeBase.gmk
293 
294   # Define basic logging setup
295   BUILD_LOG := $(OUTPUTDIR)/build.log
296   BUILD_PROFILE_LOG := $(OUTPUTDIR)/build-profile.log
297 
298   BUILD_LOG_PIPE := &gt; &gt;($(TEE) -a $(BUILD_LOG)) 2&gt; &gt;($(TEE) -a $(BUILD_LOG) &gt;&amp;2) &amp;&amp; wait
<span class="line-added">299   # Use this for simple echo/printf commands that are never expected to print</span>
<span class="line-added">300   # to stderr.</span>
<span class="line-added">301   BUILD_LOG_PIPE_SIMPLE := | $(TEE) -a $(BUILD_LOG)</span>
302 
303   ifneq ($(CUSTOM_ROOT), )
304     topdir=$(CUSTOM_ROOT)
305   else
306     topdir=$(TOPDIR)
307   endif
308 
309   # Parse COMPARE_BUILD into COMPARE_BUILD_*
310   # Syntax: COMPARE_BUILD=CONF=&lt;configure options&gt;:PATCH=&lt;patch file&gt;:
311   #         MAKE=&lt;make targets&gt;:COMP_OPTS=&lt;compare script options&gt;:
312   #         COMP_DIR=&lt;compare script base dir&gt;|&lt;default&gt;:
313   #         FAIL=&lt;bool&gt;
314   # If neither CONF or PATCH is given, assume &lt;default&gt; means CONF if it
315   # begins with &quot;--&quot;, otherwise assume it means PATCH.
316   # MAKE and COMP_OPTS can only be used with CONF and/or PATCH specified.
317   # If any value contains &quot;+&quot;, it will be replaced by space.
318   # FAIL can be set to false to have the return value of compare be ignored.
319   define ParseCompareBuild
320     ifneq ($$(COMPARE_BUILD), )
321       COMPARE_BUILD_OUTPUTDIR := $(topdir)/build/compare-build/$(CONF_NAME)
</pre>
<hr />
<pre>
370     endif
371   endef
372 
373   # Prepare for a comparison rebuild
374   define PrepareCompareBuild
375 	$(ECHO) &quot;Preparing for comparison rebuild&quot;
376         # Apply patch, if any
377 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -p1 &lt; $(COMPARE_BUILD_PATCH))
378         # Move the first build away temporarily
379 	$(RM) -r $(topdir)/build/.compare-build-temp
380 	$(MKDIR) -p $(topdir)/build/.compare-build-temp
381 	$(MV) $(OUTPUTDIR) $(topdir)/build/.compare-build-temp
382         # Restore an old compare-build, or create a new compare-build directory.
383 	if test -d $(COMPARE_BUILD_OUTPUTDIR); then \
384 	  $(MV) $(COMPARE_BUILD_OUTPUTDIR) $(OUTPUTDIR); \
385 	else \
386 	  $(MKDIR) -p $(OUTPUTDIR); \
387 	fi
388         # Re-run configure with the same arguments (and possibly some additional),
389         # must be done after patching.
<span class="line-modified">390 	( cd $(CONFIGURE_START_DIR) &amp;&amp; PATH=&quot;$(ORIGINAL_PATH)&quot; \</span>
391 	    $(BASH) $(topdir)/configure $(CONFIGURE_COMMAND_LINE) $(COMPARE_BUILD_CONF))
392   endef
393 
394   # Cleanup after a compare build
395   define CleanupCompareBuild
396         # If running with a COMPARE_BUILD patch, reverse-apply it
397 	$(if $(COMPARE_BUILD_PATCH), cd $(topdir) &amp;&amp; $(PATCH) -R -p1 &lt; $(COMPARE_BUILD_PATCH))
398         # Move this build away and restore the original build
399 	$(MKDIR) -p $(topdir)/build/compare-build
400 	$(MV) $(OUTPUTDIR) $(COMPARE_BUILD_OUTPUTDIR)
401 	$(MV) $(topdir)/build/.compare-build-temp/$(CONF_NAME) $(OUTPUTDIR)
402 	$(RM) -r $(topdir)/build/.compare-build-temp
403   endef
404 
405   # Do the actual comparison of two builds
406   define CompareBuildDoComparison
407         # Compare first and second build. Ignore any error code from compare.sh.
408 	$(ECHO) &quot;Comparing between comparison rebuild (this/new) and baseline (other/old)&quot;
409 	$(if $(COMPARE_BUILD_COMP_DIR), \
410 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
411 	      -2dirs $(COMPARE_BUILD_OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) \
412 	      $(OUTPUTDIR)/$(COMPARE_BUILD_COMP_DIR) $(COMPARE_BUILD_IGNORE_RESULT)), \
413 	  +(cd $(COMPARE_BUILD_OUTPUTDIR) &amp;&amp; ./compare.sh $(COMPARE_BUILD_COMP_OPTS) \
414 	      -o $(OUTPUTDIR) $(COMPARE_BUILD_IGNORE_RESULT)) \
415 	)
416   endef
417 
418   define PrintFailureReports
419 	$(if $(filter none, $(LOG_REPORT)), , \
420 	  $(if $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log), \
421 	    $(PRINTF) &quot;\n=== Output from failing command(s) repeated here ===\n&quot; $(NEWLINE) \
422 	    $(foreach logfile, $(sort $(wildcard $(MAKESUPPORT_OUTPUTDIR)/failure-logs/*.log)), \
423 	        $(PRINTF) &quot;* For target $(notdir $(basename $(logfile))):\n&quot; $(NEWLINE) \
424 	        $(if $(filter all, $(LOG_REPORT)), \
425 	          $(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true $(NEWLINE) \
426 	        , \
<span class="line-modified">427 	          ($(GREP) -v -e &quot;^Note: including file:&quot; &lt;  $(logfile) || true) | $(HEAD) -n 15 $(NEWLINE) \</span>
<span class="line-modified">428 	          if test `$(WC) -l &lt; $(logfile)` -gt 15; then \</span>
429 	            $(ECHO) &quot;   ... (rest of output omitted)&quot; ; \
430 	          fi $(NEWLINE) \
431 	        ) \
432 	    ) \
433 	    $(PRINTF) &quot;\n* All command lines available in $(MAKESUPPORT_OUTPUTDIR)/failure-logs.\n&quot; $(NEWLINE) \
434 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; \
435 	  ) \
436 	)
437   endef
438 
439   define PrintBuildLogFailures
440 	$(if $(filter none, $(LOG_REPORT)), , \
441 	  if $(GREP) -q &quot;recipe for target .* failed&quot; $(BUILD_LOG) 2&gt; /dev/null; then  \
442 	    $(PRINTF) &quot;\n=== Make failed targets repeated here ===\n&quot; ; \
443 	    $(GREP) &quot;recipe for target .* failed&quot; $(BUILD_LOG) ; \
444 	    $(PRINTF) &quot;=== End of repeated output ===\n&quot; ; \
445 	    $(PRINTF) &quot;\nHint: Try searching the build log for the name of the first failed target.\n&quot; ; \
446 	  else \
447 	    $(PRINTF) &quot;\nNo indication of failed target found.\n&quot; ; \
448 	    $(PRINTF) &quot;Hint: Try searching the build log for &#39;] Error&#39;.\n&quot; ; \
</pre>
<hr />
<pre>
500   define StartGlobalTimer
501 	$(RM) -r $(BUILDTIMESDIR) 2&gt; /dev/null &amp;&amp; \
502 	$(MKDIR) -p $(BUILDTIMESDIR) &amp;&amp; \
503 	$(call RecordStartTime,TOTAL)
504   endef
505 
506   define StopGlobalTimer
507 	$(call RecordEndTime,TOTAL)
508   endef
509 
510   # Find all build_time_* files and print their contents in a list sorted
511   # on the name of the sub repository.
512   define ReportBuildTimes
513 	$(PRINTF) $(LOG_INFO) -- \
514 	    &quot;----- Build times -------\nStart %s\nEnd   %s\n%s\n%s\n-------------------------\n&quot; \
515 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_start_TOTAL_human_readable`&quot; \
516 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_end_TOTAL_human_readable`&quot; \
517 	    &quot;`$(LS) $(BUILDTIMESDIR)/build_time_diff_* | $(GREP) -v _TOTAL | \
518 	    $(XARGS) $(CAT) | $(SORT) -k 2`&quot; \
519 	    &quot;`$(CAT) $(BUILDTIMESDIR)/build_time_diff_TOTAL`&quot; \
<span class="line-modified">520 	    $(BUILD_LOG_PIPE_SIMPLE)</span>
521   endef
522 
523   define ReportProfileTimes
524     $(if $(findstring true, $(LOG_PROFILE_TIMES_LOG)), \
525       [ ! -f $(BUILD_PROFILE_LOG) ] || \
526       { $(ECHO) Begin $(notdir $(BUILD_PROFILE_LOG)) &amp;&amp; \
527         $(CAT) $(BUILD_PROFILE_LOG) &amp;&amp; \
528         $(ECHO) End $(notdir $(BUILD_PROFILE_LOG)); \
529       } \
<span class="line-modified">530       $(BUILD_LOG_PIPE_SIMPLE)</span>
531     )
532   endef
533 
534 endif # HAS_SPEC
535 
536 # Look for a given option in the LOG variable, and if found, set a variable
537 # and remove the option from the LOG variable
538 # $1: The option to look for
539 # $2: The variable to set to &quot;true&quot; if the option is found
540 define ParseLogOption
541   ifneq ($$(findstring $1, $$(LOG)),)
542     override $2 := true
543     # First try to remove &quot;,&lt;option&gt;&quot; if it exists, otherwise just remove &quot;&lt;option&gt;&quot;
544     LOG_STRIPPED := $$(subst $1,, $$(subst $$(COMMA)$$(strip $1),, $$(LOG)))
545     # We might have ended up with a leading comma. Remove it. Need override
546     # since LOG is set from the command line.
547     override LOG := $$(strip $$(patsubst $$(COMMA)%, %, $$(LOG_STRIPPED)))
548   endif
549 endef
550 
</pre>
</td>
</tr>
</table>
<center><a href="Init.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> <a href="MacBundles.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>