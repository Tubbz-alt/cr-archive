<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/hotspot/gensrc/GensrcDtrace.gmk</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # Gensrc support for dtrace. The files generated here are included by dtrace.hpp
 28 
 29 ifeq ($(call check-jvm-feature, dtrace), true)
 30 
 31   ifeq ($(call isTargetOs, solaris), true)
 32     DTRACE_FLAGS := -64
 33     DTRACE_CPP_FLAGS := -D_LP64
 34   else ifeq ($(call isTargetOs, macosx), true)
 35     DTRACE_CPP_FLAGS := -D_LP64 -x c
 36   else ifeq ($(call isTargetOs, linux), true)
 37     DTRACE_CPP_FLAGS := -x c
 38   endif
 39 
 40   DTRACE_SOURCE_DIR := $(TOPDIR)/src/hotspot/os/posix/dtrace
 41   DTRACE_GENSRC_DIR := $(JVM_VARIANT_OUTPUTDIR)/gensrc/dtracefiles
 42 
 43   # Make sure we run our selected compiler for preprocessing instead of letting
 44   # the dtrace tool pick it on it&#39;s own.
 45   $(DTRACE_GENSRC_DIR)/%.h: $(DTRACE_SOURCE_DIR)/%.d
 46 	$(call LogInfo, Generating dtrace header file $(@F))
 47 	$(call MakeDir, $(@D) $(DTRACE_SUPPORT_DIR))
 48 	$(call ExecuteWithLog, $(DTRACE_SUPPORT_DIR)/$(@F).d, \
 49 	    ($(CPP) $(DTRACE_CPP_FLAGS) $&lt; &gt; $(DTRACE_SUPPORT_DIR)/$(@F).d))
 50 	$(call ExecuteWithLog, $@, $(DTRACE) $(DTRACE_FLAGS) -h -o $@ -s $(DTRACE_SUPPORT_DIR)/$(@F).d)
 51 
 52   # Process all .d files in DTRACE_SOURCE_DIR. They are:
 53   # hotspot_jni.d hotspot.d hs_private.d
 54   TARGETS += $(patsubst $(DTRACE_SOURCE_DIR)/%.d, \
 55       $(DTRACE_GENSRC_DIR)/%.h, $(wildcard $(DTRACE_SOURCE_DIR)/*.d))
 56 
 57   ifeq ($(call isTargetOs, solaris), true)
 58     ############################################################################
 59     # First we need to generate the dtraceGenOffsets tool. When run, this will
 60     # produce two header files and a C++ file. Note that generateJvmOffsets.cpp
 61     # is using the same JVM_CFLAGS as libjvm.so.
 62 
 63     # Include support files that will setup JVM compiler flags.
 64     include lib/JvmFeatures.gmk
 65     include lib/JvmFlags.gmk
 66 
 67     # We cannot compile until the JVMTI and JFR gensrc has finished.
 68     # JFR_FILES is defined in GensrcJfr.gmk.
 69     JVMTI_H := $(JVM_VARIANT_OUTPUTDIR)/gensrc/jvmtifiles/jvmti.h
 70 
 71     $(eval $(call SetupNativeCompilation, BUILD_DTRACE_GEN_OFFSETS, \
 72         NAME := dtraceGenOffsets, \
 73         TYPE := EXECUTABLE, \
 74         SRC := $(TOPDIR)/make/hotspot/src/native/dtrace, \
 75         TOOLCHAIN := $(TOOLCHAIN_BUILD), \
 76         LDFLAGS := -m64, \
 77         CFLAGS := -m64 $(JVM_CFLAGS), \
 78         DISABLED_WARNINGS_solstudio := hidef w_novirtualdescr unknownpragma \
 79             doubunder nokeyworddefine wunreachable, \
 80         EXTRA_DEPS := $(JVMTI_H) $(JFR_FILES), \
 81         OBJECT_DIR := $(JVM_VARIANT_OUTPUTDIR)/tools/dtrace-gen-offsets/objs, \
 82         OUTPUT_DIR := $(JVM_VARIANT_OUTPUTDIR)/tools/dtrace-gen-offsets, \
 83     ))
 84 
 85     DTRACE_GEN_OFFSETS_TOOL := $(BUILD_DTRACE_GEN_OFFSETS_TARGET)
 86 
 87     # Argument 1: Output filename
 88     # Argument 2: dtrace-gen-offset tool command line option
 89     define SetupDtraceOffsetsGeneration
 90       $$(eval $$(call SetupExecute, dtrace_offset_$$(strip $2), \
 91           INFO := Generating dtrace $2 file, \
 92           DEPS := $$(BUILD_DTRACE_GEN_OFFSETS), \
 93           OUTPUT_FILE := $1, \
 94           COMMAND := ( $$(DTRACE_GEN_OFFSETS_TOOL) -$$(strip $2) &gt; $1 ), \
 95       ))
 96 
 97       TARGETS += $$(dtrace_offset_$$(strip $2)_TARGET)
 98     endef
 99 
100     JVM_OFFSETS_H := $(DTRACE_GENSRC_DIR)/JvmOffsets.h
101     JVM_OFFSETS_CPP := $(DTRACE_GENSRC_DIR)/JvmOffsets.cpp
102     JVM_OFFSETS_INDEX_H := $(DTRACE_GENSRC_DIR)/JvmOffsetsIndex.h
103 
104     ############################################################################
105     # Run the dtrace-gen-offset tool to generate these three files.
106     # The generated JvmOffsets.cpp is compiled with the rest of libjvm.
107     # The header files are used by libjvm_db and jhelper.d, respectively.
108 
109     $(eval $(call SetupDtraceOffsetsGeneration, $(JVM_OFFSETS_H), header))
110     $(eval $(call SetupDtraceOffsetsGeneration, $(JVM_OFFSETS_INDEX_H), index))
111     $(eval $(call SetupDtraceOffsetsGeneration, $(JVM_OFFSETS_CPP), table))
112   endif
113 
114 endif
    </pre>
  </body>
</html>