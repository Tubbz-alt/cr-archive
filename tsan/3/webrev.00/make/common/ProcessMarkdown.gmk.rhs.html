<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/common/ProcessMarkdown.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
    <script type="text/javascript" src="../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a><span class="line-modified">  1 # Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  2 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  3 #
  4 # This code is free software; you can redistribute it and/or modify it
  5 # under the terms of the GNU General Public License version 2 only, as
  6 # published by the Free Software Foundation.  Oracle designates this
  7 # particular file as subject to the &quot;Classpath&quot; exception as provided
  8 # by Oracle in the LICENSE file that accompanied this code.
  9 #
 10 # This code is distributed in the hope that it will be useful, but WITHOUT
 11 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13 # version 2 for more details (a copy is included in the LICENSE file that
 14 # accompanied this code).
 15 #
 16 # You should have received a copy of the GNU General Public License version
 17 # 2 along with this work; if not, write to the Free Software Foundation,
 18 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19 #
 20 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21 # or visit www.oracle.com if you need additional information or have any
 22 # questions.
 23 #
 24 
 25 ifeq (,$(_MAKEBASE_GMK))
 26   $(error You must include MakeBase.gmk prior to including ProcessMarkdown.gmk)
 27 endif
 28 
 29 include TextFileProcessing.gmk
 30 
 31 # Helper function for SetupProcessMarkdown
 32 # $1: The $1 from SetupProcessMarkdown
 33 # $2: The name of the current source file, relative to the dir given in $3
 34 # $3: The directory of the current source file
 35 define ProcessMarkdown
 36   $1_$2_OUTPUT_FILE := $$($1_DEST)/$$(basename $2)$$($1_FILE_EXT)
 37   $1_$2_TARGET_DIR := $$(dir $$($1_$2_OUTPUT_FILE))
 38   $1_$2_INPUT_FILE := $3/$2
 39   $1_$2_MARKER := $$(subst /,_,$1_$2)
 40 
 41   ifneq ($$($1_REPLACEMENTS), )
 42     $1_$2_PANDOC_INPUT := $$(SUPPORT_OUTPUTDIR)/markdown/$$($1_$2_MARKER)_pre.tmp
 43 
 44     $$(eval $$(call SetupTextFileProcessing, $1_$2_PREPROCESSED, \
 45         SOURCE_FILES := $$($1_$2_INPUT_FILE), \
 46         OUTPUT_FILE := $$($1_$2_PANDOC_INPUT), \
 47         REPLACEMENTS := $$($1_REPLACEMENTS), \
 48     ))
 49   else
 50     $1_$2_PANDOC_INPUT := $$($1_$2_INPUT_FILE)
 51   endif
 52 
 53   ifneq ($$($1_POST_PROCESS), )
 54     $1_$2_PANDOC_OUTPUT := $$(SUPPORT_OUTPUTDIR)/markdown/$$($1_$2_MARKER)_post.tmp
 55   else
 56     $1_$2_PANDOC_OUTPUT := $$($1_$2_OUTPUT_FILE)
 57   endif
 58 
 59   ifneq ($$($1_CSS), )
 60     ifneq ($$(findstring http:/, $$($1_CSS)), )
 61       $1_$2_CSS_OPTION := --css &#39;$$($1_CSS)&#39;
 62     else
 63       $1_$2_CSS := $$(strip $$(call RelativePath, $$($1_CSS), $$($1_$2_TARGET_DIR)))
 64       $1_$2_CSS_OPTION := --css &#39;$$($1_$2_CSS)&#39;
 65     endif
 66   endif
 67 
 68   # This does not need to be included in VARDEPS since it&#39;s from the actual
 69   # source file. Only run the shell if the recipe gets executed below.
 70   $1_$2_OPTIONS_FROM_SRC = \
 71       $$(shell $$(GREP) _pandoc-options_: $3/$2 | $$(CUT) -d : -f 2-)
 72 
 73   ifneq ($$($1_FILTER), )
 74     $1_$2_OPTIONS := --filter $$($1_FILTER)
 75   endif
 76 
 77   $1_$2_VARDEPS := $$($1_OPTIONS) $$($1_$2_OPTIONS) $$($1_CSS) \
 78       $$($1_REPLACEMENTS) $$($1_POST_PROCESS)
 79   $1_$2_VARDEPS_FILE := $$(call DependOnVariable, $1_$2_VARDEPS, \
 80       $$(SUPPORT_OUTPUTDIR)/markdown/$$($1_$2_MARKER).vardeps)
 81 
 82   $$($1_$2_PANDOC_OUTPUT): $$($1_$2_PANDOC_INPUT) $$($1_$2_VARDEPS_FILE) $$($1_EXTRA_DEPS)
 83 	$$(call LogInfo, Converting $2 to $$($1_FORMAT))
 84 	$$(call MakeDir, $$(SUPPORT_OUTPUTDIR)/markdown $$(dir $$($1_$2_PANDOC_OUTPUT)))
 85 	$$(call ExecuteWithLog, $$(SUPPORT_OUTPUTDIR)/markdown/$$($1_$2_MARKER), \
 86 	    $$(PANDOC) $$($1_OPTIONS) -f $$(PANDOC_MARKDOWN_FLAG) \
 87 	    -t $$($1_FORMAT) --standalone \
 88 	    $$($1_$2_CSS_OPTION) $$($1_$2_OPTIONS_FROM_SRC) $$($1_$2_OPTIONS) \
 89 	    &#39;$$($1_$2_PANDOC_INPUT)&#39; -o &#39;$$($1_$2_PANDOC_OUTPUT)&#39;)
 90         ifneq ($$(findstring $$(LOG_LEVEL), debug trace),)
 91 	  TOO_LONG_LINES=`$$(GREP) -E -e &#39;^.{80}.+$$$$&#39; $$&lt;` || true ; \
 92 	  if [ &quot;x$$$$TOO_LONG_LINES&quot; != x ]; then \
 93 	    $$(ECHO) &quot;Warning: Unsuitable markdown in $$&lt;:&quot; ; \
 94 	    $$(ECHO) &quot;The following lines are longer than 80 characters:&quot; ; \
 95 	    $$(GREP) -E -n -e &#39;^.{80}.+$$$$&#39; $$&lt; || true ; \
 96 	  fi
 97         endif
 98 
 99   # If we have no post processing, PANDOC_OUTPUT is set to OUTPUT_FILE. Otherwise
100   # PANDOC_OUTPUT is a temporary file, and we must now create the real OUTPUT_FILE.
101   ifneq ($$($1_POST_PROCESS), )
102     $$($1_$2_OUTPUT_FILE): $$($1_$2_PANDOC_OUTPUT)
103 	$$(call LogInfo, Post-processing markdown file $2)
104 	$$(call MakeDir, $$(SUPPORT_OUTPUTDIR)/markdown $$($1_$2_TARGET_DIR))
105 	$$(call ExecuteWithLog, $$(SUPPORT_OUTPUTDIR)/markdown/$$($1_$2_MARKER)_post, \
<a name="2" id="anc2"></a><span class="line-modified">106 	    ( $$($1_POST_PROCESS) &lt; $$($1_$2_PANDOC_OUTPUT) &gt; $$($1_$2_OUTPUT_FILE) ) )</span>
107   endif
108 
109   $1 += $$($1_$2_OUTPUT_FILE)
110 endef
111 
112 ################################################################################
113 # Setup make rules for converting a markdown file to html.
114 #
115 # Parameter 1 is the name of the rule. This name is used as variable prefix,
116 # and the targets generated are listed in a variable by that name.
117 #
118 # Remaining parameters are named arguments. These include:
119 #   DEST     : Destination root dir
120 #   FILES    : List of files to copy with absolute paths, or path relative to SRC.
121 #   SRC      : Source root dir; if given keep input files hierarchy relative to
122 #              SRC in DEST, otherwise flatten structure into DEST.
123 #   FORMAT   : The target format (defaults to html5)
124 #   FILE_EXT : The file extension to replace .md with (defaults to .html)
125 #   OPTIONS  : Additional options to pandoc
126 #   EXTRA_DEPS : Additional dependencies to add to each pandoc call
127 #   FILTER   : Optional pandoc filter command
128 #   POST_PROCESS : Optional command-line to post-process generated markdown
129 #   REPLACEMENTS : Text replacements to perform on input file before processing
130 #
131 SetupProcessMarkdown = $(NamedParamsMacroTemplate)
132 define SetupProcessMarkdownBody
133   ifeq ($$($1_FILES), )
134     $$(error FILES is missing in SetupProcessMarkdown $1)
135   endif
136 
137   ifeq ($$($1_DEST), )
138     $$(error DEST is missing in SetupProcessMarkdown $1)
139   endif
140 
141   # If no target format is specified, default to html5.
142   ifeq ($$($1_FORMAT), )
143     $1_FORMAT := html5
144   endif
145 
146   ifeq ($$($1_FORMAT), man)
147     # If no file extension is specified, default to &#39;.1&#39;.
148     ifeq ($$($1_FILE_EXT), )
149       $1_FILE_EXT := .1
150     endif
151   else ifeq ($$($1_FORMAT), html5)
152     ifeq ($$($1_FILE_EXT), )
153       $1_FILE_EXT := .html
154     endif
155   else ifeq ($$($1_FORMAT), html)
156     ifeq ($$($1_FILE_EXT), )
157       $1_FILE_EXT := .html
158     endif
159   endif
160 
161   # Remove any trailing slash
162   $1_DEST := $$(patsubst %/,%,$$($1_DEST))
163 
164   ifeq ($$($1_SRC), )
165     # No SRC given, assume we&#39;re flattening all files into output dir.
166     $$(foreach f, $$($1_FILES), \
167       $$(eval $$(call ProcessMarkdown,$1,$$(notdir $$f),$$(patsubst %/,%,$$(dir $$f)))) \
168     )
169   else
170     # Remove any trailing slash
171     $1_SRC := $$(patsubst %/,%,$$($1_SRC))
172 
173     $$(foreach f, $$(patsubst $$($1_SRC)/%,%,$$($1_FILES)), \
174       $$(eval $$(call ProcessMarkdown,$1,$$f,$$($1_SRC))) \
175     )
176   endif
177 endef
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>