<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/common/ZipArchive.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
    <script type="text/javascript" src="../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #
<a name="1" id="anc1"></a><span class="line-modified">  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ifndef _ZIP_ARCHIVE_GMK
 27 _ZIP_ARCHIVE_GMK := 1
 28 
 29 ifeq (,$(_MAKEBASE_GMK))
 30   $(error You must include MakeBase.gmk prior to including ZipArchive.gmk)
 31 endif
 32 
 33 # Setup make rules for creating a zip archive.
 34 #
 35 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 36 # and the targets generated are listed in a variable by that name.
 37 #
 38 # Remaining parameters are named arguments. These include:
 39 #   SRC
 40 #   ZIP
 41 #   INCLUDES
 42 #   INCLUDE_FILES
 43 #   EXCLUDES
 44 #   EXCLUDE_FILES
 45 #   EXCLUDE_PATTERNS - Patterns with at most one % wildcard matching filenames
 46 #                      and not directories.
 47 #   EXCLUDE_PATTERNS_$dir - Exclude patterns just like above but specific to one
 48 #                           src dir
 49 #   SUFFIXES
 50 #   EXTRA_DEPS
<a name="2" id="anc2"></a><span class="line-added"> 51 #   FOLLOW_SYMLINKS - Set to explicitly follow symlinks. Affects performance of</span>
<span class="line-added"> 52 #                     finding files.</span>
 53 #   ZIP_OPTIONS extra options to pass to zip
 54 SetupZipArchive = $(NamedParamsMacroTemplate)
 55 define SetupZipArchiveBody
 56 
<a name="3" id="anc3"></a><span class="line-added"> 57   # Create a version $1_SRC with a guaranteed trailing slash</span>
<span class="line-added"> 58   $1_SRC_SLASH := $$(addsuffix /, $$(patsubst %/, %, $$($1_SRC)))</span>
<span class="line-added"> 59 </span>
 60   # To avoid running find over too large sets of files, which causes make to crash
 61   # on some configurations (cygwin), use INCLUDES and INCLUDE_FILES to build a set
 62   # of directories to run find in, if available.
 63   ifneq ($$($1_INCLUDES)$$($1_INCLUDE_FILES),)
<a name="4" id="anc4"></a><span class="line-modified"> 64     $1_FIND_LIST := $$(wildcard $$(foreach s,$$($1_SRC_SLASH), \</span>
<span class="line-modified"> 65         $$(addprefix $$s,$$($1_INCLUDES) $$($1_INCLUDE_FILES))))</span>
 66   else
<a name="5" id="anc5"></a><span class="line-modified"> 67     $1_FIND_LIST := $$($1_SRC_SLASH)</span>
 68   endif
 69 
<a name="6" id="anc6"></a><span class="line-modified"> 70   # Find all files in the source tree.</span>
<span class="line-modified"> 71   # If asked to, follow symlinks in this find since that is what zip does. To do</span>
<span class="line-modified"> 72   # this, we need to call ShellFindFiles directly.</span>
<span class="line-added"> 73   ifeq ($$($1_FOLLOW_SYMLINKS), true)</span>
<span class="line-added"> 74     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call ShellFindFiles,$$($1_FIND_LIST), , -L))</span>
<span class="line-added"> 75   else</span>
<span class="line-added"> 76     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call FindFiles,$$($1_FIND_LIST)))</span>
<span class="line-added"> 77   endif</span>
 78 
 79   # Filter on suffixes if set
 80   ifneq ($$($1_SUFFIXES),)
 81     $1_ALL_SRCS := $$(filter $$(addprefix %, $$($1_SUFFIXES)), $$($1_ALL_SRCS))
 82   endif
 83 
 84   ifneq ($$($1_INCLUDES),)
 85     ifneq ($$($1_SUFFIXES),)
 86       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 87           $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$$s$(DQUOTE),$$($1_INCLUDES))))
 88     else
 89       $1_ZIP_INCLUDES := $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_INCLUDES)))
 90     endif
 91   else
 92     ifneq ($$($1_SUFFIXES),)
 93       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 94           $$(addprefix -i$(SPACE)$(DQUOTE),*$$s$(DQUOTE)))
 95     endif
 96   endif
 97   ifneq ($$($1_INCLUDE_FILES),)
 98     $1_ZIP_INCLUDES += $$(addprefix -i$(SPACE),$$($1_INCLUDE_FILES))
 99   endif
100   ifneq ($$($1_EXCLUDES),)
101     $1_ZIP_EXCLUDES := $$(addprefix -x$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_EXCLUDES)))
<a name="7" id="anc7"></a><span class="line-modified">102     $1_SRC_EXCLUDES := $$(foreach s,$$($1_SRC_SLASH),$$(addprefix $$s,$$(addsuffix /%,$$($1_EXCLUDES))))</span>
103     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDES),$$($1_ALL_SRCS))
104   endif
105   ifneq ($$($1_EXCLUDE_FILES),)
106     $1_SRC_EXCLUDE_FILES := $$(addprefix %, $$($1_EXCLUDE_FILES)) $$($1_EXCLUDE_FILES)
107     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDE_FILES), $$($1_ALL_SRCS))
<a name="8" id="anc8"></a><span class="line-modified">108     $$(foreach s, $$($1_SRC_SLASH), \</span>
109       $$(eval $1_ZIP_EXCLUDES_$$s += \
<a name="9" id="anc9"></a><span class="line-modified">110           $$(addprefix -x$$(SPACE), $$(patsubst $$s%,%, $$($1_EXCLUDE_FILES))) \</span>
111       ) \
112     )
113   endif
114   ifneq ($$($1_EXCLUDE_PATTERNS), )
115     $1_ALL_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERNS), $$($1_ALL_SRCS))
116     $1_ZIP_EXCLUDES += $$(addprefix -x$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS)))
117   endif
118   # Rewrite src dir specific exclude patterns to zip excludes
<a name="10" id="anc10"></a><span class="line-modified">119   $$(foreach s, $$($1_SRC_SLASH), \</span>
120     $$(if $$($1_EXCLUDE_PATTERNS_$$s), \
121       $$(eval $1_ZIP_EXCLUDES_$$s += \
122           $$(addprefix -x$$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS_$$s))) \
123       ) \
124     ) \
125   )
126 
127   # Use a slightly shorter name for logging, but with enough path to identify this zip.
128   $1_NAME:=$$(subst $$(OUTPUTDIR)/,,$$($1_ZIP))
129 
130   # Now $1_ALL_SRCS should contain all sources that are going to be put into the zip.
131   # I.e. the zip -i and -x options should match the filtering done in the makefile.
132   # Explicitly excluded files can be given with absolute path. The patsubst solution
133   # isn&#39;t perfect but the likelyhood of an absolute path to match something in a src
134   # dir is very small.
135   # If zip has nothing to do, it returns 12 and would fail the build. Check for 12
136   # and only fail if it&#39;s not.
137   $$($1_ZIP) : $$($1_ALL_SRCS) $$($1_EXTRA_DEPS)
138 	$$(call LogWarn, Updating $$($1_NAME))
139 	$$(call MakeTargetDir)
<a name="11" id="anc11"></a><span class="line-modified">140         # Find duplicate file names in the SRC and generate excludes for all</span>
<span class="line-added">141         # instances that should not be included. Run this rather expensive</span>
<span class="line-added">142         # calculation as part of the recipe to avoid running it when nothing</span>
<span class="line-added">143         # needs to be rebuilt. The drawback is that we cannot exclude these</span>
<span class="line-added">144         # files from the make prerequisites list, but the number of files is</span>
<span class="line-added">145         # usually small so a very rare unnecessary rebuild is worth it.</span>
<span class="line-added">146         # (The inner most foreach here is used instead of eval to declare a</span>
<span class="line-added">147         # local variable.)</span>
<span class="line-added">148 	$$(foreach root, $$($1_SRC_SLASH), \</span>
<span class="line-added">149 	  $$(foreach file, $$(filter $$(root)%, $$($1_ALL_SRCS)), \</span>
<span class="line-added">150 	    $$(foreach relfile, $$(patsubst $$(root)%, %, $$(file)), \</span>
<span class="line-added">151 	      $$(if $$($1_relfiles_$$(call DoubleDollar, $$(relfile))), \</span>
<span class="line-added">152 	        $$(eval $1_ZIP_EXCLUDES_$$(root) += -x $$(relfile)) \</span>
<span class="line-added">153 	      , \</span>
<span class="line-added">154 	        $$(eval $1_relfiles_$$(call DoubleDollar, $$(relfile)) := 1) \</span>
<span class="line-added">155 	      ) \</span>
<span class="line-added">156 	    ) \</span>
<span class="line-added">157 	  ) \</span>
<span class="line-added">158 	)</span>
<span class="line-added">159 	$$(foreach s,$$($1_SRC_SLASH), $$(call ExecuteWithLog, \</span>
160 	    $$(SUPPORT_OUTPUTDIR)/zip/$$(patsubst $$(OUTPUTDIR)/%,%, $$@), \
161 	    (cd $$s &amp;&amp; $(ZIPEXE) -qru $$($1_ZIP_OPTIONS) $$@ . \
162 	        $$($1_ZIP_INCLUDES) $$($1_ZIP_EXCLUDES) -x \*_the.\* \
163 	        $$($1_ZIP_EXCLUDES_$$s) \
164 	        || test &quot;$$$$?&quot; = &quot;12&quot; \
165 	    ))$$(NEWLINE) \
166 	) true \
167 	$(TOUCH) $$@
168 
169   # Add zip to target list
170   $1 += $$($1_ZIP)
171 endef
172 
173 endif # _ZIP_ARCHIVE_GMK
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>