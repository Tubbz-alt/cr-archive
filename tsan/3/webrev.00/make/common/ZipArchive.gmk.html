<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/common/ZipArchive.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ifndef _ZIP_ARCHIVE_GMK
 27 _ZIP_ARCHIVE_GMK := 1
 28 
 29 ifeq (,$(_MAKEBASE_GMK))
 30   $(error You must include MakeBase.gmk prior to including ZipArchive.gmk)
 31 endif
 32 
 33 # Setup make rules for creating a zip archive.
 34 #
 35 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 36 # and the targets generated are listed in a variable by that name.
 37 #
 38 # Remaining parameters are named arguments. These include:
 39 #   SRC
 40 #   ZIP
 41 #   INCLUDES
 42 #   INCLUDE_FILES
 43 #   EXCLUDES
 44 #   EXCLUDE_FILES
 45 #   EXCLUDE_PATTERNS - Patterns with at most one % wildcard matching filenames
 46 #                      and not directories.
 47 #   EXCLUDE_PATTERNS_$dir - Exclude patterns just like above but specific to one
 48 #                           src dir
 49 #   SUFFIXES
 50 #   EXTRA_DEPS
 51 #   FOLLOW_SYMLINKS - Set to explicitly follow symlinks. Affects performance of
 52 #                     finding files.
 53 #   ZIP_OPTIONS extra options to pass to zip
 54 SetupZipArchive = $(NamedParamsMacroTemplate)
 55 define SetupZipArchiveBody
 56 
 57   # Create a version $1_SRC with a guaranteed trailing slash
 58   $1_SRC_SLASH := $$(addsuffix /, $$(patsubst %/, %, $$($1_SRC)))
 59 
 60   # To avoid running find over too large sets of files, which causes make to crash
 61   # on some configurations (cygwin), use INCLUDES and INCLUDE_FILES to build a set
 62   # of directories to run find in, if available.
 63   ifneq ($$($1_INCLUDES)$$($1_INCLUDE_FILES),)
 64     $1_FIND_LIST := $$(wildcard $$(foreach s,$$($1_SRC_SLASH), \
 65         $$(addprefix $$s,$$($1_INCLUDES) $$($1_INCLUDE_FILES))))
 66   else
 67     $1_FIND_LIST := $$($1_SRC_SLASH)
 68   endif
 69 
 70   # Find all files in the source tree.
 71   # If asked to, follow symlinks in this find since that is what zip does. To do
 72   # this, we need to call ShellFindFiles directly.
 73   ifeq ($$($1_FOLLOW_SYMLINKS), true)
 74     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call ShellFindFiles,$$($1_FIND_LIST), , -L))
 75   else
 76     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call FindFiles,$$($1_FIND_LIST)))
 77   endif
 78 
 79   # Filter on suffixes if set
 80   ifneq ($$($1_SUFFIXES),)
 81     $1_ALL_SRCS := $$(filter $$(addprefix %, $$($1_SUFFIXES)), $$($1_ALL_SRCS))
 82   endif
 83 
 84   ifneq ($$($1_INCLUDES),)
 85     ifneq ($$($1_SUFFIXES),)
 86       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 87           $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$$s$(DQUOTE),$$($1_INCLUDES))))
 88     else
 89       $1_ZIP_INCLUDES := $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_INCLUDES)))
 90     endif
 91   else
 92     ifneq ($$($1_SUFFIXES),)
 93       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 94           $$(addprefix -i$(SPACE)$(DQUOTE),*$$s$(DQUOTE)))
 95     endif
 96   endif
 97   ifneq ($$($1_INCLUDE_FILES),)
 98     $1_ZIP_INCLUDES += $$(addprefix -i$(SPACE),$$($1_INCLUDE_FILES))
 99   endif
100   ifneq ($$($1_EXCLUDES),)
101     $1_ZIP_EXCLUDES := $$(addprefix -x$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_EXCLUDES)))
102     $1_SRC_EXCLUDES := $$(foreach s,$$($1_SRC_SLASH),$$(addprefix $$s,$$(addsuffix /%,$$($1_EXCLUDES))))
103     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDES),$$($1_ALL_SRCS))
104   endif
105   ifneq ($$($1_EXCLUDE_FILES),)
106     $1_SRC_EXCLUDE_FILES := $$(addprefix %, $$($1_EXCLUDE_FILES)) $$($1_EXCLUDE_FILES)
107     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDE_FILES), $$($1_ALL_SRCS))
108     $$(foreach s, $$($1_SRC_SLASH), \
109       $$(eval $1_ZIP_EXCLUDES_$$s += \
110           $$(addprefix -x$$(SPACE), $$(patsubst $$s%,%, $$($1_EXCLUDE_FILES))) \
111       ) \
112     )
113   endif
114   ifneq ($$($1_EXCLUDE_PATTERNS), )
115     $1_ALL_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERNS), $$($1_ALL_SRCS))
116     $1_ZIP_EXCLUDES += $$(addprefix -x$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS)))
117   endif
118   # Rewrite src dir specific exclude patterns to zip excludes
119   $$(foreach s, $$($1_SRC_SLASH), \
120     $$(if $$($1_EXCLUDE_PATTERNS_$$s), \
121       $$(eval $1_ZIP_EXCLUDES_$$s += \
122           $$(addprefix -x$$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS_$$s))) \
123       ) \
124     ) \
125   )
126 
127   # Use a slightly shorter name for logging, but with enough path to identify this zip.
128   $1_NAME:=$$(subst $$(OUTPUTDIR)/,,$$($1_ZIP))
129 
130   # Now $1_ALL_SRCS should contain all sources that are going to be put into the zip.
131   # I.e. the zip -i and -x options should match the filtering done in the makefile.
132   # Explicitly excluded files can be given with absolute path. The patsubst solution
133   # isn&#39;t perfect but the likelyhood of an absolute path to match something in a src
134   # dir is very small.
135   # If zip has nothing to do, it returns 12 and would fail the build. Check for 12
136   # and only fail if it&#39;s not.
137   $$($1_ZIP) : $$($1_ALL_SRCS) $$($1_EXTRA_DEPS)
138 	$$(call LogWarn, Updating $$($1_NAME))
139 	$$(call MakeTargetDir)
140         # Find duplicate file names in the SRC and generate excludes for all
141         # instances that should not be included. Run this rather expensive
142         # calculation as part of the recipe to avoid running it when nothing
143         # needs to be rebuilt. The drawback is that we cannot exclude these
144         # files from the make prerequisites list, but the number of files is
145         # usually small so a very rare unnecessary rebuild is worth it.
146         # (The inner most foreach here is used instead of eval to declare a
147         # local variable.)
148 	$$(foreach root, $$($1_SRC_SLASH), \
149 	  $$(foreach file, $$(filter $$(root)%, $$($1_ALL_SRCS)), \
150 	    $$(foreach relfile, $$(patsubst $$(root)%, %, $$(file)), \
151 	      $$(if $$($1_relfiles_$$(call DoubleDollar, $$(relfile))), \
152 	        $$(eval $1_ZIP_EXCLUDES_$$(root) += -x $$(relfile)) \
153 	      , \
154 	        $$(eval $1_relfiles_$$(call DoubleDollar, $$(relfile)) := 1) \
155 	      ) \
156 	    ) \
157 	  ) \
158 	)
159 	$$(foreach s,$$($1_SRC_SLASH), $$(call ExecuteWithLog, \
160 	    $$(SUPPORT_OUTPUTDIR)/zip/$$(patsubst $$(OUTPUTDIR)/%,%, $$@), \
161 	    (cd $$s &amp;&amp; $(ZIPEXE) -qru $$($1_ZIP_OPTIONS) $$@ . \
162 	        $$($1_ZIP_INCLUDES) $$($1_ZIP_EXCLUDES) -x \*_the.\* \
163 	        $$($1_ZIP_EXCLUDES_$$s) \
164 	        || test &quot;$$$$?&quot; = &quot;12&quot; \
165 	    ))$$(NEWLINE) \
166 	) true \
167 	$(TOUCH) $$@
168 
169   # Add zip to target list
170   $1 += $$($1_ZIP)
171 endef
172 
173 endif # _ZIP_ARCHIVE_GMK
    </pre>
  </body>
</html>