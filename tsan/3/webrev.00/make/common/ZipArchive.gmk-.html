<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/common/ZipArchive.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ifndef _ZIP_ARCHIVE_GMK
 27 _ZIP_ARCHIVE_GMK := 1
 28 
 29 ifeq (,$(_MAKEBASE_GMK))
 30   $(error You must include MakeBase.gmk prior to including ZipArchive.gmk)
 31 endif
 32 
 33 # Setup make rules for creating a zip archive.
 34 #
 35 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 36 # and the targets generated are listed in a variable by that name.
 37 #
 38 # Remaining parameters are named arguments. These include:
 39 #   SRC
 40 #   ZIP
 41 #   INCLUDES
 42 #   INCLUDE_FILES
 43 #   EXCLUDES
 44 #   EXCLUDE_FILES
 45 #   EXCLUDE_PATTERNS - Patterns with at most one % wildcard matching filenames
 46 #                      and not directories.
 47 #   EXCLUDE_PATTERNS_$dir - Exclude patterns just like above but specific to one
 48 #                           src dir
 49 #   SUFFIXES
 50 #   EXTRA_DEPS
 51 #   ZIP_OPTIONS extra options to pass to zip
 52 SetupZipArchive = $(NamedParamsMacroTemplate)
 53 define SetupZipArchiveBody
 54 
 55   # To avoid running find over too large sets of files, which causes make to crash
 56   # on some configurations (cygwin), use INCLUDES and INCLUDE_FILES to build a set
 57   # of directories to run find in, if available.
 58   ifneq ($$($1_INCLUDES)$$($1_INCLUDE_FILES),)
 59     $1_FIND_LIST := $$(wildcard $$(foreach i,$$($1_SRC), \
 60         $$(addprefix $$i/,$$($1_INCLUDES) $$($1_INCLUDE_FILES))))
 61   else
 62     $1_FIND_LIST := $$($1_SRC)
 63   endif
 64 
 65   # Find all files in the source tree. Follow symlinks in this find since that is
 66   # what zip does.
 67   $1_ALL_SRCS := $$(call not-containing,_the.,$$(call CacheFind,$$($1_FIND_LIST), , -L))
 68 
 69   # Filter on suffixes if set
 70   ifneq ($$($1_SUFFIXES),)
 71     $1_ALL_SRCS := $$(filter $$(addprefix %, $$($1_SUFFIXES)), $$($1_ALL_SRCS))
 72   endif
 73 
 74   ifneq ($$($1_INCLUDES),)
 75     ifneq ($$($1_SUFFIXES),)
 76       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 77           $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$$s$(DQUOTE),$$($1_INCLUDES))))
 78     else
 79       $1_ZIP_INCLUDES := $$(addprefix -i$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_INCLUDES)))
 80     endif
 81   else
 82     ifneq ($$($1_SUFFIXES),)
 83       $1_ZIP_INCLUDES := $$(foreach s,$$($1_SUFFIXES), \
 84           $$(addprefix -i$(SPACE)$(DQUOTE),*$$s$(DQUOTE)))
 85     endif
 86   endif
 87   ifneq ($$($1_INCLUDE_FILES),)
 88     $1_ZIP_INCLUDES += $$(addprefix -i$(SPACE),$$($1_INCLUDE_FILES))
 89   endif
 90   ifneq ($$($1_EXCLUDES),)
 91     $1_ZIP_EXCLUDES := $$(addprefix -x$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_EXCLUDES)))
 92     $1_SRC_EXCLUDES := $$(foreach i,$$($1_SRC),$$(addprefix $$i/,$$(addsuffix /%,$$($1_EXCLUDES))))
 93     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDES),$$($1_ALL_SRCS))
 94   endif
 95   ifneq ($$($1_EXCLUDE_FILES),)
 96     $1_SRC_EXCLUDE_FILES := $$(addprefix %, $$($1_EXCLUDE_FILES)) $$($1_EXCLUDE_FILES)
 97     $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDE_FILES), $$($1_ALL_SRCS))
 98     $$(foreach s, $$($1_SRC), \
 99       $$(eval $1_ZIP_EXCLUDES_$$s += \
100           $$(addprefix -x$$(SPACE), $$(patsubst $$s/%,%, $$($1_EXCLUDE_FILES))) \
101       ) \
102     )
103   endif
104   ifneq ($$($1_EXCLUDE_PATTERNS), )
105     $1_ALL_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERNS), $$($1_ALL_SRCS))
106     $1_ZIP_EXCLUDES += $$(addprefix -x$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS)))
107   endif
108   # Rewrite src dir specific exclude patterns to zip excludes
109   $$(foreach s, $$($1_SRC), \
110     $$(if $$($1_EXCLUDE_PATTERNS_$$s), \
111       $$(eval $1_ZIP_EXCLUDES_$$s += \
112           $$(addprefix -x$$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS_$$s))) \
113       ) \
114     ) \
115   )
116 
117   # Use a slightly shorter name for logging, but with enough path to identify this zip.
118   $1_NAME:=$$(subst $$(OUTPUTDIR)/,,$$($1_ZIP))
119 
120   # Now $1_ALL_SRCS should contain all sources that are going to be put into the zip.
121   # I.e. the zip -i and -x options should match the filtering done in the makefile.
122   # Explicitly excluded files can be given with absolute path. The patsubst solution
123   # isn&#39;t perfect but the likelyhood of an absolute path to match something in a src
124   # dir is very small.
125   # If zip has nothing to do, it returns 12 and would fail the build. Check for 12
126   # and only fail if it&#39;s not.
127   $$($1_ZIP) : $$($1_ALL_SRCS) $$($1_EXTRA_DEPS)
128 	$$(call LogWarn, Updating $$($1_NAME))
129 	$$(call MakeTargetDir)
130 	$$(foreach s,$$($1_SRC), $$(call ExecuteWithLog, \
131 	    $$(SUPPORT_OUTPUTDIR)/zip/$$(patsubst $$(OUTPUTDIR)/%,%, $$@), \
132 	    (cd $$s &amp;&amp; $(ZIPEXE) -qru $$($1_ZIP_OPTIONS) $$@ . \
133 	        $$($1_ZIP_INCLUDES) $$($1_ZIP_EXCLUDES) -x \*_the.\* \
134 	        $$($1_ZIP_EXCLUDES_$$s) \
135 	        || test &quot;$$$$?&quot; = &quot;12&quot; \
136 	    ))$$(NEWLINE) \
137 	) true \
138 	$(TOUCH) $$@
139 
140   # Add zip to target list
141   $1 += $$($1_ZIP)
142 endef
143 
144 endif # _ZIP_ARCHIVE_GMK
    </pre>
  </body>
</html>