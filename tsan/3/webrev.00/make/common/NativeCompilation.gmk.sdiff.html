<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/common/NativeCompilation.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="Modules.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="ProcessMarkdown.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/common/NativeCompilation.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 #
<span class="line-modified">   2 # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4 #
   5 # This code is free software; you can redistribute it and/or modify it
   6 # under the terms of the GNU General Public License version 2 only, as
   7 # published by the Free Software Foundation.  Oracle designates this
   8 # particular file as subject to the &quot;Classpath&quot; exception as provided
   9 # by Oracle in the LICENSE file that accompanied this code.
  10 #
  11 # This code is distributed in the hope that it will be useful, but WITHOUT
  12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14 # version 2 for more details (a copy is included in the LICENSE file that
  15 # accompanied this code).
  16 #
  17 # You should have received a copy of the GNU General Public License version
  18 # 2 along with this work; if not, write to the Free Software Foundation,
  19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20 #
  21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22 # or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 214 # Remaining parameters are named arguments:
 215 #   FILE - The full path of the source file to compiler
 216 #   BASE - The name of the rule for the entire binary to build ($1)
 217 #   DISABLE_THIS_FILE_DEFINE - Set to true to disable the THIS_FILE define.
 218 #
 219 SetupCompileNativeFile = $(NamedParamsMacroTemplate)
 220 define SetupCompileNativeFileBody
 221   $1_FILENAME := $$(notdir $$($1_FILE))
 222 
 223   # The target file to be generated.
 224   $1_OBJ := $$($$($1_BASE)_OBJECT_DIR)/$$(call replace_with_obj_extension, \
 225       $$($1_FILENAME))
 226 
 227   # Generate the corresponding compile_commands.json fragment.
 228   $1_OBJ_JSON = $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 229       $$(OUTPUTDIR)/,,$$($1_OBJ))).json
 230   $$($1_BASE)_ALL_OBJS_JSON += $$($1_OBJ_JSON)
 231 
 232   # Only continue if this object file hasn&#39;t been processed already. This lets
 233   # the first found source file override any other with the same name.
<span class="line-modified"> 234   ifeq ($$(findstring $$($1_OBJ), $$($$($1_BASE)_OBJS_SO_FAR)), )</span>
<span class="line-modified"> 235     $$($1_BASE)_OBJS_SO_FAR += $$($1_OBJ)</span>
 236     # This is the definite source file to use for $1_FILENAME.
 237     $1_SRC_FILE := $$($1_FILE)
 238 
<span class="line-modified"> 239     ifneq ($$($1_DISABLE_THIS_FILE_DEFINE), true)</span>
<span class="line-modified"> 240       $1_THIS_FILE = -DTHIS_FILE=&#39;&quot;$$($1_FILENAME)&quot;&#39;</span>


 241     endif
 242 
 243     ifeq ($$($1_OPTIMIZATION), )
 244       $1_OPT_CFLAGS := $$($$($1_BASE)_OPT_CFLAGS)
 245       $1_OPT_CXXFLAGS := $$($$($1_BASE)_OPT_CXXFLAGS)
 246     else
 247       ifeq ($$($1_OPTIMIZATION), NONE)
 248         $1_OPT_CFLAGS := $(C_O_FLAG_NONE)
 249         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NONE)
 250       else ifeq ($$($1_OPTIMIZATION), LOW)
 251         $1_OPT_CFLAGS := $(C_O_FLAG_NORM)
 252         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NORM)
 253       else ifeq ($$($1_OPTIMIZATION), HIGH)
 254         $1_OPT_CFLAGS := $(C_O_FLAG_HI)
 255         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HI)
 256       else ifeq ($$($1_OPTIMIZATION), HIGHEST)
 257         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST)
 258         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST)
 259       else ifeq ($$($1_OPTIMIZATION), HIGHEST_JVM)
 260         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST_JVM)
</pre>
<hr />
<pre>
 291           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c
 292       $1_COMPILER := $$($$($1_BASE)_CC)
 293       $1_DEP_FLAG := $(C_FLAG_DEPS)
 294     else ifneq ($$(filter %.s %.S, $$($1_FILENAME)), )
 295       # Compile as assembler file
 296       $1_FLAGS := $$($1_BASE_ASFLAGS)
 297       $1_COMPILER := $(AS)
 298       $1_DEP_FLAG :=
 299     else ifneq ($$(filter %.cpp %.cc %.mm, $$($1_FILENAME)), )
 300       # Compile as a C++ or Objective-C++ file
 301       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CXXFLAGS) \
 302           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) $$($1_THIS_FILE) -c
 303       $1_COMPILER := $$($$($1_BASE)_CXX)
 304       $1_DEP_FLAG := $(CXX_FLAG_DEPS)
 305     else
 306       $$(error Internal error in NativeCompilation.gmk: no compiler for file $$($1_FILENAME))
 307     endif
 308 
 309     ifeq ($$(filter %.s %.S, $$($1_FILENAME)), )
 310       # And this is the dependency file for this obj file.
<span class="line-modified"> 311       $1_DEP := $$(patsubst %$(OBJ_SUFFIX),%.d,$$($1_OBJ))</span>
 312       # The dependency target file lists all dependencies as empty targets to
 313       # avoid make error &quot;No rule to make target&quot; for removed files
<span class="line-modified"> 314       $1_DEP_TARGETS := $$(patsubst %$(OBJ_SUFFIX),%.d.targets,$$($1_OBJ))</span>
<span class="line-modified"> 315 </span>
<span class="line-modified"> 316       # Include previously generated dependency information. (if it exists)</span>
<span class="line-modified"> 317       -include $$($1_DEP)</span>
<span class="line-modified"> 318       -include $$($1_DEP_TARGETS)</span>




 319     endif
 320 
 321     ifneq ($$(strip $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)), )
 322       $1_VARDEPS := $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)
 323       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, $$($1_OBJ).vardeps)
 324     endif
 325 
 326     $1_OBJ_DEPS := $$($1_SRC_FILE) $$($$($1_BASE)_COMPILE_VARDEPS_FILE) \
 327         $$($$($1_BASE)_EXTRA_DEPS) $$($1_VARDEPS_FILE)
 328     $1_COMPILE_OPTIONS := $$($1_FLAGS) $(CC_OUT_OPTION)$$($1_OBJ) $$($1_SRC_FILE)
 329 
 330     $$($1_OBJ_JSON): $$($1_OBJ_DEPS)
 331 	$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$($1_SRC_FILE), \
 332 	    $$($1_COMPILER) $$($1_COMPILE_OPTIONS))
 333 
 334     $$($1_OBJ): $$($1_OBJ_DEPS) | $$($$($1_BASE)_BUILD_INFO)
 335 	$$(call LogInfo, Compiling $$($1_FILENAME) (for $$($$($1_BASE)_BASENAME)))
 336 	$$(call MakeDir, $$(@D))
 337         ifneq ($(TOOLCHAIN_TYPE), microsoft)
 338           ifeq ($(TOOLCHAIN_TYPE)$$(filter %.s, $$($1_FILENAME)), solstudio)
 339             # The Solaris studio compiler doesn&#39;t output the full path to the
 340             # object file in the generated deps files. Fixing it with sed. If
 341             # compiling assembly, don&#39;t try this.
 342 	    $$(call ExecuteWithLog, $$@, \
<span class="line-modified"> 343 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEP).tmp $$($1_COMPILE_OPTIONS))</span>
<span class="line-modified"> 344 	    $(SED) &#39;s|^$$(@F):|$$@:|&#39; $$($1_DEP).tmp &gt; $$($1_DEP)</span>
 345           else
 346 	    $$(call ExecuteWithLog, $$@, \
<span class="line-modified"> 347 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEP) $$($1_COMPILE_OPTIONS))</span>
 348           endif
 349           # Create a dependency target file from the dependency file.
 350           # Solution suggested by http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/
<span class="line-modified"> 351           ifneq ($$($1_DEP), )</span>
<span class="line-modified"> 352 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEP) &gt; $$($1_DEP_TARGETS)</span>
 353           endif
 354         else
 355           # The Visual Studio compiler lacks a feature for generating make
 356           # dependencies, but by setting -showIncludes, all included files are
 357           # printed. These are filtered out and parsed into make dependences.
 358           #
 359           # Keep as much as possible on one execution line for best performance
 360           # on Windows. No need to save exit code from compilation since
 361           # pipefail is always active on Windows.
 362 	  $$(call ExecuteWithLog, $$@, \
 363 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS)) \
 364 	      | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 365 	          -e &quot;^$$($1_FILENAME)$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
<span class="line-modified"> 366 	  $(ECHO) $$@: \\ &gt; $$($1_DEP) ; \</span>
 367 	  $(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_OBJ).log \
<span class="line-modified"> 368 	      | $(SORT) -u &gt;&gt; $$($1_DEP) ; \</span>
<span class="line-modified"> 369 	  $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEP) &gt; $$($1_DEP_TARGETS)</span>

 370         endif
 371   endif
 372 endef
 373 
 374 # Setup make rules for creating a native binary (a shared library or an
 375 # executable).
 376 #
 377 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 378 # and the targets generated are listed in a variable by that name.
 379 #
 380 # Remaining parameters are named arguments. These include:
 381 #   NAME The base name for the resulting binary, excluding decorations (like *.exe)
 382 #   TYPE Type of binary (EXECUTABLE, LIBRARY or STATIC_LIBRARY). Default is LIBRARY.
 383 #   SUFFIX Override the default suffix for the output file
 384 #   TOOLCHAIN Name of toolchain setup to use. Defaults to TOOLCHAIN_DEFAULT.
 385 #   SRC one or more directory roots to scan for C/C++ files.
 386 #   CFLAGS the compiler flags to be used, used both for C and C++.
 387 #   CXXFLAGS the compiler flags to be used for c++, if set overrides CFLAGS.
 388 #   LDFLAGS the linker flags to be used, used both for C and C++.
 389 #   LIBS the libraries to link to
 390 #   ARFLAGS the archiver flags to be used
 391 #   OBJECT_DIR the directory where we store the object files
 392 #   OUTPUT_DIR the directory where the resulting binary is put

 393 #   INCLUDES only pick source from these directories
 394 #   EXCLUDES do not pick source from these directories
 395 #   INCLUDE_FILES only compile exactly these files!
 396 #   EXCLUDE_FILES with these names
 397 #   EXCLUDE_PATTERN exclude files matching any of these substrings
 398 #   EXTRA_FILES List of extra files not in any of the SRC dirs
 399 #   EXTRA_OBJECT_FILES List of extra object files to include when linking
 400 #   EXTRA_DEPS List of extra dependencies to be added to each compiled file
 401 #   VERSIONINFO_RESOURCE Input file for RC. Setting this implies that RC will be run
 402 #   RC_FLAGS flags for RC.
 403 #   EMBED_MANIFEST if true, embed manifest on Windows.
 404 #   MAPFILE mapfile
 405 #   REORDER reorder file
 406 #   USE_MAPFILE_FOR_SYMBOLS if true and this is a STATIC_BUILD, just copy the
 407 #       mapfile for the output symbols file
 408 #   CC the compiler to use, default is $(CC)
 409 #   LD the linker to use, default is $(LD)
 410 #   OPTIMIZATION sets optimization level to NONE, LOW, HIGH, HIGHEST, HIGHEST_JVM, SIZE
 411 #   DISABLED_WARNINGS_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 412 #   DISABLED_WARNINGS_C_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 413 #       when compiling C code
 414 #   DISABLED_WARNINGS_CXX_&lt;toolchain&gt; Disable the given warnings for the specified
 415 #       toolchain when compiling C++ code
 416 #   STRIP_SYMBOLS Set to false to override global strip policy and always leave
 417 #       symbols in the binary, if the toolchain allows for it
 418 #   DEBUG_SYMBOLS Set to false to disable generation of debug symbols
 419 #   COPY_DEBUG_SYMBOLS Set to false to override global setting of debug symbol copying
 420 #   ZIP_EXTERNAL_DEBUG_SYMBOLS Set to false to override global setting of debug symbol
 421 #       zipping
 422 #   STRIPFLAGS Optionally change the flags given to the strip command
 423 #   PRECOMPILED_HEADER Header file to use as precompiled header
 424 #   PRECOMPILED_HEADER_EXCLUDE List of source files that should not use PCH

 425 #
 426 # After being called, some variables are exported from this macro, all prefixed
 427 # with parameter 1 followed by a &#39;_&#39;:
 428 #   TARGET The library or executable created by the macro
 429 #   TARGET_DEPS All prerequisites for the target calculated by the macro
 430 #   ALL_OBJS All object files
 431 #   IMPORT_LIBRARY The import library created for a shared library on Windows
 432 SetupNativeCompilation = $(NamedParamsMacroTemplate)
 433 define SetupNativeCompilationBody
 434 
 435   # If type is unspecified, default to LIBRARY
 436   ifeq ($$($1_TYPE), )
 437     $1_TYPE := LIBRARY
 438   endif
 439 
 440   # If we&#39;re doing a static build and producing a library
 441   # force it to be a static library and remove the -l libraries
 442   ifeq ($(STATIC_BUILD), true)
 443     ifeq ($$($1_TYPE), LIBRARY)
 444       $1_TYPE := STATIC_LIBRARY
 445     endif
 446   endif
 447 






















 448   ifeq ($$($1_TYPE), EXECUTABLE)
 449     $1_PREFIX :=
 450     ifeq ($$($1_SUFFIX), )
 451       $1_SUFFIX := $(EXE_SUFFIX)
 452     endif
 453   else
 454     $1_PREFIX := $(LIBRARY_PREFIX)
 455     ifeq ($$($1_TYPE), LIBRARY)
 456       ifeq ($$($1_SUFFIX), )
 457         $1_SUFFIX := $(SHARED_LIBRARY_SUFFIX)
 458       endif
 459     else ifeq ($$($1_TYPE), STATIC_LIBRARY)
 460       ifeq ($$($1_SUFFIX), )
 461         $1_SUFFIX := $(STATIC_LIBRARY_SUFFIX)
 462       endif
 463     endif
 464   endif
 465 
 466   ifneq ($$($1_NAME), $(basename $$($1_NAME)))
 467     $$(error NAME must not contain any directory path in $1)
</pre>
<hr />
<pre>
 469   ifneq ($(findstring $$($1_SUFFIX), $$($1_NAME)), )
 470     $$(error NAME should be specified without suffix: $$($1_SUFFIX) in $1)
 471   endif
 472   ifneq ($(findstring $$($1_PREFIX), $$($1_NAME)), )
 473     $$(error NAME should be specified without prefix: $$($1_PREFIX) in $1)
 474   endif
 475   ifeq ($$($1_OUTPUT_DIR), )
 476     $$(error OUTPUT_DIR is missing in $1)
 477   endif
 478   ifneq ($$($1_MANIFEST), )
 479     ifeq ($$($1_MANIFEST_VERSION), )
 480       $$(error If MANIFEST is provided, then MANIFEST_VERSION is required in $1)
 481     endif
 482   endif
 483 
 484   $1_BASENAME := $$($1_PREFIX)$$($1_NAME)$$($1_SUFFIX)
 485   $1_TARGET := $$($1_OUTPUT_DIR)/$$($1_BASENAME)
 486   $1_NOSUFFIX := $$($1_PREFIX)$$($1_NAME)
 487   $1_SAFE_NAME := $$(strip $$(subst /,_, $1))
 488 



 489   # Setup the toolchain to be used
 490   $$(call SetIfEmpty, $1_TOOLCHAIN, TOOLCHAIN_DEFAULT)
 491   $$(call SetIfEmpty, $1_CC, $$($$($1_TOOLCHAIN)_CC))
 492   $$(call SetIfEmpty, $1_CXX, $$($$($1_TOOLCHAIN)_CXX))
 493   $$(call SetIfEmpty, $1_LD, $$($$($1_TOOLCHAIN)_LD))
 494   $$(call SetIfEmpty, $1_AR, $$($$($1_TOOLCHAIN)_AR))
 495   $$(call SetIfEmpty, $1_AS, $$($$($1_TOOLCHAIN)_AS))
 496   $$(call SetIfEmpty, $1_MT, $$($$($1_TOOLCHAIN)_MT))
 497   $$(call SetIfEmpty, $1_RC, $$($$($1_TOOLCHAIN)_RC))
 498   $$(call SetIfEmpty, $1_OBJCOPY, $$($$($1_TOOLCHAIN)_OBJCOPY))
 499   $$(call SetIfEmpty, $1_STRIP, $$($$($1_TOOLCHAIN)_STRIP))
 500   $$(call SetIfEmpty, $1_SYSROOT_CFLAGS, $$($$($1_TOOLCHAIN)_SYSROOT_CFLAGS))
 501   $$(call SetIfEmpty, $1_SYSROOT_LDFLAGS, $$($$($1_TOOLCHAIN)_SYSROOT_LDFLAGS))
 502 
<span class="line-removed"> 503   # Make sure the dirs exist.</span>
<span class="line-removed"> 504   $$(call MakeDir, $$($1_OBJECT_DIR) $$($1_OUTPUT_DIR))</span>
 505   $$(foreach d, $$($1_SRC), $$(if $$(wildcard $$d), , \
 506       $$(error SRC specified to SetupNativeCompilation $1 contains missing directory $$d)))
 507 
<span class="line-modified"> 508   $1_SRCS_RAW = $$(call CacheFind, $$($1_SRC))</span>
 509   # Order src files according to the order of the src dirs
 510   $1_SRCS := $$(foreach d, $$($1_SRC), $$(filter $$d%, $$($1_SRCS_RAW)))
 511   $1_SRCS := $$(filter $$(NATIVE_SOURCE_EXTENSIONS), $$($1_SRCS))
 512   # Extract the C/C++ files.
 513   ifneq ($$($1_EXCLUDE_PATTERNS), )
 514     # We must not match the exclude pattern against the src root(s).
 515     $1_SRCS_WITHOUT_ROOTS := $$($1_SRCS)
 516     $$(foreach i, $$($1_SRC), $$(eval $1_SRCS_WITHOUT_ROOTS := $$(patsubst \
 517         $$i/%,%, $$($1_SRCS_WITHOUT_ROOTS))))
 518     $1_ALL_EXCLUDE_FILES :=  $$(call containing, $$($1_EXCLUDE_PATTERNS), \
 519         $$($1_SRCS_WITHOUT_ROOTS))
 520   endif
 521   ifneq ($$($1_EXCLUDE_FILES), )
 522     $1_ALL_EXCLUDE_FILES += $$($1_EXCLUDE_FILES)
 523   endif
 524   ifneq ($$($1_ALL_EXCLUDE_FILES), )
 525     $1_EXCLUDE_FILES_PAT := $$($1_ALL_EXCLUDE_FILES) \
 526         $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$($1_ALL_EXCLUDE_FILES)))
 527     $1_EXCLUDE_FILES_PAT := $$(addprefix %, $$($1_EXCLUDE_FILES_PAT))
 528     $1_SRCS := $$(filter-out $$($1_EXCLUDE_FILES_PAT), $$($1_SRCS))
</pre>
<hr />
<pre>
 564   endif
 565   # Sort to remove dupliates and provide a reproducable order on the input files to the linker.
 566   $1_ALL_OBJS := $$(sort $$($1_EXPECTED_OBJS) $$($1_EXTRA_OBJECT_FILES))
 567 
 568   # Pickup extra OPENJDK_TARGET_OS_TYPE, OPENJDK_TARGET_OS, and/or OPENJDK_TARGET_OS plus
 569   # OPENJDK_TARGET_CPU pair dependent variables for CFLAGS.
 570   $1_EXTRA_CFLAGS := $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_CFLAGS_$(OPENJDK_TARGET_OS)) \
 571       $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU))
 572   ifneq ($(DEBUG_LEVEL), release)
 573     # Pickup extra debug dependent variables for CFLAGS
 574     $1_EXTRA_CFLAGS += $$($1_CFLAGS_debug)
 575     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)_debug)
 576     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_debug)
 577     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU)_debug)
 578   else
 579     $1_EXTRA_CFLAGS += $$($1_CFLAGS_release)
 580     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)_release)
 581     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_release)
 582     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU)_release)
 583   endif



 584 
 585   # Pickup extra OPENJDK_TARGET_OS_TYPE and/or OPENJDK_TARGET_OS dependent variables for CXXFLAGS.
 586   $1_EXTRA_CXXFLAGS := $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS))
 587   ifneq ($(DEBUG_LEVEL), release)
 588     # Pickup extra debug dependent variables for CXXFLAGS
 589     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_debug)
 590     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)_debug)
 591     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS)_debug)
 592   else
 593     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_release)
 594     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)_release)
 595     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS)_release)
 596   endif



 597 
 598   # If no C++ flags are explicitly set, default to using the C flags.
 599   # After that, we can set additional C++ flags that should not interfere
 600   # with the mechanism for copying the C flags by default.
 601   ifeq ($$($1_CXXFLAGS), )
 602     $1_CXXFLAGS := $$($1_CFLAGS)
 603   endif
 604   ifeq ($$(strip $$($1_EXTRA_CXXFLAGS)), )
 605     $1_EXTRA_CXXFLAGS := $$($1_EXTRA_CFLAGS)
 606   endif
 607 
<span class="line-modified"> 608   ifeq ($(COMPILE_WITH_DEBUG_SYMBOLS), true)</span>
 609     $1_EXTRA_CFLAGS += $$(CFLAGS_DEBUG_SYMBOLS)
 610     $1_EXTRA_CXXFLAGS += $$(CFLAGS_DEBUG_SYMBOLS)
 611     $1_EXTRA_ASFLAGS += $$(ASFLAGS_DEBUG_SYMBOLS)
 612   endif
 613 
 614   ifneq ($$($1_REORDER), )
 615     $1_EXTRA_CFLAGS += $$(C_FLAG_REORDER)
 616     $1_EXTRA_CXXFLAGS += $$(C_FLAG_REORDER)
 617   endif
 618 
 619   # Pass the library name for static JNI library naming
 620   ifeq ($$($1_TYPE), STATIC_LIBRARY)
 621     $1_EXTRA_CFLAGS += -DLIBRARY_NAME=$$($1_NAME)
 622     $1_EXTRA_CXXFLAGS += -DLIBRARY_NAME=$$($1_NAME)
 623   endif
 624 
 625   # Pick up disabled warnings, if possible on this platform.
 626   ifneq ($(DISABLE_WARNING_PREFIX), )
 627     $1_EXTRA_CFLAGS += $$(addprefix $(DISABLE_WARNING_PREFIX), \
 628         $$(DISABLED_WARNINGS) \
</pre>
<hr />
<pre>
 679   # Track variable changes for all variables that affect the compilation command
 680   # lines for all object files in this setup. This includes at least all the
 681   # variables used in the call to add_native_source below.
 682   $1_COMPILE_VARDEPS := $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 683       $$($1_CXXFLAGS) $$($1_EXTRA_CXXFLAGS) $$($1_OPT_CFLAGS) $$($1_OPT_CXXFLAGS) \
 684       $$($1_CC) $$($1_CXX) $$($1_AS) $$($1_ASFLAGS)
 685   $1_COMPILE_VARDEPS_FILE := $$(call DependOnVariable, $1_COMPILE_VARDEPS, \
 686       $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).comp.vardeps)
 687 
 688   ifneq ($$($1_PRECOMPILED_HEADER), )
 689     ifeq ($(USE_PRECOMPILED_HEADER), true)
 690       ifeq ($(TOOLCHAIN_TYPE), microsoft)
 691         $1_PCH_FILE := $$($1_OBJECT_DIR)/$1.pch
 692         $1_GENERATED_PCH_SRC := $$($1_OBJECT_DIR)/$1_pch.cpp
 693         $1_GENERATED_PCH_OBJ := $$($1_OBJECT_DIR)/$1_pch.obj
 694 
 695         $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$($1_GENERATED_PCH_SRC)), \
 696             FILE := $$($1_GENERATED_PCH_SRC), \
 697             BASE := $1, \
 698             EXTRA_CXXFLAGS := -Fp$$($1_PCH_FILE) -Yc$$(notdir $$($1_PRECOMPILED_HEADER)), \
<span class="line-modified"> 699             DISABLE_THIS_FILE_DEFINE := true, \</span>
 700         ))
 701 
 702         $1_USE_PCH_FLAGS := \
 703             -Fp$$($1_PCH_FILE) -Yu$$(notdir $$($1_PRECOMPILED_HEADER))
 704 
 705         $$($1_ALL_OBJS): $$($1_GENERATED_PCH_OBJ)
 706 
 707         # Explicitly add the pch obj file first to ease comparing to old
 708         # hotspot build.
 709         $1_ALL_OBJS := $$($1_GENERATED_PCH_OBJ) $$($1_ALL_OBJS)
 710 
 711         $$($1_GENERATED_PCH_SRC):
 712 		$(ECHO) &quot;#include \&quot;$$(notdir $$($1_PRECOMPILED_HEADER))\&quot;&quot; &gt; $$@
 713 
 714       else ifneq ($(findstring $(TOOLCHAIN_TYPE), gcc clang), )
 715         ifeq ($(TOOLCHAIN_TYPE), gcc)
 716           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).gch
 717           $1_USE_PCH_FLAGS := -I$$($1_OBJECT_DIR)/precompiled
 718         else ifeq ($(TOOLCHAIN_TYPE), clang)
 719           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).pch
 720           $1_USE_PCH_FLAGS := -include-pch $$($1_PCH_FILE)
 721         endif
<span class="line-modified"> 722         $1_PCH_DEP := $$($1_PCH_FILE).d</span>
<span class="line-modified"> 723         $1_PCH_DEP_TARGETS := $$($1_PCH_FILE).d.targets</span>
 724 
<span class="line-modified"> 725         -include $$($1_PCH_DEP)</span>
<span class="line-modified"> 726         -include $$($1_PCH_DEP_TARGETS)</span>
 727 
 728         $1_PCH_COMMAND := $$($1_CC) $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
<span class="line-modified"> 729             $$($1_OPT_CFLAGS) -x c++-header -c $(C_FLAG_DEPS) $$($1_PCH_DEP)</span>
 730 
 731         $$($1_PCH_FILE): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 732 		$$(call LogInfo, Generating precompiled header)
 733 		$$(call MakeDir, $$(@D))
 734 		$$(call ExecuteWithLog, $$@, $$($1_PCH_COMMAND) $$&lt; -o $$@)
<span class="line-modified"> 735 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_PCH_DEP) &gt; $$($1_PCH_DEP_TARGETS)</span>

 736 
 737         $$($1_ALL_OBJS): $$($1_PCH_FILE)
 738 
 739         # Generate the corresponding compile_commands.json fragment.
 740         $1_PCH_FILE_JSON := $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 741             $$(OUTPUTDIR)/,,$$($1_PCH_FILE))).json
 742         $1_ALL_OBJS_JSON += $$($1_PCH_FILE_JSON)
 743 
 744         $$($1_PCH_FILE_JSON): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 745 		$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$&lt;, \
 746 		    $$($1_PCH_COMMAND) $$&lt; -o $$($1_PCH_FILE))
 747       endif
 748     endif
 749   endif
 750 
 751   # Now call SetupCompileNativeFile for each source file we are going to compile.
 752   $$(foreach file, $$($1_SRCS), \
 753       $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$(file)),\
 754           FILE := $$(file), \
 755           BASE := $1, \
 756       )) \
 757   )
 758 
 759   # Setup rule for printing progress info when compiling source files.
 760   # This is a rough heuristic and may not always print accurate information.
 761   $$($1_BUILD_INFO): $$($1_SRCS) $$($1_COMPILE_VARDEPS_FILE)
 762         ifeq ($$(wildcard $$($1_TARGET)), )
<span class="line-modified"> 763 	  $(ECHO) &#39;Creating $$(subst $$(OUTPUTDIR)/,,$$($1_TARGET)) from $$(words \</span>
<span class="line-modified"> 764 	      $$(filter-out %.vardeps, $$?)) file(s)&#39;</span>
 765         else
<span class="line-modified"> 766 	  $(ECHO) $$(strip &#39;Updating $$(subst $$(OUTPUTDIR)/,,$$($1_TARGET))&#39; \</span>
 767 	      $$(if $$(filter-out %.vardeps, $$?), \
<span class="line-modified"> 768 	        &#39;due to $$(words $$(filter-out %.vardeps, $$?)) file(s)&#39;, \</span>
<span class="line-modified"> 769 	      $$(if $$(filter %.vardeps, $$?), &#39;due to makefile changes&#39;)))</span>
 770         endif
 771 	$(TOUCH) $$@
 772 
 773   # On windows we need to create a resource file
 774   ifeq ($(call isTargetOs, windows), true)
 775     ifneq ($$($1_VERSIONINFO_RESOURCE), )
 776       $1_RES := $$($1_OBJECT_DIR)/$$($1_BASENAME).res
<span class="line-modified"> 777       $1_RES_DEP := $$($1_RES).d</span>
<span class="line-modified"> 778       $1_RES_DEP_TARGETS := $$($1_RES).d.targets</span>
<span class="line-modified"> 779       -include $$($1_RES_DEP)</span>
<span class="line-modified"> 780       -include $$($1_RES_DEP_TARGETS)</span>
 781 
 782       $1_RES_VARDEPS := $$($1_RC) $$($1_RC_FLAGS)
 783       $1_RES_VARDEPS_FILE := $$(call DependOnVariable, $1_RES_VARDEPS, \
 784           $$($1_RES).vardeps)
 785 
 786       $$($1_RES): $$($1_VERSIONINFO_RESOURCE) $$($1_RES_VARDEPS_FILE)
 787 		$$(call LogInfo, Compiling resource $$(notdir $$($1_VERSIONINFO_RESOURCE)) (for $$($1_BASENAME)))
 788 		$$(call MakeDir, $$(@D) $$($1_OBJECT_DIR))
 789 		$$(call ExecuteWithLog, $$@, \
 790 		    $$($1_RC) $$($1_RC_FLAGS) $$($1_SYSROOT_CFLAGS) $(CC_OUT_OPTION)$$@ \
 791 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 )
 792                 # Windows RC compiler does not support -showIncludes, so we mis-use CL
 793                 # for this. Filter out RC specific arguments that are unknown to CL.
 794                 # For some unknown reason, in this case CL actually outputs the show
 795                 # includes to stderr so need to redirect it to hide the output from the
 796                 # main log.
<span class="line-modified"> 797 		$$(call ExecuteWithLog, $$($1_RES_DEP).obj, \</span>
 798 		    $$($1_CC) $$(filter-out -l%, $$($1_RC_FLAGS)) \
 799 		        $$($1_SYSROOT_CFLAGS) -showIncludes -nologo -TC \
<span class="line-modified"> 800 		        $(CC_OUT_OPTION)$$($1_RES_DEP).obj -P -Fi$$($1_RES_DEP).pp \</span>
 801 		        $$($1_VERSIONINFO_RESOURCE)) 2&gt;&amp;1 \
 802 		    | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 803 		        -e &quot;^$$(notdir $$($1_VERSIONINFO_RESOURCE))$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
<span class="line-modified"> 804 		$(ECHO) $$($1_RES): \\ &gt; $$($1_RES_DEP) ; \</span>
<span class="line-modified"> 805 		$(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_RES_DEP).obj.log &gt;&gt; $$($1_RES_DEP) ; \</span>
<span class="line-modified"> 806 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_RES_DEP) &gt; $$($1_RES_DEP_TARGETS)</span>



 807     endif
 808   endif
 809 




























 810   ifneq ($(DISABLE_MAPFILES), true)
 811     $1_REAL_MAPFILE := $$($1_MAPFILE)
 812     ifeq ($(call isTargetOs, windows), false)
 813       ifneq ($$($1_REORDER), )
 814         $1_REAL_MAPFILE := $$($1_OBJECT_DIR)/mapfile
 815 
 816         $$($1_REAL_MAPFILE) : $$($1_MAPFILE) $$($1_REORDER)
 817 		$$(call MakeDir, $$(@D))
 818 		$$(CP) $$($1_MAPFILE) $$@.tmp
 819 		$$(SED) -e &#39;s=OUTPUTDIR=$$($1_OBJECT_DIR)=&#39; $$($1_REORDER) &gt;&gt; $$@.tmp
 820 		$$(MV) $$@.tmp $$@
 821       endif
 822     endif
 823   endif
 824 
 825   # Pickup extra OPENJDK_TARGET_OS_TYPE and/or OPENJDK_TARGET_OS dependent variables
 826   # for LDFLAGS and LIBS
 827   $1_EXTRA_LDFLAGS += $$($1_LDFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_LDFLAGS_$(OPENJDK_TARGET_OS))
 828   $1_EXTRA_LIBS += $$($1_LIBS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_LIBS_$(OPENJDK_TARGET_OS))
 829   ifneq ($$($1_REAL_MAPFILE), )
 830     $1_EXTRA_LDFLAGS += $(call SET_SHARED_LIBRARY_MAPFILE,$$($1_REAL_MAPFILE))
 831   endif
 832 
<span class="line-removed"> 833   # Need to make sure TARGET is first on list</span>
<span class="line-removed"> 834   $1 := $$($1_TARGET)</span>
<span class="line-removed"> 835 </span>
 836   ifneq ($$($1_COPY_DEBUG_SYMBOLS), false)
 837     $1_COPY_DEBUG_SYMBOLS := $(COPY_DEBUG_SYMBOLS)
 838   endif
 839 
 840   ifneq ($$($1_ZIP_EXTERNAL_DEBUG_SYMBOLS), false)
 841     $1_ZIP_EXTERNAL_DEBUG_SYMBOLS := $(ZIP_EXTERNAL_DEBUG_SYMBOLS)
 842   endif
 843 
 844   ifeq ($$($1_COPY_DEBUG_SYMBOLS), true)
 845     ifneq ($$($1_DEBUG_SYMBOLS), false)

 846       # Only copy debug symbols for dynamic libraries and programs.
 847       ifneq ($$($1_TYPE), STATIC_LIBRARY)
 848         # Generate debuginfo files.
 849         ifeq ($(call isTargetOs, windows), true)
<span class="line-modified"> 850           $1_EXTRA_LDFLAGS += -debug &quot;-pdb:$$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).pdb&quot; \</span>
<span class="line-modified"> 851               &quot;-map:$$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).map&quot;</span>
<span class="line-modified"> 852           $1_DEBUGINFO_FILES := $$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).pdb \</span>
<span class="line-modified"> 853               $$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).map</span>
 854 
 855         else ifeq ($(call isTargetOs, linux solaris), true)
<span class="line-modified"> 856           $1_DEBUGINFO_FILES := $$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).debuginfo</span>
 857           # Setup the command line creating debuginfo files, to be run after linking.
 858           # It cannot be run separately since it updates the original target file
 859           $1_CREATE_DEBUGINFO_CMDS := \
 860               $$($1_OBJCOPY) --only-keep-debug $$($1_TARGET) $$($1_DEBUGINFO_FILES) $$(NEWLINE) \
<span class="line-modified"> 861               $(CD) $$($1_OUTPUT_DIR) &amp;&amp; \</span>
 862                   $$($1_OBJCOPY) --add-gnu-debuglink=$$($1_DEBUGINFO_FILES) $$($1_TARGET)
 863 
 864         else ifeq ($(call isTargetOs, macosx), true)
 865           $1_DEBUGINFO_FILES := \
<span class="line-modified"> 866               $$($1_OUTPUT_DIR)/$$($1_BASENAME).dSYM/Contents/Info.plist \</span>
<span class="line-modified"> 867               $$($1_OUTPUT_DIR)/$$($1_BASENAME).dSYM/Contents/Resources/DWARF/$$($1_BASENAME)</span>
 868           $1_CREATE_DEBUGINFO_CMDS := \
<span class="line-modified"> 869               $(DSYMUTIL) --out $$($1_OUTPUT_DIR)/$$($1_BASENAME).dSYM $$($1_TARGET)</span>
 870         endif
 871 
 872         # Since the link rule creates more than one file that we want to track,
 873         # we have to use some tricks to get make to cooperate. To properly
 874         # trigger downstream dependants of $$($1_DEBUGINFO_FILES), we must have
 875         # a recipe in the rule below. To avoid rerunning the recipe every time
 876         # have it touch the target. If a debuginfo file is deleted by something
 877         # external, explicitly delete the TARGET to trigger a rebuild of both.
 878         ifneq ($$(wildcard $$($1_DEBUGINFO_FILES)), $$($1_DEBUGINFO_FILES))
 879           $$(call LogDebug, Deleting $$($1_BASENAME) because debuginfo files are missing)
 880           $$(shell $(RM) $$($1_TARGET))
 881         endif
 882         $$($1_DEBUGINFO_FILES): $$($1_TARGET)
 883 		$$(if $$(CORRECT_FUNCTION_IN_RECIPE_EVALUATION), \
 884 		  $$(if $$(wildcard $$@), , $$(error $$@ was not created for $$&lt;)) \
 885 		)
 886 		$(TOUCH) $$@
 887 
 888         $1 += $$($1_DEBUGINFO_FILES)
 889 
 890         ifeq ($$($1_ZIP_EXTERNAL_DEBUG_SYMBOLS), true)
<span class="line-modified"> 891           $1_DEBUGINFO_ZIP := $$($1_OUTPUT_DIR)/$$($1_NOSUFFIX).diz</span>
 892           $1 += $$($1_DEBUGINFO_ZIP)
 893 
 894           # The dependency on TARGET is needed for debuginfo files
 895           # to be rebuilt properly.
 896           $$($1_DEBUGINFO_ZIP): $$($1_DEBUGINFO_FILES) $$($1_TARGET)
<span class="line-modified"> 897 		$(CD) $$($1_OUTPUT_DIR) &amp;&amp; \</span>
<span class="line-modified"> 898 		    $(ZIPEXE) -q -r $$@ $$(subst $$($1_OUTPUT_DIR)/,, $$($1_DEBUGINFO_FILES))</span>
 899 
 900         endif
 901        endif # !STATIC_LIBRARY
 902     endif # $1_DEBUG_SYMBOLS != false
 903   endif # COPY_DEBUG_SYMBOLS
 904 
 905   # Unless specifically set, stripping should only happen if symbols are also
 906   # being copied.
 907   $$(call SetIfEmpty, $1_STRIP_SYMBOLS, $$($1_COPY_DEBUG_SYMBOLS))
 908 
 909   ifneq ($$($1_STRIP_SYMBOLS), false)
 910     ifneq ($$($1_STRIP), )
 911       # Default to using the global STRIPFLAGS. Allow for overriding with an empty value
 912       $1_STRIPFLAGS ?= $(STRIPFLAGS)
 913       $1_STRIP_CMD := $$($1_STRIP) $$($1_STRIPFLAGS) $$($1_TARGET)
 914     endif
 915   endif
 916 
 917   ifeq ($$($1_TYPE), STATIC_LIBRARY)
 918     $1_VARDEPS := $$($1_AR) $$($1_ARFLAGS) $$($1_LIBS) \
 919         $$($1_EXTRA_LIBS)
 920     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
 921         $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).vardeps)
 922 
 923     # Generating a static library, ie object file archive.
 924     ifeq ($(STATIC_BUILD), true)
 925       ifeq ($$($1_USE_MAPFILE_FOR_SYMBOLS), true)
 926         STATIC_MAPFILE_DEP := $$($1_MAPFILE)
 927       endif
 928     endif
 929 
 930     $1_TARGET_DEPS := $$($1_ALL_OBJS) $$($1_RES) $$($1_VARDEPS_FILE) $$(STATIC_MAPFILE_DEP)
 931 
 932     $$($1_TARGET): $$($1_TARGET_DEPS)
 933 	$$(call LogInfo, Building static library $$($1_BASENAME))

 934 	$$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
 935 	    $$($1_AR) $$($1_ARFLAGS) $(AR_OUT_OPTION)$$($1_TARGET) $$($1_ALL_OBJS) \
 936 	        $$($1_RES))
 937         ifeq ($(STATIC_BUILD), true)
 938           ifeq ($$($1_USE_MAPFILE_FOR_SYMBOLS), true)
 939 	    $(CP) $$($1_MAPFILE) $$(@D)/$$(basename $$(@F)).symbols
 940           else
 941 	    $(GetSymbols)
 942           endif
 943         endif
 944   else
 945     # A shared dynamic library or an executable binary has been specified
 946     ifeq ($$($1_TYPE), LIBRARY)
 947       # Generating a dynamic library.
 948       $1_EXTRA_LDFLAGS += $$(call SET_SHARED_LIBRARY_NAME,$$($1_BASENAME))
 949 
 950       # Create loadmap on AIX. Helps in diagnosing some problems.
 951       ifneq ($(COMPILER_BINDCMD_FILE_FLAG), )
 952         $1_EXTRA_LDFLAGS += $(COMPILER_BINDCMD_FILE_FLAG)$$($1_OBJECT_DIR)/$$($1_NOSUFFIX).loadmap
 953       endif
</pre>
<hr />
<pre>
 962       $1_EXTRA_LDFLAGS += &quot;-implib:$$($1_IMPORT_LIBRARY)&quot;
 963       ifeq ($$($1_TYPE), LIBRARY)
 964         # To properly trigger downstream dependants of the import library, just as
 965         # for debug files, we must have a recipe in the rule. To avoid rerunning
 966         # the recipe every time have it touch the target. If an import library
 967         # file is deleted by something external, explicitly delete the target to
 968         # trigger a rebuild of both.
 969         ifneq ($$(wildcard $$($1_IMPORT_LIBRARY)), $$($1_IMPORT_LIBRARY))
 970           $$(call LogDebug, Deleting $$($1_BASENAME) because import library is missing)
 971           $$(shell $(RM) $$($1_TARGET))
 972         endif
 973         $$($1_IMPORT_LIBRARY): $$($1_TARGET)
 974 		$(TOUCH) $$@
 975 
 976         $1 += $$($1_IMPORT_LIBRARY)
 977       endif
 978     endif
 979 
 980     $1_VARDEPS := $$($1_LD) $$($1_SYSROOT_LDFLAGS) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) \
 981         $$(GLOBAL_LIBS) $$($1_LIBS) $$($1_EXTRA_LIBS) $$($1_MT) \
<span class="line-modified"> 982         $$($1_CODESIGN) $$($1_CREATE_DEBUGINFO_CMDS) $$($1_MANIFEST_VERSION) \</span>
 983         $$($1_STRIP_CMD)
 984     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
 985         $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).vardeps)
 986 
 987     $1_LD_OBJ_ARG := $$($1_ALL_OBJS)
 988 
 989     # If there are many object files, use an @-file...
 990     ifneq ($$(word 17, $$($1_ALL_OBJS)), )
 991       $1_OBJ_FILE_LIST := $$($1_OBJECT_DIR)/_$1_objectfilenames.txt
 992       ifneq ($(COMPILER_COMMAND_FILE_FLAG), )
 993         $1_LD_OBJ_ARG := $(COMPILER_COMMAND_FILE_FLAG)$$($1_OBJ_FILE_LIST)
 994       else
 995         # ...except for toolchains which don&#39;t support them.
 996         $1_LD_OBJ_ARG := `cat $$($1_OBJ_FILE_LIST)`
 997       endif
 998     endif
 999 
1000     # Unfortunately the @-file trick does not work reliably when using clang.
1001     # Clang does not propagate the @-file parameter to the ld sub process, but
1002     # instead puts the full content on the command line. At least the llvm ld
</pre>
<hr />
<pre>
1015           $1_LINK_OBJS_RELATIVE := true
1016           $1_ALL_OBJS_RELATIVE := $$(patsubst $$(OUTPUTDIR)/%, %, $$($1_ALL_OBJS))
1017         endif
1018       endif
1019     endif
1020 
1021     $1_TARGET_DEPS := $$($1_ALL_OBJS) $$($1_RES) $$($1_MANIFEST) \
1022         $$($1_REAL_MAPFILE) $$($1_VARDEPS_FILE)
1023 
1024     $$($1_TARGET): $$($1_TARGET_DEPS)
1025                 ifneq ($$($1_OBJ_FILE_LIST), )
1026                   ifeq ($$($1_LINK_OBJS_RELATIVE), true)
1027 		    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS_RELATIVE, $$($1_OBJ_FILE_LIST)))
1028                   else
1029 		    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS, $$($1_OBJ_FILE_LIST)))
1030                   endif
1031                 endif
1032                 # Keep as much as possible on one execution line for best performance
1033                 # on Windows
1034 		$$(call LogInfo, Linking $$($1_BASENAME))

1035                 ifeq ($(call isTargetOs, windows), true)

1036 		  $$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
1037 		      $$($1_LD) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) $$($1_SYSROOT_LDFLAGS) \
1038 		          $(LD_OUT_OPTION)$$($1_TARGET) $$($1_LD_OBJ_ARG) $$($1_RES) $$(GLOBAL_LIBS) \
1039 		          $$($1_LIBS) $$($1_EXTRA_LIBS)) \
1040 		      | $(GREP) -v &quot;^   Creating library .*\.lib and object .*\.exp&quot; || \
1041 		          test &quot;$$$$?&quot; = &quot;1&quot; ; \
1042 		  $$($1_CREATE_DEBUGINFO_CMDS)
1043 		  $$($1_STRIP_CMD)
1044                 else
1045 		  $$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
1046 		      $$(if $$($1_LINK_OBJS_RELATIVE), $$(CD) $$(OUTPUTDIR) ; ) \
1047 		      $$($1_LD) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) $$($1_SYSROOT_LDFLAGS) \
1048 		          $(LD_OUT_OPTION)$$($1_TARGET) $$($1_LD_OBJ_ARG) $$($1_RES) $$(GLOBAL_LIBS) \
1049 		          $$($1_LIBS) $$($1_EXTRA_LIBS)) ; \
1050 		  $$($1_CREATE_DEBUGINFO_CMDS)
1051 		  $$($1_STRIP_CMD)
1052                 endif
1053                 ifeq ($(call isTargetOs, windows), true)
1054                   ifneq ($$($1_MANIFEST), )
1055 		    $$($1_MT) -nologo -manifest $$($1_MANIFEST) -identity:&quot;$$($1_NAME).exe, version=$$($1_MANIFEST_VERSION)&quot; -outputresource:$$@;#1
1056                   endif
1057                 endif
1058                 # This only works if the openjdk_codesign identity is present on the system. Let
1059                 # silently fail otherwise.
1060                 ifneq ($(CODESIGN), )
<span class="line-modified">1061                   ifneq ($$($1_CODESIGN), )</span>
<span class="line-modified">1062 		    $(CODESIGN) -s openjdk_codesign $$@</span>
<span class="line-removed">1063                   endif</span>
1064                 endif
1065   endif
1066 
1067   ifeq ($(GENERATE_COMPILE_COMMANDS_ONLY), true)
1068     $1 := $$($1_ALL_OBJS_JSON)
1069   endif
1070 endef
1071 
1072 endif # _NATIVE_COMPILATION_GMK
</pre>
</td>
<td>
<hr />
<pre>
   1 #
<span class="line-modified">   2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4 #
   5 # This code is free software; you can redistribute it and/or modify it
   6 # under the terms of the GNU General Public License version 2 only, as
   7 # published by the Free Software Foundation.  Oracle designates this
   8 # particular file as subject to the &quot;Classpath&quot; exception as provided
   9 # by Oracle in the LICENSE file that accompanied this code.
  10 #
  11 # This code is distributed in the hope that it will be useful, but WITHOUT
  12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14 # version 2 for more details (a copy is included in the LICENSE file that
  15 # accompanied this code).
  16 #
  17 # You should have received a copy of the GNU General Public License version
  18 # 2 along with this work; if not, write to the Free Software Foundation,
  19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20 #
  21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22 # or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 214 # Remaining parameters are named arguments:
 215 #   FILE - The full path of the source file to compiler
 216 #   BASE - The name of the rule for the entire binary to build ($1)
 217 #   DISABLE_THIS_FILE_DEFINE - Set to true to disable the THIS_FILE define.
 218 #
 219 SetupCompileNativeFile = $(NamedParamsMacroTemplate)
 220 define SetupCompileNativeFileBody
 221   $1_FILENAME := $$(notdir $$($1_FILE))
 222 
 223   # The target file to be generated.
 224   $1_OBJ := $$($$($1_BASE)_OBJECT_DIR)/$$(call replace_with_obj_extension, \
 225       $$($1_FILENAME))
 226 
 227   # Generate the corresponding compile_commands.json fragment.
 228   $1_OBJ_JSON = $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 229       $$(OUTPUTDIR)/,,$$($1_OBJ))).json
 230   $$($1_BASE)_ALL_OBJS_JSON += $$($1_OBJ_JSON)
 231 
 232   # Only continue if this object file hasn&#39;t been processed already. This lets
 233   # the first found source file override any other with the same name.
<span class="line-modified"> 234   ifeq ($$($1_OBJ_PROCESSED), )</span>
<span class="line-modified"> 235     $1_OBJ_PROCESSED := true</span>
 236     # This is the definite source file to use for $1_FILENAME.
 237     $1_SRC_FILE := $$($1_FILE)
 238 
<span class="line-modified"> 239     ifneq ($$($1_DEFINE_THIS_FILE), false)</span>
<span class="line-modified"> 240       ifneq ($$($$($1_BASE)_DEFINE_THIS_FILE), false)</span>
<span class="line-added"> 241         $1_THIS_FILE = -DTHIS_FILE=&#39;&quot;$$($1_FILENAME)&quot;&#39;</span>
<span class="line-added"> 242       endif</span>
 243     endif
 244 
 245     ifeq ($$($1_OPTIMIZATION), )
 246       $1_OPT_CFLAGS := $$($$($1_BASE)_OPT_CFLAGS)
 247       $1_OPT_CXXFLAGS := $$($$($1_BASE)_OPT_CXXFLAGS)
 248     else
 249       ifeq ($$($1_OPTIMIZATION), NONE)
 250         $1_OPT_CFLAGS := $(C_O_FLAG_NONE)
 251         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NONE)
 252       else ifeq ($$($1_OPTIMIZATION), LOW)
 253         $1_OPT_CFLAGS := $(C_O_FLAG_NORM)
 254         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NORM)
 255       else ifeq ($$($1_OPTIMIZATION), HIGH)
 256         $1_OPT_CFLAGS := $(C_O_FLAG_HI)
 257         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HI)
 258       else ifeq ($$($1_OPTIMIZATION), HIGHEST)
 259         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST)
 260         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST)
 261       else ifeq ($$($1_OPTIMIZATION), HIGHEST_JVM)
 262         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST_JVM)
</pre>
<hr />
<pre>
 293           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c
 294       $1_COMPILER := $$($$($1_BASE)_CC)
 295       $1_DEP_FLAG := $(C_FLAG_DEPS)
 296     else ifneq ($$(filter %.s %.S, $$($1_FILENAME)), )
 297       # Compile as assembler file
 298       $1_FLAGS := $$($1_BASE_ASFLAGS)
 299       $1_COMPILER := $(AS)
 300       $1_DEP_FLAG :=
 301     else ifneq ($$(filter %.cpp %.cc %.mm, $$($1_FILENAME)), )
 302       # Compile as a C++ or Objective-C++ file
 303       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CXXFLAGS) \
 304           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) $$($1_THIS_FILE) -c
 305       $1_COMPILER := $$($$($1_BASE)_CXX)
 306       $1_DEP_FLAG := $(CXX_FLAG_DEPS)
 307     else
 308       $$(error Internal error in NativeCompilation.gmk: no compiler for file $$($1_FILENAME))
 309     endif
 310 
 311     ifeq ($$(filter %.s %.S, $$($1_FILENAME)), )
 312       # And this is the dependency file for this obj file.
<span class="line-modified"> 313       $1_DEPS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d,$$($1_OBJ))</span>
 314       # The dependency target file lists all dependencies as empty targets to
 315       # avoid make error &quot;No rule to make target&quot; for removed files
<span class="line-modified"> 316       $1_DEPS_TARGETS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d.targets,$$($1_OBJ))</span>
<span class="line-modified"> 317 </span>
<span class="line-modified"> 318       # Only try to load individual dependency information files if the global</span>
<span class="line-modified"> 319       # file hasn&#39;t been loaded (could happen if make was interrupted).</span>
<span class="line-modified"> 320       ifneq ($$($$($1_BASE)_DEPS_FILE_LOADED), true)</span>
<span class="line-added"> 321         # Include previously generated dependency information. (if it exists)</span>
<span class="line-added"> 322         -include $$($1_DEPS_FILE)</span>
<span class="line-added"> 323         -include $$($1_DEPS_TARGETS_FILE)</span>
<span class="line-added"> 324       endif</span>
 325     endif
 326 
 327     ifneq ($$(strip $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)), )
 328       $1_VARDEPS := $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)
 329       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, $$($1_OBJ).vardeps)
 330     endif
 331 
 332     $1_OBJ_DEPS := $$($1_SRC_FILE) $$($$($1_BASE)_COMPILE_VARDEPS_FILE) \
 333         $$($$($1_BASE)_EXTRA_DEPS) $$($1_VARDEPS_FILE)
 334     $1_COMPILE_OPTIONS := $$($1_FLAGS) $(CC_OUT_OPTION)$$($1_OBJ) $$($1_SRC_FILE)
 335 
 336     $$($1_OBJ_JSON): $$($1_OBJ_DEPS)
 337 	$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$($1_SRC_FILE), \
 338 	    $$($1_COMPILER) $$($1_COMPILE_OPTIONS))
 339 
 340     $$($1_OBJ): $$($1_OBJ_DEPS) | $$($$($1_BASE)_BUILD_INFO)
 341 	$$(call LogInfo, Compiling $$($1_FILENAME) (for $$($$($1_BASE)_BASENAME)))
 342 	$$(call MakeDir, $$(@D))
 343         ifneq ($(TOOLCHAIN_TYPE), microsoft)
 344           ifeq ($(TOOLCHAIN_TYPE)$$(filter %.s, $$($1_FILENAME)), solstudio)
 345             # The Solaris studio compiler doesn&#39;t output the full path to the
 346             # object file in the generated deps files. Fixing it with sed. If
 347             # compiling assembly, don&#39;t try this.
 348 	    $$(call ExecuteWithLog, $$@, \
<span class="line-modified"> 349 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE).tmp $$($1_COMPILE_OPTIONS))</span>
<span class="line-modified"> 350 	    $(SED) &#39;s|^$$(@F):|$$@:|&#39; $$($1_DEPS_FILE).tmp &gt; $$($1_DEPS_FILE)</span>
 351           else
 352 	    $$(call ExecuteWithLog, $$@, \
<span class="line-modified"> 353 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE) $$($1_COMPILE_OPTIONS))</span>
 354           endif
 355           # Create a dependency target file from the dependency file.
 356           # Solution suggested by http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/
<span class="line-modified"> 357           ifneq ($$($1_DEPS_FILE), )</span>
<span class="line-modified"> 358 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)</span>
 359           endif
 360         else
 361           # The Visual Studio compiler lacks a feature for generating make
 362           # dependencies, but by setting -showIncludes, all included files are
 363           # printed. These are filtered out and parsed into make dependences.
 364           #
 365           # Keep as much as possible on one execution line for best performance
 366           # on Windows. No need to save exit code from compilation since
 367           # pipefail is always active on Windows.
 368 	  $$(call ExecuteWithLog, $$@, \
 369 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS)) \
 370 	      | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 371 	          -e &quot;^$$($1_FILENAME)$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
<span class="line-modified"> 372 	  $(ECHO) $$@: \\ &gt; $$($1_DEPS_FILE) ; \</span>
 373 	  $(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_OBJ).log \
<span class="line-modified"> 374 	      | $(SORT) -u &gt;&gt; $$($1_DEPS_FILE) ; \</span>
<span class="line-modified"> 375 	  $(ECHO) &gt;&gt; $$($1_DEPS_FILE) ; \</span>
<span class="line-added"> 376 	  $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)</span>
 377         endif
 378   endif
 379 endef
 380 
 381 # Setup make rules for creating a native binary (a shared library or an
 382 # executable).
 383 #
 384 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 385 # and the targets generated are listed in a variable by that name.
 386 #
 387 # Remaining parameters are named arguments. These include:
 388 #   NAME The base name for the resulting binary, excluding decorations (like *.exe)
 389 #   TYPE Type of binary (EXECUTABLE, LIBRARY or STATIC_LIBRARY). Default is LIBRARY.
 390 #   SUFFIX Override the default suffix for the output file
 391 #   TOOLCHAIN Name of toolchain setup to use. Defaults to TOOLCHAIN_DEFAULT.
 392 #   SRC one or more directory roots to scan for C/C++ files.
 393 #   CFLAGS the compiler flags to be used, used both for C and C++.
 394 #   CXXFLAGS the compiler flags to be used for c++, if set overrides CFLAGS.
 395 #   LDFLAGS the linker flags to be used, used both for C and C++.
 396 #   LIBS the libraries to link to
 397 #   ARFLAGS the archiver flags to be used
 398 #   OBJECT_DIR the directory where we store the object files
 399 #   OUTPUT_DIR the directory where the resulting binary is put
<span class="line-added"> 400 #   SYMBOLS_DIR the directory where the debug symbols are put, defaults to OUTPUT_DIR</span>
 401 #   INCLUDES only pick source from these directories
 402 #   EXCLUDES do not pick source from these directories
 403 #   INCLUDE_FILES only compile exactly these files!
 404 #   EXCLUDE_FILES with these names
 405 #   EXCLUDE_PATTERN exclude files matching any of these substrings
 406 #   EXTRA_FILES List of extra files not in any of the SRC dirs
 407 #   EXTRA_OBJECT_FILES List of extra object files to include when linking
 408 #   EXTRA_DEPS List of extra dependencies to be added to each compiled file
 409 #   VERSIONINFO_RESOURCE Input file for RC. Setting this implies that RC will be run
 410 #   RC_FLAGS flags for RC.
 411 #   EMBED_MANIFEST if true, embed manifest on Windows.
 412 #   MAPFILE mapfile
 413 #   REORDER reorder file
 414 #   USE_MAPFILE_FOR_SYMBOLS if true and this is a STATIC_BUILD, just copy the
 415 #       mapfile for the output symbols file
 416 #   CC the compiler to use, default is $(CC)
 417 #   LD the linker to use, default is $(LD)
 418 #   OPTIMIZATION sets optimization level to NONE, LOW, HIGH, HIGHEST, HIGHEST_JVM, SIZE
 419 #   DISABLED_WARNINGS_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 420 #   DISABLED_WARNINGS_C_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 421 #       when compiling C code
 422 #   DISABLED_WARNINGS_CXX_&lt;toolchain&gt; Disable the given warnings for the specified
 423 #       toolchain when compiling C++ code
 424 #   STRIP_SYMBOLS Set to false to override global strip policy and always leave
 425 #       symbols in the binary, if the toolchain allows for it
 426 #   DEBUG_SYMBOLS Set to false to disable generation of debug symbols
 427 #   COPY_DEBUG_SYMBOLS Set to false to override global setting of debug symbol copying
 428 #   ZIP_EXTERNAL_DEBUG_SYMBOLS Set to false to override global setting of debug symbol
 429 #       zipping
 430 #   STRIPFLAGS Optionally change the flags given to the strip command
 431 #   PRECOMPILED_HEADER Header file to use as precompiled header
 432 #   PRECOMPILED_HEADER_EXCLUDE List of source files that should not use PCH
<span class="line-added"> 433 #   DEFINE_THIS_FILE Set to false to not set the THIS_FILE preprocessor macro</span>
 434 #
 435 # After being called, some variables are exported from this macro, all prefixed
 436 # with parameter 1 followed by a &#39;_&#39;:
 437 #   TARGET The library or executable created by the macro
 438 #   TARGET_DEPS All prerequisites for the target calculated by the macro
 439 #   ALL_OBJS All object files
 440 #   IMPORT_LIBRARY The import library created for a shared library on Windows
 441 SetupNativeCompilation = $(NamedParamsMacroTemplate)
 442 define SetupNativeCompilationBody
 443 
 444   # If type is unspecified, default to LIBRARY
 445   ifeq ($$($1_TYPE), )
 446     $1_TYPE := LIBRARY
 447   endif
 448 
 449   # If we&#39;re doing a static build and producing a library
 450   # force it to be a static library and remove the -l libraries
 451   ifeq ($(STATIC_BUILD), true)
 452     ifeq ($$($1_TYPE), LIBRARY)
 453       $1_TYPE := STATIC_LIBRARY
 454     endif
 455   endif
 456 
<span class="line-added"> 457   $$(call SetIfEmpty, $1_COMPILE_WITH_DEBUG_SYMBOLS, $$(COMPILE_WITH_DEBUG_SYMBOLS))</span>
<span class="line-added"> 458 </span>
<span class="line-added"> 459   # STATIC_LIBS is set from Main.gmk when building static versions of certain</span>
<span class="line-added"> 460   # native libraries.</span>
<span class="line-added"> 461   ifeq ($(STATIC_LIBS), true)</span>
<span class="line-added"> 462     $1_TYPE := STATIC_LIBRARY</span>
<span class="line-added"> 463     # The static versions need to be redirected to different output dirs, both</span>
<span class="line-added"> 464     # to not interfere with the main build as well as to not end up inside the</span>
<span class="line-added"> 465     # jmods.</span>
<span class="line-added"> 466     $1_OBJECT_DIR := $$($1_OBJECT_DIR)/static</span>
<span class="line-added"> 467     $1_OUTPUT_DIR := $$($1_OBJECT_DIR)</span>
<span class="line-added"> 468     # For release builds where debug symbols are configured to be moved to</span>
<span class="line-added"> 469     # separate debuginfo files, disable debug symbols for static libs instead.</span>
<span class="line-added"> 470     # We don&#39;t currently support this configuration and we don&#39;t want symbol</span>
<span class="line-added"> 471     # information in release builds unless explicitly asked to provide it.</span>
<span class="line-added"> 472     ifeq ($(DEBUG_LEVEL), release)</span>
<span class="line-added"> 473       ifeq ($(COPY_DEBUG_SYMBOLS), true)</span>
<span class="line-added"> 474         $1_COMPILE_WITH_DEBUG_SYMBOLS := false</span>
<span class="line-added"> 475       endif</span>
<span class="line-added"> 476     endif</span>
<span class="line-added"> 477   endif</span>
<span class="line-added"> 478 </span>
 479   ifeq ($$($1_TYPE), EXECUTABLE)
 480     $1_PREFIX :=
 481     ifeq ($$($1_SUFFIX), )
 482       $1_SUFFIX := $(EXE_SUFFIX)
 483     endif
 484   else
 485     $1_PREFIX := $(LIBRARY_PREFIX)
 486     ifeq ($$($1_TYPE), LIBRARY)
 487       ifeq ($$($1_SUFFIX), )
 488         $1_SUFFIX := $(SHARED_LIBRARY_SUFFIX)
 489       endif
 490     else ifeq ($$($1_TYPE), STATIC_LIBRARY)
 491       ifeq ($$($1_SUFFIX), )
 492         $1_SUFFIX := $(STATIC_LIBRARY_SUFFIX)
 493       endif
 494     endif
 495   endif
 496 
 497   ifneq ($$($1_NAME), $(basename $$($1_NAME)))
 498     $$(error NAME must not contain any directory path in $1)
</pre>
<hr />
<pre>
 500   ifneq ($(findstring $$($1_SUFFIX), $$($1_NAME)), )
 501     $$(error NAME should be specified without suffix: $$($1_SUFFIX) in $1)
 502   endif
 503   ifneq ($(findstring $$($1_PREFIX), $$($1_NAME)), )
 504     $$(error NAME should be specified without prefix: $$($1_PREFIX) in $1)
 505   endif
 506   ifeq ($$($1_OUTPUT_DIR), )
 507     $$(error OUTPUT_DIR is missing in $1)
 508   endif
 509   ifneq ($$($1_MANIFEST), )
 510     ifeq ($$($1_MANIFEST_VERSION), )
 511       $$(error If MANIFEST is provided, then MANIFEST_VERSION is required in $1)
 512     endif
 513   endif
 514 
 515   $1_BASENAME := $$($1_PREFIX)$$($1_NAME)$$($1_SUFFIX)
 516   $1_TARGET := $$($1_OUTPUT_DIR)/$$($1_BASENAME)
 517   $1_NOSUFFIX := $$($1_PREFIX)$$($1_NAME)
 518   $1_SAFE_NAME := $$(strip $$(subst /,_, $1))
 519 
<span class="line-added"> 520 # Need to make sure TARGET is first on list</span>
<span class="line-added"> 521   $1 := $$($1_TARGET)</span>
<span class="line-added"> 522 </span>
 523   # Setup the toolchain to be used
 524   $$(call SetIfEmpty, $1_TOOLCHAIN, TOOLCHAIN_DEFAULT)
 525   $$(call SetIfEmpty, $1_CC, $$($$($1_TOOLCHAIN)_CC))
 526   $$(call SetIfEmpty, $1_CXX, $$($$($1_TOOLCHAIN)_CXX))
 527   $$(call SetIfEmpty, $1_LD, $$($$($1_TOOLCHAIN)_LD))
 528   $$(call SetIfEmpty, $1_AR, $$($$($1_TOOLCHAIN)_AR))
 529   $$(call SetIfEmpty, $1_AS, $$($$($1_TOOLCHAIN)_AS))
 530   $$(call SetIfEmpty, $1_MT, $$($$($1_TOOLCHAIN)_MT))
 531   $$(call SetIfEmpty, $1_RC, $$($$($1_TOOLCHAIN)_RC))
 532   $$(call SetIfEmpty, $1_OBJCOPY, $$($$($1_TOOLCHAIN)_OBJCOPY))
 533   $$(call SetIfEmpty, $1_STRIP, $$($$($1_TOOLCHAIN)_STRIP))
 534   $$(call SetIfEmpty, $1_SYSROOT_CFLAGS, $$($$($1_TOOLCHAIN)_SYSROOT_CFLAGS))
 535   $$(call SetIfEmpty, $1_SYSROOT_LDFLAGS, $$($$($1_TOOLCHAIN)_SYSROOT_LDFLAGS))
 536 


 537   $$(foreach d, $$($1_SRC), $$(if $$(wildcard $$d), , \
 538       $$(error SRC specified to SetupNativeCompilation $1 contains missing directory $$d)))
 539 
<span class="line-modified"> 540   $1_SRCS_RAW := $$(call FindFiles, $$($1_SRC))</span>
 541   # Order src files according to the order of the src dirs
 542   $1_SRCS := $$(foreach d, $$($1_SRC), $$(filter $$d%, $$($1_SRCS_RAW)))
 543   $1_SRCS := $$(filter $$(NATIVE_SOURCE_EXTENSIONS), $$($1_SRCS))
 544   # Extract the C/C++ files.
 545   ifneq ($$($1_EXCLUDE_PATTERNS), )
 546     # We must not match the exclude pattern against the src root(s).
 547     $1_SRCS_WITHOUT_ROOTS := $$($1_SRCS)
 548     $$(foreach i, $$($1_SRC), $$(eval $1_SRCS_WITHOUT_ROOTS := $$(patsubst \
 549         $$i/%,%, $$($1_SRCS_WITHOUT_ROOTS))))
 550     $1_ALL_EXCLUDE_FILES :=  $$(call containing, $$($1_EXCLUDE_PATTERNS), \
 551         $$($1_SRCS_WITHOUT_ROOTS))
 552   endif
 553   ifneq ($$($1_EXCLUDE_FILES), )
 554     $1_ALL_EXCLUDE_FILES += $$($1_EXCLUDE_FILES)
 555   endif
 556   ifneq ($$($1_ALL_EXCLUDE_FILES), )
 557     $1_EXCLUDE_FILES_PAT := $$($1_ALL_EXCLUDE_FILES) \
 558         $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$($1_ALL_EXCLUDE_FILES)))
 559     $1_EXCLUDE_FILES_PAT := $$(addprefix %, $$($1_EXCLUDE_FILES_PAT))
 560     $1_SRCS := $$(filter-out $$($1_EXCLUDE_FILES_PAT), $$($1_SRCS))
</pre>
<hr />
<pre>
 596   endif
 597   # Sort to remove dupliates and provide a reproducable order on the input files to the linker.
 598   $1_ALL_OBJS := $$(sort $$($1_EXPECTED_OBJS) $$($1_EXTRA_OBJECT_FILES))
 599 
 600   # Pickup extra OPENJDK_TARGET_OS_TYPE, OPENJDK_TARGET_OS, and/or OPENJDK_TARGET_OS plus
 601   # OPENJDK_TARGET_CPU pair dependent variables for CFLAGS.
 602   $1_EXTRA_CFLAGS := $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_CFLAGS_$(OPENJDK_TARGET_OS)) \
 603       $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU))
 604   ifneq ($(DEBUG_LEVEL), release)
 605     # Pickup extra debug dependent variables for CFLAGS
 606     $1_EXTRA_CFLAGS += $$($1_CFLAGS_debug)
 607     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)_debug)
 608     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_debug)
 609     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU)_debug)
 610   else
 611     $1_EXTRA_CFLAGS += $$($1_CFLAGS_release)
 612     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS_TYPE)_release)
 613     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_release)
 614     $1_EXTRA_CFLAGS += $$($1_CFLAGS_$(OPENJDK_TARGET_OS)_$(OPENJDK_TARGET_CPU)_release)
 615   endif
<span class="line-added"> 616   ifeq ($(STATIC_LIBS), true)</span>
<span class="line-added"> 617     $1_EXTRA_CFLAGS += $$(STATIC_LIBS_CFLAGS)</span>
<span class="line-added"> 618   endif</span>
 619 
 620   # Pickup extra OPENJDK_TARGET_OS_TYPE and/or OPENJDK_TARGET_OS dependent variables for CXXFLAGS.
 621   $1_EXTRA_CXXFLAGS := $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS))
 622   ifneq ($(DEBUG_LEVEL), release)
 623     # Pickup extra debug dependent variables for CXXFLAGS
 624     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_debug)
 625     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)_debug)
 626     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS)_debug)
 627   else
 628     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_release)
 629     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS_TYPE)_release)
 630     $1_EXTRA_CXXFLAGS += $$($1_CXXFLAGS_$(OPENJDK_TARGET_OS)_release)
 631   endif
<span class="line-added"> 632   ifeq ($(STATIC_LIBS), true)</span>
<span class="line-added"> 633     $1_EXTRA_CXXFLAGS += $$(STATIC_LIB_CFLAGS)</span>
<span class="line-added"> 634   endif</span>
 635 
 636   # If no C++ flags are explicitly set, default to using the C flags.
 637   # After that, we can set additional C++ flags that should not interfere
 638   # with the mechanism for copying the C flags by default.
 639   ifeq ($$($1_CXXFLAGS), )
 640     $1_CXXFLAGS := $$($1_CFLAGS)
 641   endif
 642   ifeq ($$(strip $$($1_EXTRA_CXXFLAGS)), )
 643     $1_EXTRA_CXXFLAGS := $$($1_EXTRA_CFLAGS)
 644   endif
 645 
<span class="line-modified"> 646   ifeq ($$($1_COMPILE_WITH_DEBUG_SYMBOLS), true)</span>
 647     $1_EXTRA_CFLAGS += $$(CFLAGS_DEBUG_SYMBOLS)
 648     $1_EXTRA_CXXFLAGS += $$(CFLAGS_DEBUG_SYMBOLS)
 649     $1_EXTRA_ASFLAGS += $$(ASFLAGS_DEBUG_SYMBOLS)
 650   endif
 651 
 652   ifneq ($$($1_REORDER), )
 653     $1_EXTRA_CFLAGS += $$(C_FLAG_REORDER)
 654     $1_EXTRA_CXXFLAGS += $$(C_FLAG_REORDER)
 655   endif
 656 
 657   # Pass the library name for static JNI library naming
 658   ifeq ($$($1_TYPE), STATIC_LIBRARY)
 659     $1_EXTRA_CFLAGS += -DLIBRARY_NAME=$$($1_NAME)
 660     $1_EXTRA_CXXFLAGS += -DLIBRARY_NAME=$$($1_NAME)
 661   endif
 662 
 663   # Pick up disabled warnings, if possible on this platform.
 664   ifneq ($(DISABLE_WARNING_PREFIX), )
 665     $1_EXTRA_CFLAGS += $$(addprefix $(DISABLE_WARNING_PREFIX), \
 666         $$(DISABLED_WARNINGS) \
</pre>
<hr />
<pre>
 717   # Track variable changes for all variables that affect the compilation command
 718   # lines for all object files in this setup. This includes at least all the
 719   # variables used in the call to add_native_source below.
 720   $1_COMPILE_VARDEPS := $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 721       $$($1_CXXFLAGS) $$($1_EXTRA_CXXFLAGS) $$($1_OPT_CFLAGS) $$($1_OPT_CXXFLAGS) \
 722       $$($1_CC) $$($1_CXX) $$($1_AS) $$($1_ASFLAGS)
 723   $1_COMPILE_VARDEPS_FILE := $$(call DependOnVariable, $1_COMPILE_VARDEPS, \
 724       $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).comp.vardeps)
 725 
 726   ifneq ($$($1_PRECOMPILED_HEADER), )
 727     ifeq ($(USE_PRECOMPILED_HEADER), true)
 728       ifeq ($(TOOLCHAIN_TYPE), microsoft)
 729         $1_PCH_FILE := $$($1_OBJECT_DIR)/$1.pch
 730         $1_GENERATED_PCH_SRC := $$($1_OBJECT_DIR)/$1_pch.cpp
 731         $1_GENERATED_PCH_OBJ := $$($1_OBJECT_DIR)/$1_pch.obj
 732 
 733         $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$($1_GENERATED_PCH_SRC)), \
 734             FILE := $$($1_GENERATED_PCH_SRC), \
 735             BASE := $1, \
 736             EXTRA_CXXFLAGS := -Fp$$($1_PCH_FILE) -Yc$$(notdir $$($1_PRECOMPILED_HEADER)), \
<span class="line-modified"> 737             DEFINE_THIS_FILE := false, \</span>
 738         ))
 739 
 740         $1_USE_PCH_FLAGS := \
 741             -Fp$$($1_PCH_FILE) -Yu$$(notdir $$($1_PRECOMPILED_HEADER))
 742 
 743         $$($1_ALL_OBJS): $$($1_GENERATED_PCH_OBJ)
 744 
 745         # Explicitly add the pch obj file first to ease comparing to old
 746         # hotspot build.
 747         $1_ALL_OBJS := $$($1_GENERATED_PCH_OBJ) $$($1_ALL_OBJS)
 748 
 749         $$($1_GENERATED_PCH_SRC):
 750 		$(ECHO) &quot;#include \&quot;$$(notdir $$($1_PRECOMPILED_HEADER))\&quot;&quot; &gt; $$@
 751 
 752       else ifneq ($(findstring $(TOOLCHAIN_TYPE), gcc clang), )
 753         ifeq ($(TOOLCHAIN_TYPE), gcc)
 754           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).gch
 755           $1_USE_PCH_FLAGS := -I$$($1_OBJECT_DIR)/precompiled
 756         else ifeq ($(TOOLCHAIN_TYPE), clang)
 757           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).pch
 758           $1_USE_PCH_FLAGS := -include-pch $$($1_PCH_FILE)
 759         endif
<span class="line-modified"> 760         $1_PCH_DEPS_FILE := $$($1_PCH_FILE).d</span>
<span class="line-modified"> 761         $1_PCH_DEPS_TARGETS_FILE := $$($1_PCH_FILE).d.targets</span>
 762 
<span class="line-modified"> 763         -include $$($1_PCH_DEPS_FILE)</span>
<span class="line-modified"> 764         -include $$($1_PCH_DEPS_TARGETS_FILE)</span>
 765 
 766         $1_PCH_COMMAND := $$($1_CC) $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
<span class="line-modified"> 767             $$($1_OPT_CFLAGS) -x c++-header -c $(C_FLAG_DEPS) $$($1_PCH_DEPS_FILE)</span>
 768 
 769         $$($1_PCH_FILE): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 770 		$$(call LogInfo, Generating precompiled header)
 771 		$$(call MakeDir, $$(@D))
 772 		$$(call ExecuteWithLog, $$@, $$($1_PCH_COMMAND) $$&lt; -o $$@)
<span class="line-modified"> 773 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_PCH_DEPS_FILE) \</span>
<span class="line-added"> 774 		    &gt; $$($1_PCH_DEPS_TARGETS_FILE)</span>
 775 
 776         $$($1_ALL_OBJS): $$($1_PCH_FILE)
 777 
 778         # Generate the corresponding compile_commands.json fragment.
 779         $1_PCH_FILE_JSON := $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 780             $$(OUTPUTDIR)/,,$$($1_PCH_FILE))).json
 781         $1_ALL_OBJS_JSON += $$($1_PCH_FILE_JSON)
 782 
 783         $$($1_PCH_FILE_JSON): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 784 		$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$&lt;, \
 785 		    $$($1_PCH_COMMAND) $$&lt; -o $$($1_PCH_FILE))
 786       endif
 787     endif
 788   endif
 789 
 790   # Now call SetupCompileNativeFile for each source file we are going to compile.
 791   $$(foreach file, $$($1_SRCS), \
 792       $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$(file)),\
 793           FILE := $$(file), \
 794           BASE := $1, \
 795       )) \
 796   )
 797 
 798   # Setup rule for printing progress info when compiling source files.
 799   # This is a rough heuristic and may not always print accurate information.
 800   $$($1_BUILD_INFO): $$($1_SRCS) $$($1_COMPILE_VARDEPS_FILE)
 801         ifeq ($$(wildcard $$($1_TARGET)), )
<span class="line-modified"> 802 	  $$(call LogWarn, Creating $$(subst $$(OUTPUTDIR)/,,$$($1_TARGET)) from $$(words \</span>
<span class="line-modified"> 803 	      $$(filter-out %.vardeps, $$?)) file(s))</span>
 804         else
<span class="line-modified"> 805 	  $$(call LogWarn, $$(strip Updating $$(subst $$(OUTPUTDIR)/,,$$($1_TARGET)) \</span>
 806 	      $$(if $$(filter-out %.vardeps, $$?), \
<span class="line-modified"> 807 	        due to $$(words $$(filter-out %.vardeps, $$?)) file(s), \</span>
<span class="line-modified"> 808 	      $$(if $$(filter %.vardeps, $$?), due to makefile changes))))</span>
 809         endif
 810 	$(TOUCH) $$@
 811 
 812   # On windows we need to create a resource file
 813   ifeq ($(call isTargetOs, windows), true)
 814     ifneq ($$($1_VERSIONINFO_RESOURCE), )
 815       $1_RES := $$($1_OBJECT_DIR)/$$($1_BASENAME).res
<span class="line-modified"> 816       $1_RES_DEPS_FILE := $$($1_RES).d</span>
<span class="line-modified"> 817       $1_RES_DEPS_TARGETS_FILE := $$($1_RES).d.targets</span>
<span class="line-modified"> 818       -include $$($1_RES_DEPS_FILE)</span>
<span class="line-modified"> 819       -include $$($1_RES_DEPS_TARGETS_FILE)</span>
 820 
 821       $1_RES_VARDEPS := $$($1_RC) $$($1_RC_FLAGS)
 822       $1_RES_VARDEPS_FILE := $$(call DependOnVariable, $1_RES_VARDEPS, \
 823           $$($1_RES).vardeps)
 824 
 825       $$($1_RES): $$($1_VERSIONINFO_RESOURCE) $$($1_RES_VARDEPS_FILE)
 826 		$$(call LogInfo, Compiling resource $$(notdir $$($1_VERSIONINFO_RESOURCE)) (for $$($1_BASENAME)))
 827 		$$(call MakeDir, $$(@D) $$($1_OBJECT_DIR))
 828 		$$(call ExecuteWithLog, $$@, \
 829 		    $$($1_RC) $$($1_RC_FLAGS) $$($1_SYSROOT_CFLAGS) $(CC_OUT_OPTION)$$@ \
 830 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 )
 831                 # Windows RC compiler does not support -showIncludes, so we mis-use CL
 832                 # for this. Filter out RC specific arguments that are unknown to CL.
 833                 # For some unknown reason, in this case CL actually outputs the show
 834                 # includes to stderr so need to redirect it to hide the output from the
 835                 # main log.
<span class="line-modified"> 836 		$$(call ExecuteWithLog, $$($1_RES_DEPS_FILE).obj, \</span>
 837 		    $$($1_CC) $$(filter-out -l%, $$($1_RC_FLAGS)) \
 838 		        $$($1_SYSROOT_CFLAGS) -showIncludes -nologo -TC \
<span class="line-modified"> 839 		        $(CC_OUT_OPTION)$$($1_RES_DEPS_FILE).obj -P -Fi$$($1_RES_DEPS_FILE).pp \</span>
 840 		        $$($1_VERSIONINFO_RESOURCE)) 2&gt;&amp;1 \
 841 		    | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 842 		        -e &quot;^$$(notdir $$($1_VERSIONINFO_RESOURCE))$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
<span class="line-modified"> 843 		$(ECHO) $$($1_RES): \\ &gt; $$($1_RES_DEPS_FILE) ; \</span>
<span class="line-modified"> 844 		$(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_RES_DEPS_FILE).obj.log \</span>
<span class="line-modified"> 845 		    &gt;&gt; $$($1_RES_DEPS_FILE) ; \</span>
<span class="line-added"> 846 		$(ECHO) &gt;&gt; $$($1_RES_DEPS_FILE) ;\</span>
<span class="line-added"> 847 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_RES_DEPS_FILE) \</span>
<span class="line-added"> 848 		    &gt; $$($1_RES_DEPS_TARGETS_FILE)</span>
 849     endif
 850   endif
 851 
<span class="line-added"> 852   # Create a rule to collect all the individual make dependency files into a</span>
<span class="line-added"> 853   # single makefile.</span>
<span class="line-added"> 854   $1_DEPS_FILE := $$($1_OBJECT_DIR)/$1.d</span>
<span class="line-added"> 855 </span>
<span class="line-added"> 856   $$($1_DEPS_FILE): $$($1_ALL_OBJS) $$($1_RES)</span>
<span class="line-added"> 857 	$(RM) $$@</span>
<span class="line-added"> 858         # CD into dir to reduce risk of hitting command length limits, which</span>
<span class="line-added"> 859         # could otherwise happen if TOPDIR is a very long path.</span>
<span class="line-added"> 860 	$(CD) $$($1_OBJECT_DIR) &amp;&amp; $(CAT) *.d &gt; $$@.tmp</span>
<span class="line-added"> 861 	$(CD) $$($1_OBJECT_DIR) &amp;&amp; $(CAT) *.d.targets | $(SORT) -u &gt;&gt; $$@.tmp</span>
<span class="line-added"> 862         # After generating the file, which happens after all objects have been</span>
<span class="line-added"> 863         # compiled, copy it to .old extension. On the next make invocation, this</span>
<span class="line-added"> 864         # .old file will be included by make.</span>
<span class="line-added"> 865 	$(CP) $$@.tmp $$@.old</span>
<span class="line-added"> 866 	$(MV) $$@.tmp $$@</span>
<span class="line-added"> 867 </span>
<span class="line-added"> 868   $1 += $$($1_DEPS_FILE)</span>
<span class="line-added"> 869 </span>
<span class="line-added"> 870   # The include must be on the .old file, which represents the state from the</span>
<span class="line-added"> 871   # previous invocation of make. The file being included must not have a rule</span>
<span class="line-added"> 872   # defined for it as otherwise make will think it has to run the rule before</span>
<span class="line-added"> 873   # being able to include the file, which would be wrong since we specifically</span>
<span class="line-added"> 874   # need the file as it was generated by a previous make invocation.</span>
<span class="line-added"> 875   ifneq ($$(wildcard $$($1_DEPS_FILE).old), )</span>
<span class="line-added"> 876     $1_DEPS_FILE_LOADED := true</span>
<span class="line-added"> 877     -include $$($1_DEPS_FILE).old</span>
<span class="line-added"> 878   endif</span>
<span class="line-added"> 879 </span>
 880   ifneq ($(DISABLE_MAPFILES), true)
 881     $1_REAL_MAPFILE := $$($1_MAPFILE)
 882     ifeq ($(call isTargetOs, windows), false)
 883       ifneq ($$($1_REORDER), )
 884         $1_REAL_MAPFILE := $$($1_OBJECT_DIR)/mapfile
 885 
 886         $$($1_REAL_MAPFILE) : $$($1_MAPFILE) $$($1_REORDER)
 887 		$$(call MakeDir, $$(@D))
 888 		$$(CP) $$($1_MAPFILE) $$@.tmp
 889 		$$(SED) -e &#39;s=OUTPUTDIR=$$($1_OBJECT_DIR)=&#39; $$($1_REORDER) &gt;&gt; $$@.tmp
 890 		$$(MV) $$@.tmp $$@
 891       endif
 892     endif
 893   endif
 894 
 895   # Pickup extra OPENJDK_TARGET_OS_TYPE and/or OPENJDK_TARGET_OS dependent variables
 896   # for LDFLAGS and LIBS
 897   $1_EXTRA_LDFLAGS += $$($1_LDFLAGS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_LDFLAGS_$(OPENJDK_TARGET_OS))
 898   $1_EXTRA_LIBS += $$($1_LIBS_$(OPENJDK_TARGET_OS_TYPE)) $$($1_LIBS_$(OPENJDK_TARGET_OS))
 899   ifneq ($$($1_REAL_MAPFILE), )
 900     $1_EXTRA_LDFLAGS += $(call SET_SHARED_LIBRARY_MAPFILE,$$($1_REAL_MAPFILE))
 901   endif
 902 



 903   ifneq ($$($1_COPY_DEBUG_SYMBOLS), false)
 904     $1_COPY_DEBUG_SYMBOLS := $(COPY_DEBUG_SYMBOLS)
 905   endif
 906 
 907   ifneq ($$($1_ZIP_EXTERNAL_DEBUG_SYMBOLS), false)
 908     $1_ZIP_EXTERNAL_DEBUG_SYMBOLS := $(ZIP_EXTERNAL_DEBUG_SYMBOLS)
 909   endif
 910 
 911   ifeq ($$($1_COPY_DEBUG_SYMBOLS), true)
 912     ifneq ($$($1_DEBUG_SYMBOLS), false)
<span class="line-added"> 913       $$(call SetIfEmpty, $1_SYMBOLS_DIR, $$($1_OUTPUT_DIR))</span>
 914       # Only copy debug symbols for dynamic libraries and programs.
 915       ifneq ($$($1_TYPE), STATIC_LIBRARY)
 916         # Generate debuginfo files.
 917         ifeq ($(call isTargetOs, windows), true)
<span class="line-modified"> 918           $1_EXTRA_LDFLAGS += -debug &quot;-pdb:$$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).pdb&quot; \</span>
<span class="line-modified"> 919               &quot;-map:$$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).map&quot;</span>
<span class="line-modified"> 920           $1_DEBUGINFO_FILES := $$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).pdb \</span>
<span class="line-modified"> 921               $$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).map</span>
 922 
 923         else ifeq ($(call isTargetOs, linux solaris), true)
<span class="line-modified"> 924           $1_DEBUGINFO_FILES := $$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).debuginfo</span>
 925           # Setup the command line creating debuginfo files, to be run after linking.
 926           # It cannot be run separately since it updates the original target file
 927           $1_CREATE_DEBUGINFO_CMDS := \
 928               $$($1_OBJCOPY) --only-keep-debug $$($1_TARGET) $$($1_DEBUGINFO_FILES) $$(NEWLINE) \
<span class="line-modified"> 929               $(CD) $$($1_SYMBOLS_DIR) &amp;&amp; \</span>
 930                   $$($1_OBJCOPY) --add-gnu-debuglink=$$($1_DEBUGINFO_FILES) $$($1_TARGET)
 931 
 932         else ifeq ($(call isTargetOs, macosx), true)
 933           $1_DEBUGINFO_FILES := \
<span class="line-modified"> 934               $$($1_SYMBOLS_DIR)/$$($1_BASENAME).dSYM/Contents/Info.plist \</span>
<span class="line-modified"> 935               $$($1_SYMBOLS_DIR)/$$($1_BASENAME).dSYM/Contents/Resources/DWARF/$$($1_BASENAME)</span>
 936           $1_CREATE_DEBUGINFO_CMDS := \
<span class="line-modified"> 937               $(DSYMUTIL) --out $$($1_SYMBOLS_DIR)/$$($1_BASENAME).dSYM $$($1_TARGET)</span>
 938         endif
 939 
 940         # Since the link rule creates more than one file that we want to track,
 941         # we have to use some tricks to get make to cooperate. To properly
 942         # trigger downstream dependants of $$($1_DEBUGINFO_FILES), we must have
 943         # a recipe in the rule below. To avoid rerunning the recipe every time
 944         # have it touch the target. If a debuginfo file is deleted by something
 945         # external, explicitly delete the TARGET to trigger a rebuild of both.
 946         ifneq ($$(wildcard $$($1_DEBUGINFO_FILES)), $$($1_DEBUGINFO_FILES))
 947           $$(call LogDebug, Deleting $$($1_BASENAME) because debuginfo files are missing)
 948           $$(shell $(RM) $$($1_TARGET))
 949         endif
 950         $$($1_DEBUGINFO_FILES): $$($1_TARGET)
 951 		$$(if $$(CORRECT_FUNCTION_IN_RECIPE_EVALUATION), \
 952 		  $$(if $$(wildcard $$@), , $$(error $$@ was not created for $$&lt;)) \
 953 		)
 954 		$(TOUCH) $$@
 955 
 956         $1 += $$($1_DEBUGINFO_FILES)
 957 
 958         ifeq ($$($1_ZIP_EXTERNAL_DEBUG_SYMBOLS), true)
<span class="line-modified"> 959           $1_DEBUGINFO_ZIP := $$($1_SYMBOLS_DIR)/$$($1_NOSUFFIX).diz</span>
 960           $1 += $$($1_DEBUGINFO_ZIP)
 961 
 962           # The dependency on TARGET is needed for debuginfo files
 963           # to be rebuilt properly.
 964           $$($1_DEBUGINFO_ZIP): $$($1_DEBUGINFO_FILES) $$($1_TARGET)
<span class="line-modified"> 965 		$(CD) $$($1_SYMBOLS_DIR) &amp;&amp; \</span>
<span class="line-modified"> 966 		    $(ZIPEXE) -q -r $$@ $$(subst $$($1_SYMBOLS_DIR)/,, $$($1_DEBUGINFO_FILES))</span>
 967 
 968         endif
 969        endif # !STATIC_LIBRARY
 970     endif # $1_DEBUG_SYMBOLS != false
 971   endif # COPY_DEBUG_SYMBOLS
 972 
 973   # Unless specifically set, stripping should only happen if symbols are also
 974   # being copied.
 975   $$(call SetIfEmpty, $1_STRIP_SYMBOLS, $$($1_COPY_DEBUG_SYMBOLS))
 976 
 977   ifneq ($$($1_STRIP_SYMBOLS), false)
 978     ifneq ($$($1_STRIP), )
 979       # Default to using the global STRIPFLAGS. Allow for overriding with an empty value
 980       $1_STRIPFLAGS ?= $(STRIPFLAGS)
 981       $1_STRIP_CMD := $$($1_STRIP) $$($1_STRIPFLAGS) $$($1_TARGET)
 982     endif
 983   endif
 984 
 985   ifeq ($$($1_TYPE), STATIC_LIBRARY)
 986     $1_VARDEPS := $$($1_AR) $$($1_ARFLAGS) $$($1_LIBS) \
 987         $$($1_EXTRA_LIBS)
 988     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
 989         $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).vardeps)
 990 
 991     # Generating a static library, ie object file archive.
 992     ifeq ($(STATIC_BUILD), true)
 993       ifeq ($$($1_USE_MAPFILE_FOR_SYMBOLS), true)
 994         STATIC_MAPFILE_DEP := $$($1_MAPFILE)
 995       endif
 996     endif
 997 
 998     $1_TARGET_DEPS := $$($1_ALL_OBJS) $$($1_RES) $$($1_VARDEPS_FILE) $$(STATIC_MAPFILE_DEP)
 999 
1000     $$($1_TARGET): $$($1_TARGET_DEPS)
1001 	$$(call LogInfo, Building static library $$($1_BASENAME))
<span class="line-added">1002 	$$(call MakeDir, $$($1_OUTPUT_DIR) $$($1_SYMBOLS_DIR))</span>
1003 	$$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
1004 	    $$($1_AR) $$($1_ARFLAGS) $(AR_OUT_OPTION)$$($1_TARGET) $$($1_ALL_OBJS) \
1005 	        $$($1_RES))
1006         ifeq ($(STATIC_BUILD), true)
1007           ifeq ($$($1_USE_MAPFILE_FOR_SYMBOLS), true)
1008 	    $(CP) $$($1_MAPFILE) $$(@D)/$$(basename $$(@F)).symbols
1009           else
1010 	    $(GetSymbols)
1011           endif
1012         endif
1013   else
1014     # A shared dynamic library or an executable binary has been specified
1015     ifeq ($$($1_TYPE), LIBRARY)
1016       # Generating a dynamic library.
1017       $1_EXTRA_LDFLAGS += $$(call SET_SHARED_LIBRARY_NAME,$$($1_BASENAME))
1018 
1019       # Create loadmap on AIX. Helps in diagnosing some problems.
1020       ifneq ($(COMPILER_BINDCMD_FILE_FLAG), )
1021         $1_EXTRA_LDFLAGS += $(COMPILER_BINDCMD_FILE_FLAG)$$($1_OBJECT_DIR)/$$($1_NOSUFFIX).loadmap
1022       endif
</pre>
<hr />
<pre>
1031       $1_EXTRA_LDFLAGS += &quot;-implib:$$($1_IMPORT_LIBRARY)&quot;
1032       ifeq ($$($1_TYPE), LIBRARY)
1033         # To properly trigger downstream dependants of the import library, just as
1034         # for debug files, we must have a recipe in the rule. To avoid rerunning
1035         # the recipe every time have it touch the target. If an import library
1036         # file is deleted by something external, explicitly delete the target to
1037         # trigger a rebuild of both.
1038         ifneq ($$(wildcard $$($1_IMPORT_LIBRARY)), $$($1_IMPORT_LIBRARY))
1039           $$(call LogDebug, Deleting $$($1_BASENAME) because import library is missing)
1040           $$(shell $(RM) $$($1_TARGET))
1041         endif
1042         $$($1_IMPORT_LIBRARY): $$($1_TARGET)
1043 		$(TOUCH) $$@
1044 
1045         $1 += $$($1_IMPORT_LIBRARY)
1046       endif
1047     endif
1048 
1049     $1_VARDEPS := $$($1_LD) $$($1_SYSROOT_LDFLAGS) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) \
1050         $$(GLOBAL_LIBS) $$($1_LIBS) $$($1_EXTRA_LIBS) $$($1_MT) \
<span class="line-modified">1051         $$($1_CREATE_DEBUGINFO_CMDS) $$($1_MANIFEST_VERSION) \</span>
1052         $$($1_STRIP_CMD)
1053     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
1054         $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).vardeps)
1055 
1056     $1_LD_OBJ_ARG := $$($1_ALL_OBJS)
1057 
1058     # If there are many object files, use an @-file...
1059     ifneq ($$(word 17, $$($1_ALL_OBJS)), )
1060       $1_OBJ_FILE_LIST := $$($1_OBJECT_DIR)/_$1_objectfilenames.txt
1061       ifneq ($(COMPILER_COMMAND_FILE_FLAG), )
1062         $1_LD_OBJ_ARG := $(COMPILER_COMMAND_FILE_FLAG)$$($1_OBJ_FILE_LIST)
1063       else
1064         # ...except for toolchains which don&#39;t support them.
1065         $1_LD_OBJ_ARG := `cat $$($1_OBJ_FILE_LIST)`
1066       endif
1067     endif
1068 
1069     # Unfortunately the @-file trick does not work reliably when using clang.
1070     # Clang does not propagate the @-file parameter to the ld sub process, but
1071     # instead puts the full content on the command line. At least the llvm ld
</pre>
<hr />
<pre>
1084           $1_LINK_OBJS_RELATIVE := true
1085           $1_ALL_OBJS_RELATIVE := $$(patsubst $$(OUTPUTDIR)/%, %, $$($1_ALL_OBJS))
1086         endif
1087       endif
1088     endif
1089 
1090     $1_TARGET_DEPS := $$($1_ALL_OBJS) $$($1_RES) $$($1_MANIFEST) \
1091         $$($1_REAL_MAPFILE) $$($1_VARDEPS_FILE)
1092 
1093     $$($1_TARGET): $$($1_TARGET_DEPS)
1094                 ifneq ($$($1_OBJ_FILE_LIST), )
1095                   ifeq ($$($1_LINK_OBJS_RELATIVE), true)
1096 		    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS_RELATIVE, $$($1_OBJ_FILE_LIST)))
1097                   else
1098 		    $$(eval $$(call ListPathsSafely, $1_ALL_OBJS, $$($1_OBJ_FILE_LIST)))
1099                   endif
1100                 endif
1101                 # Keep as much as possible on one execution line for best performance
1102                 # on Windows
1103 		$$(call LogInfo, Linking $$($1_BASENAME))
<span class="line-added">1104 		$$(call MakeDir, $$($1_OUTPUT_DIR) $$($1_SYMBOLS_DIR))</span>
1105                 ifeq ($(call isTargetOs, windows), true)
<span class="line-added">1106 </span>
1107 		  $$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
1108 		      $$($1_LD) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) $$($1_SYSROOT_LDFLAGS) \
1109 		          $(LD_OUT_OPTION)$$($1_TARGET) $$($1_LD_OBJ_ARG) $$($1_RES) $$(GLOBAL_LIBS) \
1110 		          $$($1_LIBS) $$($1_EXTRA_LIBS)) \
1111 		      | $(GREP) -v &quot;^   Creating library .*\.lib and object .*\.exp&quot; || \
1112 		          test &quot;$$$$?&quot; = &quot;1&quot; ; \
1113 		  $$($1_CREATE_DEBUGINFO_CMDS)
1114 		  $$($1_STRIP_CMD)
1115                 else
1116 		  $$(call ExecuteWithLog, $$($1_OBJECT_DIR)/$$($1_SAFE_NAME)_link, \
1117 		      $$(if $$($1_LINK_OBJS_RELATIVE), $$(CD) $$(OUTPUTDIR) ; ) \
1118 		      $$($1_LD) $$($1_LDFLAGS) $$($1_EXTRA_LDFLAGS) $$($1_SYSROOT_LDFLAGS) \
1119 		          $(LD_OUT_OPTION)$$($1_TARGET) $$($1_LD_OBJ_ARG) $$($1_RES) $$(GLOBAL_LIBS) \
1120 		          $$($1_LIBS) $$($1_EXTRA_LIBS)) ; \
1121 		  $$($1_CREATE_DEBUGINFO_CMDS)
1122 		  $$($1_STRIP_CMD)
1123                 endif
1124                 ifeq ($(call isTargetOs, windows), true)
1125                   ifneq ($$($1_MANIFEST), )
1126 		    $$($1_MT) -nologo -manifest $$($1_MANIFEST) -identity:&quot;$$($1_NAME).exe, version=$$($1_MANIFEST_VERSION)&quot; -outputresource:$$@;#1
1127                   endif
1128                 endif
1129                 # This only works if the openjdk_codesign identity is present on the system. Let
1130                 # silently fail otherwise.
1131                 ifneq ($(CODESIGN), )
<span class="line-modified">1132 		  $(CODESIGN) -s &quot;$(MACOSX_CODESIGN_IDENTITY)&quot; --timestamp --options runtime \</span>
<span class="line-modified">1133 		  --entitlements $(TOPDIR)/make/data/macosxsigning/entitlements.plist $$@</span>

1134                 endif
1135   endif
1136 
1137   ifeq ($(GENERATE_COMPILE_COMMANDS_ONLY), true)
1138     $1 := $$($1_ALL_OBJS_JSON)
1139   endif
1140 endef
1141 
1142 endif # _NATIVE_COMPILATION_GMK
</pre>
</td>
</tr>
</table>
<center><a href="Modules.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="ProcessMarkdown.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>