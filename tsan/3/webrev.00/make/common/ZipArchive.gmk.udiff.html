<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff make/common/ZipArchive.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="Utils.gmk.udiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../conf/jib-profiles.js.udiff.html" target="_top">next &gt;</a></center>    <h2>make/common/ZipArchive.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  #
<span class="udiff-line-modified-removed">- # Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+ # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  #
  # This code is free software; you can redistribute it and/or modify it
  # under the terms of the GNU General Public License version 2 only, as
  # published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,27 +46,37 @@</span>
  #                      and not directories.
  #   EXCLUDE_PATTERNS_$dir - Exclude patterns just like above but specific to one
  #                           src dir
  #   SUFFIXES
  #   EXTRA_DEPS
<span class="udiff-line-added">+ #   FOLLOW_SYMLINKS - Set to explicitly follow symlinks. Affects performance of</span>
<span class="udiff-line-added">+ #                     finding files.</span>
  #   ZIP_OPTIONS extra options to pass to zip
  SetupZipArchive = $(NamedParamsMacroTemplate)
  define SetupZipArchiveBody
  
<span class="udiff-line-added">+   # Create a version $1_SRC with a guaranteed trailing slash</span>
<span class="udiff-line-added">+   $1_SRC_SLASH := $$(addsuffix /, $$(patsubst %/, %, $$($1_SRC)))</span>
<span class="udiff-line-added">+ </span>
    # To avoid running find over too large sets of files, which causes make to crash
    # on some configurations (cygwin), use INCLUDES and INCLUDE_FILES to build a set
    # of directories to run find in, if available.
    ifneq ($$($1_INCLUDES)$$($1_INCLUDE_FILES),)
<span class="udiff-line-modified-removed">-     $1_FIND_LIST := $$(wildcard $$(foreach i,$$($1_SRC), \</span>
<span class="udiff-line-modified-removed">-         $$(addprefix $$i/,$$($1_INCLUDES) $$($1_INCLUDE_FILES))))</span>
<span class="udiff-line-modified-added">+     $1_FIND_LIST := $$(wildcard $$(foreach s,$$($1_SRC_SLASH), \</span>
<span class="udiff-line-modified-added">+         $$(addprefix $$s,$$($1_INCLUDES) $$($1_INCLUDE_FILES))))</span>
    else
<span class="udiff-line-modified-removed">-     $1_FIND_LIST := $$($1_SRC)</span>
<span class="udiff-line-modified-added">+     $1_FIND_LIST := $$($1_SRC_SLASH)</span>
    endif
  
<span class="udiff-line-modified-removed">-   # Find all files in the source tree. Follow symlinks in this find since that is</span>
<span class="udiff-line-modified-removed">-   # what zip does.</span>
<span class="udiff-line-modified-removed">-   $1_ALL_SRCS := $$(call not-containing,_the.,$$(call CacheFind,$$($1_FIND_LIST), , -L))</span>
<span class="udiff-line-modified-added">+   # Find all files in the source tree.</span>
<span class="udiff-line-modified-added">+   # If asked to, follow symlinks in this find since that is what zip does. To do</span>
<span class="udiff-line-modified-added">+   # this, we need to call ShellFindFiles directly.</span>
<span class="udiff-line-added">+   ifeq ($$($1_FOLLOW_SYMLINKS), true)</span>
<span class="udiff-line-added">+     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call ShellFindFiles,$$($1_FIND_LIST), , -L))</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     $1_ALL_SRCS := $$(call not-containing,_the.,$$(call FindFiles,$$($1_FIND_LIST)))</span>
<span class="udiff-line-added">+   endif</span>
  
    # Filter on suffixes if set
    ifneq ($$($1_SUFFIXES),)
      $1_ALL_SRCS := $$(filter $$(addprefix %, $$($1_SUFFIXES)), $$($1_ALL_SRCS))
    endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,28 +97,28 @@</span>
    ifneq ($$($1_INCLUDE_FILES),)
      $1_ZIP_INCLUDES += $$(addprefix -i$(SPACE),$$($1_INCLUDE_FILES))
    endif
    ifneq ($$($1_EXCLUDES),)
      $1_ZIP_EXCLUDES := $$(addprefix -x$(SPACE)$(DQUOTE),$$(addsuffix /*$(DQUOTE),$$($1_EXCLUDES)))
<span class="udiff-line-modified-removed">-     $1_SRC_EXCLUDES := $$(foreach i,$$($1_SRC),$$(addprefix $$i/,$$(addsuffix /%,$$($1_EXCLUDES))))</span>
<span class="udiff-line-modified-added">+     $1_SRC_EXCLUDES := $$(foreach s,$$($1_SRC_SLASH),$$(addprefix $$s,$$(addsuffix /%,$$($1_EXCLUDES))))</span>
      $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDES),$$($1_ALL_SRCS))
    endif
    ifneq ($$($1_EXCLUDE_FILES),)
      $1_SRC_EXCLUDE_FILES := $$(addprefix %, $$($1_EXCLUDE_FILES)) $$($1_EXCLUDE_FILES)
      $1_ALL_SRCS := $$(filter-out $$($1_SRC_EXCLUDE_FILES), $$($1_ALL_SRCS))
<span class="udiff-line-modified-removed">-     $$(foreach s, $$($1_SRC), \</span>
<span class="udiff-line-modified-added">+     $$(foreach s, $$($1_SRC_SLASH), \</span>
        $$(eval $1_ZIP_EXCLUDES_$$s += \
<span class="udiff-line-modified-removed">-           $$(addprefix -x$$(SPACE), $$(patsubst $$s/%,%, $$($1_EXCLUDE_FILES))) \</span>
<span class="udiff-line-modified-added">+           $$(addprefix -x$$(SPACE), $$(patsubst $$s%,%, $$($1_EXCLUDE_FILES))) \</span>
        ) \
      )
    endif
    ifneq ($$($1_EXCLUDE_PATTERNS), )
      $1_ALL_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERNS), $$($1_ALL_SRCS))
      $1_ZIP_EXCLUDES += $$(addprefix -x$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS)))
    endif
    # Rewrite src dir specific exclude patterns to zip excludes
<span class="udiff-line-modified-removed">-   $$(foreach s, $$($1_SRC), \</span>
<span class="udiff-line-modified-added">+   $$(foreach s, $$($1_SRC_SLASH), \</span>
      $$(if $$($1_EXCLUDE_PATTERNS_$$s), \
        $$(eval $1_ZIP_EXCLUDES_$$s += \
            $$(addprefix -x$$(SPACE), $$(subst %,\*,$$($1_EXCLUDE_PATTERNS_$$s))) \
        ) \
      ) \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,11 +135,30 @@</span>
    # If zip has nothing to do, it returns 12 and would fail the build. Check for 12
    # and only fail if it&#39;s not.
    $$($1_ZIP) : $$($1_ALL_SRCS) $$($1_EXTRA_DEPS)
  	$$(call LogWarn, Updating $$($1_NAME))
  	$$(call MakeTargetDir)
<span class="udiff-line-modified-removed">- 	$$(foreach s,$$($1_SRC), $$(call ExecuteWithLog, \</span>
<span class="udiff-line-modified-added">+         # Find duplicate file names in the SRC and generate excludes for all</span>
<span class="udiff-line-added">+         # instances that should not be included. Run this rather expensive</span>
<span class="udiff-line-added">+         # calculation as part of the recipe to avoid running it when nothing</span>
<span class="udiff-line-added">+         # needs to be rebuilt. The drawback is that we cannot exclude these</span>
<span class="udiff-line-added">+         # files from the make prerequisites list, but the number of files is</span>
<span class="udiff-line-added">+         # usually small so a very rare unnecessary rebuild is worth it.</span>
<span class="udiff-line-added">+         # (The inner most foreach here is used instead of eval to declare a</span>
<span class="udiff-line-added">+         # local variable.)</span>
<span class="udiff-line-added">+ 	$$(foreach root, $$($1_SRC_SLASH), \</span>
<span class="udiff-line-added">+ 	  $$(foreach file, $$(filter $$(root)%, $$($1_ALL_SRCS)), \</span>
<span class="udiff-line-added">+ 	    $$(foreach relfile, $$(patsubst $$(root)%, %, $$(file)), \</span>
<span class="udiff-line-added">+ 	      $$(if $$($1_relfiles_$$(call DoubleDollar, $$(relfile))), \</span>
<span class="udiff-line-added">+ 	        $$(eval $1_ZIP_EXCLUDES_$$(root) += -x $$(relfile)) \</span>
<span class="udiff-line-added">+ 	      , \</span>
<span class="udiff-line-added">+ 	        $$(eval $1_relfiles_$$(call DoubleDollar, $$(relfile)) := 1) \</span>
<span class="udiff-line-added">+ 	      ) \</span>
<span class="udiff-line-added">+ 	    ) \</span>
<span class="udiff-line-added">+ 	  ) \</span>
<span class="udiff-line-added">+ 	)</span>
<span class="udiff-line-added">+ 	$$(foreach s,$$($1_SRC_SLASH), $$(call ExecuteWithLog, \</span>
  	    $$(SUPPORT_OUTPUTDIR)/zip/$$(patsubst $$(OUTPUTDIR)/%,%, $$@), \
  	    (cd $$s &amp;&amp; $(ZIPEXE) -qru $$($1_ZIP_OPTIONS) $$@ . \
  	        $$($1_ZIP_INCLUDES) $$($1_ZIP_EXCLUDES) -x \*_the.\* \
  	        $$($1_ZIP_EXCLUDES_$$s) \
  	        || test &quot;$$$$?&quot; = &quot;12&quot; \
</pre>
<center><a href="Utils.gmk.udiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../conf/jib-profiles.js.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>