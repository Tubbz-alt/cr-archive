<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/conf/jib-profiles.js</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="../common/ZipArchive.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/conf/jib-profiles.js</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 230  * @param input External data to use for generating the configuration
 231  * @returns Common values
 232  */
 233 var getJibProfilesCommon = function (input, data) {
 234     var common = {};
 235 
 236     common.organization = &quot;jpg.infra.builddeps&quot;;
 237     common.build_id = getBuildId(input);
 238     common.build_number = input.build_number != null ? input.build_number : &quot;0&quot;;
 239 
 240     // List of the main profile names used for iteration
 241     common.main_profile_names = [
 242         &quot;linux-x64&quot;, &quot;linux-x86&quot;, &quot;macosx-x64&quot;, &quot;solaris-x64&quot;,
 243         &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;, &quot;windows-x86&quot;,
 244         &quot;linux-aarch64&quot;, &quot;linux-arm32&quot;, &quot;linux-ppc64le&quot;, &quot;linux-s390x&quot;
 245     ];
 246 
 247     // These are the base setttings for all the main build profiles.
 248     common.main_profile_base = {
 249         dependencies: [&quot;boot_jdk&quot;, &quot;gnumake&quot;, &quot;jtreg&quot;, &quot;jib&quot;, &quot;autoconf&quot;, &quot;jmh&quot;, &quot;jcov&quot;],
<span class="line-modified"> 250         default_make_targets: [&quot;product-bundles&quot;, &quot;test-bundles&quot;],</span>
 251         configure_args: concat([&quot;--enable-jtreg-failure-handler&quot;],
 252             &quot;--with-exclude-translations=de,es,fr,it,ko,pt_BR,sv,ca,tr,cs,sk,ja_JP_A,ja_JP_HA,ja_JP_HI,ja_JP_I,zh_TW,zh_HK&quot;,
 253             &quot;--disable-manpages&quot;,
 254             &quot;--with-jvm-features=-shenandoahgc&quot;,
 255             versionArgs(input, common))
 256     };
 257     // Extra settings for debug profiles
 258     common.debug_suffix = &quot;-debug&quot;;
 259     common.debug_profile_base = {
 260         configure_args: [&quot;--enable-debug&quot;],
 261         labels: &quot;debug&quot;
 262     };
 263     // Extra settings for slowdebug profiles
 264     common.slowdebug_suffix = &quot;-slowdebug&quot;;
 265     common.slowdebug_profile_base = {
 266         configure_args: [&quot;--with-debug-level=slowdebug&quot;],
 267         labels: &quot;slowdebug&quot;
 268     };
 269     // Extra settings for openjdk only profiles
 270     common.open_suffix = &quot;-open&quot;;
</pre>
<hr />
<pre>
 303                     ],
 304                     exploded: &quot;images/test&quot;
 305                 },
 306                 test_demos: {
 307                     local: &quot;bundles/\\(jdk.*bin-tests-demos.tar.gz\\)&quot;,
 308                     remote: [
 309                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-demos.tar.gz&quot;,
 310                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 311                     ],
 312                     exploded: &quot;images/test&quot;
 313                 },
 314                 jdk_symbols: {
 315                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 316                     remote: [
 317                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-symbols.tar.gz&quot;,
 318                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 319                     ],
 320                     subdir: jdk_subdir,
 321                     exploded: &quot;images/jdk&quot;
 322                 },








 323             }
 324         };
 325     };
 326 
 327 
 328     /**
 329      * Define common artifacts template for all debug profiles
 330      * @param o - Object containing data for artifacts
 331      */
 332     common.debug_profile_artifacts = function (o) {
 333         var jdk_subdir = &quot;jdk-&quot; + data.version + &quot;/fastdebug&quot;;
 334         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 335         var pf = o.platform
 336         return {
 337             artifacts: {
 338                 jdk: {
 339                     local: &quot;bundles/\\(jdk.*bin-debug.&quot; + jdk_suffix + &quot;\\)&quot;,
 340                     remote: [
 341                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug.&quot; + jdk_suffix,
 342                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
</pre>
<hr />
<pre>
 344                     subdir: jdk_subdir,
 345                     exploded: &quot;images/jdk&quot;
 346                 },
 347                 test: {
 348                     local: &quot;bundles/\\(jdk.*bin-tests-debug.tar.gz\\)&quot;,
 349                     remote: [
 350                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-debug.tar.gz&quot;,
 351                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 352                     ],
 353                     exploded: &quot;images/test&quot;
 354                 },
 355                 jdk_symbols: {
 356                     local: &quot;bundles/\\(jdk.*bin-debug-symbols.tar.gz\\)&quot;,
 357                     remote: [
 358                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug-symbols.tar.gz&quot;,
 359                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 360                     ],
 361                     subdir: jdk_subdir,
 362                     exploded: &quot;images/jdk&quot;
 363                 },








 364             }
 365         };
 366     };
 367 
<span class="line-modified"> 368     common.boot_jdk_version = &quot;11&quot;;</span>

 369     common.boot_jdk_home = input.get(&quot;boot_jdk&quot;, &quot;install_path&quot;) + &quot;/jdk-&quot;
 370         + common.boot_jdk_version
 371         + (input.build_os == &quot;macosx&quot; ? &quot;.jdk/Contents/Home&quot; : &quot;&quot;);
 372 
 373     return common;
 374 };
 375 
 376 /**
 377  * Generates the profiles part of the configuration.
 378  *
 379  * @param input External data to use for generating the configuration
 380  * @param common The common values
 381  * @returns {{}} Profiles part of the configuration
 382  */
 383 var getJibProfilesProfiles = function (input, common, data) {
 384     // Main SE profiles
 385     var profiles = {
 386 
 387         &quot;linux-x64&quot;: {
 388             target_os: &quot;linux&quot;,
</pre>
<hr />
<pre>
 400             target_cpu: &quot;x86&quot;,
 401             build_cpu: &quot;x64&quot;,
 402             dependencies: [&quot;devkit&quot;],
 403             configure_args: concat(common.configure_args_32bit,
 404                 &quot;--with-jvm-variants=minimal,server&quot;, &quot;--with-zlib=system&quot;),
 405         },
 406 
 407         &quot;macosx-x64&quot;: {
 408             target_os: &quot;macosx&quot;,
 409             target_cpu: &quot;x64&quot;,
 410             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 411             configure_args: concat(common.configure_args_64bit, &quot;--with-zlib=system&quot;,
 412                 &quot;--with-macosx-version-max=10.9.0&quot;),
 413         },
 414 
 415         &quot;solaris-x64&quot;: {
 416             target_os: &quot;solaris&quot;,
 417             target_cpu: &quot;x64&quot;,
 418             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 419             configure_args: concat(common.configure_args_64bit,
<span class="line-modified"> 420                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;),</span>
 421         },
 422 
 423         &quot;solaris-sparcv9&quot;: {
 424             target_os: &quot;solaris&quot;,
 425             target_cpu: &quot;sparcv9&quot;,
 426             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 427             configure_args: concat(common.configure_args_64bit,
<span class="line-modified"> 428                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;),</span>
 429         },
 430 
 431         &quot;windows-x64&quot;: {
 432             target_os: &quot;windows&quot;,
 433             target_cpu: &quot;x64&quot;,
 434             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 435             configure_args: concat(common.configure_args_64bit),
 436         },
 437 
 438         &quot;windows-x86&quot;: {
 439             target_os: &quot;windows&quot;,
 440             target_cpu: &quot;x86&quot;,
 441             build_cpu: &quot;x64&quot;,
 442             dependencies: [&quot;devkit&quot;],
 443             configure_args: concat(common.configure_args_32bit),
 444         },
 445 
 446         &quot;linux-aarch64&quot;: {
 447             target_os: &quot;linux&quot;,
 448             target_cpu: &quot;aarch64&quot;,
</pre>
<hr />
<pre>
 737 
 738     // For open profiles, the non-debug jdk bundles, need an &quot;open&quot; prefix on the
 739     // remote bundle names, forming the word &quot;openjdk&quot;. See JDK-8188789.
 740     common.main_profile_names.forEach(function (name) {
 741         var openName = name + common.open_suffix;
 742         profiles[openName].artifacts[&quot;jdk&quot;].remote = replaceAll(
 743             &quot;\/jdk-&quot;, &quot;/openjdk-&quot;,
 744             replaceAll(&quot;\/\\1&quot;, &quot;/open\\1&quot;,
 745                        profiles[openName].artifacts[&quot;jdk&quot;].remote));
 746     });
 747 
 748     // Generate cmp-baseline profiles for each main profile and their
 749     // corresponding debug profile. This profile does a compare build run with no
 750     // changes to verify that the compare script has a clean baseline
 751     common.main_profile_names.forEach(function (name) {
 752         [ &quot;&quot;, common.open_suffix ].forEach(function (suffix) {
 753             var cmpBaselineName = name + suffix + &quot;-cmp-baseline&quot;;
 754             profiles[cmpBaselineName] = clone(profiles[name + suffix]);
 755             // Only compare the images target. This should pressumably be expanded
 756             // to include more build targets when possible.
<span class="line-modified"> 757             profiles[cmpBaselineName].default_make_targets = [ &quot;images&quot; ];</span>




 758             profiles[cmpBaselineName].make_args = [ &quot;COMPARE_BUILD=CONF=&quot; ];
 759             // Do not inherit artifact definitions from base profile
 760             delete profiles[cmpBaselineName].artifacts;
 761         });
 762     });
 763 
 764     // Artifacts of JCov profiles
 765     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 766         .forEach(function (name) {
 767             var o = artifactData[name]
 768             var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 769             var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 770             var pf = o.platform
 771             var jcovName = name + &quot;-jcov&quot;;
 772             profiles[jcovName].artifacts = {
 773                 jdk: {
 774                     local: &quot;bundles/\\(jdk-jcov.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 775                     remote: [
 776                         &quot;bundles/&quot; + pf + &quot;/jdk-jcov-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix
 777                     ],
</pre>
<hr />
<pre>
 817 
 818     // Profiles used to run tests.
 819     var testOnlyProfiles = {
 820         &quot;run-test&quot;: {
 821             target_os: input.build_os,
 822             target_cpu: input.build_cpu,
 823             dependencies: [ &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot; ],
 824             labels: &quot;test&quot;,
 825             environment: {
 826                 &quot;JT_JAVA&quot;: common.boot_jdk_home
 827             }
 828         }
 829     };
 830     profiles = concatObjects(profiles, testOnlyProfiles);
 831 
 832     // Profiles used to run tests using Jib for internal dependencies.
 833     var testedProfile = input.testedProfile;
 834     if (testedProfile == null) {
 835         testedProfile = input.build_os + &quot;-&quot; + input.build_cpu;
 836     }
<span class="line-modified"> 837     var testedProfileJDK = testedProfile + &quot;.jdk&quot;;</span>
<span class="line-modified"> 838     var testedProfileTest = &quot;&quot;</span>
<span class="line-modified"> 839     if (testedProfile.endsWith(&quot;-jcov&quot;)) {</span>
<span class="line-modified"> 840         testedProfileTest = testedProfile.substring(0, testedProfile.length - &quot;-jcov&quot;.length) + &quot;.test&quot;;</span>



 841     } else {
<span class="line-modified"> 842         testedProfileTest = testedProfile + &quot;.test&quot;;</span>
 843     }
<span class="line-modified"> 844     var testOnlyMake = [ &quot;run-test-prebuilt&quot;, &quot;LOG_CMDLINES=true&quot;, &quot;JTREG_VERBOSE=fail,error,time&quot; ];</span>

 845     if (testedProfile.endsWith(&quot;-gcov&quot;)) {
 846         testOnlyMake = concat(testOnlyMake, &quot;GCOV_ENABLED=true&quot;)
 847     }
 848     var testOnlyProfilesPrebuilt = {
 849         &quot;run-test-prebuilt&quot;: {
 850             target_os: input.build_os,
 851             target_cpu: input.build_cpu,
 852             dependencies: [
<span class="line-modified"> 853                 &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot;, &quot;jcov&quot;, testedProfileJDK,</span>
 854                 testedProfileTest
 855             ],
 856             src: &quot;src.conf&quot;,
 857             make_args: testOnlyMake,
 858             environment: {
 859                 &quot;BOOT_JDK&quot;: common.boot_jdk_home,
<span class="line-modified"> 860                 &quot;JDK_IMAGE_DIR&quot;: input.get(testedProfileJDK, &quot;home_path&quot;),</span>
 861                 &quot;TEST_IMAGE_DIR&quot;: input.get(testedProfileTest, &quot;home_path&quot;)
 862             },
 863             labels: &quot;test&quot;
 864         }
 865     };
 866 
 867     // If actually running the run-test-prebuilt profile, verify that the input
 868     // variable is valid and if so, add the appropriate target_* values from
<span class="line-modified"> 869     // the tested profile.</span>
 870     if (input.profile == &quot;run-test-prebuilt&quot;) {
<span class="line-modified"> 871         if (profiles[testedProfile] == null) {</span>
<span class="line-modified"> 872             error(&quot;testedProfile is not defined: &quot; + testedProfile);</span>
 873         }
 874     }
 875     if (profiles[testedProfile] != null) {
 876         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 877             = profiles[testedProfile][&quot;target_os&quot;];
 878         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 879             = profiles[testedProfile][&quot;target_cpu&quot;];





 880     }
 881     profiles = concatObjects(profiles, testOnlyProfilesPrebuilt);
 882 
 883     // On macosx add the devkit bin dir to the path in all the run-test profiles.
 884     // This gives us a guaranteed working version of lldb for the jtreg failure handler.
 885     if (input.build_os == &quot;macosx&quot;) {
 886         macosxRunTestExtra = {
 887             environment_path: input.get(&quot;devkit&quot;, &quot;install_path&quot;)
 888                 + &quot;/Xcode.app/Contents/Developer/usr/bin&quot;
 889         };
 890         profiles[&quot;run-test&quot;] = concatObjects(profiles[&quot;run-test&quot;], macosxRunTestExtra);
 891         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;], macosxRunTestExtra);
 892     }
 893     // On windows we want the debug symbols available at test time
 894     if (input.build_os == &quot;windows&quot;) {
 895         windowsRunTestPrebuiltExtra = {
 896             dependencies: [ testedProfile + &quot;.jdk_symbols&quot; ],
 897             environment: {
 898                 &quot;SYMBOLS_IMAGE_DIR&quot;: input.get(testedProfile + &quot;.jdk_symbols&quot;, &quot;home_path&quot;),
 899             }
</pre>
<hr />
<pre>
 922         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 923             runTestPrebuiltSrcFullExtra);
 924     }
 925 
 926     // Generate the missing platform attributes
 927     profiles = generatePlatformAttributes(profiles);
 928     profiles = generateDefaultMakeTargetsConfigureArg(common, profiles);
 929     return profiles;
 930 };
 931 
 932 /**
 933  * Generate the dependencies part of the configuration
 934  *
 935  * @param input External data to use for generating the configuration
 936  * @param common The common values
 937  * @returns {{}} Dependencies part of configuration
 938  */
 939 var getJibProfilesDependencies = function (input, common) {
 940 
 941     var devkit_platform_revisions = {
<span class="line-modified"> 942         linux_x64: &quot;gcc7.3.0-OEL6.4+1.2&quot;,</span>
 943         macosx_x64: &quot;Xcode10.1-MacOSX10.14+1.0&quot;,
 944         solaris_x64: &quot;SS12u4-Solaris11u1+1.0&quot;,
 945         solaris_sparcv9: &quot;SS12u6-Solaris11u3+1.0&quot;,
<span class="line-modified"> 946         windows_x64: &quot;VS2017-15.9.6+1.0&quot;,</span>
<span class="line-modified"> 947         linux_aarch64: &quot;gcc7.3.0-Fedora27+1.2&quot;,</span>
<span class="line-modified"> 948         linux_arm: &quot;gcc7.3.0-Fedora27+1.2&quot;,</span>
<span class="line-modified"> 949         linux_ppc64le: &quot;gcc7.3.0-Fedora27+1.0&quot;,</span>
<span class="line-modified"> 950         linux_s390x: &quot;gcc7.3.0-Fedora27+1.0&quot;</span>
 951     };
 952 
 953     var devkit_platform = (input.target_cpu == &quot;x86&quot;
 954         ? input.target_os + &quot;_x64&quot;
 955         : input.target_platform);
 956 






 957     var boot_jdk_platform = (input.build_os == &quot;macosx&quot; ? &quot;osx&quot; : input.build_os)
 958         + &quot;-&quot; + input.build_cpu;
 959     var boot_jdk_ext = (input.build_os == &quot;windows&quot; ? &quot;.zip&quot; : &quot;.tar.gz&quot;)
 960     // If running in WSL and building for Windows, it will look like Linux,
 961     // but we need a Windows boot JDK.
 962     if (isWsl(input) &amp;&amp; input.target_os == &quot;windows&quot;) {
 963         boot_jdk_platform = &quot;windows-&quot; + input.build_cpu;
 964         boot_jdk_ext = &quot;.zip&quot;;
 965     }
 966 
 967     var makeBinDir = (input.build_os == &quot;windows&quot;
 968         ? input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/cygwin/bin&quot;
 969         : input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/bin&quot;);
 970 
<span class="line-modified"> 971     var dependencies = {</span>
<span class="line-modified"> 972 </span>
<span class="line-modified"> 973         boot_jdk: {</span>








 974             server: &quot;jpg&quot;,
 975             product: &quot;jdk&quot;,
 976             version: common.boot_jdk_version,
<span class="line-modified"> 977             build_number: &quot;28&quot;,</span>
 978             file: &quot;bundles/&quot; + boot_jdk_platform + &quot;/jdk-&quot; + common.boot_jdk_version + &quot;_&quot;
 979                 + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext,
 980             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
 981             environment_path: common.boot_jdk_home + &quot;/bin&quot;
<span class="line-modified"> 982         },</span>




 983 
 984         devkit: {
 985             organization: common.organization,
 986             ext: &quot;tar.gz&quot;,
<span class="line-modified"> 987             module: &quot;devkit-&quot; + devkit_platform,</span>
 988             revision: devkit_platform_revisions[devkit_platform],
 989             environment: {
 990                 &quot;DEVKIT_HOME&quot;: input.get(&quot;devkit&quot;, &quot;home_path&quot;),
 991             }
 992         },
 993 
 994         build_devkit: {
 995             organization: common.organization,
 996             ext: &quot;tar.gz&quot;,
 997             module: &quot;devkit-&quot; + input.build_platform,
 998             revision: devkit_platform_revisions[input.build_platform]
 999         },
1000 
1001         cups: {
1002             organization: common.organization,
1003             ext: &quot;tar.gz&quot;,
1004             revision: &quot;1.0118+1.0&quot;
1005         },
1006 
1007         jtreg: {
1008             server: &quot;javare&quot;,
1009             revision: &quot;4.2&quot;,
<span class="line-modified">1010             build_number: &quot;b14&quot;,</span>
1011             checksum_file: &quot;MD5_VALUES&quot;,
1012             file: &quot;jtreg_bin-4.2.zip&quot;,
1013             environment_name: &quot;JT_HOME&quot;,
1014             environment_path: input.get(&quot;jtreg&quot;, &quot;install_path&quot;) + &quot;/jtreg/bin&quot;
1015         },
1016 
1017         jmh: {
1018             organization: common.organization,
1019             ext: &quot;tar.gz&quot;,
1020             revision: &quot;1.21+1.0&quot;
1021         },
1022 
1023         jcov: {
1024             // Until an official build of JCov is available, use custom
1025             // build to support classfile version 57.
1026             // See CODETOOLS-7902358 for more info.
1027             // server: &quot;jpg&quot;,
1028             // product: &quot;jcov&quot;,
1029             // version: &quot;3.0&quot;,
1030             // build_number: &quot;b07&quot;,
1031             // file: &quot;bundles/jcov-3_0.zip&quot;,
1032             organization: common.organization,
<span class="line-modified">1033             revision: &quot;3.0-57-support+1.0&quot;,</span>
1034             ext: &quot;zip&quot;,
1035             environment_name: &quot;JCOV_HOME&quot;,
1036         },
1037 
1038         gnumake: {
1039             organization: common.organization,
1040             ext: &quot;tar.gz&quot;,
1041             revision: &quot;4.0+1.0&quot;,
1042 
1043             module: (input.build_os == &quot;windows&quot;
1044                 ? &quot;gnumake-&quot; + input.build_osenv_platform
1045                 : &quot;gnumake-&quot; + input.build_platform),
1046 
1047             configure_args: &quot;MAKE=&quot; + makeBinDir + &quot;/make&quot;,
1048 
1049             environment: {
1050                 &quot;MAKE&quot;: makeBinDir + &quot;/make&quot;
1051             },
1052 
1053             environment_path: makeBinDir
</pre>
<hr />
<pre>
1255         }
1256     }
1257     return ret;
1258 };
1259 
1260 /**
1261  * Constructs the numeric version string from reading the
1262  * make/autoconf/version-numbers file and removing all trailing &quot;.0&quot;.
1263  *
1264  * @param feature Override feature version
1265  * @param interim Override interim version
1266  * @param update Override update version
1267  * @param patch Override patch version
1268  * @returns {String} The numeric version string
1269  */
1270 var getVersion = function (feature, interim, update, patch) {
1271     var version_numbers = getVersionNumbers();
1272     var version = (feature != null ? feature : version_numbers.get(&quot;DEFAULT_VERSION_FEATURE&quot;))
1273         + &quot;.&quot; + (interim != null ? interim : version_numbers.get(&quot;DEFAULT_VERSION_INTERIM&quot;))
1274         + &quot;.&quot; + (update != null ? update :  version_numbers.get(&quot;DEFAULT_VERSION_UPDATE&quot;))
<span class="line-modified">1275         + &quot;.&quot; + (patch != null ? patch : version_numbers.get(&quot;DEFAULT_VERSION_PATCH&quot;));</span>



1276     while (version.match(&quot;.*\\.0$&quot;)) {
1277         version = version.substring(0, version.length - 2);
1278     }
1279     return version;
1280 };
1281 
1282 /**
1283  * Constructs the common version configure args based on build type and
1284  * other version inputs
1285  */
1286 var versionArgs = function(input, common) {
1287     var args = [&quot;--with-version-build=&quot; + common.build_number];
1288     if (input.build_type == &quot;promoted&quot;) {
1289         args = concat(args,
<span class="line-modified">1290                       // This needs to be changed when we start building release candidates</span>
<span class="line-removed">1291                       // with-version-pre must be set to ea for &#39;ea&#39; and empty for fcs build</span>
<span class="line-removed">1292                       &quot;--with-version-pre=ea&quot;,</span>
1293                       &quot;--without-version-opt&quot;);








1294     } else {
1295         args = concat(args, &quot;--with-version-opt=&quot; + common.build_id);
1296     }
1297     return args;
1298 }
1299 
1300 // Properties representation of the make/autoconf/version-numbers file. Lazily
1301 // initiated by the function below.
1302 var version_numbers;
1303 
1304 /**
1305  * Read the make/autoconf/version-numbers file into a Properties object.
1306  *
1307  * @returns {java.utilProperties}
1308  */
1309 var getVersionNumbers = function () {
1310     // Read version information from make/autoconf/version-numbers
1311     if (version_numbers == null) {
1312         version_numbers = new java.util.Properties();
1313         var stream = new java.io.FileInputStream(__DIR__ + &quot;/../autoconf/version-numbers&quot;);
1314         version_numbers.load(stream);
1315         stream.close();
1316     }
1317     return version_numbers;
1318 }
1319 
1320 /**
1321  * Returns true if running in Windows Subsystem for Linux. Jib does not yet
1322  * detect wsl as osenv, so fall back on linux with version containing Microsoft.
1323  */
1324 var isWsl = function (input) {
1325     return ( input.build_osenv == &quot;wsl&quot;
1326              || (input.build_os == &quot;linux&quot;
1327                  &amp;&amp; java.lang.System.getProperty(&quot;os.version&quot;).contains(&quot;Microsoft&quot;)));
1328 }





</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 230  * @param input External data to use for generating the configuration
 231  * @returns Common values
 232  */
 233 var getJibProfilesCommon = function (input, data) {
 234     var common = {};
 235 
 236     common.organization = &quot;jpg.infra.builddeps&quot;;
 237     common.build_id = getBuildId(input);
 238     common.build_number = input.build_number != null ? input.build_number : &quot;0&quot;;
 239 
 240     // List of the main profile names used for iteration
 241     common.main_profile_names = [
 242         &quot;linux-x64&quot;, &quot;linux-x86&quot;, &quot;macosx-x64&quot;, &quot;solaris-x64&quot;,
 243         &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;, &quot;windows-x86&quot;,
 244         &quot;linux-aarch64&quot;, &quot;linux-arm32&quot;, &quot;linux-ppc64le&quot;, &quot;linux-s390x&quot;
 245     ];
 246 
 247     // These are the base setttings for all the main build profiles.
 248     common.main_profile_base = {
 249         dependencies: [&quot;boot_jdk&quot;, &quot;gnumake&quot;, &quot;jtreg&quot;, &quot;jib&quot;, &quot;autoconf&quot;, &quot;jmh&quot;, &quot;jcov&quot;],
<span class="line-modified"> 250         default_make_targets: [&quot;product-bundles&quot;, &quot;test-bundles&quot;, &quot;static-libs-bundles&quot;],</span>
 251         configure_args: concat([&quot;--enable-jtreg-failure-handler&quot;],
 252             &quot;--with-exclude-translations=de,es,fr,it,ko,pt_BR,sv,ca,tr,cs,sk,ja_JP_A,ja_JP_HA,ja_JP_HI,ja_JP_I,zh_TW,zh_HK&quot;,
 253             &quot;--disable-manpages&quot;,
 254             &quot;--with-jvm-features=-shenandoahgc&quot;,
 255             versionArgs(input, common))
 256     };
 257     // Extra settings for debug profiles
 258     common.debug_suffix = &quot;-debug&quot;;
 259     common.debug_profile_base = {
 260         configure_args: [&quot;--enable-debug&quot;],
 261         labels: &quot;debug&quot;
 262     };
 263     // Extra settings for slowdebug profiles
 264     common.slowdebug_suffix = &quot;-slowdebug&quot;;
 265     common.slowdebug_profile_base = {
 266         configure_args: [&quot;--with-debug-level=slowdebug&quot;],
 267         labels: &quot;slowdebug&quot;
 268     };
 269     // Extra settings for openjdk only profiles
 270     common.open_suffix = &quot;-open&quot;;
</pre>
<hr />
<pre>
 303                     ],
 304                     exploded: &quot;images/test&quot;
 305                 },
 306                 test_demos: {
 307                     local: &quot;bundles/\\(jdk.*bin-tests-demos.tar.gz\\)&quot;,
 308                     remote: [
 309                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-demos.tar.gz&quot;,
 310                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 311                     ],
 312                     exploded: &quot;images/test&quot;
 313                 },
 314                 jdk_symbols: {
 315                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 316                     remote: [
 317                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-symbols.tar.gz&quot;,
 318                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 319                     ],
 320                     subdir: jdk_subdir,
 321                     exploded: &quot;images/jdk&quot;
 322                 },
<span class="line-added"> 323                 static_libs: {</span>
<span class="line-added"> 324                     local: &quot;bundles/\\(jdk.*bin-static-libs.tar.gz\\)&quot;,</span>
<span class="line-added"> 325                     remote: [</span>
<span class="line-added"> 326                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs.tar.gz&quot;,</span>
<span class="line-added"> 327                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;</span>
<span class="line-added"> 328                     ],</span>
<span class="line-added"> 329                     subdir: jdk_subdir,</span>
<span class="line-added"> 330                 },</span>
 331             }
 332         };
 333     };
 334 
 335 
 336     /**
 337      * Define common artifacts template for all debug profiles
 338      * @param o - Object containing data for artifacts
 339      */
 340     common.debug_profile_artifacts = function (o) {
 341         var jdk_subdir = &quot;jdk-&quot; + data.version + &quot;/fastdebug&quot;;
 342         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 343         var pf = o.platform
 344         return {
 345             artifacts: {
 346                 jdk: {
 347                     local: &quot;bundles/\\(jdk.*bin-debug.&quot; + jdk_suffix + &quot;\\)&quot;,
 348                     remote: [
 349                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug.&quot; + jdk_suffix,
 350                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
</pre>
<hr />
<pre>
 352                     subdir: jdk_subdir,
 353                     exploded: &quot;images/jdk&quot;
 354                 },
 355                 test: {
 356                     local: &quot;bundles/\\(jdk.*bin-tests-debug.tar.gz\\)&quot;,
 357                     remote: [
 358                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-debug.tar.gz&quot;,
 359                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 360                     ],
 361                     exploded: &quot;images/test&quot;
 362                 },
 363                 jdk_symbols: {
 364                     local: &quot;bundles/\\(jdk.*bin-debug-symbols.tar.gz\\)&quot;,
 365                     remote: [
 366                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug-symbols.tar.gz&quot;,
 367                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 368                     ],
 369                     subdir: jdk_subdir,
 370                     exploded: &quot;images/jdk&quot;
 371                 },
<span class="line-added"> 372                 static_libs: {</span>
<span class="line-added"> 373                     local: &quot;bundles/\\(jdk.*bin-static-libs-debug.tar.gz\\)&quot;,</span>
<span class="line-added"> 374                     remote: [</span>
<span class="line-added"> 375                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs-debug.tar.gz&quot;,</span>
<span class="line-added"> 376                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;</span>
<span class="line-added"> 377                     ],</span>
<span class="line-added"> 378                     subdir: jdk_subdir,</span>
<span class="line-added"> 379                 },</span>
 380             }
 381         };
 382     };
 383 
<span class="line-modified"> 384     common.boot_jdk_version = &quot;13&quot;;</span>
<span class="line-added"> 385     common.boot_jdk_build_number = &quot;33&quot;;</span>
 386     common.boot_jdk_home = input.get(&quot;boot_jdk&quot;, &quot;install_path&quot;) + &quot;/jdk-&quot;
 387         + common.boot_jdk_version
 388         + (input.build_os == &quot;macosx&quot; ? &quot;.jdk/Contents/Home&quot; : &quot;&quot;);
 389 
 390     return common;
 391 };
 392 
 393 /**
 394  * Generates the profiles part of the configuration.
 395  *
 396  * @param input External data to use for generating the configuration
 397  * @param common The common values
 398  * @returns {{}} Profiles part of the configuration
 399  */
 400 var getJibProfilesProfiles = function (input, common, data) {
 401     // Main SE profiles
 402     var profiles = {
 403 
 404         &quot;linux-x64&quot;: {
 405             target_os: &quot;linux&quot;,
</pre>
<hr />
<pre>
 417             target_cpu: &quot;x86&quot;,
 418             build_cpu: &quot;x64&quot;,
 419             dependencies: [&quot;devkit&quot;],
 420             configure_args: concat(common.configure_args_32bit,
 421                 &quot;--with-jvm-variants=minimal,server&quot;, &quot;--with-zlib=system&quot;),
 422         },
 423 
 424         &quot;macosx-x64&quot;: {
 425             target_os: &quot;macosx&quot;,
 426             target_cpu: &quot;x64&quot;,
 427             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 428             configure_args: concat(common.configure_args_64bit, &quot;--with-zlib=system&quot;,
 429                 &quot;--with-macosx-version-max=10.9.0&quot;),
 430         },
 431 
 432         &quot;solaris-x64&quot;: {
 433             target_os: &quot;solaris&quot;,
 434             target_cpu: &quot;x64&quot;,
 435             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 436             configure_args: concat(common.configure_args_64bit,
<span class="line-modified"> 437                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),</span>
 438         },
 439 
 440         &quot;solaris-sparcv9&quot;: {
 441             target_os: &quot;solaris&quot;,
 442             target_cpu: &quot;sparcv9&quot;,
 443             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 444             configure_args: concat(common.configure_args_64bit,
<span class="line-modified"> 445                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),</span>
 446         },
 447 
 448         &quot;windows-x64&quot;: {
 449             target_os: &quot;windows&quot;,
 450             target_cpu: &quot;x64&quot;,
 451             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 452             configure_args: concat(common.configure_args_64bit),
 453         },
 454 
 455         &quot;windows-x86&quot;: {
 456             target_os: &quot;windows&quot;,
 457             target_cpu: &quot;x86&quot;,
 458             build_cpu: &quot;x64&quot;,
 459             dependencies: [&quot;devkit&quot;],
 460             configure_args: concat(common.configure_args_32bit),
 461         },
 462 
 463         &quot;linux-aarch64&quot;: {
 464             target_os: &quot;linux&quot;,
 465             target_cpu: &quot;aarch64&quot;,
</pre>
<hr />
<pre>
 754 
 755     // For open profiles, the non-debug jdk bundles, need an &quot;open&quot; prefix on the
 756     // remote bundle names, forming the word &quot;openjdk&quot;. See JDK-8188789.
 757     common.main_profile_names.forEach(function (name) {
 758         var openName = name + common.open_suffix;
 759         profiles[openName].artifacts[&quot;jdk&quot;].remote = replaceAll(
 760             &quot;\/jdk-&quot;, &quot;/openjdk-&quot;,
 761             replaceAll(&quot;\/\\1&quot;, &quot;/open\\1&quot;,
 762                        profiles[openName].artifacts[&quot;jdk&quot;].remote));
 763     });
 764 
 765     // Generate cmp-baseline profiles for each main profile and their
 766     // corresponding debug profile. This profile does a compare build run with no
 767     // changes to verify that the compare script has a clean baseline
 768     common.main_profile_names.forEach(function (name) {
 769         [ &quot;&quot;, common.open_suffix ].forEach(function (suffix) {
 770             var cmpBaselineName = name + suffix + &quot;-cmp-baseline&quot;;
 771             profiles[cmpBaselineName] = clone(profiles[name + suffix]);
 772             // Only compare the images target. This should pressumably be expanded
 773             // to include more build targets when possible.
<span class="line-modified"> 774             profiles[cmpBaselineName].default_make_targets = [ &quot;images&quot;, &quot;test-image&quot; ];</span>
<span class="line-added"> 775             if (name == &quot;linux-x64&quot;) {</span>
<span class="line-added"> 776                 profiles[cmpBaselineName].default_make_targets</span>
<span class="line-added"> 777                     = concat(profiles[cmpBaselineName].default_make_targets, &quot;docs&quot;);</span>
<span class="line-added"> 778             }</span>
 779             profiles[cmpBaselineName].make_args = [ &quot;COMPARE_BUILD=CONF=&quot; ];
 780             // Do not inherit artifact definitions from base profile
 781             delete profiles[cmpBaselineName].artifacts;
 782         });
 783     });
 784 
 785     // Artifacts of JCov profiles
 786     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 787         .forEach(function (name) {
 788             var o = artifactData[name]
 789             var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 790             var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 791             var pf = o.platform
 792             var jcovName = name + &quot;-jcov&quot;;
 793             profiles[jcovName].artifacts = {
 794                 jdk: {
 795                     local: &quot;bundles/\\(jdk-jcov.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 796                     remote: [
 797                         &quot;bundles/&quot; + pf + &quot;/jdk-jcov-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix
 798                     ],
</pre>
<hr />
<pre>
 838 
 839     // Profiles used to run tests.
 840     var testOnlyProfiles = {
 841         &quot;run-test&quot;: {
 842             target_os: input.build_os,
 843             target_cpu: input.build_cpu,
 844             dependencies: [ &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot; ],
 845             labels: &quot;test&quot;,
 846             environment: {
 847                 &quot;JT_JAVA&quot;: common.boot_jdk_home
 848             }
 849         }
 850     };
 851     profiles = concatObjects(profiles, testOnlyProfiles);
 852 
 853     // Profiles used to run tests using Jib for internal dependencies.
 854     var testedProfile = input.testedProfile;
 855     if (testedProfile == null) {
 856         testedProfile = input.build_os + &quot;-&quot; + input.build_cpu;
 857     }
<span class="line-modified"> 858     var testedProfileJdk = testedProfile + &quot;.jdk&quot;;</span>
<span class="line-modified"> 859     // Make it possible to use the test image from a different profile</span>
<span class="line-modified"> 860     var testImageProfile;</span>
<span class="line-modified"> 861     if (input.testImageProfile != null) {</span>
<span class="line-added"> 862         testImageProfile = input.testImageProfile;</span>
<span class="line-added"> 863     } else if (testedProfile.endsWith(&quot;-jcov&quot;)) {</span>
<span class="line-added"> 864         testImageProfile = testedProfile.substring(0, testedProfile.length - &quot;-jcov&quot;.length);</span>
 865     } else {
<span class="line-modified"> 866         testImageProfile = testedProfile;</span>
 867     }
<span class="line-modified"> 868     var testedProfileTest = testImageProfile + &quot;.test&quot;</span>
<span class="line-added"> 869     var testOnlyMake = [ &quot;test-prebuilt&quot;, &quot;LOG_CMDLINES=true&quot;, &quot;JTREG_VERBOSE=fail,error,time&quot; ];</span>
 870     if (testedProfile.endsWith(&quot;-gcov&quot;)) {
 871         testOnlyMake = concat(testOnlyMake, &quot;GCOV_ENABLED=true&quot;)
 872     }
 873     var testOnlyProfilesPrebuilt = {
 874         &quot;run-test-prebuilt&quot;: {
 875             target_os: input.build_os,
 876             target_cpu: input.build_cpu,
 877             dependencies: [
<span class="line-modified"> 878                 &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot;, &quot;jcov&quot;, testedProfileJdk,</span>
 879                 testedProfileTest
 880             ],
 881             src: &quot;src.conf&quot;,
 882             make_args: testOnlyMake,
 883             environment: {
 884                 &quot;BOOT_JDK&quot;: common.boot_jdk_home,
<span class="line-modified"> 885                 &quot;JDK_IMAGE_DIR&quot;: input.get(testedProfileJdk, &quot;home_path&quot;),</span>
 886                 &quot;TEST_IMAGE_DIR&quot;: input.get(testedProfileTest, &quot;home_path&quot;)
 887             },
 888             labels: &quot;test&quot;
 889         }
 890     };
 891 
 892     // If actually running the run-test-prebuilt profile, verify that the input
 893     // variable is valid and if so, add the appropriate target_* values from
<span class="line-modified"> 894     // the tested profile. Use testImageProfile value as backup.</span>
 895     if (input.profile == &quot;run-test-prebuilt&quot;) {
<span class="line-modified"> 896         if (profiles[testedProfile] == null &amp;&amp; profiles[testImageProfile] == null) {</span>
<span class="line-modified"> 897             error(&quot;testedProfile is not defined: &quot; + testedProfile + &quot; &quot; + testImageProfile);</span>
 898         }
 899     }
 900     if (profiles[testedProfile] != null) {
 901         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 902             = profiles[testedProfile][&quot;target_os&quot;];
 903         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 904             = profiles[testedProfile][&quot;target_cpu&quot;];
<span class="line-added"> 905     } else if (profiles[testImageProfile] != null) {</span>
<span class="line-added"> 906         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]</span>
<span class="line-added"> 907             = profiles[testImageProfile][&quot;target_os&quot;];</span>
<span class="line-added"> 908         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]</span>
<span class="line-added"> 909             = profiles[testImageProfile][&quot;target_cpu&quot;];</span>
 910     }
 911     profiles = concatObjects(profiles, testOnlyProfilesPrebuilt);
 912 
 913     // On macosx add the devkit bin dir to the path in all the run-test profiles.
 914     // This gives us a guaranteed working version of lldb for the jtreg failure handler.
 915     if (input.build_os == &quot;macosx&quot;) {
 916         macosxRunTestExtra = {
 917             environment_path: input.get(&quot;devkit&quot;, &quot;install_path&quot;)
 918                 + &quot;/Xcode.app/Contents/Developer/usr/bin&quot;
 919         };
 920         profiles[&quot;run-test&quot;] = concatObjects(profiles[&quot;run-test&quot;], macosxRunTestExtra);
 921         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;], macosxRunTestExtra);
 922     }
 923     // On windows we want the debug symbols available at test time
 924     if (input.build_os == &quot;windows&quot;) {
 925         windowsRunTestPrebuiltExtra = {
 926             dependencies: [ testedProfile + &quot;.jdk_symbols&quot; ],
 927             environment: {
 928                 &quot;SYMBOLS_IMAGE_DIR&quot;: input.get(testedProfile + &quot;.jdk_symbols&quot;, &quot;home_path&quot;),
 929             }
</pre>
<hr />
<pre>
 952         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 953             runTestPrebuiltSrcFullExtra);
 954     }
 955 
 956     // Generate the missing platform attributes
 957     profiles = generatePlatformAttributes(profiles);
 958     profiles = generateDefaultMakeTargetsConfigureArg(common, profiles);
 959     return profiles;
 960 };
 961 
 962 /**
 963  * Generate the dependencies part of the configuration
 964  *
 965  * @param input External data to use for generating the configuration
 966  * @param common The common values
 967  * @returns {{}} Dependencies part of configuration
 968  */
 969 var getJibProfilesDependencies = function (input, common) {
 970 
 971     var devkit_platform_revisions = {
<span class="line-modified"> 972         linux_x64: &quot;gcc8.3.0-OL6.4+1.0&quot;,</span>
 973         macosx_x64: &quot;Xcode10.1-MacOSX10.14+1.0&quot;,
 974         solaris_x64: &quot;SS12u4-Solaris11u1+1.0&quot;,
 975         solaris_sparcv9: &quot;SS12u6-Solaris11u3+1.0&quot;,
<span class="line-modified"> 976         windows_x64: &quot;VS2017-15.9.16+1.0&quot;,</span>
<span class="line-modified"> 977         linux_aarch64: &quot;gcc8.3.0-OL7.6+1.0&quot;,</span>
<span class="line-modified"> 978         linux_arm: &quot;gcc8.2.0-Fedora27+1.0&quot;,</span>
<span class="line-modified"> 979         linux_ppc64le: &quot;gcc8.2.0-Fedora27+1.0&quot;,</span>
<span class="line-modified"> 980         linux_s390x: &quot;gcc8.2.0-Fedora27+1.0&quot;</span>
 981     };
 982 
 983     var devkit_platform = (input.target_cpu == &quot;x86&quot;
 984         ? input.target_os + &quot;_x64&quot;
 985         : input.target_platform);
 986 
<span class="line-added"> 987     var devkit_cross_prefix = &quot;&quot;;</span>
<span class="line-added"> 988     if (input.build_platform != input.target_platform</span>
<span class="line-added"> 989        &amp;&amp; input.build_platform != devkit_platform) {</span>
<span class="line-added"> 990         devkit_cross_prefix = input.build_platform + &quot;-to-&quot;;</span>
<span class="line-added"> 991     }</span>
<span class="line-added"> 992 </span>
 993     var boot_jdk_platform = (input.build_os == &quot;macosx&quot; ? &quot;osx&quot; : input.build_os)
 994         + &quot;-&quot; + input.build_cpu;
 995     var boot_jdk_ext = (input.build_os == &quot;windows&quot; ? &quot;.zip&quot; : &quot;.tar.gz&quot;)
 996     // If running in WSL and building for Windows, it will look like Linux,
 997     // but we need a Windows boot JDK.
 998     if (isWsl(input) &amp;&amp; input.target_os == &quot;windows&quot;) {
 999         boot_jdk_platform = &quot;windows-&quot; + input.build_cpu;
1000         boot_jdk_ext = &quot;.zip&quot;;
1001     }
1002 
1003     var makeBinDir = (input.build_os == &quot;windows&quot;
1004         ? input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/cygwin/bin&quot;
1005         : input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/bin&quot;);
1006 
<span class="line-modified">1007     if (input.build_cpu == &#39;aarch64&#39;) {</span>
<span class="line-modified">1008 	boot_jdk = {</span>
<span class="line-modified">1009             organization: common.organization,</span>
<span class="line-added">1010             ext: &quot;tar.gz&quot;,</span>
<span class="line-added">1011             module: &quot;jdk-linux_aarch64&quot;,</span>
<span class="line-added">1012             revision: &quot;13+1.0&quot;,</span>
<span class="line-added">1013             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,</span>
<span class="line-added">1014             environment_path: common.boot_jdk_home + &quot;/bin&quot;</span>
<span class="line-added">1015 	}</span>
<span class="line-added">1016     } else {</span>
<span class="line-added">1017 	boot_jdk = {</span>
1018             server: &quot;jpg&quot;,
1019             product: &quot;jdk&quot;,
1020             version: common.boot_jdk_version,
<span class="line-modified">1021             build_number: common.boot_jdk_build_number,</span>
1022             file: &quot;bundles/&quot; + boot_jdk_platform + &quot;/jdk-&quot; + common.boot_jdk_version + &quot;_&quot;
1023                 + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext,
1024             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
1025             environment_path: common.boot_jdk_home + &quot;/bin&quot;
<span class="line-modified">1026 	}</span>
<span class="line-added">1027     }</span>
<span class="line-added">1028 </span>
<span class="line-added">1029     var dependencies = {</span>
<span class="line-added">1030         boot_jdk: boot_jdk,</span>
1031 
1032         devkit: {
1033             organization: common.organization,
1034             ext: &quot;tar.gz&quot;,
<span class="line-modified">1035             module: &quot;devkit-&quot; + devkit_cross_prefix + devkit_platform,</span>
1036             revision: devkit_platform_revisions[devkit_platform],
1037             environment: {
1038                 &quot;DEVKIT_HOME&quot;: input.get(&quot;devkit&quot;, &quot;home_path&quot;),
1039             }
1040         },
1041 
1042         build_devkit: {
1043             organization: common.organization,
1044             ext: &quot;tar.gz&quot;,
1045             module: &quot;devkit-&quot; + input.build_platform,
1046             revision: devkit_platform_revisions[input.build_platform]
1047         },
1048 
1049         cups: {
1050             organization: common.organization,
1051             ext: &quot;tar.gz&quot;,
1052             revision: &quot;1.0118+1.0&quot;
1053         },
1054 
1055         jtreg: {
1056             server: &quot;javare&quot;,
1057             revision: &quot;4.2&quot;,
<span class="line-modified">1058             build_number: &quot;b16&quot;,</span>
1059             checksum_file: &quot;MD5_VALUES&quot;,
1060             file: &quot;jtreg_bin-4.2.zip&quot;,
1061             environment_name: &quot;JT_HOME&quot;,
1062             environment_path: input.get(&quot;jtreg&quot;, &quot;install_path&quot;) + &quot;/jtreg/bin&quot;
1063         },
1064 
1065         jmh: {
1066             organization: common.organization,
1067             ext: &quot;tar.gz&quot;,
1068             revision: &quot;1.21+1.0&quot;
1069         },
1070 
1071         jcov: {
1072             // Until an official build of JCov is available, use custom
1073             // build to support classfile version 57.
1074             // See CODETOOLS-7902358 for more info.
1075             // server: &quot;jpg&quot;,
1076             // product: &quot;jcov&quot;,
1077             // version: &quot;3.0&quot;,
1078             // build_number: &quot;b07&quot;,
1079             // file: &quot;bundles/jcov-3_0.zip&quot;,
1080             organization: common.organization,
<span class="line-modified">1081             revision: &quot;3.0-59-support+1.0&quot;,</span>
1082             ext: &quot;zip&quot;,
1083             environment_name: &quot;JCOV_HOME&quot;,
1084         },
1085 
1086         gnumake: {
1087             organization: common.organization,
1088             ext: &quot;tar.gz&quot;,
1089             revision: &quot;4.0+1.0&quot;,
1090 
1091             module: (input.build_os == &quot;windows&quot;
1092                 ? &quot;gnumake-&quot; + input.build_osenv_platform
1093                 : &quot;gnumake-&quot; + input.build_platform),
1094 
1095             configure_args: &quot;MAKE=&quot; + makeBinDir + &quot;/make&quot;,
1096 
1097             environment: {
1098                 &quot;MAKE&quot;: makeBinDir + &quot;/make&quot;
1099             },
1100 
1101             environment_path: makeBinDir
</pre>
<hr />
<pre>
1303         }
1304     }
1305     return ret;
1306 };
1307 
1308 /**
1309  * Constructs the numeric version string from reading the
1310  * make/autoconf/version-numbers file and removing all trailing &quot;.0&quot;.
1311  *
1312  * @param feature Override feature version
1313  * @param interim Override interim version
1314  * @param update Override update version
1315  * @param patch Override patch version
1316  * @returns {String} The numeric version string
1317  */
1318 var getVersion = function (feature, interim, update, patch) {
1319     var version_numbers = getVersionNumbers();
1320     var version = (feature != null ? feature : version_numbers.get(&quot;DEFAULT_VERSION_FEATURE&quot;))
1321         + &quot;.&quot; + (interim != null ? interim : version_numbers.get(&quot;DEFAULT_VERSION_INTERIM&quot;))
1322         + &quot;.&quot; + (update != null ? update :  version_numbers.get(&quot;DEFAULT_VERSION_UPDATE&quot;))
<span class="line-modified">1323         + &quot;.&quot; + (patch != null ? patch : version_numbers.get(&quot;DEFAULT_VERSION_PATCH&quot;))</span>
<span class="line-added">1324         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA1&quot;)</span>
<span class="line-added">1325         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA2&quot;)</span>
<span class="line-added">1326         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA3&quot;);</span>
1327     while (version.match(&quot;.*\\.0$&quot;)) {
1328         version = version.substring(0, version.length - 2);
1329     }
1330     return version;
1331 };
1332 
1333 /**
1334  * Constructs the common version configure args based on build type and
1335  * other version inputs
1336  */
1337 var versionArgs = function(input, common) {
1338     var args = [&quot;--with-version-build=&quot; + common.build_number];
1339     if (input.build_type == &quot;promoted&quot;) {
1340         args = concat(args,
<span class="line-modified">1341                       &quot;--with-version-pre=&quot; + version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;),</span>


1342                       &quot;--without-version-opt&quot;);
<span class="line-added">1343     } else if (input.build_type == &quot;ci&quot;) {</span>
<span class="line-added">1344         var optString = input.build_id_data.ciBuildNumber;</span>
<span class="line-added">1345         var preString = input.build_id_data.projectName;</span>
<span class="line-added">1346         if (preString == &quot;jdk&quot;) {</span>
<span class="line-added">1347             preString = version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;);</span>
<span class="line-added">1348         }</span>
<span class="line-added">1349         args = concat(args, &quot;--with-version-pre=&quot; + preString,</span>
<span class="line-added">1350                      &quot;--with-version-opt=&quot; + optString);</span>
1351     } else {
1352         args = concat(args, &quot;--with-version-opt=&quot; + common.build_id);
1353     }
1354     return args;
1355 }
1356 
1357 // Properties representation of the make/autoconf/version-numbers file. Lazily
1358 // initiated by the function below.
1359 var version_numbers;
1360 
1361 /**
1362  * Read the make/autoconf/version-numbers file into a Properties object.
1363  *
1364  * @returns {java.utilProperties}
1365  */
1366 var getVersionNumbers = function () {
1367     // Read version information from make/autoconf/version-numbers
1368     if (version_numbers == null) {
1369         version_numbers = new java.util.Properties();
1370         var stream = new java.io.FileInputStream(__DIR__ + &quot;/../autoconf/version-numbers&quot;);
1371         version_numbers.load(stream);
1372         stream.close();
1373     }
1374     return version_numbers;
1375 }
1376 
1377 /**
1378  * Returns true if running in Windows Subsystem for Linux. Jib does not yet
1379  * detect wsl as osenv, so fall back on linux with version containing Microsoft.
1380  */
1381 var isWsl = function (input) {
1382     return ( input.build_osenv == &quot;wsl&quot;
1383              || (input.build_os == &quot;linux&quot;
1384                  &amp;&amp; java.lang.System.getProperty(&quot;os.version&quot;).contains(&quot;Microsoft&quot;)));
1385 }
<span class="line-added">1386 </span>
<span class="line-added">1387 var error = function (s) {</span>
<span class="line-added">1388     java.lang.System.err.println(&quot;[ERROR] &quot; + s);</span>
<span class="line-added">1389     exit(1);</span>
<span class="line-added">1390 };</span>
</pre>
</td>
</tr>
</table>
<center><a href="../common/ZipArchive.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>