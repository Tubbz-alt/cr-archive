<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff make/jdk/src/classes/build/tools/cldrconverter/CLDRConverter.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Bundle.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LDMLParseHandler.java.udiff.html" target="_top">next &gt;</a></center>    <h2>make/jdk/src/classes/build/tools/cldrconverter/CLDRConverter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,10 @@</span>
   * questions.
   */
  
  package build.tools.cldrconverter;
  
<span class="udiff-line-removed">- import static build.tools.cldrconverter.Bundle.jreTimeZoneNames;</span>
  import build.tools.cldrconverter.BundleGenerator.BundleType;
  import java.io.File;
  import java.io.IOException;
  import java.io.UncheckedIOException;
  import java.nio.file.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -68,10 +67,11 @@</span>
      private static String NUMBERING_SOURCE_FILE;
      private static String METAZONES_SOURCE_FILE;
      private static String LIKELYSUBTAGS_SOURCE_FILE;
      private static String TIMEZONE_SOURCE_FILE;
      private static String WINZONES_SOURCE_FILE;
<span class="udiff-line-added">+     private static String PLURALS_SOURCE_FILE;</span>
      static String DESTINATION_DIR = &quot;build/gensrc&quot;;
  
      static final String LOCALE_NAME_PREFIX = &quot;locale.displayname.&quot;;
      static final String LOCALE_SEPARATOR = LOCALE_NAME_PREFIX + &quot;separator&quot;;
      static final String LOCALE_KEYTYPE = LOCALE_NAME_PREFIX + &quot;keytype&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -86,15 +86,18 @@</span>
      static final String TIMEZONE_ID_PREFIX = &quot;timezone.id.&quot;;
      static final String EXEMPLAR_CITY_PREFIX = &quot;timezone.excity.&quot;;
      static final String ZONE_NAME_PREFIX = &quot;timezone.displayname.&quot;;
      static final String METAZONE_ID_PREFIX = &quot;metazone.id.&quot;;
      static final String PARENT_LOCALE_PREFIX = &quot;parentLocale.&quot;;
<span class="udiff-line-added">+     static final String META_EMPTY_ZONE_NAME = &quot;EMPTY_ZONE&quot;;</span>
      static final String[] EMPTY_ZONE = {&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;};
<span class="udiff-line-added">+     static final String META_ETCUTC_ZONE_NAME = &quot;ETC_UTC&quot;;</span>
  
      private static SupplementDataParseHandler handlerSuppl;
      private static LikelySubtagsParseHandler handlerLikelySubtags;
      private static WinZonesParseHandler handlerWinZones;
<span class="udiff-line-added">+     static PluralsParseHandler handlerPlurals;</span>
      static SupplementalMetadataParseHandler handlerSupplMeta;
      static NumberingSystemsParseHandler handlerNumbering;
      static MetaZonesParseHandler handlerMetaZones;
      static TimeZoneParseHandler handlerTimeZone;
      private static BundleGenerator bundleGenerator;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,11 +109,11 @@</span>
      // &quot;parentLocales&quot; map
      private static final Map&lt;String, SortedSet&lt;String&gt;&gt; parentLocalesMap = new HashMap&lt;&gt;();
      private static final ResourceBundle.Control defCon =
          ResourceBundle.Control.getControl(ResourceBundle.Control.FORMAT_DEFAULT);
  
<span class="udiff-line-modified-removed">-     private static final String[] AVAILABLE_TZIDS = TimeZone.getAvailableIDs();</span>
<span class="udiff-line-modified-added">+     private static Set&lt;String&gt; AVAILABLE_TZIDS;</span>
      private static String zoneNameTempFile;
      private static String tzDataDir;
      private static final Map&lt;String, String&gt; canonicalTZMap = new HashMap&lt;&gt;();
  
      static enum DraftType {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,10 +245,11 @@</span>
          NUMBERING_SOURCE_FILE = CLDR_BASE + &quot;/supplemental/numberingSystems.xml&quot;;
          METAZONES_SOURCE_FILE = CLDR_BASE + &quot;/supplemental/metaZones.xml&quot;;
          TIMEZONE_SOURCE_FILE = CLDR_BASE + &quot;/bcp47/timezone.xml&quot;;
          SPPL_META_SOURCE_FILE = CLDR_BASE + &quot;/supplemental/supplementalMetadata.xml&quot;;
          WINZONES_SOURCE_FILE = CLDR_BASE + &quot;/supplemental/windowsZones.xml&quot;;
<span class="udiff-line-added">+         PLURALS_SOURCE_FILE = CLDR_BASE + &quot;/supplemental/plurals.xml&quot;;</span>
  
          if (BASE_LOCALES.isEmpty()) {
              setupBaseLocales(&quot;en-US&quot;);
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -262,10 +266,13 @@</span>
              // Generate java.time.format.ZoneName.java
              generateZoneName();
  
              // Generate Windows tzmappings
              generateWindowsTZMappings();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Generate Plural rules</span>
<span class="udiff-line-added">+             generatePluralRules();</span>
          }
      }
  
      private static void usage() {
          errout(&quot;Usage: java CLDRConverter [options]%n&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -344,21 +351,30 @@</span>
                      Locale cldrLoc = Locale.forLanguageTag(toLanguageTag(id));
                      StringBuilder sb = getCandLocales(cldrLoc);
                      if (sb.indexOf(&quot;root&quot;) == -1) {
                          sb.append(&quot;root&quot;);
                      }
<span class="udiff-line-modified-removed">-                     Bundle b = new Bundle(id, sb.toString(), null, null);</span>
<span class="udiff-line-removed">-                     // Insert the bundle for root at the top so that it will get</span>
<span class="udiff-line-removed">-                     // processed first.</span>
<span class="udiff-line-removed">-                     if (&quot;root&quot;.equals(id)) {</span>
<span class="udiff-line-removed">-                         retList.add(0, b);</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         retList.add(b);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+                     retList.add(new Bundle(id, sb.toString(), null, null));</span>
                  }
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Sort the bundles based on id. This will make sure all the parent bundles are</span>
<span class="udiff-line-added">+         // processed first, e.g., for en_GB bundle, en_001, and &quot;root&quot; comes before</span>
<span class="udiff-line-added">+         // en_GB. In order for &quot;root&quot; to come at the beginning, &quot;root&quot; is replaced with</span>
<span class="udiff-line-added">+         // empty string on comparison.</span>
<span class="udiff-line-added">+         retList.sort((o1, o2) -&gt; {</span>
<span class="udiff-line-added">+             String id1 = o1.getID();</span>
<span class="udiff-line-added">+             String id2 = o2.getID();</span>
<span class="udiff-line-added">+             if(id1.equals(&quot;root&quot;)) {</span>
<span class="udiff-line-added">+                 id1 = &quot;&quot;;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if(id2.equals(&quot;root&quot;)) {</span>
<span class="udiff-line-added">+                 id2 = &quot;&quot;;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return id1.compareTo(id2);</span>
<span class="udiff-line-added">+         });</span>
          return retList;
      }
  
      private static final Map&lt;String, Map&lt;String, Object&gt;&gt; cldrBundles = new HashMap&lt;&gt;();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -440,10 +456,14 @@</span>
          parseLDMLFile(new File(SPPL_META_SOURCE_FILE), handlerSupplMeta);
  
          // Parse windowsZones
          handlerWinZones = new WinZonesParseHandler();
          parseLDMLFile(new File(WINZONES_SOURCE_FILE), handlerWinZones);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Parse plurals</span>
<span class="udiff-line-added">+         handlerPlurals = new PluralsParseHandler();</span>
<span class="udiff-line-added">+         parseLDMLFile(new File(PLURALS_SOURCE_FILE), handlerPlurals);</span>
      }
  
      // Parsers for data in &quot;bcp47&quot; directory
      //
      private static void parseBCP47() throws Exception {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -663,74 +683,27 @@</span>
          }
          return currencyNames;
      }
  
      private static Map&lt;String, Object&gt; extractZoneNames(Map&lt;String, Object&gt; map, String id) {
<span class="udiff-line-modified-removed">-         Map&lt;String, Object&gt; names = new HashMap&lt;&gt;();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Copy over missing time zone ids from JRE for English locale</span>
<span class="udiff-line-removed">-         if (id.equals(&quot;en&quot;)) {</span>
<span class="udiff-line-removed">-             Map&lt;String[], String&gt; jreMetaMap = new HashMap&lt;&gt;();</span>
<span class="udiff-line-removed">-             jreTimeZoneNames.stream().forEach(e -&gt; {</span>
<span class="udiff-line-removed">-                 String tzid = (String)e[0];</span>
<span class="udiff-line-removed">-                 String[] data = (String[])e[1];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (map.get(TIMEZONE_ID_PREFIX + tzid) == null &amp;&amp;</span>
<span class="udiff-line-removed">-                     handlerMetaZones.get(tzid) == null ||</span>
<span class="udiff-line-removed">-                     handlerMetaZones.get(tzid) != null &amp;&amp;</span>
<span class="udiff-line-removed">-                     map.get(METAZONE_ID_PREFIX + handlerMetaZones.get(tzid)) == null) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     // First, check the alias</span>
<span class="udiff-line-removed">-                     String canonID = canonicalTZMap.get(tzid);</span>
<span class="udiff-line-removed">-                     if (canonID != null &amp;&amp; !tzid.equals(canonID)) {</span>
<span class="udiff-line-removed">-                         Object value = map.get(TIMEZONE_ID_PREFIX + canonID);</span>
<span class="udiff-line-removed">-                         if (value != null) {</span>
<span class="udiff-line-removed">-                             names.put(tzid, value);</span>
<span class="udiff-line-removed">-                             return;</span>
<span class="udiff-line-removed">-                         } else {</span>
<span class="udiff-line-removed">-                             String meta = handlerMetaZones.get(canonID);</span>
<span class="udiff-line-removed">-                             if (meta != null) {</span>
<span class="udiff-line-removed">-                                 value = map.get(METAZONE_ID_PREFIX + meta);</span>
<span class="udiff-line-removed">-                                 if (value != null) {</span>
<span class="udiff-line-removed">-                                     names.put(tzid, meta);</span>
<span class="udiff-line-removed">-                                     return;</span>
<span class="udiff-line-removed">-                                 }</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+         Map&lt;String, Object&gt; names = new TreeMap&lt;&gt;(KeyComparator.INSTANCE);</span>
  
<span class="udiff-line-modified-removed">-                     // Check the CLDR meta key</span>
<span class="udiff-line-removed">-                     Optional&lt;Map.Entry&lt;String, String&gt;&gt; cldrMeta =</span>
<span class="udiff-line-removed">-                         handlerMetaZones.getData().entrySet().stream()</span>
<span class="udiff-line-removed">-                             .filter(me -&gt;</span>
<span class="udiff-line-removed">-                                 Arrays.deepEquals(data,</span>
<span class="udiff-line-removed">-                                     (String[])map.get(METAZONE_ID_PREFIX + me.getValue())))</span>
<span class="udiff-line-removed">-                             .findAny();</span>
<span class="udiff-line-removed">-                     cldrMeta.ifPresentOrElse(meta -&gt; names.put(tzid, meta.getValue()), () -&gt; {</span>
<span class="udiff-line-removed">-                         // Check the JRE meta key, add if there is not.</span>
<span class="udiff-line-removed">-                         Optional&lt;Map.Entry&lt;String[], String&gt;&gt; jreMeta =</span>
<span class="udiff-line-removed">-                             jreMetaMap.entrySet().stream()</span>
<span class="udiff-line-removed">-                                 .filter(jm -&gt; Arrays.deepEquals(data, jm.getKey()))</span>
<span class="udiff-line-removed">-                                 .findAny();</span>
<span class="udiff-line-removed">-                         jreMeta.ifPresentOrElse(meta -&gt; names.put(tzid, meta.getValue()), () -&gt; {</span>
<span class="udiff-line-removed">-                                 String metaName = &quot;JRE_&quot; + tzid.replaceAll(&quot;[/-]&quot;, &quot;_&quot;);</span>
<span class="udiff-line-removed">-                                 names.put(METAZONE_ID_PREFIX + metaName, data);</span>
<span class="udiff-line-removed">-                                 names.put(tzid, metaName);</span>
<span class="udiff-line-removed">-                         });</span>
<span class="udiff-line-removed">-                     });</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             });</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Arrays.stream(AVAILABLE_TZIDS).forEach(tzid -&gt; {</span>
<span class="udiff-line-modified-added">+         getAvailableZoneIds().stream().forEach(tzid -&gt; {</span>
              // If the tzid is deprecated, get the data for the replacement id
              String tzKey = Optional.ofNullable((String)handlerSupplMeta.get(tzid))
                                     .orElse(tzid);
              Object data = map.get(TIMEZONE_ID_PREFIX + tzKey);
  
              if (data instanceof String[]) {
<span class="udiff-line-modified-removed">-                 names.put(tzid, data);</span>
<span class="udiff-line-modified-added">+                 // Hack for UTC. UTC is an alias to Etc/UTC in CLDR</span>
<span class="udiff-line-added">+                 if (tzid.equals(&quot;Etc/UTC&quot;) &amp;&amp; !map.containsKey(TIMEZONE_ID_PREFIX + &quot;UTC&quot;)) {</span>
<span class="udiff-line-added">+                     names.put(METAZONE_ID_PREFIX + META_ETCUTC_ZONE_NAME, data);</span>
<span class="udiff-line-added">+                     names.put(tzid, META_ETCUTC_ZONE_NAME);</span>
<span class="udiff-line-added">+                     names.put(&quot;UTC&quot;, META_ETCUTC_ZONE_NAME);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     names.put(tzid, data);</span>
<span class="udiff-line-added">+                 }</span>
              } else {
                  String meta = handlerMetaZones.get(tzKey);
                  if (meta != null) {
                      String metaKey = METAZONE_ID_PREFIX + meta;
                      data = map.get(metaKey);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -743,28 +716,27 @@</span>
              }
          });
  
          // exemplar cities.
          Map&lt;String, Object&gt; exCities = map.entrySet().stream()
<span class="udiff-line-modified-removed">-                 .filter(e -&gt; e.getKey().startsWith(CLDRConverter.EXEMPLAR_CITY_PREFIX))</span>
<span class="udiff-line-modified-removed">-                 .collect(Collectors</span>
<span class="udiff-line-removed">-                         .toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
<span class="udiff-line-modified-added">+             .filter(e -&gt; e.getKey().startsWith(CLDRConverter.EXEMPLAR_CITY_PREFIX))</span>
<span class="udiff-line-modified-added">+             .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
          names.putAll(exCities);
  
<span class="udiff-line-modified-removed">-         if (!id.equals(&quot;en&quot;) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-             !names.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             // CLDR does not have UTC entry, so add it here.</span>
<span class="udiff-line-modified-removed">-             names.put(&quot;UTC&quot;, EMPTY_ZONE);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // no metazone zones</span>
<span class="udiff-line-removed">-             Arrays.asList(handlerMetaZones.get(MetaZonesParseHandler.NO_METAZONE_KEY)</span>
<span class="udiff-line-removed">-                 .split(&quot;\\s&quot;)).stream()</span>
<span class="udiff-line-removed">-                 .forEach(tz -&gt; {</span>
<span class="udiff-line-removed">-                     names.put(tz, EMPTY_ZONE);</span>
<span class="udiff-line-removed">-                 });</span>
<span class="udiff-line-modified-added">+         // If there&#39;s no UTC entry at this point, add an empty one</span>
<span class="udiff-line-modified-added">+         if (!names.isEmpty() &amp;&amp; !names.containsKey(&quot;UTC&quot;)) {</span>
<span class="udiff-line-modified-added">+             names.putIfAbsent(METAZONE_ID_PREFIX + META_EMPTY_ZONE_NAME, EMPTY_ZONE);</span>
<span class="udiff-line-modified-added">+             names.put(&quot;UTC&quot;, META_EMPTY_ZONE_NAME);</span>
          }
  
<span class="udiff-line-added">+         // Finally some compatibility stuff</span>
<span class="udiff-line-added">+         ZoneId.SHORT_IDS.entrySet().stream()</span>
<span class="udiff-line-added">+             .filter(e -&gt; !names.containsKey(e.getKey()) &amp;&amp; names.containsKey(e.getValue()))</span>
<span class="udiff-line-added">+             .forEach(e -&gt; {</span>
<span class="udiff-line-added">+                 names.put(e.getKey(), names.get(e.getValue()));</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
          return names;
      }
  
      /**
       * Extracts the language independent calendar data. Each of the two keys,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -853,11 +825,11 @@</span>
                  copyIfPresent(map, key, formatData);
              }
          }
  
          for (String key : map.keySet()) {
<span class="udiff-line-modified-removed">-         // Copy available calendar names</span>
<span class="udiff-line-modified-added">+             // Copy available calendar names</span>
              if (key.startsWith(CLDRConverter.LOCALE_TYPE_PREFIX_CA)) {
                  String type = key.substring(CLDRConverter.LOCALE_TYPE_PREFIX_CA.length());
                  for (CalendarType calendarType : CalendarType.values()) {
                      if (calendarType == CalendarType.GENERIC) {
                          continue;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -880,16 +852,17 @@</span>
  
          @SuppressWarnings(&quot;unchecked&quot;)
          List&lt;String&gt; numberingScripts = (List&lt;String&gt;) map.remove(&quot;numberingScripts&quot;);
          if (numberingScripts != null) {
              for (String script : numberingScripts) {
<span class="udiff-line-modified-removed">-                 copyIfPresent(map, script + &quot;.&quot; + &quot;NumberElements&quot;, formatData);</span>
<span class="udiff-line-modified-added">+                 copyIfPresent(map, script + &quot;.NumberElements&quot;, formatData);</span>
<span class="udiff-line-added">+                 copyIfPresent(map, script + &quot;.NumberPatterns&quot;, formatData);</span>
              }
          } else {
              copyIfPresent(map, &quot;NumberElements&quot;, formatData);
<span class="udiff-line-added">+             copyIfPresent(map, &quot;NumberPatterns&quot;, formatData);</span>
          }
<span class="udiff-line-removed">-         copyIfPresent(map, &quot;NumberPatterns&quot;, formatData);</span>
          copyIfPresent(map, &quot;short.CompactNumberPatterns&quot;, formatData);
          copyIfPresent(map, &quot;long.CompactNumberPatterns&quot;, formatData);
  
          // put extra number elements for available scripts into formatData, if it is &quot;root&quot;
          if (id.equals(&quot;root&quot;)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1063,12 +1036,24 @@</span>
                  })
                  .collect(Collectors.toList()),
              StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);
      }
  
<span class="udiff-line-added">+     // This method assumes handlerMetaZones is already initialized</span>
<span class="udiff-line-added">+     private static Set&lt;String&gt; getAvailableZoneIds() {</span>
<span class="udiff-line-added">+         assert handlerMetaZones != null;</span>
<span class="udiff-line-added">+         if (AVAILABLE_TZIDS == null) {</span>
<span class="udiff-line-added">+             AVAILABLE_TZIDS = new HashSet&lt;&gt;(ZoneId.getAvailableZoneIds());</span>
<span class="udiff-line-added">+             AVAILABLE_TZIDS.addAll(handlerMetaZones.keySet());</span>
<span class="udiff-line-added">+             AVAILABLE_TZIDS.remove(MetaZonesParseHandler.NO_METAZONE_KEY);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return AVAILABLE_TZIDS;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static Stream&lt;String&gt; zidMapEntry() {
<span class="udiff-line-modified-removed">-         return ZoneId.getAvailableZoneIds().stream()</span>
<span class="udiff-line-modified-added">+         return getAvailableZoneIds().stream()</span>
                  .map(id -&gt; {
                      String canonId = canonicalTZMap.getOrDefault(id, id);
                      String meta = handlerMetaZones.get(canonId);
                      String zone001 = handlerMetaZones.zidMap().get(meta);
                      return zone001 == null ? &quot;&quot; :
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1136,6 +1121,71 @@</span>
                      }
                  })
                  .collect(Collectors.toList()),
              StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Generate ResourceBundle source file for plural rules. The generated</span>
<span class="udiff-line-added">+      * class is {@code sun.text.resources.PluralRules} which has one public</span>
<span class="udiff-line-added">+      * two dimensional array {@code rulesArray}. Each array element consists</span>
<span class="udiff-line-added">+      * of two elements that designate the locale and the locale&#39;s plural rules</span>
<span class="udiff-line-added">+      * string. The latter has the syntax from Unicode Consortium&#39;s</span>
<span class="udiff-line-added">+      * &lt;a href=&quot;http://unicode.org/reports/tr35/tr35-numbers.html#Plural_rules_syntax&quot;&gt;</span>
<span class="udiff-line-added">+      * Plural rules syntax&lt;/a&gt;. {@code samples} and {@code &quot;other&quot;} are being ommited.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static void generatePluralRules() throws Exception {</span>
<span class="udiff-line-added">+         Files.createDirectories(Paths.get(DESTINATION_DIR, &quot;sun&quot;, &quot;text&quot;, &quot;resources&quot;));</span>
<span class="udiff-line-added">+         Files.write(Paths.get(DESTINATION_DIR, &quot;sun&quot;, &quot;text&quot;, &quot;resources&quot;, &quot;PluralRules.java&quot;),</span>
<span class="udiff-line-added">+             Stream.concat(</span>
<span class="udiff-line-added">+                 Stream.concat(</span>
<span class="udiff-line-added">+                     Stream.of(</span>
<span class="udiff-line-added">+                         &quot;package sun.text.resources;&quot;,</span>
<span class="udiff-line-added">+                         &quot;public final class PluralRules {&quot;,</span>
<span class="udiff-line-added">+                         &quot;    public static final String[][] rulesArray = {&quot;</span>
<span class="udiff-line-added">+                     ),</span>
<span class="udiff-line-added">+                     pluralRulesStream().sorted()</span>
<span class="udiff-line-added">+                 ),</span>
<span class="udiff-line-added">+                 Stream.of(</span>
<span class="udiff-line-added">+                     &quot;    };&quot;,</span>
<span class="udiff-line-added">+                     &quot;}&quot;</span>
<span class="udiff-line-added">+                 )</span>
<span class="udiff-line-added">+             )</span>
<span class="udiff-line-added">+             .collect(Collectors.toList()),</span>
<span class="udiff-line-added">+         StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static Stream&lt;String&gt; pluralRulesStream() {</span>
<span class="udiff-line-added">+         return handlerPlurals.getData().entrySet().stream()</span>
<span class="udiff-line-added">+             .filter(e -&gt; !((Map&lt;String, String&gt;)e.getValue()).isEmpty())</span>
<span class="udiff-line-added">+             .map(e -&gt; {</span>
<span class="udiff-line-added">+                 String loc = e.getKey();</span>
<span class="udiff-line-added">+                 Map&lt;String, String&gt; rules = (Map&lt;String, String&gt;)e.getValue();</span>
<span class="udiff-line-added">+                 return &quot;        {\&quot;&quot; + loc + &quot;\&quot;, \&quot;&quot; +</span>
<span class="udiff-line-added">+                     rules.entrySet().stream()</span>
<span class="udiff-line-added">+                         .map(rule -&gt; rule.getKey() + &quot;:&quot; + rule.getValue().replaceFirst(&quot;@.*&quot;, &quot;&quot;))</span>
<span class="udiff-line-added">+                         .map(String::trim)</span>
<span class="udiff-line-added">+                         .collect(Collectors.joining(&quot;;&quot;)) + &quot;\&quot;},&quot;;</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // for debug</span>
<span class="udiff-line-added">+     static void dumpMap(Map&lt;String, Object&gt; map) {</span>
<span class="udiff-line-added">+         map.entrySet().stream()</span>
<span class="udiff-line-added">+             .sorted(Map.Entry.comparingByKey())</span>
<span class="udiff-line-added">+             .map(e -&gt; {</span>
<span class="udiff-line-added">+                 Object val = e.getValue();</span>
<span class="udiff-line-added">+                 String valStr = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (val instanceof String[]) {</span>
<span class="udiff-line-added">+                     valStr = Arrays.asList((String[])val).toString();</span>
<span class="udiff-line-added">+                 } else if (val != null) {</span>
<span class="udiff-line-added">+                     valStr = val.toString();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return e.getKey() + &quot; = &quot; + valStr;</span>
<span class="udiff-line-added">+             })</span>
<span class="udiff-line-added">+             .forEach(System.out::println);</span>
<span class="udiff-line-added">+     }</span>
  }
<span class="udiff-line-added">+ </span>
</pre>
<center><a href="Bundle.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LDMLParseHandler.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>