<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/jdk/src/classes/build/tools/cldrconverter/ResourceBundleGenerator.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package build.tools.cldrconverter;
 27 
 28 import java.io.File;
 29 import java.io.IOException;
 30 import java.io.PrintWriter;
 31 import java.util.Arrays;
 32 import java.util.Formatter;
 33 import java.util.HashSet;
 34 import java.util.HashMap;
 35 import java.util.LinkedHashMap;
 36 import java.util.Map;
 37 import java.util.Locale;
 38 import java.util.Objects;
 39 import java.util.Set;
 40 import java.util.SortedSet;
 41 
 42 class ResourceBundleGenerator implements BundleGenerator {
 43     // preferred timezones - keeping compatibility with JDK1.1 3 letter abbreviations
 44     private static final String[] preferredTZIDs = {
 45         &quot;America/Los_Angeles&quot;,
 46         &quot;America/Denver&quot;,
 47         &quot;America/Phoenix&quot;,
 48         &quot;America/Chicago&quot;,
 49         &quot;America/New_York&quot;,
 50         &quot;America/Indianapolis&quot;,
 51         &quot;Pacific/Honolulu&quot;,
 52         &quot;America/Anchorage&quot;,
 53         &quot;America/Halifax&quot;,
 54         &quot;America/Sitka&quot;,
 55         &quot;America/St_Johns&quot;,
 56         &quot;Europe/Paris&quot;,
 57         // Although CLDR does not support abbreviated zones, handle &quot;GMT&quot; as a
 58         // special case here, as it is specified in the javadoc.
 59         &quot;GMT&quot;,
 60         &quot;Africa/Casablanca&quot;,
 61         &quot;Asia/Jerusalem&quot;,
 62         &quot;Asia/Tokyo&quot;,
 63         &quot;Europe/Bucharest&quot;,
 64         &quot;Asia/Shanghai&quot;,
 65         &quot;UTC&quot;,
 66     };
 67 
 68     // For duplicated values
 69     private static final String META_VALUE_PREFIX = &quot;metaValue_&quot;;
 70 
 71     @Override
 72     public void generateBundle(String packageName, String baseName, String localeID, boolean useJava,
 73                                Map&lt;String, ?&gt; map, BundleType type) throws IOException {
 74         String suffix = useJava ? &quot;.java&quot; : &quot;.properties&quot;;
 75         String dirName = CLDRConverter.DESTINATION_DIR + File.separator + &quot;sun&quot; + File.separator
 76                 + packageName + File.separator + &quot;resources&quot; + File.separator + &quot;cldr&quot;;
 77         packageName = packageName + &quot;.resources.cldr&quot;;
 78 
 79         if (CLDRConverter.isBaseModule ^ isBaseLocale(localeID)) {
 80             return;
 81         }
 82 
 83         // Assume that non-base resources go into jdk.localedata
 84         if (!CLDRConverter.isBaseModule) {
 85             dirName = dirName + File.separator + &quot;ext&quot;;
 86             packageName = packageName + &quot;.ext&quot;;
 87         }
 88 
 89         File dir = new File(dirName);
 90         if (!dir.exists()) {
 91             dir.mkdirs();
 92         }
 93         File file = new File(dir, baseName + (&quot;root&quot;.equals(localeID) ? &quot;&quot; : &quot;_&quot; + localeID) + suffix);
 94         if (!file.exists()) {
 95             file.createNewFile();
 96         }
 97         CLDRConverter.info(&quot;\tWriting file &quot; + file);
 98 
 99         String encoding;
100         if (useJava) {
101             if (CLDRConverter.USE_UTF8) {
102                 encoding = &quot;utf-8&quot;;
103             } else {
104                 encoding = &quot;us-ascii&quot;;
105             }
106         } else {
107             encoding = &quot;iso-8859-1&quot;;
108         }
109 
110         Formatter fmt = null;
111         if (type == BundleType.TIMEZONE) {
112             fmt = new Formatter();
113             Set&lt;String&gt; metaKeys = new HashSet&lt;&gt;();
114             for (String key : map.keySet()) {
115                 if (key.startsWith(CLDRConverter.METAZONE_ID_PREFIX)) {
116                     String meta = key.substring(CLDRConverter.METAZONE_ID_PREFIX.length());
117                     String[] value;
118                     value = (String[]) map.get(key);
119                     fmt.format(&quot;        final String[] %s = new String[] {\n&quot;, meta);
120                     for (String s : value) {
121                         fmt.format(&quot;               \&quot;%s\&quot;,\n&quot;, CLDRConverter.saveConvert(s, useJava));
122                     }
123                     fmt.format(&quot;            };\n&quot;);
124                     metaKeys.add(key);
125                 }
126             }
127             for (String key : metaKeys) {
128                 map.remove(key);
129             }
130 
131             // Make it preferred ordered
132             LinkedHashMap&lt;String, Object&gt; newMap = new LinkedHashMap&lt;&gt;();
133             for (String preferred : preferredTZIDs) {
134                 if (map.containsKey(preferred)) {
135                     newMap.put(preferred, map.remove(preferred));
136                 } else if ((&quot;GMT&quot;.equals(preferred) || &quot;UTC&quot;.equals(preferred)) &amp;&amp;
137                            metaKeys.contains(CLDRConverter.METAZONE_ID_PREFIX+preferred)) {
138                     newMap.put(preferred, preferred);
139                 }
140             }
141             newMap.putAll(map);
142             map = newMap;
143         } else {
144             // generic reduction of duplicated values
145             Map&lt;String, Object&gt; newMap = null;
146             for (String key : map.keySet()) {
147                 Object val = map.get(key);
148                 String metaVal = null;
149 
150                 for (Map.Entry&lt;String, ?&gt; entry : map.entrySet()) {
151                     String k = entry.getKey();
152                     if (!k.equals(key) &amp;&amp;
153                         Objects.deepEquals(val, entry.getValue()) &amp;&amp;
154                         !(Objects.nonNull(newMap) &amp;&amp; newMap.containsKey(k))) {
155                         if (Objects.isNull(newMap)) {
156                             newMap = new HashMap&lt;&gt;();
157                             fmt = new Formatter();
158                         }
159 
160                         if (Objects.isNull(metaVal)) {
161                             metaVal = META_VALUE_PREFIX + key.replaceAll(&quot;[\\.-]&quot;, &quot;_&quot;);
162 
163                             if (val instanceof String[]) {
164                                 fmt.format(&quot;        final String[] %s = new String[] {\n&quot;, metaVal);
165                                 for (String s : (String[])val) {
166                                     fmt.format(&quot;               \&quot;%s\&quot;,\n&quot;, CLDRConverter.saveConvert(s, useJava));
167                                 }
168                                 fmt.format(&quot;            };\n&quot;);
169                             } else {
170                                 fmt.format(&quot;        final String %s = \&quot;%s\&quot;;\n&quot;, metaVal, CLDRConverter.saveConvert((String)val, useJava));
171                             }
172                         }
173 
174                         newMap.put(k, metaVal);
175                     }
176                 }
177 
178                 if (Objects.nonNull(metaVal)) {
179                     newMap.put(key, metaVal);
180                 }
181             }
182 
183             if (Objects.nonNull(newMap)) {
184                 for (String key : map.keySet()) {
185                     newMap.putIfAbsent(key, map.get(key));
186                 }
187                 map = newMap;
188             }
189         }
190 
191         try (PrintWriter out = new PrintWriter(file, encoding)) {
192             // Output copyright headers
193             out.println(CopyrightHeaders.getOpenJDKCopyright());
194             out.println(CopyrightHeaders.getUnicodeCopyright());
195 
196             if (useJava) {
197                 out.println(&quot;package sun.&quot; + packageName + &quot;;\n&quot;);
198                 out.printf(&quot;import %s;\n\n&quot;, type.getPathName());
199                 out.printf(&quot;public class %s%s extends %s {\n&quot;, baseName, &quot;root&quot;.equals(localeID) ? &quot;&quot; : &quot;_&quot; + localeID, type.getClassName());
200 
201                 out.println(&quot;    @Override\n&quot; +
202                             &quot;    protected final Object[][] getContents() {&quot;);
203                 if (fmt != null) {
204                     out.print(fmt.toString());
205                 }
206                 out.println(&quot;        final Object[][] data = new Object[][] {&quot;);
207             }
208             for (String key : map.keySet()) {
209                 if (useJava) {
210                     Object value = map.get(key);
211                     if (value == null) {
212                         CLDRConverter.warning(&quot;null value for &quot; + key);
213                     } else if (value instanceof String) {
214                         String valStr = (String)value;
215                         if (type == BundleType.TIMEZONE &amp;&amp;
216                             !key.startsWith(CLDRConverter.EXEMPLAR_CITY_PREFIX) ||
217                             valStr.startsWith(META_VALUE_PREFIX)) {
218                             out.printf(&quot;            { \&quot;%s\&quot;, %s },\n&quot;, key, CLDRConverter.saveConvert(valStr, useJava));
219                         } else {
220                             out.printf(&quot;            { \&quot;%s\&quot;, \&quot;%s\&quot; },\n&quot;, key, CLDRConverter.saveConvert(valStr, useJava));
221                         }
222                     } else if (value instanceof String[]) {
223                         String[] values = (String[]) value;
224                         out.println(&quot;            { \&quot;&quot; + key + &quot;\&quot;,\n                new String[] {&quot;);
225                         for (String s : values) {
226                             out.println(&quot;                    \&quot;&quot; + CLDRConverter.saveConvert(s, useJava) + &quot;\&quot;,&quot;);
227                         }
228                         out.println(&quot;                }\n            },&quot;);
229                     } else {
230                         throw new RuntimeException(&quot;unknown value type: &quot; + value.getClass().getName());
231                     }
232                 } else {
233                     out.println(key + &quot;=&quot; + CLDRConverter.saveConvert((String) map.get(key), useJava));
234                 }
235             }
236             if (useJava) {
237                 out.println(&quot;        };\n        return data;\n    }\n}&quot;);
238             }
239         }
240     }
241 
242     @Override
243     public void generateMetaInfo(Map&lt;String, SortedSet&lt;String&gt;&gt; metaInfo) throws IOException {
244         String dirName = CLDRConverter.DESTINATION_DIR + File.separator + &quot;sun&quot; + File.separator + &quot;util&quot; +
245             File.separator +
246             (CLDRConverter.isBaseModule ? &quot;cldr&quot; + File.separator + File.separator :
247                       &quot;resources&quot; + File.separator + &quot;cldr&quot; + File.separator + &quot;provider&quot; + File.separator);
248         File dir = new File(dirName);
249         if (!dir.exists()) {
250             dir.mkdirs();
251         }
252         String className =
253             (CLDRConverter.isBaseModule ? &quot;CLDRBaseLocaleDataMetaInfo&quot; : &quot;CLDRLocaleDataMetaInfo&quot;);
254         File file = new File(dir, className + &quot;.java&quot;);
255         if (!file.exists()) {
256             file.createNewFile();
257         }
258         CLDRConverter.info(&quot;Generating file &quot; + file);
259 
260         try (PrintWriter out = new PrintWriter(file, &quot;us-ascii&quot;)) {
261             out.printf(CopyrightHeaders.getOpenJDKCopyright());
262 
263             out.printf((CLDRConverter.isBaseModule ? &quot;package sun.util.cldr;\n\n&quot; :
264                                   &quot;package sun.util.resources.cldr.provider;\n\n&quot;)
265                       + &quot;import java.util.HashMap;\n&quot;
266                       + &quot;import java.util.Locale;\n&quot;
267                       + &quot;import java.util.Map;\n&quot;
268                       + &quot;import sun.util.locale.provider.LocaleDataMetaInfo;\n&quot;
269                       + &quot;import sun.util.locale.provider.LocaleProviderAdapter;\n\n&quot;);
270             out.printf(&quot;public class %s implements LocaleDataMetaInfo {\n&quot;, className);
271             out.printf(&quot;    private static final Map&lt;String, String&gt; resourceNameToLocales = new HashMap&lt;&gt;();\n&quot; +
272                        (CLDRConverter.isBaseModule ?
273                        &quot;    private static final Map&lt;Locale, String[]&gt; parentLocalesMap = new HashMap&lt;&gt;();\n&quot; +
274                        &quot;    private static final Map&lt;String, String&gt; languageAliasMap = new HashMap&lt;&gt;();\n\n&quot; :
275                        &quot;\n&quot;) +
276                        &quot;    static {\n&quot;);
277 
278             for (String key : metaInfo.keySet()) {
279                 if (key.startsWith(CLDRConverter.PARENT_LOCALE_PREFIX)) {
280                     String parentTag = key.substring(CLDRConverter.PARENT_LOCALE_PREFIX.length());
281                     if (&quot;root&quot;.equals(parentTag)) {
282                         out.printf(&quot;        parentLocalesMap.put(Locale.ROOT,\n&quot;);
283                     } else {
284                         out.printf(&quot;        parentLocalesMap.put(Locale.forLanguageTag(\&quot;%s\&quot;),\n&quot;,
285                                    parentTag);
286                     }
287                     String[] children = toLocaleList(metaInfo.get(key), true).split(&quot; &quot;);
288                     Arrays.sort(children);
289                     out.printf(&quot;             new String[] {\n&quot; +
290                                &quot;                 &quot;);
291                     int count = 0;
292                     for (int i = 0; i &lt; children.length; i++) {
293                         String child = children[i];
294                         out.printf(&quot;\&quot;%s\&quot;, &quot;, child);
295                         count += child.length() + 4;
296                         if (i != children.length - 1 &amp;&amp; count &gt; 64) {
297                             out.printf(&quot;\n                 &quot;);
298                             count = 0;
299                         }
300                     }
301                     out.printf(&quot;\n             });\n&quot;);
302                 } else {
303                     if (&quot;AvailableLocales&quot;.equals(key)) {
304                         out.printf(&quot;        resourceNameToLocales.put(\&quot;%s\&quot;,\n&quot;, key);
305                         out.printf(&quot;              \&quot;%s\&quot;);\n&quot;, toLocaleList(applyLanguageAliases(metaInfo.get(key)), false));
306                     }
307                 }
308             }
309             // for languageAliasMap
310             if (CLDRConverter.isBaseModule) {
311                 CLDRConverter.handlerSupplMeta.getLanguageAliasData().forEach((key, value) -&gt; {
312                     out.printf(&quot;        languageAliasMap.put(\&quot;%s\&quot;, \&quot;%s\&quot;);\n&quot;, key, value);
313                 });
314             }
315 
316             out.printf(&quot;    }\n\n&quot;);
317 
318             // end of static initializer block.
319 
320             // Canonical TZ names for delayed initialization
321             if (CLDRConverter.isBaseModule) {
322                 out.printf(&quot;    private static class TZCanonicalIDMapHolder {\n&quot;);
323                 out.printf(&quot;        static final Map&lt;String, String&gt; tzCanonicalIDMap = new HashMap&lt;&gt;(600);\n&quot;);
324                 out.printf(&quot;        static {\n&quot;);
325                 CLDRConverter.handlerTimeZone.getData().entrySet().stream()
326                     .forEach(e -&gt; {
327                         String[] ids = ((String)e.getValue()).split(&quot;\\s&quot;);
328                         out.printf(&quot;            tzCanonicalIDMap.put(\&quot;%s\&quot;, \&quot;%s\&quot;);\n&quot;, e.getKey(),
329                                 ids[0]);
330                         for (int i = 1; i &lt; ids.length; i++) {
331                             out.printf(&quot;            tzCanonicalIDMap.put(\&quot;%s\&quot;, \&quot;%s\&quot;);\n&quot;, ids[i],
332                                 ids[0]);
333                         }
334                     });
335                 out.printf(&quot;        }\n    }\n\n&quot;);
336             }
337 
338             out.printf(&quot;    @Override\n&quot; +
339                         &quot;    public LocaleProviderAdapter.Type getType() {\n&quot; +
340                         &quot;        return LocaleProviderAdapter.Type.CLDR;\n&quot; +
341                         &quot;    }\n\n&quot;);
342 
343             out.printf(&quot;    @Override\n&quot; +
344                         &quot;    public String availableLanguageTags(String category) {\n&quot; +
345                         &quot;        return resourceNameToLocales.getOrDefault(category, \&quot;\&quot;);\n&quot; +
346                         &quot;    }\n\n&quot;);
347 
348             if (CLDRConverter.isBaseModule) {
349                 out.printf(&quot;    @Override\n&quot; +
350                            &quot;    public Map&lt;String, String&gt; getLanguageAliasMap() {\n&quot; +
351                            &quot;        return languageAliasMap;\n&quot; +
352                            &quot;    }\n\n&quot;);
353                 out.printf(&quot;    @Override\n&quot; +
354                            &quot;    public Map&lt;String, String&gt; tzCanonicalIDs() {\n&quot; +
355                            &quot;        return TZCanonicalIDMapHolder.tzCanonicalIDMap;\n&quot; +
356                            &quot;    }\n\n&quot;);
357                 out.printf(&quot;    public Map&lt;Locale, String[]&gt; parentLocales() {\n&quot; +
358                            &quot;        return parentLocalesMap;\n&quot; +
359                            &quot;    }\n}&quot;);
360             } else {
361                 out.printf(&quot;}&quot;);
362             }
363         }
364     }
365 
366     private static final Locale.Builder LOCALE_BUILDER = new Locale.Builder();
367     private static boolean isBaseLocale(String localeID) {
368         localeID = localeID.replaceAll(&quot;-&quot;, &quot;_&quot;);
369         // ignore script here
370         Locale locale = LOCALE_BUILDER
371                             .clear()
372                             .setLanguage(CLDRConverter.getLanguageCode(localeID))
373                             .setRegion(CLDRConverter.getRegionCode(localeID))
374                             .build();
375         return CLDRConverter.BASE_LOCALES.contains(locale);
376     }
377 
378     private static String toLocaleList(SortedSet&lt;String&gt; set, boolean all) {
379         StringBuilder sb = new StringBuilder(set.size() * 6);
380         for (String id : set) {
381             if (!&quot;root&quot;.equals(id)) {
382                 if (!all &amp;&amp; CLDRConverter.isBaseModule ^ isBaseLocale(id)) {
383                     continue;
384                 }
385                 sb.append(&#39; &#39;);
386                 sb.append(id);
387             }
388         }
389         return sb.toString();
390     }
391 
392     private static SortedSet&lt;String&gt; applyLanguageAliases(SortedSet&lt;String&gt; tags) {
393         CLDRConverter.handlerSupplMeta.getLanguageAliasData().forEach((key, value) -&gt; {
394             if (tags.remove(key)) {
395                 tags.add(value);
396             }
397         });
398         return tags;
399     }
400 }
    </pre>
  </body>
</html>