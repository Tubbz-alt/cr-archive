<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/lib/jdk/test/lib/containers/cgroup/MetricsTester.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CPUSetsReader.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../docker/Common.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/containers/cgroup/MetricsTester.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2020, Red Hat Inc.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,579 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  package jdk.test.lib.containers.cgroup;
  
<span class="line-modified">! import java.io.File;</span>
<span class="line-modified">! import java.io.FileNotFoundException;</span>
<span class="line-removed">- import java.io.IOException;</span>
<span class="line-removed">- import java.nio.file.Files;</span>
<span class="line-removed">- import java.nio.file.Path;</span>
<span class="line-removed">- import java.nio.file.Paths;</span>
<span class="line-removed">- import java.util.Arrays;</span>
<span class="line-removed">- import java.util.HashMap;</span>
<span class="line-removed">- import java.util.HashSet;</span>
<span class="line-removed">- import java.util.Map;</span>
<span class="line-removed">- import java.util.Scanner;</span>
<span class="line-removed">- import java.util.Set;</span>
<span class="line-removed">- import java.util.stream.Collectors;</span>
<span class="line-removed">- import java.util.stream.IntStream;</span>
<span class="line-removed">- import java.util.stream.LongStream;</span>
<span class="line-removed">- import java.util.stream.Stream;</span>
  import jdk.internal.platform.Metrics;
  
  public class MetricsTester {
  
<span class="line-modified">!     private static final double ERROR_MARGIN = 0.1;</span>
<span class="line-modified">!     private static long unlimited_minimum = 0x7FFFFFFFFF000000L;</span>
<span class="line-removed">-     long startSysVal;</span>
<span class="line-removed">-     long startUserVal;</span>
<span class="line-removed">-     long startUsage;</span>
<span class="line-removed">-     long startPerCpu[];</span>
<span class="line-removed">- </span>
<span class="line-removed">-     enum SubSystem {</span>
<span class="line-removed">-         MEMORY(&quot;memory&quot;),</span>
<span class="line-removed">-         CPUSET(&quot;cpuset&quot;),</span>
<span class="line-removed">-         CPU(&quot;cpu&quot;),</span>
<span class="line-removed">-         CPUACCT(&quot;cpuacct&quot;),</span>
<span class="line-removed">-         BLKIO(&quot;blkio&quot;);</span>
  
<span class="line-modified">!         private String value;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         SubSystem(String value) {</span>
<span class="line-modified">!             this.value = value;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         public String value() {</span>
<span class="line-modified">!             return value;</span>
          }
      }
  
<span class="line-modified">!     private static final Set&lt;String&gt; allowedSubSystems =</span>
<span class="line-modified">!             Stream.of(SubSystem.values()).map(SubSystem::value).collect(Collectors.toSet());</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static final Map&lt;String, String[]&gt; subSystemPaths = new HashMap&lt;&gt;();</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static void setPath(String[] line) {</span>
<span class="line-modified">!         String cgroupPath = line[2];</span>
<span class="line-modified">!         String[] subSystems = line[1].split(&quot;,&quot;);</span>
<span class="line-modified">! </span>
<span class="line-removed">-         for (String subSystem : subSystems) {</span>
<span class="line-removed">-             if (allowedSubSystems.contains(subSystem)) {</span>
<span class="line-removed">-                 String[] paths = subSystemPaths.get(subSystem);</span>
<span class="line-removed">-                 String finalPath = &quot;&quot;;</span>
<span class="line-removed">-                 String root = paths[0];</span>
<span class="line-removed">-                 String mountPoint = paths[1];</span>
<span class="line-removed">-                 if (root != null &amp;&amp; cgroupPath != null) {</span>
<span class="line-removed">-                     if (root.equals(&quot;/&quot;)) {</span>
<span class="line-removed">-                         if (cgroupPath.equals(&quot;/&quot;)) {</span>
<span class="line-removed">-                             finalPath = mountPoint + cgroupPath;</span>
<span class="line-removed">-                         } else {</span>
<span class="line-removed">-                             finalPath = mountPoint;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         if (root.equals(cgroupPath)) {</span>
<span class="line-removed">-                             finalPath = mountPoint;</span>
<span class="line-removed">-                         } else {</span>
<span class="line-removed">-                             if (root.indexOf(cgroupPath) == 0) {</span>
<span class="line-removed">-                                 if (cgroupPath.length() &gt; root.length()) {</span>
<span class="line-removed">-                                     String cgroupSubstr = cgroupPath.substring(root.length());</span>
<span class="line-removed">-                                     finalPath = mountPoint + cgroupSubstr;</span>
<span class="line-removed">-                                 }</span>
<span class="line-removed">-                             }</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 subSystemPaths.put(subSystem, new String[]{finalPath});</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void createSubsystems(String[] line) {</span>
<span class="line-removed">-         if (line.length &lt; 5) return;</span>
<span class="line-removed">-         Path p = Paths.get(line[4]);</span>
<span class="line-removed">-         String subsystemName = p.getFileName().toString();</span>
<span class="line-removed">-         if (subsystemName != null) {</span>
<span class="line-removed">-             for (String subSystem : subsystemName.split(&quot;,&quot;)) {</span>
<span class="line-removed">-                 if (allowedSubSystems.contains(subSystem)) {</span>
<span class="line-removed">-                     subSystemPaths.put(subSystem, new String[]{line[3], line[4]});</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void setup() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         // Initialize CPU usage metrics before we do any testing.</span>
<span class="line-removed">-         startSysVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">-         startUserVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">-         startUsage = metrics.getCpuUsage();</span>
<span class="line-removed">-         startPerCpu = metrics.getPerCpuUsage();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             Stream&lt;String&gt; lines = Files.lines(Paths.get(&quot;/proc/self/mountinfo&quot;));</span>
<span class="line-removed">-             lines.filter(line -&gt; line.contains(&quot; - cgroup cgroup &quot;))</span>
<span class="line-removed">-                     .map(line -&gt; line.split(&quot; &quot;))</span>
<span class="line-removed">-                     .forEach(MetricsTester::createSubsystems);</span>
<span class="line-removed">-             lines.close();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             lines = Files.lines(Paths.get(&quot;/proc/self/cgroup&quot;));</span>
<span class="line-removed">-             lines.map(line -&gt; line.split(&quot;:&quot;))</span>
<span class="line-removed">-                     .filter(line -&gt; (line.length &gt;= 3))</span>
<span class="line-removed">-                     .forEach(MetricsTester::setPath);</span>
<span class="line-removed">-             lines.close();</span>
<span class="line-removed">-         } catch (IOException e) {</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static String getFileContents(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">-         String fname = subSystemPaths.get(subSystem.value())[0] + File.separator + fileName;</span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             return new Scanner(new File(fname)).useDelimiter(&quot;\\Z&quot;).next();</span>
<span class="line-removed">-         } catch (FileNotFoundException e) {</span>
<span class="line-removed">-             System.err.println(&quot;Unable to open : &quot; + fname);</span>
<span class="line-removed">-             return &quot;&quot;;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static long getLongValueFromFile(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">-         String data = getFileContents(subSystem, fileName);</span>
<span class="line-removed">-         return data.isEmpty() ? 0L : Long.parseLong(data);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static long getLongValueFromFile(SubSystem subSystem, String metric, String subMetric) {</span>
<span class="line-removed">-         String stats = getFileContents(subSystem, metric);</span>
<span class="line-removed">-         String[] tokens = stats.split(&quot;[\\r\\n]+&quot;);</span>
<span class="line-removed">-         for (int i = 0; i &lt; tokens.length; i++) {</span>
<span class="line-removed">-             if (tokens[i].startsWith(subMetric)) {</span>
<span class="line-removed">-                 return Long.parseLong(tokens[i].split(&quot;\\s+&quot;)[1]);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return 0L;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static double getDoubleValueFromFile(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">-         String data = getFileContents(subSystem, fileName);</span>
<span class="line-removed">-         return data.isEmpty() ? 0.0 : Double.parseDouble(data);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private boolean compareWithErrorMargin(long oldVal, long newVal) {</span>
<span class="line-removed">-         return Math.abs(oldVal - newVal) &lt;= Math.abs(oldVal * ERROR_MARGIN);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private boolean compareWithErrorMargin(double oldVal, double newVal) {</span>
<span class="line-removed">-         return Math.abs(oldVal - newVal) &lt;= Math.abs(oldVal * ERROR_MARGIN);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void fail(SubSystem system, String metric, long oldVal, long testVal) {</span>
<span class="line-removed">-         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">-                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void fail(SubSystem system, String metric, String oldVal, String testVal) {</span>
<span class="line-removed">-         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">-                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void fail(SubSystem system, String metric, double oldVal, double testVal) {</span>
<span class="line-removed">-         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">-                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void fail(SubSystem system, String metric, boolean oldVal, boolean testVal) {</span>
<span class="line-removed">-         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">-                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void warn(SubSystem system, String metric, long oldVal, long testVal) {</span>
<span class="line-removed">-         System.err.println(&quot;Warning - &quot; + system.value + &quot;:&quot; + metric</span>
<span class="line-removed">-                 + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testMemorySubsystem() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // User Memory</span>
<span class="line-removed">-         long oldVal = metrics.getMemoryFailCount();</span>
<span class="line-removed">-         long newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.failcnt&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryLimit();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.limit_in_bytes&quot;);</span>
<span class="line-removed">-         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.max_usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Kernel memory</span>
<span class="line-removed">-         oldVal = metrics.getKernelMemoryFailCount();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.failcnt&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getKernelMemoryLimit();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.limit_in_bytes&quot;);</span>
<span class="line-removed">-         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getKernelMemoryMaxUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.max_usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getKernelMemoryUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         //TCP Memory</span>
<span class="line-removed">-         oldVal = metrics.getTcpMemoryFailCount();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.failcnt&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getTcpMemoryLimit();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.limit_in_bytes&quot;);</span>
<span class="line-removed">-         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getTcpMemoryMaxUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.max_usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getTcpMemoryUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         //  Memory and Swap</span>
<span class="line-removed">-         oldVal = metrics.getMemoryAndSwapFailCount();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.failcnt&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.memsw.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryAndSwapLimit();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.limit_in_bytes&quot;);</span>
<span class="line-removed">-         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.memsw.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryAndSwapMaxUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.max_usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.memsw.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemoryAndSwapUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.usage_in_bytes&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.memsw.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getMemorySoftLimit();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.soft_limit_in_bytes&quot;);</span>
<span class="line-removed">-         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;memory.soft_limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         boolean oomKillEnabled = metrics.isMemoryOOMKillEnabled();</span>
<span class="line-removed">-         boolean newOomKillEnabled = getLongValueFromFile(SubSystem.MEMORY,</span>
<span class="line-removed">-                 &quot;memory.oom_control&quot;, &quot;oom_kill_disable&quot;) == 0L ? true : false;</span>
<span class="line-removed">-         if (oomKillEnabled != newOomKillEnabled) {</span>
<span class="line-removed">-             throw new RuntimeException(&quot;Test failed for - &quot; + SubSystem.MEMORY.value + &quot;:&quot;</span>
<span class="line-removed">-                     + &quot;memory.oom_control:oom_kill_disable&quot; + &quot;, expected [&quot;</span>
<span class="line-removed">-                     + oomKillEnabled + &quot;], got [&quot; + newOomKillEnabled + &quot;]&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testCpuAccounting() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         long oldVal = metrics.getCpuUsage();</span>
<span class="line-removed">-         long newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.usage&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             warn(SubSystem.CPUACCT, &quot;cpuacct.usage&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         Long[] newVals = Stream.of(getFileContents(SubSystem.CPUACCT, &quot;cpuacct.usage_percpu&quot;)</span>
<span class="line-removed">-                 .split(&quot;\\s+&quot;))</span>
<span class="line-removed">-                 .map(Long::parseLong)</span>
<span class="line-removed">-                 .toArray(Long[]::new);</span>
<span class="line-removed">-         Long[] oldVals = LongStream.of(metrics.getPerCpuUsage()).boxed().toArray(Long[]::new);</span>
<span class="line-removed">-         for (int i = 0; i &lt; oldVals.length; i++) {</span>
<span class="line-removed">-             if (!compareWithErrorMargin(oldVals[i], newVals[i])) {</span>
<span class="line-removed">-                 warn(SubSystem.CPUACCT, &quot;cpuacct.usage_percpu&quot;, oldVals[i], newVals[i]);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.stat&quot;, &quot;user&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             warn(SubSystem.CPUACCT, &quot;cpuacct.usage - user&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.stat&quot;, &quot;system&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             warn(SubSystem.CPUACCT, &quot;cpuacct.usage - system&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testCpuSchedulingMetrics() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         long oldVal = metrics.getCpuPeriod();</span>
<span class="line-removed">-         long newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.cfs_period_us&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.cfs_period_us&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuQuota();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.cfs_quota_us&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.cfs_quota_us&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuShares();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.shares&quot;);</span>
<span class="line-removed">-         if (newVal == 0 || newVal == 1024) newVal = -1;</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.shares&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuNumPeriods();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;nr_periods&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.stat - nr_periods&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuNumThrottled();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;nr_throttled&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.stat - nr_throttled&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getCpuThrottledTime();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;throttled_time&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUACCT, &quot;cpu.stat - throttled_time&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testCpuSets() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         Integer[] oldVal = Arrays.stream(metrics.getCpuSetCpus()).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">-         Arrays.sort(oldVal);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         String cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.cpus&quot;);</span>
<span class="line-removed">-         // Parse range string in the format 1,2-6,7</span>
<span class="line-removed">-         Integer[] newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">-             if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">-                 String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">-                 return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">-                         Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }).toArray(Integer[]::new);</span>
<span class="line-removed">-         Arrays.sort(newVal);</span>
<span class="line-removed">-         if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">-             fail(SubSystem.CPUSET, &quot;cpuset.cpus&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">-                 Arrays.toString(newVal));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         int [] cpuSets = metrics.getEffectiveCpuSetCpus();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Skip this test if this metric is supported on this platform</span>
<span class="line-removed">-         if (cpuSets.length != 0) {</span>
<span class="line-removed">-             oldVal = Arrays.stream(cpuSets).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">-             Arrays.sort(oldVal);</span>
<span class="line-removed">-             cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.effective_cpus&quot;);</span>
<span class="line-removed">-             newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">-                 if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">-                     String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">-                     return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">-                             Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }).toArray(Integer[]::new);</span>
<span class="line-removed">-             Arrays.sort(newVal);</span>
<span class="line-removed">-             if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">-                 fail(SubSystem.CPUSET, &quot;cpuset.effective_cpus&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">-                         Arrays.toString(newVal));</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = Arrays.stream(metrics.getCpuSetMems()).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">-         Arrays.sort(oldVal);</span>
<span class="line-removed">-         cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.mems&quot;);</span>
<span class="line-removed">-         newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">-             if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">-                 String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">-                 return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">-                         Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }).toArray(Integer[]::new);</span>
<span class="line-removed">-         Arrays.sort(newVal);</span>
<span class="line-removed">-         if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">-             fail(SubSystem.CPUSET, &quot;cpuset.mems&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">-                     Arrays.toString(newVal));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         int [] cpuSetMems = metrics.getEffectiveCpuSetMems();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Skip this test if this metric is supported on this platform</span>
<span class="line-removed">-         if (cpuSetMems.length != 0) {</span>
<span class="line-removed">-             oldVal = Arrays.stream(cpuSetMems).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">-             Arrays.sort(oldVal);</span>
<span class="line-removed">-             cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.effective_mems&quot;);</span>
<span class="line-removed">-             newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">-                 if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">-                     String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">-                     return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">-                             Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }).toArray(Integer[]::new);</span>
<span class="line-removed">-             Arrays.sort(newVal);</span>
<span class="line-removed">-             if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">-                 fail(SubSystem.CPUSET, &quot;cpuset.effective_mems&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">-                         Arrays.toString(newVal));</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         double oldValue = metrics.getCpuSetMemoryPressure();</span>
<span class="line-removed">-         double newValue = getDoubleValueFromFile(SubSystem.CPUSET, &quot;cpuset.memory_pressure&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldValue, newValue)) {</span>
<span class="line-removed">-             fail(SubSystem.CPUSET, &quot;cpuset.memory_pressure&quot;, oldValue, newValue);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         boolean oldV = metrics.isCpuSetMemoryPressureEnabled();</span>
<span class="line-removed">-         boolean newV = getLongValueFromFile(SubSystem.CPUSET,</span>
<span class="line-removed">-                 &quot;cpuset.memory_pressure_enabled&quot;) == 1 ? true : false;</span>
<span class="line-removed">-         if (oldV != newV) {</span>
<span class="line-removed">-             fail(SubSystem.CPUSET, &quot;cpuset.memory_pressure_enabled&quot;, oldV, newV);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testBlkIO() {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-             long oldVal = metrics.getBlkIOServiceCount();</span>
<span class="line-removed">-         long newVal = getLongValueFromFile(SubSystem.BLKIO,</span>
<span class="line-removed">-                 &quot;blkio.throttle.io_service_bytes&quot;, &quot;Total&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.BLKIO, &quot;blkio.throttle.io_service_bytes - Total&quot;,</span>
<span class="line-removed">-                     oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         oldVal = metrics.getBlkIOServiced();</span>
<span class="line-removed">-         newVal = getLongValueFromFile(SubSystem.BLKIO, &quot;blkio.throttle.io_serviced&quot;, &quot;Total&quot;);</span>
<span class="line-removed">-         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">-             fail(SubSystem.BLKIO, &quot;blkio.throttle.io_serviced - Total&quot;, oldVal, newVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testCpuConsumption() throws IOException, InterruptedException {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         // make system call</span>
<span class="line-removed">-         long newSysVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">-         long newUserVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">-         long newUsage = metrics.getCpuUsage();</span>
<span class="line-removed">-         long[] newPerCpu = metrics.getPerCpuUsage();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (newSysVal &lt;= startSysVal) {</span>
<span class="line-removed">-             fail(SubSystem.CPU, &quot;getCpuSystemUsage&quot;, newSysVal, startSysVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (newUserVal &lt;= startUserVal) {</span>
<span class="line-removed">-             fail(SubSystem.CPU, &quot;getCpuUserUsage&quot;, newUserVal, startUserVal);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (newUsage &lt;= startUsage) {</span>
<span class="line-removed">-             fail(SubSystem.CPU, &quot;getCpuUserUsage&quot;, newUsage, startUsage);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         boolean success = false;</span>
<span class="line-removed">-         for (int i = 0; i &lt; startPerCpu.length; i++) {</span>
<span class="line-removed">-             if (newPerCpu[i] &gt; startPerCpu[i]) {</span>
<span class="line-removed">-                 success = true;</span>
<span class="line-removed">-                 break;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if(!success) fail(SubSystem.CPU, &quot;getPerCpuUsage&quot;, Arrays.toString(newPerCpu),</span>
<span class="line-removed">-                 Arrays.toString(startPerCpu));</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     public void testMemoryUsage() throws Exception {</span>
<span class="line-removed">-         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         long memoryMaxUsage = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">-         long memoryUsage = metrics.getMemoryUsage();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         long[] ll = new long[64*1024*1024]; // 64M</span>
<span class="line-removed">- </span>
<span class="line-removed">-         long newMemoryMaxUsage = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">-         long newMemoryUsage = metrics.getMemoryUsage();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if(newMemoryMaxUsage &lt; memoryMaxUsage) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;getMemoryMaxUsage&quot;, newMemoryMaxUsage,</span>
<span class="line-removed">-                     memoryMaxUsage);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if(newMemoryUsage &lt; memoryUsage) {</span>
<span class="line-removed">-             fail(SubSystem.MEMORY, &quot;getMemoryUsage&quot;, newMemoryUsage, memoryUsage);</span>
<span class="line-removed">-         }</span>
      }
  
      public static void main(String[] args) throws Exception {
          // If cgroups is not configured, report success
<span class="line-modified">!         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">-         if (metrics == null) {</span>
              System.out.println(&quot;TEST PASSED!!!&quot;);
              return;
          }
  
          MetricsTester metricsTester = new MetricsTester();
<span class="line-modified">!         metricsTester.setup();</span>
<span class="line-removed">-         metricsTester.testCpuAccounting();</span>
<span class="line-removed">-         metricsTester.testCpuSchedulingMetrics();</span>
<span class="line-removed">-         metricsTester.testCpuSets();</span>
<span class="line-removed">-         metricsTester.testMemorySubsystem();</span>
<span class="line-removed">-         metricsTester.testBlkIO();</span>
<span class="line-removed">-         metricsTester.testCpuConsumption();</span>
<span class="line-removed">-         metricsTester.testMemoryUsage();</span>
          System.out.println(&quot;TEST PASSED!!!&quot;);
      }
  }
<span class="line-new-header">--- 19,60 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-added">+ </span>
  package jdk.test.lib.containers.cgroup;
  
<span class="line-modified">! import java.util.Objects;</span>
<span class="line-modified">! </span>
  import jdk.internal.platform.Metrics;
  
<span class="line-added">+ /**</span>
<span class="line-added">+  * Cgroup version agnostic metrics tester</span>
<span class="line-added">+  *</span>
<span class="line-added">+  */</span>
  public class MetricsTester {
  
<span class="line-modified">!     private static final String CGROUP_V1 = &quot;cgroupv1&quot;;</span>
<span class="line-modified">!     private static final String CGROUP_V2 = &quot;cgroupv2&quot;;</span>
  
<span class="line-modified">!     private static CgroupMetricsTester createInstance(Metrics m) {</span>
<span class="line-modified">!         Objects.requireNonNull(m);</span>
<span class="line-modified">!         if (CGROUP_V1.equals(m.getProvider())) {</span>
<span class="line-modified">!             MetricsTesterCgroupV1 t = new MetricsTesterCgroupV1();</span>
<span class="line-modified">!             t.setup();</span>
<span class="line-modified">!             return t;</span>
<span class="line-modified">!         } else if (CGROUP_V2.equals(m.getProvider())) {</span>
<span class="line-modified">!             return new MetricsTesterCgroupV2();</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             System.err.println(&quot;WARNING: Metrics provider, &#39;&quot; + m.getProvider()</span>
<span class="line-added">+                                                               + &quot;&#39; is unknown!&quot;);</span>
<span class="line-added">+             return null;</span>
          }
      }
  
<span class="line-modified">!     public void testAll(Metrics m) throws Exception {</span>
<span class="line-modified">!         CgroupMetricsTester tester =  createInstance(m);</span>
<span class="line-modified">!         tester.testCpuAccounting();</span>
<span class="line-modified">!         tester.testCpuConsumption();</span>
<span class="line-modified">!         tester.testCpuSchedulingMetrics();</span>
<span class="line-modified">!         tester.testCpuSets();</span>
<span class="line-modified">!         tester.testMemorySubsystem();</span>
<span class="line-modified">!         tester.testMemoryUsage();</span>
<span class="line-modified">!         tester.testMisc();</span>
      }
  
      public static void main(String[] args) throws Exception {
<span class="line-added">+         Metrics m = Metrics.systemMetrics();</span>
          // If cgroups is not configured, report success
<span class="line-modified">!         if (m == null) {</span>
              System.out.println(&quot;TEST PASSED!!!&quot;);
              return;
          }
  
          MetricsTester metricsTester = new MetricsTester();
<span class="line-modified">!         metricsTester.testAll(m);</span>
          System.out.println(&quot;TEST PASSED!!!&quot;);
      }
  }
</pre>
<center><a href="CPUSetsReader.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../docker/Common.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>