<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/lib/jdk/test/lib/SecurityTools.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib;
 25 
 26 import java.io.File;
 27 import java.io.IOException;
 28 import java.nio.file.Files;
 29 import java.nio.file.Path;
 30 import java.nio.file.Paths;
 31 import java.util.List;
 32 import java.util.stream.Collectors;
 33 import java.util.stream.Stream;
 34 
 35 import jdk.test.lib.process.OutputAnalyzer;
 36 import jdk.test.lib.process.ProcessTools;
 37 
 38 /**
 39  * Run security tools (including jarsigner and keytool) in a new process.
 40  * The en_US locale is always used so a test can always match output to
 41  * English text. {@code /dev/urandom} is used as entropy source so tool will
 42  * not block because of entropy scarcity. {@code -Jvm-options} is supported
 43  * as an argument.
 44  */
 45 public class SecurityTools {
 46 
 47     /**
 48      * The response file name for keytool. Use {@link #setResponse} to
 49      * create one. Do NOT manipulate it directly.
 50      */
 51     public static final String RESPONSE_FILE = &quot;security_tools_response.txt&quot;;
 52 
 53     private SecurityTools() {}
 54 
 55     private static ProcessBuilder getProcessBuilder(String tool, List&lt;String&gt; args) {
 56         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(tool)
 57                 .addVMArg(&quot;-Duser.language=en&quot;)
 58                 .addVMArg(&quot;-Duser.country=US&quot;);
 59         if (!Platform.isWindows()) {
 60             launcher.addVMArg(&quot;-Djava.security.egd=file:/dev/./urandom&quot;);
 61         }
 62         for (String arg : args) {
 63             if (arg.startsWith(&quot;-J&quot;)) {
 64                 launcher.addVMArg(arg.substring(2));
 65             } else {
 66                 launcher.addToolArg(arg);
 67             }
 68         }
 69         return new ProcessBuilder(launcher.getCommand());
 70     }
 71 
 72     /**
 73      * Runs keytool.
 74      *
 75      * @param args arguments to keytool
 76      * @return an {@link OutputAnalyzer} object
 77      * @throws Exception if there is an error
 78      */
 79     public static OutputAnalyzer keytool(List&lt;String&gt; args)
 80             throws Exception {
 81 
 82         ProcessBuilder pb = getProcessBuilder(&quot;keytool&quot;, args);
 83 
 84         Path p = Paths.get(RESPONSE_FILE);
 85         if (!Files.exists(p)) {
 86             Files.createFile(p);
 87         }
 88         pb.redirectInput(ProcessBuilder.Redirect.from(new File(RESPONSE_FILE)));
 89 
 90         try {
 91             return execute(pb);
 92         } finally {
 93             Files.delete(p);
 94         }
 95     }
 96 
 97     /**
 98      * Runs keytool.
 99      *
100      * @param args arguments to keytool in a single string. Only call this if
101      *             there is no white space inside an argument. This string will
102      *             be split with {@code \s+}.
103      * @return an {@link OutputAnalyzer} object
104      * @throws Exception if there is an error
105      */
106     public static OutputAnalyzer keytool(String args) throws Exception {
107         return keytool(args.split(&quot;\\s+&quot;));
108     }
109 
110     /**
111      * Runs keytool.
112      *
113      * @param args arguments to keytool
114      * @return an {@link OutputAnalyzer} object
115      * @throws Exception if there is an error
116      */
117     public static OutputAnalyzer keytool(String... args) throws Exception {
118         return keytool(List.of(args));
119     }
120 
121 
122     /**
123      * Sets the responses (user input) for keytool.
124      * &lt;p&gt;
125      * For example, if keytool requires entering a password twice, call
126      * {@code setResponse(&quot;password&quot;, &quot;password&quot;)}. Do NOT append a newline
127      * character to each response. If there are useless responses at the end,
128      * they will be discarded silently. If there are less responses than
129      * necessary, keytool will read EOF. The responses will be written into
130      * {@linkplain #RESPONSE_FILE a local file} and will only be used by the
131      * next keytool run. After the run, the file is removed. Calling this
132      * method will always overwrite the previous response file (if exists).
133      *
134      * @param responses response to keytool
135      * @throws IOException if there is an error
136      */
137     public static void setResponse(String... responses) throws IOException {
138         String text;
139         if (responses.length &gt; 0) {
140             text = Stream.of(responses).collect(
141                     Collectors.joining(&quot;\n&quot;, &quot;&quot;, &quot;\n&quot;));
142         } else {
143             text = &quot;&quot;;
144         }
145         Files.write(Paths.get(RESPONSE_FILE), text.getBytes());
146     }
147 
148     /**
149      * Runs jarsigner.
150      *
151      * @param args arguments to jarsigner
152      * @return an {@link OutputAnalyzer} object
153      * @throws Exception if there is an error
154      */
155     public static OutputAnalyzer jarsigner(List&lt;String&gt; args)
156             throws Exception {
157         return execute(getProcessBuilder(&quot;jarsigner&quot;, args));
158     }
159 
160     private static OutputAnalyzer execute(ProcessBuilder pb) throws Exception {
161         try {
162             OutputAnalyzer oa = ProcessTools.executeCommand(pb);
163             System.out.println(&quot;Exit value: &quot; + oa.getExitValue());
164             return oa;
165         } catch (Throwable t) {
166             if (t instanceof Exception) {
167                 throw (Exception) t;
168             } else {
169                 throw new Exception(t);
170             }
171         }
172     }
173 
174     /**
175      * Runs jarsigner.
176      *
177      * @param args arguments to jarsigner in a single string. Only call this if
178      *             there is no white space inside an argument. This string will
179      *             be split with {@code \s+}.
180      * @return an {@link OutputAnalyzer} object
181      * @throws Exception if there is an error
182      */
183     public static OutputAnalyzer jarsigner(String args) throws Exception {
184 
185         return jarsigner(args.split(&quot;\\s+&quot;));
186     }
187 
188     /**
189      * Runs jarsigner.
190      *
191      * @param args arguments to jarsigner
192      * @return an {@link OutputAnalyzer} object
193      * @throws Exception if there is an error
194      */
195     public static OutputAnalyzer jarsigner(String... args) throws Exception {
196         return jarsigner(List.of(args));
197     }
198 
199     /**
200      * Runs ktab.
201      *
202      * @param args arguments to ktab in a single string. Only call this if
203      *             there is no white space inside an argument. This string will
204      *             be split with {@code \s+}.
205      * @return an {@link OutputAnalyzer} object
206      * @throws Exception if there is an error
207      */
208     public static OutputAnalyzer ktab(String args) throws Exception {
209         return execute(getProcessBuilder(
210                 &quot;ktab&quot;, List.of(args.trim().split(&quot;\\s+&quot;))));
211     }
212 
213     /**
214      * Runs klist.
215      *
216      * @param args arguments to klist in a single string. Only call this if
217      *             there is no white space inside an argument. This string will
218      *             be split with {@code \s+}.
219      * @return an {@link OutputAnalyzer} object
220      * @throws Exception if there is an error
221      */
222     public static OutputAnalyzer klist(String args) throws Exception {
223         return execute(getProcessBuilder(
224                 &quot;klist&quot;, List.of(args.trim().split(&quot;\\s+&quot;))));
225     }
226 }
227 
    </pre>
  </body>
</html>