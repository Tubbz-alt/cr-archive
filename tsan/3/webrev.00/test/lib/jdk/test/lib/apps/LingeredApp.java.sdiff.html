<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/lib/jdk/test/lib/apps/LingeredApp.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../Utils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../artifacts/DefaultArtifactManager.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/apps/LingeredApp.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib.apps;
 25 
 26 import java.io.BufferedReader;
 27 import java.io.ByteArrayOutputStream;
 28 import java.io.IOException;
 29 import java.io.StringReader;
 30 import java.nio.file.Files;
 31 import java.nio.file.NoSuchFileException;
 32 import java.nio.file.Path;
 33 import java.nio.file.Paths;
 34 import java.nio.file.attribute.BasicFileAttributes;
 35 import java.nio.file.attribute.FileTime;
 36 import java.util.ArrayList;

 37 import java.util.Date;
 38 import java.util.List;
 39 import java.util.Map;
 40 import java.util.stream.Collectors;
 41 import java.util.UUID;

 42 import jdk.test.lib.process.OutputBuffer;
 43 import jdk.test.lib.process.StreamPumper;
 44 
 45 /**
 46  * This is a framework to launch an app that could be synchronized with caller
 47  * to make further attach actions reliable across supported platforms
 48 
 49  * Caller example:
 50  *   SmartTestApp a = SmartTestApp.startApp(cmd);
 51  *     // do something
 52  *   a.stopApp();
 53  *
 54  *   or fine grained control
 55  *
 56  *   a = new SmartTestApp(&quot;MyLock.lck&quot;);
 57  *   a.createLock();
 58  *   a.runApp();
 59  *   a.waitAppReady();
 60  *     // do something
 61  *   a.deleteLock();
</pre>
<hr />
<pre>
264                 break;
265             }
266 
267             // Make sure process didn&#39;t already exit
268             if (!appProcess.isAlive()) {
269                 throw new IOException(&quot;App exited unexpectedly with &quot; + appProcess.exitValue());
270             }
271 
272             try {
273                 Thread.sleep(spinDelay);
274             } catch (InterruptedException ex) {
275                 // pass
276             }
277         }
278     }
279 
280     /**
281      * Analyze an environment and prepare a command line to
282      * run the app, app name should be added explicitly
283      */
<span class="line-modified">284     public List&lt;String&gt; runAppPrepare(List&lt;String&gt; vmArguments) {</span>
285         // We should always use testjava or throw an exception,
286         // so we can&#39;t use JDKToolFinder.getJDKTool(&quot;java&quot;);
287         // that falls back to compile java on error
288         String jdkPath = System.getProperty(&quot;test.jdk&quot;);
289         if (jdkPath == null) {
290             // we are not under jtreg, try env
291             Map&lt;String, String&gt; env = System.getenv();
292             jdkPath = env.get(&quot;TESTJAVA&quot;);
293         }
294 
295         if (jdkPath == null) {
296             throw new RuntimeException(&quot;Can&#39;t determine jdk path neither test.jdk property no TESTJAVA env are set&quot;);
297         }
298 
299         String osname = System.getProperty(&quot;os.name&quot;);
300         String javapath = jdkPath + ((osname.startsWith(&quot;window&quot;)) ? &quot;/bin/java.exe&quot; : &quot;/bin/java&quot;);
301 
302         List&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
303         cmd.add(javapath);
304 
305         if (vmArguments == null) {
<span class="line-modified">306             // Propagate test.vm.options to LingeredApp, filter out possible empty options</span>
<span class="line-modified">307             String testVmOpts[] = System.getProperty(&quot;test.vm.opts&quot;,&quot;&quot;).split(&quot;\\s+&quot;);</span>
<span class="line-removed">308             for (String s : testVmOpts) {</span>
<span class="line-removed">309                 if (!s.equals(&quot;&quot;)) {</span>
<span class="line-removed">310                     cmd.add(s);</span>
<span class="line-removed">311                 }</span>
<span class="line-removed">312             }</span>
313         } else {
314             // Lets user manage LingeredApp options
<span class="line-removed">315             cmd.addAll(vmArguments);</span>
316         }

317 
318         // Make sure we set correct classpath to run the app
319         cmd.add(&quot;-cp&quot;);
320         String classpath = System.getProperty(&quot;test.class.path&quot;);
321         cmd.add((classpath == null) ? &quot;.&quot; : classpath);
322 
323         return cmd;
324     }
325 
326     /**
327      * Assemble command line to a printable string
328      */
329     public void printCommandLine(List&lt;String&gt; cmd) {
330         // A bit of verbosity
331         StringBuilder cmdLine = new StringBuilder();
332         for (String strCmd : cmd) {
333             cmdLine.append(&quot;&#39;&quot;).append(strCmd).append(&quot;&#39; &quot;);
334         }
335 
336         System.err.println(&quot;Command line: [&quot; + cmdLine.toString() + &quot;]&quot;);
337     }
338 
339     /**
340      * Run the app.
341      *
342      * @param vmArguments
343      * @throws IOException
344      */
<span class="line-modified">345     public void runApp(List&lt;String&gt; vmArguments)</span>
346             throws IOException {
347 
348         List&lt;String&gt; cmd = runAppPrepare(vmArguments);
349 
350         cmd.add(this.getAppName());
351         cmd.add(lockFileName);
352 
353         printCommandLine(cmd);
354 
355         ProcessBuilder pb = new ProcessBuilder(cmd);
356         // ProcessBuilder.start can throw IOException
357         appProcess = pb.start();
358 
359         startOutputPumpers();
360     }
361 
362     private void finishApp() {
<span class="line-modified">363         OutputBuffer output = getOutput();</span>
<span class="line-modified">364         String msg =</span>
<span class="line-modified">365             &quot; LingeredApp stdout: [&quot; + output.getStdout() + &quot;];\n&quot; +</span>
<span class="line-modified">366             &quot; LingeredApp stderr: [&quot; + output.getStderr() + &quot;]\n&quot; +</span>
<span class="line-modified">367             &quot; LingeredApp exitValue = &quot; + appProcess.exitValue();</span>

368 
<span class="line-modified">369         System.err.println(msg);</span>

370     }
371 
372     /**
373      * Delete lock file that signals app to terminate, then
374      * wait until app is actually terminated.
375      * @throws IOException
376      */
377     public void stopApp() throws IOException {
378         deleteLock();
379         // The startApp() of the derived app can throw
380         // an exception before the LA actually starts
381         if (appProcess != null) {
382             waitAppTerminate();



383             int exitcode = appProcess.exitValue();
384             if (exitcode != 0) {
385                 throw new IOException(&quot;LingeredApp terminated with non-zero exit code &quot; + exitcode);
386             }
387         }
<span class="line-removed">388         finishApp();</span>
389     }
390 
391     /**
392      *  High level interface for test writers
393      */
394     /**
<span class="line-modified">395      * Factory method that creates LingeredApp object with ready to use application</span>
396      * lock name is autogenerated
<span class="line-modified">397      * @param cmd - vm options, could be null to auto add testvm.options</span>
<span class="line-modified">398      * @return LingeredApp object</span>
399      * @throws IOException
400      */
<span class="line-modified">401     public static LingeredApp startApp(List&lt;String&gt; cmd) throws IOException {</span>
<span class="line-modified">402         LingeredApp a = new LingeredApp();</span>
<span class="line-removed">403         a.createLock();</span>
404         try {
<span class="line-modified">405             a.runApp(cmd);</span>
<span class="line-modified">406             a.waitAppReady(appWaitTime);</span>
407         } catch (Exception ex) {
<span class="line-modified">408             a.deleteLock();</span>
<span class="line-removed">409             System.err.println(&quot;LingeredApp failed to start: &quot; + ex);</span>
<span class="line-removed">410             a.finishApp();</span>
411             throw ex;
412         }
<span class="line-removed">413 </span>
<span class="line-removed">414         return a;</span>
415     }
416 
417     /**
<span class="line-modified">418      * Factory method that starts pre-created LingeredApp</span>
419      * lock name is autogenerated
<span class="line-modified">420      * @param cmd - vm options, could be null to auto add testvm.options</span>
<span class="line-removed">421      * @param theApp - app to start</span>
422      * @return LingeredApp object
423      * @throws IOException
424      */
<span class="line-modified">425 </span>
<span class="line-modified">426     public static void startApp(List&lt;String&gt; cmd, LingeredApp theApp) throws IOException {</span>
<span class="line-removed">427         theApp.createLock();</span>
428         try {
<span class="line-modified">429             theApp.runApp(cmd);</span>
<span class="line-removed">430             theApp.waitAppReady(appWaitTime);</span>
431         } catch (Exception ex) {
<span class="line-modified">432             theApp.deleteLock();</span>

433             throw ex;
434         }
<span class="line-removed">435     }</span>
436 
<span class="line-modified">437     public static LingeredApp startApp() throws IOException {</span>
<span class="line-removed">438         return startApp(null);</span>
439     }
440 
441     public static void stopApp(LingeredApp app) throws IOException {
442         if (app != null) {
443             // LingeredApp can throw an exception during the intialization,
444             // make sure we don&#39;t have cascade NPE
445             app.stopApp();
446         }
447     }
448 
449     /**
450      * LastModified time might not work correctly in some cases it might
451      * cause later failures
452      */
453 
454     public static boolean isLastModifiedWorking() {
455         boolean sane = true;
456         try {
457             long lm = lastModified(&quot;.&quot;);
458             if (lm == 0) {
</pre>
<hr />
<pre>
475         }
476         catch(IOException e) {
477             System.err.println(&quot;SANITY Warning! IOException during sanity check &quot; + e);
478             sane = false;
479         }
480 
481         return sane;
482     }
483 
484     /**
485      * This part is the application it self
486      */
487     public static void main(String args[]) {
488 
489         if (args.length != 1) {
490             System.err.println(&quot;Lock file name is not specified&quot;);
491             System.exit(7);
492         }
493 
494         String theLockFileName = args[0];

495 
496         try {
<span class="line-removed">497             Path path = Paths.get(theLockFileName);</span>
<span class="line-removed">498 </span>
499             while (Files.exists(path)) {
500                 // Touch the lock to indicate our readiness
501                 setLastModified(theLockFileName, epoch());
502                 Thread.sleep(spinDelay);
503             }
<span class="line-modified">504         } catch (NoSuchFileException ex) {</span>
505             // Lock deleted while we are setting last modified time.
<span class="line-modified">506             // Ignore error and lets the app exits</span>





507         } catch (Exception ex) {
508             System.err.println(&quot;LingeredApp ERROR: &quot; + ex);
509             // Leave exit_code = 1 to Java launcher
510             System.exit(3);
511         }
512 
513         System.exit(0);
514     }
515 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib.apps;
 25 
 26 import java.io.BufferedReader;
 27 import java.io.ByteArrayOutputStream;
 28 import java.io.IOException;
 29 import java.io.StringReader;
 30 import java.nio.file.Files;
 31 import java.nio.file.NoSuchFileException;
 32 import java.nio.file.Path;
 33 import java.nio.file.Paths;
 34 import java.nio.file.attribute.BasicFileAttributes;
 35 import java.nio.file.attribute.FileTime;
 36 import java.util.ArrayList;
<span class="line-added"> 37 import java.util.Collections;</span>
 38 import java.util.Date;
 39 import java.util.List;
 40 import java.util.Map;
 41 import java.util.stream.Collectors;
 42 import java.util.UUID;
<span class="line-added"> 43 import jdk.test.lib.Utils;</span>
 44 import jdk.test.lib.process.OutputBuffer;
 45 import jdk.test.lib.process.StreamPumper;
 46 
 47 /**
 48  * This is a framework to launch an app that could be synchronized with caller
 49  * to make further attach actions reliable across supported platforms
 50 
 51  * Caller example:
 52  *   SmartTestApp a = SmartTestApp.startApp(cmd);
 53  *     // do something
 54  *   a.stopApp();
 55  *
 56  *   or fine grained control
 57  *
 58  *   a = new SmartTestApp(&quot;MyLock.lck&quot;);
 59  *   a.createLock();
 60  *   a.runApp();
 61  *   a.waitAppReady();
 62  *     // do something
 63  *   a.deleteLock();
</pre>
<hr />
<pre>
266                 break;
267             }
268 
269             // Make sure process didn&#39;t already exit
270             if (!appProcess.isAlive()) {
271                 throw new IOException(&quot;App exited unexpectedly with &quot; + appProcess.exitValue());
272             }
273 
274             try {
275                 Thread.sleep(spinDelay);
276             } catch (InterruptedException ex) {
277                 // pass
278             }
279         }
280     }
281 
282     /**
283      * Analyze an environment and prepare a command line to
284      * run the app, app name should be added explicitly
285      */
<span class="line-modified">286     public List&lt;String&gt; runAppPrepare(String[] vmArguments) {</span>
287         // We should always use testjava or throw an exception,
288         // so we can&#39;t use JDKToolFinder.getJDKTool(&quot;java&quot;);
289         // that falls back to compile java on error
290         String jdkPath = System.getProperty(&quot;test.jdk&quot;);
291         if (jdkPath == null) {
292             // we are not under jtreg, try env
293             Map&lt;String, String&gt; env = System.getenv();
294             jdkPath = env.get(&quot;TESTJAVA&quot;);
295         }
296 
297         if (jdkPath == null) {
298             throw new RuntimeException(&quot;Can&#39;t determine jdk path neither test.jdk property no TESTJAVA env are set&quot;);
299         }
300 
301         String osname = System.getProperty(&quot;os.name&quot;);
302         String javapath = jdkPath + ((osname.startsWith(&quot;window&quot;)) ? &quot;/bin/java.exe&quot; : &quot;/bin/java&quot;);
303 
304         List&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
305         cmd.add(javapath);
306 
307         if (vmArguments == null) {
<span class="line-modified">308             // Propagate getTestJavaOpts() to LingeredApp</span>
<span class="line-modified">309             vmArguments = Utils.getTestJavaOpts();</span>





310         } else {
311             // Lets user manage LingeredApp options

312         }
<span class="line-added">313         Collections.addAll(cmd, vmArguments);</span>
314 
315         // Make sure we set correct classpath to run the app
316         cmd.add(&quot;-cp&quot;);
317         String classpath = System.getProperty(&quot;test.class.path&quot;);
318         cmd.add((classpath == null) ? &quot;.&quot; : classpath);
319 
320         return cmd;
321     }
322 
323     /**
324      * Assemble command line to a printable string
325      */
326     public void printCommandLine(List&lt;String&gt; cmd) {
327         // A bit of verbosity
328         StringBuilder cmdLine = new StringBuilder();
329         for (String strCmd : cmd) {
330             cmdLine.append(&quot;&#39;&quot;).append(strCmd).append(&quot;&#39; &quot;);
331         }
332 
333         System.err.println(&quot;Command line: [&quot; + cmdLine.toString() + &quot;]&quot;);
334     }
335 
336     /**
337      * Run the app.
338      *
339      * @param vmArguments
340      * @throws IOException
341      */
<span class="line-modified">342     public void runApp(String[] vmArguments)</span>
343             throws IOException {
344 
345         List&lt;String&gt; cmd = runAppPrepare(vmArguments);
346 
347         cmd.add(this.getAppName());
348         cmd.add(lockFileName);
349 
350         printCommandLine(cmd);
351 
352         ProcessBuilder pb = new ProcessBuilder(cmd);
353         // ProcessBuilder.start can throw IOException
354         appProcess = pb.start();
355 
356         startOutputPumpers();
357     }
358 
359     private void finishApp() {
<span class="line-modified">360         if (appProcess != null) {</span>
<span class="line-modified">361             OutputBuffer output = getOutput();</span>
<span class="line-modified">362             String msg =</span>
<span class="line-modified">363                     &quot; LingeredApp stdout: [&quot; + output.getStdout() + &quot;];\n&quot; +</span>
<span class="line-modified">364                     &quot; LingeredApp stderr: [&quot; + output.getStderr() + &quot;]\n&quot; +</span>
<span class="line-added">365                     &quot; LingeredApp exitValue = &quot; + appProcess.exitValue();</span>
366 
<span class="line-modified">367             System.err.println(msg);</span>
<span class="line-added">368         }</span>
369     }
370 
371     /**
372      * Delete lock file that signals app to terminate, then
373      * wait until app is actually terminated.
374      * @throws IOException
375      */
376     public void stopApp() throws IOException {
377         deleteLock();
378         // The startApp() of the derived app can throw
379         // an exception before the LA actually starts
380         if (appProcess != null) {
381             waitAppTerminate();
<span class="line-added">382 </span>
<span class="line-added">383             finishApp();</span>
<span class="line-added">384 </span>
385             int exitcode = appProcess.exitValue();
386             if (exitcode != 0) {
387                 throw new IOException(&quot;LingeredApp terminated with non-zero exit code &quot; + exitcode);
388             }
389         }

390     }
391 
392     /**
393      *  High level interface for test writers
394      */
395     /**
<span class="line-modified">396      * Factory method that starts pre-created LingeredApp</span>
397      * lock name is autogenerated
<span class="line-modified">398      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>
<span class="line-modified">399      * @param theApp - app to start</span>
400      * @throws IOException
401      */
<span class="line-modified">402     public static void startApp(LingeredApp theApp, String... cmd) throws IOException {</span>
<span class="line-modified">403         theApp.createLock();</span>

404         try {
<span class="line-modified">405             theApp.runApp(cmd);</span>
<span class="line-modified">406             theApp.waitAppReady(appWaitTime);</span>
407         } catch (Exception ex) {
<span class="line-modified">408             theApp.deleteLock();</span>


409             throw ex;
410         }


411     }
412 
413     /**
<span class="line-modified">414      * Factory method that creates LingeredApp object with ready to use application</span>
415      * lock name is autogenerated
<span class="line-modified">416      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>

417      * @return LingeredApp object
418      * @throws IOException
419      */
<span class="line-modified">420     public static LingeredApp startApp(String... cmd) throws IOException {</span>
<span class="line-modified">421         LingeredApp a = new LingeredApp();</span>

422         try {
<span class="line-modified">423             startApp(a, cmd);</span>

424         } catch (Exception ex) {
<span class="line-modified">425             System.err.println(&quot;LingeredApp failed to start: &quot; + ex);</span>
<span class="line-added">426             a.finishApp();</span>
427             throw ex;
428         }

429 
<span class="line-modified">430         return a;</span>

431     }
432 
433     public static void stopApp(LingeredApp app) throws IOException {
434         if (app != null) {
435             // LingeredApp can throw an exception during the intialization,
436             // make sure we don&#39;t have cascade NPE
437             app.stopApp();
438         }
439     }
440 
441     /**
442      * LastModified time might not work correctly in some cases it might
443      * cause later failures
444      */
445 
446     public static boolean isLastModifiedWorking() {
447         boolean sane = true;
448         try {
449             long lm = lastModified(&quot;.&quot;);
450             if (lm == 0) {
</pre>
<hr />
<pre>
467         }
468         catch(IOException e) {
469             System.err.println(&quot;SANITY Warning! IOException during sanity check &quot; + e);
470             sane = false;
471         }
472 
473         return sane;
474     }
475 
476     /**
477      * This part is the application it self
478      */
479     public static void main(String args[]) {
480 
481         if (args.length != 1) {
482             System.err.println(&quot;Lock file name is not specified&quot;);
483             System.exit(7);
484         }
485 
486         String theLockFileName = args[0];
<span class="line-added">487         Path path = Paths.get(theLockFileName);</span>
488 
489         try {


490             while (Files.exists(path)) {
491                 // Touch the lock to indicate our readiness
492                 setLastModified(theLockFileName, epoch());
493                 Thread.sleep(spinDelay);
494             }
<span class="line-modified">495         } catch (IOException ex) {</span>
496             // Lock deleted while we are setting last modified time.
<span class="line-modified">497             // Ignore the error and let the app exit.</span>
<span class="line-added">498             if (Files.exists(path)) {</span>
<span class="line-added">499                 // If the lock file was not removed, return an error.</span>
<span class="line-added">500                 System.err.println(&quot;LingeredApp IOException: lock file still exists&quot;);</span>
<span class="line-added">501                 System.exit(4);</span>
<span class="line-added">502             }</span>
503         } catch (Exception ex) {
504             System.err.println(&quot;LingeredApp ERROR: &quot; + ex);
505             // Leave exit_code = 1 to Java launcher
506             System.exit(3);
507         }
508 
509         System.exit(0);
510     }
511 }
</pre>
</td>
</tr>
</table>
<center><a href="../Utils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../artifacts/DefaultArtifactManager.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>