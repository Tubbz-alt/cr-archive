<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/cds/CDSTestUtils.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../artifacts/JibArtifactManager.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../cli/CommandLineOptionTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/cds/CDSTestUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -38,12 +38,12 @@</span>
  public class CDSTestUtils {
      public static final String MSG_RANGE_NOT_WITHIN_HEAP =
          &quot;UseSharedSpaces: Unable to allocate region, range is not within java heap.&quot;;
      public static final String MSG_RANGE_ALREADT_IN_USE =
          &quot;Unable to allocate region, java heap range is already in use.&quot;;
<span class="udiff-line-modified-removed">-     public static final String MSG_COMPRESSION_MUST_BE_USED =</span>
<span class="udiff-line-modified-removed">-         &quot;Unable to use shared archive: UseCompressedOops and UseCompressedClassPointers must be on for UseSharedSpaces.&quot;;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     public static final boolean DYNAMIC_DUMP = Boolean.getBoolean(&quot;test.dynamic.cds.archive&quot;);</span>
  
      public interface Checker {
          public void check(OutputAnalyzer output) throws Exception;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,11 +244,11 @@</span>
  
          cmd.add(&quot;-Xshare:dump&quot;);
          cmd.add(&quot;-Xlog:cds,cds+hashtables&quot;);
          if (opts.archiveName == null)
              opts.archiveName = getDefaultArchiveName();
<span class="udiff-line-modified-removed">-         cmd.add(&quot;-XX:SharedArchiveFile=./&quot; + opts.archiveName);</span>
<span class="udiff-line-modified-added">+         cmd.add(&quot;-XX:SharedArchiveFile=&quot; + opts.archiveName);</span>
  
          if (opts.classList != null) {
              File classListFile = makeClassList(opts.classList);
              cmd.add(&quot;-XX:ExtraSharedClassListFile=&quot; + classListFile.getPath());
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,16 +258,24 @@</span>
          String[] cmdLine = cmd.toArray(new String[cmd.size()]);
          ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(true, cmdLine);
          return executeAndLog(pb, &quot;dump&quot;);
      }
  
<span class="udiff-line-added">+     public static boolean isDynamicArchive() {</span>
<span class="udiff-line-added">+         return DYNAMIC_DUMP;</span>
<span class="udiff-line-added">+     }</span>
  
      // check result of &#39;dump-the-archive&#39; operation, that is &quot;-Xshare:dump&quot;
      public static OutputAnalyzer checkDump(OutputAnalyzer output, String... extraMatches)
          throws Exception {
  
<span class="udiff-line-modified-removed">-         output.shouldContain(&quot;Loading classes to share&quot;);</span>
<span class="udiff-line-modified-added">+         if (!DYNAMIC_DUMP) {</span>
<span class="udiff-line-added">+             output.shouldContain(&quot;Loading classes to share&quot;);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             output.shouldContain(&quot;Buffer-space to target-space delta&quot;)</span>
<span class="udiff-line-added">+                   .shouldContain(&quot;Written dynamic archive 0x&quot;);</span>
<span class="udiff-line-added">+         }</span>
          output.shouldHaveExitValue(0);
  
          for (String match : extraMatches) {
              output.shouldContain(match);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -297,11 +305,11 @@</span>
      // of exceptions and common errors.
      // Exception e argument - an exception to be re-thrown if none of the common
      // exceptions match. Pass null if you wish not to re-throw any exception.
      public static void checkCommonExecExceptions(OutputAnalyzer output, Exception e)
          throws Exception {
<span class="udiff-line-modified-removed">-         if (output.getStdout().contains(&quot;http://bugreport.java.com/bugreport/crash.jsp&quot;)) {</span>
<span class="udiff-line-modified-added">+         if (output.getStdout().contains(&quot;https://bugreport.java.com/bugreport/crash.jsp&quot;)) {</span>
              throw new RuntimeException(&quot;Hotspot crashed&quot;);
          }
          if (output.getStdout().contains(&quot;TEST FAILED&quot;)) {
              throw new RuntimeException(&quot;Test Failed&quot;);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -345,11 +353,12 @@</span>
              outStr.contains(&quot;Unable to map ReadWrite shared space at required address&quot;) ||
              outStr.contains(&quot;Unable to map MiscData shared space at required address&quot;) ||
              outStr.contains(&quot;Unable to map MiscCode shared space at required address&quot;) ||
              outStr.contains(&quot;Unable to map OptionalData shared space at required address&quot;) ||
              outStr.contains(&quot;Could not allocate metaspace at a compatible address&quot;) ||
<span class="udiff-line-modified-removed">-             outStr.contains(&quot;UseSharedSpaces: Unable to allocate region, range is not within java heap&quot;) ))</span>
<span class="udiff-line-modified-added">+             outStr.contains(&quot;UseSharedSpaces: Unable to allocate region, range is not within java heap&quot;) ||</span>
<span class="udiff-line-added">+             outStr.contains(&quot;DynamicDumpSharedSpaces is unsupported when base CDS archive is not loaded&quot;) ))</span>
          {
              return true;
          }
  
          return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -588,6 +597,66 @@</span>
          PrintStream ps = new PrintStream(fos);
          ps.print(content);
          ps.close();
          fos.close();
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Format a line that defines an extra symbol in the file specify by -XX:SharedArchiveConfigFile=&lt;file&gt;</span>
<span class="udiff-line-added">+     public static String formatArchiveConfigSymbol(String symbol) {</span>
<span class="udiff-line-added">+         int refCount = -1; // This is always -1 in the current HotSpot implementation.</span>
<span class="udiff-line-added">+         if (isAsciiPrintable(symbol)) {</span>
<span class="udiff-line-added">+             return symbol.length() + &quot; &quot; + refCount + &quot;: &quot; + symbol;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             StringBuilder sb = new StringBuilder();</span>
<span class="udiff-line-added">+             int utf8_length = escapeArchiveConfigString(sb, symbol);</span>
<span class="udiff-line-added">+             return utf8_length + &quot; &quot; + refCount + &quot;: &quot; + sb.toString();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // This method generates the same format as HashtableTextDump::put_utf8() in HotSpot,</span>
<span class="udiff-line-added">+     // to be used by -XX:SharedArchiveConfigFile=&lt;file&gt;.</span>
<span class="udiff-line-added">+     private static int escapeArchiveConfigString(StringBuilder sb, String s) {</span>
<span class="udiff-line-added">+         byte arr[];</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             arr = s.getBytes(&quot;UTF8&quot;);</span>
<span class="udiff-line-added">+         } catch (java.io.UnsupportedEncodingException e) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Unexpected&quot;, e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; arr.length; i++) {</span>
<span class="udiff-line-added">+             char ch = (char)(arr[i] &amp; 0xff);</span>
<span class="udiff-line-added">+             if (isAsciiPrintable(ch)) {</span>
<span class="udiff-line-added">+                 sb.append(ch);</span>
<span class="udiff-line-added">+             } else if (ch == &#39;\t&#39;) {</span>
<span class="udiff-line-added">+                 sb.append(&quot;\\t&quot;);</span>
<span class="udiff-line-added">+             } else if (ch == &#39;\r&#39;) {</span>
<span class="udiff-line-added">+                 sb.append(&quot;\\r&quot;);</span>
<span class="udiff-line-added">+             } else if (ch == &#39;\n&#39;) {</span>
<span class="udiff-line-added">+                 sb.append(&quot;\\n&quot;);</span>
<span class="udiff-line-added">+             } else if (ch == &#39;\\&#39;) {</span>
<span class="udiff-line-added">+                 sb.append(&quot;\\\\&quot;);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 String hex = Integer.toHexString(ch);</span>
<span class="udiff-line-added">+                 if (ch &lt; 16) {</span>
<span class="udiff-line-added">+                     sb.append(&quot;\\x0&quot;);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     sb.append(&quot;\\x&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 sb.append(hex);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return arr.length;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static boolean isAsciiPrintable(String s) {</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; s.length(); i++) {</span>
<span class="udiff-line-added">+             if (!isAsciiPrintable(s.charAt(i))) {</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static boolean isAsciiPrintable(char ch) {</span>
<span class="udiff-line-added">+         return ch &gt;= 32 &amp;&amp; ch &lt; 127;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../artifacts/JibArtifactManager.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../cli/CommandLineOptionTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>