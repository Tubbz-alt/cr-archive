<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/lib/jdk/test/lib/util/FileUtils.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../security/JDKSecurityProperties.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../sun/hotspot/WhiteBox.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/util/FileUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,10 ***</span>
<span class="line-new-header">--- 23,12 ---</span>
  
  package jdk.test.lib.util;
  
  import jdk.test.lib.Platform;
  
<span class="line-added">+ import java.io.BufferedReader;</span>
<span class="line-added">+ import java.io.InputStreamReader;</span>
  import java.io.IOException;
  import java.io.PrintStream;
  import java.io.UncheckedIOException;
  import java.lang.ProcessBuilder.Redirect;
  import java.nio.file.DirectoryNotEmptyException;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 43,10 ***</span>
<span class="line-new-header">--- 45,13 ---</span>
  import java.util.ArrayList;
  import java.util.ArrayDeque;
  import java.util.HashSet;
  import java.util.List;
  import java.util.Optional;
<span class="line-added">+ import java.util.Set;</span>
<span class="line-added">+ import java.util.concurrent.atomic.AtomicBoolean;</span>
<span class="line-added">+ import java.util.concurrent.atomic.AtomicReference;</span>
  import java.util.concurrent.TimeUnit;
  
  /**
   * Common library for various test file utility functions.
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,11 ***</span>
       * @throws IOException
       *         if an I/O error occurs
       */
      public static void deleteFileIfExistsWithRetry(Path path) throws IOException {
          try {
<span class="line-modified">!             if (Files.exists(path)) {</span>
                  deleteFileWithRetry0(path);
              }
          } catch (InterruptedException x) {
              throw new IOException(&quot;Interrupted while deleting.&quot;, x);
          }
<span class="line-new-header">--- 95,11 ---</span>
       * @throws IOException
       *         if an I/O error occurs
       */
      public static void deleteFileIfExistsWithRetry(Path path) throws IOException {
          try {
<span class="line-modified">!             if (!Files.notExists(path)) {</span>
                  deleteFileWithRetry0(path);
              }
          } catch (InterruptedException x) {
              throw new IOException(&quot;Interrupted while deleting.&quot;, x);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 235,10 ***</span>
<span class="line-new-header">--- 240,94 ---</span>
              }
          }
          return areFileSystemsAccessible;
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Checks whether all file systems are accessible and there are no</span>
<span class="line-added">+      * duplicate mount points. This is performed by checking free disk</span>
<span class="line-added">+      * space on all mounted file systems via a separate, spawned process.</span>
<span class="line-added">+      * File systems are considered to be accessible if this process completes</span>
<span class="line-added">+      * successfully before a given fixed duration has elapsed.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @implNote On Unix this executes the {@code df} command in a separate</span>
<span class="line-added">+      * process and on Windows always returns {@code true}.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @return whether file systems appear to be accessible and duplicate-free</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static boolean areMountPointsAccessibleAndUnique() {</span>
<span class="line-added">+         if (IS_WINDOWS) return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+         final AtomicBoolean areMountPointsOK = new AtomicBoolean(true);</span>
<span class="line-added">+         Thread thr = new Thread(() -&gt; {</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 Process proc = new ProcessBuilder(&quot;df&quot;).start();</span>
<span class="line-added">+                 BufferedReader reader = new BufferedReader</span>
<span class="line-added">+                     (new InputStreamReader(proc.getInputStream()));</span>
<span class="line-added">+                 // Skip the first line as it is the &quot;df&quot; output header.</span>
<span class="line-added">+                 if (reader.readLine() != null ) {</span>
<span class="line-added">+                     Set mountPoints = new HashSet();</span>
<span class="line-added">+                     String mountPoint = null;</span>
<span class="line-added">+                     while ((mountPoint = reader.readLine()) != null) {</span>
<span class="line-added">+                         if (!mountPoints.add(mountPoint)) {</span>
<span class="line-added">+                             System.err.printf</span>
<span class="line-added">+                                 (&quot;Config error: duplicate mount point %s%n&quot;,</span>
<span class="line-added">+                                 mountPoint);</span>
<span class="line-added">+                             areMountPointsOK.set(false);</span>
<span class="line-added">+                             break;</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+ </span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     proc.waitFor(90, TimeUnit.SECONDS);</span>
<span class="line-added">+                 } catch (InterruptedException ignored) {</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     int exitValue = proc.exitValue();</span>
<span class="line-added">+                     if (exitValue != 0) {</span>
<span class="line-added">+                         System.err.printf(&quot;df process exited with %d != 0%n&quot;,</span>
<span class="line-added">+                             exitValue);</span>
<span class="line-added">+                         areMountPointsOK.set(false);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 } catch (IllegalThreadStateException ignored) {</span>
<span class="line-added">+                     System.err.println(&quot;df command apparently hung&quot;);</span>
<span class="line-added">+                     areMountPointsOK.set(false);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             } catch (IOException ioe) {</span>
<span class="line-added">+                 throw new RuntimeException(ioe);</span>
<span class="line-added">+             };</span>
<span class="line-added">+         });</span>
<span class="line-added">+ </span>
<span class="line-added">+         final AtomicReference throwableReference =</span>
<span class="line-added">+             new AtomicReference&lt;Throwable&gt;();</span>
<span class="line-added">+         thr.setUncaughtExceptionHandler(</span>
<span class="line-added">+             new Thread.UncaughtExceptionHandler() {</span>
<span class="line-added">+                 public void uncaughtException(Thread t, Throwable e) {</span>
<span class="line-added">+                     throwableReference.set(e);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             });</span>
<span class="line-added">+ </span>
<span class="line-added">+         thr.start();</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             thr.join(120*1000L);</span>
<span class="line-added">+         } catch (InterruptedException ie) {</span>
<span class="line-added">+             throw new RuntimeException(ie);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         Throwable uncaughtException = (Throwable)throwableReference.get();</span>
<span class="line-added">+         if (uncaughtException != null) {</span>
<span class="line-added">+             throw new RuntimeException(uncaughtException);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (thr.isAlive()) {</span>
<span class="line-added">+             throw new RuntimeException(&quot;df thread did not join in time&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         return areMountPointsOK.get();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * List the open file descriptors (if supported by the &#39;lsof&#39; command).
       * @param ps a printStream to send the output to
       * @throws UncheckedIOException if an error occurs
       */
</pre>
<center><a href="../security/JDKSecurityProperties.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../sun/hotspot/WhiteBox.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>