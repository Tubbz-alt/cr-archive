<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/lib/jdk/test/lib/Utils.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="SecurityTools.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="apps/LingeredApp.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/Utils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib;
 25 
 26 import java.io.File;
 27 import java.io.IOException;

 28 import java.net.InetAddress;
 29 import java.net.InetSocketAddress;
 30 import java.net.MalformedURLException;
 31 import java.net.ServerSocket;
 32 import java.net.URL;
 33 import java.net.URLClassLoader;
 34 import java.net.UnknownHostException;
 35 import java.nio.file.Files;
 36 import java.nio.file.Path;
 37 import java.nio.file.Paths;
 38 import java.nio.file.attribute.FileAttribute;
 39 import java.nio.channels.SocketChannel;
 40 import java.util.ArrayList;
 41 import java.util.Arrays;
 42 import java.util.Collection;
 43 import java.util.Collections;
 44 import java.util.Iterator;
 45 import java.util.Map;
 46 import java.util.HashMap;
 47 import java.util.List;
</pre>
<hr />
<pre>
126     /**
127      * Returns the value of &#39;test.timeout.factor&#39; system property
128      * converted to {@code double}.
129      */
130     public static final double TIMEOUT_FACTOR;
131     static {
132         String toFactor = System.getProperty(&quot;test.timeout.factor&quot;, &quot;1.0&quot;);
133         TIMEOUT_FACTOR = Double.parseDouble(toFactor);
134     }
135 
136     /**
137      * Returns the value of JTREG default test timeout in milliseconds
138      * converted to {@code long}.
139      */
140     public static final long DEFAULT_TEST_TIMEOUT = TimeUnit.SECONDS.toMillis(120);
141 
142     private Utils() {
143         // Private constructor to prevent class instantiation
144     }
145 
<span class="line-removed">146     /**</span>
<span class="line-removed">147      * Returns the list of VM options.</span>
<span class="line-removed">148      *</span>
<span class="line-removed">149      * @return List of VM options</span>
<span class="line-removed">150      */</span>
<span class="line-removed">151     public static List&lt;String&gt; getVmOptions() {</span>
<span class="line-removed">152         return Arrays.asList(safeSplitString(VM_OPTIONS));</span>
<span class="line-removed">153     }</span>
<span class="line-removed">154 </span>
155     /**
156      * Returns the list of VM options with -J prefix.
157      *
158      * @return The list of VM options with -J prefix
159      */
160     public static List&lt;String&gt; getForwardVmOptions() {
161         String[] opts = safeSplitString(VM_OPTIONS);
162         for (int i = 0; i &lt; opts.length; i++) {
163             opts[i] = &quot;-J&quot; + opts[i];
164         }
165         return Arrays.asList(opts);
166     }
167 
168     /**
169      * Returns the default JTReg arguments for a jvm running a test.
170      * This is the combination of JTReg arguments test.vm.opts and test.java.opts.
171      * @return An array of options, or an empty array if no options.
172      */
173     public static String[] getTestJavaOpts() {
174         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();
175         Collections.addAll(opts, safeSplitString(VM_OPTIONS));
176         Collections.addAll(opts, safeSplitString(JAVA_OPTIONS));
177         return opts.toArray(new String[0]);
178     }
179 
180     /**
181      * Combines given arguments with default JTReg arguments for a jvm running a test.
182      * This is the combination of JTReg arguments test.vm.opts and test.java.opts
183      * @return The combination of JTReg test java options and user args.
184      */
<span class="line-modified">185     public static String[] addTestJavaOpts(String... userArgs) {</span>
186         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();
187         Collections.addAll(opts, getTestJavaOpts());
188         Collections.addAll(opts, userArgs);
189         return opts.toArray(new String[0]);
190     }
191 





















192     /**
193      * Removes any options specifying which GC to use, for example &quot;-XX:+UseG1GC&quot;.
194      * Removes any options matching: -XX:(+/-)Use*GC
195      * Used when a test need to set its own GC version. Then any
196      * GC specified by the framework must first be removed.
197      * @return A copy of given opts with all GC options removed.
198      */
199     private static final Pattern useGcPattern = Pattern.compile(
<span class="line-modified">200             &quot;(?:\\-XX\\:[\\+\\-]Use.+GC)&quot;</span>
<span class="line-removed">201             + &quot;|(?:\\-Xconcgc)&quot;);</span>
202     public static List&lt;String&gt; removeGcOpts(List&lt;String&gt; opts) {
203         List&lt;String&gt; optsWithoutGC = new ArrayList&lt;String&gt;();
204         for (String opt : opts) {
205             if (useGcPattern.matcher(opt).matches()) {
206                 System.out.println(&quot;removeGcOpts: removed &quot; + opt);
207             } else {
208                 optsWithoutGC.add(opt);
209             }
210         }
211         return optsWithoutGC;
212     }
213 
214     /**
215      * Returns the default JTReg arguments for a jvm running a test without
216      * options that matches regular expressions in {@code filters}.
217      * This is the combination of JTReg arguments test.vm.opts and test.java.opts.
218      * @param filters Regular expressions used to filter out options.
219      * @return An array of options, or an empty array if no options.
220      */
221     public static String[] getFilteredTestJavaOpts(String... filters) {
</pre>
<hr />
<pre>
732     }
733 
734     /*
735      * Returns the system distro.
736      */
737     public static String distro() {
738         try {
739             return uname(&quot;-v&quot;).asLines().get(0);
740         } catch (Throwable t) {
741             throw new RuntimeException(&quot;Failed to determine distro.&quot;, t);
742         }
743     }
744 
745     // This method is intended to be called from a jtreg test.
746     // It will identify the name of the test by means of stack walking.
747     // It can handle both jtreg tests and a testng tests wrapped inside jtreg tests.
748     // For jtreg tests the name of the test will be searched by stack-walking
749     // until the method main() is found; the class containing that method is the
750     // main test class and will be returned as the name of the test.
751     // Special handling is used for testng tests.

752     public static String getTestName() {
753         String result = null;
754         // If we are using testng, then we should be able to load the &quot;Test&quot; annotation.
<span class="line-modified">755         Class testClassAnnotation;</span>
756 
757         try {
<span class="line-modified">758             testClassAnnotation = Class.forName(&quot;org.testng.annotations.Test&quot;);</span>
759         } catch (ClassNotFoundException e) {
760             testClassAnnotation = null;
761         }
762 
763         StackTraceElement[] elms = (new Throwable()).getStackTrace();
764         for (StackTraceElement n: elms) {
765             String className = n.getClassName();
766 
767             // If this is a &quot;main&quot; method, then use its class name, but only
768             // if we are not using testng.
769             if (testClassAnnotation == null &amp;&amp; &quot;main&quot;.equals(n.getMethodName())) {
770                 result = className;
771                 break;
772             }
773 
774             // If this is a testng test, the test will have no &quot;main&quot; method. We can
775             // detect a testng test class by looking for the org.testng.annotations.Test
776             // annotation. If present, then use the name of this class.
777             if (testClassAnnotation != null) {
778                 try {
<span class="line-modified">779                     Class c = Class.forName(className);</span>
780                     if (c.isAnnotationPresent(testClassAnnotation)) {
781                         result = className;
782                         break;
783                     }
784                 } catch (ClassNotFoundException e) {
785                     throw new RuntimeException(&quot;Unexpected exception: &quot; + e, e);
786                 }
787             }
788         }
789 
790         if (result == null) {
791             throw new RuntimeException(&quot;Couldn&#39;t find main test class in stack trace&quot;);
792         }
793 
794         return result;
795     }
796 
797     /**
798      * Creates an empty file in &quot;user.dir&quot; if the property set.
799      * &lt;p&gt;
800      * This method is meant as a replacement for {@code Files#createTempFile(String, String, FileAttribute...)}
801      * that doesn&#39;t leave files behind in /tmp directory of the test machine
802      * &lt;p&gt;
803      * If the property &quot;user.dir&quot; is not set, &quot;.&quot; will be used.
804      *
805      * @param prefix
806      * @param suffix
807      * @param attrs
808      * @return the path to the newly created file that did not exist before this
809      *         method was invoked
810      * @throws IOException
811      *
812      * @see {@link Files#createTempFile(String, String, FileAttribute...)}
813      */
814     public static Path createTempFile(String prefix, String suffix, FileAttribute&lt;?&gt;... attrs) throws IOException {
815         Path dir = Paths.get(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));
816         return Files.createTempFile(dir, prefix, suffix);
817     }




















818 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib;
 25 
 26 import java.io.File;
 27 import java.io.IOException;
<span class="line-added"> 28 import java.lang.annotation.Annotation;</span>
 29 import java.net.InetAddress;
 30 import java.net.InetSocketAddress;
 31 import java.net.MalformedURLException;
 32 import java.net.ServerSocket;
 33 import java.net.URL;
 34 import java.net.URLClassLoader;
 35 import java.net.UnknownHostException;
 36 import java.nio.file.Files;
 37 import java.nio.file.Path;
 38 import java.nio.file.Paths;
 39 import java.nio.file.attribute.FileAttribute;
 40 import java.nio.channels.SocketChannel;
 41 import java.util.ArrayList;
 42 import java.util.Arrays;
 43 import java.util.Collection;
 44 import java.util.Collections;
 45 import java.util.Iterator;
 46 import java.util.Map;
 47 import java.util.HashMap;
 48 import java.util.List;
</pre>
<hr />
<pre>
127     /**
128      * Returns the value of &#39;test.timeout.factor&#39; system property
129      * converted to {@code double}.
130      */
131     public static final double TIMEOUT_FACTOR;
132     static {
133         String toFactor = System.getProperty(&quot;test.timeout.factor&quot;, &quot;1.0&quot;);
134         TIMEOUT_FACTOR = Double.parseDouble(toFactor);
135     }
136 
137     /**
138      * Returns the value of JTREG default test timeout in milliseconds
139      * converted to {@code long}.
140      */
141     public static final long DEFAULT_TEST_TIMEOUT = TimeUnit.SECONDS.toMillis(120);
142 
143     private Utils() {
144         // Private constructor to prevent class instantiation
145     }
146 









147     /**
148      * Returns the list of VM options with -J prefix.
149      *
150      * @return The list of VM options with -J prefix
151      */
152     public static List&lt;String&gt; getForwardVmOptions() {
153         String[] opts = safeSplitString(VM_OPTIONS);
154         for (int i = 0; i &lt; opts.length; i++) {
155             opts[i] = &quot;-J&quot; + opts[i];
156         }
157         return Arrays.asList(opts);
158     }
159 
160     /**
161      * Returns the default JTReg arguments for a jvm running a test.
162      * This is the combination of JTReg arguments test.vm.opts and test.java.opts.
163      * @return An array of options, or an empty array if no options.
164      */
165     public static String[] getTestJavaOpts() {
166         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();
167         Collections.addAll(opts, safeSplitString(VM_OPTIONS));
168         Collections.addAll(opts, safeSplitString(JAVA_OPTIONS));
169         return opts.toArray(new String[0]);
170     }
171 
172     /**
173      * Combines given arguments with default JTReg arguments for a jvm running a test.
174      * This is the combination of JTReg arguments test.vm.opts and test.java.opts
175      * @return The combination of JTReg test java options and user args.
176      */
<span class="line-modified">177     public static String[] prependTestJavaOpts(String... userArgs) {</span>
178         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();
179         Collections.addAll(opts, getTestJavaOpts());
180         Collections.addAll(opts, userArgs);
181         return opts.toArray(new String[0]);
182     }
183 
<span class="line-added">184     /**</span>
<span class="line-added">185      * Combines given arguments with default JTReg arguments for a jvm running a test.</span>
<span class="line-added">186      * This is the combination of JTReg arguments test.vm.opts and test.java.opts</span>
<span class="line-added">187      * @return The combination of JTReg test java options and user args.</span>
<span class="line-added">188      */</span>
<span class="line-added">189     public static String[] appendTestJavaOpts(String... userArgs) {</span>
<span class="line-added">190         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();</span>
<span class="line-added">191         Collections.addAll(opts, userArgs);</span>
<span class="line-added">192         Collections.addAll(opts, getTestJavaOpts());</span>
<span class="line-added">193         return opts.toArray(new String[0]);</span>
<span class="line-added">194     }</span>
<span class="line-added">195 </span>
<span class="line-added">196     /**</span>
<span class="line-added">197      * Combines given arguments with default JTReg arguments for a jvm running a test.</span>
<span class="line-added">198      * This is the combination of JTReg arguments test.vm.opts and test.java.opts</span>
<span class="line-added">199      * @return The combination of JTReg test java options and user args.</span>
<span class="line-added">200      */</span>
<span class="line-added">201     public static String[] addTestJavaOpts(String... userArgs) {</span>
<span class="line-added">202         return prependTestJavaOpts(userArgs);</span>
<span class="line-added">203     }</span>
<span class="line-added">204 </span>
205     /**
206      * Removes any options specifying which GC to use, for example &quot;-XX:+UseG1GC&quot;.
207      * Removes any options matching: -XX:(+/-)Use*GC
208      * Used when a test need to set its own GC version. Then any
209      * GC specified by the framework must first be removed.
210      * @return A copy of given opts with all GC options removed.
211      */
212     private static final Pattern useGcPattern = Pattern.compile(
<span class="line-modified">213             &quot;(?:\\-XX\\:[\\+\\-]Use.+GC)&quot;);</span>

214     public static List&lt;String&gt; removeGcOpts(List&lt;String&gt; opts) {
215         List&lt;String&gt; optsWithoutGC = new ArrayList&lt;String&gt;();
216         for (String opt : opts) {
217             if (useGcPattern.matcher(opt).matches()) {
218                 System.out.println(&quot;removeGcOpts: removed &quot; + opt);
219             } else {
220                 optsWithoutGC.add(opt);
221             }
222         }
223         return optsWithoutGC;
224     }
225 
226     /**
227      * Returns the default JTReg arguments for a jvm running a test without
228      * options that matches regular expressions in {@code filters}.
229      * This is the combination of JTReg arguments test.vm.opts and test.java.opts.
230      * @param filters Regular expressions used to filter out options.
231      * @return An array of options, or an empty array if no options.
232      */
233     public static String[] getFilteredTestJavaOpts(String... filters) {
</pre>
<hr />
<pre>
744     }
745 
746     /*
747      * Returns the system distro.
748      */
749     public static String distro() {
750         try {
751             return uname(&quot;-v&quot;).asLines().get(0);
752         } catch (Throwable t) {
753             throw new RuntimeException(&quot;Failed to determine distro.&quot;, t);
754         }
755     }
756 
757     // This method is intended to be called from a jtreg test.
758     // It will identify the name of the test by means of stack walking.
759     // It can handle both jtreg tests and a testng tests wrapped inside jtreg tests.
760     // For jtreg tests the name of the test will be searched by stack-walking
761     // until the method main() is found; the class containing that method is the
762     // main test class and will be returned as the name of the test.
763     // Special handling is used for testng tests.
<span class="line-added">764     @SuppressWarnings(&quot;unchecked&quot;)</span>
765     public static String getTestName() {
766         String result = null;
767         // If we are using testng, then we should be able to load the &quot;Test&quot; annotation.
<span class="line-modified">768         Class&lt;? extends Annotation&gt; testClassAnnotation;</span>
769 
770         try {
<span class="line-modified">771             testClassAnnotation = (Class&lt;? extends Annotation&gt;)Class.forName(&quot;org.testng.annotations.Test&quot;);</span>
772         } catch (ClassNotFoundException e) {
773             testClassAnnotation = null;
774         }
775 
776         StackTraceElement[] elms = (new Throwable()).getStackTrace();
777         for (StackTraceElement n: elms) {
778             String className = n.getClassName();
779 
780             // If this is a &quot;main&quot; method, then use its class name, but only
781             // if we are not using testng.
782             if (testClassAnnotation == null &amp;&amp; &quot;main&quot;.equals(n.getMethodName())) {
783                 result = className;
784                 break;
785             }
786 
787             // If this is a testng test, the test will have no &quot;main&quot; method. We can
788             // detect a testng test class by looking for the org.testng.annotations.Test
789             // annotation. If present, then use the name of this class.
790             if (testClassAnnotation != null) {
791                 try {
<span class="line-modified">792                     Class&lt;?&gt; c = Class.forName(className);</span>
793                     if (c.isAnnotationPresent(testClassAnnotation)) {
794                         result = className;
795                         break;
796                     }
797                 } catch (ClassNotFoundException e) {
798                     throw new RuntimeException(&quot;Unexpected exception: &quot; + e, e);
799                 }
800             }
801         }
802 
803         if (result == null) {
804             throw new RuntimeException(&quot;Couldn&#39;t find main test class in stack trace&quot;);
805         }
806 
807         return result;
808     }
809 
810     /**
811      * Creates an empty file in &quot;user.dir&quot; if the property set.
812      * &lt;p&gt;
813      * This method is meant as a replacement for {@code Files#createTempFile(String, String, FileAttribute...)}
814      * that doesn&#39;t leave files behind in /tmp directory of the test machine
815      * &lt;p&gt;
816      * If the property &quot;user.dir&quot; is not set, &quot;.&quot; will be used.
817      *
818      * @param prefix
819      * @param suffix
820      * @param attrs
821      * @return the path to the newly created file that did not exist before this
822      *         method was invoked
823      * @throws IOException
824      *
825      * @see {@link Files#createTempFile(String, String, FileAttribute...)}
826      */
827     public static Path createTempFile(String prefix, String suffix, FileAttribute&lt;?&gt;... attrs) throws IOException {
828         Path dir = Paths.get(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));
829         return Files.createTempFile(dir, prefix, suffix);
830     }
<span class="line-added">831 </span>
<span class="line-added">832     /**</span>
<span class="line-added">833      * Creates an empty directory in &quot;user.dir&quot; or &quot;.&quot;</span>
<span class="line-added">834      * &lt;p&gt;</span>
<span class="line-added">835      * This method is meant as a replacement for {@code Files#createTempDirectory(String, String, FileAttribute...)}</span>
<span class="line-added">836      * that doesn&#39;t leave files behind in /tmp directory of the test machine</span>
<span class="line-added">837      * &lt;p&gt;</span>
<span class="line-added">838      * If the property &quot;user.dir&quot; is not set, &quot;.&quot; will be used.</span>
<span class="line-added">839      *</span>
<span class="line-added">840      * @param prefix</span>
<span class="line-added">841      * @param attrs</span>
<span class="line-added">842      * @return the path to the newly created directory</span>
<span class="line-added">843      * @throws IOException</span>
<span class="line-added">844      *</span>
<span class="line-added">845      * @see {@link Files#createTempDirectory(String, String, FileAttribute...)}</span>
<span class="line-added">846      */</span>
<span class="line-added">847     public static Path createTempDirectory(String prefix, FileAttribute&lt;?&gt;... attrs) throws IOException {</span>
<span class="line-added">848         Path dir = Paths.get(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));</span>
<span class="line-added">849         return Files.createTempDirectory(dir, prefix);</span>
<span class="line-added">850     }</span>
851 }
</pre>
</td>
</tr>
</table>
<center><a href="SecurityTools.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="apps/LingeredApp.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>