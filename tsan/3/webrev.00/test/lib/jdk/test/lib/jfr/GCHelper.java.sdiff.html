<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/lib/jdk/test/lib/jfr/GCHelper.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Events.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../process/OutputAnalyzer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/jfr/GCHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 51 
 52 /**
 53  * Mixed helper classes to test GC events.
 54  */
 55 public class GCHelper {
 56     public static final String event_garbage_collection = EventNames.GarbageCollection;
 57     public static final String event_young_garbage_collection = EventNames.YoungGarbageCollection;
 58     public static final String event_old_garbage_collection = EventNames.OldGarbageCollection;
 59     public static final String event_parold_garbage_collection = EventNames.ParallelOldCollection;
 60     public static final String event_g1_garbage_collection = EventNames.G1GarbageCollection;
 61     public static final String event_heap_summary = EventNames.GCHeapSummary;
 62     public static final String event_heap_ps_summary = EventNames.PSHeapSummary;
 63     public static final String event_heap_metaspace_summary = EventNames.MetaspaceSummary;
 64     public static final String event_reference_statistics = EventNames.GCReferenceStatistics;
 65     public static final String event_phases_pause = EventNames.GCPhasePause;
 66     public static final String event_phases_level_1 = EventNames.GCPhasePauseLevel1;
 67     public static final String event_phases_level_2 = EventNames.GCPhasePauseLevel2;
 68     public static final String event_phases_level_3 = EventNames.GCPhasePauseLevel3;
 69 
 70     public static final String gcG1New = &quot;G1New&quot;;
<span class="line-removed"> 71     public static final String gcParNew = &quot;ParNew&quot;;</span>
 72     public static final String gcDefNew = &quot;DefNew&quot;;
 73     public static final String gcParallelScavenge = &quot;ParallelScavenge&quot;;
 74     public static final String gcG1Old = &quot;G1Old&quot;;
 75     public static final String gcG1Full = &quot;G1Full&quot;;
<span class="line-removed"> 76     public static final String gcConcurrentMarkSweep = &quot;ConcurrentMarkSweep&quot;;</span>
 77     public static final String gcSerialOld = &quot;SerialOld&quot;;
 78     public static final String gcPSMarkSweep = &quot;PSMarkSweep&quot;;
 79     public static final String gcParallelOld = &quot;ParallelOld&quot;;
 80     public static final String pauseLevelEvent = &quot;GCPhasePauseLevel&quot;;
 81 
 82     private static final List&lt;String&gt; g1HeapRegionTypes;

 83     private static PrintStream defaultErrorLog = null;
 84 
 85     public static int getGcId(RecordedEvent event) {
 86         return Events.assertField(event, &quot;gcId&quot;).getValue();
 87     }
 88 
 89     public static boolean isGcEvent(RecordedEvent event) {
 90         for (ValueDescriptor v : event.getFields()) {
 91             if (&quot;gcId&quot;.equals(v.getName())) {
 92                 return true;
 93             }
 94         }
 95         return false;
 96     }
 97 
 98 //    public static String getEventDesc(RecordedEvent event) {
 99 //      final String path = event.getEventType().getName();
100 //        if (!isGcEvent(event)) {
101 //            return path;
102 //        }
</pre>
<hr />
<pre>
156         for (RecordedEvent event : events) {
157             if (Events.hasField(event, &quot;gcId&quot;)) {
158                 int gcId = Events.assertField(event, &quot;gcId&quot;).getValue();
159                 if (gcId != minGcId &amp;&amp; gcId != maxGcId) {
160                     filteredEvents.add(event);
161                 }
162             }
163         }
164         return filteredEvents;
165     }
166 
167     public static Map&lt;String, Boolean&gt; beanCollectorTypes = new HashMap&lt;&gt;();
168     public static Set&lt;String&gt; collectorOverrides = new HashSet&lt;&gt;();
169     public static Map&lt;String, String[]&gt; requiredEvents = new HashMap&lt;&gt;();
170 
171     static {
172         // young GarbageCollectionMXBeans.
173         beanCollectorTypes.put(&quot;G1 Young Generation&quot;, true);
174         beanCollectorTypes.put(&quot;Copy&quot;, true);
175         beanCollectorTypes.put(&quot;PS Scavenge&quot;, true);
<span class="line-removed">176         beanCollectorTypes.put(&quot;ParNew&quot;, true);</span>
177 
178         // old GarbageCollectionMXBeans.
179         beanCollectorTypes.put(&quot;G1 Old Generation&quot;, false);
<span class="line-removed">180         beanCollectorTypes.put(&quot;ConcurrentMarkSweep&quot;, false);</span>
181         beanCollectorTypes.put(&quot;PS MarkSweep&quot;, false);
182         beanCollectorTypes.put(&quot;MarkSweepCompact&quot;, false);
183 
184         // List of expected collector overrides. &quot;A.B&quot; means that collector A may use collector B.
185         collectorOverrides.add(&quot;G1Old.G1Full&quot;);
<span class="line-removed">186         collectorOverrides.add(&quot;ConcurrentMarkSweep.SerialOld&quot;);</span>
187         collectorOverrides.add(&quot;SerialOld.PSMarkSweep&quot;);
188 
189         requiredEvents.put(gcG1New, new String[] {event_heap_summary, event_young_garbage_collection});
<span class="line-removed">190         requiredEvents.put(gcParNew, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_young_garbage_collection});</span>
191         requiredEvents.put(gcDefNew, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_young_garbage_collection});
192         requiredEvents.put(gcParallelScavenge, new String[] {event_heap_summary, event_heap_ps_summary, event_heap_metaspace_summary, event_reference_statistics, event_phases_pause, event_phases_level_1, event_young_garbage_collection});
193         requiredEvents.put(gcG1Old, new String[] {event_heap_summary, event_old_garbage_collection});
194         requiredEvents.put(gcG1Full, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_old_garbage_collection});
<span class="line-removed">195         requiredEvents.put(gcConcurrentMarkSweep, new String[] {event_phases_pause, event_phases_level_1, event_old_garbage_collection});</span>
196         requiredEvents.put(gcSerialOld, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_old_garbage_collection});
197         requiredEvents.put(gcParallelOld, new String[] {event_heap_summary, event_heap_ps_summary, event_heap_metaspace_summary, event_reference_statistics, event_phases_pause, event_phases_level_1, event_old_garbage_collection, event_parold_garbage_collection});
198 
199         String[] g1HeapRegionTypeLiterals = new String[] {
200                                                            &quot;Free&quot;,
201                                                            &quot;Eden&quot;,
202                                                            &quot;Survivor&quot;,
203                                                            &quot;Starts Humongous&quot;,
204                                                            &quot;Continues Humongous&quot;,
205                                                            &quot;Old&quot;,
206                                                            &quot;Archive&quot;
207                                                          };
208 
209         g1HeapRegionTypes = Collections.unmodifiableList(Arrays.asList(g1HeapRegionTypeLiterals));















210     }
211 
212     /**
213      * Contains all GC events belonging to the same GC (same gcId).
214      */
215     public static class GcBatch {
216         private List&lt;RecordedEvent&gt; events = new ArrayList&lt;&gt;();
217 
218         public int getGcId() {
219             if (events.isEmpty()) {
220                 return -1;
221             }
222             return GCHelper.getGcId(events.get(0));
223         }
224 
225         public String getName() {
226             RecordedEvent endEvent = getEndEvent();
227             String name = endEvent == null ? null : Events.assertField(endEvent, &quot;name&quot;).getValue();
228             return name == null ? &quot;null&quot; : name;
229         }
</pre>
<hr />
<pre>
426                 e.printStackTrace();
427                 defaultErrorLog = System.err;
428             }
429         }
430         return defaultErrorLog;
431     }
432 
433     public static void log(Object msg) {
434         log(msg, System.err);
435         log(msg, getDefaultErrorLog());
436     }
437 
438     public static void log(Object msg, PrintStream ps) {
439         ps.println(msg);
440     }
441 
442     public static boolean isValidG1HeapRegionType(final String type) {
443         return g1HeapRegionTypes.contains(type);
444     }
445 







446     /**
447      * Helper function to align heap size up.
448      *
449      * @param value
450      * @param alignment
451      * @return aligned value
452      */
453     public static long alignUp(long value, long alignment) {
454         return (value + alignment - 1) &amp; ~(alignment - 1);
455     }
456 
457     /**
458      * Helper function to align heap size down.
459      *
460      * @param value
461      * @param alignment
462      * @return aligned value
463      */
464     public static long alignDown(long value, long alignment) {
465         return value &amp; ~(alignment - 1);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 51 
 52 /**
 53  * Mixed helper classes to test GC events.
 54  */
 55 public class GCHelper {
 56     public static final String event_garbage_collection = EventNames.GarbageCollection;
 57     public static final String event_young_garbage_collection = EventNames.YoungGarbageCollection;
 58     public static final String event_old_garbage_collection = EventNames.OldGarbageCollection;
 59     public static final String event_parold_garbage_collection = EventNames.ParallelOldCollection;
 60     public static final String event_g1_garbage_collection = EventNames.G1GarbageCollection;
 61     public static final String event_heap_summary = EventNames.GCHeapSummary;
 62     public static final String event_heap_ps_summary = EventNames.PSHeapSummary;
 63     public static final String event_heap_metaspace_summary = EventNames.MetaspaceSummary;
 64     public static final String event_reference_statistics = EventNames.GCReferenceStatistics;
 65     public static final String event_phases_pause = EventNames.GCPhasePause;
 66     public static final String event_phases_level_1 = EventNames.GCPhasePauseLevel1;
 67     public static final String event_phases_level_2 = EventNames.GCPhasePauseLevel2;
 68     public static final String event_phases_level_3 = EventNames.GCPhasePauseLevel3;
 69 
 70     public static final String gcG1New = &quot;G1New&quot;;

 71     public static final String gcDefNew = &quot;DefNew&quot;;
 72     public static final String gcParallelScavenge = &quot;ParallelScavenge&quot;;
 73     public static final String gcG1Old = &quot;G1Old&quot;;
 74     public static final String gcG1Full = &quot;G1Full&quot;;

 75     public static final String gcSerialOld = &quot;SerialOld&quot;;
 76     public static final String gcPSMarkSweep = &quot;PSMarkSweep&quot;;
 77     public static final String gcParallelOld = &quot;ParallelOld&quot;;
 78     public static final String pauseLevelEvent = &quot;GCPhasePauseLevel&quot;;
 79 
 80     private static final List&lt;String&gt; g1HeapRegionTypes;
<span class="line-added"> 81     private static final List&lt;String&gt; shenandoahHeapRegionStates;</span>
 82     private static PrintStream defaultErrorLog = null;
 83 
 84     public static int getGcId(RecordedEvent event) {
 85         return Events.assertField(event, &quot;gcId&quot;).getValue();
 86     }
 87 
 88     public static boolean isGcEvent(RecordedEvent event) {
 89         for (ValueDescriptor v : event.getFields()) {
 90             if (&quot;gcId&quot;.equals(v.getName())) {
 91                 return true;
 92             }
 93         }
 94         return false;
 95     }
 96 
 97 //    public static String getEventDesc(RecordedEvent event) {
 98 //      final String path = event.getEventType().getName();
 99 //        if (!isGcEvent(event)) {
100 //            return path;
101 //        }
</pre>
<hr />
<pre>
155         for (RecordedEvent event : events) {
156             if (Events.hasField(event, &quot;gcId&quot;)) {
157                 int gcId = Events.assertField(event, &quot;gcId&quot;).getValue();
158                 if (gcId != minGcId &amp;&amp; gcId != maxGcId) {
159                     filteredEvents.add(event);
160                 }
161             }
162         }
163         return filteredEvents;
164     }
165 
166     public static Map&lt;String, Boolean&gt; beanCollectorTypes = new HashMap&lt;&gt;();
167     public static Set&lt;String&gt; collectorOverrides = new HashSet&lt;&gt;();
168     public static Map&lt;String, String[]&gt; requiredEvents = new HashMap&lt;&gt;();
169 
170     static {
171         // young GarbageCollectionMXBeans.
172         beanCollectorTypes.put(&quot;G1 Young Generation&quot;, true);
173         beanCollectorTypes.put(&quot;Copy&quot;, true);
174         beanCollectorTypes.put(&quot;PS Scavenge&quot;, true);

175 
176         // old GarbageCollectionMXBeans.
177         beanCollectorTypes.put(&quot;G1 Old Generation&quot;, false);

178         beanCollectorTypes.put(&quot;PS MarkSweep&quot;, false);
179         beanCollectorTypes.put(&quot;MarkSweepCompact&quot;, false);
180 
181         // List of expected collector overrides. &quot;A.B&quot; means that collector A may use collector B.
182         collectorOverrides.add(&quot;G1Old.G1Full&quot;);

183         collectorOverrides.add(&quot;SerialOld.PSMarkSweep&quot;);
184 
185         requiredEvents.put(gcG1New, new String[] {event_heap_summary, event_young_garbage_collection});

186         requiredEvents.put(gcDefNew, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_young_garbage_collection});
187         requiredEvents.put(gcParallelScavenge, new String[] {event_heap_summary, event_heap_ps_summary, event_heap_metaspace_summary, event_reference_statistics, event_phases_pause, event_phases_level_1, event_young_garbage_collection});
188         requiredEvents.put(gcG1Old, new String[] {event_heap_summary, event_old_garbage_collection});
189         requiredEvents.put(gcG1Full, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_old_garbage_collection});

190         requiredEvents.put(gcSerialOld, new String[] {event_heap_summary, event_heap_metaspace_summary, event_phases_pause, event_phases_level_1, event_old_garbage_collection});
191         requiredEvents.put(gcParallelOld, new String[] {event_heap_summary, event_heap_ps_summary, event_heap_metaspace_summary, event_reference_statistics, event_phases_pause, event_phases_level_1, event_old_garbage_collection, event_parold_garbage_collection});
192 
193         String[] g1HeapRegionTypeLiterals = new String[] {
194                                                            &quot;Free&quot;,
195                                                            &quot;Eden&quot;,
196                                                            &quot;Survivor&quot;,
197                                                            &quot;Starts Humongous&quot;,
198                                                            &quot;Continues Humongous&quot;,
199                                                            &quot;Old&quot;,
200                                                            &quot;Archive&quot;
201                                                          };
202 
203         g1HeapRegionTypes = Collections.unmodifiableList(Arrays.asList(g1HeapRegionTypeLiterals));
<span class="line-added">204 </span>
<span class="line-added">205         String[] shenandoahHeapRegionStateLiterals = new String[] {</span>
<span class="line-added">206                                                                     &quot;Empty Uncommitted&quot;,</span>
<span class="line-added">207                                                                     &quot;Empty Committed&quot;,</span>
<span class="line-added">208                                                                     &quot;Regular&quot;,</span>
<span class="line-added">209                                                                     &quot;Humongous Start&quot;,</span>
<span class="line-added">210                                                                     &quot;Humongous Continuation&quot;,</span>
<span class="line-added">211                                                                     &quot;Humongous Start, Pinned&quot;,</span>
<span class="line-added">212                                                                     &quot;Collection Set&quot;,</span>
<span class="line-added">213                                                                     &quot;Pinned&quot;,</span>
<span class="line-added">214                                                                     &quot;Collection Set, Pinned&quot;,</span>
<span class="line-added">215                                                                     &quot;Trash&quot;</span>
<span class="line-added">216         };</span>
<span class="line-added">217 </span>
<span class="line-added">218         shenandoahHeapRegionStates = Collections.unmodifiableList(Arrays.asList(shenandoahHeapRegionStateLiterals));</span>
219     }
220 
221     /**
222      * Contains all GC events belonging to the same GC (same gcId).
223      */
224     public static class GcBatch {
225         private List&lt;RecordedEvent&gt; events = new ArrayList&lt;&gt;();
226 
227         public int getGcId() {
228             if (events.isEmpty()) {
229                 return -1;
230             }
231             return GCHelper.getGcId(events.get(0));
232         }
233 
234         public String getName() {
235             RecordedEvent endEvent = getEndEvent();
236             String name = endEvent == null ? null : Events.assertField(endEvent, &quot;name&quot;).getValue();
237             return name == null ? &quot;null&quot; : name;
238         }
</pre>
<hr />
<pre>
435                 e.printStackTrace();
436                 defaultErrorLog = System.err;
437             }
438         }
439         return defaultErrorLog;
440     }
441 
442     public static void log(Object msg) {
443         log(msg, System.err);
444         log(msg, getDefaultErrorLog());
445     }
446 
447     public static void log(Object msg, PrintStream ps) {
448         ps.println(msg);
449     }
450 
451     public static boolean isValidG1HeapRegionType(final String type) {
452         return g1HeapRegionTypes.contains(type);
453     }
454 
<span class="line-added">455     public static boolean assertIsValidShenandoahHeapRegionState(final String state) {</span>
<span class="line-added">456         if (!shenandoahHeapRegionStates.contains(state)) {</span>
<span class="line-added">457             throw new AssertionError(&quot;Unknown state &#39;&quot; + state + &quot;&#39;, valid heap region states are &quot; + shenandoahHeapRegionStates);</span>
<span class="line-added">458         }</span>
<span class="line-added">459         return true;</span>
<span class="line-added">460     }</span>
<span class="line-added">461 </span>
462     /**
463      * Helper function to align heap size up.
464      *
465      * @param value
466      * @param alignment
467      * @return aligned value
468      */
469     public static long alignUp(long value, long alignment) {
470         return (value + alignment - 1) &amp; ~(alignment - 1);
471     }
472 
473     /**
474      * Helper function to align heap size down.
475      *
476      * @param value
477      * @param alignment
478      * @return aligned value
479      */
480     public static long alignDown(long value, long alignment) {
481         return value &amp; ~(alignment - 1);
</pre>
</td>
</tr>
</table>
<center><a href="Events.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../process/OutputAnalyzer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>