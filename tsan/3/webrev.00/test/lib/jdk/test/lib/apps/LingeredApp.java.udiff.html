<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/apps/LingeredApp.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../Utils.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../artifacts/DefaultArtifactManager.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/apps/LingeredApp.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -32,15 +32,17 @@</span>
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.nio.file.attribute.BasicFileAttributes;
  import java.nio.file.attribute.FileTime;
  import java.util.ArrayList;
<span class="udiff-line-added">+ import java.util.Collections;</span>
  import java.util.Date;
  import java.util.List;
  import java.util.Map;
  import java.util.stream.Collectors;
  import java.util.UUID;
<span class="udiff-line-added">+ import jdk.test.lib.Utils;</span>
  import jdk.test.lib.process.OutputBuffer;
  import jdk.test.lib.process.StreamPumper;
  
  /**
   * This is a framework to launch an app that could be synchronized with caller
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -279,11 +281,11 @@</span>
  
      /**
       * Analyze an environment and prepare a command line to
       * run the app, app name should be added explicitly
       */
<span class="udiff-line-modified-removed">-     public List&lt;String&gt; runAppPrepare(List&lt;String&gt; vmArguments) {</span>
<span class="udiff-line-modified-added">+     public List&lt;String&gt; runAppPrepare(String[] vmArguments) {</span>
          // We should always use testjava or throw an exception,
          // so we can&#39;t use JDKToolFinder.getJDKTool(&quot;java&quot;);
          // that falls back to compile java on error
          String jdkPath = System.getProperty(&quot;test.jdk&quot;);
          if (jdkPath == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -301,21 +303,16 @@</span>
  
          List&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
          cmd.add(javapath);
  
          if (vmArguments == null) {
<span class="udiff-line-modified-removed">-             // Propagate test.vm.options to LingeredApp, filter out possible empty options</span>
<span class="udiff-line-modified-removed">-             String testVmOpts[] = System.getProperty(&quot;test.vm.opts&quot;,&quot;&quot;).split(&quot;\\s+&quot;);</span>
<span class="udiff-line-removed">-             for (String s : testVmOpts) {</span>
<span class="udiff-line-removed">-                 if (!s.equals(&quot;&quot;)) {</span>
<span class="udiff-line-removed">-                     cmd.add(s);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             // Propagate getTestJavaOpts() to LingeredApp</span>
<span class="udiff-line-modified-added">+             vmArguments = Utils.getTestJavaOpts();</span>
          } else {
              // Lets user manage LingeredApp options
<span class="udiff-line-removed">-             cmd.addAll(vmArguments);</span>
          }
<span class="udiff-line-added">+         Collections.addAll(cmd, vmArguments);</span>
  
          // Make sure we set correct classpath to run the app
          cmd.add(&quot;-cp&quot;);
          String classpath = System.getProperty(&quot;test.class.path&quot;);
          cmd.add((classpath == null) ? &quot;.&quot; : classpath);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -340,11 +337,11 @@</span>
       * Run the app.
       *
       * @param vmArguments
       * @throws IOException
       */
<span class="udiff-line-modified-removed">-     public void runApp(List&lt;String&gt; vmArguments)</span>
<span class="udiff-line-modified-added">+     public void runApp(String[] vmArguments)</span>
              throws IOException {
  
          List&lt;String&gt; cmd = runAppPrepare(vmArguments);
  
          cmd.add(this.getAppName());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -358,17 +355,19 @@</span>
  
          startOutputPumpers();
      }
  
      private void finishApp() {
<span class="udiff-line-modified-removed">-         OutputBuffer output = getOutput();</span>
<span class="udiff-line-modified-removed">-         String msg =</span>
<span class="udiff-line-modified-removed">-             &quot; LingeredApp stdout: [&quot; + output.getStdout() + &quot;];\n&quot; +</span>
<span class="udiff-line-modified-removed">-             &quot; LingeredApp stderr: [&quot; + output.getStderr() + &quot;]\n&quot; +</span>
<span class="udiff-line-modified-removed">-             &quot; LingeredApp exitValue = &quot; + appProcess.exitValue();</span>
<span class="udiff-line-modified-added">+         if (appProcess != null) {</span>
<span class="udiff-line-modified-added">+             OutputBuffer output = getOutput();</span>
<span class="udiff-line-modified-added">+             String msg =</span>
<span class="udiff-line-modified-added">+                     &quot; LingeredApp stdout: [&quot; + output.getStdout() + &quot;];\n&quot; +</span>
<span class="udiff-line-modified-added">+                     &quot; LingeredApp stderr: [&quot; + output.getStderr() + &quot;]\n&quot; +</span>
<span class="udiff-line-added">+                     &quot; LingeredApp exitValue = &quot; + appProcess.exitValue();</span>
  
<span class="udiff-line-modified-removed">-         System.err.println(msg);</span>
<span class="udiff-line-modified-added">+             System.err.println(msg);</span>
<span class="udiff-line-added">+         }</span>
      }
  
      /**
       * Delete lock file that signals app to terminate, then
       * wait until app is actually terminated.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -378,66 +377,59 @@</span>
          deleteLock();
          // The startApp() of the derived app can throw
          // an exception before the LA actually starts
          if (appProcess != null) {
              waitAppTerminate();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             finishApp();</span>
<span class="udiff-line-added">+ </span>
              int exitcode = appProcess.exitValue();
              if (exitcode != 0) {
                  throw new IOException(&quot;LingeredApp terminated with non-zero exit code &quot; + exitcode);
              }
          }
<span class="udiff-line-removed">-         finishApp();</span>
      }
  
      /**
       *  High level interface for test writers
       */
      /**
<span class="udiff-line-modified-removed">-      * Factory method that creates LingeredApp object with ready to use application</span>
<span class="udiff-line-modified-added">+      * Factory method that starts pre-created LingeredApp</span>
       * lock name is autogenerated
<span class="udiff-line-modified-removed">-      * @param cmd - vm options, could be null to auto add testvm.options</span>
<span class="udiff-line-modified-removed">-      * @return LingeredApp object</span>
<span class="udiff-line-modified-added">+      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>
<span class="udiff-line-modified-added">+      * @param theApp - app to start</span>
       * @throws IOException
       */
<span class="udiff-line-modified-removed">-     public static LingeredApp startApp(List&lt;String&gt; cmd) throws IOException {</span>
<span class="udiff-line-modified-removed">-         LingeredApp a = new LingeredApp();</span>
<span class="udiff-line-removed">-         a.createLock();</span>
<span class="udiff-line-modified-added">+     public static void startApp(LingeredApp theApp, String... cmd) throws IOException {</span>
<span class="udiff-line-modified-added">+         theApp.createLock();</span>
          try {
<span class="udiff-line-modified-removed">-             a.runApp(cmd);</span>
<span class="udiff-line-modified-removed">-             a.waitAppReady(appWaitTime);</span>
<span class="udiff-line-modified-added">+             theApp.runApp(cmd);</span>
<span class="udiff-line-modified-added">+             theApp.waitAppReady(appWaitTime);</span>
          } catch (Exception ex) {
<span class="udiff-line-modified-removed">-             a.deleteLock();</span>
<span class="udiff-line-removed">-             System.err.println(&quot;LingeredApp failed to start: &quot; + ex);</span>
<span class="udiff-line-removed">-             a.finishApp();</span>
<span class="udiff-line-modified-added">+             theApp.deleteLock();</span>
              throw ex;
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return a;</span>
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Factory method that starts pre-created LingeredApp</span>
<span class="udiff-line-modified-added">+      * Factory method that creates LingeredApp object with ready to use application</span>
       * lock name is autogenerated
<span class="udiff-line-modified-removed">-      * @param cmd - vm options, could be null to auto add testvm.options</span>
<span class="udiff-line-removed">-      * @param theApp - app to start</span>
<span class="udiff-line-modified-added">+      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>
       * @return LingeredApp object
       * @throws IOException
       */
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     public static void startApp(List&lt;String&gt; cmd, LingeredApp theApp) throws IOException {</span>
<span class="udiff-line-removed">-         theApp.createLock();</span>
<span class="udiff-line-modified-added">+     public static LingeredApp startApp(String... cmd) throws IOException {</span>
<span class="udiff-line-modified-added">+         LingeredApp a = new LingeredApp();</span>
          try {
<span class="udiff-line-modified-removed">-             theApp.runApp(cmd);</span>
<span class="udiff-line-removed">-             theApp.waitAppReady(appWaitTime);</span>
<span class="udiff-line-modified-added">+             startApp(a, cmd);</span>
          } catch (Exception ex) {
<span class="udiff-line-modified-removed">-             theApp.deleteLock();</span>
<span class="udiff-line-modified-added">+             System.err.println(&quot;LingeredApp failed to start: &quot; + ex);</span>
<span class="udiff-line-added">+             a.finishApp();</span>
              throw ex;
          }
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     public static LingeredApp startApp() throws IOException {</span>
<span class="udiff-line-removed">-         return startApp(null);</span>
<span class="udiff-line-modified-added">+         return a;</span>
      }
  
      public static void stopApp(LingeredApp app) throws IOException {
          if (app != null) {
              // LingeredApp can throw an exception during the intialization,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -490,22 +482,26 @@</span>
              System.err.println(&quot;Lock file name is not specified&quot;);
              System.exit(7);
          }
  
          String theLockFileName = args[0];
<span class="udiff-line-added">+         Path path = Paths.get(theLockFileName);</span>
  
          try {
<span class="udiff-line-removed">-             Path path = Paths.get(theLockFileName);</span>
<span class="udiff-line-removed">- </span>
              while (Files.exists(path)) {
                  // Touch the lock to indicate our readiness
                  setLastModified(theLockFileName, epoch());
                  Thread.sleep(spinDelay);
              }
<span class="udiff-line-modified-removed">-         } catch (NoSuchFileException ex) {</span>
<span class="udiff-line-modified-added">+         } catch (IOException ex) {</span>
              // Lock deleted while we are setting last modified time.
<span class="udiff-line-modified-removed">-             // Ignore error and lets the app exits</span>
<span class="udiff-line-modified-added">+             // Ignore the error and let the app exit.</span>
<span class="udiff-line-added">+             if (Files.exists(path)) {</span>
<span class="udiff-line-added">+                 // If the lock file was not removed, return an error.</span>
<span class="udiff-line-added">+                 System.err.println(&quot;LingeredApp IOException: lock file still exists&quot;);</span>
<span class="udiff-line-added">+                 System.exit(4);</span>
<span class="udiff-line-added">+             }</span>
          } catch (Exception ex) {
              System.err.println(&quot;LingeredApp ERROR: &quot; + ex);
              // Leave exit_code = 1 to Java launcher
              System.exit(3);
          }
</pre>
<center><a href="../Utils.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../artifacts/DefaultArtifactManager.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>