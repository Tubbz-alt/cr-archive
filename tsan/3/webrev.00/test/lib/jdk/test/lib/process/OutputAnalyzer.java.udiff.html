<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/process/OutputAnalyzer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../jfr/GCHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="OutputBuffer.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/process/OutputAnalyzer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,19 +25,34 @@</span>
  
  import jdk.test.lib.Asserts;
  
  import java.io.IOException;
  import java.io.PrintStream;
<span class="udiff-line-added">+ import java.nio.charset.Charset;</span>
<span class="udiff-line-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
  import java.util.Arrays;
  import java.util.List;
  import java.util.stream.Collectors;
  import java.util.regex.Matcher;
  import java.util.regex.Pattern;
  
  public final class OutputAnalyzer {
  
      private final OutputBuffer buffer;
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Create an OutputAnalyzer, a utility class for verifying output and exit</span>
<span class="udiff-line-added">+      * value from a Process</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param process Process to analyze</span>
<span class="udiff-line-added">+      * @param cs The charset used to convert stdout/stderr from bytes to chars</span>
<span class="udiff-line-added">+      *           or null for the default charset.</span>
<span class="udiff-line-added">+      * @throws IOException If an I/O error occurs.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public OutputAnalyzer(Process process, Charset cs) throws IOException {</span>
<span class="udiff-line-added">+         buffer = OutputBuffer.of(process, cs);</span>
<span class="udiff-line-added">+     }</span>
      /**
       * Create an OutputAnalyzer, a utility class for verifying output and exit
       * value from a Process
       *
       * @param process Process to analyze
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,20 +69,41 @@</span>
       */
      public OutputAnalyzer(String buf) {
          buffer = OutputBuffer.of(buf, buf);
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Create an OutputAnalyzer, a utility class for verifying output</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param file File to analyze</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public OutputAnalyzer(Path file) throws IOException {</span>
<span class="udiff-line-added">+         this(Files.readString(file));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Create an OutputAnalyzer, a utility class for verifying output
       *
       * @param stdout stdout buffer to analyze
       * @param stderr stderr buffer to analyze
       */
      public OutputAnalyzer(String stdout, String stderr) {
          buffer = OutputBuffer.of(stdout, stderr);
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Create an OutputAnalyzer, a utility class for verifying output</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param stdout stdout buffer to analyze</span>
<span class="udiff-line-added">+      * @param stderr stderr buffer to analyze</span>
<span class="udiff-line-added">+      * @param stderr exitValue result to analyze</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public OutputAnalyzer(String stdout, String stderr, int exitValue)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         buffer = OutputBuffer.of(stdout, stderr, exitValue);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Verify that the stdout contents of output buffer is empty
       *
       * @throws RuntimeException
       *             If stdout was not empty
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -610,14 +646,14 @@</span>
       * Verify that the stdout and stderr contents of output buffer match the
       * {@code pattern} line by line. The whole output could be matched or
       * just a subset of it.
       *
       * @param from
<span class="udiff-line-modified-removed">-      *            The line from where output will be matched.</span>
<span class="udiff-line-modified-added">+      *            The line (excluded) from where output will be matched.</span>
       *            Set {@code from} to null for matching from the first line.
       * @param to
<span class="udiff-line-modified-removed">-      *            The line until where output will be matched.</span>
<span class="udiff-line-modified-added">+      *            The line (excluded) until where output will be matched.</span>
       *            Set {@code to} to null for matching until the last line.
       * @param pattern
       *            Matching pattern
       */
      public OutputAnalyzer shouldMatchByLine(String from, String to, String pattern) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -628,14 +664,14 @@</span>
       * Verify that the stdout contents of output buffer matches the
       * {@code pattern} line by line. The whole stdout could be matched or
       * just a subset of it.
       *
       * @param from
<span class="udiff-line-modified-removed">-      *            The line from where stdout will be matched.</span>
<span class="udiff-line-modified-added">+      *            The line (excluded) from where stdout will be matched.</span>
       *            Set {@code from} to null for matching from the first line.
       * @param to
<span class="udiff-line-modified-removed">-      *            The line until where stdout will be matched.</span>
<span class="udiff-line-modified-added">+      *            The line (excluded) until where stdout will be matched.</span>
       *            Set {@code to} to null for matching until the last line.
       * @param pattern
       *            Matching pattern
       */
      public OutputAnalyzer stdoutShouldMatchByLine(String from, String to, String pattern) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -645,43 +681,45 @@</span>
      private OutputAnalyzer shouldMatchByLine(String buffer, String from, String to, String pattern) {
          List&lt;String&gt; lines = asLines(buffer);
  
          int fromIndex = 0;
          if (from != null) {
<span class="udiff-line-modified-removed">-             fromIndex = indexOf(lines, from);</span>
<span class="udiff-line-modified-removed">-             Asserts.assertGreaterThan(fromIndex, -1,</span>
<span class="udiff-line-modified-added">+             fromIndex = indexOf(lines, from, 0) + 1; // + 1 -&gt; apply &#39;pattern&#39; to lines after &#39;from&#39; match</span>
<span class="udiff-line-modified-added">+             Asserts.assertGreaterThan(fromIndex, 0,</span>
                      &quot;The line/pattern &#39;&quot; + from + &quot;&#39; from where the output should match can not be found&quot;);
          }
  
          int toIndex = lines.size();
          if (to != null) {
<span class="udiff-line-modified-removed">-             toIndex = indexOf(lines, to);</span>
<span class="udiff-line-modified-removed">-             Asserts.assertGreaterThan(toIndex, -1,</span>
<span class="udiff-line-modified-added">+             toIndex = indexOf(lines, to, fromIndex);</span>
<span class="udiff-line-modified-added">+             Asserts.assertGreaterThan(toIndex, fromIndex,</span>
                      &quot;The line/pattern &#39;&quot; + to + &quot;&#39; until where the output should match can not be found&quot;);
          }
  
          List&lt;String&gt; subList = lines.subList(fromIndex, toIndex);
<span class="udiff-line-modified-removed">-         Asserts.assertFalse(subList.isEmpty(), &quot;There are no lines to check&quot;);</span>
<span class="udiff-line-modified-added">+         Asserts.assertFalse(subList.isEmpty(), &quot;There are no lines to check:&quot;</span>
<span class="udiff-line-added">+                 + &quot; range &quot; + fromIndex + &quot;..&quot; + toIndex + &quot;, subList = &quot; + subList);</span>
  
          subList.stream()
                 .filter(Pattern.compile(pattern).asPredicate().negate())
                 .findAny()
<span class="udiff-line-modified-removed">-                .ifPresent(line -&gt; Asserts.assertTrue(false,</span>
<span class="udiff-line-modified-added">+                .ifPresent(line -&gt; Asserts.fail(</span>
                         &quot;The line &#39;&quot; + line + &quot;&#39; does not match pattern &#39;&quot; + pattern + &quot;&#39;&quot;));
  
          return this;
      }
  
      /**
       * Check if there is a line matching {@code regexp} and return its index
       *
       * @param regexp Matching pattern
<span class="udiff-line-added">+      * @param fromIndex Start matching after so many lines skipped</span>
       * @return Index of first matching line
       */
<span class="udiff-line-modified-removed">-     private int indexOf(List&lt;String&gt; lines, String regexp) {</span>
<span class="udiff-line-modified-added">+     private int indexOf(List&lt;String&gt; lines, String regexp, int fromIndex) {</span>
          Pattern pattern = Pattern.compile(regexp);
<span class="udiff-line-modified-removed">-         for (int i = 0; i &lt; lines.size(); i++) {</span>
<span class="udiff-line-modified-added">+         for (int i = fromIndex; i &lt; lines.size(); i++) {</span>
              if (pattern.matcher(lines.get(i)).matches()) {
                  return i;
              }
          }
          return -1;
</pre>
<center><a href="../jfr/GCHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="OutputBuffer.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>