<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/lib/jdk/test/lib/containers/cgroup/MetricsTester.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a>
 24 package jdk.test.lib.containers.cgroup;
 25 
<a name="3" id="anc3"></a><span class="line-modified"> 26 import java.io.File;</span>
<span class="line-modified"> 27 import java.io.FileNotFoundException;</span>
<span class="line-removed"> 28 import java.io.IOException;</span>
<span class="line-removed"> 29 import java.nio.file.Files;</span>
<span class="line-removed"> 30 import java.nio.file.Path;</span>
<span class="line-removed"> 31 import java.nio.file.Paths;</span>
<span class="line-removed"> 32 import java.util.Arrays;</span>
<span class="line-removed"> 33 import java.util.HashMap;</span>
<span class="line-removed"> 34 import java.util.HashSet;</span>
<span class="line-removed"> 35 import java.util.Map;</span>
<span class="line-removed"> 36 import java.util.Scanner;</span>
<span class="line-removed"> 37 import java.util.Set;</span>
<span class="line-removed"> 38 import java.util.stream.Collectors;</span>
<span class="line-removed"> 39 import java.util.stream.IntStream;</span>
<span class="line-removed"> 40 import java.util.stream.LongStream;</span>
<span class="line-removed"> 41 import java.util.stream.Stream;</span>
 42 import jdk.internal.platform.Metrics;
 43 
<a name="4" id="anc4"></a>



 44 public class MetricsTester {
 45 
<a name="5" id="anc5"></a><span class="line-modified"> 46     private static final double ERROR_MARGIN = 0.1;</span>
<span class="line-modified"> 47     private static long unlimited_minimum = 0x7FFFFFFFFF000000L;</span>
<span class="line-removed"> 48     long startSysVal;</span>
<span class="line-removed"> 49     long startUserVal;</span>
<span class="line-removed"> 50     long startUsage;</span>
<span class="line-removed"> 51     long startPerCpu[];</span>
<span class="line-removed"> 52 </span>
<span class="line-removed"> 53     enum SubSystem {</span>
<span class="line-removed"> 54         MEMORY(&quot;memory&quot;),</span>
<span class="line-removed"> 55         CPUSET(&quot;cpuset&quot;),</span>
<span class="line-removed"> 56         CPU(&quot;cpu&quot;),</span>
<span class="line-removed"> 57         CPUACCT(&quot;cpuacct&quot;),</span>
<span class="line-removed"> 58         BLKIO(&quot;blkio&quot;);</span>
 59 
<a name="6" id="anc6"></a><span class="line-modified"> 60         private String value;</span>
<span class="line-modified"> 61 </span>
<span class="line-modified"> 62         SubSystem(String value) {</span>
<span class="line-modified"> 63             this.value = value;</span>
<span class="line-modified"> 64         }</span>
<span class="line-modified"> 65 </span>
<span class="line-modified"> 66         public String value() {</span>
<span class="line-modified"> 67             return value;</span>




 68         }
 69     }
 70 
<a name="7" id="anc7"></a><span class="line-modified"> 71     private static final Set&lt;String&gt; allowedSubSystems =</span>
<span class="line-modified"> 72             Stream.of(SubSystem.values()).map(SubSystem::value).collect(Collectors.toSet());</span>
<span class="line-modified"> 73 </span>
<span class="line-modified"> 74     private static final Map&lt;String, String[]&gt; subSystemPaths = new HashMap&lt;&gt;();</span>
<span class="line-modified"> 75 </span>
<span class="line-modified"> 76     private static void setPath(String[] line) {</span>
<span class="line-modified"> 77         String cgroupPath = line[2];</span>
<span class="line-modified"> 78         String[] subSystems = line[1].split(&quot;,&quot;);</span>
<span class="line-modified"> 79 </span>
<span class="line-removed"> 80         for (String subSystem : subSystems) {</span>
<span class="line-removed"> 81             if (allowedSubSystems.contains(subSystem)) {</span>
<span class="line-removed"> 82                 String[] paths = subSystemPaths.get(subSystem);</span>
<span class="line-removed"> 83                 String finalPath = &quot;&quot;;</span>
<span class="line-removed"> 84                 String root = paths[0];</span>
<span class="line-removed"> 85                 String mountPoint = paths[1];</span>
<span class="line-removed"> 86                 if (root != null &amp;&amp; cgroupPath != null) {</span>
<span class="line-removed"> 87                     if (root.equals(&quot;/&quot;)) {</span>
<span class="line-removed"> 88                         if (cgroupPath.equals(&quot;/&quot;)) {</span>
<span class="line-removed"> 89                             finalPath = mountPoint + cgroupPath;</span>
<span class="line-removed"> 90                         } else {</span>
<span class="line-removed"> 91                             finalPath = mountPoint;</span>
<span class="line-removed"> 92                         }</span>
<span class="line-removed"> 93                     } else {</span>
<span class="line-removed"> 94                         if (root.equals(cgroupPath)) {</span>
<span class="line-removed"> 95                             finalPath = mountPoint;</span>
<span class="line-removed"> 96                         } else {</span>
<span class="line-removed"> 97                             if (root.indexOf(cgroupPath) == 0) {</span>
<span class="line-removed"> 98                                 if (cgroupPath.length() &gt; root.length()) {</span>
<span class="line-removed"> 99                                     String cgroupSubstr = cgroupPath.substring(root.length());</span>
<span class="line-removed">100                                     finalPath = mountPoint + cgroupSubstr;</span>
<span class="line-removed">101                                 }</span>
<span class="line-removed">102                             }</span>
<span class="line-removed">103                         }</span>
<span class="line-removed">104                     }</span>
<span class="line-removed">105                 }</span>
<span class="line-removed">106                 subSystemPaths.put(subSystem, new String[]{finalPath});</span>
<span class="line-removed">107             }</span>
<span class="line-removed">108         }</span>
<span class="line-removed">109     }</span>
<span class="line-removed">110 </span>
<span class="line-removed">111     private static void createSubsystems(String[] line) {</span>
<span class="line-removed">112         if (line.length &lt; 5) return;</span>
<span class="line-removed">113         Path p = Paths.get(line[4]);</span>
<span class="line-removed">114         String subsystemName = p.getFileName().toString();</span>
<span class="line-removed">115         if (subsystemName != null) {</span>
<span class="line-removed">116             for (String subSystem : subsystemName.split(&quot;,&quot;)) {</span>
<span class="line-removed">117                 if (allowedSubSystems.contains(subSystem)) {</span>
<span class="line-removed">118                     subSystemPaths.put(subSystem, new String[]{line[3], line[4]});</span>
<span class="line-removed">119                 }</span>
<span class="line-removed">120             }</span>
<span class="line-removed">121         }</span>
<span class="line-removed">122     }</span>
<span class="line-removed">123 </span>
<span class="line-removed">124     public void setup() {</span>
<span class="line-removed">125         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">126         // Initialize CPU usage metrics before we do any testing.</span>
<span class="line-removed">127         startSysVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">128         startUserVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">129         startUsage = metrics.getCpuUsage();</span>
<span class="line-removed">130         startPerCpu = metrics.getPerCpuUsage();</span>
<span class="line-removed">131 </span>
<span class="line-removed">132         try {</span>
<span class="line-removed">133             Stream&lt;String&gt; lines = Files.lines(Paths.get(&quot;/proc/self/mountinfo&quot;));</span>
<span class="line-removed">134             lines.filter(line -&gt; line.contains(&quot; - cgroup cgroup &quot;))</span>
<span class="line-removed">135                     .map(line -&gt; line.split(&quot; &quot;))</span>
<span class="line-removed">136                     .forEach(MetricsTester::createSubsystems);</span>
<span class="line-removed">137             lines.close();</span>
<span class="line-removed">138 </span>
<span class="line-removed">139             lines = Files.lines(Paths.get(&quot;/proc/self/cgroup&quot;));</span>
<span class="line-removed">140             lines.map(line -&gt; line.split(&quot;:&quot;))</span>
<span class="line-removed">141                     .filter(line -&gt; (line.length &gt;= 3))</span>
<span class="line-removed">142                     .forEach(MetricsTester::setPath);</span>
<span class="line-removed">143             lines.close();</span>
<span class="line-removed">144         } catch (IOException e) {</span>
<span class="line-removed">145         }</span>
<span class="line-removed">146     }</span>
<span class="line-removed">147 </span>
<span class="line-removed">148     private static String getFileContents(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">149         String fname = subSystemPaths.get(subSystem.value())[0] + File.separator + fileName;</span>
<span class="line-removed">150         try {</span>
<span class="line-removed">151             return new Scanner(new File(fname)).useDelimiter(&quot;\\Z&quot;).next();</span>
<span class="line-removed">152         } catch (FileNotFoundException e) {</span>
<span class="line-removed">153             System.err.println(&quot;Unable to open : &quot; + fname);</span>
<span class="line-removed">154             return &quot;&quot;;</span>
<span class="line-removed">155         }</span>
<span class="line-removed">156     }</span>
<span class="line-removed">157 </span>
<span class="line-removed">158     private static long getLongValueFromFile(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">159         String data = getFileContents(subSystem, fileName);</span>
<span class="line-removed">160         return data.isEmpty() ? 0L : Long.parseLong(data);</span>
<span class="line-removed">161     }</span>
<span class="line-removed">162 </span>
<span class="line-removed">163     private static long getLongValueFromFile(SubSystem subSystem, String metric, String subMetric) {</span>
<span class="line-removed">164         String stats = getFileContents(subSystem, metric);</span>
<span class="line-removed">165         String[] tokens = stats.split(&quot;[\\r\\n]+&quot;);</span>
<span class="line-removed">166         for (int i = 0; i &lt; tokens.length; i++) {</span>
<span class="line-removed">167             if (tokens[i].startsWith(subMetric)) {</span>
<span class="line-removed">168                 return Long.parseLong(tokens[i].split(&quot;\\s+&quot;)[1]);</span>
<span class="line-removed">169             }</span>
<span class="line-removed">170         }</span>
<span class="line-removed">171         return 0L;</span>
<span class="line-removed">172     }</span>
<span class="line-removed">173 </span>
<span class="line-removed">174     private static double getDoubleValueFromFile(SubSystem subSystem, String fileName) {</span>
<span class="line-removed">175         String data = getFileContents(subSystem, fileName);</span>
<span class="line-removed">176         return data.isEmpty() ? 0.0 : Double.parseDouble(data);</span>
<span class="line-removed">177     }</span>
<span class="line-removed">178 </span>
<span class="line-removed">179     private boolean compareWithErrorMargin(long oldVal, long newVal) {</span>
<span class="line-removed">180         return Math.abs(oldVal - newVal) &lt;= Math.abs(oldVal * ERROR_MARGIN);</span>
<span class="line-removed">181     }</span>
<span class="line-removed">182 </span>
<span class="line-removed">183     private boolean compareWithErrorMargin(double oldVal, double newVal) {</span>
<span class="line-removed">184         return Math.abs(oldVal - newVal) &lt;= Math.abs(oldVal * ERROR_MARGIN);</span>
<span class="line-removed">185     }</span>
<span class="line-removed">186 </span>
<span class="line-removed">187     private static void fail(SubSystem system, String metric, long oldVal, long testVal) {</span>
<span class="line-removed">188         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">189                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">190     }</span>
<span class="line-removed">191 </span>
<span class="line-removed">192     private static void fail(SubSystem system, String metric, String oldVal, String testVal) {</span>
<span class="line-removed">193         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">194                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">195     }</span>
<span class="line-removed">196 </span>
<span class="line-removed">197     private static void fail(SubSystem system, String metric, double oldVal, double testVal) {</span>
<span class="line-removed">198         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">199                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">200     }</span>
<span class="line-removed">201 </span>
<span class="line-removed">202     private static void fail(SubSystem system, String metric, boolean oldVal, boolean testVal) {</span>
<span class="line-removed">203         throw new RuntimeException(&quot;Test failed for - &quot; + system.value + &quot;:&quot;</span>
<span class="line-removed">204                 + metric + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">205     }</span>
<span class="line-removed">206 </span>
<span class="line-removed">207     private static void warn(SubSystem system, String metric, long oldVal, long testVal) {</span>
<span class="line-removed">208         System.err.println(&quot;Warning - &quot; + system.value + &quot;:&quot; + metric</span>
<span class="line-removed">209                 + &quot;, expected [&quot; + oldVal + &quot;], got [&quot; + testVal + &quot;]&quot;);</span>
<span class="line-removed">210     }</span>
<span class="line-removed">211 </span>
<span class="line-removed">212     public void testMemorySubsystem() {</span>
<span class="line-removed">213         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">214 </span>
<span class="line-removed">215         // User Memory</span>
<span class="line-removed">216         long oldVal = metrics.getMemoryFailCount();</span>
<span class="line-removed">217         long newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.failcnt&quot;);</span>
<span class="line-removed">218         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">219             fail(SubSystem.MEMORY, &quot;memory.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">220         }</span>
<span class="line-removed">221 </span>
<span class="line-removed">222         oldVal = metrics.getMemoryLimit();</span>
<span class="line-removed">223         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.limit_in_bytes&quot;);</span>
<span class="line-removed">224         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">225         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">226             fail(SubSystem.MEMORY, &quot;memory.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">227         }</span>
<span class="line-removed">228 </span>
<span class="line-removed">229         oldVal = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">230         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.max_usage_in_bytes&quot;);</span>
<span class="line-removed">231         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">232             fail(SubSystem.MEMORY, &quot;memory.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">233         }</span>
<span class="line-removed">234 </span>
<span class="line-removed">235         oldVal = metrics.getMemoryUsage();</span>
<span class="line-removed">236         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.usage_in_bytes&quot;);</span>
<span class="line-removed">237         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">238             fail(SubSystem.MEMORY, &quot;memory.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">239         }</span>
<span class="line-removed">240 </span>
<span class="line-removed">241         // Kernel memory</span>
<span class="line-removed">242         oldVal = metrics.getKernelMemoryFailCount();</span>
<span class="line-removed">243         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.failcnt&quot;);</span>
<span class="line-removed">244         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">245             fail(SubSystem.MEMORY, &quot;memory.kmem.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">246         }</span>
<span class="line-removed">247 </span>
<span class="line-removed">248         oldVal = metrics.getKernelMemoryLimit();</span>
<span class="line-removed">249         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.limit_in_bytes&quot;);</span>
<span class="line-removed">250         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">251         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">252             fail(SubSystem.MEMORY, &quot;memory.kmem.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">253         }</span>
<span class="line-removed">254 </span>
<span class="line-removed">255         oldVal = metrics.getKernelMemoryMaxUsage();</span>
<span class="line-removed">256         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.max_usage_in_bytes&quot;);</span>
<span class="line-removed">257         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">258             fail(SubSystem.MEMORY, &quot;memory.kmem.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">259         }</span>
<span class="line-removed">260 </span>
<span class="line-removed">261         oldVal = metrics.getKernelMemoryUsage();</span>
<span class="line-removed">262         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.usage_in_bytes&quot;);</span>
<span class="line-removed">263         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">264             fail(SubSystem.MEMORY, &quot;memory.kmem.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">265         }</span>
<span class="line-removed">266 </span>
<span class="line-removed">267         //TCP Memory</span>
<span class="line-removed">268         oldVal = metrics.getTcpMemoryFailCount();</span>
<span class="line-removed">269         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.failcnt&quot;);</span>
<span class="line-removed">270         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">271             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">272         }</span>
<span class="line-removed">273 </span>
<span class="line-removed">274         oldVal = metrics.getTcpMemoryLimit();</span>
<span class="line-removed">275         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.limit_in_bytes&quot;);</span>
<span class="line-removed">276         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">277         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">278             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">279         }</span>
<span class="line-removed">280 </span>
<span class="line-removed">281         oldVal = metrics.getTcpMemoryMaxUsage();</span>
<span class="line-removed">282         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.max_usage_in_bytes&quot;);</span>
<span class="line-removed">283         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">284             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">285         }</span>
<span class="line-removed">286 </span>
<span class="line-removed">287         oldVal = metrics.getTcpMemoryUsage();</span>
<span class="line-removed">288         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.kmem.tcp.usage_in_bytes&quot;);</span>
<span class="line-removed">289         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">290             fail(SubSystem.MEMORY, &quot;memory.kmem.tcp.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">291         }</span>
<span class="line-removed">292 </span>
<span class="line-removed">293         //  Memory and Swap</span>
<span class="line-removed">294         oldVal = metrics.getMemoryAndSwapFailCount();</span>
<span class="line-removed">295         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.failcnt&quot;);</span>
<span class="line-removed">296         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">297             fail(SubSystem.MEMORY, &quot;memory.memsw.failcnt&quot;, oldVal, newVal);</span>
<span class="line-removed">298         }</span>
<span class="line-removed">299 </span>
<span class="line-removed">300         oldVal = metrics.getMemoryAndSwapLimit();</span>
<span class="line-removed">301         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.limit_in_bytes&quot;);</span>
<span class="line-removed">302         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">303         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">304             fail(SubSystem.MEMORY, &quot;memory.memsw.limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">305         }</span>
<span class="line-removed">306 </span>
<span class="line-removed">307         oldVal = metrics.getMemoryAndSwapMaxUsage();</span>
<span class="line-removed">308         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.max_usage_in_bytes&quot;);</span>
<span class="line-removed">309         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">310             fail(SubSystem.MEMORY, &quot;memory.memsw.max_usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">311         }</span>
<span class="line-removed">312 </span>
<span class="line-removed">313         oldVal = metrics.getMemoryAndSwapUsage();</span>
<span class="line-removed">314         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.memsw.usage_in_bytes&quot;);</span>
<span class="line-removed">315         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">316             fail(SubSystem.MEMORY, &quot;memory.memsw.usage_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">317         }</span>
<span class="line-removed">318 </span>
<span class="line-removed">319         oldVal = metrics.getMemorySoftLimit();</span>
<span class="line-removed">320         newVal = getLongValueFromFile(SubSystem.MEMORY, &quot;memory.soft_limit_in_bytes&quot;);</span>
<span class="line-removed">321         newVal = newVal &gt; unlimited_minimum ? -1L : newVal;</span>
<span class="line-removed">322         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">323             fail(SubSystem.MEMORY, &quot;memory.soft_limit_in_bytes&quot;, oldVal, newVal);</span>
<span class="line-removed">324         }</span>
<span class="line-removed">325 </span>
<span class="line-removed">326         boolean oomKillEnabled = metrics.isMemoryOOMKillEnabled();</span>
<span class="line-removed">327         boolean newOomKillEnabled = getLongValueFromFile(SubSystem.MEMORY,</span>
<span class="line-removed">328                 &quot;memory.oom_control&quot;, &quot;oom_kill_disable&quot;) == 0L ? true : false;</span>
<span class="line-removed">329         if (oomKillEnabled != newOomKillEnabled) {</span>
<span class="line-removed">330             throw new RuntimeException(&quot;Test failed for - &quot; + SubSystem.MEMORY.value + &quot;:&quot;</span>
<span class="line-removed">331                     + &quot;memory.oom_control:oom_kill_disable&quot; + &quot;, expected [&quot;</span>
<span class="line-removed">332                     + oomKillEnabled + &quot;], got [&quot; + newOomKillEnabled + &quot;]&quot;);</span>
<span class="line-removed">333         }</span>
<span class="line-removed">334     }</span>
<span class="line-removed">335 </span>
<span class="line-removed">336     public void testCpuAccounting() {</span>
<span class="line-removed">337         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">338         long oldVal = metrics.getCpuUsage();</span>
<span class="line-removed">339         long newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.usage&quot;);</span>
<span class="line-removed">340 </span>
<span class="line-removed">341         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">342             warn(SubSystem.CPUACCT, &quot;cpuacct.usage&quot;, oldVal, newVal);</span>
<span class="line-removed">343         }</span>
<span class="line-removed">344 </span>
<span class="line-removed">345         Long[] newVals = Stream.of(getFileContents(SubSystem.CPUACCT, &quot;cpuacct.usage_percpu&quot;)</span>
<span class="line-removed">346                 .split(&quot;\\s+&quot;))</span>
<span class="line-removed">347                 .map(Long::parseLong)</span>
<span class="line-removed">348                 .toArray(Long[]::new);</span>
<span class="line-removed">349         Long[] oldVals = LongStream.of(metrics.getPerCpuUsage()).boxed().toArray(Long[]::new);</span>
<span class="line-removed">350         for (int i = 0; i &lt; oldVals.length; i++) {</span>
<span class="line-removed">351             if (!compareWithErrorMargin(oldVals[i], newVals[i])) {</span>
<span class="line-removed">352                 warn(SubSystem.CPUACCT, &quot;cpuacct.usage_percpu&quot;, oldVals[i], newVals[i]);</span>
<span class="line-removed">353             }</span>
<span class="line-removed">354         }</span>
<span class="line-removed">355 </span>
<span class="line-removed">356         oldVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">357         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.stat&quot;, &quot;user&quot;);</span>
<span class="line-removed">358         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">359             warn(SubSystem.CPUACCT, &quot;cpuacct.usage - user&quot;, oldVal, newVal);</span>
<span class="line-removed">360         }</span>
<span class="line-removed">361 </span>
<span class="line-removed">362         oldVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">363         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpuacct.stat&quot;, &quot;system&quot;);</span>
<span class="line-removed">364         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">365             warn(SubSystem.CPUACCT, &quot;cpuacct.usage - system&quot;, oldVal, newVal);</span>
<span class="line-removed">366         }</span>
<span class="line-removed">367     }</span>
<span class="line-removed">368 </span>
<span class="line-removed">369     public void testCpuSchedulingMetrics() {</span>
<span class="line-removed">370         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">371         long oldVal = metrics.getCpuPeriod();</span>
<span class="line-removed">372         long newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.cfs_period_us&quot;);</span>
<span class="line-removed">373         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">374             fail(SubSystem.CPUACCT, &quot;cpu.cfs_period_us&quot;, oldVal, newVal);</span>
<span class="line-removed">375         }</span>
<span class="line-removed">376 </span>
<span class="line-removed">377         oldVal = metrics.getCpuQuota();</span>
<span class="line-removed">378         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.cfs_quota_us&quot;);</span>
<span class="line-removed">379         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">380             fail(SubSystem.CPUACCT, &quot;cpu.cfs_quota_us&quot;, oldVal, newVal);</span>
<span class="line-removed">381         }</span>
<span class="line-removed">382 </span>
<span class="line-removed">383         oldVal = metrics.getCpuShares();</span>
<span class="line-removed">384         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.shares&quot;);</span>
<span class="line-removed">385         if (newVal == 0 || newVal == 1024) newVal = -1;</span>
<span class="line-removed">386         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">387             fail(SubSystem.CPUACCT, &quot;cpu.shares&quot;, oldVal, newVal);</span>
<span class="line-removed">388         }</span>
<span class="line-removed">389 </span>
<span class="line-removed">390         oldVal = metrics.getCpuNumPeriods();</span>
<span class="line-removed">391         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;nr_periods&quot;);</span>
<span class="line-removed">392         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">393             fail(SubSystem.CPUACCT, &quot;cpu.stat - nr_periods&quot;, oldVal, newVal);</span>
<span class="line-removed">394         }</span>
<span class="line-removed">395 </span>
<span class="line-removed">396         oldVal = metrics.getCpuNumThrottled();</span>
<span class="line-removed">397         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;nr_throttled&quot;);</span>
<span class="line-removed">398         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">399             fail(SubSystem.CPUACCT, &quot;cpu.stat - nr_throttled&quot;, oldVal, newVal);</span>
<span class="line-removed">400         }</span>
<span class="line-removed">401 </span>
<span class="line-removed">402         oldVal = metrics.getCpuThrottledTime();</span>
<span class="line-removed">403         newVal = getLongValueFromFile(SubSystem.CPUACCT, &quot;cpu.stat&quot;, &quot;throttled_time&quot;);</span>
<span class="line-removed">404         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">405             fail(SubSystem.CPUACCT, &quot;cpu.stat - throttled_time&quot;, oldVal, newVal);</span>
<span class="line-removed">406         }</span>
<span class="line-removed">407     }</span>
<span class="line-removed">408 </span>
<span class="line-removed">409     public void testCpuSets() {</span>
<span class="line-removed">410         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">411         Integer[] oldVal = Arrays.stream(metrics.getCpuSetCpus()).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">412         Arrays.sort(oldVal);</span>
<span class="line-removed">413 </span>
<span class="line-removed">414         String cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.cpus&quot;);</span>
<span class="line-removed">415         // Parse range string in the format 1,2-6,7</span>
<span class="line-removed">416         Integer[] newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">417             if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">418                 String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">419                 return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">420                         Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">421             } else {</span>
<span class="line-removed">422                 return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">423             }</span>
<span class="line-removed">424         }).toArray(Integer[]::new);</span>
<span class="line-removed">425         Arrays.sort(newVal);</span>
<span class="line-removed">426         if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">427             fail(SubSystem.CPUSET, &quot;cpuset.cpus&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">428                 Arrays.toString(newVal));</span>
<span class="line-removed">429         }</span>
<span class="line-removed">430 </span>
<span class="line-removed">431         int [] cpuSets = metrics.getEffectiveCpuSetCpus();</span>
<span class="line-removed">432 </span>
<span class="line-removed">433         // Skip this test if this metric is supported on this platform</span>
<span class="line-removed">434         if (cpuSets.length != 0) {</span>
<span class="line-removed">435             oldVal = Arrays.stream(cpuSets).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">436             Arrays.sort(oldVal);</span>
<span class="line-removed">437             cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.effective_cpus&quot;);</span>
<span class="line-removed">438             newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">439                 if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">440                     String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">441                     return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">442                             Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">443                 } else {</span>
<span class="line-removed">444                     return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">445                 }</span>
<span class="line-removed">446             }).toArray(Integer[]::new);</span>
<span class="line-removed">447             Arrays.sort(newVal);</span>
<span class="line-removed">448             if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">449                 fail(SubSystem.CPUSET, &quot;cpuset.effective_cpus&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">450                         Arrays.toString(newVal));</span>
<span class="line-removed">451             }</span>
<span class="line-removed">452         }</span>
<span class="line-removed">453 </span>
<span class="line-removed">454         oldVal = Arrays.stream(metrics.getCpuSetMems()).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">455         Arrays.sort(oldVal);</span>
<span class="line-removed">456         cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.mems&quot;);</span>
<span class="line-removed">457         newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">458             if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">459                 String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">460                 return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">461                         Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">462             } else {</span>
<span class="line-removed">463                 return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">464             }</span>
<span class="line-removed">465         }).toArray(Integer[]::new);</span>
<span class="line-removed">466         Arrays.sort(newVal);</span>
<span class="line-removed">467         if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">468             fail(SubSystem.CPUSET, &quot;cpuset.mems&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">469                     Arrays.toString(newVal));</span>
<span class="line-removed">470         }</span>
<span class="line-removed">471 </span>
<span class="line-removed">472         int [] cpuSetMems = metrics.getEffectiveCpuSetMems();</span>
<span class="line-removed">473 </span>
<span class="line-removed">474         // Skip this test if this metric is supported on this platform</span>
<span class="line-removed">475         if (cpuSetMems.length != 0) {</span>
<span class="line-removed">476             oldVal = Arrays.stream(cpuSetMems).boxed().toArray(Integer[]::new);</span>
<span class="line-removed">477             Arrays.sort(oldVal);</span>
<span class="line-removed">478             cpusstr = getFileContents(SubSystem.CPUSET, &quot;cpuset.effective_mems&quot;);</span>
<span class="line-removed">479             newVal = Stream.of(cpusstr.split(&quot;,&quot;)).flatMap(a -&gt; {</span>
<span class="line-removed">480                 if (a.contains(&quot;-&quot;)) {</span>
<span class="line-removed">481                     String[] range = a.split(&quot;-&quot;);</span>
<span class="line-removed">482                     return IntStream.rangeClosed(Integer.parseInt(range[0]),</span>
<span class="line-removed">483                             Integer.parseInt(range[1])).boxed();</span>
<span class="line-removed">484                 } else {</span>
<span class="line-removed">485                     return Stream.of(Integer.parseInt(a));</span>
<span class="line-removed">486                 }</span>
<span class="line-removed">487             }).toArray(Integer[]::new);</span>
<span class="line-removed">488             Arrays.sort(newVal);</span>
<span class="line-removed">489             if (Arrays.compare(oldVal, newVal) != 0) {</span>
<span class="line-removed">490                 fail(SubSystem.CPUSET, &quot;cpuset.effective_mems&quot;, Arrays.toString(oldVal),</span>
<span class="line-removed">491                         Arrays.toString(newVal));</span>
<span class="line-removed">492             }</span>
<span class="line-removed">493         }</span>
<span class="line-removed">494 </span>
<span class="line-removed">495         double oldValue = metrics.getCpuSetMemoryPressure();</span>
<span class="line-removed">496         double newValue = getDoubleValueFromFile(SubSystem.CPUSET, &quot;cpuset.memory_pressure&quot;);</span>
<span class="line-removed">497         if (!compareWithErrorMargin(oldValue, newValue)) {</span>
<span class="line-removed">498             fail(SubSystem.CPUSET, &quot;cpuset.memory_pressure&quot;, oldValue, newValue);</span>
<span class="line-removed">499         }</span>
<span class="line-removed">500 </span>
<span class="line-removed">501         boolean oldV = metrics.isCpuSetMemoryPressureEnabled();</span>
<span class="line-removed">502         boolean newV = getLongValueFromFile(SubSystem.CPUSET,</span>
<span class="line-removed">503                 &quot;cpuset.memory_pressure_enabled&quot;) == 1 ? true : false;</span>
<span class="line-removed">504         if (oldV != newV) {</span>
<span class="line-removed">505             fail(SubSystem.CPUSET, &quot;cpuset.memory_pressure_enabled&quot;, oldV, newV);</span>
<span class="line-removed">506         }</span>
<span class="line-removed">507     }</span>
<span class="line-removed">508 </span>
<span class="line-removed">509     public void testBlkIO() {</span>
<span class="line-removed">510         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">511             long oldVal = metrics.getBlkIOServiceCount();</span>
<span class="line-removed">512         long newVal = getLongValueFromFile(SubSystem.BLKIO,</span>
<span class="line-removed">513                 &quot;blkio.throttle.io_service_bytes&quot;, &quot;Total&quot;);</span>
<span class="line-removed">514         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">515             fail(SubSystem.BLKIO, &quot;blkio.throttle.io_service_bytes - Total&quot;,</span>
<span class="line-removed">516                     oldVal, newVal);</span>
<span class="line-removed">517         }</span>
<span class="line-removed">518 </span>
<span class="line-removed">519         oldVal = metrics.getBlkIOServiced();</span>
<span class="line-removed">520         newVal = getLongValueFromFile(SubSystem.BLKIO, &quot;blkio.throttle.io_serviced&quot;, &quot;Total&quot;);</span>
<span class="line-removed">521         if (!compareWithErrorMargin(oldVal, newVal)) {</span>
<span class="line-removed">522             fail(SubSystem.BLKIO, &quot;blkio.throttle.io_serviced - Total&quot;, oldVal, newVal);</span>
<span class="line-removed">523         }</span>
<span class="line-removed">524     }</span>
<span class="line-removed">525 </span>
<span class="line-removed">526     public void testCpuConsumption() throws IOException, InterruptedException {</span>
<span class="line-removed">527         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">528         // make system call</span>
<span class="line-removed">529         long newSysVal = metrics.getCpuSystemUsage();</span>
<span class="line-removed">530         long newUserVal = metrics.getCpuUserUsage();</span>
<span class="line-removed">531         long newUsage = metrics.getCpuUsage();</span>
<span class="line-removed">532         long[] newPerCpu = metrics.getPerCpuUsage();</span>
<span class="line-removed">533 </span>
<span class="line-removed">534         if (newSysVal &lt;= startSysVal) {</span>
<span class="line-removed">535             fail(SubSystem.CPU, &quot;getCpuSystemUsage&quot;, newSysVal, startSysVal);</span>
<span class="line-removed">536         }</span>
<span class="line-removed">537 </span>
<span class="line-removed">538         if (newUserVal &lt;= startUserVal) {</span>
<span class="line-removed">539             fail(SubSystem.CPU, &quot;getCpuUserUsage&quot;, newUserVal, startUserVal);</span>
<span class="line-removed">540         }</span>
<span class="line-removed">541 </span>
<span class="line-removed">542         if (newUsage &lt;= startUsage) {</span>
<span class="line-removed">543             fail(SubSystem.CPU, &quot;getCpuUserUsage&quot;, newUsage, startUsage);</span>
<span class="line-removed">544         }</span>
<span class="line-removed">545 </span>
<span class="line-removed">546         boolean success = false;</span>
<span class="line-removed">547         for (int i = 0; i &lt; startPerCpu.length; i++) {</span>
<span class="line-removed">548             if (newPerCpu[i] &gt; startPerCpu[i]) {</span>
<span class="line-removed">549                 success = true;</span>
<span class="line-removed">550                 break;</span>
<span class="line-removed">551             }</span>
<span class="line-removed">552         }</span>
<span class="line-removed">553 </span>
<span class="line-removed">554         if(!success) fail(SubSystem.CPU, &quot;getPerCpuUsage&quot;, Arrays.toString(newPerCpu),</span>
<span class="line-removed">555                 Arrays.toString(startPerCpu));</span>
<span class="line-removed">556     }</span>
<span class="line-removed">557 </span>
<span class="line-removed">558     public void testMemoryUsage() throws Exception {</span>
<span class="line-removed">559         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">560         long memoryMaxUsage = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">561         long memoryUsage = metrics.getMemoryUsage();</span>
<span class="line-removed">562 </span>
<span class="line-removed">563         long[] ll = new long[64*1024*1024]; // 64M</span>
<span class="line-removed">564 </span>
<span class="line-removed">565         long newMemoryMaxUsage = metrics.getMemoryMaxUsage();</span>
<span class="line-removed">566         long newMemoryUsage = metrics.getMemoryUsage();</span>
<span class="line-removed">567 </span>
<span class="line-removed">568         if(newMemoryMaxUsage &lt; memoryMaxUsage) {</span>
<span class="line-removed">569             fail(SubSystem.MEMORY, &quot;getMemoryMaxUsage&quot;, newMemoryMaxUsage,</span>
<span class="line-removed">570                     memoryMaxUsage);</span>
<span class="line-removed">571         }</span>
<span class="line-removed">572 </span>
<span class="line-removed">573         if(newMemoryUsage &lt; memoryUsage) {</span>
<span class="line-removed">574             fail(SubSystem.MEMORY, &quot;getMemoryUsage&quot;, newMemoryUsage, memoryUsage);</span>
<span class="line-removed">575         }</span>
576     }
577 
578     public static void main(String[] args) throws Exception {
<a name="8" id="anc8"></a>
579         // If cgroups is not configured, report success
<a name="9" id="anc9"></a><span class="line-modified">580         Metrics metrics = Metrics.systemMetrics();</span>
<span class="line-removed">581         if (metrics == null) {</span>
582             System.out.println(&quot;TEST PASSED!!!&quot;);
583             return;
584         }
585 
586         MetricsTester metricsTester = new MetricsTester();
<a name="10" id="anc10"></a><span class="line-modified">587         metricsTester.setup();</span>
<span class="line-removed">588         metricsTester.testCpuAccounting();</span>
<span class="line-removed">589         metricsTester.testCpuSchedulingMetrics();</span>
<span class="line-removed">590         metricsTester.testCpuSets();</span>
<span class="line-removed">591         metricsTester.testMemorySubsystem();</span>
<span class="line-removed">592         metricsTester.testBlkIO();</span>
<span class="line-removed">593         metricsTester.testCpuConsumption();</span>
<span class="line-removed">594         metricsTester.testMemoryUsage();</span>
595         System.out.println(&quot;TEST PASSED!!!&quot;);
596     }
597 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>