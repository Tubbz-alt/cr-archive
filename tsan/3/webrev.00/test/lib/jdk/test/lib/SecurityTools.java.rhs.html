<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/lib/jdk/test/lib/SecurityTools.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib;
 25 
 26 import java.io.File;
 27 import java.io.IOException;
 28 import java.nio.file.Files;
 29 import java.nio.file.Path;
 30 import java.nio.file.Paths;
<a name="1" id="anc1"></a><span class="line-added"> 31 import java.util.ArrayList;</span>
 32 import java.util.List;
 33 import java.util.stream.Collectors;
 34 import java.util.stream.Stream;
 35 
 36 import jdk.test.lib.process.OutputAnalyzer;
 37 import jdk.test.lib.process.ProcessTools;
 38 
 39 /**
 40  * Run security tools (including jarsigner and keytool) in a new process.
 41  * The en_US locale is always used so a test can always match output to
 42  * English text. {@code /dev/urandom} is used as entropy source so tool will
 43  * not block because of entropy scarcity. {@code -Jvm-options} is supported
 44  * as an argument.
 45  */
 46 public class SecurityTools {
 47 
 48     /**
 49      * The response file name for keytool. Use {@link #setResponse} to
 50      * create one. Do NOT manipulate it directly.
 51      */
 52     public static final String RESPONSE_FILE = &quot;security_tools_response.txt&quot;;
 53 
 54     private SecurityTools() {}
 55 
<a name="2" id="anc2"></a><span class="line-modified"> 56     public static ProcessBuilder getProcessBuilder(String tool, List&lt;String&gt; args) {</span>
 57         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(tool)
 58                 .addVMArg(&quot;-Duser.language=en&quot;)
 59                 .addVMArg(&quot;-Duser.country=US&quot;);
 60         if (!Platform.isWindows()) {
 61             launcher.addVMArg(&quot;-Djava.security.egd=file:/dev/./urandom&quot;);
 62         }
 63         for (String arg : args) {
 64             if (arg.startsWith(&quot;-J&quot;)) {
 65                 launcher.addVMArg(arg.substring(2));
<a name="3" id="anc3"></a><span class="line-added"> 66             } else if (Platform.isWindows() &amp;&amp; arg.isEmpty()) {</span>
<span class="line-added"> 67                 // JDK-6518827: special handling for empty argument on Windows</span>
<span class="line-added"> 68                 launcher.addToolArg(&quot;\&quot;\&quot;&quot;);</span>
 69             } else {
 70                 launcher.addToolArg(arg);
 71             }
 72         }
 73         return new ProcessBuilder(launcher.getCommand());
 74     }
 75 
 76     /**
 77      * Runs keytool.
 78      *
 79      * @param args arguments to keytool
 80      * @return an {@link OutputAnalyzer} object
 81      * @throws Exception if there is an error
 82      */
 83     public static OutputAnalyzer keytool(List&lt;String&gt; args)
 84             throws Exception {
 85 
 86         ProcessBuilder pb = getProcessBuilder(&quot;keytool&quot;, args);
 87 
 88         Path p = Paths.get(RESPONSE_FILE);
 89         if (!Files.exists(p)) {
 90             Files.createFile(p);
 91         }
 92         pb.redirectInput(ProcessBuilder.Redirect.from(new File(RESPONSE_FILE)));
 93 
 94         try {
 95             return execute(pb);
 96         } finally {
 97             Files.delete(p);
 98         }
 99     }
100 
101     /**
102      * Runs keytool.
103      *
<a name="4" id="anc4"></a><span class="line-modified">104      * @param args arguments to keytool in a single string. The string is</span>
<span class="line-modified">105      *             converted to be List with makeList.</span>

106      * @return an {@link OutputAnalyzer} object
107      * @throws Exception if there is an error
108      */
109     public static OutputAnalyzer keytool(String args) throws Exception {
<a name="5" id="anc5"></a><span class="line-modified">110         return keytool(makeList(args));</span>
111     }
112 
113     /**
114      * Runs keytool.
115      *
116      * @param args arguments to keytool
117      * @return an {@link OutputAnalyzer} object
118      * @throws Exception if there is an error
119      */
120     public static OutputAnalyzer keytool(String... args) throws Exception {
121         return keytool(List.of(args));
122     }
123 
124 
125     /**
126      * Sets the responses (user input) for keytool.
127      * &lt;p&gt;
128      * For example, if keytool requires entering a password twice, call
129      * {@code setResponse(&quot;password&quot;, &quot;password&quot;)}. Do NOT append a newline
130      * character to each response. If there are useless responses at the end,
131      * they will be discarded silently. If there are less responses than
132      * necessary, keytool will read EOF. The responses will be written into
133      * {@linkplain #RESPONSE_FILE a local file} and will only be used by the
134      * next keytool run. After the run, the file is removed. Calling this
135      * method will always overwrite the previous response file (if exists).
136      *
137      * @param responses response to keytool
138      * @throws IOException if there is an error
139      */
140     public static void setResponse(String... responses) throws IOException {
141         String text;
142         if (responses.length &gt; 0) {
143             text = Stream.of(responses).collect(
144                     Collectors.joining(&quot;\n&quot;, &quot;&quot;, &quot;\n&quot;));
145         } else {
146             text = &quot;&quot;;
147         }
148         Files.write(Paths.get(RESPONSE_FILE), text.getBytes());
149     }
150 
151     /**
152      * Runs jarsigner.
153      *
154      * @param args arguments to jarsigner
155      * @return an {@link OutputAnalyzer} object
156      * @throws Exception if there is an error
157      */
158     public static OutputAnalyzer jarsigner(List&lt;String&gt; args)
159             throws Exception {
160         return execute(getProcessBuilder(&quot;jarsigner&quot;, args));
161     }
162 
163     private static OutputAnalyzer execute(ProcessBuilder pb) throws Exception {
164         try {
165             OutputAnalyzer oa = ProcessTools.executeCommand(pb);
166             System.out.println(&quot;Exit value: &quot; + oa.getExitValue());
167             return oa;
168         } catch (Throwable t) {
169             if (t instanceof Exception) {
170                 throw (Exception) t;
171             } else {
172                 throw new Exception(t);
173             }
174         }
175     }
176 
177     /**
178      * Runs jarsigner.
179      *
<a name="6" id="anc6"></a><span class="line-modified">180      * @param args arguments to jarsigner in a single string. The string is</span>
<span class="line-modified">181      *             converted to be List with makeList.</span>

182      * @return an {@link OutputAnalyzer} object
183      * @throws Exception if there is an error
184      */
185     public static OutputAnalyzer jarsigner(String args) throws Exception {
186 
<a name="7" id="anc7"></a><span class="line-modified">187         return jarsigner(makeList(args));</span>
188     }
189 
190     /**
191      * Runs jarsigner.
192      *
193      * @param args arguments to jarsigner
194      * @return an {@link OutputAnalyzer} object
195      * @throws Exception if there is an error
196      */
197     public static OutputAnalyzer jarsigner(String... args) throws Exception {
198         return jarsigner(List.of(args));
199     }
200 
201     /**
202      * Runs ktab.
203      *
<a name="8" id="anc8"></a><span class="line-modified">204      * @param args arguments to ktab in a single string. The string is</span>
<span class="line-modified">205      *             converted to be List with makeList.</span>

206      * @return an {@link OutputAnalyzer} object
207      * @throws Exception if there is an error
208      */
209     public static OutputAnalyzer ktab(String args) throws Exception {
<a name="9" id="anc9"></a><span class="line-modified">210         return execute(getProcessBuilder(&quot;ktab&quot;, makeList(args)));</span>

211     }
212 
213     /**
214      * Runs klist.
215      *
<a name="10" id="anc10"></a><span class="line-modified">216      * @param args arguments to klist in a single string. The string is</span>
<span class="line-modified">217      *             converted to be List with makeList.</span>

218      * @return an {@link OutputAnalyzer} object
219      * @throws Exception if there is an error
220      */
221     public static OutputAnalyzer klist(String args) throws Exception {
<a name="11" id="anc11"></a><span class="line-modified">222         return execute(getProcessBuilder(&quot;klist&quot;, makeList(args)));</span>
<span class="line-modified">223     }</span>
<span class="line-added">224 </span>
<span class="line-added">225     /**</span>
<span class="line-added">226      * Runs jar.</span>
<span class="line-added">227      *</span>
<span class="line-added">228      * @param args arguments to jar in a single string. The string is</span>
<span class="line-added">229      *             converted to be List with makeList.</span>
<span class="line-added">230      * @return an {@link OutputAnalyzer} object</span>
<span class="line-added">231      * @throws Exception if there is an error</span>
<span class="line-added">232      */</span>
<span class="line-added">233     public static OutputAnalyzer jar(String args) throws Exception {</span>
<span class="line-added">234         return execute(getProcessBuilder(&quot;jar&quot;, makeList(args)));</span>
<span class="line-added">235     }</span>
<span class="line-added">236 </span>
<span class="line-added">237     /**</span>
<span class="line-added">238      * Split a line to a list of string. All whitespaces are treated as</span>
<span class="line-added">239      * delimiters unless quoted between ` and `.</span>
<span class="line-added">240      *</span>
<span class="line-added">241      * @param line the input</span>
<span class="line-added">242      * @return the list</span>
<span class="line-added">243      */</span>
<span class="line-added">244     public static List&lt;String&gt; makeList(String line) {</span>
<span class="line-added">245         List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="line-added">246         StringBuilder sb = new StringBuilder();</span>
<span class="line-added">247         boolean inBackTick = false;</span>
<span class="line-added">248         for (char c : line.toCharArray()) {</span>
<span class="line-added">249             if (inBackTick) {</span>
<span class="line-added">250                 if (c == &#39;`&#39;) {</span>
<span class="line-added">251                     result.add(sb.toString());</span>
<span class="line-added">252                     sb.setLength(0);</span>
<span class="line-added">253                     inBackTick = false;</span>
<span class="line-added">254                 } else {</span>
<span class="line-added">255                     sb.append(c);</span>
<span class="line-added">256                 }</span>
<span class="line-added">257             } else {</span>
<span class="line-added">258                 if (sb.length() == 0 &amp;&amp; c == &#39;`&#39;) {</span>
<span class="line-added">259                     // Allow ` inside a string</span>
<span class="line-added">260                     inBackTick = true;</span>
<span class="line-added">261                 } else {</span>
<span class="line-added">262                     if (Character.isWhitespace(c)) {</span>
<span class="line-added">263                         if (sb.length() != 0) {</span>
<span class="line-added">264                             result.add(sb.toString());</span>
<span class="line-added">265                             sb.setLength(0);</span>
<span class="line-added">266                         }</span>
<span class="line-added">267                     } else {</span>
<span class="line-added">268                         sb.append(c);</span>
<span class="line-added">269                     }</span>
<span class="line-added">270                 }</span>
<span class="line-added">271             }</span>
<span class="line-added">272         }</span>
<span class="line-added">273         if (sb.length() != 0) {</span>
<span class="line-added">274             result.add(sb.toString());</span>
<span class="line-added">275         }</span>
<span class="line-added">276         return result;</span>
277     }
278 }
279 
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>