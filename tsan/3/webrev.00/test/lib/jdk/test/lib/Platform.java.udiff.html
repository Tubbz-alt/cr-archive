<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/Platform.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="NetworkConfiguration.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SA/SATestUtils.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/Platform.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,12 +22,16 @@</span>
   */
  
  package jdk.test.lib;
  
  import java.io.File;
<span class="udiff-line-added">+ import java.io.FileNotFoundException;</span>
  import java.io.IOException;
  import java.io.RandomAccessFile;
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-added">+ import java.nio.file.Paths;</span>
<span class="udiff-line-added">+ import java.util.concurrent.TimeUnit;</span>
  import java.util.regex.Pattern;
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.security.PrivilegedActionException;
  import java.security.PrivilegedExceptionAction;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,10 +47,11 @@</span>
      private static final String vmVersion   = privilegedGetProperty(&quot;java.vm.version&quot;);
      private static final String jdkDebug    = privilegedGetProperty(&quot;jdk.debug&quot;);
      private static final String osArch      = privilegedGetProperty(&quot;os.arch&quot;);
      private static final String userName    = privilegedGetProperty(&quot;user.name&quot;);
      private static final String compiler    = privilegedGetProperty(&quot;sun.management.compiler&quot;);
<span class="udiff-line-added">+     private static final String testJdk     = privilegedGetProperty(&quot;test.jdk&quot;);</span>
  
      private static String privilegedGetProperty(String key) {
          return AccessController.doPrivileged((
                  PrivilegedAction&lt;String&gt;) () -&gt; System.getProperty(key));
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -57,14 +62,10 @@</span>
  
      public static boolean isServer() {
          return vmName.endsWith(&quot; Server VM&quot;);
      }
  
<span class="udiff-line-removed">-     public static boolean isGraal() {</span>
<span class="udiff-line-removed">-         return vmName.endsWith(&quot; Graal VM&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      public static boolean isZero() {
          return vmName.endsWith(&quot; Zero VM&quot;);
      }
  
      public static boolean isMinimal() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,21 +231,74 @@</span>
          }
          // Other platforms expected to work:
          return true;
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Return true if the test JDK is signed, otherwise false. Only valid on OSX.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static boolean isSignedOSX() throws IOException {</span>
<span class="udiff-line-added">+         // We only care about signed binaries for 10.14 and later (actually 10.14.5, but</span>
<span class="udiff-line-added">+         // for simplicity we&#39;ll also include earlier 10.14 versions).</span>
<span class="udiff-line-added">+         if (getOsVersionMajor() == 10 &amp;&amp; getOsVersionMinor() &lt; 14) {</span>
<span class="udiff-line-added">+             return false; // assume not signed</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Find the path to the java binary.</span>
<span class="udiff-line-added">+         String jdkPath = System.getProperty(&quot;java.home&quot;);</span>
<span class="udiff-line-added">+         Path javaPath = Paths.get(jdkPath + &quot;/bin/java&quot;);</span>
<span class="udiff-line-added">+         String javaFileName = javaPath.toAbsolutePath().toString();</span>
<span class="udiff-line-added">+         if (!javaPath.toFile().exists()) {</span>
<span class="udiff-line-added">+             throw new FileNotFoundException(&quot;Could not find file &quot; + javaFileName);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Run codesign on the java binary.</span>
<span class="udiff-line-added">+         ProcessBuilder pb = new ProcessBuilder(&quot;codesign&quot;, &quot;-d&quot;, &quot;-v&quot;, javaFileName);</span>
<span class="udiff-line-added">+         pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-added">+         pb.redirectOutput(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-added">+         Process codesignProcess = pb.start();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             if (codesignProcess.waitFor(10, TimeUnit.SECONDS) == false) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;Timed out waiting for the codesign process to complete. Assuming not signed.&quot;);</span>
<span class="udiff-line-added">+                 codesignProcess.destroyForcibly();</span>
<span class="udiff-line-added">+                 return false; // assume not signed</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Check codesign result to see if java binary is signed. Here are the</span>
<span class="udiff-line-added">+         // exit code meanings:</span>
<span class="udiff-line-added">+         //    0: signed</span>
<span class="udiff-line-added">+         //    1: not signed</span>
<span class="udiff-line-added">+         //    2: invalid arguments</span>
<span class="udiff-line-added">+         //    3: only has meaning with the -R argument.</span>
<span class="udiff-line-added">+         // So we should always get 0 or 1 as an exit value.</span>
<span class="udiff-line-added">+         if (codesignProcess.exitValue() == 0) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Target JDK is signed. Some tests may be skipped.&quot;);</span>
<span class="udiff-line-added">+             return true; // signed</span>
<span class="udiff-line-added">+         } else if (codesignProcess.exitValue() == 1) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Target JDK is not signed.&quot;);</span>
<span class="udiff-line-added">+             return false; // not signed</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             System.err.println(&quot;Executing codesign failed. Assuming unsigned: &quot; +</span>
<span class="udiff-line-added">+                                codesignProcess.exitValue());</span>
<span class="udiff-line-added">+             return false; // not signed</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Return a boolean for whether we expect to be able to attach
       * the SA to our own processes on this system.  This requires
       * that SA is ported/available on this platform.
       */
      public static boolean shouldSAAttach() throws IOException {
          if (!hasSA()) return false;
          if (isLinux()) {
              return canPtraceAttachLinux();
          } else if (isOSX()) {
<span class="udiff-line-modified-removed">-             return canAttachOSX();</span>
<span class="udiff-line-modified-added">+             return canAttachOSX() &amp;&amp; !isSignedOSX();</span>
          } else {
              // Other platforms expected to work:
              return true;
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -263,11 +317,10 @@</span>
                      (PrivilegedExceptionAction&lt;RandomAccessFile&gt;) () -&gt; new RandomAccessFile(deny_ptrace, &quot;r&quot;))) {
                  if (file.readByte() != &#39;0&#39;) {
                      return false;
                  }
              } catch (PrivilegedActionException e) {
<span class="udiff-line-removed">-                 @SuppressWarnings(&quot;unchecked&quot;)</span>
                  IOException t = (IOException) e.getException();
                  throw t;
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -287,11 +340,10 @@</span>
  
                  if (!userName.equals(&quot;root&quot;) &amp;&amp; yama_scope != &#39;0&#39;) {
                      return false;
                  }
              } catch (PrivilegedActionException e) {
<span class="udiff-line-removed">-                 @SuppressWarnings(&quot;unchecked&quot;)</span>
                  IOException t = (IOException) e.getException();
                  throw t;
              }
          }
          // Otherwise expect to be permitted:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -338,10 +390,39 @@</span>
          } else {
              return &quot;LD_LIBRARY_PATH&quot;;
          }
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Returns absolute path to directory containing JVM shared library.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static Path jvmLibDir() {</span>
<span class="udiff-line-added">+         Path dir = Paths.get(testJdk);</span>
<span class="udiff-line-added">+         if (Platform.isWindows()) {</span>
<span class="udiff-line-added">+             return dir.resolve(&quot;bin&quot;)</span>
<span class="udiff-line-added">+                 .resolve(variant())</span>
<span class="udiff-line-added">+                 .toAbsolutePath();</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return dir.resolve(&quot;lib&quot;)</span>
<span class="udiff-line-added">+                 .resolve(variant())</span>
<span class="udiff-line-added">+                 .toAbsolutePath();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static String variant() {</span>
<span class="udiff-line-added">+         if (Platform.isServer()) {</span>
<span class="udiff-line-added">+             return &quot;server&quot;;</span>
<span class="udiff-line-added">+         } else if (Platform.isClient()) {</span>
<span class="udiff-line-added">+             return &quot;client&quot;;</span>
<span class="udiff-line-added">+         } else if (Platform.isMinimal()) {</span>
<span class="udiff-line-added">+             return &quot;minimal&quot;;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             throw new Error(&quot;TESTBUG: unsupported vm variant&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
      public static boolean isDefaultCDSArchiveSupported() {
          return (is64bit()  &amp;&amp;
                  isServer() &amp;&amp;
                  (isLinux()   ||
                   isOSX()     ||
</pre>
<center><a href="NetworkConfiguration.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SA/SATestUtils.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>