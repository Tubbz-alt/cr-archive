<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/lib/ClassFileInstaller.java</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="../lib-test/jdk/test/lib/apps/LingeredAppTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="RedefineClassHelper.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/ClassFileInstaller.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 30,10 ***</span>
<span class="line-new-header">--- 30,11 ---</span>
  import java.io.ByteArrayInputStream;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.nio.file.StandardCopyOption;
<span class="line-added">+ import java.util.ArrayList;</span>
  import java.util.zip.ZipEntry;
  import java.util.zip.ZipOutputStream;
  
  /**
   * Dump a class file for a class on the class path in the current directory, or
</pre>
<hr />
<pre>
<span class="line-old-header">*** 82,21 ***</span>
              if (args.length &lt; 2) {
                  throw new RuntimeException(&quot;Usage: ClassFileInstaller &lt;options&gt; &lt;classes&gt;\n&quot; +
                                             &quot;where possible options include:\n&quot; +
                                             &quot;  -jar &lt;path&gt;             Write to the JAR file &lt;path&gt;&quot;);
              }
<span class="line-modified">!             writeJar(args[1], null, args, 2, args.length);</span>
          } else {
              if (DEBUG) {
                  System.out.println(&quot;ClassFileInstaller: Writing to &quot; + System.getProperty(&quot;user.dir&quot;));
              }
<span class="line-modified">!             for (String arg : args) {</span>
<span class="line-modified">!                 writeClassToDisk(arg);</span>
              }
          }
      }
  
      public static class Manifest {
          private InputStream in;
  
          private Manifest(InputStream in) {
              this.in = in;
<span class="line-new-header">--- 83,51 ---</span>
              if (args.length &lt; 2) {
                  throw new RuntimeException(&quot;Usage: ClassFileInstaller &lt;options&gt; &lt;classes&gt;\n&quot; +
                                             &quot;where possible options include:\n&quot; +
                                             &quot;  -jar &lt;path&gt;             Write to the JAR file &lt;path&gt;&quot;);
              }
<span class="line-modified">!             String jarFile = args[1];</span>
<span class="line-added">+             String[] classes = addInnerClasses(args, 2);</span>
<span class="line-added">+             writeJar_impl(jarFile, null, classes);</span>
          } else {
              if (DEBUG) {
                  System.out.println(&quot;ClassFileInstaller: Writing to &quot; + System.getProperty(&quot;user.dir&quot;));
              }
<span class="line-modified">!             String[] classes = addInnerClasses(args, 0);</span>
<span class="line-modified">!             for (String cls : classes) {</span>
<span class="line-added">+                 writeClassToDisk(cls);</span>
              }
          }
      }
  
<span class="line-added">+     // Add commonly used inner classes that are often omitted by mistake. Currently</span>
<span class="line-added">+     // we support only sun.hotspot.WhiteBox$WhiteBoxPermission. See JDK-8199290</span>
<span class="line-added">+     private static String[] addInnerClasses(String[] classes, int startIdx) {</span>
<span class="line-added">+         boolean seenWB = false;</span>
<span class="line-added">+         boolean seenWBInner = false;</span>
<span class="line-added">+         final String wb = &quot;sun.hotspot.WhiteBox&quot;;</span>
<span class="line-added">+         final String wbInner = &quot;sun.hotspot.WhiteBox$WhiteBoxPermission&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+         ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="line-added">+ </span>
<span class="line-added">+         for (int i = startIdx; i &lt; classes.length; i++) {</span>
<span class="line-added">+             String cls = classes[i];</span>
<span class="line-added">+             list.add(cls);</span>
<span class="line-added">+             switch (cls) {</span>
<span class="line-added">+             case wb:      seenWB      = true; break;</span>
<span class="line-added">+             case wbInner: seenWBInner = true; break;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (seenWB &amp;&amp; !seenWBInner) {</span>
<span class="line-added">+             list.add(wbInner);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         String[] array = new String[list.size()];</span>
<span class="line-added">+         list.toArray(array);</span>
<span class="line-added">+         return array;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public static class Manifest {
          private InputStream in;
  
          private Manifest(InputStream in) {
              this.in = in;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,11 ***</span>
          public InputStream getInputStream() {
              return in;
          }
      }
  
<span class="line-modified">!     private static void writeJar(String jarFile, Manifest manifest, String classes[], int from, int to) throws Exception {</span>
          if (DEBUG) {
              System.out.println(&quot;ClassFileInstaller: Writing to &quot; + getJarPath(jarFile));
          }
  
          (new File(jarFile)).delete();
<span class="line-new-header">--- 151,11 ---</span>
          public InputStream getInputStream() {
              return in;
          }
      }
  
<span class="line-modified">!     private static void writeJar_impl(String jarFile, Manifest manifest, String classes[]) throws Exception {</span>
          if (DEBUG) {
              System.out.println(&quot;ClassFileInstaller: Writing to &quot; + getJarPath(jarFile));
          }
  
          (new File(jarFile)).delete();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 135,12 ***</span>
          // constructor and JDK-5046178.
          if (manifest != null) {
              writeToDisk(zos, &quot;META-INF/MANIFEST.MF&quot;, manifest.getInputStream());
          }
  
<span class="line-modified">!         for (int i=from; i&lt;to; i++) {</span>
<span class="line-modified">!             writeClassToDisk(zos, classes[i]);</span>
          }
  
          zos.close();
          fos.close();
      }
<span class="line-new-header">--- 166,12 ---</span>
          // constructor and JDK-5046178.
          if (manifest != null) {
              writeToDisk(zos, &quot;META-INF/MANIFEST.MF&quot;, manifest.getInputStream());
          }
  
<span class="line-modified">!         for (String cls : classes) {</span>
<span class="line-modified">!             writeClassToDisk(zos, cls);</span>
          }
  
          zos.close();
          fos.close();
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 155,16 ***</span>
       *
       * @library testlibrary
       * @build ClassFileInstaller
       */
      public static String writeJar(String jarFile, String... classes) throws Exception {
<span class="line-modified">!         writeJar(jarFile, null, classes, 0, classes.length);</span>
          return getJarPath(jarFile);
      }
  
      public static String writeJar(String jarFile, Manifest manifest, String... classes) throws Exception {
<span class="line-modified">!         writeJar(jarFile, manifest, classes, 0, classes.length);</span>
          return getJarPath(jarFile);
      }
  
      /**
       * This returns the absolute path to the file specified in &quot;@ClassFileInstaller -jar myjar.jar&quot;,
<span class="line-new-header">--- 186,18 ---</span>
       *
       * @library testlibrary
       * @build ClassFileInstaller
       */
      public static String writeJar(String jarFile, String... classes) throws Exception {
<span class="line-modified">!         classes = addInnerClasses(classes, 0);</span>
<span class="line-added">+         writeJar_impl(jarFile, null, classes);</span>
          return getJarPath(jarFile);
      }
  
      public static String writeJar(String jarFile, Manifest manifest, String... classes) throws Exception {
<span class="line-modified">!         classes = addInnerClasses(classes, 0);</span>
<span class="line-added">+         writeJar_impl(jarFile, manifest, classes);</span>
          return getJarPath(jarFile);
      }
  
      /**
       * This returns the absolute path to the file specified in &quot;@ClassFileInstaller -jar myjar.jar&quot;,
</pre>
<center><a href="../lib-test/jdk/test/lib/apps/LingeredAppTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="RedefineClassHelper.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>