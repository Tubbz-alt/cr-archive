<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jaxp/javax/xml/jaxp/unittest/transform/ErrorListenerTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package transform;
 25 
 26 import java.io.ByteArrayInputStream;
 27 import java.io.ByteArrayOutputStream;
 28 import java.io.InputStream;
 29 import java.io.PrintStream;
 30 import java.io.StringReader;
 31 import java.io.StringWriter;
 32 import java.util.ArrayList;
 33 import java.util.List;
 34 
 35 import javax.xml.transform.ErrorListener;
 36 import javax.xml.transform.OutputKeys;
 37 import javax.xml.transform.Transformer;
 38 import javax.xml.transform.TransformerConfigurationException;
 39 import javax.xml.transform.TransformerException;
 40 import javax.xml.transform.TransformerFactory;
 41 import javax.xml.transform.sax.SAXSource;
 42 import javax.xml.transform.stream.StreamResult;
 43 import javax.xml.transform.stream.StreamSource;
 44 import org.testng.Assert;
 45 import org.testng.annotations.AfterClass;
 46 import org.testng.annotations.BeforeClass;
 47 import org.testng.annotations.DataProvider;
 48 import org.testng.annotations.Test;
 49 import org.xml.sax.InputSource;
 50 
 51 /*
 52  * @test
 53  * @bug 8157830 8228854
 54  * @library /javax/xml/jaxp/libs /javax/xml/jaxp/unittest
 55  * @run testng/othervm transform.ErrorListenerTest
 56  * @summary Verifies that ErrorListeners are handled properly
 57  */
 58 public class ErrorListenerTest {
 59     static final int SYSTEM_ERR = 1;
 60     static final int SYSTEM_OUT = 2;
 61     static final String ERR_STDERR = &quot;Msg sent to stderr&quot;;
 62     static final String ERR_STDOUT = &quot;Msg sent to stdout&quot;;
 63 
 64     static final private String INVALID_STYLESHEET = &quot;xxx&quot;;
 65     static final private String SYSTEM_ID = &quot;http://openjdk_java_net/xsl/dummy.xsl&quot;;
 66 
 67     final private String INCLUDE_NOT_EXIST = &quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot; +
 68         &quot;&lt;xsl:stylesheet xmlns:xsl=\&quot;http://www.w3.org/1999/XSL/Transform\&quot; version=\&quot;1.0\&quot;&gt;&quot; +
 69         &quot;    &lt;xsl:import href=\&quot;NOSUCHFILE.xsl\&quot;/&gt;&quot; +
 70         &quot;&lt;/xsl:stylesheet&gt;&quot;;
 71 
 72     final private String VAR_UNDEFINED = &quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;ISO-8859-1\&quot;?&gt;&quot; +
 73         &quot;&lt;xsl:stylesheet version=\&quot;1.0\&quot; xmlns:xsl=\&quot;http://www.w3.org/1999/XSL/Transform\&quot;&gt;&quot; +
 74         &quot;    &lt;xsl:template match=\&quot;/\&quot;&gt; &quot; +
 75         &quot;        &lt;test1&gt;&lt;xsl:apply-templates select=\&quot;$ids\&quot;/&gt;&lt;/test1&gt;&quot; +
 76         &quot;        &lt;test2&gt;&lt;xsl:apply-templates select=\&quot;$dummy//ids/id\&quot;/&gt;&lt;/test2&gt;&quot; +
 77         &quot;    &lt;/xsl:template&gt;&quot; +
 78         &quot;&lt;/xsl:stylesheet&gt;&quot;;
 79     final private String XSL_DOC_FUNCTION = &quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;ISO-8859-1\&quot;?&gt;&quot; +
 80         &quot;&lt;xsl:stylesheet version=\&quot;1.0\&quot; xmlns:xsl=\&quot;http://www.w3.org/1999/XSL/Transform\&quot;&gt;&quot; +
 81         &quot;    &lt;xsl:output method=\&quot;xml\&quot; indent=\&quot;yes\&quot;/&gt;&quot; +
 82         &quot;    &lt;xsl:variable name=\&quot;ids\&quot; select=\&quot;//ids//id\&quot;/&gt;&quot; +
 83         &quot;    &lt;xsl:variable name=\&quot;dummy\&quot; select=\&quot;document(&#39;NOSUCHFILE.xml&#39;)\&quot;/&gt;&quot; +
 84         &quot;    &lt;xsl:template match=\&quot;/\&quot;&gt; &quot; +
 85         &quot;        &lt;test1&gt;&lt;xsl:apply-templates select=\&quot;$ids\&quot;/&gt;&lt;/test1&gt;&quot; +
 86         &quot;        &lt;test2&gt;&lt;xsl:apply-templates select=\&quot;$dummy//ids/id\&quot;/&gt;&lt;/test2&gt;&quot; +
 87         &quot;    &lt;/xsl:template&gt;&quot; +
 88         &quot;    &lt;xsl:template match=\&quot;id\&quot;&gt;&quot; +
 89         &quot;        &lt;xsl:variable name=\&quot;entity\&quot; select=\&quot;id(@value)\&quot;/&gt; &quot; +
 90         &quot;        &lt;must-be-one&gt;&lt;xsl:value-of select=\&quot;count($entity)\&quot;/&gt;&lt;/must-be-one&gt;&quot; +
 91         &quot;    &lt;/xsl:template&gt;&quot; +
 92         &quot;&lt;/xsl:stylesheet&gt;&quot;;
 93     final private String XML_DOC_FUNCTION = &quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;ISO-8859-1\&quot; standalone=\&quot;no\&quot;?&gt;&quot; +
 94         &quot;&lt;organization2&gt;&quot; +
 95         &quot;    &lt;company id=\&quot;xca\&quot; count=\&quot;2\&quot;&gt;&quot; +
 96         &quot;        &lt;department id=\&quot;xda\&quot;/&gt;&quot; +
 97         &quot;    &lt;/company&gt;&quot; +
 98         &quot;    &lt;company id=\&quot;xcb\&quot; count=\&quot;0\&quot;/&gt;&quot; +
 99         &quot;    &lt;company id=\&quot;xcc\&quot; count=\&quot;5\&quot;/&gt;&quot; +
100         &quot;    &lt;ids&gt;&quot; +
101         &quot;        &lt;id value=\&quot;xca\&quot;/&gt;&quot; +
102         &quot;        &lt;id value=\&quot;xcb\&quot;/&gt;&quot; +
103         &quot;    &lt;/ids&gt;&quot; +
104         &quot;&lt;/organization2&gt;&quot;;
105 
106     PrintStream originalErr, originalOut;
107     List&lt;String&gt; testMsgs = new ArrayList&lt;&gt;();
108 
109     @BeforeClass
110     public void setUpClass() throws Exception {
111         // save the PrintStream
112         originalErr = System.err;
113         originalOut = System.out;
114     }
115 
116     @AfterClass
117     protected void tearDown() throws Exception {
118         // set back to the original
119         System.setErr(originalErr);
120         System.setOut(originalOut);
121         // print out test messages
122         testMsgs.stream().forEach((msg) -&gt; {
123             System.out.println(msg);
124         });
125     }
126 
127     /*
128        DataProvider: for ErrorListenner tests
129        Data: xsl, xml, setListener(true/false), output channel(stderr/stdout),
130              expected console output, expected listener output
131      */
132     @DataProvider(name = &quot;testCreatingTransformer&quot;)
133     public Object[][] getTransformer() {
134         return new Object[][]{
135             /*
136              * Verifies that the default implementation does not print out
137              * warnings and errors to stderr.
138              */
139             {INCLUDE_NOT_EXIST, false, &quot;&quot;},
140             {VAR_UNDEFINED, false, &quot;&quot;},
141             /*
142              * Verifies that the registered listener is used.
143              */
144             {INCLUDE_NOT_EXIST, true, &quot;NOSUCHFILE.xsl&quot;},
145             {VAR_UNDEFINED, true, &quot;&#39;ids&#39; is undefined&quot;},
146             /*
147              * The original test for JDK8157830
148              * Verifies that when an ErrorListener is registered, parser errors
149              * are passed onto the listener without other output.
150             */
151             {INVALID_STYLESHEET, true, &quot;Content is not allowed in prolog&quot;},
152         };
153     }
154     /*
155        DataProvider: for ErrorListenner tests
156        Data: xsl, xml, setListener(true/false), output channel(stderr/stdout),
157              expected console output, expected listener output
158      */
159     @DataProvider(name = &quot;testTransform&quot;)
160     public Object[][] getTransform() {
161         return new Object[][]{
162             /*
163              * Verifies that the default implementation does not print out
164              * warnings and errors to stderr.
165              */
166             {XSL_DOC_FUNCTION, XML_DOC_FUNCTION, false, &quot;&quot;},
167             /*
168              * Verifies that the default implementation does not print out
169              * warnings and errors to stderr.
170              */
171             {XSL_DOC_FUNCTION, XML_DOC_FUNCTION, true, &quot;NOSUCHFILE.xml&quot;}
172         };
173     }
174 
175     /*
176        DataProvider: for ErrorListenner tests
177        Data: xsl, xml, setListener(true/false), expected listener output
178      */
179     @DataProvider(name = &quot;testEncoding&quot;)
180     public Object[][] getData() {
181         return new Object[][]{
182             {&quot;&lt;foo&gt;&lt;bar&gt;&lt;/bar&gt;&lt;/foo&gt;&quot;, false, &quot;&quot;},
183             {&quot;&lt;foo&gt;&lt;bar&gt;&lt;/bar&gt;&lt;/foo&gt;&quot;, true, &quot;&#39;dummy&#39; is not supported&quot;}
184         };
185     }
186 
187     /**
188      * Verifies that ErrorListeners are properly set and propagated, or the
189      * default ErrorListener does not send messages to stderr/stdout.
190      *
191      * @param xsl the stylesheet
192      * @param setListener a flag indicating whether a listener should be set
193      * @param msgL the expected listener output
194      * @throws Exception if the test fails
195      */
196     @Test(dataProvider = &quot;testCreatingTransformer&quot;)
197     public void testTransformer(String xsl, boolean setListener, String msgL)
198             throws Exception {
199         ErrListener listener = setListener ? new ErrListener(&quot;test&quot;) : null;
200         String msgConsole = getTransformerErr(&quot;testTransformer&quot;, xsl, listener);
201         evalResult(listener, msgConsole, setListener, msgL);
202     }
203 
204     /**
205      * Verifies that ErrorListeners are properly set and propagated, or the
206      * default ErrorListener does not send messages to stderr/stdout.
207      *
208      * @param xsl the stylesheet
209      * @param xml the XML
210      * @param setListener a flag indicating whether a listener should be set
211      * @param msgL the expected listener output
212      * @throws Exception if the test fails
213      */
214     //@Test(dataProvider = &quot;testTransform&quot;)
215     public void testTransform(String xsl, String xml, boolean setListener, String msgL)
216             throws Exception {
217         ErrListener listener = setListener ? new ErrListener(&quot;test&quot;) : null;
218         Transformer t = getTransformer(&quot;testDocFunc&quot;, xsl, listener);
219         String msgConsole = transform(&quot;testDocFunc&quot;, xml, t);
220         evalResult(listener, msgConsole, setListener, msgL);
221     }
222 
223     /**
224      * Verifies that the default implementation does not print out warnings and
225      * errors to the console when an invalid encoding is set.
226      *
227      * @throws Exception if the test fails
228      */
229     //@Test(dataProvider = &quot;testEncoding&quot;)
230     public void testEncoding(String xml, boolean setListener, String msgL)
231             throws Exception {
232         ErrListener listener = setListener ? new ErrListener(&quot;test&quot;) : null;
233         Transformer t = TransformerFactory.newInstance().newTransformer();
234         if (setListener) {
235             t.setErrorListener(listener);
236         }
237         t.setOutputProperty(OutputKeys.ENCODING, &quot;dummy&quot;);
238         String msgConsole = transform(&quot;testEncoding&quot;, &quot;&lt;foo&gt;&lt;bar&gt;&lt;/bar&gt;&lt;/foo&gt;&quot;, t);
239         evalResult(listener, msgConsole, setListener, msgL);
240     }
241 
242     private void evalResult(ErrListener l, String m, boolean setListener, String msgL)
243             throws Exception{
244         Assert.assertTrue(!m.contains(ERR_STDERR), &quot;no output to stderr&quot;);
245         Assert.assertTrue(!m.contains(ERR_STDOUT), &quot;no output to stdout&quot;);
246         if (setListener) {
247             testMsgs.add(&quot;l.errMsg=&quot; + l.errMsg);
248             testMsgs.add(&quot;evalResult.msgL=&quot; + msgL);
249             Assert.assertTrue(l.errMsg.contains(msgL),
250                     &quot;The registered listener shall be used.&quot;);
251         }
252     }
253 
254     /**
255      * Obtains a Transformer.
256      *
257      * @param test the name of the test
258      * @param xsl the stylesheet
259      * @param setListener a flag indicating whether to set a listener
260      * @return the Transformer, null if error occurs
261      * @throws Exception
262      */
263     private Transformer getTransformer(String test, String xsl, ErrorListener listener)
264             throws Exception {
265         Transformer f = null;
266         InputSource source = new InputSource(new ByteArrayInputStream(xsl.getBytes()));
267         TransformerFactory factory = TransformerFactory.newInstance();
268         if (listener != null) {
269             factory.setErrorListener(listener);
270         }
271 
272         try {
273             f = factory.newTransformer(new SAXSource(source));
274             if (listener != null) {
275                 f.setErrorListener(listener);
276             }
277         } catch (TransformerConfigurationException e) {
278             testMsgs.add(test + &quot;::catch: &quot; + e.getMessage());
279         }
280 
281         return f;
282     }
283 
284     /**
285      * Attempts to capture messages sent to stderr/stdout during the creation
286      * of a Transformer.
287      *
288      * @param test the name of the test
289      * @param xsl the stylesheet
290      * @param setListener a flag indicating whether to set a listener
291      * @return message sent to stderr/stdout, null if none
292      * @throws Exception
293      */
294     private String getTransformerErr(String test, String xsl, ErrorListener listener)
295             throws Exception {
296         InputStream is = new ByteArrayInputStream(xsl.getBytes());
297         InputSource source = new InputSource(is);
298 
299         ByteArrayOutputStream baos1 = setOutput(SYSTEM_ERR);
300         ByteArrayOutputStream baos2 = setOutput(SYSTEM_OUT);
301 
302         TransformerFactory factory = TransformerFactory.newInstance();
303         if (listener != null) {
304             factory.setErrorListener(listener);
305         }
306 
307         try {
308             factory.newTransformer(new SAXSource(source));
309         } catch (TransformerConfigurationException e) {
310             testMsgs.add(test + &quot;::catch: &quot; + e.getMessage());
311         }
312         reset();
313         String msg = !&quot;&quot;.equals(baos1.toString()) ? ERR_STDERR : &quot;&quot;;
314         msg = !&quot;&quot;.equals(baos2.toString()) ? msg + ERR_STDOUT : msg;
315         return msg;
316     }
317 
318     /**
319      * Transforms an XML file. Attempts to capture stderr/stdout as the Transformer
320      * may direct messages to stdout.
321      *
322      * @param test the name of the test
323      * @param xml the XML file
324      * @param t the Transformer
325      * @param type the flag indicating which output channel to capture
326      * @return message sent to stdout, null if none
327      * @throws Exception
328      */
329     private String transform(String test, String xml, Transformer t)
330             throws Exception {
331         StreamSource source = new StreamSource(new StringReader(xml));
332         StreamResult result = new StreamResult(new StringWriter());
333         ByteArrayOutputStream baos1 = setOutput(SYSTEM_ERR);
334         ByteArrayOutputStream baos2 = setOutput(SYSTEM_OUT);
335         try {
336             t.transform(source, result);
337         } catch (Exception e) {
338             testMsgs.add(test + &quot;::catch: &quot; + e.getMessage());
339         }
340         reset();
341         String msg = !&quot;&quot;.equals(baos1.toString()) ? ERR_STDERR : &quot;&quot;;
342         msg = !&quot;&quot;.equals(baos2.toString()) ? msg + ERR_STDOUT : msg;
343         return msg;
344     }
345 
346     private ByteArrayOutputStream setOutput(int type) {
347         ByteArrayOutputStream baos = new ByteArrayOutputStream();
348         PrintStream ps = new PrintStream(baos);
349         if (type == SYSTEM_ERR) {
350             System.setErr(ps);
351         } else {
352             System.setOut(ps);
353         }
354         return baos;
355     }
356 
357     private void reset() {
358         System.setErr(originalErr);
359         System.setOut(originalOut);
360     }
361 
362     class ErrListener implements ErrorListener {
363         String testName;
364         String errMsg = &quot;&quot;;
365         ErrListener(String test) {
366             testName = test;
367         }
368 
369         @Override
370         public void error(TransformerException e)
371                 throws TransformerException {
372             errMsg = errMsg + &quot;#error: &quot; + e.getMessage();
373         }
374 
375         @Override
376         public void fatalError(TransformerException e)
377                 throws TransformerException {
378             errMsg = errMsg + &quot;#fatalError: &quot; + e.getMessage();
379         }
380 
381         @Override
382         public void warning(TransformerException e)
383                 throws TransformerException {
384             errMsg = errMsg + &quot;#warning: &quot; + e.getMessage();
385         }
386     }
387 }
    </pre>
  </body>
</html>