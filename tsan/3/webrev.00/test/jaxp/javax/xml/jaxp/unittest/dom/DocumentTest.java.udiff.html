<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jaxp/javax/xml/jaxp/unittest/dom/DocumentTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../common/prettyprint/xmltest8.out.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../parsers/BaseParsingTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jaxp/javax/xml/jaxp/unittest/dom/DocumentTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,48 +20,55 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package dom;
  
<span class="udiff-line-added">+ import com.sun.org.apache.xerces.internal.dom.AttrImpl;</span>
<span class="udiff-line-added">+ import com.sun.org.apache.xerces.internal.dom.DocumentImpl;</span>
<span class="udiff-line-added">+ import com.sun.org.apache.xerces.internal.dom.ElementImpl;</span>
<span class="udiff-line-added">+ import com.sun.org.apache.xerces.internal.dom.events.MutationEventImpl;</span>
<span class="udiff-line-added">+ import com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl;</span>
  import java.io.ByteArrayInputStream;
<span class="udiff-line-removed">- import java.io.IOException;</span>
  import java.io.InputStream;
  import javax.xml.parsers.DocumentBuilder;
  import javax.xml.parsers.DocumentBuilderFactory;
  import org.testng.Assert;
  import org.testng.annotations.Listeners;
  import org.testng.annotations.Test;
  import org.w3c.dom.Document;
  import org.w3c.dom.Element;
  import org.w3c.dom.Node;
<span class="udiff-line-modified-removed">- import org.xml.sax.SAXException;</span>
<span class="udiff-line-modified-added">+ import org.w3c.dom.events.Event;</span>
<span class="udiff-line-added">+ import org.w3c.dom.events.EventListener;</span>
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8213117</span>
<span class="udiff-line-modified-added">+  * @bug 8213117 8222743</span>
   * @library /javax/xml/jaxp/libs /javax/xml/jaxp/unittest
<span class="udiff-line-added">+  * @modules java.xml</span>
<span class="udiff-line-added">+  * @modules java.xml/com.sun.org.apache.xerces.internal.dom</span>
<span class="udiff-line-added">+  * @modules java.xml/com.sun.org.apache.xerces.internal.dom.events</span>
<span class="udiff-line-added">+  * @modules java.xml/com.sun.org.apache.xerces.internal.jaxp</span>
   * @run testng dom.DocumentTest
   * @summary Tests functionalities for Document.
   */
  @Listeners({jaxp.library.BasePolicy.class})
  public class DocumentTest {
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     private static final String XML1 = &quot;&lt;root&gt;&lt;oldNode oldAttrib1=\&quot;old value 1\&quot; oldAttrib2=\&quot;old value 2\&quot;&gt;&lt;/oldNode&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-removed">-     private static final String XML2 = &quot;&lt;root&gt;&lt;newNode newAttrib=\&quot;new value\&quot;&gt;&lt;/newNode&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-modified-added">+     static final int DOC1 = 1;</span>
<span class="udiff-line-modified-added">+     static final int DOC2 = 2;</span>
  
      /**
       * Verifies the adoptNode method. Before a node from a deferred DOM can be
       * adopted, it needs to be fully expanded.
       */
      @Test
      public void testAdoptNode() throws Exception {
<span class="udiff-line-added">+         String xml1 = &quot;&lt;root&gt;&lt;oldNode oldAttrib1=\&quot;old value 1\&quot; oldAttrib2=\&quot;old value 2\&quot;&gt;&lt;/oldNode&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-added">+         String xml2 = &quot;&lt;root&gt;&lt;newNode newAttrib=\&quot;new value\&quot;&gt;&lt;/newNode&gt;&lt;/root&gt;&quot;;</span>
  
<span class="udiff-line-modified-removed">-         DocumentBuilder builder = DocumentBuilderFactory.newInstance()</span>
<span class="udiff-line-modified-removed">-                 .newDocumentBuilder();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Document doc1 = getDocument(builder, XML1);</span>
<span class="udiff-line-removed">-         Document doc2 = getDocument(builder, XML2);</span>
<span class="udiff-line-modified-added">+         Document doc1 = getDocument(xml1);</span>
<span class="udiff-line-modified-added">+         Document doc2 = getDocument(xml2);</span>
  
          Element newNode = (Element) doc2.getFirstChild().getFirstChild();
          Element replacementNode = (Element) doc1.adoptNode(newNode);
  
          Node oldNode = doc1.getFirstChild().getFirstChild();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,12 +77,120 @@</span>
          String attrValue = doc1.getFirstChild().getFirstChild().getAttributes()
                  .getNamedItem(&quot;newAttrib&quot;).getNodeValue();
          Assert.assertEquals(attrValue, &quot;new value&quot;);
      }
  
<span class="udiff-line-modified-removed">-     private static Document getDocument(DocumentBuilder builder, String xml) throws SAXException, IOException {</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-added">+      * Verifies that the lookupNamespaceURI method returns null (not empty string)</span>
<span class="udiff-line-added">+      * for unbound prefix.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * Specification for lookupNamespaceURI:</span>
<span class="udiff-line-added">+      * Returns the associated namespace URI or null if none is found.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testUnboundNamespaceURI() throws Exception {</span>
<span class="udiff-line-added">+         String xml = &quot;&lt;?xml version=&#39;1.1&#39;?&gt;&quot;</span>
<span class="udiff-line-added">+                 + &quot;&lt;root&gt;&lt;e1 xmlns=&#39;&#39; xmlns:p1=&#39;&#39; xmlns:p2=&#39;uri2&#39;&gt;&lt;e2/&gt;&lt;/e1&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         DocumentBuilder db = DocumentBuilderFactory.newInstance().newDocumentBuilder();</span>
<span class="udiff-line-added">+         Document doc = getDocument(xml);</span>
<span class="udiff-line-added">+         Element e1 = doc.getDocumentElement();</span>
<span class="udiff-line-added">+         Element e2 = (Element)e1.getFirstChild().getFirstChild();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Assert.assertEquals(e1.lookupNamespaceURI(null), null);</span>
<span class="udiff-line-added">+         Assert.assertEquals(e2.lookupNamespaceURI(null), null);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Assert.assertEquals(e1.lookupNamespaceURI(&quot;p1&quot;), null);</span>
<span class="udiff-line-added">+         Assert.assertEquals(e2.lookupNamespaceURI(&quot;p1&quot;), null);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Assert.assertEquals(e1.lookupNamespaceURI(&quot;p2&quot;), null);</span>
<span class="udiff-line-added">+         Assert.assertEquals(e2.lookupNamespaceURI(&quot;p2&quot;), &quot;uri2&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Verifies that calling namespace methods on an empty document won&#39;t result</span>
<span class="udiff-line-added">+      * in a NPE.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testNamespaceNPE() throws Exception {</span>
<span class="udiff-line-added">+         Document document = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();</span>
<span class="udiff-line-added">+         document.lookupNamespaceURI(&quot;prefix&quot;);</span>
<span class="udiff-line-added">+         document.lookupPrefix(&quot;uri&quot;);</span>
<span class="udiff-line-added">+         document.isDefaultNamespace(&quot;uri&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Verifies that manipulating an independent document from within a mutation</span>
<span class="udiff-line-added">+      * listener does not modify the original event object.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testMutation() throws Exception {</span>
<span class="udiff-line-added">+         String xml1 = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;</span>
<span class="udiff-line-added">+                 + &quot;&lt;root&gt;&lt;a a_attr=\&quot;a_attr_value\&quot;/&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-added">+         String xml2 = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;</span>
<span class="udiff-line-added">+                 + &quot;&lt;root&gt;&lt;b b_attr=\&quot;b_attr_value\&quot;/&gt;&lt;/root&gt;&quot;;</span>
<span class="udiff-line-added">+         DocumentBuilder db = DocumentBuilderFactoryImpl.newInstance().newDocumentBuilder();</span>
<span class="udiff-line-added">+         DocumentImpl doc1 = (DocumentImpl)getDocument(xml1);</span>
<span class="udiff-line-added">+         DocumentImpl doc2 = (DocumentImpl)getDocument(xml2);</span>
<span class="udiff-line-added">+         ElementImpl a = (ElementImpl) doc1.getDocumentElement().getFirstChild();</span>
<span class="udiff-line-added">+         AttrImpl attr = (AttrImpl) a.getAttributeNode(&quot;a_attr&quot;);</span>
<span class="udiff-line-added">+         attr.addEventListener(MutationEventImpl.DOM_NODE_REMOVED, new MyEventListener(DOC1, doc2), false);</span>
<span class="udiff-line-added">+         doc2.addEventListener(MutationEventImpl.DOM_ATTR_MODIFIED, new MyEventListener(DOC2), true);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // make a change to doc1 to trigger the event</span>
<span class="udiff-line-added">+         Element a1 = (Element) doc1.getDocumentElement().getFirstChild();</span>
<span class="udiff-line-added">+         a1.setAttribute(&quot;a_attr&quot;, &quot;a_attr_newvalue&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static Document getDocument(String xml) throws Exception {</span>
<span class="udiff-line-added">+         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="udiff-line-added">+         dbf.setNamespaceAware(true);</span>
<span class="udiff-line-added">+         DocumentBuilder db = dbf.newDocumentBuilder();</span>
          InputStream a = new ByteArrayInputStream(xml.getBytes());
<span class="udiff-line-modified-removed">-         Document out = builder.parse(a);</span>
<span class="udiff-line-modified-added">+         Document out = db.parse(a);</span>
          return out;
      }
  
<span class="udiff-line-added">+     // EventListener that mutates an unrelated document when an event is received.</span>
<span class="udiff-line-added">+     static class MyEventListener implements EventListener {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private int docId;</span>
<span class="udiff-line-added">+         private Document doc = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public MyEventListener(int docId) {</span>
<span class="udiff-line-added">+             this.docId = docId;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public MyEventListener(int docId, Document doc) {</span>
<span class="udiff-line-added">+             this.docId = docId;</span>
<span class="udiff-line-added">+             this.doc = doc;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void handleEvent(Event evt) {</span>
<span class="udiff-line-added">+             if (docId == DOC1) {</span>
<span class="udiff-line-added">+                 //check the related node before making changes</span>
<span class="udiff-line-added">+                 checkRelatedNode(evt, &quot;a_attr_value&quot;);</span>
<span class="udiff-line-added">+                 //make a change to doc2</span>
<span class="udiff-line-added">+                 Element ele = (Element)doc.getDocumentElement().getFirstChild();</span>
<span class="udiff-line-added">+                 ele.setAttribute(&quot;b_attr&quot;, &quot;value for b_attr in doc2&quot;);</span>
<span class="udiff-line-added">+                 //check the related node again after the change</span>
<span class="udiff-line-added">+                 checkRelatedNode(evt, &quot;a_attr_value&quot;);</span>
<span class="udiff-line-added">+             } else { //DOC2</span>
<span class="udiff-line-added">+                 checkRelatedNode(evt, &quot;value for b_attr in doc2&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Utility method to display an event</span>
<span class="udiff-line-added">+     public static void checkRelatedNode(Event evt, String expected) {</span>
<span class="udiff-line-added">+         //System.out.println(&quot; Event: &quot; + evt + &quot;, on &quot; + evt.getTarget());</span>
<span class="udiff-line-added">+         if (evt instanceof MutationEventImpl) {</span>
<span class="udiff-line-added">+             MutationEventImpl mutation = (MutationEventImpl) evt;</span>
<span class="udiff-line-added">+             //System.out.println(&quot; + Related: &quot; + mutation.getRelatedNode());</span>
<span class="udiff-line-added">+             Assert.assertTrue(mutation.getRelatedNode().toString().contains(expected));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../common/prettyprint/xmltest8.out.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../parsers/BaseParsingTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>