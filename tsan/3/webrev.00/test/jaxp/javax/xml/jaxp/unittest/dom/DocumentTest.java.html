<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jaxp/javax/xml/jaxp/unittest/dom/DocumentTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package dom;
 24 
 25 import com.sun.org.apache.xerces.internal.dom.AttrImpl;
 26 import com.sun.org.apache.xerces.internal.dom.DocumentImpl;
 27 import com.sun.org.apache.xerces.internal.dom.ElementImpl;
 28 import com.sun.org.apache.xerces.internal.dom.events.MutationEventImpl;
 29 import com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl;
 30 import java.io.ByteArrayInputStream;
 31 import java.io.InputStream;
 32 import javax.xml.parsers.DocumentBuilder;
 33 import javax.xml.parsers.DocumentBuilderFactory;
 34 import org.testng.Assert;
 35 import org.testng.annotations.Listeners;
 36 import org.testng.annotations.Test;
 37 import org.w3c.dom.Document;
 38 import org.w3c.dom.Element;
 39 import org.w3c.dom.Node;
 40 import org.w3c.dom.events.Event;
 41 import org.w3c.dom.events.EventListener;
 42 
 43 /*
 44  * @test
 45  * @bug 8213117 8222743
 46  * @library /javax/xml/jaxp/libs /javax/xml/jaxp/unittest
 47  * @modules java.xml
 48  * @modules java.xml/com.sun.org.apache.xerces.internal.dom
 49  * @modules java.xml/com.sun.org.apache.xerces.internal.dom.events
 50  * @modules java.xml/com.sun.org.apache.xerces.internal.jaxp
 51  * @run testng dom.DocumentTest
 52  * @summary Tests functionalities for Document.
 53  */
 54 @Listeners({jaxp.library.BasePolicy.class})
 55 public class DocumentTest {
 56     static final int DOC1 = 1;
 57     static final int DOC2 = 2;
 58 
 59     /**
 60      * Verifies the adoptNode method. Before a node from a deferred DOM can be
 61      * adopted, it needs to be fully expanded.
 62      */
 63     @Test
 64     public void testAdoptNode() throws Exception {
 65         String xml1 = &quot;&lt;root&gt;&lt;oldNode oldAttrib1=\&quot;old value 1\&quot; oldAttrib2=\&quot;old value 2\&quot;&gt;&lt;/oldNode&gt;&lt;/root&gt;&quot;;
 66         String xml2 = &quot;&lt;root&gt;&lt;newNode newAttrib=\&quot;new value\&quot;&gt;&lt;/newNode&gt;&lt;/root&gt;&quot;;
 67 
 68         Document doc1 = getDocument(xml1);
 69         Document doc2 = getDocument(xml2);
 70 
 71         Element newNode = (Element) doc2.getFirstChild().getFirstChild();
 72         Element replacementNode = (Element) doc1.adoptNode(newNode);
 73 
 74         Node oldNode = doc1.getFirstChild().getFirstChild();
 75         doc1.getDocumentElement().replaceChild(replacementNode, oldNode);
 76 
 77         String attrValue = doc1.getFirstChild().getFirstChild().getAttributes()
 78                 .getNamedItem(&quot;newAttrib&quot;).getNodeValue();
 79         Assert.assertEquals(attrValue, &quot;new value&quot;);
 80     }
 81 
 82     /**
 83      * Verifies that the lookupNamespaceURI method returns null (not empty string)
 84      * for unbound prefix.
 85      *
 86      * Specification for lookupNamespaceURI:
 87      * Returns the associated namespace URI or null if none is found.
 88      *
 89      * @throws Exception
 90      */
 91     @Test
 92     public void testUnboundNamespaceURI() throws Exception {
 93         String xml = &quot;&lt;?xml version=&#39;1.1&#39;?&gt;&quot;
 94                 + &quot;&lt;root&gt;&lt;e1 xmlns=&#39;&#39; xmlns:p1=&#39;&#39; xmlns:p2=&#39;uri2&#39;&gt;&lt;e2/&gt;&lt;/e1&gt;&lt;/root&gt;&quot;;
 95 
 96         DocumentBuilder db = DocumentBuilderFactory.newInstance().newDocumentBuilder();
 97         Document doc = getDocument(xml);
 98         Element e1 = doc.getDocumentElement();
 99         Element e2 = (Element)e1.getFirstChild().getFirstChild();
100 
101         Assert.assertEquals(e1.lookupNamespaceURI(null), null);
102         Assert.assertEquals(e2.lookupNamespaceURI(null), null);
103 
104         Assert.assertEquals(e1.lookupNamespaceURI(&quot;p1&quot;), null);
105         Assert.assertEquals(e2.lookupNamespaceURI(&quot;p1&quot;), null);
106 
107         Assert.assertEquals(e1.lookupNamespaceURI(&quot;p2&quot;), null);
108         Assert.assertEquals(e2.lookupNamespaceURI(&quot;p2&quot;), &quot;uri2&quot;);
109     }
110 
111     /**
112      * Verifies that calling namespace methods on an empty document won&#39;t result
113      * in a NPE.
114      * @throws Exception
115      */
116     @Test
117     public void testNamespaceNPE() throws Exception {
118         Document document = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();
119         document.lookupNamespaceURI(&quot;prefix&quot;);
120         document.lookupPrefix(&quot;uri&quot;);
121         document.isDefaultNamespace(&quot;uri&quot;);
122     }
123 
124     /**
125      * Verifies that manipulating an independent document from within a mutation
126      * listener does not modify the original event object.
127      */
128     @Test
129     public void testMutation() throws Exception {
130         String xml1 = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;
131                 + &quot;&lt;root&gt;&lt;a a_attr=\&quot;a_attr_value\&quot;/&gt;&lt;/root&gt;&quot;;
132         String xml2 = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;
133                 + &quot;&lt;root&gt;&lt;b b_attr=\&quot;b_attr_value\&quot;/&gt;&lt;/root&gt;&quot;;
134         DocumentBuilder db = DocumentBuilderFactoryImpl.newInstance().newDocumentBuilder();
135         DocumentImpl doc1 = (DocumentImpl)getDocument(xml1);
136         DocumentImpl doc2 = (DocumentImpl)getDocument(xml2);
137         ElementImpl a = (ElementImpl) doc1.getDocumentElement().getFirstChild();
138         AttrImpl attr = (AttrImpl) a.getAttributeNode(&quot;a_attr&quot;);
139         attr.addEventListener(MutationEventImpl.DOM_NODE_REMOVED, new MyEventListener(DOC1, doc2), false);
140         doc2.addEventListener(MutationEventImpl.DOM_ATTR_MODIFIED, new MyEventListener(DOC2), true);
141 
142         // make a change to doc1 to trigger the event
143         Element a1 = (Element) doc1.getDocumentElement().getFirstChild();
144         a1.setAttribute(&quot;a_attr&quot;, &quot;a_attr_newvalue&quot;);
145     }
146 
147     private static Document getDocument(String xml) throws Exception {
148         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
149         dbf.setNamespaceAware(true);
150         DocumentBuilder db = dbf.newDocumentBuilder();
151         InputStream a = new ByteArrayInputStream(xml.getBytes());
152         Document out = db.parse(a);
153         return out;
154     }
155 
156     // EventListener that mutates an unrelated document when an event is received.
157     static class MyEventListener implements EventListener {
158 
159         private int docId;
160         private Document doc = null;
161 
162         public MyEventListener(int docId) {
163             this.docId = docId;
164         }
165 
166         public MyEventListener(int docId, Document doc) {
167             this.docId = docId;
168             this.doc = doc;
169         }
170 
171         public void handleEvent(Event evt) {
172             if (docId == DOC1) {
173                 //check the related node before making changes
174                 checkRelatedNode(evt, &quot;a_attr_value&quot;);
175                 //make a change to doc2
176                 Element ele = (Element)doc.getDocumentElement().getFirstChild();
177                 ele.setAttribute(&quot;b_attr&quot;, &quot;value for b_attr in doc2&quot;);
178                 //check the related node again after the change
179                 checkRelatedNode(evt, &quot;a_attr_value&quot;);
180             } else { //DOC2
181                 checkRelatedNode(evt, &quot;value for b_attr in doc2&quot;);
182             }
183         }
184 
185     }
186 
187     // Utility method to display an event
188     public static void checkRelatedNode(Event evt, String expected) {
189         //System.out.println(&quot; Event: &quot; + evt + &quot;, on &quot; + evt.getTarget());
190         if (evt instanceof MutationEventImpl) {
191             MutationEventImpl mutation = (MutationEventImpl) evt;
192             //System.out.println(&quot; + Related: &quot; + mutation.getRelatedNode());
193             Assert.assertTrue(mutation.getRelatedNode().toString().contains(expected));
194         }
195     }
196 }
    </pre>
  </body>
</html>