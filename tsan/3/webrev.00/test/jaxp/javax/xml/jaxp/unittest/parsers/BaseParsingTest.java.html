<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jaxp/javax/xml/jaxp/unittest/parsers/BaseParsingTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package parsers;
 24 
 25 import java.io.ByteArrayInputStream;
 26 import java.io.StringReader;
 27 import javax.xml.parsers.DocumentBuilder;
 28 import javax.xml.parsers.DocumentBuilderFactory;
 29 import javax.xml.parsers.ParserConfigurationException;
 30 import javax.xml.parsers.SAXParser;
 31 import javax.xml.parsers.SAXParserFactory;
 32 import javax.xml.stream.XMLInputFactory;
 33 import javax.xml.stream.XMLStreamReader;
 34 import org.testng.Assert;
 35 import static org.testng.Assert.assertEquals;
 36 import org.testng.annotations.DataProvider;
 37 import org.testng.annotations.Listeners;
 38 import org.testng.annotations.Test;
 39 import org.w3c.dom.Document;
 40 import org.w3c.dom.ls.DOMImplementationLS;
 41 import org.w3c.dom.ls.LSSerializer;
 42 import org.xml.sax.Attributes;
 43 import org.xml.sax.InputSource;
 44 import org.xml.sax.SAXException;
 45 import org.xml.sax.helpers.DefaultHandler;
 46 
 47 /**
 48  * @test
 49  * @bug 8169450 8222415 8219692
 50  * @library /javax/xml/jaxp/libs /javax/xml/jaxp/unittest
 51  * @run testng/othervm -DrunSecMngr=true parsers.BaseParsingTest
 52  * @run testng/othervm parsers.BaseParsingTest
 53  * @summary Tests that verify base parsing
 54  */
 55 @Listeners({jaxp.library.BasePolicy.class})
 56 public class BaseParsingTest {
 57     private static final String DOM_IMPL =
 58             &quot;com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl&quot;;
 59     private static final String SAX_IMPL =
 60             &quot;com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl&quot;;
 61 
 62     String xml_8219692 = &quot;&lt;a &quot;
 63             + &quot;xmlns=\&quot;http://openjdk_java_net/xml/defaultNS\&quot; &quot;
 64             + &quot;xmlns:p1=\&quot;http://openjdk_java_net/xml/serializer/\&quot;&gt;&quot;
 65             + &quot;&lt;b&gt;in default namespace&lt;/b&gt;&lt;/a&gt;&quot;;
 66 
 67     /**
 68      * Creates NamespaceAware parsers using old and new factory methods.
 69      * @return NamespaceAware parsers
 70      * @throws ParserConfigurationException
 71      */
 72     @DataProvider(name = &quot;NSAwareDOMFactory&quot;)
 73     public static Object[][] getNSDOMFactory() throws Exception {
 74         boolean isNSAware = true;
 75 
 76         return new Object[][]{
 77             {getDOMParser(DocumentBuilderFactory.newDefaultInstance(), isNSAware)},
 78             {getDOMParser(DocumentBuilderFactory.newInstance(), isNSAware)},
 79             {getDOMParser(DocumentBuilderFactory.newInstance(DOM_IMPL, null), isNSAware)},
 80             // using the new methods
 81             {DocumentBuilderFactory.newDefaultNSInstance().newDocumentBuilder()},
 82             {DocumentBuilderFactory.newNSInstance().newDocumentBuilder()},
 83             {DocumentBuilderFactory.newNSInstance(DOM_IMPL, null).newDocumentBuilder()}
 84         };
 85     }
 86 
 87     /**
 88      * Creates parsers using the old instance methods. By default, they are
 89      * not Namespace Aware.
 90      * @return non-NamespaceAware parsers
 91      * @throws ParserConfigurationException
 92      */
 93     @DataProvider(name = &quot;DOMFactory&quot;)
 94     public static Object[][] getDOMFactory() throws Exception {
 95         boolean isNSAware = false;
 96 
 97         return new Object[][]{
 98             {getDOMParser(DocumentBuilderFactory.newDefaultInstance(), isNSAware)},
 99             {getDOMParser(DocumentBuilderFactory.newInstance(), isNSAware)},
100             {getDOMParser(DocumentBuilderFactory.newInstance(DOM_IMPL, null), isNSAware)}
101         };
102     }
103 
104 
105     /**
106      * Creates NamespaceAware parsers using old and new factory methods.
107      * @return NamespaceAware parsers
108      * @throws ParserConfigurationException
109      */
110     @DataProvider(name = &quot;NSAwareSAXFactory&quot;)
111     public static Object[][] getNSSAXFactory() throws Exception {
112         boolean isNSAware = true;
113 
114         return new Object[][]{
115             {getSAXParser(SAXParserFactory.newDefaultInstance(), isNSAware)},
116             {getSAXParser(SAXParserFactory.newInstance(), isNSAware)},
117             {getSAXParser(SAXParserFactory.newInstance(SAX_IMPL, null), isNSAware)},
118             // using the new methods
119             {SAXParserFactory.newDefaultNSInstance().newSAXParser()},
120             {SAXParserFactory.newNSInstance().newSAXParser()},
121             {SAXParserFactory.newNSInstance(SAX_IMPL, null).newSAXParser()},
122         };
123     }
124 
125     @DataProvider(name = &quot;SAXFactory&quot;)
126     public static Object[][] getSAXFactory() throws Exception {
127         boolean isNSAware = false;
128 
129         return new Object[][]{
130             {getSAXParser(SAXParserFactory.newDefaultInstance(), isNSAware)},
131             {getSAXParser(SAXParserFactory.newInstance(), isNSAware)},
132             {getSAXParser(SAXParserFactory.newInstance(SAX_IMPL, null), isNSAware)},
133         };
134     }
135 
136     @DataProvider(name = &quot;xmlDeclarations&quot;)
137     public static Object[][] xmlDeclarations() {
138         return new Object[][]{
139             {&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
140             {&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
141             {&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=&#39;yes&#39;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
142             {&quot;&lt;?xml\n&quot;
143                 + &quot; version=\&quot;1.0\&quot;?&gt;\n&quot;
144                 + &quot;&lt;root&gt;\n&quot;
145                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
146                 + &quot;&lt;/root&gt;&quot;},
147             {&quot;&lt;?xml\n&quot;
148                 + &quot; version=\&quot;1.0\&quot;\n&quot;
149                 + &quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
150                 + &quot;&lt;root&gt;\n&quot;
151                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
152                 + &quot;&lt;/root&gt;&quot;},
153             {&quot;&lt;?xml\n&quot;
154                 + &quot; version=\&quot;1.0\&quot;\n&quot;
155                 + &quot; encoding=\&quot;UTF-8\&quot;\n&quot;
156                 + &quot; standalone=\&quot;yes\&quot;?&gt;\n&quot;
157                 + &quot;&lt;root&gt;\n&quot;
158                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
159                 + &quot;&lt;/root&gt;&quot;},
160             {&quot;&lt;?xml\n&quot;
161                 + &quot; version\n&quot;
162                 + &quot;=\n&quot;
163                 + &quot;\&quot;1.0\&quot;\n&quot;
164                 + &quot; encoding\n&quot;
165                 + &quot;=\n&quot;
166                 + &quot;\&quot;UTF-8\&quot;\n&quot;
167                 + &quot; standalone\n&quot;
168                 + &quot;=\n&quot;
169                 + &quot;\&quot;yes\&quot;?&gt;\n&quot;
170                 + &quot;&lt;root&gt;\n&quot;
171                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
172                 + &quot;&lt;/root&gt;&quot;},
173             {&quot;&lt;?xml version=\&quot;1.1\&quot;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
174             {&quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
175             {&quot;&lt;?xml version=\&quot;1.1\&quot; encoding=\&quot;UTF-8\&quot; standalone=&#39;yes&#39;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
176             {&quot;&lt;?xml\n&quot;
177                 + &quot; version=\&quot;1.1\&quot;?&gt;\n&quot;
178                 + &quot;&lt;root&gt;\n&quot;
179                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
180                 + &quot;&lt;/root&gt;&quot;},
181             {&quot;&lt;?xml\n&quot;
182                 + &quot; version=\&quot;1.1\&quot;\n&quot;
183                 + &quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
184                 + &quot;&lt;root&gt;\n&quot;
185                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
186                 + &quot;&lt;/root&gt;&quot;},
187             {&quot;&lt;?xml\n&quot;
188                 + &quot; version=\&quot;1.1\&quot;\n&quot;
189                 + &quot; encoding=\&quot;UTF-8\&quot;\n&quot;
190                 + &quot; standalone=\&quot;yes\&quot;?&gt;\n&quot;
191                 + &quot;&lt;root&gt;\n&quot;
192                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
193                 + &quot;&lt;/root&gt;&quot;},
194             {&quot;&lt;?xml\n&quot;
195                 + &quot; version\n&quot;
196                 + &quot;=\n&quot;
197                 + &quot;\&quot;1.1\&quot;\n&quot;
198                 + &quot; encoding\n&quot;
199                 + &quot;=\n&quot;
200                 + &quot;\&quot;UTF-8\&quot;\n&quot;
201                 + &quot; standalone\n&quot;
202                 + &quot;=\n&quot;
203                 + &quot;\&quot;yes\&quot;?&gt;\n&quot;
204                 + &quot;&lt;root&gt;\n&quot;
205                 + &quot; &lt;test&gt;t&lt;/test&gt;\n&quot;
206                 + &quot;&lt;/root&gt;&quot;}
207         };
208     }
209 
210     /**
211      * @bug 8169450
212      * Verifies that the parser successfully parses the declarations provided in
213      * xmlDeclarations. Exception would otherwise be thrown as reported in 8169450.
214      *
215      * XML Declaration according to https://www.w3.org/TR/REC-xml/#NT-XMLDecl
216      * [23] XMLDecl     ::= &#39;&lt;?xml&#39; VersionInfo EncodingDecl? SDDecl? S? &#39;?&gt;&#39;
217      * [24] VersionInfo ::= S &#39;version&#39; Eq (&quot;&#39;&quot; VersionNum &quot;&#39;&quot; | &#39;&quot;&#39; VersionNum &#39;&quot;&#39;)
218      * [25] Eq          ::= S? &#39;=&#39; S? [26] VersionNum ::= &#39;1.&#39; [0-9]+
219      *
220      * @param xml the test xml
221      * @throws Exception if the parser fails to parse the xml
222      */
223     @Test(dataProvider = &quot;xmlDeclarations&quot;)
224     public void test(String xml) throws Exception {
225         XMLInputFactory xif = XMLInputFactory.newDefaultFactory();
226         XMLStreamReader xsr = xif.createXMLStreamReader(new StringReader(xml));
227         while (xsr.hasNext()) {
228             xsr.next();
229         }
230     }
231 
232     /**
233      * @bug 8169450
234      * This particular issue does not appear in DOM parsing since the spaces are
235      * normalized during version detection. This test case then serves as a guard
236      * against such an issue from occurring in the version detection.
237      *
238      * @param xml the test xml
239      * @throws Exception if the parser fails to parse the xml
240      */
241     @Test(dataProvider = &quot;xmlDeclarations&quot;)
242     public void testWithDOM(String xml) throws Exception {
243         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
244         DocumentBuilder db = dbf.newDocumentBuilder();
245         db.parse(new InputSource(new StringReader(xml)));
246     }
247 
248     /**
249      * @bug 8222415
250      * Verifies that the parser is configured properly for UTF-16BE or LE.
251      * @throws Exception
252      */
253     @Test
254     public void testEncoding() throws Exception {
255         ByteArrayInputStream bis = new ByteArrayInputStream(
256                 &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-16\&quot;?&gt; &lt;a/&gt;&quot;.getBytes(&quot;UnicodeLittle&quot;));
257         InputSource is = new InputSource(bis);
258         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
259         DocumentBuilder db = dbf.newDocumentBuilder();
260 
261         Document doc = db.parse(is);
262         assertEquals(&quot;UTF-16LE&quot;, doc.getInputEncoding());
263     }
264 
265     /**
266      * @bug 8219692
267      * Verifies that the default namespace declaration is preserved when
268      * NamespaceAware is set on the parser.
269      * @throws Exception
270      */
271     @Test(dataProvider = &quot;NSAwareDOMFactory&quot;)
272     public void testNSAwareDOMFactory(DocumentBuilder db) throws Exception {
273         LSSerializer ls = getSerializer(db);
274         String out = ls.writeToString(getDoc(db, xml_8219692));
275         System.out.println(out);
276         Assert.assertTrue(out.contains(&quot;http://openjdk_java_net/xml/defaultNS&quot;));
277     }
278 
279     /**
280      * @bug 8219692
281      * Verifies that the default namespace declaration is missing when the
282      * old factory methods are used.
283      * @throws Exception
284      */
285     @Test(dataProvider = &quot;DOMFactory&quot;)
286     public void testDOMFactory(DocumentBuilder db) throws Exception {
287         LSSerializer ls = getSerializer(db);
288         String out = ls.writeToString(getDoc(db, xml_8219692));
289         System.out.println(out);
290         Assert.assertFalse(out.contains(&quot;http://openjdk_java_net/xml/defaultNS&quot;));
291     }
292 
293     /**
294      * @bug 8219692
295      * Verifies that the default namespace declaration is preserved when
296      * NamespaceAware is set on the parser.
297      * @throws Exception
298      */
299     @Test(dataProvider = &quot;NSAwareSAXFactory&quot;)
300     public void testNSAwareSAXFactory(SAXParser sp) throws Exception {
301         MyHandler h = new MyHandler();
302         sp.parse(new InputSource(new StringReader(xml_8219692)), h);
303 
304         Assert.assertTrue(h.isNSAware);
305     }
306 
307     /**
308      * @bug 8219692
309      * Verifies that the default namespace declaration is missing when the
310      * old factory methods are used.
311      * @throws Exception
312      */
313     @Test(dataProvider = &quot;SAXFactory&quot;)
314     public void testSAXFactory(SAXParser sp) throws Exception {
315         MyHandler h = new MyHandler();
316         sp.parse(new InputSource(new StringReader(xml_8219692)), h);
317 
318         Assert.assertFalse(h.isNSAware);
319     }
320 
321     private static DocumentBuilder getDOMParser(DocumentBuilderFactory dbf, boolean isNSAware)
322             throws Exception {
323         dbf.setNamespaceAware(isNSAware);
324         return dbf.newDocumentBuilder();
325     }
326 
327     private static SAXParser getSAXParser(SAXParserFactory spf, boolean isNSAware)
328             throws Exception {
329         spf.setNamespaceAware(isNSAware);
330         return spf.newSAXParser();
331     }
332 
333     private LSSerializer getSerializer(DocumentBuilder db) throws Exception {
334         DOMImplementationLS di = (DOMImplementationLS) db.getDOMImplementation();
335         return di.createLSSerializer();
336     }
337 
338     private Document getDoc(DocumentBuilder db, String xml) throws Exception {
339         InputSource is = new InputSource(new StringReader(xml));
340         return db.parse(is);
341     }
342 
343     /**
344      * SAX Handler
345      */
346     class MyHandler extends DefaultHandler {
347         boolean isNSAware = false;
348 
349         @Override
350         public void startElement(String uri, String localName, String qName,
351             Attributes attributes) throws SAXException {
352             isNSAware = &quot;http://openjdk_java_net/xml/defaultNS&quot;.equals(uri)
353                     &amp;&amp; (&quot;a&quot;.equals(localName) || &quot;b&quot;.equals(localName));
354         }
355     }
356 }
    </pre>
  </body>
</html>