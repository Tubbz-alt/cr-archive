<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jaxp/javax/xml/jaxp/unittest/parsers/BaseParsingTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../dom/DocumentTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../stream/XMLStreamWriterTest/XMLStreamWriterTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jaxp/javax/xml/jaxp/unittest/parsers/BaseParsingTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,30 +20,120 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package parsers;
  
<span class="udiff-line-added">+ import java.io.ByteArrayInputStream;</span>
  import java.io.StringReader;
  import javax.xml.parsers.DocumentBuilder;
  import javax.xml.parsers.DocumentBuilderFactory;
<span class="udiff-line-added">+ import javax.xml.parsers.ParserConfigurationException;</span>
<span class="udiff-line-added">+ import javax.xml.parsers.SAXParser;</span>
<span class="udiff-line-added">+ import javax.xml.parsers.SAXParserFactory;</span>
  import javax.xml.stream.XMLInputFactory;
  import javax.xml.stream.XMLStreamReader;
<span class="udiff-line-added">+ import org.testng.Assert;</span>
<span class="udiff-line-added">+ import static org.testng.Assert.assertEquals;</span>
  import org.testng.annotations.DataProvider;
  import org.testng.annotations.Listeners;
  import org.testng.annotations.Test;
<span class="udiff-line-added">+ import org.w3c.dom.Document;</span>
<span class="udiff-line-added">+ import org.w3c.dom.ls.DOMImplementationLS;</span>
<span class="udiff-line-added">+ import org.w3c.dom.ls.LSSerializer;</span>
<span class="udiff-line-added">+ import org.xml.sax.Attributes;</span>
  import org.xml.sax.InputSource;
<span class="udiff-line-added">+ import org.xml.sax.SAXException;</span>
<span class="udiff-line-added">+ import org.xml.sax.helpers.DefaultHandler;</span>
  
  /**
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8169450</span>
<span class="udiff-line-modified-added">+  * @bug 8169450 8222415 8219692</span>
   * @library /javax/xml/jaxp/libs /javax/xml/jaxp/unittest
   * @run testng/othervm -DrunSecMngr=true parsers.BaseParsingTest
   * @run testng/othervm parsers.BaseParsingTest
   * @summary Tests that verify base parsing
   */
  @Listeners({jaxp.library.BasePolicy.class})
  public class BaseParsingTest {
<span class="udiff-line-added">+     private static final String DOM_IMPL =</span>
<span class="udiff-line-added">+             &quot;com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl&quot;;</span>
<span class="udiff-line-added">+     private static final String SAX_IMPL =</span>
<span class="udiff-line-added">+             &quot;com.sun.org.apache.xerces.internal.jaxp.SAXParserFactoryImpl&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     String xml_8219692 = &quot;&lt;a &quot;</span>
<span class="udiff-line-added">+             + &quot;xmlns=\&quot;http://openjdk_java_net/xml/defaultNS\&quot; &quot;</span>
<span class="udiff-line-added">+             + &quot;xmlns:p1=\&quot;http://openjdk_java_net/xml/serializer/\&quot;&gt;&quot;</span>
<span class="udiff-line-added">+             + &quot;&lt;b&gt;in default namespace&lt;/b&gt;&lt;/a&gt;&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Creates NamespaceAware parsers using old and new factory methods.</span>
<span class="udiff-line-added">+      * @return NamespaceAware parsers</span>
<span class="udiff-line-added">+      * @throws ParserConfigurationException</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;NSAwareDOMFactory&quot;)</span>
<span class="udiff-line-added">+     public static Object[][] getNSDOMFactory() throws Exception {</span>
<span class="udiff-line-added">+         boolean isNSAware = true;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newDefaultInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newInstance(DOM_IMPL, null), isNSAware)},</span>
<span class="udiff-line-added">+             // using the new methods</span>
<span class="udiff-line-added">+             {DocumentBuilderFactory.newDefaultNSInstance().newDocumentBuilder()},</span>
<span class="udiff-line-added">+             {DocumentBuilderFactory.newNSInstance().newDocumentBuilder()},</span>
<span class="udiff-line-added">+             {DocumentBuilderFactory.newNSInstance(DOM_IMPL, null).newDocumentBuilder()}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Creates parsers using the old instance methods. By default, they are</span>
<span class="udiff-line-added">+      * not Namespace Aware.</span>
<span class="udiff-line-added">+      * @return non-NamespaceAware parsers</span>
<span class="udiff-line-added">+      * @throws ParserConfigurationException</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;DOMFactory&quot;)</span>
<span class="udiff-line-added">+     public static Object[][] getDOMFactory() throws Exception {</span>
<span class="udiff-line-added">+         boolean isNSAware = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newDefaultInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getDOMParser(DocumentBuilderFactory.newInstance(DOM_IMPL, null), isNSAware)}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Creates NamespaceAware parsers using old and new factory methods.</span>
<span class="udiff-line-added">+      * @return NamespaceAware parsers</span>
<span class="udiff-line-added">+      * @throws ParserConfigurationException</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;NSAwareSAXFactory&quot;)</span>
<span class="udiff-line-added">+     public static Object[][] getNSSAXFactory() throws Exception {</span>
<span class="udiff-line-added">+         boolean isNSAware = true;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newDefaultInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newInstance(SAX_IMPL, null), isNSAware)},</span>
<span class="udiff-line-added">+             // using the new methods</span>
<span class="udiff-line-added">+             {SAXParserFactory.newDefaultNSInstance().newSAXParser()},</span>
<span class="udiff-line-added">+             {SAXParserFactory.newNSInstance().newSAXParser()},</span>
<span class="udiff-line-added">+             {SAXParserFactory.newNSInstance(SAX_IMPL, null).newSAXParser()},</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;SAXFactory&quot;)</span>
<span class="udiff-line-added">+     public static Object[][] getSAXFactory() throws Exception {</span>
<span class="udiff-line-added">+         boolean isNSAware = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newDefaultInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newInstance(), isNSAware)},</span>
<span class="udiff-line-added">+             {getSAXParser(SAXParserFactory.newInstance(SAX_IMPL, null), isNSAware)},</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
  
      @DataProvider(name = &quot;xmlDeclarations&quot;)
      public static Object[][] xmlDeclarations() {
          return new Object[][]{
              {&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;root&gt;&lt;test&gt;t&lt;/test&gt;&lt;/root&gt;&quot;},
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,18 +231,126 @@</span>
  
      /**
       * @bug 8169450
       * This particular issue does not appear in DOM parsing since the spaces are
       * normalized during version detection. This test case then serves as a guard
<span class="udiff-line-modified-removed">-      * against such an issue from occuring in the version detection.</span>
<span class="udiff-line-modified-added">+      * against such an issue from occurring in the version detection.</span>
       *
       * @param xml the test xml
       * @throws Exception if the parser fails to parse the xml
       */
      @Test(dataProvider = &quot;xmlDeclarations&quot;)
      public void testWithDOM(String xml) throws Exception {
          DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
<span class="udiff-line-removed">-         dbf.setValidating(true);</span>
          DocumentBuilder db = dbf.newDocumentBuilder();
          db.parse(new InputSource(new StringReader(xml)));
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @bug 8222415</span>
<span class="udiff-line-added">+      * Verifies that the parser is configured properly for UTF-16BE or LE.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testEncoding() throws Exception {</span>
<span class="udiff-line-added">+         ByteArrayInputStream bis = new ByteArrayInputStream(</span>
<span class="udiff-line-added">+                 &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-16\&quot;?&gt; &lt;a/&gt;&quot;.getBytes(&quot;UnicodeLittle&quot;));</span>
<span class="udiff-line-added">+         InputSource is = new InputSource(bis);</span>
<span class="udiff-line-added">+         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="udiff-line-added">+         DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Document doc = db.parse(is);</span>
<span class="udiff-line-added">+         assertEquals(&quot;UTF-16LE&quot;, doc.getInputEncoding());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @bug 8219692</span>
<span class="udiff-line-added">+      * Verifies that the default namespace declaration is preserved when</span>
<span class="udiff-line-added">+      * NamespaceAware is set on the parser.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;NSAwareDOMFactory&quot;)</span>
<span class="udiff-line-added">+     public void testNSAwareDOMFactory(DocumentBuilder db) throws Exception {</span>
<span class="udiff-line-added">+         LSSerializer ls = getSerializer(db);</span>
<span class="udiff-line-added">+         String out = ls.writeToString(getDoc(db, xml_8219692));</span>
<span class="udiff-line-added">+         System.out.println(out);</span>
<span class="udiff-line-added">+         Assert.assertTrue(out.contains(&quot;http://openjdk_java_net/xml/defaultNS&quot;));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @bug 8219692</span>
<span class="udiff-line-added">+      * Verifies that the default namespace declaration is missing when the</span>
<span class="udiff-line-added">+      * old factory methods are used.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;DOMFactory&quot;)</span>
<span class="udiff-line-added">+     public void testDOMFactory(DocumentBuilder db) throws Exception {</span>
<span class="udiff-line-added">+         LSSerializer ls = getSerializer(db);</span>
<span class="udiff-line-added">+         String out = ls.writeToString(getDoc(db, xml_8219692));</span>
<span class="udiff-line-added">+         System.out.println(out);</span>
<span class="udiff-line-added">+         Assert.assertFalse(out.contains(&quot;http://openjdk_java_net/xml/defaultNS&quot;));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @bug 8219692</span>
<span class="udiff-line-added">+      * Verifies that the default namespace declaration is preserved when</span>
<span class="udiff-line-added">+      * NamespaceAware is set on the parser.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;NSAwareSAXFactory&quot;)</span>
<span class="udiff-line-added">+     public void testNSAwareSAXFactory(SAXParser sp) throws Exception {</span>
<span class="udiff-line-added">+         MyHandler h = new MyHandler();</span>
<span class="udiff-line-added">+         sp.parse(new InputSource(new StringReader(xml_8219692)), h);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Assert.assertTrue(h.isNSAware);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @bug 8219692</span>
<span class="udiff-line-added">+      * Verifies that the default namespace declaration is missing when the</span>
<span class="udiff-line-added">+      * old factory methods are used.</span>
<span class="udiff-line-added">+      * @throws Exception</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;SAXFactory&quot;)</span>
<span class="udiff-line-added">+     public void testSAXFactory(SAXParser sp) throws Exception {</span>
<span class="udiff-line-added">+         MyHandler h = new MyHandler();</span>
<span class="udiff-line-added">+         sp.parse(new InputSource(new StringReader(xml_8219692)), h);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Assert.assertFalse(h.isNSAware);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static DocumentBuilder getDOMParser(DocumentBuilderFactory dbf, boolean isNSAware)</span>
<span class="udiff-line-added">+             throws Exception {</span>
<span class="udiff-line-added">+         dbf.setNamespaceAware(isNSAware);</span>
<span class="udiff-line-added">+         return dbf.newDocumentBuilder();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static SAXParser getSAXParser(SAXParserFactory spf, boolean isNSAware)</span>
<span class="udiff-line-added">+             throws Exception {</span>
<span class="udiff-line-added">+         spf.setNamespaceAware(isNSAware);</span>
<span class="udiff-line-added">+         return spf.newSAXParser();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private LSSerializer getSerializer(DocumentBuilder db) throws Exception {</span>
<span class="udiff-line-added">+         DOMImplementationLS di = (DOMImplementationLS) db.getDOMImplementation();</span>
<span class="udiff-line-added">+         return di.createLSSerializer();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private Document getDoc(DocumentBuilder db, String xml) throws Exception {</span>
<span class="udiff-line-added">+         InputSource is = new InputSource(new StringReader(xml));</span>
<span class="udiff-line-added">+         return db.parse(is);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * SAX Handler</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     class MyHandler extends DefaultHandler {</span>
<span class="udiff-line-added">+         boolean isNSAware = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void startElement(String uri, String localName, String qName,</span>
<span class="udiff-line-added">+             Attributes attributes) throws SAXException {</span>
<span class="udiff-line-added">+             isNSAware = &quot;http://openjdk_java_net/xml/defaultNS&quot;.equals(uri)</span>
<span class="udiff-line-added">+                     &amp;&amp; (&quot;a&quot;.equals(localName) || &quot;b&quot;.equals(localName));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../dom/DocumentTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../stream/XMLStreamWriterTest/XMLStreamWriterTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>