<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/micro/org/openjdk/bench/java/net/SocketReadWrite.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SocketChannelReadWrite.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketStreaming.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/micro/org/openjdk/bench/java/net/SocketReadWrite.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014 Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,88 +20,196 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package org.openjdk.bench.java.net;
  
<span class="udiff-line-removed">- import java.io.IOException;</span>
<span class="udiff-line-removed">- import java.io.InputStream;</span>
<span class="udiff-line-removed">- import java.io.OutputStream;</span>
<span class="udiff-line-removed">- import java.net.InetAddress;</span>
<span class="udiff-line-removed">- import java.net.ServerSocket;</span>
<span class="udiff-line-removed">- import java.net.Socket;</span>
<span class="udiff-line-removed">- import java.net.SocketException;</span>
<span class="udiff-line-removed">- import java.util.concurrent.TimeUnit;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import org.openjdk.jmh.annotations.BenchmarkMode;</span>
  import org.openjdk.jmh.annotations.Benchmark;
<span class="udiff-line-added">+ import org.openjdk.jmh.annotations.BenchmarkMode;</span>
  import org.openjdk.jmh.annotations.Mode;
  import org.openjdk.jmh.annotations.OutputTimeUnit;
<span class="udiff-line-added">+ import org.openjdk.jmh.annotations.Param;</span>
  import org.openjdk.jmh.annotations.Scope;
  import org.openjdk.jmh.annotations.Setup;
  import org.openjdk.jmh.annotations.State;
  import org.openjdk.jmh.annotations.TearDown;
  
<span class="udiff-line-added">+ import java.io.IOException;</span>
<span class="udiff-line-added">+ import java.io.InputStream;</span>
<span class="udiff-line-added">+ import java.io.OutputStream;</span>
<span class="udiff-line-added">+ import java.net.InetAddress;</span>
<span class="udiff-line-added">+ import java.net.ServerSocket;</span>
<span class="udiff-line-added">+ import java.net.Socket;</span>
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ import java.util.concurrent.CountDownLatch;</span>
<span class="udiff-line-added">+ import java.util.concurrent.ThreadLocalRandom;</span>
<span class="udiff-line-added">+ import java.util.concurrent.TimeUnit;</span>
<span class="udiff-line-added">+ </span>
  /**
<span class="udiff-line-modified-removed">-  * Tests the overheads of I/O API.</span>
<span class="udiff-line-modified-removed">-  * This test is known to depend heavily on network conditions and paltform.</span>
<span class="udiff-line-modified-added">+  * Benchmark socket read/write.</span>
<span class="udiff-line-modified-added">+  *</span>
   */
  @BenchmarkMode(Mode.Throughput)
<span class="udiff-line-modified-removed">- @OutputTimeUnit(TimeUnit.MILLISECONDS)</span>
<span class="udiff-line-modified-added">+ @OutputTimeUnit(TimeUnit.SECONDS)</span>
  @State(Scope.Thread)
  public class SocketReadWrite {
  
<span class="udiff-line-modified-removed">-     private OutputStream os;</span>
<span class="udiff-line-modified-removed">-     private InputStream is;</span>
<span class="udiff-line-removed">-     private ServerSocket ss;</span>
<span class="udiff-line-removed">-     private Socket s1, s2;</span>
<span class="udiff-line-removed">-     private ReadThread rt;</span>
<span class="udiff-line-modified-added">+     static final InetAddress address = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-modified-added">+     public static final int TIMEOUT = 10000;</span>
  
<span class="udiff-line-modified-removed">-     @Setup</span>
<span class="udiff-line-modified-removed">-     public void beforeRun() throws IOException {</span>
<span class="udiff-line-removed">-         InetAddress iaddr = InetAddress.getLocalHost();</span>
<span class="udiff-line-modified-added">+     static class EchoServer implements Runnable {</span>
<span class="udiff-line-modified-added">+         // EchoServer is implemented to execute the same amount echo threads as benchmarking threads are running</span>
  
<span class="udiff-line-modified-removed">-         ss = new ServerSocket(0);</span>
<span class="udiff-line-modified-removed">-         s1 = new Socket(iaddr, ss.getLocalPort());</span>
<span class="udiff-line-modified-removed">-         s2 = ss.accept();</span>
<span class="udiff-line-modified-added">+         final ServerSocket ss;</span>
<span class="udiff-line-modified-added">+         final int port;</span>
<span class="udiff-line-modified-added">+         final CountDownLatch startedLatch;</span>
<span class="udiff-line-added">+         final int size;</span>
<span class="udiff-line-added">+         final boolean timeout;</span>
<span class="udiff-line-added">+         List&lt;ServerThread&gt; threads = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         volatile boolean isDone = false;</span>
  
<span class="udiff-line-modified-removed">-         os = s1.getOutputStream();</span>
<span class="udiff-line-modified-removed">-         is = s2.getInputStream();</span>
<span class="udiff-line-modified-added">+         public EchoServer(CountDownLatch await, int size, boolean timeout) throws IOException {</span>
<span class="udiff-line-modified-added">+             this.size = size;</span>
<span class="udiff-line-added">+             this.timeout = timeout;</span>
<span class="udiff-line-added">+             ss = new ServerSocket(0);</span>
<span class="udiff-line-added">+             port = ss.getLocalPort();</span>
<span class="udiff-line-added">+             this.startedLatch = await;</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-modified-removed">-         rt = new ReadThread(is);</span>
<span class="udiff-line-modified-removed">-         rt.start();</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         @Override</span>
<span class="udiff-line-modified-added">+         public void run() {</span>
<span class="udiff-line-modified-added">+             startedLatch.countDown();</span>
<span class="udiff-line-added">+             while (!isDone) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     Socket s = ss.accept();</span>
<span class="udiff-line-added">+                     s.setTcpNoDelay(true);</span>
<span class="udiff-line-added">+                     if (timeout) {</span>
<span class="udiff-line-added">+                         s.setSoTimeout(TIMEOUT);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     ServerThread st = new ServerThread(s, size);</span>
<span class="udiff-line-added">+                     threads.add(st);</span>
<span class="udiff-line-added">+                     new Thread(st).start();</span>
<span class="udiff-line-added">+                 } catch (IOException e) {</span>
<span class="udiff-line-added">+                     if (!isDone) {</span>
<span class="udiff-line-added">+                         e.printStackTrace();</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-modified-removed">-     @TearDown</span>
<span class="udiff-line-modified-removed">-     public void afterRun() throws IOException, InterruptedException {</span>
<span class="udiff-line-modified-removed">-         os.write(0);</span>
<span class="udiff-line-modified-removed">-         os.close();</span>
<span class="udiff-line-modified-removed">-         is.close();</span>
<span class="udiff-line-modified-removed">-         s1.close();</span>
<span class="udiff-line-modified-removed">-         s2.close();</span>
<span class="udiff-line-modified-removed">-         ss.close();</span>
<span class="udiff-line-modified-removed">-         rt.join();</span>
<span class="udiff-line-modified-added">+         synchronized void close() throws IOException {</span>
<span class="udiff-line-modified-added">+             if (!isDone) {</span>
<span class="udiff-line-modified-added">+                 isDone = true;</span>
<span class="udiff-line-modified-added">+                 ss.close();</span>
<span class="udiff-line-modified-added">+                 for (ServerThread st : threads) {</span>
<span class="udiff-line-modified-added">+                     st.close();</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static EchoServer instance = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static synchronized EchoServer startServer(int size, boolean timeout) throws IOException {</span>
<span class="udiff-line-added">+             if (instance == null) {</span>
<span class="udiff-line-added">+                 CountDownLatch started = new CountDownLatch(1);</span>
<span class="udiff-line-added">+                 EchoServer s = new EchoServer(started, size, timeout);</span>
<span class="udiff-line-added">+                 new Thread(s).start();</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     started.await(); // wait until server thread started</span>
<span class="udiff-line-added">+                 } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+                     e.printStackTrace();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 instance = s;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return instance;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static class ServerThread implements Runnable {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             final Socket s;</span>
<span class="udiff-line-added">+             final InputStream in;</span>
<span class="udiff-line-added">+             final OutputStream out;</span>
<span class="udiff-line-added">+             final int size;</span>
<span class="udiff-line-added">+             volatile boolean isDone = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             ServerThread(Socket s, int size) throws IOException {</span>
<span class="udiff-line-added">+                 this.s = s;</span>
<span class="udiff-line-added">+                 this.size = size;</span>
<span class="udiff-line-added">+                 in = s.getInputStream();</span>
<span class="udiff-line-added">+                 out = s.getOutputStream();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             @Override</span>
<span class="udiff-line-added">+             public void run() {</span>
<span class="udiff-line-added">+                 byte[] a = new byte[size];</span>
<span class="udiff-line-added">+                 while (!isDone) {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         readN(a, size, this.in);</span>
<span class="udiff-line-added">+                         out.write(a);</span>
<span class="udiff-line-added">+                     } catch (IOException e) {</span>
<span class="udiff-line-added">+                         if (!isDone) {</span>
<span class="udiff-line-added">+                             e.printStackTrace();</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             public void close() throws IOException {</span>
<span class="udiff-line-added">+                 isDone = true;</span>
<span class="udiff-line-added">+                 s.close();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         }</span>
      }
  
<span class="udiff-line-modified-removed">-     @Benchmark</span>
<span class="udiff-line-modified-removed">-     public void test() throws IOException {</span>
<span class="udiff-line-modified-removed">-         os.write((byte) 4711);</span>
<span class="udiff-line-modified-added">+     static void readN(byte[] array, int size, InputStream in) throws IOException {</span>
<span class="udiff-line-modified-added">+         int nread = 0;</span>
<span class="udiff-line-modified-added">+         while (size &gt; 0) {</span>
<span class="udiff-line-added">+             int n = in.read(array, nread, size);</span>
<span class="udiff-line-added">+             if (n &lt; 0) throw new RuntimeException();</span>
<span class="udiff-line-added">+             nread += n;</span>
<span class="udiff-line-added">+             size -= n;</span>
<span class="udiff-line-added">+         }</span>
      }
  
<span class="udiff-line-modified-removed">-     static class ReadThread extends Thread {</span>
<span class="udiff-line-removed">-         private InputStream is;</span>
<span class="udiff-line-modified-added">+     EchoServer server;</span>
  
<span class="udiff-line-modified-removed">-         public ReadThread(InputStream is) {</span>
<span class="udiff-line-modified-removed">-             this.is = is;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     @Param({&quot;1&quot;, &quot;1024&quot;, &quot;8192&quot;, &quot;64000&quot;, &quot;128000&quot;})</span>
<span class="udiff-line-modified-added">+     public int size;</span>
  
<span class="udiff-line-modified-removed">-         public void run() {</span>
<span class="udiff-line-modified-removed">-             try {</span>
<span class="udiff-line-modified-removed">-                 while (is.read() &gt; 0);</span>
<span class="udiff-line-modified-removed">-             } catch (SocketException ex) {</span>
<span class="udiff-line-modified-removed">-                 // ignore - most likely &quot;socket closed&quot;, which means shutdown</span>
<span class="udiff-line-modified-removed">-             } catch (IOException e) {</span>
<span class="udiff-line-modified-removed">-                 e.printStackTrace();</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+     @Param({&quot;false&quot;, &quot;true&quot;})</span>
<span class="udiff-line-modified-added">+     public boolean timeout;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     Socket s;</span>
<span class="udiff-line-modified-added">+     InputStream in;</span>
<span class="udiff-line-modified-added">+     OutputStream out;</span>
<span class="udiff-line-modified-added">+     byte[] array;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     @Setup</span>
<span class="udiff-line-added">+     public void setup() throws IOException {</span>
<span class="udiff-line-added">+         server = EchoServer.startServer(size, timeout);</span>
<span class="udiff-line-added">+         int port = server.port;</span>
<span class="udiff-line-added">+         s = new Socket(address, port);</span>
<span class="udiff-line-added">+         s.setTcpNoDelay(true);</span>
<span class="udiff-line-added">+         if (timeout) {</span>
<span class="udiff-line-added">+             s.setSoTimeout(TIMEOUT);</span>
<span class="udiff-line-added">+             // 10 seconds times is quite large and never will happen (for microbenchmarking),</span>
<span class="udiff-line-added">+             // but it&#39;s required since other paths inside SocketImpl are involved</span>
          }
<span class="udiff-line-added">+         in = s.getInputStream();</span>
<span class="udiff-line-added">+         out = s.getOutputStream();</span>
<span class="udiff-line-added">+         array = new byte[size];</span>
<span class="udiff-line-added">+         ThreadLocalRandom.current().nextBytes(array);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @TearDown</span>
<span class="udiff-line-added">+     public void tearDown() throws IOException {</span>
<span class="udiff-line-added">+         server.close();</span>
<span class="udiff-line-added">+         s.close();</span>
      }
  
<span class="udiff-line-added">+     @Benchmark</span>
<span class="udiff-line-added">+     public void echo() throws IOException {</span>
<span class="udiff-line-added">+         out.write(array);</span>
<span class="udiff-line-added">+         readN(array, size, in);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="SocketChannelReadWrite.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketStreaming.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>