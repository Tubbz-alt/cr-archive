<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/micro/org/openjdk/bench/java/util/ImmutableColls.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.bench.java.util;
 24 
 25 import org.openjdk.jmh.annotations.*;
 26 import org.openjdk.jmh.infra.Blackhole;
 27 
 28 import java.util.*;
 29 import java.util.concurrent.TimeUnit;
 30 
 31 /**
 32  * Micros for the various collections implemented in
 33  * java.util.ImmutableCollections
 34  */
 35 @State(Scope.Benchmark)
 36 @OutputTimeUnit(TimeUnit.MICROSECONDS)
<a name="2" id="anc2"></a><span class="line-added"> 37 @Fork(value = 3)</span>
<span class="line-added"> 38 @Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span>
<span class="line-added"> 39 @Measurement(iterations = 5, time = 2, timeUnit = TimeUnit.SECONDS)</span>
 40 public class ImmutableColls {
 41 
 42     public static String[] STRINGS = {&quot;hi&quot;, &quot;all&quot;, &quot;of&quot;, &quot;you&quot;};
 43 
 44     public static List&lt;String&gt; l0 = List.of();
 45     public static List&lt;String&gt; l1 = List.of(Arrays.copyOf(STRINGS, 1));
 46     public static List&lt;String&gt; l2 = List.of(Arrays.copyOf(STRINGS, 2));
 47     public static List&lt;String&gt; l3 = List.of(Arrays.copyOf(STRINGS, 3));
 48     public static List&lt;String&gt; l4 = List.of(Arrays.copyOf(STRINGS, 4));
 49 
 50     public static Set&lt;String&gt; s0 = Set.copyOf(l0);
 51     public static Set&lt;String&gt; s1 = Set.copyOf(l1);
 52     public static Set&lt;String&gt; s2 = Set.copyOf(l2);
 53     public static Set&lt;String&gt; s3 = Set.copyOf(l3);
 54     public static Set&lt;String&gt; s4 = Set.copyOf(l4);
 55 
 56     public static Map&lt;String, String&gt; m0 = Map.of();
 57     public static Map&lt;String, String&gt; m1 = Map.of(STRINGS[0], STRINGS[0]);
 58     public static Map&lt;String, String&gt; m2 = Map.of(STRINGS[0], STRINGS[0],
 59                                                   STRINGS[1], STRINGS[1]);
 60     public static Map&lt;String, String&gt; m3 = Map.of(STRINGS[0], STRINGS[0],
 61                                                   STRINGS[1], STRINGS[1],
 62                                                   STRINGS[2], STRINGS[2]);
 63     public static Map&lt;String, String&gt; m4 = Map.of(STRINGS[0], STRINGS[0],
 64                                                   STRINGS[1], STRINGS[1],
 65                                                   STRINGS[2], STRINGS[2],
 66                                                   STRINGS[3], STRINGS[3]);
 67 
 68     public static List&lt;String&gt; a0 = new ArrayList&lt;&gt;(l0);
 69     public static List&lt;String&gt; a1 = new ArrayList&lt;&gt;(l1);
 70     public static List&lt;String&gt; a2 = new ArrayList&lt;&gt;(l2);
 71     public static List&lt;String&gt; a3 = new ArrayList&lt;&gt;(l3);
 72     public static List&lt;String&gt; a4 = new ArrayList&lt;&gt;(l4);
 73 
 74     public static final List&lt;String&gt; fl0 = List.of();
 75     public static final List&lt;String&gt; fl1 = List.copyOf(l1);
 76     public static final List&lt;String&gt; fl2 = List.copyOf(l2);
 77     public static final List&lt;String&gt; fl3 = List.copyOf(l3);
 78     public static final List&lt;String&gt; fl4 = List.copyOf(l4);
 79 
 80     public static final List&lt;String&gt; fsl0 = fl0.subList(0, 0);
 81     public static final List&lt;String&gt; fsl1 = fl2.subList(1, 2);
 82     public static final List&lt;String&gt; fsl2 = fl3.subList(0, 2);
 83     public static final List&lt;String&gt; fsl3 = fl4.subList(0, 3);
 84 
 85     public static final Set&lt;String&gt; fs0 = Set.copyOf(l0);
 86     public static final Set&lt;String&gt; fs1 = Set.copyOf(l1);
 87     public static final Set&lt;String&gt; fs2 = Set.copyOf(l2);
 88     public static final Set&lt;String&gt; fs3 = Set.copyOf(l3);
 89     public static final Set&lt;String&gt; fs4 = Set.copyOf(l4);
 90 
 91     public static final Map&lt;String, String&gt; fm0 = Map.copyOf(m0);
 92     public static final Map&lt;String, String&gt; fm1 = Map.copyOf(m1);
 93     public static final Map&lt;String, String&gt; fm2 = Map.copyOf(m2);
 94     public static final Map&lt;String, String&gt; fm3 = Map.copyOf(m3);
 95     public static final Map&lt;String, String&gt; fm4 = Map.copyOf(m4);
 96 
<a name="3" id="anc3"></a><span class="line-modified"> 97     @Benchmark</span>
<span class="line-modified"> 98     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-modified"> 99     public void constructLists(Blackhole bh) {</span>
<span class="line-modified">100         bh.consume(List.of(STRINGS[0]));</span>
<span class="line-modified">101         bh.consume(List.of(STRINGS[0], STRINGS[1]));</span>
<span class="line-added">102         bh.consume(List.of(STRINGS[0], STRINGS[1], STRINGS[2]));</span>
<span class="line-added">103     }</span>
<span class="line-added">104 </span>
<span class="line-added">105     @Benchmark</span>
<span class="line-added">106     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">107     public void constructSets(Blackhole bh) {</span>
<span class="line-added">108         bh.consume(Set.of(STRINGS[0]));</span>
<span class="line-added">109         bh.consume(Set.of(STRINGS[0], STRINGS[1]));</span>
<span class="line-added">110         bh.consume(Set.of(STRINGS[0], STRINGS[1], STRINGS[2]));</span>
<span class="line-added">111     }</span>
112 
113     @Benchmark
114     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
115     public int sumSizesList() {
116         return sizeOf(l0) +
117                 sizeOf(l1) +
118                 sizeOf(l2) +
119                 sizeOf(l3) +
120                 sizeOf(l4);
121     }
122 
123     @Benchmark
124     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
<a name="4" id="anc4"></a><span class="line-modified">125     public int sumSizesFinalList() {</span>
126         return sizeOf(fl0) +
127                 sizeOf(fl1) +
128                 sizeOf(fl2) +
129                 sizeOf(fl3) +
130                 sizeOf(fl4);
131     }
132 
133     @Benchmark
134     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
<a name="5" id="anc5"></a><span class="line-modified">135     public int sumSizesSet() {</span>
<span class="line-modified">136         return sizeOf(s0) +</span>
<span class="line-modified">137                 sizeOf(s1) +</span>
<span class="line-modified">138                 sizeOf(s2) +</span>
<span class="line-modified">139                 sizeOf(s3) +</span>
<span class="line-modified">140                 sizeOf(s4);</span>
141     }
142 
143     @Benchmark
144     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
<a name="6" id="anc6"></a><span class="line-modified">145     public int sumSizesFinalSet() {</span>
<span class="line-modified">146         return sizeOf2(fs0) +</span>
<span class="line-modified">147                 sizeOf2(fs1) +</span>
<span class="line-modified">148                 sizeOf2(fs2) +</span>
<span class="line-modified">149                 sizeOf2(fs3) +</span>
<span class="line-modified">150                 sizeOf2(fs4);</span>
151     }
152 
<a name="7" id="anc7"></a><span class="line-modified">153     @Benchmark</span>
<span class="line-modified">154     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">155     public boolean emptyFinalSet() {</span>
<span class="line-added">156         return fs0.isEmpty() &amp;</span>
<span class="line-added">157                 fs1.isEmpty() &amp;</span>
<span class="line-added">158                 fs2.isEmpty() &amp;</span>
<span class="line-added">159                 fs3.isEmpty() &amp;</span>
<span class="line-added">160                 fs4.isEmpty();</span>
<span class="line-added">161     }</span>
<span class="line-added">162 </span>
<span class="line-added">163     @Benchmark</span>
<span class="line-added">164     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">165     public boolean emptyFinalList() {</span>
<span class="line-added">166         return fl0.isEmpty() &amp;</span>
<span class="line-added">167                 fl1.isEmpty() &amp;</span>
<span class="line-added">168                 fl2.isEmpty() &amp;</span>
<span class="line-added">169                 fl3.isEmpty() &amp;</span>
<span class="line-added">170                 fl4.isEmpty();</span>
<span class="line-added">171     }</span>
<span class="line-added">172 </span>
<span class="line-added">173     @Benchmark</span>
<span class="line-added">174     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">175     public boolean emptyFinalMap() {</span>
<span class="line-added">176         return fm0.isEmpty() &amp;</span>
<span class="line-added">177                 fm1.isEmpty() &amp;</span>
<span class="line-added">178                 fm2.isEmpty() &amp;</span>
<span class="line-added">179                 fm3.isEmpty() &amp;</span>
<span class="line-added">180                 fm4.isEmpty();</span>
<span class="line-added">181     }</span>
<span class="line-added">182 </span>
<span class="line-added">183     @Benchmark</span>
<span class="line-added">184     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">185     public boolean containsFinalSet() {</span>
<span class="line-added">186         return fs0.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">187                 fs1.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">188                 fs2.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">189                 fs3.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">190                 fs4.contains(&quot;hi&quot;);</span>
<span class="line-added">191     }</span>
<span class="line-added">192 </span>
<span class="line-added">193     @Benchmark</span>
<span class="line-added">194     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">195     public boolean containsFinalList() {</span>
<span class="line-added">196         return fl0.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">197                 fl1.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">198                 fl2.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">199                 fl3.contains(&quot;hi&quot;) &amp;</span>
<span class="line-added">200                 fl4.contains(&quot;hi&quot;);</span>
<span class="line-added">201     }</span>
<span class="line-added">202 </span>
<span class="line-added">203     @Benchmark</span>
<span class="line-added">204     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">205     public boolean containsKeyFinalMap() {</span>
<span class="line-added">206         return fm0.containsKey(&quot;hi&quot;) &amp;</span>
<span class="line-added">207                 fm1.containsKey(&quot;hi&quot;) &amp;</span>
<span class="line-added">208                 fm2.containsKey(&quot;hi&quot;) &amp;</span>
<span class="line-added">209                 fm3.containsKey(&quot;hi&quot;) &amp;</span>
<span class="line-added">210                 fm4.containsKey(&quot;hi&quot;);</span>
<span class="line-added">211     }</span>
<span class="line-added">212 </span>
<span class="line-added">213     @Benchmark</span>
<span class="line-added">214     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">215     public boolean containsValueFinalMap() {</span>
<span class="line-added">216         return fm0.containsValue(&quot;hi&quot;) &amp;</span>
<span class="line-added">217                 fm1.containsValue(&quot;hi&quot;) &amp;</span>
<span class="line-added">218                 fm2.containsValue(&quot;hi&quot;) &amp;</span>
<span class="line-added">219                 fm3.containsValue(&quot;hi&quot;) &amp;</span>
<span class="line-added">220                 fm4.containsValue(&quot;hi&quot;);</span>
<span class="line-added">221     }</span>
<span class="line-added">222 </span>
<span class="line-added">223     @Benchmark</span>
<span class="line-added">224     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">225     public void getOrDefault(Blackhole bh) {</span>
<span class="line-added">226         bh.consume(fm4.getOrDefault(&quot;hi&quot;, &quot;test&quot;));</span>
<span class="line-added">227         bh.consume(fm4.getOrDefault(&quot;not_in_this_map&quot;, &quot;test&quot;));</span>
228     }
229 
230     public int sizeOf(List&lt;String&gt; list) {
231         return list.size();
232     }
233 
<a name="8" id="anc8"></a><span class="line-added">234     /**</span>
<span class="line-added">235      * Same as sizeOf(List), but duplicated to avoid any</span>
<span class="line-added">236      * potential profile pollution with tests using</span>
<span class="line-added">237      * sizeOf.</span>
<span class="line-added">238      */</span>
<span class="line-added">239     public int sizeOf2(List&lt;String&gt; list) {</span>
<span class="line-added">240         return list.size();</span>
<span class="line-added">241     }</span>
<span class="line-added">242 </span>
<span class="line-added">243     public int sizeOf(Set&lt;String&gt; set) {</span>
<span class="line-added">244         return set.size();</span>
<span class="line-added">245     }</span>
<span class="line-added">246 </span>
<span class="line-added">247     /**</span>
<span class="line-added">248      * Same as sizeOf(Set), but duplicated to avoid any</span>
<span class="line-added">249      * potential profile pollution with tests using</span>
<span class="line-added">250      * sizeOf.</span>
<span class="line-added">251      */</span>
<span class="line-added">252     public int sizeOf2(Set&lt;String&gt; set) {</span>
<span class="line-added">253         return set.size();</span>
<span class="line-added">254     }</span>
<span class="line-added">255 </span>
256     @Benchmark
257     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
258     public int getFromList() {
259         return get(l1, 0).length() +
260                 get(l2, 1).length() +
261                 get(l3, 2).length() +
262                 get(l4, 3).length();
263     }
264 
265     @Benchmark
266     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
267     public int finalGetFromList() {
268         return get(fl1, 0).length() +
269                 get(fl2, 1).length() +
270                 get(fl3, 2).length() +
271                 get(fl4, 3).length();
272     }
273 
274     @Benchmark
275     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
276     public void toArrayFromSet(Blackhole bh) {
277         bh.consume(fs4.toArray());
278         bh.consume(s1.toArray());
279         bh.consume(s3.toArray());
280         bh.consume(fs2.toArray());
281         bh.consume(s0.toArray());
282     }
283 
<a name="9" id="anc9"></a><span class="line-added">284     @Benchmark</span>
<span class="line-added">285     @CompilerControl(CompilerControl.Mode.DONT_INLINE)</span>
<span class="line-added">286     public void iterateOverSet(Blackhole bh) {</span>
<span class="line-added">287         iterateSet(bh, fs4);</span>
<span class="line-added">288         iterateSet(bh, s1);</span>
<span class="line-added">289         iterateSet(bh, s3);</span>
<span class="line-added">290         iterateSet(bh, fs2);</span>
<span class="line-added">291         iterateSet(bh, s0);</span>
<span class="line-added">292     }</span>
<span class="line-added">293 </span>
<span class="line-added">294     public void iterateSet(Blackhole bh, Set&lt;String&gt; coll) {</span>
<span class="line-added">295         for (String s : coll) {</span>
<span class="line-added">296             bh.consume(s);</span>
<span class="line-added">297         }</span>
<span class="line-added">298     }</span>
<span class="line-added">299 </span>
300     @Benchmark
301     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
302     public void toArrayFromMap(Blackhole bh) {
303         bh.consume(fm4.entrySet().toArray());
304         bh.consume(m1.entrySet().toArray());
305         bh.consume(m3.entrySet().toArray());
306         bh.consume(fm2.entrySet().toArray());
307         bh.consume(m0.entrySet().toArray());
308     }
309 
310     @Benchmark
311     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
312     public void toArrayFromList(Blackhole bh) {
313         bh.consume(fl4.toArray());
314         bh.consume(fl1.toArray());
315         bh.consume(l3.toArray());
316         bh.consume(l0.toArray());
317         bh.consume(fsl3.toArray());
318     }
319 
320     @Benchmark
321     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
322     public void toTypedArrayFromSet(Blackhole bh) {
323         bh.consume(fs4.toArray(new String[0]));
324         bh.consume(s1.toArray(new String[0]));
325         bh.consume(s3.toArray(new String[0]));
326         bh.consume(fs2.toArray(new String[0]));
327         bh.consume(s0.toArray(new String[0]));
328     }
329 
330     @Benchmark
331     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
332     public void toTypedArrayFromMap(Blackhole bh) {
333         bh.consume(fm4.entrySet().toArray(new Map.Entry[0]));
334         bh.consume(m1.entrySet().toArray(new Map.Entry[0]));
335         bh.consume(m3.entrySet().toArray(new Map.Entry[0]));
336         bh.consume(fm2.entrySet().toArray(new Map.Entry[0]));
337         bh.consume(m0.entrySet().toArray(new Map.Entry[0]));
338     }
339 
340     @Benchmark
341     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
342     public void toTypedArrayFromList(Blackhole bh) {
343         bh.consume(fl4.toArray(new String[0]));
344         bh.consume(fl1.toArray(new String[0]));
345         bh.consume(l3.toArray(new String[0]));
346         bh.consume(l0.toArray(new String[0]));
347         bh.consume(fsl3.toArray(new String[0]));
348     }
349 
350     @Benchmark
351     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
352     public void copyOfLists(Blackhole bh) {
353         bh.consume(List.copyOf(fl1));
354         bh.consume(List.copyOf(fl4));
355         bh.consume(List.copyOf(fsl2));
356         bh.consume(List.copyOf(fsl3));
357     }
358 
<a name="10" id="anc10"></a>








359     public String get2(List&lt;String&gt; list, int idx) {
360         return list.get(idx);
361     }
362 
363     public String get(List&lt;String&gt; list, int idx) {
364         return list.get(idx);
365     }
366 
367     @Benchmark
368     @CompilerControl(CompilerControl.Mode.DONT_INLINE)
369     public Set&lt;String&gt; createSetOf() {
370         return Set.of(STRINGS);
371     }
372 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>