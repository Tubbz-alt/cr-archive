<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/jdk/jfr/jmx/TestRecordingOptions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.jmx;
 27 
<a name="1" id="anc1"></a><span class="line-added"> 28 import java.io.File;</span>
 29 import java.util.HashMap;
 30 import java.util.LinkedHashMap;
 31 import java.util.Map;
 32 
 33 import jdk.management.jfr.FlightRecorderMXBean;
 34 import jdk.test.lib.Asserts;
 35 
 36 /**
 37  * @test
 38  * @key jfr
 39  * @requires vm.hasJFR
 40  * @library /test/lib /test/jdk
 41  * @run main/othervm jdk.jfr.jmx.TestRecordingOptions
 42  */
 43 public class TestRecordingOptions {
 44     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
 45     public static void main(String[] args) throws Exception {
 46         Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
 47         options.put(&quot;name&quot;, &quot;myName&quot;);
 48         options.put(&quot;maxAge&quot;, &quot;2 h&quot;);
 49         options.put(&quot;maxSize&quot;, &quot;1234567890&quot;);
 50         options.put(&quot;dumpOnExit&quot;, &quot;false&quot;);
 51         options.put(&quot;disk&quot;, &quot;false&quot;);
 52         options.put(&quot;duration&quot;, &quot;1 h&quot;); // don&#39;t want recording to stop
<a name="2" id="anc2"></a><span class="line-modified"> 53         options.put(&quot;destination&quot;, &quot;.&quot; + File.separator + &quot;dump.jfr&quot;);</span>
 54         FlightRecorderMXBean bean = JmxHelper.getFlighteRecorderMXBean();
 55         long recId = bean.newRecording();
 56         Map&lt;String, String&gt; defaults = bean.getRecordingOptions(recId);
 57         bean.setRecordingOptions(recId, options);
 58 
 59         // Verify that all options have been set. We only check the option we
 60         // have set. Unknown options are ignored.
 61         Map&lt;String, String&gt; outOptions = bean.getRecordingOptions(recId);
 62         logMap(&quot;set options&quot;, options);
 63         logMap(&quot;get options&quot;, outOptions);
 64         for (String key : options.keySet()) {
 65             Asserts.assertTrue(outOptions.containsKey(key), &quot;Missing key &quot; + key);
 66             Asserts.assertEquals(options.get(key), outOptions.get(key), &quot;Wrong value for key &quot; + key);
 67         }
 68 
 69         // Verify options in RecordingInfo
 70         Asserts.assertEquals(outOptions.get(&quot;name&quot;), &quot;myName&quot;, &quot;Wrong name&quot;);
 71         Asserts.assertEquals(outOptions.get(&quot;maxAge&quot;), &quot;2 h&quot;, &quot;Wrong maxAge&quot;);
 72         Asserts.assertEquals(outOptions.get(&quot;maxSize&quot;), &quot;1234567890&quot;, &quot;Wrong maxSize&quot;);
 73         Asserts.assertEquals(outOptions.get(&quot;dumpOnExit&quot;), &quot;false&quot;, &quot;Wrong dumpOnExit&quot;);
 74         Asserts.assertEquals(outOptions.get(&quot;disk&quot;), &quot;false&quot;, &quot;Wrong disk&quot;);
 75         Asserts.assertEquals(outOptions.get(&quot;duration&quot;), &quot;1 h&quot;, &quot;Wrong duration&quot;);
<a name="3" id="anc3"></a><span class="line-added"> 76         Asserts.assertEquals(outOptions.get(&quot;destination&quot;), &quot;.&quot; + File.separator + &quot;dump.jfr&quot;, &quot;Wrong destination&quot;);</span>
 77 
 78         // try empty map
 79         bean.setRecordingOptions(recId, new HashMap&lt;&gt;());
 80 
 81         // try map that does not have string keys
 82         Map&lt;Integer, String&gt; invalidKeys = new HashMap&lt;&gt;();
 83         invalidKeys.put(4711, &quot;value&quot;);
 84         try {
 85             bean.setRecordingOptions(recId, (Map) invalidKeys);
 86             throw new Error(&quot;Expected IllagalStateException for non String key&quot;);
 87         } catch (IllegalArgumentException iae) {
 88             // OK, as expected
 89         }
 90         // try map that does not have string values
 91         Map&lt;String, Integer&gt; invalidValues = new HashMap&lt;&gt;();
 92         invalidValues.put(&quot;duration&quot;, 4711);
 93         try {
 94             bean.setRecordingOptions(recId, (Map) invalidKeys);
 95             throw new Error(&quot;Expected IllagalStateException for non String value&quot;);
 96         } catch (IllegalArgumentException iae) {
 97             // OK, as expected
 98         }
 99 
100         // Try one incorrect value, and make sure non
101         // of the other values are set.
102         Map&lt;String, String&gt; lastIncorrect = new LinkedHashMap&lt;&gt;();
103         lastIncorrect.put(&quot;duration&quot;, &quot;10 h&quot;);
104         lastIncorrect.put(&quot;whatever&quot;, &quot;4711&quot;);
105         try {
106             bean.setRecordingOptions(recId, lastIncorrect);
107             throw new Error(&quot;Expected IllagalStateException for incorrect key&quot;);
108         } catch (IllegalArgumentException iae) {
109             // ok
110             Asserts.assertEquals(&quot;1 h&quot;, bean.getRecordingOptions(recId).get(&quot;duration&quot;));
111         }
112 
113         // verify that defaults are set back, if we use null
114         Map&lt;String, String&gt; nullMap = new HashMap&lt;&gt;();
115         nullMap.put(&quot;name&quot;, null);
116         nullMap.put(&quot;maxAge&quot;, null);
117         nullMap.put(&quot;maxSize&quot;, null);
118         nullMap.put(&quot;dumpOnExit&quot;, null);
119         nullMap.put(&quot;disk&quot;, null);
120         nullMap.put(&quot;duration&quot;, null);
<a name="4" id="anc4"></a><span class="line-added">121         nullMap.put(&quot;destination&quot;, null);</span>
122         bean.setRecordingOptions(recId, nullMap);
123         Asserts.assertEquals(bean.getRecordingOptions(recId), defaults);
124 
125         bean.closeRecording(recId);
126     }
127 
128     private static void logMap(String name, Map&lt;String, String&gt; map) {
129         for (String key : map.keySet()) {
130             System.out.printf(&quot;%s: %s=%s%n&quot;, name, key, map.get(key));
131         }
132     }
133 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>