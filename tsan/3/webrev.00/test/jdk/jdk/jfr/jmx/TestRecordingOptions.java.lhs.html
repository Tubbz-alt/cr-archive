<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/jdk/jfr/jmx/TestRecordingOptions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.jmx;
 27 
<a name="1" id="anc1"></a>
 28 import java.util.HashMap;
 29 import java.util.LinkedHashMap;
 30 import java.util.Map;
 31 
 32 import jdk.management.jfr.FlightRecorderMXBean;
 33 import jdk.test.lib.Asserts;
 34 
 35 /**
 36  * @test
 37  * @key jfr
 38  * @requires vm.hasJFR
 39  * @library /test/lib /test/jdk
 40  * @run main/othervm jdk.jfr.jmx.TestRecordingOptions
 41  */
 42 public class TestRecordingOptions {
 43     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
 44     public static void main(String[] args) throws Exception {
 45         Map&lt;String, String&gt; options = new HashMap&lt;&gt;();
 46         options.put(&quot;name&quot;, &quot;myName&quot;);
 47         options.put(&quot;maxAge&quot;, &quot;2 h&quot;);
 48         options.put(&quot;maxSize&quot;, &quot;1234567890&quot;);
 49         options.put(&quot;dumpOnExit&quot;, &quot;false&quot;);
 50         options.put(&quot;disk&quot;, &quot;false&quot;);
 51         options.put(&quot;duration&quot;, &quot;1 h&quot;); // don&#39;t want recording to stop
<a name="2" id="anc2"></a><span class="line-modified"> 52 </span>
 53         FlightRecorderMXBean bean = JmxHelper.getFlighteRecorderMXBean();
 54         long recId = bean.newRecording();
 55         Map&lt;String, String&gt; defaults = bean.getRecordingOptions(recId);
 56         bean.setRecordingOptions(recId, options);
 57 
 58         // Verify that all options have been set. We only check the option we
 59         // have set. Unknown options are ignored.
 60         Map&lt;String, String&gt; outOptions = bean.getRecordingOptions(recId);
 61         logMap(&quot;set options&quot;, options);
 62         logMap(&quot;get options&quot;, outOptions);
 63         for (String key : options.keySet()) {
 64             Asserts.assertTrue(outOptions.containsKey(key), &quot;Missing key &quot; + key);
 65             Asserts.assertEquals(options.get(key), outOptions.get(key), &quot;Wrong value for key &quot; + key);
 66         }
 67 
 68         // Verify options in RecordingInfo
 69         Asserts.assertEquals(outOptions.get(&quot;name&quot;), &quot;myName&quot;, &quot;Wrong name&quot;);
 70         Asserts.assertEquals(outOptions.get(&quot;maxAge&quot;), &quot;2 h&quot;, &quot;Wrong maxAge&quot;);
 71         Asserts.assertEquals(outOptions.get(&quot;maxSize&quot;), &quot;1234567890&quot;, &quot;Wrong maxSize&quot;);
 72         Asserts.assertEquals(outOptions.get(&quot;dumpOnExit&quot;), &quot;false&quot;, &quot;Wrong dumpOnExit&quot;);
 73         Asserts.assertEquals(outOptions.get(&quot;disk&quot;), &quot;false&quot;, &quot;Wrong disk&quot;);
 74         Asserts.assertEquals(outOptions.get(&quot;duration&quot;), &quot;1 h&quot;, &quot;Wrong duration&quot;);
<a name="3" id="anc3"></a>
 75 
 76         // try empty map
 77         bean.setRecordingOptions(recId, new HashMap&lt;&gt;());
 78 
 79         // try map that does not have string keys
 80         Map&lt;Integer, String&gt; invalidKeys = new HashMap&lt;&gt;();
 81         invalidKeys.put(4711, &quot;value&quot;);
 82         try {
 83             bean.setRecordingOptions(recId, (Map) invalidKeys);
 84             throw new Error(&quot;Expected IllagalStateException for non String key&quot;);
 85         } catch (IllegalArgumentException iae) {
 86             // OK, as expected
 87         }
 88         // try map that does not have string values
 89         Map&lt;String, Integer&gt; invalidValues = new HashMap&lt;&gt;();
 90         invalidValues.put(&quot;duration&quot;, 4711);
 91         try {
 92             bean.setRecordingOptions(recId, (Map) invalidKeys);
 93             throw new Error(&quot;Expected IllagalStateException for non String value&quot;);
 94         } catch (IllegalArgumentException iae) {
 95             // OK, as expected
 96         }
 97 
 98         // Try one incorrect value, and make sure non
 99         // of the other values are set.
100         Map&lt;String, String&gt; lastIncorrect = new LinkedHashMap&lt;&gt;();
101         lastIncorrect.put(&quot;duration&quot;, &quot;10 h&quot;);
102         lastIncorrect.put(&quot;whatever&quot;, &quot;4711&quot;);
103         try {
104             bean.setRecordingOptions(recId, lastIncorrect);
105             throw new Error(&quot;Expected IllagalStateException for incorrect key&quot;);
106         } catch (IllegalArgumentException iae) {
107             // ok
108             Asserts.assertEquals(&quot;1 h&quot;, bean.getRecordingOptions(recId).get(&quot;duration&quot;));
109         }
110 
111         // verify that defaults are set back, if we use null
112         Map&lt;String, String&gt; nullMap = new HashMap&lt;&gt;();
113         nullMap.put(&quot;name&quot;, null);
114         nullMap.put(&quot;maxAge&quot;, null);
115         nullMap.put(&quot;maxSize&quot;, null);
116         nullMap.put(&quot;dumpOnExit&quot;, null);
117         nullMap.put(&quot;disk&quot;, null);
118         nullMap.put(&quot;duration&quot;, null);
<a name="4" id="anc4"></a>
119         bean.setRecordingOptions(recId, nullMap);
120         Asserts.assertEquals(bean.getRecordingOptions(recId), defaults);
121 
122         bean.closeRecording(recId);
123     }
124 
125     private static void logMap(String name, Map&lt;String, String&gt; map) {
126         for (String key : map.keySet()) {
127             System.out.printf(&quot;%s: %s=%s%n&quot;, name, key, map.get(key));
128         }
129     }
130 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>