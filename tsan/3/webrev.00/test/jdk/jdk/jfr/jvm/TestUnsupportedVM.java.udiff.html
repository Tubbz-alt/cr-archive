<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/jdk/jfr/jvm/TestUnsupportedVM.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestJavaEvent.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestPrint.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/jvm/TestUnsupportedVM.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,12 +28,14 @@</span>
  import java.io.FileReader;
  import java.io.IOException;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.nio.file.Paths;
<span class="udiff-line-added">+ import java.time.Duration;</span>
  import java.util.ArrayList;
  import java.util.concurrent.Callable;
<span class="udiff-line-added">+ import java.util.concurrent.atomic.AtomicBoolean;</span>
  
  import jdk.jfr.AnnotationElement;
  import jdk.jfr.Configuration;
  import jdk.jfr.Description;
  import jdk.jfr.Event;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,19 +48,21 @@</span>
  import jdk.jfr.Label;
  import jdk.jfr.Recording;
  import jdk.jfr.RecordingState;
  import jdk.jfr.SettingControl;
  import jdk.jfr.ValueDescriptor;
<span class="udiff-line-added">+ import jdk.jfr.consumer.EventStream;</span>
  import jdk.jfr.consumer.RecordedClass;
  import jdk.jfr.consumer.RecordedEvent;
  import jdk.jfr.consumer.RecordedFrame;
  import jdk.jfr.consumer.RecordedMethod;
  import jdk.jfr.consumer.RecordedObject;
  import jdk.jfr.consumer.RecordedStackTrace;
  import jdk.jfr.consumer.RecordedThread;
  import jdk.jfr.consumer.RecordedThreadGroup;
  import jdk.jfr.consumer.RecordingFile;
<span class="udiff-line-added">+ import jdk.jfr.consumer.RecordingStream;</span>
  import jdk.management.jfr.ConfigurationInfo;
  import jdk.management.jfr.EventTypeInfo;
  import jdk.management.jfr.FlightRecorderMXBean;
  import jdk.management.jfr.RecordingInfo;
  import jdk.management.jfr.SettingDescriptorInfo;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,13 +108,15 @@</span>
              RecordingFile.class,
              RecordingInfo.class,
              RecordingState.class,
              SettingControl.class,
              SettingDescriptorInfo.class,
<span class="udiff-line-modified-removed">-             ValueDescriptor.class</span>
<span class="udiff-line-modified-added">+             ValueDescriptor.class,</span>
<span class="udiff-line-added">+             EventStream.class,</span>
<span class="udiff-line-added">+             RecordingStream.class</span>
         };
<span class="udiff-line-modified-removed">-     // * @run main/othervm -Dprepare-recording=true jdk.jfr.jvm.TestUnsupportedVM</span>
<span class="udiff-line-modified-added">+ </span>
      @Label(&quot;My Event&quot;)
      @Description(&quot;My fine event&quot;)
      static class MyEvent extends Event {
          int myValue;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,21 +129,22 @@</span>
              r.dump(RECORDING_FILE);
              r.close();
              return;
          }
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;jdk.jfr.unsupportedvm=&quot; + System.getProperty(&quot;jdk.jfr.unsupportedvm&quot;));</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;jfr.unsupported.vm=&quot; + System.getProperty(&quot;jfr.unsupported.vm&quot;));</span>
          // Class FlightRecorder
          if (FlightRecorder.isAvailable()) {
              throw new AssertionError(&quot;JFR should not be available on an unsupported VM&quot;);
          }
  
          if (FlightRecorder.isInitialized()) {
              throw new AssertionError(&quot;JFR should not be initialized on an unsupported VM&quot;);
          }
  
          assertIllegalStateException(() -&gt; FlightRecorder.getFlightRecorder());
<span class="udiff-line-added">+         assertIllegalStateException(() -&gt; new RecordingStream());</span>
          assertSwallow(() -&gt; FlightRecorder.addListener(new FlightRecorderListener() {}));
          assertSwallow(() -&gt; FlightRecorder.removeListener(new FlightRecorderListener() {}));
          assertSwallow(() -&gt; FlightRecorder.register(MyEvent.class));
          assertSwallow(() -&gt; FlightRecorder.unregister(MyEvent.class));
          assertSwallow(() -&gt; FlightRecorder.addPeriodicEvent(MyEvent.class, new Runnable() { public void run() {} }));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -172,12 +179,43 @@</span>
  
          // jdk.jfr.consumer.*
          // Only run this part of tests if we are on VM
          // that can produce a recording file
          if (Files.exists(RECORDING_FILE)) {
<span class="udiff-line-added">+             boolean firstFileEvent = true;</span>
              for(RecordedEvent re : RecordingFile.readAllEvents(RECORDING_FILE)) {
<span class="udiff-line-modified-removed">-                 System.out.println(re);</span>
<span class="udiff-line-modified-added">+                 // Print one event</span>
<span class="udiff-line-added">+                 if (firstFileEvent) {</span>
<span class="udiff-line-added">+                     System.out.println(re);</span>
<span class="udiff-line-added">+                     firstFileEvent = false;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             AtomicBoolean firstStreamEvent = new AtomicBoolean(true);</span>
<span class="udiff-line-added">+             try (EventStream es = EventStream.openFile(RECORDING_FILE)) {</span>
<span class="udiff-line-added">+                 es.onEvent(e -&gt; {</span>
<span class="udiff-line-added">+                     // Print one event</span>
<span class="udiff-line-added">+                     if (firstStreamEvent.get()) {</span>
<span class="udiff-line-added">+                         try {</span>
<span class="udiff-line-added">+                             System.out.println(e);</span>
<span class="udiff-line-added">+                             firstStreamEvent.set(false);</span>
<span class="udiff-line-added">+                         } catch (Throwable t) {</span>
<span class="udiff-line-added">+                             t.printStackTrace();</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 });</span>
<span class="udiff-line-added">+                 es.start();</span>
<span class="udiff-line-added">+                 if (firstStreamEvent.get()) {</span>
<span class="udiff-line-added">+                     throw new AssertionError(&quot;Didn&#39;t print streaming event&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             try (EventStream es = EventStream.openRepository()) {</span>
<span class="udiff-line-added">+                 es.onEvent(e -&gt; {</span>
<span class="udiff-line-added">+                     System.out.println(e);</span>
<span class="udiff-line-added">+                 });</span>
<span class="udiff-line-added">+                 es.startAsync();</span>
<span class="udiff-line-added">+                 es.awaitTermination(Duration.ofMillis(10));</span>
              }
          }
      }
  
      private static void assertNoClassInitFailure(Class&lt;?&gt; clazz) {
</pre>
<center><a href="TestJavaEvent.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestPrint.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>