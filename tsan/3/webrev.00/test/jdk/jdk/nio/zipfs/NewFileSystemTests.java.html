<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/jdk/nio/zipfs/NewFileSystemTests.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import org.testng.annotations.AfterClass;
 25 import org.testng.annotations.BeforeClass;
 26 import org.testng.annotations.DataProvider;
 27 import org.testng.annotations.Test;
 28 
 29 import java.io.IOException;
 30 import java.net.URI;
 31 import java.nio.file.FileSystem;
 32 import java.nio.file.FileSystems;
 33 import java.nio.file.Files;
 34 import java.nio.file.Path;
 35 import java.util.Iterator;
 36 import java.util.Map;
 37 
 38 import static org.testng.Assert.*;
 39 
 40 /**
 41  * @test
 42  * @bug 8218875
 43  * @summary ZIP File System tests that leverage Files.newFileSystem
 44  * @modules jdk.zipfs
 45  * @compile NewFileSystemTests.java
 46  * @run testng NewFileSystemTests
 47  * @run testng/othervm/java.security.policy=test.policy  NewFileSystemTests
 48  */
 49 public class NewFileSystemTests {
 50 
 51     // The Zip file system scheme
 52     private static final String ZIPFS_SCHEME = &quot;jar&quot;;
 53     // Map to used for creating a ZIP archive
 54     private static final Map&lt;String, String&gt; ZIPFS_OPTIONS = Map.of(&quot;create&quot;, &quot;true&quot;);
 55     // Primary jar file used for testing
 56     private static Path jarFile;
 57     // URI for jar file used for testing
 58     private static URI jarURI;
 59 
 60     /**
 61      * Create the JAR file used by the tests
 62      */
 63     @BeforeClass
 64     public void setUp() throws Exception {
 65         jarFile = Utils.createJarFile(&quot;basic.jar&quot;,
 66                 &quot;README&quot;);
 67         jarURI = new URI(ZIPFS_SCHEME, jarFile.toUri().toString(), null);
 68 
 69     }
 70 
 71     /**
 72      * Remove JAR file used by test as part of clean-up
 73      */
 74     @AfterClass
 75     public void tearDown() throws Exception {
 76         Files.deleteIfExists(jarFile);
 77     }
 78 
 79     /**
 80      * Validate that {@code FileSystems.newFileSystem(Path, Map&lt;String, ?&gt;)}
 81      * will return a Zip file system
 82      *
 83      * @throws IOException
 84      */
 85     @Test
 86     public void testNewFileSystemPathMap() throws IOException {
 87         try (FileSystem zipfs = FileSystems.newFileSystem(Path.of(&quot;basic.jar&quot;),
 88                 ZIPFS_OPTIONS)) {
 89             checkFileSystem(zipfs);
 90         }
 91     }
 92 
 93     /**
 94      * Validate that {@code FileSystems.newFileSystem(Path)}
 95      * will return a Zip file system
 96      *
 97      * @throws IOException
 98      */
 99     @Test
100     public void testNewFileSystemPath() throws IOException {
101         try (FileSystem zipfs = FileSystems.newFileSystem(Path.of(&quot;basic.jar&quot;))) {
102             checkFileSystem(zipfs);
103         }
104     }
105 
106     /**
107      * Validate that {@code FileSystems.newFileSystem(Path, ClassLoader)}
108      * will return a Zip file system
109      *
110      * @throws IOException
111      */
112     @Test(dataProvider = &quot;classLoaders&quot;)
113     public void testNewFileSystemPathClassLoader(ClassLoader cl) throws Exception {
114         try (FileSystem zipfs = FileSystems.newFileSystem(Path.of(&quot;basic.jar&quot;),
115                 cl)) {
116             checkFileSystem(zipfs);
117         }
118     }
119 
120     /**
121      * Validate that {@code FileSystems.newFileSystem(Path, Map&lt;String, ?&gt;, ClassLoader)}
122      * will return a Zip file system
123      *
124      * @throws IOException
125      */
126     @Test(dataProvider = &quot;classLoaders&quot;)
127     public void testNewFileSystemPathMapClassLoader(ClassLoader cl) throws Exception {
128         try (FileSystem zipfs = FileSystems.newFileSystem(Path.of(&quot;basic.jar&quot;),
129                 ZIPFS_OPTIONS, cl)) {
130             checkFileSystem(zipfs);
131         }
132     }
133 
134     /**
135      * Validate that {@code FileSystems.newFileSystem(URI, Map&lt;String, ?&gt;)}
136      * will return a Zip file system
137      *
138      * @throws IOException
139      */
140     @Test
141     public void testNewFileSystemUriMap() throws Exception {
142         try (FileSystem zipfs = FileSystems.newFileSystem(jarURI, ZIPFS_OPTIONS)) {
143             checkFileSystem(zipfs);
144         }
145     }
146 
147     /**
148      * Validate that {@code FileSystems.newFileSystem(URI, Map&lt;String, ?&gt;, ClassLoader)}
149      * will return a Zip file system
150      *
151      * @throws IOException
152      */
153     @Test(dataProvider = &quot;classLoaders&quot;)
154     public void testNewFileSystemURIMapClassLoader(ClassLoader cl) throws Exception {
155         try (FileSystem zipfs = FileSystems.newFileSystem(jarURI, ZIPFS_OPTIONS,
156                 cl)) {
157             checkFileSystem(zipfs);
158         }
159     }
160 
161     /**
162      * Validate that {@code FileSystems.newFileSystem(Path, Map&lt;String, ?&gt;)}
163      * will throw a {@code NullPointerException} when the specified {@code Map}
164      * is null
165      *
166      */
167     @Test
168     public void testNewFileSystemPathNullMap() {
169         Map&lt;String, ?&gt; nullMap = null;
170         assertThrows(NullPointerException.class, () -&gt;
171                 FileSystems.newFileSystem(Path.of(&quot;basic.jar&quot;), nullMap));
172     }
173 
174     /*
175      * DataProvider used to verify that a Zip file system may be returned
176      * when specifying a class loader
177      */
178     @DataProvider(name = &quot;classLoaders&quot;)
179     private Object[][] classLoaders() {
180         return new Object[][]{
181                 {null},
182                 {ClassLoader.getSystemClassLoader()}
183         };
184     }
185 
186     /**
187      * Validate that the given FileSystem is a Zip file system.
188      *
189      * @param fs File System to validate
190      */
191     private void checkFileSystem(FileSystem fs) {
192 
193         assertNotNull(fs, &quot;Error: FileSystem was not returned&quot;);
194         assertTrue(fs.provider().getScheme().equalsIgnoreCase(ZIPFS_SCHEME));
195         assertTrue(fs.isOpen());
196         assertEquals(fs.getSeparator(), &quot;/&quot;);
197 
198         // one root
199         Iterator&lt;Path&gt; roots = fs.getRootDirectories().iterator();
200         assertTrue(roots.next().toString().equals(&quot;/&quot;));
201         assertFalse(roots.hasNext());
202     }
203 }
    </pre>
  </body>
</html>