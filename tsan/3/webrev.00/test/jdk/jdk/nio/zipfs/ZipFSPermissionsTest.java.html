<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/jdk/nio/zipfs/ZipFSPermissionsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 import org.testng.SkipException;
 26 import org.testng.annotations.*;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.FileSystem;
 30 import java.nio.file.FileSystems;
 31 import java.nio.file.Files;
 32 import java.nio.file.Path;
 33 import java.nio.file.attribute.PosixFileAttributeView;
 34 import java.nio.file.attribute.PosixFileAttributes;
 35 import java.nio.file.attribute.PosixFilePermission;
 36 import java.nio.file.attribute.PosixFilePermissions;
 37 import java.util.Map;
 38 import java.util.Set;
 39 
 40 import static java.nio.file.attribute.PosixFilePermission.*;
 41 import static org.testng.Assert.assertEquals;
 42 
 43 /**
 44  * @test
 45  * @bug 8229888
 46  * @summary Updating an existing zip file does not preserve original permissions
 47  * @library /test/lib
 48  * @modules jdk.zipfs
 49  * @run testng/othervm ZipFSPermissionsTest
 50  * @run testng/othervm/java.security.policy=ZipFSPermissionsTest.policy ZipFSPermissionsTest
 51  */
 52 public class ZipFSPermissionsTest {
 53 
 54     // Files used for testing
 55     private static final Path zipFile = Path.of(&quot;zipPermsTest.zip&quot;);
 56     private static final Path entry0 = Path.of(&quot;Entry-0.txt&quot;);
 57     // Path of 2nd file to add to the Zip file
 58     private static final Path entry1 = Path.of(&quot;Entry-1.txt&quot;);
 59 
 60     // Enable for permissions output
 61     private static final boolean DEBUG = false;
 62 
 63     /**
 64      * Create the files used by the test
 65      */
 66     @BeforeSuite
 67     public void setUp() throws Exception {
 68         boolean supportsPosix = FileSystems.getDefault()
 69                 .supportedFileAttributeViews().contains(&quot;posix&quot;);
 70 
 71         // Check to see if File System supports POSIX permissions
 72         if (supportsPosix) {
 73             System.out.println(&quot;File Store Supports Posix&quot;);
 74         } else {
 75             // As there is no POSIX permission support, skip running the test
 76             throw new SkipException(&quot;Cannot set permissions on this File Store&quot;);
 77         }
 78         Files.writeString(entry0, &quot;Tennis Pro&quot;);
 79         Files.writeString(entry1, &quot;Tennis is a lifetime sport!&quot;);
 80     }
 81 
 82     /**
 83      * Re-create the initial Zip file prior to each run.
 84      */
 85     @BeforeMethod
 86     public void before() throws Exception {
 87         Files.deleteIfExists(zipFile);
 88         zip(zipFile, Map.of(&quot;create&quot;, &quot;true&quot;), entry0);
 89     }
 90 
 91     /**
 92      * Remove Zip file used by test after each run.
 93      */
 94     @AfterMethod
 95     public void tearDown() throws Exception {
 96         Files.deleteIfExists(zipFile);
 97     }
 98 
 99     /**
100      * Remove files used by test as part of final test run clean-up
101      */
102     @AfterSuite
103     public void suiteCleanUp() throws Exception {
104         Files.deleteIfExists(zipFile);
105         Files.deleteIfExists(entry0);
106         Files.deleteIfExists(entry1);
107     }
108 
109     /**
110      * Validate that the Zip file permissions are as expected after updating the
111      * Zip file
112      * @param newPerms The permissions to set on the Zip File before updating the
113      *                 file
114      * @throws Exception If an error occurs
115      */
116     @Test(dataProvider = &quot;posixPermissions&quot;)
117     public void testZipPerms(Set&lt;PosixFilePermission&gt; newPerms) throws Exception {
118         if (DEBUG) {
119             System.out.printf(&quot;Test Run with perms= %s%n&quot;, newPerms);
120         }
121 
122         PosixFileAttributes attrs = getPosixAttributes(zipFile);
123 
124         // Permissions used to verify the results of updating the Zip file
125         if (newPerms == null) {
126             // Use current Zip File permissions;
127             newPerms = attrs.permissions();
128         }
129         displayPermissions(&quot;Original permissions&quot;, zipFile);
130 
131         // Now set the new permissions
132         Files.setPosixFilePermissions(zipFile, newPerms);
133         displayPermissions(&quot;Revised permissions&quot;, zipFile);
134 
135         // Update the Zip file
136         zip(zipFile, Map.of(), entry1);
137 
138         // Validate that the permissions are as expected after updating the
139         // Zip file
140         PosixFileAttributes afterAttrs = getPosixAttributes(zipFile);
141         displayPermissions(&quot;Permissions after updating the Zip File&quot;, zipFile);
142         assertEquals(afterAttrs.permissions(), newPerms,
143                 &quot;Permissions were not updated as expected!&quot;);
144     }
145 
146     /**
147      * Display the permissions for the specified Zip file when {@code DEBUG}
148      * is set to {@code true}
149      *
150      * @param msg     String to include in the message
151      * @param zipFile Path to the Zip File
152      * @throws IOException If an error occurs obtaining the permissions
153      */
154     public void displayPermissions(String msg, Path zipFile) throws IOException {
155         if (DEBUG) {
156             PosixFileAttributeView view = Files.getFileAttributeView(zipFile,
157                     PosixFileAttributeView.class);
158             if (view == null) {
159                 System.out.println(&quot;Could not obtain a PosixFileAttributeView!&quot;);
160                 return;
161             }
162             PosixFileAttributes attrs = view.readAttributes();
163             System.out.printf(&quot;%s: %s, Owner: %s, Group:%s, permissions: %s%n&quot;, msg,
164                     zipFile.getFileName(), attrs.owner().getName(),
165                     attrs.group().getName(), PosixFilePermissions.toString(attrs.permissions()));
166         }
167     }
168 
169     /**
170      * Create a Zip File System using the specified properties and a Zip file
171      * with the specified number of entries
172      *
173      * @param zipFile Path to the Zip File to create/update
174      * @param env     Properties used for creating the Zip Filesystem
175      * @param source  The path of the file to add to the Zip File
176      * @throws IOException If an error occurs while creating/updating the Zip file
177      */
178     public void zip(Path zipFile, Map&lt;String, String&gt; env, Path source) throws IOException {
179         if (DEBUG) {
180             System.out.printf(&quot;File:%s, adding:%s%n&quot;, zipFile.toAbsolutePath(), source);
181         }
182         try (FileSystem zipfs =
183                      FileSystems.newFileSystem(zipFile, env)) {
184             Files.copy(source, zipfs.getPath(source.getFileName().toString()));
185         }
186     }
187 
188     /**
189      * Returns a file&#39;s POSIX file attributes.
190      *
191      * @param path The path to the Zip file
192      * @return The POSIX file attributes for the specified file or
193      * null if the  POSIX attribute view is not available
194      * @throws IOException If an error occurs obtaining the POSIX attributes for
195      *                     the specified file
196      */
197     public PosixFileAttributes getPosixAttributes(Path path) throws IOException {
198         PosixFileAttributes attrs = null;
199             PosixFileAttributeView view =
200                     Files.getFileAttributeView(path, PosixFileAttributeView.class);
201             // Return if the attribute view is not supported
202             if (view == null) {
203                 return null;
204             }
205             attrs = view.readAttributes();
206         return attrs;
207     }
208 
209     /*
210      * DataProvider used to verify the permissions on a Zip file
211      * are as expected after updating the Zip file
212      */
213     @DataProvider(name = &quot;posixPermissions&quot;)
214     private Object[][] posixPermissions() {
215         return new Object[][]{
216                 {null},
217                 {Set.of(OWNER_READ, OWNER_WRITE, OTHERS_READ)},
218                 {Set.of(OWNER_READ, OWNER_WRITE, OWNER_EXECUTE)},
219                 {Set.of(OWNER_READ, OWNER_WRITE, OTHERS_READ, OTHERS_WRITE)},
220                 {Set.of(OWNER_READ, OWNER_WRITE, OWNER_EXECUTE, OTHERS_READ,
221                         OTHERS_WRITE, OTHERS_EXECUTE)},
222                 {Set.of(OWNER_READ, OWNER_WRITE, OWNER_EXECUTE,
223                         GROUP_READ, GROUP_WRITE,GROUP_EXECUTE, OTHERS_READ,
224                         OTHERS_WRITE, OTHERS_EXECUTE)},
225                 {Set.of(OWNER_READ, OWNER_WRITE, GROUP_READ, GROUP_WRITE,
226                         OTHERS_READ, OTHERS_WRITE)},
227         };
228     }
229 }
    </pre>
  </body>
</html>