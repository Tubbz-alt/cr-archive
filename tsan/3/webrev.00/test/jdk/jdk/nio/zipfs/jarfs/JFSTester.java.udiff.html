<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/jdk/nio/zipfs/jarfs/JFSTester.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ZipFSTester.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../lib/testlibrary/java/util/jar/CreateMultiReleaseTestJars.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/nio/zipfs/jarfs/JFSTester.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,19 +21,20 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8164389</span>
<span class="udiff-line-modified-removed">-  * @summary walk entries in a jdk.nio.zipfs.JarFileSystem</span>
<span class="udiff-line-modified-removed">-  * @modules jdk.jartool/sun.tools.jar</span>
<span class="udiff-line-modified-added">+  * @bug 8164389 8222440</span>
<span class="udiff-line-modified-added">+  * @summary walk entries in a multi-release jar file via jdk.zipfs</span>
<span class="udiff-line-modified-added">+  * @library /lib/testlibrary/java/util/jar</span>
<span class="udiff-line-added">+  * @modules jdk.jartool</span>
   *          jdk.zipfs
<span class="udiff-line-added">+  * @build Compiler JarBuilder</span>
   * @run testng JFSTester
   */
  
  import org.testng.Assert;
<span class="udiff-line-removed">- import org.testng.annotations.AfterClass;</span>
  import org.testng.annotations.BeforeClass;
  import org.testng.annotations.Test;
  
  import java.io.IOException;
  import java.io.UncheckedIOException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,71 +49,91 @@</span>
  import java.util.Set;
  import java.util.stream.Collectors;
  
  public class JFSTester {
      private URI jarURI;
<span class="udiff-line-modified-removed">-     private Path jarfile;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     final private String root_dir1_leaf1_txt = &quot;This is leaf 1.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String root_dir1_leaf2_txt = &quot;This is leaf 2.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String root_dir2_leaf3_txt = &quot;This is leaf 3.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String root_dir2_leaf4_txt = &quot;This is leaf 4.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v9_root_dir2_leaf3_txt = &quot;This is version 9 leaf 3.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v9_root_dir2_leaf4_txt = &quot;This is version 9 leaf 4.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v9_root_dir3_leaf5_txt = &quot;This is version 9 leaf 5.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v9_root_dir3_leaf6_txt = &quot;This is version 9 leaf 6.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v10_root_dir3_leaf5_txt = &quot;This is version 10 leaf 5.&quot; + System.lineSeparator();</span>
<span class="udiff-line-added">+     final private String v10_root_dir3_leaf6_txt = &quot;This is version 10 leaf 6.&quot; + System.lineSeparator();</span>
  
      @BeforeClass
      public void initialize() throws Exception {
<span class="udiff-line-modified-removed">-         String userdir = System.getProperty(&quot;user.dir&quot;,&quot;.&quot;);</span>
<span class="udiff-line-modified-removed">-         jarfile = Paths.get(userdir, &quot;test.jar&quot;);</span>
<span class="udiff-line-modified-removed">-         String srcdir = System.getProperty(&quot;test.src&quot;);</span>
<span class="udiff-line-modified-removed">-         String[] args = (</span>
<span class="udiff-line-modified-removed">-                         &quot;-cf &quot;</span>
<span class="udiff-line-modified-removed">-                         + jarfile.toString()</span>
<span class="udiff-line-modified-removed">-                         + &quot; -C &quot;</span>
<span class="udiff-line-modified-removed">-                         + srcdir</span>
<span class="udiff-line-modified-removed">-                         + &quot; root --release 9 -C &quot;</span>
<span class="udiff-line-modified-removed">-                         + srcdir</span>
<span class="udiff-line-modified-removed">-                         + System.getProperty(&quot;file.separator&quot;)</span>
<span class="udiff-line-modified-removed">-                         + &quot;v9 root&quot;</span>
<span class="udiff-line-modified-removed">-         ).split(&quot; +&quot;);</span>
<span class="udiff-line-modified-removed">-         new sun.tools.jar.Main(System.out, System.err, &quot;jar&quot;).run(args);</span>
<span class="udiff-line-modified-removed">-         String ssp = jarfile.toUri().toString();</span>
<span class="udiff-line-modified-removed">-         jarURI = new URI(&quot;jar&quot;, ssp, null);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @AfterClass</span>
<span class="udiff-line-removed">-     public void close() throws IOException {</span>
<span class="udiff-line-removed">-         Files.deleteIfExists(jarfile);</span>
<span class="udiff-line-modified-added">+         Path jarfile = Paths.get(&quot;test.jar&quot;);</span>
<span class="udiff-line-modified-added">+         JarBuilder jb = new JarBuilder(jarfile.toString());</span>
<span class="udiff-line-modified-added">+         jb.addAttribute(&quot;Multi-Release&quot;, &quot;true&quot;);</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;root/dir1/leaf1.txt&quot;, root_dir1_leaf1_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;root/dir1/leaf2.txt&quot;, root_dir1_leaf2_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;root/dir2/leaf3.txt&quot;, root_dir2_leaf3_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;root/dir2/leaf4.txt&quot;, root_dir2_leaf4_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/9/root/dir2/leaf3.txt&quot;, v9_root_dir2_leaf3_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/9/root/dir2/leaf4.txt&quot;, v9_root_dir2_leaf4_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/9/root/dir3/leaf5.txt&quot;, v9_root_dir3_leaf5_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/9/root/dir3/leaf6.txt&quot;, v9_root_dir3_leaf6_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/10/root/dir3/leaf5.txt&quot;, v10_root_dir3_leaf5_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.addEntry(&quot;META-INF/versions/10/root/dir3/leaf6.txt&quot;, v10_root_dir3_leaf6_txt.getBytes());</span>
<span class="udiff-line-modified-added">+         jb.build();</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;Created &quot; + jarfile + &quot;: &quot; + Files.exists(jarfile));</span>
<span class="udiff-line-modified-added">+         jarURI = new URI(&quot;jar&quot;, jarfile.toUri().toString(), null);</span>
      }
  
      @Test
      public void testWalk() throws IOException {
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         // no configuration, treat multi-release jar as unversioned</span>
<span class="udiff-line-removed">-         Map&lt;String,String&gt; env = new HashMap&lt;&gt;();</span>
<span class="udiff-line-modified-added">+         // treat multi-release jar as unversioned</span>
<span class="udiff-line-modified-added">+         Map&lt;String, String&gt; env = new HashMap&lt;&gt;();</span>
          Set&lt;String&gt; contents = doTest(env);
<span class="udiff-line-modified-removed">-         Set&lt;String&gt; baseContents = Set.of(</span>
<span class="udiff-line-modified-removed">-                 &quot;This is leaf 1.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is leaf 2.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is leaf 3.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is leaf 4.\n&quot;</span>
<span class="udiff-line-modified-added">+         Set&lt;String&gt; expectedContents = Set.of(</span>
<span class="udiff-line-modified-added">+             root_dir1_leaf1_txt,</span>
<span class="udiff-line-modified-added">+             root_dir1_leaf2_txt,</span>
<span class="udiff-line-modified-added">+             root_dir2_leaf3_txt,</span>
<span class="udiff-line-modified-added">+             root_dir2_leaf4_txt</span>
          );
<span class="udiff-line-modified-removed">-         Assert.assertEquals(contents, baseContents);</span>
<span class="udiff-line-modified-added">+         Assert.assertEquals(contents, expectedContents);</span>
  
<span class="udiff-line-modified-removed">-         // a configuration and jar file is multi-release</span>
<span class="udiff-line-modified-added">+         // open file as multi-release for version 9</span>
          env.put(&quot;multi-release&quot;, &quot;9&quot;);
          contents = doTest(env);
<span class="udiff-line-modified-removed">-         Set&lt;String&gt; versionedContents = Set.of(</span>
<span class="udiff-line-modified-removed">-                 &quot;This is versioned leaf 1.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is versioned leaf 2.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is versioned leaf 3.\n&quot;,</span>
<span class="udiff-line-modified-removed">-                 &quot;This is versioned leaf 4.\n&quot;</span>
<span class="udiff-line-modified-added">+         expectedContents = Set.of(</span>
<span class="udiff-line-modified-added">+             root_dir1_leaf1_txt,</span>
<span class="udiff-line-modified-added">+             root_dir1_leaf2_txt,</span>
<span class="udiff-line-modified-added">+             v9_root_dir2_leaf3_txt,</span>
<span class="udiff-line-modified-added">+             v9_root_dir2_leaf4_txt,</span>
<span class="udiff-line-added">+             v9_root_dir3_leaf5_txt,</span>
<span class="udiff-line-added">+             v9_root_dir3_leaf6_txt</span>
<span class="udiff-line-added">+         );</span>
<span class="udiff-line-added">+         Assert.assertEquals(contents, expectedContents);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // open file as multi-release for version 10</span>
<span class="udiff-line-added">+         env.put(&quot;multi-release&quot;, &quot;10&quot;);</span>
<span class="udiff-line-added">+         contents = doTest(env);</span>
<span class="udiff-line-added">+         expectedContents = Set.of(</span>
<span class="udiff-line-added">+             root_dir1_leaf1_txt,</span>
<span class="udiff-line-added">+             root_dir1_leaf2_txt,</span>
<span class="udiff-line-added">+             v9_root_dir2_leaf3_txt,</span>
<span class="udiff-line-added">+             v9_root_dir2_leaf4_txt,</span>
<span class="udiff-line-added">+             v10_root_dir3_leaf5_txt,</span>
<span class="udiff-line-added">+             v10_root_dir3_leaf6_txt</span>
          );
<span class="udiff-line-modified-removed">-         Assert.assertEquals(contents, versionedContents);</span>
<span class="udiff-line-modified-added">+         Assert.assertEquals(contents, expectedContents);</span>
      }
  
      private Set&lt;String&gt; doTest(Map&lt;String,String&gt; env) throws IOException {
          Set&lt;String&gt; contents;
          try (FileSystem fs = FileSystems.newFileSystem(jarURI, env)) {
              Path root = fs.getPath(&quot;root&quot;);
              contents = Files.walk(root)
<span class="udiff-line-modified-removed">-                     .filter(p -&gt; !Files.isDirectory(p))</span>
<span class="udiff-line-modified-removed">-                     .map(this::pathToContents)</span>
<span class="udiff-line-modified-removed">-                     .collect(Collectors.toSet());</span>
<span class="udiff-line-modified-added">+                 .filter(p -&gt; !Files.isDirectory(p))</span>
<span class="udiff-line-modified-added">+                 .map(this::pathToContents)</span>
<span class="udiff-line-modified-added">+                 .sorted()</span>
<span class="udiff-line-added">+                 .collect(Collectors.toSet());</span>
          }
          return contents;
      }
  
      private String pathToContents(Path path) {
</pre>
<center><a href="../ZipFSTester.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../lib/testlibrary/java/util/jar/CreateMultiReleaseTestJars.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>