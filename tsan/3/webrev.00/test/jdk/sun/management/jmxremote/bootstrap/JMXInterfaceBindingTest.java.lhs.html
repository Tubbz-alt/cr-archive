<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/management/jmxremote/bootstrap/JMXInterfaceBindingTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Red Hat Inc
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.File;
<a name="1" id="anc1"></a>
 25 import java.net.InetAddress;
<a name="2" id="anc2"></a><span class="line-removed"> 26 import java.net.NetworkInterface;</span>
 27 import java.net.UnknownHostException;
<a name="3" id="anc3"></a><span class="line-removed"> 28 import java.net.SocketException;</span>
 29 import java.util.ArrayList;
 30 import java.util.List;
<a name="4" id="anc4"></a><span class="line-modified"> 31 import java.util.stream.Collectors;</span>
 32 
<a name="5" id="anc5"></a><span class="line-modified"> 33 import jdk.test.lib.thread.ProcessThread;</span>
 34 import jdk.test.lib.process.ProcessTools;
 35 
 36 /**
 37  * @test
 38  * @bug     6425769
 39  * @summary Test JMX agent host address binding. Same ports but different
<a name="6" id="anc6"></a><span class="line-modified"> 40  *          interfaces to bind to (selecting plain or SSL sockets at random</span>
<span class="line-removed"> 41  * @key intermittent</span>
 42  *
 43  * @library /test/lib
 44  * @modules java.management.rmi
 45  *
 46  * @build JMXAgentInterfaceBinding
 47  * @run main/timeout=60 JMXInterfaceBindingTest
 48  */
 49 public class JMXInterfaceBindingTest {
 50 
 51     public static final int COMMUNICATION_ERROR_EXIT_VAL = 1;
 52     public static final int STOP_PROCESS_EXIT_VAL = 10;
 53     public static final int JMX_PORT_RANGE_LOWER = 9100;
 54     public static final int JMX_PORT_RANGE_UPPER = 9200;
<a name="7" id="anc7"></a><span class="line-removed"> 55     public static final int JMX_PORT = getRandomPortInRange(JMX_PORT_RANGE_LOWER,</span>
<span class="line-removed"> 56                                                             JMX_PORT_RANGE_UPPER);</span>
 57     public static final int JMX_PORT_RANGE_LOWER_SSL = 9201; // 9200 might be RMI Port
 58     public static final int JMX_PORT_RANGE_UPPER_SSL = 9300;
<a name="8" id="anc8"></a><span class="line-modified"> 59     public static final int JMX_PORT_SSL = getRandomPortInRange(JMX_PORT_RANGE_LOWER_SSL,</span>
<span class="line-removed"> 60                                                                 JMX_PORT_RANGE_UPPER_SSL);</span>
<span class="line-removed"> 61     public static final int RMI_PORT = JMX_PORT + 1;</span>
<span class="line-removed"> 62     public static final int RMI_PORT_SSL = JMX_PORT_SSL + 1;</span>
 63     public static final String READY_MSG = &quot;MainThread: Ready for connections&quot;;
 64     public static final String TEST_CLASS = JMXAgentInterfaceBinding.class.getSimpleName();
 65     public static final String KEYSTORE_LOC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) +
 66                                               File.separator +
 67                                               &quot;ssl&quot; +
 68                                               File.separator +
 69                                               &quot;keystore&quot;;
 70     public static final String TRUSTSTORE_LOC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) +
 71                                                 File.separator +
 72                                                 &quot;ssl&quot; +
 73                                                 File.separator +
 74                                                 &quot;truststore&quot;;
 75     public static final String TEST_CLASSPATH = System.getProperty(&quot;test.classes&quot;, &quot;.&quot;);
 76 
 77     public void run(List&lt;InetAddress&gt; addrs) {
 78         System.out.println(&quot;DEBUG: Running tests with plain sockets.&quot;);
 79         runTests(addrs, false);
 80         System.out.println(&quot;DEBUG: Running tests with SSL sockets.&quot;);
 81         runTests(addrs, true);
 82     }
 83 
 84     private void runTests(List&lt;InetAddress&gt; addrs, boolean useSSL) {
<a name="9" id="anc9"></a><span class="line-modified"> 85         List&lt;ProcessThread&gt; jvms = new ArrayList&lt;&gt;(addrs.size());</span>
<span class="line-modified"> 86         int i = 1;</span>
 87         for (InetAddress addr : addrs) {
 88             String address = JMXAgentInterfaceBinding.wrapAddress(addr.getHostAddress());
<a name="10" id="anc10"></a><span class="line-modified"> 89             System.out.println();</span>
<span class="line-modified"> 90             String msg = String.format(&quot;DEBUG: Launching java tester for triplet (HOSTNAME,JMX_PORT,RMI_PORT) == (%s,%d,%d)&quot;,</span>
<span class="line-modified"> 91                     address,</span>
<span class="line-removed"> 92                     useSSL ? JMX_PORT_SSL : JMX_PORT,</span>
<span class="line-removed"> 93                     useSSL ? RMI_PORT_SSL : RMI_PORT);</span>
<span class="line-removed"> 94             System.out.println(msg);</span>
<span class="line-removed"> 95             ProcessThread jvm = runJMXBindingTest(address, useSSL);</span>
<span class="line-removed"> 96             jvms.add(jvm);</span>
<span class="line-removed"> 97             jvm.start();</span>
<span class="line-removed"> 98             System.out.println(&quot;DEBUG: Started &quot; + (i++) + &quot; Process(es).&quot;);</span>
<span class="line-removed"> 99         }</span>
<span class="line-removed">100         int failedProcesses = 0;</span>
<span class="line-removed">101         for (ProcessThread pt: jvms) {</span>
<span class="line-removed">102             try {</span>
<span class="line-removed">103                 pt.sendMessage(&quot;Exit: &quot; + STOP_PROCESS_EXIT_VAL);</span>
<span class="line-removed">104                 pt.join();</span>
<span class="line-removed">105             } catch (Throwable e) {</span>
<span class="line-removed">106                 System.err.println(&quot;Failed to stop process: &quot; + pt.getName());</span>
<span class="line-removed">107                 throw new RuntimeException(&quot;Test failed&quot;, e);</span>
<span class="line-removed">108             }</span>
<span class="line-removed">109             int exitValue = pt.getOutput().getExitValue();</span>
<span class="line-removed">110             // If there is a communication error (the case we care about)</span>
<span class="line-removed">111             // we get a exit code of 1</span>
<span class="line-removed">112             if (exitValue == COMMUNICATION_ERROR_EXIT_VAL) {</span>
<span class="line-removed">113                 // Failure case since the java processes should still be</span>
<span class="line-removed">114                 // running.</span>
<span class="line-removed">115                 System.err.println(&quot;Test FAILURE on &quot; + pt.getName());</span>
<span class="line-removed">116                 failedProcesses++;</span>
<span class="line-removed">117             } else if (exitValue == STOP_PROCESS_EXIT_VAL) {</span>
<span class="line-removed">118                 System.out.println(&quot;DEBUG: OK. Spawned java process terminated with expected exit code of &quot; + STOP_PROCESS_EXIT_VAL);</span>
<span class="line-removed">119             } else {</span>
<span class="line-removed">120                 System.err.println(&quot;Test FAILURE on &quot; + pt.getName() + &quot; reason: Unexpected exit code =&gt; &quot; + exitValue);</span>
<span class="line-removed">121                 failedProcesses++;</span>
<span class="line-removed">122             }</span>
<span class="line-removed">123         }</span>
<span class="line-removed">124         if (failedProcesses &gt; 0) {</span>
<span class="line-removed">125             throw new RuntimeException(&quot;Test FAILED. &quot; + failedProcesses + &quot; out of &quot; + addrs.size() + &quot; process(es) failed to start the JMX agent.&quot;);</span>
<span class="line-removed">126         }</span>
<span class="line-removed">127     }</span>
<span class="line-removed">128 </span>
<span class="line-removed">129     private ProcessThread runJMXBindingTest(String address, boolean useSSL) {</span>
<span class="line-removed">130         List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="line-removed">131         args.add(&quot;-classpath&quot;);</span>
<span class="line-removed">132         args.add(TEST_CLASSPATH);</span>
<span class="line-removed">133         args.add(&quot;-Dcom.sun.management.jmxremote.host=&quot; + address);</span>
<span class="line-removed">134         args.add(&quot;-Dcom.sun.management.jmxremote.port=&quot; + (useSSL ? JMX_PORT_SSL : JMX_PORT));</span>
<span class="line-removed">135         args.add(&quot;-Dcom.sun.management.jmxremote.rmi.port=&quot; + (useSSL ? RMI_PORT_SSL : RMI_PORT));</span>
<span class="line-removed">136         args.add(&quot;-Dcom.sun.management.jmxremote.authenticate=false&quot;);</span>
<span class="line-removed">137         args.add(&quot;-Dcom.sun.management.jmxremote.ssl=&quot; + Boolean.toString(useSSL));</span>
<span class="line-removed">138         // This is needed for testing on loopback</span>
<span class="line-removed">139         args.add(&quot;-Djava.rmi.server.hostname=&quot; + address);</span>
<span class="line-removed">140         if (useSSL) {</span>
<span class="line-removed">141             args.add(&quot;-Dcom.sun.management.jmxremote.registry.ssl=true&quot;);</span>
<span class="line-removed">142             args.add(&quot;-Djavax.net.ssl.keyStore=&quot; + KEYSTORE_LOC);</span>
<span class="line-removed">143             args.add(&quot;-Djavax.net.ssl.trustStore=&quot; + TRUSTSTORE_LOC);</span>
<span class="line-removed">144             args.add(&quot;-Djavax.net.ssl.keyStorePassword=password&quot;);</span>
<span class="line-removed">145             args.add(&quot;-Djavax.net.ssl.trustStorePassword=trustword&quot;);</span>
146         }
<a name="11" id="anc11"></a><span class="line-removed">147         args.add(TEST_CLASS);</span>
<span class="line-removed">148         args.add(address);</span>
<span class="line-removed">149         args.add(Integer.toString(useSSL ? JMX_PORT_SSL : JMX_PORT));</span>
<span class="line-removed">150         args.add(Integer.toString(useSSL ? RMI_PORT_SSL : RMI_PORT));</span>
<span class="line-removed">151         args.add(Boolean.toString(useSSL));</span>
152         try {
<a name="12" id="anc12"></a><span class="line-modified">153             ProcessBuilder builder = ProcessTools.createJavaProcessBuilder(args.toArray(new String[] {}));</span>
<span class="line-modified">154             System.out.println(ProcessTools.getCommandLine(builder));</span>
<span class="line-modified">155             ProcessThread jvm = new ProcessThread(&quot;JMX-Tester-&quot; + address, JMXInterfaceBindingTest::isJMXAgentResponseAvailable, builder);</span>
<span class="line-removed">156             return jvm;</span>
<span class="line-removed">157         } catch (Exception e) {</span>
158             throw new RuntimeException(&quot;Test failed&quot;, e);
159         }
160 
<a name="13" id="anc13"></a><span class="line-modified">161     }</span>
<span class="line-modified">162 </span>
<span class="line-modified">163     private static boolean isJMXAgentResponseAvailable(String line) {</span>
<span class="line-modified">164         if (line.equals(READY_MSG)) {</span>
<span class="line-removed">165             System.out.println(&quot;DEBUG: Found expected READY_MSG.&quot;);</span>
<span class="line-removed">166             return true;</span>
<span class="line-removed">167         } else if (line.startsWith(&quot;Error:&quot;)) {</span>
<span class="line-removed">168             // Allow for a JVM process that exits with</span>
<span class="line-removed">169             // &quot;Error: JMX connector server communication error: ...&quot;</span>
<span class="line-removed">170             // to continue as well since we handle that case elsewhere.</span>
<span class="line-removed">171             // This has the effect that the test does not timeout and</span>
<span class="line-removed">172             // fails with an exception in the test.</span>
<span class="line-removed">173             System.err.println(&quot;PROBLEM: JMX agent of target JVM did not start as it should.&quot;);</span>
<span class="line-removed">174             return true;</span>
<span class="line-removed">175         } else {</span>
<span class="line-removed">176             return false;</span>
177         }
178     }
179 
180     private static int getRandomPortInRange(int lower, int upper) {
181         if (upper &lt;= lower) {
182             throw new IllegalArgumentException(&quot;upper &lt;= lower&quot;);
183         }
184         int range = upper - lower;
185         int randPort = lower + (int)(Math.random() * range);
186         return randPort;
187     }
188 
189     public static void main(String[] args) {
190         List&lt;InetAddress&gt; addrs = getNonLoopbackAddressesForLocalHost();
191         if (addrs.isEmpty()) {
192             System.out.println(&quot;Ignoring test since no non-loopback IPs are available to bind to &quot; +
193                                &quot;in addition to the loopback interface.&quot;);
194             return;
195         }
196         JMXInterfaceBindingTest test = new JMXInterfaceBindingTest();
197         // Add loopback interface too as we&#39;d like to verify whether it&#39;s
198         // possible to bind to multiple addresses on the same host. This
199         // wasn&#39;t possible prior JDK-6425769. It used to bind to *all* local
200         // interfaces. We add loopback here, since that eases test setup.
201         addrs.add(InetAddress.getLoopbackAddress());
202         test.run(addrs);
203         System.out.println(&quot;All tests PASSED.&quot;);
204     }
205 
206     private static List&lt;InetAddress&gt; getNonLoopbackAddressesForLocalHost() {
207         List&lt;InetAddress&gt; addrs = new ArrayList&lt;&gt;();
208         try {
209             InetAddress localHost = InetAddress.getLocalHost();
210             if (!localHost.isLoopbackAddress()) {
211                 addrs.add(localHost);
212             }
213             return addrs;
214         } catch (UnknownHostException e) {
215             throw new RuntimeException(&quot;Test failed&quot;, e);
216         }
217     }
<a name="14" id="anc14"></a>



























































































































218 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>