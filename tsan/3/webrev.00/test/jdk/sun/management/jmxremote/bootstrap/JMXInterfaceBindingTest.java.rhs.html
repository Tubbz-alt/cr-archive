<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/management/jmxremote/bootstrap/JMXInterfaceBindingTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Red Hat Inc
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.File;
<a name="1" id="anc1"></a><span class="line-added"> 25 import java.io.PrintWriter;</span>
 26 import java.net.InetAddress;
<a name="2" id="anc2"></a>
 27 import java.net.UnknownHostException;
<a name="3" id="anc3"></a>
 28 import java.util.ArrayList;
 29 import java.util.List;
<a name="4" id="anc4"></a><span class="line-modified"> 30 import java.util.concurrent.CountDownLatch;</span>
 31 
<a name="5" id="anc5"></a><span class="line-modified"> 32 import jdk.test.lib.process.OutputAnalyzer;</span>
 33 import jdk.test.lib.process.ProcessTools;
 34 
 35 /**
 36  * @test
 37  * @bug     6425769
 38  * @summary Test JMX agent host address binding. Same ports but different
<a name="6" id="anc6"></a><span class="line-modified"> 39  *          interfaces to bind to (selecting plain or SSL sockets at random)</span>

 40  *
 41  * @library /test/lib
 42  * @modules java.management.rmi
 43  *
 44  * @build JMXAgentInterfaceBinding
 45  * @run main/timeout=60 JMXInterfaceBindingTest
 46  */
 47 public class JMXInterfaceBindingTest {
 48 
 49     public static final int COMMUNICATION_ERROR_EXIT_VAL = 1;
 50     public static final int STOP_PROCESS_EXIT_VAL = 10;
 51     public static final int JMX_PORT_RANGE_LOWER = 9100;
 52     public static final int JMX_PORT_RANGE_UPPER = 9200;
<a name="7" id="anc7"></a>

 53     public static final int JMX_PORT_RANGE_LOWER_SSL = 9201; // 9200 might be RMI Port
 54     public static final int JMX_PORT_RANGE_UPPER_SSL = 9300;
<a name="8" id="anc8"></a><span class="line-modified"> 55     private static final int MAX_RETRY_ATTEMTS = 10;</span>



 56     public static final String READY_MSG = &quot;MainThread: Ready for connections&quot;;
 57     public static final String TEST_CLASS = JMXAgentInterfaceBinding.class.getSimpleName();
 58     public static final String KEYSTORE_LOC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) +
 59                                               File.separator +
 60                                               &quot;ssl&quot; +
 61                                               File.separator +
 62                                               &quot;keystore&quot;;
 63     public static final String TRUSTSTORE_LOC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) +
 64                                                 File.separator +
 65                                                 &quot;ssl&quot; +
 66                                                 File.separator +
 67                                                 &quot;truststore&quot;;
 68     public static final String TEST_CLASSPATH = System.getProperty(&quot;test.classes&quot;, &quot;.&quot;);
 69 
 70     public void run(List&lt;InetAddress&gt; addrs) {
 71         System.out.println(&quot;DEBUG: Running tests with plain sockets.&quot;);
 72         runTests(addrs, false);
 73         System.out.println(&quot;DEBUG: Running tests with SSL sockets.&quot;);
 74         runTests(addrs, true);
 75     }
 76 
 77     private void runTests(List&lt;InetAddress&gt; addrs, boolean useSSL) {
<a name="9" id="anc9"></a><span class="line-modified"> 78         List&lt;TestProcessThread&gt; testThreads = new ArrayList&lt;&gt;(addrs.size());</span>
<span class="line-modified"> 79         CountDownLatch latch = new CountDownLatch(addrs.size());</span>
 80         for (InetAddress addr : addrs) {
 81             String address = JMXAgentInterfaceBinding.wrapAddress(addr.getHostAddress());
<a name="10" id="anc10"></a><span class="line-modified"> 82             TestProcessThread t = new TestProcessThread(address, useSSL, latch);</span>
<span class="line-modified"> 83             testThreads.add(t);</span>
<span class="line-modified"> 84             t.start();</span>






















































 85         }
<a name="11" id="anc11"></a>




 86         try {
<a name="12" id="anc12"></a><span class="line-modified"> 87             latch.await();</span>
<span class="line-modified"> 88         } catch (InterruptedException e) {</span>
<span class="line-modified"> 89             System.err.println(&quot;Failed to wait for the test threads to complete&quot;);</span>


 90             throw new RuntimeException(&quot;Test failed&quot;, e);
 91         }
 92 
<a name="13" id="anc13"></a><span class="line-modified"> 93         long failedProcesses = testThreads.stream().filter(TestProcessThread::isTestFailed).count();</span>
<span class="line-modified"> 94         if (failedProcesses &gt; 0) {</span>
<span class="line-modified"> 95             throw new RuntimeException(&quot;Test FAILED. &quot; + failedProcesses + &quot; out of &quot; + addrs.size() +</span>
<span class="line-modified"> 96                     &quot; process(es) failed to start the JMX agent.&quot;);</span>












 97         }
 98     }
 99 
100     private static int getRandomPortInRange(int lower, int upper) {
101         if (upper &lt;= lower) {
102             throw new IllegalArgumentException(&quot;upper &lt;= lower&quot;);
103         }
104         int range = upper - lower;
105         int randPort = lower + (int)(Math.random() * range);
106         return randPort;
107     }
108 
109     public static void main(String[] args) {
110         List&lt;InetAddress&gt; addrs = getNonLoopbackAddressesForLocalHost();
111         if (addrs.isEmpty()) {
112             System.out.println(&quot;Ignoring test since no non-loopback IPs are available to bind to &quot; +
113                                &quot;in addition to the loopback interface.&quot;);
114             return;
115         }
116         JMXInterfaceBindingTest test = new JMXInterfaceBindingTest();
117         // Add loopback interface too as we&#39;d like to verify whether it&#39;s
118         // possible to bind to multiple addresses on the same host. This
119         // wasn&#39;t possible prior JDK-6425769. It used to bind to *all* local
120         // interfaces. We add loopback here, since that eases test setup.
121         addrs.add(InetAddress.getLoopbackAddress());
122         test.run(addrs);
123         System.out.println(&quot;All tests PASSED.&quot;);
124     }
125 
126     private static List&lt;InetAddress&gt; getNonLoopbackAddressesForLocalHost() {
127         List&lt;InetAddress&gt; addrs = new ArrayList&lt;&gt;();
128         try {
129             InetAddress localHost = InetAddress.getLocalHost();
130             if (!localHost.isLoopbackAddress()) {
131                 addrs.add(localHost);
132             }
133             return addrs;
134         } catch (UnknownHostException e) {
135             throw new RuntimeException(&quot;Test failed&quot;, e);
136         }
137     }
<a name="14" id="anc14"></a><span class="line-added">138 </span>
<span class="line-added">139     private static class TestProcessThread extends Thread {</span>
<span class="line-added">140         private final String name;</span>
<span class="line-added">141         private final String address;</span>
<span class="line-added">142         private final boolean useSSL;</span>
<span class="line-added">143         private final CountDownLatch latch;</span>
<span class="line-added">144         private volatile boolean testFailed = false;</span>
<span class="line-added">145         private OutputAnalyzer output;</span>
<span class="line-added">146 </span>
<span class="line-added">147         public TestProcessThread(String address, boolean useSSL, CountDownLatch latch) {</span>
<span class="line-added">148             this.address = address;</span>
<span class="line-added">149             this.useSSL = useSSL;</span>
<span class="line-added">150             this.name = &quot;JMX-Tester-&quot; + address;</span>
<span class="line-added">151             this.latch = latch;</span>
<span class="line-added">152         }</span>
<span class="line-added">153 </span>
<span class="line-added">154         @Override</span>
<span class="line-added">155         public void run() {</span>
<span class="line-added">156             int attempts = 0;</span>
<span class="line-added">157             boolean needRetry = false;</span>
<span class="line-added">158             do {</span>
<span class="line-added">159                 if (needRetry) {</span>
<span class="line-added">160                     System.err.println(&quot;Retrying the test for &quot; + name);</span>
<span class="line-added">161                 }</span>
<span class="line-added">162                 needRetry = runTest();</span>
<span class="line-added">163             } while (needRetry &amp;&amp; (attempts++ &lt; MAX_RETRY_ATTEMTS));</span>
<span class="line-added">164 </span>
<span class="line-added">165             if (testFailed) {</span>
<span class="line-added">166                 int exitValue = output.getExitValue();</span>
<span class="line-added">167                 if (needRetry) {</span>
<span class="line-added">168                     System.err.println(&quot;Test FAILURE on &quot; + name + &quot; reason: run out of retries to to pick free ports&quot;);</span>
<span class="line-added">169                 } else if (exitValue == COMMUNICATION_ERROR_EXIT_VAL) {</span>
<span class="line-added">170                     // Failure case since the java processes should still be</span>
<span class="line-added">171                     // running.</span>
<span class="line-added">172                     System.err.println(&quot;Test FAILURE on &quot; + name);</span>
<span class="line-added">173                 } else if (exitValue == STOP_PROCESS_EXIT_VAL) {</span>
<span class="line-added">174                     System.out.println(&quot;Test FAILURE on &quot; + name + &quot; reason: The expected line \&quot;&quot; + READY_MSG</span>
<span class="line-added">175                             + &quot;\&quot; is not present in the process output&quot;);</span>
<span class="line-added">176                 } else {</span>
<span class="line-added">177                     System.err.println(&quot;Test FAILURE on &quot; + name + &quot; reason: Unexpected exit code =&gt; &quot; + exitValue);</span>
<span class="line-added">178                 }</span>
<span class="line-added">179                 output.reportDiagnosticSummary();</span>
<span class="line-added">180             }</span>
<span class="line-added">181             latch.countDown();</span>
<span class="line-added">182         }</span>
<span class="line-added">183 </span>
<span class="line-added">184         public boolean isTestFailed() {</span>
<span class="line-added">185             return testFailed;</span>
<span class="line-added">186         }</span>
<span class="line-added">187 </span>
<span class="line-added">188         private int getJMXPort() {</span>
<span class="line-added">189             return useSSL ?</span>
<span class="line-added">190                     getRandomPortInRange(JMX_PORT_RANGE_LOWER_SSL, JMX_PORT_RANGE_UPPER_SSL) :</span>
<span class="line-added">191                     getRandomPortInRange(JMX_PORT_RANGE_LOWER, JMX_PORT_RANGE_UPPER);</span>
<span class="line-added">192         }</span>
<span class="line-added">193 </span>
<span class="line-added">194         private Process createTestProcess() {</span>
<span class="line-added">195             int jmxPort = getJMXPort();</span>
<span class="line-added">196             int rmiPort = jmxPort + 1;</span>
<span class="line-added">197             String msg = String.format(&quot;DEBUG: Launching java tester for triplet (HOSTNAME,JMX_PORT,RMI_PORT)&quot; +</span>
<span class="line-added">198                             &quot; == (%s,%d,%d)&quot;, address, jmxPort, rmiPort);</span>
<span class="line-added">199             System.out.println(msg);</span>
<span class="line-added">200             List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="line-added">201             args.add(&quot;-classpath&quot;);</span>
<span class="line-added">202             args.add(TEST_CLASSPATH);</span>
<span class="line-added">203             args.add(&quot;-Dcom.sun.management.jmxremote.host=&quot; + address);</span>
<span class="line-added">204             args.add(&quot;-Dcom.sun.management.jmxremote.port=&quot; + jmxPort);</span>
<span class="line-added">205             args.add(&quot;-Dcom.sun.management.jmxremote.rmi.port=&quot; + rmiPort);</span>
<span class="line-added">206             args.add(&quot;-Dcom.sun.management.jmxremote.authenticate=false&quot;);</span>
<span class="line-added">207             args.add(&quot;-Dcom.sun.management.jmxremote.ssl=&quot; + Boolean.toString(useSSL));</span>
<span class="line-added">208             // This is needed for testing on loopback</span>
<span class="line-added">209             args.add(&quot;-Djava.rmi.server.hostname=&quot; + address);</span>
<span class="line-added">210             if (useSSL) {</span>
<span class="line-added">211                 args.add(&quot;-Dcom.sun.management.jmxremote.registry.ssl=true&quot;);</span>
<span class="line-added">212                 args.add(&quot;-Djavax.net.ssl.keyStore=&quot; + KEYSTORE_LOC);</span>
<span class="line-added">213                 args.add(&quot;-Djavax.net.ssl.trustStore=&quot; + TRUSTSTORE_LOC);</span>
<span class="line-added">214                 args.add(&quot;-Djavax.net.ssl.keyStorePassword=password&quot;);</span>
<span class="line-added">215                 args.add(&quot;-Djavax.net.ssl.trustStorePassword=trustword&quot;);</span>
<span class="line-added">216             }</span>
<span class="line-added">217             args.add(TEST_CLASS);</span>
<span class="line-added">218             args.add(address);</span>
<span class="line-added">219             args.add(Integer.toString(jmxPort));</span>
<span class="line-added">220             args.add(Integer.toString(rmiPort));</span>
<span class="line-added">221             args.add(Boolean.toString(useSSL));</span>
<span class="line-added">222 </span>
<span class="line-added">223             try {</span>
<span class="line-added">224                 ProcessBuilder builder = ProcessTools.createJavaProcessBuilder(args.toArray(new String[]{}));</span>
<span class="line-added">225                 System.out.println(ProcessTools.getCommandLine(builder));</span>
<span class="line-added">226                 Process process = builder.start();</span>
<span class="line-added">227                 output = new OutputAnalyzer(process);</span>
<span class="line-added">228                 return process;</span>
<span class="line-added">229             } catch (Exception e) {</span>
<span class="line-added">230                 throw new RuntimeException(&quot;Test failed&quot;, e);</span>
<span class="line-added">231             }</span>
<span class="line-added">232         }</span>
<span class="line-added">233 </span>
<span class="line-added">234         // Returns true if the test failed due to &quot;Port already in use&quot; error.</span>
<span class="line-added">235         private boolean runTest() {</span>
<span class="line-added">236             testFailed = true;</span>
<span class="line-added">237             Process process = createTestProcess();</span>
<span class="line-added">238             try {</span>
<span class="line-added">239                 sendMessageToProcess(process, &quot;Exit: &quot; + STOP_PROCESS_EXIT_VAL);</span>
<span class="line-added">240                 process.waitFor();</span>
<span class="line-added">241             } catch (Throwable e) {</span>
<span class="line-added">242                 System.err.println(&quot;Failed to stop process: &quot; + name);</span>
<span class="line-added">243                 throw new RuntimeException(&quot;Test failed&quot;, e);</span>
<span class="line-added">244             }</span>
<span class="line-added">245             if (output.getExitValue() == STOP_PROCESS_EXIT_VAL &amp;&amp; output.getStdout().contains(READY_MSG)) {</span>
<span class="line-added">246                 testFailed = false;</span>
<span class="line-added">247             } else if (output.getStderr().contains(&quot;Port already in use&quot;)) {</span>
<span class="line-added">248                 System.out.println(&quot;The test attempt for the test &quot; + name +&quot; failed due to the bind error&quot;);</span>
<span class="line-added">249                 // Need to retry</span>
<span class="line-added">250                 return true;</span>
<span class="line-added">251             }</span>
<span class="line-added">252             return false;</span>
<span class="line-added">253         }</span>
<span class="line-added">254 </span>
<span class="line-added">255         private static void sendMessageToProcess(Process process, String message) {</span>
<span class="line-added">256             try (PrintWriter pw = new PrintWriter(process.getOutputStream())) {</span>
<span class="line-added">257                 pw.println(message);</span>
<span class="line-added">258                 pw.flush();</span>
<span class="line-added">259             }</span>
<span class="line-added">260         }</span>
<span class="line-added">261     }</span>
262 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>