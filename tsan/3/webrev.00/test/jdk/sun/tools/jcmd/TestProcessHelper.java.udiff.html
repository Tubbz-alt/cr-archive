<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/tools/jcmd/TestProcessHelper.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../text/resources/LocaleDataTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../jhsdb/BasicLauncherTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/tools/jcmd/TestProcessHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -19,20 +19,17 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="udiff-line-removed">- import jdk.internal.module.ModuleInfoWriter;</span>
<span class="udiff-line-removed">- import jdk.test.lib.JDKToolFinder;</span>
<span class="udiff-line-removed">- import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-removed">- import jdk.test.lib.util.JarUtils;</span>
<span class="udiff-line-removed">- import sun.tools.common.ProcessHelper;</span>
<span class="udiff-line-removed">- </span>
  import java.io.File;
  import java.io.IOException;
  import java.io.OutputStream;
<span class="udiff-line-added">+ import java.lang.invoke.MethodHandle;</span>
<span class="udiff-line-added">+ import java.lang.invoke.MethodHandles;</span>
  import java.lang.module.ModuleDescriptor;
<span class="udiff-line-added">+ import java.lang.reflect.Method;</span>
  import java.nio.file.FileSystems;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.util.ArrayList;
  import java.util.LinkedList;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,27 +39,30 @@</span>
  import java.util.jar.JarOutputStream;
  import java.util.jar.Manifest;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
  
<span class="udiff-line-added">+ import jdk.internal.module.ModuleInfoWriter;</span>
<span class="udiff-line-added">+ import jdk.test.lib.JDKToolFinder;</span>
<span class="udiff-line-added">+ import jdk.test.lib.process.ProcessTools;</span>
<span class="udiff-line-added">+ import jdk.test.lib.util.JarUtils;</span>
<span class="udiff-line-added">+ </span>
  /*
   * @test
   * @bug 8205654
   * @summary Unit test for sun.tools.ProcessHelper class. The test launches Java processes with different Java options
   * and checks that sun.tools.ProcessHelper.getMainClass(pid) method returns a correct main class.                                                                                                                               return a .
   *
   * @requires os.family == &quot;linux&quot;
   * @library /test/lib
<span class="udiff-line-modified-removed">-  * @modules jdk.jcmd/sun.tools.common</span>
<span class="udiff-line-modified-added">+  * @modules jdk.jcmd/sun.tools.common:+open</span>
   *          java.base/jdk.internal.module
   * @build test.TestProcess
   * @run main/othervm TestProcessHelper
   */
  public class TestProcessHelper {
  
<span class="udiff-line-removed">-     private ProcessHelper PROCESS_HELPER = ProcessHelper.platformProcessHelper();</span>
<span class="udiff-line-removed">- </span>
      private static final String TEST_PROCESS_MAIN_CLASS_NAME = &quot;TestProcess&quot;;
      private static final String TEST_PROCESS_MAIN_CLASS_PACKAGE = &quot;test&quot;;
      private static final String TEST_PROCESS_MAIN_CLASS = TEST_PROCESS_MAIN_CLASS_PACKAGE + &quot;.&quot;
              + TEST_PROCESS_MAIN_CLASS_NAME;
      private static final Path TEST_CLASSES = FileSystems.getDefault().getPath(System.getProperty(&quot;test.classes&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -71,17 +71,48 @@</span>
      private static final String JAVA_PATH = JDKToolFinder.getJDKTool(&quot;java&quot;);
      private static final Path TEST_CLASS = TEST_CLASSES.resolve(TEST_PROCESS_MAIN_CLASS_PACKAGE)
              .resolve(TEST_PROCESS_MAIN_CLASS_NAME + &quot;.class&quot;);
  
      private static final String[] CP_OPTIONS = {&quot;-cp&quot;, &quot;-classpath&quot;, &quot;--class-path&quot;};
<span class="udiff-line-modified-removed">-     private static final String[][] VM_ARGS = {{}, {&quot;-Dtest1=aaa&quot;}, {&quot;-Dtest1=aaa&quot;, &quot;-Dtest2=bbb&quot;}};</span>
<span class="udiff-line-modified-added">+     private static final String[][] VM_ARGS = {{}, {&quot;-Dtest1=aaa&quot;}, {&quot;-Dtest1=aaa&quot;, &quot;-Dtest2=bbb ccc&quot;}};</span>
      private static final String[][] ARGS = {{}, {&quot;param1&quot;}, {&quot;param1&quot;, &quot;param2&quot;}};
      private static final String[] MP_OPTIONS = {&quot;-p&quot;, &quot;--module-path&quot;};
<span class="udiff-line-modified-removed">-     private static final String[] MODULE_OPTIONS = {&quot;-m&quot;, &quot;--module&quot;};</span>
<span class="udiff-line-modified-added">+     private static final String[] MODULE_OPTIONS = {&quot;-m&quot;, &quot;--module&quot;, &quot;--module=&quot;};</span>
      private static final String JAR_OPTION = &quot;-jar&quot;;
      private static final String MODULE_NAME = &quot;module1&quot;;
<span class="udiff-line-added">+     private static final String[][] EXTRA_MODULAR_OPTIONS = {null,</span>
<span class="udiff-line-added">+             {&quot;--add-opens&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="udiff-line-added">+             {&quot;--add-exports&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="udiff-line-added">+             {&quot;--add-reads&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="udiff-line-added">+             {&quot;--add-modules&quot;, &quot;java.management&quot;},</span>
<span class="udiff-line-added">+             {&quot;--limit-modules&quot;, &quot;java.management&quot;},</span>
<span class="udiff-line-added">+             {&quot;--upgrade-module-path&quot;, &quot;test&quot;}};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final String[] PATCH_MODULE_OPTIONS = {&quot;--patch-module&quot;, null};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final MethodHandle MH_GET_MAIN_CLASS = resolveMainClassMH();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static MethodHandle resolveMainClassMH() {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             Method getMainClassMethod = Class</span>
<span class="udiff-line-added">+                 .forName(&quot;sun.tools.common.ProcessHelper&quot;)</span>
<span class="udiff-line-added">+                 .getDeclaredMethod(&quot;getMainClass&quot;, String.class);</span>
<span class="udiff-line-added">+             getMainClassMethod.setAccessible(true);</span>
<span class="udiff-line-added">+             return MethodHandles.lookup().unreflect(getMainClassMethod);</span>
<span class="udiff-line-added">+         } catch (ClassNotFoundException | NoSuchMethodException | SecurityException | IllegalAccessException e) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     private static String callGetMainClass(Process p) {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return (String)MH_GET_MAIN_CLASS.invoke(Long.toString(p.pid()));</span>
<span class="udiff-line-added">+         } catch (Throwable e) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
  
      public static void main(String[] args) throws Exception {
          new TestProcessHelper().runTests();
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,22 +126,28 @@</span>
      // and with different combinations of VM and program args.
      private void testClassPath() throws Exception {
          for (String cp : CP_OPTIONS) {
              for (String[] vma : VM_ARGS) {
                  for (String[] arg : ARGS) {
<span class="udiff-line-modified-removed">-                     List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-                     cmd.add(JAVA_PATH);</span>
<span class="udiff-line-modified-removed">-                     cmd.add(cp);</span>
<span class="udiff-line-modified-removed">-                     cmd.add(TEST_CLASSES.toAbsolutePath().toString());</span>
<span class="udiff-line-modified-removed">-                     for (String v : vma) {</span>
<span class="udiff-line-modified-removed">-                         cmd.add(v);</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     cmd.add(TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-modified-removed">-                     for (String a : arg) {</span>
<span class="udiff-line-modified-removed">-                         cmd.add(a);</span>
<span class="udiff-line-modified-added">+                     for (String[] modularOptions : EXTRA_MODULAR_OPTIONS) {</span>
<span class="udiff-line-modified-added">+                         List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-modified-added">+                         cmd.add(JAVA_PATH);</span>
<span class="udiff-line-modified-added">+                         cmd.add(cp);</span>
<span class="udiff-line-modified-added">+                         cmd.add(TEST_CLASSES.toAbsolutePath().toString());</span>
<span class="udiff-line-modified-added">+                         for (String v : vma) {</span>
<span class="udiff-line-modified-added">+                             cmd.add(v);</span>
<span class="udiff-line-modified-added">+                         }</span>
<span class="udiff-line-modified-added">+                         if (modularOptions != null) {</span>
<span class="udiff-line-modified-added">+                             cmd.add(modularOptions[0]);</span>
<span class="udiff-line-added">+                             cmd.add(modularOptions[1]);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         cmd.add(TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-added">+                         for (String a : arg) {</span>
<span class="udiff-line-added">+                             cmd.add(a);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         testProcessHelper(cmd, TEST_PROCESS_MAIN_CLASS);</span>
                      }
<span class="udiff-line-removed">-                     testProcessHelper(cmd);</span>
                  }
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,11 +165,11 @@</span>
                  cmd.add(JAR_OPTION);
                  cmd.add(jarFile.getAbsolutePath());
                  for (String a : arg) {
                      cmd.add(a);
                  }
<span class="udiff-line-modified-removed">-                 testProcessHelper(cmd);</span>
<span class="udiff-line-modified-added">+                 testProcessHelper(cmd, jarFile.getAbsolutePath());</span>
              }
          }
  
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,46 +179,76 @@</span>
          prepareModule();
          for (String mp : MP_OPTIONS) {
              for (String m : MODULE_OPTIONS) {
                  for (String[] vma : VM_ARGS) {
                      for (String[] arg : ARGS) {
<span class="udiff-line-modified-removed">-                         List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-                         cmd.add(JAVA_PATH);</span>
<span class="udiff-line-modified-removed">-                         cmd.add(mp);</span>
<span class="udiff-line-modified-removed">-                         cmd.add(TEST_MODULES.toAbsolutePath().toString());</span>
<span class="udiff-line-modified-removed">-                         for (String v : vma) {</span>
<span class="udiff-line-modified-removed">-                             cmd.add(v);</span>
<span class="udiff-line-modified-added">+                         for(String patchModuleOption : PATCH_MODULE_OPTIONS) {</span>
<span class="udiff-line-modified-added">+                             List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="udiff-line-modified-added">+                             cmd.add(JAVA_PATH);</span>
<span class="udiff-line-modified-added">+                             cmd.add(mp);</span>
<span class="udiff-line-modified-added">+                             cmd.add(TEST_MODULES.toAbsolutePath().toString());</span>
<span class="udiff-line-modified-added">+                             if (patchModuleOption != null) {</span>
<span class="udiff-line-added">+                                 cmd.add(patchModuleOption);</span>
<span class="udiff-line-added">+                                 cmd.add(MODULE_NAME + &quot;=&quot; + TEST_MODULES.toAbsolutePath().toString());</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             for (String v : vma) {</span>
<span class="udiff-line-added">+                                 cmd.add(v);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             if (m.endsWith(&quot;=&quot;)) {</span>
<span class="udiff-line-added">+                                 cmd.add(m + MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-added">+                             } else {</span>
<span class="udiff-line-added">+                                 cmd.add(m);</span>
<span class="udiff-line-added">+                                 cmd.add(MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             for (String a : arg) {</span>
<span class="udiff-line-added">+                                 cmd.add(a);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             testProcessHelper(cmd, MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
                          }
<span class="udiff-line-removed">-                         cmd.add(m);</span>
<span class="udiff-line-removed">-                         cmd.add(MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-removed">-                         for (String a : arg) {</span>
<span class="udiff-line-removed">-                             cmd.add(a);</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                         testProcessHelper(cmd);</span>
                      }
                  }
              }
          }
      }
  
      private void checkMainClass(Process p, String expectedMainClass) {
<span class="udiff-line-modified-removed">-         String mainClass = PROCESS_HELPER.getMainClass(Long.toString(p.pid()));</span>
<span class="udiff-line-modified-added">+         String mainClass = callGetMainClass(p);</span>
<span class="udiff-line-added">+         // getMainClass() may return null, e.g. due to timing issues.</span>
<span class="udiff-line-added">+         // Attempt some limited retries.</span>
<span class="udiff-line-added">+         if (mainClass == null) {</span>
<span class="udiff-line-added">+             System.err.println(&quot;Main class returned by ProcessHelper was null.&quot;);</span>
<span class="udiff-line-added">+             // sleep time doubles each round, altogether, wait no longer than 1 sec</span>
<span class="udiff-line-added">+             final int MAX_RETRIES = 10;</span>
<span class="udiff-line-added">+             int retrycount = 0;</span>
<span class="udiff-line-added">+             long sleepms = 1;</span>
<span class="udiff-line-added">+             while (retrycount &lt; MAX_RETRIES &amp;&amp; mainClass == null) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;Retry &quot; + retrycount + &quot;, sleeping for &quot; + sleepms + &quot;ms.&quot;);</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     Thread.sleep(sleepms);</span>
<span class="udiff-line-added">+                 } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+                     // ignore</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 mainClass = callGetMainClass(p);</span>
<span class="udiff-line-added">+                 retrycount++;</span>
<span class="udiff-line-added">+                 sleepms *= 2;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          p.destroyForcibly();
          if (!expectedMainClass.equals(mainClass)) {
              throw new RuntimeException(&quot;Main class is wrong: &quot; + mainClass);
          }
      }
  
<span class="udiff-line-modified-removed">-     private void testProcessHelper(List&lt;String&gt; args) throws Exception {</span>
<span class="udiff-line-modified-added">+     private void testProcessHelper(List&lt;String&gt; args, String expectedValue) throws Exception {</span>
          ProcessBuilder pb = new ProcessBuilder(args);
          String cmd = pb.command().stream().collect(Collectors.joining(&quot; &quot;));
          System.out.println(&quot;Starting the process:&quot; + cmd);
          Process p = ProcessTools.startProcess(&quot;test&quot;, pb);
          if (!p.isAlive()) {
              throw new RuntimeException(&quot;Cannot start the process: &quot; + cmd);
          }
<span class="udiff-line-modified-removed">-         checkMainClass(p, TEST_PROCESS_MAIN_CLASS);</span>
<span class="udiff-line-modified-added">+         checkMainClass(p, expectedValue);</span>
      }
  
      private File prepareJar() throws Exception {
          Path jarFile = USER_DIR.resolve(&quot;testprocess.jar&quot;);
          Manifest manifest = createManifest();
</pre>
<center><a href="../../text/resources/LocaleDataTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../jhsdb/BasicLauncherTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>