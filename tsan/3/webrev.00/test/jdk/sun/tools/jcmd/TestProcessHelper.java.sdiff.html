<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/tools/jcmd/TestProcessHelper.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../text/resources/LocaleDataTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../jhsdb/BasicLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/tools/jcmd/TestProcessHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-removed"> 24 import jdk.internal.module.ModuleInfoWriter;</span>
<span class="line-removed"> 25 import jdk.test.lib.JDKToolFinder;</span>
<span class="line-removed"> 26 import jdk.test.lib.process.ProcessTools;</span>
<span class="line-removed"> 27 import jdk.test.lib.util.JarUtils;</span>
<span class="line-removed"> 28 import sun.tools.common.ProcessHelper;</span>
<span class="line-removed"> 29 </span>
 30 import java.io.File;
 31 import java.io.IOException;
 32 import java.io.OutputStream;


 33 import java.lang.module.ModuleDescriptor;

 34 import java.nio.file.FileSystems;
 35 import java.nio.file.Files;
 36 import java.nio.file.Path;
 37 import java.util.ArrayList;
 38 import java.util.LinkedList;
 39 import java.util.List;
 40 import java.util.jar.Attributes;
 41 import java.util.jar.JarEntry;
 42 import java.util.jar.JarOutputStream;
 43 import java.util.jar.Manifest;
 44 import java.util.stream.Collectors;
 45 import java.util.stream.Stream;
 46 





 47 /*
 48  * @test
 49  * @bug 8205654
 50  * @summary Unit test for sun.tools.ProcessHelper class. The test launches Java processes with different Java options
 51  * and checks that sun.tools.ProcessHelper.getMainClass(pid) method returns a correct main class.                                                                                                                               return a .
 52  *
 53  * @requires os.family == &quot;linux&quot;
 54  * @library /test/lib
<span class="line-modified"> 55  * @modules jdk.jcmd/sun.tools.common</span>
 56  *          java.base/jdk.internal.module
 57  * @build test.TestProcess
 58  * @run main/othervm TestProcessHelper
 59  */
 60 public class TestProcessHelper {
 61 
<span class="line-removed"> 62     private ProcessHelper PROCESS_HELPER = ProcessHelper.platformProcessHelper();</span>
<span class="line-removed"> 63 </span>
 64     private static final String TEST_PROCESS_MAIN_CLASS_NAME = &quot;TestProcess&quot;;
 65     private static final String TEST_PROCESS_MAIN_CLASS_PACKAGE = &quot;test&quot;;
 66     private static final String TEST_PROCESS_MAIN_CLASS = TEST_PROCESS_MAIN_CLASS_PACKAGE + &quot;.&quot;
 67             + TEST_PROCESS_MAIN_CLASS_NAME;
 68     private static final Path TEST_CLASSES = FileSystems.getDefault().getPath(System.getProperty(&quot;test.classes&quot;));
 69     private static final Path USER_DIR = FileSystems.getDefault().getPath(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));
 70     private static final Path TEST_MODULES = USER_DIR.resolve(&quot;testmodules&quot;);
 71     private static final String JAVA_PATH = JDKToolFinder.getJDKTool(&quot;java&quot;);
 72     private static final Path TEST_CLASS = TEST_CLASSES.resolve(TEST_PROCESS_MAIN_CLASS_PACKAGE)
 73             .resolve(TEST_PROCESS_MAIN_CLASS_NAME + &quot;.class&quot;);
 74 
 75     private static final String[] CP_OPTIONS = {&quot;-cp&quot;, &quot;-classpath&quot;, &quot;--class-path&quot;};
<span class="line-modified"> 76     private static final String[][] VM_ARGS = {{}, {&quot;-Dtest1=aaa&quot;}, {&quot;-Dtest1=aaa&quot;, &quot;-Dtest2=bbb&quot;}};</span>
 77     private static final String[][] ARGS = {{}, {&quot;param1&quot;}, {&quot;param1&quot;, &quot;param2&quot;}};
 78     private static final String[] MP_OPTIONS = {&quot;-p&quot;, &quot;--module-path&quot;};
<span class="line-modified"> 79     private static final String[] MODULE_OPTIONS = {&quot;-m&quot;, &quot;--module&quot;};</span>
 80     private static final String JAR_OPTION = &quot;-jar&quot;;
 81     private static final String MODULE_NAME = &quot;module1&quot;;























 82 








 83 
 84     public static void main(String[] args) throws Exception {
 85         new TestProcessHelper().runTests();
 86     }
 87 
 88     public void runTests() throws Exception {
 89         testClassPath();
 90         testJar();
 91         testModule();
 92     }
 93 
 94     // Test Java processes that are started with -classpath, -cp, or --class-path options
 95     // and with different combinations of VM and program args.
 96     private void testClassPath() throws Exception {
 97         for (String cp : CP_OPTIONS) {
 98             for (String[] vma : VM_ARGS) {
 99                 for (String[] arg : ARGS) {
<span class="line-modified">100                     List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="line-modified">101                     cmd.add(JAVA_PATH);</span>
<span class="line-modified">102                     cmd.add(cp);</span>
<span class="line-modified">103                     cmd.add(TEST_CLASSES.toAbsolutePath().toString());</span>
<span class="line-modified">104                     for (String v : vma) {</span>
<span class="line-modified">105                         cmd.add(v);</span>
<span class="line-modified">106                     }</span>
<span class="line-modified">107                     cmd.add(TEST_PROCESS_MAIN_CLASS);</span>
<span class="line-modified">108                     for (String a : arg) {</span>
<span class="line-modified">109                         cmd.add(a);</span>







110                     }
<span class="line-removed">111                     testProcessHelper(cmd);</span>
112                 }
113             }
114         }
115     }
116 
117     // Test Java processes that are started with -jar option
118     // and with different combinations of VM and program args.
119     private void testJar() throws Exception {
120         File jarFile = prepareJar();
121         for (String[] vma : VM_ARGS) {
122             for (String[] arg : ARGS) {
123                 List&lt;String&gt; cmd = new LinkedList&lt;&gt;();
124                 cmd.add(JAVA_PATH);
125                 for (String v : vma) {
126                     cmd.add(v);
127                 }
128                 cmd.add(JAR_OPTION);
129                 cmd.add(jarFile.getAbsolutePath());
130                 for (String a : arg) {
131                     cmd.add(a);
132                 }
<span class="line-modified">133                 testProcessHelper(cmd);</span>
134             }
135         }
136 
137     }
138 
139     // Test Java processes that are started with -m or --module options
140     // and with different combination of VM and program args.
141     private void testModule() throws Exception {
142         prepareModule();
143         for (String mp : MP_OPTIONS) {
144             for (String m : MODULE_OPTIONS) {
145                 for (String[] vma : VM_ARGS) {
146                     for (String[] arg : ARGS) {
<span class="line-modified">147                         List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="line-modified">148                         cmd.add(JAVA_PATH);</span>
<span class="line-modified">149                         cmd.add(mp);</span>
<span class="line-modified">150                         cmd.add(TEST_MODULES.toAbsolutePath().toString());</span>
<span class="line-modified">151                         for (String v : vma) {</span>
<span class="line-modified">152                             cmd.add(v);</span>
















153                         }
<span class="line-removed">154                         cmd.add(m);</span>
<span class="line-removed">155                         cmd.add(MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="line-removed">156                         for (String a : arg) {</span>
<span class="line-removed">157                             cmd.add(a);</span>
<span class="line-removed">158                         }</span>
<span class="line-removed">159                         testProcessHelper(cmd);</span>
160                     }
161                 }
162             }
163         }
164     }
165 
166     private void checkMainClass(Process p, String expectedMainClass) {
<span class="line-modified">167         String mainClass = PROCESS_HELPER.getMainClass(Long.toString(p.pid()));</span>




















168         p.destroyForcibly();
169         if (!expectedMainClass.equals(mainClass)) {
170             throw new RuntimeException(&quot;Main class is wrong: &quot; + mainClass);
171         }
172     }
173 
<span class="line-modified">174     private void testProcessHelper(List&lt;String&gt; args) throws Exception {</span>
175         ProcessBuilder pb = new ProcessBuilder(args);
176         String cmd = pb.command().stream().collect(Collectors.joining(&quot; &quot;));
177         System.out.println(&quot;Starting the process:&quot; + cmd);
178         Process p = ProcessTools.startProcess(&quot;test&quot;, pb);
179         if (!p.isAlive()) {
180             throw new RuntimeException(&quot;Cannot start the process: &quot; + cmd);
181         }
<span class="line-modified">182         checkMainClass(p, TEST_PROCESS_MAIN_CLASS);</span>
183     }
184 
185     private File prepareJar() throws Exception {
186         Path jarFile = USER_DIR.resolve(&quot;testprocess.jar&quot;);
187         Manifest manifest = createManifest();
188         JarUtils.createJarFile(jarFile, manifest, TEST_CLASSES, TEST_CLASS);
189         return jarFile.toFile();
190     }
191 
192     private void prepareModule() throws Exception {
193         TEST_MODULES.toFile().mkdirs();
194         Path moduleJar = TEST_MODULES.resolve(&quot;mod1.jar&quot;);
195         ModuleDescriptor md = createModuleDescriptor();
196         createModuleJarFile(moduleJar, md, TEST_CLASSES, TEST_CLASS);
197     }
198 
199     private Manifest createManifest() {
200         Manifest manifest = new Manifest();
201         manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION, &quot;1.0&quot;);
202         manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS, TEST_PROCESS_MAIN_CLASS);
</pre>
</td>
<td>
<hr />
<pre>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 






 24 import java.io.File;
 25 import java.io.IOException;
 26 import java.io.OutputStream;
<span class="line-added"> 27 import java.lang.invoke.MethodHandle;</span>
<span class="line-added"> 28 import java.lang.invoke.MethodHandles;</span>
 29 import java.lang.module.ModuleDescriptor;
<span class="line-added"> 30 import java.lang.reflect.Method;</span>
 31 import java.nio.file.FileSystems;
 32 import java.nio.file.Files;
 33 import java.nio.file.Path;
 34 import java.util.ArrayList;
 35 import java.util.LinkedList;
 36 import java.util.List;
 37 import java.util.jar.Attributes;
 38 import java.util.jar.JarEntry;
 39 import java.util.jar.JarOutputStream;
 40 import java.util.jar.Manifest;
 41 import java.util.stream.Collectors;
 42 import java.util.stream.Stream;
 43 
<span class="line-added"> 44 import jdk.internal.module.ModuleInfoWriter;</span>
<span class="line-added"> 45 import jdk.test.lib.JDKToolFinder;</span>
<span class="line-added"> 46 import jdk.test.lib.process.ProcessTools;</span>
<span class="line-added"> 47 import jdk.test.lib.util.JarUtils;</span>
<span class="line-added"> 48 </span>
 49 /*
 50  * @test
 51  * @bug 8205654
 52  * @summary Unit test for sun.tools.ProcessHelper class. The test launches Java processes with different Java options
 53  * and checks that sun.tools.ProcessHelper.getMainClass(pid) method returns a correct main class.                                                                                                                               return a .
 54  *
 55  * @requires os.family == &quot;linux&quot;
 56  * @library /test/lib
<span class="line-modified"> 57  * @modules jdk.jcmd/sun.tools.common:+open</span>
 58  *          java.base/jdk.internal.module
 59  * @build test.TestProcess
 60  * @run main/othervm TestProcessHelper
 61  */
 62 public class TestProcessHelper {
 63 


 64     private static final String TEST_PROCESS_MAIN_CLASS_NAME = &quot;TestProcess&quot;;
 65     private static final String TEST_PROCESS_MAIN_CLASS_PACKAGE = &quot;test&quot;;
 66     private static final String TEST_PROCESS_MAIN_CLASS = TEST_PROCESS_MAIN_CLASS_PACKAGE + &quot;.&quot;
 67             + TEST_PROCESS_MAIN_CLASS_NAME;
 68     private static final Path TEST_CLASSES = FileSystems.getDefault().getPath(System.getProperty(&quot;test.classes&quot;));
 69     private static final Path USER_DIR = FileSystems.getDefault().getPath(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));
 70     private static final Path TEST_MODULES = USER_DIR.resolve(&quot;testmodules&quot;);
 71     private static final String JAVA_PATH = JDKToolFinder.getJDKTool(&quot;java&quot;);
 72     private static final Path TEST_CLASS = TEST_CLASSES.resolve(TEST_PROCESS_MAIN_CLASS_PACKAGE)
 73             .resolve(TEST_PROCESS_MAIN_CLASS_NAME + &quot;.class&quot;);
 74 
 75     private static final String[] CP_OPTIONS = {&quot;-cp&quot;, &quot;-classpath&quot;, &quot;--class-path&quot;};
<span class="line-modified"> 76     private static final String[][] VM_ARGS = {{}, {&quot;-Dtest1=aaa&quot;}, {&quot;-Dtest1=aaa&quot;, &quot;-Dtest2=bbb ccc&quot;}};</span>
 77     private static final String[][] ARGS = {{}, {&quot;param1&quot;}, {&quot;param1&quot;, &quot;param2&quot;}};
 78     private static final String[] MP_OPTIONS = {&quot;-p&quot;, &quot;--module-path&quot;};
<span class="line-modified"> 79     private static final String[] MODULE_OPTIONS = {&quot;-m&quot;, &quot;--module&quot;, &quot;--module=&quot;};</span>
 80     private static final String JAR_OPTION = &quot;-jar&quot;;
 81     private static final String MODULE_NAME = &quot;module1&quot;;
<span class="line-added"> 82     private static final String[][] EXTRA_MODULAR_OPTIONS = {null,</span>
<span class="line-added"> 83             {&quot;--add-opens&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="line-added"> 84             {&quot;--add-exports&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="line-added"> 85             {&quot;--add-reads&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;},</span>
<span class="line-added"> 86             {&quot;--add-modules&quot;, &quot;java.management&quot;},</span>
<span class="line-added"> 87             {&quot;--limit-modules&quot;, &quot;java.management&quot;},</span>
<span class="line-added"> 88             {&quot;--upgrade-module-path&quot;, &quot;test&quot;}};</span>
<span class="line-added"> 89 </span>
<span class="line-added"> 90     private static final String[] PATCH_MODULE_OPTIONS = {&quot;--patch-module&quot;, null};</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92     private static final MethodHandle MH_GET_MAIN_CLASS = resolveMainClassMH();</span>
<span class="line-added"> 93 </span>
<span class="line-added"> 94     private static MethodHandle resolveMainClassMH() {</span>
<span class="line-added"> 95         try {</span>
<span class="line-added"> 96             Method getMainClassMethod = Class</span>
<span class="line-added"> 97                 .forName(&quot;sun.tools.common.ProcessHelper&quot;)</span>
<span class="line-added"> 98                 .getDeclaredMethod(&quot;getMainClass&quot;, String.class);</span>
<span class="line-added"> 99             getMainClassMethod.setAccessible(true);</span>
<span class="line-added">100             return MethodHandles.lookup().unreflect(getMainClassMethod);</span>
<span class="line-added">101         } catch (ClassNotFoundException | NoSuchMethodException | SecurityException | IllegalAccessException e) {</span>
<span class="line-added">102             throw new RuntimeException(e);</span>
<span class="line-added">103         }</span>
<span class="line-added">104     }</span>
105 
<span class="line-added">106     private static String callGetMainClass(Process p) {</span>
<span class="line-added">107         try {</span>
<span class="line-added">108             return (String)MH_GET_MAIN_CLASS.invoke(Long.toString(p.pid()));</span>
<span class="line-added">109         } catch (Throwable e) {</span>
<span class="line-added">110             throw new RuntimeException(e);</span>
<span class="line-added">111         }</span>
<span class="line-added">112 </span>
<span class="line-added">113     }</span>
114 
115     public static void main(String[] args) throws Exception {
116         new TestProcessHelper().runTests();
117     }
118 
119     public void runTests() throws Exception {
120         testClassPath();
121         testJar();
122         testModule();
123     }
124 
125     // Test Java processes that are started with -classpath, -cp, or --class-path options
126     // and with different combinations of VM and program args.
127     private void testClassPath() throws Exception {
128         for (String cp : CP_OPTIONS) {
129             for (String[] vma : VM_ARGS) {
130                 for (String[] arg : ARGS) {
<span class="line-modified">131                     for (String[] modularOptions : EXTRA_MODULAR_OPTIONS) {</span>
<span class="line-modified">132                         List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="line-modified">133                         cmd.add(JAVA_PATH);</span>
<span class="line-modified">134                         cmd.add(cp);</span>
<span class="line-modified">135                         cmd.add(TEST_CLASSES.toAbsolutePath().toString());</span>
<span class="line-modified">136                         for (String v : vma) {</span>
<span class="line-modified">137                             cmd.add(v);</span>
<span class="line-modified">138                         }</span>
<span class="line-modified">139                         if (modularOptions != null) {</span>
<span class="line-modified">140                             cmd.add(modularOptions[0]);</span>
<span class="line-added">141                             cmd.add(modularOptions[1]);</span>
<span class="line-added">142                         }</span>
<span class="line-added">143                         cmd.add(TEST_PROCESS_MAIN_CLASS);</span>
<span class="line-added">144                         for (String a : arg) {</span>
<span class="line-added">145                             cmd.add(a);</span>
<span class="line-added">146                         }</span>
<span class="line-added">147                         testProcessHelper(cmd, TEST_PROCESS_MAIN_CLASS);</span>
148                     }

149                 }
150             }
151         }
152     }
153 
154     // Test Java processes that are started with -jar option
155     // and with different combinations of VM and program args.
156     private void testJar() throws Exception {
157         File jarFile = prepareJar();
158         for (String[] vma : VM_ARGS) {
159             for (String[] arg : ARGS) {
160                 List&lt;String&gt; cmd = new LinkedList&lt;&gt;();
161                 cmd.add(JAVA_PATH);
162                 for (String v : vma) {
163                     cmd.add(v);
164                 }
165                 cmd.add(JAR_OPTION);
166                 cmd.add(jarFile.getAbsolutePath());
167                 for (String a : arg) {
168                     cmd.add(a);
169                 }
<span class="line-modified">170                 testProcessHelper(cmd, jarFile.getAbsolutePath());</span>
171             }
172         }
173 
174     }
175 
176     // Test Java processes that are started with -m or --module options
177     // and with different combination of VM and program args.
178     private void testModule() throws Exception {
179         prepareModule();
180         for (String mp : MP_OPTIONS) {
181             for (String m : MODULE_OPTIONS) {
182                 for (String[] vma : VM_ARGS) {
183                     for (String[] arg : ARGS) {
<span class="line-modified">184                         for(String patchModuleOption : PATCH_MODULE_OPTIONS) {</span>
<span class="line-modified">185                             List&lt;String&gt; cmd = new LinkedList&lt;&gt;();</span>
<span class="line-modified">186                             cmd.add(JAVA_PATH);</span>
<span class="line-modified">187                             cmd.add(mp);</span>
<span class="line-modified">188                             cmd.add(TEST_MODULES.toAbsolutePath().toString());</span>
<span class="line-modified">189                             if (patchModuleOption != null) {</span>
<span class="line-added">190                                 cmd.add(patchModuleOption);</span>
<span class="line-added">191                                 cmd.add(MODULE_NAME + &quot;=&quot; + TEST_MODULES.toAbsolutePath().toString());</span>
<span class="line-added">192                             }</span>
<span class="line-added">193                             for (String v : vma) {</span>
<span class="line-added">194                                 cmd.add(v);</span>
<span class="line-added">195                             }</span>
<span class="line-added">196                             if (m.endsWith(&quot;=&quot;)) {</span>
<span class="line-added">197                                 cmd.add(m + MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="line-added">198                             } else {</span>
<span class="line-added">199                                 cmd.add(m);</span>
<span class="line-added">200                                 cmd.add(MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
<span class="line-added">201                             }</span>
<span class="line-added">202                             for (String a : arg) {</span>
<span class="line-added">203                                 cmd.add(a);</span>
<span class="line-added">204                             }</span>
<span class="line-added">205                             testProcessHelper(cmd, MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);</span>
206                         }






207                     }
208                 }
209             }
210         }
211     }
212 
213     private void checkMainClass(Process p, String expectedMainClass) {
<span class="line-modified">214         String mainClass = callGetMainClass(p);</span>
<span class="line-added">215         // getMainClass() may return null, e.g. due to timing issues.</span>
<span class="line-added">216         // Attempt some limited retries.</span>
<span class="line-added">217         if (mainClass == null) {</span>
<span class="line-added">218             System.err.println(&quot;Main class returned by ProcessHelper was null.&quot;);</span>
<span class="line-added">219             // sleep time doubles each round, altogether, wait no longer than 1 sec</span>
<span class="line-added">220             final int MAX_RETRIES = 10;</span>
<span class="line-added">221             int retrycount = 0;</span>
<span class="line-added">222             long sleepms = 1;</span>
<span class="line-added">223             while (retrycount &lt; MAX_RETRIES &amp;&amp; mainClass == null) {</span>
<span class="line-added">224                 System.err.println(&quot;Retry &quot; + retrycount + &quot;, sleeping for &quot; + sleepms + &quot;ms.&quot;);</span>
<span class="line-added">225                 try {</span>
<span class="line-added">226                     Thread.sleep(sleepms);</span>
<span class="line-added">227                 } catch (InterruptedException e) {</span>
<span class="line-added">228                     // ignore</span>
<span class="line-added">229                 }</span>
<span class="line-added">230                 mainClass = callGetMainClass(p);</span>
<span class="line-added">231                 retrycount++;</span>
<span class="line-added">232                 sleepms *= 2;</span>
<span class="line-added">233             }</span>
<span class="line-added">234         }</span>
235         p.destroyForcibly();
236         if (!expectedMainClass.equals(mainClass)) {
237             throw new RuntimeException(&quot;Main class is wrong: &quot; + mainClass);
238         }
239     }
240 
<span class="line-modified">241     private void testProcessHelper(List&lt;String&gt; args, String expectedValue) throws Exception {</span>
242         ProcessBuilder pb = new ProcessBuilder(args);
243         String cmd = pb.command().stream().collect(Collectors.joining(&quot; &quot;));
244         System.out.println(&quot;Starting the process:&quot; + cmd);
245         Process p = ProcessTools.startProcess(&quot;test&quot;, pb);
246         if (!p.isAlive()) {
247             throw new RuntimeException(&quot;Cannot start the process: &quot; + cmd);
248         }
<span class="line-modified">249         checkMainClass(p, expectedValue);</span>
250     }
251 
252     private File prepareJar() throws Exception {
253         Path jarFile = USER_DIR.resolve(&quot;testprocess.jar&quot;);
254         Manifest manifest = createManifest();
255         JarUtils.createJarFile(jarFile, manifest, TEST_CLASSES, TEST_CLASS);
256         return jarFile.toFile();
257     }
258 
259     private void prepareModule() throws Exception {
260         TEST_MODULES.toFile().mkdirs();
261         Path moduleJar = TEST_MODULES.resolve(&quot;mod1.jar&quot;);
262         ModuleDescriptor md = createModuleDescriptor();
263         createModuleJarFile(moduleJar, md, TEST_CLASSES, TEST_CLASS);
264     }
265 
266     private Manifest createManifest() {
267         Manifest manifest = new Manifest();
268         manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION, &quot;1.0&quot;);
269         manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS, TEST_PROCESS_MAIN_CLASS);
</pre>
</td>
</tr>
</table>
<center><a href="../../text/resources/LocaleDataTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../jhsdb/BasicLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>