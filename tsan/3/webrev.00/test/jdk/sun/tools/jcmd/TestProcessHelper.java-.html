<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/tools/jcmd/TestProcessHelper.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import jdk.internal.module.ModuleInfoWriter;
 25 import jdk.test.lib.JDKToolFinder;
 26 import jdk.test.lib.process.ProcessTools;
 27 import jdk.test.lib.util.JarUtils;
 28 import sun.tools.common.ProcessHelper;
 29 
 30 import java.io.File;
 31 import java.io.IOException;
 32 import java.io.OutputStream;
 33 import java.lang.module.ModuleDescriptor;
 34 import java.nio.file.FileSystems;
 35 import java.nio.file.Files;
 36 import java.nio.file.Path;
 37 import java.util.ArrayList;
 38 import java.util.LinkedList;
 39 import java.util.List;
 40 import java.util.jar.Attributes;
 41 import java.util.jar.JarEntry;
 42 import java.util.jar.JarOutputStream;
 43 import java.util.jar.Manifest;
 44 import java.util.stream.Collectors;
 45 import java.util.stream.Stream;
 46 
 47 /*
 48  * @test
 49  * @bug 8205654
 50  * @summary Unit test for sun.tools.ProcessHelper class. The test launches Java processes with different Java options
 51  * and checks that sun.tools.ProcessHelper.getMainClass(pid) method returns a correct main class.                                                                                                                               return a .
 52  *
 53  * @requires os.family == &quot;linux&quot;
 54  * @library /test/lib
 55  * @modules jdk.jcmd/sun.tools.common
 56  *          java.base/jdk.internal.module
 57  * @build test.TestProcess
 58  * @run main/othervm TestProcessHelper
 59  */
 60 public class TestProcessHelper {
 61 
 62     private ProcessHelper PROCESS_HELPER = ProcessHelper.platformProcessHelper();
 63 
 64     private static final String TEST_PROCESS_MAIN_CLASS_NAME = &quot;TestProcess&quot;;
 65     private static final String TEST_PROCESS_MAIN_CLASS_PACKAGE = &quot;test&quot;;
 66     private static final String TEST_PROCESS_MAIN_CLASS = TEST_PROCESS_MAIN_CLASS_PACKAGE + &quot;.&quot;
 67             + TEST_PROCESS_MAIN_CLASS_NAME;
 68     private static final Path TEST_CLASSES = FileSystems.getDefault().getPath(System.getProperty(&quot;test.classes&quot;));
 69     private static final Path USER_DIR = FileSystems.getDefault().getPath(System.getProperty(&quot;user.dir&quot;, &quot;.&quot;));
 70     private static final Path TEST_MODULES = USER_DIR.resolve(&quot;testmodules&quot;);
 71     private static final String JAVA_PATH = JDKToolFinder.getJDKTool(&quot;java&quot;);
 72     private static final Path TEST_CLASS = TEST_CLASSES.resolve(TEST_PROCESS_MAIN_CLASS_PACKAGE)
 73             .resolve(TEST_PROCESS_MAIN_CLASS_NAME + &quot;.class&quot;);
 74 
 75     private static final String[] CP_OPTIONS = {&quot;-cp&quot;, &quot;-classpath&quot;, &quot;--class-path&quot;};
 76     private static final String[][] VM_ARGS = {{}, {&quot;-Dtest1=aaa&quot;}, {&quot;-Dtest1=aaa&quot;, &quot;-Dtest2=bbb&quot;}};
 77     private static final String[][] ARGS = {{}, {&quot;param1&quot;}, {&quot;param1&quot;, &quot;param2&quot;}};
 78     private static final String[] MP_OPTIONS = {&quot;-p&quot;, &quot;--module-path&quot;};
 79     private static final String[] MODULE_OPTIONS = {&quot;-m&quot;, &quot;--module&quot;};
 80     private static final String JAR_OPTION = &quot;-jar&quot;;
 81     private static final String MODULE_NAME = &quot;module1&quot;;
 82 
 83 
 84     public static void main(String[] args) throws Exception {
 85         new TestProcessHelper().runTests();
 86     }
 87 
 88     public void runTests() throws Exception {
 89         testClassPath();
 90         testJar();
 91         testModule();
 92     }
 93 
 94     // Test Java processes that are started with -classpath, -cp, or --class-path options
 95     // and with different combinations of VM and program args.
 96     private void testClassPath() throws Exception {
 97         for (String cp : CP_OPTIONS) {
 98             for (String[] vma : VM_ARGS) {
 99                 for (String[] arg : ARGS) {
100                     List&lt;String&gt; cmd = new LinkedList&lt;&gt;();
101                     cmd.add(JAVA_PATH);
102                     cmd.add(cp);
103                     cmd.add(TEST_CLASSES.toAbsolutePath().toString());
104                     for (String v : vma) {
105                         cmd.add(v);
106                     }
107                     cmd.add(TEST_PROCESS_MAIN_CLASS);
108                     for (String a : arg) {
109                         cmd.add(a);
110                     }
111                     testProcessHelper(cmd);
112                 }
113             }
114         }
115     }
116 
117     // Test Java processes that are started with -jar option
118     // and with different combinations of VM and program args.
119     private void testJar() throws Exception {
120         File jarFile = prepareJar();
121         for (String[] vma : VM_ARGS) {
122             for (String[] arg : ARGS) {
123                 List&lt;String&gt; cmd = new LinkedList&lt;&gt;();
124                 cmd.add(JAVA_PATH);
125                 for (String v : vma) {
126                     cmd.add(v);
127                 }
128                 cmd.add(JAR_OPTION);
129                 cmd.add(jarFile.getAbsolutePath());
130                 for (String a : arg) {
131                     cmd.add(a);
132                 }
133                 testProcessHelper(cmd);
134             }
135         }
136 
137     }
138 
139     // Test Java processes that are started with -m or --module options
140     // and with different combination of VM and program args.
141     private void testModule() throws Exception {
142         prepareModule();
143         for (String mp : MP_OPTIONS) {
144             for (String m : MODULE_OPTIONS) {
145                 for (String[] vma : VM_ARGS) {
146                     for (String[] arg : ARGS) {
147                         List&lt;String&gt; cmd = new LinkedList&lt;&gt;();
148                         cmd.add(JAVA_PATH);
149                         cmd.add(mp);
150                         cmd.add(TEST_MODULES.toAbsolutePath().toString());
151                         for (String v : vma) {
152                             cmd.add(v);
153                         }
154                         cmd.add(m);
155                         cmd.add(MODULE_NAME + &quot;/&quot; + TEST_PROCESS_MAIN_CLASS);
156                         for (String a : arg) {
157                             cmd.add(a);
158                         }
159                         testProcessHelper(cmd);
160                     }
161                 }
162             }
163         }
164     }
165 
166     private void checkMainClass(Process p, String expectedMainClass) {
167         String mainClass = PROCESS_HELPER.getMainClass(Long.toString(p.pid()));
168         p.destroyForcibly();
169         if (!expectedMainClass.equals(mainClass)) {
170             throw new RuntimeException(&quot;Main class is wrong: &quot; + mainClass);
171         }
172     }
173 
174     private void testProcessHelper(List&lt;String&gt; args) throws Exception {
175         ProcessBuilder pb = new ProcessBuilder(args);
176         String cmd = pb.command().stream().collect(Collectors.joining(&quot; &quot;));
177         System.out.println(&quot;Starting the process:&quot; + cmd);
178         Process p = ProcessTools.startProcess(&quot;test&quot;, pb);
179         if (!p.isAlive()) {
180             throw new RuntimeException(&quot;Cannot start the process: &quot; + cmd);
181         }
182         checkMainClass(p, TEST_PROCESS_MAIN_CLASS);
183     }
184 
185     private File prepareJar() throws Exception {
186         Path jarFile = USER_DIR.resolve(&quot;testprocess.jar&quot;);
187         Manifest manifest = createManifest();
188         JarUtils.createJarFile(jarFile, manifest, TEST_CLASSES, TEST_CLASS);
189         return jarFile.toFile();
190     }
191 
192     private void prepareModule() throws Exception {
193         TEST_MODULES.toFile().mkdirs();
194         Path moduleJar = TEST_MODULES.resolve(&quot;mod1.jar&quot;);
195         ModuleDescriptor md = createModuleDescriptor();
196         createModuleJarFile(moduleJar, md, TEST_CLASSES, TEST_CLASS);
197     }
198 
199     private Manifest createManifest() {
200         Manifest manifest = new Manifest();
201         manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION, &quot;1.0&quot;);
202         manifest.getMainAttributes().put(Attributes.Name.MAIN_CLASS, TEST_PROCESS_MAIN_CLASS);
203         return manifest;
204     }
205 
206     private ModuleDescriptor createModuleDescriptor() {
207         ModuleDescriptor.Builder builder
208                 = ModuleDescriptor.newModule(MODULE_NAME).requires(&quot;java.base&quot;);
209         return builder.build();
210     }
211 
212     private static void createModuleJarFile(Path jarfile, ModuleDescriptor md, Path dir, Path... files)
213             throws IOException {
214 
215         Path parent = jarfile.getParent();
216         if (parent != null) {
217             Files.createDirectories(parent);
218         }
219 
220         List&lt;Path&gt; entries = findAllRegularFiles(dir, files);
221 
222         try (OutputStream out = Files.newOutputStream(jarfile);
223              JarOutputStream jos = new JarOutputStream(out)) {
224             if (md != null) {
225                 JarEntry je = new JarEntry(&quot;module-info.class&quot;);
226                 jos.putNextEntry(je);
227                 ModuleInfoWriter.write(md, jos);
228                 jos.closeEntry();
229             }
230 
231             for (Path entry : entries) {
232                 String name = toJarEntryName(entry);
233                 jos.putNextEntry(new JarEntry(name));
234                 Files.copy(dir.resolve(entry), jos);
235                 jos.closeEntry();
236             }
237         }
238     }
239 
240     private static String toJarEntryName(Path file) {
241         Path normalized = file.normalize();
242         return normalized.subpath(0, normalized.getNameCount())
243                 .toString()
244                 .replace(File.separatorChar, &#39;/&#39;);
245     }
246 
247     private static List&lt;Path&gt; findAllRegularFiles(Path dir, Path[] files) throws IOException {
248         List&lt;Path&gt; entries = new ArrayList&lt;&gt;();
249         for (Path file : files) {
250             try (Stream&lt;Path&gt; stream = Files.find(dir.resolve(file), Integer.MAX_VALUE,
251                     (p, attrs) -&gt; attrs.isRegularFile())) {
252                 stream.map(dir::relativize)
253                         .forEach(entries::add);
254             }
255         }
256         return entries;
257     }
258 
259 }
    </pre>
  </body>
</html>