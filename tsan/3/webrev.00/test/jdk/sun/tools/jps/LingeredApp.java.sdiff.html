<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/tools/jps/LingeredApp.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="JpsHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="LingeredAppForJps.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/tools/jps/LingeredApp.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.BufferedReader;
 25 import java.io.IOException;
 26 import java.io.InputStream;
 27 import java.io.InputStreamReader;
 28 import java.nio.file.Files;
 29 import java.nio.file.NoSuchFileException;
 30 import java.nio.file.Path;
 31 import java.nio.file.Paths;
 32 import java.nio.file.attribute.BasicFileAttributes;
 33 import java.nio.file.attribute.FileTime;
 34 import java.util.ArrayList;

 35 import java.util.Date;
 36 import java.util.List;
 37 import java.util.Map;
 38 import java.util.UUID;

 39 
 40 /**
 41  * This is a framework to launch an app that could be synchronized with caller
 42  * to make further attach actions reliable across supported platforms
 43 
 44  * Caller example:
 45  *   SmartTestApp a = SmartTestApp.startApp(cmd);
 46  *     // do something
 47  *   a.stopApp();
 48  *
 49  *   or fine grained control
 50  *
 51  *   a = new SmartTestApp(&quot;MyLock.lck&quot;);
 52  *   a.createLock();
 53  *   a.runApp();
 54  *   a.waitAppReady();
 55  *     // do something
 56  *   a.deleteLock();
 57  *   a.waitAppTerminate();
 58  *
</pre>
<hr />
<pre>
240                 break;
241             }
242 
243             // Make sure process didn&#39;t already exit
244             if (!appProcess.isAlive()) {
245                 throw new IOException(&quot;App exited unexpectedly with &quot; + appProcess.exitValue());
246             }
247 
248             try {
249                 Thread.sleep(spinDelay);
250             } catch (InterruptedException ex) {
251                 // pass
252             }
253         }
254     }
255 
256     /**
257      * Analyze an environment and prepare a command line to
258      * run the app, app name should be added explicitly
259      */
<span class="line-modified">260     public List&lt;String&gt; runAppPrepare(List&lt;String&gt; vmArguments) {</span>
261         // We should always use testjava or throw an exception,
262         // so we can&#39;t use JDKToolFinder.getJDKTool(&quot;java&quot;);
263         // that falls back to compile java on error
264         String jdkPath = System.getProperty(&quot;test.jdk&quot;);
265         if (jdkPath == null) {
266             // we are not under jtreg, try env
267             Map&lt;String, String&gt; env = System.getenv();
268             jdkPath = env.get(&quot;TESTJAVA&quot;);
269         }
270 
271         if (jdkPath == null) {
272             throw new RuntimeException(&quot;Can&#39;t determine jdk path neither test.jdk property no TESTJAVA env are set&quot;);
273         }
274 
275         String osname = System.getProperty(&quot;os.name&quot;);
276         String javapath = jdkPath + ((osname.startsWith(&quot;window&quot;)) ? &quot;/bin/java.exe&quot; : &quot;/bin/java&quot;);
277 
278         List&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
279         cmd.add(javapath);
280 
<span class="line-removed">281 </span>
282         if (vmArguments == null) {
<span class="line-modified">283             // Propagate test.vm.options to LingeredApp, filter out possible empty options</span>
<span class="line-modified">284             String testVmOpts[] = System.getProperty(&quot;test.vm.opts&quot;,&quot;&quot;).split(&quot;\\s+&quot;);</span>
<span class="line-modified">285             for (String s : testVmOpts) {</span>
<span class="line-removed">286                 if (!s.equals(&quot;&quot;)) {</span>
<span class="line-removed">287                     cmd.add(s);</span>
<span class="line-removed">288                 }</span>
<span class="line-removed">289             }</span>
<span class="line-removed">290         }</span>
<span class="line-removed">291         else{</span>
292             // Lets user manage LingeredApp options
<span class="line-removed">293             cmd.addAll(vmArguments);</span>
294         }

295 
296         // Make sure we set correct classpath to run the app
297         cmd.add(&quot;-cp&quot;);
298         String classpath = System.getProperty(&quot;test.class.path&quot;);
299         cmd.add((classpath == null) ? &quot;.&quot; : classpath);
300 
301         return cmd;
302     }
303 
304     /**
305      * Assemble command line to a printable string
306      */
307     public void printCommandLine(List&lt;String&gt; cmd) {
308         // A bit of verbosity
309         StringBuilder cmdLine = new StringBuilder();
310         for (String strCmd : cmd) {
311             cmdLine.append(&quot;&#39;&quot;).append(strCmd).append(&quot;&#39; &quot;);
312         }
313 
314         System.out.println(&quot;Command line: [&quot; + cmdLine.toString() + &quot;]&quot;);
315     }
316 
317     public void startGobblerPipe() {
318       // Create pipe reader for process, and read stdin and stderr to array of strings
319       InputGobbler gb = new InputGobbler(appProcess.getInputStream(), storedAppOutput);
320       gb.start();
321     }
322 
323     /**
324      * Run the app.
325      *
326      * @param vmArguments
327      * @throws IOException
328      */
<span class="line-modified">329     public void runApp(List&lt;String&gt; vmArguments)</span>
330             throws IOException {
331 
332         List&lt;String&gt; cmd = runAppPrepare(vmArguments);
333 
334         cmd.add(this.getAppName());
335         cmd.add(lockFileName);
336 
337         printCommandLine(cmd);
338 
339         ProcessBuilder pb = new ProcessBuilder(cmd);
340         // we don&#39;t expect any error output but make sure we are not stuck on pipe
341         // pb.redirectErrorStream(false);
342         // ProcessBuilder.start can throw IOException
343         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
344         appProcess = pb.start();
345 
346         startGobblerPipe();
347     }
348 
349     /**
350      * Delete lock file that signals app to terminate, then
351      * wait until app is actually terminated.
352      * @throws IOException
353      */
354     public void stopApp() throws IOException {
355         deleteLock();
356         // The startApp() of the derived app can throw
357         // an exception before the LA actually starts
358         if (appProcess != null) {
359             waitAppTerminate();
360             int exitcode = appProcess.exitValue();
361             if (exitcode != 0) {
362                 throw new IOException(&quot;LingeredApp terminated with non-zero exit code &quot; + exitcode);
363             }
364         }
365     }
366 
367     /**
368      *  High level interface for test writers
369      */
<span class="line-removed">370     /**</span>
<span class="line-removed">371      * Factory method that creates LingeredApp object with ready to use application</span>
<span class="line-removed">372      * lock name is autogenerated</span>
<span class="line-removed">373      * @param cmd - vm options, could be null to auto add testvm.options</span>
<span class="line-removed">374      * @return LingeredApp object</span>
<span class="line-removed">375      * @throws IOException</span>
<span class="line-removed">376      */</span>
<span class="line-removed">377     public static LingeredApp startApp(List&lt;String&gt; cmd) throws IOException {</span>
<span class="line-removed">378         LingeredApp a = new LingeredApp();</span>
<span class="line-removed">379         a.createLock();</span>
<span class="line-removed">380         try {</span>
<span class="line-removed">381             a.runApp(cmd);</span>
<span class="line-removed">382             a.waitAppReady(appWaitTime);</span>
<span class="line-removed">383         } catch (Exception ex) {</span>
<span class="line-removed">384             a.deleteLock();</span>
<span class="line-removed">385             throw ex;</span>
<span class="line-removed">386         }</span>
<span class="line-removed">387 </span>
<span class="line-removed">388         return a;</span>
<span class="line-removed">389     }</span>
<span class="line-removed">390 </span>
391     /**
392      * Factory method that starts pre-created LingeredApp
393      * lock name is autogenerated
<span class="line-modified">394      * @param cmd - vm options, could be null to auto add testvm.options</span>
395      * @param theApp - app to start
<span class="line-removed">396      * @return LingeredApp object</span>
397      * @throws IOException
398      */
<span class="line-modified">399 </span>
<span class="line-removed">400     public static void startApp(List&lt;String&gt; cmd, LingeredApp theApp) throws IOException {</span>
401         theApp.createLock();
402         try {
403             theApp.runApp(cmd);
404             theApp.waitAppReady(appWaitTime);
405         } catch (Exception ex) {
406             theApp.deleteLock();
407             throw ex;
408         }
409     }
410 
<span class="line-modified">411     public static LingeredApp startApp() throws IOException {</span>
<span class="line-modified">412         return startApp(null);</span>









413     }
414 
415     public static void stopApp(LingeredApp app) throws IOException {
416         if (app != null) {
417             // LingeredApp can throw an exception during the intialization,
418             // make sure we don&#39;t have cascade NPE
419             app.stopApp();
420         }
421     }
422 
423     /**
424      * LastModified time might not work correctly in some cases it might
425      * cause later failures
426      */
427 
428     public static boolean isLastModifiedWorking() {
429         boolean sane = true;
430         try {
431             long lm = lastModified(&quot;.&quot;);
432             if (lm == 0) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.BufferedReader;
 25 import java.io.IOException;
 26 import java.io.InputStream;
 27 import java.io.InputStreamReader;
 28 import java.nio.file.Files;
 29 import java.nio.file.NoSuchFileException;
 30 import java.nio.file.Path;
 31 import java.nio.file.Paths;
 32 import java.nio.file.attribute.BasicFileAttributes;
 33 import java.nio.file.attribute.FileTime;
 34 import java.util.ArrayList;
<span class="line-added"> 35 import java.util.Collections;</span>
 36 import java.util.Date;
 37 import java.util.List;
 38 import java.util.Map;
 39 import java.util.UUID;
<span class="line-added"> 40 import jdk.test.lib.Utils;</span>
 41 
 42 /**
 43  * This is a framework to launch an app that could be synchronized with caller
 44  * to make further attach actions reliable across supported platforms
 45 
 46  * Caller example:
 47  *   SmartTestApp a = SmartTestApp.startApp(cmd);
 48  *     // do something
 49  *   a.stopApp();
 50  *
 51  *   or fine grained control
 52  *
 53  *   a = new SmartTestApp(&quot;MyLock.lck&quot;);
 54  *   a.createLock();
 55  *   a.runApp();
 56  *   a.waitAppReady();
 57  *     // do something
 58  *   a.deleteLock();
 59  *   a.waitAppTerminate();
 60  *
</pre>
<hr />
<pre>
242                 break;
243             }
244 
245             // Make sure process didn&#39;t already exit
246             if (!appProcess.isAlive()) {
247                 throw new IOException(&quot;App exited unexpectedly with &quot; + appProcess.exitValue());
248             }
249 
250             try {
251                 Thread.sleep(spinDelay);
252             } catch (InterruptedException ex) {
253                 // pass
254             }
255         }
256     }
257 
258     /**
259      * Analyze an environment and prepare a command line to
260      * run the app, app name should be added explicitly
261      */
<span class="line-modified">262     public List&lt;String&gt; runAppPrepare(String[] vmArguments) {</span>
263         // We should always use testjava or throw an exception,
264         // so we can&#39;t use JDKToolFinder.getJDKTool(&quot;java&quot;);
265         // that falls back to compile java on error
266         String jdkPath = System.getProperty(&quot;test.jdk&quot;);
267         if (jdkPath == null) {
268             // we are not under jtreg, try env
269             Map&lt;String, String&gt; env = System.getenv();
270             jdkPath = env.get(&quot;TESTJAVA&quot;);
271         }
272 
273         if (jdkPath == null) {
274             throw new RuntimeException(&quot;Can&#39;t determine jdk path neither test.jdk property no TESTJAVA env are set&quot;);
275         }
276 
277         String osname = System.getProperty(&quot;os.name&quot;);
278         String javapath = jdkPath + ((osname.startsWith(&quot;window&quot;)) ? &quot;/bin/java.exe&quot; : &quot;/bin/java&quot;);
279 
280         List&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
281         cmd.add(javapath);
282 

283         if (vmArguments == null) {
<span class="line-modified">284             // Propagate getTestJavaOpts() to LingeredApp</span>
<span class="line-modified">285             vmArguments = Utils.getTestJavaOpts();</span>
<span class="line-modified">286         } else {</span>






287             // Lets user manage LingeredApp options

288         }
<span class="line-added">289         Collections.addAll(cmd, vmArguments);</span>
290 
291         // Make sure we set correct classpath to run the app
292         cmd.add(&quot;-cp&quot;);
293         String classpath = System.getProperty(&quot;test.class.path&quot;);
294         cmd.add((classpath == null) ? &quot;.&quot; : classpath);
295 
296         return cmd;
297     }
298 
299     /**
300      * Assemble command line to a printable string
301      */
302     public void printCommandLine(List&lt;String&gt; cmd) {
303         // A bit of verbosity
304         StringBuilder cmdLine = new StringBuilder();
305         for (String strCmd : cmd) {
306             cmdLine.append(&quot;&#39;&quot;).append(strCmd).append(&quot;&#39; &quot;);
307         }
308 
309         System.out.println(&quot;Command line: [&quot; + cmdLine.toString() + &quot;]&quot;);
310     }
311 
312     public void startGobblerPipe() {
313       // Create pipe reader for process, and read stdin and stderr to array of strings
314       InputGobbler gb = new InputGobbler(appProcess.getInputStream(), storedAppOutput);
315       gb.start();
316     }
317 
318     /**
319      * Run the app.
320      *
321      * @param vmArguments
322      * @throws IOException
323      */
<span class="line-modified">324     public void runApp(String[] vmArguments)</span>
325             throws IOException {
326 
327         List&lt;String&gt; cmd = runAppPrepare(vmArguments);
328 
329         cmd.add(this.getAppName());
330         cmd.add(lockFileName);
331 
332         printCommandLine(cmd);
333 
334         ProcessBuilder pb = new ProcessBuilder(cmd);
335         // we don&#39;t expect any error output but make sure we are not stuck on pipe
336         // pb.redirectErrorStream(false);
337         // ProcessBuilder.start can throw IOException
338         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
339         appProcess = pb.start();
340 
341         startGobblerPipe();
342     }
343 
344     /**
345      * Delete lock file that signals app to terminate, then
346      * wait until app is actually terminated.
347      * @throws IOException
348      */
349     public void stopApp() throws IOException {
350         deleteLock();
351         // The startApp() of the derived app can throw
352         // an exception before the LA actually starts
353         if (appProcess != null) {
354             waitAppTerminate();
355             int exitcode = appProcess.exitValue();
356             if (exitcode != 0) {
357                 throw new IOException(&quot;LingeredApp terminated with non-zero exit code &quot; + exitcode);
358             }
359         }
360     }
361 
362     /**
363      *  High level interface for test writers
364      */





















365     /**
366      * Factory method that starts pre-created LingeredApp
367      * lock name is autogenerated
<span class="line-modified">368      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>
369      * @param theApp - app to start

370      * @throws IOException
371      */
<span class="line-modified">372     public static void startApp(LingeredApp theApp, String... cmd) throws IOException {</span>

373         theApp.createLock();
374         try {
375             theApp.runApp(cmd);
376             theApp.waitAppReady(appWaitTime);
377         } catch (Exception ex) {
378             theApp.deleteLock();
379             throw ex;
380         }
381     }
382 
<span class="line-modified">383     /**</span>
<span class="line-modified">384      * Factory method that creates LingeredApp object with ready to use application</span>
<span class="line-added">385      * lock name is autogenerated</span>
<span class="line-added">386      * @param cmd - vm options, could be null to auto add Utils.getTestJavaOpts()</span>
<span class="line-added">387      * @return LingeredApp object</span>
<span class="line-added">388      * @throws IOException</span>
<span class="line-added">389      */</span>
<span class="line-added">390     public static LingeredApp startApp(String... cmd) throws IOException {</span>
<span class="line-added">391         LingeredApp a = new LingeredApp();</span>
<span class="line-added">392         startApp(a, cmd);</span>
<span class="line-added">393         return a;</span>
394     }
395 
396     public static void stopApp(LingeredApp app) throws IOException {
397         if (app != null) {
398             // LingeredApp can throw an exception during the intialization,
399             // make sure we don&#39;t have cascade NPE
400             app.stopApp();
401         }
402     }
403 
404     /**
405      * LastModified time might not work correctly in some cases it might
406      * cause later failures
407      */
408 
409     public static boolean isLastModifiedWorking() {
410         boolean sane = true;
411         try {
412             long lm = lastModified(&quot;.&quot;);
413             if (lm == 0) {
</pre>
</td>
</tr>
</table>
<center><a href="JpsHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="LingeredAppForJps.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>