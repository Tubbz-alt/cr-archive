<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/java2d/marlin/ClipShapeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../cmm/ColorConvertOp/ConstructorsNullTest/ConstructorsNullTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../pipe/hw/RSLAPITest/RSLAPITest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/java2d/marlin/ClipShapeTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,15 +22,18 @@</span>
   */
  import java.awt.BasicStroke;
  import java.awt.Color;
  import java.awt.Graphics2D;
  import java.awt.RenderingHints;
<span class="udiff-line-removed">- import java.awt.Shape;</span>
  import java.awt.Stroke;
<span class="udiff-line-added">+ import java.awt.Shape;</span>
<span class="udiff-line-added">+ import java.awt.geom.CubicCurve2D;</span>
  import java.awt.geom.Ellipse2D;
<span class="udiff-line-added">+ import java.awt.geom.Line2D;</span>
  import java.awt.geom.Path2D;
  import java.awt.geom.PathIterator;
<span class="udiff-line-added">+ import java.awt.geom.QuadCurve2D;</span>
  import java.awt.image.BufferedImage;
  import java.awt.image.DataBufferInt;
  import java.io.File;
  import java.io.FileOutputStream;
  import java.io.IOException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -67,32 +70,35 @@</span>
   * @run main/othervm/timeout=300 -Dsun.java2d.renderer=sun.java2d.marlin.DMarlinRenderingEngine ClipShapeTest -cubic
   * @run main/othervm/timeout=300 -Dsun.java2d.renderer=sun.java2d.marlin.DMarlinRenderingEngine ClipShapeTest -cubic -doDash
  */
  public final class ClipShapeTest {
  
<span class="udiff-line-modified-removed">-     static boolean TX_SCALE = false;</span>
<span class="udiff-line-modified-removed">-     static boolean TX_SHEAR = false;</span>
<span class="udiff-line-modified-added">+     // test options:</span>
<span class="udiff-line-modified-added">+     static int NUM_TESTS;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // shape settings:</span>
<span class="udiff-line-added">+     static ShapeMode SHAPE_MODE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static boolean USE_DASHES;</span>
<span class="udiff-line-added">+     static boolean USE_VAR_STROKE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static int THRESHOLD_DELTA;</span>
<span class="udiff-line-added">+     static long THRESHOLD_NBPIX;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // constants:</span>
<span class="udiff-line-added">+     static final boolean DO_FAIL = Boolean.valueOf(System.getProperty(&quot;ClipShapeTest.fail&quot;, &quot;true&quot;));</span>
  
      static final boolean TEST_STROKER = true;
      static final boolean TEST_FILLER = true;
  
<span class="udiff-line-modified-removed">-     // complementary tests in slow mode:</span>
<span class="udiff-line-modified-removed">-     static boolean USE_DASHES = false;</span>
<span class="udiff-line-modified-removed">-     static boolean USE_VAR_STROKE = false;</span>
<span class="udiff-line-modified-added">+     static final boolean SUBDIVIDE_CURVE = true;</span>
<span class="udiff-line-modified-added">+     static final double SUBDIVIDE_LEN_TH = 50.0;</span>
<span class="udiff-line-modified-added">+     static final boolean TRACE_SUBDIVIDE_CURVE = false;</span>
  
<span class="udiff-line-removed">-     static int NUM_TESTS = 5000;</span>
      static final int TESTW = 100;
      static final int TESTH = 100;
  
<span class="udiff-line-removed">-     // shape settings:</span>
<span class="udiff-line-removed">-     static ShapeMode SHAPE_MODE = ShapeMode.NINE_LINE_POLYS;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static int THRESHOLD_DELTA;</span>
<span class="udiff-line-removed">-     static long THRESHOLD_NBPIX;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static final boolean SHAPE_REPEAT = true;</span>
<span class="udiff-line-removed">- </span>
      // dump path on console:
      static final boolean DUMP_SHAPE = true;
  
      static final boolean SHOW_DETAILS = false; // disabled
      static final boolean SHOW_OUTLINE = true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -101,11 +107,12 @@</span>
  
      static final int MAX_SHOW_FRAMES = 10;
      static final int MAX_SAVE_FRAMES = 100;
  
      // use fixed seed to reproduce always same polygons between tests
<span class="udiff-line-modified-removed">-     static final boolean FIXED_SEED = false;</span>
<span class="udiff-line-modified-added">+     static final boolean FIXED_SEED = true;</span>
<span class="udiff-line-added">+ </span>
      static final double RAND_SCALE = 3.0;
      static final double RANDW = TESTW * RAND_SCALE;
      static final double OFFW = (TESTW - RANDW) / 2.0;
      static final double RANDH = TESTH * RAND_SCALE;
      static final double OFFH = (TESTH - RANDH) / 2.0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,10 +131,11 @@</span>
      static final Random RANDOM = new Random(SEED);
  
      static final File OUTPUT_DIR = new File(&quot;.&quot;);
  
      static final AtomicBoolean isMarlin = new AtomicBoolean();
<span class="udiff-line-added">+     static final AtomicBoolean isMarlinFloat = new AtomicBoolean();</span>
      static final AtomicBoolean isClipRuntime = new AtomicBoolean();
  
      static {
          Locale.setDefault(Locale.US);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,10 +149,11 @@</span>
                  final String msg = record.getMessage();
                  if (msg != null) {
                      // last space to avoid matching other settings:
                      if (msg.startsWith(&quot;sun.java2d.renderer &quot;)) {
                          isMarlin.set(msg.contains(&quot;MarlinRenderingEngine&quot;));
<span class="udiff-line-added">+                         isMarlinFloat.set(!msg.contains(&quot;DMarlinRenderingEngine&quot;));</span>
                      }
                      if (msg.startsWith(&quot;sun.java2d.renderer.clip.runtime.enable&quot;)) {
                          isClipRuntime.set(msg.contains(&quot;true&quot;));
                      }
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,96 +193,146 @@</span>
  
          // If any curve, increase curve accuracy:
          // curve length max error:
          System.setProperty(&quot;sun.java2d.renderer.curve_len_err&quot;, &quot;1e-4&quot;);
  
<span class="udiff-line-added">+         // cubic min/max error:</span>
<span class="udiff-line-added">+         System.setProperty(&quot;sun.java2d.renderer.cubic_dec_d2&quot;, &quot;1e-3&quot;);</span>
<span class="udiff-line-added">+         System.setProperty(&quot;sun.java2d.renderer.cubic_inc_d1&quot;, &quot;1e-4&quot;);</span>
<span class="udiff-line-added">+ </span>
          // quad max error:
          System.setProperty(&quot;sun.java2d.renderer.quad_dec_d2&quot;, &quot;5e-4&quot;);
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // cubic min/max error:</span>
<span class="udiff-line-modified-removed">-         System.setProperty(&quot;sun.java2d.renderer.cubic_dec_d2&quot;, &quot;1e-3&quot;);</span>
<span class="udiff-line-modified-removed">-         System.setProperty(&quot;sun.java2d.renderer.cubic_inc_d1&quot;, &quot;1e-4&quot;); // or disabled ~ 1e-6</span>
<span class="udiff-line-modified-added">+     private static void resetOptions() {</span>
<span class="udiff-line-modified-added">+         NUM_TESTS = Integer.getInteger(&quot;ClipShapeTest.numTests&quot;, 5000);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         // shape settings:</span>
<span class="udiff-line-added">+         SHAPE_MODE = ShapeMode.NINE_LINE_POLYS;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         USE_DASHES = false;</span>
<span class="udiff-line-added">+         USE_VAR_STROKE = false;</span>
      }
  
      /**
       * Test
       * @param args
       */
      public static void main(String[] args) {
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             // Bootstrap: init Renderer now:</span>
<span class="udiff-line-added">+             final BufferedImage img = newImage(TESTW, TESTH);</span>
<span class="udiff-line-added">+             final Graphics2D g2d = initialize(img, null);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 paintShape(new Line2D.Double(0,0,100,100), g2d, true, false);</span>
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 g2d.dispose();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (!isMarlin.get()) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Marlin renderer not used at runtime !&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!isClipRuntime.get()) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Marlin clipping not enabled at runtime !&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         System.out.println(&quot;---------------------------------------&quot;);</span>
<span class="udiff-line-added">+         System.out.println(&quot;ClipShapeTest: image = &quot; + TESTW + &quot; x &quot; + TESTH);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         resetOptions();</span>
<span class="udiff-line-added">+ </span>
          boolean runSlowTests = false;
  
          for (String arg : args) {
              if (&quot;-slow&quot;.equals(arg)) {
<span class="udiff-line-removed">-                 System.out.println(&quot;slow: enabled.&quot;);</span>
                  runSlowTests = true;
<span class="udiff-line-removed">-             } else if (&quot;-doScale&quot;.equals(arg)) {</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;doScale: enabled.&quot;);</span>
<span class="udiff-line-removed">-                 TX_SCALE = true;</span>
<span class="udiff-line-removed">-             } else if (&quot;-doShear&quot;.equals(arg)) {</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;doShear: enabled.&quot;);</span>
<span class="udiff-line-removed">-                 TX_SHEAR = true;</span>
              } else if (&quot;-doDash&quot;.equals(arg)) {
<span class="udiff-line-removed">-                 System.out.println(&quot;doDash: enabled.&quot;);</span>
                  USE_DASHES = true;
              } else if (&quot;-doVarStroke&quot;.equals(arg)) {
<span class="udiff-line-removed">-                 System.out.println(&quot;doVarStroke: enabled.&quot;);</span>
                  USE_VAR_STROKE = true;
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             // shape mode:</span>
<span class="udiff-line-modified-removed">-             else if (arg.equalsIgnoreCase(&quot;-poly&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SHAPE_MODE = ShapeMode.NINE_LINE_POLYS;</span>
<span class="udiff-line-modified-removed">-             } else if (arg.equalsIgnoreCase(&quot;-bigpoly&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SHAPE_MODE = ShapeMode.FIFTY_LINE_POLYS;</span>
<span class="udiff-line-modified-removed">-             } else if (arg.equalsIgnoreCase(&quot;-quad&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SHAPE_MODE = ShapeMode.FOUR_QUADS;</span>
<span class="udiff-line-modified-removed">-             } else if (arg.equalsIgnoreCase(&quot;-cubic&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SHAPE_MODE = ShapeMode.TWO_CUBICS;</span>
<span class="udiff-line-modified-removed">-             } else if (arg.equalsIgnoreCase(&quot;-mixed&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SHAPE_MODE = ShapeMode.MIXED;</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 // shape mode:</span>
<span class="udiff-line-modified-added">+                 if (arg.equalsIgnoreCase(&quot;-poly&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SHAPE_MODE = ShapeMode.NINE_LINE_POLYS;</span>
<span class="udiff-line-modified-added">+                 } else if (arg.equalsIgnoreCase(&quot;-bigpoly&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SHAPE_MODE = ShapeMode.FIFTY_LINE_POLYS;</span>
<span class="udiff-line-modified-added">+                 } else if (arg.equalsIgnoreCase(&quot;-quad&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SHAPE_MODE = ShapeMode.FOUR_QUADS;</span>
<span class="udiff-line-modified-added">+                 } else if (arg.equalsIgnoreCase(&quot;-cubic&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SHAPE_MODE = ShapeMode.TWO_CUBICS;</span>
<span class="udiff-line-modified-added">+                 } else if (arg.equalsIgnoreCase(&quot;-mixed&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SHAPE_MODE = ShapeMode.MIXED;</span>
<span class="udiff-line-added">+                 }</span>
              }
          }
  
          System.out.println(&quot;Shape mode: &quot; + SHAPE_MODE);
  
          // adjust image comparison thresholds:
<span class="udiff-line-modified-removed">-         switch(SHAPE_MODE) {</span>
<span class="udiff-line-modified-added">+         switch (SHAPE_MODE) {</span>
              case TWO_CUBICS:
                  // Define uncertainty for curves:
<span class="udiff-line-modified-removed">-                 THRESHOLD_DELTA = 32; //  / 256</span>
<span class="udiff-line-modified-removed">-                 THRESHOLD_NBPIX = 128; //  / 10000</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_DELTA = 32;</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_NBPIX = (USE_DASHES) ? 50 : 200;</span>
<span class="udiff-line-added">+                 if (SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     THRESHOLD_NBPIX = 4;</span>
<span class="udiff-line-added">+                 }</span>
                  break;
              case FOUR_QUADS:
              case MIXED:
                  // Define uncertainty for quads:
                  // curve subdivision causes curves to be smaller
                  // then curve offsets are different (more accurate)
<span class="udiff-line-modified-removed">-                 THRESHOLD_DELTA = 64;  // 64 / 256</span>
<span class="udiff-line-modified-removed">-                 THRESHOLD_NBPIX = 256; // 256 / 10000</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_DELTA = 64;</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_NBPIX = (USE_DASHES) ? 40 : 420;</span>
<span class="udiff-line-added">+                 if (SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     THRESHOLD_NBPIX = 10;</span>
<span class="udiff-line-added">+                 }</span>
                  break;
              default:
                  // Define uncertainty for lines:
                  // float variant have higher uncertainty
<span class="udiff-line-modified-removed">-                 THRESHOLD_DELTA = 8;</span>
<span class="udiff-line-modified-removed">-                 THRESHOLD_NBPIX = 8;</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_DELTA = 2;</span>
<span class="udiff-line-modified-added">+                 THRESHOLD_NBPIX = (USE_DASHES) ?</span>
<span class="udiff-line-added">+                     // float variant have higher uncertainty</span>
<span class="udiff-line-added">+                     ((isMarlinFloat.get()) ? 30 : 6) // low for double</span>
<span class="udiff-line-added">+                     : (isMarlinFloat.get()) ? 10 : 0;</span>
          }
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;THRESHOLD_DELTA: &quot;+THRESHOLD_DELTA);</span>
<span class="udiff-line-modified-removed">-         System.out.println(&quot;THRESHOLD_NBPIX: &quot;+THRESHOLD_NBPIX);</span>
<span class="udiff-line-modified-added">+ // Visual inspection (low threshold):</span>
<span class="udiff-line-modified-added">+ //        THRESHOLD_NBPIX = 2;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         System.out.println(&quot;THRESHOLD_DELTA: &quot; + THRESHOLD_DELTA);</span>
<span class="udiff-line-added">+         System.out.println(&quot;THRESHOLD_NBPIX: &quot; + THRESHOLD_NBPIX);</span>
  
          if (runSlowTests) {
              NUM_TESTS = 10000; // or 100000 (very slow)
<span class="udiff-line-removed">-             USE_DASHES = true;</span>
              USE_VAR_STROKE = true;
          }
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;ClipShapeTests: image = &quot; + TESTW + &quot; x &quot; + TESTH);</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;NUM_TESTS: &quot; + NUM_TESTS);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (USE_DASHES) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;USE_DASHES: enabled.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (USE_VAR_STROKE) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;USE_VAR_STROKE: enabled.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!DO_FAIL) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;DO_FAIL: disabled.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         System.out.println(&quot;---------------------------------------&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final DiffContext allCtx = new DiffContext(&quot;All Test setups&quot;);</span>
<span class="udiff-line-added">+         final DiffContext allWorstCtx = new DiffContext(&quot;Worst(All Test setups)&quot;);</span>
  
          int failures = 0;
          final long start = System.nanoTime();
          try {
<span class="udiff-line-removed">-             // TODO: test affine transforms ?</span>
<span class="udiff-line-removed">- </span>
              if (TEST_STROKER) {
                  final float[][] dashArrays = (USE_DASHES) ?
  // small
  //                        new float[][]{new float[]{1f, 2f}}
  // normal
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -289,11 +348,11 @@</span>
                                                  ? new float[5] :
                                                    new float[]{10f};
  
                  int nsw = 0;
                  if (USE_VAR_STROKE) {
<span class="udiff-line-modified-removed">-                     for (float width = 0.1f; width &lt; 110f; width *= 5f) {</span>
<span class="udiff-line-modified-added">+                     for (float width = 0.25f; width &lt; 110f; width *= 5f) {</span>
                          strokeWidths[nsw++] = width;
                      }
                  } else {
                      nsw = 1;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -308,43 +367,40 @@</span>
  
                          for (int cap = 0; cap &lt;= 2; cap++) {
  
                              for (int join = 0; join &lt;= 2; join++) {
  
<span class="udiff-line-modified-removed">-                                 failures += paintPaths(new TestSetup(SHAPE_MODE, false, width, cap, join, dashes));</span>
<span class="udiff-line-modified-removed">-                                 failures += paintPaths(new TestSetup(SHAPE_MODE, true, width, cap, join, dashes));</span>
<span class="udiff-line-modified-added">+                                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, false, width, cap, join, dashes));</span>
<span class="udiff-line-modified-added">+                                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, true, width, cap, join, dashes));</span>
                              }
                          }
                      }
                  }
              }
  
              if (TEST_FILLER) {
                  // Filler tests:
<span class="udiff-line-modified-removed">-                 failures += paintPaths(new TestSetup(SHAPE_MODE, false, Path2D.WIND_NON_ZERO));</span>
<span class="udiff-line-modified-removed">-                 failures += paintPaths(new TestSetup(SHAPE_MODE, true, Path2D.WIND_NON_ZERO));</span>
<span class="udiff-line-modified-added">+                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, false, Path2D.WIND_NON_ZERO));</span>
<span class="udiff-line-modified-added">+                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, true, Path2D.WIND_NON_ZERO));</span>
  
<span class="udiff-line-modified-removed">-                 failures += paintPaths(new TestSetup(SHAPE_MODE, false, Path2D.WIND_EVEN_ODD));</span>
<span class="udiff-line-modified-removed">-                 failures += paintPaths(new TestSetup(SHAPE_MODE, true, Path2D.WIND_EVEN_ODD));</span>
<span class="udiff-line-modified-added">+                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, false, Path2D.WIND_EVEN_ODD));</span>
<span class="udiff-line-modified-added">+                 failures += paintPaths(allCtx, allWorstCtx, new TestSetup(SHAPE_MODE, true, Path2D.WIND_EVEN_ODD));</span>
              }
          } catch (IOException ioe) {
              throw new RuntimeException(ioe);
          }
          System.out.println(&quot;main: duration= &quot; + (1e-6 * (System.nanoTime() - start)) + &quot; ms.&quot;);
  
<span class="udiff-line-modified-removed">-         if (!isMarlin.get()) {</span>
<span class="udiff-line-modified-removed">-             throw new RuntimeException(&quot;Marlin renderer not used at runtime !&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (!isClipRuntime.get()) {</span>
<span class="udiff-line-removed">-             throw new RuntimeException(&quot;Marlin clipping not enabled at runtime !&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (failures != 0) {</span>
<span class="udiff-line-modified-added">+         allWorstCtx.dump();</span>
<span class="udiff-line-modified-added">+         allCtx.dump();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         if (DO_FAIL &amp;&amp; (failures != 0)) {</span>
              throw new RuntimeException(&quot;Clip test failures : &quot; + failures);
          }
      }
  
<span class="udiff-line-modified-removed">-     static int paintPaths(final TestSetup ts) throws IOException {</span>
<span class="udiff-line-modified-added">+     static int paintPaths(final DiffContext allCtx, final DiffContext allWorstCtx, final TestSetup ts) throws IOException {</span>
          final long start = System.nanoTime();
  
          if (FIXED_SEED) {
              // Reset seed for random numbers:
              RANDOM.setSeed(SEED);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -354,23 +410,28 @@</span>
                  + &quot; paths (&quot; + SHAPE_MODE + &quot;) - setup: &quot; + ts);
  
          final boolean fill = !ts.isStroke();
          final Path2D p2d = new Path2D.Double(ts.windingRule);
  
<span class="udiff-line-added">+         final Stroke stroke = (!fill) ? createStroke(ts) : null;</span>
<span class="udiff-line-added">+ </span>
          final BufferedImage imgOn = newImage(TESTW, TESTH);
<span class="udiff-line-modified-removed">-         final Graphics2D g2dOn = initialize(imgOn, ts);</span>
<span class="udiff-line-modified-added">+         final Graphics2D g2dOn = initialize(imgOn, stroke);</span>
  
          final BufferedImage imgOff = newImage(TESTW, TESTH);
<span class="udiff-line-modified-removed">-         final Graphics2D g2dOff = initialize(imgOff, ts);</span>
<span class="udiff-line-modified-added">+         final Graphics2D g2dOff = initialize(imgOff, stroke);</span>
  
          final BufferedImage imgDiff = newImage(TESTW, TESTH);
  
<span class="udiff-line-modified-removed">-         final DiffContext globalCtx = new DiffContext(&quot;All tests&quot;);</span>
<span class="udiff-line-modified-added">+         final DiffContext testSetupCtx = new DiffContext(&quot;Test setup&quot;);</span>
<span class="udiff-line-added">+         final DiffContext testWorstCtx = new DiffContext(&quot;Worst&quot;);</span>
<span class="udiff-line-added">+         final DiffContext testWorstThCtx = new DiffContext(&quot;Worst(&gt;threshold)&quot;);</span>
  
          int nd = 0;
          try {
              final DiffContext testCtx = new DiffContext(&quot;Test&quot;);
<span class="udiff-line-added">+             final DiffContext testThCtx = new DiffContext(&quot;Test(&gt;threshold)&quot;);</span>
              BufferedImage diffImage;
  
              for (int n = 0; n &lt; NUM_TESTS; n++) {
                  genShape(p2d, ts);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -379,19 +440,28 @@</span>
  
                  // Runtime clip setting ON:
                  paintShape(p2d, g2dOn, fill, true);
  
                  /* compute image difference if possible */
<span class="udiff-line-modified-removed">-                 diffImage = computeDiffImage(testCtx, imgOn, imgOff, imgDiff, globalCtx);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 final String testName = &quot;Setup_&quot; + ts.id + &quot;_test_&quot; + n;</span>
<span class="udiff-line-modified-added">+                 diffImage = computeDiffImage(testCtx, testThCtx, imgOn, imgOff, imgDiff);</span>
  
<span class="udiff-line-added">+                 // Worst (total)</span>
<span class="udiff-line-added">+                 if (testCtx.isDiff()) {</span>
<span class="udiff-line-added">+                     if (testWorstCtx.isWorse(testCtx, false)) {</span>
<span class="udiff-line-added">+                         testWorstCtx.set(testCtx);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     if (testWorstThCtx.isWorse(testCtx, true)) {</span>
<span class="udiff-line-added">+                         testWorstThCtx.set(testCtx);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     // accumulate data:</span>
<span class="udiff-line-added">+                     testSetupCtx.add(testCtx);</span>
<span class="udiff-line-added">+                 }</span>
                  if (diffImage != null) {
                      nd++;
  
<span class="udiff-line-modified-removed">-                     final double ratio = (100.0 * testCtx.histPix.count) / testCtx.histAll.count;</span>
<span class="udiff-line-modified-removed">-                     System.out.println(&quot;Diff ratio: &quot; + testName + &quot; = &quot; + trimTo3Digits(ratio) + &quot; %&quot;);</span>
<span class="udiff-line-modified-added">+                     testThCtx.dump();</span>
<span class="udiff-line-modified-added">+                     testCtx.dump();</span>
  
                      if (nd &lt; MAX_SHOW_FRAMES) {
                          if (SHOW_DETAILS) {
                              paintShapeDetails(g2dOff, p2d);
                              paintShapeDetails(g2dOn, p2d);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -399,13 +469,16 @@</span>
  
                          if (nd &lt; MAX_SAVE_FRAMES) {
                              if (DUMP_SHAPE) {
                                  dumpShape(p2d);
                              }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                             final String testName = &quot;Setup_&quot; + ts.id + &quot;_test_&quot; + n;</span>
<span class="udiff-line-added">+ </span>
                              saveImage(imgOff, OUTPUT_DIR, testName + &quot;-off.png&quot;);
                              saveImage(imgOn, OUTPUT_DIR, testName + &quot;-on.png&quot;);
<span class="udiff-line-modified-removed">-                             saveImage(diffImage, OUTPUT_DIR, testName + &quot;-diff.png&quot;);</span>
<span class="udiff-line-modified-added">+                             saveImage(imgDiff, OUTPUT_DIR, testName + &quot;-diff.png&quot;);</span>
                          }
                      }
                  }
              }
          } finally {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -416,17 +489,29 @@</span>
                  System.out.println(&quot;paintPaths: &quot; + NUM_TESTS + &quot; paths - &quot;
                          + &quot;Number of differences = &quot; + nd
                          + &quot; ratio = &quot; + (100f * nd) / NUM_TESTS + &quot; %&quot;);
              }
  
<span class="udiff-line-modified-removed">-             globalCtx.dump();</span>
<span class="udiff-line-modified-added">+             if (testWorstCtx.isDiff()) {</span>
<span class="udiff-line-added">+                 testWorstCtx.dump();</span>
<span class="udiff-line-added">+                 if (testWorstThCtx.isDiff() &amp;&amp; testWorstThCtx.histPix.sum != testWorstCtx.histPix.sum) {</span>
<span class="udiff-line-added">+                     testWorstThCtx.dump();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (allWorstCtx.isWorse(testWorstThCtx, true)) {</span>
<span class="udiff-line-added">+                     allWorstCtx.set(testWorstThCtx);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             testSetupCtx.dump();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // accumulate data:</span>
<span class="udiff-line-added">+             allCtx.add(testSetupCtx);</span>
          }
          System.out.println(&quot;paintPaths: duration= &quot; + (1e-6 * (System.nanoTime() - start)) + &quot; ms.&quot;);
          return nd;
      }
  
<span class="udiff-line-modified-removed">-     private static void paintShape(final Path2D p2d, final Graphics2D g2d,</span>
<span class="udiff-line-modified-added">+     private static void paintShape(final Shape p2d, final Graphics2D g2d,</span>
                                     final boolean fill, final boolean clip) {
          reset(g2d);
  
          setClip(g2d, clip);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -436,30 +521,24 @@</span>
              g2d.draw(p2d);
          }
      }
  
      private static Graphics2D initialize(final BufferedImage img,
<span class="udiff-line-modified-removed">-                                          final TestSetup ts) {</span>
<span class="udiff-line-modified-added">+                                          final Stroke s) {</span>
          final Graphics2D g2d = (Graphics2D) img.getGraphics();
          g2d.setRenderingHint(RenderingHints.KEY_RENDERING,
                  RenderingHints.VALUE_RENDER_QUALITY);
          g2d.setRenderingHint(RenderingHints.KEY_STROKE_CONTROL,
<span class="udiff-line-modified-removed">-                 RenderingHints.VALUE_STROKE_PURE);</span>
<span class="udiff-line-modified-added">+ // Test normalize:</span>
<span class="udiff-line-added">+ //                RenderingHints.VALUE_STROKE_NORMALIZE</span>
<span class="udiff-line-added">+                 RenderingHints.VALUE_STROKE_PURE</span>
<span class="udiff-line-added">+         );</span>
  
<span class="udiff-line-modified-removed">-         if (ts.isStroke()) {</span>
<span class="udiff-line-modified-removed">-             g2d.setStroke(createStroke(ts));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         g2d.setColor(Color.GRAY);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Test scale</span>
<span class="udiff-line-removed">-         if (TX_SCALE) {</span>
<span class="udiff-line-removed">-             g2d.scale(1.2, 1.2);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         // Test shear</span>
<span class="udiff-line-removed">-         if (TX_SHEAR) {</span>
<span class="udiff-line-removed">-             g2d.shear(0.1, 0.2);</span>
<span class="udiff-line-modified-added">+         if (s != null) {</span>
<span class="udiff-line-modified-added">+             g2d.setStroke(s);</span>
          }
<span class="udiff-line-added">+         g2d.setColor(Color.BLACK);</span>
  
          return g2d;
      }
  
      private static void reset(final Graphics2D g2d) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -480,62 +559,228 @@</span>
      }
  
      static void genShape(final Path2D p2d, final TestSetup ts) {
          p2d.reset();
  
<span class="udiff-line-modified-removed">-         final int end = (SHAPE_REPEAT) ? 2 : 1;</span>
<span class="udiff-line-modified-added">+         /*</span>
<span class="udiff-line-added">+             Test closed path:</span>
<span class="udiff-line-added">+             0: moveTo + (draw)To + closePath</span>
<span class="udiff-line-added">+             1: (draw)To + closePath (closePath + (draw)To sequence)</span>
<span class="udiff-line-added">+         */</span>
<span class="udiff-line-added">+         final int end  = (ts.closed) ? 2 : 1;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final double[] in = new double[8];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         double sx0 = 0.0, sy0 = 0.0, x0 = 0.0, y0 = 0.0;</span>
  
          for (int p = 0; p &lt; end; p++) {
<span class="udiff-line-modified-removed">-             p2d.moveTo(randX(), randY());</span>
<span class="udiff-line-modified-added">+             if (p &lt;= 0) {</span>
<span class="udiff-line-added">+                 x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                 p2d.moveTo(x0, y0);</span>
<span class="udiff-line-added">+                 sx0 = x0; sy0 = y0;</span>
<span class="udiff-line-added">+             }</span>
  
              switch (ts.shapeMode) {
                  case MIXED:
<span class="udiff-line-removed">-                 case FIFTY_LINE_POLYS:</span>
<span class="udiff-line-removed">-                 case NINE_LINE_POLYS:</span>
                  case FIVE_LINE_POLYS:
<span class="udiff-line-added">+                 case NINE_LINE_POLYS:</span>
<span class="udiff-line-added">+                 case FIFTY_LINE_POLYS:</span>
                      p2d.lineTo(randX(), randY());
                      p2d.lineTo(randX(), randY());
                      p2d.lineTo(randX(), randY());
                      p2d.lineTo(randX(), randY());
<span class="udiff-line-added">+                     x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                     p2d.lineTo(x0, y0);</span>
                      if (ts.shapeMode == ShapeMode.FIVE_LINE_POLYS) {
                          // And an implicit close makes 5 lines
                          break;
                      }
                      p2d.lineTo(randX(), randY());
                      p2d.lineTo(randX(), randY());
                      p2d.lineTo(randX(), randY());
<span class="udiff-line-modified-removed">-                     p2d.lineTo(randX(), randY());</span>
<span class="udiff-line-modified-added">+                     x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                     p2d.lineTo(x0, y0);</span>
                      if (ts.shapeMode == ShapeMode.NINE_LINE_POLYS) {
                          // And an implicit close makes 9 lines
                          break;
                      }
                      if (ts.shapeMode == ShapeMode.FIFTY_LINE_POLYS) {
                          for (int i = 0; i &lt; 41; i++) {
<span class="udiff-line-modified-removed">-                             p2d.lineTo(randX(), randY());</span>
<span class="udiff-line-modified-added">+                             x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                             p2d.lineTo(x0, y0);</span>
                          }
                          // And an implicit close makes 50 lines
                          break;
                      }
                  case TWO_CUBICS:
<span class="udiff-line-modified-removed">-                     p2d.curveTo(randX(), randY(), randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-removed">-                     p2d.curveTo(randX(), randY(), randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-added">+                     if (SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-modified-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-added">+                         in[4] = randX(); in[5] = randY();</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[6] = x0; in[7] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 8, in);</span>
<span class="udiff-line-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-added">+                         in[4] = randX(); in[5] = randY();</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[6] = x0; in[7] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 8, in);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.curveTo(randX(), randY(), randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.curveTo(randX(), randY(), randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                     }</span>
                      if (ts.shapeMode == ShapeMode.TWO_CUBICS) {
                          break;
                      }
                  case FOUR_QUADS:
<span class="udiff-line-modified-removed">-                     p2d.quadTo(randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-removed">-                     p2d.quadTo(randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-removed">-                     p2d.quadTo(randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-removed">-                     p2d.quadTo(randX(), randY(), randX(), randY());</span>
<span class="udiff-line-modified-added">+                     if (SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-modified-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-modified-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-modified-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[4] = x0; in[5] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 6, in);</span>
<span class="udiff-line-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[4] = x0; in[5] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 6, in);</span>
<span class="udiff-line-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[4] = x0; in[5] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 6, in);</span>
<span class="udiff-line-added">+                         in[0] = x0; in[1] = y0;</span>
<span class="udiff-line-added">+                         in[2] = randX(); in[3] = randY();</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         in[4] = x0; in[5] = y0;</span>
<span class="udiff-line-added">+                         subdivide(p2d, 6, in);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.quadTo(randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.quadTo(randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.quadTo(randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                         x0 = randX(); y0 = randY();</span>
<span class="udiff-line-added">+                         p2d.quadTo(randX(), randY(), x0, y0);</span>
<span class="udiff-line-added">+                     }</span>
                      if (ts.shapeMode == ShapeMode.FOUR_QUADS) {
                          break;
                      }
                  default:
              }
  
              if (ts.closed) {
                  p2d.closePath();
<span class="udiff-line-added">+                 x0 = sx0; y0 = sy0;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static final int SUBDIVIDE_LIMIT = 5;</span>
<span class="udiff-line-added">+     static final double[][] SUBDIVIDE_CURVES = new double[SUBDIVIDE_LIMIT + 1][];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static {</span>
<span class="udiff-line-added">+         for (int i = 0, n = 1; i &lt; SUBDIVIDE_LIMIT; i++, n *= 2) {</span>
<span class="udiff-line-added">+             SUBDIVIDE_CURVES[i] = new double[8 * n];</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static void subdivide(final Path2D p2d, final int type, final double[] in) {</span>
<span class="udiff-line-added">+         if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;subdivide: &quot; + Arrays.toString(Arrays.copyOf(in, type)));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         double curveLen = ((type == 8)</span>
<span class="udiff-line-added">+                 ? curvelen(in[0], in[1], in[2], in[3], in[4], in[5], in[6], in[7])</span>
<span class="udiff-line-added">+                 : quadlen(in[0], in[1], in[2], in[3], in[4], in[5]));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (curveLen &gt; SUBDIVIDE_LEN_TH) {</span>
<span class="udiff-line-added">+             if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;curvelen: &quot; + curveLen);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             System.arraycopy(in, 0, SUBDIVIDE_CURVES[0], 0, 8);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             int level = 0;</span>
<span class="udiff-line-added">+             while (curveLen &gt;= SUBDIVIDE_LEN_TH) {</span>
<span class="udiff-line-added">+                 level++;</span>
<span class="udiff-line-added">+                 curveLen /= 2.0;</span>
<span class="udiff-line-added">+                 if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     System.out.println(&quot;curvelen: &quot; + curveLen);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;level: &quot; + level);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (level &gt; SUBDIVIDE_LIMIT) {</span>
<span class="udiff-line-added">+                 if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     System.out.println(&quot;max level reached : &quot; + level);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 level = SUBDIVIDE_LIMIT;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             for (int l = 0; l &lt; level; l++) {</span>
<span class="udiff-line-added">+                 if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     System.out.println(&quot;level: &quot; + l);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 double[] src = SUBDIVIDE_CURVES[l];</span>
<span class="udiff-line-added">+                 double[] dst = SUBDIVIDE_CURVES[l + 1];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 for (int i = 0, j = 0; i &lt; src.length; i += 8, j += 16) {</span>
<span class="udiff-line-added">+                     if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                         System.out.println(&quot;subdivide: &quot; + Arrays.toString(Arrays.copyOfRange(src, i, i + type)));</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     if (type == 8) {</span>
<span class="udiff-line-added">+                         CubicCurve2D.subdivide(src, i, dst, j, dst, j + 8);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         QuadCurve2D.subdivide(src, i, dst, j, dst, j + 8);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                         System.out.println(&quot;left: &quot; + Arrays.toString(Arrays.copyOfRange(dst, j, j + type)));</span>
<span class="udiff-line-added">+                         System.out.println(&quot;right: &quot; + Arrays.toString(Arrays.copyOfRange(dst, j + 8, j + 8 + type)));</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Emit curves at last level:</span>
<span class="udiff-line-added">+             double[] src = SUBDIVIDE_CURVES[level];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             double len = 0.0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             for (int i = 0; i &lt; src.length; i += 8) {</span>
<span class="udiff-line-added">+                 if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                     System.out.println(&quot;curve: &quot; + Arrays.toString(Arrays.copyOfRange(src, i, i + type)));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (type == 8) {</span>
<span class="udiff-line-added">+                     if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                         len += curvelen(src[i + 0], src[i + 1], src[i + 2], src[i + 3], src[i + 4], src[i + 5], src[i + 6], src[i + 7]);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     p2d.curveTo(src[i + 2], src[i + 3], src[i + 4], src[i + 5], src[i + 6], src[i + 7]);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                         len += quadlen(src[i + 0], src[i + 1], src[i + 2], src[i + 3], src[i + 4], src[i + 5]);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     p2d.quadTo(src[i + 2], src[i + 3], src[i + 4], src[i + 5]);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (TRACE_SUBDIVIDE_CURVE) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;curveLen (final) = &quot; + len);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             if (type == 8) {</span>
<span class="udiff-line-added">+                 p2d.curveTo(in[2], in[3], in[4], in[5], in[6], in[7]);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 p2d.quadTo(in[2], in[3], in[4], in[5]);</span>
              }
          }
      }
  
      static final float POINT_RADIUS = 2f;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -752,22 +997,23 @@</span>
  
      public static BufferedImage newImage(final int w, final int h) {
          return new BufferedImage(w, h, BufferedImage.TYPE_INT_ARGB_PRE);
      }
  
<span class="udiff-line-modified-removed">-     public static BufferedImage computeDiffImage(final DiffContext localCtx,</span>
<span class="udiff-line-modified-added">+     public static BufferedImage computeDiffImage(final DiffContext testCtx,</span>
<span class="udiff-line-added">+                                                  final DiffContext testThCtx,</span>
                                                   final BufferedImage tstImage,
                                                   final BufferedImage refImage,
<span class="udiff-line-modified-removed">-                                                  final BufferedImage diffImage,</span>
<span class="udiff-line-removed">-                                                  final DiffContext globalCtx) {</span>
<span class="udiff-line-modified-added">+                                                  final BufferedImage diffImage) {</span>
  
          final int[] aRefPix = ((DataBufferInt) refImage.getRaster().getDataBuffer()).getData();
          final int[] aTstPix = ((DataBufferInt) tstImage.getRaster().getDataBuffer()).getData();
          final int[] aDifPix = ((DataBufferInt) diffImage.getRaster().getDataBuffer()).getData();
  
<span class="udiff-line-modified-removed">-         // reset local diff context:</span>
<span class="udiff-line-modified-removed">-         localCtx.reset();</span>
<span class="udiff-line-modified-added">+         // reset diff contexts:</span>
<span class="udiff-line-modified-added">+         testCtx.reset();</span>
<span class="udiff-line-added">+         testThCtx.reset();</span>
  
          int ref, tst, dg, v;
          for (int i = 0, len = aRefPix.length; i &lt; len; i++) {
              ref = aRefPix[i];
              tst = aTstPix[i];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -775,28 +1021,28 @@</span>
              // grayscale diff:
              dg = (r(ref) + g(ref) + b(ref)) - (r(tst) + g(tst) + b(tst));
  
              // max difference on grayscale values:
              v = (int) Math.ceil(Math.abs(dg / 3.0));
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // TODO: count warnings</span>
              if (v &lt;= THRESHOLD_DELTA) {
                  aDifPix[i] = 0;
              } else {
                  aDifPix[i] = toInt(v, v, v);
<span class="udiff-line-added">+                 testThCtx.add(v);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-                 localCtx.add(v);</span>
<span class="udiff-line-modified-added">+             if (v != 0) {</span>
<span class="udiff-line-added">+                 testCtx.add(v);</span>
              }
<span class="udiff-line-removed">-             globalCtx.add(v);</span>
          }
  
<span class="udiff-line-modified-removed">-         if (!localCtx.isDiff() || (localCtx.histPix.count &lt;= THRESHOLD_NBPIX)) {</span>
<span class="udiff-line-modified-added">+         testCtx.addNbPix(testThCtx.histPix.count);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!testThCtx.isDiff() || (testThCtx.histPix.count &lt;= THRESHOLD_NBPIX)) {</span>
              return null;
          }
  
<span class="udiff-line-removed">-         localCtx.dump();</span>
<span class="udiff-line-removed">- </span>
          return diffImage;
      }
  
      static void saveImage(final BufferedImage image, final File resDirectory, final String imageFileName) throws IOException {
          final Iterator&lt;ImageWriter&gt; itWriters = ImageIO.getImageWritersByFormatName(&quot;PNG&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -893,10 +1139,21 @@</span>
              if (val &gt; max) {
                  max = val;
              }
          }
  
<span class="udiff-line-added">+         void add(StatInteger stat) {</span>
<span class="udiff-line-added">+             count += stat.count;</span>
<span class="udiff-line-added">+             sum += stat.sum;</span>
<span class="udiff-line-added">+             if (stat.min &lt; min) {</span>
<span class="udiff-line-added">+                 min = stat.min;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (stat.max &gt; max) {</span>
<span class="udiff-line-added">+                 max = stat.max;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          public final double average() {
              return ((double) sum) / count;
          }
  
          @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -906,12 +1163,15 @@</span>
              return sb.toString();
          }
  
          public final StringBuilder toString(final StringBuilder sb) {
              sb.append(name).append(&quot;[n: &quot;).append(count);
<span class="udiff-line-modified-removed">-             sb.append(&quot;] sum: &quot;).append(sum).append(&quot; avg: &quot;).append(trimTo3Digits(average()));</span>
<span class="udiff-line-modified-removed">-             sb.append(&quot; [&quot;).append(min).append(&quot; | &quot;).append(max).append(&quot;]&quot;);</span>
<span class="udiff-line-modified-added">+             sb.append(&quot;] &quot;);</span>
<span class="udiff-line-modified-added">+             if (count != 0) {</span>
<span class="udiff-line-added">+                 sb.append(&quot;sum: &quot;).append(sum).append(&quot; avg: &quot;).append(trimTo3Digits(average()));</span>
<span class="udiff-line-added">+                 sb.append(&quot; [&quot;).append(min).append(&quot; | &quot;).append(max).append(&quot;]&quot;);</span>
<span class="udiff-line-added">+             }</span>
              return sb;
          }
  
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -919,19 +1179,26 @@</span>
  
          static final int BUCKET = 2;
          static final int MAX = 20;
          static final int LAST = MAX - 1;
          static final int[] STEPS = new int[MAX];
<span class="udiff-line-added">+         static final int BUCKET_TH;</span>
  
          static {
              STEPS[0] = 0;
              STEPS[1] = 1;
  
              for (int i = 2; i &lt; MAX; i++) {
                  STEPS[i] = STEPS[i - 1] * BUCKET;
              }
  //            System.out.println(&quot;Histogram.STEPS = &quot; + Arrays.toString(STEPS));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (THRESHOLD_DELTA % 2 != 0) {</span>
<span class="udiff-line-added">+                 throw new IllegalStateException(&quot;THRESHOLD_DELTA must be odd&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             BUCKET_TH = bucket(THRESHOLD_DELTA);</span>
          }
  
          static int bucket(int val) {
              for (int i = 1; i &lt; MAX; i++) {
                  if (val &lt; STEPS[i]) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -967,10 +1234,41 @@</span>
          @Override
          final void add(long val) {
              add((int) val);
          }
  
<span class="udiff-line-added">+         void add(Histogram hist) {</span>
<span class="udiff-line-added">+             super.add(hist);</span>
<span class="udiff-line-added">+             for (int i = 0; i &lt; MAX; i++) {</span>
<span class="udiff-line-added">+                 stats[i].add(hist.stats[i]);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean isWorse(Histogram hist, boolean useTh) {</span>
<span class="udiff-line-added">+             boolean worst = false;</span>
<span class="udiff-line-added">+             if (!useTh &amp;&amp; (hist.sum &gt; sum)) {</span>
<span class="udiff-line-added">+                 worst = true;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 long sumLoc = 0l;</span>
<span class="udiff-line-added">+                 long sumHist = 0l;</span>
<span class="udiff-line-added">+                 // use running sum:</span>
<span class="udiff-line-added">+                 for (int i = MAX - 1; i &gt;= BUCKET_TH; i--) {</span>
<span class="udiff-line-added">+                     sumLoc += stats[i].sum;</span>
<span class="udiff-line-added">+                     sumHist += hist.stats[i].sum;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (sumHist &gt; sumLoc) {</span>
<span class="udiff-line-added">+                     worst = true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             /*</span>
<span class="udiff-line-added">+             System.out.println(&quot;running sum worst:&quot;);</span>
<span class="udiff-line-added">+             System.out.println(&quot;this ? &quot; + toString());</span>
<span class="udiff-line-added">+             System.out.println(&quot;worst ? &quot; + hist.toString());</span>
<span class="udiff-line-added">+              */</span>
<span class="udiff-line-added">+             return worst;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          @Override
          public final String toString() {
              final StringBuilder sb = new StringBuilder(2048);
              super.toString(sb).append(&quot; { &quot;);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -993,40 +1291,90 @@</span>
          return ((long) (1e3d * value)) / 1e3d;
      }
  
      static final class DiffContext {
  
<span class="udiff-line-removed">-         public final Histogram histAll;</span>
          public final Histogram histPix;
  
<span class="udiff-line-added">+         public final StatInteger nbPix;</span>
<span class="udiff-line-added">+ </span>
          DiffContext(String name) {
<span class="udiff-line-removed">-             histAll = new Histogram(&quot;All  Pixels [&quot; + name + &quot;]&quot;);</span>
              histPix = new Histogram(&quot;Diff Pixels [&quot; + name + &quot;]&quot;);
<span class="udiff-line-added">+             nbPix = new StatInteger(&quot;NbPixels [&quot; + name + &quot;]&quot;);</span>
          }
  
          void reset() {
<span class="udiff-line-removed">-             histAll.reset();</span>
              histPix.reset();
<span class="udiff-line-added">+             nbPix.reset();</span>
          }
  
          void dump() {
              if (isDiff()) {
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Differences [&quot; + histAll.name + &quot;]:&quot;);</span>
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Total [all pixels]:\n&quot; + histAll.toString());</span>
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Total [different pixels]:\n&quot; + histPix.toString());</span>
<span class="udiff-line-modified-added">+                 System.out.println(&quot;Differences [&quot; + histPix.name + &quot;]:\n&quot;</span>
<span class="udiff-line-modified-added">+                         + ((nbPix.count != 0) ? (nbPix.toString() + &quot;\n&quot;) : &quot;&quot;)</span>
<span class="udiff-line-modified-added">+                         + histPix.toString()</span>
<span class="udiff-line-added">+                 );</span>
              } else {
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;No difference for [&quot; + histAll.name + &quot;].&quot;);</span>
<span class="udiff-line-modified-added">+                 System.out.println(&quot;No difference for [&quot; + histPix.name + &quot;].&quot;);</span>
              }
          }
  
          void add(int val) {
<span class="udiff-line-modified-removed">-             histAll.add(val);</span>
<span class="udiff-line-modified-removed">-             if (val != 0) {</span>
<span class="udiff-line-modified-removed">-                 histPix.add(val);</span>
<span class="udiff-line-modified-added">+             histPix.add(val);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         void add(DiffContext ctx) {</span>
<span class="udiff-line-added">+             histPix.add(ctx.histPix);</span>
<span class="udiff-line-added">+             if (ctx.nbPix.count != 0L) {</span>
<span class="udiff-line-added">+                 nbPix.add(ctx.nbPix);</span>
              }
          }
  
<span class="udiff-line-added">+         void addNbPix(long val) {</span>
<span class="udiff-line-added">+             if (val != 0L) {</span>
<span class="udiff-line-added">+                 nbPix.add(val);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void set(DiffContext ctx) {</span>
<span class="udiff-line-added">+             reset();</span>
<span class="udiff-line-added">+             add(ctx);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean isWorse(DiffContext ctx, boolean useTh) {</span>
<span class="udiff-line-added">+             return histPix.isWorse(ctx.histPix, useTh);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          boolean isDiff() {
<span class="udiff-line-modified-removed">-             return histAll.sum != 0l;</span>
<span class="udiff-line-modified-added">+             return histPix.sum != 0l;</span>
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static double linelen(final double x0, final double y0,</span>
<span class="udiff-line-added">+                           final double x1, final double y1)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         final double dx = x1 - x0;</span>
<span class="udiff-line-added">+         final double dy = y1 - y0;</span>
<span class="udiff-line-added">+         return Math.sqrt(dx * dx + dy * dy);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static double quadlen(final double x0, final double y0,</span>
<span class="udiff-line-added">+                           final double x1, final double y1,</span>
<span class="udiff-line-added">+                           final double x2, final double y2)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return (linelen(x0, y0, x1, y1)</span>
<span class="udiff-line-added">+                 + linelen(x1, y1, x2, y2)</span>
<span class="udiff-line-added">+                 + linelen(x0, y0, x2, y2)) / 2.0d;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static double curvelen(final double x0, final double y0,</span>
<span class="udiff-line-added">+                            final double x1, final double y1,</span>
<span class="udiff-line-added">+                            final double x2, final double y2,</span>
<span class="udiff-line-added">+                            final double x3, final double y3)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return (linelen(x0, y0, x1, y1)</span>
<span class="udiff-line-added">+               + linelen(x1, y1, x2, y2)</span>
<span class="udiff-line-added">+               + linelen(x2, y2, x3, y3)</span>
<span class="udiff-line-added">+               + linelen(x0, y0, x3, y3)) / 2.0d;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../cmm/ColorConvertOp/ConstructorsNullTest/ConstructorsNullTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../pipe/hw/RSLAPITest/RSLAPITest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>