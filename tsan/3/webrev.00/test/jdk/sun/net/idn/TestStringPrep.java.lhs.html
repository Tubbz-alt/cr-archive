<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/net/idn/TestStringPrep.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2005, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @summary Unit test for sun.net.idn.Punycode</span>
<span class="line-modified"> 27  * @bug 4737170 8060097</span>
<span class="line-modified"> 28  * @modules java.base/sun.net.idn:+open</span>
<span class="line-removed"> 29  *          java.base/sun.text.normalizer</span>
 30  * @library .
 31  * @compile -XDignore.symbol.file TestStringPrep.java NFS4StringPrep.java
 32  *     TestData.java
 33  * @run main/othervm -ea TestStringPrep
 34  * @author Edward Wang
 35  */
 36 /*
 37  *******************************************************************************
 38  * Copyright (C) 2003-2004, International Business Machines Corporation and    *
 39  * others. All Rights Reserved.                                                *
 40  *******************************************************************************
 41 */
 42 
 43 import java.text.ParseException;
 44 import java.io.InputStream;
 45 import java.util.Locale;
 46 
<a name="3" id="anc3"></a><span class="line-modified"> 47 import sun.net.idn.StringPrep;</span>
<span class="line-modified"> 48 import sun.text.normalizer.UCharacterIterator;</span>
 49 
 50 public class TestStringPrep {
 51     public static void main(String[] args) throws Exception {
 52         TestNFS4MixedPrep();
 53         TestCISPrep();
 54         TestCSPrep();
 55         TestNamePrepConformance();
 56     }
 57     /*
 58        There are several special identifiers (&quot;who&quot;) which need to be
 59        understood universally, rather than in the context of a particular
 60        DNS domain.  Some of these identifiers cannot be understood when an
 61        NFS client accesses the server, but have meaning when a local process
 62        accesses the file.  The ability to display and modify these
 63        permissions is permitted over NFS, even if none of the access methods
 64        on the server understands the identifiers.
 65 
 66         Who                    Description
 67        _______________________________________________________________
 68 
 69        &quot;OWNER&quot;                The owner of the file.
 70        &quot;GROUP&quot;                The group associated with the file.
 71        &quot;EVERYONE&quot;             The world.
 72        &quot;INTERACTIVE&quot;          Accessed from an interactive terminal.
 73        &quot;NETWORK&quot;              Accessed via the network.
 74        &quot;DIALUP&quot;               Accessed as a dialup user to the server.
 75        &quot;BATCH&quot;                Accessed from a batch job.
 76        &quot;ANONYMOUS&quot;            Accessed without any authentication.
 77        &quot;AUTHENTICATED&quot;        Any authenticated user (opposite of
 78                               ANONYMOUS)
 79        &quot;SERVICE&quot;              Access from a system service.
 80 
 81        To avoid conflict, these special identifiers are distinguish by an
 82        appended &quot;@&quot; and should appear in the form &quot;xxxx@&quot; (note: no domain
 83        name after the &quot;@&quot;).  For example: ANONYMOUS@.
 84     */
 85     private static String[] mixed_prep_data ={
 86         &quot;OWNER@&quot;,
 87         &quot;GROUP@&quot;,
 88         &quot;EVERYONE@&quot;,
 89         &quot;INTERACTIVE@&quot;,
 90         &quot;NETWORK@&quot;,
 91         &quot;DIALUP@&quot;,
 92         &quot;BATCH@&quot;,
 93         &quot;ANONYMOUS@&quot;,
 94         &quot;AUTHENTICATED@&quot;,
 95         &quot;\u0930\u094D\u092E\u094D\u0915\u094D\u0937\u0947\u0924\u094D@slip129-37-118-146.nc.us.ibm.net&quot;,
 96         &quot;\u0936\u094d\u0930\u0940\u092e\u0926\u094d@saratoga.pe.utexas.edu&quot;,
 97         &quot;\u092d\u0917\u0935\u0926\u094d\u0917\u0940\u0924\u093e@dial-120-45.ots.utexas.edu&quot;,
 98         &quot;\u0905\u0927\u094d\u092f\u093e\u092f@woo-085.dorms.waller.net&quot;,
 99         &quot;\u0905\u0930\u094d\u091c\u0941\u0928@hd30-049.hil.compuserve.com&quot;,
100         &quot;\u0935\u093f\u0937\u093e\u0926@pem203-31.pe.ttu.edu&quot;,
101         &quot;\u092f\u094b\u0917@56K-227.MaxTNT3.pdq.net&quot;,
102         &quot;\u0927\u0943\u0924\u0930\u093e\u0937\u094d\u091f\u094d\u0930@dial-36-2.ots.utexas.edu&quot;,
103         &quot;\u0909\u0935\u093E\u091A\u0943@slip129-37-23-152.ga.us.ibm.net&quot;,
104         &quot;\u0927\u0930\u094d\u092e\u0915\u094d\u0937\u0947\u0924\u094d\u0930\u0947@ts45ip119.cadvision.com&quot;,
105         &quot;\u0915\u0941\u0930\u0941\u0915\u094d\u0937\u0947\u0924\u094d\u0930\u0947@sdn-ts-004txaustP05.dialsprint.net&quot;,
106         &quot;\u0938\u092e\u0935\u0947\u0924\u093e@bar-tnt1s66.erols.com&quot;,
107         &quot;\u092f\u0941\u092f\u0941\u0924\u094d\u0938\u0935\u0903@101.st-louis-15.mo.dial-access.att.net&quot;,
108         &quot;\u092e\u093e\u092e\u0915\u093e\u0903@h92-245.Arco.COM&quot;,
109         &quot;\u092a\u093e\u0923\u094d\u0921\u0935\u093e\u0936\u094d\u091a\u0948\u0935@dial-13-2.ots.utexas.edu&quot;,
110         &quot;\u0915\u093f\u092e\u0915\u0941\u0930\u094d\u0935\u0924@net-redynet29.datamarkets.com.ar&quot;,
111         &quot;\u0938\u0902\u091c\u0935@ccs-shiva28.reacciun.net.ve&quot;,
112         &quot;\u0c30\u0c18\u0c41\u0c30\u0c3e\u0c2e\u0c4d@7.houston-11.tx.dial-access.att.net&quot;,
113         &quot;\u0c35\u0c3f\u0c36\u0c4d\u0c35\u0c28\u0c3e\u0c27@ingw129-37-120-26.mo.us.ibm.net&quot;,
114         &quot;\u0c06\u0c28\u0c02\u0c26\u0c4d@dialup6.austintx.com&quot;,
115         &quot;\u0C35\u0C26\u0C4D\u0C26\u0C3F\u0C30\u0C3E\u0C1C\u0C41@dns2.tpao.gov.tr&quot;,
116         &quot;\u0c30\u0c3e\u0c1c\u0c40\u0c35\u0c4d@slip129-37-119-194.nc.us.ibm.net&quot;,
117         &quot;\u0c15\u0c36\u0c30\u0c2c\u0c3e\u0c26@cs7.dillons.co.uk.203.119.193.in-addr.arpa&quot;,
118         &quot;\u0c38\u0c02\u0c1c\u0c40\u0c35\u0c4d@swprd1.innovplace.saskatoon.sk.ca&quot;,
119         &quot;\u0c15\u0c36\u0c30\u0c2c\u0c3e\u0c26@bikini.bologna.maraut.it&quot;,
120         &quot;\u0c38\u0c02\u0c1c\u0c40\u0c2c\u0c4d@node91.subnet159-198-79.baxter.com&quot;,
121         &quot;\u0c38\u0c46\u0c28\u0c4d\u0c17\u0c41\u0c2a\u0c4d\u0c24@cust19.max5.new-york.ny.ms.uu.net&quot;,
122         &quot;\u0c05\u0c2e\u0c30\u0c47\u0c02\u0c26\u0c4d\u0c30@balexander.slip.andrew.cmu.edu&quot;,
123         &quot;\u0c39\u0c28\u0c41\u0c2e\u0c3e\u0c28\u0c41\u0c32@pool029.max2.denver.co.dynip.alter.net&quot;,
124         &quot;\u0c30\u0c35\u0c3f@cust49.max9.new-york.ny.ms.uu.net&quot;,
125         &quot;\u0c15\u0c41\u0c2e\u0c3e\u0c30\u0c4d@s61.abq-dialin2.hollyberry.com&quot;,
126         &quot;\u0c35\u0c3f\u0c36\u0c4d\u0c35\u0c28\u0c3e\u0c27@\u0917\u0928\u0947\u0936.sanjose.ibm.com&quot;,
127         &quot;\u0c06\u0c26\u0c3f\u0c24\u0c4d\u0c2f@www.\u00E0\u00B3\u00AF.com&quot;,
128         &quot;\u0C15\u0C02\u0C26\u0C4D\u0C30\u0C47\u0C17\u0C41\u0c32@www.\u00C2\u00A4.com&quot;,
129         &quot;\u0c36\u0c4d\u0c30\u0c40\u0C27\u0C30\u0C4D@www.\u00C2\u00A3.com&quot;,
130         &quot;\u0c15\u0c02\u0c1f\u0c2e\u0c36\u0c46\u0c1f\u0c4d\u0c1f\u0c3f@\u0025&quot;,
131         &quot;\u0c2e\u0c3e\u0c27\u0c35\u0c4d@\u005C\u005C&quot;,
132         &quot;\u0c26\u0c46\u0c36\u0c46\u0c1f\u0c4d\u0c1f\u0c3f@www.\u0021.com&quot;,
133         &quot;test@www.\u0024.com&quot;,
134         &quot;help@\u00C3\u00BC.com&quot;,
135     };
136     public static void TestNFS4MixedPrep(){
137         for(int i=0; i&lt; mixed_prep_data.length; i++){
138             try{
139                 String src = mixed_prep_data[i];
140                 byte[] dest = NFS4StringPrep.mixed_prepare(src.getBytes(&quot;UTF-8&quot;));
141                 String destString = new String(dest, &quot;UTF-8&quot;);
142                 int destIndex = destString.indexOf(&#39;@&#39;);
143                 if(destIndex &lt; 0){
144                     fail(&quot;Delimiter @ disappeared from the output!&quot;);
145                 }
146             }catch(Exception e){
147                 fail(&quot;mixed_prepare for string: &quot; + mixed_prep_data[i] +&quot; failed with &quot; + e.toString());
148             }
149         }
150         /* test the error condition */
151         {
152             String src = &quot;OWNER@oss.software.ibm.com&quot;;
153             try{
154                 byte[] dest = NFS4StringPrep.mixed_prepare(src.getBytes(&quot;UTF-8&quot;));
155                 if(dest!=null){
156                     fail(&quot;Did not get the expected exception&quot;);
157                 }
158             }catch(Exception e){
159                 System.out.println(&quot;mixed_prepare for string: &quot; + src +&quot; passed with &quot; + e.toString());
160             }
161 
162          }
163     }
164     public static void TestCISPrep(){
165 
166         for(int i=0;i&lt; (TestData.conformanceTestCases.length);i++){
167             TestData.ConformanceTestCase testCase = TestData.conformanceTestCases[i];
168             String src = testCase.input;
169             Exception expected = testCase.expected;
170             String expectedDest = testCase.output;
171             try{
172                 byte[] dest =NFS4StringPrep.cis_prepare(src.getBytes(&quot;UTF-8&quot;));
173                 String destString = new String(dest, &quot;UTF-8&quot;);
174                 if(!expectedDest.equalsIgnoreCase(destString)){
175                       fail(&quot;Did not get the expected output for nfs4_cis_prep at index &quot; + i);
176                 }
177             }catch(Exception e){
178                 if(!((expected instanceof ParseException) &amp;&amp; (e instanceof ParseException))) {
179                     fail(&quot;Did not get the expected exception&quot;);
180                 }
181             }
182 
183         }
184     }
185 
186     public static void TestCSPrep(){
187 
188         // Checking for bidi is turned off
189         String src = &quot;\uC138\uACC4\uC758\uBAA8\uB4E0\uC0AC\uB78C\uB4E4\uC774\u0644\u064A\u0647\uD55C\uAD6D\uC5B4\uB97C\uC774\uD574\uD55C\uB2E4\uBA74&quot;;
190         try{
191             NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
192         }catch(Exception e){
193             fail(&quot;Got unexpected exception: &quot; + e.toString());
194         }
195 
196         // normalization is turned off
197         try{
198             src = &quot;www.\u00E0\u00B3\u00AF.com&quot;;
199             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
200             String destStr = new String(dest, &quot;UTF-8&quot;);
201             if(!src.equals(destStr)){
202                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
203                       &quot; Got: &quot; + prettify(destStr));
204             }
205         }catch(Exception e){
206             fail(&quot;Got unexpected exception: &quot; + e.toString());
207         }
208 
209         // test case insensitive string
210         try{
211             src = &quot;THISISATEST&quot;;
212             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
213             String destStr = new String(dest, &quot;UTF-8&quot;);
214             if(!src.toLowerCase(Locale.ROOT).equals(destStr)){
215                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
216                       &quot; Got: &quot; + prettify(destStr));
217             }
218         }catch(Exception e){
219             fail(&quot;Got unexpected exception: &quot; + e.toString());
220         }
221         // test case sensitive string
222         try{
223             src = &quot;THISISATEST&quot;;
224             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), true);
225             String destStr = new String(dest, &quot;UTF-8&quot;);
226             if(!src.equals(destStr)){
227                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
228                       &quot; Got: &quot; + prettify(destStr));
229             }
230         }catch(Exception e){
231             fail(&quot;Got unexpected exception: &quot; + e.toString());
232         }
233     }
234 
235     public static void TestNamePrepConformance() throws Exception {
236         InputStream stream = StringPrep.class.getModule()
237                                              .getResourceAsStream(&quot;sun/net/idn/uidna.spp&quot;);
238         StringPrep namePrep = new StringPrep(stream);
239         stream.close();
240         int i;
241         for(i=0; i&lt;TestData.conformanceTestCases.length;i++){
242             TestData.ConformanceTestCase testCase = TestData.conformanceTestCases[i];
243             try{
244                 UCharacterIterator iter = UCharacterIterator.getInstance(testCase.input);
245                 StringBuffer output = namePrep.prepare(iter, testCase.flags);
246                 if(testCase.output !=null &amp;&amp; output!=null &amp;&amp; !testCase.output.equals(output.toString())){
247                     fail(&quot;Did not get the expected output. Expected: &quot; + prettify(testCase.output)+
248                             &quot; Got: &quot;+ prettify(output.toString()) );
249                 }
250             } catch(ParseException ex) {
251                 if (testCase.expected == null) {
252                     fail(&quot;get the unexpected exception for source: &quot; +testCase.input +&quot; Got:  &quot;+ ex.toString());
253                 }
254             }
255         }
256         System.out.println(&quot;Nameprep test count: &quot; + i);
257     }
258 
259     private static void fail(String msg) {
260         throw new RuntimeException(msg);
261     }
262 
263     private static String prettify(String s) {
264         StringBuffer result = new StringBuffer();
265         for (int i = 0; i &lt; s.length(); ++i) {
266             char ch =s.charAt(i);
267             if(ch &gt; 0x7f){
268                 result.append(&quot;\\u&quot;);
269                 result.append(hex(ch));
270             }else{
271                 result.append(ch);
272             }
273 
274         }
275         return result.toString();
276     }
277 
278     private static String hex(char ch) {
279         StringBuffer result = new StringBuffer();
280         String foo = Integer.toString(ch,16).toUpperCase(Locale.ROOT);
281         for (int i = foo.length(); i &lt; 4; ++i) {
282             result.append(&#39;0&#39;);
283         }
284         return result + foo;
285     }
286 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>