<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/net/idn/TestStringPrep.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Unit test for jdk.internal.icu.text.StringPrep
 27  * @bug 4737170 8060097 8174270
 28  * @modules java.base/jdk.internal.icu.text
 29  * @library .
 30  * @compile -XDignore.symbol.file TestStringPrep.java NFS4StringPrep.java
 31  *     TestData.java
 32  * @run main/othervm -ea TestStringPrep
 33  * @author Edward Wang
 34  */
 35 /*
 36  *******************************************************************************
 37  * Copyright (C) 2003-2004, International Business Machines Corporation and    *
 38  * others. All Rights Reserved.                                                *
 39  *******************************************************************************
 40 */
 41 
 42 import java.text.ParseException;
 43 import java.io.InputStream;
 44 import java.util.Locale;
 45 
 46 import jdk.internal.icu.text.StringPrep;
 47 import jdk.internal.icu.text.UCharacterIterator;
 48 
 49 public class TestStringPrep {
 50     public static void main(String[] args) throws Exception {
 51         TestNFS4MixedPrep();
 52         TestCISPrep();
 53         TestCSPrep();
 54         TestNamePrepConformance();
 55     }
 56     /*
 57        There are several special identifiers (&quot;who&quot;) which need to be
 58        understood universally, rather than in the context of a particular
 59        DNS domain.  Some of these identifiers cannot be understood when an
 60        NFS client accesses the server, but have meaning when a local process
 61        accesses the file.  The ability to display and modify these
 62        permissions is permitted over NFS, even if none of the access methods
 63        on the server understands the identifiers.
 64 
 65         Who                    Description
 66        _______________________________________________________________
 67 
 68        &quot;OWNER&quot;                The owner of the file.
 69        &quot;GROUP&quot;                The group associated with the file.
 70        &quot;EVERYONE&quot;             The world.
 71        &quot;INTERACTIVE&quot;          Accessed from an interactive terminal.
 72        &quot;NETWORK&quot;              Accessed via the network.
 73        &quot;DIALUP&quot;               Accessed as a dialup user to the server.
 74        &quot;BATCH&quot;                Accessed from a batch job.
 75        &quot;ANONYMOUS&quot;            Accessed without any authentication.
 76        &quot;AUTHENTICATED&quot;        Any authenticated user (opposite of
 77                               ANONYMOUS)
 78        &quot;SERVICE&quot;              Access from a system service.
 79 
 80        To avoid conflict, these special identifiers are distinguish by an
 81        appended &quot;@&quot; and should appear in the form &quot;xxxx@&quot; (note: no domain
 82        name after the &quot;@&quot;).  For example: ANONYMOUS@.
 83     */
 84     private static String[] mixed_prep_data ={
 85         &quot;OWNER@&quot;,
 86         &quot;GROUP@&quot;,
 87         &quot;EVERYONE@&quot;,
 88         &quot;INTERACTIVE@&quot;,
 89         &quot;NETWORK@&quot;,
 90         &quot;DIALUP@&quot;,
 91         &quot;BATCH@&quot;,
 92         &quot;ANONYMOUS@&quot;,
 93         &quot;AUTHENTICATED@&quot;,
 94         &quot;\u0930\u094D\u092E\u094D\u0915\u094D\u0937\u0947\u0924\u094D@slip129-37-118-146.nc.us.ibm.net&quot;,
 95         &quot;\u0936\u094d\u0930\u0940\u092e\u0926\u094d@saratoga.pe.utexas.edu&quot;,
 96         &quot;\u092d\u0917\u0935\u0926\u094d\u0917\u0940\u0924\u093e@dial-120-45.ots.utexas.edu&quot;,
 97         &quot;\u0905\u0927\u094d\u092f\u093e\u092f@woo-085.dorms.waller.net&quot;,
 98         &quot;\u0905\u0930\u094d\u091c\u0941\u0928@hd30-049.hil.compuserve.com&quot;,
 99         &quot;\u0935\u093f\u0937\u093e\u0926@pem203-31.pe.ttu.edu&quot;,
100         &quot;\u092f\u094b\u0917@56K-227.MaxTNT3.pdq.net&quot;,
101         &quot;\u0927\u0943\u0924\u0930\u093e\u0937\u094d\u091f\u094d\u0930@dial-36-2.ots.utexas.edu&quot;,
102         &quot;\u0909\u0935\u093E\u091A\u0943@slip129-37-23-152.ga.us.ibm.net&quot;,
103         &quot;\u0927\u0930\u094d\u092e\u0915\u094d\u0937\u0947\u0924\u094d\u0930\u0947@ts45ip119.cadvision.com&quot;,
104         &quot;\u0915\u0941\u0930\u0941\u0915\u094d\u0937\u0947\u0924\u094d\u0930\u0947@sdn-ts-004txaustP05.dialsprint.net&quot;,
105         &quot;\u0938\u092e\u0935\u0947\u0924\u093e@bar-tnt1s66.erols.com&quot;,
106         &quot;\u092f\u0941\u092f\u0941\u0924\u094d\u0938\u0935\u0903@101.st-louis-15.mo.dial-access.att.net&quot;,
107         &quot;\u092e\u093e\u092e\u0915\u093e\u0903@h92-245.Arco.COM&quot;,
108         &quot;\u092a\u093e\u0923\u094d\u0921\u0935\u093e\u0936\u094d\u091a\u0948\u0935@dial-13-2.ots.utexas.edu&quot;,
109         &quot;\u0915\u093f\u092e\u0915\u0941\u0930\u094d\u0935\u0924@net-redynet29.datamarkets.com.ar&quot;,
110         &quot;\u0938\u0902\u091c\u0935@ccs-shiva28.reacciun.net.ve&quot;,
111         &quot;\u0c30\u0c18\u0c41\u0c30\u0c3e\u0c2e\u0c4d@7.houston-11.tx.dial-access.att.net&quot;,
112         &quot;\u0c35\u0c3f\u0c36\u0c4d\u0c35\u0c28\u0c3e\u0c27@ingw129-37-120-26.mo.us.ibm.net&quot;,
113         &quot;\u0c06\u0c28\u0c02\u0c26\u0c4d@dialup6.austintx.com&quot;,
114         &quot;\u0C35\u0C26\u0C4D\u0C26\u0C3F\u0C30\u0C3E\u0C1C\u0C41@dns2.tpao.gov.tr&quot;,
115         &quot;\u0c30\u0c3e\u0c1c\u0c40\u0c35\u0c4d@slip129-37-119-194.nc.us.ibm.net&quot;,
116         &quot;\u0c15\u0c36\u0c30\u0c2c\u0c3e\u0c26@cs7.dillons.co.uk.203.119.193.in-addr.arpa&quot;,
117         &quot;\u0c38\u0c02\u0c1c\u0c40\u0c35\u0c4d@swprd1.innovplace.saskatoon.sk.ca&quot;,
118         &quot;\u0c15\u0c36\u0c30\u0c2c\u0c3e\u0c26@bikini.bologna.maraut.it&quot;,
119         &quot;\u0c38\u0c02\u0c1c\u0c40\u0c2c\u0c4d@node91.subnet159-198-79.baxter.com&quot;,
120         &quot;\u0c38\u0c46\u0c28\u0c4d\u0c17\u0c41\u0c2a\u0c4d\u0c24@cust19.max5.new-york.ny.ms.uu.net&quot;,
121         &quot;\u0c05\u0c2e\u0c30\u0c47\u0c02\u0c26\u0c4d\u0c30@balexander.slip.andrew.cmu.edu&quot;,
122         &quot;\u0c39\u0c28\u0c41\u0c2e\u0c3e\u0c28\u0c41\u0c32@pool029.max2.denver.co.dynip.alter.net&quot;,
123         &quot;\u0c30\u0c35\u0c3f@cust49.max9.new-york.ny.ms.uu.net&quot;,
124         &quot;\u0c15\u0c41\u0c2e\u0c3e\u0c30\u0c4d@s61.abq-dialin2.hollyberry.com&quot;,
125         &quot;\u0c35\u0c3f\u0c36\u0c4d\u0c35\u0c28\u0c3e\u0c27@\u0917\u0928\u0947\u0936.sanjose.ibm.com&quot;,
126         &quot;\u0c06\u0c26\u0c3f\u0c24\u0c4d\u0c2f@www.\u00E0\u00B3\u00AF.com&quot;,
127         &quot;\u0C15\u0C02\u0C26\u0C4D\u0C30\u0C47\u0C17\u0C41\u0c32@www.\u00C2\u00A4.com&quot;,
128         &quot;\u0c36\u0c4d\u0c30\u0c40\u0C27\u0C30\u0C4D@www.\u00C2\u00A3.com&quot;,
129         &quot;\u0c15\u0c02\u0c1f\u0c2e\u0c36\u0c46\u0c1f\u0c4d\u0c1f\u0c3f@\u0025&quot;,
130         &quot;\u0c2e\u0c3e\u0c27\u0c35\u0c4d@\u005C\u005C&quot;,
131         &quot;\u0c26\u0c46\u0c36\u0c46\u0c1f\u0c4d\u0c1f\u0c3f@www.\u0021.com&quot;,
132         &quot;test@www.\u0024.com&quot;,
133         &quot;help@\u00C3\u00BC.com&quot;,
134     };
135     public static void TestNFS4MixedPrep(){
136         for(int i=0; i&lt; mixed_prep_data.length; i++){
137             try{
138                 String src = mixed_prep_data[i];
139                 byte[] dest = NFS4StringPrep.mixed_prepare(src.getBytes(&quot;UTF-8&quot;));
140                 String destString = new String(dest, &quot;UTF-8&quot;);
141                 int destIndex = destString.indexOf(&#39;@&#39;);
142                 if(destIndex &lt; 0){
143                     fail(&quot;Delimiter @ disappeared from the output!&quot;);
144                 }
145             }catch(Exception e){
146                 fail(&quot;mixed_prepare for string: &quot; + mixed_prep_data[i] +&quot; failed with &quot; + e.toString());
147             }
148         }
149         /* test the error condition */
150         {
151             String src = &quot;OWNER@oss.software.ibm.com&quot;;
152             try{
153                 byte[] dest = NFS4StringPrep.mixed_prepare(src.getBytes(&quot;UTF-8&quot;));
154                 if(dest!=null){
155                     fail(&quot;Did not get the expected exception&quot;);
156                 }
157             }catch(Exception e){
158                 System.out.println(&quot;mixed_prepare for string: &quot; + src +&quot; passed with &quot; + e.toString());
159             }
160 
161          }
162     }
163     public static void TestCISPrep(){
164 
165         for(int i=0;i&lt; (TestData.conformanceTestCases.length);i++){
166             TestData.ConformanceTestCase testCase = TestData.conformanceTestCases[i];
167             String src = testCase.input;
168             Exception expected = testCase.expected;
169             String expectedDest = testCase.output;
170             try{
171                 byte[] dest =NFS4StringPrep.cis_prepare(src.getBytes(&quot;UTF-8&quot;));
172                 String destString = new String(dest, &quot;UTF-8&quot;);
173                 if(!expectedDest.equalsIgnoreCase(destString)){
174                       fail(&quot;Did not get the expected output for nfs4_cis_prep at index &quot; + i);
175                 }
176             }catch(Exception e){
177                 if(!((expected instanceof ParseException) &amp;&amp; (e instanceof ParseException))) {
178                     fail(&quot;Did not get the expected exception&quot;);
179                 }
180             }
181 
182         }
183     }
184 
185     public static void TestCSPrep(){
186 
187         // Checking for bidi is turned off
188         String src = &quot;\uC138\uACC4\uC758\uBAA8\uB4E0\uC0AC\uB78C\uB4E4\uC774\u0644\u064A\u0647\uD55C\uAD6D\uC5B4\uB97C\uC774\uD574\uD55C\uB2E4\uBA74&quot;;
189         try{
190             NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
191         }catch(Exception e){
192             fail(&quot;Got unexpected exception: &quot; + e.toString());
193         }
194 
195         // normalization is turned off
196         try{
197             src = &quot;www.\u00E0\u00B3\u00AF.com&quot;;
198             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
199             String destStr = new String(dest, &quot;UTF-8&quot;);
200             if(!src.equals(destStr)){
201                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
202                       &quot; Got: &quot; + prettify(destStr));
203             }
204         }catch(Exception e){
205             fail(&quot;Got unexpected exception: &quot; + e.toString());
206         }
207 
208         // test case insensitive string
209         try{
210             src = &quot;THISISATEST&quot;;
211             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), false);
212             String destStr = new String(dest, &quot;UTF-8&quot;);
213             if(!src.toLowerCase(Locale.ROOT).equals(destStr)){
214                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
215                       &quot; Got: &quot; + prettify(destStr));
216             }
217         }catch(Exception e){
218             fail(&quot;Got unexpected exception: &quot; + e.toString());
219         }
220         // test case sensitive string
221         try{
222             src = &quot;THISISATEST&quot;;
223             byte[] dest = NFS4StringPrep.cs_prepare(src.getBytes(&quot;UTF-8&quot;), true);
224             String destStr = new String(dest, &quot;UTF-8&quot;);
225             if(!src.equals(destStr)){
226                 fail(&quot;Did not get expected output. Expected: &quot;+ prettify(src)+
227                       &quot; Got: &quot; + prettify(destStr));
228             }
229         }catch(Exception e){
230             fail(&quot;Got unexpected exception: &quot; + e.toString());
231         }
232     }
233 
234     public static void TestNamePrepConformance() throws Exception {
235         InputStream stream = StringPrep.class.getModule()
236                                              .getResourceAsStream(&quot;sun/net/idn/uidna.spp&quot;);
237         StringPrep namePrep = new StringPrep(stream);
238         stream.close();
239         int i;
240         for(i=0; i&lt;TestData.conformanceTestCases.length;i++){
241             TestData.ConformanceTestCase testCase = TestData.conformanceTestCases[i];
242             try{
243                 UCharacterIterator iter = UCharacterIterator.getInstance(testCase.input);
244                 StringBuffer output = namePrep.prepare(iter, testCase.flags);
245                 if(testCase.output !=null &amp;&amp; output!=null &amp;&amp; !testCase.output.equals(output.toString())){
246                     fail(&quot;Did not get the expected output. Expected: &quot; + prettify(testCase.output)+
247                             &quot; Got: &quot;+ prettify(output.toString()) );
248                 }
249             } catch(ParseException ex) {
250                 if (testCase.expected == null) {
251                     fail(&quot;get the unexpected exception for source: &quot; +testCase.input +&quot; Got:  &quot;+ ex.toString());
252                 }
253             }
254         }
255         System.out.println(&quot;Nameprep test count: &quot; + i);
256     }
257 
258     private static void fail(String msg) {
259         throw new RuntimeException(msg);
260     }
261 
262     private static String prettify(String s) {
263         StringBuffer result = new StringBuffer();
264         for (int i = 0; i &lt; s.length(); ++i) {
265             char ch =s.charAt(i);
266             if(ch &gt; 0x7f){
267                 result.append(&quot;\\u&quot;);
268                 result.append(hex(ch));
269             }else{
270                 result.append(ch);
271             }
272 
273         }
274         return result.toString();
275     }
276 
277     private static String hex(char ch) {
278         StringBuffer result = new StringBuffer();
279         String foo = Integer.toString(ch,16).toUpperCase(Locale.ROOT);
280         for (int i = foo.length(); i &lt; 4; ++i) {
281             result.append(&#39;0&#39;);
282         }
283         return result + foo;
284     }
285 }
    </pre>
  </body>
</html>