<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/ftp/FtpGetContent.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B6427768.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="FtpURL.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/ftp/FtpGetContent.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;
 26 
 27 /*
 28  * @test
 29  * @bug 4255280
 30  * @summary URL.getContent() loses first six bytes for ftp URLs


 31  */
 32 
 33 public class FtpGetContent {
 34     static int filesize = 2048;
 35 
 36     /**
 37      * A class that simulates, on a separate, an FTP server.
 38      */
 39 
 40     private class FtpServer extends Thread {
<span class="line-modified"> 41         private ServerSocket    server;</span>
 42         private int port;
 43         private boolean done = false;
 44         private boolean portEnabled = true;
 45         private boolean pasvEnabled = true;

 46         private String username;
 47         private String password;
 48         private String cwd;
 49         private String filename;
 50         private String type;
 51         private boolean list = false;
 52 
 53         /**
 54          * This Inner class will handle ONE client at a time.
 55          * That&#39;s where 99% of the protocol handling is done.
 56          */
 57 
 58         private class FtpServerHandler extends Thread {
 59             BufferedReader in;
 60             PrintWriter out;
 61             Socket client;
 62             private final int ERROR = 0;
 63             private final int USER = 1;
 64             private final int PASS = 2;
 65             private final int CWD = 3;
 66             private final int CDUP = 4;
 67             private final int PWD = 5;
 68             private final int TYPE = 6;
 69             private final int NOOP = 7;
 70             private final int RETR = 8;
 71             private final int PASV = 9;
 72             private final int PORT = 10;
 73             private final int LIST = 11;
 74             private final int REIN = 12;
 75             private final int QUIT = 13;
 76             private final int STOR = 14;
 77             private final int NLST = 15;
 78             private final int RNFR = 16;
 79             private final int RNTO = 17;

 80             String[] cmds = { &quot;USER&quot;, &quot;PASS&quot;, &quot;CWD&quot;, &quot;CDUP&quot;, &quot;PWD&quot;, &quot;TYPE&quot;,
 81                               &quot;NOOP&quot;, &quot;RETR&quot;, &quot;PASV&quot;, &quot;PORT&quot;, &quot;LIST&quot;, &quot;REIN&quot;,
<span class="line-modified"> 82                               &quot;QUIT&quot;, &quot;STOR&quot;, &quot;NLST&quot;, &quot;RNFR&quot;, &quot;RNTO&quot; };</span>
 83             private String arg = null;
 84             private ServerSocket pasv = null;
 85             private int data_port = 0;
 86             private InetAddress data_addr = null;
 87 
 88             /**
 89              * Parses a line to match it with one of the supported FTP commands.
 90              * Returns the command number.
 91              */
 92 
 93             private int parseCmd(String cmd) {

 94                 if (cmd == null || cmd.length() &lt; 3)
 95                     return ERROR;
 96                 int blank = cmd.indexOf(&#39; &#39;);
 97                 if (blank &lt; 0)
 98                     blank = cmd.length();
 99                 if (blank &lt; 3)
100                     return ERROR;
101                 String s = cmd.substring(0, blank);
102                 if (cmd.length() &gt; blank+1)
103                     arg = cmd.substring(blank+1, cmd.length());
104                 else
105                     arg = null;
106                 for (int i = 0; i &lt; cmds.length; i++) {
107                     if (s.equalsIgnoreCase(cmds[i]))
108                         return i+1;
109                 }
110                 return ERROR;
111             }
112 
113             public FtpServerHandler(Socket cl) {
</pre>
<hr />
<pre>
231                                 pasv.close();
232                             done = true;
233                             break;
234                         case TYPE:
235                             out.println(&quot;200 Type set to &quot; + arg + &quot;.&quot;);
236                             type = arg;
237                             break;
238                         case CWD:
239                             out.println(&quot;250 CWD command successful.&quot;);
240                             if (cwd == null)
241                                 cwd = str.substring(4);
242                             else
243                                 cwd = cwd + &quot;/&quot; + str.substring(4);
244                             break;
245                         case CDUP:
246                             out.println(&quot;250 CWD command successful.&quot;);
247                             break;
248                         case PWD:
249                             out.println(&quot;257 \&quot;&quot; + cwd + &quot;\&quot; is current directory&quot;);
250                             break;


























251                         case PASV:
252                             if (!pasvEnabled) {
253                                 out.println(&quot;500 PASV is disabled, use PORT instead.&quot;);
254                                 continue;
255                             }
256                             try {
<span class="line-modified">257                                 if (pasv == null)</span>
<span class="line-modified">258                                     pasv = new ServerSocket(0);</span>


259                                 int port = pasv.getLocalPort();
260                                 out.println(&quot;227 Entering Passive Mode (127,0,0,1,&quot; +
261                                             (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) +&quot;)&quot;);
262                             } catch (IOException ssex) {
263                                 out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
264                             }
265                             break;
266                         case PORT:
267                             if (!portEnabled) {
268                                 out.println(&quot;500 PORT is disabled, use PASV instead&quot;);
269                                 continue;
270                             }
271                             StringBuffer host;
272                             int i=0, j=4;
273                             while (j&gt;0) {
274                                 i = arg.indexOf(&#39;,&#39;, i+1);
275                                 if (i &lt; 0)
276                                     break;
277                                 j--;
278                             }
</pre>
<hr />
<pre>
350                                     } while (val != -1);
351                                     din.close();
352                                 } else
353                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
354                             }
355                             break;
356                         }
357                     } catch (IOException ioe) {
358                         ioe.printStackTrace();
359                         try {
360                             out.close();
361                         } catch (Exception ex2) {
362                         }
363                         done = true;
364                     }
365                 }
366             }
367         }
368 
369         public FtpServer(int port) {




370             this.port = port;
371             try {
<span class="line-modified">372               server = new ServerSocket(port);</span>

373             } catch (IOException e) {

374             }
375         }
376 
377         public FtpServer() {
378             this(21);
379         }
380 
381         public int getPort() {
382             if (server != null)
383                 return server.getLocalPort();
384             return 0;
385         }
386 










387         /**
388          * A way to tell the server that it can stop.
389          */
390         synchronized public void terminate() {
391             done = true;
392         }
393 
394         synchronized boolean done() {
395             return done;
396         }
397 
398         synchronized public void setPortEnabled(boolean ok) {
399             portEnabled = ok;
400         }
401 
402         synchronized public void setPasvEnabled(boolean ok) {
403             pasvEnabled = ok;
404         }
405 
406         String getUsername() {
</pre>
<hr />
<pre>
435         public void run() {
436             try {
437                 Socket client;
438                 while (!done()) {
439                     client = server.accept();
440                     (new FtpServerHandler(client)).start();
441                 }
442             } catch(Exception e) {
443             } finally {
444                 try { server.close(); } catch (IOException unused) {}
445             }
446         }
447     }
448     public static void main(String[] args) throws Exception {
449         FtpGetContent test = new FtpGetContent();
450     }
451 
452     public FtpGetContent() throws Exception {
453         FtpServer server = null;
454         try {
<span class="line-modified">455             server = new FtpServer(0);</span>

456             server.start();
<span class="line-modified">457             int port = server.getPort();</span>
458 
459             // Now let&#39;s check the URL handler
460 
<span class="line-modified">461             URL url = new URL(&quot;ftp://localhost:&quot; + port + &quot;/pub/BigFile&quot;);</span>
<span class="line-modified">462             InputStream stream = (InputStream)url.getContent();</span>

463             byte[] buffer = new byte[1024];
464             int totalBytes = 0;
465             int bytesRead = stream.read(buffer);
466             while (bytesRead != -1) {
467                 totalBytes += bytesRead;
468                 bytesRead = stream.read(buffer);
469             }
470             stream.close();
471             if (totalBytes != filesize)
472                 throw new RuntimeException(&quot;wrong file size!&quot;);
473         } catch (IOException e) {
474             throw new RuntimeException(e.getMessage());
475         } finally {
476             server.terminate();
477             server.server.close();
478         }
479     }
480 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;
 26 
 27 /*
 28  * @test
 29  * @bug 4255280
 30  * @summary URL.getContent() loses first six bytes for ftp URLs
<span class="line-added"> 31  * @run main FtpGetContent</span>
<span class="line-added"> 32  * @run main/othervm -Djava.net.preferIPv6Addresses=true FtpGetContent</span>
 33  */
 34 
 35 public class FtpGetContent {
 36     static int filesize = 2048;
 37 
 38     /**
 39      * A class that simulates, on a separate, an FTP server.
 40      */
 41 
 42     private class FtpServer extends Thread {
<span class="line-modified"> 43         private final ServerSocket    server;</span>
 44         private int port;
 45         private boolean done = false;
 46         private boolean portEnabled = true;
 47         private boolean pasvEnabled = true;
<span class="line-added"> 48         private boolean extendedEnabled = true;</span>
 49         private String username;
 50         private String password;
 51         private String cwd;
 52         private String filename;
 53         private String type;
 54         private boolean list = false;
 55 
 56         /**
 57          * This Inner class will handle ONE client at a time.
 58          * That&#39;s where 99% of the protocol handling is done.
 59          */
 60 
 61         private class FtpServerHandler extends Thread {
 62             BufferedReader in;
 63             PrintWriter out;
 64             Socket client;
 65             private final int ERROR = 0;
 66             private final int USER = 1;
 67             private final int PASS = 2;
 68             private final int CWD = 3;
 69             private final int CDUP = 4;
 70             private final int PWD = 5;
 71             private final int TYPE = 6;
 72             private final int NOOP = 7;
 73             private final int RETR = 8;
 74             private final int PASV = 9;
 75             private final int PORT = 10;
 76             private final int LIST = 11;
 77             private final int REIN = 12;
 78             private final int QUIT = 13;
 79             private final int STOR = 14;
 80             private final int NLST = 15;
 81             private final int RNFR = 16;
 82             private final int RNTO = 17;
<span class="line-added"> 83             private final int EPSV = 18;</span>
 84             String[] cmds = { &quot;USER&quot;, &quot;PASS&quot;, &quot;CWD&quot;, &quot;CDUP&quot;, &quot;PWD&quot;, &quot;TYPE&quot;,
 85                               &quot;NOOP&quot;, &quot;RETR&quot;, &quot;PASV&quot;, &quot;PORT&quot;, &quot;LIST&quot;, &quot;REIN&quot;,
<span class="line-modified"> 86                               &quot;QUIT&quot;, &quot;STOR&quot;, &quot;NLST&quot;, &quot;RNFR&quot;, &quot;RNTO&quot;, &quot;EPSV&quot;};</span>
 87             private String arg = null;
 88             private ServerSocket pasv = null;
 89             private int data_port = 0;
 90             private InetAddress data_addr = null;
 91 
 92             /**
 93              * Parses a line to match it with one of the supported FTP commands.
 94              * Returns the command number.
 95              */
 96 
 97             private int parseCmd(String cmd) {
<span class="line-added"> 98                 System.out.println(&quot;FTP server received command: &quot; + cmd);</span>
 99                 if (cmd == null || cmd.length() &lt; 3)
100                     return ERROR;
101                 int blank = cmd.indexOf(&#39; &#39;);
102                 if (blank &lt; 0)
103                     blank = cmd.length();
104                 if (blank &lt; 3)
105                     return ERROR;
106                 String s = cmd.substring(0, blank);
107                 if (cmd.length() &gt; blank+1)
108                     arg = cmd.substring(blank+1, cmd.length());
109                 else
110                     arg = null;
111                 for (int i = 0; i &lt; cmds.length; i++) {
112                     if (s.equalsIgnoreCase(cmds[i]))
113                         return i+1;
114                 }
115                 return ERROR;
116             }
117 
118             public FtpServerHandler(Socket cl) {
</pre>
<hr />
<pre>
236                                 pasv.close();
237                             done = true;
238                             break;
239                         case TYPE:
240                             out.println(&quot;200 Type set to &quot; + arg + &quot;.&quot;);
241                             type = arg;
242                             break;
243                         case CWD:
244                             out.println(&quot;250 CWD command successful.&quot;);
245                             if (cwd == null)
246                                 cwd = str.substring(4);
247                             else
248                                 cwd = cwd + &quot;/&quot; + str.substring(4);
249                             break;
250                         case CDUP:
251                             out.println(&quot;250 CWD command successful.&quot;);
252                             break;
253                         case PWD:
254                             out.println(&quot;257 \&quot;&quot; + cwd + &quot;\&quot; is current directory&quot;);
255                             break;
<span class="line-added">256                         case EPSV:</span>
<span class="line-added">257                             if (!extendedEnabled || !pasvEnabled) {</span>
<span class="line-added">258                                 out.println(&quot;500 EPSV is disabled, &quot; +</span>
<span class="line-added">259                                                 &quot;use PORT instead.&quot;);</span>
<span class="line-added">260                                 continue;</span>
<span class="line-added">261                             }</span>
<span class="line-added">262                             if (!(server.getInetAddress() instanceof Inet6Address)) {</span>
<span class="line-added">263                                 // pretend EPSV is not implemented</span>
<span class="line-added">264                                 out.println(&quot;500 &#39;&quot; + str + &quot;&#39;: command not understood.&quot;);</span>
<span class="line-added">265                                 break;</span>
<span class="line-added">266                             }</span>
<span class="line-added">267                             if (&quot;all&quot;.equalsIgnoreCase(arg)) {</span>
<span class="line-added">268                                 out.println(&quot;200 EPSV ALL command successful.&quot;);</span>
<span class="line-added">269                                 continue;</span>
<span class="line-added">270                             }</span>
<span class="line-added">271                             try {</span>
<span class="line-added">272                                 if (pasv == null)</span>
<span class="line-added">273                                     pasv = new ServerSocket(0, 0, server.getInetAddress());</span>
<span class="line-added">274                                 int port = pasv.getLocalPort();</span>
<span class="line-added">275                                 out.println(&quot;229 Entering Extended&quot; +</span>
<span class="line-added">276                                         &quot; Passive Mode (|||&quot; + port + &quot;|)&quot;);</span>
<span class="line-added">277                             } catch (IOException ssex) {</span>
<span class="line-added">278                                 out.println(&quot;425 Can&#39;t build data connection:&quot; +</span>
<span class="line-added">279                                                 &quot; Connection refused.&quot;);</span>
<span class="line-added">280                             }</span>
<span class="line-added">281                             break;</span>
282                         case PASV:
283                             if (!pasvEnabled) {
284                                 out.println(&quot;500 PASV is disabled, use PORT instead.&quot;);
285                                 continue;
286                             }
287                             try {
<span class="line-modified">288                                 if (pasv == null) {</span>
<span class="line-modified">289                                     pasv = new ServerSocket();</span>
<span class="line-added">290                                     pasv.bind(new InetSocketAddress(&quot;127.0.0.1&quot;, 0));</span>
<span class="line-added">291                                 }</span>
292                                 int port = pasv.getLocalPort();
293                                 out.println(&quot;227 Entering Passive Mode (127,0,0,1,&quot; +
294                                             (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) +&quot;)&quot;);
295                             } catch (IOException ssex) {
296                                 out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
297                             }
298                             break;
299                         case PORT:
300                             if (!portEnabled) {
301                                 out.println(&quot;500 PORT is disabled, use PASV instead&quot;);
302                                 continue;
303                             }
304                             StringBuffer host;
305                             int i=0, j=4;
306                             while (j&gt;0) {
307                                 i = arg.indexOf(&#39;,&#39;, i+1);
308                                 if (i &lt; 0)
309                                     break;
310                                 j--;
311                             }
</pre>
<hr />
<pre>
383                                     } while (val != -1);
384                                     din.close();
385                                 } else
386                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
387                             }
388                             break;
389                         }
390                     } catch (IOException ioe) {
391                         ioe.printStackTrace();
392                         try {
393                             out.close();
394                         } catch (Exception ex2) {
395                         }
396                         done = true;
397                     }
398                 }
399             }
400         }
401 
402         public FtpServer(int port) {
<span class="line-added">403             this(null, 0);</span>
<span class="line-added">404         }</span>
<span class="line-added">405 </span>
<span class="line-added">406         public FtpServer(InetAddress address, int port) {</span>
407             this.port = port;
408             try {
<span class="line-modified">409                 server = new ServerSocket();</span>
<span class="line-added">410                 server.bind(new InetSocketAddress(address, port));</span>
411             } catch (IOException e) {
<span class="line-added">412                 throw new RuntimeException(e);</span>
413             }
414         }
415 
416         public FtpServer() {
417             this(21);
418         }
419 
420         public int getPort() {
421             if (server != null)
422                 return server.getLocalPort();
423             return 0;
424         }
425 
<span class="line-added">426         public String getAuthority() {</span>
<span class="line-added">427             InetAddress address = server.getInetAddress();</span>
<span class="line-added">428             String hostaddr = address.isAnyLocalAddress()</span>
<span class="line-added">429                 ? &quot;localhost&quot; : address.getHostAddress();</span>
<span class="line-added">430             if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="line-added">431                 hostaddr = &quot;[&quot; + hostaddr +&quot;]&quot;;</span>
<span class="line-added">432             }</span>
<span class="line-added">433             return hostaddr + &quot;:&quot; + getPort();</span>
<span class="line-added">434         }</span>
<span class="line-added">435 </span>
436         /**
437          * A way to tell the server that it can stop.
438          */
439         synchronized public void terminate() {
440             done = true;
441         }
442 
443         synchronized boolean done() {
444             return done;
445         }
446 
447         synchronized public void setPortEnabled(boolean ok) {
448             portEnabled = ok;
449         }
450 
451         synchronized public void setPasvEnabled(boolean ok) {
452             pasvEnabled = ok;
453         }
454 
455         String getUsername() {
</pre>
<hr />
<pre>
484         public void run() {
485             try {
486                 Socket client;
487                 while (!done()) {
488                     client = server.accept();
489                     (new FtpServerHandler(client)).start();
490                 }
491             } catch(Exception e) {
492             } finally {
493                 try { server.close(); } catch (IOException unused) {}
494             }
495         }
496     }
497     public static void main(String[] args) throws Exception {
498         FtpGetContent test = new FtpGetContent();
499     }
500 
501     public FtpGetContent() throws Exception {
502         FtpServer server = null;
503         try {
<span class="line-modified">504             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">505             server = new FtpServer(loopback, 0);</span>
506             server.start();
<span class="line-modified">507             String authority = server.getAuthority();</span>
508 
509             // Now let&#39;s check the URL handler
510 
<span class="line-modified">511             URL url = new URL(&quot;ftp://&quot; + authority + &quot;/pub/BigFile&quot;);</span>
<span class="line-modified">512             InputStream stream = (InputStream)url.openConnection(Proxy.NO_PROXY)</span>
<span class="line-added">513                                  .getContent();</span>
514             byte[] buffer = new byte[1024];
515             int totalBytes = 0;
516             int bytesRead = stream.read(buffer);
517             while (bytesRead != -1) {
518                 totalBytes += bytesRead;
519                 bytesRead = stream.read(buffer);
520             }
521             stream.close();
522             if (totalBytes != filesize)
523                 throw new RuntimeException(&quot;wrong file size!&quot;);
524         } catch (IOException e) {
525             throw new RuntimeException(e.getMessage());
526         } finally {
527             server.terminate();
528             server.server.close();
529         }
530     }
531 }
</pre>
</td>
</tr>
</table>
<center><a href="B6427768.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="FtpURL.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>