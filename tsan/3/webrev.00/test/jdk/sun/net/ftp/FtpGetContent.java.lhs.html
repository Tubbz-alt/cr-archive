<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/net/ftp/FtpGetContent.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;
 26 
 27 /*
 28  * @test
 29  * @bug 4255280
 30  * @summary URL.getContent() loses first six bytes for ftp URLs
<a name="2" id="anc2"></a>

 31  */
 32 
 33 public class FtpGetContent {
 34     static int filesize = 2048;
 35 
 36     /**
 37      * A class that simulates, on a separate, an FTP server.
 38      */
 39 
 40     private class FtpServer extends Thread {
<a name="3" id="anc3"></a><span class="line-modified"> 41         private ServerSocket    server;</span>
 42         private int port;
 43         private boolean done = false;
 44         private boolean portEnabled = true;
 45         private boolean pasvEnabled = true;
<a name="4" id="anc4"></a>
 46         private String username;
 47         private String password;
 48         private String cwd;
 49         private String filename;
 50         private String type;
 51         private boolean list = false;
 52 
 53         /**
 54          * This Inner class will handle ONE client at a time.
 55          * That&#39;s where 99% of the protocol handling is done.
 56          */
 57 
 58         private class FtpServerHandler extends Thread {
 59             BufferedReader in;
 60             PrintWriter out;
 61             Socket client;
 62             private final int ERROR = 0;
 63             private final int USER = 1;
 64             private final int PASS = 2;
 65             private final int CWD = 3;
 66             private final int CDUP = 4;
 67             private final int PWD = 5;
 68             private final int TYPE = 6;
 69             private final int NOOP = 7;
 70             private final int RETR = 8;
 71             private final int PASV = 9;
 72             private final int PORT = 10;
 73             private final int LIST = 11;
 74             private final int REIN = 12;
 75             private final int QUIT = 13;
 76             private final int STOR = 14;
 77             private final int NLST = 15;
 78             private final int RNFR = 16;
 79             private final int RNTO = 17;
<a name="5" id="anc5"></a>
 80             String[] cmds = { &quot;USER&quot;, &quot;PASS&quot;, &quot;CWD&quot;, &quot;CDUP&quot;, &quot;PWD&quot;, &quot;TYPE&quot;,
 81                               &quot;NOOP&quot;, &quot;RETR&quot;, &quot;PASV&quot;, &quot;PORT&quot;, &quot;LIST&quot;, &quot;REIN&quot;,
<a name="6" id="anc6"></a><span class="line-modified"> 82                               &quot;QUIT&quot;, &quot;STOR&quot;, &quot;NLST&quot;, &quot;RNFR&quot;, &quot;RNTO&quot; };</span>
 83             private String arg = null;
 84             private ServerSocket pasv = null;
 85             private int data_port = 0;
 86             private InetAddress data_addr = null;
 87 
 88             /**
 89              * Parses a line to match it with one of the supported FTP commands.
 90              * Returns the command number.
 91              */
 92 
 93             private int parseCmd(String cmd) {
<a name="7" id="anc7"></a>
 94                 if (cmd == null || cmd.length() &lt; 3)
 95                     return ERROR;
 96                 int blank = cmd.indexOf(&#39; &#39;);
 97                 if (blank &lt; 0)
 98                     blank = cmd.length();
 99                 if (blank &lt; 3)
100                     return ERROR;
101                 String s = cmd.substring(0, blank);
102                 if (cmd.length() &gt; blank+1)
103                     arg = cmd.substring(blank+1, cmd.length());
104                 else
105                     arg = null;
106                 for (int i = 0; i &lt; cmds.length; i++) {
107                     if (s.equalsIgnoreCase(cmds[i]))
108                         return i+1;
109                 }
110                 return ERROR;
111             }
112 
113             public FtpServerHandler(Socket cl) {
114                 client = cl;
115             }
116 
117             protected boolean isPasvSet() {
118                 if (pasv != null &amp;&amp; !pasvEnabled) {
119                     try {
120                         pasv.close();
121                     } catch (IOException ex) {
122                     }
123                     pasv = null;
124                 }
125                 if (pasvEnabled &amp;&amp; pasv != null)
126                     return true;
127                 return false;
128             }
129 
130             /**
131              * Open the data socket with the client. This can be the
132              * result of a &quot;PASV&quot; or &quot;PORT&quot; command.
133              */
134 
135             protected OutputStream getOutDataStream() {
136                 try {
137                     if (isPasvSet()) {
138                         Socket s = pasv.accept();
139                         return s.getOutputStream();
140                     }
141                     if (data_addr != null) {
142                         Socket s = new Socket(data_addr, data_port);
143                         data_addr = null;
144                         data_port = 0;
145                         return s.getOutputStream();
146                     }
147                 } catch (Exception e) {
148                     e.printStackTrace();
149                 }
150                 return null;
151             }
152 
153             protected InputStream getInDataStream() {
154                 try {
155                     if (isPasvSet()) {
156                         Socket s = pasv.accept();
157                         return s.getInputStream();
158                     }
159                     if (data_addr != null) {
160                         Socket s = new Socket(data_addr, data_port);
161                         data_addr = null;
162                         data_port = 0;
163                         return s.getInputStream();
164                     }
165                 } catch (Exception e) {
166                     e.printStackTrace();
167                 }
168                 return null;
169             }
170 
171             /**
172              * Handles the protocol exchange with the client.
173              */
174 
175             public void run() {
176                 boolean done = false;
177                 String str;
178                 int res;
179                 boolean logged = false;
180                 boolean waitpass = false;
181 
182                 try {
183                     in = new BufferedReader(new InputStreamReader(client.getInputStream()));
184                     out = new PrintWriter(client.getOutputStream(), true);
185                     out.println(&quot;220 tatooine FTP server (SunOS 5.8) ready.&quot;);
186                 } catch (Exception ex) {
187                     return;
188                 }
189                 while (!done) {
190                     try {
191                         str = in.readLine();
192                         res = parseCmd(str);
193                         if ((res &gt; PASS &amp;&amp; res != QUIT) &amp;&amp; !logged) {
194                             out.println(&quot;530 Not logged in.&quot;);
195                             continue;
196                         }
197                         switch (res) {
198                         case ERROR:
199                             out.println(&quot;500 &#39;&quot; + str + &quot;&#39;: command not understood.&quot;);
200                             break;
201                         case USER:
202                             if (!logged &amp;&amp; !waitpass) {
203                                 username = str.substring(5);
204                                 password = null;
205                                 cwd = null;
206                                 if (&quot;user2&quot;.equals(username)) {
207                                     out.println(&quot;230 Guest login ok, access restrictions apply.&quot;);
208                                     logged = true;
209                                 } else {
210                                     out.println(&quot;331 Password required for &quot; + arg);
211                                     waitpass = true;
212                                 }
213                             } else {
214                                 out.println(&quot;503 Bad sequence of commands.&quot;);
215                             }
216                             break;
217                         case PASS:
218                             if (!logged &amp;&amp; waitpass) {
219                                 out.println(&quot;230 Guest login ok, access restrictions apply.&quot;);
220                                 password = str.substring(5);
221                                 logged = true;
222                                 waitpass = false;
223                             } else
224                                 out.println(&quot;503 Bad sequence of commands.&quot;);
225                             break;
226                         case QUIT:
227                             out.println(&quot;221 Goodbye.&quot;);
228                             out.flush();
229                             out.close();
230                             if (pasv != null)
231                                 pasv.close();
232                             done = true;
233                             break;
234                         case TYPE:
235                             out.println(&quot;200 Type set to &quot; + arg + &quot;.&quot;);
236                             type = arg;
237                             break;
238                         case CWD:
239                             out.println(&quot;250 CWD command successful.&quot;);
240                             if (cwd == null)
241                                 cwd = str.substring(4);
242                             else
243                                 cwd = cwd + &quot;/&quot; + str.substring(4);
244                             break;
245                         case CDUP:
246                             out.println(&quot;250 CWD command successful.&quot;);
247                             break;
248                         case PWD:
249                             out.println(&quot;257 \&quot;&quot; + cwd + &quot;\&quot; is current directory&quot;);
250                             break;
<a name="8" id="anc8"></a>

























251                         case PASV:
252                             if (!pasvEnabled) {
253                                 out.println(&quot;500 PASV is disabled, use PORT instead.&quot;);
254                                 continue;
255                             }
256                             try {
<a name="9" id="anc9"></a><span class="line-modified">257                                 if (pasv == null)</span>
<span class="line-modified">258                                     pasv = new ServerSocket(0);</span>


259                                 int port = pasv.getLocalPort();
260                                 out.println(&quot;227 Entering Passive Mode (127,0,0,1,&quot; +
261                                             (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) +&quot;)&quot;);
262                             } catch (IOException ssex) {
263                                 out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
264                             }
265                             break;
266                         case PORT:
267                             if (!portEnabled) {
268                                 out.println(&quot;500 PORT is disabled, use PASV instead&quot;);
269                                 continue;
270                             }
271                             StringBuffer host;
272                             int i=0, j=4;
273                             while (j&gt;0) {
274                                 i = arg.indexOf(&#39;,&#39;, i+1);
275                                 if (i &lt; 0)
276                                     break;
277                                 j--;
278                             }
279                             if (j != 0) {
280                                 out.println(&quot;500 &#39;&quot; + arg + &quot;&#39;: command not understood.&quot;);
281                                 continue;
282                             }
283                             try {
284                                 host = new StringBuffer(arg.substring(0,i));
285                                 for (j=0; j &lt; host.length(); j++)
286                                     if (host.charAt(j) == &#39;,&#39;)
287                                         host.setCharAt(j, &#39;.&#39;);
288                                 String ports = arg.substring(i+1);
289                                 i = ports.indexOf(&#39;,&#39;);
290                                 data_port = Integer.parseInt(ports.substring(0,i)) &lt;&lt; 8;
291                                 data_port += (Integer.parseInt(ports.substring(i+1)));
292                                 data_addr = InetAddress.getByName(host.toString());
293                                 out.println(&quot;200 Command okay.&quot;);
294                             } catch (Exception ex3) {
295                                 data_port = 0;
296                                 data_addr = null;
297                                 out.println(&quot;500 &#39;&quot; + arg + &quot;&#39;: command not understood.&quot;);
298                             }
299                             break;
300                         case RETR:
301                             {
302                                 filename = str.substring(5);
303                                 OutputStream dout = getOutDataStream();
304                                 if (dout != null) {
305                                     out.println(&quot;200 Command okay.&quot;);
306                                     BufferedOutputStream pout = new BufferedOutputStream(dout);
307                                     for (int x = 0; x &lt; filesize ; x++)
308                                         pout.write(0);
309                                     pout.flush();
310                                     pout.close();
311                                     list = false;
312                                 } else
313                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
314                             }
315                             break;
316                         case NLST:
317                             filename = arg;
318                         case LIST:
319                             {
320                                 OutputStream dout = getOutDataStream();
321                                 if (dout != null) {
322                                     out.println(&quot;200 Command okay.&quot;);
323                                     PrintWriter pout = new PrintWriter(new BufferedOutputStream(dout));
324                                     pout.println(&quot;total 130&quot;);
325                                     pout.println(&quot;drwxrwxrwt   7 sys      sys          577 May 12 03:30 .&quot;);
326                                     pout.println(&quot;drwxr-xr-x  39 root     root        1024 Mar 27 12:55 ..&quot;);
327                                     pout.println(&quot;drwxrwxr-x   2 root     root         176 Apr 10 12:02 .X11-pipe&quot;);
328                                     pout.println(&quot;drwxrwxr-x   2 root     root         176 Apr 10 12:02 .X11-unix&quot;);
329                                     pout.println(&quot;drwxrwxrwx   2 root     root         179 Mar 30 15:09 .pcmcia&quot;);
330                                     pout.println(&quot;drwxrwxrwx   2 jladen   staff        117 Mar 30 18:18 .removable&quot;);
331                                     pout.println(&quot;drwxrwxrwt   2 root     root         327 Mar 30 15:08 .rpc_door&quot;);
332                                     pout.println(&quot;-rw-r--r--   1 root     other         21 May  5 16:59 hello2.txt&quot;);
333                                     pout.println(&quot;-rw-rw-r--   1 root     sys         5968 Mar 30 15:08 ps_data&quot;);
334                                     pout.flush();
335                                     pout.close();
336                                     list = true;
337                                 } else
338                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
339                             }
340                             break;
341                         case STOR:
342                             {
343                                 InputStream is = getInDataStream();
344                                 if (is != null) {
345                                     out.println(&quot;200 Command okay.&quot;);
346                                     BufferedInputStream din = new BufferedInputStream(is);
347                                     int val;
348                                     do {
349                                         val = din.read();
350                                     } while (val != -1);
351                                     din.close();
352                                 } else
353                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
354                             }
355                             break;
356                         }
357                     } catch (IOException ioe) {
358                         ioe.printStackTrace();
359                         try {
360                             out.close();
361                         } catch (Exception ex2) {
362                         }
363                         done = true;
364                     }
365                 }
366             }
367         }
368 
369         public FtpServer(int port) {
<a name="10" id="anc10"></a>



370             this.port = port;
371             try {
<a name="11" id="anc11"></a><span class="line-modified">372               server = new ServerSocket(port);</span>

373             } catch (IOException e) {
<a name="12" id="anc12"></a>
374             }
375         }
376 
377         public FtpServer() {
378             this(21);
379         }
380 
381         public int getPort() {
382             if (server != null)
383                 return server.getLocalPort();
384             return 0;
385         }
386 
<a name="13" id="anc13"></a>









387         /**
388          * A way to tell the server that it can stop.
389          */
390         synchronized public void terminate() {
391             done = true;
392         }
393 
394         synchronized boolean done() {
395             return done;
396         }
397 
398         synchronized public void setPortEnabled(boolean ok) {
399             portEnabled = ok;
400         }
401 
402         synchronized public void setPasvEnabled(boolean ok) {
403             pasvEnabled = ok;
404         }
405 
406         String getUsername() {
407             return username;
408         }
409 
410         String getPassword() {
411             return password;
412         }
413 
414         String pwd() {
415             return cwd;
416         }
417 
418         String getFilename() {
419             return filename;
420         }
421 
422         String getType() {
423             return type;
424         }
425 
426         boolean getList() {
427             return list;
428         }
429 
430         /*
431          * All we got to do here is create a ServerSocket and wait for connections.
432          * When a connection happens, we just have to create a thread that will
433          * handle it.
434          */
435         public void run() {
436             try {
437                 Socket client;
438                 while (!done()) {
439                     client = server.accept();
440                     (new FtpServerHandler(client)).start();
441                 }
442             } catch(Exception e) {
443             } finally {
444                 try { server.close(); } catch (IOException unused) {}
445             }
446         }
447     }
448     public static void main(String[] args) throws Exception {
449         FtpGetContent test = new FtpGetContent();
450     }
451 
452     public FtpGetContent() throws Exception {
453         FtpServer server = null;
454         try {
<a name="14" id="anc14"></a><span class="line-modified">455             server = new FtpServer(0);</span>

456             server.start();
<a name="15" id="anc15"></a><span class="line-modified">457             int port = server.getPort();</span>
458 
459             // Now let&#39;s check the URL handler
460 
<a name="16" id="anc16"></a><span class="line-modified">461             URL url = new URL(&quot;ftp://localhost:&quot; + port + &quot;/pub/BigFile&quot;);</span>
<span class="line-modified">462             InputStream stream = (InputStream)url.getContent();</span>

463             byte[] buffer = new byte[1024];
464             int totalBytes = 0;
465             int bytesRead = stream.read(buffer);
466             while (bytesRead != -1) {
467                 totalBytes += bytesRead;
468                 bytesRead = stream.read(buffer);
469             }
470             stream.close();
471             if (totalBytes != filesize)
472                 throw new RuntimeException(&quot;wrong file size!&quot;);
473         } catch (IOException e) {
474             throw new RuntimeException(e.getMessage());
475         } finally {
476             server.terminate();
477             server.server.close();
478         }
479     }
480 }
<a name="17" id="anc17"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="17" type="hidden" />
</body>
</html>