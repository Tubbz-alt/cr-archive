<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/ftp/FtpURL.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="FtpGetContent.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="FtpURLConnectionLeak.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/ftp/FtpURL.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;

 26 
 27 /*
 28  * @test
 29  * @bug 4398880
 30  * @summary FTP URL processing modified to conform to RFC 1738




 31  */
 32 
 33 public class FtpURL {
 34     /**
 35      * A class that simulates, on a separate, an FTP server.
 36      */
 37 
 38     private class FtpServer extends Thread {
<span class="line-modified"> 39         private ServerSocket    server;</span>
<span class="line-modified"> 40         private int port;</span>
 41         private boolean done = false;
 42         private boolean portEnabled = true;
 43         private boolean pasvEnabled = true;

 44         private String username;
 45         private String password;
 46         private String cwd;
 47         private String filename;
 48         private String type;
 49         private boolean list = false;
 50 
 51         /**
 52          * This Inner class will handle ONE client at a time.
 53          * That&#39;s where 99% of the protocol handling is done.
 54          */
 55 
 56         private class FtpServerHandler {
 57             BufferedReader in;
 58             PrintWriter out;
 59             Socket client;
 60             private final int ERROR = 0;
 61             private final int USER = 1;
 62             private final int PASS = 2;
 63             private final int CWD = 3;
 64             private final int CDUP = 4;
 65             private final int PWD = 5;
 66             private final int TYPE = 6;
 67             private final int NOOP = 7;
 68             private final int RETR = 8;
 69             private final int PASV = 9;
 70             private final int PORT = 10;
 71             private final int LIST = 11;
 72             private final int REIN = 12;
 73             private final int QUIT = 13;
 74             private final int STOR = 14;
 75             private final int NLST = 15;
 76             private final int RNFR = 16;
 77             private final int RNTO = 17;

 78             String[] cmds = { &quot;USER&quot;, &quot;PASS&quot;, &quot;CWD&quot;, &quot;CDUP&quot;, &quot;PWD&quot;, &quot;TYPE&quot;,
 79                               &quot;NOOP&quot;, &quot;RETR&quot;, &quot;PASV&quot;, &quot;PORT&quot;, &quot;LIST&quot;, &quot;REIN&quot;,
<span class="line-modified"> 80                               &quot;QUIT&quot;, &quot;STOR&quot;, &quot;NLST&quot;, &quot;RNFR&quot;, &quot;RNTO&quot; };</span>
 81             private String arg = null;
 82             private ServerSocket pasv = null;
 83             private int data_port = 0;
 84             private InetAddress data_addr = null;
 85 
 86             /**
 87              * Parses a line to match it with one of the supported FTP commands.
 88              * Returns the command number.
 89              */
 90 
 91             private int parseCmd(String cmd) {

 92                 if (cmd == null || cmd.length() &lt; 3)
 93                     return ERROR;
 94                 int blank = cmd.indexOf(&#39; &#39;);
 95                 if (blank &lt; 0)
 96                     blank = cmd.length();
 97                 if (blank &lt; 3)
 98                     return ERROR;
 99                 String s = cmd.substring(0, blank);
100                 if (cmd.length() &gt; blank+1)
101                     arg = cmd.substring(blank+1, cmd.length());
102                 else
103                     arg = null;
104                 for (int i = 0; i &lt; cmds.length; i++) {
105                     if (s.equalsIgnoreCase(cmds[i]))
106                         return i+1;
107                 }
108                 return ERROR;
109             }
110 
111             public FtpServerHandler(Socket cl) {
112                 client = cl;
113             }
114 
115             protected boolean isPasvSet() {
116                 if (pasv != null &amp;&amp; !pasvEnabled) {
117                     try {
118                         pasv.close();
119                     } catch (IOException ex) {
120                     }
121                     pasv = null;
122                 }
123                 if (pasvEnabled &amp;&amp; pasv != null)
124                     return true;
125                 return false;
126             }
127 
128             /**
129              * Open the data socket with the client. This can be the
<span class="line-modified">130              * result of a &quot;PASV&quot; or &quot;PORT&quot; command.</span>
131              */
132 
133             protected OutputStream getOutDataStream() {
134                 try {
135                     if (isPasvSet()) {
136                         Socket s = pasv.accept();
137                         return s.getOutputStream();
138                     }
139                     if (data_addr != null) {
140                         Socket s = new Socket(data_addr, data_port);
141                         data_addr = null;
142                         data_port = 0;
143                         return s.getOutputStream();
144                     }
145                 } catch (Exception e) {
146                     e.printStackTrace();
147                 }
148                 return null;
149             }
150 
</pre>
<hr />
<pre>
230                                 pasv.close();
231                             done = true;
232                             break;
233                         case TYPE:
234                             out.println(&quot;200 Type set to &quot; + arg + &quot;.&quot;);
235                             type = arg;
236                             break;
237                         case CWD:
238                             out.println(&quot;250 CWD command successful.&quot;);
239                             if (cwd == null)
240                                 cwd = str.substring(4);
241                             else
242                                 cwd = cwd + &quot;/&quot; + str.substring(4);
243                             break;
244                         case CDUP:
245                             out.println(&quot;250 CWD command successful.&quot;);
246                             break;
247                         case PWD:
248                             out.println(&quot;257 \&quot;&quot; + cwd + &quot;\&quot; is current directory&quot;);
249                             break;



























250                         case PASV:
251                             if (!pasvEnabled) {
252                                 out.println(&quot;500 PASV is disabled, use PORT instead.&quot;);
253                                 continue;
254                             }
255                             try {
<span class="line-modified">256                                 if (pasv == null)</span>
<span class="line-modified">257                                     pasv = new ServerSocket(0);</span>




258                                 int port = pasv.getLocalPort();
259                                 out.println(&quot;227 Entering Passive Mode (127,0,0,1,&quot; +
260                                             (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) +&quot;)&quot;);
261                             } catch (IOException ssex) {
262                                 out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
263                             }
264                             break;
265                         case PORT:
266                             if (!portEnabled) {
267                                 out.println(&quot;500 PORT is disabled, use PASV instead&quot;);
268                                 continue;
269                             }
270                             StringBuffer host;
271                             int i=0, j=4;
272                             while (j&gt;0) {
273                                 i = arg.indexOf(&#39;,&#39;, i+1);
274                                 if (i &lt; 0)
275                                     break;
276                                 j--;
277                             }
</pre>
<hr />
<pre>
352                                     din.close();
353                                 } else
354                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
355                             }
356                             break;
357                         }
358                     } catch (IOException ioe) {
359                         ioe.printStackTrace();
360                         try {
361                             out.close();
362                         } catch (Exception ex2) {
363                         }
364                         done = true;
365                     }
366                   }
367                 }
368             }
369         }
370 
371         public FtpServer(int port) {




372             this.port = port;
373             try {
<span class="line-modified">374               server = new ServerSocket(port);</span>





375             } catch (IOException e) {

376             }
377         }
378 
379         public FtpServer() {
<span class="line-modified">380             this(21);</span>
381         }
382 
383         public int getPort() {
<span class="line-modified">384             if (server != null)</span>
<span class="line-modified">385                 return server.getLocalPort();</span>
<span class="line-modified">386             return 0;</span>








387         }
388 
389         /**
390          * A way to tell the server that it can stop.
391          */
392         synchronized public void terminate() {
393             done = true;
394         }
395 
396         synchronized public void setPortEnabled(boolean ok) {
397             portEnabled = ok;
398         }
399 
400         synchronized public void setPasvEnabled(boolean ok) {
401             pasvEnabled = ok;
402         }
403 
404         String getUsername() {
405             return username;
406         }
</pre>
<hr />
<pre>
428 
429         /*
430          * All we got to do here is create a ServerSocket and wait for connections.
431          * When a connection happens, we just have to create a thread that will
432          * handle it.
433          */
434         public void run() {
435             try {
436                 Socket client;
437                 for (int i=0; i&lt;2; i++) {
438                     client = server.accept();
439                     (new FtpServerHandler(client)).run();
440                 }
441             } catch(Exception e) {
442             } finally {
443                 try { server.close(); } catch (IOException unused) {}
444             }
445         }
446     }
447     public static void main(String[] args) throws Exception {

448         FtpURL test = new FtpURL();
449     }
450 
451     public FtpURL() throws Exception {
<span class="line-modified">452         FtpServer server = new FtpServer(0);</span>
453         BufferedReader in = null;
454         try {
455             server.start();
<span class="line-modified">456             int port = server.getPort();</span>


457 
458             // Now let&#39;s check the URL handler
459 
<span class="line-modified">460             URL url = new URL(&quot;ftp://user:password@localhost:&quot; + port + &quot;/%2Fetc/motd;type=a&quot;);</span>
<span class="line-modified">461             URLConnection con = url.openConnection();</span>
462             in = new BufferedReader(new InputStreamReader(con.getInputStream()));
463             String s;
464             do {
465                 s = in.readLine();
466             } while (s != null);
467             if (!(&quot;user&quot;.equals(server.getUsername())))
468                 throw new RuntimeException(&quot;Inccorect username received&quot;);
469             if (!(&quot;password&quot;.equals(server.getPassword())))
470                 throw new RuntimeException(&quot;Inccorect password received&quot;);
471             if (!(&quot;/etc&quot;.equals(server.pwd())))
472                 throw new RuntimeException(&quot;Inccorect directory received&quot;);
473             if (!(&quot;motd&quot;.equals(server.getFilename())))
474                 throw new RuntimeException(&quot;Inccorect username received&quot;);
475             if (!(&quot;A&quot;.equals(server.getType())))
476                 throw new RuntimeException(&quot;Incorrect type received&quot;);
477 
478             in.close();
479             // We&#39;re done!
480 
481             // Second URL test
<span class="line-removed">482             port = server.getPort();</span>
483 
484             // Now let&#39;s check the URL handler
485 
<span class="line-modified">486             url = new URL(&quot;ftp://user2@localhost:&quot; + port + &quot;/%2Fusr/bin;type=d&quot;);</span>
<span class="line-modified">487             con = url.openConnection();</span>
488             in = new BufferedReader(new InputStreamReader(con.getInputStream()));
489             do {
490                 s = in.readLine();
491             } while (s != null);
492             if (!server.getList())
493                 throw new RuntimeException(&quot;;type=d didn&#39;t generate a NLST&quot;);
494             if (server.getPassword() != null)
495                 throw new RuntimeException(&quot;password should be null!&quot;);
496             if (! &quot;bin&quot;.equals(server.getFilename()))
497                 throw new RuntimeException(&quot;Incorrect filename received&quot;);
498             if (! &quot;/usr&quot;.equals(server.pwd()))
499                 throw new RuntimeException(&quot;Incorrect pwd received&quot;);
500             // We&#39;re done!
501 
502         } catch (Exception e) {
<span class="line-modified">503             throw new RuntimeException(&quot;FTP support error: &quot; + e.getMessage());</span>
504         } finally {
<span class="line-modified">505             try { in.close(); } catch (IOException unused) {}</span>
506             server.terminate();
507             server.server.close();
508         }
509     }
510 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.*;
 25 import java.net.*;
<span class="line-added"> 26 import jdk.test.lib.net.IPSupport;</span>
 27 
 28 /*
 29  * @test
 30  * @bug 4398880
 31  * @summary FTP URL processing modified to conform to RFC 1738
<span class="line-added"> 32  * @library /test/lib</span>
<span class="line-added"> 33  * @run main/othervm FtpURL</span>
<span class="line-added"> 34  * @run main/othervm -Djava.net.preferIPv4Stack=true FtpURL</span>
<span class="line-added"> 35  * @run main/othervm -Djava.net.preferIPv6Addresses=true FtpURL</span>
 36  */
 37 
 38 public class FtpURL {
 39     /**
 40      * A class that simulates, on a separate, an FTP server.
 41      */
 42 
 43     private class FtpServer extends Thread {
<span class="line-modified"> 44         private final ServerSocket server;</span>
<span class="line-modified"> 45         private final int port;</span>
 46         private boolean done = false;
 47         private boolean portEnabled = true;
 48         private boolean pasvEnabled = true;
<span class="line-added"> 49         private boolean extendedEnabled = true;</span>
 50         private String username;
 51         private String password;
 52         private String cwd;
 53         private String filename;
 54         private String type;
 55         private boolean list = false;
 56 
 57         /**
 58          * This Inner class will handle ONE client at a time.
 59          * That&#39;s where 99% of the protocol handling is done.
 60          */
 61 
 62         private class FtpServerHandler {
 63             BufferedReader in;
 64             PrintWriter out;
 65             Socket client;
 66             private final int ERROR = 0;
 67             private final int USER = 1;
 68             private final int PASS = 2;
 69             private final int CWD = 3;
 70             private final int CDUP = 4;
 71             private final int PWD = 5;
 72             private final int TYPE = 6;
 73             private final int NOOP = 7;
 74             private final int RETR = 8;
 75             private final int PASV = 9;
 76             private final int PORT = 10;
 77             private final int LIST = 11;
 78             private final int REIN = 12;
 79             private final int QUIT = 13;
 80             private final int STOR = 14;
 81             private final int NLST = 15;
 82             private final int RNFR = 16;
 83             private final int RNTO = 17;
<span class="line-added"> 84             private final int EPSV = 18;</span>
 85             String[] cmds = { &quot;USER&quot;, &quot;PASS&quot;, &quot;CWD&quot;, &quot;CDUP&quot;, &quot;PWD&quot;, &quot;TYPE&quot;,
 86                               &quot;NOOP&quot;, &quot;RETR&quot;, &quot;PASV&quot;, &quot;PORT&quot;, &quot;LIST&quot;, &quot;REIN&quot;,
<span class="line-modified"> 87                               &quot;QUIT&quot;, &quot;STOR&quot;, &quot;NLST&quot;, &quot;RNFR&quot;, &quot;RNTO&quot;, &quot;EPSV&quot; };</span>
 88             private String arg = null;
 89             private ServerSocket pasv = null;
 90             private int data_port = 0;
 91             private InetAddress data_addr = null;
 92 
 93             /**
 94              * Parses a line to match it with one of the supported FTP commands.
 95              * Returns the command number.
 96              */
 97 
 98             private int parseCmd(String cmd) {
<span class="line-added"> 99                 System.out.println(&quot;Received command: &quot; + cmd);</span>
100                 if (cmd == null || cmd.length() &lt; 3)
101                     return ERROR;
102                 int blank = cmd.indexOf(&#39; &#39;);
103                 if (blank &lt; 0)
104                     blank = cmd.length();
105                 if (blank &lt; 3)
106                     return ERROR;
107                 String s = cmd.substring(0, blank);
108                 if (cmd.length() &gt; blank+1)
109                     arg = cmd.substring(blank+1, cmd.length());
110                 else
111                     arg = null;
112                 for (int i = 0; i &lt; cmds.length; i++) {
113                     if (s.equalsIgnoreCase(cmds[i]))
114                         return i+1;
115                 }
116                 return ERROR;
117             }
118 
119             public FtpServerHandler(Socket cl) {
120                 client = cl;
121             }
122 
123             protected boolean isPasvSet() {
124                 if (pasv != null &amp;&amp; !pasvEnabled) {
125                     try {
126                         pasv.close();
127                     } catch (IOException ex) {
128                     }
129                     pasv = null;
130                 }
131                 if (pasvEnabled &amp;&amp; pasv != null)
132                     return true;
133                 return false;
134             }
135 
136             /**
137              * Open the data socket with the client. This can be the
<span class="line-modified">138              * result of a &quot;EPSV&quot;, &quot;PASV&quot; or &quot;PORT&quot; command.</span>
139              */
140 
141             protected OutputStream getOutDataStream() {
142                 try {
143                     if (isPasvSet()) {
144                         Socket s = pasv.accept();
145                         return s.getOutputStream();
146                     }
147                     if (data_addr != null) {
148                         Socket s = new Socket(data_addr, data_port);
149                         data_addr = null;
150                         data_port = 0;
151                         return s.getOutputStream();
152                     }
153                 } catch (Exception e) {
154                     e.printStackTrace();
155                 }
156                 return null;
157             }
158 
</pre>
<hr />
<pre>
238                                 pasv.close();
239                             done = true;
240                             break;
241                         case TYPE:
242                             out.println(&quot;200 Type set to &quot; + arg + &quot;.&quot;);
243                             type = arg;
244                             break;
245                         case CWD:
246                             out.println(&quot;250 CWD command successful.&quot;);
247                             if (cwd == null)
248                                 cwd = str.substring(4);
249                             else
250                                 cwd = cwd + &quot;/&quot; + str.substring(4);
251                             break;
252                         case CDUP:
253                             out.println(&quot;250 CWD command successful.&quot;);
254                             break;
255                         case PWD:
256                             out.println(&quot;257 \&quot;&quot; + cwd + &quot;\&quot; is current directory&quot;);
257                             break;
<span class="line-added">258                         case EPSV:</span>
<span class="line-added">259                             if (!extendedEnabled || !pasvEnabled) {</span>
<span class="line-added">260                                 out.println(&quot;500 EPSV is disabled, &quot; +</span>
<span class="line-added">261                                                 &quot;use PORT instead.&quot;);</span>
<span class="line-added">262                                 continue;</span>
<span class="line-added">263                             }</span>
<span class="line-added">264                             if (!(server.getInetAddress() instanceof Inet6Address)) {</span>
<span class="line-added">265                                 // pretend EPSV is not implemented</span>
<span class="line-added">266                                 out.println(&quot;500 &#39;&quot; + str + &quot;&#39;: command not understood.&quot;);</span>
<span class="line-added">267                                 break;</span>
<span class="line-added">268                             }</span>
<span class="line-added">269                             if (&quot;all&quot;.equalsIgnoreCase(arg)) {</span>
<span class="line-added">270                                 out.println(&quot;200 EPSV ALL command successful.&quot;);</span>
<span class="line-added">271                                 continue;</span>
<span class="line-added">272                             }</span>
<span class="line-added">273                             try {</span>
<span class="line-added">274                                 if (pasv == null)</span>
<span class="line-added">275                                     pasv = new ServerSocket(0, 0, server.getInetAddress());</span>
<span class="line-added">276                                 int port = pasv.getLocalPort();</span>
<span class="line-added">277                                 out.println(&quot;229 Entering Extended&quot; +</span>
<span class="line-added">278                                         &quot; Passive Mode (|||&quot; + port + &quot;|)&quot;);</span>
<span class="line-added">279                             } catch (IOException ssex) {</span>
<span class="line-added">280                                 out.println(&quot;425 Can&#39;t build data connection:&quot; +</span>
<span class="line-added">281                                                 &quot; Connection refused.&quot;);</span>
<span class="line-added">282                             }</span>
<span class="line-added">283                             break;</span>
<span class="line-added">284 </span>
285                         case PASV:
286                             if (!pasvEnabled) {
287                                 out.println(&quot;500 PASV is disabled, use PORT instead.&quot;);
288                                 continue;
289                             }
290                             try {
<span class="line-modified">291                                 if (pasv == null) {</span>
<span class="line-modified">292                                     // Not sure how to support PASV mode over</span>
<span class="line-added">293                                     // IPv6</span>
<span class="line-added">294                                     pasv = new ServerSocket();</span>
<span class="line-added">295                                     pasv.bind(new InetSocketAddress(&quot;127.0.0.1&quot;, 0));</span>
<span class="line-added">296                                 }</span>
297                                 int port = pasv.getLocalPort();
298                                 out.println(&quot;227 Entering Passive Mode (127,0,0,1,&quot; +
299                                             (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) +&quot;)&quot;);
300                             } catch (IOException ssex) {
301                                 out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
302                             }
303                             break;
304                         case PORT:
305                             if (!portEnabled) {
306                                 out.println(&quot;500 PORT is disabled, use PASV instead&quot;);
307                                 continue;
308                             }
309                             StringBuffer host;
310                             int i=0, j=4;
311                             while (j&gt;0) {
312                                 i = arg.indexOf(&#39;,&#39;, i+1);
313                                 if (i &lt; 0)
314                                     break;
315                                 j--;
316                             }
</pre>
<hr />
<pre>
391                                     din.close();
392                                 } else
393                                     out.println(&quot;425 Can&#39;t build data connection: Connection refused.&quot;);
394                             }
395                             break;
396                         }
397                     } catch (IOException ioe) {
398                         ioe.printStackTrace();
399                         try {
400                             out.close();
401                         } catch (Exception ex2) {
402                         }
403                         done = true;
404                     }
405                   }
406                 }
407             }
408         }
409 
410         public FtpServer(int port) {
<span class="line-added">411             this(InetAddress.getLoopbackAddress(), port);</span>
<span class="line-added">412         }</span>
<span class="line-added">413 </span>
<span class="line-added">414         public FtpServer(InetAddress address, int port) {</span>
415             this.port = port;
416             try {
<span class="line-modified">417                 if (address == null) {</span>
<span class="line-added">418                     server = new ServerSocket(port);</span>
<span class="line-added">419                 } else {</span>
<span class="line-added">420                     server = new ServerSocket();</span>
<span class="line-added">421                     server.bind(new InetSocketAddress(address, port));</span>
<span class="line-added">422                 }</span>
423             } catch (IOException e) {
<span class="line-added">424                 throw new UncheckedIOException(e);</span>
425             }
426         }
427 
428         public FtpServer() {
<span class="line-modified">429             this(null, 21);</span>
430         }
431 
432         public int getPort() {
<span class="line-modified">433              return server.getLocalPort();</span>
<span class="line-modified">434         }</span>
<span class="line-modified">435 </span>
<span class="line-added">436         public String getAuthority() {</span>
<span class="line-added">437             InetAddress address = server.getInetAddress();</span>
<span class="line-added">438             String hostaddr = address.isAnyLocalAddress()</span>
<span class="line-added">439                 ? &quot;localhost&quot; : address.getHostAddress();</span>
<span class="line-added">440             if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="line-added">441                 hostaddr = &quot;[&quot; + hostaddr +&quot;]&quot;;</span>
<span class="line-added">442             }</span>
<span class="line-added">443             return hostaddr + &quot;:&quot; + getPort();</span>
444         }
445 
446         /**
447          * A way to tell the server that it can stop.
448          */
449         synchronized public void terminate() {
450             done = true;
451         }
452 
453         synchronized public void setPortEnabled(boolean ok) {
454             portEnabled = ok;
455         }
456 
457         synchronized public void setPasvEnabled(boolean ok) {
458             pasvEnabled = ok;
459         }
460 
461         String getUsername() {
462             return username;
463         }
</pre>
<hr />
<pre>
485 
486         /*
487          * All we got to do here is create a ServerSocket and wait for connections.
488          * When a connection happens, we just have to create a thread that will
489          * handle it.
490          */
491         public void run() {
492             try {
493                 Socket client;
494                 for (int i=0; i&lt;2; i++) {
495                     client = server.accept();
496                     (new FtpServerHandler(client)).run();
497                 }
498             } catch(Exception e) {
499             } finally {
500                 try { server.close(); } catch (IOException unused) {}
501             }
502         }
503     }
504     public static void main(String[] args) throws Exception {
<span class="line-added">505         IPSupport.throwSkippedExceptionIfNonOperational();</span>
506         FtpURL test = new FtpURL();
507     }
508 
509     public FtpURL() throws Exception {
<span class="line-modified">510         FtpServer server = new FtpServer(InetAddress.getLoopbackAddress(), 0);</span>
511         BufferedReader in = null;
512         try {
513             server.start();
<span class="line-modified">514             String authority = server.getAuthority();</span>
<span class="line-added">515             System.out.println(&quot;FTP server waiting for connections at: &quot; + authority);</span>
<span class="line-added">516             assert authority != null;</span>
517 
518             // Now let&#39;s check the URL handler
519 
<span class="line-modified">520             URL url = new URL(&quot;ftp://user:password@&quot; + authority + &quot;/%2Fetc/motd;type=a&quot;);</span>
<span class="line-modified">521             URLConnection con = url.openConnection(Proxy.NO_PROXY);</span>
522             in = new BufferedReader(new InputStreamReader(con.getInputStream()));
523             String s;
524             do {
525                 s = in.readLine();
526             } while (s != null);
527             if (!(&quot;user&quot;.equals(server.getUsername())))
528                 throw new RuntimeException(&quot;Inccorect username received&quot;);
529             if (!(&quot;password&quot;.equals(server.getPassword())))
530                 throw new RuntimeException(&quot;Inccorect password received&quot;);
531             if (!(&quot;/etc&quot;.equals(server.pwd())))
532                 throw new RuntimeException(&quot;Inccorect directory received&quot;);
533             if (!(&quot;motd&quot;.equals(server.getFilename())))
534                 throw new RuntimeException(&quot;Inccorect username received&quot;);
535             if (!(&quot;A&quot;.equals(server.getType())))
536                 throw new RuntimeException(&quot;Incorrect type received&quot;);
537 
538             in.close();
539             // We&#39;re done!
540 
541             // Second URL test

542 
543             // Now let&#39;s check the URL handler
544 
<span class="line-modified">545             url = new URL(&quot;ftp://user2@&quot; + authority + &quot;/%2Fusr/bin;type=d&quot;);</span>
<span class="line-modified">546             con = url.openConnection(Proxy.NO_PROXY);</span>
547             in = new BufferedReader(new InputStreamReader(con.getInputStream()));
548             do {
549                 s = in.readLine();
550             } while (s != null);
551             if (!server.getList())
552                 throw new RuntimeException(&quot;;type=d didn&#39;t generate a NLST&quot;);
553             if (server.getPassword() != null)
554                 throw new RuntimeException(&quot;password should be null!&quot;);
555             if (! &quot;bin&quot;.equals(server.getFilename()))
556                 throw new RuntimeException(&quot;Incorrect filename received&quot;);
557             if (! &quot;/usr&quot;.equals(server.pwd()))
558                 throw new RuntimeException(&quot;Incorrect pwd received&quot;);
559             // We&#39;re done!
560 
561         } catch (Exception e) {
<span class="line-modified">562             throw new RuntimeException(&quot;FTP support error: &quot; + e.getMessage(), e);</span>
563         } finally {
<span class="line-modified">564             try { in.close(); } catch (Exception unused) {}</span>
565             server.terminate();
566             server.server.close();
567         }
568     }
569 }
</pre>
</td>
</tr>
</table>
<center><a href="FtpGetContent.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="FtpURLConnectionLeak.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>