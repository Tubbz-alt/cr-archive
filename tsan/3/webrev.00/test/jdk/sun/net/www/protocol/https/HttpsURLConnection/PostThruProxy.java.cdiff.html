<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/protocol/https/HttpsURLConnection/PostThruProxy.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ImpactOnSNI.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PostThruProxyWithAuth.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/HttpsURLConnection/PostThruProxy.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,28 ***</span>
  import java.net.*;
  import java.security.KeyStore;
  import javax.net.*;
  import javax.net.ssl.*;
  
<span class="line-modified">! import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="line-removed">- import jdk.test.lib.process.ProcessTools;</span>
  
  /*
   * @test
   * @bug 4423074
   * @modules java.base/sun.net.www
   * @summary This test case is written to test the https POST through a proxy.
   *          There is no proxy authentication done. It includes a simple server
   *          that serves http POST method requests in secure channel, and a client
   *          that makes https POST request through a proxy.
   * @library /test/lib
<span class="line-removed">-  * @build jdk.test.lib.Utils</span>
<span class="line-removed">-  *        jdk.test.lib.Asserts</span>
<span class="line-removed">-  *        jdk.test.lib.JDKToolFinder</span>
<span class="line-removed">-  *        jdk.test.lib.JDKToolLauncher</span>
<span class="line-removed">-  *        jdk.test.lib.Platform</span>
<span class="line-removed">-  *        jdk.test.lib.process.*</span>
   * @compile OriginServer.java ProxyTunnelServer.java
   * @run main/othervm PostThruProxy
   */
  public class PostThruProxy {
  
<span class="line-new-header">--- 25,21 ---</span>
  import java.net.*;
  import java.security.KeyStore;
  import javax.net.*;
  import javax.net.ssl.*;
  
<span class="line-modified">! import jdk.test.lib.net.URIBuilder;</span>
  
  /*
   * @test
   * @bug 4423074
   * @modules java.base/sun.net.www
   * @summary This test case is written to test the https POST through a proxy.
   *          There is no proxy authentication done. It includes a simple server
   *          that serves http POST method requests in secure channel, and a client
   *          that makes https POST request through a proxy.
   * @library /test/lib
   * @compile OriginServer.java ProxyTunnelServer.java
   * @run main/othervm PostThruProxy
   */
  public class PostThruProxy {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,10 ***</span>
<span class="line-new-header">--- 53,13 ---</span>
      static String keyStoreFile = &quot;keystore&quot;;
      static String trustStoreFile = &quot;truststore&quot;;
      static String passwd = &quot;passphrase&quot;;
  
      private static int serverPort = 0;
<span class="line-added">+     private static ProxyTunnelServer pserver;</span>
<span class="line-added">+     private static TestServer server;</span>
<span class="line-added">+     static final String RESPONSE_MSG = &quot;Https POST thru proxy is successful&quot;;</span>
  
      /*
       * The TestServer implements a OriginServer that
       * processes HTTP requests and responses.
       */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 77,38 ***</span>
           * the data sent in the response.
           *
           * @return bytes for the data in the response
           */
          public byte[] getBytes() {
<span class="line-modified">!             return &quot;Https POST thru proxy is successful&quot;.</span>
<span class="line-removed">-                         getBytes();</span>
          }
      }
  
      /*
       * Main method to create the server and client
       */
      public static void main(String args[]) throws Exception {
          String keyFilename = TEST_SRC + &quot;/&quot; + pathToStores + &quot;/&quot; + keyStoreFile;
          String trustFilename = TEST_SRC + &quot;/&quot; + pathToStores + &quot;/&quot;
                  + trustStoreFile;
  
          System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyFilename);
          System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, passwd);
          System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustFilename);
          System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, passwd);
  
          boolean useSSL = true;
          /*
           * setup the server
           */
          try {
              ServerSocketFactory ssf = getServerSocketFactory(useSSL);
<span class="line-modified">!             ServerSocket ss = ssf.createServerSocket(serverPort);</span>
              ss.setSoTimeout(TIMEOUT);  // 30 seconds
              serverPort = ss.getLocalPort();
<span class="line-modified">!             new TestServer(ss);</span>
          } catch (Exception e) {
              System.out.println(&quot;Server side failed:&quot; +
                                  e.getMessage());
              throw e;
          }
<span class="line-new-header">--- 73,40 ---</span>
           * the data sent in the response.
           *
           * @return bytes for the data in the response
           */
          public byte[] getBytes() {
<span class="line-modified">!             return RESPONSE_MSG.getBytes();</span>
          }
      }
  
      /*
       * Main method to create the server and client
       */
      public static void main(String args[]) throws Exception {
<span class="line-added">+ </span>
          String keyFilename = TEST_SRC + &quot;/&quot; + pathToStores + &quot;/&quot; + keyStoreFile;
          String trustFilename = TEST_SRC + &quot;/&quot; + pathToStores + &quot;/&quot;
                  + trustStoreFile;
  
          System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyFilename);
          System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, passwd);
          System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustFilename);
          System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, passwd);
  
<span class="line-added">+         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
          boolean useSSL = true;
          /*
           * setup the server
           */
          try {
              ServerSocketFactory ssf = getServerSocketFactory(useSSL);
<span class="line-modified">!             ServerSocket ss = ssf.createServerSocket(serverPort, 0, loopback);</span>
              ss.setSoTimeout(TIMEOUT);  // 30 seconds
              serverPort = ss.getLocalPort();
<span class="line-modified">!             server = new TestServer(ss);</span>
<span class="line-added">+             System.out.println(&quot;Server started at: &quot; + ss);</span>
          } catch (Exception e) {
              System.out.println(&quot;Server side failed:&quot; +
                                  e.getMessage());
              throw e;
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 118,10 ***</span>
<span class="line-new-header">--- 116,16 ---</span>
          } catch (Exception e) {
              System.out.println(&quot;Client side failed: &quot; +
                                  e.getMessage());
              throw e;
          }
<span class="line-added">+         long connectCount = pserver.getConnectCount();</span>
<span class="line-added">+         if (connectCount == 0) {</span>
<span class="line-added">+             throw new AssertionError(&quot;Proxy was not used!&quot;);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             System.out.println(&quot;Proxy CONNECT count: &quot; + connectCount);</span>
<span class="line-added">+         }</span>
      }
  
      private static ServerSocketFactory getServerSocketFactory
                     (boolean useSSL) throws Exception {
          if (useSSL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 160,13 ***</span>
               * we want to avoid URLspoofCheck failures in cases where the cert
               * DN name does not match the hostname in the URL.
               */
              HttpsURLConnection.setDefaultHostnameVerifier(
                                            new NameVerifier());
<span class="line-modified">!             URL url = new URL(&quot;https://&quot; + getHostname() +&quot;:&quot; + serverPort);</span>
  
              Proxy p = new Proxy(Proxy.Type.HTTP, pAddr);
              HttpsURLConnection https = (HttpsURLConnection)url.openConnection(p);
              https.setConnectTimeout(TIMEOUT);
              https.setReadTimeout(TIMEOUT);
              https.setDoOutput(true);
              https.setRequestMethod(&quot;POST&quot;);
<span class="line-new-header">--- 164,19 ---</span>
               * we want to avoid URLspoofCheck failures in cases where the cert
               * DN name does not match the hostname in the URL.
               */
              HttpsURLConnection.setDefaultHostnameVerifier(
                                            new NameVerifier());
<span class="line-modified">!             URL url = URIBuilder.newBuilder()</span>
<span class="line-added">+                       .scheme(&quot;https&quot;)</span>
<span class="line-added">+                       .loopback()</span>
<span class="line-added">+                       .port(serverPort)</span>
<span class="line-added">+                       .toURL();</span>
  
              Proxy p = new Proxy(Proxy.Type.HTTP, pAddr);
<span class="line-added">+             System.out.println(&quot;Client connecting to: &quot; + url);</span>
<span class="line-added">+             System.out.println(&quot;Through proxy: &quot; + pAddr);</span>
              HttpsURLConnection https = (HttpsURLConnection)url.openConnection(p);
              https.setConnectTimeout(TIMEOUT);
              https.setReadTimeout(TIMEOUT);
              https.setDoOutput(true);
              https.setRequestMethod(&quot;POST&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 183,13 ***</span>
                 // clear the pipe
                 BufferedReader in = new BufferedReader(
                                      new InputStreamReader(
                                      https.getInputStream()));
                 String inputLine;
<span class="line-modified">!                while ((inputLine = in.readLine()) != null)</span>
                      System.out.println(&quot;Client received: &quot; + inputLine);
                 in.close();
              } catch (SSLException e) {
                  if (ps != null)
                      ps.close();
                  throw e;
              } catch (SocketTimeoutException e) {
<span class="line-new-header">--- 193,19 ---</span>
                 // clear the pipe
                 BufferedReader in = new BufferedReader(
                                      new InputStreamReader(
                                      https.getInputStream()));
                 String inputLine;
<span class="line-modified">!                boolean msgFound = false;</span>
<span class="line-added">+                while ((inputLine = in.readLine()) != null) {</span>
                      System.out.println(&quot;Client received: &quot; + inputLine);
<span class="line-added">+                     if (inputLine.contains(RESPONSE_MSG)) msgFound = true;</span>
<span class="line-added">+                }</span>
                 in.close();
<span class="line-added">+                if (!msgFound) {</span>
<span class="line-added">+                    throw new RuntimeException(&quot;POST message not found.&quot;);</span>
<span class="line-added">+                }</span>
              } catch (SSLException e) {
                  if (ps != null)
                      ps.close();
                  throw e;
              } catch (SocketTimeoutException e) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,22 ***</span>
              return true;
          }
      }
  
      static SocketAddress setupProxy() throws IOException {
<span class="line-modified">!         ProxyTunnelServer pserver = new ProxyTunnelServer();</span>
  
          // disable proxy authentication
          pserver.needUserAuth(false);
          pserver.start();
<span class="line-modified">!         return new InetSocketAddress(&quot;localhost&quot;, pserver.getPort());</span>
      }
  
<span class="line-removed">-     private static String getHostname() {</span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             OutputAnalyzer oa = ProcessTools.executeCommand(&quot;hostname&quot;);</span>
<span class="line-removed">-             return oa.getOutput().trim();</span>
<span class="line-removed">-         } catch (Throwable e) {</span>
<span class="line-removed">-             throw new RuntimeException(&quot;Get hostname failed.&quot;, e);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  }
<span class="line-new-header">--- 222,15 ---</span>
              return true;
          }
      }
  
      static SocketAddress setupProxy() throws IOException {
<span class="line-modified">!         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">+         pserver = new ProxyTunnelServer(loopback);</span>
  
          // disable proxy authentication
          pserver.needUserAuth(false);
          pserver.start();
<span class="line-modified">!         return new InetSocketAddress(loopback, pserver.getPort());</span>
      }
  
  }
</pre>
<center><a href="ImpactOnSNI.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PostThruProxyWithAuth.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>