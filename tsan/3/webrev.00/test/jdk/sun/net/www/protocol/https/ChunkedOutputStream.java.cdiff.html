<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/protocol/https/ChunkedOutputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../http/ZoneId.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HttpCallback.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/ChunkedOutputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,38 ***</span>
   * @test
   * @bug 5026745
   * @modules java.base/sun.net.www
   * @build TestHttpsServer HttpCallback
   * @run main/othervm ChunkedOutputStream
   *
   *     SunJSSE does not support dynamic system properties, no way to re-use
   *     system properties in samevm/agentvm mode.
   * @summary Cannot flush output stream when writing to an HttpUrlConnection
   */
  
  import java.io.*;
  import java.net.*;
  import javax.net.ssl.*;
  
  public class ChunkedOutputStream implements HttpCallback {
      /*
       * Where do we find the keystores for ssl?
       */
      static String pathToStores = &quot;../../../../../javax/net/ssl/etc&quot;;
      static String keyStoreFile = &quot;keystore&quot;;
      static String trustStoreFile = &quot;truststore&quot;;
      static String passwd = &quot;passphrase&quot;;
      static int count = 0;
  
      static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
                                  &quot;1234567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;+
                                  &quot;1434567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;;
  
      static final String str2 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
                                  &quot;1234567890&quot;;
  
<span class="line-modified">!     public void request (HttpTransaction req) {</span>
          try {
              // this is needed (count++ doesn&#39;t work), &#39;cause we
              // are doing concurrent tests
              String path = req.getRequestURI().getPath();
              if (path.equals(&quot;/d0&quot;)) {
<span class="line-new-header">--- 25,41 ---</span>
   * @test
   * @bug 5026745
   * @modules java.base/sun.net.www
   * @build TestHttpsServer HttpCallback
   * @run main/othervm ChunkedOutputStream
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true ChunkedOutputStream</span>
   *
   *     SunJSSE does not support dynamic system properties, no way to re-use
   *     system properties in samevm/agentvm mode.
   * @summary Cannot flush output stream when writing to an HttpUrlConnection
   */
  
  import java.io.*;
  import java.net.*;
  import javax.net.ssl.*;
<span class="line-added">+ import java.util.concurrent.atomic.AtomicInteger;</span>
  
  public class ChunkedOutputStream implements HttpCallback {
      /*
       * Where do we find the keystores for ssl?
       */
      static String pathToStores = &quot;../../../../../javax/net/ssl/etc&quot;;
      static String keyStoreFile = &quot;keystore&quot;;
      static String trustStoreFile = &quot;truststore&quot;;
      static String passwd = &quot;passphrase&quot;;
      static int count = 0;
<span class="line-added">+     static final AtomicInteger rogueCount = new AtomicInteger();</span>
  
      static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
                                  &quot;1234567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;+
                                  &quot;1434567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;;
  
      static final String str2 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
                                  &quot;1234567890&quot;;
  
<span class="line-modified">!     public void request(HttpTransaction req) {</span>
          try {
              // this is needed (count++ doesn&#39;t work), &#39;cause we
              // are doing concurrent tests
              String path = req.getRequestURI().getPath();
              if (path.equals(&quot;/d0&quot;)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,217 ***</span>
              switch (count) {
              case 0: /* test1 -- keeps conn alive */
              case 1: /* test2 -- closes conn */
                  String reqbody = req.getRequestEntityBody();
                  if (!reqbody.equals(str1)) {
<span class="line-modified">!                     req.sendResponse (500, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 String chunk = req.getRequestHeader (&quot;Transfer-encoding&quot;);</span>
<span class="line-modified">!                 if (!&quot;chunked&quot;.equals (chunk)) {</span>
<span class="line-modified">!                     req.sendResponse (501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 req.setResponseEntityBody (reqbody);</span>
                  if (count == 1) {
<span class="line-modified">!                     req.setResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
                  }
<span class="line-modified">!                 req.sendResponse (200, &quot;OK&quot;);</span>
                  if (count == 1) {
                      req.orderlyClose();
                  }
                  break;
              case 2: /* test 3 */
                  reqbody = req.getRequestEntityBody();
                  if (!reqbody.equals(str2)) {
<span class="line-modified">!                     req.sendResponse (500, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
                  int clen = Integer.parseInt (
<span class="line-modified">!                         req.getRequestHeader (&quot;Content-length&quot;));</span>
                  if (clen != str2.length()) {
<span class="line-modified">!                     req.sendResponse (501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
                  req.setResponseEntityBody (reqbody);
<span class="line-modified">!                 req.setResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse (200, &quot;OK&quot;);</span>
                  req.orderlyClose();
                  break;
              case 3: /* test 6 */
<span class="line-modified">!                 req.setResponseHeader (&quot;Location&quot;, &quot;https://foo.bar/&quot;);</span>
<span class="line-modified">!                 req.setResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse (307, &quot;Temporary Redirect&quot;);</span>
                  req.orderlyClose();
                  break;
              case 4: /* test 7 */
              case 5: /* test 8 */
                  reqbody = req.getRequestEntityBody();
<span class="line-modified">!                 if (reqbody != null &amp;&amp; !&quot;&quot;.equals (reqbody)) {</span>
<span class="line-modified">!                     req.sendResponse (501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 req.setResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse (200, &quot;OK&quot;);</span>
                  req.orderlyClose();
                  break;
              }
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
  
<span class="line-modified">!     static void readAndCompare (InputStream is, String cmp) throws IOException {</span>
          int c;
<span class="line-modified">!         byte buf[] = new byte [1024];</span>
          int off = 0;
          int len = 1024;
          while ((c=is.read(buf, off, len)) != -1) {
              off += c;
              len -= c;
          }
<span class="line-modified">!         String s1 = new String (buf, 0, off, &quot;ISO8859_1&quot;);</span>
          if (!cmp.equals(s1)) {
<span class="line-modified">!             throw new IOException (&quot;strings not same&quot;);</span>
          }
      }
  
      /* basic chunked test (runs twice) */
  
<span class="line-modified">!     static void test1 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode (20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
<span class="line-modified">!         os.write (str1.getBytes());</span>
          os.close();
          InputStream is = urlc.getInputStream();
<span class="line-modified">!         readAndCompare (is, str1);</span>
          is.close();
      }
  
      /* basic fixed length test */
  
<span class="line-modified">!     static void test3 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode (str2.length());</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
          os.write (str2.getBytes());
          os.close();
          InputStream is = urlc.getInputStream();
<span class="line-modified">!         readAndCompare (is, str2);</span>
          is.close();
      }
  
      /* write too few bytes */
  
<span class="line-modified">!     static void test4 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode (str2.length()+1);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
<span class="line-modified">!         os.write (str2.getBytes());</span>
          try {
              os.close();
<span class="line-modified">!             throw new Exception (&quot;should have thrown IOException&quot;);</span>
          } catch (IOException e) {}
      }
  
      /* write too many bytes */
  
<span class="line-modified">!     static void test5 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode (str2.length()-1);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
          try {
<span class="line-modified">!             os.write (str2.getBytes());</span>
<span class="line-modified">!             throw new Exception (&quot;should have thrown IOException&quot;);</span>
          } catch (IOException e) {}
      }
  
      /* check for HttpRetryException on redirection */
  
<span class="line-modified">!     static void test6 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode (20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
<span class="line-modified">!         os.write (str1.getBytes());</span>
          os.close();
          try {
              InputStream is = urlc.getInputStream();
<span class="line-modified">!             throw new Exception (&quot;should have gotten HttpRetryException&quot;);</span>
          } catch (HttpRetryException e) {
              if (e.responseCode() != 307) {
<span class="line-modified">!                 throw new Exception (&quot;Wrong response code &quot; + e.responseCode());</span>
              }
<span class="line-modified">!             if (!e.getLocation().equals (&quot;https://foo.bar/&quot;)) {</span>
<span class="line-modified">!                 throw new Exception (&quot;Wrong location &quot; + e.getLocation());</span>
              }
          }
      }
  
      /* next two tests send zero length posts */
  
<span class="line-modified">!     static void test7 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode (20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
          os.close();
          int ret = urlc.getResponseCode();
          if (ret != 200) {
<span class="line-modified">!             throw new Exception (&quot;Expected 200: got &quot; + ret);</span>
          }
      }
  
<span class="line-modified">!     static void test8 (String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL (u);</span>
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode (0);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod (&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream ();</span>
          os.close();
          int ret = urlc.getResponseCode();
          if (ret != 200) {
<span class="line-modified">!             throw new Exception (&quot;Expected 200: got &quot; + ret);</span>
          }
      }
  
      static TestHttpsServer server;
  
<span class="line-modified">!     public static void main (String[] args) throws Exception {</span>
          // setup properties to do ssl
          String keyFilename =
              System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
                  &quot;/&quot; + keyStoreFile;
          String trustFilename =
              System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
                  &quot;/&quot; + trustStoreFile;
  
          HostnameVerifier reservedHV =
              HttpsURLConnection.getDefaultHostnameVerifier();
          try {
              System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyFilename);
              System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, passwd);
<span class="line-new-header">--- 81,250 ---</span>
              switch (count) {
              case 0: /* test1 -- keeps conn alive */
              case 1: /* test2 -- closes conn */
                  String reqbody = req.getRequestEntityBody();
                  if (!reqbody.equals(str1)) {
<span class="line-modified">!                     req.sendResponse(500, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 String chunk = req.getRequestHeader(&quot;Transfer-encoding&quot;);</span>
<span class="line-modified">!                 if (!&quot;chunked&quot;.equals(chunk)) {</span>
<span class="line-modified">!                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 req.setResponseEntityBody(reqbody);</span>
                  if (count == 1) {
<span class="line-modified">!                     req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
                  }
<span class="line-modified">!                 req.sendResponse(200, &quot;OK&quot;);</span>
                  if (count == 1) {
                      req.orderlyClose();
                  }
                  break;
              case 2: /* test 3 */
                  reqbody = req.getRequestEntityBody();
                  if (!reqbody.equals(str2)) {
<span class="line-modified">!                     req.sendResponse(500, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
                  int clen = Integer.parseInt (
<span class="line-modified">!                         req.getRequestHeader(&quot;Content-length&quot;));</span>
                  if (clen != str2.length()) {
<span class="line-modified">!                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
                  req.setResponseEntityBody (reqbody);
<span class="line-modified">!                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse(200, &quot;OK&quot;);</span>
                  req.orderlyClose();
                  break;
              case 3: /* test 6 */
<span class="line-modified">!                 req.setResponseHeader(&quot;Location&quot;, &quot;https://foo.bar/&quot;);</span>
<span class="line-modified">!                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse(307, &quot;Temporary Redirect&quot;);</span>
                  req.orderlyClose();
                  break;
              case 4: /* test 7 */
              case 5: /* test 8 */
                  reqbody = req.getRequestEntityBody();
<span class="line-modified">!                 if (reqbody != null &amp;&amp; !&quot;&quot;.equals(reqbody)) {</span>
<span class="line-modified">!                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
                      req.orderlyClose();
                  }
<span class="line-modified">!                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                 req.sendResponse(200, &quot;OK&quot;);</span>
<span class="line-added">+                 req.orderlyClose();</span>
<span class="line-added">+                 break;</span>
<span class="line-added">+             default:</span>
<span class="line-added">+                 req.sendResponse(404, &quot;Not Found&quot;);</span>
                  req.orderlyClose();
                  break;
              }
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
  
<span class="line-modified">!     public boolean dropPlainTextConnections() {</span>
<span class="line-added">+         System.out.println(&quot;Unrecognized SSL message, plaintext connection?&quot;);</span>
<span class="line-added">+         System.out.println(&quot;TestHttpsServer receveived rogue connection: ignoring it.&quot;);</span>
<span class="line-added">+         rogueCount.incrementAndGet();</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     static void readAndCompare(InputStream is, String cmp) throws IOException {</span>
          int c;
<span class="line-modified">!         byte buf[] = new byte[1024];</span>
          int off = 0;
          int len = 1024;
          while ((c=is.read(buf, off, len)) != -1) {
              off += c;
              len -= c;
          }
<span class="line-modified">!         String s1 = new String(buf, 0, off, &quot;ISO8859_1&quot;);</span>
          if (!cmp.equals(s1)) {
<span class="line-modified">!             throw new IOException(&quot;strings not same&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /* basic smoke test: verify that server drops plain connections */</span>
<span class="line-added">+     static void testPlainText(String authority) throws Exception {</span>
<span class="line-added">+         URL url = new URL(&quot;http://&quot; + authority + &quot;/Donauschiffsgesellschaftskapitaenskajuete&quot;);</span>
<span class="line-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
<span class="line-added">+         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-added">+         int rogue = rogueCount.get();</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             int code  = urlc.getResponseCode();</span>
<span class="line-added">+             System.out.println(&quot;Unexpected response: &quot; + code);</span>
<span class="line-added">+             throw new AssertionError(&quot;Unexpected response: &quot; + code);</span>
<span class="line-added">+         } catch (SocketException x) {</span>
<span class="line-added">+             // we expect that the server will drop the connection and</span>
<span class="line-added">+             // close the accepted socket, so we should get a SocketException</span>
<span class="line-added">+             // on the client side, and confirm that this::dropPlainTextConnections</span>
<span class="line-added">+             // has ben called.</span>
<span class="line-added">+             if (rogueCount.get() == rogue) throw x;</span>
<span class="line-added">+             System.out.println(&quot;Got expected exception: &quot; + x);</span>
          }
      }
  
      /* basic chunked test (runs twice) */
  
<span class="line-modified">!     static void test1(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode(20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">!         os.write(str1.getBytes());</span>
          os.close();
          InputStream is = urlc.getInputStream();
<span class="line-modified">!         readAndCompare(is, str1);</span>
          is.close();
      }
  
      /* basic fixed length test */
  
<span class="line-modified">!     static void test3(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode(str2.length());</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
          os.write (str2.getBytes());
          os.close();
          InputStream is = urlc.getInputStream();
<span class="line-modified">!         readAndCompare(is, str2);</span>
          is.close();
      }
  
      /* write too few bytes */
  
<span class="line-modified">!     static void test4(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode(str2.length()+1);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">!         os.write(str2.getBytes());</span>
          try {
              os.close();
<span class="line-modified">!             throw new Exception(&quot;should have thrown IOException&quot;);</span>
          } catch (IOException e) {}
      }
  
      /* write too many bytes */
  
<span class="line-modified">!     static void test5(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode(str2.length()-1);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
          try {
<span class="line-modified">!             os.write(str2.getBytes());</span>
<span class="line-modified">!             throw new Exception(&quot;should have thrown IOException&quot;);</span>
          } catch (IOException e) {}
      }
  
      /* check for HttpRetryException on redirection */
  
<span class="line-modified">!     static void test6(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode(20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">!         os.write(str1.getBytes());</span>
          os.close();
          try {
              InputStream is = urlc.getInputStream();
<span class="line-modified">!             throw new Exception(&quot;should have gotten HttpRetryException&quot;);</span>
          } catch (HttpRetryException e) {
              if (e.responseCode() != 307) {
<span class="line-modified">!                 throw new Exception(&quot;Wrong response code &quot; + e.responseCode());</span>
              }
<span class="line-modified">!             if (!e.getLocation().equals(&quot;https://foo.bar/&quot;)) {</span>
<span class="line-modified">!                 throw new Exception(&quot;Wrong location &quot; + e.getLocation());</span>
              }
          }
      }
  
      /* next two tests send zero length posts */
  
<span class="line-modified">!     static void test7(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setChunkedStreamingMode(20);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
          os.close();
          int ret = urlc.getResponseCode();
          if (ret != 200) {
<span class="line-modified">!             throw new Exception(&quot;Expected 200: got &quot; + ret);</span>
          }
      }
  
<span class="line-modified">!     static void test8(String u) throws Exception {</span>
<span class="line-modified">!         URL url = new URL(u);</span>
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">!         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">!         urlc.setFixedLengthStreamingMode(0);</span>
          urlc.setDoOutput(true);
<span class="line-modified">!         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">!         OutputStream os = urlc.getOutputStream();</span>
          os.close();
          int ret = urlc.getResponseCode();
          if (ret != 200) {
<span class="line-modified">!             throw new Exception(&quot;Expected 200: got &quot; + ret);</span>
          }
      }
  
      static TestHttpsServer server;
  
<span class="line-modified">!     public static void main(String[] args) throws Exception {</span>
          // setup properties to do ssl
          String keyFilename =
              System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
                  &quot;/&quot; + keyStoreFile;
          String trustFilename =
              System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
                  &quot;/&quot; + trustStoreFile;
  
<span class="line-added">+         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">+ </span>
          HostnameVerifier reservedHV =
              HttpsURLConnection.getDefaultHostnameVerifier();
          try {
              System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyFilename);
              System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, passwd);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 296,21 ***</span>
              System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, passwd);
              HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
  
              try {
                  server = new TestHttpsServer(
<span class="line-modified">!                         new ChunkedOutputStream(), 1, 10, 0);</span>
<span class="line-modified">!                 System.out.println (&quot;Server started: listening on port: &quot; + server.getLocalPort());</span>
                  // the test server doesn&#39;t support keep-alive yet
<span class="line-modified">!                 // test1(&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/d0&quot;);</span>
<span class="line-modified">!                 test1(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d01&quot;);</span>
<span class="line-modified">!                 test3(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d3&quot;);</span>
<span class="line-modified">!                 test4(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d4&quot;);</span>
<span class="line-modified">!                 test5(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d5&quot;);</span>
<span class="line-modified">!                 test6(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d6&quot;);</span>
<span class="line-modified">!                 test7(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d7&quot;);</span>
<span class="line-modified">!                 test8(&quot;https://localhost:&quot;+server.getLocalPort()+&quot;/d8&quot;);</span>
              } catch (Exception e) {
                  if (server != null) {
                      server.terminate();
                  }
                  throw e;
<span class="line-new-header">--- 332,22 ---</span>
              System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, passwd);
              HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
  
              try {
                  server = new TestHttpsServer(
<span class="line-modified">!                         new ChunkedOutputStream(), 1, 10, loopback, 0);</span>
<span class="line-modified">!                 System.out.println(&quot;Server started: listening on: &quot; + server.getAuthority());</span>
<span class="line-added">+                 testPlainText(server.getAuthority());</span>
                  // the test server doesn&#39;t support keep-alive yet
<span class="line-modified">!                 // test1(&quot;http://&quot; + server.getAuthority() + &quot;/d0&quot;);</span>
<span class="line-modified">!                 test1(&quot;https://&quot; + server.getAuthority() + &quot;/d01&quot;);</span>
<span class="line-modified">!                 test3(&quot;https://&quot; + server.getAuthority() + &quot;/d3&quot;);</span>
<span class="line-modified">!                 test4(&quot;https://&quot; + server.getAuthority() + &quot;/d4&quot;);</span>
<span class="line-modified">!                 test5(&quot;https://&quot; + server.getAuthority() + &quot;/d5&quot;);</span>
<span class="line-modified">!                 test6(&quot;https://&quot; + server.getAuthority() + &quot;/d6&quot;);</span>
<span class="line-modified">!                 test7(&quot;https://&quot; + server.getAuthority() + &quot;/d7&quot;);</span>
<span class="line-modified">!                 test8(&quot;https://&quot; + server.getAuthority() + &quot;/d8&quot;);</span>
              } catch (Exception e) {
                  if (server != null) {
                      server.terminate();
                  }
                  throw e;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 325,10 ***</span>
          public boolean verify(String hostname, SSLSession session) {
              return true;
          }
      }
  
<span class="line-modified">!     public static void except (String s) {</span>
          server.terminate();
<span class="line-modified">!         throw new RuntimeException (s);</span>
      }
  }
<span class="line-new-header">--- 362,10 ---</span>
          public boolean verify(String hostname, SSLSession session) {
              return true;
          }
      }
  
<span class="line-modified">!     public static void except(String s) {</span>
          server.terminate();
<span class="line-modified">!         throw new RuntimeException(s);</span>
      }
  }
</pre>
<center><a href="../http/ZoneId.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HttpCallback.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>