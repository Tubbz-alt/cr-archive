<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/protocol/https/HttpsURLConnection/PostThruProxyWithAuth.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PostThruProxy.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/HttpsURLConnection/PostThruProxyWithAuth.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 27,10 ***</span>
<span class="line-new-header">--- 27,11 ---</span>
  import javax.net.*;
  import javax.net.ssl.*;
  
  import jdk.test.lib.process.OutputAnalyzer;
  import jdk.test.lib.process.ProcessTools;
<span class="line-added">+ import jdk.test.lib.net.URIBuilder;</span>
  
  /*
   * @test
   * @bug 4423074
   * @modules java.base/sun.net.www
</pre>
<hr />
<pre>
<span class="line-old-header">*** 45,10 ***</span>
<span class="line-new-header">--- 46,12 ---</span>
   *        jdk.test.lib.JDKToolLauncher
   *        jdk.test.lib.Platform
   *        jdk.test.lib.process.*
   * @compile OriginServer.java ProxyTunnelServer.java
   * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes= PostThruProxyWithAuth
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added">+                      -Djdk.http.auth.tunneling.disabledSchemes= PostThruProxyWithAuth</span>
   */
  public class PostThruProxyWithAuth {
  
      private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
      private static final int TIMEOUT = 30000;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 60,10 ***</span>
<span class="line-new-header">--- 63,15 ---</span>
      static String keyStoreFile = &quot;keystore&quot;;
      static String trustStoreFile = &quot;truststore&quot;;
      static String passwd = &quot;passphrase&quot;;
  
      volatile private static int serverPort = 0;
<span class="line-added">+     private static ProxyTunnelServer pserver;</span>
<span class="line-added">+     private static TestServer server;</span>
<span class="line-added">+ </span>
<span class="line-added">+     static final String RESPONSE_MSG =</span>
<span class="line-added">+         &quot;Https POST thru proxy is successful with proxy authentication&quot;;</span>
  
      /*
       * The TestServer implements a OriginServer that
       * processes HTTP requests and responses.
       */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 77,13 ***</span>
           * the data sent in the response.
           *
           * @return bytes for the data in the response
           */
          public byte[] getBytes() {
<span class="line-modified">!             return</span>
<span class="line-removed">-                 &quot;Https POST thru proxy is successful with proxy authentication&quot;.</span>
<span class="line-removed">-                 getBytes();</span>
          }
      }
  
      /*
       * Main method to create the server and client
<span class="line-new-header">--- 85,11 ---</span>
           * the data sent in the response.
           *
           * @return bytes for the data in the response
           */
          public byte[] getBytes() {
<span class="line-modified">!             return RESPONSE_MSG.getBytes();</span>
          }
      }
  
      /*
       * Main method to create the server and client
</pre>
<hr />
<pre>
<span class="line-old-header">*** 101,15 ***</span>
          boolean useSSL = true;
          /*
           * setup the server
           */
          try {
              ServerSocketFactory ssf = getServerSocketFactory(useSSL);
<span class="line-modified">!             ServerSocket ss = ssf.createServerSocket(serverPort);</span>
              ss.setSoTimeout(TIMEOUT);  // 30 seconds
              serverPort = ss.getLocalPort();
<span class="line-modified">!             new TestServer(ss);</span>
          } catch (Exception e) {
              System.out.println(&quot;Server side failed:&quot; +
                                  e.getMessage());
              throw e;
          }
<span class="line-new-header">--- 107,17 ---</span>
          boolean useSSL = true;
          /*
           * setup the server
           */
          try {
<span class="line-added">+             InetAddress localhost = InetAddress.getLocalHost();</span>
              ServerSocketFactory ssf = getServerSocketFactory(useSSL);
<span class="line-modified">!             ServerSocket ss = ssf.createServerSocket(serverPort, 0, localhost);</span>
              ss.setSoTimeout(TIMEOUT);  // 30 seconds
              serverPort = ss.getLocalPort();
<span class="line-modified">!             server = new TestServer(ss);</span>
<span class="line-added">+             System.out.println(&quot;Server started at: &quot; + ss);</span>
          } catch (Exception e) {
              System.out.println(&quot;Server side failed:&quot; +
                                  e.getMessage());
              throw e;
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 118,11 ***</span>
              doClientSide();
          } catch (Exception e) {
              System.out.println(&quot;Client side failed: &quot; +
                                  e.getMessage());
              throw e;
<span class="line-modified">!           }</span>
      }
  
      private static ServerSocketFactory getServerSocketFactory
                     (boolean useSSL) throws Exception {
          if (useSSL) {
<span class="line-new-header">--- 126,17 ---</span>
              doClientSide();
          } catch (Exception e) {
              System.out.println(&quot;Client side failed: &quot; +
                                  e.getMessage());
              throw e;
<span class="line-modified">!         }</span>
<span class="line-added">+         long connectCount = pserver.getConnectCount();</span>
<span class="line-added">+         if (connectCount == 0) {</span>
<span class="line-added">+             throw new AssertionError(&quot;Proxy was not used!&quot;);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             System.out.println(&quot;Proxy CONNECT count: &quot; + connectCount);</span>
<span class="line-added">+         }</span>
      }
  
      private static ServerSocketFactory getServerSocketFactory
                     (boolean useSSL) throws Exception {
          if (useSSL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 158,13 ***</span>
           * we want to avoid URLspoofCheck failures in cases where the cert
           * DN name does not match the hostname in the URL.
           */
          HttpsURLConnection.setDefaultHostnameVerifier(
                                        new NameVerifier());
<span class="line-modified">!         URL url = new URL(&quot;https://&quot; + getHostname() + &quot;:&quot; + serverPort);</span>
  
          Proxy p = new Proxy(Proxy.Type.HTTP, pAddr);
          HttpsURLConnection https = (HttpsURLConnection)url.openConnection(p);
          https.setConnectTimeout(TIMEOUT);
          https.setReadTimeout(TIMEOUT);
          https.setDoOutput(true);
          https.setRequestMethod(&quot;POST&quot;);
<span class="line-new-header">--- 172,20 ---</span>
           * we want to avoid URLspoofCheck failures in cases where the cert
           * DN name does not match the hostname in the URL.
           */
          HttpsURLConnection.setDefaultHostnameVerifier(
                                        new NameVerifier());
<span class="line-modified">! </span>
<span class="line-added">+         URL url = URIBuilder.newBuilder()</span>
<span class="line-added">+                       .scheme(&quot;https&quot;)</span>
<span class="line-added">+                       .host(getHostname())</span>
<span class="line-added">+                       .port(serverPort)</span>
<span class="line-added">+                       .toURL();</span>
  
          Proxy p = new Proxy(Proxy.Type.HTTP, pAddr);
<span class="line-added">+         System.out.println(&quot;Client connecting to: &quot; + url);</span>
<span class="line-added">+         System.out.println(&quot;Through proxy: &quot; + pAddr);</span>
          HttpsURLConnection https = (HttpsURLConnection)url.openConnection(p);
          https.setConnectTimeout(TIMEOUT);
          https.setReadTimeout(TIMEOUT);
          https.setDoOutput(true);
          https.setRequestMethod(&quot;POST&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 180,13 ***</span>
             // clear the pipe
             BufferedReader in = new BufferedReader(
                                  new InputStreamReader(
                                  https.getInputStream()));
             String inputLine;
<span class="line-modified">!            while ((inputLine = in.readLine()) != null)</span>
<span class="line-modified">!                  System.out.println(&quot;Client received: &quot; + inputLine);</span>
             in.close();
          } catch (SSLException e) {
              if (ps != null)
                  ps.close();
              throw e;
          } catch (SocketTimeoutException e) {
<span class="line-new-header">--- 201,19 ---</span>
             // clear the pipe
             BufferedReader in = new BufferedReader(
                                  new InputStreamReader(
                                  https.getInputStream()));
             String inputLine;
<span class="line-modified">!            boolean msgFound = false;</span>
<span class="line-modified">!            while ((inputLine = in.readLine()) != null) {</span>
<span class="line-added">+                 System.out.println(&quot;Client received: &quot; + inputLine);</span>
<span class="line-added">+                 if (inputLine.contains(RESPONSE_MSG)) msgFound = true;</span>
<span class="line-added">+            }</span>
             in.close();
<span class="line-added">+            if (!msgFound) {</span>
<span class="line-added">+                throw new RuntimeException(&quot;POST message not found.&quot;);</span>
<span class="line-added">+            }</span>
          } catch (SSLException e) {
              if (ps != null)
                  ps.close();
              throw e;
          } catch (SocketTimeoutException e) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,11 ***</span>
              return true;
          }
      }
  
      static SocketAddress setupProxy() throws IOException {
<span class="line-modified">!         ProxyTunnelServer pserver = new ProxyTunnelServer();</span>
  
          /*
           * register a system wide authenticator and setup the proxy for
           * authentication
           */
<span class="line-new-header">--- 227,13 ---</span>
              return true;
          }
      }
  
      static SocketAddress setupProxy() throws IOException {
<span class="line-modified">! </span>
<span class="line-added">+         InetAddress localhost = InetAddress.getLocalHost();</span>
<span class="line-added">+         pserver = new ProxyTunnelServer(localhost);</span>
  
          /*
           * register a system wide authenticator and setup the proxy for
           * authentication
           */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 214,11 ***</span>
          pserver.needUserAuth(true);
          pserver.setUserAuth(&quot;Test&quot;, &quot;test123&quot;);
  
          pserver.start();
  
<span class="line-modified">!         return new InetSocketAddress(&quot;localhost&quot;, pserver.getPort());</span>
      }
  
      public static class TestAuthenticator extends Authenticator {
          public PasswordAuthentication getPasswordAuthentication() {
              return new PasswordAuthentication(&quot;Test&quot;,
<span class="line-new-header">--- 243,11 ---</span>
          pserver.needUserAuth(true);
          pserver.setUserAuth(&quot;Test&quot;, &quot;test123&quot;);
  
          pserver.start();
  
<span class="line-modified">!         return new InetSocketAddress(localhost, pserver.getPort());</span>
      }
  
      public static class TestAuthenticator extends Authenticator {
          public PasswordAuthentication getPasswordAuthentication() {
              return new PasswordAuthentication(&quot;Test&quot;,
</pre>
<center><a href="PostThruProxy.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>