<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/net/www/protocol/https/HttpsClient/ProxyAuthTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2001, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 //
 25 // SunJSSE does not support dynamic system properties, no way to re-use
 26 // system properties in samevm/agentvm mode.
 27 //
 28 
 29 /*
 30  * @test
 31  * @bug 4323990 4413069 8160838
 32  * @summary HttpsURLConnection doesn&#39;t send Proxy-Authorization on CONNECT
 33  *     Incorrect checking of proxy server response
 34  * @modules jdk.crypto.ec
 35  *          java.base/sun.net.www
 36  * @library /javax/net/ssl/templates
 37  * @run main/othervm ProxyAuthTest fail
 38  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Basic
 39  *      ProxyAuthTest fail
 40  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Basic,
 41  *      ProxyAuthTest fail
 42  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=BAsIc
 43  *      ProxyAuthTest fail
 44  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Basic,Digest
 45  *      ProxyAuthTest fail
 46  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Unknown,bAsIc
 47  *      ProxyAuthTest fail
 48  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=
 49  *      ProxyAuthTest succeed
 50  * @run main/othervm
 51  *      -Djdk.http.auth.tunneling.disabledSchemes=Digest,NTLM,Negotiate
 52  *      ProxyAuthTest succeed
 53  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=UNKNOWN,notKnown
 54  *      ProxyAuthTest succeed
 55  */
 56 
 57 import java.io.BufferedReader;
 58 import java.io.DataOutputStream;
 59 import java.io.IOException;
 60 import java.io.InputStreamReader;
 61 import java.net.Authenticator;
<a name="2" id="anc2"></a>
 62 import java.net.InetSocketAddress;
 63 import java.net.PasswordAuthentication;
 64 import java.net.Proxy;
 65 import java.net.URL;
 66 import javax.net.ssl.HostnameVerifier;
 67 import javax.net.ssl.HttpsURLConnection;
 68 import javax.net.ssl.SSLSession;
 69 import javax.net.ssl.SSLSocket;
 70 import javax.net.ssl.SSLContext;
 71 import static java.nio.charset.StandardCharsets.US_ASCII;
 72 
 73 /*
 74  * ProxyAuthTest.java -- includes a simple server that can serve
 75  * Http get request in both clear and secure channel, and a client
 76  * that makes https requests behind the firewall through an
 77  * authentication proxy
 78  */
 79 
 80 public class ProxyAuthTest extends SSLSocketTemplate {
 81     private static boolean expectSuccess;
 82 
<a name="3" id="anc3"></a>



 83     /*
 84      * Run the test case.
 85      */
 86     public static void main(String[] args) throws Exception {
 87         // Get the customized arguments.
 88         parseArguments(args);
 89 
 90         (new ProxyAuthTest()).run();
 91     }
 92 
 93     @Override
 94     protected boolean isCustomizedClientConnection() {
 95         return true;
 96     }
 97 
 98     @Override
 99     protected void runServerApplication(SSLSocket socket) throws Exception {
100         String response = &quot;Proxy authentication for tunneling succeeded ..&quot;;
101         DataOutputStream out = new DataOutputStream(socket.getOutputStream());
102         try {
103             BufferedReader in = new BufferedReader(
104                     new InputStreamReader(socket.getInputStream()));
105 
106             // read the request
107             readRequest(in);
108 
109             // retrieve bytecodes
110             byte[] bytecodes = response.getBytes(US_ASCII);
111 
112             // send bytecodes in response (assumes HTTP/1.0 or later)
113             out.writeBytes(&quot;HTTP/1.0 200 OK\r\n&quot;);
114             out.writeBytes(&quot;Content-Length: &quot; + bytecodes.length + &quot;\r\n&quot;);
115             out.writeBytes(&quot;Content-Type: text/html\r\n\r\n&quot;);
116             out.write(bytecodes);
117             out.flush();
118         } catch (IOException e) {
119             // write out error response
120             out.writeBytes(&quot;HTTP/1.0 400 &quot; + e.getMessage() + &quot;\r\n&quot;);
121             out.writeBytes(&quot;Content-Type: text/html\r\n\r\n&quot;);
122             out.flush();
123         }
124     }
125 
126     @Override
127     protected void runClientApplication(int serverPort) throws Exception {
128         /*
129          * Set the default SSLSocketFactory.
130          */
131         SSLContext context = createClientSSLContext();
132         HttpsURLConnection.setDefaultSSLSocketFactory(
133                 context.getSocketFactory());
134 
135         /*
136          * setup up a proxy with authentication information
137          */
138         ProxyTunnelServer ps = setupProxy();
139 
140         /*
141          * we want to avoid URLspoofCheck failures in cases where the cert
142          * DN name does not match the hostname in the URL.
143          */
144         HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
145 
<a name="4" id="anc4"></a><span class="line-modified">146         InetSocketAddress paddr =</span>
<span class="line-modified">147                 new InetSocketAddress(&quot;localhost&quot;, ps.getPort());</span>

148         Proxy proxy = new Proxy(Proxy.Type.HTTP, paddr);
149 
<a name="5" id="anc5"></a>




150         URL url = new URL(
<a name="6" id="anc6"></a><span class="line-modified">151                 &quot;https://&quot; + &quot;localhost:&quot; + serverPort + &quot;/index.html&quot;);</span>

152         BufferedReader in = null;
153         HttpsURLConnection uc = (HttpsURLConnection) url.openConnection(proxy);
154         try {
155             in = new BufferedReader(new InputStreamReader(uc.getInputStream()));
156             String inputLine;
<a name="7" id="anc7"></a><span class="line-modified">157             System.out.print(&quot;Client recieved from the server: &quot;);</span>
158             while ((inputLine = in.readLine()) != null) {
159                 System.out.println(inputLine);
160             }
161             if (!expectSuccess) {
162                 throw new RuntimeException(
163                     &quot;Expected exception/failure to connect, but succeeded.&quot;);
164             }
165         } catch (IOException e) {
166             if (expectSuccess) {
167                 System.out.println(&quot;Client side failed: &quot; + e.getMessage());
168                 throw e;
169             }
170 
171             // Assert that the error stream is not accessible from the failed
172             // tunnel setup.
173             if (uc.getErrorStream() != null) {
174                 throw new RuntimeException(&quot;Unexpected error stream.&quot;);
175             }
176 
177             if (!e.getMessage().contains(&quot;Unable to tunnel through proxy&quot;) ||
178                 !e.getMessage().contains(&quot;407&quot;)) {
179 
180                 throw new RuntimeException(
181                         &quot;Expected exception about cannot tunnel, &quot; +
182                         &quot;407, etc, but got&quot;, e);
183             } else {
184                 // Informative
185                 System.out.println(
186                         &quot;Caught expected exception: &quot; + e.getMessage());
187             }
188         } finally {
189             if (in != null) {
190                 in.close();
191             }
192         }
193     }
194 
195 
196     private static void parseArguments(String[] args) {
197         if (args[0].equals(&quot;succeed&quot;)) {
198             expectSuccess = true;
199         } else {
200             expectSuccess = false;
201         }
202     }
203 
204     /**
205      * read the response, don&#39;t care for the syntax of the request-line
206      * for this testing
207      */
208     private static void readRequest(BufferedReader in) throws IOException {
209         String line = null;
210         System.out.println(&quot;Server received: &quot;);
211         do {
212             if (line != null) {
213                 System.out.println(line);
214             }
215             line = in.readLine();
216         } while ((line.length() != 0) &amp;&amp;
217                 (line.charAt(0) != &#39;\r&#39;) &amp;&amp; (line.charAt(0) != &#39;\n&#39;));
218     }
219 
220     private static class NameVerifier implements HostnameVerifier {
221 
222         @Override
223         public boolean verify(String hostname, SSLSession session) {
224             return true;
225         }
226     }
227 
228     private static ProxyTunnelServer setupProxy() throws IOException {
<a name="8" id="anc8"></a><span class="line-modified">229         ProxyTunnelServer pserver = new ProxyTunnelServer();</span>

230 
231         /*
232          * register a system wide authenticator and setup the proxy for
233          * authentication
234          */
235         Authenticator.setDefault(new TestAuthenticator());
236 
237         // register with the username and password
238         pserver.needUserAuth(true);
239         pserver.setUserAuth(&quot;Test&quot;, &quot;test123&quot;);
240 
241         pserver.start();
242         return pserver;
243     }
244 
245     private static class TestAuthenticator extends Authenticator {
246 
247         @Override
248         public PasswordAuthentication getPasswordAuthentication() {
249             return new PasswordAuthentication(&quot;Test&quot;, &quot;test123&quot;.toCharArray());
250         }
251     }
252 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>