<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/net/www/http/ChunkedOutputStream/Test.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CheckError.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../HttpClient/B6726695.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/http/ChunkedOutputStream/Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2004, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,18 +23,21 @@</span>
  
  /**
   * @test
   * @bug 5026745 6631048
   * @modules jdk.httpserver
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @run main/othervm/timeout=500 Test
   * @summary Cannot flush output stream when writing to an HttpUrlConnection
   */
  
  import java.io.*;
  import java.net.*;
  import com.sun.net.httpserver.*;
  
<span class="udiff-line-added">+ import jdk.test.lib.net.URIBuilder;</span>
<span class="udiff-line-added">+ </span>
  public class Test implements HttpHandler {
  
      static volatile int count = 0;
  
      static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -270,13 +273,12 @@</span>
          }
      }
  
      /* basic chunked test (runs twice) */
  
<span class="udiff-line-modified-removed">-     static void test1 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test1(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (20);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -287,13 +289,12 @@</span>
          is.close();
      }
  
      /* basic fixed length test */
  
<span class="udiff-line-modified-removed">-     static void test3 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test3(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setFixedLengthStreamingMode (str2.length());
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -304,13 +305,12 @@</span>
          is.close();
      }
  
      /* write too few bytes */
  
<span class="udiff-line-modified-removed">-     static void test4 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test4(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setFixedLengthStreamingMode (str2.length()+1);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -321,13 +321,12 @@</span>
          } catch (IOException e) {}
      }
  
      /* write too many bytes */
  
<span class="udiff-line-modified-removed">-     static void test5 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test5(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setFixedLengthStreamingMode (str2.length()-1);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -337,13 +336,12 @@</span>
          } catch (IOException e) {}
      }
  
      /* check for HttpRetryException on redirection */
  
<span class="udiff-line-modified-removed">-     static void test6 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test6(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (20);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -362,13 +360,12 @@</span>
          }
      }
  
      /* next two tests send zero length posts */
  
<span class="udiff-line-modified-removed">-     static void test7 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test7(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (20);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -377,13 +374,12 @@</span>
          if (ret != 200) {
              throw new Exception (&quot;Expected 200: got &quot; + ret);
          }
      }
  
<span class="udiff-line-modified-removed">-     static void test8 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test8(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setFixedLengthStreamingMode (0);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -394,13 +390,12 @@</span>
          }
      }
  
      /* calling setChunkedStreamingMode with -1 should entail using
         the default chunk size */
<span class="udiff-line-modified-removed">-    static void test9 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test9(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (-1);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -409,13 +404,12 @@</span>
          InputStream is = urlc.getInputStream();
          readAndCompare (is, str1);
          is.close();
      }
  
<span class="udiff-line-modified-removed">-    static void test10 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test10(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (4 * 1024);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -433,13 +427,12 @@</span>
          if (ret != 200) {
              throw new Exception (&quot;Expected 200: got &quot; + ret);
          }
      }
  
<span class="udiff-line-modified-removed">-     static void test11 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test11(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (36 * 1024);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -460,13 +453,12 @@</span>
          if (ret != 200) {
              throw new Exception (&quot;Expected 200: got &quot; + ret);
          }
      }
  
<span class="udiff-line-modified-removed">-     static void test12 (String u) throws Exception {</span>
<span class="udiff-line-modified-removed">-         URL url = new URL (u);</span>
<span class="udiff-line-removed">-         System.out.println (&quot;client opening connection to: &quot; + u);</span>
<span class="udiff-line-modified-added">+     static void test12(URL url) throws Exception {</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;client opening connection to: &quot; + url);</span>
          HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
          urlc.setChunkedStreamingMode (36 * 1024);
          urlc.setDoOutput(true);
          urlc.setRequestMethod (&quot;POST&quot;);
          OutputStream os = urlc.getOutputStream ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -483,33 +475,43 @@</span>
              throw new Exception (&quot;Expected 200: got &quot; + ret);
          }
      }
  
  
<span class="udiff-line-modified-removed">-     static com.sun.net.httpserver.HttpServer httpserver;</span>
<span class="udiff-line-modified-added">+     static HttpServer httpserver;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static URL buildTestURL(int port, String path)</span>
<span class="udiff-line-added">+             throws MalformedURLException, URISyntaxException {</span>
<span class="udiff-line-added">+         return URIBuilder.newBuilder()</span>
<span class="udiff-line-added">+                 .scheme(&quot;http&quot;)</span>
<span class="udiff-line-added">+                 .loopback()</span>
<span class="udiff-line-added">+                 .port(port)</span>
<span class="udiff-line-added">+                 .path(path)</span>
<span class="udiff-line-added">+                 .toURL();</span>
<span class="udiff-line-added">+     }</span>
  
      public static void main (String[] args) throws Exception {
          try {
<span class="udiff-line-modified-removed">-             httpserver = com.sun.net.httpserver.HttpServer.create(new InetSocketAddress(0), 0);</span>
<span class="udiff-line-modified-removed">-             HttpContext ctx = httpserver.createContext(&quot;/test/&quot;, new Test() );</span>
<span class="udiff-line-modified-added">+             httpserver = HttpServer.create(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0), 0);</span>
<span class="udiff-line-modified-added">+             httpserver.createContext(&quot;/test/&quot;, new Test());</span>
              httpserver.start();
  
              int port = httpserver.getAddress().getPort();
  
              System.out.println (&quot;Server started: listening on port: &quot; + port);
<span class="udiff-line-modified-removed">-             test1(&quot;http://localhost:&quot;+ port + &quot;/test/test1&quot;);</span>
<span class="udiff-line-modified-removed">-             test1(&quot;http://localhost:&quot;+ port + &quot;/test/test2&quot;);</span>
<span class="udiff-line-modified-removed">-             test3(&quot;http://localhost:&quot;+ port + &quot;/test/test3&quot;);</span>
<span class="udiff-line-modified-removed">-             test4(&quot;http://localhost:&quot;+ port + &quot;/test/test4&quot;);</span>
<span class="udiff-line-modified-removed">-             test5(&quot;http://localhost:&quot;+ port + &quot;/test/test5&quot;);</span>
<span class="udiff-line-modified-removed">-             test6(&quot;http://localhost:&quot;+ port + &quot;/test/test6&quot;);</span>
<span class="udiff-line-modified-removed">-             test7(&quot;http://localhost:&quot;+ port + &quot;/test/test7&quot;);</span>
<span class="udiff-line-modified-removed">-             test8(&quot;http://localhost:&quot;+ port + &quot;/test/test8&quot;);</span>
<span class="udiff-line-modified-removed">-             test9(&quot;http://localhost:&quot;+ port + &quot;/test/test9&quot;);</span>
<span class="udiff-line-modified-removed">-             test10(&quot;http://localhost:&quot;+ port + &quot;/test/test10&quot;);</span>
<span class="udiff-line-modified-removed">-             test11(&quot;http://localhost:&quot;+ port + &quot;/test/test11&quot;);</span>
<span class="udiff-line-modified-removed">-             test12(&quot;http://localhost:&quot;+ port + &quot;/test/test12&quot;);</span>
<span class="udiff-line-modified-added">+             test1(buildTestURL(port, &quot;/test/test1&quot;));</span>
<span class="udiff-line-modified-added">+             test1(buildTestURL(port, &quot;/test/test2&quot;));</span>
<span class="udiff-line-modified-added">+             test3(buildTestURL(port, &quot;/test/test3&quot;));</span>
<span class="udiff-line-modified-added">+             test4(buildTestURL(port, &quot;/test/test4&quot;));</span>
<span class="udiff-line-modified-added">+             test5(buildTestURL(port, &quot;/test/test5&quot;));</span>
<span class="udiff-line-modified-added">+             test6(buildTestURL(port, &quot;/test/test6&quot;));</span>
<span class="udiff-line-modified-added">+             test7(buildTestURL(port, &quot;/test/test7&quot;));</span>
<span class="udiff-line-modified-added">+             test8(buildTestURL(port, &quot;/test/test8&quot;));</span>
<span class="udiff-line-modified-added">+             test9(buildTestURL(port, &quot;/test/test9&quot;));</span>
<span class="udiff-line-modified-added">+             test10(buildTestURL(port, &quot;/test/test10&quot;));</span>
<span class="udiff-line-modified-added">+             test11(buildTestURL(port, &quot;/test/test11&quot;));</span>
<span class="udiff-line-modified-added">+             test12(buildTestURL(port, &quot;/test/test12&quot;));</span>
          } finally {
              if (httpserver != null)
                  httpserver.stop(0);
          }
      }
</pre>
<center><a href="CheckError.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../HttpClient/B6726695.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>