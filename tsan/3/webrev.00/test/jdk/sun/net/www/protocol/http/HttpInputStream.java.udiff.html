<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/net/www/protocol/http/HttpInputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Finalizer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HttpOnly.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/HttpInputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,21 +21,26 @@</span>
   * questions.
   */
  
  /* @test
   * @bug 4937598
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @summary http://www.clipstream.com video does not play; read() problem
   */
  
  
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
<span class="udiff-line-added">+ import java.net.InetAddress;</span>
<span class="udiff-line-added">+ import java.net.InetSocketAddress;</span>
  import java.net.ServerSocket;
  import java.net.Socket;
  import java.net.URL;
  
<span class="udiff-line-added">+ import jdk.test.lib.net.URIBuilder;</span>
<span class="udiff-line-added">+ </span>
  public class HttpInputStream {
  
      private static final int CONTENT_LENGTH = 20;
  
      static class Server implements AutoCloseable, Runnable {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,11 +48,13 @@</span>
          final ServerSocket serverSocket;
          static final byte[] requestEnd = new byte[]{&#39;\r&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\n&#39;};
          static final int TIMEOUT = 10 * 1000;
  
          Server() throws IOException {
<span class="udiff-line-modified-removed">-             serverSocket = new ServerSocket(0);</span>
<span class="udiff-line-modified-added">+             serverSocket = new ServerSocket();</span>
<span class="udiff-line-added">+             serverSocket.bind(new InetSocketAddress(</span>
<span class="udiff-line-added">+                     InetAddress.getLoopbackAddress(), 0));</span>
          }
  
          void readOneRequest(InputStream is) throws IOException {
              int requestEndCount = 0, r;
              while ((r = is.read()) != -1) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,11 +111,16 @@</span>
      }
  
      public static void main(String args[]) throws IOException {
          try (Server server = new Server()) {
              (new Thread(server)).start();
<span class="udiff-line-modified-removed">-             URL url = new URL(&quot;http://localhost:&quot; + server.getPort() + &quot;/anything&quot;);</span>
<span class="udiff-line-modified-added">+             URL url = URIBuilder.newBuilder()</span>
<span class="udiff-line-added">+                     .scheme(&quot;http&quot;)</span>
<span class="udiff-line-added">+                     .loopback()</span>
<span class="udiff-line-added">+                     .port(server.getPort())</span>
<span class="udiff-line-added">+                     .path(&quot;/anything&quot;)</span>
<span class="udiff-line-added">+                     .toURLUnchecked();</span>
              try (InputStream is = url.openConnection().getInputStream()) {
                  if (read(is) != CONTENT_LENGTH) {
                      throw new RuntimeException(&quot;HttpInputStream.read() failed with 0xff&quot;);
                  }
              }
</pre>
<center><a href="Finalizer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HttpOnly.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>