<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/http/HttpStreams.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="HttpOnly.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Modified.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/HttpStreams.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8011719

 27  * @modules jdk.httpserver
 28  * @summary Basic checks to verify behavior of returned input streams
 29  */
 30 
 31 import com.sun.net.httpserver.HttpExchange;
 32 import com.sun.net.httpserver.HttpHandler;
 33 import com.sun.net.httpserver.HttpServer;
 34 import java.io.*;
 35 import java.net.*;
 36 import java.nio.charset.StandardCharsets;
 37 import java.util.*;
 38 


 39 public class HttpStreams {
 40 
 41     void client(String u) throws Exception {
 42         byte[] ba = new byte[5];
 43         HttpURLConnection urlc = (HttpURLConnection)(new URL(u)).openConnection();
 44         int resp = urlc.getResponseCode();
 45         InputStream is;
 46         if (resp == 200)
 47             is = urlc.getInputStream();
 48         else
 49             is = urlc.getErrorStream();
 50 
 51         expectNoThrow(() -&gt; { is.read(); }, &quot;read on open stream should not throw :&quot; + u);
 52         expectNoThrow(() -&gt; { is.close(); }, &quot;close should never throw: &quot; + u);
 53         expectNoThrow(() -&gt; { is.close(); }, &quot;close should never throw: &quot; + u);
 54         expectThrow(() -&gt; { is.read(); }, &quot;read on closed stream should throw: &quot; + u);
 55         expectThrow(() -&gt; { is.read(ba); }, &quot;read on closed stream should throw: &quot; + u);
 56         expectThrow(() -&gt; { is.read(ba, 0, 2); }, &quot;read on closed stream should throw: &quot; + u);
 57     }
 58 









 59     void test() throws Exception {
 60         HttpServer server = null;
 61         try {
 62             server = startHttpServer();
<span class="line-modified"> 63             String baseUrl = &quot;http://localhost:&quot; + server.getAddress().getPort() + &quot;/&quot;;</span>
<span class="line-modified"> 64             client(baseUrl +  &quot;chunked/&quot;);</span>
<span class="line-modified"> 65             client(baseUrl +  &quot;fixed/&quot;);</span>
<span class="line-modified"> 66             client(baseUrl +  &quot;error/&quot;);</span>
<span class="line-modified"> 67             client(baseUrl +  &quot;chunkedError/&quot;);</span>
 68 
 69             // Test with a response cache
 70             ResponseCache ch = ResponseCache.getDefault();
 71             ResponseCache.setDefault(new TrivialCacheHandler());
 72             try {
<span class="line-modified"> 73                 client(baseUrl +  &quot;chunked/&quot;);</span>
<span class="line-modified"> 74                 client(baseUrl +  &quot;fixed/&quot;);</span>
<span class="line-modified"> 75                 client(baseUrl +  &quot;error/&quot;);</span>
<span class="line-modified"> 76                 client(baseUrl +  &quot;chunkedError/&quot;);</span>
 77             } finally {
 78                 ResponseCache.setDefault(ch);
 79             }
 80         } finally {
 81             if (server != null)
 82                 server.stop(0);
 83         }
 84 
 85         System.out.println(&quot;passed: &quot; + pass + &quot;, failed: &quot; + fail);
 86         if (fail &gt; 0)
 87             throw new RuntimeException(&quot;some tests failed check output&quot;);
 88     }
 89 
 90     public static void main(String[] args) throws Exception {
 91         (new HttpStreams()).test();
 92     }
 93 
 94     // HTTP Server
 95     HttpServer startHttpServer() throws IOException {
<span class="line-modified"> 96         HttpServer httpServer = HttpServer.create(new InetSocketAddress(0), 0);</span>

 97         httpServer.createContext(&quot;/chunked/&quot;, new ChunkedHandler());
 98         httpServer.createContext(&quot;/fixed/&quot;, new FixedHandler());
 99         httpServer.createContext(&quot;/error/&quot;, new ErrorHandler());
100         httpServer.createContext(&quot;/chunkedError/&quot;, new ChunkedErrorHandler());
101         httpServer.start();
102         return httpServer;
103     }
104 
105     static abstract class AbstractHandler implements HttpHandler {
106         @Override
107         public void handle(HttpExchange t) throws IOException {
108             try (InputStream is = t.getRequestBody()) {
109                 while (is.read() != -1);
110             }
111             t.sendResponseHeaders(respCode(), length());
112             try (OutputStream os = t.getResponseBody()) {
113                 os.write(message());
114             }
115             t.close();
116         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8011719
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @modules jdk.httpserver
 29  * @summary Basic checks to verify behavior of returned input streams
 30  */
 31 
 32 import com.sun.net.httpserver.HttpExchange;
 33 import com.sun.net.httpserver.HttpHandler;
 34 import com.sun.net.httpserver.HttpServer;
 35 import java.io.*;
 36 import java.net.*;
 37 import java.nio.charset.StandardCharsets;
 38 import java.util.*;
 39 
<span class="line-added"> 40 import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added"> 41 </span>
 42 public class HttpStreams {
 43 
 44     void client(String u) throws Exception {
 45         byte[] ba = new byte[5];
 46         HttpURLConnection urlc = (HttpURLConnection)(new URL(u)).openConnection();
 47         int resp = urlc.getResponseCode();
 48         InputStream is;
 49         if (resp == 200)
 50             is = urlc.getInputStream();
 51         else
 52             is = urlc.getErrorStream();
 53 
 54         expectNoThrow(() -&gt; { is.read(); }, &quot;read on open stream should not throw :&quot; + u);
 55         expectNoThrow(() -&gt; { is.close(); }, &quot;close should never throw: &quot; + u);
 56         expectNoThrow(() -&gt; { is.close(); }, &quot;close should never throw: &quot; + u);
 57         expectThrow(() -&gt; { is.read(); }, &quot;read on closed stream should throw: &quot; + u);
 58         expectThrow(() -&gt; { is.read(ba); }, &quot;read on closed stream should throw: &quot; + u);
 59         expectThrow(() -&gt; { is.read(ba, 0, 2); }, &quot;read on closed stream should throw: &quot; + u);
 60     }
 61 
<span class="line-added"> 62     String constructUrlString(int port, String path) throws Exception {</span>
<span class="line-added"> 63         return URIBuilder.newBuilder()</span>
<span class="line-added"> 64                 .scheme(&quot;http&quot;)</span>
<span class="line-added"> 65                 .port(port)</span>
<span class="line-added"> 66                 .loopback()</span>
<span class="line-added"> 67                 .path(path)</span>
<span class="line-added"> 68                 .toURL().toString();</span>
<span class="line-added"> 69     }</span>
<span class="line-added"> 70 </span>
 71     void test() throws Exception {
 72         HttpServer server = null;
 73         try {
 74             server = startHttpServer();
<span class="line-modified"> 75             int serverPort = server.getAddress().getPort();</span>
<span class="line-modified"> 76             client(constructUrlString(serverPort, &quot;/chunked/&quot;));</span>
<span class="line-modified"> 77             client(constructUrlString(serverPort, &quot;/fixed/&quot;));</span>
<span class="line-modified"> 78             client(constructUrlString(serverPort, &quot;/error/&quot;));</span>
<span class="line-modified"> 79             client(constructUrlString(serverPort, &quot;/chunkedError/&quot;));</span>
 80 
 81             // Test with a response cache
 82             ResponseCache ch = ResponseCache.getDefault();
 83             ResponseCache.setDefault(new TrivialCacheHandler());
 84             try {
<span class="line-modified"> 85                 client(constructUrlString(serverPort, &quot;/chunked/&quot;));</span>
<span class="line-modified"> 86                 client(constructUrlString(serverPort, &quot;/fixed/&quot;));</span>
<span class="line-modified"> 87                 client(constructUrlString(serverPort, &quot;/error/&quot;));</span>
<span class="line-modified"> 88                 client(constructUrlString(serverPort, &quot;/chunkedError/&quot;));</span>
 89             } finally {
 90                 ResponseCache.setDefault(ch);
 91             }
 92         } finally {
 93             if (server != null)
 94                 server.stop(0);
 95         }
 96 
 97         System.out.println(&quot;passed: &quot; + pass + &quot;, failed: &quot; + fail);
 98         if (fail &gt; 0)
 99             throw new RuntimeException(&quot;some tests failed check output&quot;);
100     }
101 
102     public static void main(String[] args) throws Exception {
103         (new HttpStreams()).test();
104     }
105 
106     // HTTP Server
107     HttpServer startHttpServer() throws IOException {
<span class="line-modified">108         HttpServer httpServer = HttpServer.create();</span>
<span class="line-added">109         httpServer.bind(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0), 0);</span>
110         httpServer.createContext(&quot;/chunked/&quot;, new ChunkedHandler());
111         httpServer.createContext(&quot;/fixed/&quot;, new FixedHandler());
112         httpServer.createContext(&quot;/error/&quot;, new ErrorHandler());
113         httpServer.createContext(&quot;/chunkedError/&quot;, new ChunkedErrorHandler());
114         httpServer.start();
115         return httpServer;
116     }
117 
118     static abstract class AbstractHandler implements HttpHandler {
119         @Override
120         public void handle(HttpExchange t) throws IOException {
121             try (InputStream is = t.getRequestBody()) {
122                 while (is.read() != -1);
123             }
124             t.sendResponseHeaders(respCode(), length());
125             try (OutputStream os = t.getResponseBody()) {
126                 os.write(message());
127             }
128             t.close();
129         }
</pre>
</td>
</tr>
</table>
<center><a href="HttpOnly.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Modified.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>