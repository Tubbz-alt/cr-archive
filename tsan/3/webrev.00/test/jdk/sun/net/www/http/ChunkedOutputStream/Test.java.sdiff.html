<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/http/ChunkedOutputStream/Test.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CheckError.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../HttpClient/B6726695.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/http/ChunkedOutputStream/Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 5026745 6631048
 27  * @modules jdk.httpserver

 28  * @run main/othervm/timeout=500 Test
 29  * @summary Cannot flush output stream when writing to an HttpUrlConnection
 30  */
 31 
 32 import java.io.*;
 33 import java.net.*;
 34 import com.sun.net.httpserver.*;
 35 


 36 public class Test implements HttpHandler {
 37 
 38     static volatile int count = 0;
 39 
 40     static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 41                                 &quot;1234567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;+
 42                                 &quot;1434567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;;
 43 
 44     static final String str2 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 45                                 &quot;1234567890&quot;;
 46 
 47     public void handle(HttpExchange exchange) {
 48         String reqbody;
 49         try {
 50             switch (exchange.getRequestURI().toString()) {
 51             case &quot;/test/test1&quot;: /* test1 -- keeps conn alive */
 52             case &quot;/test/test2&quot;: /* test2 -- closes conn */
 53                 printRequestURI(exchange);
 54                 reqbody = read(exchange.getRequestBody());
 55                 if (!reqbody.equals(str1)) {
</pre>
<hr />
<pre>
255         }
256     }
257 
258     static void readAndCompare(InputStream is, String cmp) throws IOException {
259         int c;
260         byte buf[] = new byte [1024];
261         int off = 0;
262         int len = 1024;
263         while ((c=is.read(buf, off, len)) != -1) {
264             off += c;
265             len -= c;
266         }
267         String s1 = new String(buf, 0, off, &quot;ISO8859_1&quot;);
268         if (!cmp.equals(s1)) {
269             throw new IOException(&quot;strings not same&quot;);
270         }
271     }
272 
273     /* basic chunked test (runs twice) */
274 
<span class="line-modified">275     static void test1 (String u) throws Exception {</span>
<span class="line-modified">276         URL url = new URL (u);</span>
<span class="line-removed">277         System.out.println (&quot;client opening connection to: &quot; + u);</span>
278         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
279         urlc.setChunkedStreamingMode (20);
280         urlc.setDoOutput(true);
281         urlc.setRequestMethod (&quot;POST&quot;);
282         OutputStream os = urlc.getOutputStream ();
283         os.write (str1.getBytes());
284         os.close();
285         InputStream is = urlc.getInputStream();
286         readAndCompare (is, str1);
287         is.close();
288     }
289 
290     /* basic fixed length test */
291 
<span class="line-modified">292     static void test3 (String u) throws Exception {</span>
<span class="line-modified">293         URL url = new URL (u);</span>
<span class="line-removed">294         System.out.println (&quot;client opening connection to: &quot; + u);</span>
295         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
296         urlc.setFixedLengthStreamingMode (str2.length());
297         urlc.setDoOutput(true);
298         urlc.setRequestMethod (&quot;POST&quot;);
299         OutputStream os = urlc.getOutputStream ();
300         os.write (str2.getBytes());
301         os.close();
302         InputStream is = urlc.getInputStream();
303         readAndCompare (is, str2);
304         is.close();
305     }
306 
307     /* write too few bytes */
308 
<span class="line-modified">309     static void test4 (String u) throws Exception {</span>
<span class="line-modified">310         URL url = new URL (u);</span>
<span class="line-removed">311         System.out.println (&quot;client opening connection to: &quot; + u);</span>
312         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
313         urlc.setFixedLengthStreamingMode (str2.length()+1);
314         urlc.setDoOutput(true);
315         urlc.setRequestMethod (&quot;POST&quot;);
316         OutputStream os = urlc.getOutputStream ();
317         os.write (str2.getBytes());
318         try {
319             os.close();
320             throw new Exception (&quot;should have thrown IOException&quot;);
321         } catch (IOException e) {}
322     }
323 
324     /* write too many bytes */
325 
<span class="line-modified">326     static void test5 (String u) throws Exception {</span>
<span class="line-modified">327         URL url = new URL (u);</span>
<span class="line-removed">328         System.out.println (&quot;client opening connection to: &quot; + u);</span>
329         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
330         urlc.setFixedLengthStreamingMode (str2.length()-1);
331         urlc.setDoOutput(true);
332         urlc.setRequestMethod (&quot;POST&quot;);
333         OutputStream os = urlc.getOutputStream ();
334         try {
335             os.write (str2.getBytes());
336             throw new Exception (&quot;should have thrown IOException&quot;);
337         } catch (IOException e) {}
338     }
339 
340     /* check for HttpRetryException on redirection */
341 
<span class="line-modified">342     static void test6 (String u) throws Exception {</span>
<span class="line-modified">343         URL url = new URL (u);</span>
<span class="line-removed">344         System.out.println (&quot;client opening connection to: &quot; + u);</span>
345         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
346         urlc.setChunkedStreamingMode (20);
347         urlc.setDoOutput(true);
348         urlc.setRequestMethod (&quot;POST&quot;);
349         OutputStream os = urlc.getOutputStream ();
350         os.write (str1.getBytes());
351         os.close();
352         try {
353             InputStream is = urlc.getInputStream();
354             throw new Exception (&quot;should have gotten HttpRetryException&quot;);
355         } catch (HttpRetryException e) {
356             if (e.responseCode() != 307) {
357                 throw new Exception (&quot;Wrong response code &quot; + e.responseCode());
358             }
359             if (!e.getLocation().equals (&quot;http://foo.bar/&quot;)) {
360                 throw new Exception (&quot;Wrong location &quot; + e.getLocation());
361             }
362         }
363     }
364 
365     /* next two tests send zero length posts */
366 
<span class="line-modified">367     static void test7 (String u) throws Exception {</span>
<span class="line-modified">368         URL url = new URL (u);</span>
<span class="line-removed">369         System.out.println (&quot;client opening connection to: &quot; + u);</span>
370         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
371         urlc.setChunkedStreamingMode (20);
372         urlc.setDoOutput(true);
373         urlc.setRequestMethod (&quot;POST&quot;);
374         OutputStream os = urlc.getOutputStream ();
375         os.close();
376         int ret = urlc.getResponseCode();
377         if (ret != 200) {
378             throw new Exception (&quot;Expected 200: got &quot; + ret);
379         }
380     }
381 
<span class="line-modified">382     static void test8 (String u) throws Exception {</span>
<span class="line-modified">383         URL url = new URL (u);</span>
<span class="line-removed">384         System.out.println (&quot;client opening connection to: &quot; + u);</span>
385         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
386         urlc.setFixedLengthStreamingMode (0);
387         urlc.setDoOutput(true);
388         urlc.setRequestMethod (&quot;POST&quot;);
389         OutputStream os = urlc.getOutputStream ();
390         os.close();
391         int ret = urlc.getResponseCode();
392         if (ret != 200) {
393             throw new Exception (&quot;Expected 200: got &quot; + ret);
394         }
395     }
396 
397     /* calling setChunkedStreamingMode with -1 should entail using
398        the default chunk size */
<span class="line-modified">399    static void test9 (String u) throws Exception {</span>
<span class="line-modified">400         URL url = new URL (u);</span>
<span class="line-removed">401         System.out.println (&quot;client opening connection to: &quot; + u);</span>
402         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
403         urlc.setChunkedStreamingMode (-1);
404         urlc.setDoOutput(true);
405         urlc.setRequestMethod (&quot;POST&quot;);
406         OutputStream os = urlc.getOutputStream ();
407         os.write (str1.getBytes());
408         os.close();
409         InputStream is = urlc.getInputStream();
410         readAndCompare (is, str1);
411         is.close();
412     }
413 
<span class="line-modified">414    static void test10 (String u) throws Exception {</span>
<span class="line-modified">415         URL url = new URL (u);</span>
<span class="line-removed">416         System.out.println (&quot;client opening connection to: &quot; + u);</span>
417         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
418         urlc.setChunkedStreamingMode (4 * 1024);
419         urlc.setDoOutput(true);
420         urlc.setRequestMethod (&quot;POST&quot;);
421         OutputStream os = urlc.getOutputStream ();
422         byte[] buf = new byte [200 * 1024];
423         for (int i=0; i&lt; 200 * 1024; i++) {
424             buf[i] = (byte) i;
425         }
426         /* write a small bit first, and then the large buffer */
427         os.write (str1.getBytes());
428         os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
429         os.close();
430         InputStream is = urlc.getInputStream();
431         is.close();
432         int ret = urlc.getResponseCode();
433         if (ret != 200) {
434             throw new Exception (&quot;Expected 200: got &quot; + ret);
435         }
436     }
437 
<span class="line-modified">438     static void test11 (String u) throws Exception {</span>
<span class="line-modified">439         URL url = new URL (u);</span>
<span class="line-removed">440         System.out.println (&quot;client opening connection to: &quot; + u);</span>
441         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
442         urlc.setChunkedStreamingMode (36 * 1024);
443         urlc.setDoOutput(true);
444         urlc.setRequestMethod (&quot;POST&quot;);
445         OutputStream os = urlc.getOutputStream ();
446         byte[] buf = new byte [30 * 1024];
447         for (int i=0; i&lt; 30 * 1024; i++) {
448             buf[i] = (byte) i;
449         }
450         /* write a small bit first, and then the large buffer */
451         os.write (str1.getBytes());
452         //os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
453         os.write (buf, 10, (10 * 1024) - 10);
454         os.write (buf, (10 * 1024), (10 * 1024));
455         os.write (buf, (20 * 1024), (10 * 1024));
456         os.close();
457         InputStream is = urlc.getInputStream();
458         is.close();
459         int ret = urlc.getResponseCode();
460         if (ret != 200) {
461             throw new Exception (&quot;Expected 200: got &quot; + ret);
462         }
463     }
464 
<span class="line-modified">465     static void test12 (String u) throws Exception {</span>
<span class="line-modified">466         URL url = new URL (u);</span>
<span class="line-removed">467         System.out.println (&quot;client opening connection to: &quot; + u);</span>
468         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
469         urlc.setChunkedStreamingMode (36 * 1024);
470         urlc.setDoOutput(true);
471         urlc.setRequestMethod (&quot;POST&quot;);
472         OutputStream os = urlc.getOutputStream ();
473         byte[] buf = new byte [30 * 1024];
474         for (int i=0; i&lt; 30 * 1024; i++) {
475             buf[i] = (byte) i;
476         }
477         os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
478         os.close();
479         InputStream is = urlc.getInputStream();
480         is.close();
481         int ret = urlc.getResponseCode();
482         if (ret != 200) {
483             throw new Exception (&quot;Expected 200: got &quot; + ret);
484         }
485     }
486 
487 
<span class="line-modified">488     static com.sun.net.httpserver.HttpServer httpserver;</span>










489 
490     public static void main (String[] args) throws Exception {
491         try {
<span class="line-modified">492             httpserver = com.sun.net.httpserver.HttpServer.create(new InetSocketAddress(0), 0);</span>
<span class="line-modified">493             HttpContext ctx = httpserver.createContext(&quot;/test/&quot;, new Test() );</span>
494             httpserver.start();
495 
496             int port = httpserver.getAddress().getPort();
497 
498             System.out.println (&quot;Server started: listening on port: &quot; + port);
<span class="line-modified">499             test1(&quot;http://localhost:&quot;+ port + &quot;/test/test1&quot;);</span>
<span class="line-modified">500             test1(&quot;http://localhost:&quot;+ port + &quot;/test/test2&quot;);</span>
<span class="line-modified">501             test3(&quot;http://localhost:&quot;+ port + &quot;/test/test3&quot;);</span>
<span class="line-modified">502             test4(&quot;http://localhost:&quot;+ port + &quot;/test/test4&quot;);</span>
<span class="line-modified">503             test5(&quot;http://localhost:&quot;+ port + &quot;/test/test5&quot;);</span>
<span class="line-modified">504             test6(&quot;http://localhost:&quot;+ port + &quot;/test/test6&quot;);</span>
<span class="line-modified">505             test7(&quot;http://localhost:&quot;+ port + &quot;/test/test7&quot;);</span>
<span class="line-modified">506             test8(&quot;http://localhost:&quot;+ port + &quot;/test/test8&quot;);</span>
<span class="line-modified">507             test9(&quot;http://localhost:&quot;+ port + &quot;/test/test9&quot;);</span>
<span class="line-modified">508             test10(&quot;http://localhost:&quot;+ port + &quot;/test/test10&quot;);</span>
<span class="line-modified">509             test11(&quot;http://localhost:&quot;+ port + &quot;/test/test11&quot;);</span>
<span class="line-modified">510             test12(&quot;http://localhost:&quot;+ port + &quot;/test/test12&quot;);</span>
511         } finally {
512             if (httpserver != null)
513                 httpserver.stop(0);
514         }
515     }
516 
517 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 5026745 6631048
 27  * @modules jdk.httpserver
<span class="line-added"> 28  * @library /test/lib</span>
 29  * @run main/othervm/timeout=500 Test
 30  * @summary Cannot flush output stream when writing to an HttpUrlConnection
 31  */
 32 
 33 import java.io.*;
 34 import java.net.*;
 35 import com.sun.net.httpserver.*;
 36 
<span class="line-added"> 37 import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added"> 38 </span>
 39 public class Test implements HttpHandler {
 40 
 41     static volatile int count = 0;
 42 
 43     static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 44                                 &quot;1234567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;+
 45                                 &quot;1434567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;;
 46 
 47     static final String str2 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 48                                 &quot;1234567890&quot;;
 49 
 50     public void handle(HttpExchange exchange) {
 51         String reqbody;
 52         try {
 53             switch (exchange.getRequestURI().toString()) {
 54             case &quot;/test/test1&quot;: /* test1 -- keeps conn alive */
 55             case &quot;/test/test2&quot;: /* test2 -- closes conn */
 56                 printRequestURI(exchange);
 57                 reqbody = read(exchange.getRequestBody());
 58                 if (!reqbody.equals(str1)) {
</pre>
<hr />
<pre>
258         }
259     }
260 
261     static void readAndCompare(InputStream is, String cmp) throws IOException {
262         int c;
263         byte buf[] = new byte [1024];
264         int off = 0;
265         int len = 1024;
266         while ((c=is.read(buf, off, len)) != -1) {
267             off += c;
268             len -= c;
269         }
270         String s1 = new String(buf, 0, off, &quot;ISO8859_1&quot;);
271         if (!cmp.equals(s1)) {
272             throw new IOException(&quot;strings not same&quot;);
273         }
274     }
275 
276     /* basic chunked test (runs twice) */
277 
<span class="line-modified">278     static void test1(URL url) throws Exception {</span>
<span class="line-modified">279         System.out.println(&quot;client opening connection to: &quot; + url);</span>

280         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
281         urlc.setChunkedStreamingMode (20);
282         urlc.setDoOutput(true);
283         urlc.setRequestMethod (&quot;POST&quot;);
284         OutputStream os = urlc.getOutputStream ();
285         os.write (str1.getBytes());
286         os.close();
287         InputStream is = urlc.getInputStream();
288         readAndCompare (is, str1);
289         is.close();
290     }
291 
292     /* basic fixed length test */
293 
<span class="line-modified">294     static void test3(URL url) throws Exception {</span>
<span class="line-modified">295         System.out.println(&quot;client opening connection to: &quot; + url);</span>

296         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
297         urlc.setFixedLengthStreamingMode (str2.length());
298         urlc.setDoOutput(true);
299         urlc.setRequestMethod (&quot;POST&quot;);
300         OutputStream os = urlc.getOutputStream ();
301         os.write (str2.getBytes());
302         os.close();
303         InputStream is = urlc.getInputStream();
304         readAndCompare (is, str2);
305         is.close();
306     }
307 
308     /* write too few bytes */
309 
<span class="line-modified">310     static void test4(URL url) throws Exception {</span>
<span class="line-modified">311         System.out.println(&quot;client opening connection to: &quot; + url);</span>

312         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
313         urlc.setFixedLengthStreamingMode (str2.length()+1);
314         urlc.setDoOutput(true);
315         urlc.setRequestMethod (&quot;POST&quot;);
316         OutputStream os = urlc.getOutputStream ();
317         os.write (str2.getBytes());
318         try {
319             os.close();
320             throw new Exception (&quot;should have thrown IOException&quot;);
321         } catch (IOException e) {}
322     }
323 
324     /* write too many bytes */
325 
<span class="line-modified">326     static void test5(URL url) throws Exception {</span>
<span class="line-modified">327         System.out.println(&quot;client opening connection to: &quot; + url);</span>

328         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
329         urlc.setFixedLengthStreamingMode (str2.length()-1);
330         urlc.setDoOutput(true);
331         urlc.setRequestMethod (&quot;POST&quot;);
332         OutputStream os = urlc.getOutputStream ();
333         try {
334             os.write (str2.getBytes());
335             throw new Exception (&quot;should have thrown IOException&quot;);
336         } catch (IOException e) {}
337     }
338 
339     /* check for HttpRetryException on redirection */
340 
<span class="line-modified">341     static void test6(URL url) throws Exception {</span>
<span class="line-modified">342         System.out.println(&quot;client opening connection to: &quot; + url);</span>

343         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
344         urlc.setChunkedStreamingMode (20);
345         urlc.setDoOutput(true);
346         urlc.setRequestMethod (&quot;POST&quot;);
347         OutputStream os = urlc.getOutputStream ();
348         os.write (str1.getBytes());
349         os.close();
350         try {
351             InputStream is = urlc.getInputStream();
352             throw new Exception (&quot;should have gotten HttpRetryException&quot;);
353         } catch (HttpRetryException e) {
354             if (e.responseCode() != 307) {
355                 throw new Exception (&quot;Wrong response code &quot; + e.responseCode());
356             }
357             if (!e.getLocation().equals (&quot;http://foo.bar/&quot;)) {
358                 throw new Exception (&quot;Wrong location &quot; + e.getLocation());
359             }
360         }
361     }
362 
363     /* next two tests send zero length posts */
364 
<span class="line-modified">365     static void test7(URL url) throws Exception {</span>
<span class="line-modified">366         System.out.println(&quot;client opening connection to: &quot; + url);</span>

367         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
368         urlc.setChunkedStreamingMode (20);
369         urlc.setDoOutput(true);
370         urlc.setRequestMethod (&quot;POST&quot;);
371         OutputStream os = urlc.getOutputStream ();
372         os.close();
373         int ret = urlc.getResponseCode();
374         if (ret != 200) {
375             throw new Exception (&quot;Expected 200: got &quot; + ret);
376         }
377     }
378 
<span class="line-modified">379     static void test8(URL url) throws Exception {</span>
<span class="line-modified">380         System.out.println(&quot;client opening connection to: &quot; + url);</span>

381         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
382         urlc.setFixedLengthStreamingMode (0);
383         urlc.setDoOutput(true);
384         urlc.setRequestMethod (&quot;POST&quot;);
385         OutputStream os = urlc.getOutputStream ();
386         os.close();
387         int ret = urlc.getResponseCode();
388         if (ret != 200) {
389             throw new Exception (&quot;Expected 200: got &quot; + ret);
390         }
391     }
392 
393     /* calling setChunkedStreamingMode with -1 should entail using
394        the default chunk size */
<span class="line-modified">395     static void test9(URL url) throws Exception {</span>
<span class="line-modified">396         System.out.println(&quot;client opening connection to: &quot; + url);</span>

397         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
398         urlc.setChunkedStreamingMode (-1);
399         urlc.setDoOutput(true);
400         urlc.setRequestMethod (&quot;POST&quot;);
401         OutputStream os = urlc.getOutputStream ();
402         os.write (str1.getBytes());
403         os.close();
404         InputStream is = urlc.getInputStream();
405         readAndCompare (is, str1);
406         is.close();
407     }
408 
<span class="line-modified">409     static void test10(URL url) throws Exception {</span>
<span class="line-modified">410         System.out.println(&quot;client opening connection to: &quot; + url);</span>

411         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
412         urlc.setChunkedStreamingMode (4 * 1024);
413         urlc.setDoOutput(true);
414         urlc.setRequestMethod (&quot;POST&quot;);
415         OutputStream os = urlc.getOutputStream ();
416         byte[] buf = new byte [200 * 1024];
417         for (int i=0; i&lt; 200 * 1024; i++) {
418             buf[i] = (byte) i;
419         }
420         /* write a small bit first, and then the large buffer */
421         os.write (str1.getBytes());
422         os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
423         os.close();
424         InputStream is = urlc.getInputStream();
425         is.close();
426         int ret = urlc.getResponseCode();
427         if (ret != 200) {
428             throw new Exception (&quot;Expected 200: got &quot; + ret);
429         }
430     }
431 
<span class="line-modified">432     static void test11(URL url) throws Exception {</span>
<span class="line-modified">433         System.out.println(&quot;client opening connection to: &quot; + url);</span>

434         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
435         urlc.setChunkedStreamingMode (36 * 1024);
436         urlc.setDoOutput(true);
437         urlc.setRequestMethod (&quot;POST&quot;);
438         OutputStream os = urlc.getOutputStream ();
439         byte[] buf = new byte [30 * 1024];
440         for (int i=0; i&lt; 30 * 1024; i++) {
441             buf[i] = (byte) i;
442         }
443         /* write a small bit first, and then the large buffer */
444         os.write (str1.getBytes());
445         //os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
446         os.write (buf, 10, (10 * 1024) - 10);
447         os.write (buf, (10 * 1024), (10 * 1024));
448         os.write (buf, (20 * 1024), (10 * 1024));
449         os.close();
450         InputStream is = urlc.getInputStream();
451         is.close();
452         int ret = urlc.getResponseCode();
453         if (ret != 200) {
454             throw new Exception (&quot;Expected 200: got &quot; + ret);
455         }
456     }
457 
<span class="line-modified">458     static void test12(URL url) throws Exception {</span>
<span class="line-modified">459         System.out.println(&quot;client opening connection to: &quot; + url);</span>

460         HttpURLConnection urlc = (HttpURLConnection)url.openConnection ();
461         urlc.setChunkedStreamingMode (36 * 1024);
462         urlc.setDoOutput(true);
463         urlc.setRequestMethod (&quot;POST&quot;);
464         OutputStream os = urlc.getOutputStream ();
465         byte[] buf = new byte [30 * 1024];
466         for (int i=0; i&lt; 30 * 1024; i++) {
467             buf[i] = (byte) i;
468         }
469         os.write (buf, 10, buf.length - 10); /* skip 10 bytes to test offset */
470         os.close();
471         InputStream is = urlc.getInputStream();
472         is.close();
473         int ret = urlc.getResponseCode();
474         if (ret != 200) {
475             throw new Exception (&quot;Expected 200: got &quot; + ret);
476         }
477     }
478 
479 
<span class="line-modified">480     static HttpServer httpserver;</span>
<span class="line-added">481 </span>
<span class="line-added">482     private static URL buildTestURL(int port, String path)</span>
<span class="line-added">483             throws MalformedURLException, URISyntaxException {</span>
<span class="line-added">484         return URIBuilder.newBuilder()</span>
<span class="line-added">485                 .scheme(&quot;http&quot;)</span>
<span class="line-added">486                 .loopback()</span>
<span class="line-added">487                 .port(port)</span>
<span class="line-added">488                 .path(path)</span>
<span class="line-added">489                 .toURL();</span>
<span class="line-added">490     }</span>
491 
492     public static void main (String[] args) throws Exception {
493         try {
<span class="line-modified">494             httpserver = HttpServer.create(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0), 0);</span>
<span class="line-modified">495             httpserver.createContext(&quot;/test/&quot;, new Test());</span>
496             httpserver.start();
497 
498             int port = httpserver.getAddress().getPort();
499 
500             System.out.println (&quot;Server started: listening on port: &quot; + port);
<span class="line-modified">501             test1(buildTestURL(port, &quot;/test/test1&quot;));</span>
<span class="line-modified">502             test1(buildTestURL(port, &quot;/test/test2&quot;));</span>
<span class="line-modified">503             test3(buildTestURL(port, &quot;/test/test3&quot;));</span>
<span class="line-modified">504             test4(buildTestURL(port, &quot;/test/test4&quot;));</span>
<span class="line-modified">505             test5(buildTestURL(port, &quot;/test/test5&quot;));</span>
<span class="line-modified">506             test6(buildTestURL(port, &quot;/test/test6&quot;));</span>
<span class="line-modified">507             test7(buildTestURL(port, &quot;/test/test7&quot;));</span>
<span class="line-modified">508             test8(buildTestURL(port, &quot;/test/test8&quot;));</span>
<span class="line-modified">509             test9(buildTestURL(port, &quot;/test/test9&quot;));</span>
<span class="line-modified">510             test10(buildTestURL(port, &quot;/test/test10&quot;));</span>
<span class="line-modified">511             test11(buildTestURL(port, &quot;/test/test11&quot;));</span>
<span class="line-modified">512             test12(buildTestURL(port, &quot;/test/test12&quot;));</span>
513         } finally {
514             if (httpserver != null)
515                 httpserver.stop(0);
516         }
517     }
518 
519 }
</pre>
</td>
</tr>
</table>
<center><a href="CheckError.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../HttpClient/B6726695.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>