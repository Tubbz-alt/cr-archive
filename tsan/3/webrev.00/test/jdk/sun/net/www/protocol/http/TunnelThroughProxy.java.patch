diff a/test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java b/test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java
--- a/test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java
+++ b/test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java
@@ -58,17 +58,18 @@
 
     static void getLocalPortTest() throws Exception {
         ProxyTunnelServer proxy = setupProxy(true);
         try {
             int proxyPort = proxy.getPort();
-            ServerSocket server = new ServerSocket(0);
+            InetAddress proxyAddress = proxy.getInetAddress();
+            ServerSocket server = new ServerSocket(0, 0, InetAddress.getLoopbackAddress());
             int serverPort = server.getLocalPort();
 
             Socket sock;
             sock = new Socket(new Proxy(Proxy.Type.HTTP,
-                    new InetSocketAddress(InetAddress.getLoopbackAddress(), proxyPort)));
-            InetSocketAddress dest = new InetSocketAddress(InetAddress.getLoopbackAddress(), serverPort);
+                    new InetSocketAddress(proxyAddress, proxyPort)));
+            InetSocketAddress dest = new InetSocketAddress(server.getInetAddress(), serverPort);
             sock.connect(dest);
             int localPort = sock.getLocalPort();
             if (localPort == proxyPort)
                 throw new RuntimeException("Fail: socket has wrong local port");
             // check that tunnel really works
@@ -82,17 +83,20 @@
             proxy.terminate();
         }
     }
 
     static ProxyTunnelServer setupProxy(boolean makeTunnel) throws IOException {
-        ProxyTunnelServer pserver = new ProxyTunnelServer();
+        InetAddress proxyAddress = InetAddress.getLoopbackAddress();
+        ProxyTunnelServer pserver = new ProxyTunnelServer(proxyAddress);
         pserver.doTunnel(makeTunnel);
         int proxyPort = pserver.getPort();
 
         // disable proxy authentication
         pserver.needUserAuth(false);
         pserver.start();
-        System.setProperty("https.proxyHost", "localhost");
+        System.out.printf("Setting https.proxyHost='%s'%n", proxyAddress.getHostAddress());
+        System.setProperty("https.proxyHost", proxyAddress.getHostAddress());
+        System.out.printf("Setting https.proxyPort='%s'%n", String.valueOf(proxyPort));
         System.setProperty("https.proxyPort", String.valueOf(proxyPort));
         return pserver;
     }
 }
