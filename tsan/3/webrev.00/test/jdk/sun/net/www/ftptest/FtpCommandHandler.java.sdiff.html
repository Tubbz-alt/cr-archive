<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/ftptest/FtpCommandHandler.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../AuthHeaderTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FtpServer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/ftptest/FtpCommandHandler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
221             out.println(&quot;500 &#39;&quot; + arg + &quot;&#39;: command not understood.&quot;);
222             return;
223         }
224         try {
225             dataAddress = InetAddress.getByName(m.group(2));
226         } catch (UnknownHostException e) {
227             out.println(&quot;500 &quot; + arg + &quot;: invalid address.&quot;);
228             dataAddress = null;
229             return;
230         }
231         dataPort = Integer.parseInt(m.group(3));
232         out.println(&quot;200 Command okay.&quot;);
233     }
234 
235     private void doPasv() {
236         if (!pasvEnabled) {
237             out.println(&quot;500 PASV is disabled, use PORT.&quot;);
238             return;
239         }
240         try {
<span class="line-removed">241             if (pasv == null)</span>
<span class="line-removed">242                 pasv = new ServerSocket(0);</span>
<span class="line-removed">243             int port = pasv.getLocalPort();</span>
244             InetAddress rAddress = cmd.getLocalAddress();
245             if (rAddress instanceof Inet6Address) {
246                 out.println(&quot;500 PASV illegal over IPv6 addresses, use EPSV.&quot;);
247                 return;
248             }



249             byte[] a = rAddress.getAddress();
250             out.println(&quot;227 Entering Passive Mode &quot; + a[0] + &quot;,&quot; + a[1] + &quot;,&quot; + a[2] + &quot;,&quot; + a[3] + &quot;,&quot; +
251                         (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) );
252         } catch (IOException e) {
253             out.println(&quot;425 can&#39;t build data connection: Connection refused.&quot;);
254         }
255     }
256 
257     private void doEpsv(String arg) {
258         if (!extendedEnabled || !pasvEnabled) {
259             out.println(&quot;500 EPSV disabled, use PORT or PASV.&quot;);
260             return;
261         }
262         if (&quot;all&quot;.equalsIgnoreCase(arg)) {
263             out.println(&quot;200 EPSV ALL Command successful.&quot;);
264             epsvAll = true;
265             return;
266         }
267         try {
268             if (pasv == null)
<span class="line-modified">269                 pasv = new ServerSocket(0);</span>
270             int port = pasv.getLocalPort();
271             out.println(&quot;229 Entering Extended Passive Mode (|||&quot; + port + &quot;|)&quot;);
272         } catch (IOException e) {
273             out.println(&quot;500 Can&#39;t create data connection.&quot;);
274         }
275     }
276 
277     private void doRetr(String arg) {
278         try {
279             OutputStream dOut = getOutDataStream();
280             if (dOut != null) {
281                 InputStream dIn = fsh.getFile(arg);
282                 if (dIn == null) {
283                     out.println(&quot;550 File not found.&quot;);
284                     dOut.close();
285                     return;
286                 }
287                 out.println(&quot;150 Opening &quot; + (binary ? &quot;BINARY &quot; : &quot;ASCII &quot;) + &quot; data connection for file &quot; + arg +
288                             &quot;(&quot; + fsh.getFileSize(arg) + &quot; bytes).&quot;);
289                 if (binary) {
</pre>
<hr />
<pre>
449             // sequence), otherwise it will affect normal ftp tests which depends
450             // on this.
451             out.println(&quot;---------------------------------\n220 Java FTP test server&quot;
452                     + &quot; (j2se 6.0) ready.\n \n   -            Please send commands\n&quot;
453                     + &quot;-----------------------------\n\n\n&quot;);
454             out.flush();
455             if (auth.authType() == 0) // No auth needed
456                 logged = true;
457         } catch (IOException e) {
458             e.printStackTrace();
459             return;
460         }
461 
462         String str;
463         StringBuffer buf;
464         int res;
465         while (!done) {
466             try {
467                 str = in.readLine();
468                 System.out.println(&quot;line: &quot; + str);




469                 buf = new StringBuffer(str);
470                 res = parseCmd(buf);
471                 switch (res) {
472                 case ERROR:
473                     out.println(&quot;500 &#39;&quot; + str +&quot;&#39;: command not understood.&quot;);
474                     break;
475                 case QUIT:
476                     out.println(&quot;221 Goodbye.&quot;);
477                     done = true;
478                     break;
479                 case USER:
480                     logged = false;
481                     username = buf.toString();
482                     if (auth.authType() &gt; 1)
483                         out.println(&quot;331 User name okay, need password.&quot;);
484                     else {
485                         if (auth.authenticate(username, null)) {
486                             out.println(&quot;230 User logged in, proceed.&quot;);
487                             logged = true;
488                         } else {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
221             out.println(&quot;500 &#39;&quot; + arg + &quot;&#39;: command not understood.&quot;);
222             return;
223         }
224         try {
225             dataAddress = InetAddress.getByName(m.group(2));
226         } catch (UnknownHostException e) {
227             out.println(&quot;500 &quot; + arg + &quot;: invalid address.&quot;);
228             dataAddress = null;
229             return;
230         }
231         dataPort = Integer.parseInt(m.group(3));
232         out.println(&quot;200 Command okay.&quot;);
233     }
234 
235     private void doPasv() {
236         if (!pasvEnabled) {
237             out.println(&quot;500 PASV is disabled, use PORT.&quot;);
238             return;
239         }
240         try {



241             InetAddress rAddress = cmd.getLocalAddress();
242             if (rAddress instanceof Inet6Address) {
243                 out.println(&quot;500 PASV illegal over IPv6 addresses, use EPSV.&quot;);
244                 return;
245             }
<span class="line-added">246             if (pasv == null)</span>
<span class="line-added">247                 pasv = new ServerSocket(0, 0, rAddress);</span>
<span class="line-added">248             int port = pasv.getLocalPort();</span>
249             byte[] a = rAddress.getAddress();
250             out.println(&quot;227 Entering Passive Mode &quot; + a[0] + &quot;,&quot; + a[1] + &quot;,&quot; + a[2] + &quot;,&quot; + a[3] + &quot;,&quot; +
251                         (port &gt;&gt; 8) + &quot;,&quot; + (port &amp; 0xff) );
252         } catch (IOException e) {
253             out.println(&quot;425 can&#39;t build data connection: Connection refused.&quot;);
254         }
255     }
256 
257     private void doEpsv(String arg) {
258         if (!extendedEnabled || !pasvEnabled) {
259             out.println(&quot;500 EPSV disabled, use PORT or PASV.&quot;);
260             return;
261         }
262         if (&quot;all&quot;.equalsIgnoreCase(arg)) {
263             out.println(&quot;200 EPSV ALL Command successful.&quot;);
264             epsvAll = true;
265             return;
266         }
267         try {
268             if (pasv == null)
<span class="line-modified">269                 pasv = new ServerSocket(0, 0, parent.getInetAddress());</span>
270             int port = pasv.getLocalPort();
271             out.println(&quot;229 Entering Extended Passive Mode (|||&quot; + port + &quot;|)&quot;);
272         } catch (IOException e) {
273             out.println(&quot;500 Can&#39;t create data connection.&quot;);
274         }
275     }
276 
277     private void doRetr(String arg) {
278         try {
279             OutputStream dOut = getOutDataStream();
280             if (dOut != null) {
281                 InputStream dIn = fsh.getFile(arg);
282                 if (dIn == null) {
283                     out.println(&quot;550 File not found.&quot;);
284                     dOut.close();
285                     return;
286                 }
287                 out.println(&quot;150 Opening &quot; + (binary ? &quot;BINARY &quot; : &quot;ASCII &quot;) + &quot; data connection for file &quot; + arg +
288                             &quot;(&quot; + fsh.getFileSize(arg) + &quot; bytes).&quot;);
289                 if (binary) {
</pre>
<hr />
<pre>
449             // sequence), otherwise it will affect normal ftp tests which depends
450             // on this.
451             out.println(&quot;---------------------------------\n220 Java FTP test server&quot;
452                     + &quot; (j2se 6.0) ready.\n \n   -            Please send commands\n&quot;
453                     + &quot;-----------------------------\n\n\n&quot;);
454             out.flush();
455             if (auth.authType() == 0) // No auth needed
456                 logged = true;
457         } catch (IOException e) {
458             e.printStackTrace();
459             return;
460         }
461 
462         String str;
463         StringBuffer buf;
464         int res;
465         while (!done) {
466             try {
467                 str = in.readLine();
468                 System.out.println(&quot;line: &quot; + str);
<span class="line-added">469                 if (str == null) {</span>
<span class="line-added">470                     System.out.println(&quot;EOF read from input&quot;);</span>
<span class="line-added">471                     break;</span>
<span class="line-added">472                 }</span>
473                 buf = new StringBuffer(str);
474                 res = parseCmd(buf);
475                 switch (res) {
476                 case ERROR:
477                     out.println(&quot;500 &#39;&quot; + str +&quot;&#39;: command not understood.&quot;);
478                     break;
479                 case QUIT:
480                     out.println(&quot;221 Goodbye.&quot;);
481                     done = true;
482                     break;
483                 case USER:
484                     logged = false;
485                     username = buf.toString();
486                     if (auth.authType() &gt; 1)
487                         out.println(&quot;331 User name okay, need password.&quot;);
488                     else {
489                         if (auth.authenticate(username, null)) {
490                             out.println(&quot;230 User logged in, proceed.&quot;);
491                             logged = true;
492                         } else {
</pre>
</td>
</tr>
</table>
<center><a href="../AuthHeaderTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FtpServer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>