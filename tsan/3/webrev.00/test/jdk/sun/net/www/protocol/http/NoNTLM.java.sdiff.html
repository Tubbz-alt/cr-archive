<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/http/NoNTLM.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="NoCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/NoNTLM.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8004502

 26  * @summary Sanity check that NTLM will not be selected by the http protocol
 27  *    handler when running on a profile that does not support NTLM
 28  * @modules java.base/sun.net.www
 29  *          java.base/sun.net.www.protocol.http:open
 30  * @run main/othervm NoNTLM

 31  */
 32 
 33 import java.io.IOException;
 34 import java.lang.reflect.Field;
 35 import java.net.Authenticator;
 36 import java.net.HttpURLConnection;

 37 import java.net.PasswordAuthentication;
 38 import java.net.Proxy;
 39 import java.net.ServerSocket;
 40 import java.net.Socket;
 41 import java.net.URL;

 42 import sun.net.www.MessageHeader;
 43 
 44 public class NoNTLM {
 45 
 46     static final String CRLF = &quot;\r\n&quot;;
 47 
 48     static final String OKAY =
 49         &quot;HTTP/1.1 200&quot; + CRLF +
 50         &quot;Content-Length: 0&quot; + CRLF +
 51         &quot;Connection: close&quot; + CRLF +
 52         CRLF;
 53 
 54     static class Client implements Runnable {
 55         private final URL url;
 56         private volatile IOException ioe;
 57         private volatile int respCode;
 58 
 59         Client(int port) throws IOException {
<span class="line-modified"> 60             this.url = new URL(&quot;http://127.0.0.1:&quot; + port + &quot;/foo.html&quot;);</span>






 61         }
 62 
 63         public void run() {
 64             try {
 65                 HttpURLConnection uc =
 66                     (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);
 67                 try {
 68                     uc.getInputStream();
 69                 } catch (IOException x) {
 70                     respCode = uc.getResponseCode();
 71                     throw x;
 72                 }
 73                 uc.disconnect();
 74             } catch (IOException x) {
 75                 if (respCode == 0)
 76                     respCode = -1;
 77                 ioe = x;
 78             }
 79         }
 80 
</pre>
<hr />
<pre>
129      * in the WWW-Authenticate header.
130      */
131     static void test(String... schemes) throws IOException {
132 
133         // the authentication scheme that the client is expected to choose
134         String expected = null;
135         for (String s: schemes) {
136             if (expected == null) {
137                 expected = s;
138             } else if (s.equals(&quot;Digest&quot;)) {
139                 expected = s;
140             }
141         }
142 
143         // server reply
144         String reply = authReplyFor(schemes);
145 
146         System.out.println(&quot;====================================&quot;);
147         System.out.println(&quot;Expect client to choose: &quot; + expected);
148         System.out.println(reply);
<span class="line-modified">149 </span>
<span class="line-modified">150         try (ServerSocket ss = new ServerSocket(0)) {</span>
151             Client.start(ss.getLocalPort());
152 
153             // client ---- GET ---&gt; server
154             // client &lt;--- 401 ---- server
155             try (Socket s = ss.accept()) {
156                 new MessageHeader().parseHeader(s.getInputStream());
157                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
158             }
159 
160             // client ---- GET ---&gt; server
161             // client &lt;--- 200 ---- server
162             String auth;
163             try (Socket s = ss.accept()) {
164                 MessageHeader mh = new MessageHeader();
165                 mh.parseHeader(s.getInputStream());
166                 s.getOutputStream().write(OKAY.getBytes(&quot;US-ASCII&quot;));
167                 auth = mh.findValue(&quot;Authorization&quot;);
168             }
169 
170             // check Authorization header
</pre>
<hr />
<pre>
172                 throw new RuntimeException(&quot;Authorization header not found&quot;);
173             System.out.println(&quot;Server received Authorization header: &quot; + auth);
174             String[] values = auth.split(&quot; &quot;);
175             if (!values[0].equals(expected))
176                 throw new RuntimeException(&quot;Unexpected value&quot;);
177         }
178     }
179 
180     /**
181      * Test the http protocol handler with one WWW-Authenticate header with
182      * the value &quot;NTLM&quot;.
183      */
184     static void testNTLM() throws Exception {
185         // server reply
186         String reply = authReplyFor(&quot;NTLM&quot;);
187 
188         System.out.println(&quot;====================================&quot;);
189         System.out.println(&quot;Expect client to fail with 401 Unauthorized&quot;);
190         System.out.println(reply);
191 
<span class="line-modified">192         try (ServerSocket ss = new ServerSocket(0)) {</span>

193             Client client = new Client(ss.getLocalPort());
194             Thread thr = new Thread(client);
195             thr.start();
196 
197             // client ---- GET ---&gt; server
198             // client &lt;--- 401 ---- client
199             try (Socket s = ss.accept()) {
200                 new MessageHeader().parseHeader(s.getInputStream());
201                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
202             }
203 
204             // the client should fail with 401
205             System.out.println(&quot;Waiting for client to terminate&quot;);
206             thr.join();
207             IOException ioe = client.ioException();
208             if (ioe != null)
209                 System.out.println(&quot;Client failed: &quot; + ioe);
210             int respCode = client.respCode();
211             if (respCode != 0 &amp;&amp; respCode != -1)
212                 System.out.println(&quot;Client received HTTP response code: &quot; + respCode);
213             if (respCode != HttpURLConnection.HTTP_UNAUTHORIZED)
214                 throw new RuntimeException(&quot;Unexpected response code&quot;);
215         }
216     }
217 
218     public static void main(String[] args) throws Exception {

219         try {
220             Class&lt;?&gt; ntlmProxyClass = Class.forName(&quot;sun.net.www.protocol.http.NTLMAuthenticationProxy&quot;, true, NoNTLM.class.getClassLoader());
221             Field ntlmSupportedField = ntlmProxyClass.getDeclaredField(&quot;supported&quot;);
222             ntlmSupportedField.setAccessible(true);
223             if (ntlmSupportedField.getBoolean(null)) {
<span class="line-modified">224                 System.out.println(&quot;NTLM is supported. Nothing to do. Exiting.&quot;);</span>
<span class="line-modified">225                 return;</span>
226             }
227         } catch (ClassNotFoundException okay) { }
228 
229         // setup Authenticator
230         Authenticator.setDefault(new Authenticator() {
231             @Override
232             protected PasswordAuthentication getPasswordAuthentication() {
233                 return new PasswordAuthentication(&quot;user&quot;, &quot;pass&quot;.toCharArray());
234             }
235         });
236 
237         // test combinations of authentication schemes
238         test(&quot;Basic&quot;);
239         test(&quot;Digest&quot;);
240         test(&quot;Basic&quot;, &quot;Digest&quot;);
<span class="line-modified">241         test(&quot;Basic&quot;, &quot;NTLM&quot;);</span>







242         test(&quot;Digest&quot;, &quot;NTLM&quot;);
243         test(&quot;Basic&quot;, &quot;Digest&quot;, &quot;NTLM&quot;);
244 
<span class="line-modified">245         // test NTLM only, this should fail with &quot;401 Unauthorized&quot;</span>
<span class="line-modified">246         testNTLM();</span>





247 
248         System.out.println();
249         System.out.println(&quot;TEST PASSED&quot;);
250     }
251 }
<span class="line-removed">252 </span>
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8004502
<span class="line-added"> 26  * @library /test/lib</span>
 27  * @summary Sanity check that NTLM will not be selected by the http protocol
 28  *    handler when running on a profile that does not support NTLM
 29  * @modules java.base/sun.net.www
 30  *          java.base/sun.net.www.protocol.http:open
 31  * @run main/othervm NoNTLM
<span class="line-added"> 32  * @run main/othervm -Djava.net.preferIPv6Addresses=true NoNTLM</span>
 33  */
 34 
 35 import java.io.IOException;
 36 import java.lang.reflect.Field;
 37 import java.net.Authenticator;
 38 import java.net.HttpURLConnection;
<span class="line-added"> 39 import java.net.InetAddress;</span>
 40 import java.net.PasswordAuthentication;
 41 import java.net.Proxy;
 42 import java.net.ServerSocket;
 43 import java.net.Socket;
 44 import java.net.URL;
<span class="line-added"> 45 import jdk.test.lib.net.URIBuilder;</span>
 46 import sun.net.www.MessageHeader;
 47 
 48 public class NoNTLM {
 49 
 50     static final String CRLF = &quot;\r\n&quot;;
 51 
 52     static final String OKAY =
 53         &quot;HTTP/1.1 200&quot; + CRLF +
 54         &quot;Content-Length: 0&quot; + CRLF +
 55         &quot;Connection: close&quot; + CRLF +
 56         CRLF;
 57 
 58     static class Client implements Runnable {
 59         private final URL url;
 60         private volatile IOException ioe;
 61         private volatile int respCode;
 62 
 63         Client(int port) throws IOException {
<span class="line-modified"> 64             this.url = URIBuilder.newBuilder()</span>
<span class="line-added"> 65                 .scheme(&quot;http&quot;)</span>
<span class="line-added"> 66                 .loopback()</span>
<span class="line-added"> 67                 .port(port)</span>
<span class="line-added"> 68                 .path(&quot;/foo.html&quot;)</span>
<span class="line-added"> 69                 .toURLUnchecked();</span>
<span class="line-added"> 70             System.out.println(&quot;Client URL: &quot; + this.url);</span>
 71         }
 72 
 73         public void run() {
 74             try {
 75                 HttpURLConnection uc =
 76                     (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);
 77                 try {
 78                     uc.getInputStream();
 79                 } catch (IOException x) {
 80                     respCode = uc.getResponseCode();
 81                     throw x;
 82                 }
 83                 uc.disconnect();
 84             } catch (IOException x) {
 85                 if (respCode == 0)
 86                     respCode = -1;
 87                 ioe = x;
 88             }
 89         }
 90 
</pre>
<hr />
<pre>
139      * in the WWW-Authenticate header.
140      */
141     static void test(String... schemes) throws IOException {
142 
143         // the authentication scheme that the client is expected to choose
144         String expected = null;
145         for (String s: schemes) {
146             if (expected == null) {
147                 expected = s;
148             } else if (s.equals(&quot;Digest&quot;)) {
149                 expected = s;
150             }
151         }
152 
153         // server reply
154         String reply = authReplyFor(schemes);
155 
156         System.out.println(&quot;====================================&quot;);
157         System.out.println(&quot;Expect client to choose: &quot; + expected);
158         System.out.println(reply);
<span class="line-modified">159         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-modified">160         try (ServerSocket ss = new ServerSocket(0, 0, loopback)) {</span>
161             Client.start(ss.getLocalPort());
162 
163             // client ---- GET ---&gt; server
164             // client &lt;--- 401 ---- server
165             try (Socket s = ss.accept()) {
166                 new MessageHeader().parseHeader(s.getInputStream());
167                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
168             }
169 
170             // client ---- GET ---&gt; server
171             // client &lt;--- 200 ---- server
172             String auth;
173             try (Socket s = ss.accept()) {
174                 MessageHeader mh = new MessageHeader();
175                 mh.parseHeader(s.getInputStream());
176                 s.getOutputStream().write(OKAY.getBytes(&quot;US-ASCII&quot;));
177                 auth = mh.findValue(&quot;Authorization&quot;);
178             }
179 
180             // check Authorization header
</pre>
<hr />
<pre>
182                 throw new RuntimeException(&quot;Authorization header not found&quot;);
183             System.out.println(&quot;Server received Authorization header: &quot; + auth);
184             String[] values = auth.split(&quot; &quot;);
185             if (!values[0].equals(expected))
186                 throw new RuntimeException(&quot;Unexpected value&quot;);
187         }
188     }
189 
190     /**
191      * Test the http protocol handler with one WWW-Authenticate header with
192      * the value &quot;NTLM&quot;.
193      */
194     static void testNTLM() throws Exception {
195         // server reply
196         String reply = authReplyFor(&quot;NTLM&quot;);
197 
198         System.out.println(&quot;====================================&quot;);
199         System.out.println(&quot;Expect client to fail with 401 Unauthorized&quot;);
200         System.out.println(reply);
201 
<span class="line-modified">202         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">203         try (ServerSocket ss = new ServerSocket(0, 0, loopback)) {</span>
204             Client client = new Client(ss.getLocalPort());
205             Thread thr = new Thread(client);
206             thr.start();
207 
208             // client ---- GET ---&gt; server
209             // client &lt;--- 401 ---- client
210             try (Socket s = ss.accept()) {
211                 new MessageHeader().parseHeader(s.getInputStream());
212                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
213             }
214 
215             // the client should fail with 401
216             System.out.println(&quot;Waiting for client to terminate&quot;);
217             thr.join();
218             IOException ioe = client.ioException();
219             if (ioe != null)
220                 System.out.println(&quot;Client failed: &quot; + ioe);
221             int respCode = client.respCode();
222             if (respCode != 0 &amp;&amp; respCode != -1)
223                 System.out.println(&quot;Client received HTTP response code: &quot; + respCode);
224             if (respCode != HttpURLConnection.HTTP_UNAUTHORIZED)
225                 throw new RuntimeException(&quot;Unexpected response code&quot;);
226         }
227     }
228 
229     public static void main(String[] args) throws Exception {
<span class="line-added">230         boolean ntlmSupported = false;</span>
231         try {
232             Class&lt;?&gt; ntlmProxyClass = Class.forName(&quot;sun.net.www.protocol.http.NTLMAuthenticationProxy&quot;, true, NoNTLM.class.getClassLoader());
233             Field ntlmSupportedField = ntlmProxyClass.getDeclaredField(&quot;supported&quot;);
234             ntlmSupportedField.setAccessible(true);
235             if (ntlmSupportedField.getBoolean(null)) {
<span class="line-modified">236                 System.out.println(&quot;NTLM is supported.&quot;);</span>
<span class="line-modified">237                 ntlmSupported = true;</span>
238             }
239         } catch (ClassNotFoundException okay) { }
240 
241         // setup Authenticator
242         Authenticator.setDefault(new Authenticator() {
243             @Override
244             protected PasswordAuthentication getPasswordAuthentication() {
245                 return new PasswordAuthentication(&quot;user&quot;, &quot;pass&quot;.toCharArray());
246             }
247         });
248 
249         // test combinations of authentication schemes
250         test(&quot;Basic&quot;);
251         test(&quot;Digest&quot;);
252         test(&quot;Basic&quot;, &quot;Digest&quot;);
<span class="line-modified">253 </span>
<span class="line-added">254         if (ntlmSupported) {</span>
<span class="line-added">255             System.out.println(&quot;====================================&quot;);</span>
<span class="line-added">256             System.out.println(&quot;NTLM is supported: client would select NTLM: skipping `test(\&quot;Basic\&quot;, \&quot;NTLM\&quot;)`..&quot;);</span>
<span class="line-added">257         } else {</span>
<span class="line-added">258             test(&quot;Basic&quot;, &quot;NTLM&quot;);</span>
<span class="line-added">259         }</span>
<span class="line-added">260 </span>
261         test(&quot;Digest&quot;, &quot;NTLM&quot;);
262         test(&quot;Basic&quot;, &quot;Digest&quot;, &quot;NTLM&quot;);
263 
<span class="line-modified">264         if (ntlmSupported) {</span>
<span class="line-modified">265             System.out.println(&quot;====================================&quot;);</span>
<span class="line-added">266             System.out.println(&quot;NTLM is supported: client would select NTLM: skipping `testNTLM()`..&quot;);</span>
<span class="line-added">267         } else {</span>
<span class="line-added">268             // test NTLM only, this should fail with &quot;401 Unauthorized&quot;</span>
<span class="line-added">269             testNTLM();</span>
<span class="line-added">270         }</span>
271 
272         System.out.println();
273         System.out.println(&quot;TEST PASSED&quot;);
274     }
275 }

</pre>
</td>
</tr>
</table>
<center><a href="NoCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>