<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/http/HttpClient/MultiThreadTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="IsKeepingAlive.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="OpenServer.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/http/HttpClient/MultiThreadTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 40,10 ***</span>
<span class="line-new-header">--- 40,11 ---</span>
  import java.net.*;
  import java.io.*;
  import java.time.Duration;
  import java.util.Queue;
  import java.util.concurrent.ConcurrentLinkedQueue;
<span class="line-added">+ import java.util.concurrent.atomic.AtomicInteger;</span>
  
  public class MultiThreadTest extends Thread {
  
      /*
       * Is debugging enabled - start with -d to enable.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,17 ***</span>
      static void debug(String msg) {
          if (debug)
              System.out.println(msg);
      }
  
<span class="line-modified">!     static int reqnum = 0;</span>
  
      void doRequest(String uri) throws Exception {
<span class="line-modified">!         URL url = new URL(uri + &quot;?foo=&quot;+reqnum);</span>
<span class="line-removed">-         reqnum ++;</span>
          HttpURLConnection http = (HttpURLConnection)url.openConnection();
<span class="line-removed">- </span>
          InputStream in = http.getInputStream();
          byte b[] = new byte[100];
          int total = 0;
          int n;
          do {
<span class="line-new-header">--- 59,15 ---</span>
      static void debug(String msg) {
          if (debug)
              System.out.println(msg);
      }
  
<span class="line-modified">!     static final AtomicInteger reqnum = new AtomicInteger();</span>
  
      void doRequest(String uri) throws Exception {
<span class="line-modified">!         URL url = new URL(uri + &quot;?foo=&quot;+reqnum.getAndIncrement());</span>
          HttpURLConnection http = (HttpURLConnection)url.openConnection();
          InputStream in = http.getInputStream();
          byte b[] = new byte[100];
          int total = 0;
          int n;
          do {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 82,12 ***</span>
  
      String uri;
      byte[] b;
      int requests;
  
<span class="line-modified">!     MultiThreadTest(int port, int requests) throws Exception {</span>
<span class="line-modified">!         uri = &quot;http://localhost:&quot; + port + &quot;/foo.html&quot;;</span>
  
          b = new byte [256];
          this.requests = requests;
  
          synchronized (threadlock) {
<span class="line-new-header">--- 81,12 ---</span>
  
      String uri;
      byte[] b;
      int requests;
  
<span class="line-modified">!     MultiThreadTest(String authority, int requests) throws Exception {</span>
<span class="line-modified">!         uri = &quot;http://&quot; + authority + &quot;/foo.html&quot;;</span>
  
          b = new byte [256];
          this.requests = requests;
  
          synchronized (threadlock) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,18 ***</span>
              threads = Integer.parseInt (args[x]);
              requests = Integer.parseInt (args[x+1]);
          }
  
          /* start the server */
<span class="line-modified">!         ServerSocket ss = new ServerSocket(0);</span>
          Server svr = new Server(ss);
          svr.start();
  
          Object lock = MultiThreadTest.getLock();
          synchronized (lock) {
              for (int i=0; i&lt;threads; i++) {
<span class="line-modified">!                 MultiThreadTest t = new MultiThreadTest(ss.getLocalPort(), requests);</span>
                  t.start ();
              }
              try {
                  lock.wait();
              } catch (InterruptedException e) {}
<span class="line-new-header">--- 131,20 ---</span>
              threads = Integer.parseInt (args[x]);
              requests = Integer.parseInt (args[x+1]);
          }
  
          /* start the server */
<span class="line-modified">!         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">+         ServerSocket ss = new ServerSocket();</span>
<span class="line-added">+         ss.bind(new InetSocketAddress(loopback, 0));</span>
          Server svr = new Server(ss);
          svr.start();
  
          Object lock = MultiThreadTest.getLock();
          synchronized (lock) {
              for (int i=0; i&lt;threads; i++) {
<span class="line-modified">!                 MultiThreadTest t = new MultiThreadTest(svr.getAuthority(), requests);</span>
                  t.start ();
              }
              try {
                  lock.wait();
              } catch (InterruptedException e) {}
</pre>
<hr />
<pre>
<span class="line-old-header">*** 155,16 ***</span>
          int cnt = svr.connectionCount();
          MultiThreadTest.debug(&quot;Connections = &quot; + cnt);
          int reqs = Worker.getRequests ();
          MultiThreadTest.debug(&quot;Requests = &quot; + reqs);
          System.out.println (&quot;Connection count = &quot; + cnt + &quot; Request count = &quot; + reqs);
<span class="line-modified">!         if (cnt &gt; threads) { // could be less</span>
<span class="line-modified">!             throw new RuntimeException (&quot;Expected &quot;+threads + &quot; connections: used &quot; +cnt);</span>
          }
<span class="line-modified">!         if  (reqs != threads*requests) {</span>
              throw new RuntimeException (&quot;Expected &quot;+ threads*requests+ &quot; requests: got &quot; +reqs);
          }
          for (Thread worker : svr.workers()) {
              worker.join(60_000);
          }
  
          debug(&quot;main thread end - &quot; + Duration.ofNanos(System.nanoTime() - start));
<span class="line-new-header">--- 156,41 ---</span>
          int cnt = svr.connectionCount();
          MultiThreadTest.debug(&quot;Connections = &quot; + cnt);
          int reqs = Worker.getRequests ();
          MultiThreadTest.debug(&quot;Requests = &quot; + reqs);
          System.out.println (&quot;Connection count = &quot; + cnt + &quot; Request count = &quot; + reqs);
<span class="line-modified">! </span>
<span class="line-modified">!         // We may have received traffic from something else than</span>
<span class="line-added">+         // our client. We should only count those workers for which</span>
<span class="line-added">+         // the expected header has been found.</span>
<span class="line-added">+         int validConnections = 0;</span>
<span class="line-added">+         for (Worker w : svr.workers()) {</span>
<span class="line-added">+             if (w.headerFound) validConnections++;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (validConnections &gt; threads + 1 || validConnections == 0) { // could be less</span>
<span class="line-added">+             throw new RuntimeException (&quot;Expected &quot; + threads + &quot; connections: used &quot; + validConnections);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Sometimes the client drops a connection after a while and</span>
<span class="line-added">+         // spawns a new one. Why this is happening is not clear,</span>
<span class="line-added">+         // and JDK-8223783 is logged to follow up on this. For the sake</span>
<span class="line-added">+         // of test stabilization we don&#39;t fail on `threads + 1` connections</span>
<span class="line-added">+         // but log a warning instead.</span>
<span class="line-added">+         if (validConnections == threads + 1) {</span>
<span class="line-added">+             debug(&quot;WARNING: &quot; + validConnections</span>
<span class="line-added">+                 + &quot; have been used, where only &quot; + threads</span>
<span class="line-added">+                 + &quot; were expected!&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (validConnections != cnt) {</span>
<span class="line-added">+             debug(&quot;WARNING: got &quot; + (cnt - validConnections) + &quot; unexpected connections!&quot;);</span>
          }
<span class="line-modified">!         if  (validConnections == cnt &amp;&amp; reqs != threads*requests) {</span>
              throw new RuntimeException (&quot;Expected &quot;+ threads*requests+ &quot; requests: got &quot; +reqs);
          }
<span class="line-added">+ </span>
          for (Thread worker : svr.workers()) {
              worker.join(60_000);
          }
  
          debug(&quot;main thread end - &quot; + Duration.ofNanos(System.nanoTime() - start));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 177,16 ***</span>
       */
      class Server extends Thread {
          ServerSocket ss;
          int connectionCount;
          boolean shutdown = false;
<span class="line-modified">!         private Queue&lt;Worker&gt; workers = new ConcurrentLinkedQueue&lt;&gt;();</span>
  
          Server(ServerSocket ss) {
              this.ss = ss;
          }
  
          public Queue&lt;Worker&gt; workers() {
              return workers;
          }
  
          public synchronized int connectionCount() {
<span class="line-new-header">--- 203,26 ---</span>
       */
      class Server extends Thread {
          ServerSocket ss;
          int connectionCount;
          boolean shutdown = false;
<span class="line-modified">!         private final Queue&lt;Worker&gt; workers = new ConcurrentLinkedQueue&lt;&gt;();</span>
  
          Server(ServerSocket ss) {
              this.ss = ss;
          }
  
<span class="line-added">+         public String getAuthority() {</span>
<span class="line-added">+             InetAddress address = ss.getInetAddress();</span>
<span class="line-added">+             String hostaddr = address.isAnyLocalAddress()</span>
<span class="line-added">+                 ? &quot;localhost&quot; : address.getHostAddress();</span>
<span class="line-added">+             if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="line-added">+                 hostaddr = &quot;[&quot; + hostaddr + &quot;]&quot;;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return hostaddr + &quot;:&quot; + ss.getLocalPort();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          public Queue&lt;Worker&gt; workers() {
              return workers;
          }
  
          public synchronized int connectionCount() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 244,12 ***</span>
<span class="line-new-header">--- 280,14 ---</span>
       * multiple http requests on same connection.
       */
      class Worker extends Thread {
          Socket s;
          int id;
<span class="line-added">+         volatile boolean headerFound;</span>
  
          Worker(Socket s, int id) {
<span class="line-added">+             super(&quot;Worker-&quot; + id);</span>
              this.s = s;
              this.id = id;
          }
  
          static int requests = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 258,22 ***</span>
          public static int getRequests () {
              synchronized (rlock) {
                  return requests;
              }
          }
          public static void incRequests () {
              synchronized (rlock) {
                  requests++;
              }
          }
  
<span class="line-modified">!         int readUntil(InputStream in, char[] seq) throws IOException {</span>
              int i=0, count=0;
              while (true) {
                  int c = in.read();
                  if (c == -1)
                      return -1;
                  count++;
                  if (c == seq[i]) {
                      i++;
                      if (i == seq.length)
                          return count;
<span class="line-new-header">--- 296,24 ---</span>
          public static int getRequests () {
              synchronized (rlock) {
                  return requests;
              }
          }
<span class="line-added">+ </span>
          public static void incRequests () {
              synchronized (rlock) {
                  requests++;
              }
          }
  
<span class="line-modified">!         int readUntil(InputStream in, StringBuilder headers, char[] seq) throws IOException {</span>
              int i=0, count=0;
              while (true) {
                  int c = in.read();
                  if (c == -1)
                      return -1;
<span class="line-added">+                 headers.append((char)c);</span>
                  count++;
                  if (c == seq[i]) {
                      i++;
                      if (i == seq.length)
                          return count;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 298,18 ***</span>
  
                  for (;;) {
  
                      // read entire request from client
                      int n=0;
<span class="line-modified">! </span>
<span class="line-modified">!                     n = readUntil(in, new char[] {&#39;\r&#39;,&#39;\n&#39;, &#39;\r&#39;,&#39;\n&#39;});</span>
<span class="line-removed">- </span>
                      if (n &lt;= 0) {
                          MultiThreadTest.debug(&quot;worker: &quot; + id + &quot;: Shutdown&quot;);
                          s.close();
                          return;
                      }
  
                      MultiThreadTest.debug(&quot;worker &quot; + id +
                          &quot;: Read request from client &quot; +
                          &quot;(&quot; + n + &quot; bytes).&quot;);
  
<span class="line-new-header">--- 338,22 ---</span>
  
                  for (;;) {
  
                      // read entire request from client
                      int n=0;
<span class="line-modified">!                     StringBuilder headers = new StringBuilder();</span>
<span class="line-modified">!                     n = readUntil(in, headers, new char[] {&#39;\r&#39;,&#39;\n&#39;, &#39;\r&#39;,&#39;\n&#39;});</span>
                      if (n &lt;= 0) {
                          MultiThreadTest.debug(&quot;worker: &quot; + id + &quot;: Shutdown&quot;);
                          s.close();
                          return;
                      }
<span class="line-added">+                     if (headers.toString().contains(&quot;/foo.html?foo=&quot;)) {</span>
<span class="line-added">+                         headerFound = true;</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         MultiThreadTest.debug(&quot;worker: &quot; + id + &quot;: Unexpected request received: &quot; + headers);</span>
<span class="line-added">+                     }</span>
  
                      MultiThreadTest.debug(&quot;worker &quot; + id +
                          &quot;: Read request from client &quot; +
                          &quot;(&quot; + n + &quot; bytes).&quot;);
  
</pre>
<center><a href="IsKeepingAlive.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="OpenServer.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>