<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/http/ChunkedErrorStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="BasicLongCredentials.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CloseOptionHeader.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/ChunkedErrorStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6488669 6595324 6993490

 27  * @modules jdk.httpserver
 28  * @run main/othervm ChunkedErrorStream
 29  * @summary Chunked ErrorStream tests
 30  */
 31 
 32 import java.net.*;
 33 import java.io.*;
 34 import com.sun.net.httpserver.*;

 35 
 36 /**
 37  * Part 1: 6488669
 38  * 1) Http server that responds with an error code (&gt;=400)
 39  *    and a chunked response body. It also indicates that
 40  *    the connection will be closed.
 41  * 2) Client sends request to server and tries to
 42  *    getErrorStream(). Some data must be able to be read
 43  *    from the errorStream.
 44  *
 45  * Part 2: 6595324
 46  * 1) Http server that responds with an error code (&gt;=400)
 47  *    and a chunked response body greater than
 48  *    sun.net.http.errorstream.bufferSize, 4K + 10 bytes.
 49  * 2) Client sends request to server and tries to
 50  *    getErrorStream(). 4K + 10 bytes must be read from
 51  *    the errorStream.
 52  *
 53  * Part 3: 6993490
 54  *    Reuse persistent connection from part 2, the error stream
</pre>
<hr />
<pre>
 77 
 78     public static void main(String[] args) {
 79         new ChunkedErrorStream();
 80     }
 81 
 82     public ChunkedErrorStream() {
 83         try {
 84             startHttpServer();
 85             doClient();
 86         } catch (IOException ioe) {
 87             ioe.printStackTrace();
 88         }  finally {
 89             httpServer.stop(1);
 90         }
 91     }
 92 
 93     void doClient() {
 94         for (int times=0; times&lt;3; times++) {
 95             HttpURLConnection uc = null;
 96             try {
<span class="line-modified"> 97                 InetSocketAddress address = httpServer.getAddress();</span>
<span class="line-removed"> 98                 String URLStr = &quot;http://localhost:&quot; + address.getPort() + &quot;/test/&quot;;</span>
 99                 if (times == 0) {
<span class="line-modified">100                     URLStr += &quot;first&quot;;</span>
101                 } else {
<span class="line-modified">102                     URLStr += &quot;second&quot;;</span>
103                 }
104 
<span class="line-modified">105                 System.out.println(&quot;Trying &quot; + URLStr);</span>
<span class="line-modified">106                 URL url = new URL(URLStr);</span>






107                 uc = (HttpURLConnection)url.openConnection();
108                 uc.getInputStream();
109 
110                 throw new RuntimeException(&quot;Failed: getInputStream should throw and IOException&quot;);
111             }  catch (IOException e) {
112                 if (e instanceof SocketTimeoutException) {
113                     e.printStackTrace();
114                     throw new RuntimeException(&quot;Failed: SocketTimeoutException should not happen&quot;);
115                 }
116 
117                 // This is what we expect to happen.
118                 InputStream es = uc.getErrorStream();
119                 byte[] ba = new byte[1024];
120                 int count = 0, ret;
121                 try {
122                     while ((ret = es.read(ba)) != -1)
123                         count += ret;
124                     es.close();
125                 } catch  (IOException ioe) {
126                     ioe.printStackTrace();
127                 }
128 
129                 if (count == 0)
130                     throw new RuntimeException(&quot;Failed: ErrorStream returning 0 bytes&quot;);
131 
132                 if (times &gt;= 1 &amp;&amp; count != (4096+10))
133                     throw new RuntimeException(&quot;Failed: ErrorStream returning &quot; + count +
134                                                  &quot; bytes. Expecting &quot; + (4096+10));
135 
136                 System.out.println(&quot;Read &quot; + count + &quot; bytes from the errorStream&quot;);
137             }
138         }
139     }
140 
141     /**
142      * Http Server
143      */
144     void startHttpServer() throws IOException {
<span class="line-modified">145         httpServer = com.sun.net.httpserver.HttpServer.create(new InetSocketAddress(0), 0);</span>


146 
147         // create HttpServer context
148         httpServer.createContext(&quot;/test/first&quot;, new FirstHandler());
149         httpServer.createContext(&quot;/test/second&quot;, new SecondHandler());
150 
151         httpServer.start();
152     }
153 
154     class FirstHandler implements HttpHandler {
155         public void handle(HttpExchange t) throws IOException {
156             InputStream is = t.getRequestBody();
157             byte[] ba = new byte[1024];
158             while (is.read(ba) != -1);
159             is.close();
160 
161             Headers resHeaders = t.getResponseHeaders();
162             resHeaders.add(&quot;Connection&quot;, &quot;close&quot;);
163             t.sendResponseHeaders(404, 0);
164             OutputStream os = t.getResponseBody();
165 
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6488669 6595324 6993490
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @modules jdk.httpserver
 29  * @run main/othervm ChunkedErrorStream
 30  * @summary Chunked ErrorStream tests
 31  */
 32 
 33 import java.net.*;
 34 import java.io.*;
 35 import com.sun.net.httpserver.*;
<span class="line-added"> 36 import jdk.test.lib.net.URIBuilder;</span>
 37 
 38 /**
 39  * Part 1: 6488669
 40  * 1) Http server that responds with an error code (&gt;=400)
 41  *    and a chunked response body. It also indicates that
 42  *    the connection will be closed.
 43  * 2) Client sends request to server and tries to
 44  *    getErrorStream(). Some data must be able to be read
 45  *    from the errorStream.
 46  *
 47  * Part 2: 6595324
 48  * 1) Http server that responds with an error code (&gt;=400)
 49  *    and a chunked response body greater than
 50  *    sun.net.http.errorstream.bufferSize, 4K + 10 bytes.
 51  * 2) Client sends request to server and tries to
 52  *    getErrorStream(). 4K + 10 bytes must be read from
 53  *    the errorStream.
 54  *
 55  * Part 3: 6993490
 56  *    Reuse persistent connection from part 2, the error stream
</pre>
<hr />
<pre>
 79 
 80     public static void main(String[] args) {
 81         new ChunkedErrorStream();
 82     }
 83 
 84     public ChunkedErrorStream() {
 85         try {
 86             startHttpServer();
 87             doClient();
 88         } catch (IOException ioe) {
 89             ioe.printStackTrace();
 90         }  finally {
 91             httpServer.stop(1);
 92         }
 93     }
 94 
 95     void doClient() {
 96         for (int times=0; times&lt;3; times++) {
 97             HttpURLConnection uc = null;
 98             try {
<span class="line-modified"> 99                 String path = &quot;/test/&quot;;</span>

100                 if (times == 0) {
<span class="line-modified">101                     path += &quot;first&quot;;</span>
102                 } else {
<span class="line-modified">103                     path += &quot;second&quot;;</span>
104                 }
105 
<span class="line-modified">106                 URL url = URIBuilder.newBuilder()</span>
<span class="line-modified">107                         .scheme(&quot;http&quot;)</span>
<span class="line-added">108                         .host(httpServer.getAddress().getAddress())</span>
<span class="line-added">109                         .port(httpServer.getAddress().getPort())</span>
<span class="line-added">110                         .path(path)</span>
<span class="line-added">111                         .toURLUnchecked();</span>
<span class="line-added">112 </span>
<span class="line-added">113                 System.out.println(&quot;Trying &quot; + url);</span>
114                 uc = (HttpURLConnection)url.openConnection();
115                 uc.getInputStream();
116 
117                 throw new RuntimeException(&quot;Failed: getInputStream should throw and IOException&quot;);
118             }  catch (IOException e) {
119                 if (e instanceof SocketTimeoutException) {
120                     e.printStackTrace();
121                     throw new RuntimeException(&quot;Failed: SocketTimeoutException should not happen&quot;);
122                 }
123 
124                 // This is what we expect to happen.
125                 InputStream es = uc.getErrorStream();
126                 byte[] ba = new byte[1024];
127                 int count = 0, ret;
128                 try {
129                     while ((ret = es.read(ba)) != -1)
130                         count += ret;
131                     es.close();
132                 } catch  (IOException ioe) {
133                     ioe.printStackTrace();
134                 }
135 
136                 if (count == 0)
137                     throw new RuntimeException(&quot;Failed: ErrorStream returning 0 bytes&quot;);
138 
139                 if (times &gt;= 1 &amp;&amp; count != (4096+10))
140                     throw new RuntimeException(&quot;Failed: ErrorStream returning &quot; + count +
141                                                  &quot; bytes. Expecting &quot; + (4096+10));
142 
143                 System.out.println(&quot;Read &quot; + count + &quot; bytes from the errorStream&quot;);
144             }
145         }
146     }
147 
148     /**
149      * Http Server
150      */
151     void startHttpServer() throws IOException {
<span class="line-modified">152         InetAddress lba = InetAddress.getLoopbackAddress();</span>
<span class="line-added">153         InetSocketAddress addr = new InetSocketAddress(lba, 0);</span>
<span class="line-added">154         httpServer = com.sun.net.httpserver.HttpServer.create(addr, 0);</span>
155 
156         // create HttpServer context
157         httpServer.createContext(&quot;/test/first&quot;, new FirstHandler());
158         httpServer.createContext(&quot;/test/second&quot;, new SecondHandler());
159 
160         httpServer.start();
161     }
162 
163     class FirstHandler implements HttpHandler {
164         public void handle(HttpExchange t) throws IOException {
165             InputStream is = t.getRequestBody();
166             byte[] ba = new byte[1024];
167             while (is.read(ba) != -1);
168             is.close();
169 
170             Headers resHeaders = t.getResponseHeaders();
171             resHeaders.add(&quot;Connection&quot;, &quot;close&quot;);
172             t.sendResponseHeaders(404, 0);
173             OutputStream os = t.getResponseBody();
174 
</pre>
</td>
</tr>
</table>
<center><a href="BasicLongCredentials.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CloseOptionHeader.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>