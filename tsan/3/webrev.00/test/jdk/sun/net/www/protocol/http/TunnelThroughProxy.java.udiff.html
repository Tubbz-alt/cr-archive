<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="StreamingOutputStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="UserAgent.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/TunnelThroughProxy.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -58,17 +58,18 @@</span>
  
      static void getLocalPortTest() throws Exception {
          ProxyTunnelServer proxy = setupProxy(true);
          try {
              int proxyPort = proxy.getPort();
<span class="udiff-line-modified-removed">-             ServerSocket server = new ServerSocket(0);</span>
<span class="udiff-line-modified-added">+             InetAddress proxyAddress = proxy.getInetAddress();</span>
<span class="udiff-line-added">+             ServerSocket server = new ServerSocket(0, 0, InetAddress.getLoopbackAddress());</span>
              int serverPort = server.getLocalPort();
  
              Socket sock;
              sock = new Socket(new Proxy(Proxy.Type.HTTP,
<span class="udiff-line-modified-removed">-                     new InetSocketAddress(InetAddress.getLoopbackAddress(), proxyPort)));</span>
<span class="udiff-line-modified-removed">-             InetSocketAddress dest = new InetSocketAddress(InetAddress.getLoopbackAddress(), serverPort);</span>
<span class="udiff-line-modified-added">+                     new InetSocketAddress(proxyAddress, proxyPort)));</span>
<span class="udiff-line-modified-added">+             InetSocketAddress dest = new InetSocketAddress(server.getInetAddress(), serverPort);</span>
              sock.connect(dest);
              int localPort = sock.getLocalPort();
              if (localPort == proxyPort)
                  throw new RuntimeException(&quot;Fail: socket has wrong local port&quot;);
              // check that tunnel really works
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,17 +83,20 @@</span>
              proxy.terminate();
          }
      }
  
      static ProxyTunnelServer setupProxy(boolean makeTunnel) throws IOException {
<span class="udiff-line-modified-removed">-         ProxyTunnelServer pserver = new ProxyTunnelServer();</span>
<span class="udiff-line-modified-added">+         InetAddress proxyAddress = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-added">+         ProxyTunnelServer pserver = new ProxyTunnelServer(proxyAddress);</span>
          pserver.doTunnel(makeTunnel);
          int proxyPort = pserver.getPort();
  
          // disable proxy authentication
          pserver.needUserAuth(false);
          pserver.start();
<span class="udiff-line-modified-removed">-         System.setProperty(&quot;https.proxyHost&quot;, &quot;localhost&quot;);</span>
<span class="udiff-line-modified-added">+         System.out.printf(&quot;Setting https.proxyHost=&#39;%s&#39;%n&quot;, proxyAddress.getHostAddress());</span>
<span class="udiff-line-added">+         System.setProperty(&quot;https.proxyHost&quot;, proxyAddress.getHostAddress());</span>
<span class="udiff-line-added">+         System.out.printf(&quot;Setting https.proxyPort=&#39;%s&#39;%n&quot;, String.valueOf(proxyPort));</span>
          System.setProperty(&quot;https.proxyPort&quot;, String.valueOf(proxyPort));
          return pserver;
      }
  }
</pre>
<center><a href="StreamingOutputStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="UserAgent.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>