<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/protocol/http/DigestTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CloseOptionHeader.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Finalizer.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/DigestTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,17 ---</span>
  /**
   * @test
   * @bug 4432213
   * @modules java.base/sun.net.www
   * @run main/othervm -Dhttp.auth.digest.validateServer=true DigestTest
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added">+  *                   -Dhttp.auth.digest.validateServer=true DigestTest</span>
<span class="line-added">+  * @run main/othervm -Dhttp.auth.digest.validateServer=true</span>
<span class="line-added">+                      -Dtest.succeed=true DigestTest</span>
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added">+  *                   -Dhttp.auth.digest.validateServer=true</span>
<span class="line-added">+                      -Dtest.succeed=true DigestTest</span>
   * @summary  Need to support Digest Authentication for Proxies
   */
  
  import java.io.*;
  import java.util.*;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 55,17 ***</span>
  
      String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot; +
          &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
          &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
          &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
<span class="line-modified">!         &quot;Transfer-encoding: chunked\r\n\r\n&quot;+</span>
          &quot;B\r\nHelloWorld1\r\n&quot;+
          &quot;B\r\nHelloWorld2\r\n&quot;+
          &quot;B\r\nHelloWorld3\r\n&quot;+
          &quot;B\r\nHelloWorld4\r\n&quot;+
          &quot;B\r\nHelloWorld5\r\n&quot;+
<span class="line-modified">!         &quot;0\r\n&quot;+</span>
          &quot;Authentication-Info: &quot;;
  
      DigestServer (ServerSocket y) {
          s = y;
          port = s.getLocalPort();
<span class="line-new-header">--- 62,19 ---</span>
  
      String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot; +
          &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
          &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
          &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
<span class="line-modified">!         &quot;Transfer-encoding: chunked\r\n&quot;;</span>
<span class="line-added">+     String body =</span>
          &quot;B\r\nHelloWorld1\r\n&quot;+
          &quot;B\r\nHelloWorld2\r\n&quot;+
          &quot;B\r\nHelloWorld3\r\n&quot;+
          &quot;B\r\nHelloWorld4\r\n&quot;+
          &quot;B\r\nHelloWorld5\r\n&quot;+
<span class="line-modified">!         &quot;0\r\n\r\n&quot;;</span>
<span class="line-added">+     String authInfo =</span>
          &quot;Authentication-Info: &quot;;
  
      DigestServer (ServerSocket y) {
          s = y;
          port = s.getLocalPort();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 82,19 ***</span>
                  s1.close ();
  
                  s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
<span class="line-modified">!                 is.read ();</span>
                  // need to get the cnonce out of the response
                  MessageHeader header = new MessageHeader (is);
                  String raw = header.findValue (&quot;Authorization&quot;);
                  HeaderParser parser = new HeaderParser (raw);
                  String cnonce = parser.findValue (&quot;cnonce&quot;);
                  String cnstring = parser.findValue (&quot;nc&quot;);
  
<span class="line-modified">!                 String reply = reply2 + getAuthorization (uri, &quot;GET&quot;, cnonce, cnstring) +&quot;\r\n&quot;;</span>
                  os.write (reply.getBytes());
                  Thread.sleep (2000);
                  s1.close ();
          } catch (Exception e) {
              System.out.println (e);
<span class="line-new-header">--- 91,19 ---</span>
                  s1.close ();
  
                  s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
<span class="line-modified">!                 //is.read ();</span>
                  // need to get the cnonce out of the response
                  MessageHeader header = new MessageHeader (is);
                  String raw = header.findValue (&quot;Authorization&quot;);
                  HeaderParser parser = new HeaderParser (raw);
                  String cnonce = parser.findValue (&quot;cnonce&quot;);
                  String cnstring = parser.findValue (&quot;nc&quot;);
  
<span class="line-modified">!                 String reply = reply2 + authInfo + getAuthorization (uri, &quot;GET&quot;, cnonce, cnstring) +&quot;\r\n&quot; + body;</span>
                  os.write (reply.getBytes());
                  Thread.sleep (2000);
                  s1.close ();
          } catch (Exception e) {
              System.out.println (e);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 191,53 ***</span>
  
  }
  
  public class DigestTest {
  
      static class MyAuthenticator extends Authenticator {
          public MyAuthenticator () {
              super ();
          }
  
          public PasswordAuthentication getPasswordAuthentication ()
          {
<span class="line-modified">!             return (new PasswordAuthentication (&quot;user&quot;, &quot;Wrongpassword&quot;.toCharArray()));</span>
          }
      }
  
  
      public static void main(String[] args) throws Exception {
          int port;
          DigestServer server;
          ServerSocket sock;
  
          try {
<span class="line-modified">!             sock = new ServerSocket (0);</span>
<span class="line-modified">!             port = sock.getLocalPort ();</span>
          }
          catch (Exception e) {
              System.out.println (&quot;Exception: &quot; + e);
<span class="line-modified">!             return;</span>
          }
  
          server = new DigestServer(sock);
          server.start ();
          boolean passed = false;
  
          try  {
              Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">!             String s = &quot;http://localhost:&quot; + port + DigestServer.uri;</span>
              URL url = new URL(s);
<span class="line-modified">!             java.net.URLConnection conURL =  url.openConnection();</span>
  
              InputStream in = conURL.getInputStream();
              while (in.read () != -1) {}
              in.close ();
          } catch(ProtocolException e) {
<span class="line-modified">!             passed = true;</span>
          }
  
          if (!passed) {
<span class="line-modified">!             throw new RuntimeException (&quot;Expected a ProtocolException from wrong password&quot;);</span>
          }
      }
  }
<span class="line-new-header">--- 200,71 ---</span>
  
  }
  
  public class DigestTest {
  
<span class="line-added">+     static final boolean SUCCEED =</span>
<span class="line-added">+         Boolean.parseBoolean(System.getProperty(&quot;test.succeed&quot;, &quot;false&quot;));</span>
<span class="line-added">+ </span>
      static class MyAuthenticator extends Authenticator {
          public MyAuthenticator () {
              super ();
          }
  
          public PasswordAuthentication getPasswordAuthentication ()
          {
<span class="line-modified">!             char[] passwd = SUCCEED ? DigestServer.passwd.clone()</span>
<span class="line-added">+                                       : &quot;Wrongpassword&quot;.toCharArray();</span>
<span class="line-added">+             return new PasswordAuthentication(&quot;user&quot;, passwd);</span>
          }
      }
  
  
      public static void main(String[] args) throws Exception {
          int port;
          DigestServer server;
          ServerSocket sock;
  
<span class="line-added">+         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
          try {
<span class="line-modified">!             sock = new ServerSocket();</span>
<span class="line-modified">!             sock.bind(new InetSocketAddress(loopback, 0));</span>
<span class="line-added">+             port = sock.getLocalPort();</span>
          }
          catch (Exception e) {
              System.out.println (&quot;Exception: &quot; + e);
<span class="line-modified">!             throw e;</span>
          }
  
          server = new DigestServer(sock);
          server.start ();
          boolean passed = false;
<span class="line-added">+         ProtocolException exception = null;</span>
  
          try  {
              Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">!             String address = loopback.getHostAddress();</span>
<span class="line-added">+             if (address.indexOf(&#39;:&#39;) &gt; -1)  address = &quot;[&quot; + address + &quot;]&quot;;</span>
<span class="line-added">+             String s = &quot;http://&quot; + address + &quot;:&quot; + port + DigestServer.uri;</span>
              URL url = new URL(s);
<span class="line-modified">!             java.net.URLConnection conURL =  url.openConnection(Proxy.NO_PROXY);</span>
  
              InputStream in = conURL.getInputStream();
              while (in.read () != -1) {}
              in.close ();
<span class="line-added">+             if (SUCCEED) passed = true;</span>
          } catch(ProtocolException e) {
<span class="line-modified">!             exception = e;</span>
<span class="line-added">+             if (!SUCCEED) passed = true;</span>
          }
  
          if (!passed) {
<span class="line-modified">!             if (!SUCCEED) {</span>
<span class="line-added">+                 throw new RuntimeException(&quot;Expected a ProtocolException from wrong password&quot;);</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 assert exception != null;</span>
<span class="line-added">+                 throw new RuntimeException(&quot;Unexpected ProtocolException from correct password: &quot;</span>
<span class="line-added">+                                             + exception, exception);</span>
<span class="line-added">+             }</span>
          }
      }
  }
</pre>
<center><a href="CloseOptionHeader.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Finalizer.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>