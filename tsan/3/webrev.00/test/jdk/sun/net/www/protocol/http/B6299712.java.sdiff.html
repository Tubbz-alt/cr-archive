<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/http/B6299712.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="B6296310.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6369510.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/B6299712.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6299712 7150552
 27  * @modules jdk.httpserver
 28  * @run main/othervm B6299712

 29  * @summary  NullPointerException in sun.net.www.protocol.http.HttpURLConnection.followRedirect
 30  */
 31 
 32 import com.sun.net.httpserver.HttpExchange;
 33 import com.sun.net.httpserver.HttpHandler;
 34 import com.sun.net.httpserver.HttpServer;
 35 import java.net.*;
 36 import java.io.*;
 37 import java.util.*;
 38 
 39 /*
 40  * Test Description:
 41  *      - main thread is run as a http client
 42  *      - another thread runs an http server, which redirects calls to &quot;/&quot; to
 43  *        &quot;/redirect&quot; and returns &#39;200 OK&#39; for the successive call
 44  *      - a global ResponseCache instance is installed, which returns DeployCacheResponse
 45  *        for urls that end with &quot;/redirect&quot;, i.e. the url redirected to by our simple http server,
 46  *        and null for other urls.
 47  *      - the whole result is that the first call will be served by our simple
 48  *        http server and is redirected to &quot;/redirect&quot;. The successive call will be done
 49  *        automatically by HttpURLConnection, which will be served by DeployCacheResponse.
 50  *        The NPE will be thrown on the second round if the bug is there.
 51  */
 52 public class B6299712 {
 53     static HttpServer server;
 54 
 55     public static void main(String[] args) throws Exception {
 56         ResponseCache.setDefault(new DeployCacheHandler());

 57         startHttpServer();
 58 
 59         makeHttpCall();
 60     }
 61 
 62     public static void startHttpServer() throws IOException {
<span class="line-modified"> 63         server = HttpServer.create(new InetSocketAddress(0), 0);</span>

 64         server.createContext(&quot;/&quot;, new DefaultHandler());
 65         server.createContext(&quot;/redirect&quot;, new RedirectHandler());
 66         server.start();
 67     }
 68 
 69     public static void makeHttpCall() throws IOException {
 70         try {
 71             System.out.println(&quot;http server listen on: &quot;
 72                     + server.getAddress().getPort());
 73             URL url = new URL(&quot;http&quot;,
 74                                InetAddress.getLocalHost().getHostAddress(),
 75                                server.getAddress().getPort(), &quot;/&quot;);
 76             HttpURLConnection uc = (HttpURLConnection)url.openConnection();
 77             if (uc.getResponseCode() != 200)
 78                 throw new RuntimeException(&quot;Expected Response Code was 200,&quot;
 79                         + &quot;received: &quot; + uc.getResponseCode());
 80             uc.disconnect();
 81         } finally {
 82             server.stop(0);
 83         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 6299712 7150552
 27  * @modules jdk.httpserver
 28  * @run main/othervm B6299712
<span class="line-added"> 29  * @run main/othervm -Djava.net.preferIPv6Addresses=true B6299712</span>
 30  * @summary  NullPointerException in sun.net.www.protocol.http.HttpURLConnection.followRedirect
 31  */
 32 
 33 import com.sun.net.httpserver.HttpExchange;
 34 import com.sun.net.httpserver.HttpHandler;
 35 import com.sun.net.httpserver.HttpServer;
 36 import java.net.*;
 37 import java.io.*;
 38 import java.util.*;
 39 
 40 /*
 41  * Test Description:
 42  *      - main thread is run as a http client
 43  *      - another thread runs an http server, which redirects calls to &quot;/&quot; to
 44  *        &quot;/redirect&quot; and returns &#39;200 OK&#39; for the successive call
 45  *      - a global ResponseCache instance is installed, which returns DeployCacheResponse
 46  *        for urls that end with &quot;/redirect&quot;, i.e. the url redirected to by our simple http server,
 47  *        and null for other urls.
 48  *      - the whole result is that the first call will be served by our simple
 49  *        http server and is redirected to &quot;/redirect&quot;. The successive call will be done
 50  *        automatically by HttpURLConnection, which will be served by DeployCacheResponse.
 51  *        The NPE will be thrown on the second round if the bug is there.
 52  */
 53 public class B6299712 {
 54     static HttpServer server;
 55 
 56     public static void main(String[] args) throws Exception {
 57         ResponseCache.setDefault(new DeployCacheHandler());
<span class="line-added"> 58         ProxySelector.setDefault(ProxySelector.of(null)); // no proxy</span>
 59         startHttpServer();
 60 
 61         makeHttpCall();
 62     }
 63 
 64     public static void startHttpServer() throws IOException {
<span class="line-modified"> 65         InetAddress address = InetAddress.getLocalHost();</span>
<span class="line-added"> 66         server = HttpServer.create(new InetSocketAddress(address, 0), 0);</span>
 67         server.createContext(&quot;/&quot;, new DefaultHandler());
 68         server.createContext(&quot;/redirect&quot;, new RedirectHandler());
 69         server.start();
 70     }
 71 
 72     public static void makeHttpCall() throws IOException {
 73         try {
 74             System.out.println(&quot;http server listen on: &quot;
 75                     + server.getAddress().getPort());
 76             URL url = new URL(&quot;http&quot;,
 77                                InetAddress.getLocalHost().getHostAddress(),
 78                                server.getAddress().getPort(), &quot;/&quot;);
 79             HttpURLConnection uc = (HttpURLConnection)url.openConnection();
 80             if (uc.getResponseCode() != 200)
 81                 throw new RuntimeException(&quot;Expected Response Code was 200,&quot;
 82                         + &quot;received: &quot; + uc.getResponseCode());
 83             uc.disconnect();
 84         } finally {
 85             server.stop(0);
 86         }
</pre>
</td>
</tr>
</table>
<center><a href="B6296310.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="B6369510.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>