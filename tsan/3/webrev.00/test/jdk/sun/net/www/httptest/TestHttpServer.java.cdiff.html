<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/httptest/TestHttpServer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../http/KeepAliveStream/KeepAliveStreamCloseWithWrongContentLength.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../protocol/file/DirPermissionDenied.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/httptest/TestHttpServer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,10 ***</span>
<span class="line-new-header">--- 66,26 ---</span>
  
      public TestHttpServer (HttpCallback cb) throws IOException {
          this (cb, 1, 10, 0);
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified callback object</span>
<span class="line-added">+      * for handling requests. One thread is created to handle requests,</span>
<span class="line-added">+      * and up to ten TCP connections will be handled simultaneously.</span>
<span class="line-added">+      * @param cb the callback object which is invoked to handle each</span>
<span class="line-added">+      *  incoming request</span>
<span class="line-added">+      * @param address the address to bind the server to. &lt;code&gt;Null&lt;/code&gt;</span>
<span class="line-added">+      *  means bind to the wildcard address.</span>
<span class="line-added">+      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;</span>
<span class="line-added">+      *  means choose any free port.</span>
<span class="line-added">+      */</span>
<span class="line-added">+ </span>
<span class="line-added">+     public TestHttpServer (HttpCallback cb, InetAddress address, int port) throws IOException {</span>
<span class="line-added">+         this (cb, 1, 10, address, 0);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number of
       * threads and maximum number of connections per thread. This functions
       * the same as the 4 arg constructor, where the port argument is set to zero.
       * @param cb the callback object which is invoked to handle each
</pre>
<hr />
<pre>
<span class="line-old-header">*** 100,13 ***</span>
       * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;
       *  means choose any free port.
       */
  
      public TestHttpServer (HttpCallback cb, int threads, int cperthread, int port)
          throws IOException {
          schan = ServerSocketChannel.open ();
<span class="line-modified">!         InetSocketAddress addr = new InetSocketAddress (port);</span>
          schan.socket().bind (addr);
          this.threads = threads;
          this.cb = cb;
          this.cperthread = cperthread;
          servers = new Server [threads];
<span class="line-new-header">--- 116,37 ---</span>
       * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;
       *  means choose any free port.
       */
  
      public TestHttpServer (HttpCallback cb, int threads, int cperthread, int port)
<span class="line-added">+             throws IOException {</span>
<span class="line-added">+         this(cb, threads, cperthread, null, port);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number</span>
<span class="line-added">+      * of threads and maximum number of connections per thread and running on</span>
<span class="line-added">+      * the specified port. The specified number of threads are created to</span>
<span class="line-added">+      * handle incoming requests, and each thread is allowed</span>
<span class="line-added">+      * to handle a number of simultaneous TCP connections.</span>
<span class="line-added">+      * @param cb the callback object which is invoked to handle</span>
<span class="line-added">+      *  each incoming request</span>
<span class="line-added">+      * @param threads the number of threads to create to handle</span>
<span class="line-added">+      *  requests in parallel</span>
<span class="line-added">+      * @param cperthread the number of simultaneous TCP connections</span>
<span class="line-added">+      *  to handle per thread</span>
<span class="line-added">+      * @param address the address to bind the server to. &lt;code&gt;Null&lt;/code&gt;</span>
<span class="line-added">+      *  means bind to the wildcard address.</span>
<span class="line-added">+      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;</span>
<span class="line-added">+      *  means choose any free port.</span>
<span class="line-added">+      */</span>
<span class="line-added">+ </span>
<span class="line-added">+     public TestHttpServer (HttpCallback cb, int threads, int cperthread,</span>
<span class="line-added">+                            InetAddress address, int port)</span>
          throws IOException {
          schan = ServerSocketChannel.open ();
<span class="line-modified">!         InetSocketAddress addr = new InetSocketAddress (address, port);</span>
          schan.socket().bind (addr);
          this.threads = threads;
          this.cb = cb;
          this.cperthread = cperthread;
          servers = new Server [threads];
</pre>
<hr />
<pre>
<span class="line-old-header">*** 145,10 ***</span>
<span class="line-new-header">--- 185,18 ---</span>
  
      public int getLocalPort () {
          return schan.socket().getLocalPort ();
      }
  
<span class="line-added">+     public String getAuthority() {</span>
<span class="line-added">+         InetAddress address = schan.socket().getInetAddress();</span>
<span class="line-added">+         String hostaddr = address.getHostAddress();</span>
<span class="line-added">+         if (address.isAnyLocalAddress()) hostaddr = &quot;localhost&quot;;</span>
<span class="line-added">+         if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) hostaddr = &quot;[&quot; + hostaddr + &quot;]&quot;;</span>
<span class="line-added">+         return hostaddr + &quot;:&quot; + getLocalPort();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static class Server extends Thread {
  
          ServerSocketChannel schan;
          Selector selector;
          SelectionKey listenerKey;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 171,10 ***</span>
<span class="line-new-header">--- 219,11 ---</span>
                  selector = Selector.open ();
                  schan.configureBlocking (false);
                  listenerKey = schan.register (selector, SelectionKey.OP_ACCEPT);
              } catch (IOException e) {
                  System.err.println (&quot;Server could not start: &quot; + e);
<span class="line-added">+                 throw new RuntimeException(&quot;Server could not start: &quot; + e, e);</span>
              }
          }
  
          /* Stop the thread as soon as possible */
          public void terminate () {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 744,6 ***</span>
                  }
              }
          }
      }
  }
<span class="line-removed">- </span>
<span class="line-new-header">--- 793,5 ---</span>
</pre>
<center><a href="../http/KeepAliveStream/KeepAliveStreamCloseWithWrongContentLength.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../protocol/file/DirPermissionDenied.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>