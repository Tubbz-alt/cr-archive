<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/httptest/TestHttpServer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../http/KeepAliveStream/KeepAliveStreamCloseWithWrongContentLength.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../protocol/file/DirPermissionDenied.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/httptest/TestHttpServer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 51 public class TestHttpServer {
 52 
 53     ServerSocketChannel schan;
 54     int threads;
 55     int cperthread;
 56     HttpCallback cb;
 57     Server[] servers;
 58 
 59     /**
 60      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified callback object
 61      * for handling requests. One thread is created to handle requests,
 62      * and up to ten TCP connections will be handled simultaneously.
 63      * @param cb the callback object which is invoked to handle each
 64      *  incoming request
 65      */
 66 
 67     public TestHttpServer (HttpCallback cb) throws IOException {
 68         this (cb, 1, 10, 0);
 69     }
 70 
















 71     /**
 72      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number of
 73      * threads and maximum number of connections per thread. This functions
 74      * the same as the 4 arg constructor, where the port argument is set to zero.
 75      * @param cb the callback object which is invoked to handle each
 76      *     incoming request
 77      * @param threads the number of threads to create to handle requests
 78      *     in parallel
 79      * @param cperthread the number of simultaneous TCP connections to
 80      *     handle per thread
 81      */
 82 
 83     public TestHttpServer (HttpCallback cb, int threads, int cperthread)
 84         throws IOException {
 85         this (cb, threads, cperthread, 0);
 86     }
 87 
 88     /**
 89      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number
 90      * of threads and maximum number of connections per thread and running on
 91      * the specified port. The specified number of threads are created to
 92      * handle incoming requests, and each thread is allowed
 93      * to handle a number of simultaneous TCP connections.
 94      * @param cb the callback object which is invoked to handle
 95      *  each incoming request
 96      * @param threads the number of threads to create to handle
 97      *  requests in parallel
 98      * @param cperthread the number of simultaneous TCP connections
 99      *  to handle per thread
100      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;
101      *  means choose any free port.
102      */
103 
104     public TestHttpServer (HttpCallback cb, int threads, int cperthread, int port)
























105         throws IOException {
106         schan = ServerSocketChannel.open ();
<span class="line-modified">107         InetSocketAddress addr = new InetSocketAddress (port);</span>
108         schan.socket().bind (addr);
109         this.threads = threads;
110         this.cb = cb;
111         this.cperthread = cperthread;
112         servers = new Server [threads];
113         for (int i=0; i&lt;threads; i++) {
114             servers[i] = new Server (cb, schan, cperthread);
115             servers[i].start();
116         }
117     }
118 
119     /**
120      * Tell all threads in the server to exit within 5 seconds.
121      * This is an abortive termination. Just prior to the thread exiting
122      * all channels in that thread waiting to be closed are forceably closed.
123      * @throws InterruptedException
124      */
125 
126     public void terminate () {
127         for (int i=0; i&lt;threads; i++) {
</pre>
<hr />
<pre>
130 
131         for (int i = 0; i &lt; threads; i++) {
132             try {
133                 servers[i].join();
134             } catch (InterruptedException e) {
135                 System.err.println(&quot;Unexpected InterruptedException during terminating server&quot;);
136                 throw new RuntimeException(e);
137             }
138         }
139     }
140 
141     /**
142      * return the local port number to which the server is bound.
143      * @return the local port number
144      */
145 
146     public int getLocalPort () {
147         return schan.socket().getLocalPort ();
148     }
149 








150     static class Server extends Thread {
151 
152         ServerSocketChannel schan;
153         Selector selector;
154         SelectionKey listenerKey;
155         SelectionKey key; /* the current key being processed */
156         HttpCallback cb;
157         ByteBuffer consumeBuffer;
158         int maxconn;
159         int nconn;
160         ClosedChannelList clist;
161         volatile boolean shutdown;
162 
163         Server (HttpCallback cb, ServerSocketChannel schan, int maxconn) {
164             this.schan = schan;
165             this.maxconn = maxconn;
166             this.cb = cb;
167             nconn = 0;
168             consumeBuffer = ByteBuffer.allocate (512);
169             clist = new ClosedChannelList ();
170             try {
171                 selector = Selector.open ();
172                 schan.configureBlocking (false);
173                 listenerKey = schan.register (selector, SelectionKey.OP_ACCEPT);
174             } catch (IOException e) {
175                 System.err.println (&quot;Server could not start: &quot; + e);

176             }
177         }
178 
179         /* Stop the thread as soon as possible */
180         public void terminate () {
181             shutdown = true;
182         }
183 
184         public void run ()  {
185             try {
186                 while (true) {
187                     selector.select(1000);
188                     Set&lt;SelectionKey&gt; selected = selector.selectedKeys();
189                     Iterator&lt;SelectionKey&gt; iter = selected.iterator();
190                     while (iter.hasNext()) {
191                         key = iter.next();
192                         if (key.equals (listenerKey)) {
193                             SocketChannel sock = schan.accept ();
194                             if (sock == null) {
195                                 /* false notification */
</pre>
<hr />
<pre>
729      * exists but is not set, then the call returns without doing anything.
730      * Note, some higher level synchronization
731      * may be needed between clear and the other operations.
732      */
733 
734     public static void clearCondition(String condition) {
735         BValue cond;
736         synchronized (conditions) {
737             cond = (BValue) conditions.get (condition);
738             if (cond == null) {
739                 return;
740             }
741             synchronized (cond) {
742                 if (cond.v) {
743                     conditions.remove (condition);
744                 }
745             }
746         }
747     }
748 }
<span class="line-removed">749 </span>
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 51 public class TestHttpServer {
 52 
 53     ServerSocketChannel schan;
 54     int threads;
 55     int cperthread;
 56     HttpCallback cb;
 57     Server[] servers;
 58 
 59     /**
 60      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified callback object
 61      * for handling requests. One thread is created to handle requests,
 62      * and up to ten TCP connections will be handled simultaneously.
 63      * @param cb the callback object which is invoked to handle each
 64      *  incoming request
 65      */
 66 
 67     public TestHttpServer (HttpCallback cb) throws IOException {
 68         this (cb, 1, 10, 0);
 69     }
 70 
<span class="line-added"> 71     /**</span>
<span class="line-added"> 72      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified callback object</span>
<span class="line-added"> 73      * for handling requests. One thread is created to handle requests,</span>
<span class="line-added"> 74      * and up to ten TCP connections will be handled simultaneously.</span>
<span class="line-added"> 75      * @param cb the callback object which is invoked to handle each</span>
<span class="line-added"> 76      *  incoming request</span>
<span class="line-added"> 77      * @param address the address to bind the server to. &lt;code&gt;Null&lt;/code&gt;</span>
<span class="line-added"> 78      *  means bind to the wildcard address.</span>
<span class="line-added"> 79      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;</span>
<span class="line-added"> 80      *  means choose any free port.</span>
<span class="line-added"> 81      */</span>
<span class="line-added"> 82 </span>
<span class="line-added"> 83     public TestHttpServer (HttpCallback cb, InetAddress address, int port) throws IOException {</span>
<span class="line-added"> 84         this (cb, 1, 10, address, 0);</span>
<span class="line-added"> 85     }</span>
<span class="line-added"> 86 </span>
 87     /**
 88      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number of
 89      * threads and maximum number of connections per thread. This functions
 90      * the same as the 4 arg constructor, where the port argument is set to zero.
 91      * @param cb the callback object which is invoked to handle each
 92      *     incoming request
 93      * @param threads the number of threads to create to handle requests
 94      *     in parallel
 95      * @param cperthread the number of simultaneous TCP connections to
 96      *     handle per thread
 97      */
 98 
 99     public TestHttpServer (HttpCallback cb, int threads, int cperthread)
100         throws IOException {
101         this (cb, threads, cperthread, 0);
102     }
103 
104     /**
105      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number
106      * of threads and maximum number of connections per thread and running on
107      * the specified port. The specified number of threads are created to
108      * handle incoming requests, and each thread is allowed
109      * to handle a number of simultaneous TCP connections.
110      * @param cb the callback object which is invoked to handle
111      *  each incoming request
112      * @param threads the number of threads to create to handle
113      *  requests in parallel
114      * @param cperthread the number of simultaneous TCP connections
115      *  to handle per thread
116      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;
117      *  means choose any free port.
118      */
119 
120     public TestHttpServer (HttpCallback cb, int threads, int cperthread, int port)
<span class="line-added">121             throws IOException {</span>
<span class="line-added">122         this(cb, threads, cperthread, null, port);</span>
<span class="line-added">123     }</span>
<span class="line-added">124 </span>
<span class="line-added">125     /**</span>
<span class="line-added">126      * Create a &lt;code&gt;TestHttpServer&lt;code&gt; instance with the specified number</span>
<span class="line-added">127      * of threads and maximum number of connections per thread and running on</span>
<span class="line-added">128      * the specified port. The specified number of threads are created to</span>
<span class="line-added">129      * handle incoming requests, and each thread is allowed</span>
<span class="line-added">130      * to handle a number of simultaneous TCP connections.</span>
<span class="line-added">131      * @param cb the callback object which is invoked to handle</span>
<span class="line-added">132      *  each incoming request</span>
<span class="line-added">133      * @param threads the number of threads to create to handle</span>
<span class="line-added">134      *  requests in parallel</span>
<span class="line-added">135      * @param cperthread the number of simultaneous TCP connections</span>
<span class="line-added">136      *  to handle per thread</span>
<span class="line-added">137      * @param address the address to bind the server to. &lt;code&gt;Null&lt;/code&gt;</span>
<span class="line-added">138      *  means bind to the wildcard address.</span>
<span class="line-added">139      * @param port the port number to bind the server to. &lt;code&gt;Zero&lt;/code&gt;</span>
<span class="line-added">140      *  means choose any free port.</span>
<span class="line-added">141      */</span>
<span class="line-added">142 </span>
<span class="line-added">143     public TestHttpServer (HttpCallback cb, int threads, int cperthread,</span>
<span class="line-added">144                            InetAddress address, int port)</span>
145         throws IOException {
146         schan = ServerSocketChannel.open ();
<span class="line-modified">147         InetSocketAddress addr = new InetSocketAddress (address, port);</span>
148         schan.socket().bind (addr);
149         this.threads = threads;
150         this.cb = cb;
151         this.cperthread = cperthread;
152         servers = new Server [threads];
153         for (int i=0; i&lt;threads; i++) {
154             servers[i] = new Server (cb, schan, cperthread);
155             servers[i].start();
156         }
157     }
158 
159     /**
160      * Tell all threads in the server to exit within 5 seconds.
161      * This is an abortive termination. Just prior to the thread exiting
162      * all channels in that thread waiting to be closed are forceably closed.
163      * @throws InterruptedException
164      */
165 
166     public void terminate () {
167         for (int i=0; i&lt;threads; i++) {
</pre>
<hr />
<pre>
170 
171         for (int i = 0; i &lt; threads; i++) {
172             try {
173                 servers[i].join();
174             } catch (InterruptedException e) {
175                 System.err.println(&quot;Unexpected InterruptedException during terminating server&quot;);
176                 throw new RuntimeException(e);
177             }
178         }
179     }
180 
181     /**
182      * return the local port number to which the server is bound.
183      * @return the local port number
184      */
185 
186     public int getLocalPort () {
187         return schan.socket().getLocalPort ();
188     }
189 
<span class="line-added">190     public String getAuthority() {</span>
<span class="line-added">191         InetAddress address = schan.socket().getInetAddress();</span>
<span class="line-added">192         String hostaddr = address.getHostAddress();</span>
<span class="line-added">193         if (address.isAnyLocalAddress()) hostaddr = &quot;localhost&quot;;</span>
<span class="line-added">194         if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) hostaddr = &quot;[&quot; + hostaddr + &quot;]&quot;;</span>
<span class="line-added">195         return hostaddr + &quot;:&quot; + getLocalPort();</span>
<span class="line-added">196     }</span>
<span class="line-added">197 </span>
198     static class Server extends Thread {
199 
200         ServerSocketChannel schan;
201         Selector selector;
202         SelectionKey listenerKey;
203         SelectionKey key; /* the current key being processed */
204         HttpCallback cb;
205         ByteBuffer consumeBuffer;
206         int maxconn;
207         int nconn;
208         ClosedChannelList clist;
209         volatile boolean shutdown;
210 
211         Server (HttpCallback cb, ServerSocketChannel schan, int maxconn) {
212             this.schan = schan;
213             this.maxconn = maxconn;
214             this.cb = cb;
215             nconn = 0;
216             consumeBuffer = ByteBuffer.allocate (512);
217             clist = new ClosedChannelList ();
218             try {
219                 selector = Selector.open ();
220                 schan.configureBlocking (false);
221                 listenerKey = schan.register (selector, SelectionKey.OP_ACCEPT);
222             } catch (IOException e) {
223                 System.err.println (&quot;Server could not start: &quot; + e);
<span class="line-added">224                 throw new RuntimeException(&quot;Server could not start: &quot; + e, e);</span>
225             }
226         }
227 
228         /* Stop the thread as soon as possible */
229         public void terminate () {
230             shutdown = true;
231         }
232 
233         public void run ()  {
234             try {
235                 while (true) {
236                     selector.select(1000);
237                     Set&lt;SelectionKey&gt; selected = selector.selectedKeys();
238                     Iterator&lt;SelectionKey&gt; iter = selected.iterator();
239                     while (iter.hasNext()) {
240                         key = iter.next();
241                         if (key.equals (listenerKey)) {
242                             SocketChannel sock = schan.accept ();
243                             if (sock == null) {
244                                 /* false notification */
</pre>
<hr />
<pre>
778      * exists but is not set, then the call returns without doing anything.
779      * Note, some higher level synchronization
780      * may be needed between clear and the other operations.
781      */
782 
783     public static void clearCondition(String condition) {
784         BValue cond;
785         synchronized (conditions) {
786             cond = (BValue) conditions.get (condition);
787             if (cond == null) {
788                 return;
789             }
790             synchronized (cond) {
791                 if (cond.v) {
792                     conditions.remove (condition);
793                 }
794             }
795         }
796     }
797 }

</pre>
</td>
</tr>
</table>
<center><a href="../http/KeepAliveStream/KeepAliveStreamCloseWithWrongContentLength.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../protocol/file/DirPermissionDenied.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>