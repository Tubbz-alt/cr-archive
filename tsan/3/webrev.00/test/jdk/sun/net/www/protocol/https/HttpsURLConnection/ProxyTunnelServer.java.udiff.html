<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/net/www/protocol/https/HttpsURLConnection/ProxyTunnelServer.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PostThruProxyWithAuth.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ReadTimeout.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/HttpsURLConnection/ProxyTunnelServer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -61,15 +61,27 @@</span>
       * denote whether the proxy needs to authorize
       * CONNECT requests.
       */
      static boolean needAuth = false;
  
<span class="udiff-line-added">+     volatile long connectCount;</span>
<span class="udiff-line-added">+ </span>
      public ProxyTunnelServer() throws IOException {
          if (ss == null) {
              ss = (ServerSocket) ServerSocketFactory.getDefault()
                      .createServerSocket(0);
              ss.setSoTimeout(TIMEOUT);
<span class="udiff-line-added">+             System.out.println(&quot;Proxy server created: &quot; + ss);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public ProxyTunnelServer(InetAddress address) throws IOException {</span>
<span class="udiff-line-added">+         if (ss == null) {</span>
<span class="udiff-line-added">+             ss = (ServerSocket) ServerSocketFactory.getDefault()</span>
<span class="udiff-line-added">+                     .createServerSocket(0, 0, address);</span>
<span class="udiff-line-added">+             ss.setSoTimeout(TIMEOUT);</span>
<span class="udiff-line-added">+             System.out.println(&quot;Proxy server created: &quot; + ss);</span>
          }
      }
  
      public void needUserAuth(boolean auth) {
          needAuth = auth;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -84,11 +96,13 @@</span>
          userPlusPass = uname + &quot;:&quot; + passwd;
      }
  
      public void run() {
          try {
<span class="udiff-line-added">+             System.out.println(&quot;Proxy server listening at: &quot; + ss);</span>
              clientSocket = ss.accept();
<span class="udiff-line-added">+             System.out.println(&quot;Proxy server accepted connection: &quot; + clientSocket);</span>
              processRequests();
          } catch (SocketTimeoutException e) {
              System.out.println(
                      &quot;Proxy can not get response in time: &quot; + e.getMessage());
          } catch (Exception e) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -99,11 +113,13 @@</span>
              }
              catch (IOException excep) {
                  System.out.println(&quot;ProxyServer close error: &quot; + excep);
                  excep.printStackTrace();
              }
<span class="udiff-line-modified-removed">-           }</span>
<span class="udiff-line-modified-added">+          } finally {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Proxy server: request served&quot;);</span>
<span class="udiff-line-added">+          }</span>
      }
  
      /*
       * Processes the CONNECT requests, if needAuth is set to true, then
       * the name and password are extracted from the Proxy-Authorization header
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,10 +132,11 @@</span>
          InputStream in = clientSocket.getInputStream();
          MessageHeader mheader = new MessageHeader(in);
          String statusLine = mheader.getValue(0);
  
          if (statusLine.startsWith(&quot;CONNECT&quot;)) {
<span class="udiff-line-added">+             synchronized(this) { connectCount++; }</span>
              // retrieve the host and port info from the status-line
              retrieveConnectInfo(statusLine);
              if (needAuth) {
                  String authInfo;
                  if ((authInfo = mheader.findValue(&quot;Proxy-Authorization&quot;))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -152,10 +169,14 @@</span>
                                     + &quot;CONNECT method requests, recieved: &quot;
                                     + statusLine);
          }
      }
  
<span class="udiff-line-added">+     public long getConnectCount() {</span>
<span class="udiff-line-added">+         return connectCount;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private void respondForConnect(boolean needAuth) throws Exception {
  
          OutputStream out = clientSocket.getOutputStream();
          PrintWriter pout = new PrintWriter(out);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -271,17 +292,23 @@</span>
          try {
              starti = connectStr.indexOf(&#39; &#39;);
              endi = connectStr.lastIndexOf(&#39; &#39;);
              connectInfo = connectStr.substring(starti+1, endi).trim();
              // retrieve server name and port
<span class="udiff-line-modified-removed">-             endi = connectInfo.indexOf(&#39;:&#39;);</span>
<span class="udiff-line-modified-removed">-             serverName = connectInfo.substring(0, endi);</span>
<span class="udiff-line-modified-added">+             if (connectInfo.charAt(0) == &#39;[&#39;) {</span>
<span class="udiff-line-modified-added">+                  endi = connectInfo.indexOf(&#39;]&#39;);</span>
<span class="udiff-line-added">+                  serverName = connectInfo.substring(1, endi++);</span>
<span class="udiff-line-added">+                  assert connectInfo.charAt(endi) == &#39;:&#39; : &quot;Expected [IPv6]:port&quot;;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                  endi = connectInfo.indexOf(&#39;:&#39;);</span>
<span class="udiff-line-added">+                  serverName = connectInfo.substring(0, endi);</span>
<span class="udiff-line-added">+             }</span>
              serverPort = Integer.parseInt(connectInfo.substring(endi+1));
          } catch (Exception e) {
              throw new IOException(&quot;Proxy recieved a request: &quot;
                                          + connectStr, e);
<span class="udiff-line-modified-removed">-           }</span>
<span class="udiff-line-modified-added">+         }</span>
          serverInetAddr = InetAddress.getByName(serverName);
      }
  
      public int getPort() {
          return ss.getLocalPort();
</pre>
<center><a href="PostThruProxyWithAuth.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ReadTimeout.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>