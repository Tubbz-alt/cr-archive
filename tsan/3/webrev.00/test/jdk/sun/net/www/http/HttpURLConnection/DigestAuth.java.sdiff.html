<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/http/HttpURLConnection/DigestAuth.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../HttpClient/StreamingRetry.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NTLMAuthWithSM.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/http/HttpURLConnection/DigestAuth.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import com.sun.net.httpserver.HttpExchange;
 25 import com.sun.net.httpserver.HttpHandler;
 26 import com.sun.net.httpserver.HttpServer;
 27 import java.io.BufferedReader;
 28 import java.io.InputStreamReader;
 29 import java.io.IOException;
 30 import java.io.InputStream;
 31 import java.net.Authenticator;

 32 import java.net.InetSocketAddress;
 33 import java.net.PasswordAuthentication;
 34 import java.net.URL;
 35 import java.net.URLConnection;
 36 import java.util.List;
 37 
 38 /*
 39  * @test
 40  * @bug 8138990
 41  * @summary Tests for HTTP Digest auth
 42  *          The impl maintains a cache for auth info,
 43  *          the testcases run in a separate JVM to avoid cache hits
 44  * @modules jdk.httpserver
 45  * @run main/othervm DigestAuth good
 46  * @run main/othervm DigestAuth only_nonce
 47  * @run main/othervm DigestAuth sha1
 48  * @run main/othervm DigestAuth no_header
 49  * @run main/othervm DigestAuth no_nonce
 50  * @run main/othervm DigestAuth no_qop
 51  * @run main/othervm DigestAuth invalid_alg
 52  * @run main/othervm DigestAuth validate_server
 53  * @run main/othervm DigestAuth validate_server_no_qop
 54  */
 55 public class DigestAuth {
 56 
<span class="line-removed"> 57     static final String LOCALHOST = &quot;localhost&quot;;</span>
 58     static final String EXPECT_FAILURE = null;
 59     static final String EXPECT_DIGEST = &quot;Digest&quot;;
 60     static final String REALM = &quot;testrealm@host.com&quot;;
 61     static final String NEXT_NONCE = &quot;40f2e879449675f288476d772627370a&quot;;
 62 
 63     static final String GOOD_WWW_AUTH_HEADER = &quot;Digest &quot;
 64             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 65             + &quot;qop=\&quot;auth,auth-int\&quot;, &quot;
 66             + &quot;nonce=\&quot;dcd98b7102dd2f0e8b11d0f600bfb0c093\&quot;, &quot;
 67             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
 68 
 69     static final String GOOD_WWW_AUTH_HEADER_NO_QOP = &quot;Digest &quot;
 70             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 71             + &quot;nonce=\&quot;dcd98b7102dd2f0e8b11d0f600bfb0c093\&quot;, &quot;
 72             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
 73 
 74     static final String WWW_AUTH_HEADER_NO_NONCE = &quot;Digest &quot;
 75             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 76             + &quot;qop=\&quot;auth,auth-int\&quot;, &quot;
 77             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
</pre>
<hr />
<pre>
102     static final String AUTH_INFO_HEADER_WRONG_DIGEST =
103               &quot;nextnonce=\&quot;&quot; + NEXT_NONCE + &quot;\&quot;, &quot;
104             + &quot;rspauth=\&quot;7327570c586207eca2afae94fc20903d\&quot;, &quot;
105             + &quot;cnonce=\&quot;0a4f113b\&quot;, &quot;
106             + &quot;nc=00000001, &quot;
107             + &quot;qop=auth&quot;;
108 
109     public static void main(String[] args) throws Exception {
110         if (args.length == 0) {
111             throw new RuntimeException(&quot;No testcase specified&quot;);
112         }
113         String testcase = args[0];
114 
115         // start a local HTTP server
116         try (LocalHttpServer server = LocalHttpServer.startServer()) {
117 
118             // set authenticator
119             AuthenticatorImpl auth = new AuthenticatorImpl();
120             Authenticator.setDefault(auth);
121 
<span class="line-modified">122             String url = String.format(&quot;http://%s:%d/test/&quot;,</span>
<span class="line-removed">123                     LOCALHOST, server.getPort());</span>
124 
125             boolean success = true;
126             switch (testcase) {
127                 case &quot;good&quot;:
128                     // server returns a good WWW-Authenticate header
129                     server.setWWWAuthHeader(GOOD_WWW_AUTH_HEADER);
130                     success = testAuth(url, auth, EXPECT_DIGEST);
131                     if (auth.lastRequestedPrompt == null ||
132                             !auth.lastRequestedPrompt.equals(REALM)) {
133                         System.out.println(&quot;Unexpected realm: &quot;
134                                 + auth.lastRequestedPrompt);
135                         success = false;
136                     }
137                     break;
138                 case &quot;validate_server&quot;:
139                     // enable processing Authentication-Info headers
140                     System.setProperty(&quot;http.auth.digest.validateServer&quot;,
141                             &quot;true&quot;);
142 
143                     /* Server returns good WWW-Authenticate
</pre>
<hr />
<pre>
305             System.out.println(&quot;AuthenticatorImpl: requested &quot;
306                     + lastRequestedScheme);
307 
308             return new PasswordAuthentication(&quot;Mufasa&quot;,
309                     &quot;Circle Of Life&quot;.toCharArray());
310         }
311     }
312 
313     // local HTTP server which pretends to support HTTP Digest auth
314     static class LocalHttpServer implements HttpHandler, AutoCloseable {
315 
316         private final HttpServer server;
317         private volatile String wwwAuthHeader = null;
318         private volatile String authInfoHeader = null;
319         private volatile String lastRequestedNonce;
320 
321         private LocalHttpServer(HttpServer server) {
322             this.server = server;
323         }
324 










325         void setWWWAuthHeader(String wwwAuthHeader) {
326             this.wwwAuthHeader = wwwAuthHeader;
327         }
328 
329         void setAuthInfoHeader(String authInfoHeader) {
330             this.authInfoHeader = authInfoHeader;
331         }
332 
333         static LocalHttpServer startServer() throws IOException {

334             HttpServer httpServer = HttpServer.create(
<span class="line-modified">335                     new InetSocketAddress(0), 0);</span>
336             LocalHttpServer localHttpServer = new LocalHttpServer(httpServer);
337             localHttpServer.start();
338 
339             return localHttpServer;
340         }
341 
342         void start() {
343             server.createContext(&quot;/test&quot;, this);
344             server.start();
<span class="line-modified">345             System.out.println(&quot;HttpServer: started on port &quot; + getPort());</span>
346         }
347 
348         void stop() {
349             server.stop(0);
350             System.out.println(&quot;HttpServer: stopped&quot;);
351         }
352 
353         int getPort() {
354             return server.getAddress().getPort();
355         }
356 
357         @Override
358         public void handle(HttpExchange t) throws IOException {
359             System.out.println(&quot;HttpServer: handle connection&quot;);
360 
361             // read a request
362             try (InputStream is = t.getRequestBody()) {
363                 while (is.read() &gt; 0);
364             }
365 
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import com.sun.net.httpserver.HttpExchange;
 25 import com.sun.net.httpserver.HttpHandler;
 26 import com.sun.net.httpserver.HttpServer;
 27 import java.io.BufferedReader;
 28 import java.io.InputStreamReader;
 29 import java.io.IOException;
 30 import java.io.InputStream;
 31 import java.net.Authenticator;
<span class="line-added"> 32 import java.net.InetAddress;</span>
 33 import java.net.InetSocketAddress;
 34 import java.net.PasswordAuthentication;
 35 import java.net.URL;
 36 import java.net.URLConnection;
 37 import java.util.List;
 38 
 39 /*
 40  * @test
 41  * @bug 8138990
 42  * @summary Tests for HTTP Digest auth
 43  *          The impl maintains a cache for auth info,
 44  *          the testcases run in a separate JVM to avoid cache hits
 45  * @modules jdk.httpserver
 46  * @run main/othervm DigestAuth good
 47  * @run main/othervm DigestAuth only_nonce
 48  * @run main/othervm DigestAuth sha1
 49  * @run main/othervm DigestAuth no_header
 50  * @run main/othervm DigestAuth no_nonce
 51  * @run main/othervm DigestAuth no_qop
 52  * @run main/othervm DigestAuth invalid_alg
 53  * @run main/othervm DigestAuth validate_server
 54  * @run main/othervm DigestAuth validate_server_no_qop
 55  */
 56 public class DigestAuth {
 57 

 58     static final String EXPECT_FAILURE = null;
 59     static final String EXPECT_DIGEST = &quot;Digest&quot;;
 60     static final String REALM = &quot;testrealm@host.com&quot;;
 61     static final String NEXT_NONCE = &quot;40f2e879449675f288476d772627370a&quot;;
 62 
 63     static final String GOOD_WWW_AUTH_HEADER = &quot;Digest &quot;
 64             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 65             + &quot;qop=\&quot;auth,auth-int\&quot;, &quot;
 66             + &quot;nonce=\&quot;dcd98b7102dd2f0e8b11d0f600bfb0c093\&quot;, &quot;
 67             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
 68 
 69     static final String GOOD_WWW_AUTH_HEADER_NO_QOP = &quot;Digest &quot;
 70             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 71             + &quot;nonce=\&quot;dcd98b7102dd2f0e8b11d0f600bfb0c093\&quot;, &quot;
 72             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
 73 
 74     static final String WWW_AUTH_HEADER_NO_NONCE = &quot;Digest &quot;
 75             + &quot;realm=\&quot;testrealm@host.com\&quot;, &quot;
 76             + &quot;qop=\&quot;auth,auth-int\&quot;, &quot;
 77             + &quot;opaque=\&quot;5ccc069c403ebaf9f0171e9517f40e41\&quot;&quot;;
</pre>
<hr />
<pre>
102     static final String AUTH_INFO_HEADER_WRONG_DIGEST =
103               &quot;nextnonce=\&quot;&quot; + NEXT_NONCE + &quot;\&quot;, &quot;
104             + &quot;rspauth=\&quot;7327570c586207eca2afae94fc20903d\&quot;, &quot;
105             + &quot;cnonce=\&quot;0a4f113b\&quot;, &quot;
106             + &quot;nc=00000001, &quot;
107             + &quot;qop=auth&quot;;
108 
109     public static void main(String[] args) throws Exception {
110         if (args.length == 0) {
111             throw new RuntimeException(&quot;No testcase specified&quot;);
112         }
113         String testcase = args[0];
114 
115         // start a local HTTP server
116         try (LocalHttpServer server = LocalHttpServer.startServer()) {
117 
118             // set authenticator
119             AuthenticatorImpl auth = new AuthenticatorImpl();
120             Authenticator.setDefault(auth);
121 
<span class="line-modified">122             String url = String.format(&quot;http://%s/test/&quot;, server.getAuthority());</span>

123 
124             boolean success = true;
125             switch (testcase) {
126                 case &quot;good&quot;:
127                     // server returns a good WWW-Authenticate header
128                     server.setWWWAuthHeader(GOOD_WWW_AUTH_HEADER);
129                     success = testAuth(url, auth, EXPECT_DIGEST);
130                     if (auth.lastRequestedPrompt == null ||
131                             !auth.lastRequestedPrompt.equals(REALM)) {
132                         System.out.println(&quot;Unexpected realm: &quot;
133                                 + auth.lastRequestedPrompt);
134                         success = false;
135                     }
136                     break;
137                 case &quot;validate_server&quot;:
138                     // enable processing Authentication-Info headers
139                     System.setProperty(&quot;http.auth.digest.validateServer&quot;,
140                             &quot;true&quot;);
141 
142                     /* Server returns good WWW-Authenticate
</pre>
<hr />
<pre>
304             System.out.println(&quot;AuthenticatorImpl: requested &quot;
305                     + lastRequestedScheme);
306 
307             return new PasswordAuthentication(&quot;Mufasa&quot;,
308                     &quot;Circle Of Life&quot;.toCharArray());
309         }
310     }
311 
312     // local HTTP server which pretends to support HTTP Digest auth
313     static class LocalHttpServer implements HttpHandler, AutoCloseable {
314 
315         private final HttpServer server;
316         private volatile String wwwAuthHeader = null;
317         private volatile String authInfoHeader = null;
318         private volatile String lastRequestedNonce;
319 
320         private LocalHttpServer(HttpServer server) {
321             this.server = server;
322         }
323 
<span class="line-added">324         public String getAuthority() {</span>
<span class="line-added">325             InetAddress address = server.getAddress().getAddress();</span>
<span class="line-added">326             String hostaddr = address.isAnyLocalAddress()</span>
<span class="line-added">327                 ? &quot;localhost&quot; : address.getHostAddress();</span>
<span class="line-added">328             if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="line-added">329                 hostaddr = &quot;[&quot; + hostaddr + &quot;]&quot;;</span>
<span class="line-added">330             }</span>
<span class="line-added">331             return hostaddr + &quot;:&quot; + getPort();</span>
<span class="line-added">332         }</span>
<span class="line-added">333 </span>
334         void setWWWAuthHeader(String wwwAuthHeader) {
335             this.wwwAuthHeader = wwwAuthHeader;
336         }
337 
338         void setAuthInfoHeader(String authInfoHeader) {
339             this.authInfoHeader = authInfoHeader;
340         }
341 
342         static LocalHttpServer startServer() throws IOException {
<span class="line-added">343             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
344             HttpServer httpServer = HttpServer.create(
<span class="line-modified">345                     new InetSocketAddress(loopback, 0), 0);</span>
346             LocalHttpServer localHttpServer = new LocalHttpServer(httpServer);
347             localHttpServer.start();
348 
349             return localHttpServer;
350         }
351 
352         void start() {
353             server.createContext(&quot;/test&quot;, this);
354             server.start();
<span class="line-modified">355             System.out.println(&quot;HttpServer: started on port &quot; + getAuthority());</span>
356         }
357 
358         void stop() {
359             server.stop(0);
360             System.out.println(&quot;HttpServer: stopped&quot;);
361         }
362 
363         int getPort() {
364             return server.getAddress().getPort();
365         }
366 
367         @Override
368         public void handle(HttpExchange t) throws IOException {
369             System.out.println(&quot;HttpServer: handle connection&quot;);
370 
371             // read a request
372             try (InputStream is = t.getRequestBody()) {
373                 while (is.read() &gt; 0);
374             }
375 
</pre>
</td>
</tr>
</table>
<center><a href="../HttpClient/StreamingRetry.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NTLMAuthWithSM.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>