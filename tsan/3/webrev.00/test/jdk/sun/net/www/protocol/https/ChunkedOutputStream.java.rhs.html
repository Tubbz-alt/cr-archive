<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/net/www/protocol/https/ChunkedOutputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 5026745
 27  * @modules java.base/sun.net.www
 28  * @build TestHttpsServer HttpCallback
 29  * @run main/othervm ChunkedOutputStream
<a name="2" id="anc2"></a><span class="line-added"> 30  * @run main/othervm -Djava.net.preferIPv6Addresses=true ChunkedOutputStream</span>
 31  *
 32  *     SunJSSE does not support dynamic system properties, no way to re-use
 33  *     system properties in samevm/agentvm mode.
 34  * @summary Cannot flush output stream when writing to an HttpUrlConnection
 35  */
 36 
 37 import java.io.*;
 38 import java.net.*;
 39 import javax.net.ssl.*;
<a name="3" id="anc3"></a><span class="line-added"> 40 import java.util.concurrent.atomic.AtomicInteger;</span>
 41 
 42 public class ChunkedOutputStream implements HttpCallback {
 43     /*
 44      * Where do we find the keystores for ssl?
 45      */
 46     static String pathToStores = &quot;../../../../../javax/net/ssl/etc&quot;;
 47     static String keyStoreFile = &quot;keystore&quot;;
 48     static String trustStoreFile = &quot;truststore&quot;;
 49     static String passwd = &quot;passphrase&quot;;
 50     static int count = 0;
<a name="4" id="anc4"></a><span class="line-added"> 51     static final AtomicInteger rogueCount = new AtomicInteger();</span>
 52 
 53     static final String str1 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 54                                 &quot;1234567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;+
 55                                 &quot;1434567890abcdefkjsdlkjflkjsldkfjlsdkjflkj&quot;;
 56 
 57     static final String str2 = &quot;Helloworld1234567890abcdefghijklmnopqrstuvwxyz&quot;+
 58                                 &quot;1234567890&quot;;
 59 
<a name="5" id="anc5"></a><span class="line-modified"> 60     public void request(HttpTransaction req) {</span>
 61         try {
 62             // this is needed (count++ doesn&#39;t work), &#39;cause we
 63             // are doing concurrent tests
 64             String path = req.getRequestURI().getPath();
 65             if (path.equals(&quot;/d0&quot;)) {
 66                 count = 0;
 67             } else if (path.equals(&quot;/d01&quot;)) {
 68                 count = 1;
 69             } else if (path.equals(&quot;/d3&quot;)) {
 70                 count = 2;
 71             } else if (path.equals(&quot;/d4&quot;) || path.equals(&quot;/d5&quot;)) {
 72                 count = 3;
 73             } else if (path.equals(&quot;/d6&quot;)) {
 74                 count = 3;
 75             }  else if (path.equals(&quot;/d7&quot;)) {
 76                 count = 4;
 77             }  else if (path.equals(&quot;/d8&quot;)) {
 78                 count = 5;
 79             }
 80 
 81             switch (count) {
 82             case 0: /* test1 -- keeps conn alive */
 83             case 1: /* test2 -- closes conn */
 84                 String reqbody = req.getRequestEntityBody();
 85                 if (!reqbody.equals(str1)) {
<a name="6" id="anc6"></a><span class="line-modified"> 86                     req.sendResponse(500, &quot;Internal server error&quot;);</span>
 87                     req.orderlyClose();
 88                 }
<a name="7" id="anc7"></a><span class="line-modified"> 89                 String chunk = req.getRequestHeader(&quot;Transfer-encoding&quot;);</span>
<span class="line-modified"> 90                 if (!&quot;chunked&quot;.equals(chunk)) {</span>
<span class="line-modified"> 91                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
 92                     req.orderlyClose();
 93                 }
<a name="8" id="anc8"></a><span class="line-modified"> 94                 req.setResponseEntityBody(reqbody);</span>
 95                 if (count == 1) {
<a name="9" id="anc9"></a><span class="line-modified"> 96                     req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
 97                 }
<a name="10" id="anc10"></a><span class="line-modified"> 98                 req.sendResponse(200, &quot;OK&quot;);</span>
 99                 if (count == 1) {
100                     req.orderlyClose();
101                 }
102                 break;
103             case 2: /* test 3 */
104                 reqbody = req.getRequestEntityBody();
105                 if (!reqbody.equals(str2)) {
<a name="11" id="anc11"></a><span class="line-modified">106                     req.sendResponse(500, &quot;Internal server error&quot;);</span>
107                     req.orderlyClose();
108                 }
109                 int clen = Integer.parseInt (
<a name="12" id="anc12"></a><span class="line-modified">110                         req.getRequestHeader(&quot;Content-length&quot;));</span>
111                 if (clen != str2.length()) {
<a name="13" id="anc13"></a><span class="line-modified">112                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
113                     req.orderlyClose();
114                 }
115                 req.setResponseEntityBody (reqbody);
<a name="14" id="anc14"></a><span class="line-modified">116                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">117                 req.sendResponse(200, &quot;OK&quot;);</span>
118                 req.orderlyClose();
119                 break;
120             case 3: /* test 6 */
<a name="15" id="anc15"></a><span class="line-modified">121                 req.setResponseHeader(&quot;Location&quot;, &quot;https://foo.bar/&quot;);</span>
<span class="line-modified">122                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">123                 req.sendResponse(307, &quot;Temporary Redirect&quot;);</span>
124                 req.orderlyClose();
125                 break;
126             case 4: /* test 7 */
127             case 5: /* test 8 */
128                 reqbody = req.getRequestEntityBody();
<a name="16" id="anc16"></a><span class="line-modified">129                 if (reqbody != null &amp;&amp; !&quot;&quot;.equals(reqbody)) {</span>
<span class="line-modified">130                     req.sendResponse(501, &quot;Internal server error&quot;);</span>
131                     req.orderlyClose();
132                 }
<a name="17" id="anc17"></a><span class="line-modified">133                 req.setResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">134                 req.sendResponse(200, &quot;OK&quot;);</span>
<span class="line-added">135                 req.orderlyClose();</span>
<span class="line-added">136                 break;</span>
<span class="line-added">137             default:</span>
<span class="line-added">138                 req.sendResponse(404, &quot;Not Found&quot;);</span>
139                 req.orderlyClose();
140                 break;
141             }
142         } catch (IOException e) {
143             e.printStackTrace();
144         }
145     }
146 
<a name="18" id="anc18"></a><span class="line-modified">147     public boolean dropPlainTextConnections() {</span>
<span class="line-added">148         System.out.println(&quot;Unrecognized SSL message, plaintext connection?&quot;);</span>
<span class="line-added">149         System.out.println(&quot;TestHttpsServer receveived rogue connection: ignoring it.&quot;);</span>
<span class="line-added">150         rogueCount.incrementAndGet();</span>
<span class="line-added">151         return true;</span>
<span class="line-added">152     }</span>
<span class="line-added">153 </span>
<span class="line-added">154     static void readAndCompare(InputStream is, String cmp) throws IOException {</span>
155         int c;
<a name="19" id="anc19"></a><span class="line-modified">156         byte buf[] = new byte[1024];</span>
157         int off = 0;
158         int len = 1024;
159         while ((c=is.read(buf, off, len)) != -1) {
160             off += c;
161             len -= c;
162         }
<a name="20" id="anc20"></a><span class="line-modified">163         String s1 = new String(buf, 0, off, &quot;ISO8859_1&quot;);</span>
164         if (!cmp.equals(s1)) {
<a name="21" id="anc21"></a><span class="line-modified">165             throw new IOException(&quot;strings not same&quot;);</span>
<span class="line-added">166         }</span>
<span class="line-added">167     }</span>
<span class="line-added">168 </span>
<span class="line-added">169     /* basic smoke test: verify that server drops plain connections */</span>
<span class="line-added">170     static void testPlainText(String authority) throws Exception {</span>
<span class="line-added">171         URL url = new URL(&quot;http://&quot; + authority + &quot;/Donauschiffsgesellschaftskapitaenskajuete&quot;);</span>
<span class="line-added">172         System.out.println(&quot;client opening connection to: &quot; + url);</span>
<span class="line-added">173         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-added">174         int rogue = rogueCount.get();</span>
<span class="line-added">175         try {</span>
<span class="line-added">176             int code  = urlc.getResponseCode();</span>
<span class="line-added">177             System.out.println(&quot;Unexpected response: &quot; + code);</span>
<span class="line-added">178             throw new AssertionError(&quot;Unexpected response: &quot; + code);</span>
<span class="line-added">179         } catch (SocketException x) {</span>
<span class="line-added">180             // we expect that the server will drop the connection and</span>
<span class="line-added">181             // close the accepted socket, so we should get a SocketException</span>
<span class="line-added">182             // on the client side, and confirm that this::dropPlainTextConnections</span>
<span class="line-added">183             // has ben called.</span>
<span class="line-added">184             if (rogueCount.get() == rogue) throw x;</span>
<span class="line-added">185             System.out.println(&quot;Got expected exception: &quot; + x);</span>
186         }
187     }
188 
189     /* basic chunked test (runs twice) */
190 
<a name="22" id="anc22"></a><span class="line-modified">191     static void test1(String u) throws Exception {</span>
<span class="line-modified">192         URL url = new URL(u);</span>
<span class="line-modified">193         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">194         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">195         urlc.setChunkedStreamingMode(20);</span>
196         urlc.setDoOutput(true);
<a name="23" id="anc23"></a><span class="line-modified">197         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">198         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">199         os.write(str1.getBytes());</span>
200         os.close();
201         InputStream is = urlc.getInputStream();
<a name="24" id="anc24"></a><span class="line-modified">202         readAndCompare(is, str1);</span>
203         is.close();
204     }
205 
206     /* basic fixed length test */
207 
<a name="25" id="anc25"></a><span class="line-modified">208     static void test3(String u) throws Exception {</span>
<span class="line-modified">209         URL url = new URL(u);</span>
<span class="line-modified">210         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">211         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">212         urlc.setFixedLengthStreamingMode(str2.length());</span>
213         urlc.setDoOutput(true);
<a name="26" id="anc26"></a><span class="line-modified">214         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">215         OutputStream os = urlc.getOutputStream();</span>
216         os.write (str2.getBytes());
217         os.close();
218         InputStream is = urlc.getInputStream();
<a name="27" id="anc27"></a><span class="line-modified">219         readAndCompare(is, str2);</span>
220         is.close();
221     }
222 
223     /* write too few bytes */
224 
<a name="28" id="anc28"></a><span class="line-modified">225     static void test4(String u) throws Exception {</span>
<span class="line-modified">226         URL url = new URL(u);</span>
<span class="line-modified">227         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">228         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">229         urlc.setFixedLengthStreamingMode(str2.length()+1);</span>
230         urlc.setDoOutput(true);
<a name="29" id="anc29"></a><span class="line-modified">231         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">232         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">233         os.write(str2.getBytes());</span>
234         try {
235             os.close();
<a name="30" id="anc30"></a><span class="line-modified">236             throw new Exception(&quot;should have thrown IOException&quot;);</span>
237         } catch (IOException e) {}
238     }
239 
240     /* write too many bytes */
241 
<a name="31" id="anc31"></a><span class="line-modified">242     static void test5(String u) throws Exception {</span>
<span class="line-modified">243         URL url = new URL(u);</span>
<span class="line-modified">244         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">245         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">246         urlc.setFixedLengthStreamingMode(str2.length()-1);</span>
247         urlc.setDoOutput(true);
<a name="32" id="anc32"></a><span class="line-modified">248         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">249         OutputStream os = urlc.getOutputStream();</span>
250         try {
<a name="33" id="anc33"></a><span class="line-modified">251             os.write(str2.getBytes());</span>
<span class="line-modified">252             throw new Exception(&quot;should have thrown IOException&quot;);</span>
253         } catch (IOException e) {}
254     }
255 
256     /* check for HttpRetryException on redirection */
257 
<a name="34" id="anc34"></a><span class="line-modified">258     static void test6(String u) throws Exception {</span>
<span class="line-modified">259         URL url = new URL(u);</span>
<span class="line-modified">260         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">261         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">262         urlc.setChunkedStreamingMode(20);</span>
263         urlc.setDoOutput(true);
<a name="35" id="anc35"></a><span class="line-modified">264         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">265         OutputStream os = urlc.getOutputStream();</span>
<span class="line-modified">266         os.write(str1.getBytes());</span>
267         os.close();
268         try {
269             InputStream is = urlc.getInputStream();
<a name="36" id="anc36"></a><span class="line-modified">270             throw new Exception(&quot;should have gotten HttpRetryException&quot;);</span>
271         } catch (HttpRetryException e) {
272             if (e.responseCode() != 307) {
<a name="37" id="anc37"></a><span class="line-modified">273                 throw new Exception(&quot;Wrong response code &quot; + e.responseCode());</span>
274             }
<a name="38" id="anc38"></a><span class="line-modified">275             if (!e.getLocation().equals(&quot;https://foo.bar/&quot;)) {</span>
<span class="line-modified">276                 throw new Exception(&quot;Wrong location &quot; + e.getLocation());</span>
277             }
278         }
279     }
280 
281     /* next two tests send zero length posts */
282 
<a name="39" id="anc39"></a><span class="line-modified">283     static void test7(String u) throws Exception {</span>
<span class="line-modified">284         URL url = new URL(u);</span>
<span class="line-modified">285         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">286         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">287         urlc.setChunkedStreamingMode(20);</span>
288         urlc.setDoOutput(true);
<a name="40" id="anc40"></a><span class="line-modified">289         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">290         OutputStream os = urlc.getOutputStream();</span>
291         os.close();
292         int ret = urlc.getResponseCode();
293         if (ret != 200) {
<a name="41" id="anc41"></a><span class="line-modified">294             throw new Exception(&quot;Expected 200: got &quot; + ret);</span>
295         }
296     }
297 
<a name="42" id="anc42"></a><span class="line-modified">298     static void test8(String u) throws Exception {</span>
<span class="line-modified">299         URL url = new URL(u);</span>
<span class="line-modified">300         System.out.println(&quot;client opening connection to: &quot; + u);</span>
<span class="line-modified">301         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
<span class="line-modified">302         urlc.setFixedLengthStreamingMode(0);</span>
303         urlc.setDoOutput(true);
<a name="43" id="anc43"></a><span class="line-modified">304         urlc.setRequestMethod(&quot;POST&quot;);</span>
<span class="line-modified">305         OutputStream os = urlc.getOutputStream();</span>
306         os.close();
307         int ret = urlc.getResponseCode();
308         if (ret != 200) {
<a name="44" id="anc44"></a><span class="line-modified">309             throw new Exception(&quot;Expected 200: got &quot; + ret);</span>
310         }
311     }
312 
313     static TestHttpsServer server;
314 
<a name="45" id="anc45"></a><span class="line-modified">315     public static void main(String[] args) throws Exception {</span>
316         // setup properties to do ssl
317         String keyFilename =
318             System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
319                 &quot;/&quot; + keyStoreFile;
320         String trustFilename =
321             System.getProperty(&quot;test.src&quot;, &quot;./&quot;) + &quot;/&quot; + pathToStores +
322                 &quot;/&quot; + trustStoreFile;
323 
<a name="46" id="anc46"></a><span class="line-added">324         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">325 </span>
326         HostnameVerifier reservedHV =
327             HttpsURLConnection.getDefaultHostnameVerifier();
328         try {
329             System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyFilename);
330             System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, passwd);
331             System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustFilename);
332             System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, passwd);
333             HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
334 
335             try {
336                 server = new TestHttpsServer(
<a name="47" id="anc47"></a><span class="line-modified">337                         new ChunkedOutputStream(), 1, 10, loopback, 0);</span>
<span class="line-modified">338                 System.out.println(&quot;Server started: listening on: &quot; + server.getAuthority());</span>
<span class="line-added">339                 testPlainText(server.getAuthority());</span>
340                 // the test server doesn&#39;t support keep-alive yet
<a name="48" id="anc48"></a><span class="line-modified">341                 // test1(&quot;http://&quot; + server.getAuthority() + &quot;/d0&quot;);</span>
<span class="line-modified">342                 test1(&quot;https://&quot; + server.getAuthority() + &quot;/d01&quot;);</span>
<span class="line-modified">343                 test3(&quot;https://&quot; + server.getAuthority() + &quot;/d3&quot;);</span>
<span class="line-modified">344                 test4(&quot;https://&quot; + server.getAuthority() + &quot;/d4&quot;);</span>
<span class="line-modified">345                 test5(&quot;https://&quot; + server.getAuthority() + &quot;/d5&quot;);</span>
<span class="line-modified">346                 test6(&quot;https://&quot; + server.getAuthority() + &quot;/d6&quot;);</span>
<span class="line-modified">347                 test7(&quot;https://&quot; + server.getAuthority() + &quot;/d7&quot;);</span>
<span class="line-modified">348                 test8(&quot;https://&quot; + server.getAuthority() + &quot;/d8&quot;);</span>
349             } catch (Exception e) {
350                 if (server != null) {
351                     server.terminate();
352                 }
353                 throw e;
354             }
355             server.terminate();
356         } finally {
357             HttpsURLConnection.setDefaultHostnameVerifier(reservedHV);
358         }
359     }
360 
361     static class NameVerifier implements HostnameVerifier {
362         public boolean verify(String hostname, SSLSession session) {
363             return true;
364         }
365     }
366 
<a name="49" id="anc49"></a><span class="line-modified">367     public static void except(String s) {</span>
368         server.terminate();
<a name="50" id="anc50"></a><span class="line-modified">369         throw new RuntimeException(s);</span>
370     }
371 }
<a name="51" id="anc51"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="51" type="hidden" />
</body>
</html>