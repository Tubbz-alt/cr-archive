<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/https/HttpsClient/ProxyAuthTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../HttpCallback.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/HttpsClient/ProxyAuthTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 42  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=BAsIc
 43  *      ProxyAuthTest fail
 44  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Basic,Digest
 45  *      ProxyAuthTest fail
 46  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Unknown,bAsIc
 47  *      ProxyAuthTest fail
 48  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=
 49  *      ProxyAuthTest succeed
 50  * @run main/othervm
 51  *      -Djdk.http.auth.tunneling.disabledSchemes=Digest,NTLM,Negotiate
 52  *      ProxyAuthTest succeed
 53  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=UNKNOWN,notKnown
 54  *      ProxyAuthTest succeed
 55  */
 56 
 57 import java.io.BufferedReader;
 58 import java.io.DataOutputStream;
 59 import java.io.IOException;
 60 import java.io.InputStreamReader;
 61 import java.net.Authenticator;

 62 import java.net.InetSocketAddress;
 63 import java.net.PasswordAuthentication;
 64 import java.net.Proxy;
 65 import java.net.URL;
 66 import javax.net.ssl.HostnameVerifier;
 67 import javax.net.ssl.HttpsURLConnection;
 68 import javax.net.ssl.SSLSession;
 69 import javax.net.ssl.SSLSocket;
 70 import javax.net.ssl.SSLContext;
 71 import static java.nio.charset.StandardCharsets.US_ASCII;
 72 
 73 /*
 74  * ProxyAuthTest.java -- includes a simple server that can serve
 75  * Http get request in both clear and secure channel, and a client
 76  * that makes https requests behind the firewall through an
 77  * authentication proxy
 78  */
 79 
 80 public class ProxyAuthTest extends SSLSocketTemplate {
 81     private static boolean expectSuccess;
 82 




 83     /*
 84      * Run the test case.
 85      */
 86     public static void main(String[] args) throws Exception {
 87         // Get the customized arguments.
 88         parseArguments(args);
 89 
 90         (new ProxyAuthTest()).run();
 91     }
 92 
 93     @Override
 94     protected boolean isCustomizedClientConnection() {
 95         return true;
 96     }
 97 
 98     @Override
 99     protected void runServerApplication(SSLSocket socket) throws Exception {
100         String response = &quot;Proxy authentication for tunneling succeeded ..&quot;;
101         DataOutputStream out = new DataOutputStream(socket.getOutputStream());
102         try {
</pre>
<hr />
<pre>
126     @Override
127     protected void runClientApplication(int serverPort) throws Exception {
128         /*
129          * Set the default SSLSocketFactory.
130          */
131         SSLContext context = createClientSSLContext();
132         HttpsURLConnection.setDefaultSSLSocketFactory(
133                 context.getSocketFactory());
134 
135         /*
136          * setup up a proxy with authentication information
137          */
138         ProxyTunnelServer ps = setupProxy();
139 
140         /*
141          * we want to avoid URLspoofCheck failures in cases where the cert
142          * DN name does not match the hostname in the URL.
143          */
144         HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
145 
<span class="line-modified">146         InetSocketAddress paddr =</span>
<span class="line-modified">147                 new InetSocketAddress(&quot;localhost&quot;, ps.getPort());</span>

148         Proxy proxy = new Proxy(Proxy.Type.HTTP, paddr);
149 





150         URL url = new URL(
<span class="line-modified">151                 &quot;https://&quot; + &quot;localhost:&quot; + serverPort + &quot;/index.html&quot;);</span>

152         BufferedReader in = null;
153         HttpsURLConnection uc = (HttpsURLConnection) url.openConnection(proxy);
154         try {
155             in = new BufferedReader(new InputStreamReader(uc.getInputStream()));
156             String inputLine;
<span class="line-modified">157             System.out.print(&quot;Client recieved from the server: &quot;);</span>
158             while ((inputLine = in.readLine()) != null) {
159                 System.out.println(inputLine);
160             }
161             if (!expectSuccess) {
162                 throw new RuntimeException(
163                     &quot;Expected exception/failure to connect, but succeeded.&quot;);
164             }
165         } catch (IOException e) {
166             if (expectSuccess) {
167                 System.out.println(&quot;Client side failed: &quot; + e.getMessage());
168                 throw e;
169             }
170 
171             // Assert that the error stream is not accessible from the failed
172             // tunnel setup.
173             if (uc.getErrorStream() != null) {
174                 throw new RuntimeException(&quot;Unexpected error stream.&quot;);
175             }
176 
177             if (!e.getMessage().contains(&quot;Unable to tunnel through proxy&quot;) ||
</pre>
<hr />
<pre>
209         String line = null;
210         System.out.println(&quot;Server received: &quot;);
211         do {
212             if (line != null) {
213                 System.out.println(line);
214             }
215             line = in.readLine();
216         } while ((line.length() != 0) &amp;&amp;
217                 (line.charAt(0) != &#39;\r&#39;) &amp;&amp; (line.charAt(0) != &#39;\n&#39;));
218     }
219 
220     private static class NameVerifier implements HostnameVerifier {
221 
222         @Override
223         public boolean verify(String hostname, SSLSession session) {
224             return true;
225         }
226     }
227 
228     private static ProxyTunnelServer setupProxy() throws IOException {
<span class="line-modified">229         ProxyTunnelServer pserver = new ProxyTunnelServer();</span>

230 
231         /*
232          * register a system wide authenticator and setup the proxy for
233          * authentication
234          */
235         Authenticator.setDefault(new TestAuthenticator());
236 
237         // register with the username and password
238         pserver.needUserAuth(true);
239         pserver.setUserAuth(&quot;Test&quot;, &quot;test123&quot;);
240 
241         pserver.start();
242         return pserver;
243     }
244 
245     private static class TestAuthenticator extends Authenticator {
246 
247         @Override
248         public PasswordAuthentication getPasswordAuthentication() {
249             return new PasswordAuthentication(&quot;Test&quot;, &quot;test123&quot;.toCharArray());
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 42  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=BAsIc
 43  *      ProxyAuthTest fail
 44  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Basic,Digest
 45  *      ProxyAuthTest fail
 46  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=Unknown,bAsIc
 47  *      ProxyAuthTest fail
 48  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=
 49  *      ProxyAuthTest succeed
 50  * @run main/othervm
 51  *      -Djdk.http.auth.tunneling.disabledSchemes=Digest,NTLM,Negotiate
 52  *      ProxyAuthTest succeed
 53  * @run main/othervm -Djdk.http.auth.tunneling.disabledSchemes=UNKNOWN,notKnown
 54  *      ProxyAuthTest succeed
 55  */
 56 
 57 import java.io.BufferedReader;
 58 import java.io.DataOutputStream;
 59 import java.io.IOException;
 60 import java.io.InputStreamReader;
 61 import java.net.Authenticator;
<span class="line-added"> 62 import java.net.InetAddress;</span>
 63 import java.net.InetSocketAddress;
 64 import java.net.PasswordAuthentication;
 65 import java.net.Proxy;
 66 import java.net.URL;
 67 import javax.net.ssl.HostnameVerifier;
 68 import javax.net.ssl.HttpsURLConnection;
 69 import javax.net.ssl.SSLSession;
 70 import javax.net.ssl.SSLSocket;
 71 import javax.net.ssl.SSLContext;
 72 import static java.nio.charset.StandardCharsets.US_ASCII;
 73 
 74 /*
 75  * ProxyAuthTest.java -- includes a simple server that can serve
 76  * Http get request in both clear and secure channel, and a client
 77  * that makes https requests behind the firewall through an
 78  * authentication proxy
 79  */
 80 
 81 public class ProxyAuthTest extends SSLSocketTemplate {
 82     private static boolean expectSuccess;
 83 
<span class="line-added"> 84     ProxyAuthTest() {</span>
<span class="line-added"> 85         serverAddress = InetAddress.getLoopbackAddress();</span>
<span class="line-added"> 86     }</span>
<span class="line-added"> 87 </span>
 88     /*
 89      * Run the test case.
 90      */
 91     public static void main(String[] args) throws Exception {
 92         // Get the customized arguments.
 93         parseArguments(args);
 94 
 95         (new ProxyAuthTest()).run();
 96     }
 97 
 98     @Override
 99     protected boolean isCustomizedClientConnection() {
100         return true;
101     }
102 
103     @Override
104     protected void runServerApplication(SSLSocket socket) throws Exception {
105         String response = &quot;Proxy authentication for tunneling succeeded ..&quot;;
106         DataOutputStream out = new DataOutputStream(socket.getOutputStream());
107         try {
</pre>
<hr />
<pre>
131     @Override
132     protected void runClientApplication(int serverPort) throws Exception {
133         /*
134          * Set the default SSLSocketFactory.
135          */
136         SSLContext context = createClientSSLContext();
137         HttpsURLConnection.setDefaultSSLSocketFactory(
138                 context.getSocketFactory());
139 
140         /*
141          * setup up a proxy with authentication information
142          */
143         ProxyTunnelServer ps = setupProxy();
144 
145         /*
146          * we want to avoid URLspoofCheck failures in cases where the cert
147          * DN name does not match the hostname in the URL.
148          */
149         HttpsURLConnection.setDefaultHostnameVerifier(new NameVerifier());
150 
<span class="line-modified">151         InetSocketAddress paddr = InetSocketAddress</span>
<span class="line-modified">152             .createUnresolved(ps.getInetAddress().getHostAddress(),</span>
<span class="line-added">153                               ps.getPort());</span>
154         Proxy proxy = new Proxy(Proxy.Type.HTTP, paddr);
155 
<span class="line-added">156         InetAddress serverAddress = this.serverAddress;</span>
<span class="line-added">157         String host = serverAddress == null</span>
<span class="line-added">158                 ? &quot;localhost&quot;</span>
<span class="line-added">159                 : serverAddress.getHostAddress();</span>
<span class="line-added">160         if (host.indexOf(&#39;:&#39;) &gt; -1) host = &quot;[&quot; + host + &quot;]&quot;;</span>
161         URL url = new URL(
<span class="line-modified">162                 &quot;https://&quot; + host + &quot;:&quot; + serverPort + &quot;/index.html&quot;);</span>
<span class="line-added">163         System.out.println(&quot;URL: &quot; + url);</span>
164         BufferedReader in = null;
165         HttpsURLConnection uc = (HttpsURLConnection) url.openConnection(proxy);
166         try {
167             in = new BufferedReader(new InputStreamReader(uc.getInputStream()));
168             String inputLine;
<span class="line-modified">169             System.out.print(&quot;Client received from the server: &quot;);</span>
170             while ((inputLine = in.readLine()) != null) {
171                 System.out.println(inputLine);
172             }
173             if (!expectSuccess) {
174                 throw new RuntimeException(
175                     &quot;Expected exception/failure to connect, but succeeded.&quot;);
176             }
177         } catch (IOException e) {
178             if (expectSuccess) {
179                 System.out.println(&quot;Client side failed: &quot; + e.getMessage());
180                 throw e;
181             }
182 
183             // Assert that the error stream is not accessible from the failed
184             // tunnel setup.
185             if (uc.getErrorStream() != null) {
186                 throw new RuntimeException(&quot;Unexpected error stream.&quot;);
187             }
188 
189             if (!e.getMessage().contains(&quot;Unable to tunnel through proxy&quot;) ||
</pre>
<hr />
<pre>
221         String line = null;
222         System.out.println(&quot;Server received: &quot;);
223         do {
224             if (line != null) {
225                 System.out.println(line);
226             }
227             line = in.readLine();
228         } while ((line.length() != 0) &amp;&amp;
229                 (line.charAt(0) != &#39;\r&#39;) &amp;&amp; (line.charAt(0) != &#39;\n&#39;));
230     }
231 
232     private static class NameVerifier implements HostnameVerifier {
233 
234         @Override
235         public boolean verify(String hostname, SSLSession session) {
236             return true;
237         }
238     }
239 
240     private static ProxyTunnelServer setupProxy() throws IOException {
<span class="line-modified">241         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">242         ProxyTunnelServer pserver = new ProxyTunnelServer(loopback);</span>
243 
244         /*
245          * register a system wide authenticator and setup the proxy for
246          * authentication
247          */
248         Authenticator.setDefault(new TestAuthenticator());
249 
250         // register with the username and password
251         pserver.needUserAuth(true);
252         pserver.setUserAuth(&quot;Test&quot;, &quot;test123&quot;);
253 
254         pserver.start();
255         return pserver;
256     }
257 
258     private static class TestAuthenticator extends Authenticator {
259 
260         @Override
261         public PasswordAuthentication getPasswordAuthentication() {
262             return new PasswordAuthentication(&quot;Test&quot;, &quot;test123&quot;.toCharArray());
</pre>
</td>
</tr>
</table>
<center><a href="../HttpCallback.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProxyTunnelServer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>