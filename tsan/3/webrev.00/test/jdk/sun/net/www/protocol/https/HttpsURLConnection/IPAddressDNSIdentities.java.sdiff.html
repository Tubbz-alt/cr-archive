<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/net/www/protocol/https/HttpsURLConnection/IPAddressDNSIdentities.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HttpsSocketFacTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IPAddressIPIdentities.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/https/HttpsURLConnection/IPAddressDNSIdentities.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2011, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 6766775

 26  * @summary X509 certificate hostname checking is broken in JDK1.6.0_10
 27  * @run main/othervm IPAddressDNSIdentities
 28  *
 29  *     SunJSSE does not support dynamic system properties, no way to re-use
 30  *     system properties in samevm/agentvm mode.
 31  * @author Xuelei Fan
 32  */
 33 
 34 import java.net.*;
 35 import java.util.*;
 36 import java.io.*;
 37 import javax.net.ssl.*;
 38 import java.security.KeyStore;
 39 import java.security.KeyFactory;
 40 import java.security.cert.Certificate;
 41 import java.security.cert.CertificateFactory;
 42 import java.security.spec.*;
 43 import java.security.interfaces.*;
 44 import java.math.BigInteger;

 45 
 46 /*
 47  * Certificates and key used in the test.
 48  *
 49  * TLS server certificate:
 50  * server private key:
 51  * -----BEGIN RSA PRIVATE KEY-----
 52  * Proc-Type: 4,ENCRYPTED
 53  * DEK-Info: DES-EDE3-CBC,D9AE407F6D0E389A
 54  *
 55  * WPrA7TFol/cQCcp9oHnXWNpYlvRbbIcQj0m+RKT2Iuzfus+DHt3Zadf8nJpKfX2e
 56  * h2rnhlzCN9M7djRDooZKDOPCsdBn51Au7HlZF3S3Opgo7D8XFM1a8t1Je4ke14oI
 57  * nw6QKYsBblRziPnP2PZ0zvX24nOv7bbY8beynlJHGs00VWSFdoH2DS0aE1p6D+3n
 58  * ptJuJ75dVfZFK4X7162APlNXevX8D6PEQpSiRw1rjjGGcnvQ4HdWk3BxDVDcCNJb
 59  * Y1aGNRxsjTDvPi3R9Qx2M+W03QzEPx4SR3ZHVskeSJHaetM0TM/w/45Paq4GokXP
 60  * ZeTnbEx1xmjkA7h+t4doLL4watx5F6yLsJzu8xB3lt/1EtmkYtLz1t7X4BetPAXz
 61  * zS69X/VwhKfsOI3qXBWuL2oHPyhDmT1gcaUQwEPSV6ogHEEQEDXdiUS8heNK13KF
 62  * TCQYFkETvV2BLxUhV1hypPzRQ6tUpJiAbD5KmoK2lD9slshG2QtvKQq0/bgkDY5J
 63  * LhDHV2dtcZ3kDPkkZXpbcJQvoeH3d09C5sIsuTFo2zgNR6oETHUc5TzP6FY2YYRa
 64  * QcK5HcmtsRRiXFm01ac+aMejJUIujjFt84SiKWT/73vC8AmY4tYcJBLjCg4XIxSH
</pre>
<hr />
<pre>
631     volatile static boolean closeReady = false;
632 
633     /*
634      * Turn on SSL debugging?
635      */
636     static boolean debug = false;
637 
638     private SSLServerSocket sslServerSocket = null;
639 
640     /*
641      * Define the server side of the test.
642      *
643      * If the server prematurely exits, serverReady will be set to true
644      * to avoid infinite hangs.
645      */
646     void doServerSide() throws Exception {
647         SSLContext context = getSSLContext(trusedCertStr, serverCertStr,
648             serverModulus, serverPrivateExponent, passphrase);
649         SSLServerSocketFactory sslssf = context.getServerSocketFactory();
650 




651         sslServerSocket =
<span class="line-modified">652             (SSLServerSocket) sslssf.createServerSocket(serverPort);</span>

653         serverPort = sslServerSocket.getLocalPort();
654 
655         /*
656          * Signal Client, we&#39;re ready for his connect.
657          */
658         serverReady = true;
659 
660         SSLSocket sslSocket = (SSLSocket) sslServerSocket.accept();
661         sslSocket.setNeedClientAuth(true);
662 
663         PrintStream out =
664                 new PrintStream(sslSocket.getOutputStream());
665 
666         try {
667             // ignore request data
668 
669             // send the response
670             out.print(&quot;HTTP/1.1 200 OK\r\n&quot;);
671             out.print(&quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot;);
672             out.print(&quot;Content-Length: &quot;+ 9 +&quot;\r\n&quot;);
</pre>
<hr />
<pre>
693      * to avoid infinite hangs.
694      */
695     void doClientSide() throws Exception {
696         SSLContext reservedSSLContext = SSLContext.getDefault();
697         try {
698             SSLContext context = getSSLContext(trusedCertStr, clientCertStr,
699                 clientModulus, clientPrivateExponent, passphrase);
700 
701             SSLContext.setDefault(context);
702 
703             /*
704              * Wait for server to get started.
705              */
706             while (!serverReady) {
707                 Thread.sleep(50);
708             }
709 
710             HttpsURLConnection http = null;
711 
712             /* establish http connection to server */
<span class="line-modified">713             URL url = new URL(&quot;https://127.0.0.1:&quot; + serverPort+&quot;/&quot;);</span>





714             System.out.println(&quot;url is &quot;+url.toString());
715 
716             try {
<span class="line-modified">717                 http = (HttpsURLConnection)url.openConnection();</span>
718 
719                 int respCode = http.getResponseCode();
720                 System.out.println(&quot;respCode = &quot; + respCode);
721 
722                 throw new Exception(&quot;Unexpectly found &quot; +
723                         &quot;subject alternative name matching IP address&quot;);
724             } catch (SSLHandshakeException sslhe) {
725                 // no subject alternative names matching IP address 127.0.0.1
726                 // found that&#39;s the expected exception, ignore it.
727             } catch (IOException ioe) {
728                 // HttpsClient may throw IOE during checking URL spoofing,
729                 // that&#39;s the expected exception, ignore it.
730             } finally {
731                 if (http != null) {
732                     http.disconnect();
733                 }
734                 closeReady = true;
735             }
736         } finally {
737             SSLContext.setDefault(reservedSSLContext);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 6766775
<span class="line-added"> 26  * @library /test/lib</span>
 27  * @summary X509 certificate hostname checking is broken in JDK1.6.0_10
 28  * @run main/othervm IPAddressDNSIdentities
 29  *
 30  *     SunJSSE does not support dynamic system properties, no way to re-use
 31  *     system properties in samevm/agentvm mode.
 32  * @author Xuelei Fan
 33  */
 34 
 35 import java.net.*;
 36 import java.util.*;
 37 import java.io.*;
 38 import javax.net.ssl.*;
 39 import java.security.KeyStore;
 40 import java.security.KeyFactory;
 41 import java.security.cert.Certificate;
 42 import java.security.cert.CertificateFactory;
 43 import java.security.spec.*;
 44 import java.security.interfaces.*;
 45 import java.math.BigInteger;
<span class="line-added"> 46 import jdk.test.lib.net.URIBuilder;</span>
 47 
 48 /*
 49  * Certificates and key used in the test.
 50  *
 51  * TLS server certificate:
 52  * server private key:
 53  * -----BEGIN RSA PRIVATE KEY-----
 54  * Proc-Type: 4,ENCRYPTED
 55  * DEK-Info: DES-EDE3-CBC,D9AE407F6D0E389A
 56  *
 57  * WPrA7TFol/cQCcp9oHnXWNpYlvRbbIcQj0m+RKT2Iuzfus+DHt3Zadf8nJpKfX2e
 58  * h2rnhlzCN9M7djRDooZKDOPCsdBn51Au7HlZF3S3Opgo7D8XFM1a8t1Je4ke14oI
 59  * nw6QKYsBblRziPnP2PZ0zvX24nOv7bbY8beynlJHGs00VWSFdoH2DS0aE1p6D+3n
 60  * ptJuJ75dVfZFK4X7162APlNXevX8D6PEQpSiRw1rjjGGcnvQ4HdWk3BxDVDcCNJb
 61  * Y1aGNRxsjTDvPi3R9Qx2M+W03QzEPx4SR3ZHVskeSJHaetM0TM/w/45Paq4GokXP
 62  * ZeTnbEx1xmjkA7h+t4doLL4watx5F6yLsJzu8xB3lt/1EtmkYtLz1t7X4BetPAXz
 63  * zS69X/VwhKfsOI3qXBWuL2oHPyhDmT1gcaUQwEPSV6ogHEEQEDXdiUS8heNK13KF
 64  * TCQYFkETvV2BLxUhV1hypPzRQ6tUpJiAbD5KmoK2lD9slshG2QtvKQq0/bgkDY5J
 65  * LhDHV2dtcZ3kDPkkZXpbcJQvoeH3d09C5sIsuTFo2zgNR6oETHUc5TzP6FY2YYRa
 66  * QcK5HcmtsRRiXFm01ac+aMejJUIujjFt84SiKWT/73vC8AmY4tYcJBLjCg4XIxSH
</pre>
<hr />
<pre>
633     volatile static boolean closeReady = false;
634 
635     /*
636      * Turn on SSL debugging?
637      */
638     static boolean debug = false;
639 
640     private SSLServerSocket sslServerSocket = null;
641 
642     /*
643      * Define the server side of the test.
644      *
645      * If the server prematurely exits, serverReady will be set to true
646      * to avoid infinite hangs.
647      */
648     void doServerSide() throws Exception {
649         SSLContext context = getSSLContext(trusedCertStr, serverCertStr,
650             serverModulus, serverPrivateExponent, passphrase);
651         SSLServerSocketFactory sslssf = context.getServerSocketFactory();
652 
<span class="line-added">653         // doClientSide() connects to the loopback address</span>
<span class="line-added">654         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">655         InetSocketAddress address = new InetSocketAddress(loopback, serverPort);</span>
<span class="line-added">656 </span>
657         sslServerSocket =
<span class="line-modified">658             (SSLServerSocket) sslssf.createServerSocket();</span>
<span class="line-added">659         sslServerSocket.bind(address);</span>
660         serverPort = sslServerSocket.getLocalPort();
661 
662         /*
663          * Signal Client, we&#39;re ready for his connect.
664          */
665         serverReady = true;
666 
667         SSLSocket sslSocket = (SSLSocket) sslServerSocket.accept();
668         sslSocket.setNeedClientAuth(true);
669 
670         PrintStream out =
671                 new PrintStream(sslSocket.getOutputStream());
672 
673         try {
674             // ignore request data
675 
676             // send the response
677             out.print(&quot;HTTP/1.1 200 OK\r\n&quot;);
678             out.print(&quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot;);
679             out.print(&quot;Content-Length: &quot;+ 9 +&quot;\r\n&quot;);
</pre>
<hr />
<pre>
700      * to avoid infinite hangs.
701      */
702     void doClientSide() throws Exception {
703         SSLContext reservedSSLContext = SSLContext.getDefault();
704         try {
705             SSLContext context = getSSLContext(trusedCertStr, clientCertStr,
706                 clientModulus, clientPrivateExponent, passphrase);
707 
708             SSLContext.setDefault(context);
709 
710             /*
711              * Wait for server to get started.
712              */
713             while (!serverReady) {
714                 Thread.sleep(50);
715             }
716 
717             HttpsURLConnection http = null;
718 
719             /* establish http connection to server */
<span class="line-modified">720             URL url = URIBuilder.newBuilder()</span>
<span class="line-added">721                 .scheme(&quot;https&quot;)</span>
<span class="line-added">722                 .loopback()</span>
<span class="line-added">723                 .port(serverPort)</span>
<span class="line-added">724                 .path(&quot;/&quot;)</span>
<span class="line-added">725                 .toURL();</span>
726             System.out.println(&quot;url is &quot;+url.toString());
727 
728             try {
<span class="line-modified">729                 http = (HttpsURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
730 
731                 int respCode = http.getResponseCode();
732                 System.out.println(&quot;respCode = &quot; + respCode);
733 
734                 throw new Exception(&quot;Unexpectly found &quot; +
735                         &quot;subject alternative name matching IP address&quot;);
736             } catch (SSLHandshakeException sslhe) {
737                 // no subject alternative names matching IP address 127.0.0.1
738                 // found that&#39;s the expected exception, ignore it.
739             } catch (IOException ioe) {
740                 // HttpsClient may throw IOE during checking URL spoofing,
741                 // that&#39;s the expected exception, ignore it.
742             } finally {
743                 if (http != null) {
744                     http.disconnect();
745                 }
746                 closeReady = true;
747             }
748         } finally {
749             SSLContext.setDefault(reservedSSLContext);
</pre>
</td>
</tr>
</table>
<center><a href="HttpsSocketFacTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IPAddressIPIdentities.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>