<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/net/www/protocol/http/NoNTLM.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8004502
<a name="2" id="anc2"></a>
 26  * @summary Sanity check that NTLM will not be selected by the http protocol
 27  *    handler when running on a profile that does not support NTLM
 28  * @modules java.base/sun.net.www
 29  *          java.base/sun.net.www.protocol.http:open
 30  * @run main/othervm NoNTLM
<a name="3" id="anc3"></a>
 31  */
 32 
 33 import java.io.IOException;
 34 import java.lang.reflect.Field;
 35 import java.net.Authenticator;
 36 import java.net.HttpURLConnection;
<a name="4" id="anc4"></a>
 37 import java.net.PasswordAuthentication;
 38 import java.net.Proxy;
 39 import java.net.ServerSocket;
 40 import java.net.Socket;
 41 import java.net.URL;
<a name="5" id="anc5"></a>
 42 import sun.net.www.MessageHeader;
 43 
 44 public class NoNTLM {
 45 
 46     static final String CRLF = &quot;\r\n&quot;;
 47 
 48     static final String OKAY =
 49         &quot;HTTP/1.1 200&quot; + CRLF +
 50         &quot;Content-Length: 0&quot; + CRLF +
 51         &quot;Connection: close&quot; + CRLF +
 52         CRLF;
 53 
 54     static class Client implements Runnable {
 55         private final URL url;
 56         private volatile IOException ioe;
 57         private volatile int respCode;
 58 
 59         Client(int port) throws IOException {
<a name="6" id="anc6"></a><span class="line-modified"> 60             this.url = new URL(&quot;http://127.0.0.1:&quot; + port + &quot;/foo.html&quot;);</span>






 61         }
 62 
 63         public void run() {
 64             try {
 65                 HttpURLConnection uc =
 66                     (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);
 67                 try {
 68                     uc.getInputStream();
 69                 } catch (IOException x) {
 70                     respCode = uc.getResponseCode();
 71                     throw x;
 72                 }
 73                 uc.disconnect();
 74             } catch (IOException x) {
 75                 if (respCode == 0)
 76                     respCode = -1;
 77                 ioe = x;
 78             }
 79         }
 80 
 81         IOException ioException() {
 82             return ioe;
 83         }
 84 
 85         int respCode() {
 86             return respCode;
 87         }
 88 
 89         static void start(int port) throws IOException {
 90             Client client = new Client(port);
 91             new Thread(client).start();
 92         }
 93     }
 94 
 95     /**
 96      * Return the http response with WWW-Authenticate headers for the given
 97      * authentication schemes.
 98      */
 99     static String authReplyFor(String... schemes) {
100         // construct the server reply
101         String reply = &quot;HTTP/1.1 401 Unauthorized&quot; + CRLF +
102                        &quot;Content-Length: 0&quot;+ CRLF +
103                        &quot;Connection: close&quot; + CRLF;
104         for (String s: schemes) {
105             switch (s) {
106                 case &quot;Basic&quot; :
107                     reply += &quot;WWW-Authenticate: Basic realm=\&quot;wallyworld\&quot;&quot; + CRLF;
108                     break;
109                 case &quot;Digest&quot; :
110                     reply += &quot;WWW-Authenticate: Digest&quot; +
111                              &quot; realm=\&quot;wallyworld\&quot;&quot; +
112                              &quot; domain=/&quot; +
113                              &quot; nonce=\&quot;abcdefghijklmnopqrstuvwxyz\&quot;&quot; +
114                              &quot; qop=\&quot;auth\&quot;&quot; + CRLF;
115                     break;
116                 case &quot;NTLM&quot; :
117                     reply += &quot;WWW-Authenticate: NTLM&quot; + CRLF;
118                     break;
119                 default :
120                     throw new RuntimeException(&quot;Should not get here&quot;);
121             }
122         }
123         reply += CRLF;
124         return reply;
125     }
126 
127     /**
128      * Test the http protocol handler with the given authentication schemes
129      * in the WWW-Authenticate header.
130      */
131     static void test(String... schemes) throws IOException {
132 
133         // the authentication scheme that the client is expected to choose
134         String expected = null;
135         for (String s: schemes) {
136             if (expected == null) {
137                 expected = s;
138             } else if (s.equals(&quot;Digest&quot;)) {
139                 expected = s;
140             }
141         }
142 
143         // server reply
144         String reply = authReplyFor(schemes);
145 
146         System.out.println(&quot;====================================&quot;);
147         System.out.println(&quot;Expect client to choose: &quot; + expected);
148         System.out.println(reply);
<a name="7" id="anc7"></a><span class="line-modified">149 </span>
<span class="line-modified">150         try (ServerSocket ss = new ServerSocket(0)) {</span>
151             Client.start(ss.getLocalPort());
152 
153             // client ---- GET ---&gt; server
154             // client &lt;--- 401 ---- server
155             try (Socket s = ss.accept()) {
156                 new MessageHeader().parseHeader(s.getInputStream());
157                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
158             }
159 
160             // client ---- GET ---&gt; server
161             // client &lt;--- 200 ---- server
162             String auth;
163             try (Socket s = ss.accept()) {
164                 MessageHeader mh = new MessageHeader();
165                 mh.parseHeader(s.getInputStream());
166                 s.getOutputStream().write(OKAY.getBytes(&quot;US-ASCII&quot;));
167                 auth = mh.findValue(&quot;Authorization&quot;);
168             }
169 
170             // check Authorization header
171             if (auth == null)
172                 throw new RuntimeException(&quot;Authorization header not found&quot;);
173             System.out.println(&quot;Server received Authorization header: &quot; + auth);
174             String[] values = auth.split(&quot; &quot;);
175             if (!values[0].equals(expected))
176                 throw new RuntimeException(&quot;Unexpected value&quot;);
177         }
178     }
179 
180     /**
181      * Test the http protocol handler with one WWW-Authenticate header with
182      * the value &quot;NTLM&quot;.
183      */
184     static void testNTLM() throws Exception {
185         // server reply
186         String reply = authReplyFor(&quot;NTLM&quot;);
187 
188         System.out.println(&quot;====================================&quot;);
189         System.out.println(&quot;Expect client to fail with 401 Unauthorized&quot;);
190         System.out.println(reply);
191 
<a name="8" id="anc8"></a><span class="line-modified">192         try (ServerSocket ss = new ServerSocket(0)) {</span>

193             Client client = new Client(ss.getLocalPort());
194             Thread thr = new Thread(client);
195             thr.start();
196 
197             // client ---- GET ---&gt; server
198             // client &lt;--- 401 ---- client
199             try (Socket s = ss.accept()) {
200                 new MessageHeader().parseHeader(s.getInputStream());
201                 s.getOutputStream().write(reply.getBytes(&quot;US-ASCII&quot;));
202             }
203 
204             // the client should fail with 401
205             System.out.println(&quot;Waiting for client to terminate&quot;);
206             thr.join();
207             IOException ioe = client.ioException();
208             if (ioe != null)
209                 System.out.println(&quot;Client failed: &quot; + ioe);
210             int respCode = client.respCode();
211             if (respCode != 0 &amp;&amp; respCode != -1)
212                 System.out.println(&quot;Client received HTTP response code: &quot; + respCode);
213             if (respCode != HttpURLConnection.HTTP_UNAUTHORIZED)
214                 throw new RuntimeException(&quot;Unexpected response code&quot;);
215         }
216     }
217 
218     public static void main(String[] args) throws Exception {
<a name="9" id="anc9"></a>
219         try {
220             Class&lt;?&gt; ntlmProxyClass = Class.forName(&quot;sun.net.www.protocol.http.NTLMAuthenticationProxy&quot;, true, NoNTLM.class.getClassLoader());
221             Field ntlmSupportedField = ntlmProxyClass.getDeclaredField(&quot;supported&quot;);
222             ntlmSupportedField.setAccessible(true);
223             if (ntlmSupportedField.getBoolean(null)) {
<a name="10" id="anc10"></a><span class="line-modified">224                 System.out.println(&quot;NTLM is supported. Nothing to do. Exiting.&quot;);</span>
<span class="line-modified">225                 return;</span>
226             }
227         } catch (ClassNotFoundException okay) { }
228 
229         // setup Authenticator
230         Authenticator.setDefault(new Authenticator() {
231             @Override
232             protected PasswordAuthentication getPasswordAuthentication() {
233                 return new PasswordAuthentication(&quot;user&quot;, &quot;pass&quot;.toCharArray());
234             }
235         });
236 
237         // test combinations of authentication schemes
238         test(&quot;Basic&quot;);
239         test(&quot;Digest&quot;);
240         test(&quot;Basic&quot;, &quot;Digest&quot;);
<a name="11" id="anc11"></a><span class="line-modified">241         test(&quot;Basic&quot;, &quot;NTLM&quot;);</span>







242         test(&quot;Digest&quot;, &quot;NTLM&quot;);
243         test(&quot;Basic&quot;, &quot;Digest&quot;, &quot;NTLM&quot;);
244 
<a name="12" id="anc12"></a><span class="line-modified">245         // test NTLM only, this should fail with &quot;401 Unauthorized&quot;</span>
<span class="line-modified">246         testNTLM();</span>





247 
248         System.out.println();
249         System.out.println(&quot;TEST PASSED&quot;);
250     }
251 }
<a name="13" id="anc13"></a><span class="line-removed">252 </span>
<a name="14" id="anc14"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="14" type="hidden" />
</body>
</html>