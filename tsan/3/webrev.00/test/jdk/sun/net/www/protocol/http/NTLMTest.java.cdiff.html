<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/net/www/protocol/http/NTLMTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Modified.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NoCache.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/www/protocol/http/NTLMTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,55 ***</span>
  
  /*
   * @test
   * @bug 6520665 6357133
   * @modules java.base/sun.net.www
   * @run main/othervm NTLMTest
   * @summary 6520665 &amp; 6357133: NTLM authentication issues.
   */
  
  import java.net.*;
  import java.io.*;
  import sun.net.www.MessageHeader;
  
  public class NTLMTest
  {
<span class="line-modified">!     public static void main(String[] args) {</span>
          Authenticator.setDefault(new NullAuthenticator());
  
          try {
<span class="line-modified">!             // Test with direct connection.</span>
<span class="line-removed">-             ServerSocket serverSS = new ServerSocket(0);</span>
<span class="line-removed">-             startServer(serverSS, false);</span>
<span class="line-removed">-             runClient(Proxy.NO_PROXY, serverSS.getLocalPort());</span>
  
              // Test with proxy.
<span class="line-modified">!             serverSS = new ServerSocket(0);</span>
<span class="line-modified">!             startServer(serverSS, true /*proxy*/);</span>
<span class="line-modified">!             SocketAddress proxyAddr = new InetSocketAddress(&quot;localhost&quot;, serverSS.getLocalPort());</span>
<span class="line-modified">!             runClient(new Proxy(java.net.Proxy.Type.HTTP, proxyAddr), 8888);</span>
<span class="line-modified">! </span>
          } catch (IOException e) {
<span class="line-modified">!             e.printStackTrace();</span>
          }
      }
  
      static void runClient(Proxy proxy, int serverPort) {
          try {
<span class="line-modified">!             String urlStr = &quot;http://localhost:&quot; + serverPort + &quot;/&quot;;</span>
<span class="line-modified">!             URL url = new URL(urlStr);</span>
              HttpURLConnection uc = (HttpURLConnection) url.openConnection(proxy);
<span class="line-modified">!             uc.getInputStream();</span>
  
          } catch (ProtocolException e) {
              /* java.net.ProtocolException: Server redirected too many  times (20) */
              throw new RuntimeException(&quot;Failed: ProtocolException&quot;, e);
          } catch (IOException ioe) {
              /* IOException is OK. We are expecting &quot;java.io.IOException: Server
               * returned HTTP response code: 401 for URL: ...&quot;
               */
              //ioe.printStackTrace();
          } catch (NullPointerException npe) {
              throw new RuntimeException(&quot;Failed: NPE thrown &quot;, npe);
          }
      }
  
<span class="line-new-header">--- 23,63 ---</span>
  
  /*
   * @test
   * @bug 6520665 6357133
   * @modules java.base/sun.net.www
<span class="line-added">+  * @library /test/lib</span>
   * @run main/othervm NTLMTest
   * @summary 6520665 &amp; 6357133: NTLM authentication issues.
   */
  
  import java.net.*;
  import java.io.*;
  import sun.net.www.MessageHeader;
<span class="line-added">+ import jdk.test.lib.net.URIBuilder;</span>
  
  public class NTLMTest
  {
<span class="line-modified">!     public static void main(String[] args) throws Exception {</span>
          Authenticator.setDefault(new NullAuthenticator());
  
          try {
<span class="line-modified">!             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
  
<span class="line-added">+             // Test with direct connection.</span>
<span class="line-added">+             try (NTLMServer server = startServer(new ServerSocket(0, 0, loopback), false)) {</span>
<span class="line-added">+                 runClient(Proxy.NO_PROXY, server.getLocalPort());</span>
<span class="line-added">+             }</span>
              // Test with proxy.
<span class="line-modified">!             try (NTLMServer server =</span>
<span class="line-modified">!                     startServer(new ServerSocket(0, 0, loopback), true /*proxy*/)) {</span>
<span class="line-modified">!                 SocketAddress proxyAddr = new InetSocketAddress(loopback, server.getLocalPort());</span>
<span class="line-modified">!                 runClient(new Proxy(java.net.Proxy.Type.HTTP, proxyAddr), 8888);</span>
<span class="line-modified">!             }</span>
          } catch (IOException e) {
<span class="line-modified">!             throw e;</span>
          }
      }
  
      static void runClient(Proxy proxy, int serverPort) {
          try {
<span class="line-modified">!             URL url = URIBuilder.newBuilder()</span>
<span class="line-modified">!                       .scheme(&quot;http&quot;)</span>
<span class="line-added">+                       .loopback()</span>
<span class="line-added">+                       .port(serverPort)</span>
<span class="line-added">+                       .path(&quot;/&quot;)</span>
<span class="line-added">+                       .toURLUnchecked();</span>
              HttpURLConnection uc = (HttpURLConnection) url.openConnection(proxy);
<span class="line-modified">!             uc.getInputStream().readAllBytes();</span>
  
          } catch (ProtocolException e) {
              /* java.net.ProtocolException: Server redirected too many  times (20) */
              throw new RuntimeException(&quot;Failed: ProtocolException&quot;, e);
          } catch (IOException ioe) {
              /* IOException is OK. We are expecting &quot;java.io.IOException: Server
               * returned HTTP response code: 401 for URL: ...&quot;
               */
              //ioe.printStackTrace();
<span class="line-added">+             System.out.println(&quot;Got expected &quot; + ioe);</span>
          } catch (NullPointerException npe) {
              throw new RuntimeException(&quot;Failed: NPE thrown &quot;, npe);
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 91,38 ***</span>
  
                  &quot;HTTP/1.1 407 Proxy Authentication Required\r\n&quot; +
                  &quot;Content-Length: 0\r\n&quot; +
                  &quot;Proxy-Authenticate: NTLM TlRMTVNTUAACAAAAAAAAACgAAAABggAAU3J2Tm9uY2UAAAAAAAAAAA==\r\n\r\n&quot;};
  
<span class="line-modified">!     static void startServer(ServerSocket serverSS, boolean proxy) {</span>
<span class="line-modified">!         final ServerSocket ss = serverSS;</span>
<span class="line-modified">!         final boolean isProxy = proxy;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         Thread thread = new Thread(new Runnable() {</span>
<span class="line-modified">!             public void run() {</span>
<span class="line-modified">!                 boolean doing2ndStageNTLM = false;</span>
<span class="line-modified">!                 while (true) {</span>
<span class="line-modified">!                     try {</span>
<span class="line-modified">!                         Socket s = ss.accept();</span>
<span class="line-modified">!                         if (!doing2ndStageNTLM) {</span>
<span class="line-modified">!                             handleConnection(s, isProxy ? proxyResp : serverResp, 0, 1);</span>
<span class="line-modified">!                             doing2ndStageNTLM = true;</span>
<span class="line-modified">!                         } else {</span>
<span class="line-modified">!                             handleConnection(s, isProxy ? proxyResp : serverResp, 1, 2);</span>
<span class="line-modified">!                             doing2ndStageNTLM = false;</span>
<span class="line-modified">!                         }</span>
<span class="line-modified">!                         connectionCount++;</span>
<span class="line-modified">!                         //System.out.println(&quot;connectionCount = &quot; + connectionCount);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     } catch (IOException ioe) {</span>
<span class="line-modified">!                         ioe.printStackTrace();</span>
                      }
                  }
<span class="line-modified">!             } });</span>
<span class="line-modified">!             thread.setDaemon(true);</span>
<span class="line-modified">!             thread.start();</span>
  
      }
  
      static int connectionCount = 0;
  
      static void handleConnection(Socket s, String[] resp, int start, int end) {
<span class="line-new-header">--- 99,60 ---</span>
  
                  &quot;HTTP/1.1 407 Proxy Authentication Required\r\n&quot; +
                  &quot;Content-Length: 0\r\n&quot; +
                  &quot;Proxy-Authenticate: NTLM TlRMTVNTUAACAAAAAAAAACgAAAABggAAU3J2Tm9uY2UAAAAAAAAAAA==\r\n\r\n&quot;};
  
<span class="line-modified">!     static class NTLMServer extends Thread implements AutoCloseable {</span>
<span class="line-modified">!         final ServerSocket ss;</span>
<span class="line-modified">!         final boolean isProxy;</span>
<span class="line-modified">!         volatile boolean closed;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         NTLMServer(ServerSocket serverSS, boolean proxy) {</span>
<span class="line-modified">!             super();</span>
<span class="line-modified">!             setDaemon(true);</span>
<span class="line-modified">!             ss = serverSS;</span>
<span class="line-modified">!             isProxy = proxy;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!        public int getLocalPort() { return ss.getLocalPort(); }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         @Override</span>
<span class="line-modified">!         public void run() {</span>
<span class="line-modified">!             boolean doing2ndStageNTLM = false;</span>
<span class="line-modified">!             while (!closed) {</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     Socket s = ss.accept();</span>
<span class="line-modified">!                     if (!doing2ndStageNTLM) {</span>
<span class="line-modified">!                         handleConnection(s, isProxy ? proxyResp : serverResp, 0, 1);</span>
<span class="line-added">+                         doing2ndStageNTLM = true;</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         handleConnection(s, isProxy ? proxyResp : serverResp, 1, 2);</span>
<span class="line-added">+                         doing2ndStageNTLM = false;</span>
                      }
<span class="line-added">+                     connectionCount++;</span>
<span class="line-added">+                     //System.out.println(&quot;connectionCount = &quot; + connectionCount);</span>
<span class="line-added">+                 } catch (IOException ioe) {</span>
<span class="line-added">+                     if (!closed) ioe.printStackTrace();</span>
                  }
<span class="line-modified">!             }</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public void close() {</span>
<span class="line-added">+            if (closed) return;</span>
<span class="line-added">+            synchronized(this) {</span>
<span class="line-added">+                if (closed) return;</span>
<span class="line-added">+                closed = true;</span>
<span class="line-added">+            }</span>
<span class="line-added">+            try { ss.close(); } catch (IOException x) { };</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  
<span class="line-added">+     public static NTLMServer startServer(ServerSocket serverSS, boolean proxy) {</span>
<span class="line-added">+         NTLMServer server = new NTLMServer(serverSS, proxy);</span>
<span class="line-added">+         server.start();</span>
<span class="line-added">+         return server;</span>
      }
  
      static int connectionCount = 0;
  
      static void handleConnection(Socket s, String[] resp, int start, int end) {
</pre>
<center><a href="Modified.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NoCache.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>