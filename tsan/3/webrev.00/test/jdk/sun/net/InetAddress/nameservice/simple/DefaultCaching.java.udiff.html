<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/sun/net/InetAddress/nameservice/simple/DefaultCaching.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../misc/SunMiscSignalTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../ftp/B6427768.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/net/InetAddress/nameservice/simple/DefaultCaching.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2006, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,100 +31,128 @@</span>
  import java.net.UnknownHostException;
  import java.security.Security;
  import java.io.FileWriter;
  import java.io.PrintWriter;
  import java.io.BufferedWriter;
<span class="udiff-line-added">+ import java.nio.file.Files;</span>
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-added">+ import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;</span>
  
  public class DefaultCaching {
  
      public static void main(String args[]) throws Exception {
  
<span class="udiff-line-modified-removed">-         String hostsFileName = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) + &quot;/DefaultCachingHosts&quot;;</span>
<span class="udiff-line-modified-added">+         String hostsFileNameSrc = System.getProperty(&quot;test.src&quot;, &quot;.&quot;) + &quot;/DefaultCachingHosts&quot;;</span>
<span class="udiff-line-added">+         String hostsFileName = System.getProperty(&quot;user.dir&quot;, &quot;.&quot;) + &quot;/DefaultCachingHosts&quot;;</span>
<span class="udiff-line-added">+         if (!hostsFileNameSrc.equals(hostsFileName)) {</span>
<span class="udiff-line-added">+             Files.copy(Path.of(hostsFileNameSrc), Path.of(hostsFileName), REPLACE_EXISTING);</span>
<span class="udiff-line-added">+             System.out.println(&quot;Host file created: &quot; + hostsFileName);</span>
<span class="udiff-line-added">+         }</span>
          System.setProperty(&quot;jdk.net.hosts.file&quot;, hostsFileName);
          // initial mapping
          // name service needs to resolve this.
          addMappingToHostsFile(&quot;theclub&quot;, &quot;129.156.220.219&quot;, hostsFileName, false);
  
<span class="udiff-line-modified-removed">-         test (&quot;theclub&quot;, &quot;129.156.220.219&quot;, true);      // lk: 1</span>
<span class="udiff-line-modified-removed">-         test (&quot;luster&quot;, &quot;1.16.20.2&quot;, false);            // lk: 2</span>
<span class="udiff-line-modified-added">+         test(&quot;theclub&quot;, &quot;129.156.220.219&quot;, true);      // lk: 1</span>
<span class="udiff-line-modified-added">+         test(&quot;luster&quot;, &quot;1.16.20.2&quot;, false);            // lk: 2</span>
  
          // name service now needs to know about luster
          addMappingToHostsFile(&quot;luster&quot;, &quot;10.5.18.21&quot;, hostsFileName, true);
  
<span class="udiff-line-modified-removed">-         test (&quot;luster&quot;, &quot;1.16.20.2&quot;, false);            // lk: 2</span>
<span class="udiff-line-modified-removed">-         sleep (10+1);</span>
<span class="udiff-line-modified-added">+         test(&quot;luster&quot;, &quot;1.16.20.2&quot;, false);            // lk: 2</span>
<span class="udiff-line-modified-added">+         sleep(10+1);</span>
          test(&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 3);          // lk: 3
<span class="udiff-line-modified-removed">-         sleep (5);</span>
<span class="udiff-line-modified-added">+         sleep(5);</span>
  
          // new mapping for theclub and rewrite existing foo and luster mappings
          addMappingToHostsFile(&quot;theclub&quot;, &quot;129.156.220.1&quot;, hostsFileName, false);
          addMappingToHostsFile(&quot;foo&quot;, &quot;10.5.18.22&quot;, hostsFileName, true);
          addMappingToHostsFile(&quot;luster&quot;, &quot;10.5.18.21&quot;, hostsFileName, true);
  
<span class="udiff-line-modified-removed">-         test (&quot;theclub&quot;, &quot;129.156.220.219&quot;, true, 3);</span>
<span class="udiff-line-modified-removed">-         test (&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 3);</span>
<span class="udiff-line-modified-removed">-         test (&quot;bar&quot;, &quot;10.5.18.22&quot;, false, 4);</span>
<span class="udiff-line-modified-removed">-         test (&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 5);</span>
<span class="udiff-line-modified-added">+         test(&quot;theclub&quot;, &quot;129.156.220.219&quot;, true, 3);</span>
<span class="udiff-line-modified-added">+         test(&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 3);</span>
<span class="udiff-line-modified-added">+         test(&quot;bar&quot;, &quot;10.5.18.22&quot;, false, 4);</span>
<span class="udiff-line-modified-added">+         test(&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 5);</span>
  
          // now delay to see if theclub has expired
<span class="udiff-line-modified-removed">-         sleep (5);</span>
<span class="udiff-line-modified-added">+         sleep(5);</span>
  
<span class="udiff-line-modified-removed">-         test (&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 5);</span>
<span class="udiff-line-modified-removed">-         test (&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 6);</span>
<span class="udiff-line-modified-added">+         test(&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 5);</span>
<span class="udiff-line-modified-added">+         test(&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 6);</span>
  
<span class="udiff-line-modified-removed">-         sleep (11);</span>
<span class="udiff-line-modified-added">+         sleep(11);</span>
          // now see if luster has expired
<span class="udiff-line-modified-removed">-         test (&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 7);</span>
<span class="udiff-line-modified-removed">-         test (&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 7);</span>
<span class="udiff-line-modified-added">+         test(&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 7);</span>
<span class="udiff-line-modified-added">+         test(&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 7);</span>
  
          // now delay to see if 3rd has expired
<span class="udiff-line-modified-removed">-         sleep (10+6);</span>
<span class="udiff-line-modified-added">+         sleep(10+6);</span>
  
<span class="udiff-line-modified-removed">-         test (&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 8);</span>
<span class="udiff-line-modified-removed">-         test (&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 8);</span>
<span class="udiff-line-modified-removed">-         test (&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 9);</span>
<span class="udiff-line-modified-added">+         test(&quot;theclub&quot;, &quot;129.156.220.1&quot;, true, 8);</span>
<span class="udiff-line-modified-added">+         test(&quot;luster&quot;, &quot;10.5.18.21&quot;, true, 8);</span>
<span class="udiff-line-modified-added">+         test(&quot;foo&quot;, &quot;10.5.18.22&quot;, true, 9);</span>
      }
  
      /* throws RuntimeException if it fails */
  
<span class="udiff-line-modified-removed">-     static void test (String host, String address,</span>
<span class="udiff-line-modified-removed">-                         boolean shouldSucceed, int count) {</span>
<span class="udiff-line-modified-removed">-         test (host, address, shouldSucceed);</span>
<span class="udiff-line-modified-added">+     static void test(String host, String address,</span>
<span class="udiff-line-modified-added">+                      boolean shouldSucceed, int count) {</span>
<span class="udiff-line-modified-added">+         test(host, address, shouldSucceed);</span>
      }
  
<span class="udiff-line-modified-removed">-     static void sleep (int seconds) {</span>
<span class="udiff-line-modified-added">+     static void sleep(int seconds) {</span>
          try {
<span class="udiff-line-modified-removed">-             Thread.sleep (seconds * 1000);</span>
<span class="udiff-line-modified-removed">-         } catch (InterruptedException e) {}</span>
<span class="udiff-line-modified-added">+             sleepms(seconds * 1000);</span>
<span class="udiff-line-modified-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             e.printStackTrace();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static long sleepms(long millis) throws InterruptedException {</span>
<span class="udiff-line-added">+         long start = System.nanoTime();</span>
<span class="udiff-line-added">+         long ms = millis;</span>
<span class="udiff-line-added">+         while (ms &gt; 0) {</span>
<span class="udiff-line-added">+             assert ms &lt; Long.MAX_VALUE/1000_000L;</span>
<span class="udiff-line-added">+             Thread.sleep(ms);</span>
<span class="udiff-line-added">+             long elapsedms = (System.nanoTime() - start)/1000_000L;</span>
<span class="udiff-line-added">+             ms = millis - elapsedms;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return millis - ms;</span>
      }
  
<span class="udiff-line-modified-removed">-     static void test (String host, String address, boolean shouldSucceed) {</span>
<span class="udiff-line-modified-added">+     static void test(String host, String address, boolean shouldSucceed) {</span>
          InetAddress addr = null;
          try {
<span class="udiff-line-modified-removed">-             addr = InetAddress.getByName (host);</span>
<span class="udiff-line-modified-added">+             addr = InetAddress.getByName(host);</span>
              if (!shouldSucceed) {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException (host+&quot;:&quot;+address+&quot;: should fail&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(host+&quot;:&quot;+address+&quot;: should fail (got &quot;</span>
<span class="udiff-line-modified-added">+                                            + addr + &quot;)&quot;);</span>
              }
              if (!address.equals(addr.getHostAddress())) {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(host+&quot;:&quot;+address+&quot;: compare failed&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(host+&quot;/&quot;+address+&quot;: compare failed (found &quot;</span>
<span class="udiff-line-added">+                                            + addr + &quot;)&quot;);</span>
              }
<span class="udiff-line-added">+             System.out.println(&quot;test: &quot; + host + &quot;/&quot; + address</span>
<span class="udiff-line-added">+                                + &quot; succeeded - got &quot; + addr);</span>
          } catch (UnknownHostException e) {
              if (shouldSucceed) {
                  throw new RuntimeException(host+&quot;:&quot;+address+&quot;: should succeed&quot;);
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;test: &quot; + host + &quot;/&quot; + address</span>
<span class="udiff-line-added">+                                    + &quot; succeeded - got expected &quot; + e);</span>
              }
          }
      }
  
  
<span class="udiff-line-modified-removed">-     private static void addMappingToHostsFile (String host,</span>
<span class="udiff-line-modified-removed">-                                                String addr,</span>
<span class="udiff-line-modified-removed">-                                                String hostsFileName,</span>
<span class="udiff-line-modified-removed">-                                                boolean append)</span>
<span class="udiff-line-modified-added">+     private static void addMappingToHostsFile(String host,</span>
<span class="udiff-line-modified-added">+                                               String addr,</span>
<span class="udiff-line-modified-added">+                                               String hostsFileName,</span>
<span class="udiff-line-modified-added">+                                               boolean append)</span>
                                               throws Exception {
          String mapping = addr + &quot; &quot; + host;
          try (PrintWriter hfPWriter = new PrintWriter(new BufferedWriter(
                  new FileWriter(hostsFileName, append)))) {
              hfPWriter.println(mapping);
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-added">+         }</span>
      }
  }
</pre>
<center><a href="../../../../misc/SunMiscSignalTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../ftp/B6427768.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>