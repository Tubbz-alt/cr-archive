<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/security/util/HostnameMatcher/NullHostnameCheck.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import javax.net.ssl.KeyManagerFactory;
 25 import javax.net.ssl.SSLContext;
 26 import javax.net.ssl.SSLEngine;
 27 import javax.net.ssl.SSLEngineResult;
 28 import javax.net.ssl.SSLException;
 29 import javax.net.ssl.SSLHandshakeException;
 30 import javax.net.ssl.SSLParameters;
 31 import javax.net.ssl.TrustManager;
 32 import javax.net.ssl.X509TrustManager;
 33 import java.io.ByteArrayInputStream;
 34 import java.nio.ByteBuffer;
 35 import java.security.KeyStore;
 36 import java.security.cert.CertificateException;
 37 import java.security.cert.X509Certificate;
 38 import java.util.Base64;
 39 
 40 /*
 41  * @test
 42  * @bug 8211339
 43  * @summary Verify hostname returns an exception instead of null pointer when
 44  * creating a new engine
 45  * @run main NullHostnameCheck
 46  */
 47 
 48 
 49 public final class NullHostnameCheck {
 50 
 51     public static void main(String[] args) throws Exception {
 52         KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());
 53         keyStore.load(
 54                 new ByteArrayInputStream(Base64.getDecoder().
 55                         decode(keystoreB64)),
 56                 &quot;123456&quot;.toCharArray());
 57         KeyManagerFactory kmf = KeyManagerFactory.getInstance(
 58                 KeyManagerFactory.getDefaultAlgorithm());
 59         kmf.init(keyStore, &quot;123456&quot;.toCharArray());
 60         SSLContext serverCtx = SSLContext.getInstance(&quot;TLSv1.2&quot;);
 61         serverCtx.init(kmf.getKeyManagers(), null, null);
 62         SSLEngine serverEngine = serverCtx.createSSLEngine(&quot;localhost&quot;, -1);
 63         serverEngine.setUseClientMode(false);
 64 
 65         SSLContext clientCtx = SSLContext.getInstance(&quot;TLSv1.2&quot;);
 66         clientCtx.init(null, new TrustManager[] {
 67                 new X509TrustManager() {
 68                     @Override
 69                     public void checkClientTrusted(
 70                             X509Certificate[] x509Certificates, String s) {
 71                     }
 72 
 73                     @Override
 74                     public void checkServerTrusted(
 75                             X509Certificate[] x509Certificates, String s) {
 76                     }
 77 
 78                     @Override
 79                     public X509Certificate[] getAcceptedIssuers() {
 80                         return new X509Certificate[0];
 81                     }
 82                 }
 83         }, null);
 84 
 85         SSLEngine clientEngine = clientCtx.createSSLEngine();
 86         clientEngine.setUseClientMode(true);
 87 
 88         SSLParameters sslParameters = clientEngine.getSSLParameters();
 89         sslParameters.setEndpointIdentificationAlgorithm(&quot;HTTPS&quot;);
 90         clientEngine.setSSLParameters(sslParameters);
 91         try {
 92             handshake(clientEngine, serverEngine);
 93             throw new Exception(&quot;Value was not null.  Unexpected.&quot;);
 94         } catch (SSLHandshakeException e) {
 95             if (e.getCause() instanceof CertificateException) {
 96                 System.out.println(&quot;Correct Exception class thrown:\n\t&quot; +
 97                         e.getMessage());
 98                 return;
 99             }
100             throw e;
101         }
102     }
103 
104     private static void handshake(SSLEngine clientEngine,
105             SSLEngine serverEngine) throws SSLException{
106         ByteBuffer cTOs = ByteBuffer.allocate(
107                 clientEngine.getSession().getPacketBufferSize());
108         ByteBuffer sTOc = ByteBuffer.allocate(
109                 serverEngine.getSession().getPacketBufferSize());
110 
111         ByteBuffer serverAppReadBuffer = ByteBuffer.allocate(
112                 serverEngine.getSession().getApplicationBufferSize());
113         ByteBuffer clientAppReadBuffer = ByteBuffer.allocate(
114                 clientEngine.getSession().getApplicationBufferSize());
115 
116         clientEngine.beginHandshake();
117         serverEngine.beginHandshake();
118 
119         ByteBuffer empty = ByteBuffer.allocate(0);
120 
121         SSLEngineResult clientResult;
122         SSLEngineResult serverResult;
123 
124         boolean clientHandshakeFinished = false;
125         boolean serverHandshakeFinished = false;
126 
127         do {
128             if (!clientHandshakeFinished) {
129                 clientResult = clientEngine.wrap(empty, cTOs);
130                 runDelegatedTasks(clientResult, clientEngine);
131 
132                 if (isHandshakeFinished(clientResult)) {
133                     clientHandshakeFinished = true;
134                 }
135             }
136 
137             if (!serverHandshakeFinished) {
138                 serverResult = serverEngine.wrap(empty, sTOc);
139                 runDelegatedTasks(serverResult, serverEngine);
140 
141                 if (isHandshakeFinished(serverResult)) {
142                     serverHandshakeFinished = true;
143                 }
144             }
145 
146             cTOs.flip();
147             sTOc.flip();
148 
149             if (!clientHandshakeFinished) {
150                 clientResult = clientEngine.unwrap(sTOc, clientAppReadBuffer);
151 
152                 runDelegatedTasks(clientResult, clientEngine);
153 
154                 if (isHandshakeFinished(clientResult)) {
155                     clientHandshakeFinished = true;
156                 }
157             }
158 
159             if (!serverHandshakeFinished) {
160                 serverResult = serverEngine.unwrap(cTOs, serverAppReadBuffer);
161                 runDelegatedTasks(serverResult, serverEngine);
162 
163                 if (isHandshakeFinished(serverResult)) {
164                     serverHandshakeFinished = true;
165                 }
166             }
167 
168             sTOc.compact();
169             cTOs.compact();
170         } while (!clientHandshakeFinished || !serverHandshakeFinished);
171     }
172 
173     private static boolean isHandshakeFinished(SSLEngineResult result) {
174         return result.getHandshakeStatus() ==
175                 SSLEngineResult.HandshakeStatus.FINISHED;
176     }
177 
178     private static void runDelegatedTasks(SSLEngineResult result,
179             SSLEngine engine) {
180         if (result.getHandshakeStatus() ==
181                 SSLEngineResult.HandshakeStatus.NEED_TASK) {
182             for (;;) {
183                 Runnable task = engine.getDelegatedTask();
184                 if (task == null) {
185                     break;
186                 }
187                 task.run();
188             }
189         }
190     }
191 
192 // Base64 of PKCS12 Keystore
193 static final String keystoreB64 =
194         &quot;MIIQ6wIBAzCCEKQGCSqGSIb3DQEHAaCCEJUEghCRMIIQjTCCBgEGCSqGSIb3DQEHAa&quot; +
195         &quot;CCBfIEggXuMIIF6jCCAuwGCyqGSIb3DQEMCgECoIICmzCCApcwKQYKKoZIhvcNAQwB&quot; +
196         &quot;AzAbBBS7qnTOxJYV5At3migAiNAdPvKd7AIDAMNQBIICaMo0roH1TuZE1ARZtwCOXy&quot; +
197         &quot;F2sk4DmI6m1/CRdh6NeQzszJZH2701cEm0CES971IwobCNFo0+Er9tk1c+iXmMPJgM&quot; +
198         &quot;s1l/+7OpQCc/GRl2Nc7lQSj1Yvrq1CIQxC51hSrwNs0N9aCTavjKfJ7jk3k1+MNItU&quot; +
199         &quot;dMdwuIFK663NEH8Wm0D4njvIA9p3ehOLJWDi0ziFTcySyCbbWAL6HmJhzRlpakPpbp&quot; +
200         &quot;Ox68wfI2YgDpQwTq580TMEWz+9P1U07VmtfYlu9xjXQT/Ks1xzNrhbOyv+HLoE54qL&quot; +
201         &quot;RyhL36/fwCzlpCXCYokPUG2uziu8JiQyITYRpVhVcgR5m/rSMhVsj8HwUmIdlK2Irm&quot; +
202         &quot;kOqG2m6YPKRiq7eeCPskcf2Hh0H3pb6lxagSVQMb+qndIUhCvZoXL/oS2+1ngtMlXh&quot; +
203         &quot;ezjIEa5s2K+Kk8eV48Ydms5bW8Plqy20+0fgEClABF6QL4We4NaFJdl6DB0+KsxgUd&quot; +
204         &quot;ZHo4U7f3R6o971mAd/OACs4jzpA0/C3AKCbhBEh/nxnSPoxM0Ty3bLaK8LQnv+B2uo&quot; +
205         &quot;6TeypsxmGg4/kd6fymzrhWUJAFz7DjkO/32pDUXnUDa6CB+dZdUldPoOpviGl9ITfG&quot; +
206         &quot;apdnq8+B4y7lg/87OZbr99vyVBWtbATaNof3Y5PuNY5TTQ5y1u4gU+zO9qhRnjxSqb&quot; +
207         &quot;bXJYhKeOIJmXCgGerV1dFqcWfj163OtjTwwJ5VCrtgolTU+3eodARD86jkp1VRCtQ2&quot; +
208         &quot;M54zOND9mx9RM2ucOy41mgF2MyKIseN6+3665DtgDbN5H/pmmjR4/GSuuy4eJoGHvY&quot; +
209         &quot;OPy49P7o8xPjAZBgkqhkiG9w0BCRQxDB4KAG0AeQBrAGUAeTAhBgkqhkiG9w0BCRUx&quot; +
210         &quot;FAQSVGltZSAxNTQxMTg5MzQ5NTAxMIIC9gYLKoZIhvcNAQwKAQKgggKbMIIClzApBg&quot; +
211         &quot;oqhkiG9w0BDAEDMBsEFO1oLv/9BmQKRKpeUB/Q5FPzMZaPAgMAw1AEggJoxez71rvm&quot; +
212         &quot;pCMbF0MH3shCpy2LsHNnkyjQVTKBIqdHFmn1390gqRkUUlvaaLgpjNNFSVY/LMg+gK&quot; +
213         &quot;JEJW6kClerkFg1/fvMQDBr5ApGbACIWi7fN/qYjED0cY5eypnSKePUzR2uO254Qko4&quot; +
214         &quot;xc+Enx3+V0/O0eqwlzGq3Pmgq9vfyqPefG562tFQEmHyUMUTLg1m4rtUgG5bvtRIMl&quot; +
215         &quot;Vd6tgFA3JRb08USaJY3D+FQFb+zm/iIJ1KrHBgtBuJFLfaXqYo/fjjgIv0WiOIQmd1&quot; +
216         &quot;ygrfRp7AhCvqZu7IzKT3TWggfGHABfjgkRcVmCGsFCf1cXAJVzS1v4N2biY9tB9Q5Y&quot; +
217         &quot;iWZ0JglMHK+NfJu2+3UthyC3ugDeLTQTSbwfJv3ShcVFo7mVxJz2zPWJtDoXbORczm&quot; +
218         &quot;0tjMu8KztEpPhwH4nsoXJ60fMUDOAvYwr2t49CBRZ+b9rJB5QWWJ60ZrM5rsfNU5yJ&quot; +
219         &quot;RJYldqryD/T5UJEqRLK5X9N/DAszDFTDoTVFMwwuBv6yk/v9N999m4X77q75/d1y71&quot; +
220         &quot;sY9Aaj9gHKLSy1ZCsGoU2nt7A+Z+V9TNcmsM5aT+QpNdKvW99jI1T2XI7kHNJ+D0W3&quot; +
221         &quot;sD8dXlNA91na7/6HGM5dKQfZdk1zcUYg2lkDpyi3xzO2nzFvCaDfAqQqjuQtiXggWy&quot; +
222         &quot;RiNk+WC45GuUKP5F6fWWr871RjeVYezj5XoXWJ7x8J85SUMKiuQH3S2tRMcP2RtAS/&quot; +
223         &quot;D1aXdwuiVfLUMu9113dwpSwwmXcFASrt9VxXPNI8Aztu/YtqkONyQq50NChtYsykGA&quot; +
224         &quot;4ZUOuazkc1SLmIitNfBB9DFIMCMGCSqGSIb3DQEJFDEWHhQAcwBlAGwAZgBzAGkAZw&quot; +
225         &quot;BuAGUAZDAhBgkqhkiG9w0BCRUxFAQSVGltZSAxNTQxMTg5MzUzNjg4MIIKhAYJKoZI&quot; +
226         &quot;hvcNAQcGoIIKdTCCCnECAQAwggpqBgkqhkiG9w0BBwEwKQYKKoZIhvcNAQwBBjAbBB&quot; +
227         &quot;S3KnmddxJSpicU3Pxyg8+NUl6deAIDAMNQgIIKMA0HSR92DBEs74SvbSTUrLeitduz&quot; +
228         &quot;wzkxQ2D8jO+eP7dC7L9nVVvfHDcalUfwah7fvriDgPKg/ws7vaPO6c4Q7RdzB3epvK&quot; +
229         &quot;7LqJlqseW0NxRGJXF9hvDOWk6me+3NyAy791C0R8oF/llujojwoR2Tw6DzTdov9c0p&quot; +
230         &quot;pwCACNtgeAtz3SEFlc/F4MwZKai0jdpakINJkD5H7Za8nyKu6pIITs1roy3Oq2HA4M&quot; +
231         &quot;XAnlnWh+8R9mloDBTJJMJYUOsn1VaFrYNFq3kr4oOMNINJvUCZL2LZgl5rmzgWSVs0&quot; +
232         &quot;VSZa7JUWx49rsrBeCi/SFwW5ryleK5uEtjXjtqjQxCjvLvRYV5HmPfv/ZGCP/vitHX&quot; +
233         &quot;dQ9gzxO/7RVQoxgE0dSx90jiGOEsmG8N9sDnNyS+GCc7pxJeW6NKc1h5YameCsqUGz&quot; +
234         &quot;V9FTfz2JdDpaPsGmHtvMTs8n3ncK9FOWeWhoNKhPnoMGHmfJGZgz282aTosggSZgh7&quot; +
235         &quot;FSvf3KfAmhcCj9+frE90jPvB4W8tPF0YnOrNgvByw2+bj7NCkZ0WBT2WrOSOoS/o2H&quot; +
236         &quot;zmErCJmyt6Su5sPEeTz+dnU0std6qCjsHtjo8Is8VnVVec2nbpeT+nd3RTCV71dViW&quot; +
237         &quot;42L3rRYxl80UpsUs3Fh0J+01EZkWmExCSZpYTKgPhYcYSwUrIVx9ukcCdUSpvS07bq&quot; +
238         &quot;hLfqWOVLfLs00VBr/mFWOqDBfy+qJMXEFYyYDBa/TlrIjzEbF4qKwIJiIxRcqYy0Ta&quot; +
239         &quot;CnMVvn8HlMeIMPJQaqdfDspxIdSdJWWZVbk9FnEDcMuSg8saON26HwieH+AsdnsZDR&quot; +
240         &quot;cZ6kT+bMPibCfnKLTmJYM0dq7abhdYj7GYcfRjwCeeK/PSxklqpsJ/1T/FeVweuQXz&quot; +
241         &quot;bhHatL5z8UmTV3WUE1Ww23K3sR701xh/Tx3HoZPjluSHZFuQCvhkOU6Fj5o7dYjJZc&quot; +
242         &quot;3l3n8wD3SY04ObfCedHe56NytvbXGp79en8Q6kluThWvS5tuNgR5UhMf5oeVi8H1++&quot; +
243         &quot;MeuCOz9MJMwBGe0JUkxijdI1YVHvspqXcQhjAL9BBPT/Q+iaQITzqPSVj/fSUbY147&quot; +
244         &quot;XrAGKS8/9iOV5gTVw2TiW1MKp3ubLjqc1YmIB3TRz+SIlAXg3tD4hl/8DXs0zDFLN0&quot; +
245         &quot;OJLslwQJNaiV0S0mndsVQ/qXiS0gfZldQcn1NmUCJNiy04aUNWR/wKgyLAk5DNPCjx&quot; +
246         &quot;RlStSK7RjrgIcyUO+4cf/nfV2ymaaeDtBSwLLhAr2syXlio1fQILIrSlmT2X7i4/7X&quot; +
247         &quot;1vzN0h78g3+NcWpCs+WnOZ1bu/nzVY7zL8rmHJCeOD37UMgxgW5s3sBvONCpUzyOoe&quot; +
248         &quot;raTalqk843CE223ovLgh+KRm/JXUlDMtDSpk+02Ve7ZoyqgI8vr6UBwWk6CjUJx21M&quot; +
249         &quot;ldkh6QZcK+weQg0Ml9t3czrKXlfQl62VIG6aqSRehSEa52k5IWrcVY6yauRfERfi6a&quot; +
250         &quot;zGSmn5kXlQZSJ1mDuss22Fp12n5Kn0MAwo7XHmnzasaD3rB57A+s/3zkgC0j2t/qYC&quot; +
251         &quot;VpcTq/7Hh7CirbUzVBaXn9CI5MYcbtL40KEE7/DKsjR0VTUtLRi9PnEX1D4zxWl45Y&quot; +
252         &quot;WJ0QO4icHmUS+bvz3i/N91kI+XKDjZmktsqpF+JRaooQe2wZsasnsCSm6tEx8rN/Ya&quot; +
253         &quot;iE3nEUTxeUdHudzT4mldgYL9jlOoubC+DvXilRPRboNRuF9djrfq1p+j4egC4FcjeR&quot; +
254         &quot;kISHIuVXVwcg6Iz9q5j3IAGBfRhXuZ70qyLMtuts4RE+Xy4SmOPnw2rObNhMcTBs9T&quot; +
255         &quot;wYIhrzv426xid908L4v3bUunlsCoDP6LzzMdE4g1OhKzralRqoYZcsLN6Jt5f/W8UY&quot; +
256         &quot;RFauTV8YFV3dBUpp9xhKJlYH+OtJY1gLrT2aaX8b96ruv1JTq1fKCReiB2/0MCPvHd&quot; +
257         &quot;Yz8+/P7YQTysaoDlTC7prQFvDEcz11D0+SmVi2yxNQZETMaMcX5QdqfO8omTPMtuE5&quot; +
258         &quot;jKgtBtmjq6GeNNJBSKySWtjp0J7jKMqmk2n9+9/RCv3e4IVEcZDOo71g5omtB5592w&quot; +
259         &quot;XEQqydg1yH5HFD/B7bgcuFAbr36UMdp6o4M8vek9HsI9K/+Q+2clecOabzNDsS4S8y&quot; +
260         &quot;vr0Kna4rluHwGT0QUp0SbRQRIKzSm7xye5CTxUrZ8cizQ5hQFBUFMr8OWRm0N1GalY&quot; +
261         &quot;TfPaGwX0sWdvhX4rrrGXpToRbUUqeSk1suiRMT8s1iluaoCpiN1Kq4cehFdlSpWv9c&quot; +
262         &quot;74Dktfk+kS8X+vCdoU3voPHiGQbxql0mcdSIboOKdCdzs5krl7GbnJZoYLIYpK/y87&quot; +
263         &quot;YUbOb1CiivlTNe4+KiamuEg44Y0zZ/Z+yWLb7QkpjoIiDObU/0oJKqHUeYL4ZjReus&quot; +
264         &quot;U014itt5jBMmVCBlhUWtHTmznJotjl45H6bVAX7cimbdoWDcmzWlgHM5lFP6IH/q+Q&quot; +
265         &quot;Gsgw+kRfbzX0dnYF0a6d5j02ZgSjJJZpQ5Df+qB9ZKteywXxApcv3FRVuz7A5v7yXR&quot; +
266         &quot;xUE8TQnLwOZgvwDu/pL90drEf0KXef8G/CEHQPB4HVCDzaUnhfSIUflsjtaFfuFq1U&quot; +
267         &quot;DHmmt5WrrTkWo5RRMUzWYcYn2QzBvzCRDTWdVTlXAJcYJ+KHeJlyxhlrEDu3ej4WUe&quot; +
268         &quot;BmkbiTQStUEUpk3IcTbzVLLtfS/pe3m0EmaU6nRkmfLxMfYtnDUgdghMy0Cltc3TKn&quot; +
269         &quot;9qFrBtY41qf8D5LGSrrmLVC1tnQv+hJC7hwiIQZ/2a5b5Bv67tcdzlEGRNT7uv0ID0&quot; +
270         &quot;Ig5MyPjvJtppNQfxhPbNbJvxWtmI1NvH4359d0vR/4yzxYq+BpCLpOXw3BreGE55J7&quot; +
271         &quot;xIvxeRb+Pws7A0xdbKHAwSUsEyPglxAkZCzftZin+MoEw8UnhXYWOPKf+k49TVAq7S&quot; +
272         &quot;Yi1mJxxzwkSkSw9AdhbalYi1Y17VVfHHcb9Ioh1Jdtq8iNqtO2GG+Gd4yGKaRjnQ03&quot; +
273         &quot;6YRWyffrMx6Lv/aEecMR1DASDuX0vVjfafKHAp+13VKVGsB6zPbzR4njAXhJxTC9qj&quot; +
274         &quot;RbG2ISl4xrgAy/gBCKqN+UaVGVYe5DdA22XOOfNkgRrfoqcdgajzp4v6hqr3kPh997&quot; +
275         &quot;89Ayxcov6OopEUBuy6wuPO2ezXRMw8snABq6YDlf36l2jugHbqUUOiiQ4jIPgZAp/S&quot; +
276         &quot;r+4i6wyH+wOIjn1pBn9GgqypWCjyj/uTIMiXiMe5TDzp7U9pJ7e/hWUGzm6wWuDQWB&quot; +
277         &quot;zLwAJNRtaaGV0UraI4ubOJVsvGym0PJ8elxCUgKo6cePkhwrVPcNKA19HgVj/3g0pa&quot; +
278         &quot;ZwYt5Yw2Gdydm0zadva7K/oVgVKRDmkQbwlavySW0xqU8Pul/V/HUSd32/4cpOmmol&quot; +
279         &quot;OjMo1vyn/iSMylG0s2SzTjZ4LlcwhaxjoIVpXo6MwPMh/vdlgQyZ/bjO9PMr9TYW6J&quot; +
280         &quot;aF2PnIKsRkzYfcn6xcQwPjAhMAkGBSsOAwIaBQAEFLddLgmJBuufBBi+JoHCaLDeTK&quot; +
281         &quot;RvBBTQP0GN26PaNdjOaE/AzK7bbhZGNAIDAYag&quot;;
282 }
    </pre>
  </body>
</html>