<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/pkcs11/PKCS11Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MessageDigest/ByteBuffers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Secmod/AddTrustedCert.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/pkcs11/PKCS11Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 // common infrastructure for SunPKCS11 tests
 26 
 27 import java.io.BufferedReader;
 28 import java.io.ByteArrayOutputStream;
 29 import java.io.File;
 30 import java.io.IOException;
 31 import java.io.InputStream;
 32 import java.io.InputStreamReader;
 33 import java.io.StringReader;
 34 import java.nio.charset.StandardCharsets;
 35 import java.nio.file.Files;
 36 import java.nio.file.Path;
 37 import java.nio.file.Paths;
 38 import java.security.AlgorithmParameters;
 39 import java.security.InvalidAlgorithmParameterException;
 40 import java.security.KeyPairGenerator;
 41 import java.security.NoSuchProviderException;

 42 import java.security.Provider;
 43 import java.security.ProviderException;
 44 import java.security.Security;
 45 import java.security.spec.ECGenParameterSpec;
 46 import java.security.spec.ECParameterSpec;
 47 import java.util.ArrayList;
 48 import java.util.Arrays;
 49 import java.util.HashMap;
 50 import java.util.Iterator;
 51 import java.util.List;
 52 import java.util.Map;
 53 import java.util.Optional;
 54 import java.util.Properties;
 55 import java.util.ServiceConfigurationError;
 56 import java.util.ServiceLoader;
 57 import java.util.Set;
 58 
 59 import jdk.test.lib.artifacts.Artifact;
 60 import jdk.test.lib.artifacts.ArtifactResolver;
 61 import jdk.test.lib.artifacts.ArtifactResolverException;
</pre>
<hr />
<pre>
 65     private boolean enableSM = false;
 66 
 67     static final Properties props = System.getProperties();
 68 
 69     static final String PKCS11 = &quot;PKCS11&quot;;
 70 
 71     // directory of the test source
 72     static final String BASE = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 73 
 74     static final char SEP = File.separatorChar;
 75 
 76     private static final String DEFAULT_POLICY =
 77             BASE + SEP + &quot;..&quot; + SEP + &quot;policy&quot;;
 78 
 79     // directory corresponding to BASE in the /closed hierarchy
 80     static final String CLOSED_BASE;
 81 
 82     static {
 83         // hack
 84         String absBase = new File(BASE).getAbsolutePath();
<span class="line-modified"> 85         int k = absBase.indexOf(SEP + &quot;test&quot; + SEP + &quot;sun&quot; + SEP);</span>
 86         if (k &lt; 0) k = 0;
<span class="line-modified"> 87         String p1 = absBase.substring(0, k + 6);</span>
<span class="line-modified"> 88         String p2 = absBase.substring(k + 5);</span>
<span class="line-modified"> 89         CLOSED_BASE = p1 + &quot;closed&quot; + p2;</span>
 90 
 91         // set it as a system property to make it available in policy file
 92         System.setProperty(&quot;closed.base&quot;, CLOSED_BASE);
 93     }
 94 
 95     // NSS version info
 96     public static enum ECCState { None, Basic, Extended };
 97     static double nss_version = -1;
 98     static ECCState nss_ecc_status = ECCState.Extended;
 99 
100     // The NSS library we need to search for in getNSSLibDir()
101     // Default is &quot;libsoftokn3.so&quot;, listed as &quot;softokn3&quot;
102     // The other is &quot;libnss3.so&quot;, listed as &quot;nss3&quot;.
103     static String nss_library = &quot;softokn3&quot;;
104 
105     // NSS versions of each library.  It is simplier to keep nss_version
106     // for quick checking for generic testing than many if-else statements.
107     static double softoken3_version = -1;
108     static double nss3_version = -1;
109     static Provider pkcs11;
</pre>
<hr />
<pre>
367         if (isNSS(p) &amp;&amp; nssVersion &gt;= 3.11 &amp;&amp; nssVersion &lt; 3.12) {
368             System.out.println(&quot;NSS 3.11 has a DER issue that recent &quot; +
369                     &quot;version do not, skipping&quot;);
370             return true;
371         }
372         return false;
373     }
374 
375     protected static void safeReload(String lib) throws Exception {
376         try {
377             System.load(lib);
378         } catch (UnsatisfiedLinkError e) {
379             if (e.getMessage().contains(&quot;already loaded&quot;)) {
380                 return;
381             }
382         }
383     }
384 
385     static boolean loadNSPR(String libdir) throws Exception {
386         // load NSS softoken dependencies in advance to avoid resolver issues
<span class="line-modified">387         safeReload(libdir + System.mapLibraryName(&quot;nspr4&quot;));</span>
<span class="line-modified">388         safeReload(libdir + System.mapLibraryName(&quot;plc4&quot;));</span>
<span class="line-modified">389         safeReload(libdir + System.mapLibraryName(&quot;plds4&quot;));</span>
<span class="line-modified">390         safeReload(libdir + System.mapLibraryName(&quot;sqlite3&quot;));</span>
<span class="line-modified">391         safeReload(libdir + System.mapLibraryName(&quot;nssutil3&quot;));</span>



392         return true;
393     }
394 
395     // Check the provider being used is NSS
396     public static boolean isNSS(Provider p) {
397         return p.getName().toUpperCase().equals(&quot;SUNPKCS11-NSS&quot;);
398     }
399 
400     static double getNSSVersion() {
401         if (nss_version == -1)
402             getNSSInfo();
403         return nss_version;
404     }
405 
406     static ECCState getNSSECC() {
407         if (nss_version == -1)
408             getNSSInfo();
409         return nss_ecc_status;
410     }
411 
</pre>
<hr />
<pre>
859 
860     static byte[] generateData(int length) {
861         byte data[] = new byte[length];
862         for (int i=0; i&lt;data.length; i++) {
863             data[i] = (byte) (i % 256);
864         }
865         return data;
866     }
867 
868     private static String fetchNssLib(String osId) {
869         switch (osId) {
870         case &quot;Windows-x86-32&quot;:
871             return fetchNssLib(WINDOWS_X86.class);
872 
873         case &quot;Windows-amd64-64&quot;:
874             return fetchNssLib(WINDOWS_X64.class);
875 
876         case &quot;MacOSX-x86_64-64&quot;:
877             return fetchNssLib(MACOSX_X64.class);
878 



879         default:
880             return null;
881         }
882     }
883 
884     private static String fetchNssLib(Class&lt;?&gt; clazz) {
885         String path = null;
886         try {
887             path = ArtifactResolver.resolve(clazz).entrySet().stream()
888                     .findAny().get().getValue() + File.separator + &quot;nsslib&quot;
889                     + File.separator;
890         } catch (ArtifactResolverException e) {
891             Throwable cause = e.getCause();
892             if (cause == null) {
893                 System.out.println(&quot;Cannot resolve artifact, &quot;
894                         + &quot;please check if JIB jar is present in classpath.&quot;);
895             } else {
896                 throw new RuntimeException(&quot;Fetch artifact failed: &quot; + clazz
897                         + &quot;\nPlease make sure the artifact is available.&quot;);
898             }
899         }

900         return path;
901     }
902 
903     @Artifact(
904             organization = &quot;jpg.tests.jdk.nsslib&quot;,
905             name = &quot;nsslib-windows_x64&quot;,
<span class="line-modified">906             revision = &quot;3.35&quot;,</span>
907             extension = &quot;zip&quot;)
908     private static class WINDOWS_X64 { }
909 
910     @Artifact(
911             organization = &quot;jpg.tests.jdk.nsslib&quot;,
912             name = &quot;nsslib-windows_x86&quot;,
<span class="line-modified">913             revision = &quot;3.35&quot;,</span>
914             extension = &quot;zip&quot;)
915     private static class WINDOWS_X86 { }
916 
917     @Artifact(
918             organization = &quot;jpg.tests.jdk.nsslib&quot;,
919             name = &quot;nsslib-macosx_x64&quot;,
<span class="line-modified">920             revision = &quot;3.35&quot;,</span>
921             extension = &quot;zip&quot;)
922     private static class MACOSX_X64 { }







923 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 // common infrastructure for SunPKCS11 tests
 26 
 27 import java.io.BufferedReader;
 28 import java.io.ByteArrayOutputStream;
 29 import java.io.File;
 30 import java.io.IOException;
 31 import java.io.InputStream;
 32 import java.io.InputStreamReader;
 33 import java.io.StringReader;
 34 import java.nio.charset.StandardCharsets;
 35 import java.nio.file.Files;
 36 import java.nio.file.Path;
 37 import java.nio.file.Paths;
 38 import java.security.AlgorithmParameters;
 39 import java.security.InvalidAlgorithmParameterException;
 40 import java.security.KeyPairGenerator;
 41 import java.security.NoSuchProviderException;
<span class="line-added"> 42 import java.security.Policy;</span>
 43 import java.security.Provider;
 44 import java.security.ProviderException;
 45 import java.security.Security;
 46 import java.security.spec.ECGenParameterSpec;
 47 import java.security.spec.ECParameterSpec;
 48 import java.util.ArrayList;
 49 import java.util.Arrays;
 50 import java.util.HashMap;
 51 import java.util.Iterator;
 52 import java.util.List;
 53 import java.util.Map;
 54 import java.util.Optional;
 55 import java.util.Properties;
 56 import java.util.ServiceConfigurationError;
 57 import java.util.ServiceLoader;
 58 import java.util.Set;
 59 
 60 import jdk.test.lib.artifacts.Artifact;
 61 import jdk.test.lib.artifacts.ArtifactResolver;
 62 import jdk.test.lib.artifacts.ArtifactResolverException;
</pre>
<hr />
<pre>
 66     private boolean enableSM = false;
 67 
 68     static final Properties props = System.getProperties();
 69 
 70     static final String PKCS11 = &quot;PKCS11&quot;;
 71 
 72     // directory of the test source
 73     static final String BASE = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 74 
 75     static final char SEP = File.separatorChar;
 76 
 77     private static final String DEFAULT_POLICY =
 78             BASE + SEP + &quot;..&quot; + SEP + &quot;policy&quot;;
 79 
 80     // directory corresponding to BASE in the /closed hierarchy
 81     static final String CLOSED_BASE;
 82 
 83     static {
 84         // hack
 85         String absBase = new File(BASE).getAbsolutePath();
<span class="line-modified"> 86         int k = absBase.indexOf(SEP + &quot;test&quot; + SEP + &quot;jdk&quot; + SEP);</span>
 87         if (k &lt; 0) k = 0;
<span class="line-modified"> 88         String p1 = absBase.substring(0, k);</span>
<span class="line-modified"> 89         String p2 = absBase.substring(k);</span>
<span class="line-modified"> 90         CLOSED_BASE = p1 + &quot;/../closed&quot; + p2;</span>
 91 
 92         // set it as a system property to make it available in policy file
 93         System.setProperty(&quot;closed.base&quot;, CLOSED_BASE);
 94     }
 95 
 96     // NSS version info
 97     public static enum ECCState { None, Basic, Extended };
 98     static double nss_version = -1;
 99     static ECCState nss_ecc_status = ECCState.Extended;
100 
101     // The NSS library we need to search for in getNSSLibDir()
102     // Default is &quot;libsoftokn3.so&quot;, listed as &quot;softokn3&quot;
103     // The other is &quot;libnss3.so&quot;, listed as &quot;nss3&quot;.
104     static String nss_library = &quot;softokn3&quot;;
105 
106     // NSS versions of each library.  It is simplier to keep nss_version
107     // for quick checking for generic testing than many if-else statements.
108     static double softoken3_version = -1;
109     static double nss3_version = -1;
110     static Provider pkcs11;
</pre>
<hr />
<pre>
368         if (isNSS(p) &amp;&amp; nssVersion &gt;= 3.11 &amp;&amp; nssVersion &lt; 3.12) {
369             System.out.println(&quot;NSS 3.11 has a DER issue that recent &quot; +
370                     &quot;version do not, skipping&quot;);
371             return true;
372         }
373         return false;
374     }
375 
376     protected static void safeReload(String lib) throws Exception {
377         try {
378             System.load(lib);
379         } catch (UnsatisfiedLinkError e) {
380             if (e.getMessage().contains(&quot;already loaded&quot;)) {
381                 return;
382             }
383         }
384     }
385 
386     static boolean loadNSPR(String libdir) throws Exception {
387         // load NSS softoken dependencies in advance to avoid resolver issues
<span class="line-modified">388         String dir = libdir.endsWith(File.separator)</span>
<span class="line-modified">389                      ? libdir</span>
<span class="line-modified">390                      : libdir + File.separator;</span>
<span class="line-modified">391         safeReload(dir + System.mapLibraryName(&quot;nspr4&quot;));</span>
<span class="line-modified">392         safeReload(dir + System.mapLibraryName(&quot;plc4&quot;));</span>
<span class="line-added">393         safeReload(dir + System.mapLibraryName(&quot;plds4&quot;));</span>
<span class="line-added">394         safeReload(dir + System.mapLibraryName(&quot;sqlite3&quot;));</span>
<span class="line-added">395         safeReload(dir + System.mapLibraryName(&quot;nssutil3&quot;));</span>
396         return true;
397     }
398 
399     // Check the provider being used is NSS
400     public static boolean isNSS(Provider p) {
401         return p.getName().toUpperCase().equals(&quot;SUNPKCS11-NSS&quot;);
402     }
403 
404     static double getNSSVersion() {
405         if (nss_version == -1)
406             getNSSInfo();
407         return nss_version;
408     }
409 
410     static ECCState getNSSECC() {
411         if (nss_version == -1)
412             getNSSInfo();
413         return nss_ecc_status;
414     }
415 
</pre>
<hr />
<pre>
863 
864     static byte[] generateData(int length) {
865         byte data[] = new byte[length];
866         for (int i=0; i&lt;data.length; i++) {
867             data[i] = (byte) (i % 256);
868         }
869         return data;
870     }
871 
872     private static String fetchNssLib(String osId) {
873         switch (osId) {
874         case &quot;Windows-x86-32&quot;:
875             return fetchNssLib(WINDOWS_X86.class);
876 
877         case &quot;Windows-amd64-64&quot;:
878             return fetchNssLib(WINDOWS_X64.class);
879 
880         case &quot;MacOSX-x86_64-64&quot;:
881             return fetchNssLib(MACOSX_X64.class);
882 
<span class="line-added">883         case &quot;Linux-amd64-64&quot;:</span>
<span class="line-added">884             return fetchNssLib(LINUX_X64.class);</span>
<span class="line-added">885 </span>
886         default:
887             return null;
888         }
889     }
890 
891     private static String fetchNssLib(Class&lt;?&gt; clazz) {
892         String path = null;
893         try {
894             path = ArtifactResolver.resolve(clazz).entrySet().stream()
895                     .findAny().get().getValue() + File.separator + &quot;nsslib&quot;
896                     + File.separator;
897         } catch (ArtifactResolverException e) {
898             Throwable cause = e.getCause();
899             if (cause == null) {
900                 System.out.println(&quot;Cannot resolve artifact, &quot;
901                         + &quot;please check if JIB jar is present in classpath.&quot;);
902             } else {
903                 throw new RuntimeException(&quot;Fetch artifact failed: &quot; + clazz
904                         + &quot;\nPlease make sure the artifact is available.&quot;);
905             }
906         }
<span class="line-added">907         Policy.setPolicy(null); // Clear the policy created by JIB if any</span>
908         return path;
909     }
910 
911     @Artifact(
912             organization = &quot;jpg.tests.jdk.nsslib&quot;,
913             name = &quot;nsslib-windows_x64&quot;,
<span class="line-modified">914             revision = &quot;3.46-VS2017&quot;,</span>
915             extension = &quot;zip&quot;)
916     private static class WINDOWS_X64 { }
917 
918     @Artifact(
919             organization = &quot;jpg.tests.jdk.nsslib&quot;,
920             name = &quot;nsslib-windows_x86&quot;,
<span class="line-modified">921             revision = &quot;3.46-VS2017&quot;,</span>
922             extension = &quot;zip&quot;)
923     private static class WINDOWS_X86 { }
924 
925     @Artifact(
926             organization = &quot;jpg.tests.jdk.nsslib&quot;,
927             name = &quot;nsslib-macosx_x64&quot;,
<span class="line-modified">928             revision = &quot;3.46&quot;,</span>
929             extension = &quot;zip&quot;)
930     private static class MACOSX_X64 { }
<span class="line-added">931 </span>
<span class="line-added">932     @Artifact(</span>
<span class="line-added">933             organization = &quot;jpg.tests.jdk.nsslib&quot;,</span>
<span class="line-added">934             name = &quot;nsslib-linux_x64&quot;,</span>
<span class="line-added">935             revision = &quot;3.46&quot;,</span>
<span class="line-added">936             extension = &quot;zip&quot;)</span>
<span class="line-added">937     private static class LINUX_X64 { }</span>
938 }
</pre>
</td>
</tr>
</table>
<center><a href="MessageDigest/ByteBuffers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Secmod/AddTrustedCert.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>