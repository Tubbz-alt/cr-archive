<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/pkcs11/Signature/KeyAndParamCheckForPSS.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 import java.security.*;
 24 import java.security.interfaces.*;
 25 import java.security.spec.*;
 26 
 27 /**
 28  * @test
 29  * @bug 8080462 8226651
 30  * @summary Ensure that PSS key and params check are implemented properly
 31  *         regardless of call sequence
 32  * @library /test/lib ..
 33  * @modules jdk.crypto.cryptoki
 34  * @run main KeyAndParamCheckForPSS
 35  */
 36 public class KeyAndParamCheckForPSS extends PKCS11Test {
 37 
 38     /**
 39      * ALGORITHM name, fixed as RSA for PKCS11
 40      */
 41     private static final String KEYALG = &quot;RSA&quot;;
 42     private static final String SIGALG = &quot;RSASSA-PSS&quot;;
 43 
 44     public static void main(String[] args) throws Exception {
 45         main(new KeyAndParamCheckForPSS(), args);
 46     }
 47 
 48     @Override
 49     public void main(Provider p) throws Exception {
 50         Signature sig;
 51         try {
 52             sig = Signature.getInstance(SIGALG, p);
 53         } catch (NoSuchAlgorithmException e) {
 54             System.out.println(&quot;Skip testing RSASSA-PSS&quot; +
 55                 &quot; due to no support&quot;);
 56             return;
 57         }
 58         // NOTE: key length &gt;= (digest length + 2) in bytes
 59         // otherwise, even salt length = 0 would not work
 60         runTest(p, 1024, &quot;SHA-256&quot;, &quot;SHA-256&quot;);
 61         runTest(p, 1024, &quot;SHA-256&quot;, &quot;SHA-384&quot;);
 62         runTest(p, 1024, &quot;SHA-256&quot;, &quot;SHA-512&quot;);
 63         runTest(p, 1024, &quot;SHA-384&quot;, &quot;SHA-256&quot;);
 64         runTest(p, 1024, &quot;SHA-384&quot;, &quot;SHA-384&quot;);
 65         runTest(p, 1024, &quot;SHA-384&quot;, &quot;SHA-512&quot;);
 66         runTest(p, 1040, &quot;SHA-512&quot;, &quot;SHA-256&quot;);
 67         runTest(p, 1040, &quot;SHA-512&quot;, &quot;SHA-384&quot;);
 68         runTest(p, 1040, &quot;SHA-512&quot;, &quot;SHA-512&quot;);
 69     }
 70 
 71     private void runTest(Provider p, int keySize, String hashAlg,
 72             String mgfHashAlg) throws Exception {
 73         System.out.println(&quot;Testing [&quot; + keySize + &quot; &quot; + hashAlg + &quot;]&quot;);
 74 
 75         // create a key pair with the supplied size
 76         KeyPairGenerator kpg = KeyPairGenerator.getInstance(KEYALG, p);
 77         kpg.initialize(keySize);
 78         KeyPair kp = kpg.generateKeyPair();
 79 
 80         int bigSaltLen = keySize/8 - 14;
 81         AlgorithmParameterSpec paramsBad = new PSSParameterSpec(hashAlg,
 82             &quot;MGF1&quot;, new MGF1ParameterSpec(mgfHashAlg), bigSaltLen, 1);
 83         AlgorithmParameterSpec paramsGood = new PSSParameterSpec(hashAlg,
 84             &quot;MGF1&quot;, new MGF1ParameterSpec(mgfHashAlg), 0, 1);
 85 
 86         PrivateKey priv = kp.getPrivate();
 87         PublicKey pub = kp.getPublic();
 88 
 89         // test#1 - setParameter then initSign
 90         Signature sig = Signature.getInstance(&quot;RSASSA-PSS&quot;, p);
 91         sig.setParameter(paramsBad);
 92         try {
 93             sig.initSign(priv);
 94             throw new RuntimeException(&quot;Expected IKE not thrown&quot;);
 95         } catch (InvalidKeyException ike) {
 96             System.out.println(&quot;test#1: got expected IKE&quot;);
 97         }
 98         sig.setParameter(paramsGood);
 99         sig.initSign(priv);
100         System.out.println(&quot;test#1: pass&quot;);
101 
102         // test#2 - setParameter then initVerify
103         sig = Signature.getInstance(&quot;RSASSA-PSS&quot;, p);
104         sig.setParameter(paramsBad);
105         try {
106             sig.initVerify(pub);
107             throw new RuntimeException(&quot;Expected IKE not thrown&quot;);
108         } catch (InvalidKeyException ike) {
109             System.out.println(&quot;test#2: got expected IKE&quot;);
110         }
111         sig.setParameter(paramsGood);
112         sig.initVerify(pub);
113         System.out.println(&quot;test#2: pass&quot;);
114 
115         // test#3 - initSign, then setParameter
116         sig = Signature.getInstance(&quot;RSASSA-PSS&quot;, p);
117         sig.initSign(priv);
118         try {
119             sig.setParameter(paramsBad);
120             throw new RuntimeException(&quot;Expected IAPE not thrown&quot;);
121         } catch (InvalidAlgorithmParameterException iape) {
122             System.out.println(&quot;test#3: got expected IAPE&quot;);
123         }
124         sig.setParameter(paramsGood);
125         System.out.println(&quot;test#3: pass&quot;);
126 
127         // test#4 - initVerify, then setParameter
128         sig = Signature.getInstance(&quot;RSASSA-PSS&quot;, p);
129         sig.initVerify(pub);
130         try {
131             sig.setParameter(paramsBad);
132             throw new RuntimeException(&quot;Expected IAPE not thrown&quot;);
133         } catch (InvalidAlgorithmParameterException iape) {
134             System.out.println(&quot;test#4: got expected IAPE&quot;);
135         }
136         sig.setParameter(paramsGood);
137         System.out.println(&quot;test#4: pass&quot;);
138     }
139 }
    </pre>
  </body>
</html>