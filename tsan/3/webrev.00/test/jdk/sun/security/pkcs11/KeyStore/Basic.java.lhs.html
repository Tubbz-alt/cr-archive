<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/pkcs11/KeyStore/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 import java.io.*;
  25 import java.util.*;
  26 
  27 import java.security.KeyStore;
  28 import java.security.KeyStoreException;
  29 import java.security.KeyFactory;
  30 import java.security.KeyPairGenerator;
  31 import java.security.KeyPair;
  32 import java.security.SecureRandom;
  33 import java.security.AuthProvider;
  34 import java.security.PrivateKey;
  35 import java.security.Provider;
  36 import java.security.ProviderException;
  37 import java.security.Signature;
  38 import java.security.Security;
  39 
  40 import java.security.cert.*;
  41 import java.security.spec.*;
  42 import java.security.interfaces.*;
  43 
  44 import javax.crypto.SecretKey;
  45 
  46 import javax.security.auth.Subject;
  47 import javax.security.auth.login.LoginException;
  48 
  49 import com.sun.security.auth.module.*;
  50 import com.sun.security.auth.callback.*;
  51 
  52 
  53 public class Basic extends PKCS11Test {
  54 
  55     private static final char SEP = File.separatorChar;
  56 
  57     private static String DIR = System.getProperty(&quot;DIR&quot;);
  58     private static char[] tokenPwd;
  59     private static final char[] ibuttonPwd =
  60                         new char[0];
  61     private static final char[] activcardPwd =
  62                         new char[] { &#39;1&#39;, &#39;1&#39;, &#39;2&#39;, &#39;2&#39;, &#39;3&#39;, &#39;3&#39; };
  63     private static final char[] nssPwd =
  64                         new char[] { &#39;t&#39;, &#39;e&#39;, &#39;s&#39;, &#39;t&#39;, &#39;1&#39;, &#39;2&#39; };
  65     private static final char[] solarisPwd =
  66                         new char[] { &#39;p&#39;, &#39;i&#39;, &#39;n&#39; };
  67     private static final char[] sca1000Pwd =
  68                         new char[] { &#39;p&#39;, &#39;a&#39;, &#39;s&#39;, &#39;s&#39;, &#39;w&#39;, &#39;o&#39;, &#39;r&#39;, &#39;d&#39; };
  69     private static final char[] sPwd = { &#39;f&#39;, &#39;o&#39;, &#39;o&#39; };
  70 
  71     private static SecretKey sk1;
  72     private static SecretKey sk2;
  73     private static SecretKey sk3;
  74     private static SecretKey sk4;
  75 
  76     private static RSAPrivateCrtKey pk1;
  77     private static PrivateKey pk2;
  78     private static PrivateKey pk3;
  79 
  80     private static Certificate[] chain1;
  81     private static Certificate[] chain2;
  82     private static Certificate[] chain3;
  83     private static Certificate[] chain4;
  84 
  85     private static X509Certificate randomCert;
  86 
  87     private static KeyStore ks;
  88     private static final String KS_TYPE = &quot;PKCS11&quot;;
  89     private static Provider provider;
  90 
  91     private static class FooEntry implements KeyStore.Entry { }
  92 
  93     private static class P11SecretKey implements SecretKey {
  94         String alg;
  95         int length;
  96         public P11SecretKey(String alg, int length) {
  97             this.alg = alg;
  98             this.length = length;
  99         }
 100         public String getAlgorithm() { return alg; }
 101         public String getFormat() { return &quot;raw&quot;; }
 102         public byte[] getEncoded() { return new byte[length/8]; }
 103     }
 104 
 105     public static void main(String[] args) throws Exception {
 106         main(new Basic(), args);
 107     }
 108 
 109     public void main(Provider p) throws Exception {
 110 
 111         this.provider = p;
 112 
 113         // get private keys
<a name="2" id="anc2"></a><span class="line-modified"> 114         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;, &quot;SunJSSE&quot;);</span>
 115         KeyFactory dsaKf = KeyFactory.getInstance(&quot;DSA&quot;, &quot;SUN&quot;);
 116 
 117         ObjectInputStream ois1 = new ObjectInputStream
 118                         (new FileInputStream(new File(DIR, &quot;pk1.key&quot;)));
 119         byte[] keyBytes = (byte[])ois1.readObject();
 120         ois1.close();
 121         PrivateKey tmpKey =
 122                 kf.generatePrivate(new PKCS8EncodedKeySpec(keyBytes));
 123         pk1 = (RSAPrivateCrtKey)tmpKey;
 124 
 125         ObjectInputStream ois2 = new ObjectInputStream
 126                         (new FileInputStream(new File(DIR, &quot;pk2.key&quot;)));
 127         keyBytes = (byte[])ois2.readObject();
 128         ois2.close();
 129         pk2 = kf.generatePrivate(new PKCS8EncodedKeySpec(keyBytes));
 130 
 131         ObjectInputStream ois3 = new ObjectInputStream
 132                         (new FileInputStream(new File(DIR, &quot;pk3.key&quot;)));
 133         keyBytes = (byte[])ois3.readObject();
 134         pk3 = kf.generatePrivate(new PKCS8EncodedKeySpec(keyBytes));
 135         ois3.close();
 136 
 137         // get cert chains for private keys
 138         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;, &quot;SUN&quot;);
 139         Certificate caCert = (X509Certificate)cf.generateCertificate
 140                         (new FileInputStream(new File(DIR, &quot;ca.cert&quot;)));
 141         Certificate ca2Cert = (X509Certificate)cf.generateCertificate
 142                         (new FileInputStream(new File(DIR, &quot;ca2.cert&quot;)));
 143         Certificate pk1cert = (X509Certificate)cf.generateCertificate
 144                         (new FileInputStream(new File(DIR, &quot;pk1.cert&quot;)));
 145         Certificate pk1cert2 = (X509Certificate)cf.generateCertificate
 146                         (new FileInputStream(new File(DIR, &quot;pk1.cert2&quot;)));
 147         Certificate pk2cert = (X509Certificate)cf.generateCertificate
 148                         (new FileInputStream(new File(DIR, &quot;pk2.cert&quot;)));
 149         Certificate pk3cert = (X509Certificate)cf.generateCertificate
 150                         (new FileInputStream(new File(DIR, &quot;pk3.cert&quot;)));
 151         chain1 = new Certificate[] { pk1cert, caCert };
 152         chain2 = new Certificate[] { pk2cert, caCert };
 153         chain3 = new Certificate[] { pk3cert, caCert };
 154         chain4 = new Certificate[] { pk1cert2, ca2Cert };
 155 
 156         // create secret keys
 157         sk1 = new P11SecretKey(&quot;DES&quot;, 64);
 158         sk2 = new P11SecretKey(&quot;DESede&quot;, 192);
 159         sk3 = new P11SecretKey(&quot;AES&quot;, 128);
 160         sk4 = new P11SecretKey(&quot;RC4&quot;, 128);
 161 
 162         // read randomCert
 163         randomCert = (X509Certificate)cf.generateCertificate
 164                         (new FileInputStream(new File(DIR, &quot;random.cert&quot;)));
 165 
 166         doTest();
 167     }
 168 
 169     private static void doTest() throws Exception {
 170 
 171         String token = System.getProperty(&quot;TOKEN&quot;);
 172         String test = System.getProperty(&quot;TEST&quot;);
 173 
 174         if (token == null || token.length() == 0) {
 175             throw new Exception(&quot;token arg required&quot;);
 176         }
 177         if (test == null || test.length() == 0) {
 178             throw new Exception(&quot;test arg required&quot;);
 179         }
 180 
 181         if (&quot;ibutton&quot;.equals(token)) {
 182             tokenPwd = ibuttonPwd;
 183         } else if (&quot;activcard&quot;.equals(token)) {
 184             tokenPwd = activcardPwd;
 185         } else if (&quot;nss&quot;.equals(token)) {
 186             tokenPwd = nssPwd;
 187         } else if (&quot;sca1000&quot;.equals(token)) {
 188             tokenPwd = sca1000Pwd;
 189         } else if (&quot;solaris&quot;.equals(token)) {
 190             tokenPwd = solarisPwd;
 191         }
 192 
 193         if (&quot;list&quot;.equals(test)) {
 194             Basic.list();
 195         } else if (&quot;basic&quot;.equals(test)) {
 196 
 197             int testnum = 1;
 198 
 199             if (&quot;ibutton&quot;.equals(token)) {
 200                 // pkey and setAttribute
 201                 testnum = Basic.pkey(testnum);
 202                 testnum = Basic.setAttribute(testnum);
 203             } else if (&quot;activcard&quot;.equals(token)) {
 204                 // sign
 205                 testnum = Basic.signAlias(testnum, null);
 206             } else if (&quot;nss&quot;.equals(token)) {
 207                 // setAttribute, pkey, sign
 208                 testnum = Basic.setAttribute(testnum);
 209                 testnum = Basic.pkey(testnum);
 210                 testnum = Basic.sign(testnum);
 211                 testnum = Basic.copy(testnum);
 212             } else if (&quot;solaris&quot;.equals(token)) {
 213                 testnum = Basic.setAttribute(testnum);
 214                 testnum = Basic.pkey(testnum);
 215                 testnum = Basic.sign(testnum);
 216                 testnum = Basic.skey(testnum);
 217                 testnum = Basic.copy(testnum);
 218             } else if (&quot;sca1000&quot;.equals(token)) {
 219                 // setAttribute, pkey, sign, skey, copy
 220                 testnum = Basic.setAttribute(testnum);
 221                 testnum = Basic.pkey(testnum);
 222                 testnum = Basic.sign(testnum);
 223                 testnum = Basic.skey(testnum);
 224                 testnum = Basic.copy(testnum);
 225             }
 226 
 227         } else if (&quot;pkey&quot;.equals(test)) {
 228             Basic.pkey(1);
 229         } else if (&quot;skey&quot;.equals(test)) {
 230             Basic.skey(1);
 231         } else if (&quot;setAttribute&quot;.equals(test)) {
 232             Basic.setAttribute(1);
 233         } else if (&quot;copy&quot;.equals(test)) {
 234             Basic.copy(1);
 235         } else if (&quot;sign&quot;.equals(test)) {
 236             Basic.sign(1);
 237         } else if (&quot;module&quot;.equals(test)) {
 238             Basic.module();
 239         } else if (&quot;nss-extended&quot;.equals(test)) {
 240 
 241             // this only works if NSS_TEST is set to true in P11KeyStore.java
 242 
 243             int testnum = 1;
 244             testnum = Basic.setAttribute(testnum);
 245             testnum = Basic.pkey(testnum);
 246             testnum = Basic.sign(testnum);
 247             testnum = Basic.extended(testnum);
 248         } else {
 249             System.out.println(&quot;unrecognized command&quot;);
 250         }
 251     }
 252 
 253     private static int sign(int testnum) throws Exception {
 254         if (ks == null) {
 255             ks = KeyStore.getInstance(KS_TYPE, provider);
 256             ks.load(null, tokenPwd);
 257         }
 258         if (!ks.containsAlias(&quot;pk1&quot;)) {
 259             ks.setKeyEntry(&quot;pk1&quot;, pk1, null, chain1);
 260         }
 261         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 262 
 263         return signAlias(testnum, &quot;pk1&quot;);
 264     }
 265 
 266     private static int signAlias(int testnum, String alias) throws Exception {
 267 
 268         if (ks == null) {
 269             ks = KeyStore.getInstance(KS_TYPE, provider);
 270             ks.load(null, tokenPwd);
 271         }
 272 
 273         if (alias == null) {
 274             Enumeration enu = ks.aliases();
 275             if (enu.hasMoreElements()) {
 276                 alias = (String)enu.nextElement();
 277             }
 278         }
 279 
 280         PrivateKey pkey = (PrivateKey)ks.getKey(alias, null);
 281         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
 282             System.out.println(&quot;got [&quot; + alias + &quot;] signing key: &quot; + pkey);
 283         } else {
 284             throw new SecurityException
 285                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
 286         }
 287 
 288         Signature s = Signature.getInstance(&quot;MD5WithRSA&quot;, ks.getProvider());
 289         s.initSign(pkey);
 290         System.out.println(&quot;initialized signature object with key&quot;);
 291         s.update(&quot;hello&quot;.getBytes());
 292         System.out.println(&quot;signature object updated with [hello] bytes&quot;);
 293 
 294         byte[] signed = s.sign();
 295         System.out.println(&quot;received signature &quot; + signed.length +
 296                         &quot; bytes in length&quot;);
 297 
 298         Signature v = Signature.getInstance(&quot;MD5WithRSA&quot;, ks.getProvider());
 299         v.initVerify(ks.getCertificate(alias));
 300         v.update(&quot;hello&quot;.getBytes());
 301         v.verify(signed);
 302         System.out.println(&quot;signature verified&quot;);
 303         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 304 
 305         return testnum;
 306     }
 307 
 308     private static int copy(int testnum) throws Exception {
 309 
 310         if (ks == null) {
 311             ks = KeyStore.getInstance(KS_TYPE, provider);
 312             ks.load(null, tokenPwd);
 313         }
 314 
 315         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;, provider);
 316         PrivateKey pkSession = (PrivateKey)kf.translateKey(pk3);
 317         System.out.println(&quot;pkSession = &quot; + pkSession);
 318         ks.setKeyEntry(&quot;pkSession&quot;, pkSession, null, chain3);
 319 
 320         KeyStore.PrivateKeyEntry pke =
 321                 (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pkSession&quot;, null);
 322         System.out.println(&quot;pkSession = &quot; + pke.getPrivateKey());
 323         Certificate[] chain = pke.getCertificateChain();
 324         if (chain.length != chain3.length) {
 325             throw new SecurityException(&quot;received chain not correct length&quot;);
 326         }
 327         for (int i = 0; i &lt; chain.length; i++) {
 328             if (!chain[i].equals(chain3[i])) {
 329                 throw new SecurityException(&quot;received chain not equal&quot;);
 330             }
 331         }
 332 
 333         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 334 
 335         return testnum;
 336     }
 337 
 338     private static void list() throws Exception {
 339         int testnum = 1;
 340 
 341         ks = KeyStore.getInstance(KS_TYPE, provider);
 342 
 343         // check instance
 344         if (ks.getProvider() instanceof java.security.AuthProvider) {
 345             System.out.println(&quot;keystore provider instance of AuthProvider&quot;);
 346             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 347         } else {
 348             throw new SecurityException(&quot;did not get AuthProvider KeyStore&quot;);
 349         }
 350 
 351         // load
 352         ks.load(null, tokenPwd);
 353         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 354 
 355         // aliases
 356         Enumeration enu = ks.aliases();
 357         int count = 0;
 358         while (enu.hasMoreElements()) {
 359             count++;
 360             System.out.println(&quot;alias &quot; +
 361                                 count +
 362                                 &quot; = &quot; +
 363                                 (String)enu.nextElement());
 364         }
 365     }
 366 
 367     private static void module() throws Exception {
 368 
 369         // perform Security.addProvider of P11 provider
 370         Security.addProvider(getSunPKCS11(System.getProperty(&quot;CUSTOM_P11_CONFIG&quot;)));
 371 
 372         String KS_PROVIDER = &quot;SunPKCS11-&quot; + System.getProperty(&quot;TOKEN&quot;);
 373 
 374         KeyStoreLoginModule m = new KeyStoreLoginModule();
 375         Subject s = new Subject();
 376         Map options = new HashMap();
 377         options.put(&quot;keyStoreURL&quot;, &quot;NONE&quot;);
 378         options.put(&quot;keyStoreType&quot;, KS_TYPE);
 379         options.put(&quot;keyStoreProvider&quot;, KS_PROVIDER);
 380         options.put(&quot;debug&quot;, &quot;true&quot;);
 381         m.initialize(s, new TextCallbackHandler(), new HashMap(), options);
 382         m.login();
 383         m.commit();
 384         System.out.println(&quot;authenticated subject = &quot; + s);
 385         m.logout();
 386         System.out.println(&quot;authenticated subject = &quot; + s);
 387     }
 388 
 389     /**
 390      * SCA1000 does not handle extended secret key tests
 391      * . Blowfish (CKR_TEMPLATE_INCOMPLETE)
 392      * . AES (CKR_TEMPLATE_INCOMPLETE)
 393      * . RC4 (CKR_ATTRIBUTE_TYPE_INVALID)
 394      * so do this instead
 395      */
 396     private static int skey(int testnum) throws Exception {
 397         if (ks == null) {
 398             ks = KeyStore.getInstance(KS_TYPE, provider);
 399             ks.load(null, tokenPwd);
 400         }
 401 
 402         // delete all old aliases
 403         Enumeration enu = ks.aliases();
 404         int count = 0;
 405         while (enu.hasMoreElements()) {
 406             String next = (String)enu.nextElement();
 407             ks.deleteEntry(next);
 408             System.out.println(&quot;deleted entry for: &quot; + next);
 409         }
 410 
 411         // set good ske 1
 412         ks.setKeyEntry(&quot;sk1&quot;, sk1, null, null);
 413         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 414 
 415         // set good ske 2
 416         ks.setKeyEntry(&quot;sk2&quot;, sk2, null, null);
 417         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 418 
 419         // getEntry good ske 1
 420         KeyStore.SecretKeyEntry ske =
 421                 (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk1&quot;, null);
 422         if (&quot;DES&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 423             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 424         } else {
 425             throw new SecurityException
 426                 (&quot;expected DES, got &quot; + ske.getSecretKey().getAlgorithm());
 427         }
 428 
 429         // getEntry good ske 2
 430         ske = (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk2&quot;, null);
 431         if (&quot;DESede&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 432             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 433         } else {
 434             throw new SecurityException
 435                 (&quot;expected DESede, got &quot; + ske.getSecretKey().getAlgorithm());
 436         }
 437 
 438         // getKey good ske 1
 439         SecretKey skey = (SecretKey)ks.getKey(&quot;sk1&quot;, null);
 440         if (&quot;DES&quot;.equals(skey.getAlgorithm())) {
 441             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 442         } else {
 443             throw new SecurityException
 444                 (&quot;expected DES, got &quot; + skey.getAlgorithm());
 445         }
 446 
 447         // getKey good ske 2
 448         skey = (SecretKey)ks.getKey(&quot;sk2&quot;, null);
 449         if (&quot;DESede&quot;.equals(skey.getAlgorithm())) {
 450             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 451         } else {
 452             throw new SecurityException
 453                 (&quot;expected DESede, got &quot; + skey.getAlgorithm());
 454         }
 455 
 456         // aliases
 457         enu = ks.aliases();
 458         count = 0;
 459         while (enu.hasMoreElements()) {
 460             count++;
 461             System.out.println(&quot;alias &quot; +
 462                                 count +
 463                                 &quot; = &quot; +
 464                                 (String)enu.nextElement());
 465         }
 466         if (count == 2) {
 467             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 468         } else {
 469             throw new SecurityException(&quot;expected 2 aliases&quot;);
 470         }
 471 
 472         // size
 473         if (ks.size() == 2) {
 474             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 475         } else {
 476             throw new SecurityException(&quot;expected size 2&quot;);
 477         }
 478 
 479         // isCertificateEntry sk1
 480         if (!ks.isCertificateEntry(&quot;sk1&quot;)) {
 481             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 482         } else {
 483             throw new SecurityException(&quot;expected ske&quot;);
 484         }
 485 
 486         // isKeyEntry sk1
 487         if (ks.isKeyEntry(&quot;sk1&quot;)) {
 488             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 489         } else {
 490             throw new SecurityException(&quot;expected ske&quot;);
 491         }
 492 
 493         // entryInstanceOf sk2
 494         if (ks.entryInstanceOf(&quot;sk2&quot;, KeyStore.SecretKeyEntry.class)) {
 495             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 496         } else {
 497             throw new SecurityException(&quot;expected ske&quot;);
 498         }
 499 
 500         return testnum;
 501     }
 502 
 503     private static int setAttribute(int testnum) throws Exception {
 504 
 505         if (ks == null) {
 506             ks = KeyStore.getInstance(KS_TYPE, provider);
 507             ks.load(null, tokenPwd);
 508         }
 509 
 510         if (!ks.containsAlias(&quot;pk1&quot;)) {
 511             // set good pke 1
 512             ks.setKeyEntry(&quot;pk1&quot;, pk1, null, chain1);
 513             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 514         }
 515 
 516         // delete all old aliases except pk1
 517         Enumeration enu = ks.aliases();
 518         int count = 0;
 519         while (enu.hasMoreElements()) {
 520             String next = (String)enu.nextElement();
 521             if (!&quot;pk1&quot;.equals(next)) {
 522                 ks.deleteEntry(next);
 523                 System.out.println(&quot;deleted entry for: &quot; + next);
 524             }
 525         }
 526 
 527         KeyStore.PrivateKeyEntry pke =
 528                 (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1&quot;, null);
 529         System.out.println(&quot;pk1 = &quot; + pke.getPrivateKey());
 530         Certificate[] chain = pke.getCertificateChain();
 531         if (chain.length != chain1.length) {
 532             throw new SecurityException(&quot;received chain not correct length&quot;);
 533         }
 534         for (int i = 0; i &lt; chain.length; i++) {
 535             if (!chain[i].equals(chain1[i])) {
 536                 throw new SecurityException(&quot;received chain not equal&quot;);
 537             }
 538         }
 539         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 540 
 541         /**
 542          * test change alias only
 543          */
 544 
 545         // test C_SetAttribute
 546         PrivateKey pkey = pke.getPrivateKey();
 547         ks.setEntry(&quot;pk1SA&quot;,
 548                 new KeyStore.PrivateKeyEntry(pkey, chain1),
 549                 null);
 550         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 551 
 552         // aliases
 553         enu = ks.aliases();
 554         count = 0;
 555         String newAlias = null;
 556         while (enu.hasMoreElements()) {
 557             count++;
 558             newAlias = (String)enu.nextElement();
 559             System.out.println(&quot;alias &quot; +
 560                                 count +
 561                                 &quot; = &quot; +
 562                                 newAlias);
 563         }
 564         if (count == 1 &amp;&amp; &quot;pk1SA&quot;.equals(newAlias)) {
 565             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 566         } else {
 567             throw new SecurityException(&quot;expected 1 alias&quot;);
 568         }
 569 
 570         // size
 571         if (ks.size() == 1) {
 572             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 573         } else {
 574             throw new SecurityException(&quot;expected size 1&quot;);
 575         }
 576 
 577         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1&quot;, null);
 578         if (pke != null) {
 579             throw new SecurityException(&quot;expected not to find pk1&quot;);
 580         }
 581         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 582 
 583         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1SA&quot;, null);
 584         System.out.println(&quot;pk1SA = &quot; + pke.getPrivateKey());
 585         chain = pke.getCertificateChain();
 586         if (chain.length != chain1.length) {
 587             throw new SecurityException(&quot;received chain not correct length&quot;);
 588         }
 589         for (int i = 0; i &lt; chain.length; i++) {
 590             if (!chain[i].equals(chain1[i])) {
 591                 throw new SecurityException(&quot;received chain not equal&quot;);
 592             }
 593         }
 594         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 595 
 596         /**
 597          * test change cert chain
 598          */
 599 
 600         pkey = pke.getPrivateKey();
 601         ks.setEntry(&quot;pk1SA-2&quot;,
 602                 new KeyStore.PrivateKeyEntry(pkey, chain4),
 603                 null);
 604         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 605 
 606         // aliases
 607         enu = ks.aliases();
 608         count = 0;
 609         newAlias = null;
 610         while (enu.hasMoreElements()) {
 611             count++;
 612             newAlias = (String)enu.nextElement();
 613             System.out.println(&quot;alias &quot; +
 614                                 count +
 615                                 &quot; = &quot; +
 616                                 newAlias);
 617         }
 618         if (count == 1 &amp;&amp; &quot;pk1SA-2&quot;.equals(newAlias)) {
 619             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 620         } else {
 621             throw new SecurityException(&quot;expected 1 alias&quot;);
 622         }
 623 
 624         // size
 625         if (ks.size() == 1) {
 626             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 627         } else {
 628             throw new SecurityException(&quot;expected size 1&quot;);
 629         }
 630 
 631         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1SA&quot;, null);
 632         if (pke != null) {
 633             throw new SecurityException(&quot;expected not to find pk1SA&quot;);
 634         }
 635         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 636 
 637         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1SA-2&quot;, null);
 638         System.out.println(&quot;pk1SA-2 = &quot; + pke.getPrivateKey());
 639         chain = pke.getCertificateChain();
 640         if (chain.length != chain4.length) {
 641             throw new SecurityException(&quot;received chain not correct length&quot;);
 642         }
 643         for (int i = 0; i &lt; chain.length; i++) {
 644             if (!chain[i].equals(chain4[i])) {
 645                 throw new SecurityException(&quot;received chain not equal&quot;);
 646             }
 647         }
 648         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 649 
 650         return testnum;
 651     }
 652 
 653     private static int pkey(int testnum) throws Exception {
 654 
 655         if (ks == null) {
 656             ks = KeyStore.getInstance(KS_TYPE, provider);
 657             ks.load(null, tokenPwd);
 658             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 659         }
 660 
 661         // check instance
 662         if (ks.getProvider() instanceof java.security.AuthProvider) {
 663             System.out.println(&quot;keystore provider instance of AuthProvider&quot;);
 664             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 665         } else {
 666             throw new SecurityException(&quot;did not get AuthProvider KeyStore&quot;);
 667         }
 668 
 669         // delete all old aliases
 670         Enumeration enu = ks.aliases();
 671         int count = 0;
 672         while (enu.hasMoreElements()) {
 673             String next = (String)enu.nextElement();
 674             ks.deleteEntry(next);
 675             System.out.println(&quot;deleted entry for: &quot; + next);
 676         }
 677 
 678         // set good pke 1
 679         ks.setKeyEntry(&quot;pk1&quot;, pk1, null, chain1);
 680         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 681 
 682         // set good pke 2
 683         ks.setEntry(&quot;pk2&quot;,
 684                 new KeyStore.PrivateKeyEntry(pk2, chain2),
 685                 null);
 686         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 687 
 688         // getEntry good pke 1
 689         KeyStore.PrivateKeyEntry pke =
 690                 (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1&quot;, null);
 691         System.out.println(&quot;pk1 = &quot; + pke.getPrivateKey());
 692         Certificate[] chain = pke.getCertificateChain();
 693         if (chain.length != chain1.length) {
 694             throw new SecurityException(&quot;received chain not correct length&quot;);
 695         }
 696         for (int i = 0; i &lt; chain.length; i++) {
 697             if (!chain[i].equals(chain1[i])) {
 698                 throw new SecurityException(&quot;received chain not equal&quot;);
 699             }
 700         }
 701 
 702         // getKey good pke 1
 703         PrivateKey pkey = (PrivateKey)ks.getKey(&quot;pk1&quot;, null);
 704         System.out.println(&quot;pk1 = &quot; + pkey);
 705         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
 706             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 707         } else {
 708             throw new SecurityException
 709                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
 710         }
 711 
 712         // getCertificate chain chain 1
 713         chain = ks.getCertificateChain(&quot;pk1&quot;);
 714         if (chain.length != chain1.length) {
 715             throw new SecurityException(&quot;received chain not correct length&quot;);
 716         }
 717         for (int i = 0; i &lt; chain.length; i++) {
 718             if (!chain[i].equals(chain1[i])) {
 719                 throw new SecurityException(&quot;received chain not equal&quot;);
 720             }
 721         }
 722         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 723 
 724         // getEntry good pke 2
 725         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk2&quot;, null);
 726         if (&quot;RSA&quot;.equals(pke.getPrivateKey().getAlgorithm())) {
 727             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 728         } else {
 729             throw new SecurityException
 730                 (&quot;expected RSA, got &quot; + pke.getPrivateKey().getAlgorithm());
 731         }
 732         System.out.println(&quot;pk2 = &quot; + pke.getPrivateKey());
 733         chain = pke.getCertificateChain();
 734         if (chain.length != chain2.length) {
 735             throw new SecurityException(&quot;received chain not correct length&quot;);
 736         }
 737         for (int i = 0; i &lt; chain.length; i++) {
 738             if (!chain[i].equals(chain2[i])) {
 739                 throw new SecurityException(&quot;received chain not equal&quot;);
 740             }
 741         }
 742 
 743         // getKey good pke 2
 744         pkey = (PrivateKey)ks.getKey(&quot;pk2&quot;, null);
 745         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
 746             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 747         } else {
 748             throw new SecurityException
 749                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
 750         }
 751 
 752         // getCertificate chain chain 2
 753         chain = ks.getCertificateChain(&quot;pk2&quot;);
 754         if (chain.length != chain2.length) {
 755             throw new SecurityException(&quot;received chain not correct length&quot;);
 756         }
 757         for (int i = 0; i &lt; chain.length; i++) {
 758             if (!chain[i].equals(chain2[i])) {
 759                 throw new SecurityException(&quot;received chain not equal&quot;);
 760             }
 761         }
 762         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 763 
 764         // aliases
 765         enu = ks.aliases();
 766         count = 0;
 767         while (enu.hasMoreElements()) {
 768             count++;
 769             System.out.println(&quot;alias &quot; +
 770                                 count +
 771                                 &quot; = &quot; +
 772                                 (String)enu.nextElement());
 773         }
 774         if (count == 2) {
 775             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 776         } else {
 777             throw new SecurityException(&quot;expected 2 aliases&quot;);
 778         }
 779 
 780         // size
 781         if (ks.size() == 2) {
 782             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 783         } else {
 784             throw new SecurityException(&quot;expected size 2&quot;);
 785         }
 786 
 787         // getCertificate
 788         if (ks.getCertificate(&quot;pk1&quot;).equals(chain1[0])) {
 789             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 790         } else {
 791             throw new SecurityException(&quot;expected certificate pk1 end entity&quot;);
 792         }
 793 
 794         // containsAlias
 795         if (ks.containsAlias(&quot;pk1&quot;) &amp;&amp; ks.containsAlias(&quot;pk2&quot;) &amp;&amp;
 796             !ks.containsAlias(&quot;foobar&quot;) &amp;&amp;
 797             !ks.containsAlias(&quot;pk1.2&quot;) &amp;&amp; !ks.containsAlias(&quot;pk2.2&quot;)) {
 798             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 799         } else {
 800             throw new SecurityException(&quot;unexpected aliases encountered&quot;);
 801         }
 802 
 803         // isKeyEntry
 804         if (ks.isKeyEntry(&quot;pk1&quot;) &amp;&amp; ks.isKeyEntry(&quot;pk2&quot;) &amp;&amp;
 805             !ks.isKeyEntry(&quot;foobar&quot;)) {
 806             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 807         } else {
 808             throw new SecurityException(&quot;isKeyEntry failed&quot;);
 809         }
 810 
 811         // isCertificateEntry
 812         if (!ks.isCertificateEntry(&quot;foobar&quot;) &amp;&amp;
 813             !ks.isCertificateEntry(&quot;pk1&quot;) &amp;&amp; !ks.isCertificateEntry(&quot;pk2&quot;)) {
 814             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 815         } else {
 816             throw new SecurityException(&quot;isCertificateEntry failed&quot;);
 817         }
 818 
 819         // getCertificateAlias
 820         if (ks.getCertificateAlias(chain1[0]).equals(&quot;pk1&quot;) &amp;&amp;
 821             ks.getCertificateAlias(chain2[0]).equals(&quot;pk2&quot;) &amp;&amp;
 822             ks.getCertificateAlias(randomCert) == null) {
 823             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 824         } else {
 825             throw new SecurityException(&quot;getCertificateAlias failed&quot;);
 826         }
 827 
 828         if (ks.entryInstanceOf(&quot;pk1&quot;, KeyStore.PrivateKeyEntry.class) &amp;&amp;
 829             ks.entryInstanceOf(&quot;pk2&quot;, KeyStore.PrivateKeyEntry.class) &amp;&amp;
 830         !ks.entryInstanceOf(&quot;pk1&quot;, KeyStore.TrustedCertificateEntry.class) &amp;&amp;
 831         !ks.entryInstanceOf(&quot;pk2&quot;, KeyStore.TrustedCertificateEntry.class) &amp;&amp;
 832         !ks.entryInstanceOf(&quot;foobar&quot;, KeyStore.TrustedCertificateEntry.class) &amp;&amp;
 833           !ks.entryInstanceOf(&quot;foobar&quot;, KeyStore.PrivateKeyEntry.class)) {
 834             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 835         } else {
 836             throw new SecurityException(&quot;entryInstanceOf failed&quot;);
 837         }
 838 
 839         ks.deleteEntry(&quot;pk2&quot;);
 840         if (ks.containsAlias(&quot;pk1&quot;) &amp;&amp; !ks.containsAlias(&quot;pk2&quot;)) {
 841             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 842         } else {
 843             throw new SecurityException(&quot;deleteEntry failed&quot;);
 844         }
 845 
 846         // getEntry good pke 1
 847         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1&quot;, null);
 848         System.out.println(&quot;pk1 = &quot; + pke.getPrivateKey());
 849         chain = pke.getCertificateChain();
 850         if (chain.length != chain1.length) {
 851             throw new SecurityException(&quot;received chain not correct length&quot;);
 852         }
 853         for (int i = 0; i &lt; chain.length; i++) {
 854             if (!chain[i].equals(chain1[i])) {
 855                 throw new SecurityException(&quot;received chain not equal&quot;);
 856             }
 857         }
 858         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 859 
 860         // aliases
 861         enu = ks.aliases();
 862         count = 0;
 863         while (enu.hasMoreElements()) {
 864             count++;
 865             System.out.println(&quot;alias &quot; +
 866                                 count +
 867                                 &quot; = &quot; +
 868                                 (String)enu.nextElement());
 869         }
 870         if (count == 1) {
 871             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 872         } else {
 873             throw new SecurityException(&quot;expected 1 alias&quot;);
 874         }
 875 
 876         // size
 877         if (ks.size() == 1) {
 878             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 879         } else {
 880             throw new SecurityException(&quot;expected size 1&quot;);
 881         }
 882 
 883         return testnum;
 884     }
 885 
 886     private static int extended(int testnum) throws Exception {
 887 
 888         // setEntry unknown entry type
 889         try {
 890             ks.setEntry(&quot;foo&quot;, new FooEntry(), null);
 891             throw new SecurityException(&quot;setEntry should have failed&quot;);
 892         } catch (KeyStoreException kse) {
 893             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 894         }
 895 
 896         // getEntry random foo
 897         if (ks.getEntry(&quot;foo&quot;, null) != null) {
 898             throw new SecurityException(&quot;expected null entry&quot;);
 899         } else {
 900             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 901         }
 902 
 903         // set good ske 1
 904         ks.setKeyEntry(&quot;sk1&quot;, sk1, null, null);
 905         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 906 
 907         // set good ske 2
 908         ks.setKeyEntry(&quot;sk2&quot;, sk2, null, null);
 909         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 910 
 911         // set good ske 3
 912         ks.setEntry(&quot;sk3&quot;,
 913                 new KeyStore.SecretKeyEntry(sk3),
 914                 null);
 915         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 916 
 917         // set good ske 4
 918         ks.setEntry(&quot;sk4&quot;,
 919                 new KeyStore.SecretKeyEntry(sk4),
 920                 null);
 921         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 922 
 923         // getEntry good ske 1
 924         KeyStore.SecretKeyEntry ske =
 925                 (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk1&quot;, null);
 926         if (&quot;DES&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 927             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 928         } else {
 929             throw new SecurityException
 930                 (&quot;expected DES, got &quot; + ske.getSecretKey().getAlgorithm());
 931         }
 932 
 933         // getEntry good ske 2
 934         ske = (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk2&quot;, null);
 935         if (&quot;DESede&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 936             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 937         } else {
 938             throw new SecurityException
 939                 (&quot;expected DESede, got &quot; + ske.getSecretKey().getAlgorithm());
 940         }
 941 
 942         // getEntry good ske 3
 943         ske = (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk3&quot;, null);
 944         if (&quot;AES&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 945             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 946         } else {
 947             throw new SecurityException
 948                 (&quot;expected AES, got &quot; + ske.getSecretKey().getAlgorithm());
 949         }
 950 
 951         // getEntry good ske 4
 952         ske = (KeyStore.SecretKeyEntry)ks.getEntry(&quot;sk4&quot;, null);
 953         if (&quot;ARCFOUR&quot;.equals(ske.getSecretKey().getAlgorithm())) {
 954             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 955         } else {
 956             throw new SecurityException
 957                 (&quot;expected ARCFOUR, got &quot; + ske.getSecretKey().getAlgorithm());
 958         }
 959 
 960         // getKey good ske 1
 961         SecretKey skey = (SecretKey)ks.getKey(&quot;sk1&quot;, null);
 962         if (&quot;DES&quot;.equals(skey.getAlgorithm())) {
 963             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 964         } else {
 965             throw new SecurityException
 966                 (&quot;expected DES, got &quot; + skey.getAlgorithm());
 967         }
 968 
 969         // getKey good ske 2
 970         skey = (SecretKey)ks.getKey(&quot;sk2&quot;, null);
 971         if (&quot;DESede&quot;.equals(skey.getAlgorithm())) {
 972             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 973         } else {
 974             throw new SecurityException
 975                 (&quot;expected DESede, got &quot; + skey.getAlgorithm());
 976         }
 977 
 978         // getKey good ske 3
 979         skey = (SecretKey)ks.getKey(&quot;sk3&quot;, null);
 980         if (&quot;AES&quot;.equals(skey.getAlgorithm())) {
 981             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 982         } else {
 983             throw new SecurityException
 984                 (&quot;expected AES, got &quot; + skey.getAlgorithm());
 985         }
 986 
 987         // getKey good ske 4
 988         skey = (SecretKey)ks.getKey(&quot;sk4&quot;, null);
 989         if (&quot;ARCFOUR&quot;.equals(skey.getAlgorithm())) {
 990             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
 991         } else {
 992             throw new SecurityException
 993                 (&quot;expected ARCFOUR, got &quot; + skey.getAlgorithm());
 994         }
 995 
 996         // aliases
 997         Enumeration enu = ks.aliases();
 998         int count = 0;
 999         while (enu.hasMoreElements()) {
1000             count++;
1001             System.out.println(&quot;alias &quot; +
1002                                 count +
1003                                 &quot; = &quot; +
1004                                 (String)enu.nextElement());
1005         }
1006         if (count == 5) {
1007             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1008         } else {
1009             throw new SecurityException(&quot;expected 5 aliases&quot;);
1010         }
1011 
1012         // size
1013         if (ks.size() == 5) {
1014             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1015         } else {
1016             throw new SecurityException(&quot;expected size 5&quot;);
1017         }
1018 
1019         // set good pke 2
1020         ks.setEntry(&quot;pk2&quot;,
1021                 new KeyStore.PrivateKeyEntry(pk2, chain2),
1022                 null);
1023         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1024 
1025         // set good pke 3
1026         ks.setEntry(&quot;pk3&quot;,
1027                 new KeyStore.PrivateKeyEntry(pk3, chain3),
1028                 null);
1029         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1030 
1031         // getEntry good pke 1
1032         KeyStore.PrivateKeyEntry pke =
1033                 (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk1&quot;, null);
1034         System.out.println(&quot;pk1 = &quot; + pke.getPrivateKey());
1035         Certificate[] chain = pke.getCertificateChain();
1036         if (chain.length != chain1.length) {
1037             throw new SecurityException(&quot;received chain not correct length&quot;);
1038         }
1039         for (int i = 0; i &lt; chain.length; i++) {
1040             if (!chain[i].equals(chain1[i])) {
1041                 throw new SecurityException(&quot;received chain not equal&quot;);
1042             }
1043         }
1044 
1045         // getEntry good pke 2
1046         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk2&quot;, null);
1047         System.out.println(&quot;pk2 = &quot; + pke.getPrivateKey());
1048         chain = pke.getCertificateChain();
1049         if (chain.length != chain2.length) {
1050             throw new SecurityException(&quot;received chain not correct length&quot;);
1051         }
1052         for (int i = 0; i &lt; chain.length; i++) {
1053             if (!chain[i].equals(chain2[i])) {
1054                 throw new SecurityException(&quot;received chain not equal&quot;);
1055             }
1056         }
1057 
1058         // getEntry good pke 3
1059         pke = (KeyStore.PrivateKeyEntry)ks.getEntry(&quot;pk3&quot;, null);
1060         System.out.println(&quot;pk3 = &quot; + pke.getPrivateKey());
1061         chain = pke.getCertificateChain();
1062         if (chain.length != chain3.length) {
1063             throw new SecurityException(&quot;received chain not correct length&quot;);
1064         }
1065         for (int i = 0; i &lt; chain.length; i++) {
1066             if (!chain[i].equals(chain3[i])) {
1067                 throw new SecurityException(&quot;received chain not equal&quot;);
1068             }
1069         }
1070 
1071         // getKey good pke 1
1072         PrivateKey pkey = (PrivateKey)ks.getKey(&quot;pk1&quot;, null);
1073         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
1074             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1075         } else {
1076             throw new SecurityException
1077                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
1078         }
1079 
1080         // getCertificate chain chain 1
1081         chain = ks.getCertificateChain(&quot;pk1&quot;);
1082         if (chain.length != chain1.length) {
1083             throw new SecurityException(&quot;received chain not correct length&quot;);
1084         }
1085         for (int i = 0; i &lt; chain.length; i++) {
1086             if (!chain[i].equals(chain1[i])) {
1087                 throw new SecurityException(&quot;received chain not equal&quot;);
1088             }
1089         }
1090 
1091         // getKey good pke 2
1092         pkey = (PrivateKey)ks.getKey(&quot;pk2&quot;, null);
1093         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
1094             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1095         } else {
1096             throw new SecurityException
1097                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
1098         }
1099 
1100         // getCertificate chain chain 2
1101         chain = ks.getCertificateChain(&quot;pk2&quot;);
1102         if (chain.length != chain2.length) {
1103             throw new SecurityException(&quot;received chain not correct length&quot;);
1104         }
1105         for (int i = 0; i &lt; chain.length; i++) {
1106             if (!chain[i].equals(chain2[i])) {
1107                 throw new SecurityException(&quot;received chain not equal&quot;);
1108             }
1109         }
1110 
1111         // getKey good pke 3
1112         pkey = (PrivateKey)ks.getKey(&quot;pk3&quot;, null);
1113         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
1114             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1115         } else {
1116             throw new SecurityException
1117                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
1118         }
1119 
1120         // getCertificate chain chain 3
1121         chain = ks.getCertificateChain(&quot;pk3&quot;);
1122         if (chain.length != chain3.length) {
1123             throw new SecurityException(&quot;received chain not correct length&quot;);
1124         }
1125         for (int i = 0; i &lt; chain.length; i++) {
1126             if (!chain[i].equals(chain3[i])) {
1127                 throw new SecurityException(&quot;received chain not equal&quot;);
1128             }
1129         }
1130 
1131         // aliases
1132         enu = ks.aliases();
1133         count = 0;
1134         while (enu.hasMoreElements()) {
1135             count++;
1136             System.out.println(&quot;alias &quot; +
1137                                 count +
1138                                 &quot; = &quot; +
1139                                 (String)enu.nextElement());
1140         }
1141         if (count == 7) {
1142             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1143         } else {
1144             throw new SecurityException(&quot;expected 7 aliases&quot;);
1145         }
1146 
1147         // size
1148         if (ks.size() == 7) {
1149             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1150         } else {
1151             throw new SecurityException(&quot;expected size 7&quot;);
1152         }
1153 
1154         // getCertificate good chain 1
1155         if (ks.getCertificate(&quot;pk1&quot;).equals(chain1[0])) {
1156             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1157         } else {
1158             throw new SecurityException(&quot;retrieved cert not equal&quot;);
1159         }
1160 
1161         // getCertificate good chain 3
1162         if (ks.getCertificate(&quot;pk3&quot;).equals(chain3[0])) {
1163             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1164         } else {
1165             throw new SecurityException(&quot;retrieved cert not equal&quot;);
1166         }
1167 
1168         // getKey good ske 1
1169         skey = (SecretKey)ks.getKey(&quot;sk1&quot;, null);
1170         if (&quot;DES&quot;.equals(skey.getAlgorithm())) {
1171             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1172         } else {
1173             throw new SecurityException
1174                 (&quot;expected DES, got &quot; + skey.getAlgorithm());
1175         }
1176 
1177         // getKey good ske 4
1178         skey = (SecretKey)ks.getKey(&quot;sk4&quot;, null);
1179         if (&quot;ARCFOUR&quot;.equals(skey.getAlgorithm())) {
1180             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1181         } else {
1182             throw new SecurityException
1183                 (&quot;expected ARCFOUR, got &quot; + skey.getAlgorithm());
1184         }
1185 
1186         // getKey good pke 1
1187         pkey = (PrivateKey)ks.getKey(&quot;pk1&quot;, null);
1188         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
1189             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1190         } else {
1191             throw new SecurityException
1192                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
1193         }
1194 
1195         // getKey good pke 3
1196         pkey = (PrivateKey)ks.getKey(&quot;pk3&quot;, null);
1197         if (&quot;RSA&quot;.equals(pkey.getAlgorithm())) {
1198             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1199         } else {
1200             throw new SecurityException
1201                 (&quot;expected RSA, got &quot; + pkey.getAlgorithm());
1202         }
1203 
1204         // contains alias
1205         if (!ks.containsAlias(&quot;pk1&quot;) ||
1206                 !ks.containsAlias(&quot;pk2&quot;) ||
1207                 !ks.containsAlias(&quot;pk3&quot;) ||
1208                 !ks.containsAlias(&quot;sk1&quot;) ||
1209                 !ks.containsAlias(&quot;sk2&quot;) ||
1210                 !ks.containsAlias(&quot;sk3&quot;) ||
1211                 !ks.containsAlias(&quot;sk4&quot;)) {
1212             throw new SecurityException(&quot;did not contain all aliases&quot;);
1213         }
1214         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1215 
1216         // getCertificateAlias pk1
1217         if (ks.getCertificateAlias(chain1[0]).equals(&quot;pk1&quot;)) {
1218             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1219         } else {
1220             throw new SecurityException(&quot;expected cert pk1&quot;);
1221         }
1222 
1223         // getCertificateAlias pk3
1224         if (ks.getCertificateAlias(chain3[0]).equals(&quot;pk3&quot;)) {
1225             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1226         } else {
1227             throw new SecurityException(&quot;expected cert pk3&quot;);
1228         }
1229 
1230         // isCertificateEntry pk1
1231         if (!ks.isCertificateEntry(&quot;pk1&quot;)) {
1232             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1233         } else {
1234             throw new SecurityException(&quot;expected pke&quot;);
1235         }
1236 
1237         // isCertificateEntry pk3
1238         if (!ks.isCertificateEntry(&quot;pk3&quot;)) {
1239             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1240         } else {
1241             throw new SecurityException(&quot;expected pke&quot;);
1242         }
1243 
1244         // isCertificateEntry sk1
1245         if (!ks.isCertificateEntry(&quot;sk1&quot;)) {
1246             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1247         } else {
1248             throw new SecurityException(&quot;expected ske&quot;);
1249         }
1250 
1251         // isCertificateEntry sk4
1252         if (!ks.isCertificateEntry(&quot;sk4&quot;)) {
1253             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1254         } else {
1255             throw new SecurityException(&quot;expected ske&quot;);
1256         }
1257 
1258         // isKeyEntry pk1
1259         if (ks.isKeyEntry(&quot;pk1&quot;)) {
1260             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1261         } else {
1262             throw new SecurityException(&quot;expected pke&quot;);
1263         }
1264 
1265         // isKeyEntry pk3
1266         if (ks.isKeyEntry(&quot;pk3&quot;)) {
1267             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1268         } else {
1269             throw new SecurityException(&quot;expected pke&quot;);
1270         }
1271 
1272         // isKeyEntry sk1
1273         if (ks.isKeyEntry(&quot;sk1&quot;)) {
1274             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1275         } else {
1276             throw new SecurityException(&quot;expected ske&quot;);
1277         }
1278 
1279         // isKeyEntry sk4
1280         if (ks.isKeyEntry(&quot;sk4&quot;)) {
1281             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1282         } else {
1283             throw new SecurityException(&quot;expected ske&quot;);
1284         }
1285 
1286         // isCertificateEntry random foo
1287         if (!ks.isCertificateEntry(&quot;foo&quot;)) {
1288             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1289         } else {
1290             throw new SecurityException(&quot;expected foo&quot;);
1291         }
1292 
1293         // isKeyEntry random foo
1294         if (!ks.isKeyEntry(&quot;foo&quot;)) {
1295             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1296         } else {
1297             throw new SecurityException(&quot;expected foo&quot;);
1298         }
1299 
1300         // entryInstanceOf pk1
1301         if (!ks.entryInstanceOf
1302                 (&quot;pk1&quot;, KeyStore.TrustedCertificateEntry.class)) {
1303             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1304         } else {
1305             throw new SecurityException(&quot;expected tce&quot;);
1306         }
1307 
1308         // entryInstanceOf pk3
1309         if (!ks.entryInstanceOf
1310                 (&quot;pk3&quot;, KeyStore.TrustedCertificateEntry.class)) {
1311             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1312         } else {
1313             throw new SecurityException(&quot;expected tce&quot;);
1314         }
1315 
1316         // entryInstanceOf sk1
1317         if (!ks.entryInstanceOf
1318                 (&quot;sk1&quot;, KeyStore.TrustedCertificateEntry.class)) {
1319             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1320         } else {
1321             throw new SecurityException(&quot;expected tce&quot;);
1322         }
1323 
1324         // entryInstanceOf sk4
1325         if (!ks.entryInstanceOf
1326                 (&quot;sk4&quot;, KeyStore.TrustedCertificateEntry.class)) {
1327             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1328         } else {
1329             throw new SecurityException(&quot;expected tce&quot;);
1330         }
1331 
1332         // entryInstanceOf pk1
1333         if (ks.entryInstanceOf(&quot;pk1&quot;, KeyStore.PrivateKeyEntry.class)) {
1334             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1335         } else {
1336             throw new SecurityException(&quot;expected pke&quot;);
1337         }
1338 
1339         // entryInstanceOf pk3
1340         if (ks.entryInstanceOf(&quot;pk3&quot;, KeyStore.PrivateKeyEntry.class)) {
1341             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1342         } else {
1343             throw new SecurityException(&quot;expected pke&quot;);
1344         }
1345 
1346         // entryInstanceOf sk1
1347         if (!ks.entryInstanceOf(&quot;sk1&quot;, KeyStore.PrivateKeyEntry.class)) {
1348             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1349         } else {
1350             throw new SecurityException(&quot;expected pke&quot;);
1351         }
1352 
1353         // entryInstanceOf sk4
1354         if (!ks.entryInstanceOf(&quot;sk4&quot;, KeyStore.PrivateKeyEntry.class)) {
1355             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1356         } else {
1357             throw new SecurityException(&quot;expected pke&quot;);
1358         }
1359 
1360         // entryInstanceOf sk1
1361         if (ks.entryInstanceOf(&quot;sk1&quot;, KeyStore.SecretKeyEntry.class)) {
1362             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1363         } else {
1364             throw new SecurityException(&quot;expected ske&quot;);
1365         }
1366 
1367         // entryInstanceOf sk4
1368         if (ks.entryInstanceOf(&quot;sk4&quot;, KeyStore.SecretKeyEntry.class)) {
1369             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1370         } else {
1371             throw new SecurityException(&quot;expected ske&quot;);
1372         }
1373 
1374         // entryInstanceOf pk1
1375         if (!ks.entryInstanceOf(&quot;pk1&quot;, KeyStore.SecretKeyEntry.class)) {
1376             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1377         } else {
1378             throw new SecurityException(&quot;expected ske&quot;);
1379         }
1380 
1381         // entryInstanceOf pk3
1382         if (!ks.entryInstanceOf(&quot;pk3&quot;, KeyStore.SecretKeyEntry.class)) {
1383             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1384         } else {
1385             throw new SecurityException(&quot;expected ske&quot;);
1386         }
1387 
1388         // getEntry random foobar
1389         if (ks.getEntry(&quot;foobar&quot;, null) != null) {
1390             throw new SecurityException(&quot;expected null entry&quot;);
1391         } else {
1392             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1393         }
1394 
1395         // deleteEntry
1396         ks.deleteEntry(&quot;pk1&quot;);
1397         ks.deleteEntry(&quot;pk3&quot;);
1398         ks.deleteEntry(&quot;sk2&quot;);
1399         ks.deleteEntry(&quot;sk3&quot;);
1400         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1401 
1402         // aliases
1403         enu = ks.aliases();
1404         count = 0;
1405         while (enu.hasMoreElements()) {
1406             count++;
1407             System.out.println(&quot;alias &quot; +
1408                                 count +
1409                                 &quot; = &quot; +
1410                                 (String)enu.nextElement());
1411         }
1412         if (count == 3) {
1413             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1414         } else {
1415             throw new SecurityException(&quot;expected 3 aliases&quot;);
1416         }
1417 
1418         // size
1419         if (ks.size() == 3) {
1420             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1421         } else {
1422             throw new SecurityException(&quot;expected size 6&quot;);
1423         }
1424 
1425         // entryInstanceOf sk1
1426         if (!ks.entryInstanceOf(&quot;sk1&quot;, KeyStore.PrivateKeyEntry.class)) {
1427             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1428         } else {
1429             throw new SecurityException(&quot;expected pke&quot;);
1430         }
1431 
1432         // entryInstanceOf sk4
1433         if (!ks.entryInstanceOf(&quot;sk4&quot;, KeyStore.PrivateKeyEntry.class)) {
1434             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1435         } else {
1436             throw new SecurityException(&quot;expected pke&quot;);
1437         }
1438 
1439         // entryInstanceOf pk2
1440         if (ks.entryInstanceOf(&quot;pk2&quot;, KeyStore.PrivateKeyEntry.class)) {
1441             System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1442         } else {
1443             throw new SecurityException(&quot;expected pke&quot;);
1444         }
1445         System.out.println(&quot;test &quot; + testnum++ + &quot; passed&quot;);
1446 
1447         return testnum;
1448     }
1449 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>