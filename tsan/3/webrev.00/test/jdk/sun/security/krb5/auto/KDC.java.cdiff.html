<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/security/krb5/auto/KDC.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../rmi/log/ReliableLog/Recovery.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../lib/cacerts/VerifyCACerts.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/krb5/auto/KDC.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 163,10 ***</span>
<span class="line-new-header">--- 163,18 ---</span>
      // different s2kparams for different etypes, pretend they are the same
      // at the moment.
      private TreeMap&lt;String,byte[]&gt; s2kparamses = new TreeMap&lt;&gt;
              (String.CASE_INSENSITIVE_ORDER);
  
<span class="line-added">+     // Alias for referrals.</span>
<span class="line-added">+     private TreeMap&lt;String,KDC&gt; aliasReferrals = new TreeMap&lt;&gt;</span>
<span class="line-added">+             (String.CASE_INSENSITIVE_ORDER);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Alias for local resolution.</span>
<span class="line-added">+     private TreeMap&lt;String,PrincipalName&gt; alias2Principals = new TreeMap&lt;&gt;</span>
<span class="line-added">+             (String.CASE_INSENSITIVE_ORDER);</span>
<span class="line-added">+ </span>
      // Realm name
      private String realm;
      // KDC
      private String kdc;
      // Service port number
</pre>
<hr />
<pre>
<span class="line-old-header">*** 551,10 ***</span>
<span class="line-new-header">--- 559,33 ---</span>
       */
      public int getPort() {
          return port;
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Register an alias name to be referred to a different KDC for</span>
<span class="line-added">+      * resolution, according to RFC 6806.</span>
<span class="line-added">+      * @param alias Alias name (i.e. user@REALM.COM).</span>
<span class="line-added">+      * @param referredKDC KDC to which the alias is referred for resolution.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void registerAlias(String alias, KDC referredKDC) {</span>
<span class="line-added">+         aliasReferrals.remove(alias);</span>
<span class="line-added">+         aliasReferrals.put(alias, referredKDC);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Register an alias to be resolved to a Principal Name locally,</span>
<span class="line-added">+      * according to RFC 6806.</span>
<span class="line-added">+      * @param alias Alias name (i.e. user@REALM.COM).</span>
<span class="line-added">+      * @param user Principal Name to which the alias is resolved.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void registerAlias(String alias, String user)</span>
<span class="line-added">+             throws RealmException {</span>
<span class="line-added">+         alias2Principals.remove(alias);</span>
<span class="line-added">+         alias2Principals.put(alias, new PrincipalName(user));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      // Private helper methods
  
      /**
       * Private constructor, cannot be called outside.
       * @param realm
</pre>
<hr />
<pre>
<span class="line-old-header">*** 687,11 ***</span>
       * @param etype the encryption type
       * @param server looking for a server principal?
       * @return the key
       * @throws sun.security.krb5.KrbException for unknown/unsupported etype
       */
<span class="line-modified">!     private EncryptionKey keyForUser(PrincipalName p, int etype, boolean server)</span>
              throws KrbException {
          try {
              // Do not call EncryptionKey.acquireSecretKeys(), otherwise
              // the krb5.conf config file would be loaded.
              Integer kvno = null;
<span class="line-new-header">--- 718,11 ---</span>
       * @param etype the encryption type
       * @param server looking for a server principal?
       * @return the key
       * @throws sun.security.krb5.KrbException for unknown/unsupported etype
       */
<span class="line-modified">!     EncryptionKey keyForUser(PrincipalName p, int etype, boolean server)</span>
              throws KrbException {
          try {
              // Do not call EncryptionKey.acquireSecretKeys(), otherwise
              // the krb5.conf config file would be loaded.
              Integer kvno = null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 768,26 ***</span>
                  throw new KrbException(Krb5.KDC_ERR_ETYPE_NOSUPP);
              }
              int e2 = eTypes[0];     // etype for outgoing session key
              int e3 = eTypes[0];     // etype for outgoing ticket
  
<span class="line-modified">!             PAData[] pas = KDCReqDotPAData(tgsReq);</span>
  
              Ticket tkt = null;
              EncTicketPart etp = null;
  
              PrincipalName cname = null;
              boolean allowForwardable = true;
  
              if (pas == null || pas.length == 0) {
                  throw new KrbException(Krb5.KDC_ERR_PADATA_TYPE_NOSUPP);
              } else {
                  PrincipalName forUserCName = null;
                  for (PAData pa: pas) {
                      if (pa.getType() == Krb5.PA_TGS_REQ) {
                          APReq apReq = new APReq(pa.getValue());
<span class="line-removed">-                         EncryptedData ed = apReq.authenticator;</span>
                          tkt = apReq.ticket;
                          int te = tkt.encPart.getEType();
                          EncryptionKey kkey = keyForUser(tkt.sname, te, true);
                          byte[] bb = tkt.encPart.decrypt(kkey, KeyUsage.KU_TICKET);
                          DerInputStream derIn = new DerInputStream(bb);
<span class="line-new-header">--- 799,41 ---</span>
                  throw new KrbException(Krb5.KDC_ERR_ETYPE_NOSUPP);
              }
              int e2 = eTypes[0];     // etype for outgoing session key
              int e3 = eTypes[0];     // etype for outgoing ticket
  
<span class="line-modified">!             PAData[] pas = tgsReq.pAData;</span>
  
              Ticket tkt = null;
              EncTicketPart etp = null;
  
              PrincipalName cname = null;
              boolean allowForwardable = true;
<span class="line-added">+             boolean isReferral = false;</span>
<span class="line-added">+             if (body.kdcOptions.get(KDCOptions.CANONICALIZE)) {</span>
<span class="line-added">+                 System.out.println(realm + &quot;&gt; verifying referral for &quot; +</span>
<span class="line-added">+                         body.sname.getNameString());</span>
<span class="line-added">+                 KDC referral = aliasReferrals.get(body.sname.getNameString());</span>
<span class="line-added">+                 if (referral != null) {</span>
<span class="line-added">+                     service = new PrincipalName(</span>
<span class="line-added">+                             PrincipalName.TGS_DEFAULT_SRV_NAME +</span>
<span class="line-added">+                             PrincipalName.NAME_COMPONENT_SEPARATOR_STR +</span>
<span class="line-added">+                             referral.getRealm(), PrincipalName.KRB_NT_SRV_INST,</span>
<span class="line-added">+                             this.getRealm());</span>
<span class="line-added">+                     System.out.println(realm + &quot;&gt; referral to &quot; +</span>
<span class="line-added">+                             referral.getRealm());</span>
<span class="line-added">+                     isReferral = true;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
  
              if (pas == null || pas.length == 0) {
                  throw new KrbException(Krb5.KDC_ERR_PADATA_TYPE_NOSUPP);
              } else {
                  PrincipalName forUserCName = null;
                  for (PAData pa: pas) {
                      if (pa.getType() == Krb5.PA_TGS_REQ) {
                          APReq apReq = new APReq(pa.getValue());
                          tkt = apReq.ticket;
                          int te = tkt.encPart.getEType();
                          EncryptionKey kkey = keyForUser(tkt.sname, te, true);
                          byte[] bb = tkt.encPart.decrypt(kkey, KeyUsage.KU_TICKET);
                          DerInputStream derIn = new DerInputStream(bb);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 962,11 ***</span>
                      tFlags,
                      timeAfter(0),
                      from,
                      till, renewTill,
                      service,
<span class="line-modified">!                     body.addresses</span>
                      );
              EncryptedData edata = new EncryptedData(ckey, enc_part.asn1Encode(),
                      KeyUsage.KU_ENC_TGS_REP_PART_SESSKEY);
              TGSRep tgsRep = new TGSRep(null,
                      cname,
<span class="line-new-header">--- 1008,12 ---</span>
                      tFlags,
                      timeAfter(0),
                      from,
                      till, renewTill,
                      service,
<span class="line-modified">!                     body.addresses,</span>
<span class="line-added">+                     null</span>
                      );
              EncryptedData edata = new EncryptedData(ckey, enc_part.asn1Encode(),
                      KeyUsage.KU_ENC_TGS_REP_PART_SESSKEY);
              TGSRep tgsRep = new TGSRep(null,
                      cname,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1006,10 ***</span>
<span class="line-new-header">--- 1053,11 ---</span>
       * @return the response
       * @throws java.lang.Exception for various errors
       */
      protected byte[] processAsReq(byte[] in) throws Exception {
          ASReq asReq = new ASReq(in);
<span class="line-added">+         byte[] asReqbytes = asReq.asn1Encode();</span>
          int[] eTypes = null;
          List&lt;PAData&gt; outPAs = new ArrayList&lt;&gt;();
  
          PrincipalName service = asReq.reqBody.sname;
          if (options.containsKey(KDC.Option.RESP_NT)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1028,10 ***</span>
<span class="line-new-header">--- 1076,27 ---</span>
              if (eTypes.length == 0) {
                  throw new KrbException(Krb5.KDC_ERR_ETYPE_NOSUPP);
              }
              int eType = eTypes[0];
  
<span class="line-added">+             if (body.kdcOptions.get(KDCOptions.CANONICALIZE)) {</span>
<span class="line-added">+                 PrincipalName principal = alias2Principals.get(</span>
<span class="line-added">+                         body.cname.getNameString());</span>
<span class="line-added">+                 if (principal != null) {</span>
<span class="line-added">+                     body.cname = principal;</span>
<span class="line-added">+                 } else {</span>
<span class="line-added">+                     KDC referral = aliasReferrals.get(body.cname.getNameString());</span>
<span class="line-added">+                     if (referral != null) {</span>
<span class="line-added">+                         body.cname = new PrincipalName(</span>
<span class="line-added">+                                 PrincipalName.TGS_DEFAULT_SRV_NAME,</span>
<span class="line-added">+                                 PrincipalName.KRB_NT_SRV_INST,</span>
<span class="line-added">+                                 referral.getRealm());</span>
<span class="line-added">+                         throw new KrbException(Krb5.KRB_ERR_WRONG_REALM);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
              EncryptionKey ckey = keyForUser(body.cname, eType, false);
              EncryptionKey skey = keyForUser(service, eType, true);
  
              if (options.containsKey(KDC.Option.ONLY_RC4_TGT)) {
                  int tgtEType = EncryptedData.ETYPE_ARCFOUR_HMAC;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1208,29 ***</span>
                  eid = new DerOutputStream();
                  eid.putSequence(pas);
                  outPAs.add(new PAData(Krb5.PA_ETYPE_INFO, eid.toByteArray()));
              }
  
<span class="line-modified">!             PAData[] inPAs = KDCReqDotPAData(asReq);</span>
<span class="line-modified">!             if (inPAs == null || inPAs.length == 0) {</span>
                  Object preauth = options.get(Option.PREAUTH_REQUIRED);
                  if (preauth == null || preauth.equals(Boolean.TRUE)) {
                      throw new KrbException(Krb5.KDC_ERR_PREAUTH_REQUIRED);
                  }
              } else {
                  try {
                      EncryptedData data = newEncryptedData(
<span class="line-modified">!                             new DerValue(inPAs[0].getValue()));</span>
<span class="line-modified">!                     EncryptionKey pakey</span>
<span class="line-removed">-                             = keyForUser(body.cname, data.getEType(), false);</span>
                      data.decrypt(pakey, KeyUsage.KU_PA_ENC_TS);
                  } catch (Exception e) {
                      KrbException ke = new KrbException(Krb5.KDC_ERR_PREAUTH_FAILED);
                      ke.initCause(e);
                      throw ke;
                  }
                  bFlags[Krb5.TKT_OPTS_PRE_AUTHENT] = true;
              }
  
              TicketFlags tFlags = new TicketFlags(bFlags);
              EncTicketPart enc = new EncTicketPart(
                      tFlags,
<span class="line-new-header">--- 1273,51 ---</span>
                  eid = new DerOutputStream();
                  eid.putSequence(pas);
                  outPAs.add(new PAData(Krb5.PA_ETYPE_INFO, eid.toByteArray()));
              }
  
<span class="line-modified">!             PAData[] inPAs = asReq.pAData;</span>
<span class="line-modified">!             List&lt;PAData&gt; enc_outPAs = new ArrayList&lt;&gt;();</span>
<span class="line-added">+ </span>
<span class="line-added">+             byte[] paEncTimestamp = null;</span>
<span class="line-added">+             if (inPAs != null) {</span>
<span class="line-added">+                 for (PAData inPA : inPAs) {</span>
<span class="line-added">+                     if (inPA.getType() == Krb5.PA_ENC_TIMESTAMP) {</span>
<span class="line-added">+                         paEncTimestamp = inPA.getValue();</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             if (paEncTimestamp == null) {</span>
                  Object preauth = options.get(Option.PREAUTH_REQUIRED);
                  if (preauth == null || preauth.equals(Boolean.TRUE)) {
                      throw new KrbException(Krb5.KDC_ERR_PREAUTH_REQUIRED);
                  }
              } else {
<span class="line-added">+                 EncryptionKey pakey = null;</span>
                  try {
                      EncryptedData data = newEncryptedData(
<span class="line-modified">!                             new DerValue(paEncTimestamp));</span>
<span class="line-modified">!                     pakey = keyForUser(body.cname, data.getEType(), false);</span>
                      data.decrypt(pakey, KeyUsage.KU_PA_ENC_TS);
                  } catch (Exception e) {
                      KrbException ke = new KrbException(Krb5.KDC_ERR_PREAUTH_FAILED);
                      ke.initCause(e);
                      throw ke;
                  }
                  bFlags[Krb5.TKT_OPTS_PRE_AUTHENT] = true;
<span class="line-added">+                 for (PAData pa : inPAs) {</span>
<span class="line-added">+                     if (pa.getType() == Krb5.PA_REQ_ENC_PA_REP) {</span>
<span class="line-added">+                         Checksum ckSum = new Checksum(</span>
<span class="line-added">+                                 Checksum.CKSUMTYPE_HMAC_SHA1_96_AES128,</span>
<span class="line-added">+                                 asReqbytes, ckey, KeyUsage.KU_AS_REQ);</span>
<span class="line-added">+                         enc_outPAs.add(new PAData(Krb5.PA_REQ_ENC_PA_REP,</span>
<span class="line-added">+                                 ckSum.asn1Encode()));</span>
<span class="line-added">+                         bFlags[Krb5.TKT_OPTS_ENC_PA_REP] = true;</span>
<span class="line-added">+                         break;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
              }
  
              TicketFlags tFlags = new TicketFlags(bFlags);
              EncTicketPart enc = new EncTicketPart(
                      tFlags,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1257,11 ***</span>
                      tFlags,
                      timeAfter(0),
                      from,
                      till, rtime,
                      service,
<span class="line-modified">!                     body.addresses</span>
                      );
              EncryptedData edata = new EncryptedData(ckey, enc_part.asn1Encode(),
                      KeyUsage.KU_ENC_AS_REP_PART);
              ASRep asRep = new ASRep(
                      outPAs.toArray(new PAData[outPAs.size()]),
<span class="line-new-header">--- 1344,12 ---</span>
                      tFlags,
                      timeAfter(0),
                      from,
                      till, rtime,
                      service,
<span class="line-modified">!                     body.addresses,</span>
<span class="line-added">+                     enc_outPAs.toArray(new PAData[enc_outPAs.size()])</span>
                      );
              EncryptedData edata = new EncryptedData(ckey, enc_part.asn1Encode(),
                      KeyUsage.KU_ENC_AS_REP_PART);
              ASRep asRep = new ASRep(
                      outPAs.toArray(new PAData[outPAs.size()]),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1305,12 ***</span>
                      + &quot; &quot; +ke.returnCodeMessage());
              byte[] eData = null;
              if (kerr == null) {
                  if (ke.returnCode() == Krb5.KDC_ERR_PREAUTH_REQUIRED ||
                          ke.returnCode() == Krb5.KDC_ERR_PREAUTH_FAILED) {
                      DerOutputStream bytes = new DerOutputStream();
<span class="line-removed">-                     bytes.write(new PAData(Krb5.PA_ENC_TIMESTAMP, new byte[0]).asn1Encode());</span>
                      for (PAData p: outPAs) {
                          bytes.write(p.asn1Encode());
                      }
                      DerOutputStream temp = new DerOutputStream();
                      temp.write(DerValue.tag_Sequence, bytes);
<span class="line-new-header">--- 1393,14 ---</span>
                      + &quot; &quot; +ke.returnCodeMessage());
              byte[] eData = null;
              if (kerr == null) {
                  if (ke.returnCode() == Krb5.KDC_ERR_PREAUTH_REQUIRED ||
                          ke.returnCode() == Krb5.KDC_ERR_PREAUTH_FAILED) {
<span class="line-added">+                     outPAs.add(new PAData(Krb5.PA_ENC_TIMESTAMP, new byte[0]));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 if (outPAs.size() &gt; 0) {</span>
                      DerOutputStream bytes = new DerOutputStream();
                      for (PAData p: outPAs) {
                          bytes.write(p.asn1Encode());
                      }
                      DerOutputStream temp = new DerOutputStream();
                      temp.write(DerValue.tag_Sequence, bytes);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1895,22 ***</span>
                      &quot;-f&quot;, &quot;-t&quot;, tmpName, &quot;-c&quot;, ccache, user);
          }
      }
  
      // Calling private methods thru reflections
<span class="line-removed">-     private static final Field getPADataField;</span>
      private static final Field getEType;
      private static final Constructor&lt;EncryptedData&gt; ctorEncryptedData;
      private static final Method stringToKey;
      private static final Field getAddlTkt;
  
      static {
          try {
              ctorEncryptedData = EncryptedData.class.getDeclaredConstructor(DerValue.class);
              ctorEncryptedData.setAccessible(true);
<span class="line-removed">-             getPADataField = KDCReq.class.getDeclaredField(&quot;pAData&quot;);</span>
<span class="line-removed">-             getPADataField.setAccessible(true);</span>
              getEType = KDCReqBody.class.getDeclaredField(&quot;eType&quot;);
              getEType.setAccessible(true);
              stringToKey = EncryptionKey.class.getDeclaredMethod(
                      &quot;stringToKey&quot;,
                      char[].class, String.class, byte[].class, Integer.TYPE);
<span class="line-new-header">--- 1985,19 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1928,17 ***</span>
              return ctorEncryptedData.newInstance(der);
          } catch (Exception e) {
              throw new AssertionError(e);
          }
      }
<span class="line-removed">-     private static PAData[] KDCReqDotPAData(KDCReq req) {</span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             return (PAData[])getPADataField.get(req);</span>
<span class="line-removed">-         } catch (Exception e) {</span>
<span class="line-removed">-             throw new AssertionError(e);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
      private static int[] KDCReqBodyDotEType(KDCReqBody body) {
          try {
              return (int[]) getEType.get(body);
          } catch (Exception e) {
              throw new AssertionError(e);
<span class="line-new-header">--- 2015,10 ---</span>
</pre>
<center><a href="../../../rmi/log/ReliableLog/Recovery.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../lib/cacerts/VerifyCACerts.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>