<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/security/krb5/auto/SaslGSS.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8012082 8019267 8194486
 27  * @summary SASL: auth-conf negotiated, but unencrypted data is accepted,
 28   *         reset to unencrypt
 29  * @library /test/lib
 30  * @compile -XDignore.symbol.file SaslGSS.java
 31  * @run main jdk.test.lib.FileInstaller TestHosts TestHosts
 32  * @run main/othervm -Djdk.net.hosts.file=TestHosts SaslGSS
 33  */
 34 
 35 import javax.security.auth.callback.Callback;
 36 import javax.security.auth.callback.CallbackHandler;
 37 import javax.security.auth.callback.UnsupportedCallbackException;
 38 import javax.security.sasl.AuthorizeCallback;
 39 import javax.security.sasl.RealmCallback;
 40 import javax.security.sasl.Sasl;
 41 import javax.security.sasl.SaslServer;
 42 import java.io.ByteArrayOutputStream;
 43 import java.io.IOException;
 44 import java.io.PrintStream;
 45 import java.util.HashMap;
 46 import java.util.logging.ConsoleHandler;
 47 import java.util.logging.Handler;
 48 import java.util.logging.Level;
 49 import java.util.logging.Logger;
 50 
 51 import org.ietf.jgss.*;
 52 import sun.security.jgss.GSSUtil;
 53 
 54 public class SaslGSS {
 55 
 56     public static void main(String[] args) throws Exception {
 57 
 58         String name = &quot;host.&quot; + OneKDC.REALM_LOWER_CASE;
 59 
 60         new OneKDC(null).writeJAASConf();
 61         System.setProperty(&quot;javax.security.auth.useSubjectCredsOnly&quot;, &quot;false&quot;);
 62 
 63         // Client in JGSS so that it can control wrap privacy mode
 64         GSSManager m = GSSManager.getInstance();
 65         GSSContext sc = m.createContext(
 66                         m.createName(OneKDC.SERVER, GSSUtil.NT_GSS_KRB5_PRINCIPAL),
 67                         GSSUtil.GSS_KRB5_MECH_OID,
 68                         null,
 69                         GSSContext.DEFAULT_LIFETIME);
 70         sc.requestMutualAuth(false);
 71 
 72         // Server in SASL
 73         final HashMap props = new HashMap();
 74         props.put(Sasl.QOP, &quot;auth-conf&quot;);
 75         SaslServer ss = Sasl.createSaslServer(&quot;GSSAPI&quot;, &quot;server&quot;,
 76                 name, props,
 77                 new CallbackHandler() {
 78                     public void handle(Callback[] callbacks)
 79                             throws IOException, UnsupportedCallbackException {
 80                         for (Callback cb : callbacks) {
 81                             if (cb instanceof RealmCallback) {
 82                                 ((RealmCallback) cb).setText(OneKDC.REALM);
 83                             } else if (cb instanceof AuthorizeCallback) {
 84                                 ((AuthorizeCallback) cb).setAuthorized(true);
 85                             }
 86                         }
 87                     }
 88                 });
 89 
 90         ByteArrayOutputStream bout = new ByteArrayOutputStream();
 91         PrintStream oldErr = System.err;
 92         System.setErr(new PrintStream(bout));
 93 
 94         Logger.getLogger(&quot;javax.security.sasl&quot;).setLevel(Level.ALL);
 95         Handler h = new ConsoleHandler();
 96         h.setLevel(Level.ALL);
 97         Logger.getLogger(&quot;javax.security.sasl&quot;).addHandler(h);
 98 
 99         byte[] token = new byte[0];
100 
101         try {
102             // Handshake
103             token = sc.initSecContext(token, 0, token.length);
104             token = ss.evaluateResponse(token);
105             token = sc.unwrap(token, 0, token.length, new MessageProp(0, false));
106             token[0] = (byte)(((token[0] &amp; 4) != 0) ? 4 : 2);
107             token = sc.wrap(token, 0, token.length, new MessageProp(0, false));
108             ss.evaluateResponse(token);
109         } finally {
110             System.setErr(oldErr);
111         }
112 
113         // Talk
114         // 1. Client sends a auth-int message
115         byte[] hello = &quot;hello&quot;.getBytes();
116         MessageProp qop = new MessageProp(0, false);
117         token = sc.wrap(hello, 0, hello.length, qop);
118         // 2. Server accepts it anyway
119         ss.unwrap(token, 0, token.length);
120         // 3. Server sends a message
121         token = ss.wrap(hello, 0, hello.length);
122         // 4. Client accepts, should be auth-conf
123         sc.unwrap(token, 0, token.length, qop);
124         if (!qop.getPrivacy()) {
125             throw new Exception();
126         }
127 
128         for (String s: bout.toString().split(&quot;\\n&quot;)) {
129             if (s.contains(&quot;KRB5SRV04&quot;) &amp;&amp; s.contains(&quot;NULL&quot;)) {
130                 return;
131             }
132         }
133         System.out.println(&quot;=======================&quot;);
134         System.out.println(bout.toString());
135         System.out.println(&quot;=======================&quot;);
136         throw new Exception(&quot;Haven&#39;t seen KRB5SRV04 with NULL&quot;);
137     }
138 }
    </pre>
  </body>
</html>