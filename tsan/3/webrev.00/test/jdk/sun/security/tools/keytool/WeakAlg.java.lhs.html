<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/keytool/WeakAlg.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8171319 8177569 8182879
 27  * @summary keytool should print out warnings when reading or generating
 28   *         cert/cert req using weak algorithms
 29  * @library /test/lib
 30  * @modules java.base/sun.security.tools.keytool
 31  *          java.base/sun.security.tools
 32  *          java.base/sun.security.util
 33  * @build jdk.test.lib.SecurityTools
 34  *        jdk.test.lib.Utils
 35  *        jdk.test.lib.Asserts
 36  *        jdk.test.lib.JDKToolFinder
 37  *        jdk.test.lib.JDKToolLauncher
 38  *        jdk.test.lib.Platform
 39  *        jdk.test.lib.process.*
 40  * @run main/othervm/timeout=600 -Duser.language=en -Duser.country=US WeakAlg
 41  */
 42 
 43 import jdk.test.lib.Asserts;
 44 import jdk.test.lib.SecurityTools;
 45 import jdk.test.lib.process.OutputAnalyzer;
 46 import sun.security.tools.KeyStoreUtil;
 47 import sun.security.util.DisabledAlgorithmConstraints;
 48 
 49 import java.io.ByteArrayInputStream;
 50 import java.io.ByteArrayOutputStream;
 51 import java.io.File;
 52 import java.io.IOException;
 53 import java.io.InputStream;
 54 import java.io.PrintStream;
 55 import java.nio.file.Files;
 56 import java.nio.file.Paths;
 57 import java.nio.file.StandardCopyOption;
 58 import java.security.CryptoPrimitive;
 59 import java.security.KeyStore;
 60 import java.security.cert.X509Certificate;
 61 import java.util.Collections;
 62 import java.util.EnumSet;
 63 import java.util.Set;
 64 import java.util.stream.Collectors;
 65 import java.util.stream.Stream;
 66 
 67 public class WeakAlg {
 68 
 69     public static void main(String[] args) throws Throwable {
 70 
 71         rm(&quot;ks&quot;);
 72 
 73         // -genkeypair, and -printcert, -list -alias, -exportcert
 74         // (w/ different formats)
 75         checkGenKeyPair(&quot;a&quot;, &quot;-keyalg RSA -sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
 76         checkGenKeyPair(&quot;b&quot;, &quot;-keyalg RSA -keysize 512&quot;, &quot;512-bit RSA key&quot;);
 77         checkGenKeyPair(&quot;c&quot;, &quot;-keyalg RSA&quot;, null);
 78 
 79         kt(&quot;-list&quot;)
 80                 .shouldContain(&quot;Warning:&quot;)
 81                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*risk&quot;)
 82                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*risk&quot;);
 83         kt(&quot;-list -v&quot;)
 84                 .shouldContain(&quot;Warning:&quot;)
 85                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*risk&quot;)
 86                 .shouldContain(&quot;MD5withRSA (weak)&quot;)
 87                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*risk&quot;)
 88                 .shouldContain(&quot;512-bit RSA key (weak)&quot;);
 89 
 90         // Multiple warnings for multiple cert in -printcert
 91         // or -list or -exportcert
 92 
 93         // -certreq, -printcertreq, -gencert
 94         checkCertReq(&quot;a&quot;, &quot;&quot;, null);
 95         gencert(&quot;c-a&quot;, &quot;&quot;)
 96                 .shouldNotContain(&quot;Warning&quot;); // new sigalg is not weak
 97         gencert(&quot;c-a&quot;, &quot;-sigalg MD2withRSA&quot;)
 98                 .shouldContain(&quot;Warning:&quot;)
 99                 .shouldMatch(&quot;The generated certificate.*MD2withRSA.*risk&quot;);
100 
101         checkCertReq(&quot;a&quot;, &quot;-sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
102         gencert(&quot;c-a&quot;, &quot;&quot;)
103                 .shouldContain(&quot;Warning:&quot;)
104                 .shouldMatch(&quot;The certificate request.*MD5withRSA.*risk&quot;);
105         gencert(&quot;c-a&quot;, &quot;-sigalg MD2withRSA&quot;)
106                 .shouldContain(&quot;Warning:&quot;)
107                 .shouldMatch(&quot;The certificate request.*MD5withRSA.*risk&quot;)
108                 .shouldMatch(&quot;The generated certificate.*MD2withRSA.*risk&quot;);
109 
110         checkCertReq(&quot;b&quot;, &quot;&quot;, &quot;512-bit RSA key&quot;);
111         gencert(&quot;c-b&quot;, &quot;&quot;)
112                 .shouldContain(&quot;Warning:&quot;)
113                 .shouldMatch(&quot;The certificate request.*512-bit RSA key.*risk&quot;)
114                 .shouldMatch(&quot;The generated certificate.*512-bit RSA key.*risk&quot;);
115 
116         checkCertReq(&quot;c&quot;, &quot;&quot;, null);
117         gencert(&quot;a-c&quot;, &quot;&quot;)
118                 .shouldContain(&quot;Warning:&quot;)
119                 .shouldMatch(&quot;The issuer.*MD5withRSA.*risk&quot;);
120 
121         // but the new cert is not weak
122         kt(&quot;-printcert -file a-c.cert&quot;)
123                 .shouldNotContain(&quot;Warning&quot;)
124                 .shouldNotContain(&quot;weak&quot;);
125 
126         gencert(&quot;b-c&quot;, &quot;&quot;)
127                 .shouldContain(&quot;Warning:&quot;)
128                 .shouldMatch(&quot;The issuer.*512-bit RSA key.*risk&quot;);
129 
130         // -importcert
131         checkImport();
132 
133         // -importkeystore
134         checkImportKeyStore();
135 
136         // -gencrl, -printcrl
137 
138         checkGenCRL(&quot;a&quot;, &quot;&quot;, null);
139         checkGenCRL(&quot;a&quot;, &quot;-sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
140         checkGenCRL(&quot;b&quot;, &quot;&quot;, &quot;512-bit RSA key&quot;);
141         checkGenCRL(&quot;c&quot;, &quot;&quot;, null);
142 
143         kt(&quot;-delete -alias b&quot;);
144         kt(&quot;-printcrl -file b.crl&quot;)
145                 .shouldContain(&quot;WARNING: not verified&quot;);
146 
147         jksTypeCheck();
148 
149         checkInplaceImportKeyStore();
150     }
151 
152     static void jksTypeCheck() throws Exception {
153 
154         // No warning for cacerts, all certs
155         kt0(&quot;-cacerts -list -storepass changeit&quot;)
156                 .shouldNotContain(&quot;Warning:&quot;);
157 
158         rm(&quot;ks&quot;);
159         rm(&quot;ks2&quot;);
160 
161         kt(&quot;-genkeypair -keyalg DSA -alias a -dname CN=A&quot;)
162                 .shouldNotContain(&quot;Warning:&quot;);
163         kt(&quot;-list&quot;)
164                 .shouldNotContain(&quot;Warning:&quot;);
165         kt(&quot;-list -storetype jks&quot;) // no warning if PKCS12 used as JKS
166                 .shouldNotContain(&quot;Warning:&quot;);
167         kt(&quot;-exportcert -alias a -file a.crt&quot;)
168                 .shouldNotContain(&quot;Warning:&quot;);
169 
170         // warn if migrating to JKS
171         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;-deststoretype jks&quot;)
172                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
173 
174         rm(&quot;ks&quot;);
175         rm(&quot;ks2&quot;);
176         rm(&quot;ks3&quot;);
177 
178         // no warning if all certs
179         kt(&quot;-importcert -alias b -file a.crt -storetype jks -noprompt&quot;)
180                 .shouldNotContain(&quot;Warning:&quot;);
<a name="1" id="anc1"></a><span class="line-modified">181         kt(&quot;-genkeypair -alias a -dname CN=A&quot;)</span>
182                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
183         kt(&quot;-list&quot;)
184                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
185         kt(&quot;-list -storetype pkcs12&quot;) // warn if JKS used as PKCS12
186                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
187         kt(&quot;-exportcert -alias a -file a.crt&quot;)
188                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
189         kt(&quot;-printcert -file a.crt&quot;) // no warning if keystore not touched
190                 .shouldNotContain(&quot;Warning:&quot;);
191         kt(&quot;-certreq -alias a -file a.req&quot;)
192                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
193         kt(&quot;-printcertreq -file a.req&quot;) // no warning if keystore not touched
194                 .shouldNotContain(&quot;Warning:&quot;);
195 
196         // No warning if migrating from JKS
197         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;&quot;)
198                 .shouldNotContain(&quot;Warning:&quot;);
199 
200         importkeystore(&quot;ks&quot;, &quot;ks3&quot;, &quot;-deststoretype pkcs12&quot;)
201                 .shouldNotContain(&quot;Warning:&quot;);
202 
203         rm(&quot;ks&quot;);
204 
<a name="2" id="anc2"></a><span class="line-modified">205         kt(&quot;-genkeypair -alias a -dname CN=A -storetype jceks&quot;)</span>
206                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
207         kt(&quot;-list&quot;)
208                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
209         kt(&quot;-importcert -alias b -file a.crt -noprompt&quot;)
210                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
211         kt(&quot;-exportcert -alias a -file a.crt&quot;)
212                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
213         kt(&quot;-printcert -file a.crt&quot;)
214                 .shouldNotContain(&quot;Warning:&quot;);
215         kt(&quot;-certreq -alias a -file a.req&quot;)
216                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
217         kt(&quot;-printcertreq -file a.req&quot;)
218                 .shouldNotContain(&quot;Warning:&quot;);
219         kt(&quot;-genseckey -alias c -keyalg AES -keysize 128&quot;)
220                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
221     }
222 
223     static void checkImportKeyStore() throws Exception {
224 
225         rm(&quot;ks2&quot;);
226         rm(&quot;ks3&quot;);
227 
228         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;&quot;)
229                 .shouldContain(&quot;3 entries successfully imported&quot;)
230                 .shouldContain(&quot;Warning&quot;)
231                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*risk&quot;)
232                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*risk&quot;);
233 
234         importkeystore(&quot;ks&quot;, &quot;ks3&quot;, &quot;-srcalias a&quot;)
235                 .shouldContain(&quot;Warning&quot;)
236                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*risk&quot;);
237     }
238 
239     static void checkInplaceImportKeyStore() throws Exception {
240 
241         rm(&quot;ks&quot;);
<a name="3" id="anc3"></a><span class="line-modified">242         genkeypair(&quot;a&quot;, &quot;&quot;);</span>
243 
244         // Same type backup
245         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;&quot;)
246                 .shouldContain(&quot;Warning:&quot;)
247                 .shouldMatch(&quot;original.*ks.old&quot;);
248 
249         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;&quot;)
250                 .shouldContain(&quot;Warning:&quot;)
251                 .shouldMatch(&quot;original.*ks.old2&quot;);
252 
253         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-srcstoretype jks&quot;) // it knows real type
254                 .shouldContain(&quot;Warning:&quot;)
255                 .shouldMatch(&quot;original.*ks.old3&quot;);
256 
257         String cPath = new File(&quot;ks&quot;).getCanonicalPath();
258 
259         importkeystore(&quot;ks&quot;, cPath, &quot;&quot;)
260                 .shouldContain(&quot;Warning:&quot;)
261                 .shouldMatch(&quot;original.*ks.old4&quot;);
262 
263         // Migration
264         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-deststoretype jks&quot;)
265                 .shouldContain(&quot;Warning:&quot;)
266                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;)
267                 .shouldMatch(&quot;Migrated.*JKS.*PKCS12.*ks.old5&quot;);
268 
269         Asserts.assertEQ(
270                 KeyStore.getInstance(
271                         new File(&quot;ks&quot;), &quot;changeit&quot;.toCharArray()).getType(),
272                 &quot;JKS&quot;);
273 
274         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-srcstoretype PKCS12&quot;)
275                 .shouldContain(&quot;Warning:&quot;)
276                 .shouldNotContain(&quot;proprietary format&quot;)
277                 .shouldMatch(&quot;Migrated.*PKCS12.*JKS.*ks.old6&quot;);
278 
279         Asserts.assertEQ(
280                 KeyStore.getInstance(
281                         new File(&quot;ks&quot;), &quot;changeit&quot;.toCharArray()).getType(),
282                 &quot;PKCS12&quot;);
283 
284         Asserts.assertEQ(
285                 KeyStore.getInstance(
286                         new File(&quot;ks.old6&quot;), &quot;changeit&quot;.toCharArray()).getType(),
287                 &quot;JKS&quot;);
288 
289         // One password prompt is enough for migration
290         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks&quot;, &quot;changeit&quot;)
291                 .shouldMatch(&quot;original.*ks.old7&quot;);
292 
293         // But three if importing to a different keystore
294         rm(&quot;ks2&quot;);
295         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks2&quot;,
296                     &quot;changeit&quot;)
297                 .shouldContain(&quot;Keystore password is too short&quot;);
298 
299         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks2&quot;,
300                 &quot;changeit&quot;, &quot;changeit&quot;, &quot;changeit&quot;)
301                 .shouldContain(&quot;Importing keystore ks to ks2...&quot;)
302                 .shouldNotContain(&quot;original&quot;)
303                 .shouldNotContain(&quot;Migrated&quot;);
304     }
305 
306     static void checkImport() throws Exception {
307 
308         saveStore();
309 
310         // add trusted cert
311 
312         // cert already in
313         kt(&quot;-importcert -alias d -file a.cert&quot;, &quot;no&quot;)
314                 .shouldContain(&quot;Certificate already exists in keystore&quot;)
315                 .shouldContain(&quot;Warning&quot;)
316                 .shouldMatch(&quot;The input.*MD5withRSA.*risk&quot;)
317                 .shouldContain(&quot;Do you still want to add it?&quot;);
318         kt(&quot;-importcert -alias d -file a.cert -noprompt&quot;)
319                 .shouldContain(&quot;Warning&quot;)
320                 .shouldMatch(&quot;The input.*MD5withRSA.*risk&quot;)
321                 .shouldNotContain(&quot;[no]&quot;);
322 
323         // cert is self-signed
324         kt(&quot;-delete -alias a&quot;);
325         kt(&quot;-delete -alias d&quot;);
326         kt(&quot;-importcert -alias d -file a.cert&quot;, &quot;no&quot;)
327                 .shouldContain(&quot;Warning&quot;)
328                 .shouldContain(&quot;MD5withRSA (weak)&quot;)
329                 .shouldMatch(&quot;The input.*MD5withRSA.*risk&quot;)
330                 .shouldContain(&quot;Trust this certificate?&quot;);
331         kt(&quot;-importcert -alias d -file a.cert -noprompt&quot;)
332                 .shouldContain(&quot;Warning&quot;)
333                 .shouldMatch(&quot;The input.*MD5withRSA.*risk&quot;)
334                 .shouldNotContain(&quot;[no]&quot;);
335 
336         // JDK-8177569: no warning for sigalg of trusted cert
337         String weakSigAlgCA = null;
338         KeyStore ks = KeyStoreUtil.getCacertsKeyStore();
339         if (ks != null) {
340             DisabledAlgorithmConstraints disabledCheck =
341                     new DisabledAlgorithmConstraints(
342                             DisabledAlgorithmConstraints.PROPERTY_CERTPATH_DISABLED_ALGS);
343             Set&lt;CryptoPrimitive&gt; sigPrimitiveSet = Collections
344                     .unmodifiableSet(EnumSet.of(CryptoPrimitive.SIGNATURE));
345 
346             for (String s : Collections.list(ks.aliases())) {
347                 if (ks.isCertificateEntry(s)) {
348                     X509Certificate c = (X509Certificate)ks.getCertificate(s);
349                     String sigAlg = c.getSigAlgName();
350                     if (!disabledCheck.permits(sigPrimitiveSet, sigAlg, null)) {
351                         weakSigAlgCA = sigAlg;
352                         Files.write(Paths.get(&quot;ca.cert&quot;),
353                                 ks.getCertificate(s).getEncoded());
354                         break;
355                     }
356                 }
357             }
358         }
359         if (weakSigAlgCA != null) {
360             // The following 2 commands still have a warning on why not using
361             // the -cacerts option directly.
362             kt(&quot;-list -keystore &quot; + KeyStoreUtil.getCacerts())
363                     .shouldNotContain(&quot;risk&quot;);
364             kt(&quot;-list -v -keystore &quot; + KeyStoreUtil.getCacerts())
365                     .shouldNotContain(&quot;risk&quot;);
366 
367             // -printcert will always show warnings
368             kt(&quot;-printcert -file ca.cert&quot;)
369                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (weak)&quot;)
370                     .shouldContain(&quot;Warning&quot;)
371                     .shouldMatch(&quot;The certificate.*&quot; + weakSigAlgCA + &quot;.*risk&quot;);
372             kt(&quot;-printcert -file ca.cert -trustcacerts&quot;) // -trustcacerts useless
373                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (weak)&quot;)
374                     .shouldContain(&quot;Warning&quot;)
375                     .shouldMatch(&quot;The certificate.*&quot; + weakSigAlgCA + &quot;.*risk&quot;);
376 
377             // Importing with -trustcacerts ignore CA cert&#39;s sig alg
378             kt(&quot;-delete -alias d&quot;);
379             kt(&quot;-importcert -alias d -trustcacerts -file ca.cert&quot;, &quot;no&quot;)
380                     .shouldContain(&quot;Certificate already exists in system-wide CA&quot;)
381                     .shouldNotContain(&quot;risk&quot;)
382                     .shouldContain(&quot;Do you still want to add it to your own keystore?&quot;);
383             kt(&quot;-importcert -alias d -trustcacerts -file ca.cert -noprompt&quot;)
384                     .shouldNotContain(&quot;risk&quot;)
385                     .shouldNotContain(&quot;[no]&quot;);
386 
387             // but not without -trustcacerts
388             kt(&quot;-delete -alias d&quot;);
389             kt(&quot;-importcert -alias d -file ca.cert&quot;, &quot;no&quot;)
390                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (weak)&quot;)
391                     .shouldContain(&quot;Warning&quot;)
392                     .shouldMatch(&quot;The input.*&quot; + weakSigAlgCA + &quot;.*risk&quot;)
393                     .shouldContain(&quot;Trust this certificate?&quot;);
394             kt(&quot;-importcert -alias d -file ca.cert -noprompt&quot;)
395                     .shouldContain(&quot;Warning&quot;)
396                     .shouldMatch(&quot;The input.*&quot; + weakSigAlgCA + &quot;.*risk&quot;)
397                     .shouldNotContain(&quot;[no]&quot;);
398         }
399 
400         // a non self-signed weak cert
401         reStore();
402         certreq(&quot;b&quot;, &quot;&quot;);
403         gencert(&quot;c-b&quot;, &quot;&quot;);
404         kt(&quot;-importcert -alias d -file c-b.cert&quot;)   // weak only, no prompt
405                 .shouldContain(&quot;Warning&quot;)
406                 .shouldNotContain(&quot;512-bit RSA key (weak)&quot;)
407                 .shouldMatch(&quot;The input.*512-bit RSA key.*risk&quot;)
408                 .shouldNotContain(&quot;[no]&quot;);
409 
410         kt(&quot;-delete -alias b&quot;);
411         kt(&quot;-delete -alias c&quot;);
412         kt(&quot;-delete -alias d&quot;);
413 
414         kt(&quot;-importcert -alias d -file c-b.cert&quot;, &quot;no&quot;) // weak and not trusted
415                 .shouldContain(&quot;Warning&quot;)
416                 .shouldContain(&quot;512-bit RSA key (weak)&quot;)
417                 .shouldMatch(&quot;The input.*512-bit RSA key.*risk&quot;)
418                 .shouldContain(&quot;Trust this certificate?&quot;);
419         kt(&quot;-importcert -alias d -file c-b.cert -noprompt&quot;)
420                 .shouldContain(&quot;Warning&quot;)
421                 .shouldMatch(&quot;The input.*512-bit RSA key.*risk&quot;)
422                 .shouldNotContain(&quot;[no]&quot;);
423 
424         // a non self-signed strong cert
425         reStore();
426         certreq(&quot;a&quot;, &quot;&quot;);
427         gencert(&quot;c-a&quot;, &quot;&quot;);
428         kt(&quot;-importcert -alias d -file c-a.cert&quot;) // trusted
429                 .shouldNotContain(&quot;Warning&quot;)
430                 .shouldNotContain(&quot;[no]&quot;);
431 
432         kt(&quot;-delete -alias a&quot;);
433         kt(&quot;-delete -alias c&quot;);
434         kt(&quot;-delete -alias d&quot;);
435 
436         kt(&quot;-importcert -alias d -file c-a.cert&quot;, &quot;no&quot;) // not trusted
437                 .shouldNotContain(&quot;Warning&quot;)
438                 .shouldContain(&quot;Trust this certificate?&quot;);
439         kt(&quot;-importcert -alias d -file c-a.cert -noprompt&quot;)
440                 .shouldNotContain(&quot;Warning&quot;)
441                 .shouldNotContain(&quot;[no]&quot;);
442 
443         // install reply
444 
445         reStore();
446         certreq(&quot;c&quot;, &quot;&quot;);
447         gencert(&quot;a-c&quot;, &quot;&quot;);
448         kt(&quot;-importcert -alias c -file a-c.cert&quot;)
449                 .shouldContain(&quot;Warning&quot;)
450                 .shouldMatch(&quot;Issuer &lt;a&gt;.*MD5withRSA.*risk&quot;);
451 
452         // JDK-8177569: no warning for sigalg of trusted cert
453         reStore();
454         // Change a into a TrustedCertEntry
455         kt(&quot;-exportcert -alias a -file a.cert&quot;);
456         kt(&quot;-delete -alias a&quot;);
457         kt(&quot;-importcert -alias a -file a.cert -noprompt&quot;);
458         kt(&quot;-list -alias a -v&quot;)
459                 .shouldNotContain(&quot;weak&quot;)
460                 .shouldNotContain(&quot;Warning&quot;);
461         // This time a is trusted and no warning on its weak sig alg
462         kt(&quot;-importcert -alias c -file a-c.cert&quot;)
463                 .shouldNotContain(&quot;Warning&quot;);
464 
465         reStore();
466 
467         gencert(&quot;a-b&quot;, &quot;&quot;);
468         gencert(&quot;b-c&quot;, &quot;&quot;);
469 
470         // Full chain with root
471         cat(&quot;a-a-b-c.cert&quot;, &quot;b-c.cert&quot;, &quot;a-b.cert&quot;, &quot;a.cert&quot;);
472         kt(&quot;-importcert -alias c -file a-a-b-c.cert&quot;)   // only weak
473                 .shouldContain(&quot;Warning&quot;)
474                 .shouldMatch(&quot;Reply #2 of 3.*512-bit RSA key.*risk&quot;)
475                 .shouldMatch(&quot;Reply #3 of 3.*MD5withRSA.*risk&quot;)
476                 .shouldNotContain(&quot;[no]&quot;);
477 
478         // Without root
479         cat(&quot;a-b-c.cert&quot;, &quot;b-c.cert&quot;, &quot;a-b.cert&quot;);
480         kt(&quot;-importcert -alias c -file a-b-c.cert&quot;)     // only weak
481                 .shouldContain(&quot;Warning&quot;)
482                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*risk&quot;)
483                 .shouldMatch(&quot;Issuer &lt;a&gt;.*MD5withRSA.*risk&quot;)
484                 .shouldNotContain(&quot;[no]&quot;);
485 
486         reStore();
487         gencert(&quot;b-a&quot;, &quot;&quot;);
488 
489         kt(&quot;-importcert -alias a -file b-a.cert&quot;)
490                 .shouldContain(&quot;Warning&quot;)
491                 .shouldMatch(&quot;Issuer &lt;b&gt;.*512-bit RSA key.*risk&quot;)
492                 .shouldNotContain(&quot;[no]&quot;);
493 
494         kt(&quot;-importcert -alias a -file c-a.cert&quot;)
495                 .shouldNotContain(&quot;Warning&quot;);
496 
497         kt(&quot;-importcert -alias b -file c-b.cert&quot;)
498                 .shouldContain(&quot;Warning&quot;)
499                 .shouldMatch(&quot;The input.*512-bit RSA key.*risk&quot;)
500                 .shouldNotContain(&quot;[no]&quot;);
501 
502         reStore();
503         gencert(&quot;b-a&quot;, &quot;&quot;);
504 
505         cat(&quot;c-b-a.cert&quot;, &quot;b-a.cert&quot;, &quot;c-b.cert&quot;);
506 
507         kt(&quot;-printcert -file c-b-a.cert&quot;)
508                 .shouldContain(&quot;Warning&quot;)
509                 .shouldMatch(&quot;The certificate #2 of 2.*512-bit RSA key.*risk&quot;);
510 
511         kt(&quot;-delete -alias b&quot;);
512 
513         kt(&quot;-importcert -alias a -file c-b-a.cert&quot;)
514                 .shouldContain(&quot;Warning&quot;)
515                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*risk&quot;)
516                 .shouldNotContain(&quot;[no]&quot;);
517 
518         kt(&quot;-delete -alias c&quot;);
519         kt(&quot;-importcert -alias a -file c-b-a.cert&quot;, &quot;no&quot;)
520                 .shouldContain(&quot;Top-level certificate in reply:&quot;)
521                 .shouldContain(&quot;512-bit RSA key (weak)&quot;)
522                 .shouldContain(&quot;Warning&quot;)
523                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*risk&quot;)
524                 .shouldContain(&quot;Install reply anyway?&quot;);
525         kt(&quot;-importcert -alias a -file c-b-a.cert -noprompt&quot;)
526                 .shouldContain(&quot;Warning&quot;)
527                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*risk&quot;)
528                 .shouldNotContain(&quot;[no]&quot;);
529 
530         reStore();
531     }
532 
533     private static void cat(String dest, String... src) throws IOException {
534         System.out.println(&quot;---------------------------------------------&quot;);
535         System.out.printf(&quot;$ cat &quot;);
536 
537         ByteArrayOutputStream bout = new ByteArrayOutputStream();
538         for (String s : src) {
539             System.out.printf(s + &quot; &quot;);
540             bout.write(Files.readAllBytes(Paths.get(s)));
541         }
542         Files.write(Paths.get(dest), bout.toByteArray());
543         System.out.println(&quot;&gt; &quot; + dest);
544     }
545 
546     static void checkGenCRL(String alias, String options, String bad) {
547 
548         OutputAnalyzer oa = kt(&quot;-gencrl -alias &quot; + alias
549                 + &quot; -id 1 -file &quot; + alias + &quot;.crl &quot; + options);
550         if (bad == null) {
551             oa.shouldNotContain(&quot;Warning&quot;);
552         } else {
553             oa.shouldContain(&quot;Warning&quot;)
554                     .shouldMatch(&quot;The generated CRL.*&quot; + bad + &quot;.*risk&quot;);
555         }
556 
557         oa = kt(&quot;-printcrl -file &quot; + alias + &quot;.crl&quot;);
558         if (bad == null) {
559             oa.shouldNotContain(&quot;Warning&quot;)
560                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
561                     .shouldNotContain(&quot;(weak&quot;);
562         } else {
563             oa.shouldContain(&quot;Warning:&quot;)
564                     .shouldMatch(&quot;The CRL.*&quot; + bad + &quot;.*risk&quot;)
565                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
566                     .shouldContain(bad + &quot; (weak)&quot;);
567         }
568     }
569 
570     static void checkCertReq(
571             String alias, String options, String bad) {
572 
573         OutputAnalyzer oa = certreq(alias, options);
574         if (bad == null) {
575             oa.shouldNotContain(&quot;Warning&quot;);
576         } else {
577             oa.shouldContain(&quot;Warning&quot;)
578                     .shouldMatch(&quot;The generated certificate request.*&quot; + bad + &quot;.*risk&quot;);
579         }
580 
581         oa = kt(&quot;-printcertreq -file &quot; + alias + &quot;.req&quot;);
582         if (bad == null) {
583             oa.shouldNotContain(&quot;Warning&quot;)
584                     .shouldNotContain(&quot;(weak)&quot;);
585         } else {
586             oa.shouldContain(&quot;Warning&quot;)
587                     .shouldMatch(&quot;The certificate request.*&quot; + bad + &quot;.*risk&quot;)
588                     .shouldContain(bad + &quot; (weak)&quot;);
589         }
590     }
591 
592     static void checkGenKeyPair(
593             String alias, String options, String bad) {
594 
595         OutputAnalyzer oa = genkeypair(alias, options);
596         if (bad == null) {
597             oa.shouldNotContain(&quot;Warning&quot;);
598         } else {
599             oa.shouldContain(&quot;Warning&quot;)
600                     .shouldMatch(&quot;The generated certificate.*&quot; + bad + &quot;.*risk&quot;);
601         }
602 
603         oa = kt(&quot;-exportcert -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
604         if (bad == null) {
605             oa.shouldNotContain(&quot;Warning&quot;);
606         } else {
607             oa.shouldContain(&quot;Warning&quot;)
608                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
609         }
610 
611         oa = kt(&quot;-exportcert -rfc -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
612         if (bad == null) {
613             oa.shouldNotContain(&quot;Warning&quot;);
614         } else {
615             oa.shouldContain(&quot;Warning&quot;)
616                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
617         }
618 
619         oa = kt(&quot;-printcert -rfc -file &quot; + alias + &quot;.cert&quot;);
620         if (bad == null) {
621             oa.shouldNotContain(&quot;Warning&quot;);
622         } else {
623             oa.shouldContain(&quot;Warning&quot;)
624                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
625         }
626 
627         oa = kt(&quot;-list -alias &quot; + alias);
628         if (bad == null) {
629             oa.shouldNotContain(&quot;Warning&quot;);
630         } else {
631             oa.shouldContain(&quot;Warning&quot;)
632                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
633         }
634 
635         // With cert content
636 
637         oa = kt(&quot;-printcert -file &quot; + alias + &quot;.cert&quot;);
638         if (bad == null) {
639             oa.shouldNotContain(&quot;Warning&quot;);
640         } else {
641             oa.shouldContain(&quot;Warning&quot;)
642                     .shouldContain(bad + &quot; (weak)&quot;)
643                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
644         }
645 
646         oa = kt(&quot;-list -v -alias &quot; + alias);
647         if (bad == null) {
648             oa.shouldNotContain(&quot;Warning&quot;);
649         } else {
650             oa.shouldContain(&quot;Warning&quot;)
651                     .shouldContain(bad + &quot; (weak)&quot;)
652                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*risk&quot;);
653         }
654     }
655 
656     // This is slow, but real keytool process is launched.
657     static OutputAnalyzer kt1(String cmd, String... input) {
658         cmd = &quot;-keystore ks -storepass changeit &quot; +
659                 &quot;-keypass changeit &quot; + cmd;
660         System.out.println(&quot;---------------------------------------------&quot;);
661         try {
662             SecurityTools.setResponse(input);
663             return SecurityTools.keytool(cmd);
664         } catch (Throwable e) {
665             throw new RuntimeException(e);
666         }
667     }
668 
669     static OutputAnalyzer kt(String cmd, String... input) {
670         return kt0(&quot;-keystore ks -storepass changeit &quot; +
671                 &quot;-keypass changeit &quot; + cmd, input);
672     }
673 
674     // Fast keytool execution by directly calling its main() method
675     static OutputAnalyzer kt0(String cmd, String... input) {
676         PrintStream out = System.out;
677         PrintStream err = System.err;
678         InputStream ins = System.in;
679         ByteArrayOutputStream bout = new ByteArrayOutputStream();
680         ByteArrayOutputStream berr = new ByteArrayOutputStream();
681         boolean succeed = true;
682         String sout;
683         String serr;
684         try {
685             System.out.println(&quot;---------------------------------------------&quot;);
686             System.out.println(&quot;$ keytool &quot; + cmd);
687             System.out.println();
688             String feed = &quot;&quot;;
689             if (input.length &gt; 0) {
690                 feed = Stream.of(input).collect(Collectors.joining(&quot;\n&quot;)) + &quot;\n&quot;;
691             }
692             System.setIn(new ByteArrayInputStream(feed.getBytes()));
693             System.setOut(new PrintStream(bout));
694             System.setErr(new PrintStream(berr));
695             sun.security.tools.keytool.Main.main(
696                     cmd.trim().split(&quot;\\s+&quot;));
697         } catch (Exception e) {
698             // Might be a normal exception when -debug is on or
699             // SecurityException (thrown by jtreg) when System.exit() is called
700             if (!(e instanceof SecurityException)) {
701                 e.printStackTrace();
702             }
703             succeed = false;
704         } finally {
705             System.setOut(out);
706             System.setErr(err);
707             System.setIn(ins);
708             sout = new String(bout.toByteArray());
709             serr = new String(berr.toByteArray());
710             System.out.println(&quot;STDOUT:\n&quot; + sout + &quot;\nSTDERR:\n&quot; + serr);
711         }
712         if (!succeed) {
713             throw new RuntimeException();
714         }
715         return new OutputAnalyzer(sout, serr);
716     }
717 
718     static OutputAnalyzer importkeystore(String src, String dest,
719                                          String options) {
720         return kt0(&quot;-importkeystore &quot;
721                 + &quot;-srckeystore &quot; + src + &quot; -destkeystore &quot; + dest
722                 + &quot; -srcstorepass changeit -deststorepass changeit &quot; + options);
723     }
724 
725     static OutputAnalyzer genkeypair(String alias, String options) {
726         return kt(&quot;-genkeypair -alias &quot; + alias + &quot; -dname CN=&quot; + alias
727                 + &quot; -storetype PKCS12 &quot; + options);
728     }
729 
730     static OutputAnalyzer certreq(String alias, String options) {
731         return kt(&quot;-certreq -alias &quot; + alias
732                 + &quot; -file &quot; + alias + &quot;.req &quot; + options);
733     }
734 
735     static OutputAnalyzer exportcert(String alias) {
736         return kt(&quot;-exportcert -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
737     }
738 
739     static OutputAnalyzer gencert(String relation, String options) {
740         int pos = relation.indexOf(&quot;-&quot;);
741         String issuer = relation.substring(0, pos);
742         String subject = relation.substring(pos + 1);
743         return kt(&quot; -gencert -alias &quot; + issuer + &quot; -infile &quot; + subject
744                 + &quot;.req -outfile &quot; + relation + &quot;.cert &quot; + options);
745     }
746 
747     static void saveStore() throws IOException {
748         System.out.println(&quot;---------------------------------------------&quot;);
749         System.out.println(&quot;$ cp ks ks2&quot;);
750         Files.copy(Paths.get(&quot;ks&quot;), Paths.get(&quot;ks2&quot;),
751                 StandardCopyOption.REPLACE_EXISTING);
752     }
753 
754     static void reStore() throws IOException {
755         System.out.println(&quot;---------------------------------------------&quot;);
756         System.out.println(&quot;$ cp ks2 ks&quot;);
757         Files.copy(Paths.get(&quot;ks2&quot;), Paths.get(&quot;ks&quot;),
758                 StandardCopyOption.REPLACE_EXISTING);
759     }
760 
761     static void rm(String s) throws IOException {
762         System.out.println(&quot;---------------------------------------------&quot;);
763         System.out.println(&quot;$ rm &quot; + s);
764         Files.deleteIfExists(Paths.get(s));
765     }
766 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>