<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/tools/jarsigner/WasSignedByOtherSigner.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.OutputStream;
 26 import java.nio.file.Path;
 27 import java.util.Map;
 28 import java.util.jar.JarFile;
 29 import java.util.jar.Manifest;
 30 import java.util.jar.Attributes.Name;
 31 import java.util.zip.ZipEntry;
 32 import java.util.zip.ZipFile;
 33 
 34 import jdk.test.lib.util.JarUtils;
 35 import jdk.test.lib.SecurityTools;
 36 import org.testng.annotations.Test;
 37 import org.testng.annotations.BeforeClass;
 38 
 39 import static java.nio.charset.StandardCharsets.UTF_8;
 40 import static org.testng.Assert.*;
 41 
 42 /**
 43  * @test
 44  * @bug 8217375
 45  * @library /test/lib
 46  * @run testng WasSignedByOtherSigner
 47  * @summary Checks that {@code wasSigned} in
 48  * {@link jdk.security.jarsigner.JarSigner#sign0} is set true if the jar to sign
 49  * contains a signature that will not be overwritten with the current one.
 50  */
 51 public class WasSignedByOtherSigner {
 52 
 53     static final String KEYSTORE_FILENAME = &quot;test.jks&quot;;
 54 
 55     @BeforeClass
 56     public void prepareKeyStore() throws Exception {
 57         SecurityTools.keytool(&quot;-genkeypair -keyalg EC -keystore &quot;
 58                 + KEYSTORE_FILENAME + &quot; -storepass changeit -keypass changeit&quot;
 59                 + &quot; -alias a -dname CN=A&quot;).shouldHaveExitValue(0);
 60     }
 61 
 62     void test(String secondSigner, boolean expRrewritten) throws Exception {
 63         String jarFilename1 = &quot;test&quot; + secondSigner + &quot;-1.jar&quot;;
 64         JarUtils.createJarFile(Path.of(jarFilename1), (Manifest) null,
 65                 Path.of(&quot;.&quot;));
 66         // TODO: use jarsigner here only to create a default manifest...
 67         SecurityTools.jarsigner(&quot;-keystore &quot; + KEYSTORE_FILENAME +
 68                 &quot; -storepass changeit -verbose -debug &quot; + jarFilename1 + &quot; a&quot;)
 69                 .shouldHaveExitValue(0);
 70         Utils.echoManifest(Utils.readJarManifestBytes(
 71                 jarFilename1), &quot;initial manifest&quot;);
 72 
 73         // replace manifest with a non-standard one that can later be checked
 74         String jarFilename2 = &quot;test&quot; + secondSigner + &quot;-2.jar&quot;;
 75         JarUtils.updateJar(jarFilename1, jarFilename2, Map.of(
 76                 // add a fake sig-related file to trigger wasSigned in JarSigner
 77                 &quot;META-INF/.SF&quot;, Name.SIGNATURE_VERSION + &quot;: 1.0\r\n&quot;));
 78         Utils.echoManifest(Utils.readJarManifestBytes(
 79                 jarFilename2), &quot;with fake META-INF.SF file&quot;);
 80         String jarFilename3 = &quot;test&quot; + secondSigner + &quot;-3.jar&quot;;
 81         JarUtils.updateManifest(jarFilename2, jarFilename3, new Manifest() {
 82             @Override public void write(OutputStream out) throws IOException {
 83                 // no trailing blank line
 84                 out.write((Name.MANIFEST_VERSION + &quot;: 1.0\r\n&quot;).getBytes(UTF_8));
 85             }
 86         });
 87         Utils.echoManifest(Utils.readJarManifestBytes(
 88                 jarFilename3), &quot;with manifest manipulated&quot;);
 89         SecurityTools.jarsigner(&quot;-keystore &quot; + KEYSTORE_FILENAME +
 90                 &quot; -storepass changeit -verbose -debug &quot; + jarFilename3 + &quot; a&quot;)
 91                 .shouldHaveExitValue(0);
 92         Utils.echoManifest(Utils.readJarManifestBytes(
 93                 jarFilename3), &quot;signed&quot;);
 94         String jarFilename4 = &quot;test&quot; + secondSigner + &quot;-4.jar&quot;;
 95         JarUtils.updateJar(jarFilename3, jarFilename4,
 96                 Map.of(&quot;META-INF/.SF&quot;, false));
 97         Utils.echoManifest(Utils.readJarManifestBytes(
 98                 jarFilename4), &quot;with fake META-INF.SF file removed&quot;);
 99 
100         // re-sign the jar with signer named secondSigner (same or different)
101         SecurityTools.jarsigner(&quot;-keystore &quot; + KEYSTORE_FILENAME +
102                 &quot; -storepass changeit -verbose -debug -sigfile &quot; +
103                 secondSigner + &quot; &quot; + jarFilename4 + &quot; a&quot;)
104                 .shouldHaveExitValue(0);
105         Utils.echoManifest(Utils.readJarManifestBytes(
106                 jarFilename4), &quot;signed again&quot;);
107         // remove META-INF/.SF from signed jar again which would not validate
108 
109         // in any case verify that the resulting jar file is valid
110         SecurityTools.jarsigner(&quot;-verify -keystore &quot; + KEYSTORE_FILENAME +
111                 &quot; -storepass changeit -debug -verbose &quot; + jarFilename4)
112                 .shouldHaveExitValue(0);
113         SecurityTools.jarsigner(&quot;-verify -keystore &quot; + KEYSTORE_FILENAME +
114                 &quot; -storepass changeit -debug -verbose &quot; + jarFilename4 +
115                 &quot; a&quot;).shouldHaveExitValue(0);
116 
117         // if wasSigned was true in JarSigner#sign0 the manifest (only main
118         // attributes present and tested here but same consideration applies
119         // to individual sections just the same) should be reproduced with
120         // unchanged binary form. Otherwise, if there were no previous
121         // signatures or only one being replaced, the manifest is kind of
122         // &quot;normalized&quot; by re-writing it thereby replacing all line breaks
123         // (from cr or lf to crlf) and replacing all line breaks onto
124         // continuation lines and also writing all section delimiting blank
125         // lines.
126         // if that &quot;normalization&quot; has took place the test here can conclude
127         // whether wasSigned was true or was not.
128         try (ZipFile jar = new ZipFile(jarFilename4)) {
129             ZipEntry ze = jar.getEntry(JarFile.MANIFEST_NAME);
130             byte[] manifestBytes = jar.getInputStream(ze).readAllBytes();
131             Utils.echoManifest(manifestBytes, &quot;manifest&quot;);
132             String manifestString = new String(manifestBytes, UTF_8);
133             boolean actRewritten = manifestString.endsWith(&quot;\r\n\r\n&quot;);
134             assertEquals(actRewritten, expRrewritten);
135         }
136     }
137 
138     @Test
139     public void reSignSameSigner() throws Exception {
140         test(&quot;A&quot;, true);
141     }
142 
143     @Test
144     public void reSignOtherSigner() throws Exception {
145         test(&quot;B&quot;, false);
146     }
147 
148 }
    </pre>
  </body>
</html>