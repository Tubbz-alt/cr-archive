<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/security/tools/jarsigner/warnings/Test.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import jdk.test.lib.process.OutputAnalyzer;
 25 import jdk.test.lib.process.ProcessTools;
 26 
 27 import java.util.ArrayList;
 28 import java.util.Arrays;
 29 import java.util.List;
 30 
 31 /**
 32  * Base class.
 33  */
 34 public abstract class Test {
 35 
 36     static final String TEST_SOURCES = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 37     static final String TEST_CLASSES = System.getProperty(&quot;test.classes&quot;);
 38     static final String FS = System.getProperty(&quot;file.separator&quot;);
 39     static final String JAVA_HOME = System.getProperty(&quot;java.home&quot;);
 40     static final String KEYTOOL = JAVA_HOME + FS + &quot;bin&quot; + FS + &quot;keytool&quot;;
 41     static final String JARSIGNER = JAVA_HOME + FS + &quot;bin&quot; + FS + &quot;jarsigner&quot;;
 42     static final String UNSIGNED_JARFILE = &quot;unsigned.jar&quot;;
 43     static final String SIGNED_JARFILE = &quot;signed.jar&quot;;
 44     static final String UPDATED_SIGNED_JARFILE = &quot;updated_signed.jar&quot;;
 45     static final String FIRST_FILE = &quot;first.txt&quot;;
 46     static final String SECOND_FILE = &quot;second.txt&quot;;
 47     static final String PASSWORD = &quot;password&quot;;
 48     static final String FIRST_KEY_KEYSTORE = &quot;first_key.jks&quot;;
 49     static final String KEYSTORE = &quot;keystore.jks&quot;;
 50     static final String FIRST_KEY_ALIAS = &quot;first&quot;;
 51     static final String SECOND_KEY_ALIAS = &quot;second&quot;;
 52     static final String KEY_ALG = &quot;RSA&quot;;
 53     static final String KEY_ALIAS = &quot;alias&quot;;
 54     static final String CERT_REQUEST_FILENAME = &quot;test.req&quot;;
 55     static final String CERT_FILENAME = &quot;test.crt&quot;;
 56     static final String CA_KEY_ALIAS = &quot;ca&quot;;
 57     static final String CA2_KEY_ALIAS = &quot;ca2&quot;;
 58     static final int KEY_SIZE = 2048;
 59     static final int TIMEOUT = 6 * 60 * 1000;   // in millis
 60     static final int VALIDITY = 365;
 61 
 62     static final String WARNING = &quot;Warning:&quot;;
 63     static final String WARNING_OR_ERROR = &quot;(Warning|Error):&quot;;
 64 
 65     static final String CHAIN_NOT_VALIDATED_VERIFYING_WARNING
 66             = &quot;This jar contains entries &quot;
 67             + &quot;whose certificate chain is invalid.&quot;;
 68 
 69     static final String ALIAS_NOT_IN_STORE_VERIFYING_WARNING
 70             = &quot;This jar contains signed entries &quot;
 71             + &quot;that are not signed by alias in this keystore.&quot;;
 72 
 73     static final String BAD_EXTENDED_KEY_USAGE_SIGNING_WARNING
 74             = &quot;The signer certificate&#39;s ExtendedKeyUsage extension &quot;
 75             + &quot;doesn&#39;t allow code signing.&quot;;
 76 
 77     static final String BAD_EXTENDED_KEY_USAGE_VERIFYING_WARNING
 78             = &quot;This jar contains entries whose signer certificate&#39;s &quot;
 79             + &quot;ExtendedKeyUsage extension doesn&#39;t allow code signing.&quot;;
 80 
 81     static final String BAD_KEY_USAGE_SIGNING_WARNING
 82             = &quot;The signer certificate&#39;s KeyUsage extension &quot;
 83             + &quot;doesn&#39;t allow code signing.&quot;;
 84 
 85     static final String BAD_KEY_USAGE_VERIFYING_WARNING
 86             = &quot;This jar contains entries whose signer certificate&#39;s KeyUsage &quot;
 87             + &quot;extension doesn&#39;t allow code signing.&quot;;
 88 
 89     static final String BAD_NETSCAPE_CERT_TYPE_SIGNING_WARNING
 90             = &quot;The signer certificate&#39;s NetscapeCertType extension &quot;
 91             + &quot;doesn&#39;t allow code signing.&quot;;
 92 
 93     static final String BAD_NETSCAPE_CERT_TYPE_VERIFYING_WARNING
 94             = &quot;This jar contains entries &quot;
 95             + &quot;whose signer certificate&#39;s NetscapeCertType extension &quot;
 96             + &quot;doesn&#39;t allow code signing.&quot;;
 97 
 98     static final String CHAIN_NOT_VALIDATED_SIGNING_WARNING
 99             = &quot;The signer&#39;s certificate chain is invalid.&quot;;
100 
101     static final String HAS_EXPIRING_CERT_SIGNING_WARNING
102             = &quot;The signer certificate will expire within six months.&quot;;
103 
104     static final String HAS_EXPIRING_CERT_VERIFYING_WARNING
105             = &quot;This jar contains entries &quot;
106             + &quot;whose signer certificate will expire within six months.&quot;;
107 
108     static final String HAS_EXPIRED_CERT_SIGNING_WARNING
109             = &quot;The signer certificate has expired.&quot;;
110 
111     static final String HAS_EXPIRED_CERT_VERIFYING_WARNING
112             = &quot;This jar contains entries whose signer certificate has expired.&quot;;
113 
114     static final String HAS_UNSIGNED_ENTRY_VERIFYING_WARNING
115             = &quot;This jar contains unsigned entries &quot;
116             + &quot;which have not been integrity-checked.&quot;;
117 
118     static final String NOT_SIGNED_BY_ALIAS_VERIFYING_WARNING
119             = &quot;This jar contains signed entries &quot;
120             + &quot;which are not signed by the specified alias(es).&quot;;
121 
122     static final String NO_TIMESTAMP_SIGNING_WARN_TEMPLATE
123             = &quot;No -tsa or -tsacert is provided &quot;
124             + &quot;and this jar is not timestamped. &quot;
125             + &quot;Without a timestamp, users may not be able to validate this jar &quot;
126             + &quot;after the signer certificate&#39;s expiration date &quot;
127             + &quot;(%1$tY-%1$tm-%1$td).&quot;;
128 
129     static final String NO_TIMESTAMP_VERIFYING_WARN_TEMPLATE
130             = &quot;This jar contains signatures that do not include a timestamp. &quot;
131             + &quot;Without a timestamp, users may not be able to validate this jar &quot;
132             + &quot;after any of the signer certificates expire &quot;
133             + &quot;(as early as %1$tY-%1$tm-%1$td).&quot;;
134 
135     static final String NOT_YET_VALID_CERT_SIGNING_WARNING
136             = &quot;The signer certificate is not yet valid.&quot;;
137 
138     static final String NOT_YET_VALID_CERT_VERIFYING_WARNING
139             = &quot;This jar contains entries &quot;
140             + &quot;whose signer certificate is not yet valid.&quot;;
141 
142     static final String JAR_SIGNED = &quot;jar signed.&quot;;
143 
144     static final String JAR_VERIFIED = &quot;jar verified.&quot;;
145 
146     static final String JAR_VERIFIED_WITH_SIGNER_ERRORS
147             = &quot;jar verified, with signer errors.&quot;;
148 
149     static final int CHAIN_NOT_VALIDATED_EXIT_CODE = 4;
150     static final int HAS_EXPIRED_CERT_EXIT_CODE = 4;
151     static final int BAD_KEY_USAGE_EXIT_CODE = 8;
152     static final int BAD_EXTENDED_KEY_USAGE_EXIT_CODE = 8;
153     static final int BAD_NETSCAPE_CERT_TYPE_EXIT_CODE = 8;
154     static final int HAS_UNSIGNED_ENTRY_EXIT_CODE = 16;
155     static final int ALIAS_NOT_IN_STORE_EXIT_CODE = 32;
156     static final int NOT_SIGNED_BY_ALIAS_EXIT_CODE = 32;
157 
158     protected void createAlias(String alias, String ... options)
159             throws Throwable {
160         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
161         cmd.addAll(List.of(
162                 &quot;-genkeypair&quot;,
163                 &quot;-alias&quot;, alias,
164                 &quot;-keyalg&quot;, KEY_ALG,
165                 &quot;-keysize&quot;, Integer.toString(KEY_SIZE),
166                 &quot;-keystore&quot;, KEYSTORE,
167                 &quot;-storepass&quot;, PASSWORD,
168                 &quot;-keypass&quot;, PASSWORD,
169                 &quot;-dname&quot;, &quot;CN=&quot; + alias));
170         cmd.addAll(Arrays.asList(options));
171 
172         keytool(cmd.toArray(new String[cmd.size()]))
173                 .shouldHaveExitValue(0);
174     }
175 
176     protected void issueCert(String alias, String ... options)
177             throws Throwable {
178         keytool(&quot;-certreq&quot;,
179                 &quot;-alias&quot;, alias,
180                 &quot;-keystore&quot;, KEYSTORE,
181                 &quot;-storepass&quot;, PASSWORD,
182                 &quot;-keypass&quot;, PASSWORD,
183                 &quot;-file&quot;, alias + &quot;.req&quot;)
184                     .shouldHaveExitValue(0);
185 
186         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
187         cmd.addAll(List.of(
188                 &quot;-gencert&quot;,
189                 &quot;-alias&quot;, CA_KEY_ALIAS,
190                 &quot;-infile&quot;, alias + &quot;.req&quot;,
191                 &quot;-outfile&quot;, alias + &quot;.cert&quot;,
192                 &quot;-keystore&quot;, KEYSTORE,
193                 &quot;-storepass&quot;, PASSWORD,
194                 &quot;-keypass&quot;, PASSWORD,
195                 &quot;-file&quot;, alias + &quot;.req&quot;));
196         cmd.addAll(Arrays.asList(options));
197 
198         keytool(cmd.toArray(new String[cmd.size()]))
199                 .shouldHaveExitValue(0);
200 
201         keytool(&quot;-importcert&quot;,
202                 &quot;-alias&quot;, alias,
203                 &quot;-keystore&quot;, KEYSTORE,
204                 &quot;-storepass&quot;, PASSWORD,
205                 &quot;-keypass&quot;, PASSWORD,
206                 &quot;-file&quot;, alias + &quot;.cert&quot;)
207                     .shouldHaveExitValue(0);
208     }
209 
210     protected void checkVerifying(OutputAnalyzer analyzer, int expectedExitCode,
211             String... warnings) {
212         analyzer.shouldHaveExitValue(expectedExitCode);
213         int count = 0;
214         for (String warning : warnings) {
215             if (warning.startsWith(&quot;!&quot;)) {
216                 analyzer.shouldNotContain(warning.substring(1));
217             } else {
218                 count++;
219                 analyzer.shouldContain(warning);
220             }
221         }
222         if (count &gt; 0) {
223             analyzer.shouldMatch(WARNING_OR_ERROR);
224         }
225         if (expectedExitCode == 0) {
226             analyzer.shouldContain(JAR_VERIFIED);
227         } else {
228             analyzer.shouldContain(JAR_VERIFIED_WITH_SIGNER_ERRORS);
229         }
230     }
231 
232     protected void checkSigning(OutputAnalyzer analyzer, String... warnings) {
233         analyzer.shouldHaveExitValue(0);
234         int count = 0;
235         for (String warning : warnings) {
236             if (warning.startsWith(&quot;!&quot;)) {
237                 analyzer.shouldNotContain(warning.substring(1));
238             } else {
239                 count++;
240                 analyzer.shouldContain(warning);
241             }
242         }
243         if (count &gt; 0) {
244             analyzer.shouldMatch(WARNING_OR_ERROR);
245         }
246         analyzer.shouldContain(JAR_SIGNED);
247     }
248 
249     protected OutputAnalyzer keytool(String... cmd) throws Throwable {
250         return tool(KEYTOOL, cmd);
251     }
252 
253     protected OutputAnalyzer jarsigner(String... cmd) throws Throwable {
254         return tool(JARSIGNER, cmd);
255     }
256 
257     private OutputAnalyzer tool(String tool, String... args) throws Throwable {
258         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
259         cmd.add(tool);
260         cmd.add(&quot;-J-Duser.language=en&quot;);
261         cmd.add(&quot;-J-Duser.country=US&quot;);
262         cmd.addAll(Arrays.asList(args));
263         return ProcessTools.executeCommand(cmd.toArray(new String[cmd.size()]));
264     }
265 }
    </pre>
  </body>
</html>