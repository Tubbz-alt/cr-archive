<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/jarsigner/compatibility/Compatibility.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<a name="2" id="anc2"></a><span class="line-modified">  26  * @bug 8217375</span>
<span class="line-added">  27  * @summary This test is used to verify the compatibility of jarsigner across</span>
  28  *     different JDK releases. It also can be used to check jar signing (w/
<a name="3" id="anc3"></a><span class="line-modified">  29  *     and w/o TSA) and to verify some specific signing and digest algorithms.</span>
<span class="line-modified">  30  *     Note that this is a manual test. For more details about the test and</span>
<span class="line-modified">  31  *     its usages, please look through the README.</span>

  32  *
<a name="4" id="anc4"></a><span class="line-modified">  33  * @library /test/lib ../warnings</span>





  34  * @compile -source 1.7 -target 1.7 JdkUtils.java
  35  * @run main/manual/othervm Compatibility
  36  */
  37 
<a name="5" id="anc5"></a><span class="line-added">  38 import static java.nio.charset.StandardCharsets.UTF_8;</span>
<span class="line-added">  39 </span>
  40 import java.io.BufferedReader;
  41 import java.io.File;
<a name="6" id="anc6"></a><span class="line-added">  42 import java.io.FileOutputStream;</span>
  43 import java.io.FileReader;
  44 import java.io.FileWriter;
  45 import java.io.IOException;
<a name="7" id="anc7"></a><span class="line-added">  46 import java.io.OutputStream;</span>
  47 import java.io.PrintStream;
<a name="8" id="anc8"></a><span class="line-added">  48 import java.nio.file.Files;</span>
<span class="line-added">  49 import java.nio.file.Path;</span>
  50 import java.text.DateFormat;
  51 import java.text.SimpleDateFormat;
  52 import java.util.ArrayList;
<a name="9" id="anc9"></a><span class="line-added">  53 import java.util.Arrays;</span>
  54 import java.util.Calendar;
  55 import java.util.Date;
  56 import java.util.HashMap;
  57 import java.util.HashSet;
  58 import java.util.List;
<a name="10" id="anc10"></a><span class="line-added">  59 import java.util.Locale;</span>
  60 import java.util.Map;
  61 import java.util.Set;
  62 import java.util.concurrent.TimeUnit;
<a name="11" id="anc11"></a><span class="line-modified">  63 import java.util.function.Consumer;</span>
<span class="line-modified">  64 import java.util.function.Function;</span>
<span class="line-added">  65 import java.util.jar.Attributes.Name;</span>
<span class="line-added">  66 import java.util.jar.Manifest;</span>
<span class="line-added">  67 import java.util.stream.Collectors;</span>
<span class="line-added">  68 import java.util.stream.IntStream;</span>
  69 
  70 import jdk.test.lib.process.OutputAnalyzer;
  71 import jdk.test.lib.process.ProcessTools;
  72 import jdk.test.lib.util.JarUtils;
  73 
  74 public class Compatibility {
  75 
<a name="12" id="anc12"></a>

  76     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
  77     private static final String TEST_CLASSES = System.getProperty(&quot;test.classes&quot;);
  78     private static final String TEST_JDK = System.getProperty(&quot;test.jdk&quot;);
<a name="13" id="anc13"></a><span class="line-modified">  79     private static JdkInfo TEST_JDK_INFO;</span>
  80 
  81     private static final String PROXY_HOST = System.getProperty(&quot;proxyHost&quot;);
  82     private static final String PROXY_PORT = System.getProperty(&quot;proxyPort&quot;, &quot;80&quot;);
  83 
  84     // An alternative security properties file.
  85     // The test provides a default one, which only contains two lines:
  86     // jdk.certpath.disabledAlgorithms=MD2, MD5
  87     // jdk.jar.disabledAlgorithms=MD2, MD5
  88     private static final String JAVA_SECURITY = System.getProperty(
  89             &quot;javaSecurityFile&quot;, TEST_SRC + &quot;/java.security&quot;);
  90 
  91     private static final String PASSWORD = &quot;testpass&quot;;
<a name="14" id="anc14"></a><span class="line-modified">  92     private static final String KEYSTORE = &quot;testKeystore.jks&quot;;</span>
  93 
  94     private static final String RSA = &quot;RSA&quot;;
  95     private static final String DSA = &quot;DSA&quot;;
  96     private static final String EC = &quot;EC&quot;;
<a name="15" id="anc15"></a><span class="line-modified">  97     private static String[] KEY_ALGORITHMS;</span>
<span class="line-added">  98     private static final String[] DEFAULT_KEY_ALGORITHMS = new String[] {</span>
  99             RSA,
 100             DSA,
 101             EC};
 102 
 103     private static final String SHA1 = &quot;SHA-1&quot;;
 104     private static final String SHA256 = &quot;SHA-256&quot;;
<a name="16" id="anc16"></a><span class="line-added"> 105     private static final String SHA384 = &quot;SHA-384&quot;;</span>
 106     private static final String SHA512 = &quot;SHA-512&quot;;
 107     private static final String DEFAULT = &quot;DEFAULT&quot;;
<a name="17" id="anc17"></a><span class="line-modified"> 108     private static String[] DIGEST_ALGORITHMS;</span>
<span class="line-added"> 109     private static final String[] DEFAULT_DIGEST_ALGORITHMS = new String[] {</span>
 110             SHA1,
 111             SHA256,
<a name="18" id="anc18"></a><span class="line-modified"> 112             SHA384,</span>
<span class="line-added"> 113             SHA512, // note: digests break onto continuation line in manifest</span>
 114             DEFAULT};
 115 
<a name="19" id="anc19"></a><span class="line-modified"> 116     private static final boolean[] EXPIRED =</span>
<span class="line-modified"> 117             Boolean.valueOf(System.getProperty(&quot;expired&quot;, &quot;true&quot;)) ?</span>
<span class="line-modified"> 118                     new boolean[] { false, true } : new boolean[] { false };</span>
<span class="line-added"> 119 </span>
<span class="line-added"> 120     private static final boolean TEST_COMPREHENSIVE_JAR_CONTENTS =</span>
<span class="line-added"> 121             Boolean.valueOf(System.getProperty(</span>
<span class="line-added"> 122                     &quot;testComprehensiveJarContents&quot;, &quot;false&quot;));</span>
<span class="line-added"> 123 </span>
<span class="line-added"> 124     private static final boolean TEST_JAR_UPDATE =</span>
<span class="line-added"> 125             Boolean.valueOf(System.getProperty(&quot;testJarUpdate&quot;, &quot;false&quot;));</span>
<span class="line-added"> 126 </span>
<span class="line-added"> 127     private static final boolean STRICT =</span>
<span class="line-added"> 128             Boolean.valueOf(System.getProperty(&quot;strict&quot;, &quot;false&quot;));</span>
 129 
 130     private static final Calendar CALENDAR = Calendar.getInstance();
 131     private static final DateFormat DATE_FORMAT
 132             = new SimpleDateFormat(&quot;yyyy/MM/dd HH:mm:ss&quot;);
 133 
 134     // The certificate validity period in minutes. The default value is 1440
 135     // minutes, namely 1 day.
 136     private static final int CERT_VALIDITY
 137             = Integer.valueOf(System.getProperty(&quot;certValidity&quot;, &quot;1440&quot;));
 138     static {
 139         if (CERT_VALIDITY &lt; 1 || CERT_VALIDITY &gt; 1440) {
 140             throw new RuntimeException(
<a name="20" id="anc20"></a><span class="line-modified"> 141                     &quot;certValidity out of range [1, 1440]: &quot; + CERT_VALIDITY);</span>
 142         }
 143     }
 144 
 145     // If true, an additional verifying will be triggered after all of
 146     // valid certificates expire. The default value is false.
 147     public static final boolean DELAY_VERIFY
 148             = Boolean.valueOf(System.getProperty(&quot;delayVerify&quot;, &quot;false&quot;));
 149 
 150     private static long lastCertStartTime;
 151 
 152     private static DetailsOutputStream detailsOutput;
 153 
<a name="21" id="anc21"></a><span class="line-modified"> 154     private static int sigfileCounter;</span>
<span class="line-added"> 155 </span>
<span class="line-added"> 156     private static String nextSigfileName(String alias, String u, String s) {</span>
<span class="line-added"> 157         String sigfileName = &quot;&quot; + (++sigfileCounter);</span>
<span class="line-added"> 158         System.out.println(&quot;using sigfile &quot; + sigfileName + &quot; for alias &quot;</span>
<span class="line-added"> 159                     + alias + &quot; signing &quot; + u + &quot;.jar to &quot; + s + &quot;.jar&quot;);</span>
<span class="line-added"> 160         return sigfileName;</span>
<span class="line-added"> 161     }</span>
<span class="line-added"> 162 </span>
<span class="line-added"> 163     public static void main(String... args) throws Throwable {</span>
 164         // Backups stdout and stderr.
 165         PrintStream origStdOut = System.out;
 166         PrintStream origStdErr = System.err;
 167 
<a name="22" id="anc22"></a><span class="line-modified"> 168         detailsOutput = new DetailsOutputStream(outfile());</span>
 169 
 170         // Redirects the system output to a custom one.
 171         PrintStream printStream = new PrintStream(detailsOutput);
 172         System.setOut(printStream);
 173         System.setErr(printStream);
 174 
<a name="23" id="anc23"></a><span class="line-modified"> 175         TEST_JDK_INFO = new JdkInfo(TEST_JDK);</span>



 176 
<a name="24" id="anc24"></a><span class="line-added"> 177         List&lt;TsaInfo&gt; tsaList = tsaInfoList();</span>
 178         List&lt;JdkInfo&gt; jdkInfoList = jdkInfoList();
 179         List&lt;CertInfo&gt; certList = createCertificates(jdkInfoList);
<a name="25" id="anc25"></a><span class="line-modified"> 180         List&lt;SignItem&gt; signItems =</span>
<span class="line-modified"> 181                 test(jdkInfoList, tsaList, certList, createJars());</span>
 182 
<a name="26" id="anc26"></a><span class="line-modified"> 183         boolean failed = generateReport(jdkInfoList, tsaList, signItems);</span>
 184 
 185         // Restores the original stdout and stderr.
 186         System.setOut(origStdOut);
 187         System.setErr(origStdErr);
 188 
 189         if (failed) {
 190             throw new RuntimeException(&quot;At least one test case failed. &quot;
 191                     + &quot;Please check the failed row(s) in report.html &quot;
 192                     + &quot;or failedReport.html.&quot;);
 193         }
 194     }
 195 
<a name="27" id="anc27"></a><span class="line-modified"> 196     private static SignItem createJarFile(String jar, Manifest m,</span>
<span class="line-modified"> 197             String... files) throws IOException {</span>
<span class="line-modified"> 198         JarUtils.createJarFile(Path.of(jar), m, Path.of(&quot;.&quot;),</span>
<span class="line-modified"> 199                 Arrays.stream(files).map(Path::of).toArray(Path[]::new));</span>
<span class="line-modified"> 200         return SignItem.build()</span>
<span class="line-added"> 201                 .signedJar(jar.replaceAll(&quot;[.]jar$&quot;, &quot;&quot;))</span>
<span class="line-added"> 202             .addContentFiles(Arrays.stream(files).collect(Collectors.toList()));</span>
<span class="line-added"> 203     }</span>
<span class="line-added"> 204 </span>
<span class="line-added"> 205     private static String createDummyFile(String name) throws IOException {</span>
<span class="line-added"> 206         if (name.contains(&quot;/&quot;)) new File(name).getParentFile().mkdir();</span>
<span class="line-added"> 207         try (OutputStream fos = new FileOutputStream(name)) {</span>
<span class="line-added"> 208             fos.write(name.getBytes(UTF_8));</span>
<span class="line-added"> 209         }</span>
<span class="line-added"> 210         return name;</span>
<span class="line-added"> 211     }</span>
<span class="line-added"> 212 </span>
<span class="line-added"> 213     // Creates one or more jar files to test</span>
<span class="line-added"> 214     private static List&lt;SignItem&gt; createJars() throws IOException {</span>
<span class="line-added"> 215         List&lt;SignItem&gt; jarList = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 216 </span>
<span class="line-added"> 217         Manifest m = new Manifest();</span>
<span class="line-added"> 218         m.getMainAttributes().put(Name.MANIFEST_VERSION, &quot;1.0&quot;);</span>
<span class="line-added"> 219 </span>
<span class="line-added"> 220         // creates a jar file that contains a dummy file</span>
<span class="line-added"> 221         jarList.add(createJarFile(&quot;test.jar&quot;, m, createDummyFile(&quot;dummy&quot;)));</span>
<span class="line-added"> 222 </span>
<span class="line-added"> 223         if (TEST_COMPREHENSIVE_JAR_CONTENTS) {</span>
<span class="line-added"> 224 </span>
<span class="line-added"> 225             // empty jar file so that jarsigner will add a default manifest</span>
<span class="line-added"> 226             jarList.add(createJarFile(&quot;empty.jar&quot;, m));</span>
<span class="line-added"> 227 </span>
<span class="line-added"> 228             // jar file that contains only an empty manifest with empty main</span>
<span class="line-added"> 229             // attributes (due to missing &quot;Manifest-Version&quot; header)</span>
<span class="line-added"> 230             JarUtils.createJar(&quot;nomainatts.jar&quot;);</span>
<span class="line-added"> 231             jarList.add(SignItem.build().signedJar(&quot;nomainatts&quot;));</span>
<span class="line-added"> 232 </span>
<span class="line-added"> 233             // creates a jar file that contains several files.</span>
<span class="line-added"> 234             jarList.add(createJarFile(&quot;files.jar&quot;, m,</span>
<span class="line-added"> 235                     IntStream.range(1, 9).boxed().map(i -&gt; {</span>
<span class="line-added"> 236                         try {</span>
<span class="line-added"> 237                             return createDummyFile(&quot;dummy&quot; + i);</span>
<span class="line-added"> 238                         } catch (IOException e) {</span>
<span class="line-added"> 239                             throw new RuntimeException(e);</span>
<span class="line-added"> 240                         }</span>
<span class="line-added"> 241                     }).toArray(String[]::new)</span>
<span class="line-added"> 242             ));</span>
<span class="line-added"> 243 </span>
<span class="line-added"> 244             // forces a line break by exceeding the line width limit of 72 bytes</span>
<span class="line-added"> 245             // in the filename and hence manifest entry name</span>
<span class="line-added"> 246             jarList.add(createJarFile(&quot;longfilename.jar&quot;, m,</span>
<span class="line-added"> 247                     createDummyFile(&quot;test&quot;.repeat(20))));</span>
<span class="line-added"> 248 </span>
<span class="line-added"> 249             // another interesting case is with different digest algorithms</span>
<span class="line-added"> 250             // resulting in digests broken across line breaks onto continuation</span>
<span class="line-added"> 251             // lines. these however are set with the &#39;digestAlgs&#39; option or</span>
<span class="line-added"> 252             // include all digest algorithms by default, see SignTwice.java.</span>
<span class="line-added"> 253         }</span>
<span class="line-added"> 254 </span>
<span class="line-added"> 255         return jarList;</span>
<span class="line-added"> 256     }</span>
<span class="line-added"> 257 </span>
<span class="line-added"> 258     // updates a signed jar file by adding another file</span>
<span class="line-added"> 259     private static List&lt;SignItem&gt; updateJar(SignItem prev) throws IOException {</span>
<span class="line-added"> 260         List&lt;SignItem&gt; jarList = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 261 </span>
<span class="line-added"> 262         // sign unmodified jar again</span>
<span class="line-added"> 263         Files.copy(Path.of(prev.signedJar + &quot;.jar&quot;),</span>
<span class="line-added"> 264                 Path.of(prev.signedJar + &quot;-signagainunmodified.jar&quot;));</span>
<span class="line-added"> 265         jarList.add(SignItem.build(prev)</span>
<span class="line-added"> 266                 .signedJar(prev.signedJar + &quot;-signagainunmodified&quot;));</span>
<span class="line-added"> 267 </span>
<span class="line-added"> 268         String oldJar = prev.signedJar;</span>
<span class="line-added"> 269         String newJar = oldJar + &quot;-addfile&quot;;</span>
<span class="line-added"> 270         String triggerUpdateFile = &quot;addfile&quot;;</span>
<span class="line-added"> 271         JarUtils.updateJar(oldJar + &quot;.jar&quot;, newJar + &quot;.jar&quot;, triggerUpdateFile);</span>
<span class="line-added"> 272         jarList.add(SignItem.build(prev).signedJar(newJar)</span>
<span class="line-added"> 273                 .addContentFiles(Arrays.asList(triggerUpdateFile)));</span>
<span class="line-added"> 274 </span>
<span class="line-added"> 275         return jarList;</span>
 276     }
 277 
 278     // Creates a key store that includes a set of valid/expired certificates
 279     // with various algorithms.
 280     private static List&lt;CertInfo&gt; createCertificates(List&lt;JdkInfo&gt; jdkInfoList)
 281             throws Throwable {
<a name="28" id="anc28"></a><span class="line-modified"> 282         List&lt;CertInfo&gt; certList = new ArrayList&lt;&gt;();</span>
<span class="line-modified"> 283         Set&lt;String&gt; expiredCertFilter = new HashSet&lt;&gt;();</span>
<span class="line-modified"> 284 </span>
<span class="line-modified"> 285         for (JdkInfo jdkInfo : jdkInfoList) {</span>
<span class="line-modified"> 286             for (String keyAlgorithm : keyAlgs()) {</span>
<span class="line-modified"> 287                 if (!jdkInfo.supportsKeyAlg(keyAlgorithm)) continue;</span>
<span class="line-modified"> 288                 for (int keySize : keySizes(keyAlgorithm)) {</span>
<span class="line-added"> 289                     for (String digestAlgorithm : digestAlgs()) {</span>
 290                         for(boolean expired : EXPIRED) {
 291                             // It creates only one expired certificate for one
 292                             // key algorithm.
 293                             if (expired
 294                                     &amp;&amp; !expiredCertFilter.add(keyAlgorithm)) {
 295                                 continue;
 296                             }
 297 
 298                             CertInfo certInfo = new CertInfo(
<a name="29" id="anc29"></a><span class="line-modified"> 299                                     jdkInfo,</span>
 300                                     keyAlgorithm,
 301                                     digestAlgorithm,
 302                                     keySize,
 303                                     expired);
<a name="30" id="anc30"></a><span class="line-modified"> 304                             // If the signature algorithm is not supported by the</span>
<span class="line-modified"> 305                             // JDK, it cannot try to sign jar with this algorithm.</span>
<span class="line-modified"> 306                             String sigalg = certInfo.sigalg();</span>
<span class="line-modified"> 307                             if (sigalg != null &amp;&amp;</span>
<span class="line-modified"> 308                                     !jdkInfo.isSupportedSigalg(sigalg)) {</span>
<span class="line-modified"> 309                                 continue;</span>
 310                             }
<a name="31" id="anc31"></a><span class="line-added"> 311                             createCertificate(jdkInfo, certInfo);</span>
<span class="line-added"> 312                             certList.add(certInfo);</span>
 313                         }
 314                     }
 315                 }
 316             }
 317         }
 318 
<a name="32" id="anc32"></a><span class="line-added"> 319         System.out.println(&quot;the keystore contents:&quot;);</span>
<span class="line-added"> 320         for (JdkInfo jdkInfo : jdkInfoList) {</span>
<span class="line-added"> 321             execTool(jdkInfo.jdkPath + &quot;/bin/keytool&quot;, new String[] {</span>
<span class="line-added"> 322                     &quot;-v&quot;,</span>
<span class="line-added"> 323                     &quot;-storetype&quot;,</span>
<span class="line-added"> 324                     &quot;jks&quot;,</span>
<span class="line-added"> 325                     &quot;-storepass&quot;,</span>
<span class="line-added"> 326                     PASSWORD,</span>
<span class="line-added"> 327                     &quot;-keystore&quot;,</span>
<span class="line-added"> 328                     KEYSTORE,</span>
<span class="line-added"> 329                     &quot;-list&quot;</span>
<span class="line-added"> 330             });</span>
<span class="line-added"> 331         }</span>
<span class="line-added"> 332 </span>
 333         return certList;
 334     }
 335 
 336     // Creates/Updates a key store that adds a certificate with specific algorithm.
<a name="33" id="anc33"></a><span class="line-modified"> 337     private static void createCertificate(JdkInfo jdkInfo, CertInfo certInfo)</span>
 338             throws Throwable {
<a name="34" id="anc34"></a><span class="line-modified"> 339         List&lt;String&gt; arguments = new ArrayList&lt;&gt;();</span>


 340         arguments.add(&quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY);
 341         arguments.add(&quot;-v&quot;);
<a name="35" id="anc35"></a><span class="line-added"> 342         arguments.add(&quot;-debug&quot;);</span>
 343         arguments.add(&quot;-storetype&quot;);
 344         arguments.add(&quot;jks&quot;);
<a name="36" id="anc36"></a><span class="line-modified"> 345         arguments.add(&quot;-keystore&quot;);</span>
<span class="line-added"> 346         arguments.add(KEYSTORE);</span>
<span class="line-added"> 347         arguments.add(&quot;-storepass&quot;);</span>
<span class="line-added"> 348         arguments.add(PASSWORD);</span>
<span class="line-added"> 349         arguments.add(jdkInfo.majorVersion &lt; 6 ? &quot;-genkey&quot; : &quot;-genkeypair&quot;);</span>
 350         arguments.add(&quot;-keyalg&quot;);
 351         arguments.add(certInfo.keyAlgorithm);
<a name="37" id="anc37"></a><span class="line-modified"> 352         String sigalg = certInfo.sigalg();</span>
 353         if (sigalg != null) {
 354             arguments.add(&quot;-sigalg&quot;);
 355             arguments.add(sigalg);
 356         }
 357         if (certInfo.keySize != 0) {
 358             arguments.add(&quot;-keysize&quot;);
 359             arguments.add(certInfo.keySize + &quot;&quot;);
 360         }
 361         arguments.add(&quot;-dname&quot;);
<a name="38" id="anc38"></a><span class="line-modified"> 362         arguments.add(&quot;CN=&quot; + certInfo);</span>
 363         arguments.add(&quot;-alias&quot;);
<a name="39" id="anc39"></a><span class="line-modified"> 364         arguments.add(certInfo.alias());</span>
 365         arguments.add(&quot;-keypass&quot;);
 366         arguments.add(PASSWORD);
<a name="40" id="anc40"></a>

 367 
 368         arguments.add(&quot;-startdate&quot;);
 369         arguments.add(startDate(certInfo.expired));
 370         arguments.add(&quot;-validity&quot;);
<a name="41" id="anc41"></a><span class="line-added"> 371 //        arguments.add(DELAY_VERIFY ? &quot;1&quot; : &quot;222&quot;); // &gt; six months no warn</span>
 372         arguments.add(&quot;1&quot;);
<a name="42" id="anc42"></a>

 373 
 374         OutputAnalyzer outputAnalyzer = execTool(
<a name="43" id="anc43"></a><span class="line-modified"> 375                 jdkInfo.jdkPath + &quot;/bin/keytool&quot;,</span>
 376                 arguments.toArray(new String[arguments.size()]));
<a name="44" id="anc44"></a><span class="line-modified"> 377         if (outputAnalyzer.getExitValue() != 0</span>
<span class="line-modified"> 378                 || outputAnalyzer.getOutput().matches(&quot;[Ee]xception&quot;)</span>
<span class="line-modified"> 379                 || outputAnalyzer.getOutput().matches(Test.ERROR + &quot; ?&quot;)) {</span>
<span class="line-modified"> 380             System.out.println(outputAnalyzer.getOutput());</span>
<span class="line-modified"> 381             throw new Exception(&quot;error generating a key pair: &quot; + arguments);</span>
 382         }
 383     }
 384 
<a name="45" id="anc45"></a>








 385     // The validity period of a certificate always be 1 day. For creating an
 386     // expired certificate, the start date is the time before 1 day, then the
 387     // certificate expires immediately. And for creating a valid certificate,
 388     // the start date is the time before (1 day - CERT_VALIDITY minutes), then
 389     // the certificate will expires in CERT_VALIDITY minutes.
 390     private static String startDate(boolean expiredCert) {
 391         CALENDAR.setTime(new Date());
<a name="46" id="anc46"></a><span class="line-modified"> 392         if (DELAY_VERIFY || expiredCert) {</span>
<span class="line-modified"> 393             // corresponds to &#39;-validity 1&#39;</span>
<span class="line-added"> 394             CALENDAR.add(Calendar.DAY_OF_MONTH, -1);</span>
<span class="line-added"> 395         }</span>
<span class="line-added"> 396         if (DELAY_VERIFY &amp;&amp; !expiredCert) {</span>
 397             CALENDAR.add(Calendar.MINUTE, CERT_VALIDITY);
 398         }
 399         Date startDate = CALENDAR.getTime();
<a name="47" id="anc47"></a><span class="line-modified"> 400         if (!expiredCert) {</span>
<span class="line-added"> 401             lastCertStartTime = startDate.getTime();</span>
<span class="line-added"> 402         }</span>
 403         return DATE_FORMAT.format(startDate);
 404     }
 405 
<a name="48" id="anc48"></a><span class="line-modified"> 406     private static String outfile() {</span>
<span class="line-modified"> 407         return System.getProperty(&quot;o&quot;);</span>
<span class="line-added"> 408     }</span>
<span class="line-added"> 409 </span>
<span class="line-added"> 410     // Retrieves JDK info from the file which is specified by property</span>
<span class="line-added"> 411     // jdkListFile, or from property jdkList if jdkListFile is not available.</span>
 412     private static List&lt;JdkInfo&gt; jdkInfoList() throws Throwable {
 413         String[] jdkList = list(&quot;jdkList&quot;);
 414         if (jdkList.length == 0) {
<a name="49" id="anc49"></a><span class="line-modified"> 415             jdkList = new String[] { &quot;TEST_JDK&quot; };</span>
 416         }
 417 
<a name="50" id="anc50"></a><span class="line-modified"> 418         List&lt;JdkInfo&gt; jdkInfoList = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 419         int index = 0;</span>
 420         for (String jdkPath : jdkList) {
<a name="51" id="anc51"></a><span class="line-modified"> 421             JdkInfo jdkInfo = &quot;TEST_JDK&quot;.equalsIgnoreCase(jdkPath) ?</span>
<span class="line-added"> 422                     TEST_JDK_INFO : new JdkInfo(jdkPath);</span>
 423             // The JDK version must be unique.
 424             if (!jdkInfoList.contains(jdkInfo)) {
<a name="52" id="anc52"></a><span class="line-added"> 425                 jdkInfo.index = index++;</span>
<span class="line-added"> 426                 jdkInfo.version = String.format(</span>
<span class="line-added"> 427                         &quot;%s(%d)&quot;, jdkInfo.version, jdkInfo.index);</span>
 428                 jdkInfoList.add(jdkInfo);
 429             } else {
 430                 System.out.println(&quot;The JDK version is duplicate: &quot; + jdkPath);
 431             }
 432         }
 433         return jdkInfoList;
 434     }
 435 
<a name="53" id="anc53"></a><span class="line-added"> 436     private static List&lt;String&gt; keyAlgs() throws IOException {</span>
<span class="line-added"> 437         if (KEY_ALGORITHMS == null) KEY_ALGORITHMS = list(&quot;keyAlgs&quot;);</span>
<span class="line-added"> 438         if (KEY_ALGORITHMS.length == 0)</span>
<span class="line-added"> 439             return Arrays.asList(DEFAULT_KEY_ALGORITHMS);</span>
<span class="line-added"> 440         return Arrays.stream(KEY_ALGORITHMS).map(a -&gt; a.split(&quot;;&quot;)[0])</span>
<span class="line-added"> 441                 .collect(Collectors.toList());</span>
<span class="line-added"> 442     }</span>
<span class="line-added"> 443 </span>
<span class="line-added"> 444     // Return key sizes according to the specified key algorithm.</span>
<span class="line-added"> 445     private static int[] keySizes(String keyAlgorithm) throws IOException {</span>
<span class="line-added"> 446         if (KEY_ALGORITHMS == null) KEY_ALGORITHMS = list(&quot;keyAlgs&quot;);</span>
<span class="line-added"> 447         for (String keyAlg : KEY_ALGORITHMS) {</span>
<span class="line-added"> 448             String[] split = (keyAlg + &quot; &quot;).split(&quot;;&quot;);</span>
<span class="line-added"> 449             if (keyAlgorithm.equals(split[0].trim()) &amp;&amp; split.length &gt; 1) {</span>
<span class="line-added"> 450                 int sizes[] = new int[split.length - 1];</span>
<span class="line-added"> 451                 for (int i = 1; i &lt;= sizes.length; i++)</span>
<span class="line-added"> 452                     sizes[i - 1] = split[i].isBlank() ? 0 : // default</span>
<span class="line-added"> 453                         Integer.parseInt(split[i].trim());</span>
<span class="line-added"> 454                 return sizes;</span>
<span class="line-added"> 455             }</span>
<span class="line-added"> 456         }</span>
<span class="line-added"> 457 </span>
<span class="line-added"> 458         // defaults</span>
<span class="line-added"> 459         if (RSA.equals(keyAlgorithm) || DSA.equals(keyAlgorithm)) {</span>
<span class="line-added"> 460             return new int[] { 1024, 2048, 0 }; // 0 is no keysize specified</span>
<span class="line-added"> 461         } else if (EC.equals(keyAlgorithm)) {</span>
<span class="line-added"> 462             return new int[] { 384, 571, 0 }; // 0 is no keysize specified</span>
<span class="line-added"> 463         } else {</span>
<span class="line-added"> 464             throw new RuntimeException(&quot;problem determining key sizes&quot;);</span>
<span class="line-added"> 465         }</span>
<span class="line-added"> 466     }</span>
<span class="line-added"> 467 </span>
<span class="line-added"> 468     private static List&lt;String&gt; digestAlgs() throws IOException {</span>
<span class="line-added"> 469         if (DIGEST_ALGORITHMS == null) DIGEST_ALGORITHMS = list(&quot;digestAlgs&quot;);</span>
<span class="line-added"> 470         if (DIGEST_ALGORITHMS.length == 0)</span>
<span class="line-added"> 471             return Arrays.asList(DEFAULT_DIGEST_ALGORITHMS);</span>
<span class="line-added"> 472         return Arrays.asList(DIGEST_ALGORITHMS);</span>
<span class="line-added"> 473     }</span>
<span class="line-added"> 474 </span>
 475     // Retrieves TSA info from the file which is specified by property tsaListFile,
 476     // or from property tsaList if tsaListFile is not available.
 477     private static List&lt;TsaInfo&gt; tsaInfoList() throws IOException {
 478         String[] tsaList = list(&quot;tsaList&quot;);
 479 
<a name="54" id="anc54"></a><span class="line-modified"> 480         List&lt;TsaInfo&gt; tsaInfoList = new ArrayList&lt;&gt;();</span>
 481         for (int i = 0; i &lt; tsaList.length; i++) {
 482             String[] values = tsaList[i].split(&quot;;digests=&quot;);
 483 
 484             String[] digests = new String[0];
 485             if (values.length == 2) {
 486                 digests = values[1].split(&quot;,&quot;);
 487             }
 488 
<a name="55" id="anc55"></a><span class="line-modified"> 489             String tsaUrl = values[0];</span>
<span class="line-modified"> 490             if (tsaUrl.isEmpty() || tsaUrl.equalsIgnoreCase(&quot;notsa&quot;)) {</span>
<span class="line-added"> 491                 tsaUrl = null;</span>
<span class="line-added"> 492             }</span>
<span class="line-added"> 493             TsaInfo bufTsa = new TsaInfo(i, tsaUrl);</span>
 494             for (String digest : digests) {
<a name="56" id="anc56"></a><span class="line-modified"> 495                 bufTsa.addDigest(digest.toUpperCase());</span>
 496             }
<a name="57" id="anc57"></a>
 497             tsaInfoList.add(bufTsa);
 498         }
 499 
<a name="58" id="anc58"></a><span class="line-added"> 500         if (tsaInfoList.size() == 0) {</span>
<span class="line-added"> 501             throw new RuntimeException(&quot;TSA service is mandatory unless &quot;</span>
<span class="line-added"> 502                     + &quot;&#39;notsa&#39; specified explicitly.&quot;);</span>
<span class="line-added"> 503         }</span>
 504         return tsaInfoList;
 505     }
 506 
<a name="59" id="anc59"></a><span class="line-modified"> 507     private static String[] list(String listProp) throws IOException {</span>

 508         String listFileProp = listProp + &quot;File&quot;;
 509         String listFile = System.getProperty(listFileProp);
 510         if (!isEmpty(listFile)) {
 511             System.out.println(listFileProp + &quot;=&quot; + listFile);
<a name="60" id="anc60"></a><span class="line-modified"> 512             List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
 513             BufferedReader reader = new BufferedReader(
 514                     new FileReader(listFile));
 515             String line;
 516             while ((line = reader.readLine()) != null) {
 517                 String item = line.trim();
 518                 if (!item.isEmpty()) {
 519                     list.add(item);
 520                 }
 521             }
 522             reader.close();
 523             return list.toArray(new String[list.size()]);
 524         }
 525 
 526         String list = System.getProperty(listProp);
 527         System.out.println(listProp + &quot;=&quot; + list);
 528         return !isEmpty(list) ? list.split(&quot;#&quot;) : new String[0];
 529     }
 530 
 531     private static boolean isEmpty(String str) {
 532         return str == null || str.isEmpty();
 533     }
 534 
 535     // A JDK (signer) signs a jar with a variety of algorithms, and then all of
 536     // JDKs (verifiers), including the signer itself, try to verify the signed
 537     // jars respectively.
 538     private static List&lt;SignItem&gt; test(List&lt;JdkInfo&gt; jdkInfoList,
<a name="61" id="anc61"></a><span class="line-modified"> 539             List&lt;TsaInfo&gt; tsaInfoList, List&lt;CertInfo&gt; certList,</span>
<span class="line-modified"> 540             List&lt;SignItem&gt; jars) throws Throwable {</span>
 541         detailsOutput.transferPhase();
<a name="62" id="anc62"></a><span class="line-modified"> 542         List&lt;SignItem&gt; signItems = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 543         signItems.addAll(signing(jdkInfoList, tsaInfoList, certList, jars));</span>
<span class="line-added"> 544         if (TEST_JAR_UPDATE) {</span>
<span class="line-added"> 545             signItems.addAll(signing(jdkInfoList, tsaInfoList, certList,</span>
<span class="line-added"> 546                     updating(signItems.stream().filter(</span>
<span class="line-added"> 547                             x -&gt; x.status != Status.ERROR)</span>
<span class="line-added"> 548                     .collect(Collectors.toList()))));</span>
<span class="line-added"> 549         }</span>
 550 
 551         detailsOutput.transferPhase();
 552         for (SignItem signItem : signItems) {
 553             for (JdkInfo verifierInfo : jdkInfoList) {
<a name="63" id="anc63"></a><span class="line-modified"> 554                 if (!verifierInfo.supportsKeyAlg(</span>
<span class="line-modified"> 555                         signItem.certInfo.keyAlgorithm)) continue;</span>
<span class="line-modified"> 556                 VerifyItem verifyItem = VerifyItem.build(verifierInfo);</span>
<span class="line-modified"> 557                 verifyItem.addSignerCertInfos(signItem);</span>
<span class="line-modified"> 558                 signItem.addVerifyItem(verifyItem);</span>
<span class="line-added"> 559                 verifying(signItem, verifyItem);</span>
 560             }
 561         }
 562 
<a name="64" id="anc64"></a><span class="line-added"> 563         // if lastCertExpirationTime passed already now, probably some</span>
<span class="line-added"> 564         // certificate was already expired during jar signature verification</span>
<span class="line-added"> 565         // (jarsigner -verify) and the test should probably be repeated with an</span>
<span class="line-added"> 566         // increased validity period -DcertValidity CERT_VALIDITY</span>
<span class="line-added"> 567         long lastCertExpirationTime = lastCertStartTime + 24 * 60 * 60 * 1000;</span>
<span class="line-added"> 568         if (lastCertExpirationTime &lt; System.currentTimeMillis()) {</span>
<span class="line-added"> 569             throw new AssertionError(&quot;CERT_VALIDITY (&quot; + CERT_VALIDITY</span>
<span class="line-added"> 570                     + &quot; [minutes]) was too short. &quot;</span>
<span class="line-added"> 571                     + &quot;Creating and signing the jars took longer, &quot;</span>
<span class="line-added"> 572                     + &quot;presumably at least &quot;</span>
<span class="line-added"> 573                     + ((lastCertExpirationTime - System.currentTimeMillis())</span>
<span class="line-added"> 574                             / 60 * 1000 + CERT_VALIDITY) + &quot; [minutes].&quot;);</span>
<span class="line-added"> 575         }</span>
<span class="line-added"> 576 </span>
 577         if (DELAY_VERIFY) {
 578             detailsOutput.transferPhase();
 579             System.out.print(&quot;Waiting for delay verifying&quot;);
<a name="65" id="anc65"></a>
 580             while (System.currentTimeMillis() &lt; lastCertExpirationTime) {
 581                 TimeUnit.SECONDS.sleep(30);
 582                 System.out.print(&quot;.&quot;);
 583             }
 584             System.out.println();
 585 
 586             System.out.println(&quot;Delay verifying starts&quot;);
 587             for (SignItem signItem : signItems) {
 588                 for (VerifyItem verifyItem : signItem.verifyItems) {
 589                     verifying(signItem, verifyItem);
 590                 }
 591             }
 592         }
 593 
 594         detailsOutput.transferPhase();
<a name="66" id="anc66"></a>
 595         return signItems;
 596     }
 597 
 598     private static List&lt;SignItem&gt; signing(List&lt;JdkInfo&gt; jdkInfos,
<a name="67" id="anc67"></a><span class="line-modified"> 599             List&lt;TsaInfo&gt; tsaList, List&lt;CertInfo&gt; certList,</span>
<span class="line-modified"> 600             List&lt;SignItem&gt; unsignedJars) throws Throwable {</span>
<span class="line-modified"> 601         List&lt;SignItem&gt; signItems = new ArrayList&lt;&gt;();</span>
<span class="line-modified"> 602 </span>
<span class="line-modified"> 603         for (CertInfo certInfo : certList) {</span>
<span class="line-modified"> 604             JdkInfo signerInfo = certInfo.jdkInfo;</span>
<span class="line-modified"> 605             String keyAlgorithm = certInfo.keyAlgorithm;</span>
<span class="line-modified"> 606             String sigDigestAlgorithm = certInfo.digestAlgorithm;</span>
<span class="line-modified"> 607             int keySize = certInfo.keySize;</span>
<span class="line-modified"> 608             boolean expired = certInfo.expired;</span>
<span class="line-added"> 609 </span>
<span class="line-added"> 610             for (String jarDigestAlgorithm : digestAlgs()) {</span>
<span class="line-added"> 611                 if (DEFAULT.equals(jarDigestAlgorithm)) {</span>
<span class="line-added"> 612                     jarDigestAlgorithm = null;</span>
 613                 }
 614 
<a name="68" id="anc68"></a><span class="line-modified"> 615                 for (TsaInfo tsaInfo : tsaList) {</span>
<span class="line-modified"> 616                     String tsaUrl = tsaInfo.tsaUrl;</span>





 617 
<a name="69" id="anc69"></a><span class="line-added"> 618                     List&lt;String&gt; tsaDigestAlgs = digestAlgs();</span>
<span class="line-added"> 619                     // no point in specifying a tsa digest algorithm</span>
<span class="line-added"> 620                     // for no TSA, except maybe it would issue a warning.</span>
<span class="line-added"> 621                     if (tsaUrl == null) tsaDigestAlgs = Arrays.asList(DEFAULT);</span>
 622                     // If the JDK doesn&#39;t support option -tsadigestalg, the
<a name="70" id="anc70"></a><span class="line-modified"> 623                     // associated cases can just be ignored.</span>
<span class="line-modified"> 624                     if (!signerInfo.supportsTsadigestalg) {</span>
<span class="line-modified"> 625                         tsaDigestAlgs = Arrays.asList(DEFAULT);</span>

 626                     }
<a name="71" id="anc71"></a><span class="line-added"> 627                     for (String tsaDigestAlg : tsaDigestAlgs) {</span>
<span class="line-added"> 628                         if (DEFAULT.equals(tsaDigestAlg)) {</span>
<span class="line-added"> 629                             tsaDigestAlg = null;</span>
<span class="line-added"> 630                         } else if (!tsaInfo.isDigestSupported(tsaDigestAlg)) {</span>
<span class="line-added"> 631                             // It has to ignore the digest algorithm, which</span>
<span class="line-added"> 632                             // is not supported by the TSA server.</span>
<span class="line-added"> 633                             continue;</span>
<span class="line-added"> 634                         }</span>
 635 
<a name="72" id="anc72"></a><span class="line-modified"> 636                         if (tsaUrl != null &amp;&amp; TsaFilter.filter(</span>
<span class="line-modified"> 637                                 signerInfo.version,</span>
<span class="line-modified"> 638                                 tsaDigestAlg,</span>
<span class="line-modified"> 639                                 expired,</span>
<span class="line-modified"> 640                                 tsaInfo.index)) {</span>
<span class="line-modified"> 641                             continue;</span>
<span class="line-modified"> 642                         }</span>
























 643 
<a name="73" id="anc73"></a><span class="line-modified"> 644                         for (SignItem prevSign : unsignedJars) {</span>
<span class="line-modified"> 645                             String unsignedJar = prevSign.signedJar;</span>




 646 
<a name="74" id="anc74"></a><span class="line-modified"> 647                             SignItem signItem = SignItem.build(prevSign)</span>
<span class="line-modified"> 648                                     .certInfo(certInfo)</span>
<span class="line-modified"> 649                                     .jdkInfo(signerInfo);</span>
<span class="line-modified"> 650                             String signedJar = unsignedJar + &quot;-&quot; + &quot;JDK_&quot; + (</span>
<span class="line-added"> 651                                     signerInfo.version + &quot;-CERT_&quot; + certInfo).</span>
<span class="line-added"> 652                                     replaceAll(&quot;[^a-z_0-9A-Z.]+&quot;, &quot;-&quot;);</span>
 653 
<a name="75" id="anc75"></a><span class="line-modified"> 654                             if (jarDigestAlgorithm != null) {</span>
<span class="line-modified"> 655                                 signedJar += &quot;-DIGESTALG_&quot; + jarDigestAlgorithm;</span>
<span class="line-modified"> 656                                 signItem.digestAlgorithm(jarDigestAlgorithm);</span>
<span class="line-modified"> 657                             }</span>
<span class="line-modified"> 658                             if (tsaUrl == null) {</span>
<span class="line-modified"> 659                                 signItem.tsaIndex(-1);</span>
<span class="line-modified"> 660                             } else {</span>
<span class="line-modified"> 661                                 signedJar += &quot;-TSA_&quot; + tsaInfo.index;</span>
<span class="line-modified"> 662                                 signItem.tsaIndex(tsaInfo.index);</span>
<span class="line-modified"> 663                                 if (tsaDigestAlg != null) {</span>
<span class="line-modified"> 664                                     signedJar += &quot;-TSADIGALG_&quot; + tsaDigestAlg;</span>
<span class="line-modified"> 665                                     signItem.tsaDigestAlgorithm(tsaDigestAlg);</span>






























 666                                 }
<a name="76" id="anc76"></a>

 667                             }
<a name="77" id="anc77"></a><span class="line-added"> 668                             signItem.signedJar(signedJar);</span>
<span class="line-added"> 669 </span>
<span class="line-added"> 670                             String signingId = signingId(signItem);</span>
<span class="line-added"> 671                             detailsOutput.writeAnchorName(signingId,</span>
<span class="line-added"> 672                                     &quot;Signing: &quot; + signingId);</span>
<span class="line-added"> 673 </span>
<span class="line-added"> 674                             OutputAnalyzer signOA = signJar(</span>
<span class="line-added"> 675                                     signerInfo.jarsignerPath,</span>
<span class="line-added"> 676                                     certInfo.sigalg(),</span>
<span class="line-added"> 677                                     jarDigestAlgorithm,</span>
<span class="line-added"> 678                                     tsaDigestAlg,</span>
<span class="line-added"> 679                                     tsaUrl,</span>
<span class="line-added"> 680                                     certInfo.alias(),</span>
<span class="line-added"> 681                                     unsignedJar,</span>
<span class="line-added"> 682                                     signedJar);</span>
<span class="line-added"> 683                             Status signingStatus = signingStatus(signOA,</span>
<span class="line-added"> 684                                     tsaUrl != null);</span>
<span class="line-added"> 685                             signItem.status(signingStatus);</span>
<span class="line-added"> 686                             signItems.add(signItem);</span>
 687                         }
 688                     }
 689                 }
 690             }
 691         }
 692 
 693         return signItems;
 694     }
 695 
<a name="78" id="anc78"></a><span class="line-added"> 696     private static List&lt;SignItem&gt; updating(List&lt;SignItem&gt; prevSignItems)</span>
<span class="line-added"> 697             throws IOException {</span>
<span class="line-added"> 698         List&lt;SignItem&gt; updateItems = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 699         for (SignItem prevSign : prevSignItems) {</span>
<span class="line-added"> 700             updateItems.addAll(updateJar(prevSign));</span>
<span class="line-added"> 701         }</span>
<span class="line-added"> 702         return updateItems;</span>
<span class="line-added"> 703     }</span>
<span class="line-added"> 704 </span>
 705     private static void verifying(SignItem signItem, VerifyItem verifyItem)
 706             throws Throwable {
<a name="79" id="anc79"></a><span class="line-modified"> 707         // TODO: how will be ensured that the first verification is not after valid period expired which is only one minute?</span>
<span class="line-modified"> 708         boolean delayVerify = verifyItem.status != Status.NONE;</span>
<span class="line-added"> 709         String verifyingId = verifyingId(signItem, verifyItem, delayVerify);</span>
 710         detailsOutput.writeAnchorName(verifyingId, &quot;Verifying: &quot; + verifyingId);
<a name="80" id="anc80"></a>
 711         OutputAnalyzer verifyOA = verifyJar(verifyItem.jdkInfo.jarsignerPath,
<a name="81" id="anc81"></a><span class="line-modified"> 712                 signItem.signedJar, verifyItem.certInfo == null ? null :</span>
<span class="line-modified"> 713                 verifyItem.certInfo.alias());</span>
<span class="line-modified"> 714         Status verifyingStatus = verifyingStatus(signItem, verifyItem, verifyOA);</span>
<span class="line-modified"> 715 </span>
<span class="line-modified"> 716         try {</span>
<span class="line-modified"> 717             String match = &quot;^  (&quot;</span>
<span class="line-modified"> 718                     + &quot;  Signature algorithm: &quot; + signItem.certInfo.</span>
<span class="line-modified"> 719                             expectedSigalg() + &quot;, &quot; + signItem.certInfo.</span>
<span class="line-modified"> 720                             expectedKeySize() + &quot;-bit key&quot;</span>
<span class="line-modified"> 721                     + &quot;)|(&quot;</span>
<span class="line-modified"> 722                     + &quot;  Digest algorithm: &quot; + signItem.expectedDigestAlg()</span>
<span class="line-modified"> 723                     + (signItem.tsaIndex &lt; 0 ? &quot;&quot; :</span>
<span class="line-modified"> 724                       &quot;)|(&quot;</span>
<span class="line-modified"> 725                     + &quot;Timestamped by \&quot;.+\&quot; on .*&quot;</span>
<span class="line-added"> 726                     + &quot;)|(&quot;</span>
<span class="line-added"> 727                     + &quot;  Timestamp digest algorithm: &quot;</span>
<span class="line-added"> 728                             + signItem.expectedTsaDigestAlg()</span>
<span class="line-added"> 729                     + &quot;)|(&quot;</span>
<span class="line-added"> 730                     + &quot;  Timestamp signature algorithm: .*&quot;</span>
<span class="line-added"> 731                       )</span>
<span class="line-added"> 732                     + &quot;)$&quot;;</span>
<span class="line-added"> 733             verifyOA.stdoutShouldMatchByLine(</span>
<span class="line-added"> 734                     &quot;^- Signed by \&quot;CN=&quot; +  signItem.certInfo.toString()</span>
<span class="line-added"> 735                             .replaceAll(&quot;[.]&quot;, &quot;[.]&quot;) + &quot;\&quot;$&quot;,</span>
<span class="line-added"> 736                     &quot;^(- Signed by \&quot;CN=.+\&quot;)?$&quot;,</span>
<span class="line-added"> 737                     match);</span>
<span class="line-added"> 738         } catch (Throwable e) {</span>
<span class="line-added"> 739             e.printStackTrace();</span>
<span class="line-added"> 740             verifyingStatus = Status.ERROR;</span>
 741         }
 742 
<a name="82" id="anc82"></a><span class="line-modified"> 743         if (!delayVerify) {</span>
<span class="line-modified"> 744             verifyItem.status(verifyingStatus);</span>
 745         } else {
 746             verifyItem.delayStatus(verifyingStatus);
 747         }
<a name="83" id="anc83"></a>
 748 
<a name="84" id="anc84"></a><span class="line-modified"> 749         if (verifyItem.prevVerify != null) {</span>
<span class="line-modified"> 750             verifying(signItem, verifyItem.prevVerify);</span>




 751         }
<a name="85" id="anc85"></a>

 752     }
 753 
 754     // Determines the status of signing.
<a name="86" id="anc86"></a><span class="line-modified"> 755     private static Status signingStatus(OutputAnalyzer outputAnalyzer,</span>
<span class="line-modified"> 756             boolean tsa) {</span>
<span class="line-modified"> 757         if (outputAnalyzer.getExitValue() != 0) {</span>





 758             return Status.ERROR;
 759         }
<a name="87" id="anc87"></a><span class="line-added"> 760         if (!outputAnalyzer.getOutput().contains(Test.JAR_SIGNED)) {</span>
<span class="line-added"> 761             return Status.ERROR;</span>
<span class="line-added"> 762         }</span>
<span class="line-added"> 763 </span>
<span class="line-added"> 764         boolean warning = false;</span>
<span class="line-added"> 765         for (String line : outputAnalyzer.getOutput().lines()</span>
<span class="line-added"> 766                 .toArray(String[]::new)) {</span>
<span class="line-added"> 767             if (line.matches(Test.ERROR + &quot; ?&quot;)) return Status.ERROR;</span>
<span class="line-added"> 768             if (line.matches(Test.WARNING + &quot; ?&quot;)) warning = true;</span>
<span class="line-added"> 769         }</span>
<span class="line-added"> 770         return warning ? Status.WARNING : Status.NORMAL;</span>
 771     }
 772 
 773     // Determines the status of verifying.
<a name="88" id="anc88"></a><span class="line-modified"> 774     private static Status verifyingStatus(SignItem signItem, VerifyItem</span>
<span class="line-modified"> 775             verifyItem, OutputAnalyzer outputAnalyzer) {</span>
<span class="line-modified"> 776         List&lt;String&gt; expectedSignedContent = new ArrayList&lt;&gt;();</span>
<span class="line-modified"> 777         if (verifyItem.certInfo == null) {</span>
<span class="line-modified"> 778             expectedSignedContent.addAll(signItem.jarContents);</span>





 779         } else {
<a name="89" id="anc89"></a><span class="line-added"> 780             SignItem i = signItem;</span>
<span class="line-added"> 781             while (i != null) {</span>
<span class="line-added"> 782                 if (i.certInfo != null &amp;&amp; i.certInfo.equals(verifyItem.certInfo)) {</span>
<span class="line-added"> 783                     expectedSignedContent.addAll(i.jarContents);</span>
<span class="line-added"> 784                 }</span>
<span class="line-added"> 785                 i = i.prevSign;</span>
<span class="line-added"> 786             }</span>
<span class="line-added"> 787         }</span>
<span class="line-added"> 788         List&lt;String&gt; expectedUnsignedContent =</span>
<span class="line-added"> 789                 new ArrayList&lt;&gt;(signItem.jarContents);</span>
<span class="line-added"> 790         expectedUnsignedContent.removeAll(expectedSignedContent);</span>
<span class="line-added"> 791 </span>
<span class="line-added"> 792         int expectedExitCode = !STRICT || expectedUnsignedContent.isEmpty() ? 0 : 32;</span>
<span class="line-added"> 793         if (outputAnalyzer.getExitValue() != expectedExitCode) {</span>
<span class="line-added"> 794             System.out.println(&quot;verifyingStatus: error: exit code != &quot; + expectedExitCode + &quot;: &quot; + outputAnalyzer.getExitValue() + &quot; != &quot; + expectedExitCode);</span>
<span class="line-added"> 795             return Status.ERROR;</span>
<span class="line-added"> 796         }</span>
<span class="line-added"> 797         String expectedSuccessMessage = expectedUnsignedContent.isEmpty() ?</span>
<span class="line-added"> 798                 Test.JAR_VERIFIED : Test.JAR_VERIFIED_WITH_SIGNER_ERRORS;</span>
<span class="line-added"> 799         if (!outputAnalyzer.getOutput().contains(expectedSuccessMessage)) {</span>
<span class="line-added"> 800             System.out.println(&quot;verifyingStatus: error: expectedSuccessMessage not found: &quot; + expectedSuccessMessage);</span>
 801             return Status.ERROR;
 802         }
<a name="90" id="anc90"></a>
 803 
<a name="91" id="anc91"></a><span class="line-modified"> 804         boolean tsa = signItem.tsaIndex &gt;= 0;</span>
<span class="line-modified"> 805         boolean warning = false;</span>
<span class="line-modified"> 806         for (String line : outputAnalyzer.getOutput().lines()</span>
<span class="line-modified"> 807                 .toArray(String[]::new)) {</span>
<span class="line-modified"> 808             if (line.isBlank()) continue;</span>
<span class="line-modified"> 809             if (Test.JAR_VERIFIED.equals(line)) continue;</span>
<span class="line-modified"> 810             if (line.matches(Test.ERROR + &quot; ?&quot;) &amp;&amp; expectedExitCode == 0) {</span>
<span class="line-modified"> 811                 System.out.println(&quot;verifyingStatus: error: line.matches(&quot; + Test.ERROR + &quot;\&quot; ?\&quot;): &quot; + line);</span>
<span class="line-modified"> 812                 return Status.ERROR;</span>
<span class="line-added"> 813             }</span>
<span class="line-added"> 814             if (line.matches(Test.WARNING + &quot; ?&quot;)) {</span>
<span class="line-added"> 815                 warning = true;</span>
<span class="line-added"> 816                 continue;</span>
<span class="line-added"> 817             }</span>
<span class="line-added"> 818             if (!warning) continue;</span>
<span class="line-added"> 819             line = line.strip();</span>
<span class="line-added"> 820             if (Test.NOT_YET_VALID_CERT_SIGNING_WARNING.equals(line)) continue;</span>
<span class="line-added"> 821             if (Test.HAS_EXPIRING_CERT_SIGNING_WARNING.equals(line)) continue;</span>
<span class="line-added"> 822             if (Test.HAS_EXPIRING_CERT_VERIFYING_WARNING.equals(line)) continue;</span>
<span class="line-added"> 823             if (line.matches(&quot;^&quot; + Test.NO_TIMESTAMP_SIGNING_WARN_TEMPLATE</span>
<span class="line-added"> 824                     .replaceAll(</span>
<span class="line-added"> 825                         &quot;\\(%1\\$tY-%1\\$tm-%1\\$td\\)&quot;, &quot;\\\\([^\\\\)]+\\\\)&quot;</span>
<span class="line-added"> 826                         + &quot;( or after any future revocation date)?&quot;)</span>
<span class="line-added"> 827                     .replaceAll(&quot;[.]&quot;, &quot;[.]&quot;) + &quot;$&quot;) &amp;&amp; !tsa) continue;</span>
<span class="line-added"> 828             if (line.matches(&quot;^&quot; + Test.NO_TIMESTAMP_VERIFYING_WARN_TEMPLATE</span>
<span class="line-added"> 829                     .replaceAll(&quot;\\(as early as %1\\$tY-%1\\$tm-%1\\$td\\)&quot;,</span>
<span class="line-added"> 830                         &quot;\\\\([^\\\\)]+\\\\)&quot;</span>
<span class="line-added"> 831                         + &quot;( or after any future revocation date)?&quot;)</span>
<span class="line-added"> 832                     .replaceAll(&quot;[.]&quot;, &quot;[.]&quot;) + &quot;$&quot;) &amp;&amp; !tsa) continue;</span>
<span class="line-added"> 833             if (line.matches(&quot;^This jar contains signatures that do(es)? not &quot;</span>
<span class="line-added"> 834                     + &quot;include a timestamp[.] Without a timestamp, users may &quot;</span>
<span class="line-added"> 835                     + &quot;not be able to validate this jar after the signer &quot;</span>
<span class="line-added"> 836                     + &quot;certificate&#39;s expiration date \\([^\\)]+\\) or after &quot;</span>
<span class="line-added"> 837                     + &quot;any future revocation date[.]&quot;) &amp;&amp; !tsa) continue;</span>
<span class="line-added"> 838             if (Test.CERTIFICATE_SELF_SIGNED.equals(line)) continue;</span>
<span class="line-added"> 839             if (Test.HAS_EXPIRED_CERT_VERIFYING_WARNING.equals(line)</span>
<span class="line-added"> 840                     &amp;&amp; signItem.certInfo.expired) continue;</span>
<span class="line-added"> 841             System.out.println(&quot;verifyingStatus: unexpected line: &quot; + line);</span>
<span class="line-added"> 842             return Status.ERROR; // treat unexpected warnings as error</span>
 843         }
<a name="92" id="anc92"></a><span class="line-added"> 844         return warning ? Status.WARNING : Status.NORMAL;</span>
 845     }
 846 
 847     // Using specified jarsigner to sign the pre-created jar with specified
 848     // algorithms.
 849     private static OutputAnalyzer signJar(String jarsignerPath, String sigalg,
<a name="93" id="anc93"></a><span class="line-modified"> 850             String jarDigestAlgorithm,</span>
<span class="line-modified"> 851             String tsadigestalg, String tsa, String alias, String unsignedJar,</span>
<span class="line-modified"> 852             String signedJar) throws Throwable {</span>
<span class="line-added"> 853         List&lt;String&gt; arguments = new ArrayList&lt;&gt;();</span>
 854 
 855         if (PROXY_HOST != null &amp;&amp; PROXY_PORT != null) {
 856             arguments.add(&quot;-J-Dhttp.proxyHost=&quot; + PROXY_HOST);
 857             arguments.add(&quot;-J-Dhttp.proxyPort=&quot; + PROXY_PORT);
 858             arguments.add(&quot;-J-Dhttps.proxyHost=&quot; + PROXY_HOST);
 859             arguments.add(&quot;-J-Dhttps.proxyPort=&quot; + PROXY_PORT);
 860         }
 861         arguments.add(&quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY);
 862         arguments.add(&quot;-debug&quot;);
 863         arguments.add(&quot;-verbose&quot;);
<a name="94" id="anc94"></a><span class="line-added"> 864         if (jarDigestAlgorithm != null) {</span>
<span class="line-added"> 865             arguments.add(&quot;-digestalg&quot;);</span>
<span class="line-added"> 866             arguments.add(jarDigestAlgorithm);</span>
<span class="line-added"> 867         }</span>
 868         if (sigalg != null) {
 869             arguments.add(&quot;-sigalg&quot;);
 870             arguments.add(sigalg);
 871         }
 872         if (tsa != null) {
 873             arguments.add(&quot;-tsa&quot;);
 874             arguments.add(tsa);
 875         }
 876         if (tsadigestalg != null) {
 877             arguments.add(&quot;-tsadigestalg&quot;);
 878             arguments.add(tsadigestalg);
 879         }
 880         arguments.add(&quot;-keystore&quot;);
 881         arguments.add(KEYSTORE);
 882         arguments.add(&quot;-storepass&quot;);
 883         arguments.add(PASSWORD);
<a name="95" id="anc95"></a><span class="line-added"> 884         arguments.add(&quot;-sigfile&quot;);</span>
<span class="line-added"> 885         arguments.add(nextSigfileName(alias, unsignedJar, signedJar));</span>
 886         arguments.add(&quot;-signedjar&quot;);
 887         arguments.add(signedJar + &quot;.jar&quot;);
<a name="96" id="anc96"></a><span class="line-modified"> 888         arguments.add(unsignedJar + &quot;.jar&quot;);</span>
 889         arguments.add(alias);
 890 
<a name="97" id="anc97"></a><span class="line-modified"> 891         OutputAnalyzer outputAnalyzer = execTool(jarsignerPath,</span>

 892                 arguments.toArray(new String[arguments.size()]));
 893         return outputAnalyzer;
 894     }
 895 
 896     // Using specified jarsigner to verify the signed jar.
 897     private static OutputAnalyzer verifyJar(String jarsignerPath,
<a name="98" id="anc98"></a><span class="line-modified"> 898             String signedJar, String alias) throws Throwable {</span>
<span class="line-modified"> 899         List&lt;String&gt; arguments = new ArrayList&lt;&gt;();</span>
<span class="line-modified"> 900         arguments.add(&quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY);</span>
<span class="line-modified"> 901         arguments.add(&quot;-debug&quot;);</span>
<span class="line-modified"> 902         arguments.add(&quot;-verbose&quot;);</span>
<span class="line-modified"> 903         arguments.add(&quot;-certs&quot;);</span>
<span class="line-modified"> 904         arguments.add(&quot;-keystore&quot;);</span>
<span class="line-modified"> 905         arguments.add(KEYSTORE);</span>
<span class="line-modified"> 906         arguments.add(&quot;-verify&quot;);</span>
<span class="line-added"> 907         if (STRICT) arguments.add(&quot;-strict&quot;);</span>
<span class="line-added"> 908         arguments.add(signedJar + &quot;.jar&quot;);</span>
<span class="line-added"> 909         if (alias != null) arguments.add(alias);</span>
<span class="line-added"> 910         OutputAnalyzer outputAnalyzer = execTool(jarsignerPath,</span>
<span class="line-added"> 911                 arguments.toArray(new String[arguments.size()]));</span>
 912         return outputAnalyzer;
 913     }
 914 
 915     // Generates the test result report.
<a name="99" id="anc99"></a><span class="line-modified"> 916     private static boolean generateReport(List&lt;JdkInfo&gt; jdkList, List&lt;TsaInfo&gt; tsaList,</span>
 917             List&lt;SignItem&gt; signItems) throws IOException {
 918         System.out.println(&quot;Report is being generated...&quot;);
 919 
 920         StringBuilder report = new StringBuilder();
 921         report.append(HtmlHelper.startHtml());
 922         report.append(HtmlHelper.startPre());
<a name="100" id="anc100"></a><span class="line-added"> 923 </span>
<span class="line-added"> 924         // Generates JDK list</span>
<span class="line-added"> 925         report.append(&quot;JDK list:\n&quot;);</span>
<span class="line-added"> 926         for(JdkInfo jdkInfo : jdkList) {</span>
<span class="line-added"> 927             report.append(String.format(&quot;%d=%s%n&quot;,</span>
<span class="line-added"> 928                     jdkInfo.index,</span>
<span class="line-added"> 929                     jdkInfo.runtimeVersion));</span>
<span class="line-added"> 930         }</span>
<span class="line-added"> 931 </span>
 932         // Generates TSA URLs
 933         report.append(&quot;TSA list:\n&quot;);
 934         for(TsaInfo tsaInfo : tsaList) {
 935             report.append(
<a name="101" id="anc101"></a><span class="line-modified"> 936                     String.format(&quot;%d=%s%n&quot;, tsaInfo.index,</span>
<span class="line-added"> 937                             tsaInfo.tsaUrl == null ? &quot;notsa&quot; : tsaInfo.tsaUrl));</span>
 938         }
 939         report.append(HtmlHelper.endPre());
 940 
 941         report.append(HtmlHelper.startTable());
 942         // Generates report headers.
<a name="102" id="anc102"></a><span class="line-modified"> 943         List&lt;String&gt; headers = new ArrayList&lt;&gt;();</span>
<span class="line-modified"> 944         headers.add(&quot;[Jarfile]&quot;);</span>
<span class="line-added"> 945         headers.add(&quot;[Signing Certificate]&quot;);</span>
 946         headers.add(&quot;[Signer JDK]&quot;);
 947         headers.add(&quot;[Signature Algorithm]&quot;);
<a name="103" id="anc103"></a><span class="line-modified"> 948         headers.add(&quot;[Jar Digest Algorithm]&quot;);</span>
<span class="line-added"> 949         headers.add(&quot;[TSA Digest Algorithm]&quot;);</span>
 950         headers.add(&quot;[TSA]&quot;);
 951         headers.add(&quot;[Signing Status]&quot;);
 952         headers.add(&quot;[Verifier JDK]&quot;);
<a name="104" id="anc104"></a><span class="line-added"> 953         headers.add(&quot;[Verifying Certificate]&quot;);</span>
 954         headers.add(&quot;[Verifying Status]&quot;);
 955         if (DELAY_VERIFY) {
 956             headers.add(&quot;[Delay Verifying Status]&quot;);
 957         }
 958         headers.add(&quot;[Failed]&quot;);
 959         report.append(HtmlHelper.htmlRow(
 960                 headers.toArray(new String[headers.size()])));
 961 
 962         StringBuilder failedReport = new StringBuilder(report.toString());
 963 
<a name="105" id="anc105"></a><span class="line-modified"> 964         boolean failed = signItems.isEmpty();</span>
 965 
 966         // Generates report rows.
 967         for (SignItem signItem : signItems) {
<a name="106" id="anc106"></a><span class="line-added"> 968             failed = failed || signItem.verifyItems.isEmpty();</span>
 969             for (VerifyItem verifyItem : signItem.verifyItems) {
 970                 String reportRow = reportRow(signItem, verifyItem);
 971                 report.append(reportRow);
 972                 boolean isFailedCase = isFailed(signItem, verifyItem);
 973                 if (isFailedCase) {
 974                     failedReport.append(reportRow);
 975                 }
 976                 failed = failed || isFailedCase;
 977             }
 978         }
 979 
 980         report.append(HtmlHelper.endTable());
 981         report.append(HtmlHelper.endHtml());
 982         generateFile(&quot;report.html&quot;, report.toString());
 983         if (failed) {
 984             failedReport.append(HtmlHelper.endTable());
 985             failedReport.append(HtmlHelper.endPre());
 986             failedReport.append(HtmlHelper.endHtml());
 987             generateFile(&quot;failedReport.html&quot;, failedReport.toString());
 988         }
 989 
 990         System.out.println(&quot;Report is generated.&quot;);
 991         return failed;
 992     }
 993 
 994     private static void generateFile(String path, String content)
 995             throws IOException {
 996         FileWriter writer = new FileWriter(new File(path));
 997         writer.write(content);
 998         writer.close();
 999     }
1000 
1001     private static String jarsignerPath(String jdkPath) {
1002         return jdkPath + &quot;/bin/jarsigner&quot;;
1003     }
1004 
1005     // Executes the specified function on JdkUtils by the specified JDK.
1006     private static String execJdkUtils(String jdkPath, String method,
1007             String... args) throws Throwable {
1008         String[] cmd = new String[args.length + 5];
1009         cmd[0] = jdkPath + &quot;/bin/java&quot;;
1010         cmd[1] = &quot;-cp&quot;;
1011         cmd[2] = TEST_CLASSES;
1012         cmd[3] = JdkUtils.class.getName();
1013         cmd[4] = method;
1014         System.arraycopy(args, 0, cmd, 5, args.length);
1015         return ProcessTools.executeCommand(cmd).getOutput();
1016     }
1017 
1018     // Executes the specified JDK tools, such as keytool and jarsigner, and
1019     // ensures the output is in US English.
1020     private static OutputAnalyzer execTool(String toolPath, String... args)
1021             throws Throwable {
<a name="107" id="anc107"></a><span class="line-modified">1022         long start = System.currentTimeMillis();</span>
<span class="line-modified">1023         try {</span>
<span class="line-modified">1024 </span>
<span class="line-modified">1025             String[] cmd = new String[args.length + 4];</span>
<span class="line-modified">1026             cmd[0] = toolPath;</span>
<span class="line-modified">1027             cmd[1] = &quot;-J-Duser.language=en&quot;;</span>
<span class="line-modified">1028             cmd[2] = &quot;-J-Duser.country=US&quot;;</span>
<span class="line-added">1029             cmd[3] = &quot;-J-Djava.security.egd=file:/dev/./urandom&quot;;</span>
<span class="line-added">1030             System.arraycopy(args, 0, cmd, 4, args.length);</span>
<span class="line-added">1031             return ProcessTools.executeCommand(cmd);</span>
<span class="line-added">1032 </span>
<span class="line-added">1033         } finally {</span>
<span class="line-added">1034             long end = System.currentTimeMillis();</span>
<span class="line-added">1035             System.out.println(&quot;child process duration [ms]: &quot; + (end - start));</span>
<span class="line-added">1036         }</span>
1037     }
1038 
1039     private static class JdkInfo {
1040 
<a name="108" id="anc108"></a><span class="line-added">1041         private int index;</span>
1042         private final String jdkPath;
1043         private final String jarsignerPath;
<a name="109" id="anc109"></a><span class="line-modified">1044         private final String runtimeVersion;</span>
<span class="line-added">1045         private String version;</span>
<span class="line-added">1046         private final int majorVersion;</span>
1047         private final boolean supportsTsadigestalg;
1048 
<a name="110" id="anc110"></a><span class="line-modified">1049         private Map&lt;String, Boolean&gt; sigalgMap = new HashMap&lt;&gt;();</span>
1050 
1051         private JdkInfo(String jdkPath) throws Throwable {
1052             this.jdkPath = jdkPath;
<a name="111" id="anc111"></a><span class="line-modified">1053             jarsignerPath = jarsignerPath(jdkPath);</span>
<span class="line-modified">1054             runtimeVersion = execJdkUtils(jdkPath, JdkUtils.M_JAVA_RUNTIME_VERSION);</span>
<span class="line-added">1055             if (runtimeVersion == null || runtimeVersion.isBlank()) {</span>
1056                 throw new RuntimeException(
1057                         &quot;Cannot determine the JDK version: &quot; + jdkPath);
1058             }
<a name="112" id="anc112"></a><span class="line-modified">1059             version = execJdkUtils(jdkPath, JdkUtils.M_JAVA_VERSION);</span>
<span class="line-added">1060             majorVersion = Integer.parseInt((runtimeVersion.matches(&quot;^1[.].*&quot;) ?</span>
<span class="line-added">1061                     runtimeVersion.substring(2) : runtimeVersion).replaceAll(&quot;[^0-9].*$&quot;, &quot;&quot;));</span>
1062             supportsTsadigestalg = execTool(jarsignerPath, &quot;-help&quot;)
1063                     .getOutput().contains(&quot;-tsadigestalg&quot;);
1064         }
1065 
1066         private boolean isSupportedSigalg(String sigalg) throws Throwable {
1067             if (!sigalgMap.containsKey(sigalg)) {
<a name="113" id="anc113"></a><span class="line-modified">1068                 boolean isSupported = Boolean.parseBoolean(</span>
1069                         execJdkUtils(
1070                                 jdkPath,
1071                                 JdkUtils.M_IS_SUPPORTED_SIGALG,
1072                                 sigalg));
1073                 sigalgMap.put(sigalg, isSupported);
1074             }
1075 
1076             return sigalgMap.get(sigalg);
1077         }
1078 
<a name="114" id="anc114"></a><span class="line-modified">1079         private boolean isAtLeastMajorVersion(int minVersion) {</span>
<span class="line-modified">1080             return majorVersion &gt;= minVersion;</span>
<span class="line-added">1081         }</span>
<span class="line-added">1082 </span>
<span class="line-added">1083         private boolean supportsKeyAlg(String keyAlgorithm) {</span>
<span class="line-added">1084             // JDK 6 doesn&#39;t support EC</span>
<span class="line-added">1085             return isAtLeastMajorVersion(6) || !EC.equals(keyAlgorithm);</span>
1086         }
1087 
1088         @Override
1089         public int hashCode() {
1090             final int prime = 31;
1091             int result = 1;
1092             result = prime * result
<a name="115" id="anc115"></a><span class="line-modified">1093                     + ((runtimeVersion == null) ? 0 : runtimeVersion.hashCode());</span>
1094             return result;
1095         }
1096 
1097         @Override
1098         public boolean equals(Object obj) {
1099             if (this == obj)
1100                 return true;
1101             if (obj == null)
1102                 return false;
1103             if (getClass() != obj.getClass())
1104                 return false;
1105             JdkInfo other = (JdkInfo) obj;
<a name="116" id="anc116"></a><span class="line-modified">1106             if (runtimeVersion == null) {</span>
<span class="line-modified">1107                 if (other.runtimeVersion != null)</span>
1108                     return false;
<a name="117" id="anc117"></a><span class="line-modified">1109             } else if (!runtimeVersion.equals(other.runtimeVersion))</span>
1110                 return false;
1111             return true;
1112         }
<a name="118" id="anc118"></a><span class="line-added">1113 </span>
<span class="line-added">1114         @Override</span>
<span class="line-added">1115         public String toString() {</span>
<span class="line-added">1116             return &quot;JdkInfo[&quot; + runtimeVersion + &quot;, &quot; + jdkPath + &quot;]&quot;;</span>
<span class="line-added">1117         }</span>
1118     }
1119 
1120     private static class TsaInfo {
1121 
1122         private final int index;
1123         private final String tsaUrl;
<a name="119" id="anc119"></a><span class="line-modified">1124         private Set&lt;String&gt; digestList = new HashSet&lt;&gt;();</span>
1125 
1126         private TsaInfo(int index, String tsa) {
1127             this.index = index;
1128             this.tsaUrl = tsa;
1129         }
1130 
1131         private void addDigest(String digest) {
<a name="120" id="anc120"></a><span class="line-modified">1132             digestList.add(digest);</span>








1133         }
1134 
1135         private boolean isDigestSupported(String digest) {
1136             return digest == null || digestList.isEmpty()
1137                     || digestList.contains(digest);
1138         }
<a name="121" id="anc121"></a><span class="line-added">1139 </span>
<span class="line-added">1140         @Override</span>
<span class="line-added">1141         public String toString() {</span>
<span class="line-added">1142             return &quot;TsaInfo[&quot; + index + &quot;, &quot; + tsaUrl + &quot;]&quot;;</span>
<span class="line-added">1143         }</span>
1144     }
1145 
1146     private static class CertInfo {
1147 
<a name="122" id="anc122"></a><span class="line-modified">1148         private static int certCounter;</span>
<span class="line-added">1149 </span>
<span class="line-added">1150         // nr distinguishes cert CNs in jarsigner -verify output</span>
<span class="line-added">1151         private final int nr = ++certCounter;</span>
<span class="line-added">1152         private final JdkInfo jdkInfo;</span>
1153         private final String keyAlgorithm;
1154         private final String digestAlgorithm;
1155         private final int keySize;
1156         private final boolean expired;
1157 
<a name="123" id="anc123"></a><span class="line-modified">1158         private CertInfo(JdkInfo jdkInfo, String keyAlgorithm,</span>
1159                 String digestAlgorithm, int keySize, boolean expired) {
<a name="124" id="anc124"></a><span class="line-modified">1160             this.jdkInfo = jdkInfo;</span>
1161             this.keyAlgorithm = keyAlgorithm;
1162             this.digestAlgorithm = digestAlgorithm;
1163             this.keySize = keySize;
1164             this.expired = expired;
1165         }
1166 
<a name="125" id="anc125"></a><span class="line-added">1167         private String sigalg() {</span>
<span class="line-added">1168             return DEFAULT.equals(digestAlgorithm) ? null : expectedSigalg();</span>
<span class="line-added">1169         }</span>
<span class="line-added">1170 </span>
<span class="line-added">1171         private String expectedSigalg() {</span>
<span class="line-added">1172             return (DEFAULT.equals(this.digestAlgorithm) ? this.digestAlgorithm</span>
<span class="line-added">1173                     : &quot;SHA-256&quot;).replace(&quot;-&quot;, &quot;&quot;) + &quot;with&quot; +</span>
<span class="line-added">1174                     keyAlgorithm + (EC.equals(keyAlgorithm) ? &quot;DSA&quot; : &quot;&quot;);</span>
<span class="line-added">1175         }</span>
<span class="line-added">1176 </span>
<span class="line-added">1177         private int expectedKeySize() {</span>
<span class="line-added">1178             if (keySize != 0) return keySize;</span>
<span class="line-added">1179 </span>
<span class="line-added">1180             // defaults</span>
<span class="line-added">1181             if (RSA.equals(keyAlgorithm) || DSA.equals(keyAlgorithm)) {</span>
<span class="line-added">1182                 return 2048;</span>
<span class="line-added">1183             } else if (EC.equals(keyAlgorithm)) {</span>
<span class="line-added">1184                 return 256;</span>
<span class="line-added">1185             } else {</span>
<span class="line-added">1186                 throw new RuntimeException(&quot;problem determining key size&quot;);</span>
<span class="line-added">1187             }</span>
<span class="line-added">1188         }</span>
<span class="line-added">1189 </span>
1190         @Override
1191         public int hashCode() {
1192             final int prime = 31;
1193             int result = 1;
1194             result = prime * result
<a name="126" id="anc126"></a><span class="line-modified">1195                     + (digestAlgorithm == null ? 0 : digestAlgorithm.hashCode());</span>
1196             result = prime * result + (expired ? 1231 : 1237);
1197             result = prime * result
<a name="127" id="anc127"></a><span class="line-modified">1198                     + (jdkInfo == null ? 0 : jdkInfo.hashCode());</span>
1199             result = prime * result
<a name="128" id="anc128"></a><span class="line-modified">1200                     + (keyAlgorithm == null ? 0 : keyAlgorithm.hashCode());</span>
1201             result = prime * result + keySize;
1202             return result;
1203         }
1204 
1205         @Override
1206         public boolean equals(Object obj) {
1207             if (this == obj)
1208                 return true;
1209             if (obj == null)
1210                 return false;
1211             if (getClass() != obj.getClass())
1212                 return false;
1213             CertInfo other = (CertInfo) obj;
1214             if (digestAlgorithm == null) {
1215                 if (other.digestAlgorithm != null)
1216                     return false;
1217             } else if (!digestAlgorithm.equals(other.digestAlgorithm))
1218                 return false;
1219             if (expired != other.expired)
1220                 return false;
<a name="129" id="anc129"></a><span class="line-modified">1221             if (jdkInfo == null) {</span>
<span class="line-modified">1222                 if (other.jdkInfo != null)</span>
1223                     return false;
<a name="130" id="anc130"></a><span class="line-modified">1224             } else if (!jdkInfo.equals(other.jdkInfo))</span>
1225                 return false;
1226             if (keyAlgorithm == null) {
1227                 if (other.keyAlgorithm != null)
1228                     return false;
1229             } else if (!keyAlgorithm.equals(other.keyAlgorithm))
1230                 return false;
1231             if (keySize != other.keySize)
1232                 return false;
1233             return true;
1234         }
1235 
1236         private String alias() {
<a name="131" id="anc131"></a><span class="line-modified">1237             return (jdkInfo.version + &quot;_&quot; + toString())</span>
<span class="line-added">1238                     // lower case for jks due to</span>
<span class="line-added">1239                     // sun.security.provider.JavaKeyStore.JDK.convertAlias</span>
<span class="line-added">1240                     .toLowerCase(Locale.ENGLISH);</span>
1241         }
1242 
1243         @Override
1244         public String toString() {
<a name="132" id="anc132"></a><span class="line-modified">1245             return &quot;nr&quot; + nr + &quot;_&quot;</span>
<span class="line-added">1246                     + keyAlgorithm + &quot;_&quot; + digestAlgorithm</span>
1247                     + (keySize == 0 ? &quot;&quot; : &quot;_&quot; + keySize)
1248                     + (expired ? &quot;_Expired&quot; : &quot;&quot;);
1249         }
1250     }
1251 
1252     // It does only one timestamping for the same JDK, digest algorithm and
1253     // TSA service with an arbitrary valid/expired certificate.
1254     private static class TsaFilter {
1255 
<a name="133" id="anc133"></a><span class="line-modified">1256         private static final Set&lt;Condition&gt; SET = new HashSet&lt;&gt;();</span>
1257 
1258         private static boolean filter(String signerVersion,
1259                 String digestAlgorithm, boolean expiredCert, int tsaIndex) {
1260             return !SET.add(new Condition(signerVersion, digestAlgorithm,
1261                     expiredCert, tsaIndex));
1262         }
1263 
1264         private static class Condition {
1265 
1266             private final String signerVersion;
1267             private final String digestAlgorithm;
1268             private final boolean expiredCert;
1269             private final int tsaIndex;
1270 
1271             private Condition(String signerVersion, String digestAlgorithm,
1272                     boolean expiredCert, int tsaIndex) {
1273                 this.signerVersion = signerVersion;
1274                 this.digestAlgorithm = digestAlgorithm;
1275                 this.expiredCert = expiredCert;
1276                 this.tsaIndex = tsaIndex;
1277             }
1278 
1279             @Override
1280             public int hashCode() {
1281                 final int prime = 31;
1282                 int result = 1;
1283                 result = prime * result
1284                         + ((digestAlgorithm == null) ? 0 : digestAlgorithm.hashCode());
1285                 result = prime * result + (expiredCert ? 1231 : 1237);
1286                 result = prime * result
1287                         + ((signerVersion == null) ? 0 : signerVersion.hashCode());
1288                 result = prime * result + tsaIndex;
1289                 return result;
1290             }
1291 
1292             @Override
1293             public boolean equals(Object obj) {
1294                 if (this == obj)
1295                     return true;
1296                 if (obj == null)
1297                     return false;
1298                 if (getClass() != obj.getClass())
1299                     return false;
1300                 Condition other = (Condition) obj;
1301                 if (digestAlgorithm == null) {
1302                     if (other.digestAlgorithm != null)
1303                         return false;
1304                 } else if (!digestAlgorithm.equals(other.digestAlgorithm))
1305                     return false;
1306                 if (expiredCert != other.expiredCert)
1307                     return false;
1308                 if (signerVersion == null) {
1309                     if (other.signerVersion != null)
1310                         return false;
1311                 } else if (!signerVersion.equals(other.signerVersion))
1312                     return false;
1313                 if (tsaIndex != other.tsaIndex)
1314                     return false;
1315                 return true;
1316             }
1317         }}
1318 
1319     private static enum Status {
1320 
1321         // No action due to pre-action fails.
1322         NONE,
1323 
1324         // jar is signed/verified with error
1325         ERROR,
1326 
1327         // jar is signed/verified with warning
1328         WARNING,
1329 
1330         // jar is signed/verified without any warning and error
1331         NORMAL
1332     }
1333 
1334     private static class SignItem {
1335 
<a name="134" id="anc134"></a><span class="line-added">1336         private SignItem prevSign;</span>
1337         private CertInfo certInfo;
<a name="135" id="anc135"></a><span class="line-modified">1338         private JdkInfo jdkInfo;</span>
<span class="line-modified">1339         private String digestAlgorithm;</span>


1340         private String tsaDigestAlgorithm;
<a name="136" id="anc136"></a>

1341         private int tsaIndex;
1342         private Status status;
<a name="137" id="anc137"></a><span class="line-added">1343         private String unsignedJar;</span>
1344         private String signedJar;
<a name="138" id="anc138"></a><span class="line-added">1345         private List&lt;String&gt; jarContents = new ArrayList&lt;&gt;();</span>
1346 
<a name="139" id="anc139"></a><span class="line-modified">1347         private List&lt;VerifyItem&gt; verifyItems = new ArrayList&lt;&gt;();</span>
1348 
1349         private static SignItem build() {
<a name="140" id="anc140"></a><span class="line-modified">1350             return new SignItem()</span>
<span class="line-added">1351                     .addContentFiles(Arrays.asList(&quot;META-INF/MANIFEST.MF&quot;));</span>
<span class="line-added">1352         }</span>
<span class="line-added">1353 </span>
<span class="line-added">1354         private static SignItem build(SignItem prevSign) {</span>
<span class="line-added">1355             return build().prevSign(prevSign).unsignedJar(prevSign.signedJar)</span>
<span class="line-added">1356                     .addContentFiles(prevSign.jarContents);</span>
<span class="line-added">1357         }</span>
<span class="line-added">1358 </span>
<span class="line-added">1359         private SignItem prevSign(SignItem prevSign) {</span>
<span class="line-added">1360             this.prevSign = prevSign;</span>
<span class="line-added">1361             return this;</span>
1362         }
1363 
1364         private SignItem certInfo(CertInfo certInfo) {
1365             this.certInfo = certInfo;
1366             return this;
1367         }
1368 
<a name="141" id="anc141"></a><span class="line-modified">1369         private SignItem jdkInfo(JdkInfo jdkInfo) {</span>
<span class="line-modified">1370             this.jdkInfo = jdkInfo;</span>
1371             return this;
1372         }
1373 
<a name="142" id="anc142"></a><span class="line-modified">1374         private SignItem digestAlgorithm(String digestAlgorithm) {</span>
<span class="line-modified">1375             this.digestAlgorithm = digestAlgorithm;</span>
1376             return this;
1377         }
1378 
<a name="143" id="anc143"></a><span class="line-modified">1379         String expectedDigestAlg() {</span>
<span class="line-modified">1380             return digestAlgorithm != null ? digestAlgorithm : &quot;SHA-256&quot;;</span>


1381         }
1382 
1383         private SignItem tsaDigestAlgorithm(String tsaDigestAlgorithm) {
1384             this.tsaDigestAlgorithm = tsaDigestAlgorithm;
1385             return this;
1386         }
1387 
<a name="144" id="anc144"></a><span class="line-modified">1388         String expectedTsaDigestAlg() {</span>
<span class="line-modified">1389             return tsaDigestAlgorithm != null ? tsaDigestAlgorithm : &quot;SHA-256&quot;;</span>


1390         }
1391 
1392         private SignItem tsaIndex(int tsaIndex) {
1393             this.tsaIndex = tsaIndex;
1394             return this;
1395         }
1396 
1397         private SignItem status(Status status) {
1398             this.status = status;
1399             return this;
1400         }
1401 
<a name="145" id="anc145"></a><span class="line-added">1402         private SignItem unsignedJar(String unsignedJar) {</span>
<span class="line-added">1403             this.unsignedJar = unsignedJar;</span>
<span class="line-added">1404             return this;</span>
<span class="line-added">1405         }</span>
<span class="line-added">1406 </span>
1407         private SignItem signedJar(String signedJar) {
1408             this.signedJar = signedJar;
1409             return this;
1410         }
1411 
<a name="146" id="anc146"></a><span class="line-added">1412         private SignItem addContentFiles(List&lt;String&gt; files) {</span>
<span class="line-added">1413             this.jarContents.addAll(files);</span>
<span class="line-added">1414             return this;</span>
<span class="line-added">1415         }</span>
<span class="line-added">1416 </span>
1417         private void addVerifyItem(VerifyItem verifyItem) {
1418             verifyItems.add(verifyItem);
1419         }
<a name="147" id="anc147"></a><span class="line-added">1420 </span>
<span class="line-added">1421         private boolean isErrorInclPrev() {</span>
<span class="line-added">1422             if (prevSign != null &amp;&amp; prevSign.isErrorInclPrev()) {</span>
<span class="line-added">1423                 System.out.println(&quot;SignItem.isErrorInclPrev: returning true from previous&quot;);</span>
<span class="line-added">1424                 return true;</span>
<span class="line-added">1425             }</span>
<span class="line-added">1426 </span>
<span class="line-added">1427             return status == Status.ERROR;</span>
<span class="line-added">1428         }</span>
<span class="line-added">1429         private List&lt;String&gt; toStringWithPrev(Function&lt;SignItem,String&gt; toStr) {</span>
<span class="line-added">1430             List&lt;String&gt; s = new ArrayList&lt;&gt;();</span>
<span class="line-added">1431             if (prevSign != null) {</span>
<span class="line-added">1432                 s.addAll(prevSign.toStringWithPrev(toStr));</span>
<span class="line-added">1433             }</span>
<span class="line-added">1434             if (status != null) { // no status means jar creation or update item</span>
<span class="line-added">1435                 s.add(toStr.apply(this));</span>
<span class="line-added">1436             }</span>
<span class="line-added">1437             return s;</span>
<span class="line-added">1438         }</span>
1439     }
1440 
1441     private static class VerifyItem {
1442 
<a name="148" id="anc148"></a><span class="line-added">1443         private VerifyItem prevVerify;</span>
<span class="line-added">1444         private CertInfo certInfo;</span>
1445         private JdkInfo jdkInfo;
1446         private Status status = Status.NONE;
1447         private Status delayStatus = Status.NONE;
1448 
1449         private static VerifyItem build(JdkInfo jdkInfo) {
1450             VerifyItem verifyItem = new VerifyItem();
1451             verifyItem.jdkInfo = jdkInfo;
1452             return verifyItem;
1453         }
1454 
<a name="149" id="anc149"></a><span class="line-added">1455         private VerifyItem certInfo(CertInfo certInfo) {</span>
<span class="line-added">1456             this.certInfo = certInfo;</span>
<span class="line-added">1457             return this;</span>
<span class="line-added">1458         }</span>
<span class="line-added">1459 </span>
<span class="line-added">1460         private void addSignerCertInfos(SignItem signItem) {</span>
<span class="line-added">1461             VerifyItem prevVerify = this;</span>
<span class="line-added">1462             CertInfo lastCertInfo = null;</span>
<span class="line-added">1463             while (signItem != null) {</span>
<span class="line-added">1464                 // (signItem.certInfo == null) means create or update jar step</span>
<span class="line-added">1465                 if (signItem.certInfo != null</span>
<span class="line-added">1466                         &amp;&amp; !signItem.certInfo.equals(lastCertInfo)) {</span>
<span class="line-added">1467                     lastCertInfo = signItem.certInfo;</span>
<span class="line-added">1468                     prevVerify = prevVerify.prevVerify =</span>
<span class="line-added">1469                             build(jdkInfo).certInfo(signItem.certInfo);</span>
<span class="line-added">1470                 }</span>
<span class="line-added">1471                 signItem = signItem.prevSign;</span>
<span class="line-added">1472             }</span>
<span class="line-added">1473         }</span>
<span class="line-added">1474 </span>
1475         private VerifyItem status(Status status) {
1476             this.status = status;
1477             return this;
1478         }
1479 
<a name="150" id="anc150"></a><span class="line-added">1480         private boolean isErrorInclPrev() {</span>
<span class="line-added">1481             if (prevVerify != null &amp;&amp; prevVerify.isErrorInclPrev()) {</span>
<span class="line-added">1482                 System.out.println(&quot;VerifyItem.isErrorInclPrev: returning true from previous&quot;);</span>
<span class="line-added">1483                 return true;</span>
<span class="line-added">1484             }</span>
<span class="line-added">1485 </span>
<span class="line-added">1486             return status == Status.ERROR || delayStatus == Status.ERROR;</span>
<span class="line-added">1487         }</span>
<span class="line-added">1488 </span>
1489         private VerifyItem delayStatus(Status status) {
1490             this.delayStatus = status;
1491             return this;
1492         }
<a name="151" id="anc151"></a><span class="line-added">1493 </span>
<span class="line-added">1494         private List&lt;String&gt; toStringWithPrev(</span>
<span class="line-added">1495                 Function&lt;VerifyItem,String&gt; toStr) {</span>
<span class="line-added">1496             List&lt;String&gt; s = new ArrayList&lt;&gt;();</span>
<span class="line-added">1497             if (prevVerify != null) {</span>
<span class="line-added">1498                 s.addAll(prevVerify.toStringWithPrev(toStr));</span>
<span class="line-added">1499             }</span>
<span class="line-added">1500             s.add(toStr.apply(this));</span>
<span class="line-added">1501             return s;</span>
<span class="line-added">1502         }</span>
1503     }
1504 
1505     // The identifier for a specific signing.
1506     private static String signingId(SignItem signItem) {
1507         return signItem.signedJar;
1508     }
1509 
1510     // The identifier for a specific verifying.
1511     private static String verifyingId(SignItem signItem, VerifyItem verifyItem,
1512             boolean delayVerify) {
<a name="152" id="anc152"></a><span class="line-modified">1513         return signingId(signItem) + (delayVerify ? &quot;-DV&quot; : &quot;-V&quot;)</span>
<span class="line-modified">1514                 + &quot;_&quot; + verifyItem.jdkInfo.version +</span>
<span class="line-added">1515                 (verifyItem.certInfo == null ? &quot;&quot; : &quot;_&quot; + verifyItem.certInfo);</span>
1516     }
1517 
1518     private static String reportRow(SignItem signItem, VerifyItem verifyItem) {
<a name="153" id="anc153"></a><span class="line-modified">1519         List&lt;String&gt; values = new ArrayList&lt;&gt;();</span>
<span class="line-modified">1520         Consumer&lt;Function&lt;SignItem, String&gt;&gt; s_values_add = f -&gt; {</span>
<span class="line-modified">1521             values.add(String.join(&quot;&lt;br/&gt;&lt;br/&gt;&quot;, signItem.toStringWithPrev(f)));</span>
<span class="line-modified">1522         };</span>
<span class="line-modified">1523         Consumer&lt;Function&lt;VerifyItem, String&gt;&gt; v_values_add = f -&gt; {</span>
<span class="line-modified">1524             values.add(String.join(&quot;&lt;br/&gt;&lt;br/&gt;&quot;, verifyItem.toStringWithPrev(f)));</span>
<span class="line-modified">1525         };</span>
<span class="line-modified">1526         s_values_add.accept(i -&gt; i.unsignedJar + &quot; -&gt; &quot; + i.signedJar);</span>
<span class="line-modified">1527         s_values_add.accept(i -&gt; i.certInfo.toString());</span>
<span class="line-modified">1528         s_values_add.accept(i -&gt; i.jdkInfo.version);</span>
<span class="line-modified">1529         s_values_add.accept(i -&gt; i.certInfo.expectedSigalg());</span>
<span class="line-added">1530         s_values_add.accept(i -&gt;</span>
<span class="line-added">1531                 null2Default(i.digestAlgorithm, i.expectedDigestAlg()));</span>
<span class="line-added">1532         s_values_add.accept(i -&gt; i.tsaIndex == -1 ? &quot;&quot; :</span>
<span class="line-added">1533                 null2Default(i.tsaDigestAlgorithm, i.expectedTsaDigestAlg()));</span>
<span class="line-added">1534         s_values_add.accept(i -&gt; i.tsaIndex == -1 ? &quot;&quot; : i.tsaIndex + &quot;&quot;);</span>
<span class="line-added">1535         s_values_add.accept(i -&gt; HtmlHelper.anchorLink(</span>
1536                 PhaseOutputStream.fileName(PhaseOutputStream.Phase.SIGNING),
<a name="154" id="anc154"></a><span class="line-modified">1537                 signingId(i),</span>
<span class="line-modified">1538                 &quot;&quot; + i.status));</span>
1539         values.add(verifyItem.jdkInfo.version);
<a name="155" id="anc155"></a><span class="line-modified">1540         v_values_add.accept(i -&gt;</span>
<span class="line-added">1541                 i.certInfo == null ? &quot;no alias&quot; : &quot;&quot; + i.certInfo);</span>
<span class="line-added">1542         v_values_add.accept(i -&gt; HtmlHelper.anchorLink(</span>
1543                 PhaseOutputStream.fileName(PhaseOutputStream.Phase.VERIFYING),
<a name="156" id="anc156"></a><span class="line-modified">1544                 verifyingId(signItem, i, false),</span>
<span class="line-modified">1545                 &quot;&quot; + i.status.toString()));</span>
1546         if (DELAY_VERIFY) {
<a name="157" id="anc157"></a><span class="line-modified">1547             v_values_add.accept(i -&gt; HtmlHelper.anchorLink(</span>
1548                     PhaseOutputStream.fileName(
1549                             PhaseOutputStream.Phase.DELAY_VERIFYING),
1550                     verifyingId(signItem, verifyItem, true),
1551                     verifyItem.delayStatus.toString()));
1552         }
1553         values.add(isFailed(signItem, verifyItem) ? &quot;X&quot; : &quot;&quot;);
1554         return HtmlHelper.htmlRow(values.toArray(new String[values.size()]));
1555     }
1556 
<a name="158" id="anc158"></a><span class="line-modified">1557     private static boolean isFailed(SignItem signItem, VerifyItem verifyItem) {</span>
<span class="line-modified">1558         System.out.println(&quot;isFailed: signItem = &quot; + signItem + &quot;, verifyItem = &quot; + verifyItem);</span>
<span class="line-modified">1559         // TODO: except known failing cases</span>
<span class="line-modified">1560 </span>
<span class="line-modified">1561         // Note about isAtLeastMajorVersion in the following conditions:</span>
<span class="line-added">1562         // signItem.jdkInfo is the jdk which signed the jar last and</span>
<span class="line-added">1563         // signItem.prevSign.jdkInfo is the jdk which signed the jar first</span>
<span class="line-added">1564         // assuming only two successive signatures as there actually are now.</span>
<span class="line-added">1565         // the first signature always works and always has. subject here is</span>
<span class="line-added">1566         // the update of an already signed jar. the following conditions always</span>
<span class="line-added">1567         // depend on the second jdk that updated the jar with another signature</span>
<span class="line-added">1568         // and the first one (signItem(.prevSign)+.jdkInfo) can be ignored.</span>
<span class="line-added">1569         // this is different for verifyItem. verifyItem.prevVerify refers to</span>
<span class="line-added">1570         // the first signature created by signItem(.prevSign)+.jdkInfo.</span>
<span class="line-added">1571         // all verifyItem(.prevVerify)+.jdkInfo however point always to the same</span>
<span class="line-added">1572         // jdk, only their certInfo is different. the same signatures are</span>
<span class="line-added">1573         // verified with different jdks in different top-level VerifyItems</span>
<span class="line-added">1574         // attached directly to signItem.verifyItems and not to</span>
<span class="line-added">1575         // verifyItem.prevVerify.</span>
<span class="line-added">1576 </span>
<span class="line-added">1577         // ManifestDigester fails to parse manifests ending in &#39;\r&#39; with</span>
<span class="line-added">1578         // IndexOutOfBoundsException at ManifestDigester.java:87 before 8217375</span>
<span class="line-added">1579         if (signItem.signedJar.startsWith(&quot;eofr&quot;)</span>
<span class="line-added">1580                 &amp;&amp; !signItem.jdkInfo.isAtLeastMajorVersion(13)</span>
<span class="line-added">1581                 &amp;&amp; !verifyItem.jdkInfo.isAtLeastMajorVersion(13)) return false;</span>
<span class="line-added">1582 </span>
<span class="line-added">1583         // if there is no blank line after main attributes, JarSigner adds</span>
<span class="line-added">1584         // individual sections nevertheless without being properly delimited</span>
<span class="line-added">1585         // in JarSigner.java:777..790 without checking for blank line</span>
<span class="line-added">1586         // before 8217375</span>
<span class="line-added">1587 //        if (signItem.signedJar.startsWith(&quot;eofn-&quot;)</span>
<span class="line-added">1588 //                &amp;&amp; signItem.signedJar.contains(&quot;-addfile-&quot;)</span>
<span class="line-added">1589 //                &amp;&amp; !signItem.jdkInfo.isAtLeastMajorVersion(13)</span>
<span class="line-added">1590 //                &amp;&amp; !verifyItem.jdkInfo.isAtLeastMajorVersion(13)) return false; // FIXME</span>
<span class="line-added">1591 </span>
<span class="line-added">1592 //        System.out.println(&quot;isFailed: signItem.isErrorInclPrev() &quot; + signItem.isErrorInclPrev());</span>
<span class="line-added">1593 //        System.out.println(&quot;isFailed: verifyItem.isErrorInclPrev() &quot; + verifyItem.isErrorInclPrev());</span>
<span class="line-added">1594         boolean isFailed = signItem.isErrorInclPrev() || verifyItem.isErrorInclPrev();</span>
<span class="line-added">1595         System.out.println(&quot;isFailed: returning &quot; + isFailed);</span>
<span class="line-added">1596         return isFailed;</span>
1597     }
1598 
1599     // If a value is null, then displays the default value or N/A.
1600     private static String null2Default(String value, String defaultValue) {
<a name="159" id="anc159"></a><span class="line-modified">1601         return value != null ? value :</span>
<span class="line-modified">1602                DEFAULT + &quot;(&quot; + (defaultValue == null</span>
1603                                   ? &quot;N/A&quot;
<a name="160" id="anc160"></a><span class="line-modified">1604                                   : defaultValue) + &quot;)&quot;;</span>

1605     }
<a name="161" id="anc161"></a><span class="line-added">1606 </span>
1607 }
<a name="162" id="anc162"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="162" type="hidden" />
</body>
</html>