<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/tools/jarsigner/JavaKeyStoreAliasCaseInsensitive.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8221719
 27  * @library /test/lib
 28  * @run testng JavaKeyStoreAliasCaseInsensitive
 29  * @summary Checks that jarsigner verifies a signed jar with the same alias as
 30  * was specified for signing, particularly regarding upper and lower case and
 31  * its conversion to lower case by JKS
 32  * ({@link sun.security.provider.JavaKeyStore.JKS#convertAlias(String)}).
 33  */
 34 
 35 import java.nio.file.Files;
 36 import java.nio.file.Paths;
 37 import jdk.test.lib.util.JarUtils;
 38 import jdk.test.lib.SecurityTools;
 39 import org.testng.annotations.Test;
 40 
 41 public class JavaKeyStoreAliasCaseInsensitive {
 42 
 43     /**
 44      * Alias for certificates in the keystore with letters in different
 45      * (upper and lower) cases.
 46      */
 47     static final String ALIAS = &quot;AlIaS&quot;;
 48 
 49     @Test
 50     public void testAliasCase() throws Exception {
 51         final String KEYSTORE_OPTIONS = &quot;-storetype JKS -keystore &quot;
 52                 + &quot;test-alias-case.jks -storepass changeit&quot;;
 53         SecurityTools.keytool(KEYSTORE_OPTIONS + &quot; -genkeypair -keyalg DSA&quot;
 54                 + &quot; -keypass changeit -alias &quot; + ALIAS + &quot; -dname CN=&quot; + ALIAS)
 55                 .shouldHaveExitValue(0);
 56         String jarFilename = &quot;test-alias-case.jar&quot;;
 57         JarUtils.createJarFile(Paths.get(jarFilename), Paths.get(&quot;.&quot;),
 58                 Files.write(Paths.get(&quot;aFile&quot;), new byte[1]));
 59 
 60         SecurityTools.jarsigner(KEYSTORE_OPTIONS + &quot; -verbose -debug &quot; +
 61                 jarFilename + &quot; &quot; + ALIAS).shouldHaveExitValue(0);
 62 
 63         SecurityTools.jarsigner(&quot;-verify -strict &quot; + KEYSTORE_OPTIONS +
 64                 &quot; -debug -verbose &quot; + jarFilename + &quot; &quot; + ALIAS)
 65                 .shouldHaveExitValue(0)
 66                 .shouldNotContain(
 67                         &quot;This jar contains signed entries which are not &quot;
 68                         + &quot;signed by the specified alias(es).&quot;);
 69     }
 70 
 71     /**
 72      * This test essentially covers compatibility with the previous version of
 73      * {@link sun.security.tools.jarsigner.Main#inKeyStoreForOneSigner} in case
 74      * a certificate and alias entry is already in
 75      * {@link sun.security.tools.jarsigner.Main#storeHash} when
 76      * {@link sun.security.tools.jarsigner.Main#inKeyStoreForOneSigner} is
 77      * invoked from a previous invocation of it.
 78      * It passed with the previous {@code jarsigner} version with a lowercase
 79      * alias {@link #ALIAS} and basically covers the duplicated portions of
 80      * code in {@link sun.security.tools.jarsigner.Main#inKeyStoreForOneSigner}
 81      * near {@code IN_KEYSTORE} and {@code SIGNED_BY_ALIAS} before having
 82      * refactored and re-unified them in order to demonstrate identical
 83      * behavior.
 84      */
 85     @Test
 86     public void testAliasCaseStoreHash() throws Exception {
 87         // Create a keystore with a certificate associated with ALIAS + &quot;2&quot;
 88         // signed by another certificate associated with ALIAS + &quot;1&quot;.
 89         final String KEYSTORE_OPTIONS = &quot;-storetype JKS -keystore&quot;
 90                 + &quot; test-alias-storeHash-case.jks -storepass changeit&quot;;
 91         SecurityTools.keytool(KEYSTORE_OPTIONS + &quot; -genkeypair -keyalg DSA&quot;
 92                 + &quot; -keypass changeit -alias &quot; + ALIAS + &quot;1 -dname CN=&quot; +
 93                 ALIAS + &quot;1&quot; + &quot; -ext bc:c&quot;).shouldHaveExitValue(0);
 94         SecurityTools.keytool(KEYSTORE_OPTIONS + &quot; -genkeypair -keyalg DSA&quot;
 95                 + &quot; -keypass changeit -alias &quot; + ALIAS + &quot;2 -dname CN=&quot;
 96                 + ALIAS + &quot;2&quot;).shouldHaveExitValue(0);
 97         String certReq = SecurityTools.keytool(KEYSTORE_OPTIONS +
 98                 &quot; -certreq -keypass changeit -alias &quot; + ALIAS + &quot;2&quot;)
 99                 .shouldHaveExitValue(0).getStdout();
100         SecurityTools.setResponse(certReq);
101         String cert = SecurityTools.keytool(KEYSTORE_OPTIONS +
102                 &quot; -gencert -rfc -keypass changeit -alias &quot; + ALIAS + &quot;1&quot;)
103                 .shouldHaveExitValue(0).getOutput();
104         SecurityTools.setResponse(cert);
105         SecurityTools.keytool(KEYSTORE_OPTIONS +
106                 &quot; -importcert -keypass changeit -alias &quot; + ALIAS + &quot;2&quot;)
107                 .shouldHaveExitValue(0);
108 
109         // Create a jar file signed by ALIAS + &quot;2&quot; and then add another file to
110         // that same jar and sign it by ALIAS + &quot;1&quot;, ALIAS + &quot;1&quot; being an alias
111         // for a certificate which is part of the certificate chain of ALIAS +
112         // &quot;2&quot; but not the certificate ALIAS + &quot;2&quot; points to directly.
113         String jarFilename = &quot;test-alias-storeHash-case.jar&quot;;
114         JarUtils.createJarFile(Paths.get(jarFilename), Paths.get(&quot;.&quot;));
115         SecurityTools.jarsigner(KEYSTORE_OPTIONS + &quot; -verbose -debug &quot; +
116                 jarFilename + &quot; &quot; + ALIAS + &quot;2&quot;).shouldHaveExitValue(0);
117         JarUtils.updateJarFile(Paths.get(jarFilename), Paths.get(&quot;.&quot;),
118                 Files.write(Paths.get(&quot;added-file&quot;), new byte[1]));
119         SecurityTools.jarsigner(KEYSTORE_OPTIONS + &quot; -verbose -debug &quot; +
120                 jarFilename + &quot; &quot; + ALIAS + &quot;1&quot;).shouldHaveExitValue(0);
121 
122         // The later added file &quot;added-file&quot; is signed by the certificate
123         // associated with alias ALIAS + &quot;1&quot; directly while the other jarfile
124         // contents is signed by a certificate associated with alias ALIAS + &quot;2&quot;
125         // which includes the certificate associated with alias ALIAS + &quot;1&quot; in
126         // its certification path.
127         SecurityTools.jarsigner(&quot;-verify -strict &quot; + KEYSTORE_OPTIONS +
128                 &quot; -debug -verbose &quot; + jarFilename + &quot; &quot; + ALIAS + &quot;1&quot;)
129                 .shouldHaveExitValue(0)
130                 .shouldNotContain(
131                         &quot;This jar contains signed entries which are not &quot;
132                         + &quot;signed by the specified alias(es).&quot;);
133     }
134 
135 }
    </pre>
  </body>
</html>