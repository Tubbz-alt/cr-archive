<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/jarsigner/warnings/Test.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a>


 24 import java.util.ArrayList;
 25 import java.util.Arrays;
 26 import java.util.List;
<a name="3" id="anc3"></a><span class="line-added"> 27 import java.util.stream.Collectors;</span>
<span class="line-added"> 28 </span>
<span class="line-added"> 29 import jdk.test.lib.process.OutputAnalyzer;</span>
<span class="line-added"> 30 import jdk.test.lib.process.ProcessTools;</span>
 31 
 32 /**
 33  * Base class.
 34  */
 35 public abstract class Test {
 36 
 37     static final String TEST_SOURCES = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 38     static final String TEST_CLASSES = System.getProperty(&quot;test.classes&quot;);
 39     static final String FS = System.getProperty(&quot;file.separator&quot;);
 40     static final String JAVA_HOME = System.getProperty(&quot;java.home&quot;);
 41     static final String KEYTOOL = JAVA_HOME + FS + &quot;bin&quot; + FS + &quot;keytool&quot;;
 42     static final String JARSIGNER = JAVA_HOME + FS + &quot;bin&quot; + FS + &quot;jarsigner&quot;;
 43     static final String UNSIGNED_JARFILE = &quot;unsigned.jar&quot;;
 44     static final String SIGNED_JARFILE = &quot;signed.jar&quot;;
 45     static final String UPDATED_SIGNED_JARFILE = &quot;updated_signed.jar&quot;;
 46     static final String FIRST_FILE = &quot;first.txt&quot;;
 47     static final String SECOND_FILE = &quot;second.txt&quot;;
 48     static final String PASSWORD = &quot;password&quot;;
 49     static final String FIRST_KEY_KEYSTORE = &quot;first_key.jks&quot;;
 50     static final String KEYSTORE = &quot;keystore.jks&quot;;
 51     static final String FIRST_KEY_ALIAS = &quot;first&quot;;
 52     static final String SECOND_KEY_ALIAS = &quot;second&quot;;
 53     static final String KEY_ALG = &quot;RSA&quot;;
 54     static final String KEY_ALIAS = &quot;alias&quot;;
 55     static final String CERT_REQUEST_FILENAME = &quot;test.req&quot;;
 56     static final String CERT_FILENAME = &quot;test.crt&quot;;
 57     static final String CA_KEY_ALIAS = &quot;ca&quot;;
 58     static final String CA2_KEY_ALIAS = &quot;ca2&quot;;
 59     static final int KEY_SIZE = 2048;
 60     static final int TIMEOUT = 6 * 60 * 1000;   // in millis
 61     static final int VALIDITY = 365;
 62 
 63     static final String WARNING = &quot;Warning:&quot;;
<a name="4" id="anc4"></a><span class="line-modified"> 64     static final String ERROR = &quot;[Ee]rror:&quot;;</span>
<span class="line-added"> 65     static final String WARNING_OR_ERROR = &quot;(&quot; + WARNING + &quot;|&quot; + ERROR + &quot;)&quot;;</span>
 66 
 67     static final String CHAIN_NOT_VALIDATED_VERIFYING_WARNING
 68             = &quot;This jar contains entries &quot;
 69             + &quot;whose certificate chain is invalid.&quot;;
 70 
<a name="5" id="anc5"></a><span class="line-added"> 71     static final String CERTIFICATE_SELF_SIGNED</span>
<span class="line-added"> 72             = &quot;The signer&#39;s certificate is self-signed.&quot;;</span>
<span class="line-added"> 73 </span>
 74     static final String ALIAS_NOT_IN_STORE_VERIFYING_WARNING
 75             = &quot;This jar contains signed entries &quot;
 76             + &quot;that are not signed by alias in this keystore.&quot;;
 77 
 78     static final String BAD_EXTENDED_KEY_USAGE_SIGNING_WARNING
 79             = &quot;The signer certificate&#39;s ExtendedKeyUsage extension &quot;
 80             + &quot;doesn&#39;t allow code signing.&quot;;
 81 
 82     static final String BAD_EXTENDED_KEY_USAGE_VERIFYING_WARNING
 83             = &quot;This jar contains entries whose signer certificate&#39;s &quot;
 84             + &quot;ExtendedKeyUsage extension doesn&#39;t allow code signing.&quot;;
 85 
 86     static final String BAD_KEY_USAGE_SIGNING_WARNING
 87             = &quot;The signer certificate&#39;s KeyUsage extension &quot;
 88             + &quot;doesn&#39;t allow code signing.&quot;;
 89 
 90     static final String BAD_KEY_USAGE_VERIFYING_WARNING
 91             = &quot;This jar contains entries whose signer certificate&#39;s KeyUsage &quot;
 92             + &quot;extension doesn&#39;t allow code signing.&quot;;
 93 
 94     static final String BAD_NETSCAPE_CERT_TYPE_SIGNING_WARNING
 95             = &quot;The signer certificate&#39;s NetscapeCertType extension &quot;
 96             + &quot;doesn&#39;t allow code signing.&quot;;
 97 
 98     static final String BAD_NETSCAPE_CERT_TYPE_VERIFYING_WARNING
 99             = &quot;This jar contains entries &quot;
100             + &quot;whose signer certificate&#39;s NetscapeCertType extension &quot;
101             + &quot;doesn&#39;t allow code signing.&quot;;
102 
103     static final String CHAIN_NOT_VALIDATED_SIGNING_WARNING
104             = &quot;The signer&#39;s certificate chain is invalid.&quot;;
105 
106     static final String HAS_EXPIRING_CERT_SIGNING_WARNING
107             = &quot;The signer certificate will expire within six months.&quot;;
108 
109     static final String HAS_EXPIRING_CERT_VERIFYING_WARNING
110             = &quot;This jar contains entries &quot;
111             + &quot;whose signer certificate will expire within six months.&quot;;
112 
113     static final String HAS_EXPIRED_CERT_SIGNING_WARNING
114             = &quot;The signer certificate has expired.&quot;;
115 
116     static final String HAS_EXPIRED_CERT_VERIFYING_WARNING
117             = &quot;This jar contains entries whose signer certificate has expired.&quot;;
118 
119     static final String HAS_UNSIGNED_ENTRY_VERIFYING_WARNING
120             = &quot;This jar contains unsigned entries &quot;
121             + &quot;which have not been integrity-checked.&quot;;
122 
123     static final String NOT_SIGNED_BY_ALIAS_VERIFYING_WARNING
124             = &quot;This jar contains signed entries &quot;
125             + &quot;which are not signed by the specified alias(es).&quot;;
126 
127     static final String NO_TIMESTAMP_SIGNING_WARN_TEMPLATE
128             = &quot;No -tsa or -tsacert is provided &quot;
129             + &quot;and this jar is not timestamped. &quot;
130             + &quot;Without a timestamp, users may not be able to validate this jar &quot;
131             + &quot;after the signer certificate&#39;s expiration date &quot;
132             + &quot;(%1$tY-%1$tm-%1$td).&quot;;
133 
134     static final String NO_TIMESTAMP_VERIFYING_WARN_TEMPLATE
135             = &quot;This jar contains signatures that do not include a timestamp. &quot;
136             + &quot;Without a timestamp, users may not be able to validate this jar &quot;
137             + &quot;after any of the signer certificates expire &quot;
138             + &quot;(as early as %1$tY-%1$tm-%1$td).&quot;;
139 
140     static final String NOT_YET_VALID_CERT_SIGNING_WARNING
141             = &quot;The signer certificate is not yet valid.&quot;;
142 
143     static final String NOT_YET_VALID_CERT_VERIFYING_WARNING
144             = &quot;This jar contains entries &quot;
145             + &quot;whose signer certificate is not yet valid.&quot;;
146 
147     static final String JAR_SIGNED = &quot;jar signed.&quot;;
148 
149     static final String JAR_VERIFIED = &quot;jar verified.&quot;;
150 
151     static final String JAR_VERIFIED_WITH_SIGNER_ERRORS
152             = &quot;jar verified, with signer errors.&quot;;
153 
154     static final int CHAIN_NOT_VALIDATED_EXIT_CODE = 4;
155     static final int HAS_EXPIRED_CERT_EXIT_CODE = 4;
156     static final int BAD_KEY_USAGE_EXIT_CODE = 8;
157     static final int BAD_EXTENDED_KEY_USAGE_EXIT_CODE = 8;
158     static final int BAD_NETSCAPE_CERT_TYPE_EXIT_CODE = 8;
159     static final int HAS_UNSIGNED_ENTRY_EXIT_CODE = 16;
160     static final int ALIAS_NOT_IN_STORE_EXIT_CODE = 32;
161     static final int NOT_SIGNED_BY_ALIAS_EXIT_CODE = 32;
162 
163     protected void createAlias(String alias, String ... options)
164             throws Throwable {
165         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
166         cmd.addAll(List.of(
167                 &quot;-genkeypair&quot;,
168                 &quot;-alias&quot;, alias,
169                 &quot;-keyalg&quot;, KEY_ALG,
170                 &quot;-keysize&quot;, Integer.toString(KEY_SIZE),
171                 &quot;-keystore&quot;, KEYSTORE,
172                 &quot;-storepass&quot;, PASSWORD,
173                 &quot;-keypass&quot;, PASSWORD,
174                 &quot;-dname&quot;, &quot;CN=&quot; + alias));
175         cmd.addAll(Arrays.asList(options));
176 
177         keytool(cmd.toArray(new String[cmd.size()]))
178                 .shouldHaveExitValue(0);
179     }
180 
181     protected void issueCert(String alias, String ... options)
182             throws Throwable {
183         keytool(&quot;-certreq&quot;,
184                 &quot;-alias&quot;, alias,
185                 &quot;-keystore&quot;, KEYSTORE,
186                 &quot;-storepass&quot;, PASSWORD,
187                 &quot;-keypass&quot;, PASSWORD,
188                 &quot;-file&quot;, alias + &quot;.req&quot;)
189                     .shouldHaveExitValue(0);
190 
191         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
192         cmd.addAll(List.of(
193                 &quot;-gencert&quot;,
194                 &quot;-alias&quot;, CA_KEY_ALIAS,
195                 &quot;-infile&quot;, alias + &quot;.req&quot;,
196                 &quot;-outfile&quot;, alias + &quot;.cert&quot;,
197                 &quot;-keystore&quot;, KEYSTORE,
198                 &quot;-storepass&quot;, PASSWORD,
199                 &quot;-keypass&quot;, PASSWORD,
200                 &quot;-file&quot;, alias + &quot;.req&quot;));
201         cmd.addAll(Arrays.asList(options));
202 
203         keytool(cmd.toArray(new String[cmd.size()]))
204                 .shouldHaveExitValue(0);
205 
206         keytool(&quot;-importcert&quot;,
207                 &quot;-alias&quot;, alias,
208                 &quot;-keystore&quot;, KEYSTORE,
209                 &quot;-storepass&quot;, PASSWORD,
210                 &quot;-keypass&quot;, PASSWORD,
211                 &quot;-file&quot;, alias + &quot;.cert&quot;)
212                     .shouldHaveExitValue(0);
213     }
214 
215     protected void checkVerifying(OutputAnalyzer analyzer, int expectedExitCode,
216             String... warnings) {
217         analyzer.shouldHaveExitValue(expectedExitCode);
218         int count = 0;
219         for (String warning : warnings) {
220             if (warning.startsWith(&quot;!&quot;)) {
221                 analyzer.shouldNotContain(warning.substring(1));
222             } else {
223                 count++;
224                 analyzer.shouldContain(warning);
225             }
226         }
227         if (count &gt; 0) {
228             analyzer.shouldMatch(WARNING_OR_ERROR);
229         }
230         if (expectedExitCode == 0) {
231             analyzer.shouldContain(JAR_VERIFIED);
232         } else {
233             analyzer.shouldContain(JAR_VERIFIED_WITH_SIGNER_ERRORS);
234         }
235     }
236 
237     protected void checkSigning(OutputAnalyzer analyzer, String... warnings) {
238         analyzer.shouldHaveExitValue(0);
239         int count = 0;
240         for (String warning : warnings) {
241             if (warning.startsWith(&quot;!&quot;)) {
242                 analyzer.shouldNotContain(warning.substring(1));
243             } else {
244                 count++;
245                 analyzer.shouldContain(warning);
246             }
247         }
248         if (count &gt; 0) {
249             analyzer.shouldMatch(WARNING_OR_ERROR);
250         }
251         analyzer.shouldContain(JAR_SIGNED);
252     }
253 
254     protected OutputAnalyzer keytool(String... cmd) throws Throwable {
255         return tool(KEYTOOL, cmd);
256     }
257 
258     protected OutputAnalyzer jarsigner(String... cmd) throws Throwable {
259         return tool(JARSIGNER, cmd);
260     }
261 
262     private OutputAnalyzer tool(String tool, String... args) throws Throwable {
263         List&lt;String&gt; cmd = new ArrayList&lt;&gt;();
264         cmd.add(tool);
265         cmd.add(&quot;-J-Duser.language=en&quot;);
266         cmd.add(&quot;-J-Duser.country=US&quot;);
<a name="6" id="anc6"></a><span class="line-modified">267         cmd.addAll(Arrays.asList(args).stream().filter(arg -&gt; {</span>
<span class="line-added">268             return arg != null &amp;&amp; !arg.isEmpty();</span>
<span class="line-added">269         }).collect(Collectors.toList()));</span>
270         return ProcessTools.executeCommand(cmd.toArray(new String[cmd.size()]));
271     }
272 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>