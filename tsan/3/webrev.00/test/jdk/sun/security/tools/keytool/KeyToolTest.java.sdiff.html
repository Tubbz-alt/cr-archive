<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/tools/keytool/KeyToolTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ImportPrompt.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="NssTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/keytool/KeyToolTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<span class="line-modified">  26  * @author weijun.wang</span>
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
</pre>
<hr />
<pre>
 180             sun.security.tools.keytool.Main.main((&quot;-debug &quot;+cmd).split(&quot;\\s+&quot;));
 181         } finally {
 182             out = b1.toString();
 183             err = b2.toString();
 184             ex = out;   // now it goes to System.out
 185             System.setIn(i1);
 186             System.setOut(p1);
 187             System.setErr(p2);
 188         }
 189     }
 190 
 191     /**
 192      * Call this method if you expect test(input, cmd) should go OK
 193      */
 194     void testOK(String input, String cmd) throws Exception {
 195         try {
 196             // Workaround for &quot;8057810: Make SHA256withDSA the default
 197             // jarsigner and keytool algorithm for DSA keys&quot;. Unfortunately
 198             // SunPKCS11-NSS does not support SHA256withDSA yet.
 199             if (cmd.contains(&quot;p11-nss.txt&quot;) &amp;&amp; cmd.contains(&quot;-genkey&quot;)
<span class="line-modified"> 200                     &amp;&amp; !cmd.contains(&quot;-keyalg&quot;)) {</span>
 201                 cmd += &quot; -sigalg SHA1withDSA -keysize 1024&quot;;
 202             }
 203             test(input, cmd);
 204         } catch(Exception e) {
 205             afterFail(input, cmd, &quot;OK&quot;);
 206             throw e;
 207         }
 208     }
 209 
 210     /**
 211      * Call this method if you expect test(input, cmd) should fail and throw
 212      * an exception
 213      */
 214     void testFail(String input, String cmd) throws Exception {
 215         boolean ok;
 216         try {
 217             test(input, cmd);
 218             ok = true;
 219         } catch(Exception e) {
 220             if (e instanceof MissingResourceException) {
</pre>
<hr />
<pre>
 335     }
 336 
 337     /**
 338      * The test suite.
 339      * Maybe it&#39;s better to put this outside the KeyToolTest class
 340      */
 341     void testAll() throws Exception {
 342         KeyStore ks;
 343 
 344         remove(&quot;x.jks&quot;);
 345         remove(&quot;x.jceks&quot;);
 346         remove(&quot;x.p12&quot;);
 347         remove(&quot;x2.jceks&quot;);
 348         remove(&quot;x2.jks&quot;);
 349         remove(&quot;x.jks.p1.cert&quot;);
 350 
 351         // name changes: genkeypair, importcert, exportcert
 352         remove(&quot;x.jks&quot;);
 353         remove(&quot;x.jks.p1.cert&quot;);
 354         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 355                 &quot;-keypass changeit -genkeypair -alias p1 -dname CN=olala&quot;);</span>
 356         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 357                 &quot;-exportcert -alias p1 -file x.jks.p1.cert&quot;);
 358         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 359         assertTrue(ks.getKey(&quot;p1&quot;, &quot;changeit&quot;.toCharArray()) != null,
 360             &quot;key not DSA&quot;);
 361         assertTrue(new File(&quot;x.jks.p1.cert&quot;).exists(), &quot;p1 export err&quot;);
 362         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 363                 &quot;-delete -alias p1&quot;);
 364         // importcert, prompt for Yes/No
 365         testOK(&quot;y\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 366                 &quot;-importcert -alias c1 -file x.jks.p1.cert&quot;);
 367         // importcert, -noprompt
 368         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 369                 &quot;-importcert -alias c2 -file x.jks.p1.cert -noprompt&quot;);
 370         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 371         assertTrue(ks.getCertificate(&quot;c1&quot;) != null, &quot;import c1 err&quot;);
 372 
 373         // v3
 374         byte[] encoded = ks.getCertificate(&quot;c1&quot;).getEncoded();
 375         X509CertImpl certImpl = new X509CertImpl(encoded);
 376         assertTrue(certImpl.getVersion() == 3, &quot;Version is not 3&quot;);
 377 
 378         // changealias and keyclone
 379         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 380                 &quot;-keypass changeit -genkeypair -alias p1 -dname CN=olala&quot;);</span>
 381         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 382                 &quot;-changealias -alias p1 -destalias p11&quot;);
 383         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 384                 &quot;-changealias -alias c1 -destalias c11&quot;);
 385         // press ENTER when prompt for p111&#39;s keypass
 386         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 387                 &quot;-keyclone -alias p11 -destalias p111&quot;);
 388         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 389         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;there is no p1&quot;);
 390         assertTrue(!ks.containsAlias(&quot;c1&quot;), &quot;there is no c1&quot;);
 391         assertTrue(ks.containsAlias(&quot;p11&quot;), &quot;there is p11&quot;);
 392         assertTrue(ks.containsAlias(&quot;c11&quot;), &quot;there is c11&quot;);
 393         assertTrue(ks.containsAlias(&quot;p111&quot;), &quot;there is p111&quot;);
 394 
 395         // genSecKey
 396         remove(&quot;x.jceks&quot;);
 397         // DES, no need keysize
 398         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 399                 &quot;-genseckey -alias s1&quot;);</span>
 400         // DES, keysize cannot be 128
 401         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 402                 &quot;-genseckey -alias s11 -keysize 128&quot;);</span>
 403         // DESede. no need keysize
 404         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 405                 &quot;-genseckey -keyalg DESede -alias s2&quot;);
 406         // AES, need keysize
 407         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype AES &quot; +
 408                 &quot;-genseckey -keyalg Rijndael -alias s3&quot;);
 409         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 410                 &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 411         // about keypass
 412         // can accept storepass
 413         testOK(&quot;\n&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
<span class="line-modified"> 414                 &quot;-genseckey -alias s4&quot;);</span>
 415         // or a new one
 416         testOK(&quot;keypass\nkeypass\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 417                 &quot;-storepass changeit -genseckey -alias s5&quot;);</span>
 418         // keypass must be valid (prompt 3 times)
 419         testOK(&quot;bad\n\bad\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 420                 &quot;-storetype JCEKS -storepass changeit -genseckey -alias s6&quot;);</span>

 421         // keypass must be valid (prompt 3 times)
 422         testFail(&quot;bad\n\bad\nbad\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 423                 &quot;-storepass changeit -genseckey -alias s7&quot;);</span>
 424         // keypass must be valid (prompt 3 times)
 425         testFail(&quot;bad\n\bad\nbad\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 426                 &quot;-storetype JCEKS -storepass changeit -genseckey -alias s7&quot;);</span>
 427         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 428         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 429                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s1 is DES&quot;);
 430         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 431                 .getEncoded().length == 8,  &quot;DES is 56&quot;);
 432         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 433                 .getEncoded().length == 24,  &quot;DESede is 168&quot;);
 434         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 435                 .getAlgorithm().equalsIgnoreCase(&quot;DESede&quot;), &quot;s2 is DESede&quot;);
 436         assertTrue(ks.getKey(&quot;s3&quot;, &quot;changeit&quot;.toCharArray())
 437                 .getAlgorithm().equalsIgnoreCase(&quot;AES&quot;), &quot;s3 is AES&quot;);
 438         assertTrue(ks.getKey(&quot;s4&quot;, &quot;changeit&quot;.toCharArray())
 439                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s4 is DES&quot;);
 440         assertTrue(ks.getKey(&quot;s5&quot;, &quot;keypass&quot;.toCharArray())
 441                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s5 is DES&quot;);
 442         assertTrue(ks.getKey(&quot;s6&quot;, &quot;keypass&quot;.toCharArray())
 443                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s6 is DES&quot;);
 444         assertTrue(!ks.containsAlias(&quot;s7&quot;), &quot;s7 not created&quot;);
 445 
 446         // maybe we needn&#39;t test this, one day JKS will support SecretKey
 447         //testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 448         //        &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 449 
 450         // importKeyStore
 451         remove(&quot;x.jks&quot;);
 452         remove(&quot;x.jceks&quot;);
 453         // create 2 entries...
 454         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 455                 &quot;-genkeypair -alias p1 -dname CN=Olala&quot;);</span>
 456         testOK(&quot;&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 457                 &quot;-importcert -alias c1 -file x.jks.p1.cert -noprompt&quot;);
 458         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 459         assertTrue(ks.size() == 2, &quot;2 entries in JCEKS&quot;);
 460         // import, shouldn&#39;t mention destalias/srckeypass/destkeypass
 461         // if srcalias is no given
 462         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 463                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 464                 &quot;-destkeystore x.jks -deststoretype JKS -destalias pp&quot;);
 465         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 466                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 467                 &quot;-destkeystore x.jks -deststoretype JKS -srckeypass changeit&quot;);
 468         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 469                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 470                 &quot;-destkeystore x.jks -deststoretype JKS -destkeypass changeit&quot;);
 471         // normal import
 472         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 473                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 474                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 475         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
</pre>
<hr />
<pre>
 515         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 516         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 517         // rename
 518         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 519                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 520                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 521                 &quot;-srcalias p1 -destalias p2&quot;);
 522         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 523         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 524         // another rename
 525         testOK(&quot;changeit\nchangeit\n\nnewalias\n&quot;, &quot;-importkeystore &quot; +
 526                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 527                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 528         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 529         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 530 
 531         // importkeystore single, different keypass
 532         remove(&quot;x.jks&quot;);
 533         // generate entry with different keypass
 534         testOK(&quot;changeit\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 535                 &quot;-storetype JCEKS -genkeypair -alias p2 -dname CN=Olala&quot;);</span>
 536         // prompt
 537         testOK(&quot;changeit\nchangeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 538                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 539                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p2&quot;);
 540         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 541         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 542         // diff destkeypass
 543         testOK(&quot;changeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 544                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 545                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 546                 &quot;-srcalias p2 -destalias p3 -destkeypass keypass2&quot;);
 547         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 548         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 549         assertTrue(ks.getKey(&quot;p2&quot;, &quot;keypass&quot;.toCharArray()) != null,
 550                 &quot;p2 has old password&quot;);
 551         assertTrue(ks.getKey(&quot;p3&quot;, &quot;keypass2&quot;.toCharArray()) != null,
 552                 &quot;p3 has new password&quot;);
 553 
 554         // importkeystore single, cert
 555         remove(&quot;x.jks&quot;);
</pre>
<hr />
<pre>
 564                 &quot;-srcalias c1 -destalias c2&quot;);
 565         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;But will warn&quot;);
 566         // 2nd import, press y to overwrite ...
 567         testOK(&quot;changeit\n\ny\n&quot;, &quot;-importkeystore &quot; +
 568                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 569                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 570                 &quot;-srcalias c1 -destalias c2&quot;);
 571         // ... or rename
 572         testOK(&quot;changeit\n\n\nc3\n&quot;, &quot;-importkeystore &quot; +
 573                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 574                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 575                 &quot;-srcalias c1 -destalias c2&quot;);
 576         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 577         // c1, c2, c3
 578         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 579 
 580         // importkeystore, secretkey
 581         remove(&quot;x.jks&quot;);
 582         // create SecretKeyEntry
 583         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 584                 &quot;-genseckey -alias s1&quot;);</span>
 585         // create SecretKeyEntry
 586         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 587                 &quot;-genseckey -alias s2&quot;);</span>
 588         // remove the keypass!=storepass one
 589         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 590                 &quot;-delete -alias p2&quot;);
 591         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 592         // p1, c1, s1, s2
 593         assertTrue(ks.size() == 4, &quot;4 entries in JCEKS&quot;);
 594         // normal
 595         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 596                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 597                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias s1&quot;);
 598         assertTrue(err.indexOf(&quot;not imported&quot;) != -1, &quot;Not imported&quot;);
 599         assertTrue(err.indexOf(&quot;Cannot store non-PrivateKeys&quot;) != -1,
 600                 &quot;Not imported&quot;);
 601 
 602         // Importing a JCEKS keystore to a JKS one. Will warn
 603         // for the 2 SecretKey entries
 604 
 605         remove(&quot;x.jks&quot;);
 606         // Two &quot;no&quot; answers to bypass warnings
 607         // normal
</pre>
<hr />
<pre>
 612         assertTrue(err.indexOf(&quot;s2 not&quot;) != -1, &quot;s2 not&quot;);
 613         assertTrue(err.indexOf(&quot;c1 success&quot;) != -1, &quot;c1 success&quot;);
 614         assertTrue(err.indexOf(&quot;p1 success&quot;) != -1, &quot;p1 success&quot;);
 615         remove(&quot;x.jks&quot;);
 616         // One &quot;yes&quot; to stop
 617         // normal
 618         testOK(&quot;yes\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 619                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 620                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 621         // maybe c1 or p1 has been imported before s1 or s2 is touched,
 622         // anyway we know yesNo is only asked once.
 623 
 624         // pkcs12
 625         remove(&quot;x.jks&quot;);
 626         // JKS prompt for keypass
 627         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 628                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 629         remove(&quot;x.jks&quot;);
 630         // just type ENTER means keypass=storepass
 631         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
<span class="line-modified"> 632                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);</span>
 633         remove(&quot;x.p12&quot;);
 634         // PKCS12 only need storepass
 635         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
<span class="line-modified"> 636                 &quot;-genkeypair -alias p0 -dname CN=olala&quot;);</span>
 637         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -storetype PKCS12 &quot; +
<span class="line-modified"> 638                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);</span>
 639         // when specify keypass, make sure keypass==storepass...
 640         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass changeit &quot; +
 641                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 642         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 643                 &quot;PKCS12 silent when keypass == storepass&quot;);
 644         // otherwise, print a warning
 645         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass another&quot; +
 646                 &quot; -storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 647         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 648                 &quot;PKCS12 warning when keypass != storepass&quot;);
 649         // no -keypasswd for PKCS12
 650         testFail(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12&quot; +
 651                 &quot; -keypasswd -new changeit -alias p3&quot;);
 652         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 653                 &quot;-changealias -alias p3 -destalias p33&quot;);
 654         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 655                 &quot;-keyclone -alias p33 -destalias p3&quot;);
 656 
 657         // pkcs12
 658         remove(&quot;x.p12&quot;);
 659         // PKCS12 only need storepass
 660         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
<span class="line-modified"> 661                 &quot;-genkeypair -alias p0 -dname CN=olala&quot;);</span>
 662         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -storetype PKCS12 &quot; +
<span class="line-modified"> 663                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);</span>
 664         // when specify keypass, make sure keypass==storepass...
 665         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass changeit &quot; +
 666                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 667         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 668                 &quot;PKCS12 silent when keypass == storepass&quot;);
 669         // otherwise, print a warning
 670         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass another &quot; +
 671                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 672         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 673                 &quot;PKCS12 warning when keypass != storepass&quot;);
 674 
 675         remove(&quot;x.jks&quot;);
 676         remove(&quot;x.jceks&quot;);
 677         remove(&quot;x.p12&quot;);
 678         remove(&quot;x2.jceks&quot;);
 679         remove(&quot;x2.jks&quot;);
 680         remove(&quot;x.jks.p1.cert&quot;);
 681     }
 682 
 683     void testPKCS11() throws Exception {
 684         KeyStore ks;
 685         // pkcs11, the password maybe different and maybe PKCS11 not supported
 686 
 687         // in case last test is not executed successfully
 688         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 689         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 690         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p3&quot;);
 691         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias nss&quot;);
 692 
 693         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 694         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 695                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE &quot; +
 696                         &quot;BEFORE THIS TEST ***&quot;);
 697 
 698         testOK(&quot;&quot;, p11Arg +
<span class="line-modified"> 699                 &quot;-storepass test12 -genkeypair -alias p1 -dname CN=olala&quot;);</span>
<span class="line-modified"> 700         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -alias p2 -dname CN=olala2&quot;);</span>
 701         // cannot provide keypass for PKCS11
 702         testFail(&quot;test12\n&quot;, p11Arg +
<span class="line-modified"> 703                 &quot;-keypass test12 -genkeypair -alias p3 -dname CN=olala3&quot;);</span>
 704         // cannot provide keypass for PKCS11
 705         testFail(&quot;test12\n&quot;, p11Arg +
<span class="line-modified"> 706                 &quot;-keypass nonsense -genkeypair -alias p3 -dname CN=olala3&quot;);</span>
 707 
 708         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 709         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 710                 &quot;2 entries in p11&quot;);
 711 
 712         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -changealias -destalias p3&quot;);
 713         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 714         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 715 
 716         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p3 -keyclone -destalias p1&quot;);
 717         // in PKCS11, keyclone will delete old
 718         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 719         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 720 
 721         // cannot change password for PKCS11
 722         testFail(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -keypasswd -new another&quot;);
 723 
 724         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 725         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 726                 &quot;2 entries in p11&quot;);
 727 
 728         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 729         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 730 
 731         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 732         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 733                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE&quot; +
 734                         &quot; BEFORE THIS TEST ***&quot;);
 735     }
 736 
 737     void testPKCS11ImportKeyStore() throws Exception {
 738 
 739         KeyStore ks;
 740         testOK(&quot;&quot;, p11Arg +
<span class="line-modified"> 741                 &quot;-storepass test12 -genkeypair -alias p1 -dname CN=olala&quot;);</span>
<span class="line-modified"> 742         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -alias p2 -dname CN=olala2&quot;);</span>
 743         // test importkeystore for pkcs11
 744 
 745         remove(&quot;x.jks&quot;);
 746         // pkcs11 -&gt; jks
 747         testOK(&quot;changeit\nchangeit\ntest12\n&quot;, srcP11Arg +
 748                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 749                 &quot;-srcalias p1&quot;));
 750         assertTrue(err.indexOf(&quot;not imported&quot;) != -1,
 751                 &quot;cannot import key without destkeypass&quot;);
 752         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 753         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;p1 is not imported&quot;);
 754 
 755         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 756                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 757                 &quot;-srcalias p1 -destkeypass changeit&quot;));
 758         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 759                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 760                 &quot;-srcalias p2 -destkeypass changeit&quot;));
 761         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 762         assertTrue(ks.containsAlias(&quot;p1&quot;), &quot;p1 is imported&quot;);
</pre>
<hr />
<pre>
 792         sqeCsrTest();
 793         sqePrintcertTest();
 794         sqeDeleteTest();
 795         sqeExportTest();
 796         sqeGenkeyTest();
 797         sqeImportTest();
 798         sqeKeyclonetest();
 799         sqeKeypasswdTest();
 800         sqeListTest();
 801         sqeSelfCertTest();
 802         sqeStorepassTest();
 803 
 804         remove(&quot;badkeystore&quot;);
 805     }
 806 
 807     // Import: cacert, prompt, trusted, non-trusted, bad chain, not match
 808     void sqeImportTest() throws Exception {
 809         KeyStore ks;
 810         remove(&quot;x.jks&quot;);
 811         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 812                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 813         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 814                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 815         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 816                 &quot;-storepass changeit -delete -alias mykey&quot;);
 817         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 818                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 819         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 820                 &quot;-storepass changeit -delete -alias mykey&quot;);
 821         testOK(&quot;yes\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 822                 &quot;-importcert -file x.jks.p1.cert&quot;);
 823         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 824         assertTrue(ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 825         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 826                 &quot;-storepass changeit -delete -alias mykey&quot;);
 827         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 828                 &quot;-importcert -file x.jks.p1.cert&quot;);
 829         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 830         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 831         testOK(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 832                 &quot;-importcert -file x.jks.p1.cert&quot;);
 833         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 834         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 835         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 836                 &quot;-importcert -file nonexist&quot;);
 837         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 838                 &quot;-importcert -file x.jks&quot;);
 839         remove(&quot;x.jks&quot;);
 840     }
 841     // keyclone: exist. nonexist err, cert err, dest exist, misc
 842     void sqeKeyclonetest() throws Exception {
 843         remove(&quot;x.jks&quot;);
 844         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 845                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 846         // new pass
 847         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 848                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 849         // new pass
 850         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 851                 &quot;-keypass changeit -keyclone -dest p1&quot;);
 852         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 853                 &quot;-keyclone -dest p2&quot;);
 854         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 855                 &quot;-keyclone -dest p2&quot;);
 856         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 857                 &quot;-keyclone -dest p3 -alias noexist&quot;);
 858         // no cert
 859         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 860                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 861         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 862                 &quot;-delete -alias mykey&quot;);
 863         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 864                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 865         // new pass
 866         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 867                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 868         remove(&quot;x.jks&quot;);
 869     }
 870     // keypasswd: exist, short, nonexist err, cert err, misc
 871     void sqeKeypasswdTest() throws Exception {
 872         remove(&quot;x.jks&quot;);
 873         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 874                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 875         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 876                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 877         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 878                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 879         testOK(&quot;newpass\nnewpass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 880                 &quot;-storepass changeit -keypass changeit -keypasswd&quot;);
 881         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 882                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 883         testOK(&quot;new\nnew\nnewpass\nnewpass\n&quot;, &quot;-keystore x.jks &quot; +
 884                 &quot;-storetype JKS -storepass changeit -keypass changeit -keypasswd&quot;);
 885         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 886                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 887         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 888                 &quot;-keypasswd -new newpass&quot;);
 889         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 890                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 891         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 892                 &quot;-keypasswd -new newpass&quot;);
 893         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 894                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 895         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 896                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 897         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 898                 &quot;-keypass bad -keypasswd -new newpass&quot;);
 899         // no cert
 900         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 901                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 902         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 903                 &quot;-delete -alias mykey&quot;);
 904         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 905                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 906         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 907                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 908         // diff pass
 909         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 910                 &quot;-delete -alias mykey&quot;);
 911         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 912                 &quot;-keypass keypass -genkeypair -dname CN=olala&quot;);</span>
 913         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 914                 &quot;-keypasswd -new newpass&quot;);
 915         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 916                 &quot;-storepass changeit -keypasswd -new newpass&quot;);
 917         // i hate those misc test
 918         remove(&quot;x.jks&quot;);
 919     }
 920     // list: -f -alias, exist, nonexist err;
 921     // otherwise, check all shows, -rfc shows more, and misc
 922     void sqeListTest() throws Exception {
 923         remove(&quot;x.jks&quot;);
 924         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 925                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 926         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -list&quot;);
 927         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 928                 &quot;-list -alias mykey&quot;);
 929         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 930                 &quot;-list -alias notexist&quot;);
 931         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 932                 &quot;-list -alias mykey&quot;);
 933         // keypass ignore
 934         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 935                 &quot;-keypass badpass -list -alias mykey&quot;);
 936         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 937         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;no storepass&quot;);
 938         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 939         assertTrue(err.indexOf(&quot;WARNING&quot;) == -1, &quot;has storepass&quot;);
 940         testFail(&quot;badpass\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 941         // misc
 942         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc -storepass changeit -list&quot;);
 943         testFail(&quot;&quot;, &quot;-keystore nonexisting -storepass changeit -list&quot;);
 944         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit -list&quot;);
 945         remove(&quot;x.jks&quot;);
 946     }
 947     // selfcert: exist, non-exist err, cert err, sig, dname, wrong keypass, misc
 948     void sqeSelfCertTest() throws Exception {
 949         remove(&quot;x.jks&quot;);
 950         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 951                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 952         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -selfcert&quot;);
 953         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 954                 &quot;-keypass changeit -selfcert&quot;);
 955         // not exist
 956         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 957                 &quot;-keypass changeit -selfcert -alias nonexisting&quot;);
 958         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 959                 &quot;-keypass changeit -selfcert -dname CN=NewName&quot;);
 960         // sig not compatible
 961         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 962                 &quot;-keypass changeit -selfcert -sigalg MD5withRSA&quot;);
 963         // bad pass
 964         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass wrong &quot; +
 965                 &quot;-keypass changeit -selfcert&quot;);
 966         // bad pass
 967         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 968                 &quot;-keypass wrong -selfcert&quot;);
 969         //misc
 970         testFail(&quot;&quot;, &quot;-keystore nonexist -storepass changeit &quot; +
 971                 &quot;-keypass changeit -selfcert&quot;);
 972         testFail(&quot;&quot;, &quot;-keystore aa//dd\\gg -storepass changeit &quot; +
 973                 &quot;-keypass changeit -selfcert&quot;);
 974         // diff pass
 975         remove(&quot;x.jks&quot;);
 976         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 977                 &quot;-keypass keypass -genkeypair -dname CN=olala&quot;);</span>
 978         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 979                 &quot;-storepass changeit -selfcert&quot;);
 980         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 981                 &quot;-storepass changeit -selfcert&quot;);
 982 
 983         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 984                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 985         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 986                 &quot;-delete -alias mykey&quot;);
 987         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 988                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 989         // certentry cannot do selfcert
 990         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 991                 &quot;-selfcert&quot;);
 992         remove(&quot;x.jks&quot;);
 993     }
 994     // storepass: bad old, short new, misc
 995     void sqeStorepassTest() throws Exception {
 996         remove(&quot;x.jks&quot;);
 997         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 998                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
 999         // all in arg
1000         testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1001                 &quot;-storepass changeit -new newstore&quot;);
1002         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks&quot; +
1003                 &quot; -storetype JKS -storepass newstore -new changeit&quot;);
1004         // all not in arg, new twice
1005         testOK(&quot;changeit\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1006                 &quot;-keystore x.jks -storetype JKS&quot;);
1007         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1008                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1009         // new in arg
1010         testOK(&quot;changeit\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1011                 &quot;-storetype JKS -new newstore&quot;);
1012         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1013                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1014         // old in arg
1015         testOK(&quot;newstore\nnewstore\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1016                 &quot;-storetype JKS -storepass changeit&quot;);
1017         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1018                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
</pre>
<hr />
<pre>
1027         // short new
1028         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1029                 &quot;-storepass changeit -new new&quot;);
1030         // misc
1031         // non exist
1032         testFail(&quot;&quot;, &quot;-storepasswd -keystore nonexist &quot; +
1033                 &quot;-storepass changeit -new newstore&quot;);
1034         // bad file
1035         testFail(&quot;&quot;, &quot;-storepasswd -keystore badkeystore &quot; +
1036                 &quot;-storepass changeit -new newstore&quot;);
1037         // bad file
1038         testFail(&quot;&quot;, &quot;-storepasswd -keystore aa\\bb//cc//dd &quot; +
1039                 &quot;-storepass changeit -new newstore&quot;);
1040         remove(&quot;x.jks&quot;);
1041     }
1042 
1043     void sqeGenkeyTest() throws Exception {
1044 
1045         remove(&quot;x.jks&quot;);
1046         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1047                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1048         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1049                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1050         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1051                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias newentry&quot;);</span>
1052         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1053                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias newentry&quot;);</span>
1054         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1055                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg DSA &quot; +
1056                 &quot;-alias n1&quot;);
1057         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1058                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1059                 &quot;-alias n2&quot;);
1060         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1061                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1062                 &quot;-keyalg NoSuchAlg -alias n3&quot;);
1063         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1064                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 56 &quot; +</span>
1065                 &quot;-alias n4&quot;);
1066         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1067                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 999 &quot; +</span>
1068                 &quot;-alias n5&quot;);
1069         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1070                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 512 &quot; +</span>
1071                 &quot;-alias n6&quot;);
1072         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1073                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 1024 &quot; +</span>
1074                 &quot;-alias n7&quot;);
1075         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1076                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +</span>
1077                 &quot;-sigalg NoSuchAlg -alias n8&quot;);
1078         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1079                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1080                 &quot;-sigalg MD2withRSA -alias n9&quot;);
1081         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1082                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1083                 &quot;-sigalg MD5withRSA -alias n10&quot;);
1084         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1085                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1086                 &quot;-sigalg SHA1withRSA -alias n11&quot;);
1087         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1088                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1089                 &quot;-sigalg NoSuchAlg -alias n12&quot;);
1090         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
<span class="line-modified">1091                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +</span>
1092                 &quot;-alias n14&quot;);
1093         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
<span class="line-modified">1094                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias n16&quot;);</span>
1095         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1096                 &quot;-keypass changeit -genkeypair -dname CNN=olala -alias n17&quot;);</span>
1097         remove(&quot;x.jks&quot;);
1098     }
1099 
1100     void sqeExportTest() throws Exception {
1101         remove(&quot;x.jks&quot;);
1102         // nonexist
1103         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1104                 &quot;-export -file mykey.cert -alias mykey&quot;);
1105         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1106                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1107         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1108                 &quot;-export -file mykey.cert -alias mykey&quot;);
1109         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1110                 &quot;-delete -alias mykey&quot;);
1111         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1112                 &quot;-import -file mykey.cert -noprompt -alias c1&quot;);
1113         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1114                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1115         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1116                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1117         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1118                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1119         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1120                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1121         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1122                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1123         remove(&quot;mykey.cert&quot;);
1124         remove(&quot;mykey.cert2&quot;);
1125         remove(&quot;x.jks&quot;);
1126     }
1127 
1128     void sqeDeleteTest() throws Exception {
1129         remove(&quot;x.jks&quot;);
1130         // nonexist
1131         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1132                 &quot;-delete -alias mykey&quot;);
1133         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1134                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1135         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1136                 &quot;-delete -alias mykey&quot;);
1137         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1138                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1139         // keystore name illegal
1140         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1141                 &quot;-delete -alias mykey&quot;);
1142         // keystore not exist
1143         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1144                 &quot;-delete -alias mykey&quot;);
1145         // keystore invalid
1146         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1147                 &quot;-delete -alias mykey&quot;);
1148         // wrong pass
1149         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass xxxxxxxx &quot; +
1150                 &quot;-delete -alias mykey&quot;);
1151         remove(&quot;x.jks&quot;);
1152     }
1153 
1154     void sqeCsrTest() throws Exception {
1155         remove(&quot;x.jks&quot;);
1156         remove(&quot;x.jks.p1.cert&quot;);
1157         remove(&quot;csr1&quot;);
1158         // PrivateKeyEntry can do certreq
1159         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1160                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 1024&quot;);</span>
1161         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1162                 &quot;-certreq -file csr1 -alias mykey&quot;);
1163         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1164                 &quot;-certreq -file csr1&quot;);
1165         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1166                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1167         // unmatched sigalg
1168         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1169                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1170         // misc test
1171         // bad storepass
1172         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badstorepass &quot; +
1173                 &quot;-certreq -file csr1&quot;);
1174         // storepass from terminal
1175         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1176                 &quot;-certreq -file csr1&quot;);
1177         // must provide storepass
1178         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1179                 &quot;-certreq -file csr1&quot;);
1180         // bad keypass
</pre>
<hr />
<pre>
1204         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1205                 &quot;-exportcert -file x.jks.p1.cert&quot;);
1206         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1207                 &quot;-delete -alias mykey&quot;);
1208         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1209                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
1210         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1211                 &quot;-certreq -file csr1 -alias mykey&quot;);
1212         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1213                 &quot;-certreq -file csr1&quot;);
1214         remove(&quot;x.jks&quot;);
1215         remove(&quot;x.jks.p1.cert&quot;);
1216         remove(&quot;csr1&quot;);
1217     }
1218 
1219     void sqePrintcertTest() throws Exception {
1220         remove(&quot;x.jks&quot;);
1221         remove(&quot;mykey.cert&quot;);
1222         remove(&quot;myweakkey.cert&quot;);
1223         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1224                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);</span>
1225         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1226                 &quot;-export -file mykey.cert -alias mykey&quot;);
1227         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1228                 &quot;-keypass changeit -genkeypair -dname CN=weak -keyalg rsa &quot; +
1229                 &quot;-keysize 512 -sigalg MD5withRSA -alias myweakkey&quot;);
1230         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1231                 &quot;-export -file myweakkey.cert -alias myweakkey&quot;);
1232         testFail(&quot;&quot;, &quot;-printcert -file badkeystore&quot;);
1233         testFail(&quot;&quot;, &quot;-printcert -file a/b/c/d&quot;);
1234         testOK(&quot;&quot;, &quot;-printcert -file mykey.cert&quot;);
1235         testOK(&quot;&quot;, &quot;-printcert -file myweakkey.cert&quot;);
1236         FileInputStream fin = new FileInputStream(&quot;mykey.cert&quot;);
1237         testOK(fin, &quot;-printcert&quot;);
1238         fin.close();
1239         remove(&quot;x.jks&quot;);
1240         remove(&quot;mykey.cert&quot;);
1241         remove(&quot;myweakkey.cert&quot;);
1242     }
1243 
1244     // 8074935: jdk8 keytool doesn&#39;t validate pem files for RFC 1421 correctness
</pre>
<hr />
<pre>
1247         for (String s: Files.readAllLines(Paths.get(file))) {
1248             if (s.isEmpty()) continue;
1249             if (s.startsWith(&quot;---&quot;)) continue;
1250             if (maybeLast) {
1251                 throw new Exception(&quot;Last line already seen&quot;);
1252             }
1253             if (s.length() &gt; 64) {
1254                 throw new Exception(s);
1255             }
1256             if (s.length() &lt; 64) {
1257                 maybeLast = true;
1258             }
1259         }
1260     }
1261 
1262     void v3extTest(String keyAlg) throws Exception {
1263         KeyStore ks;
1264         remove(&quot;x.jks&quot;);
1265         String simple = &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1266                 &quot;-keypass changeit -noprompt -keyalg &quot; + keyAlg + &quot; &quot;;
<span class="line-modified">1267         String pre = simple + &quot;-genkeypair -dname CN=Olala -alias &quot;;</span>
1268 
1269         // Version and SKID
1270         testOK(&quot;&quot;, pre + &quot;o1&quot;);
1271 
1272         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1273         assertTrue(((X509Certificate)ks.getCertificate(&quot;o1&quot;)).getVersion() == 3);
1274         assertTrue(((X509CertImpl)ks.getCertificate(&quot;o1&quot;))
1275                 .getSubjectKeyIdentifierExtension() != null);
1276 
1277         // BC
1278         testOK(&quot;&quot;, pre + &quot;b1 -ext BC:critical&quot;);
1279         testOK(&quot;&quot;, pre + &quot;b2 -ext BC&quot;);
1280         testOK(&quot;&quot;, pre + &quot;b3 -ext bc&quot;);
1281         testOK(&quot;&quot;, pre + &quot;b4 -ext BasicConstraints&quot;);
1282         testOK(&quot;&quot;, pre + &quot;b5 -ext basicconstraints&quot;);
1283         testOK(&quot;&quot;, pre + &quot;b6 -ext BC=ca:true,pathlen:12&quot;);
1284         testOK(&quot;&quot;, pre + &quot;b7 -ext BC=ca:false&quot;);
1285         testOK(&quot;&quot;, pre + &quot;b8 -ext BC:critical=ca:false&quot;);
1286         testOK(&quot;&quot;, pre + &quot;b9 -ext BC=12&quot;);
1287 
</pre>
<hr />
<pre>
1302                 .getBasicConstraints() == Integer.MAX_VALUE);
1303         assertTrue(((X509Certificate)ks.getCertificate(&quot;b5&quot;))
1304                 .getBasicConstraints() == Integer.MAX_VALUE);
1305         assertTrue(((X509Certificate)ks.getCertificate(&quot;b6&quot;))
1306                 .getBasicConstraints() == 12);
1307         assertTrue(((X509Certificate)ks.getCertificate(&quot;b7&quot;))
1308                 .getBasicConstraints() == -1);
1309         assertTrue(((X509Certificate)ks.getCertificate(&quot;b9&quot;))
1310                 .getBasicConstraints() == 12);
1311 
1312         // KU
1313         testOK(&quot;&quot;, pre + &quot;ku1 -ext KeyUsage:critical=digitalsignature&quot;);
1314         testOK(&quot;&quot;, pre + &quot;ku2 -ext KU=digitalSignature&quot;);
1315         testOK(&quot;&quot;, pre + &quot;ku3 -ext KU=ds&quot;);
1316         testOK(&quot;&quot;, pre + &quot;ku4 -ext KU=dig&quot;);
1317         // ambigous value
1318         testFail(&quot;&quot;, pre + &quot;ku5 -ext KU=d&quot;);
1319         // cRLSign cannot be cs
1320         testFail(&quot;&quot;, pre + &quot;ku6 -ext KU=cs&quot;);
1321         testOK(&quot;&quot;, pre + &quot;ku11 -ext KU=nr&quot;);
<span class="line-modified">1322         // ke also means keyAgreement</span>
1323         testFail(&quot;&quot;, pre + &quot;ku12 -ext KU=ke&quot;);
1324         testOK(&quot;&quot;, pre + &quot;ku12 -ext KU=keyE&quot;);

1325         // de also means decipherOnly
<span class="line-modified">1326         testFail(&quot;&quot;, pre + &quot;ku13 -ext KU=de&quot;);</span>

1327         testOK(&quot;&quot;, pre + &quot;ku13 -ext KU=dataE&quot;);
1328         testOK(&quot;&quot;, pre + &quot;ku14 -ext KU=ka&quot;);
1329         testOK(&quot;&quot;, pre + &quot;ku15 -ext KU=kcs&quot;);
1330         testOK(&quot;&quot;, pre + &quot;ku16 -ext KU=crls&quot;);
1331         testOK(&quot;&quot;, pre + &quot;ku17 -ext KU=eo&quot;);
1332         testOK(&quot;&quot;, pre + &quot;ku18 -ext KU=do&quot;);
1333         testOK(&quot;&quot;, pre + &quot;ku19 -ext KU=cc&quot;);
1334 
1335         testOK(&quot;&quot;, pre + &quot;ku017 -ext KU=ds,cc,eo&quot;);
1336         testOK(&quot;&quot;, pre + &quot;ku135 -ext KU=nr,dataEncipherment,keyCertSign&quot;);
1337         testOK(&quot;&quot;, pre + &quot;ku246 -ext KU=keyEnc,cRL,keyA&quot;);
1338         testOK(&quot;&quot;, pre + &quot;ku1234 -ext KU=ka,da,keyE,nonR&quot;);
1339 
1340         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1341         class CheckKU {
1342             void check(KeyStore ks, String alias, int... pos) throws Exception {
1343                 System.err.print(&quot;x&quot;);
1344                 boolean[] bs = ((X509Certificate)ks.getCertificate(alias))
1345                         .getKeyUsage();
1346                 bs = Arrays.copyOf(bs, 9);
</pre>
<hr />
<pre>
1659         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
1660         assertTrue(!b.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1661         assertTrue(b.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());
1662 
1663         // 8073182: keytool may generate duplicate extensions
1664         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1665         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1666         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1667         assertTrue(dup.getBasicConstraints() == 3);
1668 
1669         remove(&quot;x.jks&quot;);
1670         remove(&quot;test.req&quot;);
1671         remove(&quot;test.cert&quot;);
1672     }
1673 
1674     void i18nTest() throws Exception {
1675         //   1.  keytool -help
1676         remove(&quot;x.jks&quot;);
1677         testOK(&quot;&quot;, &quot;-help&quot;);
1678 
<span class="line-modified">1679         //   2. keytool -genkey -v -keysize 512 Enter &quot;a&quot; for the keystore</span>
1680         // password. Check error (password too short). Enter &quot;password&quot; for
1681         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
1682         // &quot;organizational unit&quot;, &quot;City&quot;, &quot;State&quot;, and &quot;Country Code&quot;.
1683         // Type &quot;yes&quot; when they ask you if everything is correct.
1684         // Type &#39;return&#39; for new key password.
1685         testOK(&quot;a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n&quot;,
<span class="line-modified">1686                 &quot;-genkey -v -keysize 512 -keystore x.jks -storetype JKS&quot;);</span>
1687         //   3. keytool -list -v -storepass password
1688         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1689         //   4. keytool -list -v Type &quot;a&quot; for the keystore password.
1690         // Check error (wrong keystore password).
1691         testFail(&quot;a\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1692         assertTrue(ex.indexOf(&quot;password was incorrect&quot;) != -1);
<span class="line-modified">1693         //   5. keytool -genkey -v -keysize 512 Enter &quot;password&quot; as the password.</span>
1694         // Check error (alias &#39;mykey&#39; already exists).
<span class="line-modified">1695         testFail(&quot;password\n&quot;, &quot;-genkey -v -keysize 512&quot; +</span>
1696                 &quot; -keystore x.jks -storetype JKS&quot;);
1697         assertTrue(ex.indexOf(&quot;alias &lt;mykey&gt; already exists&quot;) != -1);
<span class="line-modified">1698         //   6. keytool -genkey -v -keysize 512 -alias mykey2 -storepass password</span>
1699         // Hit &#39;return&#39; for &quot;first and last name&quot;, &quot;organizational unit&quot;, &quot;City&quot;,
1700         // &quot;State&quot;, and &quot;Country Code&quot;. Type &quot;yes&quot; when they ask you if
1701         // everything is correct. Type &#39;return&#39; for new key password.
<span class="line-modified">1702         testOK(&quot;\n\n\n\n\n\nyes\n\n&quot;, &quot;-genkey -v -keysize 512 -alias mykey2&quot; +</span>
1703                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1704         //   7. keytool -list -v Type &#39;password&#39; for the store password.
1705         testOK(&quot;password\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1706         //   8. keytool -keypasswd -v -alias mykey2 -storepass password
1707         // Type &quot;a&quot; for the new key password. Type &quot;aaaaaa&quot; for the new key
1708         // password. Type &quot;bbbbbb&quot; when re-entering the new key password.
1709         // Type &quot;a&quot; for the new key password. Check Error (too many failures).
1710         testFail(&quot;a\naaaaaa\nbbbbbb\na\n&quot;, &quot;-keypasswd -v -alias mykey2&quot; +
1711                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1712         assertTrue(ex.indexOf(&quot;Too many failures - try later&quot;) != -1);
1713         //   9. keytool -keypasswd -v -alias mykey2 -storepass password
1714         // Type &quot;aaaaaa&quot; for the new key password. Type &quot;aaaaaa&quot;
1715         // when re-entering the new key password.
1716         testOK(&quot;aaaaaa\naaaaaa\n&quot;, &quot;-keypasswd -v -alias mykey2 &quot; +
1717                 &quot;-storepass password -keystore x.jks -storetype JKS&quot;);
1718         //  10. keytool -selfcert -v -alias mykey -storepass password
1719         testOK(&quot;&quot;, &quot;-selfcert -v -alias mykey -storepass password &quot; +
1720                 &quot;-keystore x.jks -storetype JKS&quot;);
1721         //  11. keytool -list -v -storepass password
1722         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
</pre>
<hr />
<pre>
1791         testOK(&quot;&quot;, p11Arg +
1792                 &quot;-storepass test12 -selfcert -alias genkey -dname cn=selfCert&quot;);
1793         testOK(&quot;&quot;, p11Arg +
1794                 &quot;-storepass test12 -list -alias genkey -v&quot;);
1795         assertTrue(out.indexOf(&quot;Owner: CN=selfCert&quot;) != -1);
1796         //(check that cert subject DN is [cn=selfCert])
1797         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias genkey&quot;);
1798         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1799         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1);
1800         //(check for empty database listing)
1801         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs unedit cert8.db key3.db&quot;);
1802         remove(&quot;genkey.cert&quot;);
1803         remove(&quot;genkey.certreq&quot;);
1804         //  12. sccs unedit cert8.db key3.db
1805     }
1806 
1807     // tesing new option -srcProviderName
1808     void sszzTest() throws Exception {
1809         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1810         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
<span class="line-modified">1811         testOK(&quot;&quot;, NSS_P11_ARG+&quot;-genkeypair -dname CN=NSS &quot; +</span>
1812                 &quot;-alias nss -storepass test12&quot;);
1813         testOK(&quot;&quot;, NSS_SRC_P11_ARG + NZZ_P11_ARG +
1814                 &quot;-importkeystore -srcstorepass test12 -deststorepass test12&quot;);
1815         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1816         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1817     }
1818 
1819     public static void main(String[] args) throws Exception {
1820         Locale reservedLocale = Locale.getDefault();
1821         try {
1822             // first test if HumanInputStream really acts like a human being
1823             HumanInputStream.test();
1824             KeyToolTest t = new KeyToolTest();
1825 
1826             if (System.getProperty(&quot;file&quot;) != null) {
1827                 t.sqeTest();
1828                 t.testAll();
1829                 t.i18nTest();
1830                 t.v3extTest(&quot;RSA&quot;);
1831                 t.v3extTest(&quot;DSA&quot;);
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<span class="line-modified">  26  * @bug 6251120 8231950</span>
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
</pre>
<hr />
<pre>
 180             sun.security.tools.keytool.Main.main((&quot;-debug &quot;+cmd).split(&quot;\\s+&quot;));
 181         } finally {
 182             out = b1.toString();
 183             err = b2.toString();
 184             ex = out;   // now it goes to System.out
 185             System.setIn(i1);
 186             System.setOut(p1);
 187             System.setErr(p2);
 188         }
 189     }
 190 
 191     /**
 192      * Call this method if you expect test(input, cmd) should go OK
 193      */
 194     void testOK(String input, String cmd) throws Exception {
 195         try {
 196             // Workaround for &quot;8057810: Make SHA256withDSA the default
 197             // jarsigner and keytool algorithm for DSA keys&quot;. Unfortunately
 198             // SunPKCS11-NSS does not support SHA256withDSA yet.
 199             if (cmd.contains(&quot;p11-nss.txt&quot;) &amp;&amp; cmd.contains(&quot;-genkey&quot;)
<span class="line-modified"> 200                     &amp;&amp; cmd.contains(&quot;DSA&quot;)) {</span>
 201                 cmd += &quot; -sigalg SHA1withDSA -keysize 1024&quot;;
 202             }
 203             test(input, cmd);
 204         } catch(Exception e) {
 205             afterFail(input, cmd, &quot;OK&quot;);
 206             throw e;
 207         }
 208     }
 209 
 210     /**
 211      * Call this method if you expect test(input, cmd) should fail and throw
 212      * an exception
 213      */
 214     void testFail(String input, String cmd) throws Exception {
 215         boolean ok;
 216         try {
 217             test(input, cmd);
 218             ok = true;
 219         } catch(Exception e) {
 220             if (e instanceof MissingResourceException) {
</pre>
<hr />
<pre>
 335     }
 336 
 337     /**
 338      * The test suite.
 339      * Maybe it&#39;s better to put this outside the KeyToolTest class
 340      */
 341     void testAll() throws Exception {
 342         KeyStore ks;
 343 
 344         remove(&quot;x.jks&quot;);
 345         remove(&quot;x.jceks&quot;);
 346         remove(&quot;x.p12&quot;);
 347         remove(&quot;x2.jceks&quot;);
 348         remove(&quot;x2.jks&quot;);
 349         remove(&quot;x.jks.p1.cert&quot;);
 350 
 351         // name changes: genkeypair, importcert, exportcert
 352         remove(&quot;x.jks&quot;);
 353         remove(&quot;x.jks.p1.cert&quot;);
 354         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 355                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
 356         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 357                 &quot;-exportcert -alias p1 -file x.jks.p1.cert&quot;);
 358         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 359         assertTrue(ks.getKey(&quot;p1&quot;, &quot;changeit&quot;.toCharArray()) != null,
 360             &quot;key not DSA&quot;);
 361         assertTrue(new File(&quot;x.jks.p1.cert&quot;).exists(), &quot;p1 export err&quot;);
 362         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 363                 &quot;-delete -alias p1&quot;);
 364         // importcert, prompt for Yes/No
 365         testOK(&quot;y\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 366                 &quot;-importcert -alias c1 -file x.jks.p1.cert&quot;);
 367         // importcert, -noprompt
 368         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 369                 &quot;-importcert -alias c2 -file x.jks.p1.cert -noprompt&quot;);
 370         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 371         assertTrue(ks.getCertificate(&quot;c1&quot;) != null, &quot;import c1 err&quot;);
 372 
 373         // v3
 374         byte[] encoded = ks.getCertificate(&quot;c1&quot;).getEncoded();
 375         X509CertImpl certImpl = new X509CertImpl(encoded);
 376         assertTrue(certImpl.getVersion() == 3, &quot;Version is not 3&quot;);
 377 
 378         // changealias and keyclone
 379         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 380                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
 381         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 382                 &quot;-changealias -alias p1 -destalias p11&quot;);
 383         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 384                 &quot;-changealias -alias c1 -destalias c11&quot;);
 385         // press ENTER when prompt for p111&#39;s keypass
 386         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 387                 &quot;-keyclone -alias p11 -destalias p111&quot;);
 388         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 389         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;there is no p1&quot;);
 390         assertTrue(!ks.containsAlias(&quot;c1&quot;), &quot;there is no c1&quot;);
 391         assertTrue(ks.containsAlias(&quot;p11&quot;), &quot;there is p11&quot;);
 392         assertTrue(ks.containsAlias(&quot;c11&quot;), &quot;there is c11&quot;);
 393         assertTrue(ks.containsAlias(&quot;p111&quot;), &quot;there is p111&quot;);
 394 
 395         // genSecKey
 396         remove(&quot;x.jceks&quot;);
 397         // DES, no need keysize
 398         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 399                 &quot;-genseckey -keyalg DES -alias s1&quot;);</span>
 400         // DES, keysize cannot be 128
 401         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 402                 &quot;-genseckey -keyalg DES -alias s11 -keysize 128&quot;);</span>
 403         // DESede. no need keysize
 404         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 405                 &quot;-genseckey -keyalg DESede -alias s2&quot;);
 406         // AES, need keysize
 407         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype AES &quot; +
 408                 &quot;-genseckey -keyalg Rijndael -alias s3&quot;);
 409         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 410                 &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 411         // about keypass
 412         // can accept storepass
 413         testOK(&quot;\n&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
<span class="line-modified"> 414                 &quot;-genseckey -keyalg DES -alias s4&quot;);</span>
 415         // or a new one
 416         testOK(&quot;keypass\nkeypass\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 417                 &quot;-storepass changeit -genseckey -keyalg DES -alias s5&quot;);</span>
 418         // keypass must be valid (prompt 3 times)
 419         testOK(&quot;bad\n\bad\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 420                 &quot;-storetype JCEKS -storepass changeit -genseckey &quot; +</span>
<span class="line-added"> 421                 &quot;-keyalg DES -alias s6&quot;);</span>
 422         // keypass must be valid (prompt 3 times)
 423         testFail(&quot;bad\n\bad\nbad\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 424                 &quot;-storepass changeit -genseckey -keyalg DES -alias s7&quot;);</span>
 425         // keypass must be valid (prompt 3 times)
 426         testFail(&quot;bad\n\bad\nbad\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 427                 &quot;-storetype JCEKS -storepass changeit -genseckey -keyalg DES -alias s7&quot;);</span>
 428         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 429         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 430                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s1 is DES&quot;);
 431         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 432                 .getEncoded().length == 8,  &quot;DES is 56&quot;);
 433         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 434                 .getEncoded().length == 24,  &quot;DESede is 168&quot;);
 435         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 436                 .getAlgorithm().equalsIgnoreCase(&quot;DESede&quot;), &quot;s2 is DESede&quot;);
 437         assertTrue(ks.getKey(&quot;s3&quot;, &quot;changeit&quot;.toCharArray())
 438                 .getAlgorithm().equalsIgnoreCase(&quot;AES&quot;), &quot;s3 is AES&quot;);
 439         assertTrue(ks.getKey(&quot;s4&quot;, &quot;changeit&quot;.toCharArray())
 440                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s4 is DES&quot;);
 441         assertTrue(ks.getKey(&quot;s5&quot;, &quot;keypass&quot;.toCharArray())
 442                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s5 is DES&quot;);
 443         assertTrue(ks.getKey(&quot;s6&quot;, &quot;keypass&quot;.toCharArray())
 444                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s6 is DES&quot;);
 445         assertTrue(!ks.containsAlias(&quot;s7&quot;), &quot;s7 not created&quot;);
 446 
 447         // maybe we needn&#39;t test this, one day JKS will support SecretKey
 448         //testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 449         //        &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 450 
 451         // importKeyStore
 452         remove(&quot;x.jks&quot;);
 453         remove(&quot;x.jceks&quot;);
 454         // create 2 entries...
 455         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 456                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=Olala&quot;);</span>
 457         testOK(&quot;&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 458                 &quot;-importcert -alias c1 -file x.jks.p1.cert -noprompt&quot;);
 459         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 460         assertTrue(ks.size() == 2, &quot;2 entries in JCEKS&quot;);
 461         // import, shouldn&#39;t mention destalias/srckeypass/destkeypass
 462         // if srcalias is no given
 463         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 464                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 465                 &quot;-destkeystore x.jks -deststoretype JKS -destalias pp&quot;);
 466         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 467                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 468                 &quot;-destkeystore x.jks -deststoretype JKS -srckeypass changeit&quot;);
 469         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 470                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 471                 &quot;-destkeystore x.jks -deststoretype JKS -destkeypass changeit&quot;);
 472         // normal import
 473         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 474                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 475                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 476         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
</pre>
<hr />
<pre>
 516         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 517         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 518         // rename
 519         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 520                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 521                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 522                 &quot;-srcalias p1 -destalias p2&quot;);
 523         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 524         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 525         // another rename
 526         testOK(&quot;changeit\nchangeit\n\nnewalias\n&quot;, &quot;-importkeystore &quot; +
 527                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 528                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 529         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 530         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 531 
 532         // importkeystore single, different keypass
 533         remove(&quot;x.jks&quot;);
 534         // generate entry with different keypass
 535         testOK(&quot;changeit\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
<span class="line-modified"> 536                 &quot;-storetype JCEKS -genkeypair -keyalg DSA -alias p2 -dname CN=Olala&quot;);</span>
 537         // prompt
 538         testOK(&quot;changeit\nchangeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 539                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 540                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p2&quot;);
 541         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 542         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 543         // diff destkeypass
 544         testOK(&quot;changeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 545                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 546                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 547                 &quot;-srcalias p2 -destalias p3 -destkeypass keypass2&quot;);
 548         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 549         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 550         assertTrue(ks.getKey(&quot;p2&quot;, &quot;keypass&quot;.toCharArray()) != null,
 551                 &quot;p2 has old password&quot;);
 552         assertTrue(ks.getKey(&quot;p3&quot;, &quot;keypass2&quot;.toCharArray()) != null,
 553                 &quot;p3 has new password&quot;);
 554 
 555         // importkeystore single, cert
 556         remove(&quot;x.jks&quot;);
</pre>
<hr />
<pre>
 565                 &quot;-srcalias c1 -destalias c2&quot;);
 566         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;But will warn&quot;);
 567         // 2nd import, press y to overwrite ...
 568         testOK(&quot;changeit\n\ny\n&quot;, &quot;-importkeystore &quot; +
 569                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 570                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 571                 &quot;-srcalias c1 -destalias c2&quot;);
 572         // ... or rename
 573         testOK(&quot;changeit\n\n\nc3\n&quot;, &quot;-importkeystore &quot; +
 574                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 575                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 576                 &quot;-srcalias c1 -destalias c2&quot;);
 577         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 578         // c1, c2, c3
 579         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 580 
 581         // importkeystore, secretkey
 582         remove(&quot;x.jks&quot;);
 583         // create SecretKeyEntry
 584         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 585                 &quot;-genseckey -keyalg DES -alias s1&quot;);</span>
 586         // create SecretKeyEntry
 587         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
<span class="line-modified"> 588                 &quot;-genseckey -keyalg DES -alias s2&quot;);</span>
 589         // remove the keypass!=storepass one
 590         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 591                 &quot;-delete -alias p2&quot;);
 592         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 593         // p1, c1, s1, s2
 594         assertTrue(ks.size() == 4, &quot;4 entries in JCEKS&quot;);
 595         // normal
 596         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 597                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 598                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias s1&quot;);
 599         assertTrue(err.indexOf(&quot;not imported&quot;) != -1, &quot;Not imported&quot;);
 600         assertTrue(err.indexOf(&quot;Cannot store non-PrivateKeys&quot;) != -1,
 601                 &quot;Not imported&quot;);
 602 
 603         // Importing a JCEKS keystore to a JKS one. Will warn
 604         // for the 2 SecretKey entries
 605 
 606         remove(&quot;x.jks&quot;);
 607         // Two &quot;no&quot; answers to bypass warnings
 608         // normal
</pre>
<hr />
<pre>
 613         assertTrue(err.indexOf(&quot;s2 not&quot;) != -1, &quot;s2 not&quot;);
 614         assertTrue(err.indexOf(&quot;c1 success&quot;) != -1, &quot;c1 success&quot;);
 615         assertTrue(err.indexOf(&quot;p1 success&quot;) != -1, &quot;p1 success&quot;);
 616         remove(&quot;x.jks&quot;);
 617         // One &quot;yes&quot; to stop
 618         // normal
 619         testOK(&quot;yes\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 620                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 621                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 622         // maybe c1 or p1 has been imported before s1 or s2 is touched,
 623         // anyway we know yesNo is only asked once.
 624 
 625         // pkcs12
 626         remove(&quot;x.jks&quot;);
 627         // JKS prompt for keypass
 628         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 629                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 630         remove(&quot;x.jks&quot;);
 631         // just type ENTER means keypass=storepass
 632         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
<span class="line-modified"> 633                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
 634         remove(&quot;x.p12&quot;);
 635         // PKCS12 only need storepass
 636         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
<span class="line-modified"> 637                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);</span>
 638         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -storetype PKCS12 &quot; +
<span class="line-modified"> 639                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
 640         // when specify keypass, make sure keypass==storepass...
 641         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass changeit &quot; +
 642                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 643         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 644                 &quot;PKCS12 silent when keypass == storepass&quot;);
 645         // otherwise, print a warning
 646         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass another&quot; +
 647                 &quot; -storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 648         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 649                 &quot;PKCS12 warning when keypass != storepass&quot;);
 650         // no -keypasswd for PKCS12
 651         testFail(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12&quot; +
 652                 &quot; -keypasswd -new changeit -alias p3&quot;);
 653         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 654                 &quot;-changealias -alias p3 -destalias p33&quot;);
 655         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 656                 &quot;-keyclone -alias p33 -destalias p3&quot;);
 657 
 658         // pkcs12
 659         remove(&quot;x.p12&quot;);
 660         // PKCS12 only need storepass
 661         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
<span class="line-modified"> 662                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);</span>
 663         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -storetype PKCS12 &quot; +
<span class="line-modified"> 664                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
 665         // when specify keypass, make sure keypass==storepass...
 666         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass changeit &quot; +
 667                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 668         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 669                 &quot;PKCS12 silent when keypass == storepass&quot;);
 670         // otherwise, print a warning
 671         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass another &quot; +
 672                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 673         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 674                 &quot;PKCS12 warning when keypass != storepass&quot;);
 675 
 676         remove(&quot;x.jks&quot;);
 677         remove(&quot;x.jceks&quot;);
 678         remove(&quot;x.p12&quot;);
 679         remove(&quot;x2.jceks&quot;);
 680         remove(&quot;x2.jks&quot;);
 681         remove(&quot;x.jks.p1.cert&quot;);
 682     }
 683 
 684     void testPKCS11() throws Exception {
 685         KeyStore ks;
 686         // pkcs11, the password maybe different and maybe PKCS11 not supported
 687 
 688         // in case last test is not executed successfully
 689         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 690         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 691         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p3&quot;);
 692         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias nss&quot;);
 693 
 694         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 695         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 696                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE &quot; +
 697                         &quot;BEFORE THIS TEST ***&quot;);
 698 
 699         testOK(&quot;&quot;, p11Arg +
<span class="line-modified"> 700                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
<span class="line-modified"> 701         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);</span>
 702         // cannot provide keypass for PKCS11
 703         testFail(&quot;test12\n&quot;, p11Arg +
<span class="line-modified"> 704                 &quot;-keypass test12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);</span>
 705         // cannot provide keypass for PKCS11
 706         testFail(&quot;test12\n&quot;, p11Arg +
<span class="line-modified"> 707                 &quot;-keypass nonsense -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);</span>
 708 
 709         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 710         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 711                 &quot;2 entries in p11&quot;);
 712 
 713         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -changealias -destalias p3&quot;);
 714         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 715         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 716 
 717         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p3 -keyclone -destalias p1&quot;);
 718         // in PKCS11, keyclone will delete old
 719         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 720         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 721 
 722         // cannot change password for PKCS11
 723         testFail(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -keypasswd -new another&quot;);
 724 
 725         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 726         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 727                 &quot;2 entries in p11&quot;);
 728 
 729         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 730         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 731 
 732         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 733         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 734                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE&quot; +
 735                         &quot; BEFORE THIS TEST ***&quot;);
 736     }
 737 
 738     void testPKCS11ImportKeyStore() throws Exception {
 739 
 740         KeyStore ks;
 741         testOK(&quot;&quot;, p11Arg +
<span class="line-modified"> 742                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);</span>
<span class="line-modified"> 743         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);</span>
 744         // test importkeystore for pkcs11
 745 
 746         remove(&quot;x.jks&quot;);
 747         // pkcs11 -&gt; jks
 748         testOK(&quot;changeit\nchangeit\ntest12\n&quot;, srcP11Arg +
 749                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 750                 &quot;-srcalias p1&quot;));
 751         assertTrue(err.indexOf(&quot;not imported&quot;) != -1,
 752                 &quot;cannot import key without destkeypass&quot;);
 753         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 754         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;p1 is not imported&quot;);
 755 
 756         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 757                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 758                 &quot;-srcalias p1 -destkeypass changeit&quot;));
 759         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 760                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 761                 &quot;-srcalias p2 -destkeypass changeit&quot;));
 762         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 763         assertTrue(ks.containsAlias(&quot;p1&quot;), &quot;p1 is imported&quot;);
</pre>
<hr />
<pre>
 793         sqeCsrTest();
 794         sqePrintcertTest();
 795         sqeDeleteTest();
 796         sqeExportTest();
 797         sqeGenkeyTest();
 798         sqeImportTest();
 799         sqeKeyclonetest();
 800         sqeKeypasswdTest();
 801         sqeListTest();
 802         sqeSelfCertTest();
 803         sqeStorepassTest();
 804 
 805         remove(&quot;badkeystore&quot;);
 806     }
 807 
 808     // Import: cacert, prompt, trusted, non-trusted, bad chain, not match
 809     void sqeImportTest() throws Exception {
 810         KeyStore ks;
 811         remove(&quot;x.jks&quot;);
 812         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 813                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 814         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 815                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 816         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 817                 &quot;-storepass changeit -delete -alias mykey&quot;);
 818         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 819                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 820         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 821                 &quot;-storepass changeit -delete -alias mykey&quot;);
 822         testOK(&quot;yes\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 823                 &quot;-importcert -file x.jks.p1.cert&quot;);
 824         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 825         assertTrue(ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 826         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 827                 &quot;-storepass changeit -delete -alias mykey&quot;);
 828         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 829                 &quot;-importcert -file x.jks.p1.cert&quot;);
 830         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 831         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 832         testOK(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 833                 &quot;-importcert -file x.jks.p1.cert&quot;);
 834         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 835         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 836         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 837                 &quot;-importcert -file nonexist&quot;);
 838         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 839                 &quot;-importcert -file x.jks&quot;);
 840         remove(&quot;x.jks&quot;);
 841     }
 842     // keyclone: exist. nonexist err, cert err, dest exist, misc
 843     void sqeKeyclonetest() throws Exception {
 844         remove(&quot;x.jks&quot;);
 845         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 846                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 847         // new pass
 848         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 849                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 850         // new pass
 851         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 852                 &quot;-keypass changeit -keyclone -dest p1&quot;);
 853         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 854                 &quot;-keyclone -dest p2&quot;);
 855         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 856                 &quot;-keyclone -dest p2&quot;);
 857         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 858                 &quot;-keyclone -dest p3 -alias noexist&quot;);
 859         // no cert
 860         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 861                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 862         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 863                 &quot;-delete -alias mykey&quot;);
 864         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 865                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 866         // new pass
 867         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 868                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 869         remove(&quot;x.jks&quot;);
 870     }
 871     // keypasswd: exist, short, nonexist err, cert err, misc
 872     void sqeKeypasswdTest() throws Exception {
 873         remove(&quot;x.jks&quot;);
 874         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 875                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 876         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 877                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 878         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 879                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 880         testOK(&quot;newpass\nnewpass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 881                 &quot;-storepass changeit -keypass changeit -keypasswd&quot;);
 882         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 883                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 884         testOK(&quot;new\nnew\nnewpass\nnewpass\n&quot;, &quot;-keystore x.jks &quot; +
 885                 &quot;-storetype JKS -storepass changeit -keypass changeit -keypasswd&quot;);
 886         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 887                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 888         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 889                 &quot;-keypasswd -new newpass&quot;);
 890         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 891                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 892         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 893                 &quot;-keypasswd -new newpass&quot;);
 894         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 895                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 896         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 897                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 898         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 899                 &quot;-keypass bad -keypasswd -new newpass&quot;);
 900         // no cert
 901         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 902                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 903         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 904                 &quot;-delete -alias mykey&quot;);
 905         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 906                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 907         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 908                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 909         // diff pass
 910         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 911                 &quot;-delete -alias mykey&quot;);
 912         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 913                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 914         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 915                 &quot;-keypasswd -new newpass&quot;);
 916         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 917                 &quot;-storepass changeit -keypasswd -new newpass&quot;);
 918         // i hate those misc test
 919         remove(&quot;x.jks&quot;);
 920     }
 921     // list: -f -alias, exist, nonexist err;
 922     // otherwise, check all shows, -rfc shows more, and misc
 923     void sqeListTest() throws Exception {
 924         remove(&quot;x.jks&quot;);
 925         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 926                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 927         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -list&quot;);
 928         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 929                 &quot;-list -alias mykey&quot;);
 930         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 931                 &quot;-list -alias notexist&quot;);
 932         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 933                 &quot;-list -alias mykey&quot;);
 934         // keypass ignore
 935         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 936                 &quot;-keypass badpass -list -alias mykey&quot;);
 937         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 938         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;no storepass&quot;);
 939         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 940         assertTrue(err.indexOf(&quot;WARNING&quot;) == -1, &quot;has storepass&quot;);
 941         testFail(&quot;badpass\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 942         // misc
 943         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc -storepass changeit -list&quot;);
 944         testFail(&quot;&quot;, &quot;-keystore nonexisting -storepass changeit -list&quot;);
 945         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit -list&quot;);
 946         remove(&quot;x.jks&quot;);
 947     }
 948     // selfcert: exist, non-exist err, cert err, sig, dname, wrong keypass, misc
 949     void sqeSelfCertTest() throws Exception {
 950         remove(&quot;x.jks&quot;);
 951         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 952                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 953         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -selfcert&quot;);
 954         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 955                 &quot;-keypass changeit -selfcert&quot;);
 956         // not exist
 957         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 958                 &quot;-keypass changeit -selfcert -alias nonexisting&quot;);
 959         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 960                 &quot;-keypass changeit -selfcert -dname CN=NewName&quot;);
 961         // sig not compatible
 962         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 963                 &quot;-keypass changeit -selfcert -sigalg MD5withRSA&quot;);
 964         // bad pass
 965         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass wrong &quot; +
 966                 &quot;-keypass changeit -selfcert&quot;);
 967         // bad pass
 968         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 969                 &quot;-keypass wrong -selfcert&quot;);
 970         //misc
 971         testFail(&quot;&quot;, &quot;-keystore nonexist -storepass changeit &quot; +
 972                 &quot;-keypass changeit -selfcert&quot;);
 973         testFail(&quot;&quot;, &quot;-keystore aa//dd\\gg -storepass changeit &quot; +
 974                 &quot;-keypass changeit -selfcert&quot;);
 975         // diff pass
 976         remove(&quot;x.jks&quot;);
 977         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 978                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
 979         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 980                 &quot;-storepass changeit -selfcert&quot;);
 981         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 982                 &quot;-storepass changeit -selfcert&quot;);
 983 
 984         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 985                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 986         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 987                 &quot;-delete -alias mykey&quot;);
 988         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 989                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 990         // certentry cannot do selfcert
 991         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 992                 &quot;-selfcert&quot;);
 993         remove(&quot;x.jks&quot;);
 994     }
 995     // storepass: bad old, short new, misc
 996     void sqeStorepassTest() throws Exception {
 997         remove(&quot;x.jks&quot;);
 998         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified"> 999                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1000         // all in arg
1001         testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1002                 &quot;-storepass changeit -new newstore&quot;);
1003         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks&quot; +
1004                 &quot; -storetype JKS -storepass newstore -new changeit&quot;);
1005         // all not in arg, new twice
1006         testOK(&quot;changeit\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1007                 &quot;-keystore x.jks -storetype JKS&quot;);
1008         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1009                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1010         // new in arg
1011         testOK(&quot;changeit\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1012                 &quot;-storetype JKS -new newstore&quot;);
1013         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1014                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1015         // old in arg
1016         testOK(&quot;newstore\nnewstore\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1017                 &quot;-storetype JKS -storepass changeit&quot;);
1018         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1019                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
</pre>
<hr />
<pre>
1028         // short new
1029         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1030                 &quot;-storepass changeit -new new&quot;);
1031         // misc
1032         // non exist
1033         testFail(&quot;&quot;, &quot;-storepasswd -keystore nonexist &quot; +
1034                 &quot;-storepass changeit -new newstore&quot;);
1035         // bad file
1036         testFail(&quot;&quot;, &quot;-storepasswd -keystore badkeystore &quot; +
1037                 &quot;-storepass changeit -new newstore&quot;);
1038         // bad file
1039         testFail(&quot;&quot;, &quot;-storepasswd -keystore aa\\bb//cc//dd &quot; +
1040                 &quot;-storepass changeit -new newstore&quot;);
1041         remove(&quot;x.jks&quot;);
1042     }
1043 
1044     void sqeGenkeyTest() throws Exception {
1045 
1046         remove(&quot;x.jks&quot;);
1047         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1048                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1049         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1050                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1051         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1052                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);</span>
1053         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1054                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);</span>
1055         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1056                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg DSA &quot; +
1057                 &quot;-alias n1&quot;);
1058         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1059                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1060                 &quot;-alias n2&quot;);
1061         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1062                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1063                 &quot;-keyalg NoSuchAlg -alias n3&quot;);
1064         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1065                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 56 &quot; +</span>
1066                 &quot;-alias n4&quot;);
1067         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1068                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 999 &quot; +</span>
1069                 &quot;-alias n5&quot;);
1070         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1071                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 512 &quot; +</span>
1072                 &quot;-alias n6&quot;);
1073         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1074                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024 &quot; +</span>
1075                 &quot;-alias n7&quot;);
1076         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1077                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +</span>
1078                 &quot;-sigalg NoSuchAlg -alias n8&quot;);
1079         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1080                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1081                 &quot;-sigalg MD2withRSA -alias n9&quot;);
1082         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1083                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1084                 &quot;-sigalg MD5withRSA -alias n10&quot;);
1085         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1086                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1087                 &quot;-sigalg SHA1withRSA -alias n11&quot;);
1088         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1089                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1090                 &quot;-sigalg NoSuchAlg -alias n12&quot;);
1091         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
<span class="line-modified">1092                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +</span>
1093                 &quot;-alias n14&quot;);
1094         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
<span class="line-modified">1095                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias n16&quot;);</span>
1096         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1097                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CNN=olala -alias n17&quot;);</span>
1098         remove(&quot;x.jks&quot;);
1099     }
1100 
1101     void sqeExportTest() throws Exception {
1102         remove(&quot;x.jks&quot;);
1103         // nonexist
1104         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1105                 &quot;-export -file mykey.cert -alias mykey&quot;);
1106         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1107                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1108         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1109                 &quot;-export -file mykey.cert -alias mykey&quot;);
1110         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1111                 &quot;-delete -alias mykey&quot;);
1112         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1113                 &quot;-import -file mykey.cert -noprompt -alias c1&quot;);
1114         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1115                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1116         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1117                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1118         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1119                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1120         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1121                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1122         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1123                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1124         remove(&quot;mykey.cert&quot;);
1125         remove(&quot;mykey.cert2&quot;);
1126         remove(&quot;x.jks&quot;);
1127     }
1128 
1129     void sqeDeleteTest() throws Exception {
1130         remove(&quot;x.jks&quot;);
1131         // nonexist
1132         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1133                 &quot;-delete -alias mykey&quot;);
1134         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1135                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1136         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1137                 &quot;-delete -alias mykey&quot;);
1138         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1139                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1140         // keystore name illegal
1141         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1142                 &quot;-delete -alias mykey&quot;);
1143         // keystore not exist
1144         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1145                 &quot;-delete -alias mykey&quot;);
1146         // keystore invalid
1147         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1148                 &quot;-delete -alias mykey&quot;);
1149         // wrong pass
1150         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass xxxxxxxx &quot; +
1151                 &quot;-delete -alias mykey&quot;);
1152         remove(&quot;x.jks&quot;);
1153     }
1154 
1155     void sqeCsrTest() throws Exception {
1156         remove(&quot;x.jks&quot;);
1157         remove(&quot;x.jks.p1.cert&quot;);
1158         remove(&quot;csr1&quot;);
1159         // PrivateKeyEntry can do certreq
1160         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1161                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024&quot;);</span>
1162         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1163                 &quot;-certreq -file csr1 -alias mykey&quot;);
1164         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1165                 &quot;-certreq -file csr1&quot;);
1166         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1167                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1168         // unmatched sigalg
1169         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1170                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1171         // misc test
1172         // bad storepass
1173         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badstorepass &quot; +
1174                 &quot;-certreq -file csr1&quot;);
1175         // storepass from terminal
1176         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1177                 &quot;-certreq -file csr1&quot;);
1178         // must provide storepass
1179         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1180                 &quot;-certreq -file csr1&quot;);
1181         // bad keypass
</pre>
<hr />
<pre>
1205         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1206                 &quot;-exportcert -file x.jks.p1.cert&quot;);
1207         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1208                 &quot;-delete -alias mykey&quot;);
1209         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1210                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
1211         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1212                 &quot;-certreq -file csr1 -alias mykey&quot;);
1213         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1214                 &quot;-certreq -file csr1&quot;);
1215         remove(&quot;x.jks&quot;);
1216         remove(&quot;x.jks.p1.cert&quot;);
1217         remove(&quot;csr1&quot;);
1218     }
1219 
1220     void sqePrintcertTest() throws Exception {
1221         remove(&quot;x.jks&quot;);
1222         remove(&quot;mykey.cert&quot;);
1223         remove(&quot;myweakkey.cert&quot;);
1224         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
<span class="line-modified">1225                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);</span>
1226         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1227                 &quot;-export -file mykey.cert -alias mykey&quot;);
1228         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1229                 &quot;-keypass changeit -genkeypair -dname CN=weak -keyalg rsa &quot; +
1230                 &quot;-keysize 512 -sigalg MD5withRSA -alias myweakkey&quot;);
1231         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1232                 &quot;-export -file myweakkey.cert -alias myweakkey&quot;);
1233         testFail(&quot;&quot;, &quot;-printcert -file badkeystore&quot;);
1234         testFail(&quot;&quot;, &quot;-printcert -file a/b/c/d&quot;);
1235         testOK(&quot;&quot;, &quot;-printcert -file mykey.cert&quot;);
1236         testOK(&quot;&quot;, &quot;-printcert -file myweakkey.cert&quot;);
1237         FileInputStream fin = new FileInputStream(&quot;mykey.cert&quot;);
1238         testOK(fin, &quot;-printcert&quot;);
1239         fin.close();
1240         remove(&quot;x.jks&quot;);
1241         remove(&quot;mykey.cert&quot;);
1242         remove(&quot;myweakkey.cert&quot;);
1243     }
1244 
1245     // 8074935: jdk8 keytool doesn&#39;t validate pem files for RFC 1421 correctness
</pre>
<hr />
<pre>
1248         for (String s: Files.readAllLines(Paths.get(file))) {
1249             if (s.isEmpty()) continue;
1250             if (s.startsWith(&quot;---&quot;)) continue;
1251             if (maybeLast) {
1252                 throw new Exception(&quot;Last line already seen&quot;);
1253             }
1254             if (s.length() &gt; 64) {
1255                 throw new Exception(s);
1256             }
1257             if (s.length() &lt; 64) {
1258                 maybeLast = true;
1259             }
1260         }
1261     }
1262 
1263     void v3extTest(String keyAlg) throws Exception {
1264         KeyStore ks;
1265         remove(&quot;x.jks&quot;);
1266         String simple = &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1267                 &quot;-keypass changeit -noprompt -keyalg &quot; + keyAlg + &quot; &quot;;
<span class="line-modified">1268         String pre = simple + &quot;-genkeypair -keyalg DSA -dname CN=Olala -alias &quot;;</span>
1269 
1270         // Version and SKID
1271         testOK(&quot;&quot;, pre + &quot;o1&quot;);
1272 
1273         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1274         assertTrue(((X509Certificate)ks.getCertificate(&quot;o1&quot;)).getVersion() == 3);
1275         assertTrue(((X509CertImpl)ks.getCertificate(&quot;o1&quot;))
1276                 .getSubjectKeyIdentifierExtension() != null);
1277 
1278         // BC
1279         testOK(&quot;&quot;, pre + &quot;b1 -ext BC:critical&quot;);
1280         testOK(&quot;&quot;, pre + &quot;b2 -ext BC&quot;);
1281         testOK(&quot;&quot;, pre + &quot;b3 -ext bc&quot;);
1282         testOK(&quot;&quot;, pre + &quot;b4 -ext BasicConstraints&quot;);
1283         testOK(&quot;&quot;, pre + &quot;b5 -ext basicconstraints&quot;);
1284         testOK(&quot;&quot;, pre + &quot;b6 -ext BC=ca:true,pathlen:12&quot;);
1285         testOK(&quot;&quot;, pre + &quot;b7 -ext BC=ca:false&quot;);
1286         testOK(&quot;&quot;, pre + &quot;b8 -ext BC:critical=ca:false&quot;);
1287         testOK(&quot;&quot;, pre + &quot;b9 -ext BC=12&quot;);
1288 
</pre>
<hr />
<pre>
1303                 .getBasicConstraints() == Integer.MAX_VALUE);
1304         assertTrue(((X509Certificate)ks.getCertificate(&quot;b5&quot;))
1305                 .getBasicConstraints() == Integer.MAX_VALUE);
1306         assertTrue(((X509Certificate)ks.getCertificate(&quot;b6&quot;))
1307                 .getBasicConstraints() == 12);
1308         assertTrue(((X509Certificate)ks.getCertificate(&quot;b7&quot;))
1309                 .getBasicConstraints() == -1);
1310         assertTrue(((X509Certificate)ks.getCertificate(&quot;b9&quot;))
1311                 .getBasicConstraints() == 12);
1312 
1313         // KU
1314         testOK(&quot;&quot;, pre + &quot;ku1 -ext KeyUsage:critical=digitalsignature&quot;);
1315         testOK(&quot;&quot;, pre + &quot;ku2 -ext KU=digitalSignature&quot;);
1316         testOK(&quot;&quot;, pre + &quot;ku3 -ext KU=ds&quot;);
1317         testOK(&quot;&quot;, pre + &quot;ku4 -ext KU=dig&quot;);
1318         // ambigous value
1319         testFail(&quot;&quot;, pre + &quot;ku5 -ext KU=d&quot;);
1320         // cRLSign cannot be cs
1321         testFail(&quot;&quot;, pre + &quot;ku6 -ext KU=cs&quot;);
1322         testOK(&quot;&quot;, pre + &quot;ku11 -ext KU=nr&quot;);
<span class="line-modified">1323         // ke means keyAgreement and keyCertSign...</span>
1324         testFail(&quot;&quot;, pre + &quot;ku12 -ext KU=ke&quot;);
1325         testOK(&quot;&quot;, pre + &quot;ku12 -ext KU=keyE&quot;);
<span class="line-added">1326         testOK(&quot;&quot;, pre + &quot;ku12a -ext KU=kE&quot;); // kE is only keyEncipherment</span>
1327         // de also means decipherOnly
<span class="line-modified">1328         testOK(&quot;&quot;, pre + &quot;ku13a -ext KU=de&quot;); // de is decipherOnly</span>
<span class="line-added">1329         testOK(&quot;&quot;, pre + &quot;ku13b -ext KU=dE&quot;); // dE is dataEncipherment</span>
1330         testOK(&quot;&quot;, pre + &quot;ku13 -ext KU=dataE&quot;);
1331         testOK(&quot;&quot;, pre + &quot;ku14 -ext KU=ka&quot;);
1332         testOK(&quot;&quot;, pre + &quot;ku15 -ext KU=kcs&quot;);
1333         testOK(&quot;&quot;, pre + &quot;ku16 -ext KU=crls&quot;);
1334         testOK(&quot;&quot;, pre + &quot;ku17 -ext KU=eo&quot;);
1335         testOK(&quot;&quot;, pre + &quot;ku18 -ext KU=do&quot;);
1336         testOK(&quot;&quot;, pre + &quot;ku19 -ext KU=cc&quot;);
1337 
1338         testOK(&quot;&quot;, pre + &quot;ku017 -ext KU=ds,cc,eo&quot;);
1339         testOK(&quot;&quot;, pre + &quot;ku135 -ext KU=nr,dataEncipherment,keyCertSign&quot;);
1340         testOK(&quot;&quot;, pre + &quot;ku246 -ext KU=keyEnc,cRL,keyA&quot;);
1341         testOK(&quot;&quot;, pre + &quot;ku1234 -ext KU=ka,da,keyE,nonR&quot;);
1342 
1343         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1344         class CheckKU {
1345             void check(KeyStore ks, String alias, int... pos) throws Exception {
1346                 System.err.print(&quot;x&quot;);
1347                 boolean[] bs = ((X509Certificate)ks.getCertificate(alias))
1348                         .getKeyUsage();
1349                 bs = Arrays.copyOf(bs, 9);
</pre>
<hr />
<pre>
1662         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
1663         assertTrue(!b.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1664         assertTrue(b.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());
1665 
1666         // 8073182: keytool may generate duplicate extensions
1667         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1668         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1669         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1670         assertTrue(dup.getBasicConstraints() == 3);
1671 
1672         remove(&quot;x.jks&quot;);
1673         remove(&quot;test.req&quot;);
1674         remove(&quot;test.cert&quot;);
1675     }
1676 
1677     void i18nTest() throws Exception {
1678         //   1.  keytool -help
1679         remove(&quot;x.jks&quot;);
1680         testOK(&quot;&quot;, &quot;-help&quot;);
1681 
<span class="line-modified">1682         //   2. keytool -genkey -keyalg DSA -v -keysize 512 Enter &quot;a&quot; for the keystore</span>
1683         // password. Check error (password too short). Enter &quot;password&quot; for
1684         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
1685         // &quot;organizational unit&quot;, &quot;City&quot;, &quot;State&quot;, and &quot;Country Code&quot;.
1686         // Type &quot;yes&quot; when they ask you if everything is correct.
1687         // Type &#39;return&#39; for new key password.
1688         testOK(&quot;a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n&quot;,
<span class="line-modified">1689                 &quot;-genkey -keyalg DSA -v -keysize 512 -keystore x.jks -storetype JKS&quot;);</span>
1690         //   3. keytool -list -v -storepass password
1691         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1692         //   4. keytool -list -v Type &quot;a&quot; for the keystore password.
1693         // Check error (wrong keystore password).
1694         testFail(&quot;a\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1695         assertTrue(ex.indexOf(&quot;password was incorrect&quot;) != -1);
<span class="line-modified">1696         //   5. keytool - -keyalg DSA -v -keysize 512 Enter &quot;password&quot; as the password.</span>
1697         // Check error (alias &#39;mykey&#39; already exists).
<span class="line-modified">1698         testFail(&quot;password\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512&quot; +</span>
1699                 &quot; -keystore x.jks -storetype JKS&quot;);
1700         assertTrue(ex.indexOf(&quot;alias &lt;mykey&gt; already exists&quot;) != -1);
<span class="line-modified">1701         //   6. keytool -genkey -keyalg DSA -v -keysize 512 -alias mykey2 -storepass password</span>
1702         // Hit &#39;return&#39; for &quot;first and last name&quot;, &quot;organizational unit&quot;, &quot;City&quot;,
1703         // &quot;State&quot;, and &quot;Country Code&quot;. Type &quot;yes&quot; when they ask you if
1704         // everything is correct. Type &#39;return&#39; for new key password.
<span class="line-modified">1705         testOK(&quot;\n\n\n\n\n\nyes\n\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512 -alias mykey2&quot; +</span>
1706                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1707         //   7. keytool -list -v Type &#39;password&#39; for the store password.
1708         testOK(&quot;password\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1709         //   8. keytool -keypasswd -v -alias mykey2 -storepass password
1710         // Type &quot;a&quot; for the new key password. Type &quot;aaaaaa&quot; for the new key
1711         // password. Type &quot;bbbbbb&quot; when re-entering the new key password.
1712         // Type &quot;a&quot; for the new key password. Check Error (too many failures).
1713         testFail(&quot;a\naaaaaa\nbbbbbb\na\n&quot;, &quot;-keypasswd -v -alias mykey2&quot; +
1714                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1715         assertTrue(ex.indexOf(&quot;Too many failures - try later&quot;) != -1);
1716         //   9. keytool -keypasswd -v -alias mykey2 -storepass password
1717         // Type &quot;aaaaaa&quot; for the new key password. Type &quot;aaaaaa&quot;
1718         // when re-entering the new key password.
1719         testOK(&quot;aaaaaa\naaaaaa\n&quot;, &quot;-keypasswd -v -alias mykey2 &quot; +
1720                 &quot;-storepass password -keystore x.jks -storetype JKS&quot;);
1721         //  10. keytool -selfcert -v -alias mykey -storepass password
1722         testOK(&quot;&quot;, &quot;-selfcert -v -alias mykey -storepass password &quot; +
1723                 &quot;-keystore x.jks -storetype JKS&quot;);
1724         //  11. keytool -list -v -storepass password
1725         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
</pre>
<hr />
<pre>
1794         testOK(&quot;&quot;, p11Arg +
1795                 &quot;-storepass test12 -selfcert -alias genkey -dname cn=selfCert&quot;);
1796         testOK(&quot;&quot;, p11Arg +
1797                 &quot;-storepass test12 -list -alias genkey -v&quot;);
1798         assertTrue(out.indexOf(&quot;Owner: CN=selfCert&quot;) != -1);
1799         //(check that cert subject DN is [cn=selfCert])
1800         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias genkey&quot;);
1801         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1802         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1);
1803         //(check for empty database listing)
1804         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs unedit cert8.db key3.db&quot;);
1805         remove(&quot;genkey.cert&quot;);
1806         remove(&quot;genkey.certreq&quot;);
1807         //  12. sccs unedit cert8.db key3.db
1808     }
1809 
1810     // tesing new option -srcProviderName
1811     void sszzTest() throws Exception {
1812         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1813         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
<span class="line-modified">1814         testOK(&quot;&quot;, NSS_P11_ARG+&quot;-genkeypair -keyalg DSA -dname CN=NSS &quot; +</span>
1815                 &quot;-alias nss -storepass test12&quot;);
1816         testOK(&quot;&quot;, NSS_SRC_P11_ARG + NZZ_P11_ARG +
1817                 &quot;-importkeystore -srcstorepass test12 -deststorepass test12&quot;);
1818         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1819         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1820     }
1821 
1822     public static void main(String[] args) throws Exception {
1823         Locale reservedLocale = Locale.getDefault();
1824         try {
1825             // first test if HumanInputStream really acts like a human being
1826             HumanInputStream.test();
1827             KeyToolTest t = new KeyToolTest();
1828 
1829             if (System.getProperty(&quot;file&quot;) != null) {
1830                 t.sqeTest();
1831                 t.testAll();
1832                 t.i18nTest();
1833                 t.v3extTest(&quot;RSA&quot;);
1834                 t.v3extTest(&quot;DSA&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="ImportPrompt.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="NssTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>