<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/jarsigner/compatibility/Compatibility.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<a name="2" id="anc2"></a><span class="line-modified">  26  * @summary This test is used to verify the compatibility on jarsigner cross</span>

  27  *     different JDK releases. It also can be used to check jar signing (w/
<a name="3" id="anc3"></a><span class="line-modified">  28  *     and w/o TSA) and verifying on some specific key algorithms and digest</span>
<span class="line-modified">  29  *     algorithms.</span>
<span class="line-modified">  30  *     Note that, this is a manual test. For more details about the test and</span>
<span class="line-removed">  31  *     its usages, please look through README.</span>
  32  *
<a name="4" id="anc4"></a><span class="line-modified">  33  * @modules java.base/sun.security.pkcs</span>
<span class="line-removed">  34  *          java.base/sun.security.timestamp</span>
<span class="line-removed">  35  *          java.base/sun.security.tools.keytool</span>
<span class="line-removed">  36  *          java.base/sun.security.util</span>
<span class="line-removed">  37  *          java.base/sun.security.x509</span>
<span class="line-removed">  38  * @library /test/lib /lib/testlibrary ../warnings</span>
  39  * @compile -source 1.7 -target 1.7 JdkUtils.java
  40  * @run main/manual/othervm Compatibility
  41  */
  42 
<a name="5" id="anc5"></a>

  43 import java.io.BufferedReader;
  44 import java.io.File;
<a name="6" id="anc6"></a>
  45 import java.io.FileReader;
  46 import java.io.FileWriter;
  47 import java.io.IOException;
<a name="7" id="anc7"></a>
  48 import java.io.PrintStream;
<a name="8" id="anc8"></a>

  49 import java.text.DateFormat;
  50 import java.text.SimpleDateFormat;
  51 import java.util.ArrayList;
<a name="9" id="anc9"></a>
  52 import java.util.Calendar;
  53 import java.util.Date;
  54 import java.util.HashMap;
  55 import java.util.HashSet;
  56 import java.util.List;
<a name="10" id="anc10"></a>
  57 import java.util.Map;
  58 import java.util.Set;
  59 import java.util.concurrent.TimeUnit;
<a name="11" id="anc11"></a><span class="line-modified">  60 import java.util.regex.Matcher;</span>
<span class="line-modified">  61 import java.util.regex.Pattern;</span>




  62 
  63 import jdk.test.lib.process.OutputAnalyzer;
  64 import jdk.test.lib.process.ProcessTools;
  65 import jdk.test.lib.util.JarUtils;
  66 
  67 public class Compatibility {
  68 
<a name="12" id="anc12"></a><span class="line-removed">  69     private static final String TEST_JAR_NAME = &quot;test.jar&quot;;</span>
<span class="line-removed">  70 </span>
  71     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;);
  72     private static final String TEST_CLASSES = System.getProperty(&quot;test.classes&quot;);
  73     private static final String TEST_JDK = System.getProperty(&quot;test.jdk&quot;);
<a name="13" id="anc13"></a><span class="line-modified">  74     private static final String TEST_JARSIGNER = jarsignerPath(TEST_JDK);</span>
  75 
  76     private static final String PROXY_HOST = System.getProperty(&quot;proxyHost&quot;);
  77     private static final String PROXY_PORT = System.getProperty(&quot;proxyPort&quot;, &quot;80&quot;);
  78 
  79     // An alternative security properties file.
  80     // The test provides a default one, which only contains two lines:
  81     // jdk.certpath.disabledAlgorithms=MD2, MD5
  82     // jdk.jar.disabledAlgorithms=MD2, MD5
  83     private static final String JAVA_SECURITY = System.getProperty(
  84             &quot;javaSecurityFile&quot;, TEST_SRC + &quot;/java.security&quot;);
  85 
  86     private static final String PASSWORD = &quot;testpass&quot;;
<a name="14" id="anc14"></a><span class="line-modified">  87     private static final String KEYSTORE = &quot;testKeystore&quot;;</span>
  88 
  89     private static final String RSA = &quot;RSA&quot;;
  90     private static final String DSA = &quot;DSA&quot;;
  91     private static final String EC = &quot;EC&quot;;
<a name="15" id="anc15"></a><span class="line-modified">  92     private static final String[] KEY_ALGORITHMS = new String[] {</span>

  93             RSA,
  94             DSA,
  95             EC};
  96 
  97     private static final String SHA1 = &quot;SHA-1&quot;;
  98     private static final String SHA256 = &quot;SHA-256&quot;;
<a name="16" id="anc16"></a>
  99     private static final String SHA512 = &quot;SHA-512&quot;;
 100     private static final String DEFAULT = &quot;DEFAULT&quot;;
<a name="17" id="anc17"></a><span class="line-modified"> 101     private static final String[] DIGEST_ALGORITHMS = new String[] {</span>

 102             SHA1,
 103             SHA256,
<a name="18" id="anc18"></a><span class="line-modified"> 104             SHA512,</span>

 105             DEFAULT};
 106 
<a name="19" id="anc19"></a><span class="line-modified"> 107     private static final boolean[] EXPIRED = new boolean[] {</span>
<span class="line-modified"> 108             false,</span>
<span class="line-modified"> 109             true};</span>










 110 
 111     private static final Calendar CALENDAR = Calendar.getInstance();
 112     private static final DateFormat DATE_FORMAT
 113             = new SimpleDateFormat(&quot;yyyy/MM/dd HH:mm:ss&quot;);
 114 
 115     // The certificate validity period in minutes. The default value is 1440
 116     // minutes, namely 1 day.
 117     private static final int CERT_VALIDITY
 118             = Integer.valueOf(System.getProperty(&quot;certValidity&quot;, &quot;1440&quot;));
 119     static {
 120         if (CERT_VALIDITY &lt; 1 || CERT_VALIDITY &gt; 1440) {
 121             throw new RuntimeException(
<a name="20" id="anc20"></a><span class="line-modified"> 122                     &quot;certValidity if out of range [1, 1440]: &quot; + CERT_VALIDITY);</span>
 123         }
 124     }
 125 
 126     // If true, an additional verifying will be triggered after all of
 127     // valid certificates expire. The default value is false.
 128     public static final boolean DELAY_VERIFY
 129             = Boolean.valueOf(System.getProperty(&quot;delayVerify&quot;, &quot;false&quot;));
 130 
 131     private static long lastCertStartTime;
 132 
 133     private static DetailsOutputStream detailsOutput;
 134 
<a name="21" id="anc21"></a><span class="line-modified"> 135     public static void main(String[] args) throws Throwable {</span>









 136         // Backups stdout and stderr.
 137         PrintStream origStdOut = System.out;
 138         PrintStream origStdErr = System.err;
 139 
<a name="22" id="anc22"></a><span class="line-modified"> 140         detailsOutput = new DetailsOutputStream();</span>
 141 
 142         // Redirects the system output to a custom one.
 143         PrintStream printStream = new PrintStream(detailsOutput);
 144         System.setOut(printStream);
 145         System.setErr(printStream);
 146 
<a name="23" id="anc23"></a><span class="line-modified"> 147         List&lt;TsaInfo&gt; tsaList = tsaInfoList();</span>
<span class="line-removed"> 148         if (tsaList.size() == 0) {</span>
<span class="line-removed"> 149             throw new RuntimeException(&quot;TSA service is mandatory.&quot;);</span>
<span class="line-removed"> 150         }</span>
 151 
<a name="24" id="anc24"></a>
 152         List&lt;JdkInfo&gt; jdkInfoList = jdkInfoList();
 153         List&lt;CertInfo&gt; certList = createCertificates(jdkInfoList);
<a name="25" id="anc25"></a><span class="line-modified"> 154         createJar();</span>
<span class="line-modified"> 155         List&lt;SignItem&gt; signItems = test(jdkInfoList, tsaList, certList);</span>
 156 
<a name="26" id="anc26"></a><span class="line-modified"> 157         boolean failed = generateReport(tsaList, signItems);</span>
 158 
 159         // Restores the original stdout and stderr.
 160         System.setOut(origStdOut);
 161         System.setErr(origStdErr);
 162 
 163         if (failed) {
 164             throw new RuntimeException(&quot;At least one test case failed. &quot;
 165                     + &quot;Please check the failed row(s) in report.html &quot;
 166                     + &quot;or failedReport.html.&quot;);
 167         }
 168     }
 169 
<a name="27" id="anc27"></a><span class="line-modified"> 170     // Creates a jar file that contains an empty file.</span>
<span class="line-modified"> 171     private static void createJar() throws IOException {</span>
<span class="line-modified"> 172         String testFile = &quot;test&quot;;</span>
<span class="line-modified"> 173         new File(testFile).createNewFile();</span>
<span class="line-modified"> 174         JarUtils.createJar(TEST_JAR_NAME, testFile);</span>











































































 175     }
 176 
 177     // Creates a key store that includes a set of valid/expired certificates
 178     // with various algorithms.
 179     private static List&lt;CertInfo&gt; createCertificates(List&lt;JdkInfo&gt; jdkInfoList)
 180             throws Throwable {
<a name="28" id="anc28"></a><span class="line-modified"> 181         List&lt;CertInfo&gt; certList = new ArrayList&lt;CertInfo&gt;();</span>
<span class="line-modified"> 182         Set&lt;String&gt; expiredCertFilter = new HashSet&lt;String&gt;();</span>
<span class="line-modified"> 183 </span>
<span class="line-modified"> 184         for(JdkInfo jdkInfo : jdkInfoList) {</span>
<span class="line-modified"> 185             for(String keyAlgorithm : KEY_ALGORITHMS) {</span>
<span class="line-modified"> 186                 for(String digestAlgorithm : DIGEST_ALGORITHMS) {</span>
<span class="line-modified"> 187                     for(int keySize : keySizes(keyAlgorithm)) {</span>

 188                         for(boolean expired : EXPIRED) {
 189                             // It creates only one expired certificate for one
 190                             // key algorithm.
 191                             if (expired
 192                                     &amp;&amp; !expiredCertFilter.add(keyAlgorithm)) {
 193                                 continue;
 194                             }
 195 
 196                             CertInfo certInfo = new CertInfo(
<a name="29" id="anc29"></a><span class="line-modified"> 197                                     jdkInfo.version,</span>
 198                                     keyAlgorithm,
 199                                     digestAlgorithm,
 200                                     keySize,
 201                                     expired);
<a name="30" id="anc30"></a><span class="line-modified"> 202                             if (!certList.contains(certInfo)) {</span>
<span class="line-modified"> 203                                 String alias = createCertificate(</span>
<span class="line-modified"> 204                                         jdkInfo.jdkPath, certInfo);</span>
<span class="line-modified"> 205                                 if (alias != null) {</span>
<span class="line-modified"> 206                                     certList.add(certInfo);</span>
<span class="line-modified"> 207                                 }</span>
 208                             }
<a name="31" id="anc31"></a>

 209                         }
 210                     }
 211                 }
 212             }
 213         }
 214 
<a name="32" id="anc32"></a>













 215         return certList;
 216     }
 217 
 218     // Creates/Updates a key store that adds a certificate with specific algorithm.
<a name="33" id="anc33"></a><span class="line-modified"> 219     private static String createCertificate(String jdkPath, CertInfo certInfo)</span>
 220             throws Throwable {
<a name="34" id="anc34"></a><span class="line-modified"> 221         String alias = certInfo.alias();</span>
<span class="line-removed"> 222 </span>
<span class="line-removed"> 223         List&lt;String&gt; arguments = new ArrayList&lt;String&gt;();</span>
 224         arguments.add(&quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY);
 225         arguments.add(&quot;-v&quot;);
<a name="35" id="anc35"></a>
 226         arguments.add(&quot;-storetype&quot;);
 227         arguments.add(&quot;jks&quot;);
<a name="36" id="anc36"></a><span class="line-modified"> 228         arguments.add(&quot;-genkey&quot;);</span>




 229         arguments.add(&quot;-keyalg&quot;);
 230         arguments.add(certInfo.keyAlgorithm);
<a name="37" id="anc37"></a><span class="line-modified"> 231         String sigalg = sigalg(certInfo.digestAlgorithm, certInfo.keyAlgorithm);</span>
 232         if (sigalg != null) {
 233             arguments.add(&quot;-sigalg&quot;);
 234             arguments.add(sigalg);
 235         }
 236         if (certInfo.keySize != 0) {
 237             arguments.add(&quot;-keysize&quot;);
 238             arguments.add(certInfo.keySize + &quot;&quot;);
 239         }
 240         arguments.add(&quot;-dname&quot;);
<a name="38" id="anc38"></a><span class="line-modified"> 241         arguments.add(&quot;CN=Test&quot;);</span>
 242         arguments.add(&quot;-alias&quot;);
<a name="39" id="anc39"></a><span class="line-modified"> 243         arguments.add(alias);</span>
 244         arguments.add(&quot;-keypass&quot;);
 245         arguments.add(PASSWORD);
<a name="40" id="anc40"></a><span class="line-removed"> 246         arguments.add(&quot;-storepass&quot;);</span>
<span class="line-removed"> 247         arguments.add(PASSWORD);</span>
 248 
 249         arguments.add(&quot;-startdate&quot;);
 250         arguments.add(startDate(certInfo.expired));
 251         arguments.add(&quot;-validity&quot;);
<a name="41" id="anc41"></a>
 252         arguments.add(&quot;1&quot;);
<a name="42" id="anc42"></a><span class="line-removed"> 253         arguments.add(&quot;-keystore&quot;);</span>
<span class="line-removed"> 254         arguments.add(KEYSTORE);</span>
 255 
 256         OutputAnalyzer outputAnalyzer = execTool(
<a name="43" id="anc43"></a><span class="line-modified"> 257                 jdkPath + &quot;/bin/keytool&quot;,</span>
 258                 arguments.toArray(new String[arguments.size()]));
<a name="44" id="anc44"></a><span class="line-modified"> 259         if (outputAnalyzer.getExitValue() == 0</span>
<span class="line-modified"> 260                 &amp;&amp; !outputAnalyzer.getOutput().matches(&quot;[Ee]xception&quot;)) {</span>
<span class="line-modified"> 261             return alias;</span>
<span class="line-modified"> 262         } else {</span>
<span class="line-modified"> 263             return null;</span>
 264         }
 265     }
 266 
<a name="45" id="anc45"></a><span class="line-removed"> 267     private static String sigalg(String digestAlgorithm, String keyAlgorithm) {</span>
<span class="line-removed"> 268         if (digestAlgorithm == DEFAULT) {</span>
<span class="line-removed"> 269             return null;</span>
<span class="line-removed"> 270         }</span>
<span class="line-removed"> 271 </span>
<span class="line-removed"> 272         String keyName = keyAlgorithm == EC ? &quot;ECDSA&quot; : keyAlgorithm;</span>
<span class="line-removed"> 273         return digestAlgorithm.replace(&quot;-&quot;, &quot;&quot;) + &quot;with&quot; + keyName;</span>
<span class="line-removed"> 274     }</span>
<span class="line-removed"> 275 </span>
 276     // The validity period of a certificate always be 1 day. For creating an
 277     // expired certificate, the start date is the time before 1 day, then the
 278     // certificate expires immediately. And for creating a valid certificate,
 279     // the start date is the time before (1 day - CERT_VALIDITY minutes), then
 280     // the certificate will expires in CERT_VALIDITY minutes.
 281     private static String startDate(boolean expiredCert) {
 282         CALENDAR.setTime(new Date());
<a name="46" id="anc46"></a><span class="line-modified"> 283         CALENDAR.add(Calendar.DAY_OF_MONTH, -1);</span>
<span class="line-modified"> 284         if (!expiredCert) {</span>



 285             CALENDAR.add(Calendar.MINUTE, CERT_VALIDITY);
 286         }
 287         Date startDate = CALENDAR.getTime();
<a name="47" id="anc47"></a><span class="line-modified"> 288         lastCertStartTime = startDate.getTime();</span>


 289         return DATE_FORMAT.format(startDate);
 290     }
 291 
<a name="48" id="anc48"></a><span class="line-modified"> 292     // Retrieves JDK info from the file which is specified by property jdkListFile,</span>
<span class="line-modified"> 293     // or from property jdkList if jdkListFile is not available.</span>




 294     private static List&lt;JdkInfo&gt; jdkInfoList() throws Throwable {
 295         String[] jdkList = list(&quot;jdkList&quot;);
 296         if (jdkList.length == 0) {
<a name="49" id="anc49"></a><span class="line-modified"> 297             jdkList = new String[] { TEST_JDK };</span>
 298         }
 299 
<a name="50" id="anc50"></a><span class="line-modified"> 300         List&lt;JdkInfo&gt; jdkInfoList = new ArrayList&lt;JdkInfo&gt;();</span>

 301         for (String jdkPath : jdkList) {
<a name="51" id="anc51"></a><span class="line-modified"> 302             JdkInfo jdkInfo = new JdkInfo(jdkPath);</span>

 303             // The JDK version must be unique.
 304             if (!jdkInfoList.contains(jdkInfo)) {
<a name="52" id="anc52"></a>


 305                 jdkInfoList.add(jdkInfo);
 306             } else {
 307                 System.out.println(&quot;The JDK version is duplicate: &quot; + jdkPath);
 308             }
 309         }
 310         return jdkInfoList;
 311     }
 312 
<a name="53" id="anc53"></a>






































 313     // Retrieves TSA info from the file which is specified by property tsaListFile,
 314     // or from property tsaList if tsaListFile is not available.
 315     private static List&lt;TsaInfo&gt; tsaInfoList() throws IOException {
 316         String[] tsaList = list(&quot;tsaList&quot;);
 317 
<a name="54" id="anc54"></a><span class="line-modified"> 318         List&lt;TsaInfo&gt; tsaInfoList = new ArrayList&lt;TsaInfo&gt;();</span>
 319         for (int i = 0; i &lt; tsaList.length; i++) {
 320             String[] values = tsaList[i].split(&quot;;digests=&quot;);
 321 
 322             String[] digests = new String[0];
 323             if (values.length == 2) {
 324                 digests = values[1].split(&quot;,&quot;);
 325             }
 326 
<a name="55" id="anc55"></a><span class="line-modified"> 327             TsaInfo bufTsa = new TsaInfo(i, values[0]);</span>
<span class="line-modified"> 328 </span>



 329             for (String digest : digests) {
<a name="56" id="anc56"></a><span class="line-modified"> 330                 bufTsa.addDigest(digest);</span>
 331             }
<a name="57" id="anc57"></a><span class="line-removed"> 332 </span>
 333             tsaInfoList.add(bufTsa);
 334         }
 335 
<a name="58" id="anc58"></a>



 336         return tsaInfoList;
 337     }
 338 
<a name="59" id="anc59"></a><span class="line-modified"> 339     private static String[] list(String listProp)</span>
<span class="line-removed"> 340             throws IOException {</span>
 341         String listFileProp = listProp + &quot;File&quot;;
 342         String listFile = System.getProperty(listFileProp);
 343         if (!isEmpty(listFile)) {
 344             System.out.println(listFileProp + &quot;=&quot; + listFile);
<a name="60" id="anc60"></a><span class="line-modified"> 345             List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
 346             BufferedReader reader = new BufferedReader(
 347                     new FileReader(listFile));
 348             String line;
 349             while ((line = reader.readLine()) != null) {
 350                 String item = line.trim();
 351                 if (!item.isEmpty()) {
 352                     list.add(item);
 353                 }
 354             }
 355             reader.close();
 356             return list.toArray(new String[list.size()]);
 357         }
 358 
 359         String list = System.getProperty(listProp);
 360         System.out.println(listProp + &quot;=&quot; + list);
 361         return !isEmpty(list) ? list.split(&quot;#&quot;) : new String[0];
 362     }
 363 
 364     private static boolean isEmpty(String str) {
 365         return str == null || str.isEmpty();
 366     }
 367 
 368     // A JDK (signer) signs a jar with a variety of algorithms, and then all of
 369     // JDKs (verifiers), including the signer itself, try to verify the signed
 370     // jars respectively.
 371     private static List&lt;SignItem&gt; test(List&lt;JdkInfo&gt; jdkInfoList,
<a name="61" id="anc61"></a><span class="line-modified"> 372             List&lt;TsaInfo&gt; tsaInfoList, List&lt;CertInfo&gt; certList)</span>
<span class="line-modified"> 373             throws Throwable {</span>
 374         detailsOutput.transferPhase();
<a name="62" id="anc62"></a><span class="line-modified"> 375         List&lt;SignItem&gt; signItems = signing(jdkInfoList, tsaInfoList, certList);</span>







 376 
 377         detailsOutput.transferPhase();
 378         for (SignItem signItem : signItems) {
 379             for (JdkInfo verifierInfo : jdkInfoList) {
<a name="63" id="anc63"></a><span class="line-modified"> 380                 // JDK 6 doesn&#39;t support EC</span>
<span class="line-modified"> 381                 if (!verifierInfo.isJdk6()</span>
<span class="line-modified"> 382                         || signItem.certInfo.keyAlgorithm != EC) {</span>
<span class="line-modified"> 383                     verifying(signItem, VerifyItem.build(verifierInfo));</span>
<span class="line-modified"> 384                 }</span>

 385             }
 386         }
 387 
<a name="64" id="anc64"></a>













 388         if (DELAY_VERIFY) {
 389             detailsOutput.transferPhase();
 390             System.out.print(&quot;Waiting for delay verifying&quot;);
<a name="65" id="anc65"></a><span class="line-removed"> 391             long lastCertExpirationTime = lastCertStartTime + 24 * 60 * 60 * 1000;</span>
 392             while (System.currentTimeMillis() &lt; lastCertExpirationTime) {
 393                 TimeUnit.SECONDS.sleep(30);
 394                 System.out.print(&quot;.&quot;);
 395             }
 396             System.out.println();
 397 
 398             System.out.println(&quot;Delay verifying starts&quot;);
 399             for (SignItem signItem : signItems) {
 400                 for (VerifyItem verifyItem : signItem.verifyItems) {
 401                     verifying(signItem, verifyItem);
 402                 }
 403             }
 404         }
 405 
 406         detailsOutput.transferPhase();
<a name="66" id="anc66"></a><span class="line-removed"> 407 </span>
 408         return signItems;
 409     }
 410 
 411     private static List&lt;SignItem&gt; signing(List&lt;JdkInfo&gt; jdkInfos,
<a name="67" id="anc67"></a><span class="line-modified"> 412             List&lt;TsaInfo&gt; tsaList, List&lt;CertInfo&gt; certList) throws Throwable {</span>
<span class="line-modified"> 413         List&lt;SignItem&gt; signItems = new ArrayList&lt;SignItem&gt;();</span>
<span class="line-modified"> 414 </span>
<span class="line-modified"> 415         Set&lt;String&gt; signFilter = new HashSet&lt;String&gt;();</span>
<span class="line-modified"> 416 </span>
<span class="line-modified"> 417         for (JdkInfo signerInfo : jdkInfos) {</span>
<span class="line-modified"> 418             for (String keyAlgorithm : KEY_ALGORITHMS) {</span>
<span class="line-modified"> 419                 // JDK 6 doesn&#39;t support EC</span>
<span class="line-modified"> 420                 if (signerInfo.isJdk6() &amp;&amp; keyAlgorithm == EC) {</span>
<span class="line-modified"> 421                     continue;</span>




 422                 }
 423 
<a name="68" id="anc68"></a><span class="line-modified"> 424                 for (String digestAlgorithm : DIGEST_ALGORITHMS) {</span>
<span class="line-modified"> 425                     String sigalg = sigalg(digestAlgorithm, keyAlgorithm);</span>
<span class="line-removed"> 426                     // If the signature algorithm is not supported by the JDK,</span>
<span class="line-removed"> 427                     // it cannot try to sign jar with this algorithm.</span>
<span class="line-removed"> 428                     if (sigalg != null &amp;&amp; !signerInfo.isSupportedSigalg(sigalg)) {</span>
<span class="line-removed"> 429                         continue;</span>
<span class="line-removed"> 430                     }</span>
 431 
<a name="69" id="anc69"></a>



 432                     // If the JDK doesn&#39;t support option -tsadigestalg, the
<a name="70" id="anc70"></a><span class="line-modified"> 433                     // associated cases just be ignored.</span>
<span class="line-modified"> 434                     if (digestAlgorithm != DEFAULT</span>
<span class="line-modified"> 435                             &amp;&amp; !signerInfo.supportsTsadigestalg) {</span>
<span class="line-removed"> 436                         continue;</span>
 437                     }
<a name="71" id="anc71"></a>







 438 
<a name="72" id="anc72"></a><span class="line-modified"> 439                     for (int keySize : keySizes(keyAlgorithm)) {</span>
<span class="line-modified"> 440                         for (boolean expired : EXPIRED) {</span>
<span class="line-modified"> 441                             CertInfo certInfo = new CertInfo(</span>
<span class="line-modified"> 442                                     signerInfo.version,</span>
<span class="line-modified"> 443                                     keyAlgorithm,</span>
<span class="line-modified"> 444                                     digestAlgorithm,</span>
<span class="line-modified"> 445                                     keySize,</span>
<span class="line-removed"> 446                                     expired);</span>
<span class="line-removed"> 447                             if (!certList.contains(certInfo)) {</span>
<span class="line-removed"> 448                                 continue;</span>
<span class="line-removed"> 449                             }</span>
<span class="line-removed"> 450 </span>
<span class="line-removed"> 451                             String tsadigestalg = digestAlgorithm != DEFAULT</span>
<span class="line-removed"> 452                                                 ? digestAlgorithm</span>
<span class="line-removed"> 453                                                 : null;</span>
<span class="line-removed"> 454 </span>
<span class="line-removed"> 455                             for (TsaInfo tsaInfo : tsaList) {</span>
<span class="line-removed"> 456                                 // It has to ignore the digest algorithm, which</span>
<span class="line-removed"> 457                                 // is not supported by the TSA server.</span>
<span class="line-removed"> 458                                 if(!tsaInfo.isDigestSupported(tsadigestalg)) {</span>
<span class="line-removed"> 459                                     continue;</span>
<span class="line-removed"> 460                                 }</span>
<span class="line-removed"> 461 </span>
<span class="line-removed"> 462                                 String tsaUrl = tsaInfo.tsaUrl;</span>
<span class="line-removed"> 463                                 if (TsaFilter.filter(</span>
<span class="line-removed"> 464                                         signerInfo.version,</span>
<span class="line-removed"> 465                                         digestAlgorithm,</span>
<span class="line-removed"> 466                                         expired,</span>
<span class="line-removed"> 467                                         tsaInfo.index)) {</span>
<span class="line-removed"> 468                                     tsaUrl = null;</span>
<span class="line-removed"> 469                                 }</span>
 470 
<a name="73" id="anc73"></a><span class="line-modified"> 471                                 String signedJar = &quot;JDK_&quot;</span>
<span class="line-modified"> 472                                         + signerInfo.version + &quot;-CERT_&quot;</span>
<span class="line-removed"> 473                                         + certInfo</span>
<span class="line-removed"> 474                                         + (tsaUrl == null</span>
<span class="line-removed"> 475                                            ? &quot;&quot;</span>
<span class="line-removed"> 476                                            : &quot;-TSA_&quot; + tsaInfo.index);</span>
 477 
<a name="74" id="anc74"></a><span class="line-modified"> 478                                 // It has to ignore the same jar signing.</span>
<span class="line-modified"> 479                                 if (!signFilter.add(signedJar)) {</span>
<span class="line-modified"> 480                                     continue;</span>
<span class="line-modified"> 481                                 }</span>


 482 
<a name="75" id="anc75"></a><span class="line-modified"> 483                                 SignItem signItem = SignItem.build()</span>
<span class="line-modified"> 484                                         .certInfo(certInfo)</span>
<span class="line-modified"> 485                                         .version(signerInfo.version)</span>
<span class="line-modified"> 486                                         .signatureAlgorithm(sigalg)</span>
<span class="line-modified"> 487                                         .tsaDigestAlgorithm(</span>
<span class="line-modified"> 488                                                 tsaUrl == null</span>
<span class="line-modified"> 489                                                 ? null</span>
<span class="line-modified"> 490                                                 : tsadigestalg)</span>
<span class="line-modified"> 491                                         .tsaIndex(</span>
<span class="line-modified"> 492                                                 tsaUrl == null</span>
<span class="line-modified"> 493                                                 ? -1</span>
<span class="line-modified"> 494                                                 : tsaInfo.index)</span>
<span class="line-removed"> 495                                         .signedJar(signedJar);</span>
<span class="line-removed"> 496                                 String signingId = signingId(signItem);</span>
<span class="line-removed"> 497                                 detailsOutput.writeAnchorName(signingId,</span>
<span class="line-removed"> 498                                         &quot;Signing: &quot; + signingId);</span>
<span class="line-removed"> 499 </span>
<span class="line-removed"> 500                                 OutputAnalyzer signOA = signJar(</span>
<span class="line-removed"> 501                                         signerInfo.jarsignerPath,</span>
<span class="line-removed"> 502                                         sigalg,</span>
<span class="line-removed"> 503                                         tsadigestalg,</span>
<span class="line-removed"> 504                                         tsaUrl,</span>
<span class="line-removed"> 505                                         certInfo.alias(),</span>
<span class="line-removed"> 506                                         signedJar);</span>
<span class="line-removed"> 507                                 Status signingStatus = signingStatus(signOA);</span>
<span class="line-removed"> 508                                 signItem.status(signingStatus);</span>
<span class="line-removed"> 509 </span>
<span class="line-removed"> 510                                 if (signingStatus != Status.ERROR) {</span>
<span class="line-removed"> 511                                     // Using the testing JDK, which is specified</span>
<span class="line-removed"> 512                                     // by jtreg option &quot;-jdk&quot;, to verify the</span>
<span class="line-removed"> 513                                     // signed jar and extract the signature</span>
<span class="line-removed"> 514                                     // algorithm and timestamp digest algorithm.</span>
<span class="line-removed"> 515                                     String output = verifyJar(TEST_JARSIGNER,</span>
<span class="line-removed"> 516                                             signedJar).getOutput();</span>
<span class="line-removed"> 517                                     signItem.extractedSignatureAlgorithm(</span>
<span class="line-removed"> 518                                             extract(output,</span>
<span class="line-removed"> 519                                                     &quot; *Signature algorithm.*&quot;,</span>
<span class="line-removed"> 520                                                     &quot;.*: |,.*&quot;));</span>
<span class="line-removed"> 521                                     signItem.extractedTsaDigestAlgorithm(</span>
<span class="line-removed"> 522                                             extract(output,</span>
<span class="line-removed"> 523                                                     &quot; *Timestamp digest algorithm.*&quot;,</span>
<span class="line-removed"> 524                                                     &quot;.*: &quot;));</span>
 525                                 }
<a name="76" id="anc76"></a><span class="line-removed"> 526 </span>
<span class="line-removed"> 527                                 signItems.add(signItem);</span>
 528                             }
<a name="77" id="anc77"></a>


















 529                         }
 530                     }
 531                 }
 532             }
 533         }
 534 
 535         return signItems;
 536     }
 537 
<a name="78" id="anc78"></a>








 538     private static void verifying(SignItem signItem, VerifyItem verifyItem)
 539             throws Throwable {
<a name="79" id="anc79"></a><span class="line-modified"> 540         boolean delayVerify = verifyItem.status == Status.NONE;</span>
<span class="line-modified"> 541         String verifyingId = verifyingId(signItem, verifyItem, !delayVerify);</span>

 542         detailsOutput.writeAnchorName(verifyingId, &quot;Verifying: &quot; + verifyingId);
<a name="80" id="anc80"></a><span class="line-removed"> 543 </span>
 544         OutputAnalyzer verifyOA = verifyJar(verifyItem.jdkInfo.jarsignerPath,
<a name="81" id="anc81"></a><span class="line-modified"> 545                 signItem.signedJar);</span>
<span class="line-modified"> 546         Status verifyingStatus = verifyingStatus(verifyOA);</span>
<span class="line-modified"> 547 </span>
<span class="line-modified"> 548         // It checks if the default timestamp digest algorithm is SHA-256.</span>
<span class="line-modified"> 549         if (verifyingStatus != Status.ERROR</span>
<span class="line-modified"> 550                 &amp;&amp; signItem.tsaDigestAlgorithm == null) {</span>
<span class="line-modified"> 551             verifyingStatus = signItem.extractedTsaDigestAlgorithm != null</span>
<span class="line-modified"> 552                                     &amp;&amp; !signItem.extractedTsaDigestAlgorithm.matches(&quot;SHA-?256&quot;)</span>
<span class="line-modified"> 553                             ? Status.ERROR</span>
<span class="line-modified"> 554                             : verifyingStatus;</span>
<span class="line-modified"> 555             if (verifyingStatus == Status.ERROR) {</span>
<span class="line-modified"> 556                 System.out.println(&quot;The default tsa digest is not SHA-256: &quot;</span>
<span class="line-modified"> 557                     + signItem.extractedTsaDigestAlgorithm);</span>
<span class="line-modified"> 558             }</span>















 559         }
 560 
<a name="82" id="anc82"></a><span class="line-modified"> 561         if (delayVerify) {</span>
<span class="line-modified"> 562             signItem.addVerifyItem(verifyItem.status(verifyingStatus));</span>
 563         } else {
 564             verifyItem.delayStatus(verifyingStatus);
 565         }
<a name="83" id="anc83"></a><span class="line-removed"> 566     }</span>
 567 
<a name="84" id="anc84"></a><span class="line-modified"> 568     // Return key sizes according to the specified key algorithm.</span>
<span class="line-modified"> 569     private static int[] keySizes(String keyAlgorithm) {</span>
<span class="line-removed"> 570         if (keyAlgorithm == RSA || keyAlgorithm == DSA) {</span>
<span class="line-removed"> 571             return new int[] { 1024, 2048, 0 };</span>
<span class="line-removed"> 572         } else if (keyAlgorithm == EC) {</span>
<span class="line-removed"> 573             return new int[] { 384, 571, 0 };</span>
 574         }
<a name="85" id="anc85"></a><span class="line-removed"> 575 </span>
<span class="line-removed"> 576         return null;</span>
 577     }
 578 
 579     // Determines the status of signing.
<a name="86" id="anc86"></a><span class="line-modified"> 580     private static Status signingStatus(OutputAnalyzer outputAnalyzer) {</span>
<span class="line-modified"> 581         if (outputAnalyzer.getExitValue() == 0) {</span>
<span class="line-modified"> 582             if (outputAnalyzer.getOutput().contains(Test.WARNING)) {</span>
<span class="line-removed"> 583                 return Status.WARNING;</span>
<span class="line-removed"> 584             } else {</span>
<span class="line-removed"> 585                 return Status.NORMAL;</span>
<span class="line-removed"> 586             }</span>
<span class="line-removed"> 587         } else {</span>
 588             return Status.ERROR;
 589         }
<a name="87" id="anc87"></a>










 590     }
 591 
 592     // Determines the status of verifying.
<a name="88" id="anc88"></a><span class="line-modified"> 593     private static Status verifyingStatus(OutputAnalyzer outputAnalyzer) {</span>
<span class="line-modified"> 594         if (outputAnalyzer.getExitValue() == 0) {</span>
<span class="line-modified"> 595             String output = outputAnalyzer.getOutput();</span>
<span class="line-modified"> 596             if (!output.contains(Test.JAR_VERIFIED)) {</span>
<span class="line-modified"> 597                 return Status.ERROR;</span>
<span class="line-removed"> 598             } else if (output.contains(Test.WARNING)) {</span>
<span class="line-removed"> 599                 return Status.WARNING;</span>
<span class="line-removed"> 600             } else {</span>
<span class="line-removed"> 601                 return Status.NORMAL;</span>
<span class="line-removed"> 602             }</span>
 603         } else {
<a name="89" id="anc89"></a>




















 604             return Status.ERROR;
 605         }
<a name="90" id="anc90"></a><span class="line-removed"> 606     }</span>
 607 
<a name="91" id="anc91"></a><span class="line-modified"> 608     // Extracts string from text by specified patterns.</span>
<span class="line-modified"> 609     private static String extract(String text, String linePattern,</span>
<span class="line-modified"> 610             String replacePattern) {</span>
<span class="line-modified"> 611         Matcher lineMatcher = Pattern.compile(linePattern).matcher(text);</span>
<span class="line-modified"> 612         if (lineMatcher.find()) {</span>
<span class="line-modified"> 613             String line = lineMatcher.group(0);</span>
<span class="line-modified"> 614             return line.replaceAll(replacePattern, &quot;&quot;);</span>
<span class="line-modified"> 615         } else {</span>
<span class="line-modified"> 616             return null;</span>






























 617         }
<a name="92" id="anc92"></a>
 618     }
 619 
 620     // Using specified jarsigner to sign the pre-created jar with specified
 621     // algorithms.
 622     private static OutputAnalyzer signJar(String jarsignerPath, String sigalg,
<a name="93" id="anc93"></a><span class="line-modified"> 623             String tsadigestalg, String tsa, String alias, String signedJar)</span>
<span class="line-modified"> 624             throws Throwable {</span>
<span class="line-modified"> 625         List&lt;String&gt; arguments = new ArrayList&lt;String&gt;();</span>

 626 
 627         if (PROXY_HOST != null &amp;&amp; PROXY_PORT != null) {
 628             arguments.add(&quot;-J-Dhttp.proxyHost=&quot; + PROXY_HOST);
 629             arguments.add(&quot;-J-Dhttp.proxyPort=&quot; + PROXY_PORT);
 630             arguments.add(&quot;-J-Dhttps.proxyHost=&quot; + PROXY_HOST);
 631             arguments.add(&quot;-J-Dhttps.proxyPort=&quot; + PROXY_PORT);
 632         }
 633         arguments.add(&quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY);
 634         arguments.add(&quot;-debug&quot;);
 635         arguments.add(&quot;-verbose&quot;);
<a name="94" id="anc94"></a>



 636         if (sigalg != null) {
 637             arguments.add(&quot;-sigalg&quot;);
 638             arguments.add(sigalg);
 639         }
 640         if (tsa != null) {
 641             arguments.add(&quot;-tsa&quot;);
 642             arguments.add(tsa);
 643         }
 644         if (tsadigestalg != null) {
 645             arguments.add(&quot;-tsadigestalg&quot;);
 646             arguments.add(tsadigestalg);
 647         }
 648         arguments.add(&quot;-keystore&quot;);
 649         arguments.add(KEYSTORE);
 650         arguments.add(&quot;-storepass&quot;);
 651         arguments.add(PASSWORD);
<a name="95" id="anc95"></a>

 652         arguments.add(&quot;-signedjar&quot;);
 653         arguments.add(signedJar + &quot;.jar&quot;);
<a name="96" id="anc96"></a><span class="line-modified"> 654         arguments.add(TEST_JAR_NAME);</span>
 655         arguments.add(alias);
 656 
<a name="97" id="anc97"></a><span class="line-modified"> 657         OutputAnalyzer outputAnalyzer = execTool(</span>
<span class="line-removed"> 658                 jarsignerPath,</span>
 659                 arguments.toArray(new String[arguments.size()]));
 660         return outputAnalyzer;
 661     }
 662 
 663     // Using specified jarsigner to verify the signed jar.
 664     private static OutputAnalyzer verifyJar(String jarsignerPath,
<a name="98" id="anc98"></a><span class="line-modified"> 665             String signedJar) throws Throwable {</span>
<span class="line-modified"> 666         OutputAnalyzer outputAnalyzer = execTool(</span>
<span class="line-modified"> 667                 jarsignerPath,</span>
<span class="line-modified"> 668                 &quot;-J-Djava.security.properties=&quot; + JAVA_SECURITY,</span>
<span class="line-modified"> 669                 &quot;-debug&quot;,</span>
<span class="line-modified"> 670                 &quot;-verbose&quot;,</span>
<span class="line-modified"> 671                 &quot;-certs&quot;,</span>
<span class="line-modified"> 672                 &quot;-keystore&quot;, KEYSTORE,</span>
<span class="line-modified"> 673                 &quot;-verify&quot;, signedJar + &quot;.jar&quot;);</span>





 674         return outputAnalyzer;
 675     }
 676 
 677     // Generates the test result report.
<a name="99" id="anc99"></a><span class="line-modified"> 678     private static boolean generateReport(List&lt;TsaInfo&gt; tsaList,</span>
 679             List&lt;SignItem&gt; signItems) throws IOException {
 680         System.out.println(&quot;Report is being generated...&quot;);
 681 
 682         StringBuilder report = new StringBuilder();
 683         report.append(HtmlHelper.startHtml());
 684         report.append(HtmlHelper.startPre());
<a name="100" id="anc100"></a>








 685         // Generates TSA URLs
 686         report.append(&quot;TSA list:\n&quot;);
 687         for(TsaInfo tsaInfo : tsaList) {
 688             report.append(
<a name="101" id="anc101"></a><span class="line-modified"> 689                     String.format(&quot;%d=%s%n&quot;, tsaInfo.index, tsaInfo.tsaUrl));</span>

 690         }
 691         report.append(HtmlHelper.endPre());
 692 
 693         report.append(HtmlHelper.startTable());
 694         // Generates report headers.
<a name="102" id="anc102"></a><span class="line-modified"> 695         List&lt;String&gt; headers = new ArrayList&lt;String&gt;();</span>
<span class="line-modified"> 696         headers.add(&quot;[Certificate]&quot;);</span>

 697         headers.add(&quot;[Signer JDK]&quot;);
 698         headers.add(&quot;[Signature Algorithm]&quot;);
<a name="103" id="anc103"></a><span class="line-modified"> 699         headers.add(&quot;[TSA Digest]&quot;);</span>

 700         headers.add(&quot;[TSA]&quot;);
 701         headers.add(&quot;[Signing Status]&quot;);
 702         headers.add(&quot;[Verifier JDK]&quot;);
<a name="104" id="anc104"></a>
 703         headers.add(&quot;[Verifying Status]&quot;);
 704         if (DELAY_VERIFY) {
 705             headers.add(&quot;[Delay Verifying Status]&quot;);
 706         }
 707         headers.add(&quot;[Failed]&quot;);
 708         report.append(HtmlHelper.htmlRow(
 709                 headers.toArray(new String[headers.size()])));
 710 
 711         StringBuilder failedReport = new StringBuilder(report.toString());
 712 
<a name="105" id="anc105"></a><span class="line-modified"> 713         boolean failed = false;</span>
 714 
 715         // Generates report rows.
 716         for (SignItem signItem : signItems) {
<a name="106" id="anc106"></a>
 717             for (VerifyItem verifyItem : signItem.verifyItems) {
 718                 String reportRow = reportRow(signItem, verifyItem);
 719                 report.append(reportRow);
 720                 boolean isFailedCase = isFailed(signItem, verifyItem);
 721                 if (isFailedCase) {
 722                     failedReport.append(reportRow);
 723                 }
 724                 failed = failed || isFailedCase;
 725             }
 726         }
 727 
 728         report.append(HtmlHelper.endTable());
 729         report.append(HtmlHelper.endHtml());
 730         generateFile(&quot;report.html&quot;, report.toString());
 731         if (failed) {
 732             failedReport.append(HtmlHelper.endTable());
 733             failedReport.append(HtmlHelper.endPre());
 734             failedReport.append(HtmlHelper.endHtml());
 735             generateFile(&quot;failedReport.html&quot;, failedReport.toString());
 736         }
 737 
 738         System.out.println(&quot;Report is generated.&quot;);
 739         return failed;
 740     }
 741 
 742     private static void generateFile(String path, String content)
 743             throws IOException {
 744         FileWriter writer = new FileWriter(new File(path));
 745         writer.write(content);
 746         writer.close();
 747     }
 748 
 749     private static String jarsignerPath(String jdkPath) {
 750         return jdkPath + &quot;/bin/jarsigner&quot;;
 751     }
 752 
 753     // Executes the specified function on JdkUtils by the specified JDK.
 754     private static String execJdkUtils(String jdkPath, String method,
 755             String... args) throws Throwable {
 756         String[] cmd = new String[args.length + 5];
 757         cmd[0] = jdkPath + &quot;/bin/java&quot;;
 758         cmd[1] = &quot;-cp&quot;;
 759         cmd[2] = TEST_CLASSES;
 760         cmd[3] = JdkUtils.class.getName();
 761         cmd[4] = method;
 762         System.arraycopy(args, 0, cmd, 5, args.length);
 763         return ProcessTools.executeCommand(cmd).getOutput();
 764     }
 765 
 766     // Executes the specified JDK tools, such as keytool and jarsigner, and
 767     // ensures the output is in US English.
 768     private static OutputAnalyzer execTool(String toolPath, String... args)
 769             throws Throwable {
<a name="107" id="anc107"></a><span class="line-modified"> 770         String[] cmd = new String[args.length + 4];</span>
<span class="line-modified"> 771         cmd[0] = toolPath;</span>
<span class="line-modified"> 772         cmd[1] = &quot;-J-Duser.language=en&quot;;</span>
<span class="line-modified"> 773         cmd[2] = &quot;-J-Duser.country=US&quot;;</span>
<span class="line-modified"> 774         cmd[3] = &quot;-J-Djava.security.egd=file:/dev/./urandom&quot;;</span>
<span class="line-modified"> 775         System.arraycopy(args, 0, cmd, 4, args.length);</span>
<span class="line-modified"> 776         return ProcessTools.executeCommand(cmd);</span>








 777     }
 778 
 779     private static class JdkInfo {
 780 
<a name="108" id="anc108"></a>
 781         private final String jdkPath;
 782         private final String jarsignerPath;
<a name="109" id="anc109"></a><span class="line-modified"> 783         private final String version;</span>


 784         private final boolean supportsTsadigestalg;
 785 
<a name="110" id="anc110"></a><span class="line-modified"> 786         private Map&lt;String, Boolean&gt; sigalgMap = new HashMap&lt;String, Boolean&gt;();</span>
 787 
 788         private JdkInfo(String jdkPath) throws Throwable {
 789             this.jdkPath = jdkPath;
<a name="111" id="anc111"></a><span class="line-modified"> 790             version = execJdkUtils(jdkPath, JdkUtils.M_JAVA_RUNTIME_VERSION);</span>
<span class="line-modified"> 791             if (version == null || version.trim().isEmpty()) {</span>

 792                 throw new RuntimeException(
 793                         &quot;Cannot determine the JDK version: &quot; + jdkPath);
 794             }
<a name="112" id="anc112"></a><span class="line-modified"> 795             jarsignerPath = jarsignerPath(jdkPath);</span>


 796             supportsTsadigestalg = execTool(jarsignerPath, &quot;-help&quot;)
 797                     .getOutput().contains(&quot;-tsadigestalg&quot;);
 798         }
 799 
 800         private boolean isSupportedSigalg(String sigalg) throws Throwable {
 801             if (!sigalgMap.containsKey(sigalg)) {
<a name="113" id="anc113"></a><span class="line-modified"> 802                 boolean isSupported = &quot;true&quot;.equalsIgnoreCase(</span>
 803                         execJdkUtils(
 804                                 jdkPath,
 805                                 JdkUtils.M_IS_SUPPORTED_SIGALG,
 806                                 sigalg));
 807                 sigalgMap.put(sigalg, isSupported);
 808             }
 809 
 810             return sigalgMap.get(sigalg);
 811         }
 812 
<a name="114" id="anc114"></a><span class="line-modified"> 813         private boolean isJdk6() {</span>
<span class="line-modified"> 814             return version.startsWith(&quot;1.6&quot;);</span>





 815         }
 816 
 817         @Override
 818         public int hashCode() {
 819             final int prime = 31;
 820             int result = 1;
 821             result = prime * result
<a name="115" id="anc115"></a><span class="line-modified"> 822                     + ((version == null) ? 0 : version.hashCode());</span>
 823             return result;
 824         }
 825 
 826         @Override
 827         public boolean equals(Object obj) {
 828             if (this == obj)
 829                 return true;
 830             if (obj == null)
 831                 return false;
 832             if (getClass() != obj.getClass())
 833                 return false;
 834             JdkInfo other = (JdkInfo) obj;
<a name="116" id="anc116"></a><span class="line-modified"> 835             if (version == null) {</span>
<span class="line-modified"> 836                 if (other.version != null)</span>
 837                     return false;
<a name="117" id="anc117"></a><span class="line-modified"> 838             } else if (!version.equals(other.version))</span>
 839                 return false;
 840             return true;
 841         }
<a name="118" id="anc118"></a>




 842     }
 843 
 844     private static class TsaInfo {
 845 
 846         private final int index;
 847         private final String tsaUrl;
<a name="119" id="anc119"></a><span class="line-modified"> 848         private Set&lt;String&gt; digestList = new HashSet&lt;String&gt;();</span>
 849 
 850         private TsaInfo(int index, String tsa) {
 851             this.index = index;
 852             this.tsaUrl = tsa;
 853         }
 854 
 855         private void addDigest(String digest) {
<a name="120" id="anc120"></a><span class="line-modified"> 856             if (!ignore(digest)) {</span>
<span class="line-removed"> 857                 digestList.add(digest);</span>
<span class="line-removed"> 858             }</span>
<span class="line-removed"> 859         }</span>
<span class="line-removed"> 860 </span>
<span class="line-removed"> 861         private static boolean ignore(String digest) {</span>
<span class="line-removed"> 862             return !SHA1.equalsIgnoreCase(digest)</span>
<span class="line-removed"> 863                     &amp;&amp; !SHA256.equalsIgnoreCase(digest)</span>
<span class="line-removed"> 864                     &amp;&amp; !SHA512.equalsIgnoreCase(digest);</span>
 865         }
 866 
 867         private boolean isDigestSupported(String digest) {
 868             return digest == null || digestList.isEmpty()
 869                     || digestList.contains(digest);
 870         }
<a name="121" id="anc121"></a>




 871     }
 872 
 873     private static class CertInfo {
 874 
<a name="122" id="anc122"></a><span class="line-modified"> 875         private final String jdkVersion;</span>




 876         private final String keyAlgorithm;
 877         private final String digestAlgorithm;
 878         private final int keySize;
 879         private final boolean expired;
 880 
<a name="123" id="anc123"></a><span class="line-modified"> 881         private CertInfo(String jdkVersion, String keyAlgorithm,</span>
 882                 String digestAlgorithm, int keySize, boolean expired) {
<a name="124" id="anc124"></a><span class="line-modified"> 883             this.jdkVersion = jdkVersion;</span>
 884             this.keyAlgorithm = keyAlgorithm;
 885             this.digestAlgorithm = digestAlgorithm;
 886             this.keySize = keySize;
 887             this.expired = expired;
 888         }
 889 
<a name="125" id="anc125"></a>






















 890         @Override
 891         public int hashCode() {
 892             final int prime = 31;
 893             int result = 1;
 894             result = prime * result
<a name="126" id="anc126"></a><span class="line-modified"> 895                     + ((digestAlgorithm == null) ? 0 : digestAlgorithm.hashCode());</span>
 896             result = prime * result + (expired ? 1231 : 1237);
 897             result = prime * result
<a name="127" id="anc127"></a><span class="line-modified"> 898                     + ((jdkVersion == null) ? 0 : jdkVersion.hashCode());</span>
 899             result = prime * result
<a name="128" id="anc128"></a><span class="line-modified"> 900                     + ((keyAlgorithm == null) ? 0 : keyAlgorithm.hashCode());</span>
 901             result = prime * result + keySize;
 902             return result;
 903         }
 904 
 905         @Override
 906         public boolean equals(Object obj) {
 907             if (this == obj)
 908                 return true;
 909             if (obj == null)
 910                 return false;
 911             if (getClass() != obj.getClass())
 912                 return false;
 913             CertInfo other = (CertInfo) obj;
 914             if (digestAlgorithm == null) {
 915                 if (other.digestAlgorithm != null)
 916                     return false;
 917             } else if (!digestAlgorithm.equals(other.digestAlgorithm))
 918                 return false;
 919             if (expired != other.expired)
 920                 return false;
<a name="129" id="anc129"></a><span class="line-modified"> 921             if (jdkVersion == null) {</span>
<span class="line-modified"> 922                 if (other.jdkVersion != null)</span>
 923                     return false;
<a name="130" id="anc130"></a><span class="line-modified"> 924             } else if (!jdkVersion.equals(other.jdkVersion))</span>
 925                 return false;
 926             if (keyAlgorithm == null) {
 927                 if (other.keyAlgorithm != null)
 928                     return false;
 929             } else if (!keyAlgorithm.equals(other.keyAlgorithm))
 930                 return false;
 931             if (keySize != other.keySize)
 932                 return false;
 933             return true;
 934         }
 935 
 936         private String alias() {
<a name="131" id="anc131"></a><span class="line-modified"> 937             return jdkVersion + &quot;_&quot; + toString();</span>



 938         }
 939 
 940         @Override
 941         public String toString() {
<a name="132" id="anc132"></a><span class="line-modified"> 942             return keyAlgorithm + &quot;_&quot; + digestAlgorithm</span>

 943                     + (keySize == 0 ? &quot;&quot; : &quot;_&quot; + keySize)
 944                     + (expired ? &quot;_Expired&quot; : &quot;&quot;);
 945         }
 946     }
 947 
 948     // It does only one timestamping for the same JDK, digest algorithm and
 949     // TSA service with an arbitrary valid/expired certificate.
 950     private static class TsaFilter {
 951 
<a name="133" id="anc133"></a><span class="line-modified"> 952         private static final Set&lt;Condition&gt; SET = new HashSet&lt;Condition&gt;();</span>
 953 
 954         private static boolean filter(String signerVersion,
 955                 String digestAlgorithm, boolean expiredCert, int tsaIndex) {
 956             return !SET.add(new Condition(signerVersion, digestAlgorithm,
 957                     expiredCert, tsaIndex));
 958         }
 959 
 960         private static class Condition {
 961 
 962             private final String signerVersion;
 963             private final String digestAlgorithm;
 964             private final boolean expiredCert;
 965             private final int tsaIndex;
 966 
 967             private Condition(String signerVersion, String digestAlgorithm,
 968                     boolean expiredCert, int tsaIndex) {
 969                 this.signerVersion = signerVersion;
 970                 this.digestAlgorithm = digestAlgorithm;
 971                 this.expiredCert = expiredCert;
 972                 this.tsaIndex = tsaIndex;
 973             }
 974 
 975             @Override
 976             public int hashCode() {
 977                 final int prime = 31;
 978                 int result = 1;
 979                 result = prime * result
 980                         + ((digestAlgorithm == null) ? 0 : digestAlgorithm.hashCode());
 981                 result = prime * result + (expiredCert ? 1231 : 1237);
 982                 result = prime * result
 983                         + ((signerVersion == null) ? 0 : signerVersion.hashCode());
 984                 result = prime * result + tsaIndex;
 985                 return result;
 986             }
 987 
 988             @Override
 989             public boolean equals(Object obj) {
 990                 if (this == obj)
 991                     return true;
 992                 if (obj == null)
 993                     return false;
 994                 if (getClass() != obj.getClass())
 995                     return false;
 996                 Condition other = (Condition) obj;
 997                 if (digestAlgorithm == null) {
 998                     if (other.digestAlgorithm != null)
 999                         return false;
1000                 } else if (!digestAlgorithm.equals(other.digestAlgorithm))
1001                     return false;
1002                 if (expiredCert != other.expiredCert)
1003                     return false;
1004                 if (signerVersion == null) {
1005                     if (other.signerVersion != null)
1006                         return false;
1007                 } else if (!signerVersion.equals(other.signerVersion))
1008                     return false;
1009                 if (tsaIndex != other.tsaIndex)
1010                     return false;
1011                 return true;
1012             }
1013         }}
1014 
1015     private static enum Status {
1016 
1017         // No action due to pre-action fails.
1018         NONE,
1019 
1020         // jar is signed/verified with error
1021         ERROR,
1022 
1023         // jar is signed/verified with warning
1024         WARNING,
1025 
1026         // jar is signed/verified without any warning and error
1027         NORMAL
1028     }
1029 
1030     private static class SignItem {
1031 
<a name="134" id="anc134"></a>
1032         private CertInfo certInfo;
<a name="135" id="anc135"></a><span class="line-modified">1033         private String version;</span>
<span class="line-modified">1034         private String signatureAlgorithm;</span>
<span class="line-removed">1035         // Signature algorithm that is extracted from verification output.</span>
<span class="line-removed">1036         private String extractedSignatureAlgorithm;</span>
1037         private String tsaDigestAlgorithm;
<a name="136" id="anc136"></a><span class="line-removed">1038         // TSA digest algorithm that is extracted from verification output.</span>
<span class="line-removed">1039         private String extractedTsaDigestAlgorithm;</span>
1040         private int tsaIndex;
1041         private Status status;
<a name="137" id="anc137"></a>
1042         private String signedJar;
<a name="138" id="anc138"></a>
1043 
<a name="139" id="anc139"></a><span class="line-modified">1044         private List&lt;VerifyItem&gt; verifyItems = new ArrayList&lt;VerifyItem&gt;();</span>
1045 
1046         private static SignItem build() {
<a name="140" id="anc140"></a><span class="line-modified">1047             return new SignItem();</span>











1048         }
1049 
1050         private SignItem certInfo(CertInfo certInfo) {
1051             this.certInfo = certInfo;
1052             return this;
1053         }
1054 
<a name="141" id="anc141"></a><span class="line-modified">1055         private SignItem version(String version) {</span>
<span class="line-modified">1056             this.version = version;</span>
1057             return this;
1058         }
1059 
<a name="142" id="anc142"></a><span class="line-modified">1060         private SignItem signatureAlgorithm(String signatureAlgorithm) {</span>
<span class="line-modified">1061             this.signatureAlgorithm = signatureAlgorithm;</span>
1062             return this;
1063         }
1064 
<a name="143" id="anc143"></a><span class="line-modified">1065         private SignItem extractedSignatureAlgorithm(</span>
<span class="line-modified">1066                 String extractedSignatureAlgorithm) {</span>
<span class="line-removed">1067             this.extractedSignatureAlgorithm = extractedSignatureAlgorithm;</span>
<span class="line-removed">1068             return this;</span>
1069         }
1070 
1071         private SignItem tsaDigestAlgorithm(String tsaDigestAlgorithm) {
1072             this.tsaDigestAlgorithm = tsaDigestAlgorithm;
1073             return this;
1074         }
1075 
<a name="144" id="anc144"></a><span class="line-modified">1076         private SignItem extractedTsaDigestAlgorithm(</span>
<span class="line-modified">1077                 String extractedTsaDigestAlgorithm) {</span>
<span class="line-removed">1078             this.extractedTsaDigestAlgorithm = extractedTsaDigestAlgorithm;</span>
<span class="line-removed">1079             return this;</span>
1080         }
1081 
1082         private SignItem tsaIndex(int tsaIndex) {
1083             this.tsaIndex = tsaIndex;
1084             return this;
1085         }
1086 
1087         private SignItem status(Status status) {
1088             this.status = status;
1089             return this;
1090         }
1091 
<a name="145" id="anc145"></a>




1092         private SignItem signedJar(String signedJar) {
1093             this.signedJar = signedJar;
1094             return this;
1095         }
1096 
<a name="146" id="anc146"></a>




1097         private void addVerifyItem(VerifyItem verifyItem) {
1098             verifyItems.add(verifyItem);
1099         }
<a name="147" id="anc147"></a>


















1100     }
1101 
1102     private static class VerifyItem {
1103 
<a name="148" id="anc148"></a>

1104         private JdkInfo jdkInfo;
1105         private Status status = Status.NONE;
1106         private Status delayStatus = Status.NONE;
1107 
1108         private static VerifyItem build(JdkInfo jdkInfo) {
1109             VerifyItem verifyItem = new VerifyItem();
1110             verifyItem.jdkInfo = jdkInfo;
1111             return verifyItem;
1112         }
1113 
<a name="149" id="anc149"></a>



















1114         private VerifyItem status(Status status) {
1115             this.status = status;
1116             return this;
1117         }
1118 
<a name="150" id="anc150"></a>








1119         private VerifyItem delayStatus(Status status) {
1120             this.delayStatus = status;
1121             return this;
1122         }
<a name="151" id="anc151"></a>









1123     }
1124 
1125     // The identifier for a specific signing.
1126     private static String signingId(SignItem signItem) {
1127         return signItem.signedJar;
1128     }
1129 
1130     // The identifier for a specific verifying.
1131     private static String verifyingId(SignItem signItem, VerifyItem verifyItem,
1132             boolean delayVerify) {
<a name="152" id="anc152"></a><span class="line-modified">1133         return &quot;S_&quot; + signingId(signItem) + &quot;-&quot; + (delayVerify ? &quot;DV&quot; : &quot;V&quot;)</span>
<span class="line-modified">1134                 + &quot;_&quot; + verifyItem.jdkInfo.version;</span>

1135     }
1136 
1137     private static String reportRow(SignItem signItem, VerifyItem verifyItem) {
<a name="153" id="anc153"></a><span class="line-modified">1138         List&lt;String&gt; values = new ArrayList&lt;String&gt;();</span>
<span class="line-modified">1139         values.add(signItem.certInfo.toString());</span>
<span class="line-modified">1140         values.add(signItem.version);</span>
<span class="line-modified">1141         values.add(null2Default(signItem.signatureAlgorithm,</span>
<span class="line-modified">1142                 signItem.extractedSignatureAlgorithm));</span>
<span class="line-modified">1143         values.add(signItem.tsaIndex == -1</span>
<span class="line-modified">1144                    ? &quot;&quot;</span>
<span class="line-modified">1145                    : null2Default(signItem.tsaDigestAlgorithm,</span>
<span class="line-modified">1146                         signItem.extractedTsaDigestAlgorithm));</span>
<span class="line-modified">1147         values.add(signItem.tsaIndex == -1 ? &quot;&quot; : signItem.tsaIndex + &quot;&quot;);</span>
<span class="line-modified">1148         values.add(HtmlHelper.anchorLink(</span>






1149                 PhaseOutputStream.fileName(PhaseOutputStream.Phase.SIGNING),
<a name="154" id="anc154"></a><span class="line-modified">1150                 signingId(signItem),</span>
<span class="line-modified">1151                 signItem.status.toString()));</span>
1152         values.add(verifyItem.jdkInfo.version);
<a name="155" id="anc155"></a><span class="line-modified">1153         values.add(HtmlHelper.anchorLink(</span>


1154                 PhaseOutputStream.fileName(PhaseOutputStream.Phase.VERIFYING),
<a name="156" id="anc156"></a><span class="line-modified">1155                 verifyingId(signItem, verifyItem, false),</span>
<span class="line-modified">1156                 verifyItem.status.toString()));</span>
1157         if (DELAY_VERIFY) {
<a name="157" id="anc157"></a><span class="line-modified">1158             values.add(HtmlHelper.anchorLink(</span>
1159                     PhaseOutputStream.fileName(
1160                             PhaseOutputStream.Phase.DELAY_VERIFYING),
1161                     verifyingId(signItem, verifyItem, true),
1162                     verifyItem.delayStatus.toString()));
1163         }
1164         values.add(isFailed(signItem, verifyItem) ? &quot;X&quot; : &quot;&quot;);
1165         return HtmlHelper.htmlRow(values.toArray(new String[values.size()]));
1166     }
1167 
<a name="158" id="anc158"></a><span class="line-modified">1168     private static boolean isFailed(SignItem signItem,</span>
<span class="line-modified">1169             VerifyItem verifyItem) {</span>
<span class="line-modified">1170         return signItem.status == Status.ERROR</span>
<span class="line-modified">1171                 || verifyItem.status == Status.ERROR</span>
<span class="line-modified">1172                 || verifyItem.delayStatus == Status.ERROR;</span>



































1173     }
1174 
1175     // If a value is null, then displays the default value or N/A.
1176     private static String null2Default(String value, String defaultValue) {
<a name="159" id="anc159"></a><span class="line-modified">1177         return value == null</span>
<span class="line-modified">1178                ? DEFAULT + &quot;(&quot; + (defaultValue == null</span>
1179                                   ? &quot;N/A&quot;
<a name="160" id="anc160"></a><span class="line-modified">1180                                   : defaultValue) + &quot;)&quot;</span>
<span class="line-removed">1181                : value;</span>
1182     }
<a name="161" id="anc161"></a>
1183 }
<a name="162" id="anc162"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="162" type="hidden" />
</body>
</html>