<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/jarsigner/multiRelease/MVJarSigningTest.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8047305 8075618
 27  * @summary Tests jarsigner tool and JarSigner API work with multi-release JAR files.
 28  * @library /test/lib
 29  * @build jdk.test.lib.compiler.CompilerUtils
 30  *        jdk.test.lib.Utils
 31  *        jdk.test.lib.Asserts
 32  *        jdk.test.lib.JDKToolFinder
 33  *        jdk.test.lib.JDKToolLauncher
 34  *        jdk.test.lib.Platform
 35  *        jdk.test.lib.process.*
 36  * @run main MVJarSigningTest
 37  */
 38 
 39 import jdk.security.jarsigner.JarSigner;
 40 
 41 import java.io.BufferedReader;
 42 import java.io.File;
 43 import java.io.FileInputStream;
 44 import java.io.FileOutputStream;
 45 import java.io.IOException;
 46 import java.io.InputStreamReader;
 47 import java.nio.file.Files;
 48 import java.nio.file.Path;
 49 import java.nio.file.Paths;
 50 import java.security.KeyStore;
 51 import java.security.PrivateKey;
 52 import java.security.cert.Certificate;
 53 import java.security.cert.CertificateFactory;
 54 import java.util.ArrayList;
 55 import java.util.Arrays;
 56 import java.util.Collections;
 57 import java.util.List;
 58 import java.util.concurrent.TimeUnit;
 59 import java.util.jar.JarFile;
 60 import java.util.stream.Stream;
 61 import java.util.zip.ZipEntry;
 62 import java.util.zip.ZipFile;
 63 import java.util.zip.ZipOutputStream;
 64 
 65 import jdk.test.lib.JDKToolFinder;
 66 import jdk.test.lib.JDKToolLauncher;
 67 import jdk.test.lib.Utils;
 68 import jdk.test.lib.compiler.CompilerUtils;
 69 import jdk.test.lib.process.OutputAnalyzer;
 70 import jdk.test.lib.process.ProcessTools;
 71 
 72 
 73 public class MVJarSigningTest {
 74 
 75     private static final String TEST_SRC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 76     private static final String USR_DIR = System.getProperty(&quot;user.dir&quot;, &quot;.&quot;);
 77     private static final String JAR_NAME = &quot;MV.jar&quot;;
 78     private static final String KEYSTORE = &quot;keystore.jks&quot;;
 79     private static final String ALIAS = &quot;JavaTest&quot;;
 80     private static final String STOREPASS = &quot;changeit&quot;;
 81     private static final String KEYPASS = &quot;changeit&quot;;
 82     private static final String SIGNED_JAR = &quot;Signed.jar&quot;;
 83     private static final String POLICY_FILE = &quot;SignedJar.policy&quot;;
 84     private static final String VERSION = Integer.toString(10);
 85     private static final String VERSION_MESSAGE = &quot;I am running on version &quot; + VERSION;
 86 
 87     public static void main(String[] args) throws Throwable {
 88         // compile java files in jarContent directory
 89         compile(&quot;jarContent&quot;);
 90 
 91         // create multi-release jar
 92         Path classes = Paths.get(&quot;classes&quot;);
 93         jar(&quot;cf&quot;, JAR_NAME, &quot;-C&quot;, classes.resolve(&quot;base&quot;).toString(), &quot;.&quot;,
 94                 &quot;--release&quot;, &quot;9&quot;, &quot;-C&quot;, classes.resolve(&quot;v9&quot;).toString(), &quot;.&quot;,
 95                 &quot;--release&quot;, &quot;10&quot;, &quot;-C&quot;, classes.resolve(&quot;v10&quot;).toString(), &quot;.&quot;)
 96             .shouldHaveExitValue(0);
 97 
 98         genKey();
 99         signJar(JAR_NAME)
100             .shouldHaveExitValue(0)
101             .shouldMatch(&quot;signing.*META-INF/versions/9/version/Version.class&quot;)
102             .shouldMatch(&quot;signing.*META-INF/versions/10/version/Version.class&quot;)
103             .shouldMatch(&quot;signing.*version/Main.class&quot;)
104             .shouldMatch(&quot;signing.*version/Version.class&quot;);
105         verify(SIGNED_JAR);
106 
107         // test with JarSigner API
108         Files.deleteIfExists(Paths.get(SIGNED_JAR));
109         signWithJarSignerAPI(JAR_NAME);
110         verify(SIGNED_JAR);
111 
112         // test Permission granted
113         File keypass = new File(&quot;keypass&quot;);
114         try (FileOutputStream fos = new FileOutputStream(keypass)) {
115             fos.write(KEYPASS.getBytes());
116         }
117         String[] cmd = {
118                 &quot;-classpath&quot;, SIGNED_JAR,
119                 &quot;-Djava.security.manager&quot;,
120                 &quot;-Djava.security.policy=&quot; +
121                 TEST_SRC + File.separator + POLICY_FILE,
122                 &quot;version.Main&quot;};
123         ProcessTools.executeTestJvm(cmd)
124             .shouldHaveExitValue(0)
125             .shouldContain(VERSION_MESSAGE);
126     }
127 
128     private static void compile (String jarContent_path) throws Throwable {
129         Path classes = Paths.get(USR_DIR, &quot;classes&quot;, &quot;base&quot;);
130         Path source = Paths.get(TEST_SRC, jarContent_path, &quot;base&quot;, &quot;version&quot;);
131         CompilerUtils.compile(source, classes);
132 
133         classes = Paths.get(USR_DIR, &quot;classes&quot;, &quot;v9&quot;);
134         source = Paths.get(TEST_SRC, jarContent_path , &quot;v9&quot;, &quot;version&quot;);
135         CompilerUtils.compile(source, classes);
136 
137         classes = Paths.get(USR_DIR, &quot;classes&quot;, &quot;v10&quot;);
138         source = Paths.get(TEST_SRC, jarContent_path, &quot;v10&quot;, &quot;version&quot;);
139         CompilerUtils.compile(source, classes);
140     }
141 
142     private static OutputAnalyzer jar(String...args) throws Throwable {
143         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(&quot;jar&quot;);
144         Stream.of(args).forEach(launcher::addToolArg);
145         return ProcessTools.executeCommand(launcher.getCommand());
146     }
147 
148     private static void genKey() throws Throwable {
149         String keytool = JDKToolFinder.getJDKTool(&quot;keytool&quot;);
150         Files.deleteIfExists(Paths.get(KEYSTORE));
151         ProcessTools.executeCommand(keytool,
152                 &quot;-J-Duser.language=en&quot;,
153                 &quot;-J-Duser.country=US&quot;,
154                 &quot;-genkey&quot;,
<a name="2" id="anc2"></a><span class="line-added">155                 &quot;-keyalg&quot;, &quot;dsa&quot;,</span>
156                 &quot;-alias&quot;, ALIAS,
157                 &quot;-keystore&quot;, KEYSTORE,
158                 &quot;-keypass&quot;, KEYPASS,
159                 &quot;-dname&quot;, &quot;cn=sample&quot;,
160                 &quot;-storepass&quot;, STOREPASS
161         ).shouldHaveExitValue(0);
162     }
163 
164     private static OutputAnalyzer signJar(String jarName) throws Throwable {
165         List&lt;String&gt; args = new ArrayList&lt;&gt;();
166         args.add(&quot;-verbose&quot;);
167         args.add(&quot;-signedjar&quot;);
168         args.add(SIGNED_JAR);
169         args.add(jarName);
170         args.add(ALIAS);
171 
172         return jarsigner(args);
173     }
174 
175     private static void verify(String signedJarName) throws Throwable {
176         verifyJar(signedJarName)
177             .shouldHaveExitValue(0)
178             .shouldContain(&quot;jar verified&quot;)
179             .shouldMatch(&quot;smk.*META-INF/versions/9/version/Version.class&quot;)
180             .shouldMatch(&quot;smk.*META-INF/versions/10/version/Version.class&quot;)
181             .shouldMatch(&quot;smk.*version/Main.class&quot;)
182             .shouldMatch(&quot;smk.*version/Version.class&quot;);
183     }
184 
185     private static OutputAnalyzer verifyJar(String signedJarName) throws Throwable {
186         List&lt;String&gt; args = new ArrayList&lt;&gt;();
187         args.add(&quot;-verbose&quot;);
188         args.add(&quot;-verify&quot;);
189         args.add(signedJarName);
190 
191         return jarsigner(args);
192     }
193 
194     private static OutputAnalyzer jarsigner(List&lt;String&gt; extra)
195             throws Throwable {
196         JDKToolLauncher launcher = JDKToolLauncher.createUsingTestJDK(&quot;jarsigner&quot;)
197                 .addVMArg(&quot;-Duser.language=en&quot;)
198                 .addVMArg(&quot;-Duser.country=US&quot;)
199                 .addToolArg(&quot;-keystore&quot;)
200                 .addToolArg(KEYSTORE)
201                 .addToolArg(&quot;-storepass&quot;)
202                 .addToolArg(STOREPASS)
203                 .addToolArg(&quot;-keypass&quot;)
204                 .addToolArg(KEYPASS);
205         for (String s : extra) {
206             if (s.startsWith(&quot;-J&quot;)) {
207                 launcher.addVMArg(s.substring(2));
208             } else {
209                 launcher.addToolArg(s);
210             }
211         }
212         return ProcessTools.executeCommand(launcher.getCommand());
213     }
214 
215     private static void signWithJarSignerAPI(String jarName)
216             throws Throwable {
217         // Get JarSigner
218         try (FileInputStream fis = new FileInputStream(KEYSTORE)) {
219                 KeyStore ks = KeyStore.getInstance(&quot;JKS&quot;);
220                 ks.load(fis, STOREPASS.toCharArray());
221                 PrivateKey pk = (PrivateKey)ks.getKey(ALIAS, KEYPASS.toCharArray());
222                 Certificate cert = ks.getCertificate(ALIAS);
223                 JarSigner signer = new JarSigner.Builder(pk,
224                         CertificateFactory.getInstance(&quot;X.509&quot;).generateCertPath(
225                                 Collections.singletonList(cert)))
226                         .build();
227             // Sign jar
228             try (ZipFile src = new JarFile(jarName);
229                     FileOutputStream out = new FileOutputStream(SIGNED_JAR)) {
230                 signer.sign(src,out);
231             }
232         }
233     }
234 
235 }
236 
237 
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>