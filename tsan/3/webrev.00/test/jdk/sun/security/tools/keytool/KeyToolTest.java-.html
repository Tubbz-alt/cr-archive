<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/security/tools/keytool/KeyToolTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
  26  * @author weijun.wang
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
  47  *       ...
  48  * Caused by: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  49  *       at sun.security.pkcs11.wrapper.PKCS11.C_SignFinal(Native Method)
  50  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:391)
  51  *       ...
  52  * been observed. Possibly a Solaris bug
  53  *
  54  * ATTENTION:
  55  * NSS PKCS11 config file are changed, DSA not supported now.
  56  *
  57  * @library /test/lib
  58  * @modules java.base/sun.security.tools.keytool
  59  *          java.base/sun.security.util
  60  *          java.base/sun.security.x509
  61  * @run main/othervm/timeout=600 -Dfile KeyToolTest
  62  */
  63 
  64 import java.nio.file.Files;
  65 import java.nio.file.Paths;
  66 import java.security.KeyStore;
  67 import sun.security.x509.*;
  68 import java.io.*;
  69 import java.security.KeyPairGenerator;
  70 import java.security.NoSuchAlgorithmException;
  71 import java.util.*;
  72 import java.security.cert.X509Certificate;
  73 import jdk.test.lib.util.FileUtils;
  74 import sun.security.util.ObjectIdentifier;
  75 
  76 
  77 public class KeyToolTest {
  78 
  79     // The stdout and stderr outputs after a keytool run
  80     String out;
  81     String err;
  82 
  83     // the output of println() in KeyTool.run
  84     String ex;
  85 
  86     String lastInput = &quot;&quot;, lastCommand = &quot;&quot;;
  87     private static final boolean debug =
  88         System.getProperty(&quot;debug&quot;) != null;
  89 
  90     static final String NSS_P11_ARG =
  91             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nss &quot; +
  92             &quot;-addprovider SunPKCS11 &quot; +
  93             &quot;-providerArg p11-nss.txt &quot;;
  94     // Use -providerClass here, to confirm it still works for SunPKCS11.
  95     static final String NSS_SRC_P11_ARG =
  96             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
  97             &quot;-srcproviderName SunPKCS11-nss &quot; +
  98             &quot;-providerClass sun.security.pkcs11.SunPKCS11 &quot; +
  99             &quot;-providerArg p11-nss.txt &quot;;
 100     static final String NZZ_P11_ARG =
 101             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nzz &quot; +
 102             &quot;-addprovider SunPKCS11 &quot; +
 103             &quot;-providerArg p11-nzz.txt &quot;;
 104     static final String NZZ_SRC_P11_ARG =
 105             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
 106             &quot;-srcproviderName SunPKCS11-nzz &quot; +
 107             &quot;-addprovider SunPKCS11 &quot; +
 108             &quot;-providerArg p11-nzz.txt &quot;;
 109     static final String SUN_P11_ARG = &quot;-keystore NONE -storetype PKCS11 &quot;;
 110     static final String SUN_SRC_P11_ARG =
 111             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot;;
 112 
 113     String p11Arg, srcP11Arg;
 114 
 115     /** Creates a new instance of KeyToolTest */
 116     KeyToolTest() {
 117         // so that there is &quot;Warning&quot; and not translated into other language
 118         Locale.setDefault(Locale.US);
 119     }
 120 
 121     /**
 122      * Helper, removes a file
 123      */
 124     void remove(String filename) {
 125         if (debug) {
 126             System.err.println(&quot;Removing &quot; + filename);
 127         }
 128         try{
 129             FileUtils.deleteFileIfExistsWithRetry(Paths.get(filename));
 130         }catch(IOException e) {
 131             throw new RuntimeException(&quot;Error deleting &quot; + filename, e);
 132         }
 133     }
 134 
 135     /**
 136      * Run a set of keytool command with given terminal input.
 137      * @param input the terminal inputs, the characters typed by human
 138      *        if &lt;code&gt;cmd&lt;/code&gt; is running on a terminal
 139      * @param cmd the argument of a keytool command line
 140      * @throws if keytool goes wrong in some place
 141      */
 142     void test(String input, String cmd) throws Exception {
 143         lastInput = input;
 144         lastCommand = cmd;
 145 
 146         // &quot;X&quot; is appended so that we can precisely test how input is consumed
 147         HumanInputStream in = new HumanInputStream(input+&quot;X&quot;);
 148         test(in, cmd);
 149         // make sure the input string is no more no less
 150         if(in.read() != &#39;X&#39; || in.read() != -1)
 151             throw new Exception(&quot;Input not consumed exactly&quot;);
 152     }
 153 
 154     void test(InputStream in, String cmd) throws Exception {
 155 
 156         // save the original 3 streams
 157         if (debug) {
 158             System.err.println(cmd);
 159         } else {
 160             System.err.print(&quot;.&quot;);
 161         }
 162         PrintStream p1 = System.out;
 163         PrintStream p2 = System.err;
 164         InputStream i1 = System.in;
 165 
 166         ByteArrayOutputStream b1 = new ByteArrayOutputStream();
 167         ByteArrayOutputStream b2 = new ByteArrayOutputStream();
 168 
 169         try {
 170             System.setIn(in);
 171             System.setOut(new PrintStream(b1));
 172             System.setErr(new PrintStream(b2));
 173 
 174             // since System.in is overrided, the
 175             // sun.security.tools.keytool.Main.main() method will
 176             // never block at user input
 177 
 178             // use -debug so that main() will throw an Exception
 179             // instead of calling System.exit()
 180             sun.security.tools.keytool.Main.main((&quot;-debug &quot;+cmd).split(&quot;\\s+&quot;));
 181         } finally {
 182             out = b1.toString();
 183             err = b2.toString();
 184             ex = out;   // now it goes to System.out
 185             System.setIn(i1);
 186             System.setOut(p1);
 187             System.setErr(p2);
 188         }
 189     }
 190 
 191     /**
 192      * Call this method if you expect test(input, cmd) should go OK
 193      */
 194     void testOK(String input, String cmd) throws Exception {
 195         try {
 196             // Workaround for &quot;8057810: Make SHA256withDSA the default
 197             // jarsigner and keytool algorithm for DSA keys&quot;. Unfortunately
 198             // SunPKCS11-NSS does not support SHA256withDSA yet.
 199             if (cmd.contains(&quot;p11-nss.txt&quot;) &amp;&amp; cmd.contains(&quot;-genkey&quot;)
 200                     &amp;&amp; !cmd.contains(&quot;-keyalg&quot;)) {
 201                 cmd += &quot; -sigalg SHA1withDSA -keysize 1024&quot;;
 202             }
 203             test(input, cmd);
 204         } catch(Exception e) {
 205             afterFail(input, cmd, &quot;OK&quot;);
 206             throw e;
 207         }
 208     }
 209 
 210     /**
 211      * Call this method if you expect test(input, cmd) should fail and throw
 212      * an exception
 213      */
 214     void testFail(String input, String cmd) throws Exception {
 215         boolean ok;
 216         try {
 217             test(input, cmd);
 218             ok = true;
 219         } catch(Exception e) {
 220             if (e instanceof MissingResourceException) {
 221                 ok = true;
 222             } else {
 223                 ok = false;
 224             }
 225         }
 226         if(ok) {
 227             afterFail(input, cmd, &quot;FAIL&quot;);
 228             throw new RuntimeException();
 229         }
 230     }
 231 
 232     /**
 233      * Call this method if you expect test(input, cmd) should go OK
 234      */
 235     void testOK(InputStream is, String cmd) throws Exception {
 236         try {
 237             test(is, cmd);
 238         } catch(Exception e) {
 239             afterFail(&quot;&quot;, cmd, &quot;OK&quot;);
 240             throw e;
 241         }
 242     }
 243 
 244     /**
 245      * Call this method if you expect test(input, cmd) should fail and throw
 246      * an exception
 247      */
 248     void testFail(InputStream is, String cmd) throws Exception {
 249         boolean ok;
 250         try {
 251             test(is, cmd);
 252             ok = true;
 253         } catch(Exception e) {
 254             ok = false;
 255         }
 256         if(ok) {
 257             afterFail(&quot;&quot;, cmd, &quot;FAIL&quot;);
 258             throw new RuntimeException();
 259         }
 260     }
 261 
 262     /**
 263      * Call this method if you just want to run the command and does
 264      * not care if it succeeds or fails.
 265      */
 266     void testAnyway(String input, String cmd) {
 267         try {
 268             test(input, cmd);
 269         } catch(Exception e) {
 270             ;
 271         }
 272     }
 273 
 274     /**
 275      * Helper method, print some output after a test does not do as expected
 276      */
 277     void afterFail(String input, String cmd, String should) {
 278         if (cmd.contains(&quot;p11-nss.txt&quot;)) {
 279             cmd = &quot;-J-Dnss.lib=&quot; + System.getProperty(&quot;nss.lib&quot;) + &quot; &quot; + cmd;
 280         }
 281         System.err.println(&quot;\nTest fails for the command ---\n&quot; +
 282                 &quot;keytool &quot; + cmd + &quot;\nOr its debug version ---\n&quot; +
 283                 &quot;keytool -debug &quot; + cmd);
 284 
 285         System.err.println(&quot;The command result should be &quot; + should +
 286                 &quot;, but it&#39;s not. Try run the command manually and type&quot; +
 287                 &quot; these input into it: &quot;);
 288         char[] inputChars = input.toCharArray();
 289 
 290         for (int i=0; i&lt;inputChars.length; i++) {
 291             char ch = inputChars[i];
 292             if (ch == &#39;\n&#39;) System.err.print(&quot;ENTER &quot;);
 293             else if (ch == &#39; &#39;) System.err.print(&quot;SPACE &quot;);
 294             else System.err.print(ch + &quot; &quot;);
 295         }
 296         System.err.println(&quot;&quot;);
 297 
 298         System.err.println(&quot;ERR is:\n&quot;+err);
 299         System.err.println(&quot;OUT is:\n&quot;+out);
 300     }
 301 
 302     void assertTrue(boolean bool, String msg) {
 303         if (debug) {
 304             System.err.println(&quot;If not &quot; + bool + &quot;, &quot; + msg);
 305         } else {
 306             System.err.print(&quot;v&quot;);
 307         }
 308         if(!bool) {
 309             afterFail(lastInput, lastCommand, &quot;TRUE&quot;);
 310                 System.err.println(msg);
 311             throw new RuntimeException(msg);
 312         }
 313     }
 314 
 315     void assertTrue(boolean bool) {
 316         assertTrue(bool, &quot;well...&quot;);
 317     }
 318     /**
 319      * Helper method, load a keystore
 320      * @param file file for keystore, null or &quot;NONE&quot; for PKCS11
 321      * @pass password for the keystore
 322      * @type keystore type
 323      * @returns the KeyStore object
 324      * @exception Exception if anything goes wrong
 325      */
 326     KeyStore loadStore(String file, String pass, String type) throws Exception {
 327         KeyStore ks = KeyStore.getInstance(type);
 328         FileInputStream is = null;
 329         if (file != null &amp;&amp; !file.equals(&quot;NONE&quot;)) {
 330             is = new FileInputStream(file);
 331         }
 332         ks.load(is, pass.toCharArray());
 333         is.close();
 334         return ks;
 335     }
 336 
 337     /**
 338      * The test suite.
 339      * Maybe it&#39;s better to put this outside the KeyToolTest class
 340      */
 341     void testAll() throws Exception {
 342         KeyStore ks;
 343 
 344         remove(&quot;x.jks&quot;);
 345         remove(&quot;x.jceks&quot;);
 346         remove(&quot;x.p12&quot;);
 347         remove(&quot;x2.jceks&quot;);
 348         remove(&quot;x2.jks&quot;);
 349         remove(&quot;x.jks.p1.cert&quot;);
 350 
 351         // name changes: genkeypair, importcert, exportcert
 352         remove(&quot;x.jks&quot;);
 353         remove(&quot;x.jks.p1.cert&quot;);
 354         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 355                 &quot;-keypass changeit -genkeypair -alias p1 -dname CN=olala&quot;);
 356         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 357                 &quot;-exportcert -alias p1 -file x.jks.p1.cert&quot;);
 358         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 359         assertTrue(ks.getKey(&quot;p1&quot;, &quot;changeit&quot;.toCharArray()) != null,
 360             &quot;key not DSA&quot;);
 361         assertTrue(new File(&quot;x.jks.p1.cert&quot;).exists(), &quot;p1 export err&quot;);
 362         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 363                 &quot;-delete -alias p1&quot;);
 364         // importcert, prompt for Yes/No
 365         testOK(&quot;y\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 366                 &quot;-importcert -alias c1 -file x.jks.p1.cert&quot;);
 367         // importcert, -noprompt
 368         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 369                 &quot;-importcert -alias c2 -file x.jks.p1.cert -noprompt&quot;);
 370         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 371         assertTrue(ks.getCertificate(&quot;c1&quot;) != null, &quot;import c1 err&quot;);
 372 
 373         // v3
 374         byte[] encoded = ks.getCertificate(&quot;c1&quot;).getEncoded();
 375         X509CertImpl certImpl = new X509CertImpl(encoded);
 376         assertTrue(certImpl.getVersion() == 3, &quot;Version is not 3&quot;);
 377 
 378         // changealias and keyclone
 379         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 380                 &quot;-keypass changeit -genkeypair -alias p1 -dname CN=olala&quot;);
 381         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 382                 &quot;-changealias -alias p1 -destalias p11&quot;);
 383         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 384                 &quot;-changealias -alias c1 -destalias c11&quot;);
 385         // press ENTER when prompt for p111&#39;s keypass
 386         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 387                 &quot;-keyclone -alias p11 -destalias p111&quot;);
 388         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 389         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;there is no p1&quot;);
 390         assertTrue(!ks.containsAlias(&quot;c1&quot;), &quot;there is no c1&quot;);
 391         assertTrue(ks.containsAlias(&quot;p11&quot;), &quot;there is p11&quot;);
 392         assertTrue(ks.containsAlias(&quot;c11&quot;), &quot;there is c11&quot;);
 393         assertTrue(ks.containsAlias(&quot;p111&quot;), &quot;there is p111&quot;);
 394 
 395         // genSecKey
 396         remove(&quot;x.jceks&quot;);
 397         // DES, no need keysize
 398         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 399                 &quot;-genseckey -alias s1&quot;);
 400         // DES, keysize cannot be 128
 401         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 402                 &quot;-genseckey -alias s11 -keysize 128&quot;);
 403         // DESede. no need keysize
 404         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 405                 &quot;-genseckey -keyalg DESede -alias s2&quot;);
 406         // AES, need keysize
 407         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype AES &quot; +
 408                 &quot;-genseckey -keyalg Rijndael -alias s3&quot;);
 409         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 410                 &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 411         // about keypass
 412         // can accept storepass
 413         testOK(&quot;\n&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 414                 &quot;-genseckey -alias s4&quot;);
 415         // or a new one
 416         testOK(&quot;keypass\nkeypass\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 417                 &quot;-storepass changeit -genseckey -alias s5&quot;);
 418         // keypass must be valid (prompt 3 times)
 419         testOK(&quot;bad\n\bad\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 420                 &quot;-storetype JCEKS -storepass changeit -genseckey -alias s6&quot;);
 421         // keypass must be valid (prompt 3 times)
 422         testFail(&quot;bad\n\bad\nbad\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 423                 &quot;-storepass changeit -genseckey -alias s7&quot;);
 424         // keypass must be valid (prompt 3 times)
 425         testFail(&quot;bad\n\bad\nbad\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 426                 &quot;-storetype JCEKS -storepass changeit -genseckey -alias s7&quot;);
 427         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 428         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 429                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s1 is DES&quot;);
 430         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 431                 .getEncoded().length == 8,  &quot;DES is 56&quot;);
 432         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 433                 .getEncoded().length == 24,  &quot;DESede is 168&quot;);
 434         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 435                 .getAlgorithm().equalsIgnoreCase(&quot;DESede&quot;), &quot;s2 is DESede&quot;);
 436         assertTrue(ks.getKey(&quot;s3&quot;, &quot;changeit&quot;.toCharArray())
 437                 .getAlgorithm().equalsIgnoreCase(&quot;AES&quot;), &quot;s3 is AES&quot;);
 438         assertTrue(ks.getKey(&quot;s4&quot;, &quot;changeit&quot;.toCharArray())
 439                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s4 is DES&quot;);
 440         assertTrue(ks.getKey(&quot;s5&quot;, &quot;keypass&quot;.toCharArray())
 441                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s5 is DES&quot;);
 442         assertTrue(ks.getKey(&quot;s6&quot;, &quot;keypass&quot;.toCharArray())
 443                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s6 is DES&quot;);
 444         assertTrue(!ks.containsAlias(&quot;s7&quot;), &quot;s7 not created&quot;);
 445 
 446         // maybe we needn&#39;t test this, one day JKS will support SecretKey
 447         //testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 448         //        &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 449 
 450         // importKeyStore
 451         remove(&quot;x.jks&quot;);
 452         remove(&quot;x.jceks&quot;);
 453         // create 2 entries...
 454         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 455                 &quot;-genkeypair -alias p1 -dname CN=Olala&quot;);
 456         testOK(&quot;&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 457                 &quot;-importcert -alias c1 -file x.jks.p1.cert -noprompt&quot;);
 458         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 459         assertTrue(ks.size() == 2, &quot;2 entries in JCEKS&quot;);
 460         // import, shouldn&#39;t mention destalias/srckeypass/destkeypass
 461         // if srcalias is no given
 462         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 463                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 464                 &quot;-destkeystore x.jks -deststoretype JKS -destalias pp&quot;);
 465         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 466                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 467                 &quot;-destkeystore x.jks -deststoretype JKS -srckeypass changeit&quot;);
 468         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 469                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 470                 &quot;-destkeystore x.jks -deststoretype JKS -destkeypass changeit&quot;);
 471         // normal import
 472         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 473                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 474                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 475         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 476         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 477         // import again, type yes to overwrite old entries
 478         testOK(&quot;changeit\nchangeit\ny\ny\n&quot;, &quot;-importkeystore &quot; +
 479                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 480                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 481         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 482         // import again, specify -nopromt
 483         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 484                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 485                 &quot;-destkeystore x.jks -deststoretype JKS -noprompt&quot;);
 486         assertTrue(err.indexOf(&quot;Warning&quot;) != -1, &quot;noprompt will warn&quot;);
 487         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 488         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 489         // import again, type into new aliases when prompted
 490         testOK(&quot;changeit\nchangeit\n\ns1\n\ns2\n&quot;, &quot;-importkeystore &quot; +
 491                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 492                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 493         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 494         assertTrue(ks.size() == 4, &quot;4 entries in JKS&quot;);
 495 
 496         // importkeystore single
 497         // normal
 498         remove(&quot;x.jks&quot;);
 499         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 500                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 501                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 502         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 503         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 504         // overwrite
 505         testOK(&quot;changeit\nchangeit\ny\n&quot;, &quot;-importkeystore &quot; +
 506                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 507                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 508         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 509         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 510         // noprompt
 511         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 512                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 513                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 514                 &quot;-srcalias p1 -noprompt&quot;);
 515         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 516         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 517         // rename
 518         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 519                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 520                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 521                 &quot;-srcalias p1 -destalias p2&quot;);
 522         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 523         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 524         // another rename
 525         testOK(&quot;changeit\nchangeit\n\nnewalias\n&quot;, &quot;-importkeystore &quot; +
 526                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 527                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 528         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 529         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 530 
 531         // importkeystore single, different keypass
 532         remove(&quot;x.jks&quot;);
 533         // generate entry with different keypass
 534         testOK(&quot;changeit\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 535                 &quot;-storetype JCEKS -genkeypair -alias p2 -dname CN=Olala&quot;);
 536         // prompt
 537         testOK(&quot;changeit\nchangeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 538                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 539                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p2&quot;);
 540         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 541         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 542         // diff destkeypass
 543         testOK(&quot;changeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 544                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 545                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 546                 &quot;-srcalias p2 -destalias p3 -destkeypass keypass2&quot;);
 547         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 548         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 549         assertTrue(ks.getKey(&quot;p2&quot;, &quot;keypass&quot;.toCharArray()) != null,
 550                 &quot;p2 has old password&quot;);
 551         assertTrue(ks.getKey(&quot;p3&quot;, &quot;keypass2&quot;.toCharArray()) != null,
 552                 &quot;p3 has new password&quot;);
 553 
 554         // importkeystore single, cert
 555         remove(&quot;x.jks&quot;);
 556         // normal
 557         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 558                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 559                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias c1&quot;);
 560         // in fact srcstorepass can be ignored
 561         testOK(&quot;changeit\n\n&quot;, &quot;-importkeystore &quot; +
 562                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 563                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 564                 &quot;-srcalias c1 -destalias c2&quot;);
 565         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;But will warn&quot;);
 566         // 2nd import, press y to overwrite ...
 567         testOK(&quot;changeit\n\ny\n&quot;, &quot;-importkeystore &quot; +
 568                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 569                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 570                 &quot;-srcalias c1 -destalias c2&quot;);
 571         // ... or rename
 572         testOK(&quot;changeit\n\n\nc3\n&quot;, &quot;-importkeystore &quot; +
 573                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 574                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 575                 &quot;-srcalias c1 -destalias c2&quot;);
 576         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 577         // c1, c2, c3
 578         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 579 
 580         // importkeystore, secretkey
 581         remove(&quot;x.jks&quot;);
 582         // create SecretKeyEntry
 583         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 584                 &quot;-genseckey -alias s1&quot;);
 585         // create SecretKeyEntry
 586         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 587                 &quot;-genseckey -alias s2&quot;);
 588         // remove the keypass!=storepass one
 589         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 590                 &quot;-delete -alias p2&quot;);
 591         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 592         // p1, c1, s1, s2
 593         assertTrue(ks.size() == 4, &quot;4 entries in JCEKS&quot;);
 594         // normal
 595         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 596                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 597                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias s1&quot;);
 598         assertTrue(err.indexOf(&quot;not imported&quot;) != -1, &quot;Not imported&quot;);
 599         assertTrue(err.indexOf(&quot;Cannot store non-PrivateKeys&quot;) != -1,
 600                 &quot;Not imported&quot;);
 601 
 602         // Importing a JCEKS keystore to a JKS one. Will warn
 603         // for the 2 SecretKey entries
 604 
 605         remove(&quot;x.jks&quot;);
 606         // Two &quot;no&quot; answers to bypass warnings
 607         // normal
 608         testOK(&quot;\n\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 609                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 610                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 611         assertTrue(err.indexOf(&quot;s1 not&quot;) != -1, &quot;s1 not&quot;);
 612         assertTrue(err.indexOf(&quot;s2 not&quot;) != -1, &quot;s2 not&quot;);
 613         assertTrue(err.indexOf(&quot;c1 success&quot;) != -1, &quot;c1 success&quot;);
 614         assertTrue(err.indexOf(&quot;p1 success&quot;) != -1, &quot;p1 success&quot;);
 615         remove(&quot;x.jks&quot;);
 616         // One &quot;yes&quot; to stop
 617         // normal
 618         testOK(&quot;yes\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 619                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 620                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 621         // maybe c1 or p1 has been imported before s1 or s2 is touched,
 622         // anyway we know yesNo is only asked once.
 623 
 624         // pkcs12
 625         remove(&quot;x.jks&quot;);
 626         // JKS prompt for keypass
 627         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 628                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 629         remove(&quot;x.jks&quot;);
 630         // just type ENTER means keypass=storepass
 631         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 632                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 633         remove(&quot;x.p12&quot;);
 634         // PKCS12 only need storepass
 635         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 636                 &quot;-genkeypair -alias p0 -dname CN=olala&quot;);
 637         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -storetype PKCS12 &quot; +
 638                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 639         // when specify keypass, make sure keypass==storepass...
 640         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass changeit &quot; +
 641                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 642         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 643                 &quot;PKCS12 silent when keypass == storepass&quot;);
 644         // otherwise, print a warning
 645         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass another&quot; +
 646                 &quot; -storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 647         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 648                 &quot;PKCS12 warning when keypass != storepass&quot;);
 649         // no -keypasswd for PKCS12
 650         testFail(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12&quot; +
 651                 &quot; -keypasswd -new changeit -alias p3&quot;);
 652         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 653                 &quot;-changealias -alias p3 -destalias p33&quot;);
 654         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 655                 &quot;-keyclone -alias p33 -destalias p3&quot;);
 656 
 657         // pkcs12
 658         remove(&quot;x.p12&quot;);
 659         // PKCS12 only need storepass
 660         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 661                 &quot;-genkeypair -alias p0 -dname CN=olala&quot;);
 662         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -storetype PKCS12 &quot; +
 663                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 664         // when specify keypass, make sure keypass==storepass...
 665         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass changeit &quot; +
 666                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 667         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 668                 &quot;PKCS12 silent when keypass == storepass&quot;);
 669         // otherwise, print a warning
 670         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass another &quot; +
 671                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 672         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 673                 &quot;PKCS12 warning when keypass != storepass&quot;);
 674 
 675         remove(&quot;x.jks&quot;);
 676         remove(&quot;x.jceks&quot;);
 677         remove(&quot;x.p12&quot;);
 678         remove(&quot;x2.jceks&quot;);
 679         remove(&quot;x2.jks&quot;);
 680         remove(&quot;x.jks.p1.cert&quot;);
 681     }
 682 
 683     void testPKCS11() throws Exception {
 684         KeyStore ks;
 685         // pkcs11, the password maybe different and maybe PKCS11 not supported
 686 
 687         // in case last test is not executed successfully
 688         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 689         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 690         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p3&quot;);
 691         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias nss&quot;);
 692 
 693         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 694         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 695                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE &quot; +
 696                         &quot;BEFORE THIS TEST ***&quot;);
 697 
 698         testOK(&quot;&quot;, p11Arg +
 699                 &quot;-storepass test12 -genkeypair -alias p1 -dname CN=olala&quot;);
 700         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -alias p2 -dname CN=olala2&quot;);
 701         // cannot provide keypass for PKCS11
 702         testFail(&quot;test12\n&quot;, p11Arg +
 703                 &quot;-keypass test12 -genkeypair -alias p3 -dname CN=olala3&quot;);
 704         // cannot provide keypass for PKCS11
 705         testFail(&quot;test12\n&quot;, p11Arg +
 706                 &quot;-keypass nonsense -genkeypair -alias p3 -dname CN=olala3&quot;);
 707 
 708         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 709         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 710                 &quot;2 entries in p11&quot;);
 711 
 712         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -changealias -destalias p3&quot;);
 713         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 714         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 715 
 716         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p3 -keyclone -destalias p1&quot;);
 717         // in PKCS11, keyclone will delete old
 718         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 719         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 720 
 721         // cannot change password for PKCS11
 722         testFail(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -keypasswd -new another&quot;);
 723 
 724         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 725         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 726                 &quot;2 entries in p11&quot;);
 727 
 728         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 729         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 730 
 731         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 732         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 733                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE&quot; +
 734                         &quot; BEFORE THIS TEST ***&quot;);
 735     }
 736 
 737     void testPKCS11ImportKeyStore() throws Exception {
 738 
 739         KeyStore ks;
 740         testOK(&quot;&quot;, p11Arg +
 741                 &quot;-storepass test12 -genkeypair -alias p1 -dname CN=olala&quot;);
 742         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -alias p2 -dname CN=olala2&quot;);
 743         // test importkeystore for pkcs11
 744 
 745         remove(&quot;x.jks&quot;);
 746         // pkcs11 -&gt; jks
 747         testOK(&quot;changeit\nchangeit\ntest12\n&quot;, srcP11Arg +
 748                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 749                 &quot;-srcalias p1&quot;));
 750         assertTrue(err.indexOf(&quot;not imported&quot;) != -1,
 751                 &quot;cannot import key without destkeypass&quot;);
 752         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 753         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;p1 is not imported&quot;);
 754 
 755         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 756                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 757                 &quot;-srcalias p1 -destkeypass changeit&quot;));
 758         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 759                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 760                 &quot;-srcalias p2 -destkeypass changeit&quot;));
 761         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 762         assertTrue(ks.containsAlias(&quot;p1&quot;), &quot;p1 is imported&quot;);
 763         assertTrue(ks.containsAlias(&quot;p2&quot;), &quot;p2 is imported&quot;);
 764         // jks -&gt; pkcs11
 765         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 766         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 767         testOK(&quot;test12\nchangeit\n&quot;, p11Arg +
 768                 &quot;-importkeystore -srckeystore x.jks -srcstoretype JKS&quot;);
 769         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 770         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p2&quot;);
 771         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 772         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 773                 &quot;2 entries in p11&quot;);
 774         // clean up
 775         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 776         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 777         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 778         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 779                 &quot;empty p11&quot;);
 780 
 781         remove(&quot;x.jks&quot;);
 782     }
 783 
 784     // Selected sqeTest
 785     void sqeTest() throws Exception {
 786         FileOutputStream fos = new FileOutputStream(&quot;badkeystore&quot;);
 787         for (int i=0; i&lt;100; i++) {
 788             fos.write(i);
 789         }
 790         fos.close();
 791 
 792         sqeCsrTest();
 793         sqePrintcertTest();
 794         sqeDeleteTest();
 795         sqeExportTest();
 796         sqeGenkeyTest();
 797         sqeImportTest();
 798         sqeKeyclonetest();
 799         sqeKeypasswdTest();
 800         sqeListTest();
 801         sqeSelfCertTest();
 802         sqeStorepassTest();
 803 
 804         remove(&quot;badkeystore&quot;);
 805     }
 806 
 807     // Import: cacert, prompt, trusted, non-trusted, bad chain, not match
 808     void sqeImportTest() throws Exception {
 809         KeyStore ks;
 810         remove(&quot;x.jks&quot;);
 811         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 812                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 813         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 814                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 815         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 816                 &quot;-storepass changeit -delete -alias mykey&quot;);
 817         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 818                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 819         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 820                 &quot;-storepass changeit -delete -alias mykey&quot;);
 821         testOK(&quot;yes\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 822                 &quot;-importcert -file x.jks.p1.cert&quot;);
 823         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 824         assertTrue(ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 825         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 826                 &quot;-storepass changeit -delete -alias mykey&quot;);
 827         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 828                 &quot;-importcert -file x.jks.p1.cert&quot;);
 829         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 830         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 831         testOK(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 832                 &quot;-importcert -file x.jks.p1.cert&quot;);
 833         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 834         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 835         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 836                 &quot;-importcert -file nonexist&quot;);
 837         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 838                 &quot;-importcert -file x.jks&quot;);
 839         remove(&quot;x.jks&quot;);
 840     }
 841     // keyclone: exist. nonexist err, cert err, dest exist, misc
 842     void sqeKeyclonetest() throws Exception {
 843         remove(&quot;x.jks&quot;);
 844         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 845                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 846         // new pass
 847         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 848                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 849         // new pass
 850         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 851                 &quot;-keypass changeit -keyclone -dest p1&quot;);
 852         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 853                 &quot;-keyclone -dest p2&quot;);
 854         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 855                 &quot;-keyclone -dest p2&quot;);
 856         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 857                 &quot;-keyclone -dest p3 -alias noexist&quot;);
 858         // no cert
 859         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 860                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 861         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 862                 &quot;-delete -alias mykey&quot;);
 863         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 864                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 865         // new pass
 866         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 867                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 868         remove(&quot;x.jks&quot;);
 869     }
 870     // keypasswd: exist, short, nonexist err, cert err, misc
 871     void sqeKeypasswdTest() throws Exception {
 872         remove(&quot;x.jks&quot;);
 873         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 874                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 875         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 876                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 877         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 878                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 879         testOK(&quot;newpass\nnewpass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 880                 &quot;-storepass changeit -keypass changeit -keypasswd&quot;);
 881         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 882                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 883         testOK(&quot;new\nnew\nnewpass\nnewpass\n&quot;, &quot;-keystore x.jks &quot; +
 884                 &quot;-storetype JKS -storepass changeit -keypass changeit -keypasswd&quot;);
 885         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 886                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 887         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 888                 &quot;-keypasswd -new newpass&quot;);
 889         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 890                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 891         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 892                 &quot;-keypasswd -new newpass&quot;);
 893         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 894                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 895         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 896                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 897         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 898                 &quot;-keypass bad -keypasswd -new newpass&quot;);
 899         // no cert
 900         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 901                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 902         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 903                 &quot;-delete -alias mykey&quot;);
 904         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 905                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 906         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 907                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 908         // diff pass
 909         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 910                 &quot;-delete -alias mykey&quot;);
 911         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 912                 &quot;-keypass keypass -genkeypair -dname CN=olala&quot;);
 913         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 914                 &quot;-keypasswd -new newpass&quot;);
 915         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 916                 &quot;-storepass changeit -keypasswd -new newpass&quot;);
 917         // i hate those misc test
 918         remove(&quot;x.jks&quot;);
 919     }
 920     // list: -f -alias, exist, nonexist err;
 921     // otherwise, check all shows, -rfc shows more, and misc
 922     void sqeListTest() throws Exception {
 923         remove(&quot;x.jks&quot;);
 924         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 925                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 926         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -list&quot;);
 927         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 928                 &quot;-list -alias mykey&quot;);
 929         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 930                 &quot;-list -alias notexist&quot;);
 931         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 932                 &quot;-list -alias mykey&quot;);
 933         // keypass ignore
 934         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 935                 &quot;-keypass badpass -list -alias mykey&quot;);
 936         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 937         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;no storepass&quot;);
 938         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 939         assertTrue(err.indexOf(&quot;WARNING&quot;) == -1, &quot;has storepass&quot;);
 940         testFail(&quot;badpass\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 941         // misc
 942         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc -storepass changeit -list&quot;);
 943         testFail(&quot;&quot;, &quot;-keystore nonexisting -storepass changeit -list&quot;);
 944         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit -list&quot;);
 945         remove(&quot;x.jks&quot;);
 946     }
 947     // selfcert: exist, non-exist err, cert err, sig, dname, wrong keypass, misc
 948     void sqeSelfCertTest() throws Exception {
 949         remove(&quot;x.jks&quot;);
 950         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 951                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 952         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -selfcert&quot;);
 953         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 954                 &quot;-keypass changeit -selfcert&quot;);
 955         // not exist
 956         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 957                 &quot;-keypass changeit -selfcert -alias nonexisting&quot;);
 958         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 959                 &quot;-keypass changeit -selfcert -dname CN=NewName&quot;);
 960         // sig not compatible
 961         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 962                 &quot;-keypass changeit -selfcert -sigalg MD5withRSA&quot;);
 963         // bad pass
 964         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass wrong &quot; +
 965                 &quot;-keypass changeit -selfcert&quot;);
 966         // bad pass
 967         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 968                 &quot;-keypass wrong -selfcert&quot;);
 969         //misc
 970         testFail(&quot;&quot;, &quot;-keystore nonexist -storepass changeit &quot; +
 971                 &quot;-keypass changeit -selfcert&quot;);
 972         testFail(&quot;&quot;, &quot;-keystore aa//dd\\gg -storepass changeit &quot; +
 973                 &quot;-keypass changeit -selfcert&quot;);
 974         // diff pass
 975         remove(&quot;x.jks&quot;);
 976         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 977                 &quot;-keypass keypass -genkeypair -dname CN=olala&quot;);
 978         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 979                 &quot;-storepass changeit -selfcert&quot;);
 980         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 981                 &quot;-storepass changeit -selfcert&quot;);
 982 
 983         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 984                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 985         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 986                 &quot;-delete -alias mykey&quot;);
 987         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 988                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 989         // certentry cannot do selfcert
 990         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 991                 &quot;-selfcert&quot;);
 992         remove(&quot;x.jks&quot;);
 993     }
 994     // storepass: bad old, short new, misc
 995     void sqeStorepassTest() throws Exception {
 996         remove(&quot;x.jks&quot;);
 997         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 998                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
 999         // all in arg
1000         testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1001                 &quot;-storepass changeit -new newstore&quot;);
1002         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks&quot; +
1003                 &quot; -storetype JKS -storepass newstore -new changeit&quot;);
1004         // all not in arg, new twice
1005         testOK(&quot;changeit\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1006                 &quot;-keystore x.jks -storetype JKS&quot;);
1007         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1008                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1009         // new in arg
1010         testOK(&quot;changeit\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1011                 &quot;-storetype JKS -new newstore&quot;);
1012         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1013                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1014         // old in arg
1015         testOK(&quot;newstore\nnewstore\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1016                 &quot;-storetype JKS -storepass changeit&quot;);
1017         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1018                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1019         // old in arg
1020         testOK(&quot;new\nnew\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1021                 &quot;-keystore x.jks -storetype JKS -storepass changeit&quot;);
1022         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1023                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1024         // bad old
1025         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1026                 &quot;-storepass badold -new newstore&quot;);
1027         // short new
1028         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1029                 &quot;-storepass changeit -new new&quot;);
1030         // misc
1031         // non exist
1032         testFail(&quot;&quot;, &quot;-storepasswd -keystore nonexist &quot; +
1033                 &quot;-storepass changeit -new newstore&quot;);
1034         // bad file
1035         testFail(&quot;&quot;, &quot;-storepasswd -keystore badkeystore &quot; +
1036                 &quot;-storepass changeit -new newstore&quot;);
1037         // bad file
1038         testFail(&quot;&quot;, &quot;-storepasswd -keystore aa\\bb//cc//dd &quot; +
1039                 &quot;-storepass changeit -new newstore&quot;);
1040         remove(&quot;x.jks&quot;);
1041     }
1042 
1043     void sqeGenkeyTest() throws Exception {
1044 
1045         remove(&quot;x.jks&quot;);
1046         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1047                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1048         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1049                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1050         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1051                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias newentry&quot;);
1052         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1053                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias newentry&quot;);
1054         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1055                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg DSA &quot; +
1056                 &quot;-alias n1&quot;);
1057         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1058                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1059                 &quot;-alias n2&quot;);
1060         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1061                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1062                 &quot;-keyalg NoSuchAlg -alias n3&quot;);
1063         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1064                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 56 &quot; +
1065                 &quot;-alias n4&quot;);
1066         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1067                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 999 &quot; +
1068                 &quot;-alias n5&quot;);
1069         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1070                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 512 &quot; +
1071                 &quot;-alias n6&quot;);
1072         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1073                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 1024 &quot; +
1074                 &quot;-alias n7&quot;);
1075         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1076                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1077                 &quot;-sigalg NoSuchAlg -alias n8&quot;);
1078         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1079                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1080                 &quot;-sigalg MD2withRSA -alias n9&quot;);
1081         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1082                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1083                 &quot;-sigalg MD5withRSA -alias n10&quot;);
1084         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1085                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1086                 &quot;-sigalg SHA1withRSA -alias n11&quot;);
1087         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1088                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1089                 &quot;-sigalg NoSuchAlg -alias n12&quot;);
1090         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1091                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1092                 &quot;-alias n14&quot;);
1093         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1094                 &quot;-keypass changeit -genkeypair -dname CN=olala -alias n16&quot;);
1095         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1096                 &quot;-keypass changeit -genkeypair -dname CNN=olala -alias n17&quot;);
1097         remove(&quot;x.jks&quot;);
1098     }
1099 
1100     void sqeExportTest() throws Exception {
1101         remove(&quot;x.jks&quot;);
1102         // nonexist
1103         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1104                 &quot;-export -file mykey.cert -alias mykey&quot;);
1105         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1106                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1107         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1108                 &quot;-export -file mykey.cert -alias mykey&quot;);
1109         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1110                 &quot;-delete -alias mykey&quot;);
1111         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1112                 &quot;-import -file mykey.cert -noprompt -alias c1&quot;);
1113         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1114                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1115         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1116                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1117         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1118                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1119         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1120                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1121         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1122                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1123         remove(&quot;mykey.cert&quot;);
1124         remove(&quot;mykey.cert2&quot;);
1125         remove(&quot;x.jks&quot;);
1126     }
1127 
1128     void sqeDeleteTest() throws Exception {
1129         remove(&quot;x.jks&quot;);
1130         // nonexist
1131         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1132                 &quot;-delete -alias mykey&quot;);
1133         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1134                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1135         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1136                 &quot;-delete -alias mykey&quot;);
1137         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1138                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1139         // keystore name illegal
1140         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1141                 &quot;-delete -alias mykey&quot;);
1142         // keystore not exist
1143         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1144                 &quot;-delete -alias mykey&quot;);
1145         // keystore invalid
1146         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1147                 &quot;-delete -alias mykey&quot;);
1148         // wrong pass
1149         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass xxxxxxxx &quot; +
1150                 &quot;-delete -alias mykey&quot;);
1151         remove(&quot;x.jks&quot;);
1152     }
1153 
1154     void sqeCsrTest() throws Exception {
1155         remove(&quot;x.jks&quot;);
1156         remove(&quot;x.jks.p1.cert&quot;);
1157         remove(&quot;csr1&quot;);
1158         // PrivateKeyEntry can do certreq
1159         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1160                 &quot;-keypass changeit -genkeypair -dname CN=olala -keysize 1024&quot;);
1161         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1162                 &quot;-certreq -file csr1 -alias mykey&quot;);
1163         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1164                 &quot;-certreq -file csr1&quot;);
1165         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1166                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1167         // unmatched sigalg
1168         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1169                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1170         // misc test
1171         // bad storepass
1172         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badstorepass &quot; +
1173                 &quot;-certreq -file csr1&quot;);
1174         // storepass from terminal
1175         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1176                 &quot;-certreq -file csr1&quot;);
1177         // must provide storepass
1178         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1179                 &quot;-certreq -file csr1&quot;);
1180         // bad keypass
1181         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1182                 &quot;-keypass badkeypass -certreq -file csr1&quot;);
1183         // bad filepath
1184         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1185                 &quot;-certreq -file aa\\bb//cc\\dd&quot;);
1186         // non-existing keystore
1187         testFail(&quot;&quot;, &quot;-keystore noexistks -storepass changeit &quot; +
1188                 &quot;-certreq -file csr1&quot;);
1189         // Try the RSA private key
1190         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1191                 &quot;-delete -alias mykey&quot;);
1192         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1193                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA&quot;);
1194         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1195                 &quot;-certreq -file csr1 -alias mykey&quot;);
1196         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1197                 &quot;-certreq -file csr1&quot;);
1198         // unmatched sigalg
1199         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1200                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1201         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1202                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1203         // TrustedCertificateEntry cannot do certreq
1204         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1205                 &quot;-exportcert -file x.jks.p1.cert&quot;);
1206         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1207                 &quot;-delete -alias mykey&quot;);
1208         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1209                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
1210         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1211                 &quot;-certreq -file csr1 -alias mykey&quot;);
1212         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1213                 &quot;-certreq -file csr1&quot;);
1214         remove(&quot;x.jks&quot;);
1215         remove(&quot;x.jks.p1.cert&quot;);
1216         remove(&quot;csr1&quot;);
1217     }
1218 
1219     void sqePrintcertTest() throws Exception {
1220         remove(&quot;x.jks&quot;);
1221         remove(&quot;mykey.cert&quot;);
1222         remove(&quot;myweakkey.cert&quot;);
1223         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1224                 &quot;-keypass changeit -genkeypair -dname CN=olala&quot;);
1225         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1226                 &quot;-export -file mykey.cert -alias mykey&quot;);
1227         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1228                 &quot;-keypass changeit -genkeypair -dname CN=weak -keyalg rsa &quot; +
1229                 &quot;-keysize 512 -sigalg MD5withRSA -alias myweakkey&quot;);
1230         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1231                 &quot;-export -file myweakkey.cert -alias myweakkey&quot;);
1232         testFail(&quot;&quot;, &quot;-printcert -file badkeystore&quot;);
1233         testFail(&quot;&quot;, &quot;-printcert -file a/b/c/d&quot;);
1234         testOK(&quot;&quot;, &quot;-printcert -file mykey.cert&quot;);
1235         testOK(&quot;&quot;, &quot;-printcert -file myweakkey.cert&quot;);
1236         FileInputStream fin = new FileInputStream(&quot;mykey.cert&quot;);
1237         testOK(fin, &quot;-printcert&quot;);
1238         fin.close();
1239         remove(&quot;x.jks&quot;);
1240         remove(&quot;mykey.cert&quot;);
1241         remove(&quot;myweakkey.cert&quot;);
1242     }
1243 
1244     // 8074935: jdk8 keytool doesn&#39;t validate pem files for RFC 1421 correctness
1245     static void checkPem(String file) throws Exception {
1246         boolean maybeLast = false;
1247         for (String s: Files.readAllLines(Paths.get(file))) {
1248             if (s.isEmpty()) continue;
1249             if (s.startsWith(&quot;---&quot;)) continue;
1250             if (maybeLast) {
1251                 throw new Exception(&quot;Last line already seen&quot;);
1252             }
1253             if (s.length() &gt; 64) {
1254                 throw new Exception(s);
1255             }
1256             if (s.length() &lt; 64) {
1257                 maybeLast = true;
1258             }
1259         }
1260     }
1261 
1262     void v3extTest(String keyAlg) throws Exception {
1263         KeyStore ks;
1264         remove(&quot;x.jks&quot;);
1265         String simple = &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1266                 &quot;-keypass changeit -noprompt -keyalg &quot; + keyAlg + &quot; &quot;;
1267         String pre = simple + &quot;-genkeypair -dname CN=Olala -alias &quot;;
1268 
1269         // Version and SKID
1270         testOK(&quot;&quot;, pre + &quot;o1&quot;);
1271 
1272         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1273         assertTrue(((X509Certificate)ks.getCertificate(&quot;o1&quot;)).getVersion() == 3);
1274         assertTrue(((X509CertImpl)ks.getCertificate(&quot;o1&quot;))
1275                 .getSubjectKeyIdentifierExtension() != null);
1276 
1277         // BC
1278         testOK(&quot;&quot;, pre + &quot;b1 -ext BC:critical&quot;);
1279         testOK(&quot;&quot;, pre + &quot;b2 -ext BC&quot;);
1280         testOK(&quot;&quot;, pre + &quot;b3 -ext bc&quot;);
1281         testOK(&quot;&quot;, pre + &quot;b4 -ext BasicConstraints&quot;);
1282         testOK(&quot;&quot;, pre + &quot;b5 -ext basicconstraints&quot;);
1283         testOK(&quot;&quot;, pre + &quot;b6 -ext BC=ca:true,pathlen:12&quot;);
1284         testOK(&quot;&quot;, pre + &quot;b7 -ext BC=ca:false&quot;);
1285         testOK(&quot;&quot;, pre + &quot;b8 -ext BC:critical=ca:false&quot;);
1286         testOK(&quot;&quot;, pre + &quot;b9 -ext BC=12&quot;);
1287 
1288         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1289         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b1&quot;))
1290                 .getBasicConstraintsExtension().isCritical());
1291         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;b2&quot;))
1292                 .getBasicConstraintsExtension().isCritical());
1293         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b8&quot;))
1294                 .getBasicConstraintsExtension().isCritical());
1295         assertTrue(((X509Certificate)ks.getCertificate(&quot;b1&quot;))
1296                 .getBasicConstraints() == Integer.MAX_VALUE);
1297         assertTrue(((X509Certificate)ks.getCertificate(&quot;b2&quot;))
1298                 .getBasicConstraints() == Integer.MAX_VALUE);
1299         assertTrue(((X509Certificate)ks.getCertificate(&quot;b3&quot;))
1300                 .getBasicConstraints() == Integer.MAX_VALUE);
1301         assertTrue(((X509Certificate)ks.getCertificate(&quot;b4&quot;))
1302                 .getBasicConstraints() == Integer.MAX_VALUE);
1303         assertTrue(((X509Certificate)ks.getCertificate(&quot;b5&quot;))
1304                 .getBasicConstraints() == Integer.MAX_VALUE);
1305         assertTrue(((X509Certificate)ks.getCertificate(&quot;b6&quot;))
1306                 .getBasicConstraints() == 12);
1307         assertTrue(((X509Certificate)ks.getCertificate(&quot;b7&quot;))
1308                 .getBasicConstraints() == -1);
1309         assertTrue(((X509Certificate)ks.getCertificate(&quot;b9&quot;))
1310                 .getBasicConstraints() == 12);
1311 
1312         // KU
1313         testOK(&quot;&quot;, pre + &quot;ku1 -ext KeyUsage:critical=digitalsignature&quot;);
1314         testOK(&quot;&quot;, pre + &quot;ku2 -ext KU=digitalSignature&quot;);
1315         testOK(&quot;&quot;, pre + &quot;ku3 -ext KU=ds&quot;);
1316         testOK(&quot;&quot;, pre + &quot;ku4 -ext KU=dig&quot;);
1317         // ambigous value
1318         testFail(&quot;&quot;, pre + &quot;ku5 -ext KU=d&quot;);
1319         // cRLSign cannot be cs
1320         testFail(&quot;&quot;, pre + &quot;ku6 -ext KU=cs&quot;);
1321         testOK(&quot;&quot;, pre + &quot;ku11 -ext KU=nr&quot;);
1322         // ke also means keyAgreement
1323         testFail(&quot;&quot;, pre + &quot;ku12 -ext KU=ke&quot;);
1324         testOK(&quot;&quot;, pre + &quot;ku12 -ext KU=keyE&quot;);
1325         // de also means decipherOnly
1326         testFail(&quot;&quot;, pre + &quot;ku13 -ext KU=de&quot;);
1327         testOK(&quot;&quot;, pre + &quot;ku13 -ext KU=dataE&quot;);
1328         testOK(&quot;&quot;, pre + &quot;ku14 -ext KU=ka&quot;);
1329         testOK(&quot;&quot;, pre + &quot;ku15 -ext KU=kcs&quot;);
1330         testOK(&quot;&quot;, pre + &quot;ku16 -ext KU=crls&quot;);
1331         testOK(&quot;&quot;, pre + &quot;ku17 -ext KU=eo&quot;);
1332         testOK(&quot;&quot;, pre + &quot;ku18 -ext KU=do&quot;);
1333         testOK(&quot;&quot;, pre + &quot;ku19 -ext KU=cc&quot;);
1334 
1335         testOK(&quot;&quot;, pre + &quot;ku017 -ext KU=ds,cc,eo&quot;);
1336         testOK(&quot;&quot;, pre + &quot;ku135 -ext KU=nr,dataEncipherment,keyCertSign&quot;);
1337         testOK(&quot;&quot;, pre + &quot;ku246 -ext KU=keyEnc,cRL,keyA&quot;);
1338         testOK(&quot;&quot;, pre + &quot;ku1234 -ext KU=ka,da,keyE,nonR&quot;);
1339 
1340         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1341         class CheckKU {
1342             void check(KeyStore ks, String alias, int... pos) throws Exception {
1343                 System.err.print(&quot;x&quot;);
1344                 boolean[] bs = ((X509Certificate)ks.getCertificate(alias))
1345                         .getKeyUsage();
1346                 bs = Arrays.copyOf(bs, 9);
1347                 for (int i=0; i&lt;bs.length; i++) {
1348                     boolean found = false;
1349                     for (int p: pos) {
1350                         if (p == i) found = true;
1351                     }
1352                     if (!found ^ bs[i]) {
1353                         // OK
1354                     } else {
1355                         throw new RuntimeException(&quot;KU not match at &quot; + i +
1356                                 &quot;: &quot; + found + &quot; vs &quot; + bs[i]);
1357                     }
1358                 }
1359             }
1360         }
1361         CheckKU c = new CheckKU();
1362         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ku1&quot;))
1363                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1364         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ku2&quot;))
1365                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1366         c.check(ks, &quot;ku1&quot;, 0);
1367         c.check(ks, &quot;ku2&quot;, 0);
1368         c.check(ks, &quot;ku3&quot;, 0);
1369         c.check(ks, &quot;ku4&quot;, 0);
1370         c.check(ks, &quot;ku11&quot;, 1);
1371         c.check(ks, &quot;ku12&quot;, 2);
1372         c.check(ks, &quot;ku13&quot;, 3);
1373         c.check(ks, &quot;ku14&quot;, 4);
1374         c.check(ks, &quot;ku15&quot;, 5);
1375         c.check(ks, &quot;ku16&quot;, 6);
1376         c.check(ks, &quot;ku17&quot;, 7);
1377         c.check(ks, &quot;ku18&quot;, 8);
1378         c.check(ks, &quot;ku19&quot;, 1);
1379         c.check(ks, &quot;ku11&quot;, 1);
1380         c.check(ks, &quot;ku11&quot;, 1);
1381         c.check(ks, &quot;ku11&quot;, 1);
1382         c.check(ks, &quot;ku017&quot;, 0, 1, 7);
1383         c.check(ks, &quot;ku135&quot;, 1, 3, 5);
1384         c.check(ks, &quot;ku246&quot;, 6, 2, 4);
1385         c.check(ks, &quot;ku1234&quot;, 1, 2, 3, 4);
1386 
1387         // EKU
1388         testOK(&quot;&quot;, pre + &quot;eku1 -ext EKU:critical=sa&quot;);
1389         testOK(&quot;&quot;, pre + &quot;eku2 -ext ExtendedKeyUsage=ca&quot;);
1390         testOK(&quot;&quot;, pre + &quot;eku3 -ext EKU=cs&quot;);
1391         testOK(&quot;&quot;, pre + &quot;eku4 -ext EKU=ep&quot;);
1392         testOK(&quot;&quot;, pre + &quot;eku8 -ext EKU=ts&quot;);
1393         testFail(&quot;&quot;, pre + &quot;eku9 -ext EKU=os&quot;);
1394         testOK(&quot;&quot;, pre + &quot;eku9 -ext EKU=ocsps&quot;);
1395         testOK(&quot;&quot;, pre + &quot;eku10 -ext EKU=any&quot;);
1396         testOK(&quot;&quot;, pre + &quot;eku11 -ext EKU=1.2.3.4,1.3.5.7,ep&quot;);
1397         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=c&quot;);
1398         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=nothing&quot;);
1399 
1400         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1401         class CheckEKU {
1402             void check(KeyStore ks, String alias, String... pos) throws Exception {
1403                 System.err.print(&quot;x&quot;);
1404                 List&lt;String&gt; bs = ((X509Certificate)ks.getCertificate(alias))
1405                         .getExtendedKeyUsage();
1406                 int found = 0;
1407                 for (String p: pos) {
1408                     if (bs.contains(p)) {
1409                         found++;
1410                     } else {
1411                         throw new RuntimeException(&quot;EKU: not included &quot; + p);
1412                     }
1413                 }
1414                 if (found != bs.size()) {
1415                     throw new RuntimeException(&quot;EKU: more items than expected&quot;);
1416                 }
1417             }
1418         }
1419         CheckEKU cx = new CheckEKU();
1420         assertTrue(((X509CertImpl)ks.getCertificate(&quot;eku1&quot;))
1421                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1422         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;eku2&quot;))
1423                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1424         cx.check(ks, &quot;eku1&quot;, &quot;1.3.6.1.5.5.7.3.1&quot;);
1425         cx.check(ks, &quot;eku2&quot;, &quot;1.3.6.1.5.5.7.3.2&quot;);
1426         cx.check(ks, &quot;eku3&quot;, &quot;1.3.6.1.5.5.7.3.3&quot;);
1427         cx.check(ks, &quot;eku4&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;);
1428         cx.check(ks, &quot;eku8&quot;, &quot;1.3.6.1.5.5.7.3.8&quot;);
1429         cx.check(ks, &quot;eku9&quot;, &quot;1.3.6.1.5.5.7.3.9&quot;);
1430         cx.check(ks, &quot;eku10&quot;, &quot;2.5.29.37.0&quot;);
1431         cx.check(ks, &quot;eku11&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;, &quot;1.2.3.4&quot;, &quot;1.3.5.7&quot;);
1432 
1433         // SAN
1434         testOK(&quot;&quot;, pre+&quot;san1 -ext san:critical=email:me@me.org&quot;);
1435         testOK(&quot;&quot;, pre+&quot;san2 -ext san=uri:http://me.org&quot;);
1436         testOK(&quot;&quot;, pre+&quot;san3 -ext san=dns:me.org&quot;);
1437         testOK(&quot;&quot;, pre+&quot;san4 -ext san=ip:192.168.0.1&quot;);
1438         testOK(&quot;&quot;, pre+&quot;san5 -ext san=oid:1.2.3.4&quot;);
1439         testOK(&quot;&quot;, pre+&quot;san6 -ext san=dns:1abc.com&quot;); //begin with digit
1440         testOK(&quot;&quot;, pre+&quot;san235 -ext san=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1441 
1442         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1443         class CheckSAN {
1444             // Please sort items with name type
1445             void check(KeyStore ks, String alias, int type, Object... items)
1446                     throws Exception {
1447                 int pos = 0;
1448                 System.err.print(&quot;x&quot;);
1449                 Object[] names = null;
1450                 if (type == 0) names = ((X509Certificate)ks.getCertificate(alias))
1451                         .getSubjectAlternativeNames().toArray();
1452                 else names = ((X509Certificate)ks.getCertificate(alias))
1453                         .getIssuerAlternativeNames().toArray();
1454                 Arrays.sort(names, new Comparator() {
1455                     public int compare(Object o1, Object o2) {
1456                         int i1 = (Integer)((List)o1).get(0);
1457                         int i2 = (Integer)((List)o2).get(0);
1458                         return i1 - i2;
1459                     }
1460                 });
1461                 for (Object o: names) {
1462                     List l = (List)o;
1463                     for (Object o2: l) {
1464                         if (!items[pos++].equals(o2)) {
1465                             throw new RuntimeException(&quot;Not equals at &quot; + pos
1466                                     + &quot;: &quot; + items[pos-1] + &quot; vs &quot; + o2);
1467                         }
1468                     }
1469                 }
1470                 if (pos != items.length) {
1471                     throw new RuntimeException(&quot;Extra items, pos is &quot; + pos);
1472                 }
1473             }
1474         }
1475         CheckSAN csan = new CheckSAN();
1476         assertTrue(((X509CertImpl)ks.getCertificate(&quot;san1&quot;))
1477                 .getSubjectAlternativeNameExtension().isCritical());
1478         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;san2&quot;))
1479                 .getSubjectAlternativeNameExtension().isCritical());
1480         csan.check(ks, &quot;san1&quot;, 0, 1, &quot;me@me.org&quot;);
1481         csan.check(ks, &quot;san2&quot;, 0, 6, &quot;http://me.org&quot;);
1482         csan.check(ks, &quot;san3&quot;, 0, 2, &quot;me.org&quot;);
1483         csan.check(ks, &quot;san4&quot;, 0, 7, &quot;192.168.0.1&quot;);
1484         csan.check(ks, &quot;san5&quot;, 0, 8, &quot;1.2.3.4&quot;);
1485         csan.check(ks, &quot;san235&quot;, 0, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1486 
1487         // IAN
1488         testOK(&quot;&quot;, pre+&quot;ian1 -ext ian:critical=email:me@me.org&quot;);
1489         testOK(&quot;&quot;, pre+&quot;ian2 -ext ian=uri:http://me.org&quot;);
1490         testOK(&quot;&quot;, pre+&quot;ian3 -ext ian=dns:me.org&quot;);
1491         testOK(&quot;&quot;, pre+&quot;ian4 -ext ian=ip:192.168.0.1&quot;);
1492         testOK(&quot;&quot;, pre+&quot;ian5 -ext ian=oid:1.2.3.4&quot;);
1493         testOK(&quot;&quot;, pre+&quot;ian235 -ext ian=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1494 
1495         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1496         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ian1&quot;))
1497                 .getIssuerAlternativeNameExtension().isCritical());
1498         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ian2&quot;))
1499                 .getIssuerAlternativeNameExtension().isCritical());
1500         csan.check(ks, &quot;ian1&quot;, 1, 1, &quot;me@me.org&quot;);
1501         csan.check(ks, &quot;ian2&quot;, 1, 6, &quot;http://me.org&quot;);
1502         csan.check(ks, &quot;ian3&quot;, 1, 2, &quot;me.org&quot;);
1503         csan.check(ks, &quot;ian4&quot;, 1, 7, &quot;192.168.0.1&quot;);
1504         csan.check(ks, &quot;ian5&quot;, 1, 8, &quot;1.2.3.4&quot;);
1505         csan.check(ks, &quot;ian235&quot;, 1, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1506 
1507         // SIA
1508         testOK(&quot;&quot;, pre+&quot;sia1 -ext sia=care:uri:ldap://ca.com/cn=CA&quot;);
1509         testOK(&quot;&quot;, pre+&quot;sia2 -ext sia=ts:email:ts@ca.com&quot;);
1510         testFail(&quot;SIA never critical&quot;, pre +
1511                 &quot;sia3 -ext sia:critical=ts:email:ts@ca.com&quot;);
1512 
1513         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1514         class CheckSia {
1515             void check(KeyStore ks, String alias, int type, Object... items)
1516                     throws Exception {
1517                 int pos = 0;
1518                 System.err.print(&quot;x&quot;);
1519                 AccessDescription[] ads = null;
1520                 if (type == 0) {
1521                     SubjectInfoAccessExtension siae = (SubjectInfoAccessExtension)
1522                             ((X509CertImpl)ks.getCertificate(alias))
1523                             .getExtension(PKIXExtensions.SubjectInfoAccess_Id);
1524                     ads = siae.getAccessDescriptions()
1525                             .toArray(new AccessDescription[0]);
1526                 } else {
1527                     AuthorityInfoAccessExtension aiae =
1528                             (AuthorityInfoAccessExtension)
1529                             ((X509CertImpl)ks.getCertificate(alias))
1530                             .getExtension(PKIXExtensions.AuthInfoAccess_Id);
1531                     ads = aiae.getAccessDescriptions()
1532                             .toArray(new AccessDescription[0]);
1533                 }
1534                 Arrays.sort(ads, new Comparator&lt;AccessDescription&gt;() {
1535                     @Override
1536                     public int compare(AccessDescription o1,
1537                                        AccessDescription o2) {
1538                         return o1.getAccessMethod().toString()
1539                                 .compareTo(o2.getAccessMethod().toString());
1540                     }
1541                 });
1542                 for (AccessDescription ad: ads) {
1543                     if (!ad.getAccessMethod().equals(items[pos++]) ||
1544                             !new Integer(ad.getAccessLocation().getType())
1545                                     .equals(items[pos++])) {
1546                         throw new RuntimeException(&quot;Not same type at &quot; + pos);
1547                     }
1548                     String name = null;
1549                     switch (ad.getAccessLocation().getType()) {
1550                         case 1:
1551                             name = ((RFC822Name)ad.getAccessLocation()
1552                                     .getName()).getName();
1553                             break;
1554                         case 6:
1555                             name = ((URIName)ad.getAccessLocation()
1556                                     .getName()).getURI().toString();
1557                             break;
1558                         default:
1559                             throw new RuntimeException(&quot;Not implemented: &quot; + ad);
1560                     }
1561                     if (!name.equals(items[pos++])) {
1562                         throw new Exception(&quot;Name not same for &quot; + ad +
1563                                 &quot; at pos &quot; + pos);
1564                     }
1565                 }
1566             }
1567         }
1568         CheckSia csia = new CheckSia();
1569         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;sia1&quot;))
1570                 .getExtension(PKIXExtensions.SubjectInfoAccess_Id).isCritical());
1571         csia.check(ks, &quot;sia1&quot;, 0,
1572                 AccessDescription.Ad_CAREPOSITORY_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1573         csia.check(ks, &quot;sia2&quot;,
1574                 0, AccessDescription.Ad_TIMESTAMPING_Id, 1, &quot;ts@ca.com&quot;);
1575 
1576         // AIA
1577         testOK(&quot;&quot;, pre+&quot;aia1 -ext aia=cai:uri:ldap://ca.com/cn=CA&quot;);
1578         testOK(&quot;&quot;, pre+&quot;aia2 -ext aia=ocsp:email:ocsp@ca.com&quot;);
1579         testFail(&quot;AIA never critical&quot;, pre +
1580                 &quot;aia3 -ext aia:critical=ts:email:ts@ca.com&quot;);
1581 
1582         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1583         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;aia1&quot;))
1584                 .getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
1585         csia.check(ks, &quot;aia1&quot;, 1,
1586                 AccessDescription.Ad_CAISSUERS_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1587         csia.check(ks, &quot;aia2&quot;, 1,
1588                 AccessDescription.Ad_OCSP_Id, 1, &quot;ocsp@ca.com&quot;);
1589 
1590         // OID
1591         testOK(&quot;&quot;, pre+&quot;oid1 -ext 1.2.3:critical=0102&quot;);
1592         testOK(&quot;&quot;, pre+&quot;oid2 -ext 1.2.3&quot;);
1593         testOK(&quot;&quot;, pre+&quot;oid12 -ext 1.2.3 -ext 1.2.4=01:02:03&quot;);
1594 
1595         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1596         class CheckOid {
1597             void check(KeyStore ks, String alias, String oid, byte[] value)
1598                     throws Exception {
1599                 int pos = 0;
1600                 System.err.print(&quot;x&quot;);
1601                 Extension ex = ((X509CertImpl)ks.getCertificate(alias))
1602                         .getExtension(new ObjectIdentifier(oid));
1603                 if (!Arrays.equals(value, ex.getValue())) {
1604                     throw new RuntimeException(&quot;Not same content in &quot; +
1605                             alias + &quot; for &quot; + oid);
1606                 }
1607             }
1608         }
1609         CheckOid coid = new CheckOid();
1610         assertTrue(((X509CertImpl)ks.getCertificate(&quot;oid1&quot;))
1611                 .getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1612         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;oid2&quot;))
1613                 .getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1614         coid.check(ks, &quot;oid1&quot;, &quot;1.2.3&quot;, new byte[]{1,2});
1615         coid.check(ks, &quot;oid2&quot;, &quot;1.2.3&quot;, new byte[]{});
1616         coid.check(ks, &quot;oid12&quot;, &quot;1.2.3&quot;, new byte[]{});
1617         coid.check(ks, &quot;oid12&quot;, &quot;1.2.4&quot;, new byte[]{1,2,3});
1618 
1619         // honored
1620         testOK(&quot;&quot;, pre+&quot;ca&quot;);
1621         testOK(&quot;&quot;, pre+&quot;a&quot;);
1622         // request: BC,KU,1.2.3,1.2.4,1.2.5
1623         testOK(&quot;&quot;, simple+&quot;-alias a -certreq &quot; +
1624                 &quot;-ext BC=1 -ext KU=crl &quot; +
1625                 &quot;-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 &quot; +
1626                 &quot;-rfc -file test.req&quot;);
1627         // printcertreq
1628         testOK(&quot;&quot;, &quot;-printcertreq -file test.req&quot;);
1629         checkPem(&quot;test.req&quot;);
1630         // issue: deny KU, change criticality of 1.2.3 and 1.2.4,
1631         // change content of BC, add 2.3.4
1632         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1633                 &quot;honored=all,-KU,1.2.3:critical,1.2.4:non-critical &quot; +
1634                 &quot;-ext BC=2 -ext 2.3.4=01020304 &quot; +
1635                 &quot;-debug -rfc -outfile test.cert&quot;);
1636         checkPem(&quot;test.cert&quot;);
1637         testOK(&quot;&quot;, simple+&quot;-importcert -file test.cert -alias a&quot;);
1638         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1639         X509CertImpl a = (X509CertImpl)ks.getCertificate(&quot;a&quot;);
1640         assertTrue(a.getAuthorityKeyIdentifierExtension() != null);
1641         assertTrue(a.getSubjectKeyIdentifierExtension() != null);
1642         assertTrue(a.getKeyUsage() == null);
1643         assertTrue(a.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1644         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());
1645         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;1.2.5&quot;)).isCritical());
1646         assertTrue(a.getExtensionValue(&quot;1.2.3&quot;).length == 3);
1647         assertTrue(a.getExtensionValue(&quot;1.2.4&quot;).length == 4);
1648         assertTrue(a.getExtensionValue(&quot;1.2.5&quot;).length == 5);
1649         assertTrue(a.getBasicConstraints() == 2);
1650         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;2.3.4&quot;)).isCritical());
1651         assertTrue(a.getExtensionValue(&quot;2.3.4&quot;).length == 6);
1652 
1653         // 8073181: keytool -ext honored not working correctly
1654         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1655                 &quot;honored=1.2.3,KU,1.2.4:critical &quot; +
1656                 &quot;-debug -rfc -outfile test2.cert&quot;);
1657         testOK(&quot;&quot;, simple+&quot;-importcert -file test2.cert -alias b&quot;);
1658         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1659         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
1660         assertTrue(!b.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());
1661         assertTrue(b.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());
1662 
1663         // 8073182: keytool may generate duplicate extensions
1664         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1665         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1666         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1667         assertTrue(dup.getBasicConstraints() == 3);
1668 
1669         remove(&quot;x.jks&quot;);
1670         remove(&quot;test.req&quot;);
1671         remove(&quot;test.cert&quot;);
1672     }
1673 
1674     void i18nTest() throws Exception {
1675         //   1.  keytool -help
1676         remove(&quot;x.jks&quot;);
1677         testOK(&quot;&quot;, &quot;-help&quot;);
1678 
1679         //   2. keytool -genkey -v -keysize 512 Enter &quot;a&quot; for the keystore
1680         // password. Check error (password too short). Enter &quot;password&quot; for
1681         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
1682         // &quot;organizational unit&quot;, &quot;City&quot;, &quot;State&quot;, and &quot;Country Code&quot;.
1683         // Type &quot;yes&quot; when they ask you if everything is correct.
1684         // Type &#39;return&#39; for new key password.
1685         testOK(&quot;a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n&quot;,
1686                 &quot;-genkey -v -keysize 512 -keystore x.jks -storetype JKS&quot;);
1687         //   3. keytool -list -v -storepass password
1688         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1689         //   4. keytool -list -v Type &quot;a&quot; for the keystore password.
1690         // Check error (wrong keystore password).
1691         testFail(&quot;a\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1692         assertTrue(ex.indexOf(&quot;password was incorrect&quot;) != -1);
1693         //   5. keytool -genkey -v -keysize 512 Enter &quot;password&quot; as the password.
1694         // Check error (alias &#39;mykey&#39; already exists).
1695         testFail(&quot;password\n&quot;, &quot;-genkey -v -keysize 512&quot; +
1696                 &quot; -keystore x.jks -storetype JKS&quot;);
1697         assertTrue(ex.indexOf(&quot;alias &lt;mykey&gt; already exists&quot;) != -1);
1698         //   6. keytool -genkey -v -keysize 512 -alias mykey2 -storepass password
1699         // Hit &#39;return&#39; for &quot;first and last name&quot;, &quot;organizational unit&quot;, &quot;City&quot;,
1700         // &quot;State&quot;, and &quot;Country Code&quot;. Type &quot;yes&quot; when they ask you if
1701         // everything is correct. Type &#39;return&#39; for new key password.
1702         testOK(&quot;\n\n\n\n\n\nyes\n\n&quot;, &quot;-genkey -v -keysize 512 -alias mykey2&quot; +
1703                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1704         //   7. keytool -list -v Type &#39;password&#39; for the store password.
1705         testOK(&quot;password\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1706         //   8. keytool -keypasswd -v -alias mykey2 -storepass password
1707         // Type &quot;a&quot; for the new key password. Type &quot;aaaaaa&quot; for the new key
1708         // password. Type &quot;bbbbbb&quot; when re-entering the new key password.
1709         // Type &quot;a&quot; for the new key password. Check Error (too many failures).
1710         testFail(&quot;a\naaaaaa\nbbbbbb\na\n&quot;, &quot;-keypasswd -v -alias mykey2&quot; +
1711                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1712         assertTrue(ex.indexOf(&quot;Too many failures - try later&quot;) != -1);
1713         //   9. keytool -keypasswd -v -alias mykey2 -storepass password
1714         // Type &quot;aaaaaa&quot; for the new key password. Type &quot;aaaaaa&quot;
1715         // when re-entering the new key password.
1716         testOK(&quot;aaaaaa\naaaaaa\n&quot;, &quot;-keypasswd -v -alias mykey2 &quot; +
1717                 &quot;-storepass password -keystore x.jks -storetype JKS&quot;);
1718         //  10. keytool -selfcert -v -alias mykey -storepass password
1719         testOK(&quot;&quot;, &quot;-selfcert -v -alias mykey -storepass password &quot; +
1720                 &quot;-keystore x.jks -storetype JKS&quot;);
1721         //  11. keytool -list -v -storepass password
1722         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1723         //  12. keytool -export -v -alias mykey -file cert -storepass password
1724         remove(&quot;cert&quot;);
1725         testOK(&quot;&quot;, &quot;-export -v -alias mykey -file cert -storepass password &quot; +
1726                 &quot;-keystore x.jks -storetype JKS&quot;);
1727         //  13. keytool -import -v -file cert -storepass password
1728         // Check error (Certificate reply and cert are the same)
1729         testFail(&quot;&quot;, &quot;-import -v -file cert -storepass password&quot; +
1730                 &quot; -keystore x.jks -storetype JKS&quot;);
1731         assertTrue(ex.indexOf(&quot;Certificate reply and certificate&quot; +
1732                 &quot; in keystore are identical&quot;) != -1);
1733         //  14. keytool -printcert -file cert
1734         testOK(&quot;&quot;, &quot;-printcert -file cert -keystore x.jks -storetype JKS&quot;);
1735         remove(&quot;cert&quot;);
1736         //  15. keytool -list -storepass password -addprovider SUN
1737         testOK(&quot;&quot;, &quot;-list -storepass password&quot; +
1738                 &quot; -addprovider SUN&quot; +
1739                 &quot; -keystore x.jks -storetype JKS&quot;);
1740 
1741         //Error tests
1742 
1743         //   1. keytool -storepasswd -storepass password -new abc
1744         // Check error (password too short)
1745         testFail(&quot;&quot;, &quot;-storepasswd -storepass password -new abc&quot;);
1746         assertTrue(ex.indexOf(&quot;New password must be at least 6 characters&quot;) != -1);
1747         // Changed, no NONE needed now
1748         //   2. keytool -list -storetype PKCS11 Check error (-keystore must be NONE)
1749         //testFail(&quot;&quot;, &quot;-list -storetype PKCS11&quot;);
1750         //assertTrue(err.indexOf(&quot;keystore must be NONE&quot;) != -1);
1751         //   3. keytool -storepasswd -storetype PKCS11 -keystore NONE
1752         // Check error (unsupported operation)
1753         testFail(&quot;&quot;, &quot;-storepasswd -storetype PKCS11 -keystore NONE&quot;);
1754         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1755         //   4. keytool -keypasswd -storetype PKCS11 -keystore NONE
1756         // Check error (unsupported operation)
1757         testFail(&quot;&quot;, &quot;-keypasswd -storetype PKCS11 -keystore NONE&quot;);
1758         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1759         //   5. keytool -list -protected -storepass password
1760         // Check error (password can not be specified with -protected)
1761         testFail(&quot;&quot;, &quot;-list -protected -storepass password &quot; +
1762                 &quot;-keystore x.jks -storetype JKS&quot;);
1763         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1764         //   6. keytool -keypasswd -protected -keypass password
1765         // Check error (password can not be specified with -protected)
1766         testFail(&quot;&quot;, &quot;-keypasswd -protected -keypass password &quot; +
1767                 &quot;-keystore x.jks -storetype JKS&quot;);
1768         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1769         //   7. keytool -keypasswd -protected -new password
1770         // Check error (password can not be specified with -protected)
1771         testFail(&quot;&quot;, &quot;-keypasswd -protected -new password &quot; +
1772                 &quot;-keystore x.jks -storetype JKS&quot;);
1773         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1774         remove(&quot;x.jks&quot;);
1775     }
1776 
1777     void i18nPKCS11Test() throws Exception {
1778         //PKCS#11 tests
1779 
1780         //   1. sccs edit cert8.db key3.db
1781         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs edit cert8.db key3.db&quot;);
1782         testOK(&quot;&quot;, p11Arg + (&quot;-storepass test12 -genkey -alias genkey&quot; +
1783                 &quot; -dname cn=genkey -keysize 512 -keyalg rsa&quot;));
1784         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1785         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias genkey&quot;);
1786         testOK(&quot;&quot;, p11Arg +
1787                 &quot;-storepass test12 -certreq -alias genkey -file genkey.certreq&quot;);
1788         testOK(&quot;&quot;, p11Arg +
1789                 &quot;-storepass test12 -export -alias genkey -file genkey.cert&quot;);
1790         testOK(&quot;&quot;, &quot;-printcert -file genkey.cert&quot;);
1791         testOK(&quot;&quot;, p11Arg +
1792                 &quot;-storepass test12 -selfcert -alias genkey -dname cn=selfCert&quot;);
1793         testOK(&quot;&quot;, p11Arg +
1794                 &quot;-storepass test12 -list -alias genkey -v&quot;);
1795         assertTrue(out.indexOf(&quot;Owner: CN=selfCert&quot;) != -1);
1796         //(check that cert subject DN is [cn=selfCert])
1797         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias genkey&quot;);
1798         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1799         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1);
1800         //(check for empty database listing)
1801         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs unedit cert8.db key3.db&quot;);
1802         remove(&quot;genkey.cert&quot;);
1803         remove(&quot;genkey.certreq&quot;);
1804         //  12. sccs unedit cert8.db key3.db
1805     }
1806 
1807     // tesing new option -srcProviderName
1808     void sszzTest() throws Exception {
1809         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1810         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1811         testOK(&quot;&quot;, NSS_P11_ARG+&quot;-genkeypair -dname CN=NSS &quot; +
1812                 &quot;-alias nss -storepass test12&quot;);
1813         testOK(&quot;&quot;, NSS_SRC_P11_ARG + NZZ_P11_ARG +
1814                 &quot;-importkeystore -srcstorepass test12 -deststorepass test12&quot;);
1815         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1816         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1817     }
1818 
1819     public static void main(String[] args) throws Exception {
1820         Locale reservedLocale = Locale.getDefault();
1821         try {
1822             // first test if HumanInputStream really acts like a human being
1823             HumanInputStream.test();
1824             KeyToolTest t = new KeyToolTest();
1825 
1826             if (System.getProperty(&quot;file&quot;) != null) {
1827                 t.sqeTest();
1828                 t.testAll();
1829                 t.i18nTest();
1830                 t.v3extTest(&quot;RSA&quot;);
1831                 t.v3extTest(&quot;DSA&quot;);
1832                 boolean testEC = true;
1833                 try {
1834                     KeyPairGenerator.getInstance(&quot;EC&quot;);
1835                 } catch (NoSuchAlgorithmException nae) {
1836                     testEC = false;
1837                 }
1838                 if (testEC) t.v3extTest(&quot;EC&quot;);
1839             }
1840 
1841             if (System.getProperty(&quot;nss&quot;) != null) {
1842                 t.srcP11Arg = NSS_SRC_P11_ARG;
1843                 t.p11Arg = NSS_P11_ARG;
1844 
1845                 t.testPKCS11();
1846 
1847                 // FAIL:
1848                 // 1. we still don&#39;t have srcprovidername yet
1849                 // 2. cannot store privatekey into NSS keystore
1850                 //    java.security.KeyStoreException: sun.security.pkcs11
1851                 //      .wrapper.PKCS11Exception: CKR_TEMPLATE_INCOMPLETE.
1852                 //t.testPKCS11ImportKeyStore();
1853 
1854                 t.i18nPKCS11Test();
1855                 //FAIL: currently PKCS11-NSS does not support
1856                 // 2 NSS KeyStores to be loaded at the same time
1857                 //t.sszzTest();
1858             }
1859 
1860             if (System.getProperty(&quot;solaris&quot;) != null) {
1861                 // For Solaris Cryptography Framework
1862                 t.srcP11Arg = SUN_SRC_P11_ARG;
1863                 t.p11Arg = SUN_P11_ARG;
1864                 t.testPKCS11();
1865                 t.testPKCS11ImportKeyStore();
1866                 t.i18nPKCS11Test();
1867             }
1868 
1869             System.out.println(&quot;Test pass!!!&quot;);
1870         } finally {
1871             // restore the reserved locale
1872             Locale.setDefault(reservedLocale);
1873         }
1874     }
1875 }
1876 
1877 class TestException extends Exception {
1878     public TestException(String e) {
1879         super(e);
1880     }
1881 }
1882 
1883 /**
1884  * HumanInputStream tries to act like a human sitting in front of a computer
1885  * terminal typing on the keyboard while the keytool program is running.
1886  *
1887  * keytool has called InputStream.read() and BufferedReader.readLine() in
1888  * various places. a call to B.readLine() will try to buffer as much input as
1889  * possible. Thus, a trivial InputStream will find it impossible to feed
1890  * anything to I.read() after a B.readLine() call.
1891  *
1892  * This is why i create HumanInputStream, which will only send a single line
1893  * to B.readLine(), no more, no less, and the next I.read() can have a chance
1894  * to read the exact character right after &quot;\n&quot;.
1895  *
1896  * I don&#39;t know why HumanInputStream works.
1897  */
1898 class HumanInputStream extends InputStream {
1899     byte[] src;
1900     int pos;
1901     int length;
1902     boolean inLine;
1903     int stopIt;
1904 
1905     public HumanInputStream(String input) {
1906         src = input.getBytes();
1907         pos = 0;
1908         length = src.length;
1909         stopIt = 0;
1910         inLine = false;
1911     }
1912 
1913     // the trick: when called through read(byte[], int, int),
1914     // return -1 twice after &quot;\n&quot;
1915 
1916     @Override public int read() throws IOException {
1917         int re;
1918         if(pos &lt; length) {
1919             re = src[pos];
1920             if(inLine) {
1921                 if(stopIt &gt; 0) {
1922                     stopIt--;
1923                     re = -1;
1924                 } else {
1925                     if(re == &#39;\n&#39;) {
1926                         stopIt = 2;
1927                     }
1928                     pos++;
1929                 }
1930             } else {
1931                 pos++;
1932             }
1933         } else {
1934             re = -1;//throw new IOException(&quot;NO MORE TO READ&quot;);
1935         }
1936         //if (re &lt; 32) System.err.printf(&quot;[%02d]&quot;, re);
1937         //else System.err.printf(&quot;[%c]&quot;, (char)re);
1938         return re;
1939     }
1940     @Override public int read(byte[] buffer, int offset, int len) {
1941         inLine = true;
1942         try {
1943             int re = super.read(buffer, offset, len);
1944             return re;
1945         } catch(Exception e) {
1946             throw new RuntimeException(&quot;HumanInputStream error&quot;);
1947         } finally {
1948             inLine = false;
1949         }
1950     }
1951     @Override public int available() {
1952         if(pos &lt; length) return 1;
1953         return 0;
1954     }
1955 
1956     // test part
1957     static void assertTrue(boolean bool) {
1958         if(!bool)
1959             throw new RuntimeException();
1960     }
1961 
1962     public static void test() throws Exception {
1963 
1964         class Tester {
1965             HumanInputStream is;
1966             BufferedReader reader;
1967             Tester(String s) {
1968                 is = new HumanInputStream(s);
1969                 reader = new BufferedReader(new InputStreamReader(is));
1970             }
1971 
1972             // three kinds of test method
1973             // 1. read byte by byte from InputStream
1974             void testStreamReadOnce(int expection) throws Exception {
1975                 assertTrue(is.read() == expection);
1976             }
1977             void testStreamReadMany(String expection) throws Exception {
1978                 char[] keys = expection.toCharArray();
1979                 for(int i=0; i&lt;keys.length; i++) {
1980                     assertTrue(is.read() == keys[i]);
1981                 }
1982             }
1983             // 2. read a line with a newly created Reader
1984             void testReaderReadline(String expection) throws Exception {
1985                 String s = new BufferedReader(new InputStreamReader(is)).readLine();
1986                 if(s == null) assertTrue(expection == null);
1987                 else assertTrue(s.equals(expection));
1988             }
1989             // 3. read a line with the old Reader
1990             void testReaderReadline2(String expection) throws Exception  {
1991                 String s = reader.readLine();
1992                 if(s == null) assertTrue(expection == null);
1993                 else assertTrue(s.equals(expection));
1994             }
1995         }
1996 
1997         Tester test;
1998 
1999         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2000         test.testReaderReadline(&quot;111&quot;);
2001         test.testReaderReadline(&quot;222&quot;);
2002         test.testReaderReadline(&quot;&quot;);
2003         test.testReaderReadline(&quot;444&quot;);
2004         test.testReaderReadline(&quot;&quot;);
2005         test.testReaderReadline(null);
2006 
2007         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2008         test.testReaderReadline2(&quot;111&quot;);
2009         test.testReaderReadline2(&quot;222&quot;);
2010         test.testReaderReadline2(&quot;&quot;);
2011         test.testReaderReadline2(&quot;444&quot;);
2012         test.testReaderReadline2(&quot;&quot;);
2013         test.testReaderReadline2(null);
2014 
2015         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2016         test.testReaderReadline2(&quot;111&quot;);
2017         test.testReaderReadline(&quot;222&quot;);
2018         test.testReaderReadline2(&quot;&quot;);
2019         test.testReaderReadline2(&quot;444&quot;);
2020         test.testReaderReadline(&quot;&quot;);
2021         test.testReaderReadline2(null);
2022 
2023         test = new Tester(&quot;1\n2&quot;);
2024         test.testStreamReadMany(&quot;1\n2&quot;);
2025         test.testStreamReadOnce(-1);
2026 
2027         test = new Tester(&quot;12\n234&quot;);
2028         test.testStreamReadOnce(&#39;1&#39;);
2029         test.testReaderReadline(&quot;2&quot;);
2030         test.testStreamReadOnce(&#39;2&#39;);
2031         test.testReaderReadline2(&quot;34&quot;);
2032         test.testReaderReadline2(null);
2033 
2034         test = new Tester(&quot;changeit\n&quot;);
2035         test.testStreamReadMany(&quot;changeit\n&quot;);
2036         test.testReaderReadline(null);
2037 
2038         test = new Tester(&quot;changeit\nName\nCountry\nYes\n&quot;);
2039         test.testStreamReadMany(&quot;changeit\n&quot;);
2040         test.testReaderReadline(&quot;Name&quot;);
2041         test.testReaderReadline(&quot;Country&quot;);
2042         test.testReaderReadline(&quot;Yes&quot;);
2043         test.testReaderReadline(null);
2044 
2045         test = new Tester(&quot;Me\nHere\n&quot;);
2046         test.testReaderReadline2(&quot;Me&quot;);
2047         test.testReaderReadline2(&quot;Here&quot;);
2048     }
2049 }
    </pre>
  </body>
</html>