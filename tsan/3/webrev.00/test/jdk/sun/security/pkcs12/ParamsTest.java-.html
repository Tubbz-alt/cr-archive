<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/sun/security/pkcs12/ParamsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8076190
 27  * @library /test/lib
 28  * @modules java.base/sun.security.pkcs
 29  *          java.base/sun.security.x509
 30  *          java.base/sun.security.util
 31  * @summary Customizing the generation of a PKCS12 keystore
 32  */
 33 
 34 import jdk.test.lib.Asserts;
 35 import jdk.test.lib.SecurityTools;
 36 import jdk.test.lib.process.OutputAnalyzer;
 37 
 38 import java.io.File;
 39 import java.io.FileInputStream;
 40 import java.io.FileOutputStream;
 41 import java.io.IOException;
 42 import java.io.InputStream;
 43 import java.io.OutputStream;
 44 import java.io.UncheckedIOException;
 45 import java.nio.file.Files;
 46 import java.nio.file.Path;
 47 import java.security.KeyStore;
 48 import java.util.Base64;
 49 import java.util.Objects;
 50 
 51 import static jdk.test.lib.security.DerUtils.*;
 52 import static sun.security.x509.AlgorithmId.*;
 53 import static sun.security.pkcs.ContentInfo.*;
 54 
 55 public class ParamsTest  {
 56 
 57     public static void main(String[] args) throws Throwable {
 58 
 59         // De-BASE64 textual files in ./params to `pwd`
 60         Files.newDirectoryStream(Path.of(System.getProperty(&quot;test.src&quot;), &quot;params&quot;))
 61                 .forEach(p -&gt; {
 62                     try (InputStream is = Files.newInputStream(p);
 63                          OutputStream os = Files.newOutputStream(p.getFileName())){
 64                         Base64.getMimeDecoder().wrap(is).transferTo(os);
 65                     } catch (IOException e) {
 66                         throw new UncheckedIOException(e);
 67                     }
 68                 });
 69 
 70         byte[] data;
 71 
 72         // openssl -&gt; keytool interop check
 73 
 74         // os2. no cert pbe, no mac.
 75         check(&quot;os2&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
 76         check(&quot;os2&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 77         // You can even load it with a wrong storepass, controversial
 78         check(&quot;os2&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
 79 
 80         // os3. no cert pbe, has mac. just like JKS
 81         check(&quot;os3&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
 82         check(&quot;os3&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 83         // Cannot load with a wrong storepass, same as JKS
 84         check(&quot;os3&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 85 
 86         // os4. non default algs
 87         check(&quot;os4&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 88         check(&quot;os4&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 89         // no storepass no cert
 90         check(&quot;os4&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 91 
 92         // os5. strong non default algs
 93         check(&quot;os5&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 94         check(&quot;os5&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 95         // no storepass no cert
 96         check(&quot;os5&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 97 
 98         // keytool
 99 
100         // Current default pkcs12 setting
101         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
102                 + &quot;-destkeystore ksnormal -deststorepass changeit&quot;);
103         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
104         checkInt(data, &quot;22&quot;, 100000); // Mac ic
105         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
106         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
107         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
108         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
109         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
110         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
111 
112         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
113         check(&quot;ksnormal&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
114         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
115 
116         // Add a new entry with password-less settings, still has a storepass
117         keytool(&quot;-keystore ksnormal -genkeypair -storepass changeit -alias b -dname CN=b &quot;
118                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
119                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
120         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
121         checkInt(data, &quot;22&quot;, 100000); // Mac ic
122         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
123         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
124         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
125         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid); // new key alg
126         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
127         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
128         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
129         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
130         check(&quot;ksnormal&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, false, true);
131         check(&quot;ksnormal&quot;, &quot;b&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
132 
133         // Different keypbe alg, no cert pbe and no mac
134         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
135                 + &quot;-destkeystore ksnopass -deststorepass changeit &quot;
136                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128 &quot;
137                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
138                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
139         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
140         shouldNotExist(data, &quot;2&quot;); // no Mac
141         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);
142         checkInt(data, &quot;110c010c010011&quot;, 50000);
143         checkAlg(data, &quot;110c10&quot;, DATA_OID);
144         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
145         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
146         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
147 
148         // Add a new entry with normal settings, still password-less
149         keytool(&quot;-keystore ksnopass -genkeypair -storepass changeit -alias b -dname CN=B&quot;);
150         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
151         shouldNotExist(data, &quot;2&quot;); // no Mac
152         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);
153         checkInt(data, &quot;110c010c010011&quot;, 50000);
154         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid);
155         checkInt(data, &quot;110c010c110011&quot;, 50000);
156         checkAlg(data, &quot;110c10&quot;, DATA_OID);
157         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
158         check(&quot;ksnopass&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, true, true);
159 
160         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
161                 + &quot;-destkeystore ksnewic -deststorepass changeit &quot;
162                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=5555 &quot;
163                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=6666 &quot;
164                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=7777&quot;);
165         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
166         checkInt(data, &quot;22&quot;, 5555); // Mac ic
167         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
168         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
169         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
170         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
171         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
172 
173         // keypbe alg cannot be NONE
174         keytool(&quot;-keystore ksnewic -genkeypair -storepass changeit -alias b -dname CN=B &quot;
175                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=NONE&quot;)
176                 .shouldContain(&quot;NONE AlgorithmParameters not available&quot;)
177                 .shouldHaveExitValue(1);
178 
179         // new entry new keypbe alg (and default ic), else unchanged
180         keytool(&quot;-keystore ksnewic -genkeypair -storepass changeit -alias b -dname CN=B &quot;
181                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128&quot;);
182         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
183         checkInt(data, &quot;22&quot;, 5555); // Mac ic
184         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
185         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
186         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
187         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndRC4_128_oid); // new key alg
188         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
189         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
190         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
191 
192         // Check KeyStore loading multiple keystores
193         KeyStore ks = KeyStore.getInstance(&quot;pkcs12&quot;);
194         try (FileInputStream fis = new FileInputStream(&quot;ksnormal&quot;);
195                 FileOutputStream fos = new FileOutputStream(&quot;ksnormaldup&quot;)) {
196             ks.load(fis, &quot;changeit&quot;.toCharArray());
197             ks.store(fos, &quot;changeit&quot;.toCharArray());
198         }
199         data = Files.readAllBytes(Path.of(&quot;ksnormaldup&quot;));
200         checkInt(data, &quot;22&quot;, 100000); // Mac ic
201         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
202         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
203         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
204         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid); // new key alg
205         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
206         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
207         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
208         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
209 
210         try (FileInputStream fis = new FileInputStream(&quot;ksnopass&quot;);
211              FileOutputStream fos = new FileOutputStream(&quot;ksnopassdup&quot;)) {
212             ks.load(fis, &quot;changeit&quot;.toCharArray());
213             ks.store(fos, &quot;changeit&quot;.toCharArray());
214         }
215         data = Files.readAllBytes(Path.of(&quot;ksnopassdup&quot;));
216         shouldNotExist(data, &quot;2&quot;); // no Mac
217         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);
218         checkInt(data, &quot;110c010c010011&quot;, 50000);
219         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid);
220         checkInt(data, &quot;110c010c110011&quot;, 50000);
221         checkAlg(data, &quot;110c10&quot;, DATA_OID);
222 
223         try (FileInputStream fis = new FileInputStream(&quot;ksnewic&quot;);
224              FileOutputStream fos = new FileOutputStream(&quot;ksnewicdup&quot;)) {
225             ks.load(fis, &quot;changeit&quot;.toCharArray());
226             ks.store(fos, &quot;changeit&quot;.toCharArray());
227         }
228         data = Files.readAllBytes(Path.of(&quot;ksnewicdup&quot;));
229         checkInt(data, &quot;22&quot;, 5555); // Mac ic
230         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg
231         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg
232         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
233         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndRC4_128_oid); // new key alg
234         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
235         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg
236         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
237 
238         // Check keytool behavior
239 
240         // ksnormal has password
241 
242         keytool(&quot;-list -keystore ksnormal&quot;)
243                 .shouldContain(&quot;WARNING WARNING WARNING&quot;)
244                 .shouldContain(&quot;Certificate chain length: 0&quot;);
245 
246         SecurityTools.setResponse(&quot;changeit&quot;);
247         keytool(&quot;-list -keystore ksnormal&quot;)
248                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
249                 .shouldContain(&quot;Certificate fingerprint&quot;);
250 
251         // ksnopass is password-less
252 
253         keytool(&quot;-list -keystore ksnopass&quot;)
254                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
255                 .shouldContain(&quot;Certificate fingerprint&quot;);
256 
257         // -certreq prompts for keypass
258         SecurityTools.setResponse(&quot;changeit&quot;);
259         keytool(&quot;-certreq -alias a -keystore ksnopass&quot;)
260                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
261                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
262                 .shouldHaveExitValue(0);
263 
264         // -certreq -storepass works fine
265         keytool(&quot;-certreq -alias a -keystore ksnopass -storepass changeit&quot;)
266                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;)
267                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
268                 .shouldHaveExitValue(0);
269 
270         // -certreq -keypass also works fine
271         keytool(&quot;-certreq -alias a -keystore ksnopass -keypass changeit&quot;)
272                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;)
273                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
274                 .shouldHaveExitValue(0);
275 
276         // -importkeystore prompts for srckeypass
277         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
278         keytool(&quot;-importkeystore -srckeystore ksnopass &quot;
279                 + &quot;-destkeystore jks3 -deststorepass changeit&quot;)
280                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
281                 .shouldContain(&quot;Enter key password for &lt;b&gt;&quot;)
282                 .shouldContain(&quot;2 entries successfully imported&quot;);
283 
284         // ksnopass2 is ksnopass + 2 cert entries
285 
286         ks = KeyStore.getInstance(new File(&quot;ksnopass&quot;), (char[])null);
287         ks.setCertificateEntry(&quot;aa&quot;, ks.getCertificate(&quot;a&quot;));
288         ks.setCertificateEntry(&quot;bb&quot;, ks.getCertificate(&quot;b&quot;));
289         try (FileOutputStream fos = new FileOutputStream(&quot;ksnopass2&quot;)) {
290             ks.store(fos, null);
291         }
292 
293         // -importkeystore prompts for srckeypass for private keys
294         // and no prompt for certs
295         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
296         keytool(&quot;-importkeystore -srckeystore ksnopass2 &quot;
297                 + &quot;-destkeystore jks5 -deststorepass changeit&quot;)
298                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
299                 .shouldContain(&quot;Enter key password for &lt;b&gt;&quot;)
300                 .shouldNotContain(&quot;Enter key password for &lt;aa&gt;&quot;)
301                 .shouldNotContain(&quot;Enter key password for &lt;bb&gt;&quot;)
302                 .shouldContain(&quot;4 entries successfully imported&quot;);
303 
304         // ksonlycert has only cert entries
305 
306         ks.deleteEntry(&quot;a&quot;);
307         ks.deleteEntry(&quot;b&quot;);
308         try (FileOutputStream fos = new FileOutputStream(&quot;ksonlycert&quot;)) {
309             ks.store(fos, null);
310         }
311 
312         // -importkeystore does not prompt at all
313         keytool(&quot;-importkeystore -srckeystore ksonlycert &quot;
314                 + &quot;-destkeystore jks6 -deststorepass changeit&quot;)
315                 .shouldNotContain(&quot;Enter key password for &lt;aa&gt;&quot;)
316                 .shouldNotContain(&quot;Enter key password for &lt;bb&gt;&quot;)
317                 .shouldContain(&quot;2 entries successfully imported&quot;);
318 
319         // create a new password-less keystore
320         keytool(&quot;-keystore ksnopass -exportcert -alias a -file a.cert -rfc&quot;);
321 
322         // Normally storepass is prompted for
323         keytool(&quot;-keystore kscert1 -importcert -alias a -file a.cert -noprompt&quot;)
324                 .shouldContain(&quot;Enter keystore password:&quot;);
325         keytool(&quot;-keystore kscert2 -importcert -alias a -file a.cert -noprompt &quot;
326                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE&quot;)
327                 .shouldContain(&quot;Enter keystore password:&quot;);
328         keytool(&quot;-keystore kscert3 -importcert -alias a -file a.cert -noprompt &quot;
329                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
330                 .shouldContain(&quot;Enter keystore password:&quot;);
331         // ... but not if it&#39;s password-less
332         keytool(&quot;-keystore kscert4 -importcert -alias a -file a.cert -noprompt &quot;
333                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
334                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
335                 .shouldNotContain(&quot;Enter keystore password:&quot;);
336 
337         // still prompt for keypass for genkeypair and certreq
338         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
339         keytool(&quot;-keystore ksnopassnew -genkeypair -alias a -dname CN=A &quot;
340                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
341                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
342                 .shouldNotContain(&quot;Enter keystore password:&quot;)
343                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;);
344         keytool(&quot;-keystore ksnopassnew -certreq -alias a&quot;)
345                 .shouldNotContain(&quot;Enter keystore password:&quot;)
346                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;);
347         keytool(&quot;-keystore ksnopassnew -list -v -alias a&quot;)
348                 .shouldNotContain(&quot;Enter keystore password:&quot;)
349                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;);
350 
351         // params only read on demand
352 
353         // keyPbeIterationCount is used by -genkeypair
354         keytool(&quot;-keystore ksgenbadkeyic -genkeypair -alias a -dname CN=A &quot;
355                 + &quot;-storepass changeit &quot;
356                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc&quot;)
357                 .shouldContain(&quot;keyPbeIterationCount is not a number: abc&quot;)
358                 .shouldHaveExitValue(1);
359 
360         keytool(&quot;-keystore ksnopassnew -exportcert -alias a -file a.cert&quot;);
361 
362         // but not used by -importcert
363         keytool(&quot;-keystore ksimpbadkeyic -importcert -alias a -file a.cert &quot;
364                 + &quot;-noprompt -storepass changeit &quot;
365                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc&quot;)
366                 .shouldHaveExitValue(0);
367 
368         // None is used by -list
369         keytool(&quot;-keystore ksnormal -storepass changeit -list &quot;
370                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc &quot;
371                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=abc &quot;
372                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=abc&quot;)
373                 .shouldHaveExitValue(0);
374     }
375 
376     /**
377      * Check keystore loading and key/cert reading.
378      *
379      * @param keystore the file name of keystore
380      * @param alias the key/cert to read
381      * @param storePass store pass to try out, can be null
382      * @param keypass key pass to try, can not be null
383      * @param expectedLoad expected result of keystore loading, true if non
384      *                     null, false if null, exception class if exception
385      * @param expectedCert expected result of cert reading
386      * @param expectedKey expected result of key reading
387      */
388     private static void check(
389             String keystore,
390             String alias,
391             String storePass,
392             String keypass,
393             Object expectedLoad,
394             Object expectedCert,
395             Object expectedKey) {
396         KeyStore ks = null;
397         Object actualLoad, actualCert, actualKey;
398         String label = keystore + &quot;-&quot; + alias + &quot;-&quot; + storePass + &quot;-&quot; + keypass;
399         try {
400             ks = KeyStore.getInstance(new File(keystore),
401                     storePass == null ? null : storePass.toCharArray());
402             actualLoad = ks != null;
403         } catch (Exception e) {
404             e.printStackTrace(System.out);
405             actualLoad = e.getClass();
406         }
407         Asserts.assertEQ(expectedLoad, actualLoad, label + &quot;-load&quot;);
408 
409         // If not loaded correctly, skip cert/key reading
410         if (!Objects.equals(actualLoad, true)) {
411             return;
412         }
413 
414         try {
415             actualCert = (ks.getCertificate(alias) != null);
416         } catch (Exception e) {
417             e.printStackTrace(System.out);
418             actualCert = e.getClass();
419         }
420         Asserts.assertEQ(expectedCert, actualCert, label + &quot;-cert&quot;);
421 
422         try {
423             actualKey = (ks.getKey(alias, keypass.toCharArray()) != null);
424         } catch (Exception e) {
425             e.printStackTrace(System.out);
426             actualKey = e.getClass();
427         }
428         Asserts.assertEQ(expectedKey, actualKey, label + &quot;-key&quot;);
429     }
430 
431     static OutputAnalyzer keytool(String s) throws Throwable {
432         return SecurityTools.keytool(s);
433     }
434 }
    </pre>
  </body>
</html>