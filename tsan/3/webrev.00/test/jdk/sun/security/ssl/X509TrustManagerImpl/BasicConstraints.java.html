<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/ssl/X509TrustManagerImpl/BasicConstraints.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 //
 25 // SunJSSE does not support dynamic system properties, no way to re-use
 26 // system properties in samevm/agentvm mode.
 27 //
 28 
 29 /*
 30  * @test
 31  * @bug 7166570
 32  * @summary JSSE certificate validation has started to fail for
 33  *     certificate chains
 34  * @run main/othervm BasicConstraints PKIX
 35  * @run main/othervm BasicConstraints SunX509
 36  */
 37 
 38 import java.util.*;
 39 import java.io.*;
 40 import javax.net.ssl.*;
 41 import java.security.KeyStore;
 42 import java.security.KeyFactory;
 43 import java.security.cert.*;
 44 import java.security.spec.*;
 45 import java.security.interfaces.*;
 46 
 47 import java.util.Base64;
 48 
 49 public class BasicConstraints {
 50 
 51     /*
 52      * =============================================================
 53      * Set the various variables needed for the tests, then
 54      * specify what tests to run on each side.
 55      */
 56 
 57     /*
 58      * Should we run the client or server in a separate thread?
 59      * Both sides can throw exceptions, but do you have a preference
 60      * as to which side should be the main thread.
 61      */
 62     static boolean separateServerThread = true;
 63 
 64     /*
 65      * Where do we find the keystores?
 66      */
 67     // Certificate information:
 68     // Issuer: C=US, O=Java, OU=SunJSSE Test Serivce
 69     // Validity
 70     //     Not Before: Dec 20 13:13:44 2019 GMT
 71     //     Not After : Dec 17 13:13:44 2029 GMT
 72     // Subject: C=US, O=Java, OU=SunJSSE Test Serivce
 73     // X509v3 Subject Key Identifier:
 74     //     88:A7:8D:A1:4F:85:3C:9B:32:47:88:E8:74:81:65:45:00:DE:DD:45
 75     // X509v3 Authority Key Identifier:
 76     //     keyid:88:A7:8D:A1:4F:85:3C:9B:32:47:88:E8:74:81:65:45:00:DE:DD:45
 77     static String trusedCertStr =
 78         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
 79         &quot;MIIDZDCCAkygAwIBAgIUSXd4x4/VUhfEFGgfxEt/BG2n8RIwDQYJKoZIhvcNAQEL\n&quot; +
 80         &quot;BQAwOzELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpT\n&quot; +
 81         &quot;U0UgVGVzdCBTZXJpdmNlMB4XDTE5MTIyMDEzMTM0NFoXDTI5MTIxNzEzMTM0NFow\n&quot; +
 82         &quot;OzELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpTU0Ug\n&quot; +
 83         &quot;VGVzdCBTZXJpdmNlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Cd4\n&quot; +
 84         &quot;U//Y2P4vIu9BBGi+pm64YXYP2LNRNK/e5/nWWmNKJapCAYYda/FJClrbzpI/FgRU\n&quot; +
 85         &quot;NLM9B4Uo065FRIrBi1vu8zyYgwT7UK0WsLwg6Z81KH50PfM0ClEx44tTqocYDc7C\n&quot; +
 86         &quot;gsvbyIeTIbV9AnRlEnBA15WFJAJMTCglaNleXUZ9+A/tazRhHlsRp0Ob8j4tCMJa\n&quot; +
 87         &quot;RDpGMYTy1XbG+WqC8wXP63a63cwjPrL5uzt/C4W1bgNBfTRwIHSUShNhfdc7ZJNS\n&quot; +
 88         &quot;r2NFPcwodd7uVle5JePNag7oyhjOFFEaBGq21dl6/ozVRkqSWWAi1P7MRay9eYj3\n&quot; +
 89         &quot;mLZiZaL6NlWxXnfzVwIDAQABo2AwXjAdBgNVHQ4EFgQUiKeNoU+FPJsyR4jodIFl\n&quot; +
 90         &quot;RQDe3UUwHwYDVR0jBBgwFoAUiKeNoU+FPJsyR4jodIFlRQDe3UUwDwYDVR0TAQH/\n&quot; +
 91         &quot;BAUwAwEB/zALBgNVHQ8EBAMCAQYwDQYJKoZIhvcNAQELBQADggEBAI1Lgf1Sd/iR\n&quot; +
 92         &quot;pXBW6OKE9Oa6WkZx/hKrtm3tw+m5OTU4veQijMPIIgnXw0QYXFMieWSjSz+OGq+v\n&quot; +
 93         &quot;t5NJWj7afCOADrhswrfAY3q3XY9+HnoXv1OvANFhokos25w6fB9t0lrm5KR+3d8l\n&quot; +
 94         &quot;RwQbxhr8I6tDn2pDExVXRe8k2PYqkabgG6IqPnLzt4iLhPx4ivzo4Zc+zfQZc672\n&quot; +
 95         &quot;oyNJw2/iNufHRsoRa8QqHJM9vziYfChZqdSSlTiqaoyijT0Br6/2yyIKfjjt5Abt\n&quot; +
 96         &quot;cwIDUWqQda62xV7ChkTh7ia3uvBXob2iiB0aI3gVTTqDfK9F5XXtW4BXfqx0hvwB\n&quot; +
 97         &quot;6JzgmNyDQos=\n&quot; +
 98         &quot;-----END CERTIFICATE-----&quot;;
 99     static String trustedPrivateKey = // Private key in the format of PKCS#8
100         &quot;MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDUJ3hT/9jY/i8i\n&quot; +
101         &quot;70EEaL6mbrhhdg/Ys1E0r97n+dZaY0olqkIBhh1r8UkKWtvOkj8WBFQ0sz0HhSjT\n&quot; +
102         &quot;rkVEisGLW+7zPJiDBPtQrRawvCDpnzUofnQ98zQKUTHji1OqhxgNzsKCy9vIh5Mh\n&quot; +
103         &quot;tX0CdGUScEDXlYUkAkxMKCVo2V5dRn34D+1rNGEeWxGnQ5vyPi0IwlpEOkYxhPLV\n&quot; +
104         &quot;dsb5aoLzBc/rdrrdzCM+svm7O38LhbVuA0F9NHAgdJRKE2F91ztkk1KvY0U9zCh1\n&quot; +
105         &quot;3u5WV7kl481qDujKGM4UURoEarbV2Xr+jNVGSpJZYCLU/sxFrL15iPeYtmJlovo2\n&quot; +
106         &quot;VbFed/NXAgMBAAECggEAUZvlQ5q1VbNhenTCc+m+/NK2hncd3WQNJtFIU7/dXuO2\n&quot; +
107         &quot;0ApQXbmzc6RbTmppB2tmbRe5NJSGM3BbpiHxb05Y6TyyDEsQ98Vgz0Xl5pJXrsaZ\n&quot; +
108         &quot;cjxChtoY+KcHI9qikoRpElaoqBu3LcpJJLxlnB4eCxu3NbbEgneH1fvTeCO1kvcp\n&quot; +
109         &quot;i3DDdyfY7WB9RW1yWAveiuqvtnbsPfJJLKEhFvZL2ArYCRTm/oIw64yukNe/QLR5\n&quot; +
110         &quot;bGzEJMT2ZNQMld1f+CW9tOrUKrnnPCGfMa351T5we+8B6sujWfftPutgEVx5TmHs\n&quot; +
111         &quot;AOW1SntMapbgg46K9EC/C5YQa5D1aNOH9ZTEMkgUMQKBgQDrpPQIHFozeeyZ0iiq\n&quot; +
112         &quot;HtReLPcqpkwr/9ELc3SjgUypSvpu0l/m++um0yLinlXMn25km/BP6Mv3t/+1uzAc\n&quot; +
113         &quot;qpopkcyek8X1hzNRhDkWuMv4KDOKk5c6qLx8FGSm6q8PYm5KbsiyeCM7CJoeoqJ5\n&quot; +
114         &quot;74IZjOIw7UrYLckCb6W8xGQLIwKBgQDmew3vGRR3JmCCSumtJQOqhF6bBYrNb6Qc\n&quot; +
115         &quot;r4vrng+QhNIquwGqHKPorAI1J8J1jOS+dkDWTxSz2xQKQ83nsOspzVPskpDh5mWL\n&quot; +
116         &quot;gGk5QCkX87jFsXfhvZFLksZMbIdpWze997Zs2fe/PWfPaH6o3erqo2zAhQV0eA9q\n&quot; +
117         &quot;C7tfImREPQKBgQDi2Xq/8CN52M9IScQx+dnyC5Gqckt0NCKXxn8sBIa7l129oDMI\n&quot; +
118         &quot;187FXA8CYPEyOu14V5KiKvdos66s0daAUlB04lI8+v+g3ZYuzH50/FQHwxPTPUBi\n&quot; +
119         &quot;DRzeyncXJWiAA/8vErWM8hDgfOh5w5Fsl4EEfdcmyNm7gWA4Qyknr1ysRwKBgQDC\n&quot; +
120         &quot;JSPepUy09VHUTxA59nT5HRmoEeoTFRizxTfi2LkZrphuwCotxoRXiRUu+3f1lyJU\n&quot; +
121         &quot;Qb5qCCFTQ5bE8squgTwGcVxhajC66V3ePePlAuPatkWN2ek28X1DoLaDR+Rk3h69\n&quot; +
122         &quot;Wb2EQbNMl4grkUUoMA8jaVhBb4vhyQSK+qjyAUFerQKBgQDXZPuflfsjH/d/O2yw\n&quot; +
123         &quot;qZbssKe9AKORjv795teblAc3vmsSlNwwVnPdS2aq1LHyoNbetc/OaZV151hTQ/9z\n&quot; +
124         &quot;bsA48oOojgrDD07Ovg3uDcNEIufxR0aGeSSvqhElp1r7wAYj8bAr6W/RH6MS16WW\n&quot; +
125         &quot;dRd+PH6hsap8BD2RlVCnrT3vIQ==&quot;;
126 
127     // Certificate information:
128     // Issuer: C=US, O=Java, OU=SunJSSE Test Serivce
129     // Validity
130     //     Not Before: Dec 20 13:13:44 2019 GMT
131     //     Not After : Dec 17 13:13:44 2029 GMT
132     // Subject: C=US, O=Java, OU=SunJSSE Test Serivce, CN=casigner
133     // X509v3 Subject Key Identifier:
134     //     4B:6D:B0:B0:E6:EF:45:15:35:B5:FC:6B:E2:C7:FC:A6:E6:C4:EC:95
135     // X509v3 Authority Key Identifier:
136     //     keyid:88:A7:8D:A1:4F:85:3C:9B:32:47:88:E8:74:81:65:45:00:DE:DD:45
137     static String caSignerStr =
138         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
139         &quot;MIIDdzCCAl+gAwIBAgIUDYDCpVXk72hlpeNam094GPxl9Z0wDQYJKoZIhvcNAQEL\n&quot; +
140         &quot;BQAwOzELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpT\n&quot; +
141         &quot;U0UgVGVzdCBTZXJpdmNlMB4XDTE5MTIyMDEzMTM0NFoXDTI5MTIxNzEzMTM0NFow\n&quot; +
142         &quot;TjELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpTU0Ug\n&quot; +
143         &quot;VGVzdCBTZXJpdmNlMREwDwYDVQQDDAhjYXNpZ25lcjCCASIwDQYJKoZIhvcNAQEB\n&quot; +
144         &quot;BQADggEPADCCAQoCggEBAMC8Z4sqVbWWNp567w28MKN9bkE0rZzQLivLsiz7WYzg\n&quot; +
145         &quot;8LsUDhtGkxpAcoiMuxnkPWGgD3Xzdy/enVo/vn9lgw7LHWJ3+FeZt3eOnwFHTBu+\n&quot; +
146         &quot;srFrnf7iU7RLkAvl06lTYBWFx15Dv4PCgvqIC4eo1wAGDcKKOshwV5kdw8zBpkx3\n&quot; +
147         &quot;1jEkbpiuc0cxaNtdMYqmZrTY0wHVSdHGx02mGp9G3aCRSzXyXrr3uxInt5uW9JYR\n&quot; +
148         &quot;bDUGa2uD02jbxRSyIXyrSb2L8bRDNg6tLq+CG6blukcCLHF8D1n+jMes3yB/yA0N\n&quot; +
149         &quot;NGcbqmEPBVvVSP2c7Z/3JMCvHsrPkS1E2YPH1I0xL2sCAwEAAaNgMF4wHQYDVR0O\n&quot; +
150         &quot;BBYEFEttsLDm70UVNbX8a+LH/KbmxOyVMB8GA1UdIwQYMBaAFIinjaFPhTybMkeI\n&quot; +
151         &quot;6HSBZUUA3t1FMA8GA1UdEwEB/wQFMAMBAf8wCwYDVR0PBAQDAgEGMA0GCSqGSIb3\n&quot; +
152         &quot;DQEBCwUAA4IBAQBpwrPMDlCvxRvv91w4oFYhYTV2zj9BecsYQPhbqG9zRiHrJoNE\n&quot; +
153         &quot;dDPxZQnjb3P5u2LAe7Cp+Nah1ZSvjnF1oVk7ct+Usz02InojHxN72xDsZOMLWuAN\n&quot; +
154         &quot;3CJhjGp6WyYUstRWybpiJzPehZdYfk+FaMxwM54REAiipDTFO07PZrj1h/aDQ0Tl\n&quot; +
155         &quot;7D6w2v1pz1IR/ctuij7sFReFvjFEE4JoTNjfqzNWO4ML1vDHVi5MHeBgUckujOrI\n&quot; +
156         &quot;P0QqaqP+xJIY+sRrzdckxSfS9AOOrJk2VXY8qEoxCN4wCvHJWuHEAF/Lm65d/hq3\n&quot; +
157         &quot;2Uh8P+QHLeuEwF8RoTpjiGM9dXvaqcQz7w5G\n&quot; +
158         &quot;-----END CERTIFICATE-----&quot;;
159     static String caSignerPrivateKey = // Private key in the format of PKCS#8
160         &quot;MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDAvGeLKlW1ljae\n&quot; +
161         &quot;eu8NvDCjfW5BNK2c0C4ry7Is+1mM4PC7FA4bRpMaQHKIjLsZ5D1hoA9183cv3p1a\n&quot; +
162         &quot;P75/ZYMOyx1id/hXmbd3jp8BR0wbvrKxa53+4lO0S5AL5dOpU2AVhcdeQ7+DwoL6\n&quot; +
163         &quot;iAuHqNcABg3CijrIcFeZHcPMwaZMd9YxJG6YrnNHMWjbXTGKpma02NMB1UnRxsdN\n&quot; +
164         &quot;phqfRt2gkUs18l6697sSJ7eblvSWEWw1Bmtrg9No28UUsiF8q0m9i/G0QzYOrS6v\n&quot; +
165         &quot;ghum5bpHAixxfA9Z/ozHrN8gf8gNDTRnG6phDwVb1Uj9nO2f9yTArx7Kz5EtRNmD\n&quot; +
166         &quot;x9SNMS9rAgMBAAECggEAZk6cF/8s5+sIqy9OXdgbaW1XbT1tOuQ23gCOX9o8Os/c\n&quot; +
167         &quot;eTG4GzpnM3QqV9l8J85D1uKD0nSeO8bLd/CGSlG0M9IVkwNjy/xIqyoFtUQHXmLn\n&quot; +
168         &quot;r84UXAv/qqDBoc8pf6RGSKZuodcMfgBuTlaQ6D3zgou0GiQN9//KP/jQyouwnr3A\n&quot; +
169         &quot;LyXQekxriwPuSYAPak8s5XLfugOebbSRm2UdGEgX3yrT9FVu9rtgeMKdRaCOU8T4\n&quot; +
170         &quot;G2UdpGaiDfm5yrR+2XEIv4oaH3WFxmmfQCxVcOFJ1iRvfKBbLb1UCgtJuCBD067y\n&quot; +
171         &quot;dq5PrwUTeAvd7hwZd0lxCSnWY7VvYFNr7iJfyElowQKBgQD8eosot+Th03hpkYDs\n&quot; +
172         &quot;BIVsw7oqhJmcrPV1bSZ+aQwqqrOGypNmb7nLGTC8Cj1sT+EzfGs7GqxiLOEn4NXr\n&quot; +
173         &quot;TYV//RUPBSEXVp2y+2dot1a9oq0BJ8FwGTYL0qSwJrIXJfkQFrYhVVz3JLIWJbwV\n&quot; +
174         &quot;cy4YCQr094BhXTS7joJOUDRsYwKBgQDDbI3Lv+bBK8lLfIBll1RY1k5Gqy/H+qxp\n&quot; +
175         &quot;sMN8FmadmIGzHhe9xml6b5EfAZphAUF4vZJhQXloT5Wm+NNIAf6X6dRjvzyw7N9B\n&quot; +
176         &quot;d48EFJF4ChqNGBocsQRNr2wPRzQ+k2caw9YyYMIjbhktDzO1U/FJGYW6/Vgr2v4K\n&quot; +
177         &quot;siROnXfLWQKBgBOVAZQP5z2opC8z7NbhZuPPrnG7xRpEw+jupUyqoxnwEWqD7bjF\n&quot; +
178         &quot;M5jQBFqhRLBQ5buTi9GSuQoIRxJLuuu8IH2TyH1YvX9M5YBLRXL2vVCJ/HcZeURT\n&quot; +
179         &quot;gECcfs92wNtQw6d+y3N8ZnB4tSNIm/Th8RJGKUZkp91lWECvxeWDDP3XAoGASfNq\n&quot; +
180         &quot;NRAJYlAPfGFAtTDu2i8+r79X9XUGiXg6gVp4umpbqkxY75eFkq9lWzZgFRVEkUwr\n&quot; +
181         &quot;eGIubyquluDSEw2uKg5yMMzNSqZYVY3IsOKXqbUpFvtn5jOWTU90tNNdEdD100sI\n&quot; +
182         &quot;Y0f6Ly4amNKH3rZFOERQNtJn6zCTsbh3xMgR7QECgYBhQTqxLU5eIu38MKobzRue\n&quot; +
183         &quot;RoUkMcoY3DePkKPSYjilFhkUDozIXf/xUGnB8kERZKO+44wUkuPGljiFL1/P/RO9\n&quot; +
184         &quot;zhHAV94Kw2ddtfxy05GVtUZ99miBmsMb2m8vumGJqfR8h2xpfc1Ra0zfrsPgLNru\n&quot; +
185         &quot;xDTDW+bNbM7XyPvg9mOf7Q==&quot;;
186 
187     // Certificate information:
188     // Issuer: C=US, O=Java, OU=SunJSSE Test Serivce, CN=casigner
189     // Validity
190     //     Not Before: May  5 02:40:57 2012 GMT
191     //     Not After : Jan 21 02:40:57 2032 GMT
192     // Subject: C=US, O=Java, OU=SunJSSE Test Serivce, CN=certissuer
193     // X509v3 Subject Key Identifier:
194     //     B4:E8:EA:80:A9:2B:F5:62:B5:2C:A6:F8:FF:65:BC:CF:51:40:9C:15
195     // X509v3 Authority Key Identifier:
196     //     keyid:4B:6D:B0:B0:E6:EF:45:15:35:B5:FC:6B:E2:C7:FC:A6:E6:C4:EC:95
197     static String certIssuerStr =
198         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
199         &quot;MIIDjDCCAnSgAwIBAgIUJWLHjJR9tY2/5DX3iOcZ2JRKY8cwDQYJKoZIhvcNAQEL\n&quot; +
200         &quot;BQAwTjELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpT\n&quot; +
201         &quot;U0UgVGVzdCBTZXJpdmNlMREwDwYDVQQDDAhjYXNpZ25lcjAeFw0xOTEyMjAxMzEz\n&quot; +
202         &quot;NDVaFw0yOTEyMTcxMzEzNDVaMFAxCzAJBgNVBAYTAlVTMQ0wCwYDVQQKDARKYXZh\n&quot; +
203         &quot;MR0wGwYDVQQLDBRTdW5KU1NFIFRlc3QgU2VyaXZjZTETMBEGA1UEAwwKY2VydGlz\n&quot; +
204         &quot;c3VlcjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALWUNWnObPBso4vI\n&quot; +
205         &quot;VaSM+Oq1f3EsyrtJWqhu+EG/5UKEwYaNBs1A9u1zM5xc05y4wXJfFj755djtzfsz\n&quot; +
206         &quot;OFt1ke/hjhpYSf4DcSJfb99MBvHHXrmrEqIdsPYSaUqT9DrIi+L0z0Rdev++IQJj\n&quot; +
207         &quot;j9J213gpi18RNrQWl8Xn9mlkxhCjwj1GoFA6aF+9cvWX8uh2Vrl6Vm28hTKnmTad\n&quot; +
208         &quot;FB7nwDF4/mGuKVsiB+YTJJ/2Y6RpNqVF/Z6kET/BE0DtCLlKvY7iljbHc892YzI0\n&quot; +
209         &quot;vhxlo4lOB3J4NhsQxJbq+mIlbbqZr+p4WA8hdnwI4UlktI4S7fXQzhA51JHVjZyX\n&quot; +
210         &quot;f9XYTRUCAwEAAaNgMF4wHQYDVR0OBBYEFLTo6oCpK/VitSym+P9lvM9RQJwVMB8G\n&quot; +
211         &quot;A1UdIwQYMBaAFEttsLDm70UVNbX8a+LH/KbmxOyVMA8GA1UdEwEB/wQFMAMBAf8w\n&quot; +
212         &quot;CwYDVR0PBAQDAgEGMA0GCSqGSIb3DQEBCwUAA4IBAQCGrjnGs23pQkQoUu8+C2y/\n&quot; +
213         &quot;OAT5k9uyPCcLxFPM+Hon5WI6DACxpj7mu2ekN0fswu6B7beQVygpnNSQFVqLrJw1\n&quot; +
214         &quot;daYdhTMzkNCkPk6q0cUmj5k94jfCHBl4jw+qoZiIehuR9qFHhpLkT4zMTkFof+P+\n&quot; +
215         &quot;Lfc92QJppUAOh3jTvHK01YwP2sxK3KXhcbofQnxGS4WHrqmmZC2YO/LQRoYDZdUY\n&quot; +
216         &quot;zr4da2aIg9CKrH2QWoMkDfRKkJvrU3/VhVfVWpNbXFE2xZXftQl3hpFCJ3FkpciA\n&quot; +
217         &quot;l3hKeq4byY3LXxhAClHpk1KkXJkMnQdOfA5aGekj/Cjuaz1/iKYAG2vRq7YcuM/o\n&quot; +
218         &quot;-----END CERTIFICATE-----&quot;;
219     static String certIssuerPrivateKey = // Private key in the format of PKCS#8
220         &quot;MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQC1lDVpzmzwbKOL\n&quot; +
221         &quot;yFWkjPjqtX9xLMq7SVqobvhBv+VChMGGjQbNQPbtczOcXNOcuMFyXxY++eXY7c37\n&quot; +
222         &quot;MzhbdZHv4Y4aWEn+A3EiX2/fTAbxx165qxKiHbD2EmlKk/Q6yIvi9M9EXXr/viEC\n&quot; +
223         &quot;Y4/Sdtd4KYtfETa0FpfF5/ZpZMYQo8I9RqBQOmhfvXL1l/Lodla5elZtvIUyp5k2\n&quot; +
224         &quot;nRQe58AxeP5hrilbIgfmEySf9mOkaTalRf2epBE/wRNA7Qi5Sr2O4pY2x3PPdmMy\n&quot; +
225         &quot;NL4cZaOJTgdyeDYbEMSW6vpiJW26ma/qeFgPIXZ8COFJZLSOEu310M4QOdSR1Y2c\n&quot; +
226         &quot;l3/V2E0VAgMBAAECggEBAJjfVrjl2kHwtSCSYchQB6FTfSBDnctgTrtP8iMo9FO0\n&quot; +
227         &quot;gVpOkVNtRndTbjhOzro7smIgPBJ5QlIIpErBLMmTinJza7gybNk2/KD7yKwuzgnw\n&quot; +
228         &quot;2IdoyB9E8B+8EHmBZzW2ck953KaqLUvzPsdMG2IOPAomr/gx/eRQwScVzBefiEGo\n&quot; +
229         &quot;sN+rGfUt/RNAHwWje1KuNDj21S84agQhN6hdYUnIMsvJLu/9mOwUb9ff+AzTUfFr\n&quot; +
230         &quot;zyx2MJL4Cx59DkUUMESCfinlHUc21llQjFWmX/zOoGY0X0qV/YM/GRsv1ZDFHw9o\n&quot; +
231         &quot;hQ6m8Ov7D9wB3TKZBI97sCyggjBfSeuYQlNbs99KWQECgYEA7IKNL0ME7FuIrKYu\n&quot; +
232         &quot;FCQ/Duz1N3oQXLzrTGKUSU1qSbrU2Jwk4SfJ8ZYCW1TP6vZkaQsTXmXun3yyCAqZ\n&quot; +
233         &quot;hcOtDBhI+b7Wpmmyf6nb83oYJtzHMRQZ5qS+9vOBfV9Uf1za8XI4p90EqkFHByCF\n&quot; +
234         &quot;tHfjVbjK39zN4CvaO3tqpOaYtL0CgYEAxIrTAhGWy9nBsxf8QeqDou0rV5Cw50Kl\n&quot; +
235         &quot;kQsE7KLmjvrMaFFpUc5lgWoC+pm/69VpNBUuN/38YozwxVjVi/nMJuuK150mhdWI\n&quot; +
236         &quot;B28FI7ORnFmVeSvTrP4mBX1ct2Tny9zpchXn3rpHR5NZUs7oBhjudHSfRMrHxeBs\n&quot; +
237         &quot;Kv2pr2s6uzkCgYAtrEh3iAm7WzHZpX3ghd9nknsIa5odTp5h8eeRAFI2Ss4vxneY\n&quot; +
238         &quot;w4ZMERwDZy1/wnVBk9H5uNWMFxiKVQGww0j3vPjawe/R0zeVT8gaDMn9N0WARNF7\n&quot; +
239         &quot;qPT3265196LptZTSa6xlPllYR6LfzXgEkeJk+3qyIIHheJZ8RikiDyYOQQKBgQC/\n&quot; +
240         &quot;rxlegiMNC4KDldf7vanGxAKqcz5lPbXWQOX7mGC+f9HNx+Cs3VxYHDltiXgJnOju\n&quot; +
241         &quot;191s1HRK9WR5REt5KhY2uzB9WxJQItJ5VYiwqhhQYXqLY/gdVv1kC0DayDndtMWk\n&quot; +
242         &quot;88JhklGkeAv83DikgbpGr9sJr6+oyFkWkLDmmfD82QKBgQCMgkZJzrdSNNlB0n5x\n&quot; +
243         &quot;xC3MzlsQ5aBJuUctnMfuyDi+11yLAuP1oLzGEJ7qEfFoGRO0V8zJWmHAfNhmVYEX\n&quot; +
244         &quot;ow5g0WbPT16GoRCiOAzq+ewH+TEELMF6HWqnDuTnCg28Jg0dw2kdVTqeyzKOQlLG\n&quot; +
245         &quot;ua9c2DY3PUTXQPNqLVhz+XxZKA==&quot;;
246 
247     // Certificate information:
248     // Issuer: C=US, O=Java, OU=SunJSSE Test Serivce, CN=certissuer
249     // Validity
250     //     Not Before: Dec 20 13:13:45 2019 GMT
251     //     Not After : Dec 17 13:13:45 2029 GMT
252     // Subject: C=US, O=Java, OU=SunJSSE Test Serivce, CN=localhost
253     // X509v3 Subject Key Identifier:
254     //     46:FC:94:7A:61:6D:BF:5F:AE:D7:20:EC:BF:6A:74:2A:26:F1:D4:4C
255     // X509v3 Authority Key Identifier:
256     //     keyid:B4:E8:EA:80:A9:2B:F5:62:B5:2C:A6:F8:FF:65:BC:CF:51:40:9C:15
257     static String serverCertStr =
258         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
259         &quot;MIIDfDCCAmSgAwIBAgIUHsJi1HTWpR3FCiOiG/qLK6BDluwwDQYJKoZIhvcNAQEL\n&quot; +
260         &quot;BQAwUDELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpT\n&quot; +
261         &quot;U0UgVGVzdCBTZXJpdmNlMRMwEQYDVQQDDApjZXJ0aXNzdWVyMB4XDTE5MTIyMDEz\n&quot; +
262         &quot;MTM0NVoXDTI5MTIxNzEzMTM0NVowTzELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEph\n&quot; +
263         &quot;dmExHTAbBgNVBAsMFFN1bkpTU0UgVGVzdCBTZXJpdmNlMRIwEAYDVQQDDAlsb2Nh\n&quot; +
264         &quot;bGhvc3QwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCaDgoxN2UQQero\n&quot; +
265         &quot;oBQ4JlQP1BFaZEtIkdIU2VJs4whz85J0LSB/68iEOS5e8wCz9wiQWr4isor7sl3e\n&quot; +
266         &quot;B2dnLGY28BthOTw2j/CYw/dRqyDbPZniooB233uLGarKjqQWXpRFQi6bgEQmNqWe\n&quot; +
267         &quot;C32w+V+Oq3CTkinwgPvA5mnSe0P8gpF9NLZBFn0TtxaY0bQIie2WNk/HjrVQIhq3\n&quot; +
268         &quot;qmG/zVxeBc3PVOOU/OKrwjHbim9YI+zdDRXjNm8siHi0RF2+fkxfyAm8Qg+mT8L4\n&quot; +
269         &quot;xdtr0a+eP4oIvkymRURxIrXNnvoX+MhYKSOQnizpW0NMOZ5L9nyw1cYX8j9Ed6eM\n&quot; +
270         &quot;kzxZwRrlAgMBAAGjTzBNMB0GA1UdDgQWBBRG/JR6YW2/X67XIOy/anQqJvHUTDAf\n&quot; +
271         &quot;BgNVHSMEGDAWgBS06OqAqSv1YrUspvj/ZbzPUUCcFTALBgNVHQ8EBAMCA+gwDQYJ\n&quot; +
272         &quot;KoZIhvcNAQELBQADggEBAGXHGefA1j136yenwK+j9K5VnG2kYGXCadi9bKtTXf/X\n&quot; +
273         &quot;6Xasb7QE2QWEIlq+78AaV9Dwc7qk1TuBsN05LbQUSe7h5UAfS4AZ5l/XSay2cxrZ\n&quot; +
274         &quot;TKoyuzh9kj38QkEBxZlrClyBzU8Mct0L9F8yEm4V7AqQOshn9gEQl9lzJUb2KHeZ\n&quot; +
275         &quot;AxblrQhPQDrWhmQjQkl/xaiOiU31sHKTnB/L2CKvJtmsKIyBdrQCQTlIOcRu4/PQ\n&quot; +
276         &quot;4z/sjecKP08Xkf5+p4RzPL+OZHkJoejSEjBndLC8BK9IZD94kHZYDz8ulWrQJ5Nr\n&quot; +
277         &quot;u/inkyf8NcG7zLBJJyuKfUXO/OzGPD5QMviVc+PCGTY=\n&quot; +
278         &quot;-----END CERTIFICATE-----&quot;;
279     static String serverPrivateKey = // Private key in the format of PKCS#8
280         &quot;MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCaDgoxN2UQQero\n&quot; +
281         &quot;oBQ4JlQP1BFaZEtIkdIU2VJs4whz85J0LSB/68iEOS5e8wCz9wiQWr4isor7sl3e\n&quot; +
282         &quot;B2dnLGY28BthOTw2j/CYw/dRqyDbPZniooB233uLGarKjqQWXpRFQi6bgEQmNqWe\n&quot; +
283         &quot;C32w+V+Oq3CTkinwgPvA5mnSe0P8gpF9NLZBFn0TtxaY0bQIie2WNk/HjrVQIhq3\n&quot; +
284         &quot;qmG/zVxeBc3PVOOU/OKrwjHbim9YI+zdDRXjNm8siHi0RF2+fkxfyAm8Qg+mT8L4\n&quot; +
285         &quot;xdtr0a+eP4oIvkymRURxIrXNnvoX+MhYKSOQnizpW0NMOZ5L9nyw1cYX8j9Ed6eM\n&quot; +
286         &quot;kzxZwRrlAgMBAAECggEBAIPF4p36ni3r1H2q/+CPmHP5l+ZTx7mJUcOXqNOO11on\n&quot; +
287         &quot;TGyndRc2ncvMBYgeH8nQUrj3hY+0XQGyrmwOtTohVkVD2IevJ3wcX1asuU5YLMCb\n&quot; +
288         &quot;zpd3HJ+RxeFT0S12GZEw0W70j11ft+tf7wZjGd5ZUI1+w8rWyZz5F18HOBlcauj/\n&quot; +
289         &quot;iqMgrlVLZ7qXEb6WV9zP5hWx5nZwrnuuiM1zXLVuO9rg7qk+zCts2oyM8KRTfQIi\n&quot; +
290         &quot;Zo3VDO0nwnEoxxTQ/2g2g/jBJ1GiFygiFm/i2SHQOJgaFS3Y3InjWEAiINIsdMIt\n&quot; +
291         &quot;yZk6twMG6ODjy8agZ4LLhZSyCkC33AN7MIkSCtvFubkCgYEAyRm+yvYxwiHCzZV8\n&quot; +
292         &quot;LZNuBBRliujgG41iuyUyRVBSaMyJMNRoOMm8XwDOF1BA44YPz4yCkfiiEk2ub/f0\n&quot; +
293         &quot;hDhfBW3EWvYHrWkEbx9Th2YmFq20JlgcBGaM2TiiL+qx4ct687idPbJVZnwc4HtR\n&quot; +
294         &quot;Kc0eTwRlFsf2O3rwIy52mvIf/48CgYEAxBxsllVz7+/nm0UcxwHNDN+bPyDBxsu9\n&quot; +
295         &quot;QuSyR+zSnfcL6xaS4SClBLKxHSjbJ2Hi+UOXezO+eozDp/zEFI6BygNRKTaLTVKr\n&quot; +
296         &quot;ezk9rbyKydRIXNlxFoX07U0KlD4lCrbrpsvcO/OlzJe6q5R0B/CIQmx2Y4wlRrE/\n&quot; +
297         &quot;Tu+hsf3tBEsCgYBBltsKmXerKJW/tbS1rLMiM4DW6JNHiTqdbUlTIBpwwd0xBuYj\n&quot; +
298         &quot;N3Dvz3RoWC2Bx9TaTaq8b0p1C88MB+RBR51+SMnVHQ9t+KWQlLgKnj9oACmUpAIn\n&quot; +
299         &quot;UUc5BeaoGDUCPvqQCTOHzuVZsrs8YBwdtR/gh79sybU+ux8damcWrEfRcwKBgEsU\n&quot; +
300         &quot;HrZHLMWU8PROtz+w/tGI4aR/Y/A5m9F6QI6sqc10AQoVcFHj74km6Auj0pL3NK/9\n&quot; +
301         &quot;Ioc2Phwou9caO+8qx6GRN4cxrI8DsUbRmT1kSzYNoU56qILY8fXPYtdyGzhI41rN\n&quot; +
302         &quot;/RiupLD4/awmf21ytpfHcmOWCcdQoE4WC69a6VyVAoGAboeogM5/TRKj80rXfUH2\n&quot; +
303         &quot;lFZzgX246XGwNyOVVgOuv/Oxa61b5FeeCpnFQcjpZmC5vd63X3w7oYSDe2wUt+Wh\n&quot; +
304         &quot;LhYunmcCEj+yb3of33loQb/FM2OLW9UoQakB7ewio9vtw+BAnWxnHFkEaqdxMXpy\n&quot; +
305         &quot;TiSXLpQ1Q9GvDpzngDzJzzY=&quot;;
306 
307     // Certificate information:
308     // Issuer: C=US, O=Java, OU=SunJSSE Test Serivce, CN=certissuer
309     // Validity
310     //     Not Before: Dec 20 14:21:29 2019 GMT
311     //     Not After : Dec 17 14:21:29 2029 GMT
312     // Subject: C=US, O=Java, OU=SunJSSE Test Serivce, CN=InterOp Tester
313     // X509v3 Subject Key Identifier:
314     //     1F:E4:C0:F5:B8:68:DB:D2:EB:9E:6F:BB:B5:9E:92:6D:BA:7D:97:3A
315     // X509v3 Authority Key Identifier:
316     //     keyid:B4:E8:EA:80:A9:2B:F5:62:B5:2C:A6:F8:FF:65:BC:CF:51:40:9C:15
317     static String clientCertStr =
318         &quot;-----BEGIN CERTIFICATE-----\n&quot; +
319         &quot;MIIDgTCCAmmgAwIBAgIUHFQOStLURT5sQ57OWO2z8iNJ9P8wDQYJKoZIhvcNAQEL\n&quot; +
320         &quot;BQAwUDELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEphdmExHTAbBgNVBAsMFFN1bkpT\n&quot; +
321         &quot;U0UgVGVzdCBTZXJpdmNlMRMwEQYDVQQDDApjZXJ0aXNzdWVyMB4XDTE5MTIyMDE0\n&quot; +
322         &quot;MjEyOVoXDTI5MTIxNzE0MjEyOVowVDELMAkGA1UEBhMCVVMxDTALBgNVBAoMBEph\n&quot; +
323         &quot;dmExHTAbBgNVBAsMFFN1bkpTU0UgVGVzdCBTZXJpdmNlMRcwFQYDVQQDDA5JbnRl\n&quot; +
324         &quot;ck9wIFRlc3RlcjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMXA3NV+\n&quot; +
325         &quot;pDnwnQgXFQ7WeDtcTe4qDQV9tDj9cRZFqQXo94C30lkuXzdH761bZB84DESV0qLI\n&quot; +
326         &quot;k6/n+D9SOsg7SPe7uejG24rph/VpPANrPXo8jxwh/KW+8y0pYNigFUZDi+mEDAOG\n&quot; +
327         &quot;gyqaAbahQePDYTa09uY3MTTOcaUnKZEJkfVZnmrwmcH7qapCCz0N4Mv6Xddi87Fk\n&quot; +
328         &quot;j9R225XXW5ZZ+jwVGi1WubjxqLpbQo9VwdTgozBfxwzjQQWDOlUIics3RRaV4Yz0\n&quot; +
329         &quot;F3Sr4xZiq09O4x8ZT8jrQgduzVZhWjc7rHHbBeMmVBhOveSCvu54onZ2Y+G7+xU/\n&quot; +
330         &quot;Zc1Z6s2Wb5N2I40CAwEAAaNPME0wHQYDVR0OBBYEFB/kwPW4aNvS655vu7Wekm26\n&quot; +
331         &quot;fZc6MB8GA1UdIwQYMBaAFLTo6oCpK/VitSym+P9lvM9RQJwVMAsGA1UdDwQEAwID\n&quot; +
332         &quot;6DANBgkqhkiG9w0BAQsFAAOCAQEAdgWs2wVkPoOrShdYTJM2/v7sDYENCsj3VGEq\n&quot; +
333         &quot;NvTeL98FCjRZhRmozVi0mli6z2LjDM/858vZoJWDJ08O0XvhXT4yJWWHCJz4xTY1\n&quot; +
334         &quot;GBern25Y8VjZGUwAIzK3EDjYzJCZpbhBREF8XZx46OxHt04BKtQwJKBtpJ1/6bRS\n&quot; +
335         &quot;wvia3wGspFLW78P2Y5rFXzqptaqBD06Dcc4xBgvFLSocSKUzLc8BdNsixtPBQZNs\n&quot; +
336         &quot;l3X3TUNYoYW677E7EWO8NHUJg+2Qbpo11tkb0AyScSxOu2aHuPfYIchRZXnDdq20\n&quot; +
337         &quot;tL85OZz8ov7d2jVet/w7FD4M5XfcogsNtpX4kaMsctyvQbDYRA==\n&quot; +
338         &quot;-----END CERTIFICATE-----&quot;;
339     static String clientPrivateKey = // Private key in the format of PKCS#8
340         &quot;MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDFwNzVfqQ58J0I\n&quot; +
341         &quot;FxUO1ng7XE3uKg0FfbQ4/XEWRakF6PeAt9JZLl83R++tW2QfOAxEldKiyJOv5/g/\n&quot; +
342         &quot;UjrIO0j3u7noxtuK6Yf1aTwDaz16PI8cIfylvvMtKWDYoBVGQ4vphAwDhoMqmgG2\n&quot; +
343         &quot;oUHjw2E2tPbmNzE0znGlJymRCZH1WZ5q8JnB+6mqQgs9DeDL+l3XYvOxZI/UdtuV\n&quot; +
344         &quot;11uWWfo8FRotVrm48ai6W0KPVcHU4KMwX8cM40EFgzpVCInLN0UWleGM9Bd0q+MW\n&quot; +
345         &quot;YqtPTuMfGU/I60IHbs1WYVo3O6xx2wXjJlQYTr3kgr7ueKJ2dmPhu/sVP2XNWerN\n&quot; +
346         &quot;lm+TdiONAgMBAAECggEBAK3PX8n+L1YFl9++efG6q55w+MX2C8/htn/IspbCz1a0\n&quot; +
347         &quot;dqWZ67YavfGWtqCGDTArUQ0PKj2NUdFwb48oNSY8hVvIkhR4hApKTAd1YRwYK8a+\n&quot; +
348         &quot;Z4JwlOERPidZkReVTF2fjN/IAc8vcSYGiq78eS85UL6Gu+OIayVgth5Ul4I1CSa8\n&quot; +
349         &quot;+b0n/RAI+yk2HxKlkq40Ofn0VWiGg1dLP2MPwwPNIk+w7nKUysfPmXCHfyBr+CZv\n&quot; +
350         &quot;1BQ0E/tVau9wsyCjO6wxFsAKteBGdYa0ToEeT0D8MEeY9leKhAAxRneBVCz9AfHj\n&quot; +
351         &quot;wMGYucxwL0cDLi1IjZB5wlvm5JPqNCKrkHE2XE+UyTkCgYEA/iNP11cqHNPItoXP\n&quot; +
352         &quot;D2wN4uX60kLNbzZ2dOF1ItybS8OcQvTxA1XulARiCVDIT/+QDETbDQclfhgMOfhe\n&quot; +
353         &quot;ZCdMrL5RG0YTwg9OGbLcA+8gqd9e/3gs9g8pWNdCfuGIwsnJbpO7iBoCBzHaHHJJ\n&quot; +
354         &quot;PbWDFS6jxvsqKIGPPwrhL9yp4VMCgYEAxzPKNLclBHorUs9rYRqiG9NTkLRNx4ll\n&quot; +
355         &quot;LUh0FBItOnG85BxkjQaIlzimNvXZEzZnpOtblugAszxFyq2KTEE9qeB/V3w3FkXi\n&quot; +
356         &quot;PSpDG5sdRHnl5Qu4PuQ9WsmN7g193tOEdtWQ4NKxPqlC72ehqVDOY7In2quYLUiq\n&quot; +
357         &quot;C377esv0658CgYAJ0I1N0LT0pg0zV1mWy+KBZ8ZXBnNunxjWDLr8XK62r1hCkbkZ\n&quot; +
358         &quot;GuF63+x1VaRWypTilGotR6BgDUezmW7zyTzB0xvIxN0QeozWmzy5/isxxEmj7h02\n&quot; +
359         &quot;Z4F+R9nukoE4nJhl59ivOenoIzm8LYG8m1zznXh/v8VyCQbiNWZa9dettwKBgQDB\n&quot; +
360         &quot;Yz4DP2noltJIaqXMd5a5fMe7y89Wz8Qx2g0XDy5pdtHygr37S0R/yrdS1AoR5Ndp\n&quot; +
361         &quot;/DPGpSVI3FLFGQUSUqQSr6fwvt6b+OxShRzxR/155P2TB3WvWNVXtiTb3q08Dgyj\n&quot; +
362         &quot;cWJdYS5BrwEUen8vaQt1LhgS6lOqYsjysCxkYm078QKBgEJuq4RzecgiGx8srWDb\n&quot; +
363         &quot;pQKpxrdEt82Y7OXLVj+W9vixcW/xUYhDYGsfdUigZoOjo4nV8KVmMbuI48PIYwnw\n&quot; +
364         &quot;haLwWrBWlki4x9MRwuZUdewOYoo7hDZToZmIDescdiwv8CA/Dg9kOX3YYLPW+cWl\n&quot; +
365         &quot;i1pnyMPaloBOhz3Y07sWXxCz&quot;;
366 
367     static char passphrase[] = &quot;passphrase&quot;.toCharArray();
368 
369     /*
370      * Is the server ready to serve?
371      */
372     volatile static boolean serverReady = false;
373 
374     /*
375      * Turn on SSL debugging?
376      */
377     static boolean debug = false;
378 
379     /*
380      * Define the server side of the test.
381      *
382      * If the server prematurely exits, serverReady will be set to true
383      * to avoid infinite hangs.
384      */
385     void doServerSide() throws Exception {
386         SSLContext context = getSSLContext(true);
387         SSLServerSocketFactory sslssf = context.getServerSocketFactory();
388 
389         SSLServerSocket sslServerSocket =
390                 (SSLServerSocket) sslssf.createServerSocket(serverPort);
391         serverPort = sslServerSocket.getLocalPort();
392         SSLSocket sslSocket = null;
393         try {
394             /*
395              * Signal Client, we&#39;re ready for his connect.
396              */
397             serverReady = true;
398 
399             sslSocket = (SSLSocket) sslServerSocket.accept();
400             sslSocket.setNeedClientAuth(true);
401 
402             InputStream sslIS = sslSocket.getInputStream();
403             OutputStream sslOS = sslSocket.getOutputStream();
404 
405             sslIS.read();
406             sslOS.write(85);
407             sslOS.flush();
408         } finally {
409             if (sslSocket != null) {
410                 sslSocket.close();
411             }
412             sslServerSocket.close();
413         }
414     }
415 
416     /*
417      * Define the client side of the test.
418      *
419      * If the server prematurely exits, serverReady will be set to true
420      * to avoid infinite hangs.
421      */
422     void doClientSide() throws Exception {
423         /*
424          * Wait for server to get started.
425          */
426         while (!serverReady) {
427             Thread.sleep(50);
428         }
429 
430         SSLContext context = getSSLContext(false);
431         SSLSocketFactory sslsf = context.getSocketFactory();
432 
433         SSLSocket sslSocket =
434                 (SSLSocket) sslsf.createSocket(&quot;localhost&quot;, serverPort);
435         try {
436             InputStream sslIS = sslSocket.getInputStream();
437             OutputStream sslOS = sslSocket.getOutputStream();
438 
439             sslOS.write(280);
440             sslOS.flush();
441             sslIS.read();
442         } finally {
443             sslSocket.close();
444         }
445     }
446 
447     // get the ssl context
448     private static SSLContext getSSLContext(boolean isServer) throws Exception {
449 
450         // generate certificate from cert string
451         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
452 
453         // create a key store
454         KeyStore ks = KeyStore.getInstance(&quot;JKS&quot;);
455         ks.load(null, null);
456 
457         // import the trused cert
458         ByteArrayInputStream is =
459             new ByteArrayInputStream(trusedCertStr.getBytes());
460         Certificate trusedCert = cf.generateCertificate(is);
461         is.close();
462 
463         ks.setCertificateEntry(&quot;SunJSSE Test Serivce&quot;, trusedCert);
464 
465         // import the certificate chain and key
466         Certificate[] chain = new Certificate[3];
467 
468         is = new ByteArrayInputStream(caSignerStr.getBytes());
469         Certificate caSignerCert = cf.generateCertificate(is);
470         is.close();
471         chain[2] = caSignerCert;
472 
473         is = new ByteArrayInputStream(certIssuerStr.getBytes());
474         Certificate certIssuerCert = cf.generateCertificate(is);
475         is.close();
476         chain[1] = certIssuerCert;
477 
478         PKCS8EncodedKeySpec priKeySpec = null;
479         if (isServer) {
480             priKeySpec = new PKCS8EncodedKeySpec(
481                             Base64.getMimeDecoder().decode(serverPrivateKey));
482             is = new ByteArrayInputStream(serverCertStr.getBytes());
483         } else {
484             priKeySpec = new PKCS8EncodedKeySpec(
485                             Base64.getMimeDecoder().decode(clientPrivateKey));
486             is = new ByteArrayInputStream(clientCertStr.getBytes());
487         }
488         KeyFactory kf = KeyFactory.getInstance(&quot;RSA&quot;);
489         RSAPrivateKey priKey = (RSAPrivateKey)kf.generatePrivate(priKeySpec);
490         Certificate keyCert = cf.generateCertificate(is);
491         is.close();
492         chain[0] = keyCert;
493 
494         ks.setKeyEntry(&quot;End Entity&quot;, priKey, passphrase, chain);
495 
496         // check the certification path
497         PKIXParameters paras = new PKIXParameters(ks);
498         paras.setRevocationEnabled(false);
499         CertPath path = cf.generateCertPath(Arrays.asList(chain));
500         CertPathValidator cv = CertPathValidator.getInstance(&quot;PKIX&quot;);
501         cv.validate(path, paras);
502 
503         // create SSL context
504         TrustManagerFactory tmf = TrustManagerFactory.getInstance(tmAlgorithm);
505         tmf.init(ks);
506 
507         SSLContext ctx = SSLContext.getInstance(&quot;TLS&quot;);
508         KeyManagerFactory kmf = KeyManagerFactory.getInstance(&quot;NewSunX509&quot;);
509         kmf.init(ks, passphrase);
510 
511         ctx.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);
512         ks = null;
513 
514         return ctx;
515     }
516 
517     private static String tmAlgorithm;        // trust manager
518 
519     private static void parseArguments(String[] args) {
520         tmAlgorithm = args[0];
521     }
522 
523     /*
524      * =============================================================
525      * The remainder is just support stuff
526      */
527 
528     // use any free port by default
529     volatile int serverPort = 0;
530 
531     volatile Exception serverException = null;
532     volatile Exception clientException = null;
533 
534     public static void main(String args[]) throws Exception {
535         if (debug)
536             System.setProperty(&quot;javax.net.debug&quot;, &quot;all&quot;);
537 
538         /*
539          * Get the customized arguments.
540          */
541         parseArguments(args);
542 
543         /*
544          * Start the tests.
545          */
546         new BasicConstraints();
547     }
548 
549     Thread clientThread = null;
550     Thread serverThread = null;
551     /*
552      * Primary constructor, used to drive remainder of the test.
553      *
554      * Fork off the other side, then do your work.
555      */
556     BasicConstraints() throws Exception {
557         if (separateServerThread) {
558             startServer(true);
559             startClient(false);
560         } else {
561             startClient(true);
562             startServer(false);
563         }
564 
565         /*
566          * Wait for other side to close down.
567          */
568         if (separateServerThread) {
569             serverThread.join();
570         } else {
571             clientThread.join();
572         }
573 
574         /*
575          * When we get here, the test is pretty much over.
576          *
577          * If the main thread excepted, that propagates back
578          * immediately.  If the other thread threw an exception, we
579          * should report back.
580          */
581         if (serverException != null)
582             throw serverException;
583         if (clientException != null)
584             throw clientException;
585     }
586 
587     void startServer(boolean newThread) throws Exception {
588         if (newThread) {
589             serverThread = new Thread() {
590                 public void run() {
591                     try {
592                         doServerSide();
593                     } catch (Exception e) {
594                         /*
595                          * Our server thread just died.
596                          *
597                          * Release the client, if not active already...
598                          */
599                         System.err.println(&quot;Server died...&quot;);
600                         serverReady = true;
601                         serverException = e;
602                     }
603                 }
604             };
605             serverThread.start();
606         } else {
607             doServerSide();
608         }
609     }
610 
611     void startClient(boolean newThread) throws Exception {
612         if (newThread) {
613             clientThread = new Thread() {
614                 public void run() {
615                     try {
616                         doClientSide();
617                     } catch (Exception e) {
618                         /*
619                          * Our client thread just died.
620                          */
621                         System.err.println(&quot;Client died...&quot;);
622                         clientException = e;
623                     }
624                 }
625             };
626             clientThread.start();
627         } else {
628             doClientSide();
629         }
630     }
631 }
    </pre>
  </body>
</html>