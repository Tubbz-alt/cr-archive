<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/ssl/CipherSuite/RestrictSignatureScheme.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8226374
 27  * @library /javax/net/ssl/templates
 28  * @summary Restrict signature algorithms and named groups
 29  * @run main/othervm RestrictSignatureScheme
 30  */
 31 import java.io.ByteArrayInputStream;
 32 import java.security.KeyFactory;
 33 import java.security.KeyStore;
 34 import java.security.PrivateKey;
 35 import java.security.Security;
 36 import java.security.cert.Certificate;
 37 import java.security.cert.CertificateFactory;
 38 import java.security.spec.PKCS8EncodedKeySpec;
 39 import java.util.Arrays;
 40 import java.util.Base64;
 41 import javax.net.ssl.KeyManagerFactory;
 42 import javax.net.ssl.SSLContext;
 43 import javax.net.ssl.SSLSocket;
 44 import javax.net.ssl.SSLServerSocket;
 45 import javax.net.ssl.TrustManagerFactory;
 46 import javax.net.ssl.SSLException;
 47 
 48 public class RestrictSignatureScheme extends SSLSocketTemplate {
 49 
 50     private static volatile int index;
 51     private static final String[][][] protocols = {
 52         {{&quot;TLSv1.3&quot;}, {&quot;TLSv1.3&quot;}},
 53         {{&quot;TLSv1.3&quot;, &quot;TLSv1.2&quot;}, {&quot;TLSv1.2&quot;}},
 54         {{&quot;TLSv1.3&quot;, &quot;TLSv1.2&quot;}, {&quot;TLSv1.2&quot;}},
 55         {{&quot;TLSv1.2&quot;}, {&quot;TLSv1.3&quot;, &quot;TLSv1.2&quot;}},
 56         {{&quot;TLSv1.2&quot;}, {&quot;TLSv1.2&quot;}}
 57     };
 58 
 59     private final SSLContext context;
 60     RestrictSignatureScheme() throws Exception {
 61         this.context = createSSLContext();
 62     }
 63 
 64     @Override
 65     protected SSLContext createClientSSLContext() throws Exception {
 66         return context;
 67     }
 68 
 69     @Override
 70     protected SSLContext createServerSSLContext() throws Exception {
 71         return context;
 72     }
 73 
 74     // Servers are configured before clients, increment test case after.
 75     @Override
 76     protected void configureClientSocket(SSLSocket socket) {
 77         String[] ps = protocols[index][0];
 78 
 79         System.out.print(&quot;Setting client protocol(s): &quot;);
 80         Arrays.stream(ps).forEachOrdered(System.out::print);
 81         System.out.println();
 82 
 83         socket.setEnabledProtocols(ps);
 84         socket.setEnabledCipherSuites(new String[] {
 85             &quot;TLS_AES_128_GCM_SHA256&quot;,
 86             &quot;TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256&quot;});
 87     }
 88 
 89     @Override
 90     protected void configureServerSocket(SSLServerSocket serverSocket) {
 91         String[] ps = protocols[index][1];
 92 
 93         System.out.print(&quot;Setting server protocol(s): &quot;);
 94         Arrays.stream(ps).forEachOrdered(System.out::print);
 95         System.out.println();
 96 
 97         serverSocket.setEnabledProtocols(ps);
 98         serverSocket.setEnabledCipherSuites(new String[] {
 99             &quot;TLS_AES_128_GCM_SHA256&quot;,
100             &quot;TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256&quot;});
101     }
102 
103     /*
104      * Run the test case.
105      */
106     public static void main(String[] args) throws Exception {
107         Security.setProperty(&quot;jdk.tls.disabledAlgorithms&quot;, &quot;RSASSA-PSS&quot;);
108 
109         for (index = 0; index &lt; protocols.length; index++) {
110             try {
111                 (new RestrictSignatureScheme()).run();
112             } catch (SSLException | IllegalStateException ssle) {
113                 // The named group should be restricted.
114                 continue;
115             }
116 
117             throw new Exception(&quot;The test case should be disabled&quot;);
118         }
119     }
120 
121 
122     private static final String trustedCertStr =
123         /**
124         * Signature Algorithm: rsassaPss
125         * Issuer: CN = localhost
126         * Validity Not Before: Jun 6 07:11:00 2018 GMT
127         * Not After : Jun 1 07:11:00 2038 GMT
128         * Subject: CN = localhost
129         * Public Key Algorithm: rsassaPss
130         */
131        &quot;-----BEGIN CERTIFICATE-----\n&quot;
132        + &quot;MIIDZjCCAh2gAwIBAgIUHxwPs3eAgJ057nJwiLgWZWeNqdgwPgYJKoZIhvcNAQEK\n&quot;
133        + &quot;MDGgDTALBglghkgBZQMEAgGhGjAYBgkqhkiG9w0BAQgwCwYJYIZIAWUDBAIBogQC\n&quot;
134        + &quot;AgDeMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDAeFw0xODA2MDYwNzExMDBaFw0zODA2\n&quot;
135        + &quot;MDEwNzExMDBaMBQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASAwCwYJKoZIhvcNAQEK\n&quot;
136        + &quot;A4IBDwAwggEKAoIBAQCl8r4Qrg27BYUO/1Va2Ix8QPGzN/lvzmKvP5Ff26ovNW4v\n&quot;
137        + &quot;RUx68HzAhhiWtcl+PwLSbJqJreEkTlle7PnRAypby3fO7ZAK0Y3YiHquaBg7d+7Y\n&quot;
138        + &quot;FhhHwv8gG0lZcyA0BkXFJHqdq76qar0xHC6DVezXm0K3mcceymGtFR9BzWmAj+7D\n&quot;
139        + &quot;YsSwvtTQ7WNoQmf0cdDMSM71IwaTwIwvT2wzX1vv5hcdDyXdr64WFqWSA9sNJ2K6\n&quot;
140        + &quot;arxaaU1klwKSgDokF6njafWQ4UxdR67d5W1MYoiioDs2Yy3utsMpO2OUzZVBZNdT\n&quot;
141        + &quot;gkr1jsJhIurpz/5K51lwJIRQBezEFSb+60AFVoMJAgMBAAGjUDBOMB0GA1UdDgQW\n&quot;
142        + &quot;BBQfFit5ilWJmZgCX4QY0HsaI9iIDDAfBgNVHSMEGDAWgBQfFit5ilWJmZgCX4QY\n&quot;
143        + &quot;0HsaI9iIDDAMBgNVHRMEBTADAQH/MD4GCSqGSIb3DQEBCjAxoA0wCwYJYIZIAWUD\n&quot;
144        + &quot;BAIBoRowGAYJKoZIhvcNAQEIMAsGCWCGSAFlAwQCAaIEAgIA3gOCAQEAa4yUQ3gh\n&quot;
145        + &quot;d1YWPdEa1sv2hdkhtenw6m5yxbmaQl2+nIKSpk4RfpXC7K1EYwBF8TdfFbD8hGGh\n&quot;
146        + &quot;5n81BT0/dn1R9SRGCv7KTxx4lfQt31frlsw/tVciwyXQtcUZ6DqfnLP0/aRVLNgx\n&quot;
147        + &quot;zaP542JUHFYLTC3EGz2zUgv70ZUTlIsPG3/p8YO1iXdnYGQyzOuQPUBpI7nS7UtR\n&quot;
148        + &quot;Ug8VE9ACpBxxI3qChMahFZGHlXCCSjSmxpQa6UO4SQl8q5tPNnqdzWwvAW8qkCy4\n&quot;
149        + &quot;6barRQ4sMcGayhHh/uSTx7bcl0FMJpcI1ygbw7/Pc03zKtw0gMTBMns7q4yXjb/u\n&quot;
150        + &quot;ef47nW0t+LRAAg==\n&quot;
151        + &quot;-----END CERTIFICATE-----\n&quot;;
152 
153     private static final String keyCertStr = trustedCertStr;
154 
155     private static final String privateKey =
156         &quot;MIIEuwIBADALBgkqhkiG9w0BAQoEggSnMIIEowIBAAKCAQEApfK+EK4NuwWFDv9V\n&quot;
157         + &quot;WtiMfEDxszf5b85irz+RX9uqLzVuL0VMevB8wIYYlrXJfj8C0myaia3hJE5ZXuz5\n&quot;
158         + &quot;0QMqW8t3zu2QCtGN2Ih6rmgYO3fu2BYYR8L/IBtJWXMgNAZFxSR6nau+qmq9MRwu\n&quot;
159         + &quot;g1Xs15tCt5nHHsphrRUfQc1pgI/uw2LEsL7U0O1jaEJn9HHQzEjO9SMGk8CML09s\n&quot;
160         + &quot;M19b7+YXHQ8l3a+uFhalkgPbDSdiumq8WmlNZJcCkoA6JBep42n1kOFMXUeu3eVt\n&quot;
161         + &quot;TGKIoqA7NmMt7rbDKTtjlM2VQWTXU4JK9Y7CYSLq6c/+SudZcCSEUAXsxBUm/utA\n&quot;
162         + &quot;BVaDCQIDAQABAoIBAAc4vRS0vlw5LUUtz2UYr2Ro3xvRf8Vh0eGWfpkRUiKjzJu6\n&quot;
163         + &quot;BE4FUSh/rWpBlvcrfs/xcfgz3OxbjIAZB/YUkS9Vd21F4VLXM7kMl2onlYZg/b/h\n&quot;
164         + &quot;lkTpM3kONu7xl6Er9LVTlRJveuinpHwSoeONRbVMSGb9BjFM1VtW4/lVGxZBG05D\n&quot;
165         + &quot;y9i/o4vCZqULn9cAumOwicKuCyTcS58XcMJ+puSPfRA71PYLxqFkASAoJsUwCXpo\n&quot;
166         + &quot;gs39lLsIFgrfO8mBO1ux/SE+QaRc+9XqFSHHKD1XqF/9zSYBgWjE910EcpdYEdZx\n&quot;
167         + &quot;GEkwea7Fn4brO5OpIrHY/45naqbUOBzv6gufMAECgYEAz7PHCdcrQvmOb8EiNbQH\n&quot;
168         + &quot;uvSimwObWJFeN1ykp6mfRbSnkXw7p8+M4Tc8HFi8QLpoq63Ev2AwoaQCQvHbFC2Y\n&quot;
169         + &quot;1Cz0EkC0aOp+tZP7U2AUBdkcDesZAJQTad0zV6KesyIUXdxZXDG8JJ1XSNWfTJV4\n&quot;
170         + &quot;QD+BjLZ0jiAyCIfVYvWQqYkCgYEAzIln1nKTixLMPr5CldSmR7ZarEtPJU+hHwVg\n&quot;
171         + &quot;dV/Lc6d2Yy9JgunOXRo4BXB1TEo8JFbK3HBQH6tS8li4qDr7WK5wyYfh8qb4WZyu\n&quot;
172         + &quot;lc562f2WVYntcN8/Ojb+Vyrt7lk9sq/8KoVHxEAWd6mqL9VTPYuAu1Vw9fTGIZfB\n&quot;
173         + &quot;lDeELYECgYAvdzU4UXzofGGJtohb332YwwlaBZP9xJLUcg6K5l+orWVSASMc8XiP\n&quot;
174         + &quot;i3DoRXsYC8GZ4kdBOPlEJ1gA9oaLcPQpIPDSLwlLpLM6Scw4vI822uvnXl/DWxOo\n&quot;
175         + &quot;sM1n7Jj59QLUhGPDhvYpI+/rjC4wcUQe4qR3hMbUKBVnD6u7RsU9iQKBgQCQ17VK\n&quot;
176         + &quot;7bSCRfuRaxaoGADww7gOTv5rQ6qr1xjpxb7D1hFGR9Rc+smCsPB/GZZXQjK44SWj\n&quot;
177         + &quot;WX3ED4Ubzaxmpe4cbNu+O5XMSmWQwB36RFBHUwdE5/nXdqDFzu/qNqJrqZLBmVKP\n&quot;
178         + &quot;ofaiiWffsaytVvotmT6+atElvAMbAua42V+nAQKBgHtIn3mYMHLriYGhQzpkFEA2\n&quot;
179         + &quot;8YcAMlKppueOMAKVy8nLu2r3MidmLAhMiKJQKG45I3Yg0/t/25tXLiOPJlwrOebh\n&quot;
180         + &quot;xQqUBI/JUOIpGAEnr48jhOXnCS+i+z294G5U/RgjXrlR4bCPvrtCmwzWwe0h79w2\n&quot;
181         + &quot;Q2hO5ZTW6UD9CVA85whf&quot;;
182 
183     private static SSLContext createSSLContext() throws Exception {
184         // Generate certificate from cert string
185         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
186 
187         // Create a key store
188         KeyStore ts = KeyStore.getInstance(&quot;PKCS12&quot;);
189         KeyStore ks = KeyStore.getInstance(&quot;PKCS12&quot;);
190         ts.load(null, null);
191         ks.load(null, null);
192         char passphrase[] = &quot;passphrase&quot;.toCharArray();
193 
194         // Import the trusted cert
195         ts.setCertificateEntry(&quot;trusted-cert-RSASSA-PSS&quot;,
196                 cf.generateCertificate(new ByteArrayInputStream(
197                         trustedCertStr.getBytes())));
198 
199         boolean hasKeyMaterials = keyCertStr != null &amp;&amp; privateKey != null;
200         if (hasKeyMaterials) {
201 
202             // Generate the private key.
203             PKCS8EncodedKeySpec priKeySpec = new PKCS8EncodedKeySpec(
204                     Base64.getMimeDecoder().decode(privateKey));
205             KeyFactory kf = KeyFactory.getInstance(&quot;RSASSA-PSS&quot;);
206             PrivateKey priKey = kf.generatePrivate(priKeySpec);
207 
208             // Generate certificate chain
209             Certificate keyCert = cf.generateCertificate(
210                     new ByteArrayInputStream(keyCertStr.getBytes()));
211             Certificate[] chain = new Certificate[]{keyCert};
212 
213             // Import the key entry.
214             ks.setKeyEntry(&quot;cert-RSASSA-PSS&quot;, priKey, passphrase, chain);
215         }
216 
217         // Create SSL context
218         TrustManagerFactory tmf = TrustManagerFactory.getInstance(&quot;PKIX&quot;);
219         tmf.init(ts);
220 
221         SSLContext context = SSLContext.getInstance(&quot;TLS&quot;);
222         if (hasKeyMaterials) {
223             KeyManagerFactory kmf = KeyManagerFactory.getInstance(&quot;NewSunX509&quot;);
224             kmf.init(ks, passphrase);
225             context.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);
226         } else {
227             context.init(null, tmf.getTrustManagers(), null);
228         }
229 
230         return context;
231     }
232 }
    </pre>
  </body>
</html>