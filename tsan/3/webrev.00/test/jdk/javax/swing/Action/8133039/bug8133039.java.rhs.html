<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/javax/swing/Action/8133039/bug8133039.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.awt.Robot;
 25 import java.awt.event.ActionEvent;
 26 import java.awt.event.KeyEvent;
 27 import javax.swing.AbstractAction;
 28 import javax.swing.Action;
 29 import javax.swing.JComboBox;
 30 import javax.swing.JFrame;
 31 import javax.swing.JLabel;
 32 import javax.swing.KeyStroke;
 33 import javax.swing.SwingUtilities;
 34 import sun.swing.UIAction;
 35 
 36 /**
 37  * @test
 38  * @key headful
 39  * @bug 8133039
 40  * @summary Provide public API to sun.swing.UIAction#isEnabled(Object)
 41  * @modules java.desktop/sun.swing
 42  * @author Alexander Scherbatiy
 43  */
 44 public class bug8133039 {
 45 
 46     private static volatile int ACTION_PERFORMED_CALLS = 0;
 47     private static volatile int ACTION_ACCEPTED_CALLS = 0;
<a name="1" id="anc1"></a><span class="line-added"> 48     private static JFrame frame;</span>
 49 
 50     public static void main(String[] args) throws Exception {
<a name="2" id="anc2"></a><span class="line-modified"> 51         try {</span>
<span class="line-modified"> 52             testActionNotification();</span>
<span class="line-added"> 53             testPopupAction();</span>
<span class="line-added"> 54         } finally {</span>
<span class="line-added"> 55             if (frame != null) SwingUtilities.invokeAndWait(() -&gt; frame.dispose());</span>
<span class="line-added"> 56         }</span>
 57     }
 58 
 59     private static void testActionNotification() {
 60 
 61         KeyEvent keyEvent = new KeyEvent(new JLabel(&quot;Test&quot;), 0, 0, 0, 0, &#39;A&#39;);
 62         SenderObject rejectedSenderObject = new SenderObject();
 63         SwingUtilities.notifyAction(new TestAction(false), null, keyEvent,
 64                 rejectedSenderObject, 0);
 65 
 66         if (rejectedSenderObject.accepted) {
 67             throw new RuntimeException(&quot;The sender is incorrectly accepted!&quot;);
 68         }
 69 
 70         if (rejectedSenderObject.performed) {
 71             throw new RuntimeException(&quot;The action is incorrectly performed!&quot;);
 72         }
 73 
 74         SenderObject acceptedSenderObject = new SenderObject();
 75         SwingUtilities.notifyAction(new TestAction(true), null, keyEvent,
 76                 acceptedSenderObject, 0);
 77 
 78         if (!acceptedSenderObject.accepted) {
 79             throw new RuntimeException(&quot;The sender is not accepted!&quot;);
 80         }
 81 
 82         if (!acceptedSenderObject.performed) {
 83             throw new RuntimeException(&quot;The action is not performed!&quot;);
 84         }
 85     }
 86 
 87     private static void testPopupAction() throws Exception {
 88 
 89         SwingUtilities.invokeAndWait(bug8133039::createAndShowGUI);
 90 
 91         Robot robot = new Robot();
 92         robot.setAutoDelay(50);
 93         robot.waitForIdle();
 94 
 95         robot.keyPress(KeyEvent.VK_A);
 96         robot.keyRelease(KeyEvent.VK_A);
 97         robot.waitForIdle();
 98 
 99         if (ACTION_ACCEPTED_CALLS != 1) {
100             throw new RuntimeException(&quot;Method accept is not invoked!&quot;);
101         }
102 
103         if (ACTION_PERFORMED_CALLS != 1) {
104             throw new RuntimeException(&quot;Method actionPerformed is not invoked!&quot;);
105         }
106 
107         robot.keyPress(KeyEvent.VK_A);
108         robot.keyRelease(KeyEvent.VK_A);
109         robot.waitForIdle();
110 
111         if (ACTION_ACCEPTED_CALLS != 2) {
112             throw new RuntimeException(&quot;Method accept is not invoked!&quot;);
113         }
114 
115         if (ACTION_PERFORMED_CALLS != 1) {
116             throw new RuntimeException(&quot;Method actionPerformed is invoked twice!&quot;);
117         }
118     }
119 
120     private static void createAndShowGUI() {
121 
<a name="3" id="anc3"></a><span class="line-modified">122         frame = new JFrame();</span>
123         frame.setSize(300, 300);
124         frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
125 
126         JComboBox&lt;String&gt; comboBox = new JComboBox&lt;&gt;(new String[]{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;});
127 
128         Action showPopupAction = new ShowPopupAction();
129         comboBox.getInputMap().put(KeyStroke.getKeyStroke(&quot;A&quot;), &quot;showPopup&quot;);
130         comboBox.getActionMap().put(&quot;showPopup&quot;, showPopupAction);
131 
132         frame.getContentPane().add(comboBox);
133         frame.setVisible(true);
134     }
135 
136     private static class ShowPopupAction extends UIAction {
137 
138         public ShowPopupAction() {
139             super(&quot;showPopup&quot;);
140         }
141 
142         @Override
143         public void actionPerformed(ActionEvent e) {
144             ACTION_PERFORMED_CALLS++;
145             Object src = e.getSource();
146             if (src instanceof JComboBox) {
147                 ((JComboBox) src).showPopup();
148             }
149         }
150 
151         @Override
152         public boolean accept(Object sender) {
153             ACTION_ACCEPTED_CALLS++;
154             if (sender instanceof JComboBox) {
155                 JComboBox c = (JComboBox) sender;
156                 return !c.isPopupVisible();
157             }
158             return false;
159         }
160     }
161 
162     private static class SenderObject {
163 
164         private boolean accepted;
165         private boolean performed;
166     }
167 
168     private static class TestAction extends AbstractAction {
169 
170         private final boolean acceptSender;
171 
172         public TestAction(boolean acceptSender) {
173             this.acceptSender = acceptSender;
174         }
175 
176         @Override
177         public boolean accept(Object sender) {
178             ((SenderObject) sender).accepted = acceptSender;
179             return acceptSender;
180         }
181 
182         @Override
183         public void actionPerformed(ActionEvent e) {
184             ((SenderObject) e.getSource()).performed = true;
185         }
186     }
187 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>