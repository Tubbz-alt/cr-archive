<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/javax/swing/plaf/basic/BasicGraphicsUtils/8132119/bug8132119.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.awt.Color;
 25 import java.awt.Font;
 26 import java.awt.FontMetrics;
 27 import java.awt.Graphics2D;
 28 import java.awt.GraphicsEnvironment;
<a name="1" id="anc1"></a>
 29 import java.awt.font.FontRenderContext;
 30 import java.awt.font.NumericShaper;
 31 import java.awt.font.TextAttribute;
 32 import java.awt.font.TextLayout;
 33 import java.awt.image.BufferedImage;
 34 import java.util.HashMap;
 35 import javax.swing.JComponent;
 36 import javax.swing.JLabel;
 37 import javax.swing.SwingUtilities;
 38 import javax.swing.UIManager;
 39 import javax.swing.plaf.basic.BasicGraphicsUtils;
 40 import javax.swing.plaf.metal.MetalLookAndFeel;
 41 
 42 /**
 43  * @test
 44  * @bug 8132119 8168992 8169897 8207941
 45  * @author Alexandr Scherbatiy
 46  * @summary Provide public API for text related methods in SwingBasicGraphicsUtils2
 47  */
 48 public class bug8132119 {
 49 
 50     private static final int WIDTH = 50;
 51     private static final int HEIGHT = 50;
 52     private static final Color DRAW_COLOR = Color.RED;
 53     private static final Color BACKGROUND_COLOR = Color.GREEN;
 54     private static final NumericShaper NUMERIC_SHAPER = NumericShaper.getShaper(
 55             NumericShaper.ARABIC);
 56 
 57     public static void main(String[] args) throws Exception {
 58         SwingUtilities.invokeAndWait(bug8132119::testStringMethods);
 59     }
 60 
 61     private static void testStringMethods() {
 62         setMetalLAF();
 63         testStringWidth();
 64         testStringClip();
 65         testDrawEmptyString();
 66         testDrawString(false);
 67         testDrawString(true);
 68         checkNullArguments();
 69     }
 70 
 71     private static void testStringWidth() {
 72 
 73         String str = &quot;12345678910\u036F&quot;;
 74         JComponent comp = createComponent(str);
 75         Font font = comp.getFont();
 76         FontMetrics fontMetrics = comp.getFontMetrics(font);
 77         float stringWidth = BasicGraphicsUtils.getStringWidth(comp, fontMetrics, str);
 78 
 79         if (stringWidth == fontMetrics.stringWidth(str)) {
 80             throw new RuntimeException(&quot;Numeric shaper is not used!&quot;);
 81         }
 82 
 83         if (stringWidth != getLayoutWidth(str, font, NUMERIC_SHAPER)) {
 84             throw new RuntimeException(&quot;Wrong text width!&quot;);
 85         }
 86     }
 87 
 88     private static void testStringClip() {
 89 
 90         String str = &quot;1234567890&quot;;
 91         JComponent comp = createComponent(str);
 92         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
 93 
 94         int width = (int) BasicGraphicsUtils.getStringWidth(comp, fontMetrics, str);
 95 
 96         String clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, width);
 97         checkClippedString(str, clip, str);
 98 
 99         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, width + 1);
100         checkClippedString(str, clip, str);
101 
102         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, -1);
103         checkClippedString(str, clip, &quot;...&quot;);
104 
105         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, 0);
106         checkClippedString(str, clip, &quot;...&quot;);
107 
108         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics,
109                 str, width - width / str.length());
110         int endIndex = str.length() - 3;
111         checkClippedString(str, clip, str.substring(0, endIndex) + &quot;...&quot;);
112     }
113 
114     private static void checkClippedString(String str, String res, String golden) {
115         if (!golden.equals(res)) {
116             throw new RuntimeException(String.format(&quot;The string &#39;%s&#39; is not &quot;
117                     + &quot;properly clipped. The result is &#39;%s&#39; instead of &#39;%s&#39;&quot;,
118                     str, res, golden));
119         }
120     }
121 
122     private static void testDrawEmptyString() {
123         JLabel label = new JLabel();
124         BufferedImage buffImage = createBufferedImage(50, 50);
125         Graphics2D g2 = buffImage.createGraphics();
126         g2.setColor(DRAW_COLOR);
127         BasicGraphicsUtils.drawString(null, g2, null, 0, 0);
128         BasicGraphicsUtils.drawString(label, g2, null, 0, 0);
129         BasicGraphicsUtils.drawString(null, g2, &quot;&quot;, 0, 0);
130         BasicGraphicsUtils.drawString(label, g2, &quot;&quot;, 0, 0);
131         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g2, null, 3, 0, 0);
132         BasicGraphicsUtils.drawStringUnderlineCharAt(label, g2, null, 3, 0, 0);
133         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g2, &quot;&quot;, 3, 0, 0);
134         BasicGraphicsUtils.drawStringUnderlineCharAt(label, g2, &quot;&quot;, 3, 0, 0);
135         g2.dispose();
136         checkImageIsEmpty(buffImage);
137     }
138 
139     private static void testDrawString(boolean underlined) {
140         String str = &quot;AOB&quot;;
141         JComponent comp = createComponent(str);
142 
143         BufferedImage buffImage = createBufferedImage(WIDTH, HEIGHT);
144         Graphics2D g2 = buffImage.createGraphics();
145 
146         g2.setColor(DRAW_COLOR);
147         g2.setFont(comp.getFont());
<a name="2" id="anc2"></a>

148 
149         FontMetrics fontMetrices = comp.getFontMetrics(comp.getFont());
150         float width = BasicGraphicsUtils.getStringWidth(comp, fontMetrices, str);
151         float x = (WIDTH - width) / 2;
152         int y = 3 * HEIGHT / 4;
153 
154         if (underlined) {
155             BasicGraphicsUtils.drawStringUnderlineCharAt(comp, g2, str, 1, x, y);
156         } else {
157             BasicGraphicsUtils.drawString(comp, g2, str, x, y);
158         }
159         g2.dispose();
160 
161         float xx = BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;A&quot;) +
<a name="3" id="anc3"></a><span class="line-modified">162                 BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;O&quot;)/2;</span>
163 
164         checkImageContainsSymbol(buffImage, (int) xx, underlined ? 3 : 2);
165     }
166 
167     private static void checkNullArguments() {
168 
169         Graphics2D g = null;
170         try {
171             String text = &quot;Test&quot;;
172             JComponent component = new JLabel(text);
173             BufferedImage img = createBufferedImage(100, 100);
174             g = img.createGraphics();
175             checkNullArguments(component, g, text);
176         } finally {
177             g.dispose();
178         }
179     }
180 
181     private static void checkNullArguments(JComponent comp, Graphics2D g,
182             String text) {
183 
184         checkNullArgumentsDrawString(comp, g, text);
185         checkNullArgumentsDrawStringUnderlineCharAt(comp, g, text);
186         checkNullArgumentsGetClippedString(comp, text);
187         checkNullArgumentsGetStringWidth(comp, text);
188     }
189 
190     private static void checkNullArgumentsDrawString(JComponent comp, Graphics2D g,
191             String text) {
192 
193         float x = 50;
194         float y = 50;
195         BasicGraphicsUtils.drawString(null, g, text, x, y);
196         BasicGraphicsUtils.drawString(comp, g, null, x, y);
197 
198         try {
199             BasicGraphicsUtils.drawString(comp, null, text, x, y);
200         } catch (NullPointerException e) {
201             return;
202         }
203 
204         throw new RuntimeException(&quot;NPE is not thrown&quot;);
205     }
206 
207     private static void checkNullArgumentsDrawStringUnderlineCharAt(
208             JComponent comp, Graphics2D g, String text) {
209 
210         int x = 50;
211         int y = 50;
212         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g, text, 1, x, y);
213         BasicGraphicsUtils.drawStringUnderlineCharAt(comp, g, null, 1, x, y);
214 
215         try {
216             BasicGraphicsUtils.drawStringUnderlineCharAt(comp, null, text, 1, x, y);
217         } catch (NullPointerException e) {
218             return;
219         }
220 
221         throw new RuntimeException(&quot;NPE is not thrown&quot;);
222     }
223 
224     private static void checkNullArgumentsGetClippedString(
225             JComponent comp, String text) {
226 
227         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
228 
229         BasicGraphicsUtils.getClippedString(null, fontMetrics, text, 1);
230         String result = BasicGraphicsUtils.getClippedString(comp, fontMetrics, null, 1);
231         if (!&quot;&quot;.equals(result)) {
232             throw new RuntimeException(&quot;Empty string is not returned!&quot;);
233         }
234 
235         try {
236             BasicGraphicsUtils.getClippedString(comp, null, text, 1);
237         } catch (NullPointerException e) {
238             return;
239         }
240 
241         throw new RuntimeException(&quot;NPE is not thrown&quot;);
242     }
243 
244     private static void checkNullArgumentsGetStringWidth(JComponent comp,
245             String text) {
246 
247         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
248         BasicGraphicsUtils.getStringWidth(null, fontMetrics, text);
249         float result = BasicGraphicsUtils.getStringWidth(comp, fontMetrics, null);
250 
251         if (result != 0) {
252             throw new RuntimeException(&quot;The string length is not 0&quot;);
253         }
254 
255         try {
256             BasicGraphicsUtils.getStringWidth(comp, null, text);
257         } catch (NullPointerException e) {
258             return;
259         }
260 
261         throw new RuntimeException(&quot;NPE is not thrown&quot;);
262     }
263 
264     private static void setMetalLAF() {
265         try {
266             UIManager.setLookAndFeel(new MetalLookAndFeel());
267         } catch (Exception e) {
268             throw new RuntimeException(e);
269         }
270     }
271 
272     private static JComponent createComponent(String str) {
273         JComponent comp = new JLabel(str);
274         comp.setSize(WIDTH, HEIGHT);
275         comp.putClientProperty(TextAttribute.NUMERIC_SHAPING, NUMERIC_SHAPER);
276         comp.setFont(getFont());
277         return comp;
278     }
279 
280     private static String getFontName(String fn, String[] fontNames) {
281         String fontName = null;
282         for (String name : fontNames) {
283             if (fn.equals(name)) {
284                 fontName = name;
285                 break;
286             }
287         }
288         return fontName;
289     }
290 
291     private static Font getFont() {
292         GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();
293         String[] fontNames = ge.getAvailableFontFamilyNames();
294 
295         // We do not have Arial on all systems so provide some reasonable fallbacks.
296         // In case the fallbacks are not available as well, choose as last fallback
297         // the first font - however this might be a problematic choice.
298         String fontName = getFontName(&quot;Arial&quot;, fontNames);
299         if (fontName == null) {
300             fontName = getFontName(&quot;Bitstream Charter&quot;, fontNames);
301             if (fontName == null) {
302                 fontName = getFontName(&quot;Dialog&quot;, fontNames);
303                 if (fontName == null) {
304                     fontName = fontNames[0];
305                     System.out.println(&quot;warning - preferred fonts not on the system, fall back to first font &quot; + fontName);
306                 }
307             }
308         }
309         return new Font(fontName, Font.PLAIN, 30);
310     }
311 
312     private static float getLayoutWidth(String text, Font font, NumericShaper shaper) {
313         HashMap map = new HashMap();
314         map.put(TextAttribute.FONT, font);
315         map.put(TextAttribute.NUMERIC_SHAPING, shaper);
316         FontRenderContext frc = new FontRenderContext(null, false, false);
317         TextLayout layout = new TextLayout(text, map, frc);
318         return layout.getAdvance();
319     }
320 
321     private static void checkImageIsEmpty(BufferedImage buffImage) {
322         int background = BACKGROUND_COLOR.getRGB();
323 
324         for (int i = 0; i &lt; buffImage.getWidth(); i++) {
325             for (int j = 0; j &lt; buffImage.getHeight(); j++) {
326                 if (background != buffImage.getRGB(i, j)) {
327                     throw new RuntimeException(&quot;Image is not empty!&quot;);
328                 }
329             }
330         }
331     }
332 
333     private static void checkImageContainsSymbol(BufferedImage buffImage,
334             int x, int intersections) {
335 
336         int background = BACKGROUND_COLOR.getRGB();
337         boolean isBackground = true;
338         int backgroundChangesCount = 0;
339 
340         for (int y = 0; y &lt; buffImage.getHeight(); y++) {
341             if (!(isBackground ^ (background != buffImage.getRGB(x, y)))) {
342                 isBackground = !isBackground;
343                 backgroundChangesCount++;
344             }
345         }
346 
347         if (backgroundChangesCount != intersections * 2) {
348             throw new RuntimeException(&quot;String is not properly drawn!&quot;);
349         }
350     }
351 
352     private static BufferedImage createBufferedImage(int width, int height) {
353         BufferedImage bufffImage = new BufferedImage(width, height,
354                 BufferedImage.TYPE_INT_RGB);
355 
356         Graphics2D g = bufffImage.createGraphics();
357         g.setColor(BACKGROUND_COLOR);
358         g.fillRect(0, 0, width, height);
359         g.dispose();
360         return bufffImage;
361     }
362 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>