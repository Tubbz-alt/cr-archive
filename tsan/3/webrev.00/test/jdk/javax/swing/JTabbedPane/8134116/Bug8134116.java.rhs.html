<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/javax/swing/JTabbedPane/8134116/Bug8134116.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 
  2 import java.awt.*;
  3 import java.awt.event.KeyEvent;
  4 import java.util.ArrayList;
  5 import java.util.List;
  6 import javax.accessibility.Accessible;
  7 import javax.accessibility.AccessibleContext;
  8 import javax.accessibility.AccessibleState;
  9 import javax.accessibility.AccessibleStateSet;
 10 import javax.swing.*;
 11 import javax.swing.plaf.nimbus.NimbusLookAndFeel;
 12 
 13 /*
 14  * @test
 15  * @key headful
 16  * @bug 8134116
 17  * @summary JTabbedPane$Page.getBounds throws IndexOutOfBoundsException
 18  * @run main Bug8134116
 19  */
 20 public class Bug8134116 {
 21 
 22     private static volatile Exception exception = null;
<a name="1" id="anc1"></a><span class="line-added"> 23     private static JFrame frame;</span>
 24 
 25     public static void main(String args[]) throws Exception {
 26 
 27         try {
 28             UIManager.setLookAndFeel(new NimbusLookAndFeel());
 29         } catch (Exception e) {
 30             throw new RuntimeException(e);
 31         }
 32 
<a name="2" id="anc2"></a><span class="line-modified"> 33         try {</span>
<span class="line-modified"> 34             SwingUtilities.invokeAndWait(() -&gt; {</span>
<span class="line-modified"> 35                 JPanel panel0 = new JPanel();</span>
<span class="line-modified"> 36                 JPanel panel2 = new JPanel();</span>
<span class="line-modified"> 37                 BadPane badPane = new BadPane();</span>
<span class="line-modified"> 38                 badPane.add(&quot;zero&quot;, panel0);</span>
<span class="line-modified"> 39                 badPane.add(&quot;one&quot;, null);  // no component</span>
<span class="line-modified"> 40                 badPane.add(&quot;&quot;, panel2);  // no title</span>
<span class="line-modified"> 41                 badPane.add(&quot;&quot;, null); // no component, no title</span>
<span class="line-modified"> 42                 // but give it that via a tabComponent</span>
<span class="line-modified"> 43                 JPanel tabComponent = new JPanel();</span>
<span class="line-modified"> 44                 JLabel tabComponentLabel = new JLabel(&quot;three&quot;);</span>
<span class="line-modified"> 45                 tabComponent.add(tabComponentLabel);</span>
<span class="line-modified"> 46                 badPane.setTabComponentAt(3, tabComponent);</span>
<span class="line-modified"> 47                 frame = new JFrame();</span>
<span class="line-modified"> 48                 frame.add(badPane);</span>
<span class="line-modified"> 49                 frame.setSize(300, 300);</span>
<span class="line-added"> 50                 frame.setVisible(true);</span>
 51 
<a name="3" id="anc3"></a><span class="line-modified"> 52                 try {</span>
<span class="line-modified"> 53                     AccessibleContext ac = badPane.getAccessibleContext();</span>
<span class="line-modified"> 54                     Accessible page0 = ac.getAccessibleChild(0);</span>
<span class="line-modified"> 55                     if (page0 == null) {</span>
<span class="line-modified"> 56                         // Not something being tested, but checking anyway</span>
<span class="line-modified"> 57                         throw new RuntimeException(&quot;getAccessibleChild(0) is null&quot;);</span>
<span class="line-modified"> 58                     }</span>
<span class="line-modified"> 59                     Accessible page1 = ac.getAccessibleChild(1);</span>
<span class="line-modified"> 60                     if (page1 == null) {</span>
<span class="line-modified"> 61                         // Not something being tested, but checking anyway</span>
<span class="line-modified"> 62                         throw new RuntimeException(&quot;getAccessibleChild(1) is null&quot;);</span>
<span class="line-modified"> 63                     }</span>
<span class="line-modified"> 64                     Accessible page2 = ac.getAccessibleChild(2);</span>
<span class="line-modified"> 65                     Accessible page3 = ac.getAccessibleChild(3);</span>
<span class="line-modified"> 66                     // page0 - page3 are JTabbedPane.Page, a private inner class</span>
<span class="line-modified"> 67                     // and is an AccessibleContext</span>
<span class="line-modified"> 68                     // and implements Accessible and AccessibleComponent</span>
<span class="line-modified"> 69                     AccessibleContext pac0 = page0.getAccessibleContext();</span>
<span class="line-modified"> 70                     AccessibleContext pac1 = page1.getAccessibleContext();</span>
<span class="line-modified"> 71                     AccessibleContext pac2 = page2.getAccessibleContext();</span>
<span class="line-modified"> 72                     AccessibleContext pac3 = page3.getAccessibleContext();</span>
 73 
<a name="4" id="anc4"></a><span class="line-modified"> 74                     // test Page.getBounds</span>
<span class="line-modified"> 75                     // ensure no IndexOutOfBoundsException</span>
<span class="line-modified"> 76                     Rectangle r0 = pac0.getAccessibleComponent().getBounds();</span>
<span class="line-modified"> 77                     // make sure second Bounds is different than first</span>
<span class="line-modified"> 78                     Rectangle r1  = pac1.getAccessibleComponent().getBounds();</span>
<span class="line-modified"> 79                     if (r1.equals(r0)) {</span>
<span class="line-modified"> 80                         String msg = &quot;Second tab should not have same bounds as first tab&quot;;</span>
<span class="line-modified"> 81                         throw new RuntimeException(msg);</span>
<span class="line-modified"> 82                     }</span>
 83 
<a name="5" id="anc5"></a><span class="line-modified"> 84                     // test Page.getAccessibleStateSet</span>
<span class="line-modified"> 85                     // At this point page 0 is selected</span>
<span class="line-modified"> 86                     AccessibleStateSet accSS0 = pac0.getAccessibleStateSet();</span>
<span class="line-modified"> 87                     if (!accSS0.contains(AccessibleState.SELECTED)) {</span>
<span class="line-modified"> 88                         String msg = &quot;Empty title -&gt; AccessibleState.SELECTED not set&quot;;</span>
<span class="line-modified"> 89                         throw new RuntimeException(msg);</span>
<span class="line-modified"> 90                     }</span>
<span class="line-modified"> 91                     // select second tab</span>
<span class="line-modified"> 92                     badPane.setSelectedIndex(1);</span>
<span class="line-modified"> 93                     AccessibleStateSet accSS1 = pac1.getAccessibleStateSet();</span>
<span class="line-modified"> 94                     if (!accSS1.contains(AccessibleState.SELECTED)) {</span>
<span class="line-modified"> 95                         String msg = &quot;Second tab selected but AccessibleState.SELECTED not set&quot;;</span>
<span class="line-modified"> 96                         throw new RuntimeException(msg);</span>
<span class="line-modified"> 97                     }</span>
<span class="line-modified"> 98                     // select third tab</span>
<span class="line-modified"> 99                     badPane.setSelectedIndex(2);</span>
<span class="line-modified">100                     AccessibleStateSet accSS2 = pac2.getAccessibleStateSet();</span>
<span class="line-modified">101                     if (!accSS1.contains(AccessibleState.SELECTED)) {</span>
<span class="line-modified">102                         String msg = &quot;Third tab selected but AccessibleState.SELECTED not set&quot;;</span>
<span class="line-modified">103                         throw new RuntimeException(msg);</span>
<span class="line-modified">104                     }</span>
<span class="line-modified">105                     // select fourth tab</span>
<span class="line-modified">106                     badPane.setSelectedIndex(3);</span>
<span class="line-modified">107                     AccessibleStateSet accSS3 = pac3.getAccessibleStateSet();</span>
<span class="line-modified">108                     if (!accSS1.contains(AccessibleState.SELECTED)) {</span>
<span class="line-modified">109                         String msg = &quot;Fourth tab selected but AccessibleState.SELECTED not set&quot;;</span>
<span class="line-modified">110                         throw new RuntimeException(msg);</span>
<span class="line-modified">111                     }</span>
112 
<a name="6" id="anc6"></a><span class="line-modified">113                     // test Page.getAccessibleIndexInParent</span>
<span class="line-modified">114                     if (pac0.getAccessibleIndexInParent() == -1) {</span>
<span class="line-modified">115                         String msg = &quot;Empty title -&gt; negative AccessibleIndexInParent&quot;;</span>
<span class="line-modified">116                         throw new RuntimeException(msg);</span>
<span class="line-modified">117                     }</span>
<span class="line-modified">118                     if (pac0.getAccessibleIndexInParent() != 0) {</span>
<span class="line-modified">119                         String msg = &quot;first tab is not at index 0 in parent&quot;;</span>
<span class="line-modified">120                         throw new RuntimeException(msg);</span>
<span class="line-modified">121                     }</span>
<span class="line-modified">122                     if (pac1.getAccessibleIndexInParent() != 1) {</span>
<span class="line-modified">123                         String msg = &quot;second tab (null component) is not at index 1 in parent&quot;;</span>
<span class="line-modified">124                         throw new RuntimeException(msg);</span>
<span class="line-modified">125                     }</span>
<span class="line-modified">126                     if (pac2.getAccessibleIndexInParent() != 2) {</span>
<span class="line-modified">127                         String msg = &quot;third tab (empty title) string is not at index 2 in parent&quot;;</span>
<span class="line-modified">128                         throw new RuntimeException(msg);</span>
<span class="line-modified">129                     }</span>
<span class="line-modified">130                     if (pac3.getAccessibleIndexInParent() != 3) {</span>
<span class="line-modified">131                         String msg = &quot;fourth tab (empty title, null component, has tabComponent) string is not at index 3 in parent&quot;;</span>
<span class="line-modified">132                         throw new RuntimeException(msg);</span>
<span class="line-modified">133                     }</span>
134 
<a name="7" id="anc7"></a><span class="line-modified">135                     // test Page.getAccessibleName</span>
<span class="line-modified">136                     String accName = pac0.getAccessibleName();</span>
<span class="line-modified">137                     if (!accName.equals(&quot;zero&quot;)) {</span>
<span class="line-modified">138                         String msg = &quot;Empty title -&gt; empty AccessibleName&quot;;</span>
<span class="line-modified">139                         throw new RuntimeException(msg);</span>
<span class="line-modified">140                     }</span>
<span class="line-modified">141                     // test Page.getAccessibleName when component is null</span>
<span class="line-modified">142                     accName = pac1.getAccessibleName();</span>
<span class="line-modified">143                     if (!accName.equals(&quot;one&quot;)) {</span>
<span class="line-modified">144                         String msg = &quot;AccessibleName of null panel not &#39;one&#39;&quot;;</span>
<span class="line-modified">145                         throw new RuntimeException(msg);</span>
<span class="line-modified">146                     }</span>
147 
<a name="8" id="anc8"></a><span class="line-modified">148                     // test Page.setDisplayedMnemonicIndex</span>
<span class="line-modified">149                     //  Empty title -&gt; IllegalArgumnetException</span>
<span class="line-modified">150                     badPane.setDisplayedMnemonicIndexAt(0, 1);</span>
151 
<a name="9" id="anc9"></a><span class="line-modified">152                     // test Page.updateDisplayedMnemonicIndex</span>
<span class="line-modified">153                     badPane.setMnemonicAt(0, KeyEvent.VK_Z);</span>
<span class="line-modified">154                     if (badPane.getDisplayedMnemonicIndexAt(0) == -1) {</span>
<span class="line-modified">155                         String msg=&quot;Empty title -&gt; getDisplayedMnemonicIndexAt failure&quot;;</span>
<span class="line-modified">156                         throw new RuntimeException(msg);</span>
<span class="line-added">157                     }</span>
<span class="line-added">158                 } catch (Exception e) {</span>
<span class="line-added">159                     exception = e;</span>
160                 }
<a name="10" id="anc10"></a><span class="line-modified">161             });</span>
<span class="line-modified">162             if (exception != null) {</span>
<span class="line-added">163                 System.out.println(&quot;Test failed: &quot; + exception.getMessage());</span>
<span class="line-added">164                 throw exception;</span>
<span class="line-added">165             } else {</span>
<span class="line-added">166                 System.out.println(&quot;Test passed.&quot;);</span>
167             }
<a name="11" id="anc11"></a><span class="line-modified">168         } finally {</span>
<span class="line-modified">169             if (frame != null) SwingUtilities.invokeAndWait(() -&gt; frame.dispose());</span>




170         }
171     }
172 
173     // The following is likely what is being done in Burp Suite
174     // https://portswigger.net/burp/ which fails in the same way, i.e. the
175     // pages List in JTabbedPane is not being managed properly and thus
176     // Page.title is &quot;&quot; for each page.  The overridden insertTab manages titles
177     // in the subclass passing a &quot;&quot; title to the superclass JTabbedPane through
178     // its insertTab.  Later an overridden getTitleAt returns the titles as
179     // managed by the subclass.
180     static class BadPane extends JTabbedPane {
181         private List&lt;String&gt; titles;
182 
183         BadPane() {
184             titles = new ArrayList&lt;String&gt;(1);
185         }
186 
187         @Override
188         public void insertTab( String title, Icon icon, Component component,
189                                String tip, int index ) {
190             titles.add(index, title);
191             super.insertTab(&quot;&quot;, icon, component, tip, index);
192         }
193 
194         @Override
195         public String getTitleAt(int i) {
196             return titles.get(i);
197         }
198     }
199 
200 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>