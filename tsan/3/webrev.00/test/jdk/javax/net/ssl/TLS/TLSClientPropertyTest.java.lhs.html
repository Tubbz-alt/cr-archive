<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/javax/net/ssl/TLS/TLSClientPropertyTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8049432 8069038</span>
 27  * @summary New tests for TLS property jdk.tls.client.protocols
 28  * @summary javax/net/ssl/TLS/TLSClientPropertyTest.java needs to be
 29  *     updated for JDK-8061210
 30  * @modules java.security.jgss
 31  *          java.security.jgss/sun.security.jgss.krb5
 32  *          java.security.jgss/sun.security.krb5:+open
 33  *          java.security.jgss/sun.security.krb5.internal:+open
 34  *          java.security.jgss/sun.security.krb5.internal.ccache
 35  *          java.security.jgss/sun.security.krb5.internal.crypto
 36  *          java.security.jgss/sun.security.krb5.internal.ktab
 37  *          java.base/sun.security.util
 38  * @run main/othervm TLSClientPropertyTest NoProperty
 39  * @run main/othervm TLSClientPropertyTest SSLv3
 40  * @run main/othervm TLSClientPropertyTest TLSv1
 41  * @run main/othervm TLSClientPropertyTest TLSv11
 42  * @run main/othervm TLSClientPropertyTest TLSv12
<a name="3" id="anc3"></a>

 43  * @run main/othervm TLSClientPropertyTest WrongProperty
 44  */
 45 
 46 import java.security.KeyManagementException;
 47 import java.security.NoSuchAlgorithmException;
 48 import java.util.Arrays;
 49 import java.util.List;
 50 import javax.net.ssl.SSLContext;
 51 
 52 /**
 53  * Sets the property jdk.tls.client.protocols to one of this protocols:
 54  * SSLv3,TLSv1,TLSv1.1,TLSv1.2 and TLSV(invalid) or removes this
 55  * property (if any),then validates the default, supported and current
 56  * protocols in the SSLContext.
 57  */
 58 public class TLSClientPropertyTest {
 59     private final String[] expectedSupportedProtos = new String[] {
<a name="4" id="anc4"></a><span class="line-modified"> 60             &quot;SSLv2Hello&quot;, &quot;SSLv3&quot;, &quot;TLSv1&quot;, &quot;TLSv1.1&quot;, &quot;TLSv1.2&quot;</span>
 61     };
 62 
 63     public static void main(String[] args) throws Exception {
 64 
 65         if (args.length &lt; 1) {
 66             throw new RuntimeException(
 67                     &quot;Incorrect arguments,expected arguments: testCase&quot;);
 68         }
 69 
 70         String[] expectedDefaultProtos;
 71         String testCase = args[0];
 72         String contextProtocol;
 73         switch (testCase) {
 74         case &quot;NoProperty&quot;:
 75             if (System.getProperty(&quot;jdk.tls.client.protocols&quot;) != null) {
 76                 System.getProperties().remove(&quot;jdk.tls.client.protocols&quot;);
 77             }
 78             contextProtocol = null;
 79             expectedDefaultProtos = new String[] {
<a name="5" id="anc5"></a><span class="line-modified"> 80                     &quot;TLSv1&quot;, &quot;TLSv1.1&quot;, &quot;TLSv1.2&quot;</span>
 81             };
 82             break;
 83         case &quot;SSLv3&quot;:
 84             contextProtocol = &quot;SSLv3&quot;;
 85             expectedDefaultProtos = new String[] {
 86             };
 87             break;
 88         case &quot;TLSv1&quot;:
 89             contextProtocol = &quot;TLSv1&quot;;
 90             expectedDefaultProtos = new String[] {
 91                     &quot;TLSv1&quot;
 92             };
 93             break;
 94         case &quot;TLSv11&quot;:
 95             contextProtocol = &quot;TLSv1.1&quot;;
 96             expectedDefaultProtos = new String[] {
 97                     &quot;TLSv1&quot;, &quot;TLSv1.1&quot;
 98             };
 99             break;
100         case &quot;TLSv12&quot;:
101             contextProtocol = &quot;TLSv1.2&quot;;
102             expectedDefaultProtos = new String[] {
103                     &quot;TLSv1&quot;, &quot;TLSv1.1&quot;, &quot;TLSv1.2&quot;
104             };
105             break;
<a name="6" id="anc6"></a>






106         case &quot;WrongProperty&quot;:
107             expectedDefaultProtos = new String[] {};
108             contextProtocol = &quot;TLSV&quot;;
109             break;
110         default:
111             throw new RuntimeException(&quot;test case is wrong&quot;);
112         }
113         if (contextProtocol != null) {
114             System.setProperty(&quot;jdk.tls.client.protocols&quot;, contextProtocol);
115         }
116         try {
117             TLSClientPropertyTest test = new TLSClientPropertyTest();
118             test.test(contextProtocol, expectedDefaultProtos);
119             if (testCase.equals(&quot;WrongProperty&quot;)) {
120                 throw new RuntimeException(
121                         &quot;Test failed: NoSuchAlgorithmException &quot; +
122                         &quot;is expected when input wrong protocol&quot;);
123             } else {
124                 System.out.println(&quot;Test &quot; + contextProtocol + &quot; passed&quot;);
125             }
126         } catch (NoSuchAlgorithmException nsae) {
127             if (testCase.equals(&quot;WrongProperty&quot;)) {
128                 System.out.println(&quot;NoSuchAlgorithmException is expected,&quot;
129                         + contextProtocol + &quot; test passed&quot;);
130             } else {
131                 throw nsae;
132             }
133         }
134 
135     }
136 
137     /**
138      * The parameter passed is the user enforced protocol. Does not catch
139      * NoSuchAlgorithmException, WrongProperty test will use it.
140      */
141     public void test(String expectedContextProto,
142             String[] expectedDefaultProtos) throws NoSuchAlgorithmException {
143 
144         SSLContext context = null;
145         try {
146             if (expectedContextProto != null) {
147                 context = SSLContext.getInstance(expectedContextProto);
148                 context.init(null, null, null);
149             } else {
150                 context = SSLContext.getDefault();
151             }
152             printContextDetails(context);
153         } catch (KeyManagementException ex) {
154             error(null, ex);
155         }
156 
157         validateContext(expectedContextProto, expectedDefaultProtos, context);
158     }
159 
160     /**
161      * Simple print utility for SSLContext&#39;s protocol details.
162      */
163     private void printContextDetails(SSLContext context) {
164         System.out.println(&quot;Default   Protocols: &quot;
165                 + Arrays.toString(context.getDefaultSSLParameters()
166                         .getProtocols()));
167         System.out.println(&quot;Supported Protocols: &quot;
168                 + Arrays.toString(context.getSupportedSSLParameters()
169                         .getProtocols()));
170         System.out.println(&quot;Current   Protocol : &quot; + context.getProtocol());
171 
172     }
173 
174     /**
175      * Error handler.
176      */
177     private void error(String msg, Throwable tble) {
178         String finalMsg = &quot;FAILED &quot; + (msg != null ? msg : &quot;&quot;);
179         if (tble != null) {
180             throw new RuntimeException(finalMsg, tble);
181         }
182         throw new RuntimeException(finalMsg);
183     }
184 
185     /**
186      * Validates the SSLContext&#39;s protocols against the user enforced protocol.
187      */
188     private void validateContext(String expectedProto,
189             String[] expectedDefaultProtos, SSLContext context) {
190         if (expectedProto == null) {
191             expectedProto = &quot;Default&quot;;
192         }
193         if (!context.getProtocol().equals(expectedProto)) {
194             error(&quot;Invalid current protocol: &quot; + context.getProtocol()
195                     + &quot;, Expected:&quot; + expectedProto, null);
196         }
197         List&lt;String&gt; actualDefaultProtos = Arrays.asList(context
198                 .getDefaultSSLParameters().getProtocols());
199         for (String p : expectedDefaultProtos) {
200             if (!actualDefaultProtos.contains(p)) {
201                 error(&quot;Default protocol &quot; + p + &quot;missing&quot;, null);
202             }
203         }
204         List&lt;String&gt; actualSupportedProtos = Arrays.asList(context
205                 .getSupportedSSLParameters().getProtocols());
206 
207         for (String p : expectedSupportedProtos) {
208             if (!actualSupportedProtos.contains(p)) {
209                 error(&quot;Expected to support protocol:&quot; + p, null);
210             }
211         }
212     }
213 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>