<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/javax/net/ssl/templates/SSLSocketSSLEngineTemplate.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../sanity/interop/JSSEServer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SSLSocketTemplate.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/javax/net/ssl/templates/SSLSocketSSLEngineTemplate.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +28,14 @@</span>
  
  /*
   * @test
   * @bug 7105780
   * @summary Add SSLSocket client/SSLEngine server to templates directory.
<span class="udiff-line-modified-removed">-  * @run main/othervm SSLSocketSSLEngineTemplate</span>
<span class="udiff-line-modified-added">+  * @run main/othervm SSLSocketSSLEngineTemplate TLSv1</span>
<span class="udiff-line-added">+  * @run main/othervm SSLSocketSSLEngineTemplate TLSv1.1</span>
<span class="udiff-line-added">+  * @run main/othervm SSLSocketSSLEngineTemplate TLSv1.2</span>
<span class="udiff-line-added">+  * @run main/othervm SSLSocketSSLEngineTemplate TLSv1.3</span>
   */
  
  /**
   * A SSLSocket/SSLEngine interop test case.  This is not the way to
   * code SSLEngine-based servers, but works for what we need to do here,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,15 +101,16 @@</span>
       * after gaining some familiarity with this application.
       */
      private static final boolean debug = false;
      private final SSLContext sslc;
      private SSLEngine serverEngine;     // server-side SSLEngine
<span class="udiff-line-added">+     private SSLSocket clientSocket;</span>
  
      private final byte[] serverMsg =
          &quot;Hi there Client, I&#39;m a Server.&quot;.getBytes();
      private final byte[] clientMsg =
<span class="udiff-line-modified-removed">-         &quot;Hello Server, I&#39;m a Client!  Pleased to meet you!&quot;.getBytes();</span>
<span class="udiff-line-modified-added">+         &quot;Hello Server, I&#39;m a Client! Pleased to meet you!&quot;.getBytes();</span>
  
      private ByteBuffer serverOut;       // write side of serverEngine
      private ByteBuffer serverIn;        // read side of serverEngine
  
      private volatile Exception clientException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,11 +126,10 @@</span>
       * The following is to set up the keystores/trust material.
       */
      private static final String pathToStores = &quot;../etc&quot;;
      private static final String keyStoreFile = &quot;keystore&quot;;
      private static final String trustStoreFile = &quot;truststore&quot;;
<span class="udiff-line-removed">-     private static final String passwd = &quot;passphrase&quot;;</span>
      private static final String keyFilename =
              System.getProperty(&quot;test.src&quot;, &quot;.&quot;) + &quot;/&quot; + pathToStores
              + &quot;/&quot; + keyStoreFile;
      private static final String trustFilename =
              System.getProperty(&quot;test.src&quot;, &quot;.&quot;) + &quot;/&quot; + pathToStores
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,39 +137,35 @@</span>
  
      /*
       * Main entry point for this test.
       */
      public static void main(String args[]) throws Exception {
<span class="udiff-line-added">+         String protocol = args[0];</span>
<span class="udiff-line-added">+ </span>
          // reset security properties to make sure that the algorithms
          // and keys used in this test are not disabled.
          Security.setProperty(&quot;jdk.tls.disabledAlgorithms&quot;, &quot;&quot;);
          Security.setProperty(&quot;jdk.certpath.disabledAlgorithms&quot;, &quot;&quot;);
  
          if (debug) {
              System.setProperty(&quot;javax.net.debug&quot;, &quot;all&quot;);
          }
  
<span class="udiff-line-modified-removed">-         String [] protocols = new String [] {</span>
<span class="udiff-line-modified-removed">-             &quot;SSLv3&quot;, &quot;TLSv1&quot;, &quot;TLSv1.1&quot;, &quot;TLSv1.2&quot; };</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         for (String protocol : protocols) {</span>
<span class="udiff-line-modified-removed">-             log(&quot;Testing &quot; + protocol);</span>
<span class="udiff-line-modified-removed">-             /*</span>
<span class="udiff-line-modified-removed">-              * Run the tests with direct and indirect buffers.</span>
<span class="udiff-line-modified-removed">-              */</span>
<span class="udiff-line-modified-removed">-             SSLSocketSSLEngineTemplate test =</span>
<span class="udiff-line-modified-removed">-                 new SSLSocketSSLEngineTemplate(protocol);</span>
<span class="udiff-line-modified-removed">-             log(&quot;-------------------------------------&quot;);</span>
<span class="udiff-line-modified-removed">-             log(&quot;Testing &quot; + protocol + &quot; for direct buffers ...&quot;);</span>
<span class="udiff-line-removed">-             test.runTest(true);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             log(&quot;---------------------------------------&quot;);</span>
<span class="udiff-line-removed">-             log(&quot;Testing &quot; + protocol + &quot; for indirect buffers ...&quot;);</span>
<span class="udiff-line-removed">-             test.runTest(false);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         /*</span>
<span class="udiff-line-modified-added">+          * Run the tests with direct and indirect buffers.</span>
<span class="udiff-line-modified-added">+          */</span>
<span class="udiff-line-modified-added">+         SSLSocketSSLEngineTemplate test =</span>
<span class="udiff-line-modified-added">+             new SSLSocketSSLEngineTemplate(protocol);</span>
<span class="udiff-line-modified-added">+         log(&quot;-------------------------------------&quot;);</span>
<span class="udiff-line-modified-added">+         log(&quot;Testing &quot; + protocol + &quot; for direct buffers ...&quot;);</span>
<span class="udiff-line-modified-added">+         test.runTest(true);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         log(&quot;---------------------------------------&quot;);</span>
<span class="udiff-line-modified-added">+         log(&quot;Testing &quot; + protocol + &quot; for indirect buffers ...&quot;);</span>
<span class="udiff-line-modified-added">+         test.runTest(false);</span>
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;Test Passed.&quot;);</span>
<span class="udiff-line-modified-added">+         log(&quot;Test Passed.&quot;);</span>
      }
  
      /*
       * Create an initialized SSLContext to use for these tests.
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -212,17 +211,19 @@</span>
       *
       * One could easily separate these phases into separate
       * sections of code.
       */
      private void runTest(boolean direct) throws Exception {
<span class="udiff-line-added">+         clientSocket = null;</span>
          boolean serverClose = direct;
  
          // generates the server-side Socket
          try (ServerSocket serverSocket = new ServerSocket()) {
              serverSocket.setReuseAddress(false);
              serverSocket.bind(null);
              int port = serverSocket.getLocalPort();
<span class="udiff-line-added">+             log(&quot;Port: &quot; + port);</span>
              Thread thread = createClientThread(port, serverClose);
  
              createSSLEngine();
              createBuffers(direct);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -259,15 +260,22 @@</span>
  
                      // Read from the Client side.
                      try {
                          len = is.read(inbound);
                          if (len == -1) {
<span class="udiff-line-modified-removed">-                             throw new Exception(&quot;Unexpected EOF&quot;);</span>
<span class="udiff-line-modified-added">+                             logSocketStatus(clientSocket);</span>
<span class="udiff-line-added">+                             if (clientSocket.isClosed()</span>
<span class="udiff-line-added">+                                     || clientSocket.isOutputShutdown()) {</span>
<span class="udiff-line-added">+                                 log(&quot;Client socket was closed or shutdown output&quot;);</span>
<span class="udiff-line-added">+                                 break;</span>
<span class="udiff-line-added">+                             } else {</span>
<span class="udiff-line-added">+                                 throw new Exception(&quot;Unexpected EOF&quot;);</span>
<span class="udiff-line-added">+                             }</span>
                          }
                          cTOs.put(inbound, 0, len);
                      } catch (SocketTimeoutException ste) {
<span class="udiff-line-modified-removed">-                         // swallow.  Nothing yet, probably waiting on us.</span>
<span class="udiff-line-modified-added">+                         // swallow. Nothing yet, probably waiting on us.</span>
                      }
  
                      cTOs.flip();
  
                      serverResult = serverEngine.unwrap(cTOs, serverIn);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -366,10 +374,12 @@</span>
              @Override
              public void run() {
                  // client-side socket
                  try (SSLSocket sslSocket = (SSLSocket)sslc.getSocketFactory().
                              createSocket(&quot;localhost&quot;, port)) {
<span class="udiff-line-added">+                     clientSocket = sslSocket;</span>
<span class="udiff-line-added">+ </span>
                      OutputStream os = sslSocket.getOutputStream();
                      InputStream is = sslSocket.getInputStream();
  
                      // write(byte[]) goes in one shot.
                      os.write(clientMsg);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -474,10 +484,19 @@</span>
  
      private static boolean isEngineClosed(SSLEngine engine) {
          return (engine.isOutboundDone() &amp;&amp; engine.isInboundDone());
      }
  
<span class="udiff-line-added">+     private static void logSocketStatus(Socket socket) {</span>
<span class="udiff-line-added">+         log(&quot;##### &quot; + socket + &quot; #####&quot;);</span>
<span class="udiff-line-added">+         log(&quot;isBound: &quot; + socket.isBound());</span>
<span class="udiff-line-added">+         log(&quot;isConnected: &quot; + socket.isConnected());</span>
<span class="udiff-line-added">+         log(&quot;isClosed: &quot; + socket.isClosed());</span>
<span class="udiff-line-added">+         log(&quot;isInputShutdown: &quot; + socket.isInputShutdown());</span>
<span class="udiff-line-added">+         log(&quot;isOutputShutdown: &quot; + socket.isOutputShutdown());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /*
       * Logging code
       */
      private static boolean resultOnce = true;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -485,11 +504,11 @@</span>
          if (!logging) {
              return;
          }
          if (resultOnce) {
              resultOnce = false;
<span class="udiff-line-modified-removed">-             System.out.println(&quot;The format of the SSLEngineResult is: \n&quot;</span>
<span class="udiff-line-modified-added">+             log(&quot;The format of the SSLEngineResult is: \n&quot;</span>
                      + &quot;\t\&quot;getStatus() / getHandshakeStatus()\&quot; +\n&quot;
                      + &quot;\t\&quot;bytesConsumed() / bytesProduced()\&quot;\n&quot;);
          }
          HandshakeStatus hsStatus = result.getHandshakeStatus();
          log(str
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -501,9 +520,13 @@</span>
          }
      }
  
      private static void log(String str) {
          if (logging) {
<span class="udiff-line-modified-removed">-             System.out.println(str);</span>
<span class="udiff-line-modified-added">+             if (debug) {</span>
<span class="udiff-line-added">+                 System.err.println(str);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 System.out.println(str);</span>
<span class="udiff-line-added">+             }</span>
          }
      }
  }
</pre>
<center><a href="../sanity/interop/JSSEServer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SSLSocketTemplate.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>