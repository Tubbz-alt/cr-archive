<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/javax/net/ssl/compatibility/Compatibility.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Client.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="JdkInfo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/javax/net/ssl/compatibility/Compatibility.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -55,39 +55,52 @@</span>
  
  import jdk.test.lib.process.OutputAnalyzer;
  
  public class Compatibility {
  
<span class="udiff-line-modified-removed">-     public static void main(String[] args) throws Throwable {</span>
<span class="udiff-line-modified-removed">-         String javaSecurityFile</span>
<span class="udiff-line-modified-removed">-                 = System.getProperty(&quot;test.src&quot;) + &quot;/java.security&quot;;</span>
<span class="udiff-line-removed">-         boolean debug = Utils.getBoolProperty(&quot;debug&quot;);</span>
<span class="udiff-line-modified-added">+     protected List&lt;UseCase&gt; getUseCases() {</span>
<span class="udiff-line-modified-added">+         return UseCase.getAllUseCases();</span>
<span class="udiff-line-modified-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         Set&lt;JdkInfo&gt; jdkInfos = jdkInfoList();</span>
<span class="udiff-line-modified-added">+     protected Set&lt;JdkInfo&gt; getJdkInfos() {</span>
<span class="udiff-line-added">+         return jdkInfoList();</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         System.out.println(&quot;Test start&quot;);</span>
<span class="udiff-line-modified-added">+     protected List&lt;TestCase&gt; runTest() throws Exception {</span>
<span class="udiff-line-added">+         Set&lt;JdkInfo&gt; jdkInfos = getJdkInfos();</span>
  
          List&lt;TestCase&gt; testCases = new ArrayList&lt;&gt;();
          ExecutorService executor = Executors.newCachedThreadPool();
          PrintStream origStdOut = System.out;
          PrintStream origStdErr = System.err;
  
<span class="udiff-line-added">+         boolean debug = Boolean.getBoolean(&quot;debug&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String securityPropertiesFile = System.getProperty(</span>
<span class="udiff-line-added">+                 &quot;test.security.properties&quot;,</span>
<span class="udiff-line-added">+                 System.getProperty(&quot;test.src&quot;) + &quot;/java.security&quot;);</span>
<span class="udiff-line-added">+         System.out.println(&quot;security properties: &quot; + securityPropertiesFile);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // If true, server and client CANNOT be a same JDK</span>
<span class="udiff-line-added">+         boolean disallowSameEndpoint = Boolean.getBoolean(&quot;disallowSameEndpoint&quot;);</span>
<span class="udiff-line-added">+         System.out.println(&quot;disallowSameEndpoint: &quot; + disallowSameEndpoint);</span>
<span class="udiff-line-added">+ </span>
          try (PrintStream printStream = new PrintStream(
                  new FileOutputStream(Utils.TEST_LOG, true))) {
              System.setOut(printStream);
              System.setErr(printStream);
  
              System.out.println(Utils.startHtml());
              System.out.println(Utils.startPre());
  
<span class="udiff-line-modified-removed">-             for (UseCase useCase : UseCase.getAllUseCases()) {</span>
<span class="udiff-line-modified-added">+             for (UseCase useCase : getUseCases()) {</span>
                  for (JdkInfo serverJdk : jdkInfos) {
                      Map&lt;String, String&gt; props = new LinkedHashMap&lt;&gt;();
                      if (debug) {
                          props.put(&quot;javax.net.debug&quot;, &quot;all&quot;);
                      }
<span class="udiff-line-modified-removed">-                     props.put(&quot;java.security.properties&quot;, javaSecurityFile);</span>
<span class="udiff-line-modified-added">+                     props.put(&quot;java.security.properties&quot;, securityPropertiesFile);</span>
  
                      props.put(Utils.PROP_PROTOCOL, useCase.protocol.name);
                      props.put(Utils.PROP_CIPHER_SUITE, useCase.cipherSuite.name());
                      props.put(Utils.PROP_CLIENT_AUTH, String.valueOf(useCase.clientAuth));
                      if (useCase.appProtocol != UseCase.AppProtocol.NONE) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -103,10 +116,14 @@</span>
                              serverJdk.supportsSNI + &quot;&quot;);
                      props.put(Utils.PROP_SUPPORTS_ALPN_ON_SERVER,
                              serverJdk.supportsALPN + &quot;&quot;);
  
                      for (JdkInfo clientJdk : jdkInfos) {
<span class="udiff-line-added">+                         if (disallowSameEndpoint &amp;&amp; clientJdk == serverJdk) {</span>
<span class="udiff-line-added">+                             continue;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+ </span>
                          TestCase testCase = new TestCase(serverJdk, clientJdk,
                                  useCase);
                          System.out.println(Utils.anchorName(testCase.toString(),
                                  &quot;===== Case start =====&quot;));
                          System.out.println(testCase.toString());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,20 +177,79 @@</span>
          }
          System.setOut(origStdOut);
          System.setErr(origStdErr);
          executor.shutdown();
  
<span class="udiff-line-added">+         return testCases;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Generates the test result report.</span>
<span class="udiff-line-added">+     protected boolean generateReport(List&lt;TestCase&gt; testCases)</span>
<span class="udiff-line-added">+             throws IOException {</span>
<span class="udiff-line-added">+         boolean failed = false;</span>
<span class="udiff-line-added">+         StringBuilder report = new StringBuilder();</span>
<span class="udiff-line-added">+         report.append(Utils.startHtml());</span>
<span class="udiff-line-added">+         report.append(Utils.tableStyle());</span>
<span class="udiff-line-added">+         report.append(Utils.startTable());</span>
<span class="udiff-line-added">+         report.append(Utils.row(</span>
<span class="udiff-line-added">+                 &quot;No.&quot;,</span>
<span class="udiff-line-added">+                 &quot;ServerJDK&quot;,</span>
<span class="udiff-line-added">+                 &quot;ClientJDK&quot;,</span>
<span class="udiff-line-added">+                 &quot;Protocol&quot;,</span>
<span class="udiff-line-added">+                 &quot;CipherSuite&quot;,</span>
<span class="udiff-line-added">+                 &quot;ClientAuth&quot;,</span>
<span class="udiff-line-added">+                 &quot;SNI&quot;,</span>
<span class="udiff-line-added">+                 &quot;ALPN&quot;,</span>
<span class="udiff-line-added">+                 &quot;Status&quot;));</span>
<span class="udiff-line-added">+         for (int i = 0, size = testCases.size(); i &lt; size; i++) {</span>
<span class="udiff-line-added">+             TestCase testCase = testCases.get(i);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             report.append(Utils.row(</span>
<span class="udiff-line-added">+                     Utils.anchorLink(</span>
<span class="udiff-line-added">+                             Utils.TEST_LOG,</span>
<span class="udiff-line-added">+                             testCase.toString(),</span>
<span class="udiff-line-added">+                             i + &quot;&quot;),</span>
<span class="udiff-line-added">+                     testCase.serverJdk.version,</span>
<span class="udiff-line-added">+                     testCase.clientJdk.version,</span>
<span class="udiff-line-added">+                     testCase.useCase.protocol.name,</span>
<span class="udiff-line-added">+                     testCase.useCase.cipherSuite,</span>
<span class="udiff-line-added">+                     Utils.boolToStr(</span>
<span class="udiff-line-added">+                             testCase.useCase.clientAuth),</span>
<span class="udiff-line-added">+                     Utils.boolToStr(</span>
<span class="udiff-line-added">+                             testCase.useCase.serverName == UseCase.ServerName.EXAMPLE),</span>
<span class="udiff-line-added">+                     Utils.boolToStr(</span>
<span class="udiff-line-added">+                             testCase.useCase.appProtocol == UseCase.AppProtocol.EXAMPLE),</span>
<span class="udiff-line-added">+                     testCase.getStatus()));</span>
<span class="udiff-line-added">+             failed = failed</span>
<span class="udiff-line-added">+                     || testCase.getStatus() == Status.FAIL</span>
<span class="udiff-line-added">+                     || testCase.getStatus() == Status.UNEXPECTED_SUCCESS;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         report.append(Utils.endTable());</span>
<span class="udiff-line-added">+         report.append(Utils.endHtml());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         generateFile(&quot;report.html&quot;, report.toString());</span>
<span class="udiff-line-added">+         return failed;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected void run() throws Exception {</span>
<span class="udiff-line-added">+         System.out.println(&quot;Test start&quot;);</span>
<span class="udiff-line-added">+         List&lt;TestCase&gt; testCases= runTest();</span>
          System.out.println(&quot;Test end&quot;);
<span class="udiff-line-modified-removed">-         System.out.println(&quot;Report is being generated...&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
          boolean failed = generateReport(testCases);
<span class="udiff-line-modified-removed">-         System.out.println(&quot;Report is generated.&quot;);</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;Report was generated.&quot;);</span>
<span class="udiff-line-added">+ </span>
          if (failed) {
              throw new RuntimeException(&quot;At least one case failed. &quot;
                      + &quot;Please check logs for more details.&quot;);
          }
      }
  
<span class="udiff-line-added">+     public static void main(String[] args) throws Throwable {</span>
<span class="udiff-line-added">+         new Compatibility().run();;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static Status getStatus(String log) {
          if (log.contains(Status.UNEXPECTED_SUCCESS.name())) {
              return Status.UNEXPECTED_SUCCESS;
          } else if (log.contains(Status.SUCCESS.name())) {
              return Status.SUCCESS;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -201,17 +277,14 @@</span>
                     : Status.FAIL;
          }
      }
  
      // Retrieves JDK info from the file which is specified by jdkListFile.
<span class="udiff-line-modified-removed">-     // If no such file or no JDK is specified by the file, the current testing</span>
<span class="udiff-line-modified-removed">-     // JDK will be used.</span>
<span class="udiff-line-modified-removed">-     private static Set&lt;JdkInfo&gt; jdkInfoList() throws Throwable {</span>
<span class="udiff-line-modified-removed">-         List&lt;String&gt; jdkList = jdkList(&quot;jdkListFile&quot;);</span>
<span class="udiff-line-removed">-         if (jdkList.size() == 0) {</span>
<span class="udiff-line-removed">-             jdkList.add(System.getProperty(&quot;test.jdk&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     // And the current testing JDK, which is specified by test.jdk, always be used.</span>
<span class="udiff-line-modified-added">+     private static Set&lt;JdkInfo&gt; jdkInfoList() {</span>
<span class="udiff-line-modified-added">+         List&lt;String&gt; jdkList = jdkList();</span>
<span class="udiff-line-modified-added">+         jdkList.add(System.getProperty(&quot;test.jdk&quot;));</span>
  
          Set&lt;JdkInfo&gt; jdkInfoList = new LinkedHashSet&lt;&gt;();
          for (String jdkPath : jdkList) {
              JdkInfo jdkInfo = new JdkInfo(jdkPath);
              // JDK version must be unique.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -220,18 +293,20 @@</span>
              }
          }
          return jdkInfoList;
      }
  
<span class="udiff-line-modified-removed">-     private static List&lt;String&gt; jdkList(String listFileProp) throws IOException {</span>
<span class="udiff-line-modified-removed">-         String listFile = System.getProperty(listFileProp);</span>
<span class="udiff-line-modified-removed">-         System.out.println(listFileProp + &quot;=&quot; + listFile);</span>
<span class="udiff-line-modified-added">+     private static List&lt;String&gt; jdkList() {</span>
<span class="udiff-line-modified-added">+         String listFile = System.getProperty(&quot;jdkListFile&quot;);</span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;jdk list file: &quot; + listFile);</span>
          if (listFile != null &amp;&amp; Files.exists(Paths.get(listFile))) {
              try (Stream&lt;String&gt; lines = Files.lines(Paths.get(listFile))) {
                  return lines.filter(line -&gt; {
                      return !line.trim().isEmpty();
                  }).collect(Collectors.toList());
<span class="udiff-line-added">+             } catch (IOException e) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Cannot get jdk list&quot;, e);</span>
              }
          } else {
              return new ArrayList&lt;&gt;();
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -271,58 +346,10 @@</span>
      private static OutputAnalyzer runClient(String jdkPath,
              Map&lt;String, String&gt; props) {
          return ProcessUtils.java(jdkPath, props, Client.class);
      }
  
<span class="udiff-line-removed">-     // Generates the test result report.</span>
<span class="udiff-line-removed">-     private static boolean generateReport(List&lt;TestCase&gt; testCases)</span>
<span class="udiff-line-removed">-             throws IOException {</span>
<span class="udiff-line-removed">-         boolean failed = false;</span>
<span class="udiff-line-removed">-         StringBuilder report = new StringBuilder();</span>
<span class="udiff-line-removed">-         report.append(Utils.startHtml());</span>
<span class="udiff-line-removed">-         report.append(Utils.tableStyle());</span>
<span class="udiff-line-removed">-         report.append(Utils.startTable());</span>
<span class="udiff-line-removed">-         report.append(Utils.row(</span>
<span class="udiff-line-removed">-                 &quot;No.&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ServerJDK&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ClientJDK&quot;,</span>
<span class="udiff-line-removed">-                 &quot;Protocol&quot;,</span>
<span class="udiff-line-removed">-                 &quot;CipherSuite&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ClientAuth&quot;,</span>
<span class="udiff-line-removed">-                 &quot;SNI&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ALPN&quot;,</span>
<span class="udiff-line-removed">-                 &quot;Status&quot;));</span>
<span class="udiff-line-removed">-         for (int i = 0, size = testCases.size(); i &lt; size; i++) {</span>
<span class="udiff-line-removed">-             TestCase testCase = testCases.get(i);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             report.append(Utils.row(</span>
<span class="udiff-line-removed">-                     Utils.anchorLink(</span>
<span class="udiff-line-removed">-                             Utils.TEST_LOG,</span>
<span class="udiff-line-removed">-                             testCase.toString(),</span>
<span class="udiff-line-removed">-                             i + &quot;&quot;),</span>
<span class="udiff-line-removed">-                     testCase.serverJdk.version,</span>
<span class="udiff-line-removed">-                     testCase.clientJdk.version,</span>
<span class="udiff-line-removed">-                     testCase.useCase.protocol.name,</span>
<span class="udiff-line-removed">-                     testCase.useCase.cipherSuite,</span>
<span class="udiff-line-removed">-                     Utils.boolToStr(</span>
<span class="udiff-line-removed">-                             testCase.useCase.clientAuth),</span>
<span class="udiff-line-removed">-                     Utils.boolToStr(</span>
<span class="udiff-line-removed">-                             testCase.useCase.serverName == UseCase.ServerName.EXAMPLE),</span>
<span class="udiff-line-removed">-                     Utils.boolToStr(</span>
<span class="udiff-line-removed">-                             testCase.useCase.appProtocol == UseCase.AppProtocol.EXAMPLE),</span>
<span class="udiff-line-removed">-                     testCase.getStatus()));</span>
<span class="udiff-line-removed">-             failed = failed</span>
<span class="udiff-line-removed">-                     || testCase.getStatus() == Status.FAIL</span>
<span class="udiff-line-removed">-                     || testCase.getStatus() == Status.UNEXPECTED_SUCCESS;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         report.append(Utils.endTable());</span>
<span class="udiff-line-removed">-         report.append(Utils.endHtml());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         generateFile(&quot;report.html&quot;, report.toString());</span>
<span class="udiff-line-removed">-         return failed;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      private static void generateFile(String path, String content)
              throws IOException {
          try(FileWriter writer = new FileWriter(new File(path))) {
              writer.write(content);
          }
</pre>
<center><a href="Client.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="JdkInfo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>