<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/NetworkInterface/NetworkInterfaceStreamTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 8081678 8131155
 26  * @summary Tests for stream returning methods
 27  * @library /lib/testlibrary/bootlib /test/lib
 28  * @build java.base/java.util.stream.OpTestCase
 29  * @run testng/othervm NetworkInterfaceStreamTest
 30  * @run testng/othervm -Djava.net.preferIPv4Stack=true NetworkInterfaceStreamTest
 31  */
 32 
 33 import org.testng.annotations.BeforeTest;
 34 import org.testng.annotations.Test;
 35 
 36 import java.net.InetAddress;
 37 import java.net.NetworkInterface;
 38 import java.net.SocketException;
 39 import java.util.ArrayList;
 40 import java.util.Collection;
 41 import java.util.Collections;
 42 import java.util.function.Supplier;
 43 import java.util.stream.OpTestCase;
 44 import java.util.stream.Stream;
 45 import java.util.stream.TestData;
 46 
 47 import jdk.test.lib.net.IPSupport;
 48 
 49 public class NetworkInterfaceStreamTest extends OpTestCase {
 50 
 51     private final static boolean IS_WINDOWS = System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;);
 52 
 53     @BeforeTest
 54     void setup() {
 55         IPSupport.throwSkippedExceptionIfNonOperational();
 56     }
 57 
 58     @Test
 59     public void testNetworkInterfaces() throws SocketException {
 60         Supplier&lt;Stream&lt;NetworkInterface&gt;&gt; ss = () -&gt; {
 61             try {
 62                 return NetworkInterface.networkInterfaces()
 63                         .filter(ni -&gt; isIncluded(ni));
 64             }
 65             catch (SocketException e) {
 66                 throw new RuntimeException(e);
 67             }
 68         };
 69 
 70         Collection&lt;NetworkInterface&gt; enums = Collections.list(NetworkInterface.getNetworkInterfaces());
 71         Collection&lt;NetworkInterface&gt; expected = new ArrayList&lt;&gt;();
 72         enums.forEach(ni -&gt; {
 73             if (isIncluded(ni)) {
 74                 expected.add(ni);
 75             }
 76         });
 77         withData(TestData.Factory.ofSupplier(&quot;Top-level network interfaces&quot;, ss))
 78                 .stream(s -&gt; s)
 79                 .expectedResult(expected)
 80                 .exercise();
 81     }
 82 
 83     private Collection&lt;NetworkInterface&gt; getAllNetworkInterfaces() throws SocketException {
 84         Collection&lt;NetworkInterface&gt; anis = new ArrayList&lt;&gt;();
 85         for (NetworkInterface ni : Collections.list(NetworkInterface.getNetworkInterfaces())) {
 86             getAllSubNetworkInterfaces(ni, anis);
 87         }
 88         return anis;
 89     }
 90 
 91     private void getAllSubNetworkInterfaces(NetworkInterface ni, Collection&lt;NetworkInterface&gt; result) {
 92         if (isIncluded(ni)) {
 93             result.add(ni);
 94         }
 95 
 96         for (NetworkInterface sni : Collections.list(ni.getSubInterfaces())) {
 97             getAllSubNetworkInterfaces(sni, result);
 98         }
 99     }
100 
101     private Stream&lt;NetworkInterface&gt; allNetworkInterfaces() throws SocketException {
102         return NetworkInterface.networkInterfaces()
103                 .filter(ni -&gt; isIncluded(ni))
104                 .flatMap(this::allSubNetworkInterfaces);
105     }
106 
107     private Stream&lt;NetworkInterface&gt; allSubNetworkInterfaces(NetworkInterface ni) {
108         return Stream.concat(
109                 Stream.of(ni),
110                 ni.subInterfaces().filter(sni -&gt; isIncluded(sni)).flatMap(this::allSubNetworkInterfaces));
111     }
112 
113     @Test
114     public void testSubNetworkInterfaces() throws SocketException {
115         Supplier&lt;Stream&lt;NetworkInterface&gt;&gt; ss = () -&gt; {
116             try {
117                 return allNetworkInterfaces();
118             }
119             catch (SocketException e) {
120                 throw new RuntimeException(e);
121             }
122         };
123 
124         Collection&lt;NetworkInterface&gt; expected = getAllNetworkInterfaces();
125         withData(TestData.Factory.ofSupplier(&quot;All network interfaces&quot;, ss))
126                 .stream(s -&gt; s)
127                 .expectedResult(expected)
128                 .exercise();
129     }
130 
131 
132     @Test
133     public void testInetAddresses() throws SocketException {
134         Supplier&lt;Stream&lt;InetAddress&gt;&gt; ss = () -&gt; {
135             try {
136                 return NetworkInterface.networkInterfaces()
137                         .filter(ni -&gt; isIncluded(ni))
138                         .flatMap(NetworkInterface::inetAddresses);
139             }
140             catch (SocketException e) {
141                 throw new RuntimeException(e);
142             }
143         };
144 
145         Collection&lt;NetworkInterface&gt; nis = Collections.list(NetworkInterface.getNetworkInterfaces());
146         Collection&lt;InetAddress&gt; expected = new ArrayList&lt;&gt;();
147         for (NetworkInterface ni : nis) {
148             if (isIncluded(ni)) {
149                 expected.addAll(Collections.list(ni.getInetAddresses()));
150             }
151         }
152         withData(TestData.Factory.ofSupplier(&quot;All inet addresses&quot;, ss))
153                 .stream(s -&gt; s)
154                 .expectedResult(expected)
155                 .exercise();
156     }
157 
158     /**
159      * Check if the input network interface should be included in the test. It is necessary to exclude
160      * &quot;Teredo Tunneling Pseudo-Interface&quot; whose configuration can be variable during a test run.
161      *
162      * @param ni a network interace
163      * @return false if it is a &quot;Teredo Tunneling Pseudo-Interface&quot;, otherwise true.
164      */
165     private boolean isIncluded(NetworkInterface ni) {
166         if (!IS_WINDOWS) {
167             return true;
168         }
169 
170         String dName = ni.getDisplayName();
171         return dName == null || !dName.contains(&quot;Teredo&quot;);
172     }
173 
174 }
175 
    </pre>
  </body>
</html>