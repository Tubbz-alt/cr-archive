<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/HttpURLConnection/SetAuthenticator/HTTPTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="HTTPSetAuthenticatorTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="HTTPTestServer.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/HttpURLConnection/SetAuthenticator/HTTPTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -38,10 +38,11 @@</span>
  import javax.net.ssl.HostnameVerifier;
  import javax.net.ssl.HttpsURLConnection;
  import javax.net.ssl.SSLContext;
  import javax.net.ssl.SSLSession;
  import jdk.test.lib.net.SimpleSSLContext;
<span class="udiff-line-added">+ import static java.net.Proxy.NO_PROXY;</span>
  
  /*
   * @test
   * @bug 8169415
   * @library /test/lib
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,20 +88,22 @@</span>
          // authenticator from the server side.
          private final ThreadLocal&lt;Boolean&gt; skipCount = new ThreadLocal&lt;&gt;();
          // count will be incremented every time getPasswordAuthentication()
          // is called from the client side.
          final AtomicInteger count = new AtomicInteger();
<span class="udiff-line-added">+         private final String name;</span>
  
<span class="udiff-line-modified-removed">-         public HttpTestAuthenticator(String realm, String username) {</span>
<span class="udiff-line-modified-added">+         public HttpTestAuthenticator(String name, String realm, String username) {</span>
<span class="udiff-line-added">+             this.name = name;</span>
              this.realm = realm;
              this.username = username;
          }
  
          @Override
          protected PasswordAuthentication getPasswordAuthentication() {
              if (skipCount.get() == null || skipCount.get().booleanValue() == false) {
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;Authenticator called: &quot; + count.incrementAndGet());</span>
<span class="udiff-line-modified-added">+                 System.out.println(&quot;Authenticator &quot; + name + &quot; called: &quot; + count.incrementAndGet());</span>
              }
              return new PasswordAuthentication(getUserName(),
                      new char[] {&#39;b&#39;,&#39;a&#39;,&#39;r&#39;});
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,21 +119,26 @@</span>
                  }
              }
              throw new SecurityException(&quot;User unknown: &quot; + user);
          }
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public String toString() {</span>
<span class="udiff-line-added">+             return super.toString() + &quot;[name=\&quot;&quot; + name + &quot;\&quot;]&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          public final String getUserName() {
              return username;
          }
          public final String getRealm() {
              return realm;
          }
  
      }
      public static final HttpTestAuthenticator AUTHENTICATOR;
      static {
<span class="udiff-line-modified-removed">-         AUTHENTICATOR = new HttpTestAuthenticator(&quot;dublin&quot;, &quot;foox&quot;);</span>
<span class="udiff-line-modified-added">+         AUTHENTICATOR = new HttpTestAuthenticator(&quot;AUTHENTICATOR&quot;,&quot;dublin&quot;, &quot;foox&quot;);</span>
          Authenticator.setDefault(AUTHENTICATOR);
      }
  
      static {
          try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -256,27 +264,40 @@</span>
      }
  
      public static URL url(HttpProtocolType protocol, InetSocketAddress address,
                            String path) throws MalformedURLException {
          return new URL(protocol(protocol),
<span class="udiff-line-modified-removed">-                        address.getHostString(),</span>
<span class="udiff-line-modified-added">+                        address.getAddress().getHostAddress(),</span>
                         address.getPort(), path);
      }
  
      public static Proxy proxy(HTTPTestServer server, HttpAuthType authType) {
<span class="udiff-line-modified-removed">-         return (authType == HttpAuthType.PROXY)</span>
<span class="udiff-line-modified-removed">-                ? new Proxy(Proxy.Type.HTTP, server.getAddress())</span>
<span class="udiff-line-modified-removed">-                : null;</span>
<span class="udiff-line-modified-added">+         if (authType != HttpAuthType.PROXY) return null;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         InetSocketAddress proxyAddress = server.getProxyAddress();</span>
<span class="udiff-line-added">+         if (!proxyAddress.isUnresolved()) {</span>
<span class="udiff-line-added">+             // Forces the proxy to use an unresolved address created</span>
<span class="udiff-line-added">+             // from the actual IP address to avoid using the proxy</span>
<span class="udiff-line-added">+             // address hostname which would result in resolving to</span>
<span class="udiff-line-added">+             // a posibly different address. For instance we want to</span>
<span class="udiff-line-added">+             // avoid cases such as:</span>
<span class="udiff-line-added">+             //    ::1 =&gt; &quot;localhost&quot; =&gt; 127.0.0.1</span>
<span class="udiff-line-added">+             proxyAddress = InetSocketAddress.</span>
<span class="udiff-line-added">+                 createUnresolved(proxyAddress.getAddress().getHostAddress(),</span>
<span class="udiff-line-added">+                                  proxyAddress.getPort());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new Proxy(Proxy.Type.HTTP, proxyAddress);</span>
      }
  
      public static HttpURLConnection openConnection(URL url,
                                                     HttpAuthType authType,
                                                     Proxy proxy)
                                      throws IOException {
  
          HttpURLConnection conn = (HttpURLConnection)
                  (authType == HttpAuthType.PROXY
                      ? url.openConnection(proxy)
<span class="udiff-line-modified-removed">-                     : url.openConnection());</span>
<span class="udiff-line-modified-added">+                     : url.openConnection(NO_PROXY));</span>
          return conn;
      }
  }
</pre>
<center><a href="HTTPSetAuthenticatorTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="HTTPTestServer.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>