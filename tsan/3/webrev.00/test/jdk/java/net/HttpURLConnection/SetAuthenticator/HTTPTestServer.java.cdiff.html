<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/HttpURLConnection/SetAuthenticator/HTTPTestServer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="HTTPTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../UnmodifiableMaps.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/HttpURLConnection/SetAuthenticator/HTTPTestServer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 163,11 ***</span>
              final List&lt;B&gt; toClose = new ArrayList&lt;&gt;();
              try {
                  for (int i = 1; i &lt;= max; i++) {
                      B bindable = createBindable();
                      SocketAddress address = getAddress(bindable);
<span class="line-modified">!                     String key = address.toString();</span>
                      if (addresses.addIfAbsent(key)) {
                         System.out.println(&quot;Socket bound to: &quot; + key
                                            + &quot; after &quot; + i + &quot; attempt(s)&quot;);
                         return bindable;
                      }
<span class="line-new-header">--- 163,11 ---</span>
              final List&lt;B&gt; toClose = new ArrayList&lt;&gt;();
              try {
                  for (int i = 1; i &lt;= max; i++) {
                      B bindable = createBindable();
                      SocketAddress address = getAddress(bindable);
<span class="line-modified">!                     String key = toString(address);</span>
                      if (addresses.addIfAbsent(key)) {
                         System.out.println(&quot;Socket bound to: &quot; + key
                                            + &quot; after &quot; + i + &quot; attempt(s)&quot;);
                         return bindable;
                      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,10 ***</span>
<span class="line-new-header">--- 186,20 ---</span>
              }
              throw new IOException(&quot;Couldn&#39;t bind socket after &quot; + max + &quot; attempts: &quot;
                                    + &quot;addresses used before: &quot; + addresses);
          }
  
<span class="line-added">+         private static String toString(SocketAddress address) {</span>
<span class="line-added">+             // We don&#39;t rely on address.toString(): sometimes it can be</span>
<span class="line-added">+             // &quot;/127.0.0.1:port&quot;, sometimes it can be &quot;localhost/127.0.0.1:port&quot;</span>
<span class="line-added">+             // Instead we compose our own string representation:</span>
<span class="line-added">+             InetSocketAddress candidate = (InetSocketAddress) address;</span>
<span class="line-added">+             String hostAddr = candidate.getAddress().getHostAddress();</span>
<span class="line-added">+             if (hostAddr.contains(&quot;:&quot;)) hostAddr = &quot;[&quot; + hostAddr + &quot;]&quot;;</span>
<span class="line-added">+             return hostAddr + &quot;:&quot; + candidate.getPort();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          protected abstract B createBindable() throws IOException;
  
          protected abstract SocketAddress getAddress(B bindable);
  
          protected abstract void close(B bindable) throws IOException;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 389,10 ***</span>
<span class="line-new-header">--- 399,14 ---</span>
  
      public InetSocketAddress getAddress() {
          return serverImpl.getAddress();
      }
  
<span class="line-added">+     public InetSocketAddress getProxyAddress() {</span>
<span class="line-added">+         return serverImpl.getAddress();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public void stop() {
          serverImpl.stop(0);
          if (redirect != null) {
              redirect.stop();
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 964,10 ***</span>
<span class="line-new-header">--- 978,12 ---</span>
      // CONNECT and then redirect streams to the real server.
      static class HttpsProxyTunnel extends HTTPTestServer
              implements Runnable {
  
          final ServerSocket ss;
<span class="line-added">+         private volatile boolean stop;</span>
<span class="line-added">+ </span>
          public HttpsProxyTunnel(HttpServer server, HTTPTestServer target,
                                 HttpHandler delegate)
                  throws IOException {
              super(server, target, delegate);
              System.out.flush();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 982,13 ***</span>
              t.start();
          }
  
          @Override
          public void stop() {
<span class="line-modified">!             super.stop();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 ss.close();</span>
              } catch (IOException ex) {
                  if (DEBUG) ex.printStackTrace(System.out);
              }
          }
  
<span class="line-new-header">--- 998,14 ---</span>
              t.start();
          }
  
          @Override
          public void stop() {
<span class="line-modified">!             try (var toClose = ss) {</span>
<span class="line-modified">!                 stop = true;</span>
<span class="line-modified">!                 System.out.println(&quot;Server &quot; + ss + &quot; stop requested&quot;);</span>
<span class="line-added">+                 super.stop();</span>
              } catch (IOException ex) {
                  if (DEBUG) ex.printStackTrace(System.out);
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1017,11 ***</span>
                  }
              };
          }
  
          @Override
<span class="line-modified">!         public InetSocketAddress getAddress() {</span>
              return new InetSocketAddress(ss.getInetAddress(), ss.getLocalPort());
          }
  
          // This is a bit shaky. It doesn&#39;t handle continuation
          // lines, but our client shouldn&#39;t send any.
<span class="line-new-header">--- 1034,11 ---</span>
                  }
              };
          }
  
          @Override
<span class="line-modified">!         public InetSocketAddress getProxyAddress() {</span>
              return new InetSocketAddress(ss.getInetAddress(), ss.getLocalPort());
          }
  
          // This is a bit shaky. It doesn&#39;t handle continuation
          // lines, but our client shouldn&#39;t send any.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1034,91 ***</span>
              int c;
              while ((c = r.read()) != -1) {
                  if (c == &#39;\n&#39;) break;
                  b.appendCodePoint(c);
              }
              if (b.codePointAt(b.length() -1) == &#39;\r&#39;) {
                  b.delete(b.length() -1, b.length());
              }
              return b.toString();
          }
  
          @Override
          public void run() {
              Socket clientConnection = null;
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 while (true) {</span>
<span class="line-modified">!                     System.out.println(&quot;Tunnel: Waiting for client&quot;);</span>
<span class="line-modified">!                     Socket previous = clientConnection;</span>
                      try {
<span class="line-modified">!                         clientConnection = ss.accept();</span>
<span class="line-modified">!                     } catch (IOException io) {</span>
<span class="line-modified">!                         if (DEBUG) io.printStackTrace(System.out);</span>
<span class="line-modified">!                         break;</span>
<span class="line-modified">!                     } finally {</span>
<span class="line-modified">!                         // close the previous connection</span>
<span class="line-modified">!                         if (previous != null) previous.close();</span>
                      }
<span class="line-modified">!                     System.out.println(&quot;Tunnel: Client accepted&quot;);</span>
<span class="line-modified">!                     Socket targetConnection = null;</span>
<span class="line-modified">!                     InputStream  ccis = clientConnection.getInputStream();</span>
<span class="line-modified">!                     OutputStream ccos = clientConnection.getOutputStream();</span>
<span class="line-modified">!                     Writer w = new OutputStreamWriter(</span>
<span class="line-modified">!                                    clientConnection.getOutputStream(), &quot;UTF-8&quot;);</span>
<span class="line-modified">!                     PrintWriter pw = new PrintWriter(w);</span>
<span class="line-modified">!                     System.out.println(&quot;Tunnel: Reading request line&quot;);</span>
<span class="line-modified">!                     String requestLine = readLine(ccis);</span>
<span class="line-modified">!                     System.out.println(&quot;Tunnel: Request line: &quot; + requestLine);</span>
<span class="line-modified">!                     if (requestLine.startsWith(&quot;CONNECT &quot;)) {</span>
<span class="line-modified">!                         // We should probably check that the next word following</span>
<span class="line-modified">!                         // CONNECT is the host:port of our HTTPS serverImpl.</span>
<span class="line-removed">-                         // Some improvement for a followup!</span>
<span class="line-removed">- </span>
<span class="line-removed">-                         // Read all headers until we find the empty line that</span>
<span class="line-removed">-                         // signals the end of all headers.</span>
<span class="line-removed">-                         while(!requestLine.equals(&quot;&quot;)) {</span>
<span class="line-removed">-                             System.out.println(&quot;Tunnel: Reading header: &quot;</span>
<span class="line-removed">-                                                + (requestLine = readLine(ccis)));</span>
                          }
<span class="line-removed">- </span>
<span class="line-removed">-                         targetConnection = new Socket(</span>
<span class="line-removed">-                                 serverImpl.getAddress().getAddress(),</span>
<span class="line-removed">-                                 serverImpl.getAddress().getPort());</span>
<span class="line-removed">- </span>
<span class="line-removed">-                         // Then send the 200 OK response to the client</span>
<span class="line-removed">-                         System.out.println(&quot;Tunnel: Sending &quot;</span>
<span class="line-removed">-                                            + &quot;HTTP/1.1 200 OK\r\n\r\n&quot;);</span>
<span class="line-removed">-                         pw.print(&quot;HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n&quot;);</span>
<span class="line-removed">-                         pw.flush();</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         // This should not happen. If it does let our serverImpl</span>
<span class="line-removed">-                         // deal with it.</span>
<span class="line-removed">-                         throw new IOException(&quot;Tunnel: Unexpected status line: &quot;</span>
<span class="line-removed">-                                              + requestLine);</span>
                      }
<span class="line-removed">- </span>
<span class="line-removed">-                     // Pipe the input stream of the client connection to the</span>
<span class="line-removed">-                     // output stream of the target connection and conversely.</span>
<span class="line-removed">-                     // Now the client and target will just talk to each other.</span>
<span class="line-removed">-                     System.out.println(&quot;Tunnel: Starting tunnel pipes&quot;);</span>
<span class="line-removed">-                     Thread t1 = pipe(ccis, targetConnection.getOutputStream(), &#39;+&#39;);</span>
<span class="line-removed">-                     Thread t2 = pipe(targetConnection.getInputStream(), ccos, &#39;-&#39;);</span>
<span class="line-removed">-                     t1.start();</span>
<span class="line-removed">-                     t2.start();</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     // We have only 1 client... wait until it has finished before</span>
<span class="line-removed">-                     // accepting a new connection request.</span>
<span class="line-removed">-                     t1.join();</span>
<span class="line-removed">-                     t2.join();</span>
                  }
<span class="line-modified">!             } catch (Throwable ex) {</span>
                  try {
<span class="line-modified">!                     ss.close();</span>
<span class="line-modified">!                 } catch (IOException ex1) {</span>
<span class="line-modified">!                     ex.addSuppressed(ex1);</span>
                  }
<span class="line-removed">-                 ex.printStackTrace(System.err);</span>
              }
          }
  
      }
  }
<span class="line-new-header">--- 1051,135 ---</span>
              int c;
              while ((c = r.read()) != -1) {
                  if (c == &#39;\n&#39;) break;
                  b.appendCodePoint(c);
              }
<span class="line-added">+             if (b.length() == 0) {</span>
<span class="line-added">+                 return &quot;&quot;;</span>
<span class="line-added">+             }</span>
              if (b.codePointAt(b.length() -1) == &#39;\r&#39;) {
                  b.delete(b.length() -1, b.length());
              }
              return b.toString();
          }
  
          @Override
          public void run() {
              Socket clientConnection = null;
<span class="line-modified">!             while (!stop) {</span>
<span class="line-modified">!                 System.out.println(&quot;Tunnel: Waiting for client at: &quot; + ss);</span>
<span class="line-modified">!                 final Socket previous = clientConnection;</span>
<span class="line-modified">!                 try {</span>
<span class="line-added">+                     clientConnection = ss.accept();</span>
<span class="line-added">+                 } catch (IOException io) {</span>
                      try {
<span class="line-modified">!                         ss.close();</span>
<span class="line-modified">!                     } catch (IOException ex) {</span>
<span class="line-modified">!                         if (DEBUG) {</span>
<span class="line-modified">!                             ex.printStackTrace(System.out);</span>
<span class="line-modified">!                         }</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                     // log the reason that caused the server to stop accepting connections</span>
<span class="line-added">+                     if (!stop) {</span>
<span class="line-added">+                         System.err.println(&quot;Server will stop accepting connections due to an exception:&quot;);</span>
<span class="line-added">+                         io.printStackTrace();</span>
                      }
<span class="line-modified">!                     break;</span>
<span class="line-modified">!                 } finally {</span>
<span class="line-modified">!                     // close the previous connection</span>
<span class="line-modified">!                     if (previous != null) {</span>
<span class="line-modified">!                         try {</span>
<span class="line-modified">!                             previous.close();</span>
<span class="line-modified">!                         } catch (IOException e) {</span>
<span class="line-modified">!                             // ignore</span>
<span class="line-modified">!                             if (DEBUG) {</span>
<span class="line-modified">!                                 System.out.println(&quot;Ignoring exception that happened while closing &quot; +</span>
<span class="line-modified">!                                         &quot;an older connection:&quot;);</span>
<span class="line-modified">!                                 e.printStackTrace(System.out);</span>
<span class="line-modified">!                             }</span>
                          }
                      }
                  }
<span class="line-modified">!                 System.out.println(&quot;Tunnel: Client accepted&quot;);</span>
                  try {
<span class="line-modified">!                     // We have only 1 client... process the current client</span>
<span class="line-modified">!                     // request and wait until it has finished before</span>
<span class="line-modified">!                     // accepting a new connection request.</span>
<span class="line-added">+                     processRequestAndWaitToComplete(clientConnection);</span>
<span class="line-added">+                 } catch (IOException ioe) {</span>
<span class="line-added">+                     // close the client connection</span>
<span class="line-added">+                     try {</span>
<span class="line-added">+                         clientConnection.close();</span>
<span class="line-added">+                     } catch (IOException io) {</span>
<span class="line-added">+                         // ignore</span>
<span class="line-added">+                         if (DEBUG) {</span>
<span class="line-added">+                             System.out.println(&quot;Ignoring exception that happened during client&quot; +</span>
<span class="line-added">+                                     &quot; connection close:&quot;);</span>
<span class="line-added">+                             io.printStackTrace(System.out);</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     } finally {</span>
<span class="line-added">+                         clientConnection = null;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 } catch (Throwable t) {</span>
<span class="line-added">+                     // don&#39;t close the client connection for non-IOExceptions, instead</span>
<span class="line-added">+                     // just log it and move on to accept next connection</span>
<span class="line-added">+                     if (!stop) {</span>
<span class="line-added">+                         t.printStackTrace();</span>
<span class="line-added">+                     }</span>
                  }
              }
          }
  
<span class="line-added">+         private void processRequestAndWaitToComplete(final Socket clientConnection)</span>
<span class="line-added">+                 throws IOException, InterruptedException {</span>
<span class="line-added">+             final Socket targetConnection;</span>
<span class="line-added">+             InputStream  ccis = clientConnection.getInputStream();</span>
<span class="line-added">+             OutputStream ccos = clientConnection.getOutputStream();</span>
<span class="line-added">+             Writer w = new OutputStreamWriter(</span>
<span class="line-added">+                     clientConnection.getOutputStream(), &quot;UTF-8&quot;);</span>
<span class="line-added">+             PrintWriter pw = new PrintWriter(w);</span>
<span class="line-added">+             System.out.println(&quot;Tunnel: Reading request line&quot;);</span>
<span class="line-added">+             String requestLine = readLine(ccis);</span>
<span class="line-added">+             System.out.println(&quot;Tunnel: Request line: &quot; + requestLine);</span>
<span class="line-added">+             if (requestLine.startsWith(&quot;CONNECT &quot;)) {</span>
<span class="line-added">+                 // We should probably check that the next word following</span>
<span class="line-added">+                 // CONNECT is the host:port of our HTTPS serverImpl.</span>
<span class="line-added">+                 // Some improvement for a followup!</span>
<span class="line-added">+ </span>
<span class="line-added">+                 // Read all headers until we find the empty line that</span>
<span class="line-added">+                 // signals the end of all headers.</span>
<span class="line-added">+                 while(!requestLine.equals(&quot;&quot;)) {</span>
<span class="line-added">+                     System.out.println(&quot;Tunnel: Reading header: &quot;</span>
<span class="line-added">+                             + (requestLine = readLine(ccis)));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+ </span>
<span class="line-added">+                 targetConnection = new Socket(</span>
<span class="line-added">+                         serverImpl.getAddress().getAddress(),</span>
<span class="line-added">+                         serverImpl.getAddress().getPort());</span>
<span class="line-added">+ </span>
<span class="line-added">+                 // Then send the 200 OK response to the client</span>
<span class="line-added">+                 System.out.println(&quot;Tunnel: Sending &quot;</span>
<span class="line-added">+                         + &quot;HTTP/1.1 200 OK\r\n\r\n&quot;);</span>
<span class="line-added">+                 pw.print(&quot;HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n&quot;);</span>
<span class="line-added">+                 pw.flush();</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 // This should not happen. If it does then consider it a</span>
<span class="line-added">+                 // client error and throw an IOException</span>
<span class="line-added">+                 System.out.println(&quot;Tunnel: Throwing an IOException due to unexpected&quot; +</span>
<span class="line-added">+                         &quot; request line: &quot; + requestLine);</span>
<span class="line-added">+                 throw new IOException(&quot;Client request error - Unexpected request line&quot;);</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             // Pipe the input stream of the client connection to the</span>
<span class="line-added">+             // output stream of the target connection and conversely.</span>
<span class="line-added">+             // Now the client and target will just talk to each other.</span>
<span class="line-added">+             System.out.println(&quot;Tunnel: Starting tunnel pipes&quot;);</span>
<span class="line-added">+             Thread t1 = pipe(ccis, targetConnection.getOutputStream(), &#39;+&#39;);</span>
<span class="line-added">+             Thread t2 = pipe(targetConnection.getInputStream(), ccos, &#39;-&#39;);</span>
<span class="line-added">+             t1.start();</span>
<span class="line-added">+             t2.start();</span>
<span class="line-added">+             // wait for the request to complete</span>
<span class="line-added">+             t1.join();</span>
<span class="line-added">+             t2.join();</span>
<span class="line-added">+         }</span>
      }
  }
</pre>
<center><a href="HTTPTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../UnmodifiableMaps.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>