<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/net/Socks/SocksIPv6Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 7100957
 26  * @modules jdk.httpserver
 27  * @summary Java doesn&#39;t correctly handle the SOCKS protocol when used over IPv6.
 28  * @run testng SocksIPv6Test
 29  */
 30 
 31 import java.io.BufferedReader;
 32 import java.io.IOException;
 33 import java.io.InputStream;
 34 import java.io.InputStreamReader;
 35 import java.io.OutputStreamWriter;
 36 import java.net.Authenticator;
 37 import java.net.InetSocketAddress;
 38 import java.net.URL;
 39 import java.net.Proxy;
 40 import java.lang.Override;
 41 import java.net.InetAddress;
 42 import java.net.Inet6Address;
 43 import java.net.ServerSocket;
 44 import java.net.SocketException;
 45 import java.net.NetworkInterface;
 46 import java.net.UnknownHostException;
 47 import java.util.Collections;
 48 import java.util.List;
 49 import com.sun.net.httpserver.*;
 50 import java.io.BufferedWriter;
 51 import org.testng.annotations.AfterClass;
 52 import org.testng.annotations.BeforeClass;
 53 import org.testng.annotations.Test;
 54 
 55 import static org.testng.Assert.*;
 56 
 57 public class SocksIPv6Test {
 58 
 59     private HttpServer server;
 60     private SocksServer socks;
 61     private String response = &quot;Hello.&quot;;
 62     private static boolean shouldRun = false;
 63 
 64     @BeforeClass
 65     public void setUp() throws Exception {
 66         shouldRun = ensureInet6AddressFamily() &amp;&amp; ensureIPv6OnLoopback();
 67 
 68         server = HttpServer.create(new InetSocketAddress(0), 0);
 69         server.createContext(&quot;/&quot;, ex -&gt; {
 70             ex.sendResponseHeaders(200, response.length());
 71             try (BufferedWriter writer = new BufferedWriter(
 72                     new OutputStreamWriter(ex.getResponseBody(), &quot;UTF-8&quot;))) {
 73                 writer.write(response);
 74             }
 75             ex.close();
 76         });
 77         server.start();
 78 
 79         socks = new SocksServer(0, false);
 80         socks.addUser(&quot;user&quot;, &quot;pass&quot;);
 81         socks.start();
 82 
 83         Authenticator.setDefault(new Authenticator() {
 84             @Override
 85             protected java.net.PasswordAuthentication getPasswordAuthentication() {
 86                 return new java.net.PasswordAuthentication(
 87                         &quot;user&quot;, &quot;pass&quot;.toCharArray());
 88             }
 89         });
 90     }
 91 
 92     private boolean ensureIPv6OnLoopback() throws Exception {
 93         boolean ipv6 = false;
 94 
 95         List&lt;NetworkInterface&gt; nics = Collections.list(NetworkInterface.getNetworkInterfaces());
 96         for (NetworkInterface nic : nics) {
 97             if (!nic.isLoopback()) {
 98                 continue;
 99             }
100             List&lt;InetAddress&gt; addrs = Collections.list(nic.getInetAddresses());
101             for (InetAddress addr : addrs) {
102                 if (addr instanceof Inet6Address) {
103                     ipv6 = true;
104                     break;
105                 }
106             }
107         }
108         if (!ipv6)
109             System.out.println(&quot;IPv6 is not enabled on loopback. Skipping test suite.&quot;);
110         return ipv6;
111     }
112 
113     private boolean ensureInet6AddressFamily() throws IOException {
114         try (ServerSocket s = new ServerSocket()) {
115             s.bind(new InetSocketAddress(&quot;::1&quot;, 0));
116             return true;
117         } catch (SocketException e) {
118             System.out.println(&quot;Inet 6 address family is not available. Skipping test suite.&quot;);
119         }
120         return false;
121     }
122 
123     @Test(groups = &quot;unit&quot;)
124     public void testSocksOverIPv6() throws Exception {
125         if (!shouldRun) return;
126 
127         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(&quot;::1&quot;,
128                 socks.getPort()));
129         URL url = new URL(&quot;http://[::1]:&quot; + server.getAddress().getPort());
130         java.net.URLConnection conn = url.openConnection(proxy);
131         String actual = &quot;&quot;;
132         try (BufferedReader reader = new BufferedReader(
133                 new InputStreamReader(conn.getInputStream()))) {
134             actual = reader.readLine();
135         }
136         assertEquals(actual, response);
137     }
138 
139     @Test(groups = &quot;unit&quot;)
140     public void testSocksOverIPv6Hostname() throws Exception {
141         if (!shouldRun) return;
142 
143         String ipv6Hostname = InetAddress.getByName(&quot;::1&quot;).getHostName();
144         String ipv4Hostname = InetAddress.getByName(&quot;127.0.0.1&quot;).getHostName();
145 
146         if (ipv6Hostname.equals(InetAddress.getByName(&quot;::1&quot;).getHostAddress())) {
147             System.out.println(&quot;Unable to get the hostname of the IPv6 loopback &quot;
148                     + &quot;address. Skipping test case.&quot;);
149             return;
150         }
151 
152         if (ipv6Hostname.equals(ipv4Hostname)) {
153             System.out.println(&quot;IPv6 and IPv4 loopback addresses map to the&quot;
154                     + &quot; same hostname. Skipping test case.&quot;);
155             return;
156         }
157 
158         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(ipv6Hostname,
159                 socks.getPort()));
160         URL url = new URL(&quot;http://&quot; + ipv6Hostname + &quot;:&quot; + server.getAddress().getPort());
161         java.net.URLConnection conn = url.openConnection(proxy);
162         String actual = &quot;&quot;;
163         try (BufferedReader reader = new BufferedReader(
164                 new InputStreamReader(conn.getInputStream()))) {
165             actual = reader.readLine();
166         }
167         assertEquals(actual, response);
168     }
169 
170     @AfterClass
171     public void tearDown() {
172         if (server != null) {
173             server.stop(1);
174         }
175         if (socks != null) {
176             socks.close();
177         }
178     }
179 }
    </pre>
  </body>
</html>