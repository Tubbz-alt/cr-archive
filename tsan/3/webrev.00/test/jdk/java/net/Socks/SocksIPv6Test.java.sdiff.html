<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/Socks/SocksIPv6Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="BadProxySelector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SocksProxyVersion.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Socks/SocksIPv6Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 7100957
 26  * @modules jdk.httpserver

 27  * @summary Java doesn&#39;t correctly handle the SOCKS protocol when used over IPv6.
 28  * @run testng SocksIPv6Test
 29  */
 30 
 31 import java.io.BufferedReader;
 32 import java.io.IOException;
<span class="line-removed"> 33 import java.io.InputStream;</span>
 34 import java.io.InputStreamReader;
 35 import java.io.OutputStreamWriter;
 36 import java.net.Authenticator;
 37 import java.net.InetSocketAddress;
 38 import java.net.URL;
 39 import java.net.Proxy;
 40 import java.lang.Override;
 41 import java.net.InetAddress;
 42 import java.net.Inet6Address;
 43 import java.net.ServerSocket;
 44 import java.net.SocketException;
 45 import java.net.NetworkInterface;
<span class="line-removed"> 46 import java.net.UnknownHostException;</span>
 47 import java.util.Collections;
 48 import java.util.List;
 49 import com.sun.net.httpserver.*;
 50 import java.io.BufferedWriter;

 51 import org.testng.annotations.AfterClass;
 52 import org.testng.annotations.BeforeClass;
 53 import org.testng.annotations.Test;
 54 


 55 import static org.testng.Assert.*;
 56 
 57 public class SocksIPv6Test {
 58 
 59     private HttpServer server;
 60     private SocksServer socks;
 61     private String response = &quot;Hello.&quot;;
<span class="line-removed"> 62     private static boolean shouldRun = false;</span>
 63 
 64     @BeforeClass
 65     public void setUp() throws Exception {
<span class="line-modified"> 66         shouldRun = ensureInet6AddressFamily() &amp;&amp; ensureIPv6OnLoopback();</span>



 67 
<span class="line-modified"> 68         server = HttpServer.create(new InetSocketAddress(0), 0);</span>
 69         server.createContext(&quot;/&quot;, ex -&gt; {
 70             ex.sendResponseHeaders(200, response.length());
 71             try (BufferedWriter writer = new BufferedWriter(
 72                     new OutputStreamWriter(ex.getResponseBody(), &quot;UTF-8&quot;))) {
 73                 writer.write(response);
 74             }
 75             ex.close();
 76         });
 77         server.start();
 78 
<span class="line-modified"> 79         socks = new SocksServer(0, false);</span>
 80         socks.addUser(&quot;user&quot;, &quot;pass&quot;);
 81         socks.start();
 82 
 83         Authenticator.setDefault(new Authenticator() {
 84             @Override
 85             protected java.net.PasswordAuthentication getPasswordAuthentication() {
 86                 return new java.net.PasswordAuthentication(
 87                         &quot;user&quot;, &quot;pass&quot;.toCharArray());
 88             }
 89         });
 90     }
 91 
 92     private boolean ensureIPv6OnLoopback() throws Exception {
 93         boolean ipv6 = false;
 94 
 95         List&lt;NetworkInterface&gt; nics = Collections.list(NetworkInterface.getNetworkInterfaces());
 96         for (NetworkInterface nic : nics) {
 97             if (!nic.isLoopback()) {
 98                 continue;
 99             }
</pre>
<hr />
<pre>
105                 }
106             }
107         }
108         if (!ipv6)
109             System.out.println(&quot;IPv6 is not enabled on loopback. Skipping test suite.&quot;);
110         return ipv6;
111     }
112 
113     private boolean ensureInet6AddressFamily() throws IOException {
114         try (ServerSocket s = new ServerSocket()) {
115             s.bind(new InetSocketAddress(&quot;::1&quot;, 0));
116             return true;
117         } catch (SocketException e) {
118             System.out.println(&quot;Inet 6 address family is not available. Skipping test suite.&quot;);
119         }
120         return false;
121     }
122 
123     @Test(groups = &quot;unit&quot;)
124     public void testSocksOverIPv6() throws Exception {
<span class="line-removed">125         if (!shouldRun) return;</span>
<span class="line-removed">126 </span>
127         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(&quot;::1&quot;,
128                 socks.getPort()));
129         URL url = new URL(&quot;http://[::1]:&quot; + server.getAddress().getPort());
130         java.net.URLConnection conn = url.openConnection(proxy);
131         String actual = &quot;&quot;;
132         try (BufferedReader reader = new BufferedReader(
133                 new InputStreamReader(conn.getInputStream()))) {
134             actual = reader.readLine();
135         }
136         assertEquals(actual, response);
137     }
138 
139     @Test(groups = &quot;unit&quot;)
140     public void testSocksOverIPv6Hostname() throws Exception {
<span class="line-modified">141         if (!shouldRun) return;</span>













142 
<span class="line-modified">143         String ipv6Hostname = InetAddress.getByName(&quot;::1&quot;).getHostName();</span>
<span class="line-modified">144         String ipv4Hostname = InetAddress.getByName(&quot;127.0.0.1&quot;).getHostName();</span>
145 
<span class="line-modified">146         if (ipv6Hostname.equals(InetAddress.getByName(&quot;::1&quot;).getHostAddress())) {</span>
147             System.out.println(&quot;Unable to get the hostname of the IPv6 loopback &quot;
148                     + &quot;address. Skipping test case.&quot;);
149             return;
150         }
151 
<span class="line-modified">152         if (ipv6Hostname.equals(ipv4Hostname)) {</span>
153             System.out.println(&quot;IPv6 and IPv4 loopback addresses map to the&quot;
154                     + &quot; same hostname. Skipping test case.&quot;);
155             return;
156         }
157 









158         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(ipv6Hostname,
159                 socks.getPort()));
160         URL url = new URL(&quot;http://&quot; + ipv6Hostname + &quot;:&quot; + server.getAddress().getPort());
161         java.net.URLConnection conn = url.openConnection(proxy);
162         String actual = &quot;&quot;;
163         try (BufferedReader reader = new BufferedReader(
164                 new InputStreamReader(conn.getInputStream()))) {
165             actual = reader.readLine();
166         }
167         assertEquals(actual, response);
168     }
169 
170     @AfterClass
171     public void tearDown() {
172         if (server != null) {
173             server.stop(1);
174         }
175         if (socks != null) {
176             socks.close();
177         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 7100957
 26  * @modules jdk.httpserver
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @summary Java doesn&#39;t correctly handle the SOCKS protocol when used over IPv6.
 29  * @run testng SocksIPv6Test
 30  */
 31 
 32 import java.io.BufferedReader;
 33 import java.io.IOException;

 34 import java.io.InputStreamReader;
 35 import java.io.OutputStreamWriter;
 36 import java.net.Authenticator;
 37 import java.net.InetSocketAddress;
 38 import java.net.URL;
 39 import java.net.Proxy;
 40 import java.lang.Override;
 41 import java.net.InetAddress;
 42 import java.net.Inet6Address;
 43 import java.net.ServerSocket;
 44 import java.net.SocketException;
 45 import java.net.NetworkInterface;

 46 import java.util.Collections;
 47 import java.util.List;
 48 import com.sun.net.httpserver.*;
 49 import java.io.BufferedWriter;
<span class="line-added"> 50 import org.testng.SkipException;</span>
 51 import org.testng.annotations.AfterClass;
 52 import org.testng.annotations.BeforeClass;
 53 import org.testng.annotations.Test;
 54 
<span class="line-added"> 55 import jdk.test.lib.NetworkConfiguration;</span>
<span class="line-added"> 56 </span>
 57 import static org.testng.Assert.*;
 58 
 59 public class SocksIPv6Test {
 60 
 61     private HttpServer server;
 62     private SocksServer socks;
 63     private String response = &quot;Hello.&quot;;

 64 
 65     @BeforeClass
 66     public void setUp() throws Exception {
<span class="line-modified"> 67         if (!ensureInet6AddressFamily() || !ensureIPv6OnLoopback()) {</span>
<span class="line-added"> 68             NetworkConfiguration.printSystemConfiguration(System.out);</span>
<span class="line-added"> 69             throw new SkipException(&quot;Host does not support IPv6&quot;);</span>
<span class="line-added"> 70         }</span>
 71 
<span class="line-modified"> 72         server = HttpServer.create(new InetSocketAddress(&quot;::1&quot;, 0), 0);</span>
 73         server.createContext(&quot;/&quot;, ex -&gt; {
 74             ex.sendResponseHeaders(200, response.length());
 75             try (BufferedWriter writer = new BufferedWriter(
 76                     new OutputStreamWriter(ex.getResponseBody(), &quot;UTF-8&quot;))) {
 77                 writer.write(response);
 78             }
 79             ex.close();
 80         });
 81         server.start();
 82 
<span class="line-modified"> 83         socks = new SocksServer(InetAddress.getByName(&quot;::1&quot;), 0, false);</span>
 84         socks.addUser(&quot;user&quot;, &quot;pass&quot;);
 85         socks.start();
 86 
 87         Authenticator.setDefault(new Authenticator() {
 88             @Override
 89             protected java.net.PasswordAuthentication getPasswordAuthentication() {
 90                 return new java.net.PasswordAuthentication(
 91                         &quot;user&quot;, &quot;pass&quot;.toCharArray());
 92             }
 93         });
 94     }
 95 
 96     private boolean ensureIPv6OnLoopback() throws Exception {
 97         boolean ipv6 = false;
 98 
 99         List&lt;NetworkInterface&gt; nics = Collections.list(NetworkInterface.getNetworkInterfaces());
100         for (NetworkInterface nic : nics) {
101             if (!nic.isLoopback()) {
102                 continue;
103             }
</pre>
<hr />
<pre>
109                 }
110             }
111         }
112         if (!ipv6)
113             System.out.println(&quot;IPv6 is not enabled on loopback. Skipping test suite.&quot;);
114         return ipv6;
115     }
116 
117     private boolean ensureInet6AddressFamily() throws IOException {
118         try (ServerSocket s = new ServerSocket()) {
119             s.bind(new InetSocketAddress(&quot;::1&quot;, 0));
120             return true;
121         } catch (SocketException e) {
122             System.out.println(&quot;Inet 6 address family is not available. Skipping test suite.&quot;);
123         }
124         return false;
125     }
126 
127     @Test(groups = &quot;unit&quot;)
128     public void testSocksOverIPv6() throws Exception {


129         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(&quot;::1&quot;,
130                 socks.getPort()));
131         URL url = new URL(&quot;http://[::1]:&quot; + server.getAddress().getPort());
132         java.net.URLConnection conn = url.openConnection(proxy);
133         String actual = &quot;&quot;;
134         try (BufferedReader reader = new BufferedReader(
135                 new InputStreamReader(conn.getInputStream()))) {
136             actual = reader.readLine();
137         }
138         assertEquals(actual, response);
139     }
140 
141     @Test(groups = &quot;unit&quot;)
142     public void testSocksOverIPv6Hostname() throws Exception {
<span class="line-modified">143         InetAddress ipv6Loopback = InetAddress.getByName(&quot;::1&quot;);</span>
<span class="line-added">144         String ipv6Hostname = ipv6Loopback.getHostName();</span>
<span class="line-added">145         String ipv6HostAddress = ipv6Loopback.getHostAddress();</span>
<span class="line-added">146         InetAddress ipv4Loopback;</span>
<span class="line-added">147         String ipv4Hostname;</span>
<span class="line-added">148         String ipv4HostAddress;</span>
<span class="line-added">149         try {</span>
<span class="line-added">150             ipv4Loopback = InetAddress.getByName(&quot;127.0.0.1&quot;);</span>
<span class="line-added">151             ipv4Hostname = ipv4Loopback == null ? null : ipv4Loopback.getHostName();</span>
<span class="line-added">152             ipv4HostAddress = ipv4Loopback == null ? null : ipv4Loopback.getHostAddress();</span>
<span class="line-added">153         } catch (IOException io) {</span>
<span class="line-added">154             ipv4Hostname = null;</span>
<span class="line-added">155             ipv4HostAddress = null;</span>
<span class="line-added">156         }</span>
157 
<span class="line-modified">158         System.out.println(&quot;ipv6Hostname: &quot; + ipv6Hostname + &quot; / &quot; + ipv6HostAddress);</span>
<span class="line-modified">159         System.out.println(&quot;ipv4Hostname: &quot; + ipv4Hostname + &quot; / &quot; + ipv4HostAddress);</span>
160 
<span class="line-modified">161         if (ipv6Hostname.equals(ipv6HostAddress)) {</span>
162             System.out.println(&quot;Unable to get the hostname of the IPv6 loopback &quot;
163                     + &quot;address. Skipping test case.&quot;);
164             return;
165         }
166 
<span class="line-modified">167         if (ipv4Hostname != null &amp;&amp; ipv6Hostname.equals(ipv4Hostname)) {</span>
168             System.out.println(&quot;IPv6 and IPv4 loopback addresses map to the&quot;
169                     + &quot; same hostname. Skipping test case.&quot;);
170             return;
171         }
172 
<span class="line-added">173         if (!InetAddress.getByName(ipv6Hostname).getHostAddress()</span>
<span class="line-added">174                 .equals(ipv6HostAddress)) {</span>
<span class="line-added">175             System.out.println(ipv6Hostname + &quot; resolves to \&quot;&quot;</span>
<span class="line-added">176                     + InetAddress.getByName(ipv6Hostname).getHostAddress()</span>
<span class="line-added">177                     + &quot;\&quot;, not \&quot;&quot; + ipv6HostAddress +</span>
<span class="line-added">178                     &quot;\&quot;. Skipping test case.&quot;);</span>
<span class="line-added">179             return;</span>
<span class="line-added">180         }</span>
<span class="line-added">181 </span>
182         Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(ipv6Hostname,
183                 socks.getPort()));
184         URL url = new URL(&quot;http://&quot; + ipv6Hostname + &quot;:&quot; + server.getAddress().getPort());
185         java.net.URLConnection conn = url.openConnection(proxy);
186         String actual = &quot;&quot;;
187         try (BufferedReader reader = new BufferedReader(
188                 new InputStreamReader(conn.getInputStream()))) {
189             actual = reader.readLine();
190         }
191         assertEquals(actual, response);
192     }
193 
194     @AfterClass
195     public void tearDown() {
196         if (server != null) {
197             server.stop(1);
198         }
199         if (socks != null) {
200             socks.close();
201         }
</pre>
</td>
</tr>
</table>
<center><a href="BadProxySelector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SocksProxyVersion.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>