<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/Socks/SocksIPv6Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="BadProxySelector.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SocksProxyVersion.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Socks/SocksIPv6Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,17 ***</span>
   */
  
  /* @test
   * @bug 7100957
   * @modules jdk.httpserver
   * @summary Java doesn&#39;t correctly handle the SOCKS protocol when used over IPv6.
   * @run testng SocksIPv6Test
   */
  
  import java.io.BufferedReader;
  import java.io.IOException;
<span class="line-removed">- import java.io.InputStream;</span>
  import java.io.InputStreamReader;
  import java.io.OutputStreamWriter;
  import java.net.Authenticator;
  import java.net.InetSocketAddress;
  import java.net.URL;
<span class="line-new-header">--- 22,17 ---</span>
   */
  
  /* @test
   * @bug 7100957
   * @modules jdk.httpserver
<span class="line-added">+  * @library /test/lib</span>
   * @summary Java doesn&#39;t correctly handle the SOCKS protocol when used over IPv6.
   * @run testng SocksIPv6Test
   */
  
  import java.io.BufferedReader;
  import java.io.IOException;
  import java.io.InputStreamReader;
  import java.io.OutputStreamWriter;
  import java.net.Authenticator;
  import java.net.InetSocketAddress;
  import java.net.URL;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 41,44 ***</span>
  import java.net.InetAddress;
  import java.net.Inet6Address;
  import java.net.ServerSocket;
  import java.net.SocketException;
  import java.net.NetworkInterface;
<span class="line-removed">- import java.net.UnknownHostException;</span>
  import java.util.Collections;
  import java.util.List;
  import com.sun.net.httpserver.*;
  import java.io.BufferedWriter;
  import org.testng.annotations.AfterClass;
  import org.testng.annotations.BeforeClass;
  import org.testng.annotations.Test;
  
  import static org.testng.Assert.*;
  
  public class SocksIPv6Test {
  
      private HttpServer server;
      private SocksServer socks;
      private String response = &quot;Hello.&quot;;
<span class="line-removed">-     private static boolean shouldRun = false;</span>
  
      @BeforeClass
      public void setUp() throws Exception {
<span class="line-modified">!         shouldRun = ensureInet6AddressFamily() &amp;&amp; ensureIPv6OnLoopback();</span>
  
<span class="line-modified">!         server = HttpServer.create(new InetSocketAddress(0), 0);</span>
          server.createContext(&quot;/&quot;, ex -&gt; {
              ex.sendResponseHeaders(200, response.length());
              try (BufferedWriter writer = new BufferedWriter(
                      new OutputStreamWriter(ex.getResponseBody(), &quot;UTF-8&quot;))) {
                  writer.write(response);
              }
              ex.close();
          });
          server.start();
  
<span class="line-modified">!         socks = new SocksServer(0, false);</span>
          socks.addUser(&quot;user&quot;, &quot;pass&quot;);
          socks.start();
  
          Authenticator.setDefault(new Authenticator() {
              @Override
<span class="line-new-header">--- 41,48 ---</span>
  import java.net.InetAddress;
  import java.net.Inet6Address;
  import java.net.ServerSocket;
  import java.net.SocketException;
  import java.net.NetworkInterface;
  import java.util.Collections;
  import java.util.List;
  import com.sun.net.httpserver.*;
  import java.io.BufferedWriter;
<span class="line-added">+ import org.testng.SkipException;</span>
  import org.testng.annotations.AfterClass;
  import org.testng.annotations.BeforeClass;
  import org.testng.annotations.Test;
  
<span class="line-added">+ import jdk.test.lib.NetworkConfiguration;</span>
<span class="line-added">+ </span>
  import static org.testng.Assert.*;
  
  public class SocksIPv6Test {
  
      private HttpServer server;
      private SocksServer socks;
      private String response = &quot;Hello.&quot;;
  
      @BeforeClass
      public void setUp() throws Exception {
<span class="line-modified">!         if (!ensureInet6AddressFamily() || !ensureIPv6OnLoopback()) {</span>
<span class="line-added">+             NetworkConfiguration.printSystemConfiguration(System.out);</span>
<span class="line-added">+             throw new SkipException(&quot;Host does not support IPv6&quot;);</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         server = HttpServer.create(new InetSocketAddress(&quot;::1&quot;, 0), 0);</span>
          server.createContext(&quot;/&quot;, ex -&gt; {
              ex.sendResponseHeaders(200, response.length());
              try (BufferedWriter writer = new BufferedWriter(
                      new OutputStreamWriter(ex.getResponseBody(), &quot;UTF-8&quot;))) {
                  writer.write(response);
              }
              ex.close();
          });
          server.start();
  
<span class="line-modified">!         socks = new SocksServer(InetAddress.getByName(&quot;::1&quot;), 0, false);</span>
          socks.addUser(&quot;user&quot;, &quot;pass&quot;);
          socks.start();
  
          Authenticator.setDefault(new Authenticator() {
              @Override
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,12 ***</span>
          return false;
      }
  
      @Test(groups = &quot;unit&quot;)
      public void testSocksOverIPv6() throws Exception {
<span class="line-removed">-         if (!shouldRun) return;</span>
<span class="line-removed">- </span>
          Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(&quot;::1&quot;,
                  socks.getPort()));
          URL url = new URL(&quot;http://[::1]:&quot; + server.getAddress().getPort());
          java.net.URLConnection conn = url.openConnection(proxy);
          String actual = &quot;&quot;;
<span class="line-new-header">--- 124,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,27 ***</span>
          assertEquals(actual, response);
      }
  
      @Test(groups = &quot;unit&quot;)
      public void testSocksOverIPv6Hostname() throws Exception {
<span class="line-modified">!         if (!shouldRun) return;</span>
  
<span class="line-modified">!         String ipv6Hostname = InetAddress.getByName(&quot;::1&quot;).getHostName();</span>
<span class="line-modified">!         String ipv4Hostname = InetAddress.getByName(&quot;127.0.0.1&quot;).getHostName();</span>
  
<span class="line-modified">!         if (ipv6Hostname.equals(InetAddress.getByName(&quot;::1&quot;).getHostAddress())) {</span>
              System.out.println(&quot;Unable to get the hostname of the IPv6 loopback &quot;
                      + &quot;address. Skipping test case.&quot;);
              return;
          }
  
<span class="line-modified">!         if (ipv6Hostname.equals(ipv4Hostname)) {</span>
              System.out.println(&quot;IPv6 and IPv4 loopback addresses map to the&quot;
                      + &quot; same hostname. Skipping test case.&quot;);
              return;
          }
  
          Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(ipv6Hostname,
                  socks.getPort()));
          URL url = new URL(&quot;http://&quot; + ipv6Hostname + &quot;:&quot; + server.getAddress().getPort());
          java.net.URLConnection conn = url.openConnection(proxy);
          String actual = &quot;&quot;;
<span class="line-new-header">--- 138,49 ---</span>
          assertEquals(actual, response);
      }
  
      @Test(groups = &quot;unit&quot;)
      public void testSocksOverIPv6Hostname() throws Exception {
<span class="line-modified">!         InetAddress ipv6Loopback = InetAddress.getByName(&quot;::1&quot;);</span>
<span class="line-added">+         String ipv6Hostname = ipv6Loopback.getHostName();</span>
<span class="line-added">+         String ipv6HostAddress = ipv6Loopback.getHostAddress();</span>
<span class="line-added">+         InetAddress ipv4Loopback;</span>
<span class="line-added">+         String ipv4Hostname;</span>
<span class="line-added">+         String ipv4HostAddress;</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             ipv4Loopback = InetAddress.getByName(&quot;127.0.0.1&quot;);</span>
<span class="line-added">+             ipv4Hostname = ipv4Loopback == null ? null : ipv4Loopback.getHostName();</span>
<span class="line-added">+             ipv4HostAddress = ipv4Loopback == null ? null : ipv4Loopback.getHostAddress();</span>
<span class="line-added">+         } catch (IOException io) {</span>
<span class="line-added">+             ipv4Hostname = null;</span>
<span class="line-added">+             ipv4HostAddress = null;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         System.out.println(&quot;ipv6Hostname: &quot; + ipv6Hostname + &quot; / &quot; + ipv6HostAddress);</span>
<span class="line-modified">!         System.out.println(&quot;ipv4Hostname: &quot; + ipv4Hostname + &quot; / &quot; + ipv4HostAddress);</span>
  
<span class="line-modified">!         if (ipv6Hostname.equals(ipv6HostAddress)) {</span>
              System.out.println(&quot;Unable to get the hostname of the IPv6 loopback &quot;
                      + &quot;address. Skipping test case.&quot;);
              return;
          }
  
<span class="line-modified">!         if (ipv4Hostname != null &amp;&amp; ipv6Hostname.equals(ipv4Hostname)) {</span>
              System.out.println(&quot;IPv6 and IPv4 loopback addresses map to the&quot;
                      + &quot; same hostname. Skipping test case.&quot;);
              return;
          }
  
<span class="line-added">+         if (!InetAddress.getByName(ipv6Hostname).getHostAddress()</span>
<span class="line-added">+                 .equals(ipv6HostAddress)) {</span>
<span class="line-added">+             System.out.println(ipv6Hostname + &quot; resolves to \&quot;&quot;</span>
<span class="line-added">+                     + InetAddress.getByName(ipv6Hostname).getHostAddress()</span>
<span class="line-added">+                     + &quot;\&quot;, not \&quot;&quot; + ipv6HostAddress +</span>
<span class="line-added">+                     &quot;\&quot;. Skipping test case.&quot;);</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(ipv6Hostname,
                  socks.getPort()));
          URL url = new URL(&quot;http://&quot; + ipv6Hostname + &quot;:&quot; + server.getAddress().getPort());
          java.net.URLConnection conn = url.openConnection(proxy);
          String actual = &quot;&quot;;
</pre>
<center><a href="BadProxySelector.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SocksProxyVersion.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>