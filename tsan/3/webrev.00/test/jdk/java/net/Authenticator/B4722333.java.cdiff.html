<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/Authenticator/B4722333.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B4678055.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B4759514.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Authenticator/B4722333.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,155 ***</span>
   * @test
   * @bug 4722333
   * @modules java.base/sun.net.www
   * @library ../../../sun/net/www/httptest/
   * @build HttpCallback TestHttpServer ClosedChannelList HttpTransaction
<span class="line-modified">!  * @run main B4722333</span>
   * @summary JRE Proxy Authentication Not Working with ISA2000
   */
  
  import java.io.*;
  import java.net.*;
  
  public class B4722333 implements HttpCallback {
  
      static int count = 0;
  
<span class="line-modified">!     static String [][] expected = {</span>
         /* scheme  realm/prompt */
          {&quot;basic&quot;, &quot;foo&quot;},
          {&quot;basic&quot;, &quot;foobar&quot;},
          {&quot;digest&quot;, &quot;biz&quot;},
          {&quot;digest&quot;, &quot;bizbar&quot;},
          {&quot;digest&quot;, &quot;foobiz&quot;}
      };
  
<span class="line-modified">!     public void request (HttpTransaction req) {</span>
          try {
<span class="line-modified">!             if (count % 2 == 1 ) {</span>
<span class="line-modified">!                 req.setResponseEntityBody (&quot;Hello .&quot;);</span>
<span class="line-modified">!                 req.sendResponse (200, &quot;Ok&quot;);</span>
                  req.orderlyClose();
              } else {
                  switch (count) {
                    case 0:
<span class="line-modified">!                     req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Basic realm=\&quot;foo\&quot;&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse (401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 2:
<span class="line-modified">!                     req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Basic realm=\&quot;foobar\&quot; Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse (401, &quot;Unauthorized&quot;);</span>
                      break;
                    case 4:
<span class="line-modified">!                     req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Digest realm=biz domain=/foo nonce=thisisanonce &quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Basic realm=bizbar&quot;);</span>
<span class="line-modified">!                     req.sendResponse (401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 6:
<span class="line-modified">!                     req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Digest realm=\&quot;bizbar\&quot; domain=/biz nonce=\&quot;hereisanonce\&quot; Basic realm=\&quot;foobar\&quot; Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse (401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 8:
<span class="line-modified">!                     req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Foo p1=1 p2=2 p3=3 p4=4 p5=5 p6=6 p7=7 p8=8 p9=10 Digest realm=foobiz domain=/foobiz nonce=newnonce&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Basic realm=bizbar&quot;);</span>
<span class="line-modified">!                     req.sendResponse (401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                  }
              }
              count ++;
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
  
<span class="line-modified">!     static void read (InputStream is) throws IOException {</span>
          int c;
<span class="line-modified">!         System.out.println (&quot;reading&quot;);</span>
          while ((c=is.read()) != -1) {
<span class="line-modified">!             System.out.write (c);</span>
          }
<span class="line-modified">!         System.out.println (&quot;&quot;);</span>
<span class="line-modified">!         System.out.println (&quot;finished reading&quot;);</span>
      }
  
  
<span class="line-modified">!     static void client (String u) throws Exception {</span>
          URL url = new URL (u);
<span class="line-modified">!         System.out.println (&quot;client opening connection to: &quot; + u);</span>
          URLConnection urlc = url.openConnection ();
          InputStream is = urlc.getInputStream ();
<span class="line-modified">!         read (is);</span>
          is.close();
      }
  
      static TestHttpServer server;
  
<span class="line-modified">!     public static void main (String[] args) throws Exception {</span>
<span class="line-modified">!         MyAuthenticator auth = new MyAuthenticator ();</span>
<span class="line-modified">!         Authenticator.setDefault (auth);</span>
          try {
<span class="line-modified">!             server = new TestHttpServer (new B4722333(), 1, 10, 0);</span>
<span class="line-modified">!             System.out.println (&quot;Server started: listening on port: &quot; + server.getLocalPort());</span>
<span class="line-modified">!             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/d1/d2/d3/foo.html&quot;);</span>
<span class="line-modified">!             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/ASD/d3/x.html&quot;);</span>
<span class="line-modified">!             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/biz/d3/x.html&quot;);</span>
<span class="line-modified">!             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/bar/d3/x.html&quot;);</span>
<span class="line-modified">!             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/fuzz/d3/x.html&quot;);</span>
          } catch (Exception e) {
              if (server != null) {
                  server.terminate();
              }
              throw e;
          }
          int f = auth.getCount();
          if (f != expected.length) {
<span class="line-modified">!             except (&quot;Authenticator was called &quot;+f+&quot; times. Should be &quot; + expected.length);</span>
          }
          server.terminate();
      }
  
<span class="line-modified">!     public static void except (String s) {</span>
          server.terminate();
<span class="line-modified">!         throw new RuntimeException (s);</span>
      }
  
      static class MyAuthenticator extends Authenticator {
<span class="line-modified">!         MyAuthenticator () {</span>
<span class="line-modified">!             super ();</span>
          }
  
          int count = 0;
  
<span class="line-modified">!         public PasswordAuthentication getPasswordAuthentication ()</span>
<span class="line-modified">!             {</span>
<span class="line-removed">-             System.out.println (&quot;Auth called&quot;);</span>
              String scheme = getRequestingScheme();
<span class="line-modified">!             System.out.println (&quot;getRequestingScheme() returns &quot; + scheme);</span>
              String prompt = getRequestingPrompt();
<span class="line-modified">!             System.out.println (&quot;getRequestingPrompt() returns &quot; + prompt);</span>
  
<span class="line-modified">!             if (!scheme.equals (expected [count][0])) {</span>
<span class="line-modified">!                 B4722333.except (&quot;wrong scheme received, &quot; + scheme + &quot; expected &quot; + expected [count][0]);</span>
              }
<span class="line-modified">!             if (!prompt.equals (expected [count][1])) {</span>
<span class="line-modified">!                 B4722333.except (&quot;wrong realm received, &quot; + prompt + &quot; expected &quot; + expected [count][1]);</span>
              }
              count ++;
<span class="line-modified">!             return (new PasswordAuthentication (&quot;user&quot;, &quot;passwordNotCheckedAnyway&quot;.toCharArray()));</span>
          }
  
          public int getCount () {
<span class="line-modified">!             return (count);</span>
          }
      }
  
  }
<span class="line-new-header">--- 25,155 ---</span>
   * @test
   * @bug 4722333
   * @modules java.base/sun.net.www
   * @library ../../../sun/net/www/httptest/
   * @build HttpCallback TestHttpServer ClosedChannelList HttpTransaction
<span class="line-modified">!  * @run main/othervm B4722333</span>
   * @summary JRE Proxy Authentication Not Working with ISA2000
   */
  
  import java.io.*;
  import java.net.*;
  
  public class B4722333 implements HttpCallback {
  
      static int count = 0;
  
<span class="line-modified">!     static String[][] expected = {</span>
         /* scheme  realm/prompt */
          {&quot;basic&quot;, &quot;foo&quot;},
          {&quot;basic&quot;, &quot;foobar&quot;},
          {&quot;digest&quot;, &quot;biz&quot;},
          {&quot;digest&quot;, &quot;bizbar&quot;},
          {&quot;digest&quot;, &quot;foobiz&quot;}
      };
  
<span class="line-modified">!     public void request(HttpTransaction req) {</span>
          try {
<span class="line-modified">!             if (count % 2 == 1) {</span>
<span class="line-modified">!                 req.setResponseEntityBody(&quot;Hello .&quot;);</span>
<span class="line-modified">!                 req.sendResponse(200, &quot;Ok&quot;);</span>
                  req.orderlyClose();
              } else {
                  switch (count) {
                    case 0:
<span class="line-modified">!                     req.addResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Basic realm=\&quot;foo\&quot;&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse(401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 2:
<span class="line-modified">!                     req.addResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Basic realm=\&quot;foobar\&quot; Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse(401, &quot;Unauthorized&quot;);</span>
                      break;
                    case 4:
<span class="line-modified">!                     req.addResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Digest realm=biz domain=/foo nonce=thisisanonce &quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Basic realm=bizbar&quot;);</span>
<span class="line-modified">!                     req.sendResponse(401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 6:
<span class="line-modified">!                     req.addResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Digest realm=\&quot;bizbar\&quot; domain=/biz nonce=\&quot;hereisanonce\&quot; Basic realm=\&quot;foobar\&quot; Foo realm=\&quot;bar\&quot;&quot;);</span>
<span class="line-modified">!                     req.sendResponse(401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                    case 8:
<span class="line-modified">!                     req.addResponseHeader(&quot;Connection&quot;, &quot;close&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Foo p1=1 p2=2 p3=3 p4=4 p5=5 p6=6 p7=7 p8=8 p9=10 Digest realm=foobiz domain=/foobiz nonce=newnonce&quot;);</span>
<span class="line-modified">!                     req.addResponseHeader(&quot;WWW-Authenticate&quot;, &quot;Basic realm=bizbar&quot;);</span>
<span class="line-modified">!                     req.sendResponse(401, &quot;Unauthorized&quot;);</span>
                      req.orderlyClose();
                      break;
                  }
              }
              count ++;
          } catch (IOException e) {
              e.printStackTrace();
          }
      }
  
<span class="line-modified">!     static void read(InputStream is) throws IOException {</span>
          int c;
<span class="line-modified">!         System.out.println(&quot;reading&quot;);</span>
          while ((c=is.read()) != -1) {
<span class="line-modified">!             System.out.write(c);</span>
          }
<span class="line-modified">!         System.out.println(&quot;&quot;);</span>
<span class="line-modified">!         System.out.println(&quot;finished reading&quot;);</span>
      }
  
  
<span class="line-modified">!     static void client(String u) throws Exception {</span>
          URL url = new URL (u);
<span class="line-modified">!         System.out.println(&quot;client opening connection to: &quot; + u);</span>
          URLConnection urlc = url.openConnection ();
          InputStream is = urlc.getInputStream ();
<span class="line-modified">!         read(is);</span>
          is.close();
      }
  
      static TestHttpServer server;
  
<span class="line-modified">!     public static void main(String[] args) throws Exception {</span>
<span class="line-modified">!         MyAuthenticator auth = new MyAuthenticator();</span>
<span class="line-modified">!         Authenticator.setDefault(auth);</span>
          try {
<span class="line-modified">!             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-modified">!             server = new TestHttpServer(new B4722333(), 1, 10, loopback, 0);</span>
<span class="line-modified">!             System.out.println(&quot;Server started: listening on port: &quot; + server.getLocalPort());</span>
<span class="line-modified">!             client(&quot;http://&quot; + server.getAuthority() + &quot;/d1/d2/d3/foo.html&quot;);</span>
<span class="line-modified">!             client(&quot;http://&quot; + server.getAuthority() + &quot;/ASD/d3/x.html&quot;);</span>
<span class="line-modified">!             client(&quot;http://&quot; + server.getAuthority() + &quot;/biz/d3/x.html&quot;);</span>
<span class="line-modified">!             client(&quot;http://&quot; + server.getAuthority() + &quot;/bar/d3/x.html&quot;);</span>
<span class="line-added">+             client(&quot;http://&quot; + server.getAuthority() + &quot;/fuzz/d3/x.html&quot;);</span>
          } catch (Exception e) {
              if (server != null) {
                  server.terminate();
              }
              throw e;
          }
          int f = auth.getCount();
          if (f != expected.length) {
<span class="line-modified">!             except(&quot;Authenticator was called &quot;+f+&quot; times. Should be &quot; + expected.length);</span>
          }
          server.terminate();
      }
  
<span class="line-modified">!     public static void except(String s) {</span>
          server.terminate();
<span class="line-modified">!         throw new RuntimeException(s);</span>
      }
  
      static class MyAuthenticator extends Authenticator {
<span class="line-modified">!         MyAuthenticator() {</span>
<span class="line-modified">!             super();</span>
          }
  
          int count = 0;
  
<span class="line-modified">!         public PasswordAuthentication getPasswordAuthentication() {</span>
<span class="line-modified">!             System.out.println(&quot;Auth called&quot;);</span>
              String scheme = getRequestingScheme();
<span class="line-modified">!             System.out.println(&quot;getRequestingScheme() returns &quot; + scheme);</span>
              String prompt = getRequestingPrompt();
<span class="line-modified">!             System.out.println(&quot;getRequestingPrompt() returns &quot; + prompt);</span>
  
<span class="line-modified">!             if (!scheme.equals(expected [count][0])) {</span>
<span class="line-modified">!                 B4722333.except(&quot;wrong scheme received, &quot; + scheme + &quot; expected &quot; + expected [count][0]);</span>
              }
<span class="line-modified">!             if (!prompt.equals(expected [count][1])) {</span>
<span class="line-modified">!                 B4722333.except(&quot;wrong realm received, &quot; + prompt + &quot; expected &quot; + expected [count][1]);</span>
              }
              count ++;
<span class="line-modified">!             return (new PasswordAuthentication(&quot;user&quot;, &quot;passwordNotCheckedAnyway&quot;.toCharArray()));</span>
          }
  
          public int getCount () {
<span class="line-modified">!             return count;</span>
          }
      }
  
  }
</pre>
<center><a href="B4678055.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B4759514.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>