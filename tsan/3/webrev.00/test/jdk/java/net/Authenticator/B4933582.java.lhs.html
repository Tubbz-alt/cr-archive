<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/Authenticator/B4933582.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<a name="2" id="anc2"></a>



 24 /*
 25  * @test
 26  * @bug 4933582
<a name="3" id="anc3"></a><span class="line-modified"> 27  * @library ../../../sun/net/www/httptest</span>

 28  * @modules java.base/sun.net.www
 29  *          java.base/sun.net.www.protocol.http
 30  * @build HttpCallback HttpTransaction TestHttpServer B4933582
 31  * @run main/othervm B4933582
 32  */
 33 import java.io.*;
 34 import java.net.*;
 35 import java.util.*;
 36 import sun.net.www.protocol.http.*;
<a name="4" id="anc4"></a>
 37 
 38 public class B4933582 implements HttpCallback {
 39 
 40     static int count = 0;
 41     static String authstring;
 42 
 43     void errorReply (HttpTransaction req, String reply) throws IOException {
 44         req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);
 45         req.addResponseHeader (&quot;WWW-Authenticate&quot;, reply);
 46         req.sendResponse (401, &quot;Unauthorized&quot;);
 47         req.orderlyClose();
 48     }
 49 
 50     void okReply (HttpTransaction req) throws IOException {
 51         req.setResponseEntityBody (&quot;Hello .&quot;);
 52         req.sendResponse (200, &quot;Ok&quot;);
 53         req.orderlyClose();
 54     }
 55 
 56     static volatile boolean firstTime = true;
 57 
 58     public void request (HttpTransaction req) {
 59         try {
 60             authstring = req.getRequestHeader (&quot;Authorization&quot;);
 61             if (firstTime) {
 62                 switch (count) {
 63                 case 0:
 64                     errorReply (req, &quot;Basic realm=\&quot;wallyworld\&quot;&quot;);
 65                     break;
 66                 case 1:
 67                     /* client stores a username/pw for wallyworld
 68                      */
 69                     save (authstring);
 70                     okReply (req);
 71                     break;
 72                 }
 73             } else {
 74                 /* check the auth string is premptively set from last time */
 75                 String savedauth = retrieve();
 76                 if (savedauth.equals (authstring)) {
 77                     okReply (req);
 78                 } else {
 79                     System.out.println (&quot;savedauth = &quot; + savedauth);
 80                     System.out.println (&quot;authstring = &quot; + authstring);
 81                     errorReply (req, &quot;Basic realm=\&quot;wallyworld\&quot;&quot;);
 82                 }
 83             }
 84             count ++;
 85         } catch (IOException e) {
 86             e.printStackTrace();
 87         }
 88     }
 89 
 90     void save (String s) {
 91         try {
 92             FileOutputStream f = new FileOutputStream (&quot;auth.save&quot;);
 93             ObjectOutputStream os = new ObjectOutputStream (f);
 94             os.writeObject (s);
 95         } catch (IOException e) {
 96             assert false;
 97         }
 98     }
 99 
100     String retrieve () {
101         String s = null;
102         try {
103             FileInputStream f = new FileInputStream (&quot;auth.save&quot;);
104             ObjectInputStream is = new ObjectInputStream (f);
105             s = (String) is.readObject();
106         } catch (Exception e) {
107             assert false;
108         }
109         return s;
110     }
111 
112     static void read (InputStream is) throws IOException {
113         int c;
114         System.out.println (&quot;reading&quot;);
115         while ((c=is.read()) != -1) {
116             System.out.write (c);
117         }
118         System.out.println (&quot;&quot;);
119         System.out.println (&quot;finished reading&quot;);
120     }
121 
122     static void client (String u) throws Exception {
123         URL url = new URL (u);
124         System.out.println (&quot;client opening connection to: &quot; + u);
125         URLConnection urlc = url.openConnection ();
126         try(InputStream is = urlc.getInputStream ()) {
127             read (is);
128         }
129     }
130 
131     static TestHttpServer server;
132 
133     public static void main (String[] args) throws Exception {
134         MyAuthenticator auth = new MyAuthenticator ();
135         Authenticator.setDefault (auth);
<a name="5" id="anc5"></a>

136         CacheImpl cache;
137         try {
<a name="6" id="anc6"></a><span class="line-modified">138             server = new TestHttpServer (new B4933582(), 1, 10, 0);</span>
139             cache = new CacheImpl (server.getLocalPort());
140             AuthCacheValue.setAuthCache (cache);
<a name="7" id="anc7"></a><span class="line-modified">141             client (&quot;http://localhost:&quot;+server.getLocalPort()+&quot;/d1/foo.html&quot;);</span>







142         } finally {
143             if (server != null) {
144                 server.terminate();
145             }
146         }
147 
148         int f = auth.getCount();
149         if (f != 1) {
150             except(&quot;Authenticator was called &quot; + f + &quot; times. Should be 1&quot;);
151         }
152 
153         firstTime = false;
154 
155         int retries = 0;
156         cache = new CacheImpl();
157         while (true) {
158             try {
159                 server = new TestHttpServer(new B4933582(), 1, 10,
<a name="8" id="anc8"></a><span class="line-modified">160                         cache.getPort());</span>
161                 break;
162             } catch (BindException e) {
163                 if (retries++ &lt; 5) {
164                     Thread.sleep(200L);
165                     System.out.println(&quot;BindException \&quot;&quot; + e.getMessage()
166                             + &quot;\&quot;, retrying...&quot;);
167                     continue;
168                 } else {
169                     throw e;
170                 }
171             }
172         }
173 
174         try {
175             AuthCacheValue.setAuthCache(cache);
<a name="9" id="anc9"></a><span class="line-modified">176             client(&quot;http://localhost:&quot; + server.getLocalPort() + &quot;/d1/foo.html&quot;);</span>







177         } finally {
178             if (server != null) {
179                 server.terminate();
180             }
181         }
182 
183         f = auth.getCount();
184         if (f != 1) {
185             except(&quot;Authenticator was called &quot; + f + &quot; times. Should be 1&quot;);
186         }
187     }
188 
189     public static void except (String s) {
190         server.terminate();
191         throw new RuntimeException (s);
192     }
193 
194     static class MyAuthenticator extends Authenticator {
195         MyAuthenticator () {
196             super ();
197         }
198 
199         volatile int count = 0;
200 
201         public PasswordAuthentication getPasswordAuthentication () {
202             PasswordAuthentication pw;
203             pw = new PasswordAuthentication (&quot;user&quot;, &quot;pass1&quot;.toCharArray());
204             count ++;
205             return pw;
206         }
207 
208         public int getCount () {
209             return (count);
210         }
211     }
212 
213     static class CacheImpl extends AuthCacheImpl {
214         HashMap&lt;String,LinkedList&lt;AuthCacheValue&gt;&gt; map;
215         int port; // need to store the port number the server is using
216 
217         CacheImpl () throws IOException {
218             this (-1);
219         }
220 
221         CacheImpl (int port) throws IOException {
222             super();
223             this.port = port;
224             File src = new File (&quot;cache.ser&quot;);
225             if (src.exists()) {
226                 try (ObjectInputStream is = new ObjectInputStream(
227                         new FileInputStream(src))) {
228                     map = (HashMap&lt;String,LinkedList&lt;AuthCacheValue&gt;&gt;)is
229                               .readObject();
230                     this.port = (Integer)is.readObject ();
231                     System.out.println (&quot;read port from file &quot; + port);
232                 } catch (ClassNotFoundException e) {
233                     assert false;
234                 }
235                 System.out.println (&quot;setMap from cache.ser&quot;);
236             } else {
237                 map = new HashMap&lt;&gt;();
238             }
239             setMap (map);
240         }
241 
242         int getPort () {
243             return port;
244         }
245 
246         private void writeMap () {
247             File dst = new File(&quot;cache.ser&quot;);
248             try {
249                 dst.delete();
250                 if (!dst.createNewFile()) {
251                     return;
252                 }
253             } catch (IOException e) {
254             }
255 
256             try (ObjectOutputStream os = new ObjectOutputStream(
257                     new FileOutputStream(dst))) {
258                 os.writeObject(map);
259                 os.writeObject(port);
260                 System.out.println(&quot;wrote port &quot; + port);
261             } catch (IOException e) {
262             }
263         }
264 
265         public void put (String pkey, AuthCacheValue value) {
266             System.out.println (&quot;put: &quot; + pkey + &quot; &quot; + value);
267             super.put (pkey, value);
268             writeMap();
269         }
270 
271         public AuthCacheValue get (String pkey, String skey) {
272             System.out.println (&quot;get: &quot; + pkey + &quot; &quot; + skey);
273             AuthCacheValue i = super.get (pkey, skey);
274             System.out.println (&quot;---&gt; &quot; + i);
275             return i;
276         }
277 
278         public void remove (String pkey, AuthCacheValue value) {
279             System.out.println (&quot;remove: &quot; + pkey + &quot; &quot; + value);
280             super.remove (pkey, value);
281             writeMap();
282         }
283     }
284 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>