<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/Authenticator/B4962064.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4962064
 27  * @modules java.base/sun.net.www
 28  * @library ../../../sun/net/www/httptest/
 29  * @build HttpCallback TestHttpServer ClosedChannelList HttpTransaction
 30  * @run main/othervm B4962064
 31  * @run main/othervm -Djava.net.preferIPv6Addresses=true B4962064
 32  * @summary Extend Authenticator to provide access to request URI and server/proxy
 33  */
 34 
 35 import java.io.*;
 36 import java.net.*;
 37 
 38 public class B4962064 implements HttpCallback {
 39 
 40     static int count = 0;
 41 
 42     public void request (HttpTransaction req) {
 43         try {
 44             switch (count) {
 45               case 0:
 46                 req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);
 47                 req.addResponseHeader (&quot;WWW-Authenticate&quot;, &quot;Basic realm=\&quot;foo\&quot;&quot;);
 48                 req.sendResponse (401, &quot;Unauthorized&quot;);
 49                 req.orderlyClose();
 50                 break;
 51               case 1:
 52               case 3:
 53                 req.setResponseEntityBody (&quot;Hello .&quot;);
 54                 req.sendResponse (200, &quot;Ok&quot;);
 55                 req.orderlyClose();
 56                 break;
 57               case 2:
 58                 req.addResponseHeader (&quot;Connection&quot;, &quot;close&quot;);
 59                 req.addResponseHeader (&quot;Proxy-Authenticate&quot;, &quot;Basic realm=\&quot;foo\&quot;&quot;);
 60                 req.sendResponse (407, &quot;Proxy Authentication Required&quot;);
 61                 req.orderlyClose();
 62                 break;
 63             }
 64             count ++;
 65         } catch (IOException e) {
 66             e.printStackTrace();
 67         }
 68     }
 69 
 70     static void read (InputStream is) throws IOException {
 71         int c;
 72         System.out.println (&quot;reading&quot;);
 73         while ((c=is.read()) != -1) {
 74             System.out.write (c);
 75         }
 76         System.out.println (&quot;&quot;);
 77         System.out.println (&quot;finished reading&quot;);
 78     }
 79 
 80 
 81     static void client (String u) throws Exception {
 82         URL url = new URL (u);
 83         System.out.println (&quot;client opening connection to: &quot; + u);
 84         URLConnection urlc = url.openConnection ();
 85         InputStream is = urlc.getInputStream ();
 86         read (is);
 87         is.close();
 88     }
 89 
 90     static TestHttpServer server;
 91     static URL urlsave;
 92 
 93     public static void main (String[] args) throws Exception {
 94         try {
 95             InetAddress address = InetAddress.getLoopbackAddress();
 96             InetAddress resolved = InetAddress.getByName(address.getHostName());
 97             System.out.println(&quot;Lookup: &quot; + address + &quot; -&gt; \&quot;&quot;
 98                                + address.getHostName() + &quot;\&quot; -&gt; &quot;
 99                                + resolved);
100             server = new TestHttpServer (new B4962064(), 1, 10, address, 0);
101             int port = server.getLocalPort();
102             String proxyHost = address.equals(resolved)
103                 ? address.getHostName()
104                 : address.getHostAddress();
105             System.setProperty (&quot;http.proxyHost&quot;, proxyHost);
106             System.setProperty (&quot;http.proxyPort&quot;, Integer.toString (port));
107             MyAuthenticator auth = new MyAuthenticator ();
108             Authenticator.setDefault (auth);
109             System.out.println (&quot;Server started: listening on port: &quot; + port);
110             String s = new String (&quot;http://foo.com/d1/d2/d3/foo.html&quot;);
111             urlsave = new URL (s);
112             client (s);
113             s = new String (&quot;http://bar.com/dr/d3/foo.html&quot;);
114             urlsave = new URL (s);
115             client (s);
116         } catch (Exception e) {
117             if (server != null) {
118                 server.terminate();
119             }
120             throw e;
121         }
122         server.terminate();
123     }
124 
125     public static void except (String s) {
126         server.terminate();
127         throw new RuntimeException (s);
128     }
129 
130     static class MyAuthenticator extends Authenticator {
131         int count = 0;
132         MyAuthenticator () {
133             super ();
134         }
135 
136         public PasswordAuthentication getPasswordAuthentication () {
137             URL url = getRequestingURL ();
138             if (!url.equals (urlsave)) {
139                 except (&quot;urls not equal&quot;);
140             }
141             Authenticator.RequestorType expected;
142             if (count == 0) {
143                 expected = Authenticator.RequestorType.SERVER;
144             } else {
145                 expected = Authenticator.RequestorType.PROXY;
146             }
147             if (getRequestorType() != expected) {
148                 except (&quot;wrong authtype&quot;);
149             }
150             count ++;
151             return (new PasswordAuthentication (&quot;user&quot;, &quot;passwordNotCheckedAnyway&quot;.toCharArray()));
152         }
153 
154     }
155 
156 }
    </pre>
  </body>
</html>