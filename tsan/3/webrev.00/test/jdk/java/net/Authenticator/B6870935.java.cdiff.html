<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/Authenticator/B6870935.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B4962064.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B8034170.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Authenticator/B6870935.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,12 ---</span>
  /**
   * @test
   * @bug 6870935
   * @modules java.base/sun.net.www
   * @run main/othervm -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935
<span class="line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added">+  *                   -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935</span>
   */
  
  import java.io.*;
  import java.util.*;
  import java.net.*;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,22 ***</span>
              port = s.getLocalPort();
          }
  
          public void run () {
              try {
                  Socket s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
                  is.read ();
                  os.write (reply1.getBytes());
                  Thread.sleep (2000);
                  s1.close ();
  
                  s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
<span class="line-modified">!                 is.read ();</span>
                  // need to get the cnonce out of the response
                  MessageHeader header = new MessageHeader (is);
                  String raw = header.findValue (&quot;Proxy-Authorization&quot;);
                  HeaderParser parser = new HeaderParser (raw);
                  String cnonce = parser.findValue (&quot;cnonce&quot;);
<span class="line-new-header">--- 80,25 ---</span>
              port = s.getLocalPort();
          }
  
          public void run () {
              try {
<span class="line-added">+                 System.out.println(&quot;Server started&quot;);</span>
                  Socket s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
                  is.read ();
                  os.write (reply1.getBytes());
<span class="line-added">+                 System.out.println(&quot;First response sent&quot;);</span>
                  Thread.sleep (2000);
                  s1.close ();
<span class="line-added">+                 System.out.println(&quot;First connection closed&quot;);</span>
  
                  s1 = s.accept ();
                  is = s1.getInputStream ();
                  os = s1.getOutputStream ();
<span class="line-modified">!                 // is.read ();</span>
                  // need to get the cnonce out of the response
                  MessageHeader header = new MessageHeader (is);
                  String raw = header.findValue (&quot;Proxy-Authorization&quot;);
                  HeaderParser parser = new HeaderParser (raw);
                  String cnonce = parser.findValue (&quot;cnonce&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 113,16 ***</span>
<span class="line-new-header">--- 118,20 ---</span>
                  String reply = reply2 + getAuthorization (
                          realm, false, uri, &quot;GET&quot;, cnonce,
                          cnstring, passwd, username
                  ) +&quot;\r\n&quot;;
                  os.write (reply.getBytes());
<span class="line-added">+                 System.out.println(&quot;Second response sent&quot;);</span>
                  Thread.sleep (2000);
                  s1.close ();
<span class="line-added">+                 System.out.println(&quot;Second connection closed&quot;);</span>
              }
              catch (Exception e) {
                  System.out.println (e);
                  e.printStackTrace();
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 System.out.println(&quot;Server finished&quot;);</span>
              }
          }
  
          private String getAuthorization (String realm, boolean isRequest, String uri, String method, String cnonce, String cnstring, char[] password, String username) {
              String response;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 223,12 ***</span>
          int port, n =0;
          byte b[] = new byte[nSize];
          DigestServer server;
          ServerSocket sock;
  
          try {
<span class="line-modified">!             sock = new ServerSocket (0);</span>
              port = sock.getLocalPort ();
          }
          catch (Exception e) {
              System.out.println (&quot;Exception: &quot; + e);
              return;
<span class="line-new-header">--- 232,21 ---</span>
          int port, n =0;
          byte b[] = new byte[nSize];
          DigestServer server;
          ServerSocket sock;
  
<span class="line-added">+         InetAddress address = InetAddress.getLoopbackAddress();</span>
<span class="line-added">+         InetAddress resolved = InetAddress.getByName(address.getHostName());</span>
<span class="line-added">+         System.out.println(&quot;Lookup: &quot;</span>
<span class="line-added">+                             + address + &quot; -&gt; \&quot;&quot; + address.getHostName() + &quot;\&quot; -&gt; &quot;</span>
<span class="line-added">+                             + resolved);</span>
<span class="line-added">+         String proxyHost = address.equals(resolved)</span>
<span class="line-added">+             ? address.getHostName()</span>
<span class="line-added">+             : address.getHostAddress();</span>
          try {
<span class="line-modified">!             sock = new ServerSocket();</span>
<span class="line-added">+             sock.bind(new InetSocketAddress(address, 0));</span>
              port = sock.getLocalPort ();
          }
          catch (Exception e) {
              System.out.println (&quot;Exception: &quot; + e);
              return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 236,16 ***</span>
  
          server = new DigestServer(sock);
          server.start ();
  
          try  {
<span class="line-removed">- </span>
              Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">!             SocketAddress addr = new InetSocketAddress (InetAddress.getLoopbackAddress(), port);</span>
              Proxy proxy = new Proxy (Proxy.Type.HTTP, addr);
              String s = &quot;http://www.ibm.com&quot;;
              URL url = new URL(s);
              java.net.URLConnection conURL =  url.openConnection(proxy);
  
              InputStream in = conURL.getInputStream();
              int c;
              while ((c = in.read ()) != -1) {
<span class="line-new-header">--- 254,16 ---</span>
  
          server = new DigestServer(sock);
          server.start ();
  
          try  {
              Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">!             SocketAddress addr = InetSocketAddress.createUnresolved(proxyHost, port);</span>
              Proxy proxy = new Proxy (Proxy.Type.HTTP, addr);
              String s = &quot;http://www.ibm.com&quot;;
              URL url = new URL(s);
<span class="line-added">+             System.out.println(&quot;opening connection through proxy: &quot; + addr);</span>
              java.net.URLConnection conURL =  url.openConnection(proxy);
  
              InputStream in = conURL.getInputStream();
              int c;
              while ((c = in.read ()) != -1) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,10 ***</span>
<span class="line-new-header">--- 271,13 ---</span>
              in.close ();
          }
          catch(IOException e) {
              e.printStackTrace();
              error = true;
<span class="line-added">+             sock.close();</span>
<span class="line-added">+         } finally {</span>
<span class="line-added">+             server.join();</span>
          }
          if (error) {
              throw new RuntimeException (&quot;Error in test&quot;);
          }
      }
</pre>
<center><a href="B4962064.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B8034170.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>