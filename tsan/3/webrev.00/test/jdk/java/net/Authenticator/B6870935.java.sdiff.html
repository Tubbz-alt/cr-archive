<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/Authenticator/B6870935.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B4962064.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B8034170.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Authenticator/B6870935.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6870935
 27  * @modules java.base/sun.net.www
 28  * @run main/othervm -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935


 29  */
 30 
 31 import java.io.*;
 32 import java.util.*;
 33 import java.net.*;
 34 import java.security.*;
 35 import sun.net.www.*;
 36 
 37 /* This is one simple test of the RFC2617 digest authentication behavior
 38  * It specifically tests that the client correctly checks the returned
 39  * Authentication-Info header field from the server and throws an exception
 40  * if the password is wrong
 41  */
 42 
 43 public class B6870935 {
 44 
 45     static char[] passwd = &quot;password&quot;.toCharArray();
 46     static String username = &quot;user&quot;;
 47     static String nonce = &quot;abcdefghijklmnopqrstuvwxyz&quot;;
 48     static String realm = &quot;wallyworld&quot;;
</pre>
<hr />
<pre>
 63         String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot; +
 64             &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
 65             &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
 66             &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
 67             &quot;Transfer-encoding: chunked\r\n\r\n&quot;+
 68             &quot;B\r\nHelloWorld1\r\n&quot;+
 69             &quot;B\r\nHelloWorld2\r\n&quot;+
 70             &quot;B\r\nHelloWorld3\r\n&quot;+
 71             &quot;B\r\nHelloWorld4\r\n&quot;+
 72             &quot;B\r\nHelloWorld5\r\n&quot;+
 73             &quot;0\r\n&quot;+
 74             &quot;Proxy-Authentication-Info: &quot;;
 75 
 76         DigestServer (ServerSocket y) {
 77             s = y;
 78             port = s.getLocalPort();
 79         }
 80 
 81         public void run () {
 82             try {

 83                 Socket s1 = s.accept ();
 84                 is = s1.getInputStream ();
 85                 os = s1.getOutputStream ();
 86                 is.read ();
 87                 os.write (reply1.getBytes());

 88                 Thread.sleep (2000);
 89                 s1.close ();

 90 
 91                 s1 = s.accept ();
 92                 is = s1.getInputStream ();
 93                 os = s1.getOutputStream ();
<span class="line-modified"> 94                 is.read ();</span>
 95                 // need to get the cnonce out of the response
 96                 MessageHeader header = new MessageHeader (is);
 97                 String raw = header.findValue (&quot;Proxy-Authorization&quot;);
 98                 HeaderParser parser = new HeaderParser (raw);
 99                 String cnonce = parser.findValue (&quot;cnonce&quot;);
100                 String cnstring = parser.findValue (&quot;nc&quot;);
101                 String clientrsp = parser.findValue (&quot;response&quot;);
102                 String expected = computeDigest(
103                         true, username,passwd,realm,
104                         &quot;GET&quot;, uri, nonce, cnonce, cnstring
105                 );
106                 if (!expected.equals(clientrsp)) {
107                     s1.close ();
108                     s.close ();
109                     error = true;
110                     return;
111                 }
112 
113                 String reply = reply2 + getAuthorization (
114                         realm, false, uri, &quot;GET&quot;, cnonce,
115                         cnstring, passwd, username
116                 ) +&quot;\r\n&quot;;
117                 os.write (reply.getBytes());

118                 Thread.sleep (2000);
119                 s1.close ();

120             }
121             catch (Exception e) {
122                 System.out.println (e);
123                 e.printStackTrace();


124             }
125         }
126 
127         private String getAuthorization (String realm, boolean isRequest, String uri, String method, String cnonce, String cnstring, char[] password, String username) {
128             String response;
129 
130             try {
131                 response = computeDigest(isRequest, username,passwd,realm,
132                                             method, uri, nonce, cnonce, cnstring);
133             } catch (NoSuchAlgorithmException ex) {
134                 return null;
135             }
136 
137             String value = &quot;Digest&quot;
138                             + &quot; qop=\&quot;auth&quot;
139                             + &quot;\&quot;, cnonce=\&quot;&quot; + cnonce
140                             + &quot;\&quot;, rspauth=\&quot;&quot; + response
141                             + &quot;\&quot;, nc=\&quot;&quot; + cnstring + &quot;\&quot;&quot;;
142             return (value+ &quot;\r\n&quot;);
143         }
</pre>
<hr />
<pre>
208     static class MyAuthenticator extends Authenticator {
209         public MyAuthenticator () {
210             super ();
211         }
212 
213         public PasswordAuthentication getPasswordAuthentication ()
214         {
215             return (new PasswordAuthentication (username, passwd));
216         }
217     }
218 
219 
220     public static void main(String[] args) throws Exception {
221         int nLoops = 1;
222         int nSize = 10;
223         int port, n =0;
224         byte b[] = new byte[nSize];
225         DigestServer server;
226         ServerSocket sock;
227 








228         try {
<span class="line-modified">229             sock = new ServerSocket (0);</span>

230             port = sock.getLocalPort ();
231         }
232         catch (Exception e) {
233             System.out.println (&quot;Exception: &quot; + e);
234             return;
235         }
236 
237         server = new DigestServer(sock);
238         server.start ();
239 
240         try  {
<span class="line-removed">241 </span>
242             Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">243             SocketAddress addr = new InetSocketAddress (InetAddress.getLoopbackAddress(), port);</span>
244             Proxy proxy = new Proxy (Proxy.Type.HTTP, addr);
245             String s = &quot;http://www.ibm.com&quot;;
246             URL url = new URL(s);

247             java.net.URLConnection conURL =  url.openConnection(proxy);
248 
249             InputStream in = conURL.getInputStream();
250             int c;
251             while ((c = in.read ()) != -1) {
252             }
253             in.close ();
254         }
255         catch(IOException e) {
256             e.printStackTrace();
257             error = true;



258         }
259         if (error) {
260             throw new RuntimeException (&quot;Error in test&quot;);
261         }
262     }
263 }
</pre>
</td>
<td>
<hr />
<pre>
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6870935
 27  * @modules java.base/sun.net.www
 28  * @run main/othervm -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935
<span class="line-added"> 29  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added"> 30  *                   -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935</span>
 31  */
 32 
 33 import java.io.*;
 34 import java.util.*;
 35 import java.net.*;
 36 import java.security.*;
 37 import sun.net.www.*;
 38 
 39 /* This is one simple test of the RFC2617 digest authentication behavior
 40  * It specifically tests that the client correctly checks the returned
 41  * Authentication-Info header field from the server and throws an exception
 42  * if the password is wrong
 43  */
 44 
 45 public class B6870935 {
 46 
 47     static char[] passwd = &quot;password&quot;.toCharArray();
 48     static String username = &quot;user&quot;;
 49     static String nonce = &quot;abcdefghijklmnopqrstuvwxyz&quot;;
 50     static String realm = &quot;wallyworld&quot;;
</pre>
<hr />
<pre>
 65         String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot; +
 66             &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
 67             &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
 68             &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
 69             &quot;Transfer-encoding: chunked\r\n\r\n&quot;+
 70             &quot;B\r\nHelloWorld1\r\n&quot;+
 71             &quot;B\r\nHelloWorld2\r\n&quot;+
 72             &quot;B\r\nHelloWorld3\r\n&quot;+
 73             &quot;B\r\nHelloWorld4\r\n&quot;+
 74             &quot;B\r\nHelloWorld5\r\n&quot;+
 75             &quot;0\r\n&quot;+
 76             &quot;Proxy-Authentication-Info: &quot;;
 77 
 78         DigestServer (ServerSocket y) {
 79             s = y;
 80             port = s.getLocalPort();
 81         }
 82 
 83         public void run () {
 84             try {
<span class="line-added"> 85                 System.out.println(&quot;Server started&quot;);</span>
 86                 Socket s1 = s.accept ();
 87                 is = s1.getInputStream ();
 88                 os = s1.getOutputStream ();
 89                 is.read ();
 90                 os.write (reply1.getBytes());
<span class="line-added"> 91                 System.out.println(&quot;First response sent&quot;);</span>
 92                 Thread.sleep (2000);
 93                 s1.close ();
<span class="line-added"> 94                 System.out.println(&quot;First connection closed&quot;);</span>
 95 
 96                 s1 = s.accept ();
 97                 is = s1.getInputStream ();
 98                 os = s1.getOutputStream ();
<span class="line-modified"> 99                 // is.read ();</span>
100                 // need to get the cnonce out of the response
101                 MessageHeader header = new MessageHeader (is);
102                 String raw = header.findValue (&quot;Proxy-Authorization&quot;);
103                 HeaderParser parser = new HeaderParser (raw);
104                 String cnonce = parser.findValue (&quot;cnonce&quot;);
105                 String cnstring = parser.findValue (&quot;nc&quot;);
106                 String clientrsp = parser.findValue (&quot;response&quot;);
107                 String expected = computeDigest(
108                         true, username,passwd,realm,
109                         &quot;GET&quot;, uri, nonce, cnonce, cnstring
110                 );
111                 if (!expected.equals(clientrsp)) {
112                     s1.close ();
113                     s.close ();
114                     error = true;
115                     return;
116                 }
117 
118                 String reply = reply2 + getAuthorization (
119                         realm, false, uri, &quot;GET&quot;, cnonce,
120                         cnstring, passwd, username
121                 ) +&quot;\r\n&quot;;
122                 os.write (reply.getBytes());
<span class="line-added">123                 System.out.println(&quot;Second response sent&quot;);</span>
124                 Thread.sleep (2000);
125                 s1.close ();
<span class="line-added">126                 System.out.println(&quot;Second connection closed&quot;);</span>
127             }
128             catch (Exception e) {
129                 System.out.println (e);
130                 e.printStackTrace();
<span class="line-added">131             } finally {</span>
<span class="line-added">132                 System.out.println(&quot;Server finished&quot;);</span>
133             }
134         }
135 
136         private String getAuthorization (String realm, boolean isRequest, String uri, String method, String cnonce, String cnstring, char[] password, String username) {
137             String response;
138 
139             try {
140                 response = computeDigest(isRequest, username,passwd,realm,
141                                             method, uri, nonce, cnonce, cnstring);
142             } catch (NoSuchAlgorithmException ex) {
143                 return null;
144             }
145 
146             String value = &quot;Digest&quot;
147                             + &quot; qop=\&quot;auth&quot;
148                             + &quot;\&quot;, cnonce=\&quot;&quot; + cnonce
149                             + &quot;\&quot;, rspauth=\&quot;&quot; + response
150                             + &quot;\&quot;, nc=\&quot;&quot; + cnstring + &quot;\&quot;&quot;;
151             return (value+ &quot;\r\n&quot;);
152         }
</pre>
<hr />
<pre>
217     static class MyAuthenticator extends Authenticator {
218         public MyAuthenticator () {
219             super ();
220         }
221 
222         public PasswordAuthentication getPasswordAuthentication ()
223         {
224             return (new PasswordAuthentication (username, passwd));
225         }
226     }
227 
228 
229     public static void main(String[] args) throws Exception {
230         int nLoops = 1;
231         int nSize = 10;
232         int port, n =0;
233         byte b[] = new byte[nSize];
234         DigestServer server;
235         ServerSocket sock;
236 
<span class="line-added">237         InetAddress address = InetAddress.getLoopbackAddress();</span>
<span class="line-added">238         InetAddress resolved = InetAddress.getByName(address.getHostName());</span>
<span class="line-added">239         System.out.println(&quot;Lookup: &quot;</span>
<span class="line-added">240                             + address + &quot; -&gt; \&quot;&quot; + address.getHostName() + &quot;\&quot; -&gt; &quot;</span>
<span class="line-added">241                             + resolved);</span>
<span class="line-added">242         String proxyHost = address.equals(resolved)</span>
<span class="line-added">243             ? address.getHostName()</span>
<span class="line-added">244             : address.getHostAddress();</span>
245         try {
<span class="line-modified">246             sock = new ServerSocket();</span>
<span class="line-added">247             sock.bind(new InetSocketAddress(address, 0));</span>
248             port = sock.getLocalPort ();
249         }
250         catch (Exception e) {
251             System.out.println (&quot;Exception: &quot; + e);
252             return;
253         }
254 
255         server = new DigestServer(sock);
256         server.start ();
257 
258         try  {

259             Authenticator.setDefault (new MyAuthenticator ());
<span class="line-modified">260             SocketAddress addr = InetSocketAddress.createUnresolved(proxyHost, port);</span>
261             Proxy proxy = new Proxy (Proxy.Type.HTTP, addr);
262             String s = &quot;http://www.ibm.com&quot;;
263             URL url = new URL(s);
<span class="line-added">264             System.out.println(&quot;opening connection through proxy: &quot; + addr);</span>
265             java.net.URLConnection conURL =  url.openConnection(proxy);
266 
267             InputStream in = conURL.getInputStream();
268             int c;
269             while ((c = in.read ()) != -1) {
270             }
271             in.close ();
272         }
273         catch(IOException e) {
274             e.printStackTrace();
275             error = true;
<span class="line-added">276             sock.close();</span>
<span class="line-added">277         } finally {</span>
<span class="line-added">278             server.join();</span>
279         }
280         if (error) {
281             throw new RuntimeException (&quot;Error in test&quot;);
282         }
283     }
284 }
</pre>
</td>
</tr>
</table>
<center><a href="B4962064.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B8034170.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>