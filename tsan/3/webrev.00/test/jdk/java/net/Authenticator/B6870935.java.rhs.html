<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/Authenticator/B6870935.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 6870935
 27  * @modules java.base/sun.net.www
 28  * @run main/othervm -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935
<a name="1" id="anc1"></a><span class="line-added"> 29  * @run main/othervm -Djava.net.preferIPv6Addresses=true</span>
<span class="line-added"> 30  *                   -Dhttp.nonProxyHosts=&quot;&quot; -Dhttp.auth.digest.validateProxy=true B6870935</span>
 31  */
 32 
 33 import java.io.*;
 34 import java.util.*;
 35 import java.net.*;
 36 import java.security.*;
 37 import sun.net.www.*;
 38 
 39 /* This is one simple test of the RFC2617 digest authentication behavior
 40  * It specifically tests that the client correctly checks the returned
 41  * Authentication-Info header field from the server and throws an exception
 42  * if the password is wrong
 43  */
 44 
 45 public class B6870935 {
 46 
 47     static char[] passwd = &quot;password&quot;.toCharArray();
 48     static String username = &quot;user&quot;;
 49     static String nonce = &quot;abcdefghijklmnopqrstuvwxyz&quot;;
 50     static String realm = &quot;wallyworld&quot;;
 51     static String uri = &quot;http://www.ibm.com&quot;;
 52     static volatile boolean error = false;
 53 
 54     static class DigestServer extends Thread {
 55 
 56         ServerSocket s;
 57         InputStream  is;
 58         OutputStream os;
 59         int port;
 60 
 61         String reply1 = &quot;HTTP/1.1 407 Proxy Authentication Required\r\n&quot;+
 62             &quot;Proxy-Authenticate: Digest realm=\&quot;&quot;+realm+&quot;\&quot; domain=/ &quot;+
 63             &quot;nonce=\&quot;&quot;+nonce+&quot;\&quot; qop=\&quot;auth\&quot;\r\n\r\n&quot;;
 64 
 65         String reply2 = &quot;HTTP/1.1 200 OK\r\n&quot; +
 66             &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
 67             &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
 68             &quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot; +
 69             &quot;Transfer-encoding: chunked\r\n\r\n&quot;+
 70             &quot;B\r\nHelloWorld1\r\n&quot;+
 71             &quot;B\r\nHelloWorld2\r\n&quot;+
 72             &quot;B\r\nHelloWorld3\r\n&quot;+
 73             &quot;B\r\nHelloWorld4\r\n&quot;+
 74             &quot;B\r\nHelloWorld5\r\n&quot;+
 75             &quot;0\r\n&quot;+
 76             &quot;Proxy-Authentication-Info: &quot;;
 77 
 78         DigestServer (ServerSocket y) {
 79             s = y;
 80             port = s.getLocalPort();
 81         }
 82 
 83         public void run () {
 84             try {
<a name="2" id="anc2"></a><span class="line-added"> 85                 System.out.println(&quot;Server started&quot;);</span>
 86                 Socket s1 = s.accept ();
 87                 is = s1.getInputStream ();
 88                 os = s1.getOutputStream ();
 89                 is.read ();
 90                 os.write (reply1.getBytes());
<a name="3" id="anc3"></a><span class="line-added"> 91                 System.out.println(&quot;First response sent&quot;);</span>
 92                 Thread.sleep (2000);
 93                 s1.close ();
<a name="4" id="anc4"></a><span class="line-added"> 94                 System.out.println(&quot;First connection closed&quot;);</span>
 95 
 96                 s1 = s.accept ();
 97                 is = s1.getInputStream ();
 98                 os = s1.getOutputStream ();
<a name="5" id="anc5"></a><span class="line-modified"> 99                 // is.read ();</span>
100                 // need to get the cnonce out of the response
101                 MessageHeader header = new MessageHeader (is);
102                 String raw = header.findValue (&quot;Proxy-Authorization&quot;);
103                 HeaderParser parser = new HeaderParser (raw);
104                 String cnonce = parser.findValue (&quot;cnonce&quot;);
105                 String cnstring = parser.findValue (&quot;nc&quot;);
106                 String clientrsp = parser.findValue (&quot;response&quot;);
107                 String expected = computeDigest(
108                         true, username,passwd,realm,
109                         &quot;GET&quot;, uri, nonce, cnonce, cnstring
110                 );
111                 if (!expected.equals(clientrsp)) {
112                     s1.close ();
113                     s.close ();
114                     error = true;
115                     return;
116                 }
117 
118                 String reply = reply2 + getAuthorization (
119                         realm, false, uri, &quot;GET&quot;, cnonce,
120                         cnstring, passwd, username
121                 ) +&quot;\r\n&quot;;
122                 os.write (reply.getBytes());
<a name="6" id="anc6"></a><span class="line-added">123                 System.out.println(&quot;Second response sent&quot;);</span>
124                 Thread.sleep (2000);
125                 s1.close ();
<a name="7" id="anc7"></a><span class="line-added">126                 System.out.println(&quot;Second connection closed&quot;);</span>
127             }
128             catch (Exception e) {
129                 System.out.println (e);
130                 e.printStackTrace();
<a name="8" id="anc8"></a><span class="line-added">131             } finally {</span>
<span class="line-added">132                 System.out.println(&quot;Server finished&quot;);</span>
133             }
134         }
135 
136         private String getAuthorization (String realm, boolean isRequest, String uri, String method, String cnonce, String cnstring, char[] password, String username) {
137             String response;
138 
139             try {
140                 response = computeDigest(isRequest, username,passwd,realm,
141                                             method, uri, nonce, cnonce, cnstring);
142             } catch (NoSuchAlgorithmException ex) {
143                 return null;
144             }
145 
146             String value = &quot;Digest&quot;
147                             + &quot; qop=\&quot;auth&quot;
148                             + &quot;\&quot;, cnonce=\&quot;&quot; + cnonce
149                             + &quot;\&quot;, rspauth=\&quot;&quot; + response
150                             + &quot;\&quot;, nc=\&quot;&quot; + cnstring + &quot;\&quot;&quot;;
151             return (value+ &quot;\r\n&quot;);
152         }
153 
154         private String computeDigest(
155                             boolean isRequest, String userName, char[] password,
156                             String realm, String connMethod,
157                             String requestURI, String nonceString,
158                             String cnonce, String ncValue
159                         ) throws NoSuchAlgorithmException
160         {
161 
162             String A1, HashA1;
163 
164             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);
165 
166             {
167                 A1 = userName + &quot;:&quot; + realm + &quot;:&quot;;
168                 HashA1 = encode(A1, password, md);
169             }
170 
171             String A2;
172             if (isRequest) {
173                 A2 = connMethod + &quot;:&quot; + requestURI;
174             } else {
175                 A2 = &quot;:&quot; + requestURI;
176             }
177             String HashA2 = encode(A2, null, md);
178             String combo, finalHash;
179 
180             { /* RRC2617 when qop=auth */
181                 combo = HashA1+ &quot;:&quot; + nonceString + &quot;:&quot; + ncValue + &quot;:&quot; +
182                             cnonce + &quot;:auth:&quot; +HashA2;
183 
184             }
185             finalHash = encode(combo, null, md);
186             return finalHash;
187         }
188 
189         private final static char charArray[] = {
190             &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;,
191             &#39;8&#39;, &#39;9&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;
192         };
193 
194         private String encode(String src, char[] passwd, MessageDigest md) {
195             md.update(src.getBytes());
196             if (passwd != null) {
197                 byte[] passwdBytes = new byte[passwd.length];
198                 for (int i=0; i&lt;passwd.length; i++)
199                     passwdBytes[i] = (byte)passwd[i];
200                 md.update(passwdBytes);
201                 Arrays.fill(passwdBytes, (byte)0x00);
202             }
203             byte[] digest = md.digest();
204 
205             StringBuffer res = new StringBuffer(digest.length * 2);
206             for (int i = 0; i &lt; digest.length; i++) {
207                 int hashchar = ((digest[i] &gt;&gt;&gt; 4) &amp; 0xf);
208                 res.append(charArray[hashchar]);
209                 hashchar = (digest[i] &amp; 0xf);
210                 res.append(charArray[hashchar]);
211             }
212             return res.toString();
213         }
214     }
215 
216 
217     static class MyAuthenticator extends Authenticator {
218         public MyAuthenticator () {
219             super ();
220         }
221 
222         public PasswordAuthentication getPasswordAuthentication ()
223         {
224             return (new PasswordAuthentication (username, passwd));
225         }
226     }
227 
228 
229     public static void main(String[] args) throws Exception {
230         int nLoops = 1;
231         int nSize = 10;
232         int port, n =0;
233         byte b[] = new byte[nSize];
234         DigestServer server;
235         ServerSocket sock;
236 
<a name="9" id="anc9"></a><span class="line-added">237         InetAddress address = InetAddress.getLoopbackAddress();</span>
<span class="line-added">238         InetAddress resolved = InetAddress.getByName(address.getHostName());</span>
<span class="line-added">239         System.out.println(&quot;Lookup: &quot;</span>
<span class="line-added">240                             + address + &quot; -&gt; \&quot;&quot; + address.getHostName() + &quot;\&quot; -&gt; &quot;</span>
<span class="line-added">241                             + resolved);</span>
<span class="line-added">242         String proxyHost = address.equals(resolved)</span>
<span class="line-added">243             ? address.getHostName()</span>
<span class="line-added">244             : address.getHostAddress();</span>
245         try {
<a name="10" id="anc10"></a><span class="line-modified">246             sock = new ServerSocket();</span>
<span class="line-added">247             sock.bind(new InetSocketAddress(address, 0));</span>
248             port = sock.getLocalPort ();
249         }
250         catch (Exception e) {
251             System.out.println (&quot;Exception: &quot; + e);
252             return;
253         }
254 
255         server = new DigestServer(sock);
256         server.start ();
257 
258         try  {
<a name="11" id="anc11"></a>
259             Authenticator.setDefault (new MyAuthenticator ());
<a name="12" id="anc12"></a><span class="line-modified">260             SocketAddress addr = InetSocketAddress.createUnresolved(proxyHost, port);</span>
261             Proxy proxy = new Proxy (Proxy.Type.HTTP, addr);
262             String s = &quot;http://www.ibm.com&quot;;
263             URL url = new URL(s);
<a name="13" id="anc13"></a><span class="line-added">264             System.out.println(&quot;opening connection through proxy: &quot; + addr);</span>
265             java.net.URLConnection conURL =  url.openConnection(proxy);
266 
267             InputStream in = conURL.getInputStream();
268             int c;
269             while ((c = in.read ()) != -1) {
270             }
271             in.close ();
272         }
273         catch(IOException e) {
274             e.printStackTrace();
275             error = true;
<a name="14" id="anc14"></a><span class="line-added">276             sock.close();</span>
<span class="line-added">277         } finally {</span>
<span class="line-added">278             server.join();</span>
279         }
280         if (error) {
281             throw new RuntimeException (&quot;Error in test&quot;);
282         }
283     }
284 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>