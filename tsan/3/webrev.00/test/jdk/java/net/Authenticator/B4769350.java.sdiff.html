<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/Authenticator/B4769350.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B4759514.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B4921848.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Authenticator/B4769350.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 4769350 8017779</span>
 27  * @modules jdk.httpserver
 28  * @run main/othervm B4769350 server
 29  * @run main/othervm B4769350 proxy


 30  * @summary proxy authentication username and password caching only works in serial case
 31  * Run in othervm since the test sets system properties that are read by the
 32  * networking stack and cached when the HTTP handler is invoked, and previous
 33  * tests may already have invoked the HTTP handler.
 34  */
 35 
 36 import com.sun.net.httpserver.HttpExchange;
 37 import com.sun.net.httpserver.HttpHandler;
 38 import com.sun.net.httpserver.HttpServer;
 39 import java.io.*;
 40 import java.net.*;
 41 import java.util.concurrent.BrokenBarrierException;
 42 import java.util.concurrent.CountDownLatch;
 43 import java.util.concurrent.CyclicBarrier;
 44 import java.util.concurrent.Executor;
 45 import java.util.concurrent.ExecutorService;
 46 import java.util.concurrent.Executors;
 47 
 48 public class B4769350 {
 49 
</pre>
<hr />
<pre>
 82             } catch (IOException e) {
 83                 if (!allowerror) {
 84                     System.out.println (Thread.currentThread().getName()
 85                             + &quot; &quot; + e);
 86                     e.printStackTrace();
 87                     error = true;
 88                 }
 89             }
 90         }
 91     }
 92 
 93     class Server implements AutoCloseable {
 94         HttpServer server;
 95         Executor executor;
 96 
 97         public String getAddress() {
 98             return server.getAddress().getHostName();
 99         }
100 
101         public void startServer() {
<span class="line-modified">102             InetSocketAddress addr = new InetSocketAddress(0);</span>

103 
104             try {
105                 server = HttpServer.create(addr, 0);
106             } catch (IOException ioe) {
107                 throw new RuntimeException(&quot;Server could not be created&quot;);
108             }
109             executor = Executors.newFixedThreadPool(10);
110             server.setExecutor(executor);
111             server.createContext(&quot;/test/realm1/t1a&quot;,
112                     new AuthenticationHandlerT1a() );
113             server.createContext(&quot;/test/realm2/t1b&quot;,
114                     new AuthenticationHandlerT1b());
115             server.createContext(&quot;/test/realm1/t1c&quot;,
116                     new AuthenticationHandlerT1c());
117             server.createContext(&quot;/test/realm2/t1d&quot;,
118                     new AuthenticationHandlerT1d());
119             server.createContext(&quot;/test/realm3/t2a&quot;,
120                     new AuthenticationHandlerT2a());
121             server.createContext(&quot;/test/realm3/t2b&quot;,
122                     new AuthenticationHandlerT2b());
</pre>
<hr />
<pre>
439                     server);
440         }
441         if (error) {
442             except (&quot;error occurred&quot;, server);
443         }
444     }
445 
446     public static void main (String[] args) throws Exception {
447         new B4769350().runTest(args[0].equals (&quot;proxy&quot;));
448     }
449 
450     public void runTest(boolean proxy) throws Exception {
451         System.setProperty (&quot;http.maxRedirects&quot;, Integer.toString (redirects));
452         System.setProperty (&quot;http.auth.serializeRequests&quot;, &quot;true&quot;);
453         Authenticator.setDefault (auth);
454         try (Server server = new Server()) {
455             server.startServer();
456             System.out.println (&quot;Server: listening on port: &quot;
457                     + server.getPort());
458             if (proxy) {
<span class="line-modified">459                 System.setProperty (&quot;http.proxyHost&quot;, &quot;localhost&quot;);</span>

460                 System.setProperty (&quot;http.proxyPort&quot;,
461                         Integer.toString(server.getPort()));
462                 doProxyTests (&quot;www.foo.com&quot;, server);
463             } else {
<span class="line-modified">464                 doServerTests (&quot;localhost:&quot;+server.getPort(), server);</span>

465             }
466         }
467 
468     }
469 









470     public static void except (String s, Server server) {
471         server.close();
472         throw new RuntimeException (s);
473     }
474 
475     static class MyAuthenticator extends Authenticator {
476         MyAuthenticator () {
477             super ();
478         }
479 
480         volatile int count = 0;
481 
482         @Override
483         public PasswordAuthentication getPasswordAuthentication () {
484             PasswordAuthentication pw;
485             pw = new PasswordAuthentication (&quot;user&quot;, &quot;pass1&quot;.toCharArray());
486             count ++;
487             return pw;
488         }
489 
490         public void resetCount () {
491             count = 0;
492         }
493 
494         public int getCount () {
495             return count;
496         }
497     }
498 }
<span class="line-removed">499 </span>
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 4769350 8017779 8191169</span>
 27  * @modules jdk.httpserver
 28  * @run main/othervm B4769350 server
 29  * @run main/othervm B4769350 proxy
<span class="line-added"> 30  * @run main/othervm -Djava.net.preferIPv6Addresses=true B4769350 server</span>
<span class="line-added"> 31  * @run main/othervm -Djava.net.preferIPv6Addresses=true B4769350 proxy</span>
 32  * @summary proxy authentication username and password caching only works in serial case
 33  * Run in othervm since the test sets system properties that are read by the
 34  * networking stack and cached when the HTTP handler is invoked, and previous
 35  * tests may already have invoked the HTTP handler.
 36  */
 37 
 38 import com.sun.net.httpserver.HttpExchange;
 39 import com.sun.net.httpserver.HttpHandler;
 40 import com.sun.net.httpserver.HttpServer;
 41 import java.io.*;
 42 import java.net.*;
 43 import java.util.concurrent.BrokenBarrierException;
 44 import java.util.concurrent.CountDownLatch;
 45 import java.util.concurrent.CyclicBarrier;
 46 import java.util.concurrent.Executor;
 47 import java.util.concurrent.ExecutorService;
 48 import java.util.concurrent.Executors;
 49 
 50 public class B4769350 {
 51 
</pre>
<hr />
<pre>
 84             } catch (IOException e) {
 85                 if (!allowerror) {
 86                     System.out.println (Thread.currentThread().getName()
 87                             + &quot; &quot; + e);
 88                     e.printStackTrace();
 89                     error = true;
 90                 }
 91             }
 92         }
 93     }
 94 
 95     class Server implements AutoCloseable {
 96         HttpServer server;
 97         Executor executor;
 98 
 99         public String getAddress() {
100             return server.getAddress().getHostName();
101         }
102 
103         public void startServer() {
<span class="line-modified">104             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">105             InetSocketAddress addr = new InetSocketAddress(loopback, 0);</span>
106 
107             try {
108                 server = HttpServer.create(addr, 0);
109             } catch (IOException ioe) {
110                 throw new RuntimeException(&quot;Server could not be created&quot;);
111             }
112             executor = Executors.newFixedThreadPool(10);
113             server.setExecutor(executor);
114             server.createContext(&quot;/test/realm1/t1a&quot;,
115                     new AuthenticationHandlerT1a() );
116             server.createContext(&quot;/test/realm2/t1b&quot;,
117                     new AuthenticationHandlerT1b());
118             server.createContext(&quot;/test/realm1/t1c&quot;,
119                     new AuthenticationHandlerT1c());
120             server.createContext(&quot;/test/realm2/t1d&quot;,
121                     new AuthenticationHandlerT1d());
122             server.createContext(&quot;/test/realm3/t2a&quot;,
123                     new AuthenticationHandlerT2a());
124             server.createContext(&quot;/test/realm3/t2b&quot;,
125                     new AuthenticationHandlerT2b());
</pre>
<hr />
<pre>
442                     server);
443         }
444         if (error) {
445             except (&quot;error occurred&quot;, server);
446         }
447     }
448 
449     public static void main (String[] args) throws Exception {
450         new B4769350().runTest(args[0].equals (&quot;proxy&quot;));
451     }
452 
453     public void runTest(boolean proxy) throws Exception {
454         System.setProperty (&quot;http.maxRedirects&quot;, Integer.toString (redirects));
455         System.setProperty (&quot;http.auth.serializeRequests&quot;, &quot;true&quot;);
456         Authenticator.setDefault (auth);
457         try (Server server = new Server()) {
458             server.startServer();
459             System.out.println (&quot;Server: listening on port: &quot;
460                     + server.getPort());
461             if (proxy) {
<span class="line-modified">462                 System.setProperty (&quot;http.proxyHost&quot;,</span>
<span class="line-added">463                         InetAddress.getLoopbackAddress().getHostAddress());</span>
464                 System.setProperty (&quot;http.proxyPort&quot;,
465                         Integer.toString(server.getPort()));
466                 doProxyTests (&quot;www.foo.com&quot;, server);
467             } else {
<span class="line-modified">468                 ProxySelector.setDefault(ProxySelector.of(null));</span>
<span class="line-added">469                 doServerTests (authority(server.getPort()), server);</span>
470             }
471         }
472 
473     }
474 
<span class="line-added">475     static String authority(int port) {</span>
<span class="line-added">476         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">477         String hoststr = loopback.getHostAddress();</span>
<span class="line-added">478         if (hoststr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="line-added">479             hoststr = &quot;[&quot; + hoststr + &quot;]&quot;;</span>
<span class="line-added">480         }</span>
<span class="line-added">481         return hoststr + &quot;:&quot; + port;</span>
<span class="line-added">482     }</span>
<span class="line-added">483 </span>
484     public static void except (String s, Server server) {
485         server.close();
486         throw new RuntimeException (s);
487     }
488 
489     static class MyAuthenticator extends Authenticator {
490         MyAuthenticator () {
491             super ();
492         }
493 
494         volatile int count = 0;
495 
496         @Override
497         public PasswordAuthentication getPasswordAuthentication () {
498             PasswordAuthentication pw;
499             pw = new PasswordAuthentication (&quot;user&quot;, &quot;pass1&quot;.toCharArray());
500             count ++;
501             return pw;
502         }
503 
504         public void resetCount () {
505             count = 0;
506         }
507 
508         public int getCount () {
509             return count;
510         }
511     }
512 }

</pre>
</td>
</tr>
</table>
<center><a href="B4759514.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="B4921848.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>