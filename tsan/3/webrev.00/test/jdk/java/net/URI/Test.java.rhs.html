<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/URI/Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /* @test
  25  * @summary Unit test for java.net.URI
  26  * @bug 4464135 4505046 4503239 4438319 4991359 4866303 7023363 7041800
  27  *      7171415 6933879
  28  * @author Mark Reinhold
  29  */
  30 
  31 import java.io.ByteArrayInputStream;
  32 import java.io.ByteArrayOutputStream;
  33 import java.io.IOException;
  34 import java.io.ObjectInputStream;
  35 import java.io.ObjectOutputStream;
  36 import java.io.PrintStream;
  37 import java.net.URI;
  38 import java.net.URISyntaxException;
  39 import java.net.URL;
  40 import java.net.MalformedURLException;
  41 
  42 
  43 public class Test {
  44 
  45     static PrintStream out = System.out;
  46     static int testCount = 0;
  47 
  48     // Properties that we check
  49     static final int PARSEFAIL   = 1 &lt;&lt; 0;
  50     static final int SCHEME      = 1 &lt;&lt; 1;
  51     static final int SSP         = 1 &lt;&lt; 2;
  52     static final int SSP_D       = 1 &lt;&lt; 3;      // Decoded form
  53     static final int OPAQUEPART  = 1 &lt;&lt; 4;      // SSP, and URI is opaque
  54     static final int USERINFO    = 1 &lt;&lt; 5;
  55     static final int USERINFO_D  = 1 &lt;&lt; 6;      // Decoded form
  56     static final int HOST        = 1 &lt;&lt; 7;
  57     static final int PORT        = 1 &lt;&lt; 8;
  58     static final int REGISTRY    = 1 &lt;&lt; 9;
  59     static final int REGISTRY_D  = 1 &lt;&lt; 10;     // Decoded form
  60     static final int PATH        = 1 &lt;&lt; 11;
  61     static final int PATH_D      = 1 &lt;&lt; 12;     // Decoded form
  62     static final int QUERY       = 1 &lt;&lt; 13;
  63     static final int QUERY_D     = 1 &lt;&lt; 14;     // Decoded form
  64     static final int FRAGMENT    = 1 &lt;&lt; 15;
  65     static final int FRAGMENT_D  = 1 &lt;&lt; 16;     // Decoded form
  66     static final int TOASCII     = 1 &lt;&lt; 17;
  67     static final int IDENT_STR   = 1 &lt;&lt; 18;     // Identities
  68     static final int IDENT_URI1  = 1 &lt;&lt; 19;
  69     static final int IDENT_URI3  = 1 &lt;&lt; 20;
  70     static final int IDENT_URI5  = 1 &lt;&lt; 21;
  71     static final int IDENT_URI7  = 1 &lt;&lt; 22;
  72     static final int TOSTRING    = 1 &lt;&lt; 23;
  73 
  74     String input;
  75     URI uri = null;
  76     URI originalURI;
  77     URI base = null;                    // Base for resolution/relativization
  78     String op = null;                   // Op performed if uri != originalURI
  79     int checked = 0;                    // Mask for checked properties
  80     int failed = 0;                     // Mask for failed properties
  81     Exception exc = null;
  82 
  83     private Test(String s) {
  84         testCount++;
  85         input = s;
  86         try {
  87             uri = new URI(s);
  88         } catch (URISyntaxException x) {
  89             exc = x;
  90         }
  91         originalURI = uri;
  92     }
  93 
  94     static Test test(String s) {
  95         return new Test(s);
  96     }
  97 
  98     private Test(String s, String u, String h, int n,
  99                  String p, String q, String f)
 100     {
 101         testCount++;
 102         try {
 103             uri = new URI(s, u, h, n, p, q, f);
 104         } catch (URISyntaxException x) {
 105             exc = x;
 106             input = x.getInput();
 107         }
 108         if (uri != null)
 109             input = uri.toString();
 110         originalURI = uri;
 111     }
 112 
 113     static Test test(String s, String u, String h, int n,
 114                      String p, String q, String f) {
 115         return new Test(s, u, h, n, p, q, f);
 116     }
 117 
 118     private Test(String s, String a,
 119                  String p, String q, String f)
 120     {
 121         testCount++;
 122         try {
 123             uri = new URI(s, a, p, q, f);
 124         } catch (URISyntaxException x) {
 125             exc = x;
 126             input = x.getInput();
 127         }
 128         if (uri != null)
 129             input = uri.toString();
 130         originalURI = uri;
 131     }
 132 
 133     static Test test(String s, String a,
 134                      String p, String q, String f) {
 135         return new Test(s, a, p, q, f);
 136     }
 137 
 138     private Test(String s, String h, String p, String f) {
 139         testCount++;
 140         try {
 141             uri = new URI(s, h, p, f);
 142         } catch (URISyntaxException x) {
 143             exc = x;
 144             input = x.getInput();
 145         }
 146         if (uri != null)
 147             input = uri.toString();
 148         originalURI = uri;
 149     }
 150 
 151     static Test test(String s, String h, String p, String f) {
 152         return new Test(s, h, p, f);
 153     }
 154 
 155     private Test(String s, String ssp, String f) {
 156         testCount++;
 157         try {
 158             uri = new URI(s, ssp, f);
 159         } catch (URISyntaxException x) {
 160             exc = x;
 161             input = x.getInput();
 162         }
 163         if (uri != null)
 164             input = uri.toString();
 165         originalURI = uri;
 166     }
 167 
 168     static Test test(String s, String ssp, String f) {
 169         return new Test(s, ssp, f);
 170     }
 171 
 172     private Test(String s, boolean xxx) {
 173         testCount++;
 174         try {
 175             uri = URI.create(s);
 176         } catch (IllegalArgumentException x) {
 177             exc = x;
 178         }
 179         if (uri != null)
 180             input = uri.toString();
 181         originalURI = uri;
 182     }
 183 
 184     static Test testCreate(String s) {
 185         return new Test(s, false);
 186     }
 187 
 188     boolean parsed() {
 189         return uri != null;
 190     }
 191 
 192     boolean resolved() {
 193         return base != null;
 194     }
 195 
 196     URI uri() {
 197         return uri;
 198     }
 199 
 200 
 201     // Operations on Test instances
 202     //
 203     // These are short so as to make test cases compact.
 204     //
 205     //    s      Scheme
 206     //    sp     Scheme-specific part
 207     //    spd    Scheme-specific part, decoded
 208     //    o      Opaque part (isOpaque() &amp;&amp; ssp matches)
 209     //    g      reGistry (authority matches, and host is not defined)
 210     //    gd     reGistry, decoded
 211     //    u      User info
 212     //    ud     User info, decoded
 213     //    h      Host
 214     //    n      port Number
 215     //    p      Path
 216     //    pd     Path, decoded
 217     //    q      Query
 218     //    qd     Query, decoded
 219     //    f      Fragment
 220     //    fd     Fragment, decoded
 221     //
 222     //    rslv   Resolve against given base
 223     //    rtvz   Relativize
 224     //    psa    Parse server Authority
 225     //    norm   Normalize
 226     //    ta     ASCII form
 227     //
 228     //    x      Check that parse failed as expected
 229     //    z      End -- ensure that unchecked components are null
 230 
 231     private boolean check1(int prop) {
 232         checked |= prop;
 233         if (!parsed()) {
 234             failed |= prop;
 235             return false;
 236         }
 237         return true;
 238     }
 239 
 240     private void check2(String s, String ans, int prop) {
 241         if ((s == null) || !s.equals(ans))
 242             failed |= prop;
 243     }
 244 
 245     Test s(String s) {
 246         if (check1(SCHEME)) check2(uri.getScheme(), s, SCHEME);
 247         return this;
 248     }
 249 
 250     Test u(String s) {
 251         if (check1(USERINFO)) check2(uri.getRawUserInfo(), s, USERINFO);
 252         return this;
 253     }
 254 
 255     Test ud(String s) {
 256         if (check1(USERINFO_D)) {
 257             check2(uri.getUserInfo(), s, USERINFO_D);
 258         }
 259         return this;
 260     }
 261 
 262     Test h(String s) {
 263         if (check1(HOST)) check2(uri.getHost(), s, HOST);
 264         return this;
 265     }
 266 
 267     Test g(String s) {
 268         if (check1(REGISTRY)) {
 269             if (uri.getHost() != null)
 270                 failed |= REGISTRY;
 271             else
 272                 check2(uri.getRawAuthority(), s, REGISTRY);
 273         }
 274         return this;
 275     }
 276 
 277     Test gd(String s) {
 278         if (check1(REGISTRY_D)) {
 279             if (uri.getHost() != null)
 280                 failed |= REGISTRY_D;
 281             else
 282                 check2(uri.getAuthority(), s, REGISTRY_D);
 283         }
 284         return this;
 285     }
 286 
 287     Test n(int n) {
 288         checked |= PORT;
 289         if (!parsed() || (uri.getPort() != n))
 290             failed |= PORT;
 291         return this;
 292     }
 293 
 294     Test p(String s) {
 295         if (check1(PATH)) check2(uri.getRawPath(), s, PATH);
 296         return this;
 297     }
 298 
 299     Test pd(String s) {
 300         if (check1(PATH_D)) check2(uri.getPath(), s, PATH_D);
 301         return this;
 302     }
 303 
 304     Test o(String s) {
 305         if (check1(OPAQUEPART)) {
 306             if (!uri.isOpaque())
 307                 failed |= OPAQUEPART;
 308             else
 309                 check2(uri.getSchemeSpecificPart(), s, OPAQUEPART);
 310         }
 311         return this;
 312     }
 313 
 314     Test sp(String s) {
 315         if (check1(SSP)) check2(uri.getRawSchemeSpecificPart(), s, SSP);
 316         return this;
 317     }
 318 
 319     Test spd(String s) {
 320         if (check1(SSP_D)) check2(uri.getSchemeSpecificPart(), s, SSP_D);
 321         return this;
 322     }
 323 
 324     Test q(String s) {
 325         if (check1(QUERY)) check2(uri.getRawQuery(), s, QUERY);
 326         return this;
 327     }
 328 
 329     Test qd(String s) {
 330         if (check1(QUERY_D)) check2(uri.getQuery(), s, QUERY_D);
 331         return this;
 332     }
 333 
 334     Test f(String s) {
 335         if (check1(FRAGMENT)) check2(uri.getRawFragment(), s, FRAGMENT);
 336         return this;
 337     }
 338 
 339     Test fd(String s) {
 340         if (check1(FRAGMENT_D)) check2(uri.getFragment(), s, FRAGMENT_D);
 341         return this;
 342     }
 343 
 344     Test ta(String s) {
 345         if (check1(TOASCII))
 346             check2(uri.toASCIIString(), s, TOASCII);
 347         return this;
 348     }
 349 
 350     Test ts(String s) {
 351         if (check1(TOSTRING))
 352             check2(uri.toString(), s, TOSTRING);
 353         return this;
 354     }
 355 
 356     Test x() {
 357         checked |= PARSEFAIL;
 358         if (parsed())
 359             failed |= PARSEFAIL;
 360         return this;
 361     }
 362 
 363     Test rslv(URI base) {
 364         if (!parsed())
 365             return this;
 366         this.base = base;
 367         op = &quot;rslv&quot;;
 368         URI u = uri;
 369         uri = null;
 370         try {
 371             this.uri = base.resolve(u);
 372         } catch (IllegalArgumentException x) {
 373             exc = x;
 374         }
 375         checked = 0;
 376         failed = 0;
 377         return this;
 378     }
 379 
 380     Test norm() {
 381         if (!parsed())
 382             return this;
 383         op = &quot;norm&quot;;
 384         uri = uri.normalize();
 385         return this;
 386     }
 387 
 388     Test rtvz(URI base) {
 389         if (!parsed())
 390             return this;
 391         this.base = base;
 392         op = &quot;rtvz&quot;;
 393         uri = base.relativize(uri);
 394         checked = 0;
 395         failed = 0;
 396         return this;
 397     }
 398 
 399     Test psa() {
 400         try {
 401             uri.parseServerAuthority();
 402         } catch (URISyntaxException x) {
 403             exc = x;
 404             uri = null;
 405         }
 406         checked = 0;
 407         failed = 0;
 408         return this;
 409     }
 410 
 411     private void checkEmpty(String s, int prop) {
 412         if (((checked &amp; prop) == 0) &amp;&amp; (s != null))
 413             failed |= prop;
 414     }
 415 
 416     // Check identity for the seven-argument URI constructor
 417     //
 418     void checkURI7() {
 419         // Only works on hierarchical URIs
 420         if (uri.isOpaque())
 421             return;
 422         // Only works with server-based authorities
 423         if ((uri.getAuthority() == null)
 424             != ((uri.getUserInfo() == null) &amp;&amp; (uri.getHost() == null)))
 425             return;
 426         // Not true if non-US-ASCII chars are encoded unnecessarily
 427         if (uri.getPath().indexOf(&#39;\u20AC&#39;) &gt;= 0)
 428             return;
 429         try {
 430             URI u2 = new URI(uri.getScheme(), uri.getUserInfo(),
 431                              uri.getHost(), uri.getPort(), uri.getPath(),
 432                              uri.getQuery(), uri.getFragment());
 433             if (!uri.equals(u2))
 434                 failed |= IDENT_URI7;
 435         } catch (URISyntaxException x) {
 436             failed |= IDENT_URI7;
 437         }
 438     }
 439 
 440     // Check identity for the five-argument URI constructor
 441     //
 442     void checkURI5() {
 443         // Only works on hierarchical URIs
 444         if (uri.isOpaque())
 445             return;
 446         try {
 447             URI u2 = new URI(uri.getScheme(), uri.getAuthority(),
 448                              uri.getPath(), uri.getQuery(), uri.getFragment());
 449             if (!uri.equals(u2))
 450                 failed |= IDENT_URI5;
 451         } catch (URISyntaxException x) {
 452             failed |= IDENT_URI5;
 453         }
 454     }
 455 
 456     // Check identity for the three-argument URI constructor
 457     //
 458     void checkURI3() {
 459         try {
 460             URI u2 = new URI(uri.getScheme(),
 461                              uri.getSchemeSpecificPart(),
 462                              uri.getFragment());
 463             if (!uri.equals(u2))
 464                 failed |= IDENT_URI3;
 465         } catch (URISyntaxException x) {
 466             failed |= IDENT_URI3;
 467         }
 468     }
 469 
 470     // Check all identities mentioned in the URI class specification
 471     //
 472     void checkIdentities() {
 473         if (input != null) {
 474             if (!uri.toString().equals(input))
 475                 failed |= IDENT_STR;
 476         }
 477         try {
 478             if (!(new URI(uri.toString())).equals(uri))
 479                 failed |= IDENT_URI1;
 480         } catch (URISyntaxException x) {
 481             failed |= IDENT_URI1;
 482         }
 483 
 484         // Remaining identities fail if &quot;//&quot; given but authority is undefined
 485         if ((uri.getAuthority() == null)
 486             &amp;&amp; (uri.getSchemeSpecificPart() != null)
 487             &amp;&amp; (uri.getSchemeSpecificPart().startsWith(&quot;///&quot;)
 488                 || uri.getSchemeSpecificPart().startsWith(&quot;//?&quot;)
 489                 || uri.getSchemeSpecificPart().equals(&quot;//&quot;)))
 490             return;
 491 
 492         // Remaining identities fail if &quot;:&quot; given but port is undefined
 493         if ((uri.getHost() != null)
 494             &amp;&amp; (uri.getAuthority() != null)
 495             &amp;&amp; (uri.getAuthority().equals(uri.getHost() + &quot;:&quot;)))
 496             return;
 497 
 498         // Remaining identities fail if non-US-ASCII chars are encoded
 499         // unnecessarily
 500         if ((uri.getPath() != null) &amp;&amp; uri.getPath().indexOf(&#39;\u20AC&#39;) &gt;= 0)
 501             return;
 502 
 503         checkURI3();
 504         checkURI5();
 505         checkURI7();
 506     }
 507 
 508     // Check identities, check that unchecked component properties are not
 509     // defined, and report any failures
 510     //
 511     Test z() {
 512         if (!parsed()) {
 513             report();
 514             return this;
 515         }
 516 
 517         if (op == null)
 518             checkIdentities();
 519 
 520         // Check that unchecked components are undefined
 521         checkEmpty(uri.getScheme(), SCHEME);
 522         checkEmpty(uri.getUserInfo(), USERINFO);
 523         checkEmpty(uri.getHost(), HOST);
 524         if (((checked &amp; PORT) == 0) &amp;&amp; (uri.getPort() != -1)) failed |= PORT;
 525         checkEmpty(uri.getPath(), PATH);
 526         checkEmpty(uri.getQuery(), QUERY);
 527         checkEmpty(uri.getFragment(), FRAGMENT);
 528 
 529         // Report failures
 530         report();
 531         return this;
 532     }
 533 
 534 
 535     // Summarization and reporting
 536 
 537     static void header(String s) {
 538         out.println();
 539         out.println();
 540         out.println(&quot;-- &quot; + s + &quot; --&quot;);
 541     }
 542 
 543     static void show(String prefix, URISyntaxException x) {
 544         out.println(uquote(x.getInput()));
 545         if (x.getIndex() &gt;= 0) {
 546             for (int i = 0; i &lt; x.getIndex(); i++) {
 547                 if (x.getInput().charAt(i) &gt;= &#39;\u0080&#39;)
 548                     out.print(&quot;      &quot;);        // Skip over \u1234
 549                 else
 550                     out.print(&quot; &quot;);
 551             }
 552             out.println(&quot;^&quot;);
 553         }
 554         out.println(prefix + &quot;: &quot; + x.getReason());
 555     }
 556 
 557     private void summarize() {
 558         out.println();
 559         StringBuffer sb = new StringBuffer();
 560         if (input.length() == 0)
 561             sb.append(&quot;\&quot;\&quot;&quot;);
 562         else
 563             sb.append(input);
 564         if (base != null) {
 565             sb.append(&quot; &quot;);
 566             sb.append(base);
 567         }
 568         if (!parsed()) {
 569             String s = (((checked &amp; PARSEFAIL) != 0)
 570                         ? &quot;Correct exception&quot; : &quot;UNEXPECTED EXCEPTION&quot;);
 571             if (exc instanceof URISyntaxException)
 572                 show(s, (URISyntaxException)exc);
 573             else {
 574                 out.println(uquote(sb.toString()));
 575                 out.print(s + &quot;: &quot;);
 576                 exc.printStackTrace(out);
 577             }
 578         } else {
 579             if (uri != originalURI) {
 580                 sb.append(&quot; &quot;);
 581                 sb.append(op);
 582                 sb.append(&quot; --&gt; &quot;);
 583                 sb.append(uri);
 584             }
 585             out.println(uquote(sb.toString()));
 586         }
 587     }
 588 
 589     public static String uquote(String str) {
 590         if (str == null)
 591             return str;
 592         StringBuffer sb = new StringBuffer();
 593         int n = str.length();
 594         for (int i = 0; i &lt; n; i++) {
 595             char c = str.charAt(i);
 596             if ((c &gt;= &#39; &#39;) &amp;&amp; (c &lt; 0x7f)) {
 597                 sb.append(c);
 598                 continue;
 599             }
 600             sb.append(&quot;\\u&quot;);
 601             String s = Integer.toHexString(c).toUpperCase();
 602             while (s.length() &lt; 4)
 603                 s = &quot;0&quot; + s;
 604             sb.append(s);
 605         }
 606         return sb.toString();
 607     }
 608 
 609     static void show(String n, String v) {
 610         out.println(&quot;  &quot; + n
 611                     + &quot;          = &quot;.substring(n.length())
 612                     + uquote(v));
 613     }
 614 
 615     static void show(String n, String v, String vd) {
 616         if ((v == null) || v.equals(vd))
 617             show(n, v);
 618         else {
 619             out.println(&quot;  &quot; + n
 620                         + &quot;          = &quot;.substring(n.length())
 621                         + uquote(v)
 622                         + &quot; = &quot; + uquote(vd));
 623         }
 624     }
 625 
 626     public static void show(URI u) {
 627         show(&quot;opaque&quot;, &quot;&quot; + u.isOpaque());
 628         show(&quot;scheme&quot;, u.getScheme());
 629         show(&quot;ssp&quot;, u.getRawSchemeSpecificPart(), u.getSchemeSpecificPart());
 630         show(&quot;authority&quot;, u.getRawAuthority(), u.getAuthority());
 631         show(&quot;userinfo&quot;, u.getRawUserInfo(), u.getUserInfo());
 632         show(&quot;host&quot;, u.getHost());
 633         show(&quot;port&quot;, &quot;&quot; + u.getPort());
 634         show(&quot;path&quot;, u.getRawPath(), u.getPath());
 635         show(&quot;query&quot;, u.getRawQuery(), u.getQuery());
 636         show(&quot;fragment&quot;, u.getRawFragment(), u.getFragment());
 637         if (!u.toString().equals(u.toASCIIString()))
 638             show(&quot;toascii&quot;, u.toASCIIString());
 639     }
 640 
 641     private void report() {
 642         summarize();
 643         if (failed == 0) return;
 644         StringBuffer sb = new StringBuffer();
 645         sb.append(&quot;FAIL:&quot;);
 646         if ((failed &amp; PARSEFAIL) != 0) sb.append(&quot; parsefail&quot;);
 647         if ((failed &amp; SCHEME) != 0) sb.append(&quot; scheme&quot;);
 648         if ((failed &amp; SSP) != 0) sb.append(&quot; ssp&quot;);
 649         if ((failed &amp; OPAQUEPART) != 0) sb.append(&quot; opaquepart&quot;);
 650         if ((failed &amp; USERINFO) != 0) sb.append(&quot; userinfo&quot;);
 651         if ((failed &amp; USERINFO_D) != 0) sb.append(&quot; userinfod&quot;);
 652         if ((failed &amp; HOST) != 0) sb.append(&quot; host&quot;);
 653         if ((failed &amp; PORT) != 0) sb.append(&quot; port&quot;);
 654         if ((failed &amp; REGISTRY) != 0) sb.append(&quot; registry&quot;);
 655         if ((failed &amp; PATH) != 0) sb.append(&quot; path&quot;);
 656         if ((failed &amp; PATH_D) != 0) sb.append(&quot; pathd&quot;);
 657         if ((failed &amp; QUERY) != 0) sb.append(&quot; query&quot;);
 658         if ((failed &amp; QUERY_D) != 0) sb.append(&quot; queryd&quot;);
 659         if ((failed &amp; FRAGMENT) != 0) sb.append(&quot; fragment&quot;);
 660         if ((failed &amp; FRAGMENT_D) != 0) sb.append(&quot; fragmentd&quot;);
 661         if ((failed &amp; TOASCII) != 0) sb.append(&quot; toascii&quot;);
 662         if ((failed &amp; IDENT_STR) != 0) sb.append(&quot; ident-str&quot;);
 663         if ((failed &amp; IDENT_URI1) != 0) sb.append(&quot; ident-uri1&quot;);
 664         if ((failed &amp; IDENT_URI3) != 0) sb.append(&quot; ident-uri3&quot;);
 665         if ((failed &amp; IDENT_URI5) != 0) sb.append(&quot; ident-uri5&quot;);
 666         if ((failed &amp; IDENT_URI7) != 0) sb.append(&quot; ident-uri7&quot;);
 667         if ((failed &amp; TOSTRING) != 0) sb.append(&quot; tostring&quot;);
 668         out.println(sb.toString());
 669         if (uri != null) show(uri);
 670         throw new RuntimeException(&quot;Test failed&quot;);
 671     }
 672 
 673 
 674 
 675     // -- Tests --
 676 
 677     static void rfc2396() {
 678 
 679 
 680         header(&quot;RFC2396: Basic examples&quot;);
 681 
 682         test(&quot;ftp://ftp.is.co.za/rfc/rfc1808.txt&quot;)
 683             .s(&quot;ftp&quot;).h(&quot;ftp.is.co.za&quot;).p(&quot;/rfc/rfc1808.txt&quot;).z();
 684 
 685         test(&quot;http://www.math.uio.no/faq/compression-faq/part1.html&quot;)
 686             .s(&quot;http&quot;).h(&quot;www.math.uio.no&quot;).p(&quot;/faq/compression-faq/part1.html&quot;).z();
 687 
 688         test(&quot;mailto:mduerst@ifi.unizh.ch&quot;)
 689             .s(&quot;mailto&quot;).o(&quot;mduerst@ifi.unizh.ch&quot;).z();
 690 
 691         test(&quot;news:comp.infosystems.www.servers.unix&quot;)
 692             .s(&quot;news&quot;).o(&quot;comp.infosystems.www.servers.unix&quot;).z();
 693 
 694         test(&quot;telnet://melvyl.ucop.edu/&quot;)
 695             .s(&quot;telnet&quot;).h(&quot;melvyl.ucop.edu&quot;).p(&quot;/&quot;).z();
 696 
 697         test(&quot;http://www.w3.org/Addressing/&quot;)
 698             .s(&quot;http&quot;).h(&quot;www.w3.org&quot;).p(&quot;/Addressing/&quot;).z();
 699 
 700         test(&quot;ftp://ds.internic.net/rfc/&quot;)
 701             .s(&quot;ftp&quot;).h(&quot;ds.internic.net&quot;).p(&quot;/rfc/&quot;).z();
 702 
 703         test(&quot;http://www.ics.uci.edu/pub/ietf/uri/historical.html#WARNING&quot;)
 704             .s(&quot;http&quot;).h(&quot;www.ics.uci.edu&quot;).p(&quot;/pub/ietf/uri/historical.html&quot;)
 705             .f(&quot;WARNING&quot;).z();
 706 
 707         test(&quot;http://www.ics.uci.edu/pub/ietf/uri/#Related&quot;)
 708             .s(&quot;http&quot;).h(&quot;www.ics.uci.edu&quot;).p(&quot;/pub/ietf/uri/&quot;)
 709             .f(&quot;Related&quot;).z();
 710 
 711 
 712         header(&quot;RFC2396: Normal relative-URI examples (appendix C)&quot;);
 713 
 714         URI base = (test(&quot;http://a/b/c/d;p?q&quot;)
 715                     .s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/d;p&quot;).q(&quot;q&quot;).z().uri());
 716 
 717         // g:h       g:h
 718         test(&quot;g:h&quot;)
 719             .s(&quot;g&quot;).o(&quot;h&quot;).z()
 720             .rslv(base).s(&quot;g&quot;).o(&quot;h&quot;).z();
 721 
 722         // g         http://a/b/c/g
 723         test(&quot;g&quot;)
 724             .p(&quot;g&quot;).z()
 725             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).z();
 726 
 727         // ./g       http://a/b/c/g
 728         test(&quot;./g&quot;)
 729             .p(&quot;./g&quot;).z()
 730             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).z();
 731 
 732         // g/        http://a/b/c/g/
 733         test(&quot;g/&quot;)
 734             .p(&quot;g/&quot;).z()
 735             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g/&quot;).z();
 736 
 737         // /g        http://a/g
 738         test(&quot;/g&quot;)
 739             .p(&quot;/g&quot;).z()
 740             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/g&quot;).z();
 741 
 742         // //g       http://g
 743         test(&quot;//g&quot;)
 744             .h(&quot;g&quot;).p(&quot;&quot;).z()
 745             .rslv(base).s(&quot;http&quot;).h(&quot;g&quot;).p(&quot;&quot;).z();
 746 
 747         // ?y        http://a/b/c/?y
 748         test(&quot;?y&quot;)
 749             .p(&quot;&quot;).q(&quot;y&quot;).z()
 750             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/&quot;).q(&quot;y&quot;).z();
 751 
 752         // g?y       http://a/b/c/g?y
 753         test(&quot;g?y&quot;)
 754             .p(&quot;g&quot;).q(&quot;y&quot;).z()
 755             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).q(&quot;y&quot;).z();
 756 
 757         // #s        (current document)#s
 758         // DEVIATION: Lone fragment parses as relative URI with empty path
 759         test(&quot;#s&quot;)
 760             .p(&quot;&quot;).f(&quot;s&quot;).z()
 761             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/d;p&quot;).f(&quot;s&quot;).q(&quot;q&quot;).z();
 762 
 763         // g#s       http://a/b/c/g#s
 764         test(&quot;g#s&quot;)
 765             .p(&quot;g&quot;).f(&quot;s&quot;).z()
 766             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).f(&quot;s&quot;).z();
 767 
 768         // g?y#s     http://a/b/c/g?y#s
 769         test(&quot;g?y#s&quot;)
 770             .p(&quot;g&quot;).q(&quot;y&quot;).f(&quot;s&quot;).z()
 771             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).q(&quot;y&quot;).f(&quot;s&quot;).z();
 772 
 773         // ;x        http://a/b/c/;x
 774         test(&quot;;x&quot;)
 775             .p(&quot;;x&quot;).z()
 776             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/;x&quot;).z();
 777 
 778         // g;x       http://a/b/c/g;x
 779         test(&quot;g;x&quot;)
 780             .p(&quot;g;x&quot;).z()
 781             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g;x&quot;).z();
 782 
 783         // g;x?y#s   http://a/b/c/g;x?y#s
 784         test(&quot;g;x?y#s&quot;)
 785             .p(&quot;g;x&quot;).q(&quot;y&quot;).f(&quot;s&quot;).z()
 786             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g;x&quot;).q(&quot;y&quot;).f(&quot;s&quot;).z();
 787 
 788         // .         http://a/b/c/
 789         test(&quot;.&quot;)
 790             .p(&quot;.&quot;).z()
 791             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/&quot;).z();
 792 
 793         // ./        http://a/b/c/
 794         test(&quot;./&quot;)
 795             .p(&quot;./&quot;).z()
 796             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/&quot;).z();
 797 
 798         // ..        http://a/b/
 799         test(&quot;..&quot;)
 800             .p(&quot;..&quot;).z()
 801             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/&quot;).z();
 802 
 803         // ../       http://a/b/
 804         test(&quot;../&quot;)
 805             .p(&quot;../&quot;).z()
 806             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/&quot;).z();
 807 
 808         // ../g      http://a/b/g
 809         test(&quot;../g&quot;)
 810             .p(&quot;../g&quot;).z()
 811             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/g&quot;).z();
 812 
 813         // ../..     http://a/
 814         test(&quot;../..&quot;)
 815             .p(&quot;../..&quot;).z()
 816             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/&quot;).z();
 817 
 818         // ../../    http://a/
 819         test(&quot;../../&quot;)
 820             .p(&quot;../../&quot;).z()
 821             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/&quot;).z();
 822 
 823         // ../../g   http://a/g
 824         test(&quot;../../g&quot;)
 825             .p(&quot;../../g&quot;).z()
 826             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/g&quot;).z();
 827 
 828 
 829         header(&quot;RFC2396: Abnormal relative-URI examples (appendix C)&quot;);
 830 
 831         // ../../../g    =  http://a/../g
 832         test(&quot;../../../g&quot;)
 833             .p(&quot;../../../g&quot;).z()
 834             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/../g&quot;).z();
 835 
 836         // ../../../../g =  http://a/../../g
 837         test(&quot;../../../../g&quot;)
 838             .p(&quot;../../../../g&quot;).z()
 839             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/../../g&quot;).z();
 840 
 841 
 842         // /./g          =  http://a/./g
 843         test(&quot;/./g&quot;)
 844             .p(&quot;/./g&quot;).z()
 845             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/./g&quot;).z();
 846 
 847         // /../g         =  http://a/../g
 848         test(&quot;/../g&quot;)
 849             .p(&quot;/../g&quot;).z()
 850             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/../g&quot;).z();
 851 
 852         // g.            =  http://a/b/c/g.
 853         test(&quot;g.&quot;)
 854             .p(&quot;g.&quot;).z()
 855             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g.&quot;).z();
 856 
 857         // .g            =  http://a/b/c/.g
 858         test(&quot;.g&quot;)
 859             .p(&quot;.g&quot;).z()
 860             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/.g&quot;).z();
 861 
 862         // g..           =  http://a/b/c/g..
 863         test(&quot;g..&quot;)
 864             .p(&quot;g..&quot;).z()
 865             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g..&quot;).z();
 866 
 867         // ..g           =  http://a/b/c/..g
 868         test(&quot;..g&quot;)
 869             .p(&quot;..g&quot;).z()
 870             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/..g&quot;).z();
 871 
 872         // ./../g        =  http://a/b/g
 873         test(&quot;./../g&quot;)
 874             .p(&quot;./../g&quot;).z()
 875             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/g&quot;).z();
 876 
 877         // ./g/.         =  http://a/b/c/g/
 878         test(&quot;./g/.&quot;)
 879             .p(&quot;./g/.&quot;).z()
 880             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g/&quot;).z();
 881 
 882         // g/./h         =  http://a/b/c/g/h
 883         test(&quot;g/./h&quot;)
 884             .p(&quot;g/./h&quot;).z()
 885             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g/h&quot;).z();
 886 
 887         // g/../h        =  http://a/b/c/h
 888         test(&quot;g/../h&quot;)
 889             .p(&quot;g/../h&quot;).z()
 890             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/h&quot;).z();
 891 
 892         // g;x=1/./y     =  http://a/b/c/g;x=1/y
 893         test(&quot;g;x=1/./y&quot;)
 894             .p(&quot;g;x=1/./y&quot;).z()
 895             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g;x=1/y&quot;).z();
 896 
 897         // g;x=1/../y    =  http://a/b/c/y
 898         test(&quot;g;x=1/../y&quot;)
 899             .p(&quot;g;x=1/../y&quot;).z()
 900             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/y&quot;).z();
 901 
 902         // g?y/./x       =  http://a/b/c/g?y/./x
 903         test(&quot;g?y/./x&quot;)
 904             .p(&quot;g&quot;).q(&quot;y/./x&quot;).z()
 905             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).q(&quot;y/./x&quot;).z();
 906 
 907         // g?y/../x      =  http://a/b/c/g?y/../x
 908         test(&quot;g?y/../x&quot;)
 909             .p(&quot;g&quot;).q(&quot;y/../x&quot;).z()
 910             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).q(&quot;y/../x&quot;).z();
 911 
 912         // g#s/./x       =  http://a/b/c/g#s/./x
 913         test(&quot;g#s/./x&quot;)
 914             .p(&quot;g&quot;).f(&quot;s/./x&quot;).z()
 915             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).f(&quot;s/./x&quot;).z();
 916 
 917         // g#s/../x      =  http://a/b/c/g#s/../x
 918         test(&quot;g#s/../x&quot;)
 919             .p(&quot;g&quot;).f(&quot;s/../x&quot;).z()
 920             .rslv(base).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/c/g&quot;).f(&quot;s/../x&quot;).z();
 921 
 922         // http:g        =  http:g
 923         test(&quot;http:g&quot;)
 924             .s(&quot;http&quot;).o(&quot;g&quot;).z()
 925             .rslv(base).s(&quot;http&quot;).o(&quot;g&quot;).z();
 926 
 927     }
 928 
 929 
 930     static void ip() {
 931 
 932         header(&quot;IP addresses&quot;);
 933 
 934         test(&quot;http://1.2.3.4:5&quot;)
 935             .s(&quot;http&quot;).h(&quot;1.2.3.4&quot;).n(5).p(&quot;&quot;).z();
 936 
 937         // From RFC2732
 938 
 939         test(&quot;http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/index.html&quot;)
 940             .s(&quot;http&quot;).h(&quot;[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]&quot;)
 941             .n(80).p(&quot;/index.html&quot;).z();
 942 
 943         test(&quot;http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:10%12]:80/index.html&quot;)
 944             .s(&quot;http&quot;).h(&quot;[FEDC:BA98:7654:3210:FEDC:BA98:7654:10%12]&quot;)
 945             .n(80).p(&quot;/index.html&quot;).z();
 946 
 947         test(&quot;http://[1080:0:0:0:8:800:200C:417A]/index.html&quot;)
 948             .s(&quot;http&quot;).h(&quot;[1080:0:0:0:8:800:200C:417A]&quot;).p(&quot;/index.html&quot;).z();
 949 
 950         test(&quot;http://[1080:0:0:0:8:800:200C:417A%1]/index.html&quot;)
 951             .s(&quot;http&quot;).h(&quot;[1080:0:0:0:8:800:200C:417A%1]&quot;).p(&quot;/index.html&quot;).z();
 952 
 953         test(&quot;http://[3ffe:2a00:100:7031::1]&quot;)
 954             .s(&quot;http&quot;).h(&quot;[3ffe:2a00:100:7031::1]&quot;).p(&quot;&quot;).z();
 955 
 956         test(&quot;http://[1080::8:800:200C:417A]/foo&quot;)
 957             .s(&quot;http&quot;).h(&quot;[1080::8:800:200C:417A]&quot;).p(&quot;/foo&quot;).z();
 958 
 959         test(&quot;http://[::192.9.5.5]/ipng&quot;)
 960             .s(&quot;http&quot;).h(&quot;[::192.9.5.5]&quot;).p(&quot;/ipng&quot;).z();
 961 
 962         test(&quot;http://[::192.9.5.5%interface]/ipng&quot;)
 963             .s(&quot;http&quot;).h(&quot;[::192.9.5.5%interface]&quot;).p(&quot;/ipng&quot;).z();
 964 
 965         test(&quot;http://[::FFFF:129.144.52.38]:80/index.html&quot;)
 966             .s(&quot;http&quot;).h(&quot;[::FFFF:129.144.52.38]&quot;).n(80).p(&quot;/index.html&quot;).z();
 967 
 968         test(&quot;http://[2010:836B:4179::836B:4179]&quot;)
 969             .s(&quot;http&quot;).h(&quot;[2010:836B:4179::836B:4179]&quot;).p(&quot;&quot;).z();
 970 
 971         // From RFC2373
 972 
 973         test(&quot;http://[FF01::101]&quot;)
 974             .s(&quot;http&quot;).h(&quot;[FF01::101]&quot;).p(&quot;&quot;).z();
 975 
 976         test(&quot;http://[::1]&quot;)
 977             .s(&quot;http&quot;).h(&quot;[::1]&quot;).p(&quot;&quot;).z();
 978 
 979         test(&quot;http://[::]&quot;)
 980             .s(&quot;http&quot;).h(&quot;[::]&quot;).p(&quot;&quot;).z();
 981 
 982         test(&quot;http://[::%hme0]&quot;)
 983             .s(&quot;http&quot;).h(&quot;[::%hme0]&quot;).p(&quot;&quot;).z();
 984 
 985         test(&quot;http://[0:0:0:0:0:0:13.1.68.3]&quot;)
 986             .s(&quot;http&quot;).h(&quot;[0:0:0:0:0:0:13.1.68.3]&quot;).p(&quot;&quot;).z();
 987 
 988         test(&quot;http://[0:0:0:0:0:FFFF:129.144.52.38]&quot;)
 989             .s(&quot;http&quot;).h(&quot;[0:0:0:0:0:FFFF:129.144.52.38]&quot;).p(&quot;&quot;).z();
 990 
 991         test(&quot;http://[0:0:0:0:0:FFFF:129.144.52.38%33]&quot;)
 992             .s(&quot;http&quot;).h(&quot;[0:0:0:0:0:FFFF:129.144.52.38%33]&quot;).p(&quot;&quot;).z();
 993 
 994         test(&quot;http://[0:0:0:0:0:ffff:1.2.3.4]&quot;)
 995             .s(&quot;http&quot;).h(&quot;[0:0:0:0:0:ffff:1.2.3.4]&quot;).p(&quot;&quot;).z();
 996 
 997         test(&quot;http://[::13.1.68.3]&quot;)
 998             .s(&quot;http&quot;).h(&quot;[::13.1.68.3]&quot;).p(&quot;&quot;).z();
 999 
1000         // Optional IPv6 brackets in constructors
1001 
1002         test(&quot;s&quot;, null, &quot;1:2:3:4:5:6:7:8&quot;, -1, null, null, null)
1003             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1004 
1005         test(&quot;s&quot;, null, &quot;[1:2:3:4:5:6:7:8]&quot;, -1, null, null, null)
1006             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1007 
1008         test(&quot;s&quot;, null, &quot;[1:2:3:4:5:6:7:8]&quot;, -1, null, null, null)
1009             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1010 
1011         test(&quot;s&quot;, &quot;1:2:3:4:5:6:7:8&quot;, null, null)
1012             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1013 
1014         test(&quot;s&quot;, &quot;1:2:3:4:5:6:7:8%hme0&quot;, null, null)
1015             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8%hme0]&quot;).p(&quot;&quot;).z();
1016 
1017         test(&quot;s&quot;, &quot;1:2:3:4:5:6:7:8%1&quot;, null, null)
1018             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8%1]&quot;).p(&quot;&quot;).z();
1019 
1020         test(&quot;s&quot;, &quot;[1:2:3:4:5:6:7:8]&quot;, null, null)
1021             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1022 
1023         test(&quot;s&quot;, &quot;[1:2:3:4:5:6:7:8]&quot;, null, null, null)
1024             .s(&quot;s&quot;).h(&quot;[1:2:3:4:5:6:7:8]&quot;).p(&quot;&quot;).z();
1025 
1026         test(&quot;s&quot;, &quot;1:2:3:4:5:6:7:8&quot;, null, null, null)
1027             .s(&quot;s&quot;).g(&quot;1:2:3:4:5:6:7:8&quot;).p(&quot;&quot;).z();
1028 
1029         // Error cases
1030 
1031         test(&quot;http://[ff01:234/foo&quot;).x().z();
1032         test(&quot;http://[ff01:234:zzz]/foo&quot;).x().z();
1033         test(&quot;http://[foo]&quot;).x().z();
1034         test(&quot;http://[]&quot;).x().z();
1035         test(&quot;http://[129.33.44.55]&quot;).x().z();
1036         test(&quot;http://[ff:ee:dd:cc:bb::aa:9:8]&quot;).x().z();
1037         test(&quot;http://[fffff::1]&quot;).x().z();
1038         test(&quot;http://[ff::ee::8]&quot;).x().z();
1039         test(&quot;http://[1:2:3:4::5:6:7:8]&quot;).x().z();
1040         test(&quot;http://[1:2]&quot;).x().z();
1041         test(&quot;http://[1:2:3:4:5:6:7:8:9]&quot;).x().z();
1042         test(&quot;http://[1:2:3:4:5:6:7:8%]&quot;).x().z();
1043         test(&quot;http://[1:2:3:4:5:6:7:8%!/]&quot;).x().z();
1044         test(&quot;http://[::1.2.3.300]&quot;).x().z();
1045         test(&quot;http://1.2.3&quot;).psa().x().z();
1046         test(&quot;http://1.2.3.300&quot;).psa().x().z();
1047         test(&quot;http://1.2.3.4.5&quot;).psa().x().z();
1048         test(&quot;http://[1.2.3.4:5]&quot;).x().z();
1049         test(&quot;http://1:2:3:4:5:6:7:8&quot;).psa().x().z();
1050         test(&quot;http://[1.2.3.4]/&quot;).x().z();
1051         test(&quot;http://[1.2.3.4/&quot;).x().z();
1052         test(&quot;http://[foo]/&quot;).x().z();
1053         test(&quot;http://[foo/&quot;).x().z();
1054         test(&quot;s&quot;, &quot;[foo]&quot;, &quot;/&quot;, null, null).x().z();
1055         test(&quot;s&quot;, &quot;[foo&quot;, &quot;/&quot;, null, null).x().z();
1056         test(&quot;s&quot;, &quot;[::foo&quot;, &quot;/&quot;, null, null).x().z();
1057 
1058         // Test hostnames that might initially look like IPv4 addresses
1059 
1060         test(&quot;s://1.2.3.com&quot;).psa().s(&quot;s&quot;).h(&quot;1.2.3.com&quot;).p(&quot;&quot;).z();
1061         test(&quot;s://1.2.3.4me.com&quot;).psa().s(&quot;s&quot;).h(&quot;1.2.3.4me.com&quot;).p(&quot;&quot;).z();
1062 
1063         test(&quot;s://7up.com&quot;).psa().s(&quot;s&quot;).h(&quot;7up.com&quot;).p(&quot;&quot;).z();
1064         test(&quot;s://7up.com/p&quot;).psa().s(&quot;s&quot;).h(&quot;7up.com&quot;).p(&quot;/p&quot;).z();
1065         test(&quot;s://7up&quot;).psa().s(&quot;s&quot;).h(&quot;7up&quot;).p(&quot;&quot;).z();
1066         test(&quot;s://7up/p&quot;).psa().s(&quot;s&quot;).h(&quot;7up&quot;).p(&quot;/p&quot;).z();
1067         test(&quot;s://7up.&quot;).psa().s(&quot;s&quot;).h(&quot;7up.&quot;).p(&quot;&quot;).z();
1068         test(&quot;s://7up./p&quot;).psa().s(&quot;s&quot;).h(&quot;7up.&quot;).p(&quot;/p&quot;).z();
1069     }
1070 
1071 
1072     static void misc() throws URISyntaxException {
1073 
1074         URI base = new URI(&quot;s://h/a/b&quot;);
1075         URI rbase = new URI(&quot;a/b/c/d&quot;);
1076 
1077 
1078         header(&quot;Corner cases&quot;);
1079 
1080         // The empty URI parses as a relative URI with an empty path
1081         test(&quot;&quot;).p(&quot;&quot;).z()
1082             .rslv(base).s(&quot;s&quot;).h(&quot;h&quot;).p(&quot;/a/&quot;).z();
1083 
1084         // Resolving solo queries and fragments
1085         test(&quot;#f&quot;).p(&quot;&quot;).f(&quot;f&quot;).z()
1086             .rslv(base).s(&quot;s&quot;).h(&quot;h&quot;).p(&quot;/a/b&quot;).f(&quot;f&quot;).z();
1087         test(&quot;?q&quot;).p(&quot;&quot;).q(&quot;q&quot;).z()
1088             .rslv(base).s(&quot;s&quot;).h(&quot;h&quot;).p(&quot;/a/&quot;).q(&quot;q&quot;).z();
1089 
1090         // Fragment is not part of ssp
1091         test(&quot;p#f&quot;).p(&quot;p&quot;).f(&quot;f&quot;).sp(&quot;p&quot;).z();
1092         test(&quot;s:p#f&quot;).s(&quot;s&quot;).o(&quot;p&quot;).f(&quot;f&quot;).z();
1093         test(&quot;p#f&quot;)
1094             .rslv(base).s(&quot;s&quot;).h(&quot;h&quot;).p(&quot;/a/p&quot;).f(&quot;f&quot;).sp(&quot;//h/a/p&quot;).z();
1095         test(&quot;&quot;).p(&quot;&quot;).sp(&quot;&quot;).z();
1096 
1097 
1098 
1099         header(&quot;Emptiness&quot;);
1100 
1101         // Components that may be empty
1102         test(&quot;///p&quot;).p(&quot;/p&quot;).z();                 // Authority (w/ path)
1103         test(&quot;//@h/p&quot;).u(&quot;&quot;).h(&quot;h&quot;).p(&quot;/p&quot;).z();  // User info
1104         test(&quot;//h:/p&quot;).h(&quot;h&quot;).p(&quot;/p&quot;).z();        // Port
1105         test(&quot;//h&quot;).h(&quot;h&quot;).p(&quot;&quot;).z();             // Path
1106         test(&quot;//h?q&quot;).h(&quot;h&quot;).p(&quot;&quot;).q(&quot;q&quot;).z();    // Path (w/query)
1107         test(&quot;//?q&quot;).p(&quot;&quot;).q(&quot;q&quot;).z();            // Authority (w/query)
1108         test(&quot;//#f&quot;).p(&quot;&quot;).f(&quot;f&quot;).z();            // Authority (w/fragment)
1109         test(&quot;p?#&quot;).p(&quot;p&quot;).q(&quot;&quot;).f(&quot;&quot;).z();       // Query &amp; fragment
1110 
1111         // Components that may not be empty
1112         test(&quot;:&quot;).x().z();              // Scheme
1113         test(&quot;x:&quot;).x().z();             // Hier/opaque
1114         test(&quot;//&quot;).x().z();             // Authority (w/o path)
1115 
1116 
1117         header(&quot;Resolution, normalization, and relativization&quot;);
1118 
1119         // Resolving relative paths
1120         test(&quot;../e/f&quot;).p(&quot;../e/f&quot;).z()
1121             .rslv(rbase).p(&quot;a/b/e/f&quot;).z();
1122         test(&quot;../../../../d&quot;).p(&quot;../../../../d&quot;).z()
1123             .rslv(rbase).p(&quot;../d&quot;).z();
1124         test(&quot;../../../d:e&quot;).p(&quot;../../../d:e&quot;).z()
1125             .rslv(rbase).p(&quot;./d:e&quot;).z();
1126         test(&quot;../../../d:e/f&quot;).p(&quot;../../../d:e/f&quot;).z()
1127             .rslv(rbase).p(&quot;./d:e/f&quot;).z();
1128 
1129         // Normalization
1130         test(&quot;a/./c/../d/f&quot;).p(&quot;a/./c/../d/f&quot;).z()
1131             .norm().p(&quot;a/d/f&quot;).z();
1132         test(&quot;http://a/./b/c/../d?q#f&quot;)
1133             .s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/./b/c/../d&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z()
1134             .norm().s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/d&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z();
1135         test(&quot;a/../b&quot;).p(&quot;a/../b&quot;).z().
1136             norm().p(&quot;b&quot;);
1137         test(&quot;a/../b:c&quot;).p(&quot;a/../b:c&quot;).z()
1138             .norm().p(&quot;./b:c&quot;).z();
1139 
1140         // Normalization of already normalized URI should yield the
1141         // same URI
1142         URI u1 = URI.create(&quot;s://h/../p&quot;);
1143         URI u2 = u1.normalize();
1144         eq(u1, u2);
1145         eqeq(u1, u2);
1146 
1147         // Relativization
1148         test(&quot;/a/b&quot;).p(&quot;/a/b&quot;).z()
1149             .rtvz(new URI(&quot;/a&quot;)).p(&quot;b&quot;).z();
1150         test(&quot;/a/b&quot;).p(&quot;/a/b&quot;).z()
1151             .rtvz(new URI(&quot;/a/&quot;)).p(&quot;b&quot;).z();
1152         test(&quot;a/b&quot;).p(&quot;a/b&quot;).z()
1153             .rtvz(new URI(&quot;a&quot;)).p(&quot;b&quot;).z();
1154         test(&quot;/a/b&quot;).p(&quot;/a/b&quot;).z()
1155             .rtvz(new URI(&quot;/a/b&quot;)).p(&quot;&quot;).z();   // Result is empty path
1156         test(&quot;a/../b:c/d&quot;).p(&quot;a/../b:c/d&quot;).z()
1157             .rtvz(new URI(&quot;./b:c/&quot;)).p(&quot;d&quot;).z();
1158 
1159         test(&quot;http://a/b/d/e?q#f&quot;)
1160             .s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/b/d/e&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z()
1161             .rtvz(new URI(&quot;http://a/b/?r#g&quot;))
1162             .p(&quot;d/e&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z();
1163 
1164         // parseServerAuthority
1165         test(&quot;/a/b&quot;).psa().p(&quot;/a/b&quot;).z();
1166         test(&quot;s://u@h:1/p&quot;)
1167             .psa().s(&quot;s&quot;).u(&quot;u&quot;).h(&quot;h&quot;).n(1).p(&quot;/p&quot;).z();
1168         test(&quot;s://u@h:-foo/p&quot;).s(&quot;s&quot;).g(&quot;u@h:-foo&quot;).p(&quot;/p&quot;).z()
1169             .psa().x().z();
1170         test(&quot;s://h:999999999999999999999999&quot;).psa().x().z();
1171         test(&quot;s://:/b&quot;).psa().x().z();
1172 
1173 
1174         header(&quot;Constructors and factories&quot;);
1175 
1176         test(&quot;s&quot;, null, null, -1, &quot;p&quot;, null, null).x().z();
1177         test(null, null, null, -1, null, null, null).p(&quot;&quot;).z();
1178         test(null, null, null, -1, &quot;p&quot;, null, null).p(&quot;p&quot;).z();
1179         test(null, null, &quot;foo%20bar&quot;, -1, null, null, null).x().z();
1180         test(null, null, &quot;foo&quot;, -100, null, null, null).x().z();
1181         test(&quot;s&quot;, null, null, -1, &quot;&quot;, null, null).x().z();
1182         test(&quot;s&quot;, null, null, -1, &quot;/p&quot;, null, null).s(&quot;s&quot;).p(&quot;/p&quot;).z();
1183         test(&quot;s&quot;, &quot;u&quot;, &quot;h&quot;, 10, &quot;/p&quot;, &quot;q&quot;, &quot;f&quot;)
1184             .s(&quot;s&quot;).u(&quot;u&quot;).h(&quot;h&quot;).n(10).p(&quot;/p&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z();
1185         test(&quot;s&quot;, &quot;a:b&quot;, &quot;/p&quot;, &quot;q&quot;, &quot;f&quot;)
1186             .s(&quot;s&quot;).g(&quot;a:b&quot;).p(&quot;/p&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z();
1187         test(&quot;s&quot;, &quot;h&quot;, &quot;/p&quot;, &quot;f&quot;)
1188             .s(&quot;s&quot;).h(&quot;h&quot;).p(&quot;/p&quot;).f(&quot;f&quot;).z();
1189         test(&quot;s&quot;, &quot;p&quot;, &quot;f&quot;).s(&quot;s&quot;).o(&quot;p&quot;).f(&quot;f&quot;).z();
1190         test(&quot;s&quot;, &quot;/p&quot;, &quot;f&quot;).s(&quot;s&quot;).p(&quot;/p&quot;).f(&quot;f&quot;).z();
1191         testCreate(&quot;s://u@h/p?q#f&quot;)
1192             .s(&quot;s&quot;).u(&quot;u&quot;).h(&quot;h&quot;).p(&quot;/p&quot;).q(&quot;q&quot;).f(&quot;f&quot;).z();
1193     }
1194 
1195     static void npes() throws URISyntaxException {
1196 
1197         header(&quot;NullPointerException&quot;);
1198 
1199         URI base = URI.create(&quot;mailto:root@foobar.com&quot;);
1200 
1201         out.println();
1202 
1203         try {
1204             base.resolve((URI)null);
1205             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
1206         } catch (NullPointerException x) {
1207             out.println(&quot;resolve((URI)null) --&gt;&quot;);
1208             out.println(&quot;Correct exception: &quot; + x);
1209         }
1210 
1211         out.println();
1212 
1213         try {
1214             base.resolve((String)null);
1215             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
1216         } catch (NullPointerException x) {
1217             out.println(&quot;resolve((String)null) --&gt;&quot;);
1218             out.println(&quot;Correct exception: &quot; + x);
1219         }
1220 
1221         out.println();
1222 
1223         try {
1224             base.relativize((URI)null);
1225             throw new RuntimeException(&quot;NullPointerException not thrown&quot;);
1226         } catch (NullPointerException x) {
1227             out.println(&quot;relativize((String)null) --&gt;&quot;);
1228             out.println(&quot;Correct exception: &quot; + x);
1229         }
1230 
1231         testCount += 3;
1232     }
1233 
1234 
1235     static void chars() throws URISyntaxException {
1236 
1237         header(&quot;Escapes and non-US-ASCII characters&quot;);
1238 
1239         URI uri;
1240 
1241         // Escape pairs
1242         test(&quot;%0a%0A%0f%0F%01%09zz&quot;)
1243             .p(&quot;%0a%0A%0f%0F%01%09zz&quot;).z();
1244         test(&quot;foo%1&quot;).x().z();
1245         test(&quot;foo%z&quot;).x().z();
1246         test(&quot;foo%9z&quot;).x().z();
1247 
1248         // Escapes not permitted in scheme, host
1249         test(&quot;s%20t://a&quot;).x().z();
1250         test(&quot;//a%20b&quot;).g(&quot;a%20b&quot;).p(&quot;&quot;).z();         // Parses as registry
1251 
1252         // Escapes permitted in opaque part, userInfo, registry, path,
1253         // query, and fragment
1254         test(&quot;//u%20v@a&quot;).u(&quot;u%20v&quot;).h(&quot;a&quot;).p(&quot;&quot;).z();
1255         test(&quot;/p%20q&quot;).p(&quot;/p%20q&quot;).z();
1256         test(&quot;/p?q%20&quot;).p(&quot;/p&quot;).q(&quot;q%20&quot;).z();
1257         test(&quot;/p#%20f&quot;).p(&quot;/p&quot;).f(&quot;%20f&quot;).z();
1258 
1259         // Non-US-ASCII chars
1260         test(&quot;s\u00a7t://a&quot;).x().z();
1261         test(&quot;//\u00a7/b&quot;).g(&quot;\u00a7&quot;).p(&quot;/b&quot;).z();     // Parses as registry
1262         test(&quot;//u\u00a7v@a&quot;).u(&quot;u\u00a7v&quot;).h(&quot;a&quot;).p(&quot;&quot;).z();
1263         test(&quot;/p\u00a7q&quot;).p(&quot;/p\u00a7q&quot;).z();
1264         test(&quot;/p?q\u00a7&quot;).p(&quot;/p&quot;).q(&quot;q\u00a7&quot;).z();
1265         test(&quot;/p#\u00a7f&quot;).p(&quot;/p&quot;).f(&quot;\u00a7f&quot;).z();
1266 
1267         // 4648111 - Escapes quoted by toString after resolution
1268         uri = new URI(&quot;http://a/b/c/d;p?q&quot;);
1269         test(&quot;/p%20p&quot;)
1270             .rslv(uri).s(&quot;http&quot;).h(&quot;a&quot;).p(&quot;/p%20p&quot;).ts(&quot;http://a/p%20p&quot;).z();
1271 
1272         // 4464135: Forbid unwise characters throughout opaque part
1273         test(&quot;foo:x{bar&quot;).x().z();
1274         test(&quot;foo:{bar&quot;).x().z();
1275 
1276         // 4438319: Single-argument constructor requires quotation,
1277         //          preserves escapes
1278         test(&quot;//u%01@h/a/b/%02/c?q%03#f%04&quot;)
1279             .u(&quot;u%01&quot;).ud(&quot;u\1&quot;)
1280             .h(&quot;h&quot;)
1281             .p(&quot;/a/b/%02/c&quot;).pd(&quot;/a/b/\2/c&quot;)
1282             .q(&quot;q%03&quot;).qd(&quot;q\3&quot;)
1283             .f(&quot;f%04&quot;).fd(&quot;f\4&quot;)
1284             .z();
1285         test(&quot;/a/b c&quot;).x().z();
1286 
1287         // 4438319: Multi-argument constructors quote illegal chars and
1288         //          preserve legal non-ASCII chars
1289         // \uA001-\uA009 are visible characters, \u2000 is a space character
1290         test(null, &quot;u\uA001\1&quot;, &quot;h&quot;, -1,
1291              &quot;/p% \uA002\2\u2000&quot;,
1292              &quot;q% \uA003\3\u2000&quot;,
1293              &quot;f% \uA004\4\u2000&quot;)
1294             .u(&quot;u\uA001%01&quot;).h(&quot;h&quot;)
1295             .p(&quot;/p%25%20\uA002%02%E2%80%80&quot;).pd(&quot;/p% \uA002\2\u2000&quot;)
1296             .q(&quot;q%25%20\uA003%03%E2%80%80&quot;).qd(&quot;q% \uA003\3\u2000&quot;)
1297             .f(&quot;f%25%20\uA004%04%E2%80%80&quot;).fd(&quot;f% \uA004\4\u2000&quot;).z();
1298         test(null, &quot;g\uA001\1&quot;,
1299              &quot;/p% \uA002\2\u2000&quot;,
1300              &quot;q% \uA003\3\u2000&quot;,
1301              &quot;f% \uA004\4\u2000&quot;)
1302             .g(&quot;g\uA001%01&quot;)
1303             .p(&quot;/p%25%20\uA002%02%E2%80%80&quot;).pd(&quot;/p% \uA002\2\u2000&quot;)
1304             .q(&quot;q%25%20\uA003%03%E2%80%80&quot;).qd(&quot;q% \uA003\3\u2000&quot;)
1305             .f(&quot;f%25%20\uA004%04%E2%80%80&quot;).fd(&quot;f% \uA004\4\u2000&quot;).z();
1306         test(null, null, &quot;/p% \uA002\2\u2000&quot;, &quot;f% \uA004\4\u2000&quot;)
1307             .p(&quot;/p%25%20\uA002%02%E2%80%80&quot;).pd(&quot;/p% \uA002\2\u2000&quot;)
1308             .f(&quot;f%25%20\uA004%04%E2%80%80&quot;).fd(&quot;f% \uA004\4\u2000&quot;).z();
1309         test(null, &quot;/sp% \uA001\1\u2000&quot;, &quot;f% \uA004\4\u2000&quot;)
1310             .sp(&quot;/sp%25%20\uA001%01%E2%80%80&quot;).spd(&quot;/sp% \uA001\1\u2000&quot;)
1311             .p(&quot;/sp%25%20\uA001%01%E2%80%80&quot;).pd(&quot;/sp% \uA001\1\u2000&quot;)
1312             .f(&quot;f%25%20\uA004%04%E2%80%80&quot;).fd(&quot;f% \uA004\4\u2000&quot;).z();
1313 
1314         // 4438319: Non-raw accessors decode all escaped octets
1315         test(&quot;/%25%20%E2%82%AC%E2%80%80&quot;)
1316             .p(&quot;/%25%20%E2%82%AC%E2%80%80&quot;).pd(&quot;/% \u20Ac\u2000&quot;).z();
1317 
1318         // 4438319: toASCIIString
1319         test(&quot;/\uCAFE\uBABE&quot;)
1320             .p(&quot;/\uCAFE\uBABE&quot;).ta(&quot;/%EC%AB%BE%EB%AA%BE&quot;).z();
1321 
1322         // 4991359 and 4866303: bad quoting by defineSchemeSpecificPart()
1323         URI base = new URI (&quot;http://host/foo%20bar/a/b/c/d&quot;);
1324         test (&quot;resolve&quot;)
1325             .rslv(base).spd(&quot;//host/foo bar/a/b/c/resolve&quot;)
1326             .sp(&quot;//host/foo%20bar/a/b/c/resolve&quot;).s(&quot;http&quot;)
1327             .pd(&quot;/foo bar/a/b/c/resolve&quot;).h(&quot;host&quot;)
1328             .p(&quot;/foo%20bar/a/b/c/resolve&quot;).z();
1329 
1330         // 6773270: java.net.URI fails to escape u0000
1331         test(&quot;s&quot;, &quot;a&quot;, &quot;/\u0000&quot;, null)
1332             .s(&quot;s&quot;).p(&quot;/%00&quot;).h(&quot;a&quot;)
1333             .ta(&quot;s://a/%00&quot;).z();
1334     }
1335 
1336 
1337     static void eq0(URI u, URI v) throws URISyntaxException {
1338         testCount++;
1339         if (!u.equals(v))
1340             throw new RuntimeException(&quot;Not equal: &quot; + u + &quot; &quot; + v);
1341         int uh = u.hashCode();
1342         int vh = v.hashCode();
1343         if (uh != vh)
1344             throw new RuntimeException(&quot;Hash codes not equal: &quot;
1345                                        + u + &quot; &quot; + Integer.toHexString(uh) + &quot; &quot;
1346                                        + v + &quot; &quot; + Integer.toHexString(vh));
1347         out.println();
1348         out.println(u + &quot; == &quot; + v
1349                     + &quot;  [&quot; + Integer.toHexString(uh) + &quot;]&quot;);
1350     }
1351 
1352     static void cmp0(URI u, URI v, boolean same)
1353         throws URISyntaxException
1354     {
1355         int c = u.compareTo(v);
1356         if ((c == 0) != same)
1357             throw new RuntimeException(&quot;Comparison inconsistent: &quot; + u + &quot; &quot; + v
1358                                        + &quot; &quot; + c);
1359     }
1360 
1361     static void eq(URI u, URI v) throws URISyntaxException {
1362         eq0(u, v);
1363         cmp0(u, v, true);
1364     }
1365 
1366     static void eq(String expected, String actual) {
1367         if (expected == null &amp;&amp; actual == null) {
1368             return;
1369         }
1370         if (expected != null &amp;&amp; expected.equals(actual)) {
1371             return;
1372         }
1373         throw new AssertionError(String.format(
1374                 &quot;Strings are not equal: &#39;%s&#39;, &#39;%s&#39;&quot;, expected, actual));
1375     }
1376 
1377     static void eqeq(URI u, URI v) {
1378         testCount++;
1379         if (u != v)
1380             throw new RuntimeException(&quot;Not ==: &quot; + u + &quot; &quot; + v);
1381     }
1382 
1383     static void ne0(URI u, URI v) throws URISyntaxException {
1384         testCount++;
1385         if (u.equals(v))
1386             throw new RuntimeException(&quot;Equal: &quot; + u + &quot; &quot; + v);
1387         out.println();
1388         out.println(u + &quot; != &quot; + v
1389                     + &quot;  [&quot; + Integer.toHexString(u.hashCode())
1390                     + &quot; &quot; + Integer.toHexString(v.hashCode())
1391                     + &quot;]&quot;);
1392     }
1393 
1394     static void ne(URI u, URI v) throws URISyntaxException {
1395         ne0(u, v);
1396         cmp0(u, v, false);
1397     }
1398 
1399     static void lt(URI u, URI v) throws URISyntaxException {
1400         ne0(u, v);
1401         int c = u.compareTo(v);
1402         if (c &gt;= 0) {
1403             show(u);
1404             show(v);
1405             throw new RuntimeException(&quot;Not less than: &quot; + u + &quot; &quot; + v
1406                                        + &quot; &quot; + c);
1407         }
1408         out.println(u + &quot; &lt; &quot; + v);
1409     }
1410 
1411     static void lt(String s, String t) throws URISyntaxException {
1412         lt(new URI(s), new URI(t));
1413     }
1414 
<a name="2" id="anc2"></a><span class="line-modified">1415     static void gt0(URI u, URI v) throws URISyntaxException {</span>
<span class="line-added">1416         ne0(u, v);</span>
<span class="line-added">1417         int c = u.compareTo(v);</span>
<span class="line-added">1418         if (c &lt;= 0) {</span>
<span class="line-added">1419             show(u);</span>
<span class="line-added">1420             show(v);</span>
<span class="line-added">1421             throw new RuntimeException(&quot;Not greater than: &quot; + u + &quot; &quot; + v</span>
<span class="line-added">1422                     + &quot; &quot; + c);</span>
<span class="line-added">1423         }</span>
<span class="line-added">1424         out.println(u + &quot; &lt; &quot; + v);</span>
<span class="line-added">1425     }</span>
<span class="line-added">1426 </span>
<span class="line-added">1427     static void gt(URI u, URI v) throws URISyntaxException {</span>
1428         lt(v, u);
1429     }
1430 
1431     static void eqHashComp() throws URISyntaxException {
1432 
1433         header(&quot;Equality, hashing, and comparison&quot;);
1434 
1435         URI o = new URI(&quot;mailto:foo@bar.com&quot;);
1436         URI r = new URI(&quot;reg://some%20registry/b/c/d?q#f&quot;);
1437         URI s = new URI(&quot;http://jag:cafebabe@java.sun.com:94/b/c/d?q#f&quot;);
<a name="3" id="anc3"></a><span class="line-added">1438         URI t = new URI(&quot;http://example.com/%5bsegment%5d&quot;);</span>
1439         eq(o, o);
1440         lt(o, r);
1441         lt(s, o);
1442         lt(s, r);
<a name="4" id="anc4"></a><span class="line-added">1443 </span>
1444         eq(o, new URI(&quot;MaILto:foo@bar.com&quot;));
1445         gt(o, new URI(&quot;mailto:foo@bar.COM&quot;));
1446         eq(r, new URI(&quot;rEg://some%20registry/b/c/d?q#f&quot;));
1447         gt(r, new URI(&quot;reg://Some%20Registry/b/c/d?q#f&quot;));
1448         gt(r, new URI(&quot;reg://some%20registry/b/c/D?q#f&quot;));
1449         eq(s, new URI(&quot;hTtP://jag:cafebabe@Java.Sun.COM:94/b/c/d?q#f&quot;));
1450         gt(s, new URI(&quot;http://jag:CafeBabe@java.sun.com:94/b/c/d?q#f&quot;));
1451         lt(s, new URI(&quot;http://jag:cafebabe@java.sun.com:94/b/c/d?r#f&quot;));
1452         lt(s, new URI(&quot;http://jag:cafebabe@java.sun.com:94/b/c/d?q#g&quot;));
<a name="5" id="anc5"></a><span class="line-added">1453         cmp0(t, new URI(&quot;http://example.com/%5Bsegment%5D&quot;), true);</span>
<span class="line-added">1454         gt0(t, new URI(&quot;http://example.com/%5BSegment%5D&quot;));</span>
<span class="line-added">1455         lt(new URI(&quot;http://example.com/%5Asegment%5D&quot;), new URI(&quot;http://example.com/%5Bsegment%5D&quot;));</span>
1456         eq(new URI(&quot;http://host/a%00bcd&quot;), new URI(&quot;http://host/a%00bcd&quot;));
1457         ne(new URI(&quot;http://host/a%00bcd&quot;), new URI(&quot;http://host/aZ00bcd&quot;));
1458         eq0(new URI(&quot;http://host/abc%e2def%C3ghi&quot;),
1459             new URI(&quot;http://host/abc%E2def%c3ghi&quot;));
1460 
1461         lt(&quot;p&quot;, &quot;s:p&quot;);
1462         lt(&quot;s:p&quot;, &quot;T:p&quot;);
1463         lt(&quot;S:p&quot;, &quot;t:p&quot;);
1464         lt(&quot;s:/p&quot;, &quot;s:p&quot;);
1465         lt(&quot;s:p&quot;, &quot;s:q&quot;);
1466         lt(&quot;s:p#f&quot;, &quot;s:p#g&quot;);
1467         lt(&quot;s://u@h:1&quot;, &quot;s://v@h:1&quot;);
1468         lt(&quot;s://u@h:1&quot;, &quot;s://u@i:1&quot;);
1469         lt(&quot;s://u@h:1&quot;, &quot;s://v@h:2&quot;);
1470         lt(&quot;s://a%20b&quot;, &quot;s://a%20c&quot;);
1471         lt(&quot;s://a%20b&quot;, &quot;s://aab&quot;);
1472         lt(&quot;s://AA&quot;, &quot;s://A_&quot;);
1473         lt(&quot;s:/p&quot;, &quot;s:/q&quot;);
1474         lt(&quot;s:/p?q&quot;, &quot;s:/p?r&quot;);
1475         lt(&quot;s:/p#f&quot;, &quot;s:/p#g&quot;);
1476 
1477         lt(&quot;s://h&quot;, &quot;s://h/p&quot;);
1478         lt(&quot;s://h/p&quot;, &quot;s://h/p?q&quot;);
1479 
1480     }
1481 
1482 
1483     static void serial(URI u) throws IOException, URISyntaxException {
1484 
1485         ByteArrayOutputStream bo = new ByteArrayOutputStream();
1486         ObjectOutputStream oo = new ObjectOutputStream(bo);
1487 
1488         oo.writeObject(u);
1489         oo.close();
1490 
1491         ByteArrayInputStream bi = new ByteArrayInputStream(bo.toByteArray());
1492         ObjectInputStream oi = new ObjectInputStream(bi);
1493         try {
1494             Object o = oi.readObject();
1495             eq(u, (URI)o);
1496         } catch (ClassNotFoundException x) {
1497             x.printStackTrace();
1498             throw new RuntimeException(x.toString());
1499         }
1500 
1501         testCount++;
1502     }
1503 
1504     static void serial() throws IOException, URISyntaxException {
1505         header(&quot;Serialization&quot;);
1506 
1507         serial(URI.create(&quot;http://java.sun.com/jdk/1.4?release#beta&quot;));
1508         serial(URI.create(&quot;s://h/p&quot;).resolve(&quot;/long%20path/&quot;));
1509     }
1510 
1511 
1512     static void urls() throws URISyntaxException {
1513 
1514         header(&quot;URLs&quot;);
1515 
1516         URI uri;
1517         URL url;
1518         boolean caught = false;
1519 
1520         out.println();
1521         uri = new URI(&quot;http://a/p?q#f&quot;);
1522         try {
1523             url = uri.toURL();
1524         } catch (MalformedURLException x) {
1525             throw new RuntimeException(x.toString());
1526         }
1527         if (!url.toString().equals(&quot;http://a/p?q#f&quot;))
1528             throw new RuntimeException(&quot;Incorrect URL: &quot; + url);
1529         out.println(uri + &quot; url --&gt; &quot; + url);
1530 
1531         out.println();
1532         uri = new URI(&quot;a/b&quot;);
1533         try {
1534             out.println(uri + &quot; url --&gt; &quot;);
1535             url = uri.toURL();
1536         } catch (IllegalArgumentException x) {
1537             caught = true;
1538             out.println(&quot;Correct exception: &quot; + x);
1539         } catch (MalformedURLException x) {
1540             caught = true;
1541             throw new RuntimeException(&quot;Incorrect exception: &quot; + x);
1542         }
1543         if (!caught)
1544             throw new RuntimeException(&quot;Incorrect URL: &quot; + url);
1545 
1546         out.println();
1547         uri = new URI(&quot;foo://bar/baz&quot;);
1548         caught = false;
1549         try {
1550             out.println(uri + &quot; url --&gt; &quot;);
1551             url = uri.toURL();
1552         } catch (MalformedURLException x) {
1553             caught = true;
1554             out.println(&quot;Correct exception: &quot; + x);
1555         } catch (IllegalArgumentException x) {
1556             caught = true;
1557             throw new RuntimeException(&quot;Incorrect exception: &quot; + x);
1558         }
1559         if (!caught)
1560             throw new RuntimeException(&quot;Incorrect URL: &quot; + url);
1561 
1562         testCount += 3;
1563     }
1564 
1565 
1566     static void tests() throws IOException, URISyntaxException {
1567         rfc2396();
1568         ip();
1569         misc();
1570         chars();
1571         eqHashComp();
1572         serial();
1573         urls();
1574         npes();
1575         bugs();
1576     }
1577 
1578 
1579     // -- Command-line invocation --
1580 
1581     static void usage() {
1582         out.println(&quot;Usage:&quot;);
1583         out.println(&quot;  java Test               --  Runs all tests in this file&quot;);
1584         out.println(&quot;  java Test &lt;uri&gt;         --  Parses uri, shows components&quot;);
1585         out.println(&quot;  java Test &lt;base&gt; &lt;uri&gt;  --  Parses uri and base, then resolves&quot;);
1586         out.println(&quot;                              uri against base&quot;);
1587     }
1588 
1589     static void clargs(String base, String uri) {
1590         URI b = null, u;
1591         try {
1592             if (base != null) {
1593                 b = new URI(base);
1594                 out.println(base);
1595                 show(b);
1596             }
1597             u = new URI(uri);
1598             out.println(uri);
1599             show(u);
1600             if (base != null) {
1601                 URI r = b.resolve(u);
1602                 out.println(r);
1603                 show(r);
1604             }
1605         } catch (URISyntaxException x) {
1606             show(&quot;ERROR&quot;, x);
1607             x.printStackTrace(out);
1608         }
1609     }
1610 
1611 
1612     // miscellaneous bugs/rfes that don&#39;t fit in with the test framework
1613 
1614     static void bugs() {
1615         b6339649();
1616         b6933879();
1617         b8037396();
1618     }
1619 
1620     // 6339649 - include detail message from nested exception
1621     private static void b6339649() {
1622         try {
1623             URI uri = URI.create(&quot;http://nowhere.net/should not be permitted&quot;);
1624         } catch (IllegalArgumentException e) {
1625             if (&quot;&quot;.equals(e.getMessage()) || e.getMessage() == null) {
1626                 throw new RuntimeException (&quot;No detail message&quot;);
1627             }
1628         }
1629     }
1630 
1631     // 6933879 - check that &quot;.&quot; and &quot;_&quot; characters are allowed in IPv6 scope_id.
1632     private static void b6933879() {
1633         final String HOST = &quot;fe80::c00:16fe:cebe:3214%eth1.12_55&quot;;
1634         URI uri;
1635         try {
1636             uri = new URI(&quot;http&quot;, null, HOST, 10, &quot;/&quot;, null, null);
1637         } catch (URISyntaxException ex) {
1638             throw new AssertionError(&quot;Should not happen&quot;, ex);
1639         }
1640         eq(&quot;[&quot; + HOST + &quot;]&quot;, uri.getHost());
1641     }
1642 
1643     private static void b8037396() {
1644 
1645         // primary checks:
1646 
1647         URI u;
1648         try {
1649             u = new URI(&quot;http&quot;, &quot;example.org&quot;, &quot;/[a b]&quot;, &quot;[a b]&quot;, &quot;[a b]&quot;);
1650         } catch (URISyntaxException e) {
1651             throw new AssertionError(&quot;shouldn&#39;t ever happen&quot;, e);
1652         }
1653         eq(&quot;/[a b]&quot;, u.getPath());
1654         eq(&quot;[a b]&quot;, u.getQuery());
1655         eq(&quot;[a b]&quot;, u.getFragment());
1656 
1657         // additional checks:
1658         //  *   &#39;%&#39; symbols are still decoded outside square brackets
1659         //  *   the getRawXXX() functionality left intact
1660 
1661         try {
1662             u = new URI(&quot;http&quot;, &quot;example.org&quot;, &quot;/a b[c d]&quot;, &quot;a b[c d]&quot;, &quot;a b[c d]&quot;);
1663         } catch (URISyntaxException e) {
1664             throw new AssertionError(&quot;shouldn&#39;t ever happen&quot;, e);
1665         }
1666 
1667         eq(&quot;/a b[c d]&quot;, u.getPath());
1668         eq(&quot;a b[c d]&quot;, u.getQuery());
1669         eq(&quot;a b[c d]&quot;, u.getFragment());
1670 
1671         eq(&quot;/a%20b%5Bc%20d%5D&quot;, u.getRawPath());
1672         eq(&quot;a%20b[c%20d]&quot;, u.getRawQuery());
1673         eq(&quot;a%20b[c%20d]&quot;, u.getRawFragment());
1674     }
1675 
1676     public static void main(String[] args) throws Exception {
1677         switch (args.length) {
1678 
1679         case 0:
1680             tests();
1681             out.println();
1682             out.println(&quot;Test cases: &quot; + testCount);
1683             break;
1684 
1685         case 1:
1686             if (args[0].equals(&quot;-help&quot;)) {
1687                 usage();
1688                 break;
1689             }
1690             clargs(null, args[0]);
1691             break;
1692 
1693         case 2:
1694             clargs(args[0], args[1]);
1695             break;
1696 
1697         default:
1698             usage();
1699             break;
1700 
1701         }
1702     }
1703 
1704 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>