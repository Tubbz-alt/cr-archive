<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/InetAddress/ptr/Lookup.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../InternalNameServiceWithHostsFileTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../InetSocketAddress/ToString.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/InetAddress/ptr/Lookup.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,10 +40,12 @@</span>
   */
  import java.io.IOException;
  import java.net.InetAddress;
  import java.net.UnknownHostException;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.stream.Stream;</span>
<span class="udiff-line-added">+ import java.util.stream.Collectors;</span>
  
  import jdk.test.lib.JDKToolFinder;
  import jdk.test.lib.process.OutputAnalyzer;
  
  public class Lookup {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,44 +55,84 @@</span>
              &quot;test.class.path&quot;);
  
      public static void main(String args[]) throws IOException {
          String addr = null;
          String ipv4Name = null;
<span class="udiff-line-added">+         String ipv4Reversed = null;</span>
<span class="udiff-line-added">+ </span>
          if (args.length == 0) {
<span class="udiff-line-modified-removed">-             // First check that host resolves to IPv4 address</span>
<span class="udiff-line-modified-added">+             // called from lookupWithIPv4Prefer</span>
<span class="udiff-line-added">+             // obtain an IPv4 address from the hostname.</span>
              try {
                  InetAddress ia = InetAddress.getByName(HOST);
                  addr = ia.getHostAddress();
<span class="udiff-line-added">+                 ia = InetAddress.getByName(addr);</span>
<span class="udiff-line-added">+                 System.out.print(addr + &quot;:&quot; + ia.getHostName());</span>
<span class="udiff-line-added">+                 return;</span>
              } catch (UnknownHostException e) {
                  System.out.print(SKIP);
                  return;
              }
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             String tmp = lookupWithIPv4Prefer();</span>
<span class="udiff-line-modified-removed">-             System.out.println(&quot;IPv4 lookup results: [&quot; + tmp + &quot;]&quot;);</span>
<span class="udiff-line-modified-removed">-             if (SKIP.equals(tmp)) {</span>
<span class="udiff-line-modified-removed">-                 System.out.println(HOST + &quot; can&#39;t be resolved - test skipped.&quot;);</span>
<span class="udiff-line-modified-added">+         } else if (args.length == 2 &amp;&amp; args[0].equals(&quot;reverse&quot;)) {</span>
<span class="udiff-line-modified-added">+             // called from reverseWithIPv4Prefer</span>
<span class="udiff-line-modified-added">+             // Check that IPv4 address can be resolved to host</span>
<span class="udiff-line-modified-added">+             // with -Djava.net.preferIPv4Stack=true</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-added">+                 InetAddress ia = InetAddress.getByName(args[1]);</span>
<span class="udiff-line-added">+                 addr = ia.getHostAddress();</span>
<span class="udiff-line-added">+                 ipv4Reversed = ia.getHostName();</span>
<span class="udiff-line-added">+                 System.out.print(addr + &quot;:&quot; + ipv4Reversed);</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             } catch (UnknownHostException e) {</span>
<span class="udiff-line-added">+                 System.out.print(SKIP);</span>
                  return;
              }
<span class="udiff-line-added">+         } else if (args.length != 1 || !args[0].equals(&quot;root&quot;)) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(Stream.of(args).collect(Collectors.joining(&quot; &quot;)));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // spawn a subprocess to obtain the IPv4 address</span>
<span class="udiff-line-added">+         String tmp = lookupWithIPv4Prefer();</span>
<span class="udiff-line-added">+         System.out.println(&quot;IPv4 lookup results: [&quot; + tmp + &quot;]&quot;);</span>
<span class="udiff-line-added">+         if (SKIP.equals(tmp)) {</span>
<span class="udiff-line-added">+             System.out.println(HOST + &quot; can&#39;t be resolved - test skipped.&quot;);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String[] strs = tmp.split(&quot;:&quot;);</span>
<span class="udiff-line-added">+         addr = strs[0];</span>
<span class="udiff-line-added">+         ipv4Name = strs[1];</span>
  
<span class="udiff-line-modified-removed">-             String[] strs = tmp.split(&quot;:&quot;);</span>
<span class="udiff-line-modified-removed">-             addr = strs[0];</span>
<span class="udiff-line-modified-removed">-             ipv4Name = strs[1];</span>
<span class="udiff-line-modified-added">+         // check that the a reverse lookup of the IPv4 address</span>
<span class="udiff-line-modified-added">+         // will succeed with the IPv4 only stack</span>
<span class="udiff-line-modified-added">+         tmp = reverseWithIPv4Prefer(addr);</span>
<span class="udiff-line-added">+         System.out.println(&quot;IPv4 reverse lookup results: [&quot; + tmp + &quot;]&quot;);</span>
<span class="udiff-line-added">+         if (SKIP.equals(tmp)) {</span>
<span class="udiff-line-added">+             System.out.println(addr + &quot; can&#39;t be resolved with preferIPv4 - test skipped.&quot;);</span>
<span class="udiff-line-added">+             return;</span>
          }
  
<span class="udiff-line-modified-removed">-         // reverse lookup</span>
<span class="udiff-line-modified-added">+         strs = tmp.split(&quot;:&quot;);</span>
<span class="udiff-line-added">+         ipv4Reversed = strs[1];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Now check that a reverse lookup will succeed with the dual stack.</span>
          InetAddress ia = InetAddress.getByName(addr);
          String name = ia.getHostName();
<span class="udiff-line-modified-removed">-         if (args.length == 0) {</span>
<span class="udiff-line-modified-removed">-             System.out.print(addr + &quot;:&quot; + name);</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             System.out.println(&quot;(default) &quot; + addr + &quot;--&gt; &quot; + name);</span>
<span class="udiff-line-modified-removed">-             if (!ipv4Name.equals(name)) {</span>
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;Mismatch between default&quot;</span>
<span class="udiff-line-modified-removed">-                         + &quot; and java.net.preferIPv4Stack=true results&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         System.out.println(&quot;(default) &quot; + addr + &quot;--&gt; &quot; + name</span>
<span class="udiff-line-modified-added">+                                + &quot; (reversed IPv4: &quot; + ipv4Reversed + &quot;)&quot;);</span>
<span class="udiff-line-modified-added">+         if (!ipv4Name.equals(name)) {</span>
<span class="udiff-line-modified-added">+             // adding some diagnosting</span>
<span class="udiff-line-modified-added">+             System.err.println(&quot;name=&quot; + name + &quot; doesn&#39;t match expected=&quot; + ipv4Name);</span>
<span class="udiff-line-modified-added">+             System.err.println(&quot;Listing all adresses:&quot;);</span>
<span class="udiff-line-modified-added">+             for (InetAddress any : InetAddress.getAllByName(HOST)) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;\t[&quot; + any + &quot;] address=&quot; + any.getHostAddress()</span>
<span class="udiff-line-added">+                                    + &quot;, host=&quot; + any.getHostName());</span>
              }
<span class="udiff-line-added">+             // make the test fail...</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Mismatch between default&quot;</span>
<span class="udiff-line-added">+                     + &quot; and java.net.preferIPv4Stack=true results&quot;);</span>
          }
      }
  
      static String lookupWithIPv4Prefer() throws IOException {
          String java = JDKToolFinder.getTestJDKTool(&quot;java&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -98,7 +140,15 @@</span>
          List&lt;String&gt; cmd = List.of(java, &quot;-Djava.net.preferIPv4Stack=true&quot;,
                  &quot;-cp&quot;, CLASS_PATH, testClz);
          System.out.println(&quot;Executing: &quot; + cmd);
          return new OutputAnalyzer(new ProcessBuilder(cmd).start()).getOutput();
      }
<span class="udiff-line-removed">- }</span>
  
<span class="udiff-line-added">+     static String reverseWithIPv4Prefer(String addr) throws IOException {</span>
<span class="udiff-line-added">+         String java = JDKToolFinder.getTestJDKTool(&quot;java&quot;);</span>
<span class="udiff-line-added">+         String testClz = Lookup.class.getName();</span>
<span class="udiff-line-added">+         List&lt;String&gt; cmd = List.of(java, &quot;-Djava.net.preferIPv4Stack=true&quot;,</span>
<span class="udiff-line-added">+                                    &quot;-cp&quot;, CLASS_PATH, testClz, &quot;reverse&quot;, addr);</span>
<span class="udiff-line-added">+         System.out.println(&quot;Executing: &quot; + cmd);</span>
<span class="udiff-line-added">+         return new OutputAnalyzer(new ProcessBuilder(cmd).start()).getOutput();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
</pre>
<center><a href="../InternalNameServiceWithHostsFileTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../InetSocketAddress/ToString.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>