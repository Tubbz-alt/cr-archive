<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/ipv6tests/TcpTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B6521014.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="UdpTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/ipv6tests/TcpTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,15 +23,18 @@</span>
  
  /*
   * @test
   * @bug 4868820
   * @key intermittent
<span class="udiff-line-modified-removed">-  * @summary IPv6 support for Windows XP and 2003 server</span>
<span class="udiff-line-modified-added">+  * @summary IPv6 support for Windows XP and 2003 server. This test requires</span>
<span class="udiff-line-added">+  *          binding to the wildcard address, and as such is susceptible</span>
<span class="udiff-line-added">+  *          of intermittent failures caused by port reuse policy.</span>
   * @library /test/lib
   * @build jdk.test.lib.NetworkConfiguration
   *        jdk.test.lib.Platform
   * @run main TcpTest -d
<span class="udiff-line-added">+  * @run main/othervm -Djdk.net.usePlainSocketImpl TcpTest -d</span>
   */
  
  import java.net.*;
  import java.io.*;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,10 +59,14 @@</span>
          }
      }
  
      public static void main (String[] args) throws Exception {
          checkDebug(args);
<span class="udiff-line-added">+         if (ia4addr == null) {</span>
<span class="udiff-line-added">+             System.out.println (&quot;No IPV4 addresses: exiting test&quot;);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
          if (ia6addr == null) {
              System.out.println (&quot;No IPV6 addresses: exiting test&quot;);
              return;
          }
          dprintln (&quot;Local Addresses&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,11 +131,23 @@</span>
          c1 = new Socket (ia4addr, port);
          try {
              dprintln (&quot;connecting to &quot; + ia6addr);
              c2 = new Socket ();
              c2.connect (sadr6, 1000);
<span class="udiff-line-modified-removed">-             throw new RuntimeException (&quot;connect to IPv6 address should be refused&quot;);</span>
<span class="udiff-line-modified-added">+             dprintln (&quot;Unexpected successful connection: &quot; + c2);</span>
<span class="udiff-line-added">+             // Connect should fail with timeout exception. However, if something else is</span>
<span class="udiff-line-added">+             // accepting connections, verify it is not our server.</span>
<span class="udiff-line-added">+             server.setSoTimeout(500);</span>
<span class="udiff-line-added">+             // Ok if accept() fails because of timeout</span>
<span class="udiff-line-added">+             while (true) {</span>
<span class="udiff-line-added">+                 // acceptedSocket could be connected to c1, but not c2</span>
<span class="udiff-line-added">+                 try (Socket acceptedSocket = server.accept()) {</span>
<span class="udiff-line-added">+                     dprintln(&quot;accepted socket: &quot; + acceptedSocket);</span>
<span class="udiff-line-added">+                     if (acceptedSocket.getRemoteSocketAddress().equals(c2.getLocalSocketAddress()))</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;connect to IPv6 address should be refused&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
          } catch (IOException e) { }
          server.close ();
          c1.close ();
          if (c2 != null) {
              c2.close();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -144,11 +163,23 @@</span>
  
          c1 = new Socket (ia6addr, port);
          try {
              dprintln (&quot;connecting to &quot; + ia4addr);
              c2 = new Socket (ia4addr, port);
<span class="udiff-line-modified-removed">-             throw new RuntimeException (&quot;connect to IPv4 address should be refused&quot;);</span>
<span class="udiff-line-modified-added">+             dprintln (&quot;Unexpected successful connection: &quot; + c2);</span>
<span class="udiff-line-added">+             // Connect should fail with timeout exception. However, if something else is</span>
<span class="udiff-line-added">+             // accepting connections, verify it is not our server.</span>
<span class="udiff-line-added">+             server.setSoTimeout(500);</span>
<span class="udiff-line-added">+             // Ok if accept() fails because of timeout</span>
<span class="udiff-line-added">+             while (true) {</span>
<span class="udiff-line-added">+                 // acceptedSocket could be connected to c1, but not c2</span>
<span class="udiff-line-added">+                 try (Socket acceptedSocket = server.accept()) {</span>
<span class="udiff-line-added">+                     dprintln(&quot;accepted socket: &quot; + acceptedSocket);</span>
<span class="udiff-line-added">+                     if (acceptedSocket.getRemoteSocketAddress().equals(c2.getLocalSocketAddress()))</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;connect to IPv4 address should be refused&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
          } catch (IOException e) { }
          server.close ();
          c1.close ();
          if (c2 != null) {
              c2.close();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,6 +245,5 @@</span>
          s1.close ();
          server.close ();
          System.out.println (&quot;Test4: OK&quot;);
      }
  }
<span class="udiff-line-removed">- </span>
</pre>
<center><a href="B6521014.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="UdpTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>