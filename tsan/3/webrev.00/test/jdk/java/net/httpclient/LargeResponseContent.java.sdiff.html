<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/LargeResponseContent.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="HttpsTunnelTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="LineStreamsAndSurrogatesTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/LargeResponseContent.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.InputStream;
 26 import java.io.OutputStream;
 27 import java.net.InetAddress;
 28 import java.net.InetSocketAddress;
 29 import java.net.ServerSocket;
 30 import java.net.Socket;
 31 import java.net.URI;
 32 import java.net.http.HttpClient;
 33 import java.net.http.HttpHeaders;
 34 import java.net.http.HttpRequest;
 35 import java.net.http.HttpResponse;
 36 import java.nio.ByteBuffer;
 37 import java.nio.charset.StandardCharsets;
 38 import java.util.List;
 39 import java.util.concurrent.CompletableFuture;
 40 import java.util.concurrent.CompletionStage;
 41 import java.util.concurrent.Flow;

 42 
 43 /**
 44  * @test
 45  * @bug 8212926

 46  * @summary Basic tests for response timeouts
 47  * @run main/othervm LargeResponseContent
 48  */
 49 
 50 public class LargeResponseContent {
 51     final ServerSocket server;
 52     final int port;
 53 
 54     public LargeResponseContent() throws Exception {
 55         server = new ServerSocket(0, 10, InetAddress.getLoopbackAddress());
 56         Thread serverThread = new Thread(this::handleConnection);
 57         serverThread.setDaemon(false);
 58         port = server.getLocalPort();
 59         serverThread.start();
 60     }
 61 
 62     void runClient() throws IOException, InterruptedException {
<span class="line-modified"> 63         URI uri = URI.create(&quot;http://127.0.0.1:&quot; + Integer.toString(port) + &quot;/foo&quot;);</span>






 64         HttpClient client = HttpClient.newHttpClient();
 65         HttpRequest request = HttpRequest.newBuilder(uri)
 66                 .GET()
 67                 .build();
 68         HttpResponse&lt;Long&gt; response = client.send(request, new ClientHandler());
 69         System.out.println(&quot;Response code = &quot; + response.statusCode());
 70         long blen = response.body();
 71         if (blen != CONTENT_LEN)
 72             throw new RuntimeException(&quot;wrong content length&quot;);
 73     }
 74 
 75     public static void main(String[] args) throws Exception {
 76         System.out.println (&quot;CONTENT_LEN = &quot; + CONTENT_LEN);
 77         System.out.println (&quot;CLEN_STR = &quot; + CLEN_STR);
 78         LargeResponseContent test = new LargeResponseContent();
 79         test.runClient();
 80     }
 81 
 82     static class ClientHandler implements HttpResponse.BodyHandler&lt;Long&gt; {
 83 
</pre>
</td>
<td>
<hr />
<pre>
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.InputStream;
 26 import java.io.OutputStream;
 27 import java.net.InetAddress;
 28 import java.net.InetSocketAddress;
 29 import java.net.ServerSocket;
 30 import java.net.Socket;
 31 import java.net.URI;
 32 import java.net.http.HttpClient;
 33 import java.net.http.HttpHeaders;
 34 import java.net.http.HttpRequest;
 35 import java.net.http.HttpResponse;
 36 import java.nio.ByteBuffer;
 37 import java.nio.charset.StandardCharsets;
 38 import java.util.List;
 39 import java.util.concurrent.CompletableFuture;
 40 import java.util.concurrent.CompletionStage;
 41 import java.util.concurrent.Flow;
<span class="line-added"> 42 import jdk.test.lib.net.URIBuilder;</span>
 43 
 44 /**
 45  * @test
 46  * @bug 8212926
<span class="line-added"> 47  * @library /test/lib</span>
 48  * @summary Basic tests for response timeouts
 49  * @run main/othervm LargeResponseContent
 50  */
 51 
 52 public class LargeResponseContent {
 53     final ServerSocket server;
 54     final int port;
 55 
 56     public LargeResponseContent() throws Exception {
 57         server = new ServerSocket(0, 10, InetAddress.getLoopbackAddress());
 58         Thread serverThread = new Thread(this::handleConnection);
 59         serverThread.setDaemon(false);
 60         port = server.getLocalPort();
 61         serverThread.start();
 62     }
 63 
 64     void runClient() throws IOException, InterruptedException {
<span class="line-modified"> 65         URI uri = URIBuilder.newBuilder()</span>
<span class="line-added"> 66             .scheme(&quot;http&quot;)</span>
<span class="line-added"> 67             .loopback()</span>
<span class="line-added"> 68             .port(port)</span>
<span class="line-added"> 69             .path(&quot;/foo&quot;)</span>
<span class="line-added"> 70             .buildUnchecked();</span>
<span class="line-added"> 71         System.out.println(&quot;URI: &quot; + uri);</span>
 72         HttpClient client = HttpClient.newHttpClient();
 73         HttpRequest request = HttpRequest.newBuilder(uri)
 74                 .GET()
 75                 .build();
 76         HttpResponse&lt;Long&gt; response = client.send(request, new ClientHandler());
 77         System.out.println(&quot;Response code = &quot; + response.statusCode());
 78         long blen = response.body();
 79         if (blen != CONTENT_LEN)
 80             throw new RuntimeException(&quot;wrong content length&quot;);
 81     }
 82 
 83     public static void main(String[] args) throws Exception {
 84         System.out.println (&quot;CONTENT_LEN = &quot; + CONTENT_LEN);
 85         System.out.println (&quot;CLEN_STR = &quot; + CLEN_STR);
 86         LargeResponseContent test = new LargeResponseContent();
 87         test.runClient();
 88     }
 89 
 90     static class ClientHandler implements HttpResponse.BodyHandler&lt;Long&gt; {
 91 
</pre>
</td>
</tr>
</table>
<center><a href="HttpsTunnelTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="LineStreamsAndSurrogatesTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>