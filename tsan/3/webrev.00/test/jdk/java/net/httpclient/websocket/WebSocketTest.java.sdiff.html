<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/websocket/WebSocketTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="WebSocketProxyTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="security/httpclient.policy.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/WebSocketTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8217429
 27  * @build DummyWebSocketServer
 28  * @run testng/othervm
 29  *       WebSocketTest
 30  */
 31 
<span class="line-removed"> 32 import org.testng.annotations.AfterTest;</span>
 33 import org.testng.annotations.DataProvider;
 34 import org.testng.annotations.Test;
 35 
 36 import java.io.IOException;
 37 import java.net.Authenticator;
 38 import java.net.PasswordAuthentication;
 39 import java.net.http.HttpResponse;
 40 import java.net.http.WebSocket;
 41 import java.net.http.WebSocketHandshakeException;
 42 import java.nio.ByteBuffer;
 43 import java.nio.charset.StandardCharsets;
 44 import java.util.ArrayList;
 45 import java.util.Base64;
 46 import java.util.List;
 47 import java.util.concurrent.CompletableFuture;
 48 import java.util.concurrent.CompletionException;
 49 import java.util.concurrent.CompletionStage;
 50 import java.util.concurrent.TimeUnit;
 51 import java.util.concurrent.atomic.AtomicBoolean;
 52 import java.util.function.Function;
</pre>
<hr />
<pre>
 56 import static java.net.http.HttpClient.Builder.NO_PROXY;
 57 import static java.net.http.HttpClient.newBuilder;
 58 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 59 import static java.nio.charset.StandardCharsets.UTF_8;
 60 import static org.testng.Assert.assertEquals;
 61 import static org.testng.Assert.assertThrows;
 62 import static org.testng.Assert.fail;
 63 
 64 public class WebSocketTest {
 65 
 66     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 67     private static final Class&lt;IllegalStateException&gt; ISE = IllegalStateException.class;
 68     private static final Class&lt;IOException&gt; IOE = IOException.class;
 69 
 70     /* shortcut */
 71     private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
 72                                     CompletionStage&lt;?&gt; stage) {
 73         Support.assertCompletesExceptionally(clazz, stage);
 74     }
 75 
<span class="line-removed"> 76     private DummyWebSocketServer server;</span>
<span class="line-removed"> 77     private WebSocket webSocket;</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79     @AfterTest</span>
<span class="line-removed"> 80     public void cleanup() {</span>
<span class="line-removed"> 81         System.out.println(&quot;AFTER TEST&quot;);</span>
<span class="line-removed"> 82         if (server != null)</span>
<span class="line-removed"> 83             server.close();</span>
<span class="line-removed"> 84         if (webSocket != null)</span>
<span class="line-removed"> 85             webSocket.abort();</span>
<span class="line-removed"> 86     }</span>
<span class="line-removed"> 87 </span>
 88     @Test
 89     public void illegalArgument() throws IOException {
<span class="line-modified"> 90         server = new DummyWebSocketServer();</span>
<span class="line-modified"> 91         server.open();</span>
<span class="line-modified"> 92         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified"> 93                 .newWebSocketBuilder()</span>
<span class="line-modified"> 94                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified"> 95                 .join();</span>
<span class="line-modified"> 96 </span>
<span class="line-modified"> 97         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 98         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 99         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified">100         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified">101         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified">102 </span>
<span class="line-modified">103         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified">104         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified">105         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified">106         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified">107         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified">108 </span>
<span class="line-modified">109         assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified">110         assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified">111         assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified">112         assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">113 </span>
<span class="line-modified">114         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">115         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">116         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">117         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">118         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">119         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">120         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">121         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">122 </span>
<span class="line-modified">123         assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">124         assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">125         assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">126         assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">127         assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">128         assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">129         assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">130         assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">131         assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">132         assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">133         assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">134         assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">135         assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">136         assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">137         assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">138         assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">139         assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">140         assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">141         assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">142         assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">143         assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">144         assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">145 </span>
<span class="line-modified">146         assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">147         assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">148         assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">149         assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">150 </span>
<span class="line-modified">151         server.close();</span>



152     }
153 
154     @Test
155     public void partialBinaryThenText() throws IOException {
<span class="line-modified">156         server = new DummyWebSocketServer();</span>
<span class="line-modified">157         server.open();</span>
<span class="line-modified">158         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">159                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">160                 .join();</span>
<span class="line-modified">161         webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">162         assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">163         assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">164         // Pings &amp; Pongs are fine</span>
<span class="line-modified">165         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">166         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">167         server.close();</span>




168     }
169 
170     @Test
171     public void partialTextThenBinary() throws IOException {
<span class="line-modified">172         server = new DummyWebSocketServer();</span>
<span class="line-modified">173         server.open();</span>
<span class="line-modified">174         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">175                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">176                 .join();</span>
<span class="line-modified">177 </span>
<span class="line-modified">178         webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">179         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">180         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">181         // Pings &amp; Pongs are fine</span>
<span class="line-modified">182         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">183         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">184         server.close();</span>



185     }
186 
187     @Test
188     public void sendMethodsThrowIOE1() throws IOException {
<span class="line-modified">189         server = new DummyWebSocketServer();</span>
<span class="line-modified">190         server.open();</span>
<span class="line-modified">191         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">192                 .newWebSocketBuilder()</span>
<span class="line-modified">193                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">194                 .join();</span>
<span class="line-modified">195 </span>
<span class="line-modified">196         webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">197 </span>
<span class="line-modified">198         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">199 </span>
<span class="line-modified">200         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">201         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">202         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">203         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">204         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">205         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">206         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">207         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">208 </span>
<span class="line-modified">209         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">210         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">211         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">212         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">213 </span>
<span class="line-modified">214         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">215         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">216         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">217         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">218 </span>
<span class="line-modified">219         server.close();</span>


220     }
221 
222     @DataProvider(name = &quot;sequence&quot;)
223     public Object[][] data1() {
224         int[] CLOSE = {
225                 0x81, 0x00, // &quot;&quot;
226                 0x82, 0x00, // []
227                 0x89, 0x00, // &lt;PING&gt;
228                 0x8a, 0x00, // &lt;PONG&gt;
229                 0x88, 0x00, // &lt;CLOSE&gt;
230         };
231         int[] ERROR = {
232                 0x81, 0x00, // &quot;&quot;
233                 0x82, 0x00, // []
234                 0x89, 0x00, // &lt;PING&gt;
235                 0x8a, 0x00, // &lt;PONG&gt;
236                 0x8b, 0x00, // 0xB control frame (causes an error)
237         };
238         return new Object[][]{
239                 {CLOSE, 1},
240                 {CLOSE, 3},
241                 {CLOSE, 4},
242                 {CLOSE, Long.MAX_VALUE},
243                 {ERROR, 1},
244                 {ERROR, 3},
245                 {ERROR, 4},
246                 {ERROR, Long.MAX_VALUE},
247         };
248     }
249 
250     @Test(dataProvider = &quot;sequence&quot;)
251     public void listenerSequentialOrder(int[] binary, long requestSize)
252             throws IOException
253     {


254 
<span class="line-modified">255         server = Support.serverWithCannedData(binary);</span>
<span class="line-removed">256         server.open();</span>
<span class="line-removed">257 </span>
<span class="line-removed">258         CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>
259 
<span class="line-modified">260         MockListener listener = new MockListener(requestSize) {</span>
261 
<span class="line-modified">262             final AtomicBoolean guard = new AtomicBoolean();</span>
263 
<span class="line-modified">264             private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">265                 if (guard.getAndSet(true)) {</span>
<span class="line-removed">266                     violation.completeExceptionally(new RuntimeException());</span>
<span class="line-removed">267                 }</span>
<span class="line-removed">268                 try {</span>
<span class="line-removed">269                     return action.get();</span>
<span class="line-removed">270                 } finally {</span>
<span class="line-removed">271                     if (!guard.getAndSet(false)) {</span>
272                         violation.completeExceptionally(new RuntimeException());
273                     }







274                 }
<span class="line-removed">275             }</span>
<span class="line-removed">276 </span>
<span class="line-removed">277             @Override</span>
<span class="line-removed">278             public void onOpen(WebSocket webSocket) {</span>
<span class="line-removed">279                 checkRunExclusively(() -&gt; {</span>
<span class="line-removed">280                     super.onOpen(webSocket);</span>
<span class="line-removed">281                     return null;</span>
<span class="line-removed">282                 });</span>
<span class="line-removed">283             }</span>
284 
<span class="line-modified">285             @Override</span>
<span class="line-modified">286             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">287                                              CharSequence data,</span>
<span class="line-modified">288                                              boolean last) {</span>
<span class="line-modified">289                 return checkRunExclusively(</span>
<span class="line-modified">290                         () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-modified">291             }</span>
<span class="line-removed">292 </span>
<span class="line-removed">293             @Override</span>
<span class="line-removed">294             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-removed">295                                                ByteBuffer data,</span>
<span class="line-removed">296                                                boolean last) {</span>
<span class="line-removed">297                 return checkRunExclusively(</span>
<span class="line-removed">298                         () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-removed">299             }</span>
<span class="line-removed">300 </span>
<span class="line-removed">301             @Override</span>
<span class="line-removed">302             public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-removed">303                                              ByteBuffer message) {</span>
<span class="line-removed">304                 return checkRunExclusively(</span>
<span class="line-removed">305                         () -&gt; super.onPing(webSocket, message));</span>
<span class="line-removed">306             }</span>
307 
<span class="line-modified">308             @Override</span>
<span class="line-modified">309             public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">310                                              ByteBuffer message) {</span>
<span class="line-modified">311                 return checkRunExclusively(</span>
<span class="line-modified">312                         () -&gt; super.onPong(webSocket, message));</span>
<span class="line-modified">313             }</span>

314 
<span class="line-modified">315             @Override</span>
<span class="line-modified">316             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">317                                               int statusCode,</span>
<span class="line-modified">318                                               String reason) {</span>
<span class="line-modified">319                 return checkRunExclusively(</span>
<span class="line-modified">320                         () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-modified">321             }</span>
322 
<span class="line-modified">323             @Override</span>
<span class="line-modified">324             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">325                 checkRunExclusively(() -&gt; {</span>
<span class="line-modified">326                     super.onError(webSocket, error);</span>
<span class="line-modified">327                     return null;</span>
<span class="line-modified">328                 });</span>
<span class="line-removed">329             }</span>
<span class="line-removed">330         };</span>
331 
<span class="line-modified">332         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">333                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">334                 .join();</span>



335 







336 
<span class="line-modified">337         listener.invocations();</span>
<span class="line-modified">338         violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-modified">339         violation.join();</span>





340 
<span class="line-modified">341         server.close();</span>










342     }
343 
344     @Test
345     public void sendMethodsThrowIOE2() throws Exception {
<span class="line-modified">346         server = Support.serverWithCannedData(0x88, 0x00);</span>
<span class="line-modified">347         server.open();</span>
<span class="line-removed">348         CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">349         CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">350 </span>
<span class="line-removed">351         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">352             @Override</span>
<span class="line-removed">353             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">354                                               int statusCode,</span>
<span class="line-removed">355                                               String reason) {</span>
<span class="line-removed">356                 System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-removed">357                 onCloseCalled.complete(null);</span>
<span class="line-removed">358                 return canClose;</span>
<span class="line-removed">359             }</span>
<span class="line-removed">360 </span>
<span class="line-removed">361             @Override</span>
<span class="line-removed">362             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">363                 System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-removed">364                 onCloseCalled.completeExceptionally(error);</span>
<span class="line-removed">365             }</span>
<span class="line-removed">366         };</span>
<span class="line-removed">367 </span>
<span class="line-removed">368         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-removed">369                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">370                 .join();</span>
<span class="line-removed">371 </span>
<span class="line-removed">372         onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-removed">373         canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-removed">374         TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-removed">375 </span>
<span class="line-removed">376         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-removed">377 </span>
<span class="line-removed">378         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-removed">379         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-removed">380         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-removed">381         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-removed">382         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-removed">383         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-removed">384         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-removed">385         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
386 
<span class="line-modified">387         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">388         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">389         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">390         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>








391 
<span class="line-modified">392         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">393         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">394         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">395         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>


396 
<span class="line-modified">397         server.close();</span>































398     }
399 
400     // Used to verify a server requiring Authentication
401     private static final String USERNAME = &quot;chegar&quot;;
402     private static final String PASSWORD = &quot;a1b2c3&quot;;
403 
404     static class WSAuthenticator extends Authenticator {
405         @Override
406         protected PasswordAuthentication getPasswordAuthentication() {
407             return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
408         }
409     }
410 
411     static final Function&lt;int[],DummyWebSocketServer&gt; SERVER_WITH_CANNED_DATA =
412         new Function&lt;&gt;() {
413             @Override public DummyWebSocketServer apply(int[] data) {
414                 return Support.serverWithCannedData(data); }
415             @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
416         };
417 
</pre>
<hr />
<pre>
441                 .collect(Collectors.toList());
442         int[] binary = new int[]{
443                 0x82, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // [alpha]
444                 0x02, 0x02, 0x62, 0x65,                   // [be
445                 0x80, 0x02, 0x74, 0x61,                   // ta]
446                 0x02, 0x01, 0x67,                         // [g
447                 0x00, 0x01, 0x61,                         // a
448                 0x00, 0x00,                               //
449                 0x00, 0x00,                               //
450                 0x00, 0x01, 0x6d,                         // m
451                 0x00, 0x01, 0x6d,                         // m
452                 0x80, 0x01, 0x61,                         // a]
453                 0x8a, 0x00,                               // &lt;PONG&gt;
454                 0x02, 0x04, 0x64, 0x65, 0x6c, 0x74,       // [delt
455                 0x00, 0x01, 0x61,                         // a
456                 0x80, 0x00,                               // ]
457                 0x88, 0x00                                // &lt;CLOSE&gt;
458         };
459         CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
460 
<span class="line-modified">461         server = serverSupplier.apply(binary);</span>
<span class="line-modified">462         server.open();</span>
463 
<span class="line-modified">464         WebSocket.Listener listener = new WebSocket.Listener() {</span>
465 
<span class="line-modified">466             List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">467             ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
468 
<span class="line-modified">469             @Override</span>
<span class="line-modified">470             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">471                                                ByteBuffer message,</span>
<span class="line-modified">472                                                boolean last) {</span>
<span class="line-modified">473                 System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">474                 webSocket.request(1);</span>
475 
<span class="line-modified">476                 append(message);</span>
<span class="line-modified">477                 if (last) {</span>
<span class="line-modified">478                     buffer.flip();</span>
<span class="line-modified">479                     byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">480                     buffer.get(bytes);</span>
<span class="line-modified">481                     buffer.clear();</span>
<span class="line-modified">482                     processWholeBinary(bytes);</span>


483                 }
<span class="line-removed">484                 return null;</span>
<span class="line-removed">485             }</span>
486 
<span class="line-modified">487             private void append(ByteBuffer message) {</span>
<span class="line-modified">488                 if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">489                     assert message.remaining() &gt; 0;</span>
<span class="line-modified">490                     int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">491                     ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">492                     b.put(buffer.flip());</span>
<span class="line-modified">493                     buffer = b;</span>


494                 }
<span class="line-removed">495                 buffer.put(message);</span>
<span class="line-removed">496             }</span>
497 
<span class="line-modified">498             private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">499                 String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">500                 System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">501                 collectedBytes.add(bytes);</span>
<span class="line-modified">502             }</span>
<span class="line-removed">503 </span>
<span class="line-removed">504             @Override</span>
<span class="line-removed">505             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">506                                               int statusCode,</span>
<span class="line-removed">507                                               String reason) {</span>
<span class="line-removed">508                 actual.complete(collectedBytes);</span>
<span class="line-removed">509                 return null;</span>
<span class="line-removed">510             }</span>
<span class="line-removed">511 </span>
<span class="line-removed">512             @Override</span>
<span class="line-removed">513             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">514                 actual.completeExceptionally(error);</span>
<span class="line-removed">515             }</span>
<span class="line-removed">516         };</span>
517 
<span class="line-modified">518         webSocket = newBuilder()</span>
<span class="line-modified">519                 .proxy(NO_PROXY)</span>
<span class="line-modified">520                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">521                 .build().newWebSocketBuilder()</span>
<span class="line-modified">522                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">523                 .join();</span>

524 
<span class="line-modified">525         List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-modified">526         assertEquals(a, expected);</span>



527 
<span class="line-modified">528         server.close();</span>












529     }
530 
531     @Test(dataProvider = &quot;servers&quot;)
532     public void simpleAggregatingTextMessages
533             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
534         throws IOException
535     {
536         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
537 
538         int[] binary = new int[]{
539                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
540                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
541                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
542                 0x01, 0x01, 0x67,                         // &quot;g
543                 0x00, 0x01, 0x61,                         // a
544                 0x00, 0x00,                               //
545                 0x00, 0x00,                               //
546                 0x00, 0x01, 0x6d,                         // m
547                 0x00, 0x01, 0x6d,                         // m
548                 0x80, 0x01, 0x61,                         // a&quot;
549                 0x8a, 0x00,                               // &lt;PONG&gt;
550                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
551                 0x00, 0x01, 0x61,                         // a
552                 0x80, 0x00,                               // &quot;
553                 0x88, 0x00                                // &lt;CLOSE&gt;
554         };
555         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
556 
<span class="line-modified">557         server = serverSupplier.apply(binary);</span>
<span class="line-modified">558         server.open();</span>
<span class="line-removed">559 </span>
<span class="line-removed">560         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">561 </span>
<span class="line-removed">562             List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-removed">563             StringBuilder text = new StringBuilder();</span>
<span class="line-removed">564 </span>
<span class="line-removed">565             @Override</span>
<span class="line-removed">566             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">567                                              CharSequence message,</span>
<span class="line-removed">568                                              boolean last) {</span>
<span class="line-removed">569                 System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-removed">570                 webSocket.request(1);</span>
<span class="line-removed">571                 text.append(message);</span>
<span class="line-removed">572                 if (last) {</span>
<span class="line-removed">573                     String str = text.toString();</span>
<span class="line-removed">574                     text.setLength(0);</span>
<span class="line-removed">575                     processWholeText(str);</span>
<span class="line-removed">576                 }</span>
<span class="line-removed">577                 return null;</span>
<span class="line-removed">578             }</span>
579 
<span class="line-modified">580             private void processWholeText(String string) {</span>
<span class="line-removed">581                 System.out.println(string);</span>
<span class="line-removed">582                 collectedStrings.add(string);</span>
<span class="line-removed">583             }</span>
584 
<span class="line-modified">585             @Override</span>
<span class="line-modified">586             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">587                                               int statusCode,</span>
<span class="line-removed">588                                               String reason) {</span>
<span class="line-removed">589                 actual.complete(collectedStrings);</span>
<span class="line-removed">590                 return null;</span>
<span class="line-removed">591             }</span>
592 
<span class="line-modified">593             @Override</span>
<span class="line-modified">594             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">595                 actual.completeExceptionally(error);</span>
<span class="line-modified">596             }</span>
<span class="line-modified">597         };</span>









598 
<span class="line-modified">599         webSocket = newBuilder()</span>
<span class="line-modified">600                 .proxy(NO_PROXY)</span>
<span class="line-modified">601                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">602                 .build().newWebSocketBuilder()</span>
<span class="line-removed">603                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">604                 .join();</span>
605 
<span class="line-modified">606         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">607         assertEquals(a, expected);</span>





608 
<span class="line-modified">609         server.close();</span>


















610     }
611 
612     /*
613      * Exercises the scenario where requests for more messages are made prior to
614      * completing the returned CompletionStage instances.
615      */
616     @Test(dataProvider = &quot;servers&quot;)
617     public void aggregatingTextMessages
618         (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
619         throws IOException
620     {
621         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
622 
623         int[] binary = new int[]{
624                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
625                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
626                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
627                 0x01, 0x01, 0x67,                         // &quot;g
628                 0x00, 0x01, 0x61,                         // a
629                 0x00, 0x00,                               //
630                 0x00, 0x00,                               //
631                 0x00, 0x01, 0x6d,                         // m
632                 0x00, 0x01, 0x6d,                         // m
633                 0x80, 0x01, 0x61,                         // a&quot;
634                 0x8a, 0x00,                               // &lt;PONG&gt;
635                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
636                 0x00, 0x01, 0x61,                         // a
637                 0x80, 0x00,                               // &quot;
638                 0x88, 0x00                                // &lt;CLOSE&gt;
639         };
640         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
641 
<span class="line-modified">642         server = serverSupplier.apply(binary);</span>
<span class="line-modified">643         server.open();</span>
<span class="line-removed">644 </span>
<span class="line-removed">645         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">646 </span>
<span class="line-removed">647             List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-removed">648             /*</span>
<span class="line-removed">649              * A CompletableFuture which will complete once the current</span>
<span class="line-removed">650              * message has been fully assembled. Until then the listener</span>
<span class="line-removed">651              * returns this instance for every call.</span>
<span class="line-removed">652              */</span>
<span class="line-removed">653             CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">654             List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-removed">655 </span>
<span class="line-removed">656             @Override</span>
<span class="line-removed">657             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">658                                              CharSequence message,</span>
<span class="line-removed">659                                              boolean last) {</span>
<span class="line-removed">660                 parts.add(message);</span>
<span class="line-removed">661                 if (!last) {</span>
<span class="line-removed">662                     webSocket.request(1);</span>
<span class="line-removed">663                 } else {</span>
<span class="line-removed">664                     this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-removed">665                     CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-removed">666                     processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-removed">667                     currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">668                     parts.clear();</span>
<span class="line-removed">669                     return refCf;</span>
<span class="line-removed">670                 }</span>
<span class="line-removed">671                 return currentCf;</span>
<span class="line-removed">672             }</span>
<span class="line-removed">673 </span>
<span class="line-removed">674             @Override</span>
<span class="line-removed">675             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">676                                               int statusCode,</span>
<span class="line-removed">677                                               String reason) {</span>
<span class="line-removed">678                 actual.complete(collected);</span>
<span class="line-removed">679                 return null;</span>
<span class="line-removed">680             }</span>
681 
<span class="line-modified">682             @Override</span>
<span class="line-modified">683             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">684                 actual.completeExceptionally(error);</span>
<span class="line-modified">685             }</span>
























686 
<span class="line-modified">687             public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">688                                             CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-modified">689                 StringBuilder b = new StringBuilder();</span>
<span class="line-modified">690                 data.forEach(b::append);</span>
<span class="line-modified">691                 String s = b.toString();</span>
<span class="line-modified">692                 System.out.println(s);</span>
<span class="line-modified">693                 cf.complete(null);</span>
<span class="line-removed">694                 collected.add(s);</span>
<span class="line-removed">695             }</span>
<span class="line-removed">696         };</span>
697 
<span class="line-modified">698         webSocket = newBuilder()</span>
<span class="line-modified">699                 .proxy(NO_PROXY)</span>
<span class="line-modified">700                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">701                 .build().newWebSocketBuilder()</span>
<span class="line-removed">702                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">703                 .join();</span>
704 
<span class="line-modified">705         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">706         assertEquals(a, expected);</span>








707 
<span class="line-modified">708         server.close();</span>












709     }
710 
711     // -- authentication specific tests
712 
713     /*
714      * Ensures authentication succeeds when an Authenticator set on client builder.
715      */
716     @Test
717     public void clientAuthenticate() throws IOException  {
718         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)){
719             server.open();
720 
721             var webSocket = newBuilder()
722                     .proxy(NO_PROXY)
723                     .authenticator(new WSAuthenticator())
724                     .build()
725                     .newWebSocketBuilder()
726                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
727                     .join();

728         }
729     }
730 
731     /*
732      * Ensures authentication succeeds when an `Authorization` header is explicitly set.
733      */
734     @Test
735     public void explicitAuthenticate() throws IOException  {
736         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
737             server.open();
738 
739             String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
740                     (USERNAME + &quot;:&quot; + PASSWORD).getBytes(UTF_8));
741 
742             var webSocket = newBuilder()
743                     .proxy(NO_PROXY).build()
744                     .newWebSocketBuilder()
745                     .header(&quot;Authorization&quot;, hv)
746                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
747                     .join();

748         }
749     }
750 
751     /*
752      * Ensures authentication does not succeed when no authenticator is present.
753      */
754     @Test
755     public void failNoAuthenticator() throws IOException  {
756         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
757             server.open();
758 
759             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
760                     .proxy(NO_PROXY).build()
761                     .newWebSocketBuilder()
762                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
763 
764             try {
765                 var webSocket = cf.join();

766                 fail(&quot;Expected exception not thrown&quot;);
767             } catch (CompletionException expected) {
768                 WebSocketHandshakeException e = (WebSocketHandshakeException)expected.getCause();
769                 HttpResponse&lt;?&gt; response = e.getResponse();
770                 assertEquals(response.statusCode(), 401);
771             }
772         }
773     }
774 
775     /*
776      * Ensures authentication does not succeed when the authenticator presents
777      * unauthorized credentials.
778      */
779     @Test
780     public void failBadCredentials() throws IOException  {
781         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
782             server.open();
783 
784             Authenticator authenticator = new Authenticator() {
785                 @Override protected PasswordAuthentication getPasswordAuthentication() {
<span class="line-modified">786                     return new PasswordAuthentication(&quot;BAD&quot;+USERNAME, &quot;&quot;.toCharArray());</span>
787                 }
788             };
789 
790             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
791                     .proxy(NO_PROXY)
792                     .authenticator(authenticator)
793                     .build()
794                     .newWebSocketBuilder()
795                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
796 
797             try {
798                 var webSocket = cf.join();

799                 fail(&quot;Expected exception not thrown&quot;);
800             } catch (CompletionException expected) {
801                 System.out.println(&quot;caught expected exception:&quot; + expected);
802             }
803         }
804     }





805 }
</pre>
</td>
<td>
<hr />
<pre>
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8217429
 27  * @build DummyWebSocketServer
 28  * @run testng/othervm
 29  *       WebSocketTest
 30  */
 31 

 32 import org.testng.annotations.DataProvider;
 33 import org.testng.annotations.Test;
 34 
 35 import java.io.IOException;
 36 import java.net.Authenticator;
 37 import java.net.PasswordAuthentication;
 38 import java.net.http.HttpResponse;
 39 import java.net.http.WebSocket;
 40 import java.net.http.WebSocketHandshakeException;
 41 import java.nio.ByteBuffer;
 42 import java.nio.charset.StandardCharsets;
 43 import java.util.ArrayList;
 44 import java.util.Base64;
 45 import java.util.List;
 46 import java.util.concurrent.CompletableFuture;
 47 import java.util.concurrent.CompletionException;
 48 import java.util.concurrent.CompletionStage;
 49 import java.util.concurrent.TimeUnit;
 50 import java.util.concurrent.atomic.AtomicBoolean;
 51 import java.util.function.Function;
</pre>
<hr />
<pre>
 55 import static java.net.http.HttpClient.Builder.NO_PROXY;
 56 import static java.net.http.HttpClient.newBuilder;
 57 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 58 import static java.nio.charset.StandardCharsets.UTF_8;
 59 import static org.testng.Assert.assertEquals;
 60 import static org.testng.Assert.assertThrows;
 61 import static org.testng.Assert.fail;
 62 
 63 public class WebSocketTest {
 64 
 65     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 66     private static final Class&lt;IllegalStateException&gt; ISE = IllegalStateException.class;
 67     private static final Class&lt;IOException&gt; IOE = IOException.class;
 68 
 69     /* shortcut */
 70     private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
 71                                     CompletionStage&lt;?&gt; stage) {
 72         Support.assertCompletesExceptionally(clazz, stage);
 73     }
 74 












 75     @Test
 76     public void illegalArgument() throws IOException {
<span class="line-modified"> 77         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified"> 78             server.open();</span>
<span class="line-modified"> 79             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified"> 80                     .newWebSocketBuilder()</span>
<span class="line-modified"> 81                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified"> 82                     .join();</span>
<span class="line-modified"> 83             try {</span>
<span class="line-modified"> 84                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 85                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 86                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified"> 87                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified"> 88                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified"> 89 </span>
<span class="line-modified"> 90                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 91                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 92                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified"> 93                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified"> 94                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified"> 95 </span>
<span class="line-modified"> 96                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified"> 97                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified"> 98                 assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified"> 99                 assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">100 </span>
<span class="line-modified">101                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">102                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">103                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">104                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">105                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">106                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">107                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">108                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">109 </span>
<span class="line-modified">110                 assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">111                 assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">112                 assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">113                 assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">114                 assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">115                 assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">116                 assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">117                 assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">118                 assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">119                 assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">120                 assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">121                 assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">122                 assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">123                 assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">124                 assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">125                 assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">126                 assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">127                 assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">128                 assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">129                 assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">130                 assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">131                 assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">132 </span>
<span class="line-modified">133                 assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">134                 assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">135                 assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">136                 assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">137 </span>
<span class="line-modified">138             } finally {</span>
<span class="line-added">139                 webSocket.abort();</span>
<span class="line-added">140             }</span>
<span class="line-added">141         }</span>
142     }
143 
144     @Test
145     public void partialBinaryThenText() throws IOException {
<span class="line-modified">146         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">147             server.open();</span>
<span class="line-modified">148             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">149                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">150                     .join();</span>
<span class="line-modified">151             try {</span>
<span class="line-modified">152                 webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">153                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">154                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">155                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">156                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">157                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-added">158             } finally {</span>
<span class="line-added">159                 webSocket.abort();</span>
<span class="line-added">160             }</span>
<span class="line-added">161         }</span>
162     }
163 
164     @Test
165     public void partialTextThenBinary() throws IOException {
<span class="line-modified">166         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">167             server.open();</span>
<span class="line-modified">168             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">169                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">170                     .join();</span>
<span class="line-modified">171             try {</span>
<span class="line-modified">172                 webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">173                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">174                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">175                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">176                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">177                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">178             } finally {</span>
<span class="line-added">179                 webSocket.abort();</span>
<span class="line-added">180             }</span>
<span class="line-added">181         }</span>
182     }
183 
184     @Test
185     public void sendMethodsThrowIOE1() throws IOException {
<span class="line-modified">186         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">187             server.open();</span>
<span class="line-modified">188             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">189                     .newWebSocketBuilder()</span>
<span class="line-modified">190                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">191                     .join();</span>
<span class="line-modified">192             try {</span>
<span class="line-modified">193                 webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">194 </span>
<span class="line-modified">195                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">196 </span>
<span class="line-modified">197                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">198                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">199                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">200                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">201                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">202                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">203                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">204                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">205 </span>
<span class="line-modified">206                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">207                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">208                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">209                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">210 </span>
<span class="line-modified">211                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">212                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">213                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">214                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">215             } finally {</span>
<span class="line-modified">216                 webSocket.abort();</span>
<span class="line-added">217             }</span>
<span class="line-added">218         }</span>
219     }
220 
221     @DataProvider(name = &quot;sequence&quot;)
222     public Object[][] data1() {
223         int[] CLOSE = {
224                 0x81, 0x00, // &quot;&quot;
225                 0x82, 0x00, // []
226                 0x89, 0x00, // &lt;PING&gt;
227                 0x8a, 0x00, // &lt;PONG&gt;
228                 0x88, 0x00, // &lt;CLOSE&gt;
229         };
230         int[] ERROR = {
231                 0x81, 0x00, // &quot;&quot;
232                 0x82, 0x00, // []
233                 0x89, 0x00, // &lt;PING&gt;
234                 0x8a, 0x00, // &lt;PONG&gt;
235                 0x8b, 0x00, // 0xB control frame (causes an error)
236         };
237         return new Object[][]{
238                 {CLOSE, 1},
239                 {CLOSE, 3},
240                 {CLOSE, 4},
241                 {CLOSE, Long.MAX_VALUE},
242                 {ERROR, 1},
243                 {ERROR, 3},
244                 {ERROR, 4},
245                 {ERROR, Long.MAX_VALUE},
246         };
247     }
248 
249     @Test(dataProvider = &quot;sequence&quot;)
250     public void listenerSequentialOrder(int[] binary, long requestSize)
251             throws IOException
252     {
<span class="line-added">253         try (var server = Support.serverWithCannedData(binary)) {</span>
<span class="line-added">254             server.open();</span>
255 
<span class="line-modified">256             CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>



257 
<span class="line-modified">258             MockListener listener = new MockListener(requestSize) {</span>
259 
<span class="line-modified">260                 final AtomicBoolean guard = new AtomicBoolean();</span>
261 
<span class="line-modified">262                 private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">263                     if (guard.getAndSet(true)) {</span>






264                         violation.completeExceptionally(new RuntimeException());
265                     }
<span class="line-added">266                     try {</span>
<span class="line-added">267                         return action.get();</span>
<span class="line-added">268                     } finally {</span>
<span class="line-added">269                         if (!guard.getAndSet(false)) {</span>
<span class="line-added">270                             violation.completeExceptionally(new RuntimeException());</span>
<span class="line-added">271                         }</span>
<span class="line-added">272                     }</span>
273                 }









274 
<span class="line-modified">275                 @Override</span>
<span class="line-modified">276                 public void onOpen(WebSocket webSocket) {</span>
<span class="line-modified">277                     checkRunExclusively(() -&gt; {</span>
<span class="line-modified">278                         super.onOpen(webSocket);</span>
<span class="line-modified">279                         return null;</span>
<span class="line-modified">280                     });</span>
<span class="line-modified">281                 }</span>















282 
<span class="line-modified">283                 @Override</span>
<span class="line-modified">284                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">285                                                  CharSequence data,</span>
<span class="line-modified">286                                                  boolean last) {</span>
<span class="line-modified">287                     return checkRunExclusively(</span>
<span class="line-modified">288                             () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-added">289                 }</span>
290 
<span class="line-modified">291                 @Override</span>
<span class="line-modified">292                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">293                                                    ByteBuffer data,</span>
<span class="line-modified">294                                                    boolean last) {</span>
<span class="line-modified">295                     return checkRunExclusively(</span>
<span class="line-modified">296                             () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-modified">297                 }</span>
298 
<span class="line-modified">299                 @Override</span>
<span class="line-modified">300                 public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-modified">301                                                  ByteBuffer message) {</span>
<span class="line-modified">302                     return checkRunExclusively(</span>
<span class="line-modified">303                             () -&gt; super.onPing(webSocket, message));</span>
<span class="line-modified">304                 }</span>


305 
<span class="line-modified">306                 @Override</span>
<span class="line-modified">307                 public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">308                                                  ByteBuffer message) {</span>
<span class="line-added">309                     return checkRunExclusively(</span>
<span class="line-added">310                             () -&gt; super.onPong(webSocket, message));</span>
<span class="line-added">311                 }</span>
312 
<span class="line-added">313                 @Override</span>
<span class="line-added">314                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">315                                                   int statusCode,</span>
<span class="line-added">316                                                   String reason) {</span>
<span class="line-added">317                     return checkRunExclusively(</span>
<span class="line-added">318                             () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-added">319                 }</span>
320 
<span class="line-modified">321                 @Override</span>
<span class="line-modified">322                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">323                     checkRunExclusively(() -&gt; {</span>
<span class="line-added">324                         super.onError(webSocket, error);</span>
<span class="line-added">325                         return null;</span>
<span class="line-added">326                     });</span>
<span class="line-added">327                 }</span>
<span class="line-added">328             };</span>
329 
<span class="line-modified">330             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">331                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">332                     .join();</span>
<span class="line-added">333             try {</span>
<span class="line-added">334                 listener.invocations();</span>
<span class="line-added">335                 violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-added">336                 violation.join();</span>
<span class="line-added">337             } finally {</span>
<span class="line-added">338                 webSocket.abort();</span>
<span class="line-added">339             }</span>
<span class="line-added">340         }</span>
341     }
342 
343     @Test
344     public void sendMethodsThrowIOE2() throws Exception {
<span class="line-modified">345         try (var server = Support.serverWithCannedData(0x88, 0x00)) {</span>
<span class="line-modified">346             server.open();</span>






































347 
<span class="line-modified">348             CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">349             CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">350 </span>
<span class="line-modified">351             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-added">352                 @Override</span>
<span class="line-added">353                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">354                                                   int statusCode,</span>
<span class="line-added">355                                                   String reason) {</span>
<span class="line-added">356                     System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-added">357                     onCloseCalled.complete(null);</span>
<span class="line-added">358                     return canClose;</span>
<span class="line-added">359                 }</span>
360 
<span class="line-modified">361                 @Override</span>
<span class="line-modified">362                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">363                     System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-modified">364                     onCloseCalled.completeExceptionally(error);</span>
<span class="line-added">365                 }</span>
<span class="line-added">366             };</span>
367 
<span class="line-modified">368             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">369                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">370                     .join();</span>
<span class="line-added">371             try {</span>
<span class="line-added">372                 onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-added">373                 canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-added">374                 TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-added">375 </span>
<span class="line-added">376                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-added">377 </span>
<span class="line-added">378                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-added">379                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-added">380                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-added">381                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-added">382                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-added">383                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-added">384                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-added">385                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-added">386 </span>
<span class="line-added">387                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-added">388                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-added">389                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-added">390                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-added">391 </span>
<span class="line-added">392                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-added">393                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-added">394                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-added">395                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-added">396             } finally {</span>
<span class="line-added">397                 webSocket.abort();</span>
<span class="line-added">398             }</span>
<span class="line-added">399         }</span>
400     }
401 
402     // Used to verify a server requiring Authentication
403     private static final String USERNAME = &quot;chegar&quot;;
404     private static final String PASSWORD = &quot;a1b2c3&quot;;
405 
406     static class WSAuthenticator extends Authenticator {
407         @Override
408         protected PasswordAuthentication getPasswordAuthentication() {
409             return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
410         }
411     }
412 
413     static final Function&lt;int[],DummyWebSocketServer&gt; SERVER_WITH_CANNED_DATA =
414         new Function&lt;&gt;() {
415             @Override public DummyWebSocketServer apply(int[] data) {
416                 return Support.serverWithCannedData(data); }
417             @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
418         };
419 
</pre>
<hr />
<pre>
443                 .collect(Collectors.toList());
444         int[] binary = new int[]{
445                 0x82, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // [alpha]
446                 0x02, 0x02, 0x62, 0x65,                   // [be
447                 0x80, 0x02, 0x74, 0x61,                   // ta]
448                 0x02, 0x01, 0x67,                         // [g
449                 0x00, 0x01, 0x61,                         // a
450                 0x00, 0x00,                               //
451                 0x00, 0x00,                               //
452                 0x00, 0x01, 0x6d,                         // m
453                 0x00, 0x01, 0x6d,                         // m
454                 0x80, 0x01, 0x61,                         // a]
455                 0x8a, 0x00,                               // &lt;PONG&gt;
456                 0x02, 0x04, 0x64, 0x65, 0x6c, 0x74,       // [delt
457                 0x00, 0x01, 0x61,                         // a
458                 0x80, 0x00,                               // ]
459                 0x88, 0x00                                // &lt;CLOSE&gt;
460         };
461         CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
462 
<span class="line-modified">463         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">464             server.open();</span>
465 
<span class="line-modified">466             WebSocket.Listener listener = new WebSocket.Listener() {</span>
467 
<span class="line-modified">468                 List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">469                 ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
470 
<span class="line-modified">471                 @Override</span>
<span class="line-modified">472                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">473                                                    ByteBuffer message,</span>
<span class="line-modified">474                                                    boolean last) {</span>
<span class="line-modified">475                     System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">476                     webSocket.request(1);</span>
477 
<span class="line-modified">478                     append(message);</span>
<span class="line-modified">479                     if (last) {</span>
<span class="line-modified">480                         buffer.flip();</span>
<span class="line-modified">481                         byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">482                         buffer.get(bytes);</span>
<span class="line-modified">483                         buffer.clear();</span>
<span class="line-modified">484                         processWholeBinary(bytes);</span>
<span class="line-added">485                     }</span>
<span class="line-added">486                     return null;</span>
487                 }


488 
<span class="line-modified">489                 private void append(ByteBuffer message) {</span>
<span class="line-modified">490                     if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">491                         assert message.remaining() &gt; 0;</span>
<span class="line-modified">492                         int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">493                         ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">494                         b.put(buffer.flip());</span>
<span class="line-modified">495                         buffer = b;</span>
<span class="line-added">496                     }</span>
<span class="line-added">497                     buffer.put(message);</span>
498                 }


499 
<span class="line-modified">500                 private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">501                     String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">502                     System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">503                     collectedBytes.add(bytes);</span>
<span class="line-modified">504                 }</span>














505 
<span class="line-modified">506                 @Override</span>
<span class="line-modified">507                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">508                                                   int statusCode,</span>
<span class="line-modified">509                                                   String reason) {</span>
<span class="line-modified">510                     actual.complete(collectedBytes);</span>
<span class="line-modified">511                     return null;</span>
<span class="line-added">512                 }</span>
513 
<span class="line-modified">514                 @Override</span>
<span class="line-modified">515                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">516                     actual.completeExceptionally(error);</span>
<span class="line-added">517                 }</span>
<span class="line-added">518             };</span>
519 
<span class="line-modified">520             var webSocket = newBuilder()</span>
<span class="line-added">521                     .proxy(NO_PROXY)</span>
<span class="line-added">522                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">523                     .build().newWebSocketBuilder()</span>
<span class="line-added">524                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">525                     .join();</span>
<span class="line-added">526             try {</span>
<span class="line-added">527                 List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-added">528                 assertEquals(a, expected);</span>
<span class="line-added">529             } finally {</span>
<span class="line-added">530                 webSocket.abort();</span>
<span class="line-added">531             }</span>
<span class="line-added">532         }</span>
533     }
534 
535     @Test(dataProvider = &quot;servers&quot;)
536     public void simpleAggregatingTextMessages
537             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
538         throws IOException
539     {
540         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
541 
542         int[] binary = new int[]{
543                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
544                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
545                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
546                 0x01, 0x01, 0x67,                         // &quot;g
547                 0x00, 0x01, 0x61,                         // a
548                 0x00, 0x00,                               //
549                 0x00, 0x00,                               //
550                 0x00, 0x01, 0x6d,                         // m
551                 0x00, 0x01, 0x6d,                         // m
552                 0x80, 0x01, 0x61,                         // a&quot;
553                 0x8a, 0x00,                               // &lt;PONG&gt;
554                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
555                 0x00, 0x01, 0x61,                         // a
556                 0x80, 0x00,                               // &quot;
557                 0x88, 0x00                                // &lt;CLOSE&gt;
558         };
559         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
560 
<span class="line-modified">561         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">562             server.open();</span>




















563 
<span class="line-modified">564             WebSocket.Listener listener = new WebSocket.Listener() {</span>



565 
<span class="line-modified">566                 List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-modified">567                 StringBuilder text = new StringBuilder();</span>





568 
<span class="line-modified">569                 @Override</span>
<span class="line-modified">570                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">571                                                  CharSequence message,</span>
<span class="line-modified">572                                                  boolean last) {</span>
<span class="line-modified">573                     System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-added">574                     webSocket.request(1);</span>
<span class="line-added">575                     text.append(message);</span>
<span class="line-added">576                     if (last) {</span>
<span class="line-added">577                         String str = text.toString();</span>
<span class="line-added">578                         text.setLength(0);</span>
<span class="line-added">579                         processWholeText(str);</span>
<span class="line-added">580                     }</span>
<span class="line-added">581                     return null;</span>
<span class="line-added">582                 }</span>
583 
<span class="line-modified">584                 private void processWholeText(String string) {</span>
<span class="line-modified">585                     System.out.println(string);</span>
<span class="line-modified">586                     collectedStrings.add(string);</span>
<span class="line-modified">587                 }</span>


588 
<span class="line-modified">589                 @Override</span>
<span class="line-modified">590                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">591                                                   int statusCode,</span>
<span class="line-added">592                                                   String reason) {</span>
<span class="line-added">593                     actual.complete(collectedStrings);</span>
<span class="line-added">594                     return null;</span>
<span class="line-added">595                 }</span>
596 
<span class="line-modified">597                 @Override</span>
<span class="line-added">598                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">599                     actual.completeExceptionally(error);</span>
<span class="line-added">600                 }</span>
<span class="line-added">601             };</span>
<span class="line-added">602 </span>
<span class="line-added">603             var webSocket = newBuilder()</span>
<span class="line-added">604                     .proxy(NO_PROXY)</span>
<span class="line-added">605                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">606                     .build().newWebSocketBuilder()</span>
<span class="line-added">607                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">608                     .join();</span>
<span class="line-added">609             try {</span>
<span class="line-added">610                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">611                 assertEquals(a, expected);</span>
<span class="line-added">612             } finally {</span>
<span class="line-added">613                 webSocket.abort();</span>
<span class="line-added">614             }</span>
<span class="line-added">615         }</span>
616     }
617 
618     /*
619      * Exercises the scenario where requests for more messages are made prior to
620      * completing the returned CompletionStage instances.
621      */
622     @Test(dataProvider = &quot;servers&quot;)
623     public void aggregatingTextMessages
624         (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
625         throws IOException
626     {
627         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
628 
629         int[] binary = new int[]{
630                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
631                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
632                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
633                 0x01, 0x01, 0x67,                         // &quot;g
634                 0x00, 0x01, 0x61,                         // a
635                 0x00, 0x00,                               //
636                 0x00, 0x00,                               //
637                 0x00, 0x01, 0x6d,                         // m
638                 0x00, 0x01, 0x6d,                         // m
639                 0x80, 0x01, 0x61,                         // a&quot;
640                 0x8a, 0x00,                               // &lt;PONG&gt;
641                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
642                 0x00, 0x01, 0x61,                         // a
643                 0x80, 0x00,                               // &quot;
644                 0x88, 0x00                                // &lt;CLOSE&gt;
645         };
646         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
647 
<span class="line-modified">648         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">649             server.open();</span>





































650 
<span class="line-modified">651             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-modified">652 </span>
<span class="line-modified">653                 List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-modified">654                 /*</span>
<span class="line-added">655                  * A CompletableFuture which will complete once the current</span>
<span class="line-added">656                  * message has been fully assembled. Until then the listener</span>
<span class="line-added">657                  * returns this instance for every call.</span>
<span class="line-added">658                  */</span>
<span class="line-added">659                 CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">660                 List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-added">661 </span>
<span class="line-added">662                 @Override</span>
<span class="line-added">663                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-added">664                                                  CharSequence message,</span>
<span class="line-added">665                                                  boolean last) {</span>
<span class="line-added">666                     parts.add(message);</span>
<span class="line-added">667                     if (!last) {</span>
<span class="line-added">668                         webSocket.request(1);</span>
<span class="line-added">669                     } else {</span>
<span class="line-added">670                         this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-added">671                         CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-added">672                         processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-added">673                         currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">674                         parts.clear();</span>
<span class="line-added">675                         return refCf;</span>
<span class="line-added">676                     }</span>
<span class="line-added">677                     return currentCf;</span>
<span class="line-added">678                 }</span>
679 
<span class="line-modified">680                 @Override</span>
<span class="line-modified">681                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">682                                                   int statusCode,</span>
<span class="line-modified">683                                                   String reason) {</span>
<span class="line-modified">684                     actual.complete(collected);</span>
<span class="line-modified">685                     return null;</span>
<span class="line-modified">686                 }</span>



687 
<span class="line-modified">688                 @Override</span>
<span class="line-modified">689                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">690                     actual.completeExceptionally(error);</span>
<span class="line-modified">691                 }</span>


692 
<span class="line-modified">693                 public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">694                                                 CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-added">695                     StringBuilder b = new StringBuilder();</span>
<span class="line-added">696                     data.forEach(b::append);</span>
<span class="line-added">697                     String s = b.toString();</span>
<span class="line-added">698                     System.out.println(s);</span>
<span class="line-added">699                     cf.complete(null);</span>
<span class="line-added">700                     collected.add(s);</span>
<span class="line-added">701                 }</span>
<span class="line-added">702             };</span>
703 
<span class="line-modified">704             var webSocket = newBuilder()</span>
<span class="line-added">705                     .proxy(NO_PROXY)</span>
<span class="line-added">706                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">707                     .build().newWebSocketBuilder()</span>
<span class="line-added">708                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">709                     .join();</span>
<span class="line-added">710             try {</span>
<span class="line-added">711                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">712                 assertEquals(a, expected);</span>
<span class="line-added">713             } finally {</span>
<span class="line-added">714                 webSocket.abort();</span>
<span class="line-added">715             }</span>
<span class="line-added">716         }</span>
717     }
718 
719     // -- authentication specific tests
720 
721     /*
722      * Ensures authentication succeeds when an Authenticator set on client builder.
723      */
724     @Test
725     public void clientAuthenticate() throws IOException  {
726         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)){
727             server.open();
728 
729             var webSocket = newBuilder()
730                     .proxy(NO_PROXY)
731                     .authenticator(new WSAuthenticator())
732                     .build()
733                     .newWebSocketBuilder()
734                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
735                     .join();
<span class="line-added">736             webSocket.abort();</span>
737         }
738     }
739 
740     /*
741      * Ensures authentication succeeds when an `Authorization` header is explicitly set.
742      */
743     @Test
744     public void explicitAuthenticate() throws IOException  {
745         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
746             server.open();
747 
748             String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
749                     (USERNAME + &quot;:&quot; + PASSWORD).getBytes(UTF_8));
750 
751             var webSocket = newBuilder()
752                     .proxy(NO_PROXY).build()
753                     .newWebSocketBuilder()
754                     .header(&quot;Authorization&quot;, hv)
755                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
756                     .join();
<span class="line-added">757             webSocket.abort();</span>
758         }
759     }
760 
761     /*
762      * Ensures authentication does not succeed when no authenticator is present.
763      */
764     @Test
765     public void failNoAuthenticator() throws IOException  {
766         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
767             server.open();
768 
769             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
770                     .proxy(NO_PROXY).build()
771                     .newWebSocketBuilder()
772                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
773 
774             try {
775                 var webSocket = cf.join();
<span class="line-added">776                 silentAbort(webSocket);</span>
777                 fail(&quot;Expected exception not thrown&quot;);
778             } catch (CompletionException expected) {
779                 WebSocketHandshakeException e = (WebSocketHandshakeException)expected.getCause();
780                 HttpResponse&lt;?&gt; response = e.getResponse();
781                 assertEquals(response.statusCode(), 401);
782             }
783         }
784     }
785 
786     /*
787      * Ensures authentication does not succeed when the authenticator presents
788      * unauthorized credentials.
789      */
790     @Test
791     public void failBadCredentials() throws IOException  {
792         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
793             server.open();
794 
795             Authenticator authenticator = new Authenticator() {
796                 @Override protected PasswordAuthentication getPasswordAuthentication() {
<span class="line-modified">797                     return new PasswordAuthentication(&quot;BAD&quot; + USERNAME, &quot;&quot;.toCharArray());</span>
798                 }
799             };
800 
801             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
802                     .proxy(NO_PROXY)
803                     .authenticator(authenticator)
804                     .build()
805                     .newWebSocketBuilder()
806                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
807 
808             try {
809                 var webSocket = cf.join();
<span class="line-added">810                 silentAbort(webSocket);</span>
811                 fail(&quot;Expected exception not thrown&quot;);
812             } catch (CompletionException expected) {
813                 System.out.println(&quot;caught expected exception:&quot; + expected);
814             }
815         }
816     }
<span class="line-added">817     private static void silentAbort(WebSocket ws) {</span>
<span class="line-added">818         try {</span>
<span class="line-added">819             ws.abort();</span>
<span class="line-added">820         } catch (Throwable t) { }</span>
<span class="line-added">821     }</span>
822 }
</pre>
</td>
</tr>
</table>
<center><a href="WebSocketProxyTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="security/httpclient.policy.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>