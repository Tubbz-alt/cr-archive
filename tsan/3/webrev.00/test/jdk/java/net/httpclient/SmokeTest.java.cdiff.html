<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/SmokeTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ShortResponseBody.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="http2/RedirectTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/SmokeTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 28,11 ***</span>
   *          java.logging
   *          jdk.httpserver
   * @library /test/lib /
   * @build jdk.test.lib.net.SimpleSSLContext ProxyServer
   * @compile ../../../com/sun/net/httpserver/LogFilter.java
<span class="line-removed">-  * @compile ../../../com/sun/net/httpserver/EchoHandler.java</span>
   * @compile ../../../com/sun/net/httpserver/FileServerHandler.java
   * @run main/othervm
   *      -Djdk.internal.httpclient.debug=true
   *      -Djdk.httpclient.HttpClient.log=errors,ssl,trace
   *      SmokeTest
<span class="line-new-header">--- 28,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 48,11 ***</span>
<span class="line-new-header">--- 47,14 ---</span>
  import com.sun.net.httpserver.HttpsServer;
  
  import java.net.InetAddress;
  import java.net.Proxy;
  import java.net.SocketAddress;
<span class="line-added">+ import java.net.http.HttpHeaders;</span>
<span class="line-added">+ import java.nio.charset.StandardCharsets;</span>
  import java.util.Collections;
<span class="line-added">+ import java.util.Optional;</span>
  import java.util.Set;
  import java.util.concurrent.atomic.AtomicInteger;
  import java.net.InetSocketAddress;
  import java.net.PasswordAuthentication;
  import java.net.ProxySelector;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,10 ***</span>
<span class="line-new-header">--- 135,26 ---</span>
      final static String smallFilename = &quot;/files/smallfile.txt&quot;;
      static Path midSizedFile;
      static Path smallFile;
      static String fileroot;
  
<span class="line-added">+     static class HttpEchoHandler implements HttpHandler {</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public void handle(HttpExchange exchange) throws IOException {</span>
<span class="line-added">+             try (InputStream is = exchange.getRequestBody();</span>
<span class="line-added">+                  OutputStream os = exchange.getResponseBody()) {</span>
<span class="line-added">+                 byte[] bytes = is.readAllBytes();</span>
<span class="line-added">+                 long responseLength = bytes.length == 0 ? -1 : bytes.length;</span>
<span class="line-added">+                 boolean fixedLength = &quot;yes&quot;.equals(exchange.getRequestHeaders()</span>
<span class="line-added">+                         .getFirst(&quot;XFixed&quot;));</span>
<span class="line-added">+                 exchange.sendResponseHeaders(200, fixedLength ? responseLength : 0);</span>
<span class="line-added">+                 os.write(bytes);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static String getFileContent(String path) throws IOException {
          FileInputStream fis = new FileInputStream(path);
          byte[] buf = new byte[2000];
          StringBuilder sb = new StringBuilder();
          int n;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 255,10 ***</span>
<span class="line-new-header">--- 273,12 ---</span>
  
          HttpRequest request = builder.build();
  
          HttpResponse&lt;String&gt; response = client.send(request, BodyHandlers.ofString());
  
<span class="line-added">+         checkResponseContentLength(response.headers(), fixedLen);</span>
<span class="line-added">+ </span>
          String body = response.body();
          if (!body.equals(&quot;This is foo.txt\r\n&quot;)) {
              throw new RuntimeException(&quot;Did not get expected body: &quot;
                  + &quot;\n\t expected \&quot;This is foo.txt\\r\\n\&quot;&quot;
                  + &quot;\n\t received \&quot;&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 502,10 ***</span>
<span class="line-new-header">--- 522,12 ---</span>
  
          HttpRequest request = builder.build();
  
          HttpResponse&lt;String&gt; response = client.send(request, BodyHandlers.ofString());
  
<span class="line-added">+         checkResponseContentLength(response.headers(), fixedLen);</span>
<span class="line-added">+ </span>
          String body = response.body();
  
          if (!body.equals(requestBody)) {
              throw new RuntimeException(
                      &quot;Body mismatch: expected [&quot; + body + &quot;], got [&quot; + body + &quot;]&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 527,10 ***</span>
<span class="line-new-header">--- 549,12 ---</span>
  
          HttpRequest request = builder.build();
  
          HttpResponse&lt;String&gt; response = client.send(request, BodyHandlers.ofString());
  
<span class="line-added">+         checkResponseContentLength(response.headers(), fixedLen);</span>
<span class="line-added">+ </span>
          if (response.statusCode() != 200) {
              throw new RuntimeException(
                      &quot;Expected 200, got [ &quot; + response.statusCode() + &quot; ]&quot;);
          }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 692,11 ***</span>
          CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; cf =
                  client.sendAsync(request, BodyHandlers.ofString());
  
          try {
              HttpResponse&lt;String&gt; response = cf.join();
<span class="line-modified">!             throw new RuntimeException(&quot;Exepected Completion Exception&quot;);</span>
          } catch (CompletionException e) {
              //System.out.println(e);
          }
  
          System.out.printf(&quot; (Calls %d) &quot;, handler.count());
<span class="line-new-header">--- 716,11 ---</span>
          CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; cf =
                  client.sendAsync(request, BodyHandlers.ofString());
  
          try {
              HttpResponse&lt;String&gt; response = cf.join();
<span class="line-modified">!             throw new RuntimeException(&quot;Expected Completion Exception&quot;);</span>
          } catch (CompletionException e) {
              //System.out.println(e);
          }
  
          System.out.printf(&quot; (Calls %d) &quot;, handler.count());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 737,16 ***</span>
          s2 = HttpsServer.create (addr, 0);
          HttpHandler h = new FileServerHandler(root);
  
          HttpContext c1 = s1.createContext(&quot;/files&quot;, h);
          HttpContext c2 = s2.createContext(&quot;/files&quot;, h);
<span class="line-modified">!         HttpContext c3 = s1.createContext(&quot;/echo&quot;, new EchoHandler());</span>
          redirectHandler = new RedirectHandler(&quot;/redirect&quot;);
          redirectHandlerSecure = new RedirectHandler(&quot;/redirect&quot;);
          HttpContext c4 = s1.createContext(&quot;/redirect&quot;, redirectHandler);
          HttpContext c41 = s2.createContext(&quot;/redirect&quot;, redirectHandlerSecure);
<span class="line-modified">!         HttpContext c5 = s2.createContext(&quot;/echo&quot;, new EchoHandler());</span>
          HttpContext c6 = s1.createContext(&quot;/keepalive&quot;, new KeepAliveHandler());
          redirectErrorHandler = new RedirectErrorHandler(&quot;/redirecterror&quot;);
          redirectErrorHandlerSecure = new RedirectErrorHandler(&quot;/redirecterror&quot;);
          HttpContext c7 = s1.createContext(&quot;/redirecterror&quot;, redirectErrorHandler);
          HttpContext c71 = s2.createContext(&quot;/redirecterror&quot;, redirectErrorHandlerSecure);
<span class="line-new-header">--- 761,16 ---</span>
          s2 = HttpsServer.create (addr, 0);
          HttpHandler h = new FileServerHandler(root);
  
          HttpContext c1 = s1.createContext(&quot;/files&quot;, h);
          HttpContext c2 = s2.createContext(&quot;/files&quot;, h);
<span class="line-modified">!         HttpContext c3 = s1.createContext(&quot;/echo&quot;, new HttpEchoHandler());</span>
          redirectHandler = new RedirectHandler(&quot;/redirect&quot;);
          redirectHandlerSecure = new RedirectHandler(&quot;/redirect&quot;);
          HttpContext c4 = s1.createContext(&quot;/redirect&quot;, redirectHandler);
          HttpContext c41 = s2.createContext(&quot;/redirect&quot;, redirectHandlerSecure);
<span class="line-modified">!         HttpContext c5 = s2.createContext(&quot;/echo&quot;, new HttpEchoHandler());</span>
          HttpContext c6 = s1.createContext(&quot;/keepalive&quot;, new KeepAliveHandler());
          redirectErrorHandler = new RedirectErrorHandler(&quot;/redirecterror&quot;);
          redirectErrorHandlerSecure = new RedirectErrorHandler(&quot;/redirecterror&quot;);
          HttpContext c7 = s1.createContext(&quot;/redirecterror&quot;, redirectErrorHandler);
          HttpContext c71 = s2.createContext(&quot;/redirecterror&quot;, redirectErrorHandlerSecure);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 774,23 ***</span>
          proxy = new ProxyServer(0, false);
          proxyPort = proxy.getPort();
          System.out.println(&quot;Proxy port = &quot; + proxyPort);
      }
  
      static class RedirectHandler implements HttpHandler {
          private final String root;
          private volatile int count = 0;
  
          RedirectHandler(String root) {
              this.root = root;
          }
  
          @Override
          public synchronized void handle(HttpExchange t) throws IOException {
<span class="line-removed">-             byte[] buf = new byte[2048];</span>
              try (InputStream is = t.getRequestBody()) {
<span class="line-modified">!                 while (is.read(buf) != -1) ;</span>
              }
  
              Headers responseHeaders = t.getResponseHeaders();
  
              if (count++ &lt; 1) {
<span class="line-new-header">--- 798,35 ---</span>
          proxy = new ProxyServer(0, false);
          proxyPort = proxy.getPort();
          System.out.println(&quot;Proxy port = &quot; + proxyPort);
      }
  
<span class="line-added">+     static void checkResponseContentLength(HttpHeaders responseHeaders, boolean fixedLen) {</span>
<span class="line-added">+         Optional&lt;String&gt; transferEncoding = responseHeaders.firstValue(&quot;transfer-encoding&quot;);</span>
<span class="line-added">+         Optional&lt;String&gt; contentLength = responseHeaders.firstValue(&quot;content-length&quot;);</span>
<span class="line-added">+         if (fixedLen) {</span>
<span class="line-added">+             assert contentLength.isPresent();</span>
<span class="line-added">+             assert !transferEncoding.isPresent();</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             assert !contentLength.isPresent();</span>
<span class="line-added">+             assert transferEncoding.isPresent();</span>
<span class="line-added">+             assert &quot;chunked&quot;.equals(transferEncoding.get());</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static class RedirectHandler implements HttpHandler {
          private final String root;
          private volatile int count = 0;
  
          RedirectHandler(String root) {
              this.root = root;
          }
  
          @Override
          public synchronized void handle(HttpExchange t) throws IOException {
              try (InputStream is = t.getRequestBody()) {
<span class="line-modified">!                 is.readAllBytes();</span>
              }
  
              Headers responseHeaders = t.getResponseHeaders();
  
              if (count++ &lt; 1) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1008,17 ***</span>
                          + remotePort + &quot; not in &quot; + portSet);
                  result = &quot;Error &quot; + Integer.toString(n);
                  System.out.println(result);
              }
          }
<span class="line-removed">-         byte[] buf = new byte[2048];</span>
  
          try (InputStream is = t.getRequestBody()) {
<span class="line-modified">!             while (is.read(buf) != -1) ;</span>
          }
          t.sendResponseHeaders(200, result.length());
          OutputStream o = t.getResponseBody();
<span class="line-modified">!         o.write(result.getBytes(&quot;US-ASCII&quot;));</span>
          t.close();
          nparallel.getAndDecrement();
      }
  }
<span class="line-new-header">--- 1044,16 ---</span>
                          + remotePort + &quot; not in &quot; + portSet);
                  result = &quot;Error &quot; + Integer.toString(n);
                  System.out.println(result);
              }
          }
  
          try (InputStream is = t.getRequestBody()) {
<span class="line-modified">!             is.readAllBytes();</span>
          }
          t.sendResponseHeaders(200, result.length());
          OutputStream o = t.getResponseBody();
<span class="line-modified">!         o.write(result.getBytes(StandardCharsets.UTF_8));</span>
          t.close();
          nparallel.getAndDecrement();
      }
  }
</pre>
<center><a href="ShortResponseBody.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="http2/RedirectTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>