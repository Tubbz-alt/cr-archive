<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/httpclient/BodySubscribersTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Basic test for the standard BodySubscribers default behavior
 27  * @bug 8225583
 28  * @run testng BodySubscribersTest
 29  */
 30 
 31 import java.net.http.HttpResponse.BodySubscriber;
 32 import java.nio.ByteBuffer;
 33 import java.nio.file.Path;
 34 import java.util.List;
 35 import java.util.concurrent.Flow;
 36 import java.util.function.Supplier;
 37 import org.testng.annotations.DataProvider;
 38 import org.testng.annotations.Test;
 39 import static java.lang.System.out;
 40 import static java.net.http.HttpResponse.BodySubscribers.*;
 41 import static java.nio.charset.StandardCharsets.UTF_8;
 42 import static java.nio.file.StandardOpenOption.CREATE;
 43 import static org.testng.Assert.assertTrue;
 44 import static org.testng.Assert.assertNotNull;
 45 import static org.testng.Assert.expectThrows;
 46 import static org.testng.Assert.fail;
 47 
 48 public class BodySubscribersTest {
 49 
 50     static final Class&lt;NullPointerException&gt; NPE = NullPointerException.class;
 51 
 52     // Supplier of BodySubscriber&lt;?&gt;, with a descriptive name
 53     static class BSSupplier implements Supplier&lt;BodySubscriber&lt;?&gt;&gt; {
 54         private final Supplier&lt;BodySubscriber&lt;?&gt;&gt; supplier;
 55         private final String name;
 56         private BSSupplier(Supplier&lt;BodySubscriber&lt;?&gt;&gt; supplier, String name) {
 57             this.supplier = supplier;
 58             this.name = name;
 59         }
 60         static BSSupplier create(String name, Supplier&lt;BodySubscriber&lt;?&gt;&gt; supplier) {
 61             return new BSSupplier(supplier, name);
 62         }
 63         @Override public BodySubscriber&lt;?&gt; get() { return supplier.get(); }
 64         @Override public String toString() { return name; }
 65     }
 66 
 67     static class LineSubscriber implements Flow.Subscriber&lt;String&gt; {
 68         @Override public void onSubscribe(Flow.Subscription subscription) {  }
 69         @Override public void onNext(String item) { fail(); }
 70         @Override public void onError(Throwable throwable) { fail(); }
 71         @Override public void onComplete() { fail(); }
 72     }
 73 
 74     static class BBSubscriber implements Flow.Subscriber&lt;List&lt;ByteBuffer&gt;&gt; {
 75         @Override public void onSubscribe(Flow.Subscription subscription) {  }
 76         @Override public void onNext(List&lt;ByteBuffer&gt; item) { fail(); }
 77         @Override public void onError(Throwable throwable) { fail(); }
 78         @Override public void onComplete() { fail(); }
 79     }
 80 
 81     @DataProvider(name = &quot;bodySubscriberSuppliers&quot;)
 82     public Object[][] bodySubscriberSuppliers() { ;
 83         List&lt;Supplier&lt;BodySubscriber&lt;?&gt;&gt;&gt; list = List.of(
 84             BSSupplier.create(&quot;ofByteArray&quot;,   () -&gt; ofByteArray()),
 85             BSSupplier.create(&quot;ofInputStream&quot;, () -&gt; ofInputStream()),
 86             BSSupplier.create(&quot;ofBAConsumer&quot;,  () -&gt; ofByteArrayConsumer(ba -&gt; { })),
 87             BSSupplier.create(&quot;ofLines&quot;,       () -&gt; ofLines(UTF_8)),
 88             BSSupplier.create(&quot;ofPublisher&quot;,   () -&gt; ofPublisher()),
 89             BSSupplier.create(&quot;ofFile&quot;,        () -&gt; ofFile(Path.of(&quot;f&quot;))),
 90             BSSupplier.create(&quot;ofFile-opts)&quot;,  () -&gt; ofFile(Path.of(&quot;f&quot;), CREATE)),
 91             BSSupplier.create(&quot;ofString&quot;,      () -&gt; ofString(UTF_8)),
 92             BSSupplier.create(&quot;buffering&quot;,     () -&gt; buffering(ofByteArray(), 10)),
 93             BSSupplier.create(&quot;discarding&quot;,    () -&gt; discarding()),
 94             BSSupplier.create(&quot;mapping&quot;,       () -&gt; mapping(ofString(UTF_8), s -&gt; s)),
 95             BSSupplier.create(&quot;replacing&quot;,     () -&gt; replacing(&quot;hello&quot;)),
 96             BSSupplier.create(&quot;fromSubscriber-1&quot;,     () -&gt; fromSubscriber(new BBSubscriber())),
 97             BSSupplier.create(&quot;fromSubscriber-2&quot;,     () -&gt; fromSubscriber(new BBSubscriber(), s -&gt; s)),
 98             BSSupplier.create(&quot;fromLineSubscriber-1&quot;, () -&gt; fromLineSubscriber(new LineSubscriber())),
 99             BSSupplier.create(&quot;fromLineSubscriber-2&quot;, () -&gt; fromLineSubscriber(new LineSubscriber(), s -&gt; s, UTF_8, &quot;,&quot;))
100         );
101 
102         return list.stream().map(x -&gt; new Object[] { x }).toArray(Object[][]::new);
103     }
104 
105     @Test(dataProvider = &quot;bodySubscriberSuppliers&quot;)
106     void nulls(Supplier&lt;BodySubscriber&lt;?&gt;&gt; bodySubscriberSupplier) {
107         BodySubscriber&lt;?&gt; bodySubscriber = bodySubscriberSupplier.get();
108         boolean subscribed = false;
109 
110         do {
111             assertNotNull(bodySubscriber.getBody());
112             assertNotNull(bodySubscriber.getBody());
113             assertNotNull(bodySubscriber.getBody());
114             expectThrows(NPE, () -&gt; bodySubscriber.onSubscribe(null));
115             expectThrows(NPE, () -&gt; bodySubscriber.onSubscribe(null));
116             expectThrows(NPE, () -&gt; bodySubscriber.onSubscribe(null));
117 
118             expectThrows(NPE, () -&gt; bodySubscriber.onNext(null));
119             expectThrows(NPE, () -&gt; bodySubscriber.onNext(null));
120             expectThrows(NPE, () -&gt; bodySubscriber.onNext(null));
121             expectThrows(NPE, () -&gt; bodySubscriber.onNext(null));
122 
123             expectThrows(NPE, () -&gt; bodySubscriber.onError(null));
124             expectThrows(NPE, () -&gt; bodySubscriber.onError(null));
125             expectThrows(NPE, () -&gt; bodySubscriber.onError(null));
126 
127             if (!subscribed) {
128                 out.println(&quot;subscribing&quot;);
129                 // subscribe the Subscriber and repeat
130                 bodySubscriber.onSubscribe(new Flow.Subscription() {
131                     @Override public void request(long n) { /* do nothing */ }
132                     @Override public void cancel() { fail(); }
133                 });
134                 subscribed = true;
135                 continue;
136             }
137             break;
138         } while (true);
139     }
140 
141     @Test(dataProvider = &quot;bodySubscriberSuppliers&quot;)
142     void subscribeMoreThanOnce(Supplier&lt;BodySubscriber&lt;?&gt;&gt; bodySubscriberSupplier) {
143         BodySubscriber&lt;?&gt; bodySubscriber = bodySubscriberSupplier.get();
144         bodySubscriber.onSubscribe(new Flow.Subscription() {
145             @Override public void request(long n) { /* do nothing */ }
146             @Override public void cancel() { fail(); }
147         });
148 
149         for (int i = 0; i &lt; 5; i++) {
150             var subscription = new Flow.Subscription() {
151                 volatile boolean cancelled;
152                 @Override public void request(long n) { fail(); }
153                 @Override public void cancel() { cancelled = true; }
154             };
155             bodySubscriber.onSubscribe(subscription);
156             assertTrue(subscription.cancelled);
157         }
158     }
159 }
    </pre>
  </body>
</html>