<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/websocket/AutomaticPong.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Abort.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SendTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/AutomaticPong.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @build DummyWebSocketServer
 27  * @run testng/othervm
 28  *      -Djdk.internal.httpclient.websocket.debug=true
 29  *       AutomaticPong
 30  */
<span class="line-removed"> 31 </span>
<span class="line-removed"> 32 import org.testng.annotations.AfterTest;</span>
 33 import org.testng.annotations.DataProvider;
 34 import org.testng.annotations.Test;
 35 
 36 import java.io.IOException;
 37 import java.net.http.WebSocket;
 38 import java.nio.ByteBuffer;
 39 import java.nio.charset.StandardCharsets;
 40 import java.util.List;
 41 
 42 import static java.net.http.HttpClient.newHttpClient;
 43 import static org.testng.Assert.assertEquals;
 44 import static org.testng.Assert.assertFalse;
 45 import static org.testng.Assert.assertTrue;
 46 import static org.testng.Assert.fail;
 47 
 48 public class AutomaticPong {
<span class="line-removed"> 49 </span>
<span class="line-removed"> 50     private DummyWebSocketServer server;</span>
<span class="line-removed"> 51     private WebSocket webSocket;</span>
<span class="line-removed"> 52 </span>
<span class="line-removed"> 53     @AfterTest</span>
<span class="line-removed"> 54     public void cleanup() {</span>
<span class="line-removed"> 55         server.close();</span>
<span class="line-removed"> 56         webSocket.abort();</span>
<span class="line-removed"> 57     }</span>
<span class="line-removed"> 58 </span>
 59     /*
 60      * The sendClose method has been invoked and a Ping comes from the server.
 61      * Naturally, the client cannot reply with a Pong (the output has been
 62      * closed). However, this MUST not be treated as an error.
 63      * At this stage the server either has received or pretty soon will receive
 64      * the Close message sent by the sendClose. Thus, the server will know the
 65      * client cannot send further messages and it&#39;s up to the server to decide
 66      * how to react on the corresponding Pong not being received.
 67      */
 68     @Test
 69     public void sendCloseThenAutomaticPong() throws IOException {
 70         int[] bytes = {
 71                 0x89, 0x00,                                     // ping
 72                 0x89, 0x06, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x3f, // ping hello?
 73                 0x88, 0x00,                                     // close
 74         };
<span class="line-modified"> 75         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified"> 76         server.open();</span>
<span class="line-modified"> 77         MockListener listener = new MockListener() {</span>
<span class="line-modified"> 78             @Override</span>
<span class="line-modified"> 79             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified"> 80                 /* request nothing */</span>






















 81             }
<span class="line-modified"> 82         };</span>
<span class="line-removed"> 83         webSocket = newHttpClient()</span>
<span class="line-removed"> 84                 .newWebSocketBuilder()</span>
<span class="line-removed"> 85                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed"> 86                 .join();</span>
<span class="line-removed"> 87 </span>
<span class="line-removed"> 88         webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-removed"> 89         // now request all messages available</span>
<span class="line-removed"> 90         webSocket.request(Long.MAX_VALUE);</span>
<span class="line-removed"> 91         List&lt;MockListener.Invocation&gt; actual = listener.invocations();</span>
<span class="line-removed"> 92         ByteBuffer hello = ByteBuffer.wrap(&quot;hello?&quot;.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed"> 93         ByteBuffer empty = ByteBuffer.allocate(0);</span>
<span class="line-removed"> 94         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed"> 95                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed"> 96                 MockListener.Invocation.onPing(webSocket, empty),</span>
<span class="line-removed"> 97                 MockListener.Invocation.onPing(webSocket, hello),</span>
<span class="line-removed"> 98                 MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;)</span>
<span class="line-removed"> 99         );</span>
<span class="line-removed">100         assertEquals(actual, expected);</span>
101     }
102 
103     /*
104      * The server sends a number of contiguous Ping messages. The client replies
105      * to these messages automatically. According to RFC 6455 a WebSocket client
106      * is free to reply only to the most recent Pings.
107      *
108      * What is checked here is that:
109      *
110      *     a) the order of Pong replies corresponds to the Pings received,
111      *     b) the last Pong corresponds to the last Ping
112      *     c) there are no unrelated Pongs
113      */
114     @Test(dataProvider = &quot;nPings&quot;)
115     public void automaticPongs(int nPings) throws Exception {
116         // big enough to not bother with resize
117         ByteBuffer buffer = ByteBuffer.allocate(65536);
118         Frame.HeaderWriter w = new Frame.HeaderWriter();
119         for (int i = 0; i &lt; nPings; i++) {
120             w.fin(true)
121              .opcode(Frame.Opcode.PING)
122              .noMask()
123              .payloadLen(4)    // the length of the number of the Ping (int)
124              .write(buffer);
125             buffer.putInt(i);  // the number of the Ping (int)
126         }
127         w.fin(true)
128          .opcode(Frame.Opcode.CLOSE)
129          .noMask()
130          .payloadLen(2)
131         .write(buffer);
132         buffer.putChar((char) 1000);
133         buffer.flip();
<span class="line-modified">134         server = Support.serverWithCannedData(buffer.array());</span>
<span class="line-modified">135         server.open();</span>
<span class="line-modified">136         MockListener listener = new MockListener();</span>
<span class="line-modified">137         webSocket = newHttpClient()</span>
<span class="line-modified">138                 .newWebSocketBuilder()</span>
<span class="line-modified">139                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">140                 .join();</span>
<span class="line-modified">141         List&lt;MockListener.Invocation&gt; inv = listener.invocations();</span>
<span class="line-modified">142         assertEquals(inv.size(), nPings + 2); // n * onPing + onOpen + onClose</span>
<span class="line-modified">143 </span>
<span class="line-modified">144         ByteBuffer data = server.read();</span>
<span class="line-modified">145         Frame.Reader reader = new Frame.Reader();</span>
<span class="line-modified">146 </span>
<span class="line-modified">147         Frame.Consumer consumer = new Frame.Consumer() {</span>
<span class="line-modified">148 </span>
<span class="line-modified">149             ByteBuffer number = ByteBuffer.allocate(4);</span>
<span class="line-modified">150             Frame.Masker masker = new Frame.Masker();</span>
<span class="line-modified">151             int i = -1;</span>
<span class="line-modified">152             boolean closed;</span>
<span class="line-modified">153 </span>
<span class="line-modified">154             @Override</span>
<span class="line-modified">155             public void fin(boolean value) { assertTrue(value); }</span>
<span class="line-modified">156 </span>
<span class="line-modified">157             @Override</span>
<span class="line-modified">158             public void rsv1(boolean value) { assertFalse(value); }</span>
<span class="line-modified">159 </span>
<span class="line-modified">160             @Override</span>
<span class="line-modified">161             public void rsv2(boolean value) { assertFalse(value); }</span>
<span class="line-modified">162 </span>
<span class="line-modified">163             @Override</span>
<span class="line-modified">164             public void rsv3(boolean value) { assertFalse(value); }</span>
<span class="line-modified">165 </span>
<span class="line-modified">166             @Override</span>
<span class="line-modified">167             public void opcode(Frame.Opcode value) {</span>
<span class="line-modified">168                 if (value == Frame.Opcode.CLOSE) {</span>
<span class="line-modified">169                     closed = true;</span>
<span class="line-modified">170                     return;</span>





















































171                 }
<span class="line-modified">172                 assertEquals(value, Frame.Opcode.PONG);</span>

173             }
<span class="line-removed">174 </span>
<span class="line-removed">175             @Override</span>
<span class="line-removed">176             public void mask(boolean value) { assertTrue(value); }</span>
<span class="line-removed">177 </span>
<span class="line-removed">178             @Override</span>
<span class="line-removed">179             public void payloadLen(long value) {</span>
<span class="line-removed">180                 if (!closed)</span>
<span class="line-removed">181                     assertEquals(value, 4);</span>
<span class="line-removed">182             }</span>
<span class="line-removed">183 </span>
<span class="line-removed">184             @Override</span>
<span class="line-removed">185             public void maskingKey(int value) {</span>
<span class="line-removed">186                 masker.mask(value);</span>
<span class="line-removed">187             }</span>
<span class="line-removed">188 </span>
<span class="line-removed">189             @Override</span>
<span class="line-removed">190             public void payloadData(ByteBuffer src) {</span>
<span class="line-removed">191                 masker.transferMasking(src, number);</span>
<span class="line-removed">192                 if (closed) {</span>
<span class="line-removed">193                     return;</span>
<span class="line-removed">194                 }</span>
<span class="line-removed">195                 number.flip();</span>
<span class="line-removed">196                 int n = number.getInt();</span>
<span class="line-removed">197                 System.out.printf(&quot;pong number=%s%n&quot;, n);</span>
<span class="line-removed">198                 number.clear();</span>
<span class="line-removed">199                 // a Pong with the number less than the maximum of Pongs already</span>
<span class="line-removed">200                 // received MUST never be received</span>
<span class="line-removed">201                 if (i &gt;= n) {</span>
<span class="line-removed">202                     fail(String.format(&quot;i=%s, n=%s&quot;, i, n));</span>
<span class="line-removed">203                 }</span>
<span class="line-removed">204                 i = n;</span>
<span class="line-removed">205             }</span>
<span class="line-removed">206 </span>
<span class="line-removed">207             @Override</span>
<span class="line-removed">208             public void endFrame() { }</span>
<span class="line-removed">209         };</span>
<span class="line-removed">210         while (data.hasRemaining()) {</span>
<span class="line-removed">211             reader.readFrame(data, consumer);</span>
212         }
213     }
214 
215 
216     @DataProvider(name = &quot;nPings&quot;)
217     public Object[][] nPings() {
218         return new Object[][]{{1}, {2}, {4}, {8}, {9}, {256}};
219     }
220 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @build DummyWebSocketServer
 27  * @run testng/othervm
 28  *      -Djdk.internal.httpclient.websocket.debug=true
 29  *       AutomaticPong
 30  */


 31 import org.testng.annotations.DataProvider;
 32 import org.testng.annotations.Test;
 33 
 34 import java.io.IOException;
 35 import java.net.http.WebSocket;
 36 import java.nio.ByteBuffer;
 37 import java.nio.charset.StandardCharsets;
 38 import java.util.List;
 39 
 40 import static java.net.http.HttpClient.newHttpClient;
 41 import static org.testng.Assert.assertEquals;
 42 import static org.testng.Assert.assertFalse;
 43 import static org.testng.Assert.assertTrue;
 44 import static org.testng.Assert.fail;
 45 
 46 public class AutomaticPong {










 47     /*
 48      * The sendClose method has been invoked and a Ping comes from the server.
 49      * Naturally, the client cannot reply with a Pong (the output has been
 50      * closed). However, this MUST not be treated as an error.
 51      * At this stage the server either has received or pretty soon will receive
 52      * the Close message sent by the sendClose. Thus, the server will know the
 53      * client cannot send further messages and it&#39;s up to the server to decide
 54      * how to react on the corresponding Pong not being received.
 55      */
 56     @Test
 57     public void sendCloseThenAutomaticPong() throws IOException {
 58         int[] bytes = {
 59                 0x89, 0x00,                                     // ping
 60                 0x89, 0x06, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x3f, // ping hello?
 61                 0x88, 0x00,                                     // close
 62         };
<span class="line-modified"> 63         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified"> 64             server.open();</span>
<span class="line-modified"> 65             MockListener listener = new MockListener() {</span>
<span class="line-modified"> 66                 @Override</span>
<span class="line-modified"> 67                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified"> 68                     /* request nothing */</span>
<span class="line-added"> 69                 }</span>
<span class="line-added"> 70             };</span>
<span class="line-added"> 71             var webSocket = newHttpClient()</span>
<span class="line-added"> 72                     .newWebSocketBuilder()</span>
<span class="line-added"> 73                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added"> 74                     .join();</span>
<span class="line-added"> 75             try {</span>
<span class="line-added"> 76                 webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-added"> 77                 // now request all messages available</span>
<span class="line-added"> 78                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-added"> 79                 List&lt;MockListener.Invocation&gt; actual = listener.invocations();</span>
<span class="line-added"> 80                 ByteBuffer hello = ByteBuffer.wrap(&quot;hello?&quot;.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-added"> 81                 ByteBuffer empty = ByteBuffer.allocate(0);</span>
<span class="line-added"> 82                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added"> 83                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added"> 84                         MockListener.Invocation.onPing(webSocket, empty),</span>
<span class="line-added"> 85                         MockListener.Invocation.onPing(webSocket, hello),</span>
<span class="line-added"> 86                         MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;)</span>
<span class="line-added"> 87                 );</span>
<span class="line-added"> 88                 assertEquals(actual, expected);</span>
<span class="line-added"> 89             } finally {</span>
<span class="line-added"> 90                 webSocket.abort();</span>
 91             }
<span class="line-modified"> 92         }</span>


















 93     }
 94 
 95     /*
 96      * The server sends a number of contiguous Ping messages. The client replies
 97      * to these messages automatically. According to RFC 6455 a WebSocket client
 98      * is free to reply only to the most recent Pings.
 99      *
100      * What is checked here is that:
101      *
102      *     a) the order of Pong replies corresponds to the Pings received,
103      *     b) the last Pong corresponds to the last Ping
104      *     c) there are no unrelated Pongs
105      */
106     @Test(dataProvider = &quot;nPings&quot;)
107     public void automaticPongs(int nPings) throws Exception {
108         // big enough to not bother with resize
109         ByteBuffer buffer = ByteBuffer.allocate(65536);
110         Frame.HeaderWriter w = new Frame.HeaderWriter();
111         for (int i = 0; i &lt; nPings; i++) {
112             w.fin(true)
113              .opcode(Frame.Opcode.PING)
114              .noMask()
115              .payloadLen(4)    // the length of the number of the Ping (int)
116              .write(buffer);
117             buffer.putInt(i);  // the number of the Ping (int)
118         }
119         w.fin(true)
120          .opcode(Frame.Opcode.CLOSE)
121          .noMask()
122          .payloadLen(2)
123         .write(buffer);
124         buffer.putChar((char) 1000);
125         buffer.flip();
<span class="line-modified">126         try (var server = Support.serverWithCannedData(buffer.array())) {</span>
<span class="line-modified">127             server.open();</span>
<span class="line-modified">128             MockListener listener = new MockListener();</span>
<span class="line-modified">129             var webSocket = newHttpClient()</span>
<span class="line-modified">130                     .newWebSocketBuilder()</span>
<span class="line-modified">131                     .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">132                     .join();</span>
<span class="line-modified">133             try {</span>
<span class="line-modified">134                 List&lt;MockListener.Invocation&gt; inv = listener.invocations();</span>
<span class="line-modified">135                 assertEquals(inv.size(), nPings + 2); // n * onPing + onOpen + onClose</span>
<span class="line-modified">136 </span>
<span class="line-modified">137                 ByteBuffer data = server.read();</span>
<span class="line-modified">138                 Frame.Reader reader = new Frame.Reader();</span>
<span class="line-modified">139 </span>
<span class="line-modified">140                 Frame.Consumer consumer = new Frame.Consumer() {</span>
<span class="line-modified">141 </span>
<span class="line-modified">142                     ByteBuffer number = ByteBuffer.allocate(4);</span>
<span class="line-modified">143                     Frame.Masker masker = new Frame.Masker();</span>
<span class="line-modified">144                     int i = -1;</span>
<span class="line-modified">145                     boolean closed;</span>
<span class="line-modified">146 </span>
<span class="line-modified">147                     @Override</span>
<span class="line-modified">148                     public void fin(boolean value) {</span>
<span class="line-modified">149                         assertTrue(value);</span>
<span class="line-modified">150                     }</span>
<span class="line-modified">151 </span>
<span class="line-modified">152                     @Override</span>
<span class="line-modified">153                     public void rsv1(boolean value) {</span>
<span class="line-modified">154                         assertFalse(value);</span>
<span class="line-modified">155                     }</span>
<span class="line-modified">156 </span>
<span class="line-modified">157                     @Override</span>
<span class="line-modified">158                     public void rsv2(boolean value) {</span>
<span class="line-modified">159                         assertFalse(value);</span>
<span class="line-modified">160                     }</span>
<span class="line-modified">161 </span>
<span class="line-modified">162                     @Override</span>
<span class="line-added">163                     public void rsv3(boolean value) {</span>
<span class="line-added">164                         assertFalse(value);</span>
<span class="line-added">165                     }</span>
<span class="line-added">166 </span>
<span class="line-added">167                     @Override</span>
<span class="line-added">168                     public void opcode(Frame.Opcode value) {</span>
<span class="line-added">169                         if (value == Frame.Opcode.CLOSE) {</span>
<span class="line-added">170                             closed = true;</span>
<span class="line-added">171                             return;</span>
<span class="line-added">172                         }</span>
<span class="line-added">173                         assertEquals(value, Frame.Opcode.PONG);</span>
<span class="line-added">174                     }</span>
<span class="line-added">175 </span>
<span class="line-added">176                     @Override</span>
<span class="line-added">177                     public void mask(boolean value) {</span>
<span class="line-added">178                         assertTrue(value);</span>
<span class="line-added">179                     }</span>
<span class="line-added">180 </span>
<span class="line-added">181                     @Override</span>
<span class="line-added">182                     public void payloadLen(long value) {</span>
<span class="line-added">183                         if (!closed)</span>
<span class="line-added">184                             assertEquals(value, 4);</span>
<span class="line-added">185                     }</span>
<span class="line-added">186 </span>
<span class="line-added">187                     @Override</span>
<span class="line-added">188                     public void maskingKey(int value) {</span>
<span class="line-added">189                         masker.mask(value);</span>
<span class="line-added">190                     }</span>
<span class="line-added">191 </span>
<span class="line-added">192                     @Override</span>
<span class="line-added">193                     public void payloadData(ByteBuffer src) {</span>
<span class="line-added">194                         masker.transferMasking(src, number);</span>
<span class="line-added">195                         if (closed) {</span>
<span class="line-added">196                             return;</span>
<span class="line-added">197                         }</span>
<span class="line-added">198                         number.flip();</span>
<span class="line-added">199                         int n = number.getInt();</span>
<span class="line-added">200                         System.out.printf(&quot;pong number=%s%n&quot;, n);</span>
<span class="line-added">201                         number.clear();</span>
<span class="line-added">202                         // a Pong with the number less than the maximum of Pongs already</span>
<span class="line-added">203                         // received MUST never be received</span>
<span class="line-added">204                         if (i &gt;= n) {</span>
<span class="line-added">205                             fail(String.format(&quot;i=%s, n=%s&quot;, i, n));</span>
<span class="line-added">206                         }</span>
<span class="line-added">207                         i = n;</span>
<span class="line-added">208                     }</span>
<span class="line-added">209 </span>
<span class="line-added">210                     @Override</span>
<span class="line-added">211                     public void endFrame() {</span>
<span class="line-added">212                     }</span>
<span class="line-added">213                 };</span>
<span class="line-added">214                 while (data.hasRemaining()) {</span>
<span class="line-added">215                     reader.readFrame(data, consumer);</span>
216                 }
<span class="line-modified">217             } finally {</span>
<span class="line-added">218                 webSocket.abort();</span>
219             }






































220         }
221     }
222 
223 
224     @DataProvider(name = &quot;nPings&quot;)
225     public Object[][] nPings() {
226         return new Object[][]{{1}, {2}, {4}, {8}, {9}, {256}};
227     }
228 }
</pre>
</td>
</tr>
</table>
<center><a href="Abort.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SendTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>