<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/AbstractThrowingPushPromises.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="AbstractThrowingPublishers.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingSubscribers.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/AbstractThrowingPushPromises.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,30 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! /*</span>
<span class="line-modified">!  * @test</span>
<span class="line-modified">!  * @summary Tests what happens when push promise handlers and their</span>
<span class="line-modified">!  *          response body handlers and subscribers throw unexpected exceptions.</span>
   * @library /test/lib http2/server
   * @build jdk.test.lib.net.SimpleSSLContext HttpServerAdapters
<span class="line-modified">!   *       ReferenceTracker AbstractThrowingPushPromises</span>
   * @modules java.base/sun.net.www.http
   *          java.net.http/jdk.internal.net.http.common
   *          java.net.http/jdk.internal.net.http.frame
   *          java.net.http/jdk.internal.net.http.hpack
<span class="line-modified">!  * @run testng/othervm -Djdk.internal.httpclient.debug=true AbstractThrowingPushPromises</span>
   */
  
  import jdk.test.lib.net.SimpleSSLContext;
  import org.testng.annotations.AfterTest;
  import org.testng.annotations.AfterClass;
  import org.testng.annotations.BeforeTest;
  import org.testng.annotations.DataProvider;
<span class="line-removed">- import org.testng.annotations.Test;</span>
  
  import javax.net.ssl.SSLContext;
  import java.io.BufferedReader;
  import java.io.IOException;
  import java.io.InputStream;
<span class="line-new-header">--- 19,37 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! </span>
<span class="line-modified">! /**</span>
<span class="line-modified">!  * This is not a test. Actual tests are implemented by concrete subclasses.</span>
<span class="line-modified">!  * The abstract class AbstractThrowingPushPromises provides a base framework</span>
<span class="line-added">+  * to test what happens when push promise handlers and their</span>
<span class="line-added">+  * response body handlers and subscribers throw unexpected exceptions.</span>
<span class="line-added">+  * Concrete tests that extend this abstract class will need to include</span>
<span class="line-added">+  * the following jtreg tags:</span>
<span class="line-added">+  *</span>
   * @library /test/lib http2/server
   * @build jdk.test.lib.net.SimpleSSLContext HttpServerAdapters
<span class="line-modified">!  *        ReferenceTracker AbstractThrowingPushPromises</span>
<span class="line-added">+  *        &lt;concrete-class-name&gt;</span>
   * @modules java.base/sun.net.www.http
   *          java.net.http/jdk.internal.net.http.common
   *          java.net.http/jdk.internal.net.http.frame
   *          java.net.http/jdk.internal.net.http.hpack
<span class="line-modified">!  * @run testng/othervm -Djdk.internal.httpclient.debug=true &lt;concrete-class-name&gt;</span>
   */
  
  import jdk.test.lib.net.SimpleSSLContext;
<span class="line-added">+ import org.testng.ITestContext;</span>
  import org.testng.annotations.AfterTest;
  import org.testng.annotations.AfterClass;
<span class="line-added">+ import org.testng.annotations.BeforeMethod;</span>
  import org.testng.annotations.BeforeTest;
  import org.testng.annotations.DataProvider;
  
  import javax.net.ssl.SSLContext;
  import java.io.BufferedReader;
  import java.io.IOException;
  import java.io.InputStream;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 138,10 ***</span>
<span class="line-new-header">--- 145,21 ---</span>
                  }
              });
          }
      }
  
<span class="line-added">+     protected boolean stopAfterFirstFailure() {</span>
<span class="line-added">+         return Boolean.getBoolean(&quot;jdk.internal.httpclient.debug&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @BeforeMethod</span>
<span class="line-added">+     void beforeMethod(ITestContext context) {</span>
<span class="line-added">+         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">+             throw new RuntimeException(&quot;some tests failed&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      @AfterClass
      static final void printFailedTests() {
          out.println(&quot;\n=========================&quot;);
          try {
              out.printf(&quot;%n%sCreated %d servers and %d clients%n&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,31 ***</span>
          }
      }
  
      private Object[][] variants(List&lt;Thrower&gt; throwers) {
          String[] uris = uris();
<span class="line-modified">!         Object[][] result = new Object[uris.length * 2 * throwers.size()][];</span>
          int i = 0;
          for (Thrower thrower : throwers) {
<span class="line-modified">!             for (boolean sameClient : List.of(false, true)) {</span>
                  for (String uri : uris()) {
                      result[i++] = new Object[]{uri, sameClient, thrower};
                  }
              }
          }
<span class="line-modified">!         assert i == uris.length * 2 * throwers.size();</span>
          return result;
      }
  
      @DataProvider(name = &quot;ioVariants&quot;)
<span class="line-modified">!     public Object[][] ioVariants() {</span>
          return variants(List.of(
                  new UncheckedIOExceptionThrower()));
      }
  
      @DataProvider(name = &quot;customVariants&quot;)
<span class="line-modified">!     public Object[][] customVariants() {</span>
          return variants(List.of(
                  new UncheckedCustomExceptionThrower()));
      }
  
      private HttpClient makeNewClient() {
<span class="line-new-header">--- 218,42 ---</span>
          }
      }
  
      private Object[][] variants(List&lt;Thrower&gt; throwers) {
          String[] uris = uris();
<span class="line-modified">!         // reduce traces by always using the same client if</span>
<span class="line-added">+         // stopAfterFirstFailure is requested.</span>
<span class="line-added">+         List&lt;Boolean&gt; sameClients = stopAfterFirstFailure()</span>
<span class="line-added">+                 ? List.of(true)</span>
<span class="line-added">+                 : List.of(false, true);</span>
<span class="line-added">+         Object[][] result = new Object[uris.length * sameClients.size() * throwers.size()][];</span>
          int i = 0;
          for (Thrower thrower : throwers) {
<span class="line-modified">!             for (boolean sameClient : sameClients) {</span>
                  for (String uri : uris()) {
                      result[i++] = new Object[]{uri, sameClient, thrower};
                  }
              }
          }
<span class="line-modified">!         assert i == uris.length * sameClients.size() * throwers.size();</span>
          return result;
      }
  
      @DataProvider(name = &quot;ioVariants&quot;)
<span class="line-modified">!     public Object[][] ioVariants(ITestContext context) {</span>
<span class="line-added">+         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">+             return new Object[0][];</span>
<span class="line-added">+         }</span>
          return variants(List.of(
                  new UncheckedIOExceptionThrower()));
      }
  
      @DataProvider(name = &quot;customVariants&quot;)
<span class="line-modified">!     public Object[][] customVariants(ITestContext context) {</span>
<span class="line-added">+         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">+             return new Object[0][];</span>
<span class="line-added">+         }</span>
          return variants(List.of(
                  new UncheckedCustomExceptionThrower()));
      }
  
      private HttpClient makeNewClient() {
</pre>
<center><a href="AbstractThrowingPublishers.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingSubscribers.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>