<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/websocket/WebSocketProxyTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="SendTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="WebSocketTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/WebSocketProxyTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,14 ***</span>
   * questions.
   */
  
  /*
   * @test
<span class="line-modified">!  * @bug 8217429</span>
   * @summary WebSocket proxy tunneling tests
<span class="line-modified">!  * @compile DummyWebSocketServer.java ../ProxyServer.java</span>
   * @run testng/othervm
   *         -Djdk.http.auth.tunneling.disabledSchemes=
   *         WebSocketProxyTest
   */
  
  import java.io.IOException;
<span class="line-new-header">--- 21,19 ---</span>
   * questions.
   */
  
  /*
   * @test
<span class="line-modified">!  * @bug 8217429 8236859</span>
   * @summary WebSocket proxy tunneling tests
<span class="line-modified">!  * @library /test/lib</span>
<span class="line-added">+  * @compile SecureSupport.java DummySecureWebSocketServer.java ../ProxyServer.java</span>
<span class="line-added">+  * @build jdk.test.lib.net.SimpleSSLContext WebSocketProxyTest</span>
   * @run testng/othervm
<span class="line-added">+  *         -Djdk.internal.httpclient.debug=true</span>
<span class="line-added">+  *         -Djdk.internal.httpclient.websocket.debug=true</span>
<span class="line-added">+  *         -Djdk.httpclient.HttpClient.log=errors,requests,headers</span>
   *         -Djdk.http.auth.tunneling.disabledSchemes=
   *         WebSocketProxyTest
   */
  
  import java.io.IOException;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 50,13 ***</span>
<span class="line-new-header">--- 55,18 ---</span>
  import java.util.concurrent.CompletionException;
  import java.util.concurrent.CompletionStage;
  import java.util.function.Function;
  import java.util.function.Supplier;
  import java.util.stream.Collectors;
<span class="line-added">+ </span>
<span class="line-added">+ import jdk.test.lib.net.SimpleSSLContext;</span>
  import org.testng.annotations.BeforeMethod;
  import org.testng.annotations.DataProvider;
  import org.testng.annotations.Test;
<span class="line-added">+ </span>
<span class="line-added">+ import javax.net.ssl.SSLContext;</span>
<span class="line-added">+ </span>
  import static java.net.http.HttpClient.newBuilder;
  import static java.nio.charset.StandardCharsets.UTF_8;
  import static org.testng.Assert.assertEquals;
  import static org.testng.FileAssert.fail;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 64,31 ***</span>
  
      // Used to verify a proxy/websocket server requiring Authentication
      private static final String USERNAME = &quot;wally&quot;;
      private static final String PASSWORD = &quot;xyz987&quot;;
  
      static class WSAuthenticator extends Authenticator {
          @Override
          protected PasswordAuthentication getPasswordAuthentication() {
              return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
          }
      }
  
<span class="line-modified">!     static final Function&lt;int[],DummyWebSocketServer&gt; SERVER_WITH_CANNED_DATA =</span>
          new Function&lt;&gt;() {
<span class="line-modified">!             @Override public DummyWebSocketServer apply(int[] data) {</span>
<span class="line-modified">!                 return Support.serverWithCannedData(data); }</span>
              @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
          };
  
<span class="line-modified">!     static final Function&lt;int[],DummyWebSocketServer&gt; AUTH_SERVER_WITH_CANNED_DATA =</span>
          new Function&lt;&gt;() {
<span class="line-modified">!             @Override public DummyWebSocketServer apply(int[] data) {</span>
<span class="line-modified">!                 return Support.serverWithCannedDataAndAuthentication(USERNAME, PASSWORD, data); }</span>
              @Override public String toString() { return &quot;AUTH_SERVER_WITH_CANNED_DATA&quot;; }
          };
  
      static final Supplier&lt;ProxyServer&gt; TUNNELING_PROXY_SERVER =
          new Supplier&lt;&gt;() {
              @Override public ProxyServer get() {
                  try { return new ProxyServer(0, true);}
                  catch(IOException e) { throw new UncheckedIOException(e); } }
<span class="line-new-header">--- 74,53 ---</span>
  
      // Used to verify a proxy/websocket server requiring Authentication
      private static final String USERNAME = &quot;wally&quot;;
      private static final String PASSWORD = &quot;xyz987&quot;;
  
<span class="line-added">+     static {</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             SSLContext.setDefault(new SimpleSSLContext().get());</span>
<span class="line-added">+         } catch (IOException ex) {</span>
<span class="line-added">+             throw new ExceptionInInitializerError(ex);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static class WSAuthenticator extends Authenticator {
          @Override
          protected PasswordAuthentication getPasswordAuthentication() {
              return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
          }
      }
  
<span class="line-modified">!     static final Function&lt;int[],DummySecureWebSocketServer&gt; SERVER_WITH_CANNED_DATA =</span>
          new Function&lt;&gt;() {
<span class="line-modified">!             @Override public DummySecureWebSocketServer apply(int[] data) {</span>
<span class="line-modified">!                 return SecureSupport.serverWithCannedData(data); }</span>
              @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
          };
  
<span class="line-modified">!     static final Function&lt;int[],DummySecureWebSocketServer&gt; SSL_SERVER_WITH_CANNED_DATA =</span>
<span class="line-added">+             new Function&lt;&gt;() {</span>
<span class="line-added">+                 @Override public DummySecureWebSocketServer apply(int[] data) {</span>
<span class="line-added">+                     return SecureSupport.serverWithCannedData(data).secure(); }</span>
<span class="line-added">+                 @Override public String toString() { return &quot;SSL_SERVER_WITH_CANNED_DATA&quot;; }</span>
<span class="line-added">+             };</span>
<span class="line-added">+ </span>
<span class="line-added">+     static final Function&lt;int[],DummySecureWebSocketServer&gt; AUTH_SERVER_WITH_CANNED_DATA =</span>
          new Function&lt;&gt;() {
<span class="line-modified">!             @Override public DummySecureWebSocketServer apply(int[] data) {</span>
<span class="line-modified">!                 return SecureSupport.serverWithCannedDataAndAuthentication(USERNAME, PASSWORD, data); }</span>
              @Override public String toString() { return &quot;AUTH_SERVER_WITH_CANNED_DATA&quot;; }
          };
  
<span class="line-added">+     static final Function&lt;int[],DummySecureWebSocketServer&gt; AUTH_SSL_SVR_WITH_CANNED_DATA =</span>
<span class="line-added">+             new Function&lt;&gt;() {</span>
<span class="line-added">+                 @Override public DummySecureWebSocketServer apply(int[] data) {</span>
<span class="line-added">+                     return SecureSupport.serverWithCannedDataAndAuthentication(USERNAME, PASSWORD, data).secure(); }</span>
<span class="line-added">+                 @Override public String toString() { return &quot;AUTH_SSL_SVR_WITH_CANNED_DATA&quot;; }</span>
<span class="line-added">+             };</span>
<span class="line-added">+ </span>
      static final Supplier&lt;ProxyServer&gt; TUNNELING_PROXY_SERVER =
          new Supplier&lt;&gt;() {
              @Override public ProxyServer get() {
                  try { return new ProxyServer(0, true);}
                  catch(IOException e) { throw new UncheckedIOException(e); } }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 103,19 ***</span>
          };
  
      @DataProvider(name = &quot;servers&quot;)
      public Object[][] servers() {
          return new Object[][] {
<span class="line-modified">!             { SERVER_WITH_CANNED_DATA,      TUNNELING_PROXY_SERVER      },</span>
<span class="line-modified">!             { SERVER_WITH_CANNED_DATA,      AUTH_TUNNELING_PROXY_SERVER },</span>
<span class="line-modified">!             { AUTH_SERVER_WITH_CANNED_DATA, TUNNELING_PROXY_SERVER      },</span>
          };
      }
  
      @Test(dataProvider = &quot;servers&quot;)
      public void simpleAggregatingBinaryMessages
<span class="line-modified">!             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier,</span>
               Supplier&lt;ProxyServer&gt; proxyServerSupplier)
          throws IOException
      {
          List&lt;byte[]&gt; expected = List.of(&quot;hello&quot;, &quot;chegar&quot;)
                  .stream()
<span class="line-new-header">--- 135,24 ---</span>
          };
  
      @DataProvider(name = &quot;servers&quot;)
      public Object[][] servers() {
          return new Object[][] {
<span class="line-modified">!             { SERVER_WITH_CANNED_DATA,       TUNNELING_PROXY_SERVER      },</span>
<span class="line-modified">!             { SERVER_WITH_CANNED_DATA,       AUTH_TUNNELING_PROXY_SERVER },</span>
<span class="line-modified">!             { SSL_SERVER_WITH_CANNED_DATA,   TUNNELING_PROXY_SERVER      },</span>
<span class="line-added">+             { SSL_SERVER_WITH_CANNED_DATA,   AUTH_TUNNELING_PROXY_SERVER },</span>
<span class="line-added">+             { AUTH_SERVER_WITH_CANNED_DATA,  TUNNELING_PROXY_SERVER      },</span>
<span class="line-added">+             { AUTH_SSL_SVR_WITH_CANNED_DATA, TUNNELING_PROXY_SERVER      },</span>
<span class="line-added">+             { AUTH_SERVER_WITH_CANNED_DATA,  AUTH_TUNNELING_PROXY_SERVER },</span>
<span class="line-added">+             { AUTH_SSL_SVR_WITH_CANNED_DATA, AUTH_TUNNELING_PROXY_SERVER },</span>
          };
      }
  
      @Test(dataProvider = &quot;servers&quot;)
      public void simpleAggregatingBinaryMessages
<span class="line-modified">!             (Function&lt;int[],DummySecureWebSocketServer&gt; serverSupplier,</span>
               Supplier&lt;ProxyServer&gt; proxyServerSupplier)
          throws IOException
      {
          List&lt;byte[]&gt; expected = List.of(&quot;hello&quot;, &quot;chegar&quot;)
                  .stream()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,10 ***</span>
<span class="line-new-header">--- 169,12 ---</span>
               var server = serverSupplier.apply(binary)) {
  
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
              server.open();
<span class="line-added">+             System.out.println(&quot;Server: &quot; + server.getURI());</span>
<span class="line-added">+             System.out.println(&quot;Proxy: &quot; + proxyAddress);</span>
  
              WebSocket.Listener listener = new WebSocket.Listener() {
  
                  List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();
                  ByteBuffer buffer = ByteBuffer.allocate(1024);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 207,11 ***</span>
       * Ensures authentication succeeds when an Authenticator set on client builder.
       */
      @Test
      public void clientAuthenticate() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummyWebSocketServer()){</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              var webSocket = newBuilder()
<span class="line-new-header">--- 246,11 ---</span>
       * Ensures authentication succeeds when an Authenticator set on client builder.
       */
      @Test
      public void clientAuthenticate() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummySecureWebSocketServer()){</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              var webSocket = newBuilder()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 228,11 ***</span>
       * Ensures authentication succeeds when an `Authorization` header is explicitly set.
       */
      @Test
      public void explicitAuthenticate() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummyWebSocketServer()) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
<span class="line-new-header">--- 267,34 ---</span>
       * Ensures authentication succeeds when an `Authorization` header is explicitly set.
       */
      @Test
      public void explicitAuthenticate() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummySecureWebSocketServer()) {</span>
<span class="line-added">+             server.open();</span>
<span class="line-added">+             InetSocketAddress proxyAddress = new InetSocketAddress(</span>
<span class="line-added">+                     InetAddress.getLoopbackAddress(), proxyServer.getPort());</span>
<span class="line-added">+ </span>
<span class="line-added">+             String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(</span>
<span class="line-added">+                     (USERNAME + &quot;:&quot; + PASSWORD).getBytes(UTF_8));</span>
<span class="line-added">+ </span>
<span class="line-added">+             var webSocket = newBuilder()</span>
<span class="line-added">+                     .proxy(ProxySelector.of(proxyAddress)).build()</span>
<span class="line-added">+                     .newWebSocketBuilder()</span>
<span class="line-added">+                     .header(&quot;Proxy-Authorization&quot;, hv)</span>
<span class="line-added">+                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Ensures authentication succeeds when an `Authorization` header is explicitly set.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void explicitAuthenticate2() throws IOException  {</span>
<span class="line-added">+         try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();</span>
<span class="line-added">+              var server = new DummySecureWebSocketServer(USERNAME, PASSWORD).secure()) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
</pre>
<hr />
<pre>
<span class="line-old-header">*** 240,10 ***</span>
<span class="line-new-header">--- 302,11 ---</span>
  
              var webSocket = newBuilder()
                      .proxy(ProxySelector.of(proxyAddress)).build()
                      .newWebSocketBuilder()
                      .header(&quot;Proxy-Authorization&quot;, hv)
<span class="line-added">+                     .header(&quot;Authorization&quot;, hv)</span>
                      .buildAsync(server.getURI(), new WebSocket.Listener() { })
                      .join();
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 251,11 ***</span>
       * Ensures authentication does not succeed when no authenticator is present.
       */
      @Test
      public void failNoAuthenticator() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
<span class="line-new-header">--- 314,11 ---</span>
       * Ensures authentication does not succeed when no authenticator is present.
       */
      @Test
      public void failNoAuthenticator() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummySecureWebSocketServer(USERNAME, PASSWORD)) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 279,11 ***</span>
       * unauthorized credentials.
       */
      @Test
      public void failBadCredentials() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              Authenticator authenticator = new Authenticator() {
<span class="line-new-header">--- 342,11 ---</span>
       * unauthorized credentials.
       */
      @Test
      public void failBadCredentials() throws IOException  {
          try (var proxyServer = AUTH_TUNNELING_PROXY_SERVER.get();
<span class="line-modified">!              var server = new DummySecureWebSocketServer(USERNAME, PASSWORD)) {</span>
              server.open();
              InetSocketAddress proxyAddress = new InetSocketAddress(
                      InetAddress.getLoopbackAddress(), proxyServer.getPort());
  
              Authenticator authenticator = new Authenticator() {
</pre>
<center><a href="SendTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="WebSocketTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>