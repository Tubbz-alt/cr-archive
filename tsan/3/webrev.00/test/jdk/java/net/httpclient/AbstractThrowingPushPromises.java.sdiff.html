<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/AbstractThrowingPushPromises.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="AbstractThrowingPublishers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingSubscribers.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/AbstractThrowingPushPromises.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-modified"> 24 /*</span>
<span class="line-modified"> 25  * @test</span>
<span class="line-modified"> 26  * @summary Tests what happens when push promise handlers and their</span>
<span class="line-modified"> 27  *          response body handlers and subscribers throw unexpected exceptions.</span>





 28  * @library /test/lib http2/server
 29  * @build jdk.test.lib.net.SimpleSSLContext HttpServerAdapters
<span class="line-modified"> 30   *       ReferenceTracker AbstractThrowingPushPromises</span>

 31  * @modules java.base/sun.net.www.http
 32  *          java.net.http/jdk.internal.net.http.common
 33  *          java.net.http/jdk.internal.net.http.frame
 34  *          java.net.http/jdk.internal.net.http.hpack
<span class="line-modified"> 35  * @run testng/othervm -Djdk.internal.httpclient.debug=true AbstractThrowingPushPromises</span>
 36  */
 37 
 38 import jdk.test.lib.net.SimpleSSLContext;

 39 import org.testng.annotations.AfterTest;
 40 import org.testng.annotations.AfterClass;

 41 import org.testng.annotations.BeforeTest;
 42 import org.testng.annotations.DataProvider;
<span class="line-removed"> 43 import org.testng.annotations.Test;</span>
 44 
 45 import javax.net.ssl.SSLContext;
 46 import java.io.BufferedReader;
 47 import java.io.IOException;
 48 import java.io.InputStream;
 49 import java.io.InputStreamReader;
 50 import java.io.OutputStream;
 51 import java.io.UncheckedIOException;
 52 import java.net.URI;
 53 import java.net.URISyntaxException;
 54 import java.net.http.HttpClient;
 55 import java.net.http.HttpHeaders;
 56 import java.net.http.HttpRequest;
 57 import java.net.http.HttpResponse;
 58 import java.net.http.HttpResponse.BodyHandler;
 59 import java.net.http.HttpResponse.BodyHandlers;
 60 import java.net.http.HttpResponse.BodySubscriber;
 61 import java.net.http.HttpResponse.PushPromiseHandler;
 62 import java.nio.ByteBuffer;
 63 import java.nio.charset.StandardCharsets;
</pre>
<hr />
<pre>
123             this.executor = executor;
124         }
125 
126         @Override
127         public void execute(Runnable command) {
128             long id = tasks.incrementAndGet();
129             executor.execute(() -&gt; {
130                 try {
131                     command.run();
132                 } catch (Throwable t) {
133                     tasksFailed = true;
134                     out.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
135                     err.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
136                     FAILURES.putIfAbsent(&quot;Task &quot; + id, t);
137                     throw t;
138                 }
139             });
140         }
141     }
142 











143     @AfterClass
144     static final void printFailedTests() {
145         out.println(&quot;\n=========================&quot;);
146         try {
147             out.printf(&quot;%n%sCreated %d servers and %d clients%n&quot;,
148                     now(), serverCount.get(), clientCount.get());
149             if (FAILURES.isEmpty()) return;
150             out.println(&quot;Failed tests: &quot;);
151             FAILURES.entrySet().forEach((e) -&gt; {
152                 out.printf(&quot;\t%s: %s%n&quot;, e.getKey(), e.getValue());
153                 e.getValue().printStackTrace(out);
154                 e.getValue().printStackTrace();
155             });
156             if (tasksFailed) {
157                 out.println(&quot;WARNING: Some tasks failed&quot;);
158             }
159         } finally {
160             out.println(&quot;\n=========================\n&quot;);
161         }
162     }
</pre>
<hr />
<pre>
185         return result;
186     }
187 
188     enum Where {
189         BODY_HANDLER, ON_SUBSCRIBE, ON_NEXT, ON_COMPLETE, ON_ERROR, GET_BODY, BODY_CF,
190         BEFORE_ACCEPTING, AFTER_ACCEPTING;
191         public Consumer&lt;Where&gt; select(Consumer&lt;Where&gt; consumer) {
192             return new Consumer&lt;Where&gt;() {
193                 @Override
194                 public void accept(Where where) {
195                     if (Where.this == where) {
196                         consumer.accept(where);
197                     }
198                 }
199             };
200         }
201     }
202 
203     private Object[][] variants(List&lt;Thrower&gt; throwers) {
204         String[] uris = uris();
<span class="line-modified">205         Object[][] result = new Object[uris.length * 2 * throwers.size()][];</span>





206         int i = 0;
207         for (Thrower thrower : throwers) {
<span class="line-modified">208             for (boolean sameClient : List.of(false, true)) {</span>
209                 for (String uri : uris()) {
210                     result[i++] = new Object[]{uri, sameClient, thrower};
211                 }
212             }
213         }
<span class="line-modified">214         assert i == uris.length * 2 * throwers.size();</span>
215         return result;
216     }
217 
218     @DataProvider(name = &quot;ioVariants&quot;)
<span class="line-modified">219     public Object[][] ioVariants() {</span>



220         return variants(List.of(
221                 new UncheckedIOExceptionThrower()));
222     }
223 
224     @DataProvider(name = &quot;customVariants&quot;)
<span class="line-modified">225     public Object[][] customVariants() {</span>



226         return variants(List.of(
227                 new UncheckedCustomExceptionThrower()));
228     }
229 
230     private HttpClient makeNewClient() {
231         clientCount.incrementAndGet();
232         return TRACKER.track(HttpClient.newBuilder()
233                 .proxy(HttpClient.Builder.NO_PROXY)
234                 .executor(executor)
235                 .sslContext(sslContext)
236                 .build());
237     }
238 
239     HttpClient newHttpClient(boolean share) {
240         if (!share) return makeNewClient();
241         HttpClient shared = sharedClient;
242         if (shared != null) return shared;
243         synchronized (this) {
244             shared = sharedClient;
245             if (shared == null) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
<span class="line-modified"> 24 </span>
<span class="line-modified"> 25 /**</span>
<span class="line-modified"> 26  * This is not a test. Actual tests are implemented by concrete subclasses.</span>
<span class="line-modified"> 27  * The abstract class AbstractThrowingPushPromises provides a base framework</span>
<span class="line-added"> 28  * to test what happens when push promise handlers and their</span>
<span class="line-added"> 29  * response body handlers and subscribers throw unexpected exceptions.</span>
<span class="line-added"> 30  * Concrete tests that extend this abstract class will need to include</span>
<span class="line-added"> 31  * the following jtreg tags:</span>
<span class="line-added"> 32  *</span>
 33  * @library /test/lib http2/server
 34  * @build jdk.test.lib.net.SimpleSSLContext HttpServerAdapters
<span class="line-modified"> 35  *        ReferenceTracker AbstractThrowingPushPromises</span>
<span class="line-added"> 36  *        &lt;concrete-class-name&gt;</span>
 37  * @modules java.base/sun.net.www.http
 38  *          java.net.http/jdk.internal.net.http.common
 39  *          java.net.http/jdk.internal.net.http.frame
 40  *          java.net.http/jdk.internal.net.http.hpack
<span class="line-modified"> 41  * @run testng/othervm -Djdk.internal.httpclient.debug=true &lt;concrete-class-name&gt;</span>
 42  */
 43 
 44 import jdk.test.lib.net.SimpleSSLContext;
<span class="line-added"> 45 import org.testng.ITestContext;</span>
 46 import org.testng.annotations.AfterTest;
 47 import org.testng.annotations.AfterClass;
<span class="line-added"> 48 import org.testng.annotations.BeforeMethod;</span>
 49 import org.testng.annotations.BeforeTest;
 50 import org.testng.annotations.DataProvider;

 51 
 52 import javax.net.ssl.SSLContext;
 53 import java.io.BufferedReader;
 54 import java.io.IOException;
 55 import java.io.InputStream;
 56 import java.io.InputStreamReader;
 57 import java.io.OutputStream;
 58 import java.io.UncheckedIOException;
 59 import java.net.URI;
 60 import java.net.URISyntaxException;
 61 import java.net.http.HttpClient;
 62 import java.net.http.HttpHeaders;
 63 import java.net.http.HttpRequest;
 64 import java.net.http.HttpResponse;
 65 import java.net.http.HttpResponse.BodyHandler;
 66 import java.net.http.HttpResponse.BodyHandlers;
 67 import java.net.http.HttpResponse.BodySubscriber;
 68 import java.net.http.HttpResponse.PushPromiseHandler;
 69 import java.nio.ByteBuffer;
 70 import java.nio.charset.StandardCharsets;
</pre>
<hr />
<pre>
130             this.executor = executor;
131         }
132 
133         @Override
134         public void execute(Runnable command) {
135             long id = tasks.incrementAndGet();
136             executor.execute(() -&gt; {
137                 try {
138                     command.run();
139                 } catch (Throwable t) {
140                     tasksFailed = true;
141                     out.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
142                     err.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
143                     FAILURES.putIfAbsent(&quot;Task &quot; + id, t);
144                     throw t;
145                 }
146             });
147         }
148     }
149 
<span class="line-added">150     protected boolean stopAfterFirstFailure() {</span>
<span class="line-added">151         return Boolean.getBoolean(&quot;jdk.internal.httpclient.debug&quot;);</span>
<span class="line-added">152     }</span>
<span class="line-added">153 </span>
<span class="line-added">154     @BeforeMethod</span>
<span class="line-added">155     void beforeMethod(ITestContext context) {</span>
<span class="line-added">156         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">157             throw new RuntimeException(&quot;some tests failed&quot;);</span>
<span class="line-added">158         }</span>
<span class="line-added">159     }</span>
<span class="line-added">160 </span>
161     @AfterClass
162     static final void printFailedTests() {
163         out.println(&quot;\n=========================&quot;);
164         try {
165             out.printf(&quot;%n%sCreated %d servers and %d clients%n&quot;,
166                     now(), serverCount.get(), clientCount.get());
167             if (FAILURES.isEmpty()) return;
168             out.println(&quot;Failed tests: &quot;);
169             FAILURES.entrySet().forEach((e) -&gt; {
170                 out.printf(&quot;\t%s: %s%n&quot;, e.getKey(), e.getValue());
171                 e.getValue().printStackTrace(out);
172                 e.getValue().printStackTrace();
173             });
174             if (tasksFailed) {
175                 out.println(&quot;WARNING: Some tasks failed&quot;);
176             }
177         } finally {
178             out.println(&quot;\n=========================\n&quot;);
179         }
180     }
</pre>
<hr />
<pre>
203         return result;
204     }
205 
206     enum Where {
207         BODY_HANDLER, ON_SUBSCRIBE, ON_NEXT, ON_COMPLETE, ON_ERROR, GET_BODY, BODY_CF,
208         BEFORE_ACCEPTING, AFTER_ACCEPTING;
209         public Consumer&lt;Where&gt; select(Consumer&lt;Where&gt; consumer) {
210             return new Consumer&lt;Where&gt;() {
211                 @Override
212                 public void accept(Where where) {
213                     if (Where.this == where) {
214                         consumer.accept(where);
215                     }
216                 }
217             };
218         }
219     }
220 
221     private Object[][] variants(List&lt;Thrower&gt; throwers) {
222         String[] uris = uris();
<span class="line-modified">223         // reduce traces by always using the same client if</span>
<span class="line-added">224         // stopAfterFirstFailure is requested.</span>
<span class="line-added">225         List&lt;Boolean&gt; sameClients = stopAfterFirstFailure()</span>
<span class="line-added">226                 ? List.of(true)</span>
<span class="line-added">227                 : List.of(false, true);</span>
<span class="line-added">228         Object[][] result = new Object[uris.length * sameClients.size() * throwers.size()][];</span>
229         int i = 0;
230         for (Thrower thrower : throwers) {
<span class="line-modified">231             for (boolean sameClient : sameClients) {</span>
232                 for (String uri : uris()) {
233                     result[i++] = new Object[]{uri, sameClient, thrower};
234                 }
235             }
236         }
<span class="line-modified">237         assert i == uris.length * sameClients.size() * throwers.size();</span>
238         return result;
239     }
240 
241     @DataProvider(name = &quot;ioVariants&quot;)
<span class="line-modified">242     public Object[][] ioVariants(ITestContext context) {</span>
<span class="line-added">243         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">244             return new Object[0][];</span>
<span class="line-added">245         }</span>
246         return variants(List.of(
247                 new UncheckedIOExceptionThrower()));
248     }
249 
250     @DataProvider(name = &quot;customVariants&quot;)
<span class="line-modified">251     public Object[][] customVariants(ITestContext context) {</span>
<span class="line-added">252         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">253             return new Object[0][];</span>
<span class="line-added">254         }</span>
255         return variants(List.of(
256                 new UncheckedCustomExceptionThrower()));
257     }
258 
259     private HttpClient makeNewClient() {
260         clientCount.incrementAndGet();
261         return TRACKER.track(HttpClient.newBuilder()
262                 .proxy(HttpClient.Builder.NO_PROXY)
263                 .executor(executor)
264                 .sslContext(sslContext)
265                 .build());
266     }
267 
268     HttpClient newHttpClient(boolean share) {
269         if (!share) return makeNewClient();
270         HttpClient shared = sharedClient;
271         if (shared != null) return shared;
272         synchronized (this) {
273             shared = sharedClient;
274             if (shared == null) {
</pre>
</td>
</tr>
</table>
<center><a href="AbstractThrowingPublishers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingSubscribers.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>