<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/httpclient/websocket/WebSocketTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8217429
 27  * @build DummyWebSocketServer
 28  * @run testng/othervm
 29  *       WebSocketTest
 30  */
 31 
<a name="1" id="anc1"></a><span class="line-removed"> 32 import org.testng.annotations.AfterTest;</span>
 33 import org.testng.annotations.DataProvider;
 34 import org.testng.annotations.Test;
 35 
 36 import java.io.IOException;
 37 import java.net.Authenticator;
 38 import java.net.PasswordAuthentication;
 39 import java.net.http.HttpResponse;
 40 import java.net.http.WebSocket;
 41 import java.net.http.WebSocketHandshakeException;
 42 import java.nio.ByteBuffer;
 43 import java.nio.charset.StandardCharsets;
 44 import java.util.ArrayList;
 45 import java.util.Base64;
 46 import java.util.List;
 47 import java.util.concurrent.CompletableFuture;
 48 import java.util.concurrent.CompletionException;
 49 import java.util.concurrent.CompletionStage;
 50 import java.util.concurrent.TimeUnit;
 51 import java.util.concurrent.atomic.AtomicBoolean;
 52 import java.util.function.Function;
 53 import java.util.function.Supplier;
 54 import java.util.stream.Collectors;
 55 
 56 import static java.net.http.HttpClient.Builder.NO_PROXY;
 57 import static java.net.http.HttpClient.newBuilder;
 58 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 59 import static java.nio.charset.StandardCharsets.UTF_8;
 60 import static org.testng.Assert.assertEquals;
 61 import static org.testng.Assert.assertThrows;
 62 import static org.testng.Assert.fail;
 63 
 64 public class WebSocketTest {
 65 
 66     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 67     private static final Class&lt;IllegalStateException&gt; ISE = IllegalStateException.class;
 68     private static final Class&lt;IOException&gt; IOE = IOException.class;
 69 
 70     /* shortcut */
 71     private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
 72                                     CompletionStage&lt;?&gt; stage) {
 73         Support.assertCompletesExceptionally(clazz, stage);
 74     }
 75 
<a name="2" id="anc2"></a><span class="line-removed"> 76     private DummyWebSocketServer server;</span>
<span class="line-removed"> 77     private WebSocket webSocket;</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79     @AfterTest</span>
<span class="line-removed"> 80     public void cleanup() {</span>
<span class="line-removed"> 81         System.out.println(&quot;AFTER TEST&quot;);</span>
<span class="line-removed"> 82         if (server != null)</span>
<span class="line-removed"> 83             server.close();</span>
<span class="line-removed"> 84         if (webSocket != null)</span>
<span class="line-removed"> 85             webSocket.abort();</span>
<span class="line-removed"> 86     }</span>
<span class="line-removed"> 87 </span>
 88     @Test
 89     public void illegalArgument() throws IOException {
<a name="3" id="anc3"></a><span class="line-modified"> 90         server = new DummyWebSocketServer();</span>
<span class="line-modified"> 91         server.open();</span>
<span class="line-modified"> 92         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified"> 93                 .newWebSocketBuilder()</span>
<span class="line-modified"> 94                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified"> 95                 .join();</span>
<span class="line-modified"> 96 </span>
<span class="line-modified"> 97         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 98         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 99         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified">100         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified">101         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified">102 </span>
<span class="line-modified">103         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified">104         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified">105         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified">106         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified">107         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified">108 </span>
<span class="line-modified">109         assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified">110         assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified">111         assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified">112         assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">113 </span>
<span class="line-modified">114         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">115         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">116         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">117         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">118         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">119         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">120         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">121         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">122 </span>
<span class="line-modified">123         assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">124         assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">125         assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">126         assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">127         assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">128         assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">129         assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">130         assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">131         assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">132         assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">133         assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">134         assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">135         assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">136         assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">137         assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">138         assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">139         assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">140         assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">141         assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">142         assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">143         assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">144         assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">145 </span>
<span class="line-modified">146         assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">147         assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">148         assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">149         assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">150 </span>
<span class="line-modified">151         server.close();</span>



152     }
153 
154     @Test
155     public void partialBinaryThenText() throws IOException {
<a name="4" id="anc4"></a><span class="line-modified">156         server = new DummyWebSocketServer();</span>
<span class="line-modified">157         server.open();</span>
<span class="line-modified">158         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">159                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">160                 .join();</span>
<span class="line-modified">161         webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">162         assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">163         assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">164         // Pings &amp; Pongs are fine</span>
<span class="line-modified">165         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">166         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">167         server.close();</span>




168     }
169 
170     @Test
171     public void partialTextThenBinary() throws IOException {
<a name="5" id="anc5"></a><span class="line-modified">172         server = new DummyWebSocketServer();</span>
<span class="line-modified">173         server.open();</span>
<span class="line-modified">174         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">175                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">176                 .join();</span>
<span class="line-modified">177 </span>
<span class="line-modified">178         webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">179         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">180         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">181         // Pings &amp; Pongs are fine</span>
<span class="line-modified">182         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">183         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">184         server.close();</span>



185     }
186 
187     @Test
188     public void sendMethodsThrowIOE1() throws IOException {
<a name="6" id="anc6"></a><span class="line-modified">189         server = new DummyWebSocketServer();</span>
<span class="line-modified">190         server.open();</span>
<span class="line-modified">191         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">192                 .newWebSocketBuilder()</span>
<span class="line-modified">193                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">194                 .join();</span>
<span class="line-modified">195 </span>
<span class="line-modified">196         webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">197 </span>
<span class="line-modified">198         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">199 </span>
<span class="line-modified">200         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">201         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">202         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">203         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">204         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">205         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">206         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">207         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">208 </span>
<span class="line-modified">209         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">210         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">211         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">212         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">213 </span>
<span class="line-modified">214         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">215         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">216         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">217         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">218 </span>
<span class="line-modified">219         server.close();</span>


220     }
221 
222     @DataProvider(name = &quot;sequence&quot;)
223     public Object[][] data1() {
224         int[] CLOSE = {
225                 0x81, 0x00, // &quot;&quot;
226                 0x82, 0x00, // []
227                 0x89, 0x00, // &lt;PING&gt;
228                 0x8a, 0x00, // &lt;PONG&gt;
229                 0x88, 0x00, // &lt;CLOSE&gt;
230         };
231         int[] ERROR = {
232                 0x81, 0x00, // &quot;&quot;
233                 0x82, 0x00, // []
234                 0x89, 0x00, // &lt;PING&gt;
235                 0x8a, 0x00, // &lt;PONG&gt;
236                 0x8b, 0x00, // 0xB control frame (causes an error)
237         };
238         return new Object[][]{
239                 {CLOSE, 1},
240                 {CLOSE, 3},
241                 {CLOSE, 4},
242                 {CLOSE, Long.MAX_VALUE},
243                 {ERROR, 1},
244                 {ERROR, 3},
245                 {ERROR, 4},
246                 {ERROR, Long.MAX_VALUE},
247         };
248     }
249 
250     @Test(dataProvider = &quot;sequence&quot;)
251     public void listenerSequentialOrder(int[] binary, long requestSize)
252             throws IOException
253     {
<a name="7" id="anc7"></a>

254 
<a name="8" id="anc8"></a><span class="line-modified">255         server = Support.serverWithCannedData(binary);</span>
<span class="line-removed">256         server.open();</span>
<span class="line-removed">257 </span>
<span class="line-removed">258         CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>
259 
<a name="9" id="anc9"></a><span class="line-modified">260         MockListener listener = new MockListener(requestSize) {</span>
261 
<a name="10" id="anc10"></a><span class="line-modified">262             final AtomicBoolean guard = new AtomicBoolean();</span>
263 
<a name="11" id="anc11"></a><span class="line-modified">264             private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">265                 if (guard.getAndSet(true)) {</span>
<span class="line-removed">266                     violation.completeExceptionally(new RuntimeException());</span>
<span class="line-removed">267                 }</span>
<span class="line-removed">268                 try {</span>
<span class="line-removed">269                     return action.get();</span>
<span class="line-removed">270                 } finally {</span>
<span class="line-removed">271                     if (!guard.getAndSet(false)) {</span>
272                         violation.completeExceptionally(new RuntimeException());
273                     }
<a name="12" id="anc12"></a>






274                 }
<a name="13" id="anc13"></a><span class="line-removed">275             }</span>
<span class="line-removed">276 </span>
<span class="line-removed">277             @Override</span>
<span class="line-removed">278             public void onOpen(WebSocket webSocket) {</span>
<span class="line-removed">279                 checkRunExclusively(() -&gt; {</span>
<span class="line-removed">280                     super.onOpen(webSocket);</span>
<span class="line-removed">281                     return null;</span>
<span class="line-removed">282                 });</span>
<span class="line-removed">283             }</span>
284 
<a name="14" id="anc14"></a><span class="line-modified">285             @Override</span>
<span class="line-modified">286             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">287                                              CharSequence data,</span>
<span class="line-modified">288                                              boolean last) {</span>
<span class="line-modified">289                 return checkRunExclusively(</span>
<span class="line-modified">290                         () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-modified">291             }</span>
<span class="line-removed">292 </span>
<span class="line-removed">293             @Override</span>
<span class="line-removed">294             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-removed">295                                                ByteBuffer data,</span>
<span class="line-removed">296                                                boolean last) {</span>
<span class="line-removed">297                 return checkRunExclusively(</span>
<span class="line-removed">298                         () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-removed">299             }</span>
<span class="line-removed">300 </span>
<span class="line-removed">301             @Override</span>
<span class="line-removed">302             public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-removed">303                                              ByteBuffer message) {</span>
<span class="line-removed">304                 return checkRunExclusively(</span>
<span class="line-removed">305                         () -&gt; super.onPing(webSocket, message));</span>
<span class="line-removed">306             }</span>
307 
<a name="15" id="anc15"></a><span class="line-modified">308             @Override</span>
<span class="line-modified">309             public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">310                                              ByteBuffer message) {</span>
<span class="line-modified">311                 return checkRunExclusively(</span>
<span class="line-modified">312                         () -&gt; super.onPong(webSocket, message));</span>
<span class="line-modified">313             }</span>

314 
<a name="16" id="anc16"></a><span class="line-modified">315             @Override</span>
<span class="line-modified">316             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">317                                               int statusCode,</span>
<span class="line-modified">318                                               String reason) {</span>
<span class="line-modified">319                 return checkRunExclusively(</span>
<span class="line-modified">320                         () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-modified">321             }</span>
322 
<a name="17" id="anc17"></a><span class="line-modified">323             @Override</span>
<span class="line-modified">324             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">325                 checkRunExclusively(() -&gt; {</span>
<span class="line-modified">326                     super.onError(webSocket, error);</span>
<span class="line-modified">327                     return null;</span>
<span class="line-modified">328                 });</span>
<span class="line-removed">329             }</span>
<span class="line-removed">330         };</span>
331 
<a name="18" id="anc18"></a><span class="line-modified">332         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">333                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">334                 .join();</span>



335 
<a name="19" id="anc19"></a>






336 
<a name="20" id="anc20"></a><span class="line-modified">337         listener.invocations();</span>
<span class="line-modified">338         violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-modified">339         violation.join();</span>





340 
<a name="21" id="anc21"></a><span class="line-modified">341         server.close();</span>










342     }
343 
344     @Test
345     public void sendMethodsThrowIOE2() throws Exception {
<a name="22" id="anc22"></a><span class="line-modified">346         server = Support.serverWithCannedData(0x88, 0x00);</span>
<span class="line-modified">347         server.open();</span>
<span class="line-removed">348         CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">349         CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">350 </span>
<span class="line-removed">351         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">352             @Override</span>
<span class="line-removed">353             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">354                                               int statusCode,</span>
<span class="line-removed">355                                               String reason) {</span>
<span class="line-removed">356                 System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-removed">357                 onCloseCalled.complete(null);</span>
<span class="line-removed">358                 return canClose;</span>
<span class="line-removed">359             }</span>
<span class="line-removed">360 </span>
<span class="line-removed">361             @Override</span>
<span class="line-removed">362             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">363                 System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-removed">364                 onCloseCalled.completeExceptionally(error);</span>
<span class="line-removed">365             }</span>
<span class="line-removed">366         };</span>
<span class="line-removed">367 </span>
<span class="line-removed">368         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-removed">369                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">370                 .join();</span>
<span class="line-removed">371 </span>
<span class="line-removed">372         onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-removed">373         canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-removed">374         TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-removed">375 </span>
<span class="line-removed">376         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-removed">377 </span>
<span class="line-removed">378         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-removed">379         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-removed">380         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-removed">381         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-removed">382         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-removed">383         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-removed">384         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-removed">385         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
386 
<a name="23" id="anc23"></a><span class="line-modified">387         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">388         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">389         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">390         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>








391 
<a name="24" id="anc24"></a><span class="line-modified">392         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">393         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">394         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">395         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>


396 
<a name="25" id="anc25"></a><span class="line-modified">397         server.close();</span>































398     }
399 
400     // Used to verify a server requiring Authentication
401     private static final String USERNAME = &quot;chegar&quot;;
402     private static final String PASSWORD = &quot;a1b2c3&quot;;
403 
404     static class WSAuthenticator extends Authenticator {
405         @Override
406         protected PasswordAuthentication getPasswordAuthentication() {
407             return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
408         }
409     }
410 
411     static final Function&lt;int[],DummyWebSocketServer&gt; SERVER_WITH_CANNED_DATA =
412         new Function&lt;&gt;() {
413             @Override public DummyWebSocketServer apply(int[] data) {
414                 return Support.serverWithCannedData(data); }
415             @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
416         };
417 
418     static final Function&lt;int[],DummyWebSocketServer&gt; AUTH_SERVER_WITH_CANNED_DATA =
419         new Function&lt;&gt;() {
420             @Override public DummyWebSocketServer apply(int[] data) {
421                 return Support.serverWithCannedDataAndAuthentication(USERNAME, PASSWORD, data); }
422             @Override public String toString() { return &quot;AUTH_SERVER_WITH_CANNED_DATA&quot;; }
423         };
424 
425     @DataProvider(name = &quot;servers&quot;)
426     public Object[][] servers() {
427         return new Object[][] {
428             { SERVER_WITH_CANNED_DATA },
429             { AUTH_SERVER_WITH_CANNED_DATA },
430         };
431     }
432 
433     @Test(dataProvider = &quot;servers&quot;)
434     public void simpleAggregatingBinaryMessages
435             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
436         throws IOException
437     {
438         List&lt;byte[]&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;)
439                 .stream()
440                 .map(s -&gt; s.getBytes(StandardCharsets.US_ASCII))
441                 .collect(Collectors.toList());
442         int[] binary = new int[]{
443                 0x82, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // [alpha]
444                 0x02, 0x02, 0x62, 0x65,                   // [be
445                 0x80, 0x02, 0x74, 0x61,                   // ta]
446                 0x02, 0x01, 0x67,                         // [g
447                 0x00, 0x01, 0x61,                         // a
448                 0x00, 0x00,                               //
449                 0x00, 0x00,                               //
450                 0x00, 0x01, 0x6d,                         // m
451                 0x00, 0x01, 0x6d,                         // m
452                 0x80, 0x01, 0x61,                         // a]
453                 0x8a, 0x00,                               // &lt;PONG&gt;
454                 0x02, 0x04, 0x64, 0x65, 0x6c, 0x74,       // [delt
455                 0x00, 0x01, 0x61,                         // a
456                 0x80, 0x00,                               // ]
457                 0x88, 0x00                                // &lt;CLOSE&gt;
458         };
459         CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
460 
<a name="26" id="anc26"></a><span class="line-modified">461         server = serverSupplier.apply(binary);</span>
<span class="line-modified">462         server.open();</span>
463 
<a name="27" id="anc27"></a><span class="line-modified">464         WebSocket.Listener listener = new WebSocket.Listener() {</span>
465 
<a name="28" id="anc28"></a><span class="line-modified">466             List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">467             ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
468 
<a name="29" id="anc29"></a><span class="line-modified">469             @Override</span>
<span class="line-modified">470             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">471                                                ByteBuffer message,</span>
<span class="line-modified">472                                                boolean last) {</span>
<span class="line-modified">473                 System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">474                 webSocket.request(1);</span>
475 
<a name="30" id="anc30"></a><span class="line-modified">476                 append(message);</span>
<span class="line-modified">477                 if (last) {</span>
<span class="line-modified">478                     buffer.flip();</span>
<span class="line-modified">479                     byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">480                     buffer.get(bytes);</span>
<span class="line-modified">481                     buffer.clear();</span>
<span class="line-modified">482                     processWholeBinary(bytes);</span>


483                 }
<a name="31" id="anc31"></a><span class="line-removed">484                 return null;</span>
<span class="line-removed">485             }</span>
486 
<a name="32" id="anc32"></a><span class="line-modified">487             private void append(ByteBuffer message) {</span>
<span class="line-modified">488                 if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">489                     assert message.remaining() &gt; 0;</span>
<span class="line-modified">490                     int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">491                     ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">492                     b.put(buffer.flip());</span>
<span class="line-modified">493                     buffer = b;</span>


494                 }
<a name="33" id="anc33"></a><span class="line-removed">495                 buffer.put(message);</span>
<span class="line-removed">496             }</span>
497 
<a name="34" id="anc34"></a><span class="line-modified">498             private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">499                 String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">500                 System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">501                 collectedBytes.add(bytes);</span>
<span class="line-modified">502             }</span>
<span class="line-removed">503 </span>
<span class="line-removed">504             @Override</span>
<span class="line-removed">505             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">506                                               int statusCode,</span>
<span class="line-removed">507                                               String reason) {</span>
<span class="line-removed">508                 actual.complete(collectedBytes);</span>
<span class="line-removed">509                 return null;</span>
<span class="line-removed">510             }</span>
<span class="line-removed">511 </span>
<span class="line-removed">512             @Override</span>
<span class="line-removed">513             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">514                 actual.completeExceptionally(error);</span>
<span class="line-removed">515             }</span>
<span class="line-removed">516         };</span>
517 
<a name="35" id="anc35"></a><span class="line-modified">518         webSocket = newBuilder()</span>
<span class="line-modified">519                 .proxy(NO_PROXY)</span>
<span class="line-modified">520                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">521                 .build().newWebSocketBuilder()</span>
<span class="line-modified">522                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">523                 .join();</span>

524 
<a name="36" id="anc36"></a><span class="line-modified">525         List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-modified">526         assertEquals(a, expected);</span>



527 
<a name="37" id="anc37"></a><span class="line-modified">528         server.close();</span>












529     }
530 
531     @Test(dataProvider = &quot;servers&quot;)
532     public void simpleAggregatingTextMessages
533             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
534         throws IOException
535     {
536         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
537 
538         int[] binary = new int[]{
539                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
540                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
541                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
542                 0x01, 0x01, 0x67,                         // &quot;g
543                 0x00, 0x01, 0x61,                         // a
544                 0x00, 0x00,                               //
545                 0x00, 0x00,                               //
546                 0x00, 0x01, 0x6d,                         // m
547                 0x00, 0x01, 0x6d,                         // m
548                 0x80, 0x01, 0x61,                         // a&quot;
549                 0x8a, 0x00,                               // &lt;PONG&gt;
550                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
551                 0x00, 0x01, 0x61,                         // a
552                 0x80, 0x00,                               // &quot;
553                 0x88, 0x00                                // &lt;CLOSE&gt;
554         };
555         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
556 
<a name="38" id="anc38"></a><span class="line-modified">557         server = serverSupplier.apply(binary);</span>
<span class="line-modified">558         server.open();</span>
<span class="line-removed">559 </span>
<span class="line-removed">560         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">561 </span>
<span class="line-removed">562             List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-removed">563             StringBuilder text = new StringBuilder();</span>
<span class="line-removed">564 </span>
<span class="line-removed">565             @Override</span>
<span class="line-removed">566             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">567                                              CharSequence message,</span>
<span class="line-removed">568                                              boolean last) {</span>
<span class="line-removed">569                 System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-removed">570                 webSocket.request(1);</span>
<span class="line-removed">571                 text.append(message);</span>
<span class="line-removed">572                 if (last) {</span>
<span class="line-removed">573                     String str = text.toString();</span>
<span class="line-removed">574                     text.setLength(0);</span>
<span class="line-removed">575                     processWholeText(str);</span>
<span class="line-removed">576                 }</span>
<span class="line-removed">577                 return null;</span>
<span class="line-removed">578             }</span>
579 
<a name="39" id="anc39"></a><span class="line-modified">580             private void processWholeText(String string) {</span>
<span class="line-removed">581                 System.out.println(string);</span>
<span class="line-removed">582                 collectedStrings.add(string);</span>
<span class="line-removed">583             }</span>
584 
<a name="40" id="anc40"></a><span class="line-modified">585             @Override</span>
<span class="line-modified">586             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">587                                               int statusCode,</span>
<span class="line-removed">588                                               String reason) {</span>
<span class="line-removed">589                 actual.complete(collectedStrings);</span>
<span class="line-removed">590                 return null;</span>
<span class="line-removed">591             }</span>
592 
<a name="41" id="anc41"></a><span class="line-modified">593             @Override</span>
<span class="line-modified">594             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">595                 actual.completeExceptionally(error);</span>
<span class="line-modified">596             }</span>
<span class="line-modified">597         };</span>









598 
<a name="42" id="anc42"></a><span class="line-modified">599         webSocket = newBuilder()</span>
<span class="line-modified">600                 .proxy(NO_PROXY)</span>
<span class="line-modified">601                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">602                 .build().newWebSocketBuilder()</span>
<span class="line-removed">603                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">604                 .join();</span>
605 
<a name="43" id="anc43"></a><span class="line-modified">606         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">607         assertEquals(a, expected);</span>





608 
<a name="44" id="anc44"></a><span class="line-modified">609         server.close();</span>


















610     }
611 
612     /*
613      * Exercises the scenario where requests for more messages are made prior to
614      * completing the returned CompletionStage instances.
615      */
616     @Test(dataProvider = &quot;servers&quot;)
617     public void aggregatingTextMessages
618         (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
619         throws IOException
620     {
621         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
622 
623         int[] binary = new int[]{
624                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
625                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
626                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
627                 0x01, 0x01, 0x67,                         // &quot;g
628                 0x00, 0x01, 0x61,                         // a
629                 0x00, 0x00,                               //
630                 0x00, 0x00,                               //
631                 0x00, 0x01, 0x6d,                         // m
632                 0x00, 0x01, 0x6d,                         // m
633                 0x80, 0x01, 0x61,                         // a&quot;
634                 0x8a, 0x00,                               // &lt;PONG&gt;
635                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
636                 0x00, 0x01, 0x61,                         // a
637                 0x80, 0x00,                               // &quot;
638                 0x88, 0x00                                // &lt;CLOSE&gt;
639         };
640         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
641 
<a name="45" id="anc45"></a><span class="line-modified">642         server = serverSupplier.apply(binary);</span>
<span class="line-modified">643         server.open();</span>
<span class="line-removed">644 </span>
<span class="line-removed">645         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">646 </span>
<span class="line-removed">647             List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-removed">648             /*</span>
<span class="line-removed">649              * A CompletableFuture which will complete once the current</span>
<span class="line-removed">650              * message has been fully assembled. Until then the listener</span>
<span class="line-removed">651              * returns this instance for every call.</span>
<span class="line-removed">652              */</span>
<span class="line-removed">653             CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">654             List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-removed">655 </span>
<span class="line-removed">656             @Override</span>
<span class="line-removed">657             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">658                                              CharSequence message,</span>
<span class="line-removed">659                                              boolean last) {</span>
<span class="line-removed">660                 parts.add(message);</span>
<span class="line-removed">661                 if (!last) {</span>
<span class="line-removed">662                     webSocket.request(1);</span>
<span class="line-removed">663                 } else {</span>
<span class="line-removed">664                     this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-removed">665                     CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-removed">666                     processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-removed">667                     currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">668                     parts.clear();</span>
<span class="line-removed">669                     return refCf;</span>
<span class="line-removed">670                 }</span>
<span class="line-removed">671                 return currentCf;</span>
<span class="line-removed">672             }</span>
<span class="line-removed">673 </span>
<span class="line-removed">674             @Override</span>
<span class="line-removed">675             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">676                                               int statusCode,</span>
<span class="line-removed">677                                               String reason) {</span>
<span class="line-removed">678                 actual.complete(collected);</span>
<span class="line-removed">679                 return null;</span>
<span class="line-removed">680             }</span>
681 
<a name="46" id="anc46"></a><span class="line-modified">682             @Override</span>
<span class="line-modified">683             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">684                 actual.completeExceptionally(error);</span>
<span class="line-modified">685             }</span>
























686 
<a name="47" id="anc47"></a><span class="line-modified">687             public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">688                                             CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-modified">689                 StringBuilder b = new StringBuilder();</span>
<span class="line-modified">690                 data.forEach(b::append);</span>
<span class="line-modified">691                 String s = b.toString();</span>
<span class="line-modified">692                 System.out.println(s);</span>
<span class="line-modified">693                 cf.complete(null);</span>
<span class="line-removed">694                 collected.add(s);</span>
<span class="line-removed">695             }</span>
<span class="line-removed">696         };</span>
697 
<a name="48" id="anc48"></a><span class="line-modified">698         webSocket = newBuilder()</span>
<span class="line-modified">699                 .proxy(NO_PROXY)</span>
<span class="line-modified">700                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">701                 .build().newWebSocketBuilder()</span>
<span class="line-removed">702                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">703                 .join();</span>
704 
<a name="49" id="anc49"></a><span class="line-modified">705         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">706         assertEquals(a, expected);</span>








707 
<a name="50" id="anc50"></a><span class="line-modified">708         server.close();</span>












709     }
710 
711     // -- authentication specific tests
712 
713     /*
714      * Ensures authentication succeeds when an Authenticator set on client builder.
715      */
716     @Test
717     public void clientAuthenticate() throws IOException  {
718         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)){
719             server.open();
720 
721             var webSocket = newBuilder()
722                     .proxy(NO_PROXY)
723                     .authenticator(new WSAuthenticator())
724                     .build()
725                     .newWebSocketBuilder()
726                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
727                     .join();
<a name="51" id="anc51"></a>
728         }
729     }
730 
731     /*
732      * Ensures authentication succeeds when an `Authorization` header is explicitly set.
733      */
734     @Test
735     public void explicitAuthenticate() throws IOException  {
736         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
737             server.open();
738 
739             String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
740                     (USERNAME + &quot;:&quot; + PASSWORD).getBytes(UTF_8));
741 
742             var webSocket = newBuilder()
743                     .proxy(NO_PROXY).build()
744                     .newWebSocketBuilder()
745                     .header(&quot;Authorization&quot;, hv)
746                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
747                     .join();
<a name="52" id="anc52"></a>
748         }
749     }
750 
751     /*
752      * Ensures authentication does not succeed when no authenticator is present.
753      */
754     @Test
755     public void failNoAuthenticator() throws IOException  {
756         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
757             server.open();
758 
759             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
760                     .proxy(NO_PROXY).build()
761                     .newWebSocketBuilder()
762                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
763 
764             try {
765                 var webSocket = cf.join();
<a name="53" id="anc53"></a>
766                 fail(&quot;Expected exception not thrown&quot;);
767             } catch (CompletionException expected) {
768                 WebSocketHandshakeException e = (WebSocketHandshakeException)expected.getCause();
769                 HttpResponse&lt;?&gt; response = e.getResponse();
770                 assertEquals(response.statusCode(), 401);
771             }
772         }
773     }
774 
775     /*
776      * Ensures authentication does not succeed when the authenticator presents
777      * unauthorized credentials.
778      */
779     @Test
780     public void failBadCredentials() throws IOException  {
781         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
782             server.open();
783 
784             Authenticator authenticator = new Authenticator() {
785                 @Override protected PasswordAuthentication getPasswordAuthentication() {
<a name="54" id="anc54"></a><span class="line-modified">786                     return new PasswordAuthentication(&quot;BAD&quot;+USERNAME, &quot;&quot;.toCharArray());</span>
787                 }
788             };
789 
790             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
791                     .proxy(NO_PROXY)
792                     .authenticator(authenticator)
793                     .build()
794                     .newWebSocketBuilder()
795                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
796 
797             try {
798                 var webSocket = cf.join();
<a name="55" id="anc55"></a>
799                 fail(&quot;Expected exception not thrown&quot;);
800             } catch (CompletionException expected) {
801                 System.out.println(&quot;caught expected exception:&quot; + expected);
802             }
803         }
804     }
<a name="56" id="anc56"></a>




805 }
<a name="57" id="anc57"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="57" type="hidden" />
</body>
</html>