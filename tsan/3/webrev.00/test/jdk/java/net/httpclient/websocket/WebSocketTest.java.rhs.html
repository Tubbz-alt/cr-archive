<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/httpclient/websocket/WebSocketTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8217429
 27  * @build DummyWebSocketServer
 28  * @run testng/othervm
 29  *       WebSocketTest
 30  */
 31 
<a name="1" id="anc1"></a>
 32 import org.testng.annotations.DataProvider;
 33 import org.testng.annotations.Test;
 34 
 35 import java.io.IOException;
 36 import java.net.Authenticator;
 37 import java.net.PasswordAuthentication;
 38 import java.net.http.HttpResponse;
 39 import java.net.http.WebSocket;
 40 import java.net.http.WebSocketHandshakeException;
 41 import java.nio.ByteBuffer;
 42 import java.nio.charset.StandardCharsets;
 43 import java.util.ArrayList;
 44 import java.util.Base64;
 45 import java.util.List;
 46 import java.util.concurrent.CompletableFuture;
 47 import java.util.concurrent.CompletionException;
 48 import java.util.concurrent.CompletionStage;
 49 import java.util.concurrent.TimeUnit;
 50 import java.util.concurrent.atomic.AtomicBoolean;
 51 import java.util.function.Function;
 52 import java.util.function.Supplier;
 53 import java.util.stream.Collectors;
 54 
 55 import static java.net.http.HttpClient.Builder.NO_PROXY;
 56 import static java.net.http.HttpClient.newBuilder;
 57 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 58 import static java.nio.charset.StandardCharsets.UTF_8;
 59 import static org.testng.Assert.assertEquals;
 60 import static org.testng.Assert.assertThrows;
 61 import static org.testng.Assert.fail;
 62 
 63 public class WebSocketTest {
 64 
 65     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 66     private static final Class&lt;IllegalStateException&gt; ISE = IllegalStateException.class;
 67     private static final Class&lt;IOException&gt; IOE = IOException.class;
 68 
 69     /* shortcut */
 70     private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
 71                                     CompletionStage&lt;?&gt; stage) {
 72         Support.assertCompletesExceptionally(clazz, stage);
 73     }
 74 
<a name="2" id="anc2"></a>











 75     @Test
 76     public void illegalArgument() throws IOException {
<a name="3" id="anc3"></a><span class="line-modified"> 77         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified"> 78             server.open();</span>
<span class="line-modified"> 79             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified"> 80                     .newWebSocketBuilder()</span>
<span class="line-modified"> 81                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified"> 82                     .join();</span>
<span class="line-modified"> 83             try {</span>
<span class="line-modified"> 84                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 85                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 86                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified"> 87                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified"> 88                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified"> 89 </span>
<span class="line-modified"> 90                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified"> 91                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified"> 92                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified"> 93                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified"> 94                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified"> 95 </span>
<span class="line-modified"> 96                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified"> 97                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified"> 98                 assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified"> 99                 assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">100 </span>
<span class="line-modified">101                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">102                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">103                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">104                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">105                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">106                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">107                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">108                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">109 </span>
<span class="line-modified">110                 assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">111                 assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">112                 assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">113                 assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">114                 assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">115                 assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">116                 assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">117                 assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">118                 assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">119                 assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">120                 assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">121                 assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">122                 assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">123                 assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">124                 assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">125                 assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">126                 assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">127                 assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">128                 assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">129                 assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">130                 assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">131                 assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">132 </span>
<span class="line-modified">133                 assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">134                 assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">135                 assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">136                 assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">137 </span>
<span class="line-modified">138             } finally {</span>
<span class="line-added">139                 webSocket.abort();</span>
<span class="line-added">140             }</span>
<span class="line-added">141         }</span>
142     }
143 
144     @Test
145     public void partialBinaryThenText() throws IOException {
<a name="4" id="anc4"></a><span class="line-modified">146         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">147             server.open();</span>
<span class="line-modified">148             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">149                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">150                     .join();</span>
<span class="line-modified">151             try {</span>
<span class="line-modified">152                 webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">153                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">154                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">155                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">156                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">157                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-added">158             } finally {</span>
<span class="line-added">159                 webSocket.abort();</span>
<span class="line-added">160             }</span>
<span class="line-added">161         }</span>
162     }
163 
164     @Test
165     public void partialTextThenBinary() throws IOException {
<a name="5" id="anc5"></a><span class="line-modified">166         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">167             server.open();</span>
<span class="line-modified">168             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">169                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">170                     .join();</span>
<span class="line-modified">171             try {</span>
<span class="line-modified">172                 webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">173                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">174                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">175                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">176                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">177                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">178             } finally {</span>
<span class="line-added">179                 webSocket.abort();</span>
<span class="line-added">180             }</span>
<span class="line-added">181         }</span>
182     }
183 
184     @Test
185     public void sendMethodsThrowIOE1() throws IOException {
<a name="6" id="anc6"></a><span class="line-modified">186         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">187             server.open();</span>
<span class="line-modified">188             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">189                     .newWebSocketBuilder()</span>
<span class="line-modified">190                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">191                     .join();</span>
<span class="line-modified">192             try {</span>
<span class="line-modified">193                 webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">194 </span>
<span class="line-modified">195                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">196 </span>
<span class="line-modified">197                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">198                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">199                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">200                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">201                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">202                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">203                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">204                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">205 </span>
<span class="line-modified">206                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">207                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">208                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">209                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">210 </span>
<span class="line-modified">211                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">212                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">213                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">214                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">215             } finally {</span>
<span class="line-modified">216                 webSocket.abort();</span>
<span class="line-added">217             }</span>
<span class="line-added">218         }</span>
219     }
220 
221     @DataProvider(name = &quot;sequence&quot;)
222     public Object[][] data1() {
223         int[] CLOSE = {
224                 0x81, 0x00, // &quot;&quot;
225                 0x82, 0x00, // []
226                 0x89, 0x00, // &lt;PING&gt;
227                 0x8a, 0x00, // &lt;PONG&gt;
228                 0x88, 0x00, // &lt;CLOSE&gt;
229         };
230         int[] ERROR = {
231                 0x81, 0x00, // &quot;&quot;
232                 0x82, 0x00, // []
233                 0x89, 0x00, // &lt;PING&gt;
234                 0x8a, 0x00, // &lt;PONG&gt;
235                 0x8b, 0x00, // 0xB control frame (causes an error)
236         };
237         return new Object[][]{
238                 {CLOSE, 1},
239                 {CLOSE, 3},
240                 {CLOSE, 4},
241                 {CLOSE, Long.MAX_VALUE},
242                 {ERROR, 1},
243                 {ERROR, 3},
244                 {ERROR, 4},
245                 {ERROR, Long.MAX_VALUE},
246         };
247     }
248 
249     @Test(dataProvider = &quot;sequence&quot;)
250     public void listenerSequentialOrder(int[] binary, long requestSize)
251             throws IOException
252     {
<a name="7" id="anc7"></a><span class="line-added">253         try (var server = Support.serverWithCannedData(binary)) {</span>
<span class="line-added">254             server.open();</span>
255 
<a name="8" id="anc8"></a><span class="line-modified">256             CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>



257 
<a name="9" id="anc9"></a><span class="line-modified">258             MockListener listener = new MockListener(requestSize) {</span>
259 
<a name="10" id="anc10"></a><span class="line-modified">260                 final AtomicBoolean guard = new AtomicBoolean();</span>
261 
<a name="11" id="anc11"></a><span class="line-modified">262                 private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">263                     if (guard.getAndSet(true)) {</span>






264                         violation.completeExceptionally(new RuntimeException());
265                     }
<a name="12" id="anc12"></a><span class="line-added">266                     try {</span>
<span class="line-added">267                         return action.get();</span>
<span class="line-added">268                     } finally {</span>
<span class="line-added">269                         if (!guard.getAndSet(false)) {</span>
<span class="line-added">270                             violation.completeExceptionally(new RuntimeException());</span>
<span class="line-added">271                         }</span>
<span class="line-added">272                     }</span>
273                 }
<a name="13" id="anc13"></a>








274 
<a name="14" id="anc14"></a><span class="line-modified">275                 @Override</span>
<span class="line-modified">276                 public void onOpen(WebSocket webSocket) {</span>
<span class="line-modified">277                     checkRunExclusively(() -&gt; {</span>
<span class="line-modified">278                         super.onOpen(webSocket);</span>
<span class="line-modified">279                         return null;</span>
<span class="line-modified">280                     });</span>
<span class="line-modified">281                 }</span>















282 
<a name="15" id="anc15"></a><span class="line-modified">283                 @Override</span>
<span class="line-modified">284                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">285                                                  CharSequence data,</span>
<span class="line-modified">286                                                  boolean last) {</span>
<span class="line-modified">287                     return checkRunExclusively(</span>
<span class="line-modified">288                             () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-added">289                 }</span>
290 
<a name="16" id="anc16"></a><span class="line-modified">291                 @Override</span>
<span class="line-modified">292                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">293                                                    ByteBuffer data,</span>
<span class="line-modified">294                                                    boolean last) {</span>
<span class="line-modified">295                     return checkRunExclusively(</span>
<span class="line-modified">296                             () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-modified">297                 }</span>
298 
<a name="17" id="anc17"></a><span class="line-modified">299                 @Override</span>
<span class="line-modified">300                 public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-modified">301                                                  ByteBuffer message) {</span>
<span class="line-modified">302                     return checkRunExclusively(</span>
<span class="line-modified">303                             () -&gt; super.onPing(webSocket, message));</span>
<span class="line-modified">304                 }</span>


305 
<a name="18" id="anc18"></a><span class="line-modified">306                 @Override</span>
<span class="line-modified">307                 public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">308                                                  ByteBuffer message) {</span>
<span class="line-added">309                     return checkRunExclusively(</span>
<span class="line-added">310                             () -&gt; super.onPong(webSocket, message));</span>
<span class="line-added">311                 }</span>
312 
<a name="19" id="anc19"></a><span class="line-added">313                 @Override</span>
<span class="line-added">314                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">315                                                   int statusCode,</span>
<span class="line-added">316                                                   String reason) {</span>
<span class="line-added">317                     return checkRunExclusively(</span>
<span class="line-added">318                             () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-added">319                 }</span>
320 
<a name="20" id="anc20"></a><span class="line-modified">321                 @Override</span>
<span class="line-modified">322                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">323                     checkRunExclusively(() -&gt; {</span>
<span class="line-added">324                         super.onError(webSocket, error);</span>
<span class="line-added">325                         return null;</span>
<span class="line-added">326                     });</span>
<span class="line-added">327                 }</span>
<span class="line-added">328             };</span>
329 
<a name="21" id="anc21"></a><span class="line-modified">330             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">331                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">332                     .join();</span>
<span class="line-added">333             try {</span>
<span class="line-added">334                 listener.invocations();</span>
<span class="line-added">335                 violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-added">336                 violation.join();</span>
<span class="line-added">337             } finally {</span>
<span class="line-added">338                 webSocket.abort();</span>
<span class="line-added">339             }</span>
<span class="line-added">340         }</span>
341     }
342 
343     @Test
344     public void sendMethodsThrowIOE2() throws Exception {
<a name="22" id="anc22"></a><span class="line-modified">345         try (var server = Support.serverWithCannedData(0x88, 0x00)) {</span>
<span class="line-modified">346             server.open();</span>






































347 
<a name="23" id="anc23"></a><span class="line-modified">348             CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">349             CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">350 </span>
<span class="line-modified">351             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-added">352                 @Override</span>
<span class="line-added">353                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">354                                                   int statusCode,</span>
<span class="line-added">355                                                   String reason) {</span>
<span class="line-added">356                     System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-added">357                     onCloseCalled.complete(null);</span>
<span class="line-added">358                     return canClose;</span>
<span class="line-added">359                 }</span>
360 
<a name="24" id="anc24"></a><span class="line-modified">361                 @Override</span>
<span class="line-modified">362                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">363                     System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-modified">364                     onCloseCalled.completeExceptionally(error);</span>
<span class="line-added">365                 }</span>
<span class="line-added">366             };</span>
367 
<a name="25" id="anc25"></a><span class="line-modified">368             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">369                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">370                     .join();</span>
<span class="line-added">371             try {</span>
<span class="line-added">372                 onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-added">373                 canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-added">374                 TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-added">375 </span>
<span class="line-added">376                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-added">377 </span>
<span class="line-added">378                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-added">379                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-added">380                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-added">381                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-added">382                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-added">383                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-added">384                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-added">385                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-added">386 </span>
<span class="line-added">387                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-added">388                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-added">389                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-added">390                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-added">391 </span>
<span class="line-added">392                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-added">393                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-added">394                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-added">395                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-added">396             } finally {</span>
<span class="line-added">397                 webSocket.abort();</span>
<span class="line-added">398             }</span>
<span class="line-added">399         }</span>
400     }
401 
402     // Used to verify a server requiring Authentication
403     private static final String USERNAME = &quot;chegar&quot;;
404     private static final String PASSWORD = &quot;a1b2c3&quot;;
405 
406     static class WSAuthenticator extends Authenticator {
407         @Override
408         protected PasswordAuthentication getPasswordAuthentication() {
409             return new PasswordAuthentication(USERNAME, PASSWORD.toCharArray());
410         }
411     }
412 
413     static final Function&lt;int[],DummyWebSocketServer&gt; SERVER_WITH_CANNED_DATA =
414         new Function&lt;&gt;() {
415             @Override public DummyWebSocketServer apply(int[] data) {
416                 return Support.serverWithCannedData(data); }
417             @Override public String toString() { return &quot;SERVER_WITH_CANNED_DATA&quot;; }
418         };
419 
420     static final Function&lt;int[],DummyWebSocketServer&gt; AUTH_SERVER_WITH_CANNED_DATA =
421         new Function&lt;&gt;() {
422             @Override public DummyWebSocketServer apply(int[] data) {
423                 return Support.serverWithCannedDataAndAuthentication(USERNAME, PASSWORD, data); }
424             @Override public String toString() { return &quot;AUTH_SERVER_WITH_CANNED_DATA&quot;; }
425         };
426 
427     @DataProvider(name = &quot;servers&quot;)
428     public Object[][] servers() {
429         return new Object[][] {
430             { SERVER_WITH_CANNED_DATA },
431             { AUTH_SERVER_WITH_CANNED_DATA },
432         };
433     }
434 
435     @Test(dataProvider = &quot;servers&quot;)
436     public void simpleAggregatingBinaryMessages
437             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
438         throws IOException
439     {
440         List&lt;byte[]&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;)
441                 .stream()
442                 .map(s -&gt; s.getBytes(StandardCharsets.US_ASCII))
443                 .collect(Collectors.toList());
444         int[] binary = new int[]{
445                 0x82, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // [alpha]
446                 0x02, 0x02, 0x62, 0x65,                   // [be
447                 0x80, 0x02, 0x74, 0x61,                   // ta]
448                 0x02, 0x01, 0x67,                         // [g
449                 0x00, 0x01, 0x61,                         // a
450                 0x00, 0x00,                               //
451                 0x00, 0x00,                               //
452                 0x00, 0x01, 0x6d,                         // m
453                 0x00, 0x01, 0x6d,                         // m
454                 0x80, 0x01, 0x61,                         // a]
455                 0x8a, 0x00,                               // &lt;PONG&gt;
456                 0x02, 0x04, 0x64, 0x65, 0x6c, 0x74,       // [delt
457                 0x00, 0x01, 0x61,                         // a
458                 0x80, 0x00,                               // ]
459                 0x88, 0x00                                // &lt;CLOSE&gt;
460         };
461         CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
462 
<a name="26" id="anc26"></a><span class="line-modified">463         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">464             server.open();</span>
465 
<a name="27" id="anc27"></a><span class="line-modified">466             WebSocket.Listener listener = new WebSocket.Listener() {</span>
467 
<a name="28" id="anc28"></a><span class="line-modified">468                 List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">469                 ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
470 
<a name="29" id="anc29"></a><span class="line-modified">471                 @Override</span>
<span class="line-modified">472                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">473                                                    ByteBuffer message,</span>
<span class="line-modified">474                                                    boolean last) {</span>
<span class="line-modified">475                     System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">476                     webSocket.request(1);</span>
477 
<a name="30" id="anc30"></a><span class="line-modified">478                     append(message);</span>
<span class="line-modified">479                     if (last) {</span>
<span class="line-modified">480                         buffer.flip();</span>
<span class="line-modified">481                         byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">482                         buffer.get(bytes);</span>
<span class="line-modified">483                         buffer.clear();</span>
<span class="line-modified">484                         processWholeBinary(bytes);</span>
<span class="line-added">485                     }</span>
<span class="line-added">486                     return null;</span>
487                 }
<a name="31" id="anc31"></a>

488 
<a name="32" id="anc32"></a><span class="line-modified">489                 private void append(ByteBuffer message) {</span>
<span class="line-modified">490                     if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">491                         assert message.remaining() &gt; 0;</span>
<span class="line-modified">492                         int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">493                         ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">494                         b.put(buffer.flip());</span>
<span class="line-modified">495                         buffer = b;</span>
<span class="line-added">496                     }</span>
<span class="line-added">497                     buffer.put(message);</span>
498                 }
<a name="33" id="anc33"></a>

499 
<a name="34" id="anc34"></a><span class="line-modified">500                 private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">501                     String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">502                     System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">503                     collectedBytes.add(bytes);</span>
<span class="line-modified">504                 }</span>














505 
<a name="35" id="anc35"></a><span class="line-modified">506                 @Override</span>
<span class="line-modified">507                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">508                                                   int statusCode,</span>
<span class="line-modified">509                                                   String reason) {</span>
<span class="line-modified">510                     actual.complete(collectedBytes);</span>
<span class="line-modified">511                     return null;</span>
<span class="line-added">512                 }</span>
513 
<a name="36" id="anc36"></a><span class="line-modified">514                 @Override</span>
<span class="line-modified">515                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">516                     actual.completeExceptionally(error);</span>
<span class="line-added">517                 }</span>
<span class="line-added">518             };</span>
519 
<a name="37" id="anc37"></a><span class="line-modified">520             var webSocket = newBuilder()</span>
<span class="line-added">521                     .proxy(NO_PROXY)</span>
<span class="line-added">522                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">523                     .build().newWebSocketBuilder()</span>
<span class="line-added">524                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">525                     .join();</span>
<span class="line-added">526             try {</span>
<span class="line-added">527                 List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-added">528                 assertEquals(a, expected);</span>
<span class="line-added">529             } finally {</span>
<span class="line-added">530                 webSocket.abort();</span>
<span class="line-added">531             }</span>
<span class="line-added">532         }</span>
533     }
534 
535     @Test(dataProvider = &quot;servers&quot;)
536     public void simpleAggregatingTextMessages
537             (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
538         throws IOException
539     {
540         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
541 
542         int[] binary = new int[]{
543                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
544                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
545                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
546                 0x01, 0x01, 0x67,                         // &quot;g
547                 0x00, 0x01, 0x61,                         // a
548                 0x00, 0x00,                               //
549                 0x00, 0x00,                               //
550                 0x00, 0x01, 0x6d,                         // m
551                 0x00, 0x01, 0x6d,                         // m
552                 0x80, 0x01, 0x61,                         // a&quot;
553                 0x8a, 0x00,                               // &lt;PONG&gt;
554                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
555                 0x00, 0x01, 0x61,                         // a
556                 0x80, 0x00,                               // &quot;
557                 0x88, 0x00                                // &lt;CLOSE&gt;
558         };
559         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
560 
<a name="38" id="anc38"></a><span class="line-modified">561         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">562             server.open();</span>




















563 
<a name="39" id="anc39"></a><span class="line-modified">564             WebSocket.Listener listener = new WebSocket.Listener() {</span>



565 
<a name="40" id="anc40"></a><span class="line-modified">566                 List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-modified">567                 StringBuilder text = new StringBuilder();</span>





568 
<a name="41" id="anc41"></a><span class="line-modified">569                 @Override</span>
<span class="line-modified">570                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">571                                                  CharSequence message,</span>
<span class="line-modified">572                                                  boolean last) {</span>
<span class="line-modified">573                     System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-added">574                     webSocket.request(1);</span>
<span class="line-added">575                     text.append(message);</span>
<span class="line-added">576                     if (last) {</span>
<span class="line-added">577                         String str = text.toString();</span>
<span class="line-added">578                         text.setLength(0);</span>
<span class="line-added">579                         processWholeText(str);</span>
<span class="line-added">580                     }</span>
<span class="line-added">581                     return null;</span>
<span class="line-added">582                 }</span>
583 
<a name="42" id="anc42"></a><span class="line-modified">584                 private void processWholeText(String string) {</span>
<span class="line-modified">585                     System.out.println(string);</span>
<span class="line-modified">586                     collectedStrings.add(string);</span>
<span class="line-modified">587                 }</span>


588 
<a name="43" id="anc43"></a><span class="line-modified">589                 @Override</span>
<span class="line-modified">590                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">591                                                   int statusCode,</span>
<span class="line-added">592                                                   String reason) {</span>
<span class="line-added">593                     actual.complete(collectedStrings);</span>
<span class="line-added">594                     return null;</span>
<span class="line-added">595                 }</span>
596 
<a name="44" id="anc44"></a><span class="line-modified">597                 @Override</span>
<span class="line-added">598                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">599                     actual.completeExceptionally(error);</span>
<span class="line-added">600                 }</span>
<span class="line-added">601             };</span>
<span class="line-added">602 </span>
<span class="line-added">603             var webSocket = newBuilder()</span>
<span class="line-added">604                     .proxy(NO_PROXY)</span>
<span class="line-added">605                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">606                     .build().newWebSocketBuilder()</span>
<span class="line-added">607                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">608                     .join();</span>
<span class="line-added">609             try {</span>
<span class="line-added">610                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">611                 assertEquals(a, expected);</span>
<span class="line-added">612             } finally {</span>
<span class="line-added">613                 webSocket.abort();</span>
<span class="line-added">614             }</span>
<span class="line-added">615         }</span>
616     }
617 
618     /*
619      * Exercises the scenario where requests for more messages are made prior to
620      * completing the returned CompletionStage instances.
621      */
622     @Test(dataProvider = &quot;servers&quot;)
623     public void aggregatingTextMessages
624         (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
625         throws IOException
626     {
627         List&lt;String&gt; expected = List.of(&quot;alpha&quot;, &quot;beta&quot;, &quot;gamma&quot;, &quot;delta&quot;);
628 
629         int[] binary = new int[]{
630                 0x81, 0x05, 0x61, 0x6c, 0x70, 0x68, 0x61, // &quot;alpha&quot;
631                 0x01, 0x02, 0x62, 0x65,                   // &quot;be
632                 0x80, 0x02, 0x74, 0x61,                   // ta&quot;
633                 0x01, 0x01, 0x67,                         // &quot;g
634                 0x00, 0x01, 0x61,                         // a
635                 0x00, 0x00,                               //
636                 0x00, 0x00,                               //
637                 0x00, 0x01, 0x6d,                         // m
638                 0x00, 0x01, 0x6d,                         // m
639                 0x80, 0x01, 0x61,                         // a&quot;
640                 0x8a, 0x00,                               // &lt;PONG&gt;
641                 0x01, 0x04, 0x64, 0x65, 0x6c, 0x74,       // &quot;delt
642                 0x00, 0x01, 0x61,                         // a
643                 0x80, 0x00,                               // &quot;
644                 0x88, 0x00                                // &lt;CLOSE&gt;
645         };
646         CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
647 
<a name="45" id="anc45"></a><span class="line-modified">648         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">649             server.open();</span>





































650 
<a name="46" id="anc46"></a><span class="line-modified">651             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-modified">652 </span>
<span class="line-modified">653                 List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-modified">654                 /*</span>
<span class="line-added">655                  * A CompletableFuture which will complete once the current</span>
<span class="line-added">656                  * message has been fully assembled. Until then the listener</span>
<span class="line-added">657                  * returns this instance for every call.</span>
<span class="line-added">658                  */</span>
<span class="line-added">659                 CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">660                 List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-added">661 </span>
<span class="line-added">662                 @Override</span>
<span class="line-added">663                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-added">664                                                  CharSequence message,</span>
<span class="line-added">665                                                  boolean last) {</span>
<span class="line-added">666                     parts.add(message);</span>
<span class="line-added">667                     if (!last) {</span>
<span class="line-added">668                         webSocket.request(1);</span>
<span class="line-added">669                     } else {</span>
<span class="line-added">670                         this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-added">671                         CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-added">672                         processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-added">673                         currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">674                         parts.clear();</span>
<span class="line-added">675                         return refCf;</span>
<span class="line-added">676                     }</span>
<span class="line-added">677                     return currentCf;</span>
<span class="line-added">678                 }</span>
679 
<a name="47" id="anc47"></a><span class="line-modified">680                 @Override</span>
<span class="line-modified">681                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">682                                                   int statusCode,</span>
<span class="line-modified">683                                                   String reason) {</span>
<span class="line-modified">684                     actual.complete(collected);</span>
<span class="line-modified">685                     return null;</span>
<span class="line-modified">686                 }</span>



687 
<a name="48" id="anc48"></a><span class="line-modified">688                 @Override</span>
<span class="line-modified">689                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">690                     actual.completeExceptionally(error);</span>
<span class="line-modified">691                 }</span>


692 
<a name="49" id="anc49"></a><span class="line-modified">693                 public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">694                                                 CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-added">695                     StringBuilder b = new StringBuilder();</span>
<span class="line-added">696                     data.forEach(b::append);</span>
<span class="line-added">697                     String s = b.toString();</span>
<span class="line-added">698                     System.out.println(s);</span>
<span class="line-added">699                     cf.complete(null);</span>
<span class="line-added">700                     collected.add(s);</span>
<span class="line-added">701                 }</span>
<span class="line-added">702             };</span>
703 
<a name="50" id="anc50"></a><span class="line-modified">704             var webSocket = newBuilder()</span>
<span class="line-added">705                     .proxy(NO_PROXY)</span>
<span class="line-added">706                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">707                     .build().newWebSocketBuilder()</span>
<span class="line-added">708                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">709                     .join();</span>
<span class="line-added">710             try {</span>
<span class="line-added">711                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">712                 assertEquals(a, expected);</span>
<span class="line-added">713             } finally {</span>
<span class="line-added">714                 webSocket.abort();</span>
<span class="line-added">715             }</span>
<span class="line-added">716         }</span>
717     }
718 
719     // -- authentication specific tests
720 
721     /*
722      * Ensures authentication succeeds when an Authenticator set on client builder.
723      */
724     @Test
725     public void clientAuthenticate() throws IOException  {
726         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)){
727             server.open();
728 
729             var webSocket = newBuilder()
730                     .proxy(NO_PROXY)
731                     .authenticator(new WSAuthenticator())
732                     .build()
733                     .newWebSocketBuilder()
734                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
735                     .join();
<a name="51" id="anc51"></a><span class="line-added">736             webSocket.abort();</span>
737         }
738     }
739 
740     /*
741      * Ensures authentication succeeds when an `Authorization` header is explicitly set.
742      */
743     @Test
744     public void explicitAuthenticate() throws IOException  {
745         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
746             server.open();
747 
748             String hv = &quot;Basic &quot; + Base64.getEncoder().encodeToString(
749                     (USERNAME + &quot;:&quot; + PASSWORD).getBytes(UTF_8));
750 
751             var webSocket = newBuilder()
752                     .proxy(NO_PROXY).build()
753                     .newWebSocketBuilder()
754                     .header(&quot;Authorization&quot;, hv)
755                     .buildAsync(server.getURI(), new WebSocket.Listener() { })
756                     .join();
<a name="52" id="anc52"></a><span class="line-added">757             webSocket.abort();</span>
758         }
759     }
760 
761     /*
762      * Ensures authentication does not succeed when no authenticator is present.
763      */
764     @Test
765     public void failNoAuthenticator() throws IOException  {
766         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
767             server.open();
768 
769             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
770                     .proxy(NO_PROXY).build()
771                     .newWebSocketBuilder()
772                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
773 
774             try {
775                 var webSocket = cf.join();
<a name="53" id="anc53"></a><span class="line-added">776                 silentAbort(webSocket);</span>
777                 fail(&quot;Expected exception not thrown&quot;);
778             } catch (CompletionException expected) {
779                 WebSocketHandshakeException e = (WebSocketHandshakeException)expected.getCause();
780                 HttpResponse&lt;?&gt; response = e.getResponse();
781                 assertEquals(response.statusCode(), 401);
782             }
783         }
784     }
785 
786     /*
787      * Ensures authentication does not succeed when the authenticator presents
788      * unauthorized credentials.
789      */
790     @Test
791     public void failBadCredentials() throws IOException  {
792         try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
793             server.open();
794 
795             Authenticator authenticator = new Authenticator() {
796                 @Override protected PasswordAuthentication getPasswordAuthentication() {
<a name="54" id="anc54"></a><span class="line-modified">797                     return new PasswordAuthentication(&quot;BAD&quot; + USERNAME, &quot;&quot;.toCharArray());</span>
798                 }
799             };
800 
801             CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
802                     .proxy(NO_PROXY)
803                     .authenticator(authenticator)
804                     .build()
805                     .newWebSocketBuilder()
806                     .buildAsync(server.getURI(), new WebSocket.Listener() { });
807 
808             try {
809                 var webSocket = cf.join();
<a name="55" id="anc55"></a><span class="line-added">810                 silentAbort(webSocket);</span>
811                 fail(&quot;Expected exception not thrown&quot;);
812             } catch (CompletionException expected) {
813                 System.out.println(&quot;caught expected exception:&quot; + expected);
814             }
815         }
816     }
<a name="56" id="anc56"></a><span class="line-added">817     private static void silentAbort(WebSocket ws) {</span>
<span class="line-added">818         try {</span>
<span class="line-added">819             ws.abort();</span>
<span class="line-added">820         } catch (Throwable t) { }</span>
<span class="line-added">821     }</span>
822 }
<a name="57" id="anc57"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="57" type="hidden" />
</body>
</html>