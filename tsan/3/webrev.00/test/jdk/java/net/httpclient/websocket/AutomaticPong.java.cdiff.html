<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/websocket/AutomaticPong.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Abort.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SendTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/AutomaticPong.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 26,12 ***</span>
   * @build DummyWebSocketServer
   * @run testng/othervm
   *      -Djdk.internal.httpclient.websocket.debug=true
   *       AutomaticPong
   */
<span class="line-removed">- </span>
<span class="line-removed">- import org.testng.annotations.AfterTest;</span>
  import org.testng.annotations.DataProvider;
  import org.testng.annotations.Test;
  
  import java.io.IOException;
  import java.net.http.WebSocket;
<span class="line-new-header">--- 26,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,20 ***</span>
  import static org.testng.Assert.assertFalse;
  import static org.testng.Assert.assertTrue;
  import static org.testng.Assert.fail;
  
  public class AutomaticPong {
<span class="line-removed">- </span>
<span class="line-removed">-     private DummyWebSocketServer server;</span>
<span class="line-removed">-     private WebSocket webSocket;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     @AfterTest</span>
<span class="line-removed">-     public void cleanup() {</span>
<span class="line-removed">-         server.close();</span>
<span class="line-removed">-         webSocket.abort();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      /*
       * The sendClose method has been invoked and a Ping comes from the server.
       * Naturally, the client cannot reply with a Pong (the output has been
       * closed). However, this MUST not be treated as an error.
       * At this stage the server either has received or pretty soon will receive
<span class="line-new-header">--- 42,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,36 ***</span>
          int[] bytes = {
                  0x89, 0x00,                                     // ping
                  0x89, 0x06, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x3f, // ping hello?
                  0x88, 0x00,                                     // close
          };
<span class="line-modified">!         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         MockListener listener = new MockListener() {</span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">!                 /* request nothing */</span>
              }
<span class="line-modified">!         };</span>
<span class="line-removed">-         webSocket = newHttpClient()</span>
<span class="line-removed">-                 .newWebSocketBuilder()</span>
<span class="line-removed">-                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">-                 .join();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-removed">-         // now request all messages available</span>
<span class="line-removed">-         webSocket.request(Long.MAX_VALUE);</span>
<span class="line-removed">-         List&lt;MockListener.Invocation&gt; actual = listener.invocations();</span>
<span class="line-removed">-         ByteBuffer hello = ByteBuffer.wrap(&quot;hello?&quot;.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed">-         ByteBuffer empty = ByteBuffer.allocate(0);</span>
<span class="line-removed">-         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">-                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">-                 MockListener.Invocation.onPing(webSocket, empty),</span>
<span class="line-removed">-                 MockListener.Invocation.onPing(webSocket, hello),</span>
<span class="line-removed">-                 MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;)</span>
<span class="line-removed">-         );</span>
<span class="line-removed">-         assertEquals(actual, expected);</span>
      }
  
      /*
       * The server sends a number of contiguous Ping messages. The client replies
       * to these messages automatically. According to RFC 6455 a WebSocket client
<span class="line-new-header">--- 58,40 ---</span>
          int[] bytes = {
                  0x89, 0x00,                                     // ping
                  0x89, 0x06, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x3f, // ping hello?
                  0x88, 0x00,                                     // close
          };
<span class="line-modified">!         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             MockListener listener = new MockListener() {</span>
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">!                     /* request nothing */</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
<span class="line-added">+             var webSocket = newHttpClient()</span>
<span class="line-added">+                     .newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-added">+                 // now request all messages available</span>
<span class="line-added">+                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-added">+                 List&lt;MockListener.Invocation&gt; actual = listener.invocations();</span>
<span class="line-added">+                 ByteBuffer hello = ByteBuffer.wrap(&quot;hello?&quot;.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-added">+                 ByteBuffer empty = ByteBuffer.allocate(0);</span>
<span class="line-added">+                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">+                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">+                         MockListener.Invocation.onPing(webSocket, empty),</span>
<span class="line-added">+                         MockListener.Invocation.onPing(webSocket, hello),</span>
<span class="line-added">+                         MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;)</span>
<span class="line-added">+                 );</span>
<span class="line-added">+                 assertEquals(actual, expected);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
              }
<span class="line-modified">!         }</span>
      }
  
      /*
       * The server sends a number of contiguous Ping messages. The client replies
       * to these messages automatically. According to RFC 6455 a WebSocket client
</pre>
<hr />
<pre>
<span class="line-old-header">*** 129,88 ***</span>
           .noMask()
           .payloadLen(2)
          .write(buffer);
          buffer.putChar((char) 1000);
          buffer.flip();
<span class="line-modified">!         server = Support.serverWithCannedData(buffer.array());</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         MockListener listener = new MockListener();</span>
<span class="line-modified">!         webSocket = newHttpClient()</span>
<span class="line-modified">!                 .newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">!                 .join();</span>
<span class="line-modified">!         List&lt;MockListener.Invocation&gt; inv = listener.invocations();</span>
<span class="line-modified">!         assertEquals(inv.size(), nPings + 2); // n * onPing + onOpen + onClose</span>
<span class="line-modified">! </span>
<span class="line-modified">!         ByteBuffer data = server.read();</span>
<span class="line-modified">!         Frame.Reader reader = new Frame.Reader();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         Frame.Consumer consumer = new Frame.Consumer() {</span>
<span class="line-modified">! </span>
<span class="line-modified">!             ByteBuffer number = ByteBuffer.allocate(4);</span>
<span class="line-modified">!             Frame.Masker masker = new Frame.Masker();</span>
<span class="line-modified">!             int i = -1;</span>
<span class="line-modified">!             boolean closed;</span>
<span class="line-modified">! </span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void fin(boolean value) { assertTrue(value); }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void rsv1(boolean value) { assertFalse(value); }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void rsv2(boolean value) { assertFalse(value); }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void rsv3(boolean value) { assertFalse(value); }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void opcode(Frame.Opcode value) {</span>
<span class="line-modified">!                 if (value == Frame.Opcode.CLOSE) {</span>
<span class="line-modified">!                     closed = true;</span>
<span class="line-modified">!                     return;</span>
                  }
<span class="line-modified">!                 assertEquals(value, Frame.Opcode.PONG);</span>
              }
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void mask(boolean value) { assertTrue(value); }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void payloadLen(long value) {</span>
<span class="line-removed">-                 if (!closed)</span>
<span class="line-removed">-                     assertEquals(value, 4);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void maskingKey(int value) {</span>
<span class="line-removed">-                 masker.mask(value);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void payloadData(ByteBuffer src) {</span>
<span class="line-removed">-                 masker.transferMasking(src, number);</span>
<span class="line-removed">-                 if (closed) {</span>
<span class="line-removed">-                     return;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 number.flip();</span>
<span class="line-removed">-                 int n = number.getInt();</span>
<span class="line-removed">-                 System.out.printf(&quot;pong number=%s%n&quot;, n);</span>
<span class="line-removed">-                 number.clear();</span>
<span class="line-removed">-                 // a Pong with the number less than the maximum of Pongs already</span>
<span class="line-removed">-                 // received MUST never be received</span>
<span class="line-removed">-                 if (i &gt;= n) {</span>
<span class="line-removed">-                     fail(String.format(&quot;i=%s, n=%s&quot;, i, n));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 i = n;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void endFrame() { }</span>
<span class="line-removed">-         };</span>
<span class="line-removed">-         while (data.hasRemaining()) {</span>
<span class="line-removed">-             reader.readFrame(data, consumer);</span>
          }
      }
  
  
      @DataProvider(name = &quot;nPings&quot;)
<span class="line-new-header">--- 121,104 ---</span>
           .noMask()
           .payloadLen(2)
          .write(buffer);
          buffer.putChar((char) 1000);
          buffer.flip();
<span class="line-modified">!         try (var server = Support.serverWithCannedData(buffer.array())) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             MockListener listener = new MockListener();</span>
<span class="line-modified">!             var webSocket = newHttpClient()</span>
<span class="line-modified">!                     .newWebSocketBuilder()</span>
<span class="line-modified">!                     .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">!                     .join();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 List&lt;MockListener.Invocation&gt; inv = listener.invocations();</span>
<span class="line-modified">!                 assertEquals(inv.size(), nPings + 2); // n * onPing + onOpen + onClose</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 ByteBuffer data = server.read();</span>
<span class="line-modified">!                 Frame.Reader reader = new Frame.Reader();</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 Frame.Consumer consumer = new Frame.Consumer() {</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     ByteBuffer number = ByteBuffer.allocate(4);</span>
<span class="line-modified">!                     Frame.Masker masker = new Frame.Masker();</span>
<span class="line-modified">!                     int i = -1;</span>
<span class="line-modified">!                     boolean closed;</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     @Override</span>
<span class="line-modified">!                     public void fin(boolean value) {</span>
<span class="line-modified">!                         assertTrue(value);</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     @Override</span>
<span class="line-modified">!                     public void rsv1(boolean value) {</span>
<span class="line-modified">!                         assertFalse(value);</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     @Override</span>
<span class="line-modified">!                     public void rsv2(boolean value) {</span>
<span class="line-modified">!                         assertFalse(value);</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     @Override</span>
<span class="line-added">+                     public void rsv3(boolean value) {</span>
<span class="line-added">+                         assertFalse(value);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void opcode(Frame.Opcode value) {</span>
<span class="line-added">+                         if (value == Frame.Opcode.CLOSE) {</span>
<span class="line-added">+                             closed = true;</span>
<span class="line-added">+                             return;</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         assertEquals(value, Frame.Opcode.PONG);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void mask(boolean value) {</span>
<span class="line-added">+                         assertTrue(value);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void payloadLen(long value) {</span>
<span class="line-added">+                         if (!closed)</span>
<span class="line-added">+                             assertEquals(value, 4);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void maskingKey(int value) {</span>
<span class="line-added">+                         masker.mask(value);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void payloadData(ByteBuffer src) {</span>
<span class="line-added">+                         masker.transferMasking(src, number);</span>
<span class="line-added">+                         if (closed) {</span>
<span class="line-added">+                             return;</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         number.flip();</span>
<span class="line-added">+                         int n = number.getInt();</span>
<span class="line-added">+                         System.out.printf(&quot;pong number=%s%n&quot;, n);</span>
<span class="line-added">+                         number.clear();</span>
<span class="line-added">+                         // a Pong with the number less than the maximum of Pongs already</span>
<span class="line-added">+                         // received MUST never be received</span>
<span class="line-added">+                         if (i &gt;= n) {</span>
<span class="line-added">+                             fail(String.format(&quot;i=%s, n=%s&quot;, i, n));</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         i = n;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+ </span>
<span class="line-added">+                     @Override</span>
<span class="line-added">+                     public void endFrame() {</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 };</span>
<span class="line-added">+                 while (data.hasRemaining()) {</span>
<span class="line-added">+                     reader.readFrame(data, consumer);</span>
                  }
<span class="line-modified">!             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
              }
          }
      }
  
  
      @DataProvider(name = &quot;nPings&quot;)
</pre>
<center><a href="Abort.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SendTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>