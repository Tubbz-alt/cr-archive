<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/httpclient/DigestEchoServer.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="AuthSchemesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="HandshakeFailureTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/DigestEchoServer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,10 +24,12 @@</span>
  import com.sun.net.httpserver.BasicAuthenticator;
  import com.sun.net.httpserver.HttpServer;
  import com.sun.net.httpserver.HttpsConfigurator;
  import com.sun.net.httpserver.HttpsParameters;
  import com.sun.net.httpserver.HttpsServer;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import java.io.Closeable;</span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
  import java.io.OutputStreamWriter;
  import java.io.PrintWriter;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,10 +80,12 @@</span>
  
      public static final boolean DEBUG =
              Boolean.parseBoolean(System.getProperty(&quot;test.debug&quot;, &quot;false&quot;));
      public static final boolean NO_LINGER =
              Boolean.parseBoolean(System.getProperty(&quot;test.nolinger&quot;, &quot;false&quot;));
<span class="udiff-line-added">+     public static final boolean TUNNEL_REQUIRES_HOST =</span>
<span class="udiff-line-added">+             Boolean.parseBoolean(System.getProperty(&quot;test.requiresHost&quot;, &quot;false&quot;));</span>
      public enum HttpAuthType {
          SERVER, PROXY, SERVER307, PROXY305
          /* add PROXY_AND_SERVER and SERVER_PROXY_NONE */
      };
      public enum HttpAuthSchemeType { NONE, BASICSERVER, BASIC, DIGEST };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1520,10 +1524,40 @@</span>
              } else {
                  super.configureAuthentication(ctxt, schemeType, auth, authType);
              }
          }
  
<span class="udiff-line-added">+         boolean badRequest(StringBuilder response, String hostport, List&lt;String&gt; hosts) {</span>
<span class="udiff-line-added">+             String message = null;</span>
<span class="udiff-line-added">+             if (hosts.isEmpty()) {</span>
<span class="udiff-line-added">+                 message = &quot;No host header provided\r\n&quot;;</span>
<span class="udiff-line-added">+             } else if (hosts.size() &gt; 1) {</span>
<span class="udiff-line-added">+                 message = &quot;Multiple host headers provided\r\n&quot;;</span>
<span class="udiff-line-added">+                 for (String h : hosts) {</span>
<span class="udiff-line-added">+                     message = message + &quot;host: &quot; + h + &quot;\r\n&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 String h = hosts.get(0);</span>
<span class="udiff-line-added">+                 if (!hostport.equalsIgnoreCase(h)</span>
<span class="udiff-line-added">+                         &amp;&amp; !hostport.equalsIgnoreCase(h + &quot;:80&quot;)</span>
<span class="udiff-line-added">+                         &amp;&amp; !hostport.equalsIgnoreCase(h + &quot;:443&quot;)) {</span>
<span class="udiff-line-added">+                     message = &quot;Bad host provided: [&quot; + h</span>
<span class="udiff-line-added">+                             + &quot;] doesnot match [&quot; + hostport + &quot;]\r\n&quot;;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (message != null) {</span>
<span class="udiff-line-added">+                 int length = message.getBytes(StandardCharsets.UTF_8).length;</span>
<span class="udiff-line-added">+                 response.append(&quot;HTTP/1.1 400 BadRequest\r\n&quot;)</span>
<span class="udiff-line-added">+                         .append(&quot;Content-Length: &quot; + length)</span>
<span class="udiff-line-added">+                         .append(&quot;\r\n\r\n&quot;)</span>
<span class="udiff-line-added">+                         .append(message);</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          boolean authorize(StringBuilder response, String requestLine, String headers) {
              if (authorization != null) {
                  return authorization.authorize(response, requestLine, headers);
              }
              response.append(&quot;HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1534,25 +1568,27 @@</span>
          private synchronized Thread pipe(InputStream is, OutputStream os, char tag, CompletableFuture&lt;Void&gt; end) {
              return new Thread(&quot;TunnelPipe(&quot;+tag+&quot;)&quot;) {
                  @Override
                  public void run() {
                      try {
<span class="udiff-line-added">+                         int c = 0;</span>
                          try {
<span class="udiff-line-removed">-                             int c;</span>
                              while ((c = is.read()) != -1) {
                                  os.write(c);
                                  os.flush();
                                  // if DEBUG prints a + or a - for each transferred
                                  // character.
                                  if (DEBUG) System.out.print(tag);
                              }
                              is.close();
<span class="udiff-line-added">+                         } catch (IOException ex) {</span>
<span class="udiff-line-added">+                             if (DEBUG || !stopped &amp;&amp; c &gt;  -1)</span>
<span class="udiff-line-added">+                                 ex.printStackTrace(System.out);</span>
<span class="udiff-line-added">+                             end.completeExceptionally(ex);</span>
                          } finally {
<span class="udiff-line-modified-removed">-                             os.close();</span>
<span class="udiff-line-modified-added">+                             try {os.close();} catch (Throwable t) {}</span>
                          }
<span class="udiff-line-removed">-                     } catch (IOException ex) {</span>
<span class="udiff-line-removed">-                         if (DEBUG) ex.printStackTrace(System.out);</span>
                      } finally {
                          end.complete(null);
                      }
                  }
              };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1598,14 +1634,16 @@</span>
          }
  
          @Override
          public void run() {
              Socket clientConnection = null;
<span class="udiff-line-added">+             Socket targetConnection = null;</span>
              try {
                  while (!stopped) {
                      System.out.println(now() + &quot;Tunnel: Waiting for client&quot;);
                      Socket toClose;
<span class="udiff-line-added">+                     targetConnection = clientConnection = null;</span>
                      try {
                          toClose = clientConnection = ss.accept();
                          if (NO_LINGER) {
                              // can be useful to trigger &quot;Connection reset by peer&quot;
                              // errors on the client side.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1615,11 +1653,10 @@</span>
                          if (DEBUG || !stopped) io.printStackTrace(System.out);
                          break;
                      }
                      System.out.println(now() + &quot;Tunnel: Client accepted&quot;);
                      StringBuilder headers = new StringBuilder();
<span class="udiff-line-removed">-                     Socket targetConnection = null;</span>
                      InputStream  ccis = clientConnection.getInputStream();
                      OutputStream ccos = clientConnection.getOutputStream();
                      Writer w = new OutputStreamWriter(
                                     clientConnection.getOutputStream(), &quot;UTF-8&quot;);
                      PrintWriter pw = new PrintWriter(w);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1633,10 +1670,11 @@</span>
                          StringTokenizer tokenizer = new StringTokenizer(requestLine);
                          String connect = tokenizer.nextToken();
                          assert connect.equalsIgnoreCase(&quot;connect&quot;);
                          String hostport = tokenizer.nextToken();
                          InetSocketAddress targetAddress;
<span class="udiff-line-added">+                         List&lt;String&gt; hosts = new ArrayList&lt;&gt;();</span>
                          try {
                              URI uri = new URI(&quot;https&quot;, hostport, &quot;/&quot;, null, null);
                              int port = uri.getPort();
                              port = port == -1 ? 443 : port;
                              targetAddress = new InetSocketAddress(uri.getHost(), port);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1657,13 +1695,34 @@</span>
                          String line = requestLine;
                          while(!line.equals(&quot;&quot;)) {
                              System.out.println(now() + &quot;Tunnel: Reading header: &quot;
                                                 + (line = readLine(ccis)));
                              headers.append(line).append(&quot;\r\n&quot;);
<span class="udiff-line-added">+                             int index = line.indexOf(&#39;:&#39;);</span>
<span class="udiff-line-added">+                             if (index &gt;= 0) {</span>
<span class="udiff-line-added">+                                 String key = line.substring(0, index).trim();</span>
<span class="udiff-line-added">+                                 if (key.equalsIgnoreCase(&quot;host&quot;)) {</span>
<span class="udiff-line-added">+                                     hosts.add(line.substring(index+1).trim());</span>
<span class="udiff-line-added">+                                 }</span>
<span class="udiff-line-added">+                             }</span>
                          }
<span class="udiff-line-removed">- </span>
                          StringBuilder response = new StringBuilder();
<span class="udiff-line-added">+                         if (TUNNEL_REQUIRES_HOST) {</span>
<span class="udiff-line-added">+                             if (badRequest(response, hostport, hosts)) {</span>
<span class="udiff-line-added">+                                 System.out.println(now() + &quot;Tunnel: Sending &quot; + response);</span>
<span class="udiff-line-added">+                                 // send the 400 response</span>
<span class="udiff-line-added">+                                 pw.print(response.toString());</span>
<span class="udiff-line-added">+                                 pw.flush();</span>
<span class="udiff-line-added">+                                 toClose.close();</span>
<span class="udiff-line-added">+                                 continue;</span>
<span class="udiff-line-added">+                             } else {</span>
<span class="udiff-line-added">+                                 assert hosts.size() == 1;</span>
<span class="udiff-line-added">+                                 System.out.println(now()</span>
<span class="udiff-line-added">+                                         + &quot;Tunnel: Host header verified &quot; + hosts);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+ </span>
                          final boolean authorize = authorize(response, requestLine, headers.toString());
                          if (!authorize) {
                              System.out.println(now() + &quot;Tunnel: Sending &quot;
                                      + response);
                              // send the 407 response
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1713,32 +1772,48 @@</span>
                      CompletableFuture&lt;Void&gt; end, end1, end2;
                      Thread t1 = pipe(ccis, targetConnection.getOutputStream(), &#39;+&#39;,
                              end1 = new CompletableFuture&lt;&gt;());
                      Thread t2 = pipe(targetConnection.getInputStream(), ccos, &#39;-&#39;,
                              end2 = new CompletableFuture&lt;&gt;());
<span class="udiff-line-modified-removed">-                     end = CompletableFuture.allOf(end1, end2);</span>
<span class="udiff-line-modified-added">+                     var end11 = end1.whenComplete((r, t) -&gt; exceptionally(end2, t));</span>
<span class="udiff-line-added">+                     var end22 = end2.whenComplete((r, t) -&gt;  exceptionally(end1, t));</span>
<span class="udiff-line-added">+                     end = CompletableFuture.allOf(end11, end22);</span>
<span class="udiff-line-added">+                     Socket tc = targetConnection;</span>
                      end.whenComplete(
                              (r,t) -&gt; {
                                  try { toClose.close(); } catch (IOException x) { }
<span class="udiff-line-added">+                                 try { tc.close(); } catch (IOException x) { }</span>
                                  finally {connectionCFs.remove(end);}
                              });
                      connectionCFs.add(end);
<span class="udiff-line-added">+                     targetConnection = clientConnection = null;</span>
                      t1.start();
                      t2.start();
                  }
              } catch (Throwable ex) {
<span class="udiff-line-modified-removed">-                 try {</span>
<span class="udiff-line-modified-removed">-                     ss.close();</span>
<span class="udiff-line-modified-removed">-                 } catch (IOException ex1) {</span>
<span class="udiff-line-removed">-                     ex.addSuppressed(ex1);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 close(clientConnection, ex);</span>
<span class="udiff-line-modified-added">+                 close(targetConnection, ex);</span>
<span class="udiff-line-modified-added">+                 close(ss, ex);</span>
                  ex.printStackTrace(System.err);
              } finally {
                  System.out.println(now() + &quot;Tunnel: exiting (stopped=&quot; + stopped + &quot;)&quot;);
                  connectionCFs.forEach(cf -&gt; cf.complete(null));
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void exceptionally(CompletableFuture&lt;?&gt; cf, Throwable t) {</span>
<span class="udiff-line-added">+             if (t != null) cf.completeExceptionally(t);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void close(Closeable c, Throwable e) {</span>
<span class="udiff-line-added">+             if (c == null) return;</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 c.close();</span>
<span class="udiff-line-added">+             } catch (IOException x) {</span>
<span class="udiff-line-added">+                 e.addSuppressed(x);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
      }
  
      /**
       * Creates a TunnelingProxy that can serve multiple servers.
       * The server address is extracted from the CONNECT request line.
</pre>
<center><a href="AuthSchemesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="HandshakeFailureTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>