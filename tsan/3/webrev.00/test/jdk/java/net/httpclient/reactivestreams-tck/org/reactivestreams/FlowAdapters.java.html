<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/httpclient/reactivestreams-tck/org/reactivestreams/FlowAdapters.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package org.reactivestreams;
 25 
 26 import java.util.concurrent.Flow;
 27 import static java.util.Objects.requireNonNull;
 28 
 29 /**
 30  * Bridge between Reactive Streams API and the Java 9 {@link java.util.concurrent.Flow} API.
 31  */
 32 public final class FlowAdapters {
 33     /** Utility class. */
 34     private FlowAdapters() {
 35         throw new IllegalStateException(&quot;No instances!&quot;);
 36     }
 37 
 38     /**
 39      * Converts a Flow Publisher into a Reactive Streams Publisher.
 40      * @param &lt;T&gt; the element type
 41      * @param flowPublisher the source Flow Publisher to convert
 42      * @return the equivalent Reactive Streams Publisher
 43      */
 44     @SuppressWarnings(&quot;unchecked&quot;)
 45     public static &lt;T&gt; org.reactivestreams.Publisher&lt;T&gt; toPublisher(
 46             Flow.Publisher&lt;? extends T&gt; flowPublisher) {
 47         requireNonNull(flowPublisher, &quot;flowPublisher&quot;);
 48         final org.reactivestreams.Publisher&lt;T&gt; publisher;
 49         if (flowPublisher instanceof FlowPublisherFromReactive) {
 50             publisher = (org.reactivestreams.Publisher&lt;T&gt;)(((FlowPublisherFromReactive&lt;T&gt;)flowPublisher).reactiveStreams);
 51         } else if (flowPublisher instanceof org.reactivestreams.Publisher) {
 52             publisher = (org.reactivestreams.Publisher&lt;T&gt;)flowPublisher;
 53         } else {
 54             publisher = new ReactivePublisherFromFlow&lt;T&gt;(flowPublisher);
 55         }
 56         return publisher;
 57     }
 58 
 59     /**
 60      * Converts a Reactive Streams Publisher into a Flow Publisher.
 61      * @param &lt;T&gt; the element type
 62      * @param reactiveStreamsPublisher the source Reactive Streams Publisher to convert
 63      * @return the equivalent Flow Publisher
 64      */
 65     @SuppressWarnings(&quot;unchecked&quot;)
 66     public static &lt;T&gt; Flow.Publisher&lt;T&gt; toFlowPublisher(
 67             org.reactivestreams.Publisher&lt;? extends T&gt; reactiveStreamsPublisher
 68     ) {
 69         requireNonNull(reactiveStreamsPublisher, &quot;reactiveStreamsPublisher&quot;);
 70         final Flow.Publisher&lt;T&gt; flowPublisher;
 71         if (reactiveStreamsPublisher instanceof ReactivePublisherFromFlow) {
 72             flowPublisher = (Flow.Publisher&lt;T&gt;)(((ReactivePublisherFromFlow&lt;T&gt;)reactiveStreamsPublisher).flow);
 73         } else if (reactiveStreamsPublisher instanceof Flow.Publisher) {
 74             flowPublisher = (Flow.Publisher&lt;T&gt;)reactiveStreamsPublisher;
 75         } else {
 76             flowPublisher = new FlowPublisherFromReactive&lt;T&gt;(reactiveStreamsPublisher);
 77         }
 78         return flowPublisher;
 79     }
 80 
 81     /**
 82      * Converts a Flow Processor into a Reactive Streams Processor.
 83      * @param &lt;T&gt; the input value type
 84      * @param &lt;U&gt; the output value type
 85      * @param flowProcessor the source Flow Processor to convert
 86      * @return the equivalent Reactive Streams Processor
 87      */
 88     @SuppressWarnings(&quot;unchecked&quot;)
 89     public static &lt;T, U&gt; org.reactivestreams.Processor&lt;T, U&gt; toProcessor(
 90             Flow.Processor&lt;? super T, ? extends U&gt; flowProcessor
 91     ) {
 92         requireNonNull(flowProcessor, &quot;flowProcessor&quot;);
 93         final org.reactivestreams.Processor&lt;T, U&gt; processor;
 94         if (flowProcessor instanceof FlowToReactiveProcessor) {
 95             processor = (org.reactivestreams.Processor&lt;T, U&gt;)(((FlowToReactiveProcessor&lt;T, U&gt;)flowProcessor).reactiveStreams);
 96         } else if (flowProcessor instanceof org.reactivestreams.Processor) {
 97             processor = (org.reactivestreams.Processor&lt;T, U&gt;)flowProcessor;
 98         } else {
 99             processor = new ReactiveToFlowProcessor&lt;T, U&gt;(flowProcessor);
100         }
101         return processor;
102     }
103 
104     /**
105      * Converts a Reactive Streams Processor into a Flow Processor.
106      * @param &lt;T&gt; the input value type
107      * @param &lt;U&gt; the output value type
108      * @param reactiveStreamsProcessor the source Reactive Streams Processor to convert
109      * @return the equivalent Flow Processor
110      */
111     @SuppressWarnings(&quot;unchecked&quot;)
112     public static &lt;T, U&gt; Flow.Processor&lt;T, U&gt; toFlowProcessor(
113             org.reactivestreams.Processor&lt;? super T, ? extends U&gt; reactiveStreamsProcessor
114         ) {
115         requireNonNull(reactiveStreamsProcessor, &quot;reactiveStreamsProcessor&quot;);
116         final Flow.Processor&lt;T, U&gt; flowProcessor;
117         if (reactiveStreamsProcessor instanceof ReactiveToFlowProcessor) {
118             flowProcessor = (Flow.Processor&lt;T, U&gt;)(((ReactiveToFlowProcessor&lt;T, U&gt;)reactiveStreamsProcessor).flow);
119         } else if (reactiveStreamsProcessor instanceof Flow.Processor) {
120             flowProcessor = (Flow.Processor&lt;T, U&gt;)reactiveStreamsProcessor;
121         } else {
122             flowProcessor = new FlowToReactiveProcessor&lt;T, U&gt;(reactiveStreamsProcessor);
123         }
124         return flowProcessor;
125     }
126 
127     /**
128      * Converts a Reactive Streams Subscriber into a Flow Subscriber.
129      * @param &lt;T&gt; the input and output value type
130      * @param reactiveStreamsSubscriber the Reactive Streams Subscriber instance to convert
131      * @return the equivalent Flow Subscriber
132      */
133     @SuppressWarnings(&quot;unchecked&quot;)
134     public static &lt;T&gt; Flow.Subscriber&lt;T&gt; toFlowSubscriber(org.reactivestreams.Subscriber&lt;T&gt; reactiveStreamsSubscriber) {
135         requireNonNull(reactiveStreamsSubscriber, &quot;reactiveStreamsSubscriber&quot;);
136         final Flow.Subscriber&lt;T&gt; flowSubscriber;
137         if (reactiveStreamsSubscriber instanceof ReactiveToFlowSubscriber) {
138             flowSubscriber = (Flow.Subscriber&lt;T&gt;)((ReactiveToFlowSubscriber&lt;T&gt;)reactiveStreamsSubscriber).flow;
139         } else if (reactiveStreamsSubscriber instanceof Flow.Subscriber) {
140             flowSubscriber = (Flow.Subscriber&lt;T&gt;)reactiveStreamsSubscriber;
141         } else {
142             flowSubscriber = new FlowToReactiveSubscriber&lt;T&gt;(reactiveStreamsSubscriber);
143         }
144         return flowSubscriber;
145     }
146 
147     /**
148      * Converts a Flow Subscriber into a Reactive Streams Subscriber.
149      * @param &lt;T&gt; the input and output value type
150      * @param flowSubscriber the Flow Subscriber instance to convert
151      * @return the equivalent Reactive Streams Subscriber
152      */
153     @SuppressWarnings(&quot;unchecked&quot;)
154     public static &lt;T&gt; org.reactivestreams.Subscriber&lt;T&gt; toSubscriber(Flow.Subscriber&lt;T&gt; flowSubscriber) {
155         requireNonNull(flowSubscriber, &quot;flowSubscriber&quot;);
156         final org.reactivestreams.Subscriber&lt;T&gt; subscriber;
157         if (flowSubscriber instanceof FlowToReactiveSubscriber) {
158             subscriber = (org.reactivestreams.Subscriber&lt;T&gt;)((FlowToReactiveSubscriber&lt;T&gt;)flowSubscriber).reactiveStreams;
159         } else if (flowSubscriber instanceof org.reactivestreams.Subscriber) {
160             subscriber = (org.reactivestreams.Subscriber&lt;T&gt;)flowSubscriber;
161         } else {
162             subscriber = new ReactiveToFlowSubscriber&lt;T&gt;(flowSubscriber);
163         }
164         return subscriber;
165     }
166 
167     /**
168      * Wraps a Reactive Streams Subscription and converts the calls to a Flow Subscription.
169      */
170     static final class FlowToReactiveSubscription implements Flow.Subscription {
171         final org.reactivestreams.Subscription reactiveStreams;
172 
173         public FlowToReactiveSubscription(org.reactivestreams.Subscription reactive) {
174             this.reactiveStreams = reactive;
175         }
176 
177         @Override
178         public void request(long n) {
179             reactiveStreams.request(n);
180         }
181 
182         @Override
183         public void cancel() {
184             reactiveStreams.cancel();
185         }
186 
187     }
188 
189     /**
190      * Wraps a Flow Subscription and converts the calls to a Reactive Streams Subscription.
191      */
192     static final class ReactiveToFlowSubscription implements org.reactivestreams.Subscription {
193         final Flow.Subscription flow;
194 
195         public ReactiveToFlowSubscription(Flow.Subscription flow) {
196             this.flow = flow;
197         }
198 
199         @Override
200         public void request(long n) {
201             flow.request(n);
202         }
203 
204         @Override
205         public void cancel() {
206             flow.cancel();
207         }
208 
209 
210     }
211 
212     /**
213      * Wraps a Reactive Streams Subscriber and forwards methods of the Flow Subscriber to it.
214      * @param &lt;T&gt; the element type
215      */
216     static final class FlowToReactiveSubscriber&lt;T&gt; implements Flow.Subscriber&lt;T&gt; {
217         final org.reactivestreams.Subscriber&lt;? super T&gt; reactiveStreams;
218 
219         public FlowToReactiveSubscriber(org.reactivestreams.Subscriber&lt;? super T&gt; reactive) {
220             this.reactiveStreams = reactive;
221         }
222 
223         @Override
224         public void onSubscribe(Flow.Subscription subscription) {
225             reactiveStreams.onSubscribe((subscription == null) ? null : new ReactiveToFlowSubscription(subscription));
226         }
227 
228         @Override
229         public void onNext(T item) {
230             reactiveStreams.onNext(item);
231         }
232 
233         @Override
234         public void onError(Throwable throwable) {
235             reactiveStreams.onError(throwable);
236         }
237 
238         @Override
239         public void onComplete() {
240             reactiveStreams.onComplete();
241         }
242 
243     }
244 
245     /**
246      * Wraps a Flow Subscriber and forwards methods of the Reactive Streams Subscriber to it.
247      * @param &lt;T&gt; the element type
248      */
249     static final class ReactiveToFlowSubscriber&lt;T&gt; implements org.reactivestreams.Subscriber&lt;T&gt; {
250         final Flow.Subscriber&lt;? super T&gt; flow;
251 
252         public ReactiveToFlowSubscriber(Flow.Subscriber&lt;? super T&gt; flow) {
253             this.flow = flow;
254         }
255 
256         @Override
257         public void onSubscribe(org.reactivestreams.Subscription subscription) {
258             flow.onSubscribe((subscription == null) ? null : new FlowToReactiveSubscription(subscription));
259         }
260 
261         @Override
262         public void onNext(T item) {
263             flow.onNext(item);
264         }
265 
266         @Override
267         public void onError(Throwable throwable) {
268             flow.onError(throwable);
269         }
270 
271         @Override
272         public void onComplete() {
273             flow.onComplete();
274         }
275 
276     }
277 
278     /**
279      * Wraps a Flow Processor and forwards methods of the Reactive Streams Processor to it.
280      * @param &lt;T&gt; the input type
281      * @param &lt;U&gt; the output type
282      */
283     static final class ReactiveToFlowProcessor&lt;T, U&gt; implements org.reactivestreams.Processor&lt;T, U&gt; {
284         final Flow.Processor&lt;? super T, ? extends U&gt; flow;
285 
286         public ReactiveToFlowProcessor(Flow.Processor&lt;? super T, ? extends U&gt; flow) {
287             this.flow = flow;
288         }
289 
290         @Override
291         public void onSubscribe(org.reactivestreams.Subscription subscription) {
292             flow.onSubscribe((subscription == null) ? null : new FlowToReactiveSubscription(subscription));
293         }
294 
295         @Override
296         public void onNext(T t) {
297             flow.onNext(t);
298         }
299 
300         @Override
301         public void onError(Throwable t) {
302             flow.onError(t);
303         }
304 
305         @Override
306         public void onComplete() {
307             flow.onComplete();
308         }
309 
310         @Override
311         public void subscribe(org.reactivestreams.Subscriber&lt;? super U&gt; s) {
312             flow.subscribe((s == null) ? null : new FlowToReactiveSubscriber&lt;U&gt;(s));
313         }
314     }
315 
316     /**
317      * Wraps a Reactive Streams Processor and forwards methods of the Flow Processor to it.
318      * @param &lt;T&gt; the input type
319      * @param &lt;U&gt; the output type
320      */
321     static final class FlowToReactiveProcessor&lt;T, U&gt; implements Flow.Processor&lt;T, U&gt; {
322         final org.reactivestreams.Processor&lt;? super T, ? extends U&gt; reactiveStreams;
323 
324         public FlowToReactiveProcessor(org.reactivestreams.Processor&lt;? super T, ? extends U&gt; reactive) {
325             this.reactiveStreams = reactive;
326         }
327 
328         @Override
329         public void onSubscribe(Flow.Subscription subscription) {
330             reactiveStreams.onSubscribe((subscription == null) ? null : new ReactiveToFlowSubscription(subscription));
331         }
332 
333         @Override
334         public void onNext(T t) {
335             reactiveStreams.onNext(t);
336         }
337 
338         @Override
339         public void onError(Throwable t) {
340             reactiveStreams.onError(t);
341         }
342 
343         @Override
344         public void onComplete() {
345             reactiveStreams.onComplete();
346         }
347 
348         @Override
349         public void subscribe(Flow.Subscriber&lt;? super U&gt; s) {
350             reactiveStreams.subscribe((s == null) ? null : new ReactiveToFlowSubscriber&lt;U&gt;(s));
351         }
352     }
353 
354     /**
355      * Reactive Streams Publisher that wraps a Flow Publisher.
356      * @param &lt;T&gt; the element type
357      */
358     static final class ReactivePublisherFromFlow&lt;T&gt; implements org.reactivestreams.Publisher&lt;T&gt; {
359         final Flow.Publisher&lt;? extends T&gt; flow;
360 
361         public ReactivePublisherFromFlow(Flow.Publisher&lt;? extends T&gt; flowPublisher) {
362             this.flow = flowPublisher;
363         }
364 
365         @Override
366         public void subscribe(org.reactivestreams.Subscriber&lt;? super T&gt; reactive) {
367             flow.subscribe((reactive == null) ? null : new FlowToReactiveSubscriber&lt;T&gt;(reactive));
368         }
369     }
370 
371     /**
372      * Flow Publisher that wraps a Reactive Streams Publisher.
373      * @param &lt;T&gt; the element type
374      */
375     static final class FlowPublisherFromReactive&lt;T&gt; implements Flow.Publisher&lt;T&gt; {
376 
377         final org.reactivestreams.Publisher&lt;? extends T&gt; reactiveStreams;
378 
379         public FlowPublisherFromReactive(org.reactivestreams.Publisher&lt;? extends T&gt; reactivePublisher) {
380             this.reactiveStreams = reactivePublisher;
381         }
382 
383         @Override
384         public void subscribe(Flow.Subscriber&lt;? super T&gt; flow) {
385             reactiveStreams.subscribe((flow == null) ? null : new ReactiveToFlowSubscriber&lt;T&gt;(flow));
386         }
387     }
388 
389 }
    </pre>
  </body>
</html>