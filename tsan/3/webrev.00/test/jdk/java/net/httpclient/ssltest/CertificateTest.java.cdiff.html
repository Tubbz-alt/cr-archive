<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/ssltest/CertificateTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../security/filePerms/nopermissions.policy.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Server.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/ssltest/CertificateTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,106 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! import java.io.File;</span>
  import java.io.IOException;
  import java.net.URI;
  import java.net.http.HttpClient;
<span class="line-removed">- import java.net.http.HttpResponse.BodyHandlers;</span>
  import java.net.http.HttpRequest;
  import java.net.http.HttpResponse;
  import javax.net.ssl.SSLContext;
  import javax.net.ssl.SSLException;
<span class="line-modified">! import javax.net.ssl.SSLParameters;</span>
<span class="line-modified">! import static java.net.http.HttpClient.Builder.NO_PROXY;</span>
  
  /*
   * @test
   * @build Server CertificateTest
<span class="line-modified">!  * @run main/othervm CertificateTest good.keystore expectSuccess</span>
<span class="line-modified">!  * @run main/othervm CertificateTest bad.keystore expectFailure</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification
<span class="line-modified">!  *       CertificateTest bad.keystore expectSuccess</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=true
<span class="line-modified">!  *       CertificateTest bad.keystore expectSuccess</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=false
<span class="line-modified">!  *       CertificateTest bad.keystore expectFailure</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=xxyyzz
<span class="line-modified">!  *       CertificateTest bad.keystore expectFailure</span>
<span class="line-modified">!  * @run main/othervm CertificateTest loopback.keystore expectSuccess</span>
   */
  
  /**
   * The test runs a number of times. In all cases it uses a valid self-signed certificate
   * that is installed in the trust store (so is trusted) and the same cert is supplied
   * by the server for its own identity. Two servers on two different ports are used
   * on the remote end.
   *
<span class="line-modified">!  * For the &quot;good&quot; run the cert contains the correct hostname of the target server</span>
   * and therefore should be accepted by the cert checking code in the client.
<span class="line-modified">!  * For the &quot;bad&quot; run, the cert contains an invalid hostname, and should be rejected.</span>
   */
  public class CertificateTest {
<span class="line-modified">!     static SSLContext ctx;</span>
<span class="line-modified">!     static SSLParameters params;</span>
      static boolean expectSuccess;
<span class="line-removed">-     static String trustStoreProp;</span>
      static Server server;
      static int port;
  
<span class="line-removed">-     static String TESTSRC = System.getProperty(&quot;test.src&quot;);</span>
      public static void main(String[] args) throws Exception
      {
          try {
<span class="line-modified">!             String keystore = args[0];</span>
<span class="line-removed">-             trustStoreProp = TESTSRC + File.separatorChar + keystore;</span>
<span class="line-removed">- </span>
              String passOrFail = args[1];
  
              if (passOrFail.equals(&quot;expectSuccess&quot;)) {
                  expectSuccess = true;
              } else {
                  expectSuccess = false;
              }
<span class="line-modified">!             server = new Server(trustStoreProp);</span>
              port = server.getPort();
<span class="line-modified">!             System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustStoreProp);</span>
<span class="line-removed">-             System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, &quot;passphrase&quot;);</span>
<span class="line-removed">-             init();</span>
<span class="line-removed">-             test(args);</span>
          } finally {
<span class="line-modified">!             server.stop();</span>
          }
      }
  
<span class="line-modified">!     static void init() throws Exception</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!         ctx = SSLContext.getDefault();</span>
<span class="line-modified">!         params = ctx.getDefaultSSLParameters();</span>
<span class="line-modified">!         //params.setProtocols(new String[] { &quot;TLSv1.2&quot; });</span>
      }
  
<span class="line-modified">!     static void test(String[] args) throws Exception</span>
      {
          String uri_s;
<span class="line-modified">!         if (args[0].equals(&quot;loopback.keystore&quot;))</span>
              uri_s = &quot;https://127.0.0.1:&quot; + Integer.toString(port) + &quot;/foo&quot;;
          else
              uri_s = &quot;https://localhost:&quot; + Integer.toString(port) + &quot;/foo&quot;;
          String error = null;
          Exception exception = null;
          System.out.println(&quot;Making request to &quot; + uri_s);
          HttpClient client = HttpClient.newBuilder()
                  .proxy(NO_PROXY)
                  .sslContext(ctx)
<span class="line-modified">!                 .sslParameters(params)</span>
                  .build();
  
          HttpRequest request = HttpRequest.newBuilder(new URI(uri_s))
                  .version(HttpClient.Version.HTTP_1_1)
                  .GET()
<span class="line-new-header">--- 19,116 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! import static java.net.http.HttpClient.Builder.NO_PROXY;</span>
<span class="line-added">+ </span>
  import java.io.IOException;
  import java.net.URI;
  import java.net.http.HttpClient;
  import java.net.http.HttpRequest;
  import java.net.http.HttpResponse;
<span class="line-added">+ import java.net.http.HttpResponse.BodyHandlers;</span>
<span class="line-added">+ </span>
  import javax.net.ssl.SSLContext;
  import javax.net.ssl.SSLException;
<span class="line-modified">! </span>
<span class="line-modified">! import jdk.test.lib.security.KeyEntry;</span>
<span class="line-added">+ import jdk.test.lib.security.KeyStoreUtils;</span>
<span class="line-added">+ import jdk.test.lib.security.SSLContextBuilder;</span>
  
  /*
   * @test
<span class="line-added">+  * @library /test/lib</span>
   * @build Server CertificateTest
<span class="line-modified">!  * @run main/othervm CertificateTest GOOD_CERT expectSuccess</span>
<span class="line-modified">!  * @run main/othervm CertificateTest BAD_CERT expectFailure</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification
<span class="line-modified">!  *       CertificateTest BAD_CERT expectSuccess</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=true
<span class="line-modified">!  *       CertificateTest BAD_CERT expectSuccess</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=false
<span class="line-modified">!  *       CertificateTest BAD_CERT expectFailure</span>
   * @run main/othervm
   *      -Djdk.internal.httpclient.disableHostnameVerification=xxyyzz
<span class="line-modified">!  *       CertificateTest BAD_CERT expectFailure</span>
<span class="line-modified">!  * @run main/othervm CertificateTest LOOPBACK_CERT expectSuccess</span>
   */
  
  /**
   * The test runs a number of times. In all cases it uses a valid self-signed certificate
   * that is installed in the trust store (so is trusted) and the same cert is supplied
   * by the server for its own identity. Two servers on two different ports are used
   * on the remote end.
   *
<span class="line-modified">!  * The GOOD_CERT cert contains the correct hostname of the target server</span>
   * and therefore should be accepted by the cert checking code in the client.
<span class="line-modified">!  * The BAD_CERT cert contains an invalid hostname, and should be rejected.</span>
<span class="line-added">+  * The LOOPBACK_CERT cert contains an invalid hostname, but it also contains a</span>
<span class="line-added">+  * subject alternative name for IP address 127.0.0.1, so it should be accepted</span>
<span class="line-added">+  * for this address.</span>
   */
  public class CertificateTest {
<span class="line-modified">! </span>
<span class="line-modified">!     private static Cert cert;</span>
      static boolean expectSuccess;
      static Server server;
      static int port;
  
      public static void main(String[] args) throws Exception
      {
          try {
<span class="line-modified">!             String certName = args[0];</span>
              String passOrFail = args[1];
  
              if (passOrFail.equals(&quot;expectSuccess&quot;)) {
                  expectSuccess = true;
              } else {
                  expectSuccess = false;
              }
<span class="line-modified">! </span>
<span class="line-added">+             cert = Cert.valueOf(certName);</span>
<span class="line-added">+             server = new Server(getSSLContext(cert));</span>
              port = server.getPort();
<span class="line-modified">!             test(cert);</span>
          } finally {
<span class="line-modified">!             if (server != null) {</span>
<span class="line-added">+                 server.stop();</span>
<span class="line-added">+             }</span>
          }
      }
  
<span class="line-modified">!     private static SSLContext getSSLContext(Cert cert) throws Exception {</span>
<span class="line-modified">!         SSLContextBuilder builder = SSLContextBuilder.builder();</span>
<span class="line-modified">!         builder.trustStore(</span>
<span class="line-modified">!                 KeyStoreUtils.createTrustStore(new String[] { cert.certStr }));</span>
<span class="line-modified">!         builder.keyStore(KeyStoreUtils.createKeyStore(</span>
<span class="line-added">+                 new KeyEntry[] { new KeyEntry(cert.keyAlgo,</span>
<span class="line-added">+                         cert.keyStr, new String[] { cert.certStr }) }));</span>
<span class="line-added">+         return builder.build();</span>
      }
  
<span class="line-modified">!     static void test(Cert cert) throws Exception</span>
      {
          String uri_s;
<span class="line-modified">!         if (cert == Cert.LOOPBACK_CERT)</span>
              uri_s = &quot;https://127.0.0.1:&quot; + Integer.toString(port) + &quot;/foo&quot;;
          else
              uri_s = &quot;https://localhost:&quot; + Integer.toString(port) + &quot;/foo&quot;;
          String error = null;
          Exception exception = null;
          System.out.println(&quot;Making request to &quot; + uri_s);
<span class="line-added">+ </span>
<span class="line-added">+         SSLContext ctx = getSSLContext(cert);</span>
          HttpClient client = HttpClient.newBuilder()
                  .proxy(NO_PROXY)
                  .sslContext(ctx)
<span class="line-modified">!                 .sslParameters(ctx.getDefaultSSLParameters())</span>
                  .build();
  
          HttpRequest request = HttpRequest.newBuilder(new URI(uri_s))
                  .version(HttpClient.Version.HTTP_1_1)
                  .GET()
</pre>
<center><a href="../security/filePerms/nopermissions.policy.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Server.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>