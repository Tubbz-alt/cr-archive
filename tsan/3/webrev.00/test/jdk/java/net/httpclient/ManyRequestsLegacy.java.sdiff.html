<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/ManyRequestsLegacy.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="LineSubscribersAndSurrogatesTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ProxyAuthDisabledSchemesSSL.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/ManyRequestsLegacy.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 57 import java.util.Optional;
 58 import java.util.concurrent.CompletableFuture;
 59 import java.util.stream.Collectors;
 60 import javax.net.ssl.SSLContext;
 61 import javax.net.ssl.SSLSession;
 62 import java.net.http.HttpClient;
 63 import java.net.http.HttpClient.Version;
 64 import java.net.http.HttpHeaders;
 65 import java.net.http.HttpRequest;
 66 import java.net.http.HttpRequest.BodyPublishers;
 67 import java.net.http.HttpResponse;
 68 import java.net.InetSocketAddress;
 69 import java.util.Arrays;
 70 import java.util.Formatter;
 71 import java.util.HashMap;
 72 import java.util.LinkedList;
 73 import java.util.Random;
 74 import java.util.logging.Logger;
 75 import java.util.logging.Level;
 76 import jdk.test.lib.net.SimpleSSLContext;

 77 
 78 public class ManyRequestsLegacy {
 79 
 80     volatile static int counter = 0;
 81 
 82     public static void main(String[] args) throws Exception {
 83         Logger logger = Logger.getLogger(&quot;com.sun.net.httpserver&quot;);
 84         logger.setLevel(Level.ALL);
 85         logger.info(&quot;TEST&quot;);
 86         System.out.println(&quot;Sending &quot; + REQUESTS
 87                          + &quot; requests; delay=&quot; + INSERT_DELAY
 88                          + &quot;, chunks=&quot; + CHUNK_SIZE
 89                          + &quot;, XFixed=&quot; + XFIXED);
 90         SSLContext ctx = new SimpleSSLContext().get();
 91         SSLContext.setDefault(ctx);
 92         HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
 93                 public boolean verify(String hostname, SSLSession session) {
 94                     return true;
 95                 }
 96             });
</pre>
<hr />
<pre>
142             public Optional&lt;SSLSession&gt; sslSession() {
143                 return Optional.empty(); // for now
144             }
145             @Override
146             public URI uri() { return request.uri();}
147             @Override
148             public HttpClient.Version version() { return Version.HTTP_1_1;}
149         }
150 
151         private void debugCompleted(String tag, long startNanos, HttpRequest req) {
152             System.err.println(tag + &quot; elapsed &quot;
153                     + (System.nanoTime() - startNanos)/1000_000L
154                     + &quot; millis for &quot; + req.method()
155                     + &quot; to &quot; + req.uri());
156         }
157 
158         CompletableFuture&lt;? extends HttpResponse&lt;byte[]&gt;&gt; sendAsync(HttpRequest r, byte[] buf) {
159             long start = System.nanoTime();
160             try {
161                 CompletableFuture&lt;LegacyHttpResponse&gt; cf = new CompletableFuture&lt;&gt;();
<span class="line-modified">162                 URLConnection urlc = r.uri().toURL().openConnection();</span>
163                 HttpURLConnection httpc = (HttpURLConnection)urlc;
164                 httpc.setRequestMethod(r.method());
165                 for (String s : r.headers().map().keySet()) {
166                     httpc.setRequestProperty(s, r.headers().allValues(s)
167                         .stream().collect(Collectors.joining(&quot;,&quot;)));
168                 }
169                 httpc.setDoInput(true);
170                 if (buf != null) httpc.setDoOutput(true);
171                 Thread t = new Thread(() -&gt; {
172                     try {
173                         if (buf != null) {
174                             try (OutputStream os = httpc.getOutputStream()) {
175                                 os.write(buf);
176                                 os.flush();
177                             }
178                         }
179                         LegacyHttpResponse response = new LegacyHttpResponse(r,
180                                 httpc.getResponseCode(),httpc.getInputStream().readAllBytes());
181                         cf.complete(response);
182                     } catch(Throwable x) {
</pre>
</td>
<td>
<hr />
<pre>
 57 import java.util.Optional;
 58 import java.util.concurrent.CompletableFuture;
 59 import java.util.stream.Collectors;
 60 import javax.net.ssl.SSLContext;
 61 import javax.net.ssl.SSLSession;
 62 import java.net.http.HttpClient;
 63 import java.net.http.HttpClient.Version;
 64 import java.net.http.HttpHeaders;
 65 import java.net.http.HttpRequest;
 66 import java.net.http.HttpRequest.BodyPublishers;
 67 import java.net.http.HttpResponse;
 68 import java.net.InetSocketAddress;
 69 import java.util.Arrays;
 70 import java.util.Formatter;
 71 import java.util.HashMap;
 72 import java.util.LinkedList;
 73 import java.util.Random;
 74 import java.util.logging.Logger;
 75 import java.util.logging.Level;
 76 import jdk.test.lib.net.SimpleSSLContext;
<span class="line-added"> 77 import static java.net.Proxy.NO_PROXY;</span>
 78 
 79 public class ManyRequestsLegacy {
 80 
 81     volatile static int counter = 0;
 82 
 83     public static void main(String[] args) throws Exception {
 84         Logger logger = Logger.getLogger(&quot;com.sun.net.httpserver&quot;);
 85         logger.setLevel(Level.ALL);
 86         logger.info(&quot;TEST&quot;);
 87         System.out.println(&quot;Sending &quot; + REQUESTS
 88                          + &quot; requests; delay=&quot; + INSERT_DELAY
 89                          + &quot;, chunks=&quot; + CHUNK_SIZE
 90                          + &quot;, XFixed=&quot; + XFIXED);
 91         SSLContext ctx = new SimpleSSLContext().get();
 92         SSLContext.setDefault(ctx);
 93         HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
 94                 public boolean verify(String hostname, SSLSession session) {
 95                     return true;
 96                 }
 97             });
</pre>
<hr />
<pre>
143             public Optional&lt;SSLSession&gt; sslSession() {
144                 return Optional.empty(); // for now
145             }
146             @Override
147             public URI uri() { return request.uri();}
148             @Override
149             public HttpClient.Version version() { return Version.HTTP_1_1;}
150         }
151 
152         private void debugCompleted(String tag, long startNanos, HttpRequest req) {
153             System.err.println(tag + &quot; elapsed &quot;
154                     + (System.nanoTime() - startNanos)/1000_000L
155                     + &quot; millis for &quot; + req.method()
156                     + &quot; to &quot; + req.uri());
157         }
158 
159         CompletableFuture&lt;? extends HttpResponse&lt;byte[]&gt;&gt; sendAsync(HttpRequest r, byte[] buf) {
160             long start = System.nanoTime();
161             try {
162                 CompletableFuture&lt;LegacyHttpResponse&gt; cf = new CompletableFuture&lt;&gt;();
<span class="line-modified">163                 URLConnection urlc = r.uri().toURL().openConnection(NO_PROXY);</span>
164                 HttpURLConnection httpc = (HttpURLConnection)urlc;
165                 httpc.setRequestMethod(r.method());
166                 for (String s : r.headers().map().keySet()) {
167                     httpc.setRequestProperty(s, r.headers().allValues(s)
168                         .stream().collect(Collectors.joining(&quot;,&quot;)));
169                 }
170                 httpc.setDoInput(true);
171                 if (buf != null) httpc.setDoOutput(true);
172                 Thread t = new Thread(() -&gt; {
173                     try {
174                         if (buf != null) {
175                             try (OutputStream os = httpc.getOutputStream()) {
176                                 os.write(buf);
177                                 os.flush();
178                             }
179                         }
180                         LegacyHttpResponse response = new LegacyHttpResponse(r,
181                                 httpc.getResponseCode(),httpc.getInputStream().readAllBytes());
182                         cf.complete(response);
183                     } catch(Throwable x) {
</pre>
</td>
</tr>
</table>
<center><a href="LineSubscribersAndSurrogatesTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ProxyAuthDisabledSchemesSSL.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>