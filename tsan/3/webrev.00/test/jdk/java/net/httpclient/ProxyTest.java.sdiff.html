<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/ProxyTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ProxyAuthDisabledSchemesSSL.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ShortRequestBody.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/ProxyTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 40 import java.net.Proxy;
 41 import java.net.ProxySelector;
 42 import java.net.ServerSocket;
 43 import java.net.Socket;
 44 import java.net.SocketAddress;
 45 import java.net.URI;
 46 import java.net.URISyntaxException;
 47 import java.nio.charset.StandardCharsets;
 48 import java.security.NoSuchAlgorithmException;
 49 import java.util.List;
 50 import java.util.concurrent.CompletableFuture;
 51 import java.util.concurrent.CopyOnWriteArrayList;
 52 import javax.net.ssl.HostnameVerifier;
 53 import javax.net.ssl.HttpsURLConnection;
 54 import javax.net.ssl.SSLContext;
 55 import javax.net.ssl.SSLSession;
 56 import java.net.http.HttpClient;
 57 import java.net.http.HttpRequest;
 58 import java.net.http.HttpResponse;
 59 import jdk.test.lib.net.SimpleSSLContext;

 60 
 61 /**
 62  * @test
 63  * @bug 8185852 8181422
 64  * @summary Verifies that passing a proxy with an unresolved address does
 65  *          not cause java.nio.channels.UnresolvedAddressException.
 66  *          Verifies that downgrading from HTTP/2 to HTTP/1.1 works through
 67  *          an SSL Tunnel connection when the client is HTTP/2 and the server
 68  *          and proxy are HTTP/1.1
 69  * @modules java.net.http
 70  * @library /test/lib
 71  * @build jdk.test.lib.net.SimpleSSLContext ProxyTest
 72  * @run main/othervm ProxyTest
 73  * @author danielfuchs
 74  */
 75 public class ProxyTest {
 76 
 77     static {
 78         try {
 79             HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
</pre>
<hr />
<pre>
150             count++;
151             return proxySelector.select(uri);
152         }
153 
154         @Override
155         public void connectFailed(URI uri, SocketAddress sa, IOException ioe) {
156             proxySelector.connectFailed(uri, sa, ioe);
157         }
158     }
159 
160     public static void test(HttpServer server, HttpClient.Version version)
161             throws IOException,
162             URISyntaxException,
163             NoSuchAlgorithmException,
164             InterruptedException
165     {
166         System.out.println(&quot;Server is: &quot; + server.getAddress().toString());
167         System.out.println(&quot;Verifying communication with server&quot;);
168         URI uri = new URI(&quot;https://localhost:&quot;
169                           + server.getAddress().getPort() + PATH + &quot;x&quot;);
<span class="line-modified">170         try (InputStream is = uri.toURL().openConnection().getInputStream()) {</span>
171             String resp = new String(is.readAllBytes(), StandardCharsets.UTF_8);
172             System.out.println(resp);
173             if (!RESPONSE.equals(resp)) {
174                 throw new AssertionError(&quot;Unexpected response from server&quot;);
175             }
176         }
177         System.out.println(&quot;Communication with server OK&quot;);
178 
179         TunnelingProxy proxy = new TunnelingProxy(server);
180         proxy.start();
181         try {
182             System.out.println(&quot;Proxy started&quot;);
183             Proxy p = new Proxy(Proxy.Type.HTTP,
184                     InetSocketAddress.createUnresolved(&quot;localhost&quot;,
185                             proxy.getAddress().getPort()));
186             System.out.println(&quot;Verifying communication with proxy&quot;);
187             HttpURLConnection conn = (HttpURLConnection)uri.toURL().openConnection(p);
188             try (InputStream is = conn.getInputStream()) {
189                 String resp = new String(is.readAllBytes(), StandardCharsets.UTF_8);
190                 System.out.println(resp);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 40 import java.net.Proxy;
 41 import java.net.ProxySelector;
 42 import java.net.ServerSocket;
 43 import java.net.Socket;
 44 import java.net.SocketAddress;
 45 import java.net.URI;
 46 import java.net.URISyntaxException;
 47 import java.nio.charset.StandardCharsets;
 48 import java.security.NoSuchAlgorithmException;
 49 import java.util.List;
 50 import java.util.concurrent.CompletableFuture;
 51 import java.util.concurrent.CopyOnWriteArrayList;
 52 import javax.net.ssl.HostnameVerifier;
 53 import javax.net.ssl.HttpsURLConnection;
 54 import javax.net.ssl.SSLContext;
 55 import javax.net.ssl.SSLSession;
 56 import java.net.http.HttpClient;
 57 import java.net.http.HttpRequest;
 58 import java.net.http.HttpResponse;
 59 import jdk.test.lib.net.SimpleSSLContext;
<span class="line-added"> 60 import static java.net.Proxy.NO_PROXY;</span>
 61 
 62 /**
 63  * @test
 64  * @bug 8185852 8181422
 65  * @summary Verifies that passing a proxy with an unresolved address does
 66  *          not cause java.nio.channels.UnresolvedAddressException.
 67  *          Verifies that downgrading from HTTP/2 to HTTP/1.1 works through
 68  *          an SSL Tunnel connection when the client is HTTP/2 and the server
 69  *          and proxy are HTTP/1.1
 70  * @modules java.net.http
 71  * @library /test/lib
 72  * @build jdk.test.lib.net.SimpleSSLContext ProxyTest
 73  * @run main/othervm ProxyTest
 74  * @author danielfuchs
 75  */
 76 public class ProxyTest {
 77 
 78     static {
 79         try {
 80             HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
</pre>
<hr />
<pre>
151             count++;
152             return proxySelector.select(uri);
153         }
154 
155         @Override
156         public void connectFailed(URI uri, SocketAddress sa, IOException ioe) {
157             proxySelector.connectFailed(uri, sa, ioe);
158         }
159     }
160 
161     public static void test(HttpServer server, HttpClient.Version version)
162             throws IOException,
163             URISyntaxException,
164             NoSuchAlgorithmException,
165             InterruptedException
166     {
167         System.out.println(&quot;Server is: &quot; + server.getAddress().toString());
168         System.out.println(&quot;Verifying communication with server&quot;);
169         URI uri = new URI(&quot;https://localhost:&quot;
170                           + server.getAddress().getPort() + PATH + &quot;x&quot;);
<span class="line-modified">171         try (InputStream is = uri.toURL().openConnection(NO_PROXY).getInputStream()) {</span>
172             String resp = new String(is.readAllBytes(), StandardCharsets.UTF_8);
173             System.out.println(resp);
174             if (!RESPONSE.equals(resp)) {
175                 throw new AssertionError(&quot;Unexpected response from server&quot;);
176             }
177         }
178         System.out.println(&quot;Communication with server OK&quot;);
179 
180         TunnelingProxy proxy = new TunnelingProxy(server);
181         proxy.start();
182         try {
183             System.out.println(&quot;Proxy started&quot;);
184             Proxy p = new Proxy(Proxy.Type.HTTP,
185                     InetSocketAddress.createUnresolved(&quot;localhost&quot;,
186                             proxy.getAddress().getPort()));
187             System.out.println(&quot;Verifying communication with proxy&quot;);
188             HttpURLConnection conn = (HttpURLConnection)uri.toURL().openConnection(p);
189             try (InputStream is = conn.getInputStream()) {
190                 String resp = new String(is.readAllBytes(), StandardCharsets.UTF_8);
191                 System.out.println(resp);
</pre>
</td>
</tr>
</table>
<center><a href="ProxyAuthDisabledSchemesSSL.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ShortRequestBody.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>