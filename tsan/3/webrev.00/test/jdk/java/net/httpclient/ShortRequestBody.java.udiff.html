<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/httpclient/ShortRequestBody.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ProxyTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ShortResponseBody.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/ShortRequestBody.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,11 @@</span>
  import java.io.UncheckedIOException;
  import java.net.InetAddress;
  import java.net.InetSocketAddress;
  import java.net.ServerSocket;
  import java.net.Socket;
<span class="udiff-line-added">+ import java.net.SocketException;</span>
  import java.net.URI;
  import java.net.http.HttpClient;
  import java.net.http.HttpRequest;
  import java.net.http.HttpRequest.BodyPublishers;
  import java.net.http.HttpResponse;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -74,10 +75,11 @@</span>
      // between client and server easier.
      static final int[] BODY_LENGTHS = new int[] { STRING_BODY.length(),
                                                    BYTE_ARRAY_BODY.length,
                                                    fileSize(FILE_BODY) };
      static final int[] BODY_OFFSETS = new int[] { 0, +1, -1, +2, -2, +3, -3 };
<span class="udiff-line-added">+     static final String MARKER = &quot;ShortRequestBody&quot;;</span>
  
      // A delegating Body Publisher. Subtypes will have a concrete body type.
      static abstract class AbstractDelegateRequestBody
              implements HttpRequest.BodyPublisher {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -132,11 +134,11 @@</span>
          clientSuppliers.add(() -&gt; sharedClient);
  
          try (Server server = new Server()) {
              for (Supplier&lt;HttpClient&gt; cs : clientSuppliers) {
                  err.println(&quot;\n---- next supplier ----\n&quot;);
<span class="udiff-line-modified-removed">-                 URI uri = new URI(&quot;http://localhost:&quot; + server.getPort() + &quot;/&quot;);</span>
<span class="udiff-line-modified-added">+                 URI uri = new URI(&quot;http://localhost:&quot; + server.getPort() + &quot;/&quot; + MARKER);</span>
  
                  // sanity ( 6 requests to keep client and server offsets easy to workout )
                  success(cs, uri, new StringRequestBody(STRING_BODY, 0));
                  success(cs, uri, new ByteArrayRequestBody(BYTE_ARRAY_BODY, 0));
                  success(cs, uri, new FileRequestBody(FILE_BODY, 0));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -246,48 +248,60 @@</span>
          public void run() {
              int count = 0;
              int offset = 0;
  
              while (!closed) {
<span class="udiff-line-added">+                 err.println(&quot;Server: waiting for connection&quot;);</span>
                  try (Socket s = ss.accept()) {
                      err.println(&quot;Server: got connection&quot;);
                      InputStream is = s.getInputStream();
<span class="udiff-line-modified-removed">-                     readRequestHeaders(is);</span>
<span class="udiff-line-modified-added">+                     try {</span>
<span class="udiff-line-added">+                         String headers = readRequestHeaders(is);</span>
<span class="udiff-line-added">+                         if (headers == null) continue;</span>
<span class="udiff-line-added">+                     } catch (SocketException ex) {</span>
<span class="udiff-line-added">+                         err.println(&quot;Ignoring unexpected exception while reading headers: &quot; + ex);</span>
<span class="udiff-line-added">+                         ex.printStackTrace(err);</span>
<span class="udiff-line-added">+                         // proceed in order to update count etc..., even though</span>
<span class="udiff-line-added">+                         // we know that read() will fail;</span>
<span class="udiff-line-added">+                     }</span>
                      byte[] ba = new byte[1024];
  
                      int length = BODY_LENGTHS[count % 3];
                      length += BODY_OFFSETS[offset];
                      err.println(&quot;Server: count=&quot; + count + &quot;, offset=&quot; + offset);
                      err.println(&quot;Server: expecting &quot; +length+ &quot; bytes&quot;);
<span class="udiff-line-modified-removed">-                     int read = is.readNBytes(ba, 0, length);</span>
<span class="udiff-line-modified-removed">-                     err.println(&quot;Server: actually read &quot; + read + &quot; bytes&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     // Update the counts before replying, to prevent the</span>
<span class="udiff-line-modified-removed">-                     // client-side racing reset with this thread.</span>
<span class="udiff-line-modified-removed">-                     count++;</span>
<span class="udiff-line-modified-removed">-                     if (count % 6 == 0) // 6 is the number of failure requests per offset</span>
<span class="udiff-line-modified-removed">-                         offset++;</span>
<span class="udiff-line-modified-removed">-                     if (count % 42 == 0) {</span>
<span class="udiff-line-modified-removed">-                         count = 0;  // reset, for second iteration</span>
<span class="udiff-line-modified-removed">-                         offset = 0;</span>
<span class="udiff-line-modified-added">+                     int read = 0;</span>
<span class="udiff-line-modified-added">+                     try {</span>
<span class="udiff-line-modified-added">+                         read = is.readNBytes(ba, 0, length);</span>
<span class="udiff-line-modified-added">+                         err.println(&quot;Server: actually read &quot; + read + &quot; bytes&quot;);</span>
<span class="udiff-line-modified-added">+                     } finally {</span>
<span class="udiff-line-modified-added">+                         // Update the counts before replying, to prevent the</span>
<span class="udiff-line-modified-added">+                         // client-side racing reset with this thread.</span>
<span class="udiff-line-modified-added">+                         count++;</span>
<span class="udiff-line-modified-added">+                         if (count % 6 == 0) // 6 is the number of failure requests per offset</span>
<span class="udiff-line-modified-added">+                             offset++;</span>
<span class="udiff-line-modified-added">+                         if (count % 42 == 0) {</span>
<span class="udiff-line-added">+                             count = 0;  // reset, for second iteration</span>
<span class="udiff-line-added">+                             offset = 0;</span>
<span class="udiff-line-added">+                         }</span>
                      }
<span class="udiff-line-removed">- </span>
                      if (read &lt; length) {
                          // no need to reply, client has already closed
                          // ensure closed
                          if (is.read() != -1)
<span class="udiff-line-modified-removed">-                             new AssertionError(&quot;Unexpected read&quot;);</span>
<span class="udiff-line-modified-added">+                             new AssertionError(&quot;Unexpected read: &quot; + read);</span>
                      } else {
                          OutputStream os = s.getOutputStream();
                          err.println(&quot;Server: writing &quot;
                                  + RESPONSE.getBytes(US_ASCII).length + &quot; bytes&quot;);
                          os.write(RESPONSE.getBytes(US_ASCII));
                      }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 } catch (IOException e) {</span>
<span class="udiff-line-modified-removed">-                     if (!closed)</span>
<span class="udiff-line-modified-removed">-                         System.out.println(&quot;Unexpected&quot; + e);</span>
<span class="udiff-line-modified-added">+                 } catch (Throwable e) {</span>
<span class="udiff-line-modified-added">+                     if (!closed) {</span>
<span class="udiff-line-modified-added">+                         err.println(&quot;Unexpected: &quot; + e);</span>
<span class="udiff-line-modified-added">+                         e.printStackTrace();</span>
<span class="udiff-line-added">+                     }</span>
                  }
              }
          }
  
          @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -304,22 +318,32 @@</span>
      }
  
      static final byte[] requestEnd = new byte[] {&#39;\r&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\n&#39; };
  
      // Read until the end of a HTTP request headers
<span class="udiff-line-modified-removed">-     static void readRequestHeaders(InputStream is) throws IOException {</span>
<span class="udiff-line-modified-removed">-         int requestEndCount = 0, r;</span>
<span class="udiff-line-modified-added">+     static String readRequestHeaders(InputStream is) throws IOException {</span>
<span class="udiff-line-modified-added">+         int requestEndCount = 0, r, eol = -1;</span>
<span class="udiff-line-added">+         StringBuilder headers = new StringBuilder();</span>
          while ((r = is.read()) != -1) {
<span class="udiff-line-added">+             if (r == &#39;\r&#39; &amp;&amp; eol &lt; 0) {</span>
<span class="udiff-line-added">+                 eol = headers.length();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             headers.append((char) r);</span>
              if (r == requestEnd[requestEndCount]) {
                  requestEndCount++;
                  if (requestEndCount == 4) {
                      break;
                  }
              } else {
                  requestEndCount = 0;
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (eol &lt;= 0) return null;</span>
<span class="udiff-line-added">+         String requestLine = headers.toString().substring(0, eol);</span>
<span class="udiff-line-added">+         if (!requestLine.contains(MARKER)) return null;</span>
<span class="udiff-line-added">+         return headers.toString();</span>
      }
  
      static int fileSize(Path p) {
          try { return (int) Files.size(p); }
          catch (IOException x) { throw new UncheckedIOException(x); }
</pre>
<center><a href="ProxyTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ShortResponseBody.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>