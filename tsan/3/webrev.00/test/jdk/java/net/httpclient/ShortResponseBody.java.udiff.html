<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/httpclient/ShortResponseBody.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ShortRequestBody.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SmokeTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/ShortResponseBody.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,17 +48,18 @@</span>
  import java.net.http.HttpResponse;
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.List;
  import java.util.concurrent.ExecutionException;
<span class="udiff-line-removed">- import java.util.concurrent.Executor;</span>
  import java.util.concurrent.ExecutorService;
  import java.util.concurrent.Executors;
  import java.util.concurrent.ThreadFactory;
  import java.util.concurrent.atomic.AtomicLong;
  import java.util.stream.Stream;
  import jdk.test.lib.net.SimpleSSLContext;
<span class="udiff-line-added">+ import org.testng.ITestContext;</span>
<span class="udiff-line-added">+ import org.testng.annotations.BeforeMethod;</span>
  import org.testng.annotations.AfterTest;
  import org.testng.annotations.BeforeTest;
  import org.testng.annotations.DataProvider;
  import org.testng.annotations.Test;
  import javax.net.ssl.SSLContext;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,10 +105,17 @@</span>
              return thread;
          }
      };
      final ExecutorService service = Executors.newCachedThreadPool(factory);
  
<span class="udiff-line-added">+     @BeforeMethod</span>
<span class="udiff-line-added">+     void beforeMethod(ITestContext context) {</span>
<span class="udiff-line-added">+         if (context.getFailedTests().size() &gt; 0) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;some tests failed&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @DataProvider(name = &quot;sanity&quot;)
      public Object[][] sanity() {
          return new Object[][]{
              { httpURIVarLen  + &quot;?length=all&quot; },
              { httpsURIVarLen + &quot;?length=all&quot; },
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -127,11 +135,11 @@</span>
                  .thenAccept(b -&gt; assertEquals(b, EXPECTED_RESPONSE_BODY))
                  .join();
      }
  
      @DataProvider(name = &quot;uris&quot;)
<span class="udiff-line-modified-removed">-     public Object[][] variants() {</span>
<span class="udiff-line-modified-added">+     public Object[][] variants(ITestContext context) {</span>
          String[][] cases = new String[][] {
              // The length query string is the total number of bytes in the reply,
              // including headers, before the server closes the connection. The
              // second arg is a partial-expected-detail message in the exception.
              { httpURIVarLen + &quot;?length=0&quot;,   &quot;no bytes&quot;     }, // EOF without receiving anything
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,10 +194,17 @@</span>
  
              { httpURIClsImed,  &quot;no bytes&quot;},
              { httpsURIClsImed, &quot;no bytes&quot;},
          };
  
<span class="udiff-line-added">+         if (context.getFailedTests().size() &gt; 0) {</span>
<span class="udiff-line-added">+             // Shorten the log output by preventing useless</span>
<span class="udiff-line-added">+             // skip traces to be printed for subsequent methods</span>
<span class="udiff-line-added">+             // if one of the previous @Test method has failed.</span>
<span class="udiff-line-added">+             return new Object[0][];</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          List&lt;Object[]&gt; list = new ArrayList&lt;&gt;();
          Arrays.asList(cases).stream()
                  .map(e -&gt; new Object[] {e[0], e[1], true})  // reuse client
                  .forEach(list::add);
          Arrays.asList(cases).stream()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -368,11 +383,10 @@</span>
                  fail(&quot;UNEXPECTED RESPONSE: &quot; + response);
              } catch (ExecutionException ee) {
                  if (ee.getCause() instanceof IOException) {
                      IOException ioe = (IOException) ee.getCause();
                      out.println(&quot;Caught expected exception:&quot; + ioe);
<span class="udiff-line-removed">-                     String msg = ioe.getMessage();</span>
  
                      List&lt;String&gt; expectedMessages = new ArrayList&lt;&gt;();
                      expectedMessages.add(expectedMsg);
                      MSGS_ORDER.stream().takeWhile(s -&gt; !s.equals(expectedMsg))
                              .forEach(expectedMessages::add);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -467,11 +481,13 @@</span>
                  return;
              closed = true;
              try {
                  ss.close();
              } catch (IOException e) {
<span class="udiff-line-modified-removed">-                 throw new UncheckedIOException(&quot;Unexpected&quot;, e);</span>
<span class="udiff-line-modified-added">+                 out.println(&quot;Unexpected exception while closing server: &quot; + e);</span>
<span class="udiff-line-added">+                 e.printStackTrace(out);</span>
<span class="udiff-line-added">+                 throw new UncheckedIOException(&quot;Unexpected: &quot;, e);</span>
              }
          }
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -492,13 +508,16 @@</span>
                  try (Socket s = ss.accept()) {
                      if (s instanceof SSLSocket) {
                          ((SSLSocket)s).startHandshake();
                      }
                      out.println(&quot;Server: got connection, closing immediately &quot;);
<span class="udiff-line-modified-removed">-                 } catch (IOException e) {</span>
<span class="udiff-line-modified-removed">-                     if (!closed)</span>
<span class="udiff-line-modified-removed">-                         throw new UncheckedIOException(&quot;Unexpected&quot;, e);</span>
<span class="udiff-line-modified-added">+                 } catch (Throwable e) {</span>
<span class="udiff-line-modified-added">+                     if (!closed) {</span>
<span class="udiff-line-modified-added">+                         out.println(&quot;Unexpected exception in server: &quot; + e);</span>
<span class="udiff-line-added">+                         e.printStackTrace(out);</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;Unexpected: &quot;, e);</span>
<span class="udiff-line-added">+                     }</span>
                  }
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -563,13 +582,16 @@</span>
                      byte[] responseBytes = response().getBytes(US_ASCII);
                      for (int i = 0; i&lt; len; i++) {
                          os.write(responseBytes[i]);
                          os.flush();
                      }
<span class="udiff-line-modified-removed">-                 } catch (IOException e) {</span>
<span class="udiff-line-modified-removed">-                     if (!closed)</span>
<span class="udiff-line-modified-removed">-                         throw new UncheckedIOException(&quot;Unexpected&quot;, e);</span>
<span class="udiff-line-modified-added">+                 } catch (Throwable e) {</span>
<span class="udiff-line-modified-added">+                     if (!closed) {</span>
<span class="udiff-line-modified-added">+                         out.println(&quot;Unexpected exception in server: &quot; + e);</span>
<span class="udiff-line-added">+                         e.printStackTrace(out);</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;Unexpected: &quot; + e, e);</span>
<span class="udiff-line-added">+                     }</span>
                  }
              }
          }
  
          static final byte[] requestEnd = new byte[] { &#39;\r&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\n&#39; };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -688,11 +710,10 @@</span>
          if (sslContext == null)
              throw new AssertionError(&quot;Unexpected null sslContext&quot;);
          SSLContext.setDefault(sslContext);
  
          sslParameters = new SSLParameters();
<span class="udiff-line-removed">-         sslParameters.setProtocols(new String[] {&quot;TLSv1.2&quot;});</span>
  
          closeImmediatelyServer = new PlainCloseImmediatelyServer();
          httpURIClsImed = &quot;http://&quot; + serverAuthority(closeImmediatelyServer)
                  + &quot;/http1/closeImmediately/foo&quot;;
  
</pre>
<center><a href="ShortRequestBody.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SmokeTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>