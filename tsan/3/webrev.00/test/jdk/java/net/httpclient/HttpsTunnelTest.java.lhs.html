<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/httpclient/HttpsTunnelTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import com.sun.net.httpserver.HttpsConfigurator;
 25 import com.sun.net.httpserver.HttpsServer;
 26 import jdk.test.lib.net.SimpleSSLContext;
 27 import javax.net.ssl.SSLContext;
 28 import java.net.InetAddress;
 29 import java.net.InetSocketAddress;
 30 import java.net.ProxySelector;
 31 import java.net.URI;
 32 import java.net.http.HttpClient;
 33 import java.net.http.HttpClient.Version;
 34 import java.net.http.HttpRequest;
 35 import java.net.http.HttpResponse;
 36 import java.net.http.HttpResponse.BodyHandlers;
 37 import java.util.Arrays;
 38 import java.util.List;
 39 import java.util.stream.Collectors;
 40 import java.util.stream.Stream;
 41 import static java.lang.String.format;
 42 import static java.lang.System.out;
 43 
 44 /**
 45  * @test
 46  * @summary This test verifies that if an h2 connection going through a
 47  *          proxy P is downgraded to HTTP/1.1, then a new h2 request
 48  *          going to a different host through the same proxy will not
 49  *          be preemptively downgraded. That, is the stack should attempt
<a name="2" id="anc2"></a><span class="line-modified"> 50  *          a new h2 connection to the new host.</span>
<span class="line-modified"> 51  * @bug 8196967</span>

 52  * @library /test/lib http2/server
 53  * @build jdk.test.lib.net.SimpleSSLContext HttpServerAdapters DigestEchoServer HttpsTunnelTest
 54  * @modules java.net.http/jdk.internal.net.http.common
 55  *          java.net.http/jdk.internal.net.http.frame
 56  *          java.net.http/jdk.internal.net.http.hpack
 57  *          java.logging
 58  *          java.base/sun.net.www.http
 59  *          java.base/sun.net.www
 60  *          java.base/sun.net
<a name="3" id="anc3"></a><span class="line-modified"> 61  * @run main/othervm -Djdk.internal.httpclient.debug=true HttpsTunnelTest</span>







 62  */
 63 
 64 public class HttpsTunnelTest implements HttpServerAdapters {
 65 
 66     static final String data[] = {
 67         &quot;Lorem ipsum&quot;,
 68         &quot;dolor sit amet&quot;,
 69         &quot;consectetur adipiscing elit, sed do eiusmod tempor&quot;,
 70         &quot;quis nostrud exercitation ullamco&quot;,
 71         &quot;laboris nisi&quot;,
 72         &quot;ut&quot;,
 73         &quot;aliquip ex ea commodo consequat.&quot; +
 74         &quot;Duis aute irure dolor in reprehenderit in voluptate velit esse&quot; +
 75         &quot;cillum dolore eu fugiat nulla pariatur.&quot;,
 76         &quot;Excepteur sint occaecat cupidatat non proident.&quot;
 77     };
 78 
 79     static final SSLContext context;
 80     static {
 81         try {
 82             context = new SimpleSSLContext().get();
 83             SSLContext.setDefault(context);
 84         } catch (Exception x) {
 85             throw new ExceptionInInitializerError(x);
 86         }
 87     }
 88 
 89     HttpsTunnelTest() {
 90     }
 91 
 92     public HttpClient newHttpClient(ProxySelector ps) {
 93         HttpClient.Builder builder = HttpClient
 94                 .newBuilder()
 95                 .sslContext(context)
 96                 .proxy(ps);
 97         return builder.build();
 98     }
 99 
100     public static void main(String[] args) throws Exception {
101         InetSocketAddress sa = new InetSocketAddress(InetAddress.getLoopbackAddress(), 0);
102         HttpsServer server1 = HttpsServer.create(sa, 0);
103         server1.setHttpsConfigurator(new HttpsConfigurator(context));
104         HttpTestServer http1Server =
105                 HttpTestServer.of(server1);
106         http1Server.addHandler(new HttpTestEchoHandler(), &quot;/&quot;);
107         http1Server.start();
108         HttpTestServer http2Server = HttpTestServer.of(
109                 new Http2TestServer(&quot;localhost&quot;, true, 0));
110         http2Server.addHandler(new HttpTestEchoHandler(), &quot;/&quot;);
111         http2Server.start();
112 
113         DigestEchoServer.TunnelingProxy proxy = DigestEchoServer.createHttpsProxyTunnel(
114                 DigestEchoServer.HttpAuthSchemeType.NONE);
115 
116         try {
117             URI uri1 = new URI(&quot;https://&quot; + http1Server.serverAuthority() + &quot;/foo/https1&quot;);
118             URI uri2 = new URI(&quot;https://&quot; + http2Server.serverAuthority() + &quot;/foo/https2&quot;);
<a name="4" id="anc4"></a>











119             ProxySelector ps = ProxySelector.of(proxy.getProxyAddress());
120                     //HttpClient.Builder.NO_PROXY;
121             HttpsTunnelTest test = new HttpsTunnelTest();
122             HttpClient client = test.newHttpClient(ps);
123             out.println(&quot;Proxy is: &quot; + ps.select(uri2));
124 
125             List&lt;String&gt; lines = List.of(Arrays.copyOfRange(data, 0, data.length));
126             assert lines.size() == data.length;
127             String body = lines.stream().collect(Collectors.joining(&quot;\r\n&quot;));
128             HttpRequest.BodyPublisher reqBody = HttpRequest.BodyPublishers.ofString(body);
<a name="5" id="anc5"></a><span class="line-modified">129             HttpRequest req1 = HttpRequest</span>
130                     .newBuilder(uri1)
131                     .version(Version.HTTP_2)
<a name="6" id="anc6"></a><span class="line-modified">132                     .POST(reqBody)</span>
<span class="line-modified">133                     .build();</span>

134             out.println(&quot;\nPosting to HTTP/1.1 server at: &quot; + req1);
135             HttpResponse&lt;Stream&lt;String&gt;&gt; response = client.send(req1, BodyHandlers.ofLines());
136             out.println(&quot;Checking response...&quot;);
137             if (response.statusCode() != 200) {
138                 throw new RuntimeException(&quot;Unexpected status code: &quot; + response);
139             }
140             if (response.version() != Version.HTTP_1_1) {
141                 throw new RuntimeException(&quot;Unexpected protocol version: &quot;
142                         + response.version());
143             }
144             List&lt;String&gt; respLines = response.body().collect(Collectors.toList());
145             if (!lines.equals(respLines)) {
146                 throw new RuntimeException(&quot;Unexpected response 1: &quot; + respLines);
147             }
<a name="7" id="anc7"></a>
148             HttpRequest.BodyPublisher reqBody2 = HttpRequest.BodyPublishers.ofString(body);
<a name="8" id="anc8"></a><span class="line-modified">149             HttpRequest req2 = HttpRequest</span>
150                     .newBuilder(uri2)
151                     .version(Version.HTTP_2)
<a name="9" id="anc9"></a><span class="line-modified">152                     .POST(reqBody2)</span>
<span class="line-modified">153                     .build();</span>

154             out.println(&quot;\nPosting to HTTP/2 server at: &quot; + req2);
155             response = client.send(req2, BodyHandlers.ofLines());
156             out.println(&quot;Checking response...&quot;);
157             if (response.statusCode() != 200) {
158                 throw new RuntimeException(&quot;Unexpected status code: &quot; + response);
159             }
160             if (response.version() != Version.HTTP_2) {
161                 throw new RuntimeException(&quot;Unexpected protocol version: &quot;
162                         + response.version());
163             }
164             respLines = response.body().collect(Collectors.toList());
165             if (!lines.equals(respLines)) {
166                 throw new RuntimeException(&quot;Unexpected response 2: &quot; + respLines);
167             }
168         } catch(Throwable t) {
169             out.println(&quot;Unexpected exception: exiting: &quot; + t);
170             t.printStackTrace();
171             throw t;
172         } finally {
173             proxy.stop();
174             http1Server.stop();
175             http2Server.stop();
176         }
177     }
178 
<a name="10" id="anc10"></a>





















179 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>