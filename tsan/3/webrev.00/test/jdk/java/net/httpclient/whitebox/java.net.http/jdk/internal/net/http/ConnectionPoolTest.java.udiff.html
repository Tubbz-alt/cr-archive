<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/httpclient/whitebox/java.net.http/jdk/internal/net/http/ConnectionPoolTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../ConnectionPoolTestDriver.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="Http1HeaderParserTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/whitebox/java.net.http/jdk/internal/net/http/ConnectionPoolTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,21 +23,29 @@</span>
  
  package jdk.internal.net.http;
  
  import java.io.IOException;
  import java.lang.management.ManagementFactory;
<span class="udiff-line-added">+ import java.lang.ref.Reference;</span>
  import java.net.Authenticator;
  import java.net.CookieHandler;
  import java.net.InetSocketAddress;
  import java.net.ProxySelector;
<span class="udiff-line-added">+ import java.net.Socket;</span>
<span class="udiff-line-added">+ import java.net.SocketAddress;</span>
<span class="udiff-line-added">+ import java.net.SocketOption;</span>
<span class="udiff-line-added">+ import java.net.http.HttpHeaders;</span>
  import java.nio.ByteBuffer;
  import java.nio.channels.SocketChannel;
<span class="udiff-line-added">+ import java.nio.channels.spi.SelectorProvider;</span>
  import java.time.Duration;
<span class="udiff-line-modified-removed">- import java.util.Arrays;</span>
<span class="udiff-line-modified-added">+ import java.util.HashMap;</span>
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Map;</span>
  import java.util.Optional;
  import java.util.Random;
<span class="udiff-line-added">+ import java.util.Set;</span>
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.Executor;
  import java.util.concurrent.Flow;
  import java.util.stream.IntStream;
  import java.time.Instant;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,11 +59,11 @@</span>
  
  /**
   * @summary Verifies that the ConnectionPool correctly handle
   *          connection deadlines and purges the right connections
   *          from the cache.
<span class="udiff-line-modified-removed">-  * @bug 8187044 8187111</span>
<span class="udiff-line-modified-added">+  * @bug 8187044 8187111 8221395</span>
   * @author danielfuchs
   */
  public class ConnectionPoolTest {
  
      static long getActiveCleaners() throws ClassNotFoundException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -76,11 +84,14 @@</span>
              if (&quot;testCacheCleaners&quot;.equals(arg)) {
                  testCacheCleaners();
              } else if (&quot;testPoolSize&quot;.equals(arg)) {
                  assert args.length == 1 : &quot;testPoolSize should be run in its own VM&quot;;
                  testPoolSize();
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+             } else if (&quot;testCloseOrReturnToPool&quot;.equals(arg)) {</span>
<span class="udiff-line-added">+                 assert args.length == 1 : &quot;testCloseOrReturnToPool should be run in its own VM&quot;;</span>
<span class="udiff-line-added">+                 testCloseOrReturnToPool();</span>
<span class="udiff-line-added">+             } else throw new RuntimeException(&quot;unknown test case: &quot; + arg);</span>
          }
      }
  
      public static void testCacheCleaners() throws Exception {
          ConnectionPool pool = new ConnectionPool(666);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -224,10 +235,117 @@</span>
                          + &quot;have been removed&quot;);
              }
          }
      }
  
<span class="udiff-line-added">+     public static void testCloseOrReturnToPool() throws Exception {</span>
<span class="udiff-line-added">+         HttpClientFacade facade = (HttpClientFacade)HttpClient.newHttpClient();</span>
<span class="udiff-line-added">+         HttpClientImpl client = facade.impl;</span>
<span class="udiff-line-added">+         ConnectionPool pool = client.connectionPool();</span>
<span class="udiff-line-added">+         InetSocketAddress proxy = InetSocketAddress.createUnresolved(&quot;bar&quot;, 80);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         InetSocketAddress addr = InetSocketAddress.createUnresolved(&quot;foo1&quot;, 80);</span>
<span class="udiff-line-added">+         HttpConnectionStub conn1 = new HttpConnectionStub(facade, client, addr, proxy, true);</span>
<span class="udiff-line-added">+         HttpHeaders hdrs = HttpHeaders.of(new HashMap&lt;&gt;(), (s1,s2) -&gt; true);</span>
<span class="udiff-line-added">+         HttpConnection conn;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         conn1.reopen();</span>
<span class="udiff-line-added">+         if (!conn1.isOpen()) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 finished&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         conn1.closeOrReturnToCache(hdrs);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Check we can find conn1 in the pool</span>
<span class="udiff-line-added">+         if (conn1 != (conn = pool.getConnection(true, addr, proxy))) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not returned, got: &quot; + conn);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(&quot;Found connection in the pool: &quot; + conn );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Try to return it with no headers: the connection should</span>
<span class="udiff-line-added">+         // be closed and not returned to the pool (EOF).</span>
<span class="udiff-line-added">+         conn.closeOrReturnToCache(null);</span>
<span class="udiff-line-added">+         if ((conn = pool.getConnection(true, addr, proxy)) != null) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(conn + &quot; found in the pool!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not closed!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(&quot;EOF connection successfully closed when returned to pool&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // reopen the connection</span>
<span class="udiff-line-added">+         conn1.reopen();</span>
<span class="udiff-line-added">+         if (!conn1.isOpen()) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 finished&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Try to return it with empty headers: the connection should</span>
<span class="udiff-line-added">+         // be returned to the pool.</span>
<span class="udiff-line-added">+         conn1.closeOrReturnToCache(hdrs);</span>
<span class="udiff-line-added">+         if (conn1 != (conn = pool.getConnection(true, addr, proxy))) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not returned to pool, got: &quot; + conn);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 closed&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!conn1.isOpen()) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 finished&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         System.out.println(&quot;Keep alive connection successfully returned to pool&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Try to return it with connection: close headers: the connection should</span>
<span class="udiff-line-added">+         // not be returned to the pool, and should be closed.</span>
<span class="udiff-line-added">+         HttpHeaders hdrs2 = HttpHeaders.of(Map.of(&quot;connection&quot;, List.of(&quot;close&quot;)), (s1, s2) -&gt; true);</span>
<span class="udiff-line-added">+         conn1.closeOrReturnToCache(hdrs2);</span>
<span class="udiff-line-added">+         if ((conn = pool.getConnection(true, addr, proxy)) != null) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(conn + &quot; found in the pool!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not closed!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(&quot;Close connection successfully closed when returned to pool&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // reopen and finish the connection.</span>
<span class="udiff-line-added">+         conn1.reopen();</span>
<span class="udiff-line-added">+         conn1.finish(true);</span>
<span class="udiff-line-added">+         if (conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 closed&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (conn1.isOpen()) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 is opened!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         conn1.closeOrReturnToCache(hdrs2);</span>
<span class="udiff-line-added">+         if ((conn = pool.getConnection(true, addr, proxy)) != null) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(conn + &quot; found in the pool!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not closed!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(&quot;Finished &#39;close&#39; connection successfully closed when returned to pool&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // reopen and finish the connection.</span>
<span class="udiff-line-added">+         conn1.reopen();</span>
<span class="udiff-line-added">+         conn1.finish(true);</span>
<span class="udiff-line-added">+         if (conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 closed&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (conn1.isOpen()) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 is opened!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         conn1.closeOrReturnToCache(hdrs);</span>
<span class="udiff-line-added">+         if ((conn = pool.getConnection(true, addr, proxy)) != null) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(conn + &quot; found in the pool!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (!conn1.closed) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;conn1 not closed!&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         System.out.println(&quot;Finished keep-alive connection successfully closed when returned to pool&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Reference.reachabilityFence(facade);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      static &lt;T&gt; T error() {
          throw new InternalError(&quot;Should not reach here: wrong test assumptions!&quot;);
      }
  
      static class FlowTubeStub implements FlowTube {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -239,59 +357,150 @@</span>
          @Override public void onComplete() { error(); }
          @Override public void onNext(List&lt;ByteBuffer&gt; item) { error();}
          @Override
          public void subscribe(Flow.Subscriber&lt;? super List&lt;ByteBuffer&gt;&gt; subscriber) {
          }
<span class="udiff-line-modified-removed">-         @Override public boolean isFinished() { return conn.closed; }</span>
<span class="udiff-line-modified-added">+         @Override public boolean isFinished() { return conn.finished; }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class SocketChannelStub extends SocketChannel {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         SocketChannelStub() { super(SelectorProvider.provider()); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SocketChannel bind(SocketAddress local) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public &lt;T&gt; SocketChannel setOption(SocketOption&lt;T&gt; name, T value) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SocketChannel shutdownInput() throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SocketChannel shutdownOutput() throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public Socket socket() { return error(); }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean isConnected() { return true; }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean isConnectionPending() { return false; }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean connect(SocketAddress remote) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean finishConnect() throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SocketAddress getRemoteAddress() throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int read(ByteBuffer dst) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public long read(ByteBuffer[] dsts, int offset, int length) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int write(ByteBuffer src) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public long write(ByteBuffer[] srcs, int offset, int length) throws IOException {</span>
<span class="udiff-line-added">+             return 0;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SocketAddress getLocalAddress() throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public &lt;T&gt; T getOption(SocketOption&lt;T&gt; name) throws IOException {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {</span>
<span class="udiff-line-added">+             return error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         protected void implCloseSelectableChannel() throws IOException {</span>
<span class="udiff-line-added">+             error();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         protected void implConfigureBlocking(boolean block) throws IOException {</span>
<span class="udiff-line-added">+             error();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      // Emulates an HttpConnection that has a strong reference to its HttpClient.
      static class HttpConnectionStub extends HttpConnection {
  
<span class="udiff-line-modified-removed">-         public HttpConnectionStub(HttpClient client,</span>
<span class="udiff-line-modified-added">+         public HttpConnectionStub(</span>
<span class="udiff-line-added">+                 HttpClient client,</span>
<span class="udiff-line-added">+                 InetSocketAddress address,</span>
<span class="udiff-line-added">+                 InetSocketAddress proxy,</span>
<span class="udiff-line-added">+                 boolean secured) {</span>
<span class="udiff-line-added">+             this(client, null, address, proxy, secured);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         public HttpConnectionStub(</span>
<span class="udiff-line-added">+                 HttpClient client,</span>
<span class="udiff-line-added">+                 HttpClientImpl impl,</span>
                  InetSocketAddress address,
                  InetSocketAddress proxy,
                  boolean secured) {
<span class="udiff-line-modified-removed">-             super(address, null);</span>
<span class="udiff-line-modified-added">+             super(address, impl);</span>
              this.key = ConnectionPool.cacheKey(address, proxy);
              this.address = address;
              this.proxy = proxy;
              this.secured = secured;
              this.client = client;
<span class="udiff-line-added">+             this.channel = new SocketChannelStub();</span>
              this.flow = new FlowTubeStub(this);
          }
  
          final InetSocketAddress proxy;
          final InetSocketAddress address;
          final boolean secured;
          final ConnectionPool.CacheKey key;
          final HttpClient client;
          final FlowTubeStub flow;
<span class="udiff-line-modified-removed">-         volatile boolean closed;</span>
<span class="udiff-line-modified-added">+         final SocketChannel channel;</span>
<span class="udiff-line-added">+         volatile boolean closed, finished;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Used for testing closeOrReturnToPool.</span>
<span class="udiff-line-added">+         void finish(boolean finished) { this.finished = finished; }</span>
<span class="udiff-line-added">+         void reopen() { closed = finished = false;}</span>
  
          // All these return something
          @Override boolean connected() {return !closed;}
          @Override boolean isSecure() {return secured;}
          @Override boolean isProxied() {return proxy!=null;}
          @Override ConnectionPool.CacheKey cacheKey() {return key;}
<span class="udiff-line-added">+         @Override FlowTube getConnectionFlow() {return flow;}</span>
<span class="udiff-line-added">+         @Override SocketChannel channel() {return channel;}</span>
          @Override
          public void close() {
<span class="udiff-line-modified-removed">-             closed=true;</span>
<span class="udiff-line-modified-added">+             closed=finished=true;</span>
              System.out.println(&quot;closed: &quot; + this);
          }
          @Override
          public String toString() {
              return &quot;HttpConnectionStub: &quot; + address + &quot; proxy: &quot; + proxy;
          }
  
<span class="udiff-line-added">+ </span>
          // All these throw errors
          @Override public HttpPublisher publisher() {return error();}
          @Override public CompletableFuture&lt;Void&gt; connectAsync(Exchange&lt;?&gt; e) {return error();}
          @Override public CompletableFuture&lt;Void&gt; finishConnect() {return error();}
<span class="udiff-line-removed">-         @Override SocketChannel channel() {return error();}</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         FlowTube getConnectionFlow() {return flow;}</span>
      }
      // Emulates an HttpClient that has a strong reference to its connection pool.
      static class HttpClientStub extends HttpClient {
          public HttpClientStub(ConnectionPool pool) {
              this.pool = pool;
</pre>
<center><a href="../../../../../ConnectionPoolTestDriver.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="Http1HeaderParserTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>