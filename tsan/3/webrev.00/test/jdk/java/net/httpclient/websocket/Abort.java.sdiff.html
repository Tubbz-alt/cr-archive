<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/websocket/Abort.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ssltest/Server.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AutomaticPong.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/Abort.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @build DummyWebSocketServer
 27  * @run testng/othervm
 28  *      -Djdk.internal.httpclient.websocket.debug=true
 29  *       Abort
 30  */
 31 
<span class="line-removed"> 32 import org.testng.annotations.AfterTest;</span>
 33 import org.testng.annotations.Test;
 34 
 35 import java.io.IOException;
 36 import java.net.ProtocolException;
 37 import java.net.http.WebSocket;
 38 import java.nio.ByteBuffer;
 39 import java.util.Arrays;
 40 import java.util.List;
 41 import java.util.concurrent.CompletableFuture;
 42 import java.util.concurrent.CompletionStage;
 43 import java.util.concurrent.TimeUnit;
 44 import java.util.concurrent.TimeoutException;
 45 
 46 import static java.net.http.HttpClient.newHttpClient;
 47 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 48 import static org.testng.Assert.assertEquals;
 49 import static org.testng.Assert.assertThrows;
 50 import static org.testng.Assert.assertTrue;
 51 import static org.testng.Assert.fail;
 52 
 53 public class Abort {
 54 
 55     private static final Class&lt;NullPointerException&gt; NPE = NullPointerException.class;
 56     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 57     private static final Class&lt;IOException&gt; IOE = IOException.class;
 58 
<span class="line-removed"> 59     private DummyWebSocketServer server;</span>
<span class="line-removed"> 60     private WebSocket webSocket;</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62     @AfterTest</span>
<span class="line-removed"> 63     public void cleanup() {</span>
<span class="line-removed"> 64         server.close();</span>
<span class="line-removed"> 65         webSocket.abort();</span>
<span class="line-removed"> 66     }</span>
 67 
 68     @Test
 69     public void onOpenThenAbort() throws Exception {
 70         int[] bytes = new int[]{
 71                 0x88, 0x00, // opcode=close
 72         };
<span class="line-modified"> 73         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified"> 74         server.open();</span>
<span class="line-modified"> 75         // messages are available</span>
<span class="line-modified"> 76         MockListener listener = new MockListener() {</span>
<span class="line-modified"> 77             @Override</span>
<span class="line-modified"> 78             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified"> 79                 // unbounded request</span>
<span class="line-modified"> 80                 webSocket.request(Long.MAX_VALUE);</span>












 81                 webSocket.abort();
 82             }
<span class="line-modified"> 83         };</span>
<span class="line-removed"> 84         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed"> 85                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed"> 86                 .join();</span>
<span class="line-removed"> 87         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed"> 88         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed"> 89         // no more invocations after onOpen as WebSocket was aborted</span>
<span class="line-removed"> 90         assertEquals(inv, List.of(MockListener.Invocation.onOpen(webSocket)));</span>
 91     }
 92 
 93     @Test
 94     public void onOpenThenOnTextThenAbort() throws Exception {
 95         int[] bytes = new int[]{
 96                 0x81, 0x00, // opcode=text, fin=true
 97                 0x88, 0x00, // opcode=close
 98         };
<span class="line-modified"> 99         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">100         server.open();</span>
<span class="line-modified">101         MockListener listener = new MockListener() {</span>
<span class="line-modified">102             @Override</span>
<span class="line-modified">103             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">104                 // unbounded request</span>
<span class="line-modified">105                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">106             }</span>
107 
<span class="line-modified">108             @Override</span>
<span class="line-modified">109             protected CompletionStage&lt;?&gt; onText0(WebSocket webSocket,</span>
<span class="line-modified">110                                                  CharSequence message,</span>
<span class="line-modified">111                                                  boolean last) {</span>
















112                 webSocket.abort();
<span class="line-removed">113                 return super.onText0(webSocket, message, last);</span>
114             }
<span class="line-modified">115         };</span>
<span class="line-removed">116         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">117                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">118                 .join();</span>
<span class="line-removed">119         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">120         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">121         // no more invocations after onOpen, onBinary as WebSocket was aborted</span>
<span class="line-removed">122         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">123                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">124                 MockListener.Invocation.onText(webSocket, &quot;&quot;, true));</span>
<span class="line-removed">125         assertEquals(inv, expected);</span>
126     }
127 
128     @Test
129     public void onOpenThenOnBinaryThenAbort() throws Exception {
130         int[] bytes = new int[]{
131                 0x82, 0x00, // opcode=binary, fin=true
132                 0x88, 0x00, // opcode=close
133         };
<span class="line-modified">134         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">135         server.open();</span>
<span class="line-modified">136         MockListener listener = new MockListener() {</span>
<span class="line-modified">137             @Override</span>
<span class="line-modified">138             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">139                 // unbounded request</span>
<span class="line-modified">140                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">141             }</span>
142 
<span class="line-modified">143             @Override</span>
<span class="line-modified">144             protected CompletionStage&lt;?&gt; onBinary0(WebSocket webSocket,</span>
<span class="line-modified">145                                                    ByteBuffer message,</span>
<span class="line-modified">146                                                    boolean last) {</span>
















147                 webSocket.abort();
<span class="line-removed">148                 return super.onBinary0(webSocket, message, last);</span>
149             }
<span class="line-modified">150         };</span>
<span class="line-removed">151         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">152                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">153                 .join();</span>
<span class="line-removed">154         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">155         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">156         // no more invocations after onOpen, onBinary as WebSocket was aborted</span>
<span class="line-removed">157         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">158                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">159                 MockListener.Invocation.onBinary(webSocket, ByteBuffer.allocate(0), true));</span>
<span class="line-removed">160         assertEquals(inv, expected);</span>
161     }
162 
163     @Test
164     public void onOpenThenOnPingThenAbort() throws Exception {
165         int[] bytes = {
166                 0x89, 0x00, // opcode=ping
167                 0x88, 0x00, // opcode=close
168         };
<span class="line-modified">169         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">170         server.open();</span>
<span class="line-modified">171         MockListener listener = new MockListener() {</span>
<span class="line-modified">172             @Override</span>
<span class="line-modified">173             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">174                 // unbounded request</span>
<span class="line-modified">175                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">176             }</span>
177 
<span class="line-modified">178             @Override</span>
<span class="line-modified">179             protected CompletionStage&lt;?&gt; onPing0(WebSocket webSocket,</span>
<span class="line-modified">180                                                  ByteBuffer message) {</span>
















181                 webSocket.abort();
<span class="line-removed">182                 return super.onPing0(webSocket, message);</span>
183             }
<span class="line-modified">184         };</span>
<span class="line-removed">185         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">186                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">187                 .join();</span>
<span class="line-removed">188         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">189         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">190         // no more invocations after onOpen, onPing as WebSocket was aborted</span>
<span class="line-removed">191         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">192                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">193                 MockListener.Invocation.onPing(webSocket, ByteBuffer.allocate(0)));</span>
<span class="line-removed">194         assertEquals(inv, expected);</span>
195     }
196 
197     @Test
198     public void onOpenThenOnPongThenAbort() throws Exception {
199         int[] bytes = {
200                 0x8a, 0x00, // opcode=pong
201                 0x88, 0x00, // opcode=close
202         };
<span class="line-modified">203         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">204         server.open();</span>
<span class="line-modified">205         MockListener listener = new MockListener() {</span>
<span class="line-modified">206             @Override</span>
<span class="line-modified">207             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">208                 // unbounded request</span>
<span class="line-modified">209                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">210             }</span>
211 
<span class="line-modified">212             @Override</span>
<span class="line-modified">213             protected CompletionStage&lt;?&gt; onPong0(WebSocket webSocket,</span>
<span class="line-modified">214                                                  ByteBuffer message) {</span>
















215                 webSocket.abort();
<span class="line-removed">216                 return super.onPong0(webSocket, message);</span>
217             }
<span class="line-modified">218         };</span>
<span class="line-removed">219         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">220                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">221                 .join();</span>
<span class="line-removed">222         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">223         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">224         // no more invocations after onOpen, onPong as WebSocket was aborted</span>
<span class="line-removed">225         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">226                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">227                 MockListener.Invocation.onPong(webSocket, ByteBuffer.allocate(0)));</span>
<span class="line-removed">228         assertEquals(inv, expected);</span>
229     }
230 
231     @Test
232     public void onOpenThenOnCloseThenAbort() throws Exception {
233         int[] bytes = {
234                 0x88, 0x00, // opcode=close
235                 0x8a, 0x00, // opcode=pong
236         };
<span class="line-modified">237         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">238         server.open();</span>
<span class="line-modified">239         MockListener listener = new MockListener() {</span>
<span class="line-modified">240             @Override</span>
<span class="line-modified">241             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">242                 // unbounded request</span>
<span class="line-modified">243                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">244             }</span>
245 
<span class="line-modified">246             @Override</span>
<span class="line-modified">247             protected CompletionStage&lt;?&gt; onClose0(WebSocket webSocket,</span>
<span class="line-modified">248                                                   int statusCode,</span>
<span class="line-modified">249                                                   String reason) {</span>
















250                 webSocket.abort();
<span class="line-removed">251                 return super.onClose0(webSocket, statusCode, reason);</span>
252             }
<span class="line-modified">253         };</span>
<span class="line-removed">254         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">255                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">256                 .join();</span>
<span class="line-removed">257         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">258         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">259         // no more invocations after onOpen, onClose</span>
<span class="line-removed">260         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">261                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">262                 MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;));</span>
<span class="line-removed">263         assertEquals(inv, expected);</span>
264     }
265 
266     @Test
267     public void onOpenThenOnErrorThenAbort() throws Exception {
268         // A header of 128 bytes long Ping (which is a protocol error)
269         int[] badPingHeader = new int[]{0x89, 0x7e, 0x00, 0x80};
270         int[] closeMessage = new int[]{0x88, 0x00};
271         int[] bytes = new int[badPingHeader.length + 128 + closeMessage.length];
272         System.arraycopy(badPingHeader, 0, bytes, 0, badPingHeader.length);
273         System.arraycopy(closeMessage, 0, bytes, badPingHeader.length + 128, closeMessage.length);
<span class="line-modified">274         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">275         server.open();</span>
<span class="line-modified">276         MockListener listener = new MockListener() {</span>
<span class="line-modified">277             @Override</span>
<span class="line-modified">278             protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">279                 // unbounded request</span>
<span class="line-modified">280                 webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">281             }</span>
282 
<span class="line-modified">283             @Override</span>
<span class="line-modified">284             protected void onError0(WebSocket webSocket, Throwable error) {</span>

















285                 webSocket.abort();
<span class="line-removed">286                 super.onError0(webSocket, error);</span>
287             }
<span class="line-modified">288         };</span>
<span class="line-removed">289         webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-removed">290                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">291                 .join();</span>
<span class="line-removed">292         TimeUnit.SECONDS.sleep(5);</span>
<span class="line-removed">293         List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-removed">294         // no more invocations after onOpen, onError</span>
<span class="line-removed">295         List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-removed">296                 MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-removed">297                 MockListener.Invocation.onError(webSocket, ProtocolException.class));</span>
<span class="line-removed">298         System.out.println(&quot;actual invocations:&quot; + Arrays.toString(inv.toArray()));</span>
<span class="line-removed">299         assertEquals(inv, expected);</span>
300     }
301 
302     @Test
303     public void immediateAbort() throws Exception {
304         CompletableFuture&lt;Void&gt; messageReceived = new CompletableFuture&lt;&gt;();
305         WebSocket.Listener listener = new WebSocket.Listener() {
306 
307             @Override
308             public void onOpen(WebSocket webSocket) {
309                 /* no initial request */
310             }
311 
312             @Override
313             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,
314                                              CharSequence message,
315                                              boolean last) {
316                 messageReceived.complete(null);
317                 return null;
318             }
319 
</pre>
<hr />
<pre>
335             @Override
336             public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,
337                                              ByteBuffer message) {
338                 messageReceived.complete(null);
339                 return null;
340             }
341 
342             @Override
343             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,
344                                               int statusCode,
345                                               String reason) {
346                 messageReceived.complete(null);
347                 return null;
348             }
349         };
350 
351         int[] bytes = new int[]{
352                 0x82, 0x00, // opcode=binary, fin=true
353                 0x88, 0x00, // opcode=close
354         };
<span class="line-modified">355         server = Support.serverWithCannedData(bytes);</span>
<span class="line-modified">356         server.open();</span>
357 
<span class="line-modified">358         WebSocket ws = newHttpClient()</span>
<span class="line-modified">359                 .newWebSocketBuilder()</span>
<span class="line-modified">360                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">361                 .join();</span>
<span class="line-modified">362         for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-modified">363             System.out.printf(&quot;iteration #%s%n&quot;, i);</span>
<span class="line-modified">364             // after the first abort() each consecutive one must be a no-op,</span>
<span class="line-modified">365             // moreover, query methods should continue to return consistent</span>
<span class="line-modified">366             // values</span>
<span class="line-modified">367             for (int j = 0; j &lt; 3; j++) {</span>
<span class="line-modified">368                 System.out.printf(&quot;abort #%s%n&quot;, j);</span>
















































369                 ws.abort();
<span class="line-removed">370                 assertTrue(ws.isInputClosed());</span>
<span class="line-removed">371                 assertTrue(ws.isOutputClosed());</span>
<span class="line-removed">372                 assertEquals(ws.getSubprotocol(), &quot;&quot;);</span>
<span class="line-removed">373             }</span>
<span class="line-removed">374             // at this point valid requests MUST be a no-op:</span>
<span class="line-removed">375             for (int j = 0; j &lt; 3; j++) {</span>
<span class="line-removed">376                 System.out.printf(&quot;request #%s%n&quot;, j);</span>
<span class="line-removed">377                 ws.request(1);</span>
<span class="line-removed">378                 ws.request(2);</span>
<span class="line-removed">379                 ws.request(8);</span>
<span class="line-removed">380                 ws.request(Integer.MAX_VALUE);</span>
<span class="line-removed">381                 ws.request(Long.MAX_VALUE);</span>
<span class="line-removed">382                 // invalid requests MUST throw IAE:</span>
<span class="line-removed">383                 assertThrows(IAE, () -&gt; ws.request(Integer.MIN_VALUE));</span>
<span class="line-removed">384                 assertThrows(IAE, () -&gt; ws.request(Long.MIN_VALUE));</span>
<span class="line-removed">385                 assertThrows(IAE, () -&gt; ws.request(-1));</span>
<span class="line-removed">386                 assertThrows(IAE, () -&gt; ws.request(0));</span>
387             }
388         }
<span class="line-removed">389         // even though there is a bunch of messages readily available on the</span>
<span class="line-removed">390         // wire we shouldn&#39;t have received any of them as we aborted before</span>
<span class="line-removed">391         // the first request</span>
<span class="line-removed">392         try {</span>
<span class="line-removed">393             messageReceived.get(5, TimeUnit.SECONDS);</span>
<span class="line-removed">394             fail();</span>
<span class="line-removed">395         } catch (TimeoutException expected) {</span>
<span class="line-removed">396             System.out.println(&quot;Finished waiting&quot;);</span>
<span class="line-removed">397         }</span>
<span class="line-removed">398         for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-removed">399             System.out.printf(&quot;send #%s%n&quot;, i);</span>
<span class="line-removed">400             Support.assertFails(IOE, ws.sendText(&quot;text!&quot;, false));</span>
<span class="line-removed">401             Support.assertFails(IOE, ws.sendText(&quot;text!&quot;, true));</span>
<span class="line-removed">402             Support.assertFails(IOE, ws.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-removed">403             Support.assertFails(IOE, ws.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-removed">404             Support.assertFails(IOE, ws.sendPing(ByteBuffer.allocate(16)));</span>
<span class="line-removed">405             Support.assertFails(IOE, ws.sendPong(ByteBuffer.allocate(16)));</span>
<span class="line-removed">406             Support.assertFails(IOE, ws.sendClose(NORMAL_CLOSURE, &quot;a reason&quot;));</span>
<span class="line-removed">407             assertThrows(NPE, () -&gt; ws.sendText(null, false));</span>
<span class="line-removed">408             assertThrows(NPE, () -&gt; ws.sendText(null, true));</span>
<span class="line-removed">409             assertThrows(NPE, () -&gt; ws.sendBinary(null, false));</span>
<span class="line-removed">410             assertThrows(NPE, () -&gt; ws.sendBinary(null, true));</span>
<span class="line-removed">411             assertThrows(NPE, () -&gt; ws.sendPing(null));</span>
<span class="line-removed">412             assertThrows(NPE, () -&gt; ws.sendPong(null));</span>
<span class="line-removed">413             assertThrows(NPE, () -&gt; ws.sendClose(NORMAL_CLOSURE, null));</span>
<span class="line-removed">414         }</span>
415     }
416 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @build DummyWebSocketServer
 27  * @run testng/othervm
 28  *      -Djdk.internal.httpclient.websocket.debug=true
 29  *       Abort
 30  */
 31 

 32 import org.testng.annotations.Test;
 33 
 34 import java.io.IOException;
 35 import java.net.ProtocolException;
 36 import java.net.http.WebSocket;
 37 import java.nio.ByteBuffer;
 38 import java.util.Arrays;
 39 import java.util.List;
 40 import java.util.concurrent.CompletableFuture;
 41 import java.util.concurrent.CompletionStage;
 42 import java.util.concurrent.TimeUnit;
 43 import java.util.concurrent.TimeoutException;
 44 
 45 import static java.net.http.HttpClient.newHttpClient;
 46 import static java.net.http.WebSocket.NORMAL_CLOSURE;
 47 import static org.testng.Assert.assertEquals;
 48 import static org.testng.Assert.assertThrows;
 49 import static org.testng.Assert.assertTrue;
 50 import static org.testng.Assert.fail;
 51 
 52 public class Abort {
 53 
 54     private static final Class&lt;NullPointerException&gt; NPE = NullPointerException.class;
 55     private static final Class&lt;IllegalArgumentException&gt; IAE = IllegalArgumentException.class;
 56     private static final Class&lt;IOException&gt; IOE = IOException.class;
 57 








 58 
 59     @Test
 60     public void onOpenThenAbort() throws Exception {
 61         int[] bytes = new int[]{
 62                 0x88, 0x00, // opcode=close
 63         };
<span class="line-modified"> 64         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified"> 65             server.open();</span>
<span class="line-modified"> 66             // messages are available</span>
<span class="line-modified"> 67             MockListener listener = new MockListener() {</span>
<span class="line-modified"> 68                 @Override</span>
<span class="line-modified"> 69                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified"> 70                     // unbounded request</span>
<span class="line-modified"> 71                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-added"> 72                     webSocket.abort();</span>
<span class="line-added"> 73                 }</span>
<span class="line-added"> 74             };</span>
<span class="line-added"> 75             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added"> 76                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added"> 77                     .join();</span>
<span class="line-added"> 78             try {</span>
<span class="line-added"> 79                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added"> 80                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added"> 81                 // no more invocations after onOpen as WebSocket was aborted</span>
<span class="line-added"> 82                 assertEquals(inv, List.of(MockListener.Invocation.onOpen(webSocket)));</span>
<span class="line-added"> 83             } finally {</span>
 84                 webSocket.abort();
 85             }
<span class="line-modified"> 86         }</span>







 87     }
 88 
 89     @Test
 90     public void onOpenThenOnTextThenAbort() throws Exception {
 91         int[] bytes = new int[]{
 92                 0x81, 0x00, // opcode=text, fin=true
 93                 0x88, 0x00, // opcode=close
 94         };
<span class="line-modified"> 95         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified"> 96             server.open();</span>
<span class="line-modified"> 97             MockListener listener = new MockListener() {</span>
<span class="line-modified"> 98                 @Override</span>
<span class="line-modified"> 99                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">100                     // unbounded request</span>
<span class="line-modified">101                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">102                 }</span>
103 
<span class="line-modified">104                 @Override</span>
<span class="line-modified">105                 protected CompletionStage&lt;?&gt; onText0(WebSocket webSocket,</span>
<span class="line-modified">106                                                      CharSequence message,</span>
<span class="line-modified">107                                                      boolean last) {</span>
<span class="line-added">108                     webSocket.abort();</span>
<span class="line-added">109                     return super.onText0(webSocket, message, last);</span>
<span class="line-added">110                 }</span>
<span class="line-added">111             };</span>
<span class="line-added">112             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">113                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">114                     .join();</span>
<span class="line-added">115             try {</span>
<span class="line-added">116                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">117                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">118                 // no more invocations after onOpen, onBinary as WebSocket was aborted</span>
<span class="line-added">119                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">120                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">121                         MockListener.Invocation.onText(webSocket, &quot;&quot;, true));</span>
<span class="line-added">122                 assertEquals(inv, expected);</span>
<span class="line-added">123             } finally {</span>
124                 webSocket.abort();

125             }
<span class="line-modified">126         }</span>










127     }
128 
129     @Test
130     public void onOpenThenOnBinaryThenAbort() throws Exception {
131         int[] bytes = new int[]{
132                 0x82, 0x00, // opcode=binary, fin=true
133                 0x88, 0x00, // opcode=close
134         };
<span class="line-modified">135         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">136             server.open();</span>
<span class="line-modified">137             MockListener listener = new MockListener() {</span>
<span class="line-modified">138                 @Override</span>
<span class="line-modified">139                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">140                     // unbounded request</span>
<span class="line-modified">141                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">142                 }</span>
143 
<span class="line-modified">144                 @Override</span>
<span class="line-modified">145                 protected CompletionStage&lt;?&gt; onBinary0(WebSocket webSocket,</span>
<span class="line-modified">146                                                        ByteBuffer message,</span>
<span class="line-modified">147                                                        boolean last) {</span>
<span class="line-added">148                     webSocket.abort();</span>
<span class="line-added">149                     return super.onBinary0(webSocket, message, last);</span>
<span class="line-added">150                 }</span>
<span class="line-added">151             };</span>
<span class="line-added">152             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">153                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">154                     .join();</span>
<span class="line-added">155             try {</span>
<span class="line-added">156                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">157                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">158                 // no more invocations after onOpen, onBinary as WebSocket was aborted</span>
<span class="line-added">159                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">160                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">161                         MockListener.Invocation.onBinary(webSocket, ByteBuffer.allocate(0), true));</span>
<span class="line-added">162                 assertEquals(inv, expected);</span>
<span class="line-added">163             } finally {</span>
164                 webSocket.abort();

165             }
<span class="line-modified">166         }</span>










167     }
168 
169     @Test
170     public void onOpenThenOnPingThenAbort() throws Exception {
171         int[] bytes = {
172                 0x89, 0x00, // opcode=ping
173                 0x88, 0x00, // opcode=close
174         };
<span class="line-modified">175         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">176             server.open();</span>
<span class="line-modified">177             MockListener listener = new MockListener() {</span>
<span class="line-modified">178                 @Override</span>
<span class="line-modified">179                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">180                     // unbounded request</span>
<span class="line-modified">181                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">182                 }</span>
183 
<span class="line-modified">184                 @Override</span>
<span class="line-modified">185                 protected CompletionStage&lt;?&gt; onPing0(WebSocket webSocket,</span>
<span class="line-modified">186                                                      ByteBuffer message) {</span>
<span class="line-added">187                     webSocket.abort();</span>
<span class="line-added">188                     return super.onPing0(webSocket, message);</span>
<span class="line-added">189                 }</span>
<span class="line-added">190             };</span>
<span class="line-added">191             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">192                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">193                     .join();</span>
<span class="line-added">194             try {</span>
<span class="line-added">195                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">196                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">197                 // no more invocations after onOpen, onPing as WebSocket was aborted</span>
<span class="line-added">198                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">199                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">200                         MockListener.Invocation.onPing(webSocket, ByteBuffer.allocate(0)));</span>
<span class="line-added">201                 assertEquals(inv, expected);</span>
<span class="line-added">202             } finally {</span>
203                 webSocket.abort();

204             }
<span class="line-modified">205         }</span>










206     }
207 
208     @Test
209     public void onOpenThenOnPongThenAbort() throws Exception {
210         int[] bytes = {
211                 0x8a, 0x00, // opcode=pong
212                 0x88, 0x00, // opcode=close
213         };
<span class="line-modified">214         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">215             server.open();</span>
<span class="line-modified">216             MockListener listener = new MockListener() {</span>
<span class="line-modified">217                 @Override</span>
<span class="line-modified">218                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">219                     // unbounded request</span>
<span class="line-modified">220                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">221                 }</span>
222 
<span class="line-modified">223                 @Override</span>
<span class="line-modified">224                 protected CompletionStage&lt;?&gt; onPong0(WebSocket webSocket,</span>
<span class="line-modified">225                                                      ByteBuffer message) {</span>
<span class="line-added">226                     webSocket.abort();</span>
<span class="line-added">227                     return super.onPong0(webSocket, message);</span>
<span class="line-added">228                 }</span>
<span class="line-added">229             };</span>
<span class="line-added">230             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">231                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">232                     .join();</span>
<span class="line-added">233             try {</span>
<span class="line-added">234                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">235                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">236                 // no more invocations after onOpen, onPong as WebSocket was aborted</span>
<span class="line-added">237                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">238                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">239                         MockListener.Invocation.onPong(webSocket, ByteBuffer.allocate(0)));</span>
<span class="line-added">240                 assertEquals(inv, expected);</span>
<span class="line-added">241             } finally {</span>
242                 webSocket.abort();

243             }
<span class="line-modified">244         }</span>










245     }
246 
247     @Test
248     public void onOpenThenOnCloseThenAbort() throws Exception {
249         int[] bytes = {
250                 0x88, 0x00, // opcode=close
251                 0x8a, 0x00, // opcode=pong
252         };
<span class="line-modified">253         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">254             server.open();</span>
<span class="line-modified">255             MockListener listener = new MockListener() {</span>
<span class="line-modified">256                 @Override</span>
<span class="line-modified">257                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">258                     // unbounded request</span>
<span class="line-modified">259                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">260                 }</span>
261 
<span class="line-modified">262                 @Override</span>
<span class="line-modified">263                 protected CompletionStage&lt;?&gt; onClose0(WebSocket webSocket,</span>
<span class="line-modified">264                                                       int statusCode,</span>
<span class="line-modified">265                                                       String reason) {</span>
<span class="line-added">266                     webSocket.abort();</span>
<span class="line-added">267                     return super.onClose0(webSocket, statusCode, reason);</span>
<span class="line-added">268                 }</span>
<span class="line-added">269             };</span>
<span class="line-added">270             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">271                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">272                     .join();</span>
<span class="line-added">273             try {</span>
<span class="line-added">274                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">275                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">276                 // no more invocations after onOpen, onClose</span>
<span class="line-added">277                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">278                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">279                         MockListener.Invocation.onClose(webSocket, 1005, &quot;&quot;));</span>
<span class="line-added">280                 assertEquals(inv, expected);</span>
<span class="line-added">281             } finally {</span>
282                 webSocket.abort();

283             }
<span class="line-modified">284         }</span>










285     }
286 
287     @Test
288     public void onOpenThenOnErrorThenAbort() throws Exception {
289         // A header of 128 bytes long Ping (which is a protocol error)
290         int[] badPingHeader = new int[]{0x89, 0x7e, 0x00, 0x80};
291         int[] closeMessage = new int[]{0x88, 0x00};
292         int[] bytes = new int[badPingHeader.length + 128 + closeMessage.length];
293         System.arraycopy(badPingHeader, 0, bytes, 0, badPingHeader.length);
294         System.arraycopy(closeMessage, 0, bytes, badPingHeader.length + 128, closeMessage.length);
<span class="line-modified">295         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">296             server.open();</span>
<span class="line-modified">297             MockListener listener = new MockListener() {</span>
<span class="line-modified">298                 @Override</span>
<span class="line-modified">299                 protected void onOpen0(WebSocket webSocket) {</span>
<span class="line-modified">300                     // unbounded request</span>
<span class="line-modified">301                     webSocket.request(Long.MAX_VALUE);</span>
<span class="line-modified">302                 }</span>
303 
<span class="line-modified">304                 @Override</span>
<span class="line-modified">305                 protected void onError0(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">306                     webSocket.abort();</span>
<span class="line-added">307                     super.onError0(webSocket, error);</span>
<span class="line-added">308                 }</span>
<span class="line-added">309             };</span>
<span class="line-added">310             var webSocket = newHttpClient().newWebSocketBuilder()</span>
<span class="line-added">311                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">312                     .join();</span>
<span class="line-added">313             try {</span>
<span class="line-added">314                 TimeUnit.SECONDS.sleep(5);</span>
<span class="line-added">315                 List&lt;MockListener.Invocation&gt; inv = listener.invocationsSoFar();</span>
<span class="line-added">316                 // no more invocations after onOpen, onError</span>
<span class="line-added">317                 List&lt;MockListener.Invocation&gt; expected = List.of(</span>
<span class="line-added">318                         MockListener.Invocation.onOpen(webSocket),</span>
<span class="line-added">319                         MockListener.Invocation.onError(webSocket, ProtocolException.class));</span>
<span class="line-added">320                 System.out.println(&quot;actual invocations:&quot; + Arrays.toString(inv.toArray()));</span>
<span class="line-added">321                 assertEquals(inv, expected);</span>
<span class="line-added">322             } finally {</span>
323                 webSocket.abort();

324             }
<span class="line-modified">325         }</span>











326     }
327 
328     @Test
329     public void immediateAbort() throws Exception {
330         CompletableFuture&lt;Void&gt; messageReceived = new CompletableFuture&lt;&gt;();
331         WebSocket.Listener listener = new WebSocket.Listener() {
332 
333             @Override
334             public void onOpen(WebSocket webSocket) {
335                 /* no initial request */
336             }
337 
338             @Override
339             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,
340                                              CharSequence message,
341                                              boolean last) {
342                 messageReceived.complete(null);
343                 return null;
344             }
345 
</pre>
<hr />
<pre>
361             @Override
362             public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,
363                                              ByteBuffer message) {
364                 messageReceived.complete(null);
365                 return null;
366             }
367 
368             @Override
369             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,
370                                               int statusCode,
371                                               String reason) {
372                 messageReceived.complete(null);
373                 return null;
374             }
375         };
376 
377         int[] bytes = new int[]{
378                 0x82, 0x00, // opcode=binary, fin=true
379                 0x88, 0x00, // opcode=close
380         };
<span class="line-modified">381         try (var server = Support.serverWithCannedData(bytes)) {</span>
<span class="line-modified">382             server.open();</span>
383 
<span class="line-modified">384             WebSocket ws = newHttpClient()</span>
<span class="line-modified">385                     .newWebSocketBuilder()</span>
<span class="line-modified">386                     .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">387                     .join();</span>
<span class="line-modified">388             try {</span>
<span class="line-modified">389                 for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-modified">390                     System.out.printf(&quot;iteration #%s%n&quot;, i);</span>
<span class="line-modified">391                     // after the first abort() each consecutive one must be a no-op,</span>
<span class="line-modified">392                     // moreover, query methods should continue to return consistent</span>
<span class="line-modified">393                     // values</span>
<span class="line-modified">394                     for (int j = 0; j &lt; 3; j++) {</span>
<span class="line-added">395                         System.out.printf(&quot;abort #%s%n&quot;, j);</span>
<span class="line-added">396                         ws.abort();</span>
<span class="line-added">397                         assertTrue(ws.isInputClosed());</span>
<span class="line-added">398                         assertTrue(ws.isOutputClosed());</span>
<span class="line-added">399                         assertEquals(ws.getSubprotocol(), &quot;&quot;);</span>
<span class="line-added">400                     }</span>
<span class="line-added">401                     // at this point valid requests MUST be a no-op:</span>
<span class="line-added">402                     for (int j = 0; j &lt; 3; j++) {</span>
<span class="line-added">403                         System.out.printf(&quot;request #%s%n&quot;, j);</span>
<span class="line-added">404                         ws.request(1);</span>
<span class="line-added">405                         ws.request(2);</span>
<span class="line-added">406                         ws.request(8);</span>
<span class="line-added">407                         ws.request(Integer.MAX_VALUE);</span>
<span class="line-added">408                         ws.request(Long.MAX_VALUE);</span>
<span class="line-added">409                         // invalid requests MUST throw IAE:</span>
<span class="line-added">410                         assertThrows(IAE, () -&gt; ws.request(Integer.MIN_VALUE));</span>
<span class="line-added">411                         assertThrows(IAE, () -&gt; ws.request(Long.MIN_VALUE));</span>
<span class="line-added">412                         assertThrows(IAE, () -&gt; ws.request(-1));</span>
<span class="line-added">413                         assertThrows(IAE, () -&gt; ws.request(0));</span>
<span class="line-added">414                     }</span>
<span class="line-added">415                 }</span>
<span class="line-added">416                 // even though there is a bunch of messages readily available on the</span>
<span class="line-added">417                 // wire we shouldn&#39;t have received any of them as we aborted before</span>
<span class="line-added">418                 // the first request</span>
<span class="line-added">419                 try {</span>
<span class="line-added">420                     messageReceived.get(5, TimeUnit.SECONDS);</span>
<span class="line-added">421                     fail();</span>
<span class="line-added">422                 } catch (TimeoutException expected) {</span>
<span class="line-added">423                     System.out.println(&quot;Finished waiting&quot;);</span>
<span class="line-added">424                 }</span>
<span class="line-added">425                 for (int i = 0; i &lt; 3; i++) {</span>
<span class="line-added">426                     System.out.printf(&quot;send #%s%n&quot;, i);</span>
<span class="line-added">427                     Support.assertFails(IOE, ws.sendText(&quot;text!&quot;, false));</span>
<span class="line-added">428                     Support.assertFails(IOE, ws.sendText(&quot;text!&quot;, true));</span>
<span class="line-added">429                     Support.assertFails(IOE, ws.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-added">430                     Support.assertFails(IOE, ws.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-added">431                     Support.assertFails(IOE, ws.sendPing(ByteBuffer.allocate(16)));</span>
<span class="line-added">432                     Support.assertFails(IOE, ws.sendPong(ByteBuffer.allocate(16)));</span>
<span class="line-added">433                     Support.assertFails(IOE, ws.sendClose(NORMAL_CLOSURE, &quot;a reason&quot;));</span>
<span class="line-added">434                     assertThrows(NPE, () -&gt; ws.sendText(null, false));</span>
<span class="line-added">435                     assertThrows(NPE, () -&gt; ws.sendText(null, true));</span>
<span class="line-added">436                     assertThrows(NPE, () -&gt; ws.sendBinary(null, false));</span>
<span class="line-added">437                     assertThrows(NPE, () -&gt; ws.sendBinary(null, true));</span>
<span class="line-added">438                     assertThrows(NPE, () -&gt; ws.sendPing(null));</span>
<span class="line-added">439                     assertThrows(NPE, () -&gt; ws.sendPong(null));</span>
<span class="line-added">440                     assertThrows(NPE, () -&gt; ws.sendClose(NORMAL_CLOSURE, null));</span>
<span class="line-added">441                 }</span>
<span class="line-added">442             } finally {</span>
443                 ws.abort();

















444             }
445         }


























446     }
447 }
</pre>
</td>
</tr>
</table>
<center><a href="../ssltest/Server.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AutomaticPong.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>