<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/httpclient/websocket/WebSocketTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="WebSocketProxyTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="security/httpclient.policy.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/websocket/WebSocketTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,11 ***</span>
   * @build DummyWebSocketServer
   * @run testng/othervm
   *       WebSocketTest
   */
  
<span class="line-removed">- import org.testng.annotations.AfterTest;</span>
  import org.testng.annotations.DataProvider;
  import org.testng.annotations.Test;
  
  import java.io.IOException;
  import java.net.Authenticator;
<span class="line-new-header">--- 27,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 71,154 ***</span>
      private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
                                      CompletionStage&lt;?&gt; stage) {
          Support.assertCompletesExceptionally(clazz, stage);
      }
  
<span class="line-removed">-     private DummyWebSocketServer server;</span>
<span class="line-removed">-     private WebSocket webSocket;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     @AfterTest</span>
<span class="line-removed">-     public void cleanup() {</span>
<span class="line-removed">-         System.out.println(&quot;AFTER TEST&quot;);</span>
<span class="line-removed">-         if (server != null)</span>
<span class="line-removed">-             server.close();</span>
<span class="line-removed">-         if (webSocket != null)</span>
<span class="line-removed">-             webSocket.abort();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      @Test
      public void illegalArgument() throws IOException {
<span class="line-modified">!         server = new DummyWebSocketServer();</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">!                 .newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                 .join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">!         assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">!         assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">!         assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">!         assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         server.close();</span>
      }
  
      @Test
      public void partialBinaryThenText() throws IOException {
<span class="line-modified">!         server = new DummyWebSocketServer();</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                 .join();</span>
<span class="line-modified">!         webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">!         assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">!         assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">!         // Pings &amp; Pongs are fine</span>
<span class="line-modified">!         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!         server.close();</span>
      }
  
      @Test
      public void partialTextThenBinary() throws IOException {
<span class="line-modified">!         server = new DummyWebSocketServer();</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                 .join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">!         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">!         assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">!         // Pings &amp; Pongs are fine</span>
<span class="line-modified">!         webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!         webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!         server.close();</span>
      }
  
      @Test
      public void sendMethodsThrowIOE1() throws IOException {
<span class="line-modified">!         server = new DummyWebSocketServer();</span>
<span class="line-modified">!         server.open();</span>
<span class="line-modified">!         webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">!                 .newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                 .join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!         server.close();</span>
      }
  
      @DataProvider(name = &quot;sequence&quot;)
      public Object[][] data1() {
          int[] CLOSE = {
<span class="line-new-header">--- 70,154 ---</span>
      private static void assertFails(Class&lt;? extends Throwable&gt; clazz,
                                      CompletionStage&lt;?&gt; stage) {
          Support.assertCompletesExceptionally(clazz, stage);
      }
  
      @Test
      public void illegalArgument() throws IOException {
<span class="line-modified">!         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">!                     .newWebSocketBuilder()</span>
<span class="line-modified">!                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                     .join();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(126)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(127)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(128)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(129)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPing(ByteBuffer.allocate(256)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(126)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(127)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(128)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(129)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendPong(ByteBuffer.allocate(256)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(Support.incompleteString(), false));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(Support.malformedString(), true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(Support.malformedString(), false));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(124)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(125)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(128)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(256)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWithNBytes(257)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.stringWith2NBytes((123 / 2) + 1)));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.malformedString()));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(NORMAL_CLOSURE, Support.incompleteString()));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(-2, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(-1, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(0, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(500, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(998, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(999, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1002, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1003, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1006, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1007, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1009, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1010, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1012, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1013, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(1015, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(5000, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(32768, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(65535, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(65536, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(Integer.MAX_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">!                 assertFails(IAE, webSocket.sendClose(Integer.MIN_VALUE, &quot;a reason&quot;));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertThrows(IAE, () -&gt; webSocket.request(Integer.MIN_VALUE));</span>
<span class="line-modified">!                 assertThrows(IAE, () -&gt; webSocket.request(Long.MIN_VALUE));</span>
<span class="line-modified">!                 assertThrows(IAE, () -&gt; webSocket.request(-1));</span>
<span class="line-modified">!                 assertThrows(IAE, () -&gt; webSocket.request(0));</span>
<span class="line-modified">! </span>
<span class="line-modified">!             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void partialBinaryThenText() throws IOException {
<span class="line-modified">!         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">!                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                     .join();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 webSocket.sendBinary(ByteBuffer.allocate(16), false).join();</span>
<span class="line-modified">!                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, false));</span>
<span class="line-modified">!                 assertFails(ISE, webSocket.sendText(&quot;text&quot;, true));</span>
<span class="line-modified">!                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">!                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void partialTextThenBinary() throws IOException {
<span class="line-modified">!         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">!                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                     .join();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 webSocket.sendText(&quot;text&quot;, false).join();</span>
<span class="line-modified">!                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), false));</span>
<span class="line-modified">!                 assertFails(ISE, webSocket.sendBinary(ByteBuffer.allocate(16), true));</span>
<span class="line-modified">!                 // Pings &amp; Pongs are fine</span>
<span class="line-modified">!                 webSocket.sendPing(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!                 webSocket.sendPong(ByteBuffer.allocate(125)).join();</span>
<span class="line-modified">!             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void sendMethodsThrowIOE1() throws IOException {
<span class="line-modified">!         try (var server = new DummyWebSocketServer()) {</span>
<span class="line-modified">!             server.open();</span>
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build()</span>
<span class="line-modified">!                     .newWebSocketBuilder()</span>
<span class="line-modified">!                     .buildAsync(server.getURI(), new WebSocket.Listener() { })</span>
<span class="line-modified">!                     .join();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 webSocket.sendClose(NORMAL_CLOSURE, &quot;ok&quot;).join();</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-modified">!             } finally {</span>
<span class="line-modified">!                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @DataProvider(name = &quot;sequence&quot;)
      public Object[][] data1() {
          int[] CLOSE = {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 249,154 ***</span>
  
      @Test(dataProvider = &quot;sequence&quot;)
      public void listenerSequentialOrder(int[] binary, long requestSize)
              throws IOException
      {
  
<span class="line-modified">!         server = Support.serverWithCannedData(binary);</span>
<span class="line-removed">-         server.open();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>
  
<span class="line-modified">!         MockListener listener = new MockListener(requestSize) {</span>
  
<span class="line-modified">!             final AtomicBoolean guard = new AtomicBoolean();</span>
  
<span class="line-modified">!             private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">!                 if (guard.getAndSet(true)) {</span>
<span class="line-removed">-                     violation.completeExceptionally(new RuntimeException());</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 try {</span>
<span class="line-removed">-                     return action.get();</span>
<span class="line-removed">-                 } finally {</span>
<span class="line-removed">-                     if (!guard.getAndSet(false)) {</span>
                          violation.completeExceptionally(new RuntimeException());
                      }
                  }
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void onOpen(WebSocket webSocket) {</span>
<span class="line-removed">-                 checkRunExclusively(() -&gt; {</span>
<span class="line-removed">-                     super.onOpen(webSocket);</span>
<span class="line-removed">-                     return null;</span>
<span class="line-removed">-                 });</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">!                                              CharSequence data,</span>
<span class="line-modified">!                                              boolean last) {</span>
<span class="line-modified">!                 return checkRunExclusively(</span>
<span class="line-modified">!                         () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-modified">!             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-removed">-                                                ByteBuffer data,</span>
<span class="line-removed">-                                                boolean last) {</span>
<span class="line-removed">-                 return checkRunExclusively(</span>
<span class="line-removed">-                         () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-removed">-                                              ByteBuffer message) {</span>
<span class="line-removed">-                 return checkRunExclusively(</span>
<span class="line-removed">-                         () -&gt; super.onPing(webSocket, message));</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">!                                              ByteBuffer message) {</span>
<span class="line-modified">!                 return checkRunExclusively(</span>
<span class="line-modified">!                         () -&gt; super.onPong(webSocket, message));</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">!                                               int statusCode,</span>
<span class="line-modified">!                                               String reason) {</span>
<span class="line-modified">!                 return checkRunExclusively(</span>
<span class="line-modified">!                         () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                 checkRunExclusively(() -&gt; {</span>
<span class="line-modified">!                     super.onError(webSocket, error);</span>
<span class="line-modified">!                     return null;</span>
<span class="line-modified">!                 });</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         };</span>
  
<span class="line-modified">!         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">!                 .join();</span>
  
  
<span class="line-modified">!         listener.invocations();</span>
<span class="line-modified">!         violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-modified">!         violation.join();</span>
  
<span class="line-modified">!         server.close();</span>
      }
  
      @Test
      public void sendMethodsThrowIOE2() throws Exception {
<span class="line-modified">!         server = Support.serverWithCannedData(0x88, 0x00);</span>
<span class="line-modified">!         server.open();</span>
<span class="line-removed">-         CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">-         CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">-                                               int statusCode,</span>
<span class="line-removed">-                                               String reason) {</span>
<span class="line-removed">-                 System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-removed">-                 onCloseCalled.complete(null);</span>
<span class="line-removed">-                 return canClose;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">-                 System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-removed">-                 onCloseCalled.completeExceptionally(error);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         };</span>
<span class="line-removed">- </span>
<span class="line-removed">-         webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-removed">-                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">-                 .join();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-removed">-         canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-removed">-         TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-removed">- </span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-removed">-         assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
  
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
  
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-modified">!         assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
  
<span class="line-modified">!         server.close();</span>
      }
  
      // Used to verify a server requiring Authentication
      private static final String USERNAME = &quot;chegar&quot;;
      private static final String PASSWORD = &quot;a1b2c3&quot;;
<span class="line-new-header">--- 248,157 ---</span>
  
      @Test(dataProvider = &quot;sequence&quot;)
      public void listenerSequentialOrder(int[] binary, long requestSize)
              throws IOException
      {
<span class="line-added">+         try (var server = Support.serverWithCannedData(binary)) {</span>
<span class="line-added">+             server.open();</span>
  
<span class="line-modified">!             CompletableFuture&lt;Void&gt; violation = new CompletableFuture&lt;&gt;();</span>
  
<span class="line-modified">!             MockListener listener = new MockListener(requestSize) {</span>
  
<span class="line-modified">!                 final AtomicBoolean guard = new AtomicBoolean();</span>
  
<span class="line-modified">!                 private &lt;T&gt; T checkRunExclusively(Supplier&lt;T&gt; action) {</span>
<span class="line-modified">!                     if (guard.getAndSet(true)) {</span>
                          violation.completeExceptionally(new RuntimeException());
                      }
<span class="line-added">+                     try {</span>
<span class="line-added">+                         return action.get();</span>
<span class="line-added">+                     } finally {</span>
<span class="line-added">+                         if (!guard.getAndSet(false)) {</span>
<span class="line-added">+                             violation.completeExceptionally(new RuntimeException());</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
                  }
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public void onOpen(WebSocket webSocket) {</span>
<span class="line-modified">!                     checkRunExclusively(() -&gt; {</span>
<span class="line-modified">!                         super.onOpen(webSocket);</span>
<span class="line-modified">!                         return null;</span>
<span class="line-modified">!                     });</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">!                                                  CharSequence data,</span>
<span class="line-modified">!                                                  boolean last) {</span>
<span class="line-modified">!                     return checkRunExclusively(</span>
<span class="line-modified">!                             () -&gt; super.onText(webSocket, data, last));</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">!                                                    ByteBuffer data,</span>
<span class="line-modified">!                                                    boolean last) {</span>
<span class="line-modified">!                     return checkRunExclusively(</span>
<span class="line-modified">!                             () -&gt; super.onBinary(webSocket, data, last));</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onPing(WebSocket webSocket,</span>
<span class="line-modified">!                                                  ByteBuffer message) {</span>
<span class="line-modified">!                     return checkRunExclusively(</span>
<span class="line-modified">!                             () -&gt; super.onPing(webSocket, message));</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onPong(WebSocket webSocket,</span>
<span class="line-modified">!                                                  ByteBuffer message) {</span>
<span class="line-added">+                     return checkRunExclusively(</span>
<span class="line-added">+                             () -&gt; super.onPong(webSocket, message));</span>
<span class="line-added">+                 }</span>
  
<span class="line-added">+                 @Override</span>
<span class="line-added">+                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">+                                                   int statusCode,</span>
<span class="line-added">+                                                   String reason) {</span>
<span class="line-added">+                     return checkRunExclusively(</span>
<span class="line-added">+                             () -&gt; super.onClose(webSocket, statusCode, reason));</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                     checkRunExclusively(() -&gt; {</span>
<span class="line-added">+                         super.onError(webSocket, error);</span>
<span class="line-added">+                         return null;</span>
<span class="line-added">+                     });</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
  
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 listener.invocations();</span>
<span class="line-added">+                 violation.complete(null); // won&#39;t affect if completed exceptionally</span>
<span class="line-added">+                 violation.join();</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void sendMethodsThrowIOE2() throws Exception {
<span class="line-modified">!         try (var server = Support.serverWithCannedData(0x88, 0x00)) {</span>
<span class="line-modified">!             server.open();</span>
  
<span class="line-modified">!             CompletableFuture&lt;Void&gt; onCloseCalled = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">!             CompletableFuture&lt;Void&gt; canClose = new CompletableFuture&lt;&gt;();</span>
<span class="line-modified">! </span>
<span class="line-modified">!             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-added">+                 @Override</span>
<span class="line-added">+                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">+                                                   int statusCode,</span>
<span class="line-added">+                                                   String reason) {</span>
<span class="line-added">+                     System.out.printf(&quot;onClose(%s, &#39;%s&#39;)%n&quot;, statusCode, reason);</span>
<span class="line-added">+                     onCloseCalled.complete(null);</span>
<span class="line-added">+                     return canClose;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                     System.out.println(&quot;onError(&quot; + error + &quot;)&quot;);</span>
<span class="line-modified">!                     onCloseCalled.completeExceptionally(error);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
  
<span class="line-modified">!             var webSocket = newBuilder().proxy(NO_PROXY).build().newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 onCloseCalled.join();      // Wait for onClose to be called</span>
<span class="line-added">+                 canClose.complete(null);   // Signal to the WebSocket it can close the output</span>
<span class="line-added">+                 TimeUnit.SECONDS.sleep(5); // Give canClose some time to reach the WebSocket</span>
<span class="line-added">+ </span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendClose(WebSocket.NORMAL_CLOSURE, &quot;ok&quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendText(&quot;&quot;, true));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendText(&quot;&quot;, false));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, true));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendText(&quot;abc&quot;, false));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), true));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(0), false));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), true));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendBinary(ByteBuffer.allocate(1), false));</span>
<span class="line-added">+ </span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(125)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(124)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(1)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPing(ByteBuffer.allocate(0)));</span>
<span class="line-added">+ </span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(125)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(124)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(1)));</span>
<span class="line-added">+                 assertFails(IOE, webSocket.sendPong(ByteBuffer.allocate(0)));</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      // Used to verify a server requiring Authentication
      private static final String USERNAME = &quot;chegar&quot;;
      private static final String PASSWORD = &quot;a1b2c3&quot;;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 456,78 ***</span>
                  0x80, 0x00,                               // ]
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         server = serverSupplier.apply(binary);</span>
<span class="line-modified">!         server.open();</span>
  
<span class="line-modified">!         WebSocket.Listener listener = new WebSocket.Listener() {</span>
  
<span class="line-modified">!             List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!             ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">!                                                ByteBuffer message,</span>
<span class="line-modified">!                                                boolean last) {</span>
<span class="line-modified">!                 System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">!                 webSocket.request(1);</span>
  
<span class="line-modified">!                 append(message);</span>
<span class="line-modified">!                 if (last) {</span>
<span class="line-modified">!                     buffer.flip();</span>
<span class="line-modified">!                     byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">!                     buffer.get(bytes);</span>
<span class="line-modified">!                     buffer.clear();</span>
<span class="line-modified">!                     processWholeBinary(bytes);</span>
                  }
<span class="line-removed">-                 return null;</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             private void append(ByteBuffer message) {</span>
<span class="line-modified">!                 if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">!                     assert message.remaining() &gt; 0;</span>
<span class="line-modified">!                     int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">!                     ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">!                     b.put(buffer.flip());</span>
<span class="line-modified">!                     buffer = b;</span>
                  }
<span class="line-removed">-                 buffer.put(message);</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">!                 String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">!                 System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">!                 collectedBytes.add(bytes);</span>
<span class="line-modified">!             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">-                                               int statusCode,</span>
<span class="line-removed">-                                               String reason) {</span>
<span class="line-removed">-                 actual.complete(collectedBytes);</span>
<span class="line-removed">-                 return null;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-removed">-                 actual.completeExceptionally(error);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         };</span>
  
<span class="line-modified">!         webSocket = newBuilder()</span>
<span class="line-modified">!                 .proxy(NO_PROXY)</span>
<span class="line-modified">!                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">!                 .build().newWebSocketBuilder()</span>
<span class="line-modified">!                 .buildAsync(server.getURI(), listener)</span>
<span class="line-modified">!                 .join();</span>
  
<span class="line-modified">!         List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-modified">!         assertEquals(a, expected);</span>
  
<span class="line-modified">!         server.close();</span>
      }
  
      @Test(dataProvider = &quot;servers&quot;)
      public void simpleAggregatingTextMessages
              (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
<span class="line-new-header">--- 458,80 ---</span>
                  0x80, 0x00,                               // ]
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;byte[]&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">!             server.open();</span>
  
<span class="line-modified">!             WebSocket.Listener listener = new WebSocket.Listener() {</span>
  
<span class="line-modified">!                 List&lt;byte[]&gt; collectedBytes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!                 ByteBuffer buffer = ByteBuffer.allocate(1024);</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onBinary(WebSocket webSocket,</span>
<span class="line-modified">!                                                    ByteBuffer message,</span>
<span class="line-modified">!                                                    boolean last) {</span>
<span class="line-modified">!                     System.out.printf(&quot;onBinary(%s, %s)%n&quot;, message, last);</span>
<span class="line-modified">!                     webSocket.request(1);</span>
  
<span class="line-modified">!                     append(message);</span>
<span class="line-modified">!                     if (last) {</span>
<span class="line-modified">!                         buffer.flip();</span>
<span class="line-modified">!                         byte[] bytes = new byte[buffer.remaining()];</span>
<span class="line-modified">!                         buffer.get(bytes);</span>
<span class="line-modified">!                         buffer.clear();</span>
<span class="line-modified">!                         processWholeBinary(bytes);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     return null;</span>
                  }
  
<span class="line-modified">!                 private void append(ByteBuffer message) {</span>
<span class="line-modified">!                     if (buffer.remaining() &lt; message.remaining()) {</span>
<span class="line-modified">!                         assert message.remaining() &gt; 0;</span>
<span class="line-modified">!                         int cap = (buffer.capacity() + message.remaining()) * 2;</span>
<span class="line-modified">!                         ByteBuffer b = ByteBuffer.allocate(cap);</span>
<span class="line-modified">!                         b.put(buffer.flip());</span>
<span class="line-modified">!                         buffer = b;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     buffer.put(message);</span>
                  }
  
<span class="line-modified">!                 private void processWholeBinary(byte[] bytes) {</span>
<span class="line-modified">!                     String stringBytes = new String(bytes, UTF_8);</span>
<span class="line-modified">!                     System.out.println(&quot;processWholeBinary: &quot; + stringBytes);</span>
<span class="line-modified">!                     collectedBytes.add(bytes);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">!                                                   int statusCode,</span>
<span class="line-modified">!                                                   String reason) {</span>
<span class="line-modified">!                     actual.complete(collectedBytes);</span>
<span class="line-modified">!                     return null;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">+                     actual.completeExceptionally(error);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
  
<span class="line-modified">!             var webSocket = newBuilder()</span>
<span class="line-added">+                     .proxy(NO_PROXY)</span>
<span class="line-added">+                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">+                     .build().newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 List&lt;byte[]&gt; a = actual.join();</span>
<span class="line-added">+                 assertEquals(a, expected);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      @Test(dataProvider = &quot;servers&quot;)
      public void simpleAggregatingTextMessages
              (Function&lt;int[],DummyWebSocketServer&gt; serverSupplier)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 552,63 ***</span>
                  0x80, 0x00,                               // &quot;
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         server = serverSupplier.apply(binary);</span>
<span class="line-modified">!         server.open();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">- </span>
<span class="line-removed">-             List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-removed">-             StringBuilder text = new StringBuilder();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">-                                              CharSequence message,</span>
<span class="line-removed">-                                              boolean last) {</span>
<span class="line-removed">-                 System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-removed">-                 webSocket.request(1);</span>
<span class="line-removed">-                 text.append(message);</span>
<span class="line-removed">-                 if (last) {</span>
<span class="line-removed">-                     String str = text.toString();</span>
<span class="line-removed">-                     text.setLength(0);</span>
<span class="line-removed">-                     processWholeText(str);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 return null;</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             private void processWholeText(String string) {</span>
<span class="line-removed">-                 System.out.println(string);</span>
<span class="line-removed">-                 collectedStrings.add(string);</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">-                                               int statusCode,</span>
<span class="line-removed">-                                               String reason) {</span>
<span class="line-removed">-                 actual.complete(collectedStrings);</span>
<span class="line-removed">-                 return null;</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                 actual.completeExceptionally(error);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         };</span>
  
<span class="line-modified">!         webSocket = newBuilder()</span>
<span class="line-modified">!                 .proxy(NO_PROXY)</span>
<span class="line-modified">!                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">!                 .build().newWebSocketBuilder()</span>
<span class="line-removed">-                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">-                 .join();</span>
  
<span class="line-modified">!         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">!         assertEquals(a, expected);</span>
  
<span class="line-modified">!         server.close();</span>
      }
  
      /*
       * Exercises the scenario where requests for more messages are made prior to
       * completing the returned CompletionStage instances.
<span class="line-new-header">--- 556,65 ---</span>
                  0x80, 0x00,                               // &quot;
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">!             server.open();</span>
  
<span class="line-modified">!             WebSocket.Listener listener = new WebSocket.Listener() {</span>
  
<span class="line-modified">!                 List&lt;String&gt; collectedStrings = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!                 StringBuilder text = new StringBuilder();</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-modified">!                                                  CharSequence message,</span>
<span class="line-modified">!                                                  boolean last) {</span>
<span class="line-modified">!                     System.out.printf(&quot;onText(%s, %s)%n&quot;, message, last);</span>
<span class="line-added">+                     webSocket.request(1);</span>
<span class="line-added">+                     text.append(message);</span>
<span class="line-added">+                     if (last) {</span>
<span class="line-added">+                         String str = text.toString();</span>
<span class="line-added">+                         text.setLength(0);</span>
<span class="line-added">+                         processWholeText(str);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     return null;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 private void processWholeText(String string) {</span>
<span class="line-modified">!                     System.out.println(string);</span>
<span class="line-modified">!                     collectedStrings.add(string);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-added">+                                                   int statusCode,</span>
<span class="line-added">+                                                   String reason) {</span>
<span class="line-added">+                     actual.complete(collectedStrings);</span>
<span class="line-added">+                     return null;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-added">+                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-added">+                     actual.completeExceptionally(error);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
<span class="line-added">+ </span>
<span class="line-added">+             var webSocket = newBuilder()</span>
<span class="line-added">+                     .proxy(NO_PROXY)</span>
<span class="line-added">+                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">+                     .build().newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">+                 assertEquals(a, expected);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      /*
       * Exercises the scenario where requests for more messages are made prior to
       * completing the returned CompletionStage instances.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 637,77 ***</span>
                  0x80, 0x00,                               // &quot;
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         server = serverSupplier.apply(binary);</span>
<span class="line-modified">!         server.open();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-removed">- </span>
<span class="line-removed">-             List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * A CompletableFuture which will complete once the current</span>
<span class="line-removed">-              * message has been fully assembled. Until then the listener</span>
<span class="line-removed">-              * returns this instance for every call.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">-             List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-removed">-                                              CharSequence message,</span>
<span class="line-removed">-                                              boolean last) {</span>
<span class="line-removed">-                 parts.add(message);</span>
<span class="line-removed">-                 if (!last) {</span>
<span class="line-removed">-                     webSocket.request(1);</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-removed">-                     CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-removed">-                     processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-removed">-                     currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-removed">-                     parts.clear();</span>
<span class="line-removed">-                     return refCf;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 return currentCf;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-removed">-                                               int statusCode,</span>
<span class="line-removed">-                                               String reason) {</span>
<span class="line-removed">-                 actual.complete(collected);</span>
<span class="line-removed">-                 return null;</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                 actual.completeExceptionally(error);</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">!                                             CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-modified">!                 StringBuilder b = new StringBuilder();</span>
<span class="line-modified">!                 data.forEach(b::append);</span>
<span class="line-modified">!                 String s = b.toString();</span>
<span class="line-modified">!                 System.out.println(s);</span>
<span class="line-modified">!                 cf.complete(null);</span>
<span class="line-removed">-                 collected.add(s);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         };</span>
  
<span class="line-modified">!         webSocket = newBuilder()</span>
<span class="line-modified">!                 .proxy(NO_PROXY)</span>
<span class="line-modified">!                 .authenticator(new WSAuthenticator())</span>
<span class="line-modified">!                 .build().newWebSocketBuilder()</span>
<span class="line-removed">-                 .buildAsync(server.getURI(), listener)</span>
<span class="line-removed">-                 .join();</span>
  
<span class="line-modified">!         List&lt;String&gt; a = actual.join();</span>
<span class="line-modified">!         assertEquals(a, expected);</span>
  
<span class="line-modified">!         server.close();</span>
      }
  
      // -- authentication specific tests
  
      /*
<span class="line-new-header">--- 643,79 ---</span>
                  0x80, 0x00,                               // &quot;
                  0x88, 0x00                                // &lt;CLOSE&gt;
          };
          CompletableFuture&lt;List&lt;String&gt;&gt; actual = new CompletableFuture&lt;&gt;();
  
<span class="line-modified">!         try (var server = serverSupplier.apply(binary)) {</span>
<span class="line-modified">!             server.open();</span>
  
<span class="line-modified">!             WebSocket.Listener listener = new WebSocket.Listener() {</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 List&lt;CharSequence&gt; parts = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!                 /*</span>
<span class="line-added">+                  * A CompletableFuture which will complete once the current</span>
<span class="line-added">+                  * message has been fully assembled. Until then the listener</span>
<span class="line-added">+                  * returns this instance for every call.</span>
<span class="line-added">+                  */</span>
<span class="line-added">+                 CompletableFuture&lt;?&gt; currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">+                 List&lt;String&gt; collected = new ArrayList&lt;&gt;();</span>
<span class="line-added">+ </span>
<span class="line-added">+                 @Override</span>
<span class="line-added">+                 public CompletionStage&lt;?&gt; onText(WebSocket webSocket,</span>
<span class="line-added">+                                                  CharSequence message,</span>
<span class="line-added">+                                                  boolean last) {</span>
<span class="line-added">+                     parts.add(message);</span>
<span class="line-added">+                     if (!last) {</span>
<span class="line-added">+                         webSocket.request(1);</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         this.currentCf.thenRun(() -&gt; webSocket.request(1));</span>
<span class="line-added">+                         CompletableFuture&lt;?&gt; refCf = this.currentCf;</span>
<span class="line-added">+                         processWholeMessage(new ArrayList&lt;&gt;(parts), refCf);</span>
<span class="line-added">+                         currentCf = new CompletableFuture&lt;&gt;();</span>
<span class="line-added">+                         parts.clear();</span>
<span class="line-added">+                         return refCf;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     return currentCf;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public CompletionStage&lt;?&gt; onClose(WebSocket webSocket,</span>
<span class="line-modified">!                                                   int statusCode,</span>
<span class="line-modified">!                                                   String reason) {</span>
<span class="line-modified">!                     actual.complete(collected);</span>
<span class="line-modified">!                     return null;</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 @Override</span>
<span class="line-modified">!                 public void onError(WebSocket webSocket, Throwable error) {</span>
<span class="line-modified">!                     actual.completeExceptionally(error);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 public void processWholeMessage(List&lt;CharSequence&gt; data,</span>
<span class="line-modified">!                                                 CompletableFuture&lt;?&gt; cf) {</span>
<span class="line-added">+                     StringBuilder b = new StringBuilder();</span>
<span class="line-added">+                     data.forEach(b::append);</span>
<span class="line-added">+                     String s = b.toString();</span>
<span class="line-added">+                     System.out.println(s);</span>
<span class="line-added">+                     cf.complete(null);</span>
<span class="line-added">+                     collected.add(s);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
  
<span class="line-modified">!             var webSocket = newBuilder()</span>
<span class="line-added">+                     .proxy(NO_PROXY)</span>
<span class="line-added">+                     .authenticator(new WSAuthenticator())</span>
<span class="line-added">+                     .build().newWebSocketBuilder()</span>
<span class="line-added">+                     .buildAsync(server.getURI(), listener)</span>
<span class="line-added">+                     .join();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 List&lt;String&gt; a = actual.join();</span>
<span class="line-added">+                 assertEquals(a, expected);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 webSocket.abort();</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
      }
  
      // -- authentication specific tests
  
      /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 723,10 ***</span>
<span class="line-new-header">--- 731,11 ---</span>
                      .authenticator(new WSAuthenticator())
                      .build()
                      .newWebSocketBuilder()
                      .buildAsync(server.getURI(), new WebSocket.Listener() { })
                      .join();
<span class="line-added">+             webSocket.abort();</span>
          }
      }
  
      /*
       * Ensures authentication succeeds when an `Authorization` header is explicitly set.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 743,10 ***</span>
<span class="line-new-header">--- 752,11 ---</span>
                      .proxy(NO_PROXY).build()
                      .newWebSocketBuilder()
                      .header(&quot;Authorization&quot;, hv)
                      .buildAsync(server.getURI(), new WebSocket.Listener() { })
                      .join();
<span class="line-added">+             webSocket.abort();</span>
          }
      }
  
      /*
       * Ensures authentication does not succeed when no authenticator is present.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 761,10 ***</span>
<span class="line-new-header">--- 771,11 ---</span>
                      .newWebSocketBuilder()
                      .buildAsync(server.getURI(), new WebSocket.Listener() { });
  
              try {
                  var webSocket = cf.join();
<span class="line-added">+                 silentAbort(webSocket);</span>
                  fail(&quot;Expected exception not thrown&quot;);
              } catch (CompletionException expected) {
                  WebSocketHandshakeException e = (WebSocketHandshakeException)expected.getCause();
                  HttpResponse&lt;?&gt; response = e.getResponse();
                  assertEquals(response.statusCode(), 401);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 781,11 ***</span>
          try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
              server.open();
  
              Authenticator authenticator = new Authenticator() {
                  @Override protected PasswordAuthentication getPasswordAuthentication() {
<span class="line-modified">!                     return new PasswordAuthentication(&quot;BAD&quot;+USERNAME, &quot;&quot;.toCharArray());</span>
                  }
              };
  
              CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
                      .proxy(NO_PROXY)
<span class="line-new-header">--- 792,11 ---</span>
          try (var server = new DummyWebSocketServer(USERNAME, PASSWORD)) {
              server.open();
  
              Authenticator authenticator = new Authenticator() {
                  @Override protected PasswordAuthentication getPasswordAuthentication() {
<span class="line-modified">!                     return new PasswordAuthentication(&quot;BAD&quot; + USERNAME, &quot;&quot;.toCharArray());</span>
                  }
              };
  
              CompletableFuture&lt;WebSocket&gt; cf = newBuilder()
                      .proxy(NO_PROXY)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 794,12 ***</span>
<span class="line-new-header">--- 805,18 ---</span>
                      .newWebSocketBuilder()
                      .buildAsync(server.getURI(), new WebSocket.Listener() { });
  
              try {
                  var webSocket = cf.join();
<span class="line-added">+                 silentAbort(webSocket);</span>
                  fail(&quot;Expected exception not thrown&quot;);
              } catch (CompletionException expected) {
                  System.out.println(&quot;caught expected exception:&quot; + expected);
              }
          }
      }
<span class="line-added">+     private static void silentAbort(WebSocket ws) {</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             ws.abort();</span>
<span class="line-added">+         } catch (Throwable t) { }</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="WebSocketProxyTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="security/httpclient.policy.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>