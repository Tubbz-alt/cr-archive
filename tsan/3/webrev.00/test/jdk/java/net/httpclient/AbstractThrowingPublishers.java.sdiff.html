<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/AbstractThrowingPublishers.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../URLPermission/nstest/LookupTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingPushPromises.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/AbstractThrowingPublishers.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import com.sun.net.httpserver.HttpServer;
 25 import com.sun.net.httpserver.HttpsConfigurator;
 26 import com.sun.net.httpserver.HttpsServer;
 27 import jdk.test.lib.net.SimpleSSLContext;

 28 import org.testng.annotations.AfterClass;
 29 import org.testng.annotations.AfterTest;

 30 import org.testng.annotations.BeforeTest;
 31 import org.testng.annotations.DataProvider;
 32 import org.testng.annotations.Test;
 33 
 34 import javax.net.ssl.SSLContext;
 35 import java.io.IOException;
 36 import java.io.InputStream;
 37 import java.io.OutputStream;
 38 import java.io.UncheckedIOException;
 39 import java.net.InetAddress;
 40 import java.net.InetSocketAddress;
 41 import java.net.URI;
 42 import java.net.http.HttpClient;
 43 import java.net.http.HttpRequest;
 44 import java.net.http.HttpRequest.BodyPublisher;
 45 import java.net.http.HttpRequest.BodyPublishers;
 46 import java.net.http.HttpResponse;
 47 import java.net.http.HttpResponse.BodyHandler;
 48 import java.net.http.HttpResponse.BodyHandlers;
 49 import java.nio.ByteBuffer;
</pre>
<hr />
<pre>
115             this.executor = executor;
116         }
117 
118         @Override
119         public void execute(Runnable command) {
120             long id = tasks.incrementAndGet();
121             executor.execute(() -&gt; {
122                 try {
123                     command.run();
124                 } catch (Throwable t) {
125                     tasksFailed = true;
126                     System.out.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
127                     System.err.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
128                     FAILURES.putIfAbsent(&quot;Task &quot; + id, t);
129                     throw t;
130                 }
131             });
132         }
133     }
134 











135     @AfterClass
136     static final void printFailedTests() {
137         out.println(&quot;\n=========================&quot;);
138         try {
139             out.printf(&quot;%n%sCreated %d servers and %d clients%n&quot;,
140                     now(), serverCount.get(), clientCount.get());
141             if (FAILURES.isEmpty()) return;
142             out.println(&quot;Failed tests: &quot;);
143             FAILURES.entrySet().forEach((e) -&gt; {
144                 out.printf(&quot;\t%s: %s%n&quot;, e.getKey(), e.getValue());
145                 e.getValue().printStackTrace(out);
146             });
147             if (tasksFailed) {
148                 System.out.println(&quot;WARNING: Some tasks failed&quot;);
149             }
150         } finally {
151             out.println(&quot;\n=========================\n&quot;);
152         }
153     }
154 
</pre>
<hr />
<pre>
200     private Object[][] variants(List&lt;Thrower&gt; throwers, Set&lt;Where&gt; whereValues) {
201         String[] uris = uris();
202         Object[][] result = new Object[uris.length * 2 * throwers.size()][];
203         //Object[][] result = new Object[(uris.length/2) * 2 * 2][];
204         int i = 0;
205         for (Thrower thrower : throwers) {
206             for (boolean sameClient : List.of(false, true)) {
207                 for (String uri : uris()) {
208                     // if (uri.contains(&quot;http2&quot;) || uri.contains(&quot;https2&quot;)) continue;
209                     // if (!sameClient) continue;
210                     result[i++] = new Object[]{uri, sameClient, thrower, whereValues};
211                 }
212             }
213         }
214         assert i == uris.length * 2 * throwers.size();
215         //assert Stream.of(result).filter(o -&gt; o != null).count() == result.length;
216         return result;
217     }
218 
219     @DataProvider(name = &quot;subscribeProvider&quot;)
<span class="line-modified">220     public Object[][] subscribeProvider() {</span>



221         return  variants(List.of(
222                 new UncheckedCustomExceptionThrower(),
223                 new UncheckedIOExceptionThrower()),
224                 EnumSet.of(Where.BEFORE_SUBSCRIBE, Where.AFTER_SUBSCRIBE));
225     }
226 
227     @DataProvider(name = &quot;requestProvider&quot;)
<span class="line-modified">228     public Object[][] requestProvider() {</span>



229         return  variants(List.of(
230                 new UncheckedCustomExceptionThrower(),
231                 new UncheckedIOExceptionThrower()),
232                 EnumSet.of(Where.BEFORE_REQUEST, Where.AFTER_REQUEST));
233     }
234 
235     @DataProvider(name = &quot;nextRequestProvider&quot;)
<span class="line-modified">236     public Object[][] nextRequestProvider() {</span>



237         return  variants(List.of(
238                 new UncheckedCustomExceptionThrower(),
239                 new UncheckedIOExceptionThrower()),
240                 EnumSet.of(Where.BEFORE_NEXT_REQUEST, Where.AFTER_NEXT_REQUEST));
241     }
242 
243     @DataProvider(name = &quot;beforeCancelProviderIO&quot;)
<span class="line-modified">244     public Object[][] beforeCancelProviderIO() {</span>



245         return  variants(List.of(
246                 new UncheckedIOExceptionThrower()),
247                 EnumSet.of(Where.BEFORE_CANCEL));
248     }
249 
250     @DataProvider(name = &quot;afterCancelProviderIO&quot;)
<span class="line-modified">251     public Object[][] afterCancelProviderIO() {</span>



252         return  variants(List.of(
253                 new UncheckedIOExceptionThrower()),
254                 EnumSet.of(Where.AFTER_CANCEL));
255     }
256 
257     @DataProvider(name = &quot;beforeCancelProviderCustom&quot;)
<span class="line-modified">258     public Object[][] beforeCancelProviderCustom() {</span>



259         return  variants(List.of(
260                 new UncheckedCustomExceptionThrower()),
261                 EnumSet.of(Where.BEFORE_CANCEL));
262     }
263 
264     @DataProvider(name = &quot;afterCancelProviderCustom&quot;)
<span class="line-modified">265     public Object[][] afterCancelProvider() {</span>



266         return  variants(List.of(
267                 new UncheckedCustomExceptionThrower()),
268                 EnumSet.of(Where.AFTER_CANCEL));
269     }
270 
271     private HttpClient makeNewClient() {
272         clientCount.incrementAndGet();
273         return TRACKER.track(HttpClient.newBuilder()
274                 .proxy(HttpClient.Builder.NO_PROXY)
275                 .executor(executor)
276                 .sslContext(sslContext)
277                 .build());
278     }
279 
280     HttpClient newHttpClient(boolean share) {
281         if (!share) return makeNewClient();
282         HttpClient shared = sharedClient;
283         if (shared != null) return shared;
284         synchronized (this) {
285             shared = sharedClient;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import com.sun.net.httpserver.HttpServer;
 25 import com.sun.net.httpserver.HttpsConfigurator;
 26 import com.sun.net.httpserver.HttpsServer;
 27 import jdk.test.lib.net.SimpleSSLContext;
<span class="line-added"> 28 import org.testng.ITestContext;</span>
 29 import org.testng.annotations.AfterClass;
 30 import org.testng.annotations.AfterTest;
<span class="line-added"> 31 import org.testng.annotations.BeforeMethod;</span>
 32 import org.testng.annotations.BeforeTest;
 33 import org.testng.annotations.DataProvider;
 34 import org.testng.annotations.Test;
 35 
 36 import javax.net.ssl.SSLContext;
 37 import java.io.IOException;
 38 import java.io.InputStream;
 39 import java.io.OutputStream;
 40 import java.io.UncheckedIOException;
 41 import java.net.InetAddress;
 42 import java.net.InetSocketAddress;
 43 import java.net.URI;
 44 import java.net.http.HttpClient;
 45 import java.net.http.HttpRequest;
 46 import java.net.http.HttpRequest.BodyPublisher;
 47 import java.net.http.HttpRequest.BodyPublishers;
 48 import java.net.http.HttpResponse;
 49 import java.net.http.HttpResponse.BodyHandler;
 50 import java.net.http.HttpResponse.BodyHandlers;
 51 import java.nio.ByteBuffer;
</pre>
<hr />
<pre>
117             this.executor = executor;
118         }
119 
120         @Override
121         public void execute(Runnable command) {
122             long id = tasks.incrementAndGet();
123             executor.execute(() -&gt; {
124                 try {
125                     command.run();
126                 } catch (Throwable t) {
127                     tasksFailed = true;
128                     System.out.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
129                     System.err.printf(now() + &quot;Task %s failed: %s%n&quot;, id, t);
130                     FAILURES.putIfAbsent(&quot;Task &quot; + id, t);
131                     throw t;
132                 }
133             });
134         }
135     }
136 
<span class="line-added">137     protected boolean stopAfterFirstFailure() {</span>
<span class="line-added">138         return Boolean.getBoolean(&quot;jdk.internal.httpclient.debug&quot;);</span>
<span class="line-added">139     }</span>
<span class="line-added">140 </span>
<span class="line-added">141     @BeforeMethod</span>
<span class="line-added">142     void beforeMethod(ITestContext context) {</span>
<span class="line-added">143         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">144             throw new RuntimeException(&quot;some tests failed&quot;);</span>
<span class="line-added">145         }</span>
<span class="line-added">146     }</span>
<span class="line-added">147 </span>
148     @AfterClass
149     static final void printFailedTests() {
150         out.println(&quot;\n=========================&quot;);
151         try {
152             out.printf(&quot;%n%sCreated %d servers and %d clients%n&quot;,
153                     now(), serverCount.get(), clientCount.get());
154             if (FAILURES.isEmpty()) return;
155             out.println(&quot;Failed tests: &quot;);
156             FAILURES.entrySet().forEach((e) -&gt; {
157                 out.printf(&quot;\t%s: %s%n&quot;, e.getKey(), e.getValue());
158                 e.getValue().printStackTrace(out);
159             });
160             if (tasksFailed) {
161                 System.out.println(&quot;WARNING: Some tasks failed&quot;);
162             }
163         } finally {
164             out.println(&quot;\n=========================\n&quot;);
165         }
166     }
167 
</pre>
<hr />
<pre>
213     private Object[][] variants(List&lt;Thrower&gt; throwers, Set&lt;Where&gt; whereValues) {
214         String[] uris = uris();
215         Object[][] result = new Object[uris.length * 2 * throwers.size()][];
216         //Object[][] result = new Object[(uris.length/2) * 2 * 2][];
217         int i = 0;
218         for (Thrower thrower : throwers) {
219             for (boolean sameClient : List.of(false, true)) {
220                 for (String uri : uris()) {
221                     // if (uri.contains(&quot;http2&quot;) || uri.contains(&quot;https2&quot;)) continue;
222                     // if (!sameClient) continue;
223                     result[i++] = new Object[]{uri, sameClient, thrower, whereValues};
224                 }
225             }
226         }
227         assert i == uris.length * 2 * throwers.size();
228         //assert Stream.of(result).filter(o -&gt; o != null).count() == result.length;
229         return result;
230     }
231 
232     @DataProvider(name = &quot;subscribeProvider&quot;)
<span class="line-modified">233     public Object[][] subscribeProvider(ITestContext context) {</span>
<span class="line-added">234         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">235             return new Object[0][];</span>
<span class="line-added">236         }</span>
237         return  variants(List.of(
238                 new UncheckedCustomExceptionThrower(),
239                 new UncheckedIOExceptionThrower()),
240                 EnumSet.of(Where.BEFORE_SUBSCRIBE, Where.AFTER_SUBSCRIBE));
241     }
242 
243     @DataProvider(name = &quot;requestProvider&quot;)
<span class="line-modified">244     public Object[][] requestProvider(ITestContext context) {</span>
<span class="line-added">245         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">246             return new Object[0][];</span>
<span class="line-added">247         }</span>
248         return  variants(List.of(
249                 new UncheckedCustomExceptionThrower(),
250                 new UncheckedIOExceptionThrower()),
251                 EnumSet.of(Where.BEFORE_REQUEST, Where.AFTER_REQUEST));
252     }
253 
254     @DataProvider(name = &quot;nextRequestProvider&quot;)
<span class="line-modified">255     public Object[][] nextRequestProvider(ITestContext context) {</span>
<span class="line-added">256         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">257             return new Object[0][];</span>
<span class="line-added">258         }</span>
259         return  variants(List.of(
260                 new UncheckedCustomExceptionThrower(),
261                 new UncheckedIOExceptionThrower()),
262                 EnumSet.of(Where.BEFORE_NEXT_REQUEST, Where.AFTER_NEXT_REQUEST));
263     }
264 
265     @DataProvider(name = &quot;beforeCancelProviderIO&quot;)
<span class="line-modified">266     public Object[][] beforeCancelProviderIO(ITestContext context) {</span>
<span class="line-added">267         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">268             return new Object[0][];</span>
<span class="line-added">269         }</span>
270         return  variants(List.of(
271                 new UncheckedIOExceptionThrower()),
272                 EnumSet.of(Where.BEFORE_CANCEL));
273     }
274 
275     @DataProvider(name = &quot;afterCancelProviderIO&quot;)
<span class="line-modified">276     public Object[][] afterCancelProviderIO(ITestContext context) {</span>
<span class="line-added">277         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">278             return new Object[0][];</span>
<span class="line-added">279         }</span>
280         return  variants(List.of(
281                 new UncheckedIOExceptionThrower()),
282                 EnumSet.of(Where.AFTER_CANCEL));
283     }
284 
285     @DataProvider(name = &quot;beforeCancelProviderCustom&quot;)
<span class="line-modified">286     public Object[][] beforeCancelProviderCustom(ITestContext context) {</span>
<span class="line-added">287         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">288             return new Object[0][];</span>
<span class="line-added">289         }</span>
290         return  variants(List.of(
291                 new UncheckedCustomExceptionThrower()),
292                 EnumSet.of(Where.BEFORE_CANCEL));
293     }
294 
295     @DataProvider(name = &quot;afterCancelProviderCustom&quot;)
<span class="line-modified">296     public Object[][] afterCancelProvider(ITestContext context) {</span>
<span class="line-added">297         if (stopAfterFirstFailure() &amp;&amp; context.getFailedTests().size() &gt; 0) {</span>
<span class="line-added">298             return new Object[0][];</span>
<span class="line-added">299         }</span>
300         return  variants(List.of(
301                 new UncheckedCustomExceptionThrower()),
302                 EnumSet.of(Where.AFTER_CANCEL));
303     }
304 
305     private HttpClient makeNewClient() {
306         clientCount.incrementAndGet();
307         return TRACKER.track(HttpClient.newBuilder()
308                 .proxy(HttpClient.Builder.NO_PROXY)
309                 .executor(executor)
310                 .sslContext(sslContext)
311                 .build());
312     }
313 
314     HttpClient newHttpClient(boolean share) {
315         if (!share) return makeNewClient();
316         HttpClient shared = sharedClient;
317         if (shared != null) return shared;
318         synchronized (this) {
319             shared = sharedClient;
</pre>
</td>
</tr>
</table>
<center><a href="../URLPermission/nstest/LookupTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AbstractThrowingPushPromises.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>