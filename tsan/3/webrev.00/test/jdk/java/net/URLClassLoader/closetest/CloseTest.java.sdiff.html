<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/URLClassLoader/closetest/CloseTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../HttpTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../URLConnection/B5052093.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLClassLoader/closetest/CloseTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2009, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 25  * @test
 26  * @bug 4167874
 27  * @modules java.logging
 28  *          jdk.httpserver
 29  *          jdk.compiler
 30  * @library ../../../../com/sun/net/httpserver
 31  *          /test/lib
 32  * @build jdk.test.lib.compiler.CompilerUtils
 33  *        jdk.test.lib.util.FileUtils
 34  *        jdk.test.lib.util.JarUtils
 35  *        jdk.test.lib.Platform
 36  *        FileServerHandler
 37  * @run main/othervm CloseTest
 38  * @summary URL-downloaded jar files can consume all available file descriptors
 39  */
 40 
 41 import java.io.File;
 42 import java.io.IOException;
 43 import java.lang.reflect.Method;
 44 import java.net.URLClassLoader;

 45 import java.net.InetSocketAddress;
 46 import java.net.URL;
 47 import java.nio.file.Files;
 48 import java.nio.file.Path;
 49 import java.nio.file.Paths;
 50 
 51 import jdk.test.lib.compiler.CompilerUtils;

 52 import jdk.test.lib.util.JarUtils;
 53 
 54 import com.sun.net.httpserver.HttpContext;
 55 import com.sun.net.httpserver.HttpServer;
 56 
 57 import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;
 58 
 59 public class CloseTest extends Common {
 60     private static final String WORK_DIR = System.getProperty(&quot;user.dir&quot;)
 61             + &quot;/&quot;;
 62 //
 63 // needs two jar files test1.jar and test2.jar with following structure
 64 //
 65 // com/foo/TestClass
 66 // com/foo/TestClass1
 67 // com/foo/Resource1
 68 // com/foo/Resource2
 69 //
 70 // and a directory hierarchy with the same structure/contents
 71 
</pre>
<hr />
<pre>
140         }
141 
142         // load tests
143         loadClass(&quot;com.foo.TestClass1&quot;, loader, false);
144         loadClass(&quot;com.foo.TestClass&quot;, loader, true);
145         loadClass(&quot;java.util.ArrayList&quot;, loader, true);
146 
147         // now check we can delete the path
148         rm_minus_rf(new File(name));
149         System.out.println(&quot; ... OK&quot;);
150     }
151 
152     static HttpServer httpServer;
153 
154     static HttpServer getHttpServer() {
155         return httpServer;
156     }
157 
158     static URL getServerURL() throws Exception {
159         int port = httpServer.getAddress().getPort();
<span class="line-modified">160         String s = &quot;http://127.0.0.1:&quot; + port + &quot;/&quot;;</span>
<span class="line-modified">161         return new URL(s);</span>




162     }
163 
164     static void startHttpServer(String docroot) throws Exception {
<span class="line-modified">165         httpServer = HttpServer.create(new InetSocketAddress(0), 10);</span>


166         HttpContext ctx = httpServer.createContext(
167                 &quot;/&quot;, new FileServerHandler(docroot)
168         );
169         httpServer.start();
170     }
171 
172     /**
173      * Prepare jars files for the tests
174      */
175     private static void setup () throws IOException {
176         String[] tests = new String[]{&quot;test1&quot;, &quot;test2&quot;};
177         Path workDir = Paths.get(WORK_DIR);
178         Path testSrc = Paths.get(System.getProperty(&quot;test.src&quot;));
179         for (String test : tests) {
180             Path testSrcDir =  testSrc.resolve(test);
181             Path testTargetDir = workDir.resolve(test);
182             // Compile sources for corresponding test
183             CompilerUtils.compile(testSrcDir, testTargetDir);
184             // Copy all resources
185             Path packages = Paths.get(&quot;com&quot;, &quot;foo&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 25  * @test
 26  * @bug 4167874
 27  * @modules java.logging
 28  *          jdk.httpserver
 29  *          jdk.compiler
 30  * @library ../../../../com/sun/net/httpserver
 31  *          /test/lib
 32  * @build jdk.test.lib.compiler.CompilerUtils
 33  *        jdk.test.lib.util.FileUtils
 34  *        jdk.test.lib.util.JarUtils
 35  *        jdk.test.lib.Platform
 36  *        FileServerHandler
 37  * @run main/othervm CloseTest
 38  * @summary URL-downloaded jar files can consume all available file descriptors
 39  */
 40 
 41 import java.io.File;
 42 import java.io.IOException;
 43 import java.lang.reflect.Method;
 44 import java.net.URLClassLoader;
<span class="line-added"> 45 import java.net.InetAddress;</span>
 46 import java.net.InetSocketAddress;
 47 import java.net.URL;
 48 import java.nio.file.Files;
 49 import java.nio.file.Path;
 50 import java.nio.file.Paths;
 51 
 52 import jdk.test.lib.compiler.CompilerUtils;
<span class="line-added"> 53 import jdk.test.lib.net.URIBuilder;</span>
 54 import jdk.test.lib.util.JarUtils;
 55 
 56 import com.sun.net.httpserver.HttpContext;
 57 import com.sun.net.httpserver.HttpServer;
 58 
 59 import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;
 60 
 61 public class CloseTest extends Common {
 62     private static final String WORK_DIR = System.getProperty(&quot;user.dir&quot;)
 63             + &quot;/&quot;;
 64 //
 65 // needs two jar files test1.jar and test2.jar with following structure
 66 //
 67 // com/foo/TestClass
 68 // com/foo/TestClass1
 69 // com/foo/Resource1
 70 // com/foo/Resource2
 71 //
 72 // and a directory hierarchy with the same structure/contents
 73 
</pre>
<hr />
<pre>
142         }
143 
144         // load tests
145         loadClass(&quot;com.foo.TestClass1&quot;, loader, false);
146         loadClass(&quot;com.foo.TestClass&quot;, loader, true);
147         loadClass(&quot;java.util.ArrayList&quot;, loader, true);
148 
149         // now check we can delete the path
150         rm_minus_rf(new File(name));
151         System.out.println(&quot; ... OK&quot;);
152     }
153 
154     static HttpServer httpServer;
155 
156     static HttpServer getHttpServer() {
157         return httpServer;
158     }
159 
160     static URL getServerURL() throws Exception {
161         int port = httpServer.getAddress().getPort();
<span class="line-modified">162         return URIBuilder.newBuilder()</span>
<span class="line-modified">163             .scheme(&quot;http&quot;)</span>
<span class="line-added">164             .loopback()</span>
<span class="line-added">165             .port(port)</span>
<span class="line-added">166             .path(&quot;/&quot;)</span>
<span class="line-added">167             .toURL();</span>
168     }
169 
170     static void startHttpServer(String docroot) throws Exception {
<span class="line-modified">171         httpServer = HttpServer.create(</span>
<span class="line-added">172                 new InetSocketAddress(InetAddress.getLoopbackAddress(), 0),</span>
<span class="line-added">173                 10);</span>
174         HttpContext ctx = httpServer.createContext(
175                 &quot;/&quot;, new FileServerHandler(docroot)
176         );
177         httpServer.start();
178     }
179 
180     /**
181      * Prepare jars files for the tests
182      */
183     private static void setup () throws IOException {
184         String[] tests = new String[]{&quot;test1&quot;, &quot;test2&quot;};
185         Path workDir = Paths.get(WORK_DIR);
186         Path testSrc = Paths.get(System.getProperty(&quot;test.src&quot;));
187         for (String test : tests) {
188             Path testSrcDir =  testSrc.resolve(test);
189             Path testTargetDir = workDir.resolve(test);
190             // Compile sources for corresponding test
191             CompilerUtils.compile(testSrcDir, testTargetDir);
192             // Copy all resources
193             Path packages = Paths.get(&quot;com&quot;, &quot;foo&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../HttpTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../URLConnection/B5052093.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>