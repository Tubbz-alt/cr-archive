<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/URL/PerConnectionProxy.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="HandlerLoop.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../URLClassLoader/ClassLoad.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URL/PerConnectionProxy.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 4920526
 26  * @summary Needs per connection proxy support for URLs
 27  * @modules java.base/sun.net.www
<span class="line-modified"> 28  * @library ../../../sun/net/www/httptest/</span>
 29  * @build ClosedChannelList TestHttpServer HttpTransaction HttpCallback
 30  * @compile PerConnectionProxy.java
 31  * @run main/othervm -Dhttp.proxyHost=inexistant -Dhttp.proxyPort=8080 PerConnectionProxy
 32  */
 33 
 34 import java.net.*;
 35 import java.io.*;
<span class="line-modified"> 36 import sun.net.www.*;</span>

 37 
 38 public class PerConnectionProxy implements HttpCallback {
 39     static TestHttpServer server;
 40 
 41     public void request (HttpTransaction req) {
 42         req.setResponseEntityBody (&quot;Hello .&quot;);
 43         try {
 44             req.sendResponse (200, &quot;Ok&quot;);
 45             req.orderlyClose();
 46         } catch (IOException e) {
 47         }
 48     }
 49 
 50     public static void main(String[] args) {
 51         try {
<span class="line-modified"> 52             server = new TestHttpServer (new PerConnectionProxy(), 1, 10, 0);</span>
<span class="line-modified"> 53             ProxyServer pserver = new ProxyServer(InetAddress.getByName(&quot;localhost&quot;), server.getLocalPort());</span>

 54             // start proxy server
 55             new Thread(pserver).start();
 56 
<span class="line-modified"> 57             URL url = new URL(&quot;http://localhost:&quot;+server.getLocalPort());</span>




 58 
 59             // for non existing proxy expect an IOException
 60             try {
 61                 InetSocketAddress isa = InetSocketAddress.createUnresolved(&quot;inexistent&quot;, 8080);
 62                 Proxy proxy = new Proxy(Proxy.Type.HTTP, isa);
 63                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (proxy);
 64                 InputStream is = urlc.getInputStream ();
 65                 is.close();
 66                 throw new RuntimeException(&quot;non existing per connection proxy should lead to IOException&quot;);
 67             } catch (IOException ioex) {
 68                 // expected
 69             }
 70 
 71             // for NO_PROXY, expect direct connection
 72             try {
 73                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (Proxy.NO_PROXY);
 74                 int respCode = urlc.getResponseCode();
 75                 urlc.disconnect();
 76             } catch (IOException ioex) {
 77                 throw new RuntimeException(&quot;direct connection should succeed :&quot;+ioex.getMessage());
 78             }
 79 
 80             // for a normal proxy setting expect to see connection
 81             // goes through that proxy
 82             try {
<span class="line-modified"> 83                 InetSocketAddress isa = InetSocketAddress.createUnresolved(&quot;localhost&quot;, pserver.getPort());</span>


 84                 Proxy p = new Proxy(Proxy.Type.HTTP, isa);
 85                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (p);
 86                 int respCode = urlc.getResponseCode();
 87                 urlc.disconnect();
 88             } catch (IOException ioex) {
 89                 throw new RuntimeException(&quot;connection through a local proxy should succeed :&quot;+ioex.getMessage());
 90             }
 91 
 92         } catch (Exception e) {
 93             throw new RuntimeException(e);
 94         } finally {
 95             if (server != null) {
 96                 server.terminate();
 97             }
 98         }
 99 
100     }
101 
102     static class ProxyServer extends Thread {
103         private static ServerSocket ss = null;
104 
105         // client requesting for a tunnel
106         private Socket clientSocket = null;
107 
108         /*
109          * Origin server&#39;s address and port that the client
110          * wants to establish the tunnel for communication.
111          */
112         private InetAddress serverInetAddr;
113         private int     serverPort;
114 
115         public ProxyServer(InetAddress server, int port) throws IOException {
116             serverInetAddr = server;
117             serverPort = port;
<span class="line-modified">118             ss = new ServerSocket(0);</span>
119         }
120 
121         public void run() {
122             try {
123                 clientSocket = ss.accept();
124                 processRequests();
125             } catch (Exception e) {
126                 System.out.println(&quot;Proxy Failed: &quot; + e);
127                 e.printStackTrace();
128                 try {
129                     ss.close();
130                 }
131                 catch (IOException excep) {
132                     System.out.println(&quot;ProxyServer close error: &quot; + excep);
133                     excep.printStackTrace();
134                 }
135             }
136         }
137 
138         private void processRequests() throws Exception {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @bug 4920526
 26  * @summary Needs per connection proxy support for URLs
 27  * @modules java.base/sun.net.www
<span class="line-modified"> 28  * @library ../../../sun/net/www/httptest/ /test/lib</span>
 29  * @build ClosedChannelList TestHttpServer HttpTransaction HttpCallback
 30  * @compile PerConnectionProxy.java
 31  * @run main/othervm -Dhttp.proxyHost=inexistant -Dhttp.proxyPort=8080 PerConnectionProxy
 32  */
 33 
 34 import java.net.*;
 35 import java.io.*;
<span class="line-modified"> 36 </span>
<span class="line-added"> 37 import jdk.test.lib.net.URIBuilder;</span>
 38 
 39 public class PerConnectionProxy implements HttpCallback {
 40     static TestHttpServer server;
 41 
 42     public void request (HttpTransaction req) {
 43         req.setResponseEntityBody (&quot;Hello .&quot;);
 44         try {
 45             req.sendResponse (200, &quot;Ok&quot;);
 46             req.orderlyClose();
 47         } catch (IOException e) {
 48         }
 49     }
 50 
 51     public static void main(String[] args) {
 52         try {
<span class="line-modified"> 53             InetAddress loopbackAddress = InetAddress.getLoopbackAddress();</span>
<span class="line-modified"> 54             server = new TestHttpServer(new PerConnectionProxy(), 1, 10, loopbackAddress, 0);</span>
<span class="line-added"> 55             ProxyServer pserver = new ProxyServer(loopbackAddress, server.getLocalPort());</span>
 56             // start proxy server
 57             new Thread(pserver).start();
 58 
<span class="line-modified"> 59             URL url = URIBuilder.newBuilder()</span>
<span class="line-added"> 60                     .scheme(&quot;http&quot;)</span>
<span class="line-added"> 61                     .loopback()</span>
<span class="line-added"> 62                     .port(server.getLocalPort())</span>
<span class="line-added"> 63                     .toURLUnchecked();</span>
 64 
 65             // for non existing proxy expect an IOException
 66             try {
 67                 InetSocketAddress isa = InetSocketAddress.createUnresolved(&quot;inexistent&quot;, 8080);
 68                 Proxy proxy = new Proxy(Proxy.Type.HTTP, isa);
 69                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (proxy);
 70                 InputStream is = urlc.getInputStream ();
 71                 is.close();
 72                 throw new RuntimeException(&quot;non existing per connection proxy should lead to IOException&quot;);
 73             } catch (IOException ioex) {
 74                 // expected
 75             }
 76 
 77             // for NO_PROXY, expect direct connection
 78             try {
 79                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (Proxy.NO_PROXY);
 80                 int respCode = urlc.getResponseCode();
 81                 urlc.disconnect();
 82             } catch (IOException ioex) {
 83                 throw new RuntimeException(&quot;direct connection should succeed :&quot;+ioex.getMessage());
 84             }
 85 
 86             // for a normal proxy setting expect to see connection
 87             // goes through that proxy
 88             try {
<span class="line-modified"> 89                 InetSocketAddress isa = InetSocketAddress.createUnresolved(</span>
<span class="line-added"> 90                         loopbackAddress.getHostAddress(),</span>
<span class="line-added"> 91                         pserver.getPort());</span>
 92                 Proxy p = new Proxy(Proxy.Type.HTTP, isa);
 93                 HttpURLConnection urlc = (HttpURLConnection)url.openConnection (p);
 94                 int respCode = urlc.getResponseCode();
 95                 urlc.disconnect();
 96             } catch (IOException ioex) {
 97                 throw new RuntimeException(&quot;connection through a local proxy should succeed :&quot;+ioex.getMessage());
 98             }
 99 
100         } catch (Exception e) {
101             throw new RuntimeException(e);
102         } finally {
103             if (server != null) {
104                 server.terminate();
105             }
106         }
107 
108     }
109 
110     static class ProxyServer extends Thread {
111         private static ServerSocket ss = null;
112 
113         // client requesting for a tunnel
114         private Socket clientSocket = null;
115 
116         /*
117          * Origin server&#39;s address and port that the client
118          * wants to establish the tunnel for communication.
119          */
120         private InetAddress serverInetAddr;
121         private int     serverPort;
122 
123         public ProxyServer(InetAddress server, int port) throws IOException {
124             serverInetAddr = server;
125             serverPort = port;
<span class="line-modified">126             ss = new ServerSocket(0, 0, InetAddress.getLoopbackAddress());</span>
127         }
128 
129         public void run() {
130             try {
131                 clientSocket = ss.accept();
132                 processRequests();
133             } catch (Exception e) {
134                 System.out.println(&quot;Proxy Failed: &quot; + e);
135                 e.printStackTrace();
136                 try {
137                     ss.close();
138                 }
139                 catch (IOException excep) {
140                     System.out.println(&quot;ProxyServer close error: &quot; + excep);
141                     excep.printStackTrace();
142                 }
143             }
144         }
145 
146         private void processRequests() throws Exception {
</pre>
</td>
</tr>
</table>
<center><a href="HandlerLoop.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../URLClassLoader/ClassLoad.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>