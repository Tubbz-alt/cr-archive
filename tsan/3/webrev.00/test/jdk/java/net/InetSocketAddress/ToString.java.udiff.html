<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/InetSocketAddress/ToString.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../InetAddress/ptr/Lookup.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../MulticastSocket/JoinLeave.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/InetSocketAddress/ToString.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,21 +21,143 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 4464064</span>
<span class="udiff-line-modified-removed">-  * @summary InetSocketAddress.toString() throws NPE with unresolved address</span>
<span class="udiff-line-modified-added">+  * @bug 8225499 4464064</span>
<span class="udiff-line-modified-added">+  * @library /test/lib</span>
<span class="udiff-line-added">+  * @summary InetSocketAddress::toString not friendly to IPv6 literal addresses</span>
<span class="udiff-line-added">+  * @run testng/othervm ToString</span>
<span class="udiff-line-added">+  * @run testng/othervm -Djava.net.preferIPv4Stack=true ToString</span>
<span class="udiff-line-added">+  * @run testng/othervm -Djava.net.preferIPv6Addresses=true ToString</span>
   */
  
  import java.net.*;
<span class="udiff-line-removed">- import java.io.*;</span>
  
<span class="udiff-line-added">+ import jdk.test.lib.net.IPSupport;</span>
<span class="udiff-line-added">+ import org.testng.annotations.BeforeTest;</span>
<span class="udiff-line-added">+ import org.testng.annotations.DataProvider;</span>
<span class="udiff-line-added">+ import org.testng.annotations.Test;</span>
  
  public class ToString {
  
<span class="udiff-line-modified-removed">-     public static void main (String args[]){</span>
<span class="udiff-line-modified-added">+     private static final String loopbackAddr;</span>
<span class="udiff-line-added">+     private static final String wildcardAddr;</span>
<span class="udiff-line-added">+     private static final String localAddr;</span>
  
<span class="udiff-line-added">+     static {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-added">+             String addr = loopback.getHostAddress();</span>
<span class="udiff-line-added">+             if (loopback instanceof Inet6Address) {</span>
<span class="udiff-line-added">+                 addr = &quot;[&quot; + addr + &quot;]&quot;;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             loopbackAddr = addr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             InetSocketAddress isa = new InetSocketAddress((InetAddress) null, 80);</span>
<span class="udiff-line-added">+             addr = isa.getAddress().toString();</span>
<span class="udiff-line-added">+             if (isa.getAddress() instanceof Inet6Address) {</span>
<span class="udiff-line-added">+                 addr = &quot;::/[0:0:0:0:0:0:0:0]&quot;;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             wildcardAddr = addr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             InetAddress ia = InetAddress.getLocalHost();</span>
<span class="udiff-line-added">+             addr = ia.toString();</span>
<span class="udiff-line-added">+             if (ia instanceof Inet6Address) {</span>
<span class="udiff-line-added">+                 addr = ia.getHostName() + &quot;/[&quot; + ia.getHostAddress() + &quot;]&quot;;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             localAddr = addr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         } catch (UnknownHostException uhe) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(uhe);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @BeforeTest</span>
<span class="udiff-line-added">+     public void setup() {</span>
<span class="udiff-line-added">+         IPSupport.throwSkippedExceptionIfNonOperational();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     // InetSocketAddress.toString() throws NPE with unresolved address</span>
<span class="udiff-line-added">+     public static void NPETest() {</span>
          System.out.println(new InetSocketAddress(&quot;unresolved&quot;, 12345));
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;hostPortArgs&quot;)</span>
<span class="udiff-line-added">+     public Object[][] createArgs1() {</span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+                 // hostname, port number, expected string in format</span>
<span class="udiff-line-added">+                 // &lt;hostname&gt;/&lt;IP literal&gt;:&lt;port&gt; or</span>
<span class="udiff-line-added">+                 // &lt;hostname&gt;/&lt;unresolved&gt;:&lt;port&gt; if address is unresolved</span>
<span class="udiff-line-added">+                 {&quot;::1&quot;, 80, &quot;/[0:0:0:0:0:0:0:1]:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210&quot;, 80, &quot;/[fedc:ba98:7654:3210:fedc:ba98:7654:3210]:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;::192.9.5.5&quot;, 80, &quot;/[0:0:0:0:0:0:c009:505]:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;127.0.0.1&quot;, 80, &quot;/127.0.0.1:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;::ffff:192.0.2.128&quot;, 80, &quot;/192.0.2.128:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;0&quot;, 80, &quot;/0.0.0.0:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;:&quot;, 80, &quot;:/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;:1&quot;, 80, &quot;:1/&lt;unresolved&gt;:80&quot;}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;hostPortArgs&quot;)</span>
<span class="udiff-line-added">+     public static void testConstructor(String host, int port, String string) {</span>
<span class="udiff-line-added">+         String received = new InetSocketAddress(host, port).toString();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!string.equals(received)) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;addrPortArgs&quot;)</span>
<span class="udiff-line-added">+     public Object[][] createArgs2() {</span>
<span class="udiff-line-added">+         InetAddress nullAddr = null;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return new Object[][]{</span>
<span class="udiff-line-added">+                     // InetAddress, port number, expected string</span>
<span class="udiff-line-added">+                     {InetAddress.getLoopbackAddress(), 80, &quot;localhost/&quot; + loopbackAddr + &quot;:80&quot;},</span>
<span class="udiff-line-added">+                     {InetAddress.getLocalHost(), 80, localAddr + &quot;:80&quot;},</span>
<span class="udiff-line-added">+                     {InetAddress.getByAddress(new byte[]{1, 1, 1, 1}), 80, &quot;/1.1.1.1:80&quot;},</span>
<span class="udiff-line-added">+                     {InetAddress.getByAddress(new byte[]{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}), 80, &quot;/[101:101:101:101:101:101:101:101]:80&quot;},</span>
<span class="udiff-line-added">+                     {InetAddress.getByName(&quot;225.225.225.0&quot;), 80, &quot;/225.225.225.0:80&quot;},</span>
<span class="udiff-line-added">+                     {nullAddr, 80, wildcardAddr + &quot;:80&quot;}</span>
<span class="udiff-line-added">+             };</span>
<span class="udiff-line-added">+         } catch (UnknownHostException uhe) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Data provider creation failed: &quot; + uhe, uhe);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;addrPortArgs&quot;)</span>
<span class="udiff-line-added">+     public static void testConstructor(InetAddress addr, int port, String string) {</span>
<span class="udiff-line-added">+         String received = new InetSocketAddress(addr, port).toString();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!string.equals(received)) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DataProvider(name = &quot;unresolved&quot;)</span>
<span class="udiff-line-added">+     public Object[][] createArgs3() {</span>
<span class="udiff-line-added">+         return new Object[][]{</span>
<span class="udiff-line-added">+                 // hostname, port number, expected string</span>
<span class="udiff-line-added">+                 {&quot;::1&quot;, 80, &quot;::1/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210&quot;, 80, &quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;::192.9.5.5&quot;, 80, &quot;::192.9.5.5/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;127.0.0.1&quot;, 80, &quot;127.0.0.1/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;::ffff:192.0.2.128&quot;, 80, &quot;::ffff:192.0.2.128/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;0&quot;, 80, &quot;0/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;foo&quot;, 80, &quot;foo/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;:&quot;, 80, &quot;:/&lt;unresolved&gt;:80&quot;},</span>
<span class="udiff-line-added">+                 {&quot;:1&quot;, 80, &quot;:1/&lt;unresolved&gt;:80&quot;}</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(dataProvider = &quot;unresolved&quot;)</span>
<span class="udiff-line-added">+     public static void testCreateUnresolved(String host, int port, String string) {</span>
<span class="udiff-line-added">+         String received = InetSocketAddress.createUnresolved(host, port).toString();</span>
  
<span class="udiff-line-added">+         if (!string.equals(received)) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);</span>
<span class="udiff-line-added">+         }</span>
      }
  }
</pre>
<center><a href="../InetAddress/ptr/Lookup.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../MulticastSocket/JoinLeave.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>