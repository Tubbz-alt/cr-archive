<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/InetSocketAddress/ToString.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8225499 4464064
 27  * @library /test/lib
 28  * @summary InetSocketAddress::toString not friendly to IPv6 literal addresses
 29  * @run testng/othervm ToString
 30  * @run testng/othervm -Djava.net.preferIPv4Stack=true ToString
 31  * @run testng/othervm -Djava.net.preferIPv6Addresses=true ToString
 32  */
 33 
 34 import java.net.*;
 35 
 36 import jdk.test.lib.net.IPSupport;
 37 import org.testng.annotations.BeforeTest;
 38 import org.testng.annotations.DataProvider;
 39 import org.testng.annotations.Test;
 40 
 41 public class ToString {
 42 
 43     private static final String loopbackAddr;
 44     private static final String wildcardAddr;
 45     private static final String localAddr;
 46 
 47     static {
 48         try {
 49             InetAddress loopback = InetAddress.getLoopbackAddress();
 50             String addr = loopback.getHostAddress();
 51             if (loopback instanceof Inet6Address) {
 52                 addr = &quot;[&quot; + addr + &quot;]&quot;;
 53             }
 54             loopbackAddr = addr;
 55 
 56             InetSocketAddress isa = new InetSocketAddress((InetAddress) null, 80);
 57             addr = isa.getAddress().toString();
 58             if (isa.getAddress() instanceof Inet6Address) {
 59                 addr = &quot;::/[0:0:0:0:0:0:0:0]&quot;;
 60             }
 61             wildcardAddr = addr;
 62 
 63             InetAddress ia = InetAddress.getLocalHost();
 64             addr = ia.toString();
 65             if (ia instanceof Inet6Address) {
 66                 addr = ia.getHostName() + &quot;/[&quot; + ia.getHostAddress() + &quot;]&quot;;
 67             }
 68             localAddr = addr;
 69 
 70         } catch (UnknownHostException uhe) {
 71             throw new RuntimeException(uhe);
 72         }
 73     }
 74 
 75     @BeforeTest
 76     public void setup() {
 77         IPSupport.throwSkippedExceptionIfNonOperational();
 78     }
 79 
 80     @Test
 81     // InetSocketAddress.toString() throws NPE with unresolved address
 82     public static void NPETest() {
 83         System.out.println(new InetSocketAddress(&quot;unresolved&quot;, 12345));
 84     }
 85 
 86     @DataProvider(name = &quot;hostPortArgs&quot;)
 87     public Object[][] createArgs1() {
 88         return new Object[][]{
 89                 // hostname, port number, expected string in format
 90                 // &lt;hostname&gt;/&lt;IP literal&gt;:&lt;port&gt; or
 91                 // &lt;hostname&gt;/&lt;unresolved&gt;:&lt;port&gt; if address is unresolved
 92                 {&quot;::1&quot;, 80, &quot;/[0:0:0:0:0:0:0:1]:80&quot;},
 93                 {&quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210&quot;, 80, &quot;/[fedc:ba98:7654:3210:fedc:ba98:7654:3210]:80&quot;},
 94                 {&quot;::192.9.5.5&quot;, 80, &quot;/[0:0:0:0:0:0:c009:505]:80&quot;},
 95                 {&quot;127.0.0.1&quot;, 80, &quot;/127.0.0.1:80&quot;},
 96                 {&quot;::ffff:192.0.2.128&quot;, 80, &quot;/192.0.2.128:80&quot;},
 97                 {&quot;0&quot;, 80, &quot;/0.0.0.0:80&quot;},
 98                 {&quot;:&quot;, 80, &quot;:/&lt;unresolved&gt;:80&quot;},
 99                 {&quot;:1&quot;, 80, &quot;:1/&lt;unresolved&gt;:80&quot;}
100         };
101     }
102 
103     @Test(dataProvider = &quot;hostPortArgs&quot;)
104     public static void testConstructor(String host, int port, String string) {
105         String received = new InetSocketAddress(host, port).toString();
106 
107         if (!string.equals(received)) {
108             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);
109         }
110     }
111 
112     @DataProvider(name = &quot;addrPortArgs&quot;)
113     public Object[][] createArgs2() {
114         InetAddress nullAddr = null;
115         try {
116             return new Object[][]{
117                     // InetAddress, port number, expected string
118                     {InetAddress.getLoopbackAddress(), 80, &quot;localhost/&quot; + loopbackAddr + &quot;:80&quot;},
119                     {InetAddress.getLocalHost(), 80, localAddr + &quot;:80&quot;},
120                     {InetAddress.getByAddress(new byte[]{1, 1, 1, 1}), 80, &quot;/1.1.1.1:80&quot;},
121                     {InetAddress.getByAddress(new byte[]{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}), 80, &quot;/[101:101:101:101:101:101:101:101]:80&quot;},
122                     {InetAddress.getByName(&quot;225.225.225.0&quot;), 80, &quot;/225.225.225.0:80&quot;},
123                     {nullAddr, 80, wildcardAddr + &quot;:80&quot;}
124             };
125         } catch (UnknownHostException uhe) {
126             throw new RuntimeException(&quot;Data provider creation failed: &quot; + uhe, uhe);
127         }
128     }
129 
130     @Test(dataProvider = &quot;addrPortArgs&quot;)
131     public static void testConstructor(InetAddress addr, int port, String string) {
132         String received = new InetSocketAddress(addr, port).toString();
133 
134         if (!string.equals(received)) {
135             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);
136         }
137     }
138 
139     @DataProvider(name = &quot;unresolved&quot;)
140     public Object[][] createArgs3() {
141         return new Object[][]{
142                 // hostname, port number, expected string
143                 {&quot;::1&quot;, 80, &quot;::1/&lt;unresolved&gt;:80&quot;},
144                 {&quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210&quot;, 80, &quot;fedc:ba98:7654:3210:fedc:ba98:7654:3210/&lt;unresolved&gt;:80&quot;},
145                 {&quot;::192.9.5.5&quot;, 80, &quot;::192.9.5.5/&lt;unresolved&gt;:80&quot;},
146                 {&quot;127.0.0.1&quot;, 80, &quot;127.0.0.1/&lt;unresolved&gt;:80&quot;},
147                 {&quot;::ffff:192.0.2.128&quot;, 80, &quot;::ffff:192.0.2.128/&lt;unresolved&gt;:80&quot;},
148                 {&quot;0&quot;, 80, &quot;0/&lt;unresolved&gt;:80&quot;},
149                 {&quot;foo&quot;, 80, &quot;foo/&lt;unresolved&gt;:80&quot;},
150                 {&quot;:&quot;, 80, &quot;:/&lt;unresolved&gt;:80&quot;},
151                 {&quot;:1&quot;, 80, &quot;:1/&lt;unresolved&gt;:80&quot;}
152         };
153     }
154 
155     @Test(dataProvider = &quot;unresolved&quot;)
156     public static void testCreateUnresolved(String host, int port, String string) {
157         String received = InetSocketAddress.createUnresolved(host, port).toString();
158 
159         if (!string.equals(received)) {
160             throw new RuntimeException(&quot;Expected: &quot; + string + &quot; Received: &quot; + received);
161         }
162     }
163 }
    </pre>
  </body>
</html>