<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/BindException/Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../Authenticator/Deadlock.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../CookieHandler/B6791927.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/BindException/Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 34 
 35 import java.net.*;
 36 import java.util.Enumeration;
 37 import jdk.test.lib.NetworkConfiguration;
 38 
 39 public class Test {
 40 
 41     static Object[][] getTestCombinations() {
 42         return new Object[][]  {
 43             { &quot;ServerSocket&quot;,   &quot;Socket&quot; },
 44             { &quot;Socket&quot;,         &quot;Socket&quot; },
 45             { &quot;DatagramSocket&quot;, &quot;DatagramSocket&quot; },
 46         };
 47     }
 48 
 49     static InetAddress ia4_this;
 50     static InetAddress ia6_this;
 51 
 52     static int count;
 53     static int failures;

 54 
 55     static void doTest(Object test[], InetAddress ia1, InetAddress ia2,
 56                        boolean silent) throws Exception {
<span class="line-removed"> 57         String s1_type = (String)test[0];</span>
<span class="line-removed"> 58         String s2_type = (String)test[1];</span>
<span class="line-removed"> 59         int port = 0;</span>
<span class="line-removed"> 60 </span>
 61         /*
 62          * Increment test count
 63          */
 64         count++;
 65 









 66         /*
 67          * Do the test
 68          */
 69 
 70         boolean gotBindException = false;
 71         boolean failed = false;
 72         Exception failed_exc = null;
 73 
 74         Socket sock1 = null;
 75         ServerSocket ss = null;
 76         DatagramSocket dsock1 = null;


 77         try {
 78             /* bind the first socket */
 79 
 80             if (s1_type.equals(&quot;Socket&quot;)) {
 81                 sock1 = new Socket();
 82                 sock1.bind( new InetSocketAddress(ia1, 0));
 83                 port = sock1.getLocalPort();
 84             }
 85 
 86             if (s1_type.equals(&quot;ServerSocket&quot;)) {
 87                 ss = new ServerSocket(0, 0, ia1);
 88                 port = ss.getLocalPort();
 89             }
 90 
 91             if (s1_type.equals(&quot;DatagramSocket&quot;)) {
 92                 dsock1 = new DatagramSocket( new InetSocketAddress(ia1, 0) );
 93                 port = dsock1.getLocalPort();
 94             }
 95 
 96             /* bind the second socket */
 97 







 98             if (s2_type.equals(&quot;Socket&quot;)) {
 99                 try (Socket sock2 = new Socket()) {
100                     sock2.bind( new InetSocketAddress(ia2, port));
101                 }
102             }
103 
104             if (s2_type.equals(&quot;ServerSocket&quot;)) {
105                 try (ServerSocket ss2 = new ServerSocket(port, 0, ia2)) { }
106             }
107 
108             if (s2_type.equals(&quot;DatagramSocket&quot;)) {
109                 try (DatagramSocket ds =
110                         new DatagramSocket(new InetSocketAddress(ia2, port))) { }
111             }
112 
113         } catch (BindException be) {
114             gotBindException = true;
115             failed_exc = be;
116         } catch (Exception e) {
117             failed = true;
</pre>
<hr />
<pre>
131         }
132         if (ia1 == ia6_this &amp;&amp; ia2 == ia4_this) {
133             expectedBindException = false;
134         }
135 
136         /*
137          * Did it fail?
138          */
139 
140         if (!failed &amp;&amp; gotBindException != expectedBindException) {
141             failed = true;
142         }
143 
144         /*
145          * If test passed and running in silent mode then exit
146          */
147         if (!failed &amp;&amp; silent) {
148             return;
149         }
150 












151         if (failed || !silent) {
152             System.out.println(&quot;&quot;);
153             System.out.println(&quot;**************************&quot;);
154             System.out.println(&quot;Test &quot; + count);
155 
156             System.out.println(s1_type + &quot; binds: &quot; + ia1 + &quot; port: &quot; + port);
157             System.out.println(s2_type + &quot; binds: &quot; + ia2);
158 
159             if (!failed) {
160                 if (gotBindException) {
161                     System.out.println(&quot;Got expected BindException - test passed!&quot;);
162                     failed_exc.printStackTrace(System.out);
163                 } else {
164                     System.out.println(&quot;No BindException as expected - test passed!&quot;);
165                 }
166                 return;
167             }
168         }
169         if (gotBindException) {
170             System.out.println(&quot;BindException unexpected - test failed!!!&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 34 
 35 import java.net.*;
 36 import java.util.Enumeration;
 37 import jdk.test.lib.NetworkConfiguration;
 38 
 39 public class Test {
 40 
 41     static Object[][] getTestCombinations() {
 42         return new Object[][]  {
 43             { &quot;ServerSocket&quot;,   &quot;Socket&quot; },
 44             { &quot;Socket&quot;,         &quot;Socket&quot; },
 45             { &quot;DatagramSocket&quot;, &quot;DatagramSocket&quot; },
 46         };
 47     }
 48 
 49     static InetAddress ia4_this;
 50     static InetAddress ia6_this;
 51 
 52     static int count;
 53     static int failures;
<span class="line-added"> 54     static boolean retried;</span>
 55 
 56     static void doTest(Object test[], InetAddress ia1, InetAddress ia2,
 57                        boolean silent) throws Exception {




 58         /*
 59          * Increment test count
 60          */
 61         count++;
 62 
<span class="line-added"> 63         doTest(test, count, ia1, ia2, silent, !retried);</span>
<span class="line-added"> 64     }</span>
<span class="line-added"> 65 </span>
<span class="line-added"> 66     static void doTest(Object test[], int count, InetAddress ia1, InetAddress ia2,</span>
<span class="line-added"> 67                        boolean silent, boolean retry) throws Exception {</span>
<span class="line-added"> 68         String s1_type = (String)test[0];</span>
<span class="line-added"> 69         String s2_type = (String)test[1];</span>
<span class="line-added"> 70         int port = 0;</span>
<span class="line-added"> 71 </span>
 72         /*
 73          * Do the test
 74          */
 75 
 76         boolean gotBindException = false;
 77         boolean failed = false;
 78         Exception failed_exc = null;
 79 
 80         Socket sock1 = null;
 81         ServerSocket ss = null;
 82         DatagramSocket dsock1 = null;
<span class="line-added"> 83         boolean firstBound = false;</span>
<span class="line-added"> 84 </span>
 85         try {
 86             /* bind the first socket */
 87 
 88             if (s1_type.equals(&quot;Socket&quot;)) {
 89                 sock1 = new Socket();
 90                 sock1.bind( new InetSocketAddress(ia1, 0));
 91                 port = sock1.getLocalPort();
 92             }
 93 
 94             if (s1_type.equals(&quot;ServerSocket&quot;)) {
 95                 ss = new ServerSocket(0, 0, ia1);
 96                 port = ss.getLocalPort();
 97             }
 98 
 99             if (s1_type.equals(&quot;DatagramSocket&quot;)) {
100                 dsock1 = new DatagramSocket( new InetSocketAddress(ia1, 0) );
101                 port = dsock1.getLocalPort();
102             }
103 
104             /* bind the second socket */
105 
<span class="line-added">106             // The fact that the port was available for ia1 does not</span>
<span class="line-added">107             // guarantee that it will also be available for ia2 as something</span>
<span class="line-added">108             // else might already be bound to that port.</span>
<span class="line-added">109             // For the sake of test stability we will retry once in</span>
<span class="line-added">110             // case of unexpected bind exception.</span>
<span class="line-added">111 </span>
<span class="line-added">112             firstBound = true;</span>
113             if (s2_type.equals(&quot;Socket&quot;)) {
114                 try (Socket sock2 = new Socket()) {
115                     sock2.bind( new InetSocketAddress(ia2, port));
116                 }
117             }
118 
119             if (s2_type.equals(&quot;ServerSocket&quot;)) {
120                 try (ServerSocket ss2 = new ServerSocket(port, 0, ia2)) { }
121             }
122 
123             if (s2_type.equals(&quot;DatagramSocket&quot;)) {
124                 try (DatagramSocket ds =
125                         new DatagramSocket(new InetSocketAddress(ia2, port))) { }
126             }
127 
128         } catch (BindException be) {
129             gotBindException = true;
130             failed_exc = be;
131         } catch (Exception e) {
132             failed = true;
</pre>
<hr />
<pre>
146         }
147         if (ia1 == ia6_this &amp;&amp; ia2 == ia4_this) {
148             expectedBindException = false;
149         }
150 
151         /*
152          * Did it fail?
153          */
154 
155         if (!failed &amp;&amp; gotBindException != expectedBindException) {
156             failed = true;
157         }
158 
159         /*
160          * If test passed and running in silent mode then exit
161          */
162         if (!failed &amp;&amp; silent) {
163             return;
164         }
165 
<span class="line-added">166         if (failed &amp;&amp; retry &amp;&amp; firstBound) {</span>
<span class="line-added">167             // retry once at the first failure only</span>
<span class="line-added">168             retried = true;</span>
<span class="line-added">169             if (!silent) {</span>
<span class="line-added">170                 System.out.println(&quot;&quot;);</span>
<span class="line-added">171                 System.out.println(&quot;**************************&quot;);</span>
<span class="line-added">172                 System.out.println(&quot;Test &quot; + count + &quot;: Retrying...&quot;);</span>
<span class="line-added">173             }</span>
<span class="line-added">174             doTest(test, count, ia1, ia2, silent, false);</span>
<span class="line-added">175             return;</span>
<span class="line-added">176         }</span>
<span class="line-added">177 </span>
178         if (failed || !silent) {
179             System.out.println(&quot;&quot;);
180             System.out.println(&quot;**************************&quot;);
181             System.out.println(&quot;Test &quot; + count);
182 
183             System.out.println(s1_type + &quot; binds: &quot; + ia1 + &quot; port: &quot; + port);
184             System.out.println(s2_type + &quot; binds: &quot; + ia2);
185 
186             if (!failed) {
187                 if (gotBindException) {
188                     System.out.println(&quot;Got expected BindException - test passed!&quot;);
189                     failed_exc.printStackTrace(System.out);
190                 } else {
191                     System.out.println(&quot;No BindException as expected - test passed!&quot;);
192                 }
193                 return;
194             }
195         }
196         if (gotBindException) {
197             System.out.println(&quot;BindException unexpected - test failed!!!&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../Authenticator/Deadlock.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../CookieHandler/B6791927.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>