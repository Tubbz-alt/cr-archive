<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/net/BindException/Test.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24  /*
 25  * @test
 26  * @bug 4417734
 27  * @key intermittent
 28  * @summary Test that we get a BindException in all expected combinations
 29  * @library /test/lib
 30  * @build jdk.test.lib.NetworkConfiguration
 31  *        jdk.test.lib.Platform
 32  * @run main Test -d
 33  */
 34 
 35 import java.net.*;
 36 import java.util.Enumeration;
 37 import jdk.test.lib.NetworkConfiguration;
 38 
 39 public class Test {
 40 
 41     static Object[][] getTestCombinations() {
 42         return new Object[][]  {
 43             { &quot;ServerSocket&quot;,   &quot;Socket&quot; },
 44             { &quot;Socket&quot;,         &quot;Socket&quot; },
 45             { &quot;DatagramSocket&quot;, &quot;DatagramSocket&quot; },
 46         };
 47     }
 48 
 49     static InetAddress ia4_this;
 50     static InetAddress ia6_this;
 51 
 52     static int count;
 53     static int failures;
 54 
 55     static void doTest(Object test[], InetAddress ia1, InetAddress ia2,
 56                        boolean silent) throws Exception {
 57         String s1_type = (String)test[0];
 58         String s2_type = (String)test[1];
 59         int port = 0;
 60 
 61         /*
 62          * Increment test count
 63          */
 64         count++;
 65 
 66         /*
 67          * Do the test
 68          */
 69 
 70         boolean gotBindException = false;
 71         boolean failed = false;
 72         Exception failed_exc = null;
 73 
 74         Socket sock1 = null;
 75         ServerSocket ss = null;
 76         DatagramSocket dsock1 = null;
 77         try {
 78             /* bind the first socket */
 79 
 80             if (s1_type.equals(&quot;Socket&quot;)) {
 81                 sock1 = new Socket();
 82                 sock1.bind( new InetSocketAddress(ia1, 0));
 83                 port = sock1.getLocalPort();
 84             }
 85 
 86             if (s1_type.equals(&quot;ServerSocket&quot;)) {
 87                 ss = new ServerSocket(0, 0, ia1);
 88                 port = ss.getLocalPort();
 89             }
 90 
 91             if (s1_type.equals(&quot;DatagramSocket&quot;)) {
 92                 dsock1 = new DatagramSocket( new InetSocketAddress(ia1, 0) );
 93                 port = dsock1.getLocalPort();
 94             }
 95 
 96             /* bind the second socket */
 97 
 98             if (s2_type.equals(&quot;Socket&quot;)) {
 99                 try (Socket sock2 = new Socket()) {
100                     sock2.bind( new InetSocketAddress(ia2, port));
101                 }
102             }
103 
104             if (s2_type.equals(&quot;ServerSocket&quot;)) {
105                 try (ServerSocket ss2 = new ServerSocket(port, 0, ia2)) { }
106             }
107 
108             if (s2_type.equals(&quot;DatagramSocket&quot;)) {
109                 try (DatagramSocket ds =
110                         new DatagramSocket(new InetSocketAddress(ia2, port))) { }
111             }
112 
113         } catch (BindException be) {
114             gotBindException = true;
115             failed_exc = be;
116         } catch (Exception e) {
117             failed = true;
118             failed_exc = e;
119         } finally {
120             if (sock1 != null) sock1.close();
121             if (ss != null) ss.close();
122             if (dsock1 != null) dsock1.close();
123         }
124 
125         /*
126          * Did we expect a BindException?
127          */
128         boolean expectedBindException = true;
129         if (ia1 == ia4_this &amp;&amp; ia2 == ia6_this) {
130             expectedBindException = false;
131         }
132         if (ia1 == ia6_this &amp;&amp; ia2 == ia4_this) {
133             expectedBindException = false;
134         }
135 
136         /*
137          * Did it fail?
138          */
139 
140         if (!failed &amp;&amp; gotBindException != expectedBindException) {
141             failed = true;
142         }
143 
144         /*
145          * If test passed and running in silent mode then exit
146          */
147         if (!failed &amp;&amp; silent) {
148             return;
149         }
150 
151         if (failed || !silent) {
152             System.out.println(&quot;&quot;);
153             System.out.println(&quot;**************************&quot;);
154             System.out.println(&quot;Test &quot; + count);
155 
156             System.out.println(s1_type + &quot; binds: &quot; + ia1 + &quot; port: &quot; + port);
157             System.out.println(s2_type + &quot; binds: &quot; + ia2);
158 
159             if (!failed) {
160                 if (gotBindException) {
161                     System.out.println(&quot;Got expected BindException - test passed!&quot;);
162                     failed_exc.printStackTrace(System.out);
163                 } else {
164                     System.out.println(&quot;No BindException as expected - test passed!&quot;);
165                 }
166                 return;
167             }
168         }
169         if (gotBindException) {
170             System.out.println(&quot;BindException unexpected - test failed!!!&quot;);
171             failed_exc.printStackTrace(System.out);
172         } else {
173             System.out.println(&quot;No bind failure as expected - test failed!!!&quot;);
174         }
175         failures++;
176     }
177 
178     public static void main(String args[]) throws Exception {
179 
180         boolean silent = true;
181         if (args.length &gt; 0) {
182             if (args[0].equals(&quot;-d&quot;)) {
183                 silent = false;
184             }
185         }
186 
187         /*
188          * Test needs an IPv4 and IPv6 address to run.
189          */
190         Enumeration nifs = NetworkInterface.getNetworkInterfaces();
191         while (nifs.hasMoreElements()) {
192             NetworkInterface ni = (NetworkInterface)nifs.nextElement();
193 
194             Enumeration addrs = ni.getInetAddresses();
195             while (addrs.hasMoreElements()) {
196                 InetAddress ia = (InetAddress)addrs.nextElement();
197 
198                 if (ia.isLoopbackAddress() || ia.isAnyLocalAddress()) {
199                     continue;
200                 }
201 
202                 if ((ia instanceof Inet4Address) &amp;&amp; (ia4_this == null)) {
203                     ia4_this = ia;
204                 }
205 
206                 if ((ia instanceof Inet6Address) &amp;&amp; (ia6_this == null)) {
207                     ia6_this = ia;
208                 }
209             }
210         }
211 
212         /*
213          * Perform tests on all combinations of IPv4 and IPv6
214          * addresses.
215          */
216         InetAddress addrs[] = { ia4_this, ia6_this };
217 
218         if (!silent) {
219             System.out.println(&quot;Using ia4_this:&quot; + ia4_this);
220             System.out.println(&quot;Using ia6_this:&quot; + ia6_this);
221         }
222 
223         Object tests[][] = getTestCombinations();
224 
225         for (int i=0; i&lt;tests.length; i++) {
226             Object test[] = tests[i];
227 
228             for (int j=0; j&lt;addrs.length; j++) {
229                 for (int k=0; k&lt;addrs.length; k++) {
230 
231                     if (addrs[j] == null || addrs[k] == null) {
232                         continue;
233                     }
234 
235                     doTest( test, addrs[j], addrs[k], silent);
236                 }
237             }
238         }
239 
240         System.out.println(&quot;&quot;);
241         System.out.println(count + &quot; test(s) executed. &quot; + failures + &quot; failure(s).&quot;);
242 
243         if (failures &gt; 0) {
244             System.err.println(&quot;********************************&quot;);
245             NetworkConfiguration.printSystemConfiguration(System.err);
246             System.out.println(&quot;********************************&quot;);
247             throw new Exception(failures + &quot; tests(s) failed - see log&quot;);
248         }
249     }
250 }
    </pre>
  </body>
</html>