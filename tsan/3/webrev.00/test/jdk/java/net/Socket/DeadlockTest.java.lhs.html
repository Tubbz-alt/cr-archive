<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/Socket/DeadlockTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4176738
<a name="2" id="anc2"></a>
 27  * @summary Make sure a deadlock situation
 28  *     would not occur
 29  * @run main DeadlockTest
 30  * @run main/othervm -Djava.net.preferIPv4Stack=true DeadlockTest
 31  */
 32 
 33 import java.net.*;
 34 import java.io.*;
<a name="3" id="anc3"></a>
 35 
 36 public class DeadlockTest {
 37     public static void main(String [] argv) throws Exception {
<a name="4" id="anc4"></a><span class="line-modified"> 38         ServerSocket ss = new ServerSocket(0);</span>


 39         Socket clientSocket = new Socket();
 40 
 41         try {
 42             // Start the server thread
 43             Thread s1 = new Thread(new ServerThread(ss));
 44             s1.start();
 45 
 46             // Start the client thread
 47             ClientThread ct = new ClientThread(clientSocket, ss.getLocalPort());
 48             Thread c1 = new Thread(ct);
 49             c1.start();
 50 
 51             // Wait for the client thread to finish
 52             c1.join(20000);
 53 
 54             // If timeout, we assume there is a deadlock
 55             if (c1.isAlive() == true) {
 56                 // Close the socket to force the server thread
 57                 // terminate too
 58                 s1.stop();
 59                 throw new Exception(&quot;Takes too long. Dead lock&quot;);
 60             }
 61         } finally {
 62             ss.close();
 63             clientSocket.close();
 64         }
 65     }
 66 }
 67 
 68 class ServerThread implements Runnable {
 69 
 70     private static boolean dbg = false;
 71 
 72     ObjectInputStream  in;
 73     ObjectOutputStream out;
 74 
 75     ServerSocket server;
 76 
 77     Socket sock;
 78 
 79     public ServerThread(ServerSocket serverSocket) throws Exception {
 80         this.server = serverSocket;
 81     }
 82 
 83     public void ping(int cnt) {
 84        Message.write(out, new PingMessage(cnt));
 85     }
 86 
 87     private int cnt = 1;
 88 
 89     public void run() {
 90 
 91         try {
 92             if (Thread.currentThread().getName().startsWith(&quot;child&quot;) == false) {
 93                 sock  = server.accept();
 94 
 95                 new Thread(this, &quot;child&quot;).start();
 96 
 97                 out = new ObjectOutputStream(sock.getOutputStream());
 98                 out.flush();
 99 
100                 if (dbg) System.out.println(&quot;*** ping0 ***&quot;);
101                 ping(0);
102                 if (dbg) System.out.println(&quot;*** ping1 ***&quot;);
103                 ping(1);
104                 if (dbg) System.out.println(&quot;*** ping2 ***&quot;);
105                 ping(2);
106                 if (dbg) System.out.println(&quot;*** ping3 ***&quot;);
107                 ping(3);
108                 if (dbg) System.out.println(&quot;*** ping4 ***&quot;);
109                 ping(4);
110                 if (dbg) System.out.println(&quot;*** end ***&quot;);
111             }
112 
113         } catch (Throwable e) {
114             System.out.println(e);
115             // If anything goes wrong, just quit.
116         }
117 
118         if (Thread.currentThread().getName().startsWith(&quot;child&quot;)) {
119             try {
120 
121                 in  = new ObjectInputStream(sock.getInputStream());
122 
123                 while (true) {
124                     if (dbg) System.out.println(&quot;read &quot; + cnt);
125                     Message msg = (Message) in.readObject();
126                     if (dbg) System.out.println(&quot;read done &quot; + cnt++);
127                     switch (msg.code) {
128                     case Message.PING: {
129                         if (true) System.out.println(&quot;ping recv&#39;ed&quot;);
130                     } break;
131                     }
132 
133                 }
134 
135             } catch (Throwable e) {
136                 // If anything goes wrong, just quit.       }
137             }
138         }
139     }
140 }
141 
142 class ClientThread implements Runnable {
143 
144     ObjectInputStream  in;
145     ObjectOutputStream out;
146 
147     Socket sock;
148 
149     public ClientThread(Socket sock, int serverPort) throws Exception {
150         try {
151             System.out.println(&quot;About to connect the client socket&quot;);
152             this.sock = sock;
<a name="5" id="anc5"></a><span class="line-modified">153             this.sock.connect(new InetSocketAddress(&quot;localhost&quot;, serverPort));</span>
154             System.out.println(&quot;connected&quot;);
155 
156             out = new ObjectOutputStream(sock.getOutputStream());
157             out.flush();
158         } catch (Throwable e) {
159           System.out.println(&quot;client failed with: &quot; + e);
160           e.printStackTrace();
161           throw new Exception(&quot;Unexpected exception&quot;);
162         }
163     }
164 
165     private int cnt = 1;
166 
167     public void run() {
168         try {
169           in  = new ObjectInputStream(sock.getInputStream());
170 
171           int count = 0;
172 
173           while (true) {
174               System.out.println(&quot;read &quot; + cnt);
175               Message msg = (Message) in.readObject();
176               System.out.println(&quot;read done &quot; + cnt++);
177               switch (msg.code) {
178               case Message.PING: {
179                   System.out.println(&quot;ping recv&#39;ed&quot;);
180                   count++;
181               } break;
182               }
183               if (count == 5) {
184                   sock.close();
185                   break;
186               }
187           }
188         }  catch (IOException ioe) {
189         } catch (Throwable e) {
190             // If anything went wrong, just quit
191         }
192     }
193 
194 }
195 
196 class Message implements java.io.Serializable {
197 
198     static final int UNKNOWN = 0;
199     static final int PING = 1;
200 
201     protected int code;
202 
203     public Message() { this.code = UNKNOWN; }
204 
205     public Message(int code) { this.code = code; }
206 
207     private static int cnt = 1;
208 
209     public static void write(ObjectOutput out, Message msg) {
210         try {
211             System.out.println(&quot;write message &quot; + cnt);
212             out.writeObject(msg);
213             System.out.println(&quot;flush message&quot;);
214             out.flush();
215             System.out.println(&quot;write message done &quot; + cnt++);
216         } catch (IOException ioe) {
217             // Ignore the exception
218             System.out.println(ioe);
219         }
220      }
221 }
222 
223 class PingMessage extends Message implements java.io.Serializable {
224 
225       public PingMessage() {
226           code = Message.PING;
227       }
228 
229       public PingMessage(int cnt)
230       {
231           code = Message.PING;
232           this.cnt = cnt;
233 
234           data = new int[50000];
235       }
236 
237       int cnt;
238       int[] data;
239 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>