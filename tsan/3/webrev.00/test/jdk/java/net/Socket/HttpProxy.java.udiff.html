<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/Socket/HttpProxy.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="GetLocalAddress.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="InheritHandle.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/Socket/HttpProxy.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2010, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,15 +21,19 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 6370908</span>
<span class="udiff-line-modified-removed">-  * @summary Add support for HTTP_CONNECT proxy in Socket class</span>
<span class="udiff-line-modified-added">+  * @bug 6370908 8220663</span>
<span class="udiff-line-modified-added">+  * @library /test/lib</span>
<span class="udiff-line-added">+  * @summary Add support for HTTP_CONNECT proxy in Socket class.</span>
<span class="udiff-line-added">+  * This test uses the wildcard address and is susceptible to fail intermittently.</span>
<span class="udiff-line-added">+  * @key intermittent</span>
   * @modules java.base/sun.net.www
   * @run main HttpProxy
   * @run main/othervm -Djava.net.preferIPv4Stack=true HttpProxy
<span class="udiff-line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true HttpProxy</span>
   */
  
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -38,25 +42,32 @@</span>
  import java.net.InetAddress;
  import java.net.InetSocketAddress;
  import java.net.Proxy;
  import java.net.ServerSocket;
  import java.net.Socket;
<span class="udiff-line-added">+ import java.net.SocketAddress;</span>
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ import jdk.test.lib.net.IPSupport;</span>
  import sun.net.www.MessageHeader;
  
  public class HttpProxy {
      final String proxyHost;
      final int proxyPort;
      static final int SO_TIMEOUT = 15000;
  
      public static void main(String[] args) throws Exception {
<span class="udiff-line-added">+         IPSupport.throwSkippedExceptionIfNonOperational();</span>
<span class="udiff-line-added">+ </span>
          String host;
          int port;
<span class="udiff-line-added">+         ConnectProxyTunnelServer proxy = null;</span>
          if (args.length == 0) {
              // Start internal proxy
<span class="udiff-line-modified-removed">-             ConnectProxyTunnelServer proxy = new ConnectProxyTunnelServer();</span>
<span class="udiff-line-modified-added">+             proxy = new ConnectProxyTunnelServer();</span>
              proxy.start();
<span class="udiff-line-modified-removed">-             host = &quot;localhost&quot;;</span>
<span class="udiff-line-modified-added">+             host = InetAddress.getLoopbackAddress().getHostAddress();</span>
              port = proxy.getLocalPort();
              out.println(&quot;Running with internal proxy: &quot; + host + &quot;:&quot; + port);
          } else if (args.length == 2) {
              host = args[0];
              port = Integer.valueOf(args[1]);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -64,53 +75,74 @@</span>
          } else {
              System.err.println(&quot;Usage: java HttpProxy [&lt;proxy host&gt; &lt;proxy port&gt;]&quot;);
              return;
          }
  
<span class="udiff-line-modified-removed">-         HttpProxy p = new HttpProxy(host, port);</span>
<span class="udiff-line-modified-removed">-         p.test();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             HttpProxy p = new HttpProxy(host, port);</span>
<span class="udiff-line-added">+             p.test();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             if (proxy != null)</span>
<span class="udiff-line-added">+                 proxy.close();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public HttpProxy(String proxyHost, int proxyPort) {
          this.proxyHost = proxyHost;
          this.proxyPort = proxyPort;
      }
  
<span class="udiff-line-added">+     static boolean canUseIPv6() {</span>
<span class="udiff-line-added">+         return IPSupport.hasIPv6() &amp;&amp; !IPSupport.preferIPv4Stack();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      void test() throws Exception {
          InetSocketAddress proxyAddress = new InetSocketAddress(proxyHost, proxyPort);
          Proxy httpProxy = new Proxy(Proxy.Type.HTTP, proxyAddress);
  
<span class="udiff-line-modified-removed">-         try (ServerSocket ss = new ServerSocket(0);</span>
<span class="udiff-line-modified-removed">-              Socket sock = new Socket(httpProxy)) {</span>
<span class="udiff-line-modified-removed">-             sock.setSoTimeout(SO_TIMEOUT);</span>
<span class="udiff-line-modified-removed">-             sock.setTcpNoDelay(false);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             InetSocketAddress externalAddress =</span>
<span class="udiff-line-modified-removed">-                 new InetSocketAddress(InetAddress.getLocalHost(), ss.getLocalPort());</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             out.println(&quot;Trying to connect to server socket on &quot; + externalAddress);</span>
<span class="udiff-line-modified-removed">-             sock.connect(externalAddress);</span>
<span class="udiff-line-modified-removed">-             try (Socket externalSock = ss.accept()) {</span>
<span class="udiff-line-modified-removed">-                 // perform some simple checks</span>
<span class="udiff-line-modified-removed">-                 check(sock.isBound(), &quot;Socket is not bound&quot;);</span>
<span class="udiff-line-modified-removed">-                 check(sock.isConnected(), &quot;Socket is not connected&quot;);</span>
<span class="udiff-line-modified-removed">-                 check(!sock.isClosed(), &quot;Socket should not be closed&quot;);</span>
<span class="udiff-line-modified-removed">-                 check(sock.getSoTimeout() == SO_TIMEOUT,</span>
<span class="udiff-line-modified-removed">-                         &quot;Socket should have a previously set timeout&quot;);</span>
<span class="udiff-line-modified-removed">-                 check(sock.getTcpNoDelay() ==  false, &quot;NODELAY should be false&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 simpleDataExchange(sock, externalSock);</span>
<span class="udiff-line-modified-added">+         // Wildcard address is needed here</span>
<span class="udiff-line-modified-added">+         try (ServerSocket ss = new ServerSocket(0)) {</span>
<span class="udiff-line-modified-added">+             List&lt;InetSocketAddress&gt; externalAddresses = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-modified-added">+             externalAddresses.add(</span>
<span class="udiff-line-modified-added">+                 new InetSocketAddress(InetAddress.getLocalHost(), ss.getLocalPort()));</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             if (canUseIPv6()) {</span>
<span class="udiff-line-modified-added">+                 byte[] bytes = new byte[] {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1};</span>
<span class="udiff-line-modified-added">+                 var address = InetAddress.getByAddress(bytes);</span>
<span class="udiff-line-modified-added">+                 externalAddresses.add(</span>
<span class="udiff-line-modified-added">+                         new InetSocketAddress(address, ss.getLocalPort()));</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             for (SocketAddress externalAddress : externalAddresses) {</span>
<span class="udiff-line-modified-added">+                 try (Socket sock = new Socket(httpProxy)) {</span>
<span class="udiff-line-modified-added">+                     sock.setSoTimeout(SO_TIMEOUT);</span>
<span class="udiff-line-modified-added">+                     sock.setTcpNoDelay(false);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+                     out.println(&quot;Trying to connect to server socket on &quot; + externalAddress);</span>
<span class="udiff-line-modified-added">+                     sock.connect(externalAddress);</span>
<span class="udiff-line-added">+                     try (Socket externalSock = ss.accept()) {</span>
<span class="udiff-line-added">+                         // perform some simple checks</span>
<span class="udiff-line-added">+                         check(sock.isBound(), &quot;Socket is not bound&quot;);</span>
<span class="udiff-line-added">+                         check(sock.isConnected(), &quot;Socket is not connected&quot;);</span>
<span class="udiff-line-added">+                         check(!sock.isClosed(), &quot;Socket should not be closed&quot;);</span>
<span class="udiff-line-added">+                         check(sock.getSoTimeout() == SO_TIMEOUT,</span>
<span class="udiff-line-added">+                                 &quot;Socket should have a previously set timeout&quot;);</span>
<span class="udiff-line-added">+                         check(sock.getTcpNoDelay() == false, &quot;NODELAY should be false&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                         simpleDataExchange(sock, externalSock);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              }
          }
      }
  
      static void check(boolean condition, String message) {
          if (!condition) out.println(message);
      }
  
      static Exception unexpected(Exception e) {
<span class="udiff-line-modified-removed">-         out.println(&quot;Unexcepted Exception: &quot; + e);</span>
<span class="udiff-line-modified-added">+         out.println(&quot;Unexpected Exception: &quot; + e);</span>
          e.printStackTrace();
          return e;
      }
  
      // performs a simple exchange of data between the two sockets
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,20 +162,22 @@</span>
      void startSimpleWriter(String threadName, final OutputStream os, final int start) {
          (new Thread(new Runnable() {
              public void run() {
                  try { simpleWrite(os, start); }
                  catch (Exception e) {unexpected(e); }
<span class="udiff-line-added">+                 finally { out.println(threadName + &quot;: done&quot;); }</span>
              }}, threadName)).start();
      }
  
      void simpleWrite(OutputStream os, int start) throws Exception {
          byte b[] = new byte[2];
          for (int i=start; i&lt;start+100; i++) {
              b[0] = (byte) (i / 256);
              b[1] = (byte) (i % 256);
              os.write(b);
          }
<span class="udiff-line-added">+         out.println(&quot;Wrote &quot; + start + &quot; -&gt; &quot; + (start + 100));</span>
      }
  
      void simpleRead(InputStream is, int start) throws Exception {
          byte b[] = new byte [2];
          for (int i=start; i&lt;start+100; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -154,61 +188,77 @@</span>
                  throw new Exception(&quot;read error&quot;);
              int r = bytes(b[0], b[1]);
              if (r != i)
                  throw new Exception(&quot;read &quot; + r + &quot; expected &quot; +i);
          }
<span class="udiff-line-added">+         out.println(&quot;Read &quot; + start + &quot; -&gt; &quot; + (start + 100));</span>
      }
  
      int bytes(byte b1, byte b2) {
          int i1 = (int)b1 &amp; 0xFF;
          int i2 = (int)b2 &amp; 0xFF;
          return i1 * 256 + i2;
      }
  
<span class="udiff-line-modified-removed">-     static class ConnectProxyTunnelServer extends Thread {</span>
<span class="udiff-line-modified-added">+     static class ConnectProxyTunnelServer extends Thread implements AutoCloseable {</span>
  
          private final ServerSocket ss;
<span class="udiff-line-added">+         private volatile boolean closed;</span>
  
          public ConnectProxyTunnelServer() throws IOException {
<span class="udiff-line-modified-removed">-             ss = new ServerSocket(0);</span>
<span class="udiff-line-modified-added">+             ss = new ServerSocket(0, 0, InetAddress.getLoopbackAddress());</span>
          }
  
          @Override
          public void run() {
<span class="udiff-line-modified-removed">-             try (Socket clientSocket = ss.accept()) {</span>
<span class="udiff-line-modified-removed">-                 processRequest(clientSocket);</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 while (!closed) {</span>
<span class="udiff-line-added">+                     try (Socket clientSocket = ss.accept()) {</span>
<span class="udiff-line-added">+                         processRequest(clientSocket);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              } catch (Exception e) {
<span class="udiff-line-modified-removed">-                 out.println(&quot;Proxy Failed: &quot; + e);</span>
<span class="udiff-line-modified-removed">-                 e.printStackTrace();</span>
<span class="udiff-line-modified-added">+                 if (!closed) {</span>
<span class="udiff-line-modified-added">+                     out.println(&quot;Proxy Failed: &quot; + e);</span>
<span class="udiff-line-added">+                     e.printStackTrace();</span>
<span class="udiff-line-added">+                 }</span>
              } finally {
<span class="udiff-line-modified-removed">-                 try { ss.close(); } catch (IOException x) { unexpected(x); }</span>
<span class="udiff-line-modified-added">+                 if (!closed)</span>
<span class="udiff-line-added">+                     try { ss.close(); } catch (IOException x) { unexpected(x); }</span>
              }
          }
  
          /**
           * Returns the port on which the proxy is accepting connections.
           */
          public int getLocalPort() {
              return ss.getLocalPort();
          }
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void close() throws Exception {</span>
<span class="udiff-line-added">+             closed = true;</span>
<span class="udiff-line-added">+             ss.close();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          /*
           * Processes the CONNECT request
           */
          private void processRequest(Socket clientSocket) throws Exception {
              MessageHeader mheader = new MessageHeader(clientSocket.getInputStream());
              String statusLine = mheader.getValue(0);
  
              if (!statusLine.startsWith(&quot;CONNECT&quot;)) {
                  out.println(&quot;proxy server: processes only &quot;
<span class="udiff-line-modified-removed">-                                   + &quot;CONNECT method requests, recieved: &quot;</span>
<span class="udiff-line-modified-added">+                                   + &quot;CONNECT method requests, received: &quot;</span>
                                    + statusLine);
                  return;
              }
  
              // retrieve the host and port info from the status-line
              InetSocketAddress serverAddr = getConnectInfo(statusLine);
<span class="udiff-line-added">+             out.println(&quot;Proxy serving CONNECT request to &quot; + serverAddr);</span>
  
              //open socket to the server
              try (Socket serverSocket = new Socket(serverAddr.getAddress(),
                                                    serverAddr.getPort())) {
                  Forwarder clientFW = new Forwarder(clientSocket.getInputStream(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,16 +294,23 @@</span>
              try {
                  int starti = connectStr.indexOf(&#39; &#39;);
                  int endi = connectStr.lastIndexOf(&#39; &#39;);
                  String connectInfo = connectStr.substring(starti+1, endi).trim();
                  // retrieve server name and port
<span class="udiff-line-modified-removed">-                 endi = connectInfo.indexOf(&#39;:&#39;);</span>
<span class="udiff-line-modified-added">+                 endi = connectInfo.lastIndexOf(&#39;:&#39;);</span>
                  String name = connectInfo.substring(0, endi);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (name.contains(&quot;:&quot;)) {</span>
<span class="udiff-line-added">+                     if (!(name.startsWith(&quot;[&quot;) &amp;&amp; name.endsWith(&quot;]&quot;))) {</span>
<span class="udiff-line-added">+                         throw new IOException(&quot;Invalid host:&quot; + name);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     name = name.substring(1, name.length() - 1);</span>
<span class="udiff-line-added">+                 }</span>
                  int port = Integer.parseInt(connectInfo.substring(endi+1));
                  return new InetSocketAddress(name, port);
              } catch (Exception e) {
<span class="udiff-line-modified-removed">-                 out.println(&quot;Proxy recieved a request: &quot; + connectStr);</span>
<span class="udiff-line-modified-added">+                 out.println(&quot;Proxy received a request: &quot; + connectStr);</span>
                  throw unexpected(e);
              }
          }
      }
  
</pre>
<center><a href="GetLocalAddress.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="InheritHandle.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>