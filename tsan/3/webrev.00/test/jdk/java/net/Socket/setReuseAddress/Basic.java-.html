<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/net/Socket/setReuseAddress/Basic.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4476378
 27  * @summary Check the specific behaviour of the setReuseAddress(boolean)
 28  *          method.
 29  * @run main Basic
 30  * @run main/othervm -Dsun.net.useExclusiveBind Basic
 31  * @run main/othervm -Dsun.net.useExclusiveBind=true Basic
 32  * @run main/othervm -Djava.net.preferIPv4Stack=true Basic
 33  * @run main/othervm -Dsun.net.useExclusiveBind
 34  *                   -Djava.net.preferIPv4Stack=true Basic
 35  * @run main/othervm -Dsun.net.useExclusiveBind=true
 36  *                   -Djava.net.preferIPv4Stack=true Basic
 37  */
 38 import java.net.*;
 39 
 40 public class Basic {
 41 
 42     static int testCount = 0;
 43     static int failures = 0;
 44 
 45     void test(String msg) {
 46         testCount++;
 47         System.out.println(&quot;***************************************&quot;);
 48         System.out.println(&quot;Test &quot; + testCount + &quot;: &quot; + msg);
 49     }
 50 
 51     void passed() {
 52         System.out.println(&quot;Test passed.&quot;);
 53     }
 54 
 55     void failed() {
 56         failures++;
 57         System.out.println(&quot;Test failed.&quot;);
 58     }
 59 
 60     void check(boolean pass) {
 61         if (pass) {
 62             passed();
 63         } else {
 64             failed();
 65         }
 66     }
 67 
 68     void SocketTests() throws Exception {
 69         Socket s1 = new Socket();
 70 
 71         test(&quot;Socket should be created with SO_REUSEADDR disabled&quot;);
 72         check(!s1.getReuseAddress());
 73 
 74         test(&quot;Socket.setReuseAddress(true)&quot;);
 75         s1.setReuseAddress(true);
 76         check(s1.getReuseAddress());
 77 
 78         test(&quot;Socket.setReuseAddress(false)&quot;);
 79         s1.setReuseAddress(false);
 80         check(!s1.getReuseAddress() );
 81 
 82         /* bind to any port */
 83         s1.bind( new InetSocketAddress(0) );
 84 
 85         test(&quot;Binding Socket to port already in use should throw &quot; +
 86              &quot;a BindException&quot;);
 87         Socket s2 = new Socket();
 88         try {
 89             s2.bind( new InetSocketAddress(s1.getLocalPort()) );
 90             failed();
 91         } catch (BindException e) {
 92             passed();
 93         }
 94         s2.close();
 95 
 96         s1.close();
 97     }
 98 
 99     void ServerSocketTests() throws Exception {
100         ServerSocket s1 = new ServerSocket();
101 
102         test(&quot;ServerSocket.setReuseAddress(true)&quot;);
103         s1.setReuseAddress(true);
104         check(s1.getReuseAddress());
105 
106         test(&quot;Socket.setReuseAddress(false)&quot;);
107         s1.setReuseAddress(false);
108         check(!s1.getReuseAddress() );
109 
110         /* bind to any port */
111         s1.bind( new InetSocketAddress(0) );
112 
113         test(&quot;Binding ServerSocket to port already in use should throw &quot; +
114                 &quot;a BindException&quot;);
115         ServerSocket s2 = new ServerSocket();
116         try {
117             s2.bind( new InetSocketAddress(s1.getLocalPort()) );
118             failed();
119         } catch (BindException e) {
120             passed();
121         }
122         s2.close();
123 
124         s1.close();
125     }
126 
127     void DatagramSocketTests() throws Exception {
128         DatagramSocket s1 = new DatagramSocket(null);
129 
130         test(&quot;DatagramSocket should be created with SO_REUSEADDR disabled&quot;);
131         check(!s1.getReuseAddress());
132 
133         test(&quot;DatagramSocket.setReuseAddress(true)&quot;);
134         s1.setReuseAddress(true);
135         check(s1.getReuseAddress());
136 
137         test(&quot;DatagramSocket.setReuseAddress(false)&quot;);
138         s1.setReuseAddress(false);
139         check(!s1.getReuseAddress() );
140 
141         /* bind to any port */
142         s1.bind( new InetSocketAddress(0) );
143 
144         test(&quot;Binding datagram socket to port already in use should throw &quot; +
145              &quot;a BindException&quot;);
146         DatagramSocket s2 = new DatagramSocket(null);
147         try {
148             s2.bind( new InetSocketAddress(s1.getLocalPort()) );
149             failed();
150         } catch (BindException e) {
151             passed();
152         }
153         s2.close();
154         s1.close();
155 
156         // bind with SO_REUSEADDR enabled
157 
158         s1 = new DatagramSocket(null);
159         s1.setReuseAddress(true);
160         s1.bind( new InetSocketAddress(0) );
161 
162         test(&quot;Bind 2 datagram sockets to the same port - second &quot; +
163              &quot;bind doesn&#39;t have SO_REUSEADDR enabled&quot;);
164         s2 = new DatagramSocket(null);
165         try {
166             s2.bind( new InetSocketAddress(s1.getLocalPort()) );
167             failed();
168         } catch (BindException e) {
169             passed();
170         }
171         s2.close();
172 
173         test(&quot;Bind 2 datagram sockets to the same port - both have &quot; +
174              &quot;SO_REUSEADDR enabled&quot;);
175         s2 = new DatagramSocket(null);
176         s2.setReuseAddress(true);
177         try {
178             s2.bind( new InetSocketAddress(s1.getLocalPort()) );
179             passed();
180         } catch (BindException e) {
181             if (System.getProperty(&quot;sun.net.useExclusiveBind&quot;) != null) {
182                 // exclusive bind enabled - expected result
183                 passed();
184             } else {
185                 failed();
186             }
187         }
188         s2.close();
189 
190         s1.close();
191 
192     }
193 
194     void MulticastSocketTests() throws Exception {
195         test(&quot;Check SO_REUSEADDR is enabled in MulticastSocket()&quot;);
196         MulticastSocket s1 = new MulticastSocket();
197         check(s1.getReuseAddress());
198         s1.close();
199 
200         test(&quot;Check that SO_REUSEADDR is not disabled by &quot; +
201              &quot;MulticastSocket.bind()&quot;);
202 
203         s1 = new MulticastSocket(null);
204 
205         // bind to specific address
206         InetSocketAddress isa = new InetSocketAddress(
207                                    InetAddress.getLocalHost(), 0);
208         s1.bind(isa);
209         check(s1.getReuseAddress());
210         s1.close();
211     }
212 
213     Basic() throws Exception {
214 
215         SocketTests();
216         ServerSocketTests();
217         DatagramSocketTests();
218         MulticastSocketTests();
219 
220         System.out.println(&quot;***************************************&quot;);
221         System.out.println(testCount + &quot; test(s) executed, &quot; +
222                            failures + &quot; failure(s).&quot;);
223         if (failures &gt; 0) {
224             throw new Exception(failures + &quot; test(s) failed&quot;);
225         }
226     }
227 
228     public static void main(String args[]) throws Exception {
229         new Basic();
230     }
231 
232 }
    </pre>
  </body>
</html>