<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/Socket/UdpSocket.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @run testng/othervm -Dsun.net.maxDatagramSockets=32 UdpSocket
 27  * @summary Basic test for a Socket to a UDP socket
 28  */
 29 
 30 import java.io.IOException;
 31 import java.lang.ref.WeakReference;
 32 import java.net.InetAddress;
 33 import java.net.InetSocketAddress;
 34 import java.net.Socket;
 35 import java.net.SocketAddress;
 36 import java.nio.ByteBuffer;
 37 import java.nio.channels.DatagramChannel;
 38 import java.security.Permission;
 39 import java.util.Arrays;
 40 import java.util.ArrayList;
 41 import java.util.ArrayDeque;
 42 import java.util.Deque;
 43 
 44 import org.testng.annotations.Test;
 45 import static org.testng.Assert.*;
 46 
 47 @Test
 48 public class UdpSocket {
 49 
 50     /**
 51      * Test using the Socket API to send/receive datagrams
 52      */
 53     public void testSendReceive() throws IOException {
 54         final String MESSAGE = &quot;hello&quot;;
 55 
 56         try (DatagramChannel dc = DatagramChannel.open()) {
 57             var loopback = InetAddress.getLoopbackAddress();
 58             dc.bind(new InetSocketAddress(loopback, 0));
 59 
 60             int port = ((InetSocketAddress) dc.getLocalAddress()).getPort();
 61             try (Socket s = new Socket(loopback, port, false)) {
 62 
 63                 // send datagram with socket output stream
 64                 byte[] array1 = MESSAGE.getBytes(&quot;UTF-8&quot;);
 65                 s.getOutputStream().write(array1);
 66 
 67                 // receive the datagram
 68                 var buf = ByteBuffer.allocate(100);
 69                 SocketAddress remote = dc.receive(buf);
 70                 buf.flip();
 71                 assertTrue(buf.remaining() == MESSAGE.length(), &quot;Unexpected size&quot;);
 72 
 73                 // echo the datagram
 74                 dc.send(buf, remote);
 75 
 76                 // receive datagram with the socket input stream
 77                 byte[] array2 = new byte[100];
 78                 int n = s.getInputStream().read(array2);
 79                 assertTrue(n == MESSAGE.length(), &quot;Unexpected size&quot;);
 80                 assertEquals(Arrays.copyOf(array1, n), Arrays.copyOf(array2, n),
 81                             &quot;Unexpected contents&quot;);
 82             }
 83         }
 84     }
 85 
 86     /**
 87      * Test that the number of UDP sockets is limited when running with a
 88      * security manager.
 89      */
 90     public void testMaxSockets() throws Exception {
 91         int limit = Integer.getInteger(&quot;sun.net.maxDatagramSockets&quot;);
 92 
 93         // security manager grants all permissions
 94         var securityManager = new SecurityManager() {
 95             @Override public void checkPermission(Permission perm) { }
 96         };
 97 
 98         System.setSecurityManager(securityManager);
 99         Deque&lt;Socket&gt; sockets = new ArrayDeque&lt;&gt;();
100         try {
101             // create the maximum number of sockets
102             for (int i=0; i&lt;limit; i++) {
103                 sockets.offer(newUdpSocket());
104             }
105 
106             // try to create another socket - should fail
107             try {
108                 Socket s = newUdpSocket();
109                 s.close();
110                 assertTrue(false);
111             } catch (IOException expected) { }
112 
113             // close one socket
114             sockets.pop().close();
115 
116             // try to create another socket - should succeed
117             Socket s = newUdpSocket();
118 
119             // unreference the socket and wait for it to be closed by the cleaner
120             var ref = new WeakReference&lt;&gt;(s);
121             s = null;
122             while (ref.get() != null) {
123                 System.gc();
124                 Thread.sleep(100);
125             }
126 
127             // try to create another socket - should succeed
128             s = newUdpSocket();
129             s.close();
130         } finally {
131             closeAll(sockets);
132             System.setSecurityManager(null);
133         }
134     }
135 
136     private Socket newUdpSocket() throws IOException {
137         return new Socket(InetAddress.getLoopbackAddress(), 8000, false);
138     }
139 
140     private void closeAll(Deque&lt;Socket&gt; sockets) throws IOException {
141         Socket s;
142         while ((s = sockets.poll()) != null) {
143             s.close();
144         }
145     }
146 }
    </pre>
  </body>
</html>