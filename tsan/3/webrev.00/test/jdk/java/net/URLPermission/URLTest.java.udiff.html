<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/URLPermission/URLTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="OpenURL.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="nstest/LookupTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLPermission/URLTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,11 @@</span>
   * @bug 8010464
   * @modules jdk.httpserver
   * @library /test/lib
   * @build jdk.test.lib.net.SimpleSSLContext
   * @run main/othervm URLTest
<span class="udiff-line-added">+  * @run main/othervm -Djava.net.preferIPv6Addresses=true URLTest</span>
   * @summary check URLPermission with Http(s)URLConnection
   */
  
  import java.net.*;
  import java.io.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,18 +76,18 @@</span>
          boolean expectException = false;
          SecurityManager sm = System.getSecurityManager();
          if (sm != null) {
              expectException = true;
              Policy.setPolicy(new CustomPolicy(
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;http://127.0.0.1:&quot;+httpPort+&quot;/foo.html&quot;, &quot;GET:X-Foo,Z-Bar&quot;),</span>
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;https://127.0.0.1:&quot;+httpsPort+&quot;/foo.html&quot;, &quot;POST:X-Fob,T-Bar&quot;)));</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;http://&quot; + httpAuth + &quot;/foo.html&quot;, &quot;GET:X-Foo,Z-Bar&quot;),</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;https://&quot; + httpsAuth + &quot;/foo.html&quot;, &quot;POST:X-Fob,T-Bar&quot;)));</span>
          }
  
<span class="udiff-line-modified-removed">-         String url1 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url2 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url3 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url4 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url1 = &quot;http://&quot; + httpAuth + &quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url2 = &quot;https://&quot; + httpsAuth + &quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url3 = &quot;http://&quot; + httpAuth + &quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url4 = &quot;https://&quot; + httpsAuth + &quot;/bar.html&quot;;</span>
  
          // simple positive test. Should succeed
          test(url1, &quot;GET&quot;, &quot;X-Foo&quot;);
          test(url1, &quot;GET&quot;, &quot;Z-Bar&quot;, &quot;X-Foo&quot;);
          test(url1, &quot;GET&quot;, &quot;X-Foo&quot;, &quot;Z-Bar&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,18 +107,18 @@</span>
          System.out.println(&quot;\n--- Test 2 ---&quot;);
  
          SecurityManager sm = System.getSecurityManager();
          if (sm != null) {
              Policy.setPolicy(new CustomPolicy(
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;http://127.0.0.1:&quot;+httpPort+&quot;/*&quot;, &quot;GET:X-Foo&quot;),</span>
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;https://127.0.0.1:&quot;+httpsPort+&quot;/*&quot;, &quot;POST:X-Fob&quot;)));</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;http://&quot; + httpAuth + &quot;/*&quot;, &quot;GET:X-Foo&quot;),</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;https://&quot; + httpsAuth + &quot;/*&quot;, &quot;POST:X-Fob&quot;)));</span>
          }
  
<span class="udiff-line-modified-removed">-         String url1 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url2 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url3 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url4 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url1 = &quot;http://&quot; + httpAuth + &quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url2 = &quot;https://&quot; + httpsAuth + &quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url3 = &quot;http://&quot; + httpAuth + &quot;/bar.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url4 = &quot;https://&quot; + httpsAuth + &quot;/bar.html&quot;;</span>
  
          // simple positive test. Should succeed
          test(url1, &quot;GET&quot;, &quot;X-Foo&quot;);
          test(url2, &quot;POST&quot;, &quot;X-Fob&quot;);
          test(url3, &quot;GET&quot;, &quot;X-Foo&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,25 +131,35 @@</span>
          boolean expectException = false;
          SecurityManager sm = System.getSecurityManager();
          if (sm != null) {
              expectException = true;
              Policy.setPolicy(new CustomPolicy(
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;http://127.0.0.1:&quot;+httpPort+&quot;/a/b/-&quot;, &quot;DELETE,GET:X-Foo,Y-Foo&quot;),</span>
<span class="udiff-line-modified-removed">-                 new URLPermission(&quot;https://127.0.0.1:&quot;+httpsPort+&quot;/a/c/-&quot;, &quot;POST:*&quot;)));</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;http://&quot; + httpAuth + &quot;/a/b/-&quot;, &quot;DELETE,GET:X-Foo,Y-Foo&quot;),</span>
<span class="udiff-line-modified-added">+                 new URLPermission(&quot;https://&quot; + httpsAuth + &quot;/a/c/-&quot;, &quot;POST:*&quot;)));</span>
          }
  
<span class="udiff-line-modified-removed">-         String url1 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url2 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/a/c/d/e/foo.html&quot;;</span>
<span class="udiff-line-modified-removed">-         String url3 = &quot;http://127.0.0.1:&quot;+httpPort+&quot;/a/b/c&quot;;</span>
<span class="udiff-line-modified-removed">-         String url4 = &quot;https://127.0.0.1:&quot;+httpsPort+&quot;/a/b/c&quot;;</span>
<span class="udiff-line-modified-added">+         String url1 = &quot;http://&quot; + httpAuth + &quot;/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url2 = &quot;https://&quot; + httpsAuth + &quot;/a/c/d/e/foo.html&quot;;</span>
<span class="udiff-line-modified-added">+         String url3 = &quot;http://&quot; + httpAuth + &quot;/a/b/c&quot;;</span>
<span class="udiff-line-modified-added">+         String url4 = &quot;https://&quot; + httpsAuth + &quot;/a/b/c&quot;;</span>
  
          test(url1, &quot;GET&quot;, &quot;X-Foo&quot;, expectException);
          test(url2, &quot;POST&quot;, &quot;X-Zxc&quot;);
          test(url3, &quot;DELETE&quot;, &quot;Y-Foo&quot;);
          test(url4, &quot;POST&quot;, &quot;Y-Foo&quot;, expectException);
      }
  
<span class="udiff-line-added">+     static String authority(InetSocketAddress address) {</span>
<span class="udiff-line-added">+         String hostaddr = address.getAddress().getHostAddress();</span>
<span class="udiff-line-added">+         int port = address.getPort();</span>
<span class="udiff-line-added">+         if (hostaddr.indexOf(&#39;:&#39;) &gt; -1) {</span>
<span class="udiff-line-added">+             return &quot;[&quot; + hostaddr + &quot;]:&quot; + port;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return hostaddr + &quot;:&quot; + port;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // Convenience methods to simplify previous explicit test scenarios.
      static void test(String u, String method, String header) throws IOException {
          test(u, method, header, null, false);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,11 +184,11 @@</span>
      {
          URL url = new URL(u);
          System.out.println(&quot;url=&quot; + u + &quot; method=&quot; + method +
                             &quot; header1=&quot; + header1 + &quot; header2=&quot; + header2 +
                             &quot; expectException=&quot; + expectException);
<span class="udiff-line-modified-removed">-         HttpURLConnection urlc = (HttpURLConnection)url.openConnection();</span>
<span class="udiff-line-modified-added">+         HttpURLConnection urlc = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
          if (urlc instanceof HttpsURLConnection) {
              HttpsURLConnection ssl = (HttpsURLConnection)urlc;
              ssl.setHostnameVerifier((host, sess) -&gt; true);
              ssl.setSSLSocketFactory(ctx.getSocketFactory());
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,15 +229,18 @@</span>
      static HttpContext c, cs;
      static ExecutorService e, es;
      static SSLContext ctx;
      static int httpPort;
      static int httpsPort;
<span class="udiff-line-added">+     static String httpAuth;</span>
<span class="udiff-line-added">+     static String httpsAuth;</span>
  
      static void createServers() throws Exception {
<span class="udiff-line-modified-removed">-         InetSocketAddress any = new InetSocketAddress(0);</span>
<span class="udiff-line-modified-removed">-         httpServer = HttpServer.create(any, 0);</span>
<span class="udiff-line-modified-removed">-         httpsServer = HttpsServer.create(any, 0);</span>
<span class="udiff-line-modified-added">+         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-modified-added">+         InetSocketAddress address = new InetSocketAddress(loopback, 0);</span>
<span class="udiff-line-modified-added">+         httpServer = HttpServer.create(address, 0);</span>
<span class="udiff-line-added">+         httpsServer = HttpsServer.create(address, 0);</span>
  
          OkHandler h = new OkHandler();
  
          c = httpServer.createContext(&quot;/&quot;, h);
          cs = httpsServer.createContext(&quot;/&quot;, h);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -241,10 +255,12 @@</span>
          httpServer.start();
          httpsServer.start();
  
          httpPort = httpServer.getAddress().getPort();
          httpsPort = httpsServer.getAddress().getPort();
<span class="udiff-line-added">+         httpAuth = authority(httpServer.getAddress());</span>
<span class="udiff-line-added">+         httpsAuth = authority(httpsServer.getAddress());</span>
      }
  
      static void shutdown() {
          httpServer.stop(1);
          httpsServer.stop(1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,16 +274,20 @@</span>
              x.close();
          }
      }
  
      static class CustomPolicy extends Policy {
<span class="udiff-line-added">+         static final Policy DEFAULT_POLICY = Policy.getPolicy();</span>
          final PermissionCollection perms = new Permissions();
<span class="udiff-line-added">+ </span>
          CustomPolicy(Permission... permissions) {
              java.util.Arrays.stream(permissions).forEach(perms::add);
  
              // needed for the HTTP(S) server
<span class="udiff-line-modified-removed">-             perms.add(new SocketPermission(&quot;localhost:1024-&quot;, &quot;listen,resolve,accept&quot;));</span>
<span class="udiff-line-modified-added">+             InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-added">+             InetSocketAddress serverBound = new InetSocketAddress(loopback,1024);</span>
<span class="udiff-line-added">+             perms.add(new SocketPermission(authority(serverBound) + &quot;-&quot;, &quot;listen,resolve,accept&quot;));</span>
              // needed by the test to reset the policy, per testX method
              perms.add(new SecurityPermission(&quot;setPolicy&quot;));
              // needed to shutdown the ThreadPoolExecutor ( used by the servers )
              perms.add(new RuntimePermission(&quot;modifyThread&quot;));
              // needed by the client code forHttpsURLConnection.setSSLSocketFactory
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -281,9 +301,9 @@</span>
          public PermissionCollection getPermissions(CodeSource codesource) {
              return perms;
          }
  
          public boolean implies(ProtectionDomain domain, Permission perm) {
<span class="udiff-line-modified-removed">-             return perms.implies(perm);</span>
<span class="udiff-line-modified-added">+             return perms.implies(perm) || DEFAULT_POLICY.implies(domain, perm);</span>
          }
      }
  }
</pre>
<center><a href="OpenURL.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="nstest/LookupTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>