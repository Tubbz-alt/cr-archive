<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/net/CookieHandler/CookieManagerTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Unit test for java.net.CookieManager
 27  * @bug 6244040 7150552 7051862
 28  * @modules jdk.httpserver
 29  * @run main/othervm -ea CookieManagerTest
 30  * @author Edward Wang
 31  */
 32 
 33 import com.sun.net.httpserver.*;
 34 import java.util.Collections;
 35 import java.util.LinkedList;
 36 import java.util.List;
 37 import java.io.IOException;
 38 import java.net.*;
 39 import static java.net.Proxy.NO_PROXY;
 40 
 41 public class CookieManagerTest {
 42 
 43     static CookieTransactionHandler httpTrans;
 44     static HttpServer server;
 45 
 46     static final String hostAddress = getAddr();
 47 
 48     /** Returns an IP literal suitable for use by the test. */
 49     static String getAddr() {
 50         try {
 51             InetAddress lh = InetAddress.getLocalHost();
 52             System.out.println(&quot;Trying: &quot; + lh);
 53             if (lh.isReachable(5_000)) {
 54                 System.out.println(&quot;Using: &quot; + lh);
 55                 return lh.getHostAddress();
 56             }
 57         } catch (IOException x) {
 58             System.out.println(&quot;Debug: caught:&quot; + x);
 59         }
 60         System.out.println(&quot;Using: \&quot;127.0.0.1\&quot;&quot;);
 61         return &quot;127.0.0.1&quot;;
 62     }
 63 
 64     public static void main(String[] args) throws Exception {
 65         startHttpServer();
 66         makeHttpCall();
 67 
 68         if (httpTrans.badRequest) {
 69             throw new RuntimeException(&quot;Test failed : bad cookie header&quot;);
 70         }
 71         checkCookiePolicy();
 72     }
 73 
 74    public static void startHttpServer() throws IOException {
 75         httpTrans = new CookieTransactionHandler();
 76         server = HttpServer.create(new InetSocketAddress(0), 0);
 77         server.createContext(&quot;/&quot;, httpTrans);
 78         server.start();
 79     }
 80 
 81     /*
 82      * Checks if CookiePolicy.ACCEPT_ORIGINAL_SERVER#shouldAccept()
 83      * returns false for null arguments
 84      */
 85     private static void checkCookiePolicy() throws Exception {
 86         CookiePolicy cp = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
 87         boolean retVal;
 88         retVal = cp.shouldAccept(null, null);
 89         checkValue(retVal);
 90         retVal = cp.shouldAccept(null, new HttpCookie(&quot;CookieName&quot;, &quot;CookieVal&quot;));
 91         checkValue(retVal);
 92         retVal = cp.shouldAccept((new URL(&quot;http&quot;, &quot;localhost&quot;, 2345, &quot;/&quot;)).toURI(),
 93                                   null);
 94         checkValue(retVal);
 95     }
 96 
 97     private static void checkValue(boolean val) {
 98         if (val)
 99             throw new RuntimeException(&quot;Return value is not false!&quot;);
100     }
101 
102     public static void makeHttpCall() throws IOException {
103         try {
104             int port = server.getAddress().getPort();
105             System.out.println(&quot;http server listenining on: &quot; + port);
106 
107             // install CookieManager to use
108             CookieHandler.setDefault(new CookieManager());
109 
110             for (int i = 0; i &lt; CookieTransactionHandler.testCount; i++) {
111                 System.out.println(&quot;====== CookieManager test &quot; + (i+1)
112                                     + &quot; ======&quot;);
113                 ((CookieManager)CookieHandler.getDefault())
114                     .setCookiePolicy(CookieTransactionHandler.testPolicies[i]);
115                 ((CookieManager)CookieHandler.getDefault())
116                     .getCookieStore().removeAll();
117                 URL url = new URL(&quot;http&quot; ,
118                                   hostAddress,
119                                   server.getAddress().getPort(),
120                                   CookieTransactionHandler.testCases[i][0]
121                                                           .serverPath);
122                 System.out.println(&quot;Requesting &quot; + url);
123                 HttpURLConnection uc = (HttpURLConnection)url.openConnection(NO_PROXY);
124                 uc.getResponseCode();
125                 uc.disconnect();
126             }
127         } finally {
128             server.stop(0);
129         }
130     }
131 }
132 
133 class CookieTransactionHandler implements HttpHandler {
134 
135     private int testcaseDone = 0;
136     private int testDone = 0;
137 
138     public static boolean badRequest = false;
139     // the main test control logic will also loop exactly this number
140     // to send http request
141     public static final int testCount = 6;
142 
143     @Override
144     public void handle(HttpExchange exchange) throws IOException {
145         if (testDone &lt; testCases[testcaseDone].length) {
146             // still have other tests to run,
147             // check the Cookie header and then redirect it
148             if (testDone &gt; 0) checkRequest(exchange.getRequestHeaders());
149             exchange.getResponseHeaders().add(&quot;Location&quot;,
150                     testCases[testcaseDone][testDone].serverPath);
151             exchange.getResponseHeaders()
152                     .add(testCases[testcaseDone][testDone].headerToken,
153                          testCases[testcaseDone][testDone].cookieToSend);
154             exchange.sendResponseHeaders(302, -1);
155             testDone++;
156         } else {
157             // the last test of this test case
158             if (testDone &gt; 0) checkRequest(exchange.getRequestHeaders());
159             testcaseDone++;
160             testDone = 0;
161             exchange.sendResponseHeaders(200, -1);
162         }
163         exchange.close();
164     }
165 
166     private static String trim(String s) {
167         StringBuilder sb = new StringBuilder();
168         for (int i=0; i&lt;s.length(); i++) {
169             char c = s.charAt(i);
170             if (!Character.isWhitespace(c))
171                 sb.append(c);
172         }
173         return sb.toString();
174     }
175 
176     private static boolean cookieEquals(String s1, String s2) {
177         s1 = trim(s1);
178         s2 = trim(s2);
179         String[] s1a = s1.split(&quot;;&quot;);
180         String[] s2a = s2.split(&quot;;&quot;);
181         List&lt;String&gt; l1 = new LinkedList(List.of(s1a));
182         List&lt;String&gt; l2 = new LinkedList(List.of(s2a));
183         Collections.sort(l1);
184         Collections.sort(l2);
185         int i = 0;
186         for (String s : l1) {
187             if (!s.equals(l2.get(i++))) {
188                 return false;
189             }
190         }
191         return true;
192     }
193 
194     private void checkRequest(Headers hdrs) {
195 
196         assert testDone &gt; 0;
197         String cookieHeader = hdrs.getFirst(&quot;Cookie&quot;);
198         if (cookieHeader != null &amp;&amp; cookieEquals(
199                 cookieHeader, testCases[testcaseDone][testDone-1].cookieToRecv))
200         {
201             System.out.printf(&quot;%15s %s\n&quot;, &quot;PASSED:&quot;, cookieHeader);
202         } else {
203             System.out.printf(&quot;%15s %s\n&quot;, &quot;FAILED:&quot;, cookieHeader);
204             System.out.printf(&quot;%15s %s\n\n&quot;, &quot;should be:&quot;,
205                     testCases[testcaseDone][testDone-1].cookieToRecv);
206             badRequest = true;
207         }
208     }
209 
210     // test cases
211     public static class CookieTestCase {
212         public String headerToken;
213         public String cookieToSend;
214         public String cookieToRecv;
215         public String serverPath;
216 
217         public CookieTestCase(String h, String cts, String ctr, String sp) {
218             headerToken = h;
219             cookieToSend = cts;
220             cookieToRecv = ctr;
221             serverPath = sp;
222         }
223     };
224 
225     /*
226      * these two must match each other,
227      * i.e. testCases.length == testPolicies.length
228      */
229 
230     // the test cases to run; each test case may contain multiple roundtrips
231     public static CookieTestCase[][] testCases = null;
232     // indicates what CookiePolicy to use with each test cases
233     public static CookiePolicy[] testPolicies = null;
234 
235     CookieTransactionHandler() {
236         testCases = new CookieTestCase[testCount][];
237         testPolicies = new CookiePolicy[testCount];
238 
239         String localHostAddr = CookieManagerTest.hostAddress;
240 
241         int count = 0;
242 
243         // an http session with Netscape cookies exchanged
244         testPolicies[count] = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
245         testCases[count++] = new CookieTestCase[]{
246                 new CookieTestCase(&quot;Set-Cookie&quot;,
247                 &quot;CUSTOMER=WILE:BOB; &quot; +
248                 &quot;path=/; expires=Sat, 09-Nov-2030 23:12:40 GMT;&quot; + &quot;domain=.&quot; +
249                 localHostAddr,
250                 &quot;CUSTOMER=WILE:BOB&quot;,
251                 &quot;/&quot;
252                 ),
253                 new CookieTestCase(&quot;Set-Cookie&quot;,
254                 &quot;PART_NUMBER=ROCKET_LAUNCHER_0001; path=/;&quot; + &quot;domain=.&quot; + localHostAddr,
255                 &quot;CUSTOMER=WILE:BOB; PART_NUMBER=ROCKET_LAUNCHER_0001&quot;,
256                 &quot;/&quot;
257                 ),
258                 new CookieTestCase(&quot;Set-Cookie&quot;,
259                 &quot;SHIPPING=FEDEX; path=/foo;&quot; + &quot;domain=.&quot; + localHostAddr,
260                 &quot;CUSTOMER=WILE:BOB; PART_NUMBER=ROCKET_LAUNCHER_0001&quot;,
261                 &quot;/&quot;
262                 ),
263                 new CookieTestCase(&quot;Set-Cookie&quot;,
264                 &quot;SHIPPING=FEDEX; path=/foo;&quot; + &quot;domain=.&quot; + localHostAddr,
265                 &quot;CUSTOMER=WILE:BOB; PART_NUMBER=ROCKET_LAUNCHER_0001; SHIPPING=FEDEX&quot;,
266                 &quot;/foo&quot;
267                 )
268                 };
269 
270         // check whether or not path rule is applied
271         testPolicies[count] = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
272         testCases[count++] = new CookieTestCase[]{
273                 new CookieTestCase(&quot;Set-Cookie&quot;,
274                 &quot;PART_NUMBER=ROCKET_LAUNCHER_0001; path=/;&quot; + &quot;domain=.&quot; + localHostAddr,
275                 &quot;PART_NUMBER=ROCKET_LAUNCHER_0001&quot;,
276                 &quot;/&quot;
277                 ),
278                 new CookieTestCase(&quot;Set-Cookie&quot;,
279                 &quot;PART_NUMBER=RIDING_ROCKET_0023; path=/ammo;&quot; + &quot;domain=.&quot; + localHostAddr,
280                 &quot;PART_NUMBER=RIDING_ROCKET_0023; PART_NUMBER=ROCKET_LAUNCHER_0001&quot;,
281                 &quot;/ammo&quot;
282                 )
283                 };
284 
285         // an http session with rfc2965 cookies exchanged
286         testPolicies[count] = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
287         testCases[count++] = new CookieTestCase[]{
288                 new CookieTestCase(&quot;Set-Cookie2&quot;,
289                 &quot;Customer=\&quot;WILE_E_COYOTE\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
290                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
291                 &quot;/acme/login&quot;
292                 ),
293                 new CookieTestCase(&quot;Set-Cookie2&quot;,
294                 &quot;Part_Number=\&quot;Rocket_Launcher_0001\&quot;; Version=\&quot;1\&quot;;Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
295                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;&quot; + &quot;$Domain=\&quot;.&quot; +
296                     localHostAddr  + &quot;\&quot;&quot; + &quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;&quot;
297                     + &quot;$Domain=\&quot;.&quot; + localHostAddr +  &quot;\&quot;&quot;,
298                 &quot;/acme/pickitem&quot;
299                 ),
300                 new CookieTestCase(&quot;Set-Cookie2&quot;,
301                 &quot;Shipping=\&quot;FedEx\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
302                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;&quot; + &quot;$Domain=\&quot;.&quot; + localHostAddr  +
303                     &quot;\&quot;&quot; + &quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;&quot; + &quot;$Domain=\&quot;.&quot;
304                     + localHostAddr  + &quot;\&quot;&quot; + &quot;; Shipping=\&quot;FedEx\&quot;;$Path=\&quot;/acme\&quot;;&quot; +
305                     &quot;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
306                 &quot;/acme/shipping&quot;
307                 )
308                 };
309 
310         // check whether or not the path rule is applied
311         testPolicies[count] = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
312         testCases[count++] = new CookieTestCase[]{
313                 new CookieTestCase(&quot;Set-Cookie2&quot;,
314                 &quot;Part_Number=\&quot;Rocket_Launcher_0001\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
315                 &quot;$Version=\&quot;1\&quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
316                 &quot;/acme/ammo&quot;
317                 ),
318                 new CookieTestCase(&quot;Set-Cookie2&quot;,
319                 &quot;Part_Number=\&quot;Riding_Rocket_0023\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme/ammo\&quot;;&quot; + &quot;domain=.&quot;
320                     + localHostAddr,
321                 &quot;$Version=\&quot;1\&quot;; Part_Number=\&quot;Riding_Rocket_0023\&quot;;$Path=\&quot;/acme/ammo\&quot;;$Domain=\&quot;.&quot;
322                     + localHostAddr  + &quot;\&quot;&quot; + &quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;&quot;
323                     + &quot;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
324                 &quot;/acme/ammo&quot;
325                 ),
326                 new CookieTestCase(&quot;&quot;,
327                 &quot;&quot;,
328                 &quot;$Version=\&quot;1\&quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;&quot; + &quot;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
329                 &quot;/acme/parts&quot;
330                 )
331                 };
332 
333         // new cookie should overwrite old cookie
334         testPolicies[count] = CookiePolicy.ACCEPT_ORIGINAL_SERVER;
335         testCases[count++] = new CookieTestCase[]{
336                 new CookieTestCase(&quot;Set-Cookie2&quot;,
337                 &quot;Part_Number=\&quot;Rocket_Launcher_0001\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
338                 &quot;$Version=\&quot;1\&quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
339                 &quot;/acme&quot;
340                 ),
341                 new CookieTestCase(&quot;Set-Cookie2&quot;,
342                 &quot;Part_Number=\&quot;Rocket_Launcher_2000\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;;&quot; + &quot;domain=.&quot; + localHostAddr,
343                 &quot;$Version=\&quot;1\&quot;; Part_Number=\&quot;Rocket_Launcher_2000\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;.&quot; + localHostAddr + &quot;\&quot;&quot;,
344                 &quot;/acme&quot;
345                 )
346                 };
347 
348         // cookies without domain attributes
349         // RFC 2965 states that domain should default to host
350         testPolicies[count] = CookiePolicy.ACCEPT_ALL;
351         testCases[count++] = new CookieTestCase[]{
352                 new CookieTestCase(&quot;Set-Cookie2&quot;,
353                 &quot;Customer=\&quot;WILE_E_COYOTE\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;&quot;,
354                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot;,
355                 &quot;/acme/login&quot;
356                 ),
357                 new CookieTestCase(&quot;Set-Cookie2&quot;,
358                 &quot;Part_Number=\&quot;Rocket_Launcher_0001\&quot;; Version=\&quot;1\&quot;;Path=\&quot;/acme\&quot;&quot;,
359                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot; +
360                     &quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot;,
361                 &quot;/acme/pickitem&quot;
362                 ),
363                 new CookieTestCase(&quot;Set-Cookie2&quot;,
364                 &quot;Shipping=\&quot;FedEx\&quot;; Version=\&quot;1\&quot;; Path=\&quot;/acme\&quot;&quot;,
365                 &quot;$Version=\&quot;1\&quot;; Customer=\&quot;WILE_E_COYOTE\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot; +
366                     &quot;; Part_Number=\&quot;Rocket_Launcher_0001\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot; +
367                     &quot;; Shipping=\&quot;FedEx\&quot;;$Path=\&quot;/acme\&quot;;$Domain=\&quot;&quot;+localHostAddr+&quot;\&quot;&quot;,
368                 &quot;/acme/shipping&quot;
369                 )
370                 };
371 
372         assert count == testCount;
373     }
374 }
    </pre>
  </body>
</html>