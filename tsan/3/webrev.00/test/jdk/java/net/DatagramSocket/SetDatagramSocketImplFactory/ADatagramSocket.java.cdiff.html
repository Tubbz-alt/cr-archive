<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/DatagramSocket/SetDatagramSocketImplFactory/ADatagramSocket.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../SendSize.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../SetReceiveBufferSize.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/DatagramSocket/SetDatagramSocketImplFactory/ADatagramSocket.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1999, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,13 ***</span>
   * @run main ADatagramSocket
   */
  import java.io.*;
  import java.net.*;
  import java.util.*;
  
  public class ADatagramSocket {
<span class="line-modified">!     public static void main(String[] args) throws IOException {</span>
          // testing out setDatagramSocketImplFactory
          System.err.println(&quot;setting DatagramSocketImplFactory...&quot;);
          try {
            DatagramSocket.setDatagramSocketImplFactory(new java.net.MyDatagramSocketImplFactory());
          } catch (Exception ex) {
<span class="line-new-header">--- 29,14 ---</span>
   * @run main ADatagramSocket
   */
  import java.io.*;
  import java.net.*;
  import java.util.*;
<span class="line-added">+ import java.util.concurrent.CountDownLatch;</span>
  
  public class ADatagramSocket {
<span class="line-modified">!     public static void main(String[] args) throws Exception {</span>
          // testing out setDatagramSocketImplFactory
          System.err.println(&quot;setting DatagramSocketImplFactory...&quot;);
          try {
            DatagramSocket.setDatagramSocketImplFactory(new java.net.MyDatagramSocketImplFactory());
          } catch (Exception ex) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,10 ***</span>
<span class="line-new-header">--- 45,12 ---</span>
  
          QuoteServerThread server = new QuoteServerThread();
          int port = server.getPort();
          System.out.println(&quot;Server port is &quot; + port);
          server.start();
<span class="line-added">+         // Wait server thread to reach receive call</span>
<span class="line-added">+         server.readyToStart.await();</span>
  
          // get a datagram socket
          DatagramSocket socket = new DatagramSocket();
  
          // send request
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,18 ***</span>
  
  class QuoteServerThread extends Thread {
  
      protected DatagramSocket socket = null;
      private final int port;
  
      public QuoteServerThread() throws IOException {
          this(&quot;QuoteServerThread&quot;);
      }
  
      public QuoteServerThread(String name) throws IOException {
          super(name);
<span class="line-modified">!         socket = new DatagramSocket(0);</span>
          port =  socket.getLocalPort();
      }
      public int getPort(){
          return port;
      }
<span class="line-new-header">--- 73,19 ---</span>
  
  class QuoteServerThread extends Thread {
  
      protected DatagramSocket socket = null;
      private final int port;
<span class="line-added">+     final CountDownLatch readyToStart = new CountDownLatch(1);</span>
  
      public QuoteServerThread() throws IOException {
          this(&quot;QuoteServerThread&quot;);
      }
  
      public QuoteServerThread(String name) throws IOException {
          super(name);
<span class="line-modified">!         socket = new DatagramSocket(0, InetAddress.getLocalHost());</span>
          port =  socket.getLocalPort();
      }
      public int getPort(){
          return port;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,10 ***</span>
<span class="line-new-header">--- 94,12 ---</span>
        try {
          byte[] buf = new byte[256];
  
          // receive request
          DatagramPacket packet = new DatagramPacket(buf, buf.length);
<span class="line-added">+         // Notify client that server is ready to receive packet</span>
<span class="line-added">+         readyToStart.countDown();</span>
          socket.receive(packet);
  
          // figure out response
          String dString = null;
          dString = new Date().toString();
</pre>
<center><a href="../SendSize.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../SetReceiveBufferSize.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>