<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/DatagramSocket/SendDatagramToBadAddress.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  *
 27  * @bug 4204320
 28  *
 29  * @summary DatagramSocket.send should throw exception when connected
 30  *  to an invalid destination (on platforms that support it).
 31  */
 32 
 33 import java.net.*;
 34 import java.util.*;
 35 import java.io.InterruptedIOException;
 36 
 37 public class SendDatagramToBadAddress {
 38 
 39     static boolean debug = false;
 40 
 41     public static boolean OSsupportsFeature () {
 42         Properties p = System.getProperties ();
 43         String v;
 44         if (p.getProperty (&quot;os.name&quot;).equals (&quot;Windows 2000&quot;))
 45             return (true);
 46         if (p.getProperty (&quot;os.name&quot;).equals (&quot;Linux&quot;))
 47             return (true);
 48         if (p.getProperty (&quot;os.name&quot;).startsWith (&quot;Mac OS&quot;))
 49             return (true);
 50         // Check for specific Solaris version from here
 51         v = p.getProperty (&quot;os.arch&quot;);
 52         if (!v.equalsIgnoreCase (&quot;sparc&quot;))
 53             return (false);
 54         v = p.getProperty (&quot;os.name&quot;);
 55         if (!v.equalsIgnoreCase (&quot;Solaris&quot;) &amp;&amp; !v.equalsIgnoreCase (&quot;SunOS&quot;))
 56             return (false);
 57         v = p.getProperty (&quot;os.version&quot;);
 58         if (v.equals (&quot;5.8&quot;) || v.equals (&quot;8&quot;))
 59             return (false);
 60         return (true);
 61     }
 62 
 63     static void print (String s) {
 64         if (debug)
 65             System.out.println (s);
 66     }
 67 
 68     class Server {
 69 
 70         DatagramSocket server;
 71         byte[] buf = new byte [128];
 72         DatagramPacket pack = new DatagramPacket (buf, buf.length);
 73 
 74         public Server (DatagramSocket s) {
 75             server = s;
 76         }
 77 
 78         public void receive (int loop, boolean expectError) throws Exception {
 79             for (int i=0; i&lt;loop; i++) {
 80                 try {
 81                     server.receive (pack);
 82                 } catch (Exception e) {
 83                     if (expectError) {
 84                         print (&quot;Got expected error: &quot; + e);
 85                         continue;
 86                     } else {
 87                         print (&quot;Got: &quot; + new String (pack.getData()));
 88                         print (&quot;Expected: &quot; + new String (buf));
 89                         throw new Exception (&quot;Error reading data: Iter &quot; +i);
 90                     }
 91                 }
 92                 String s1 = &quot;Hello, server&quot;+i;
 93                 byte[] buf      = s1.getBytes();
 94                 if (!s1.equals (new String (pack.getData(),
 95                                             pack.getOffset(),pack.getLength()))) {
 96                     print (&quot;Got: &quot; + new String (pack.getData()));
 97                     print (&quot;Expected: &quot; + new String (buf));
 98                     throw new Exception (&quot;Error comparing data: Iter &quot; +i);
 99                 }
100             }
101         }
102     };
103 
104     public static void main (String args[]) throws Exception {
105         if (args.length &gt;=1 &amp;&amp; args[0].equals (&quot;-d&quot;)) {
106             debug = true;
107         }
108         SendDatagramToBadAddress ud = new SendDatagramToBadAddress ();
109         ud.run ();
110     }
111 
112     public void run() throws Exception {
<a name="1" id="anc1"></a><span class="line-removed">113 </span>
114         if (OSsupportsFeature()) {
115             print (&quot;running on OS that supports ICMP port unreachable&quot;);
116         }
<a name="2" id="anc2"></a>






117         InetAddress addr = InetAddress.getLoopbackAddress();
<a name="3" id="anc3"></a><span class="line-removed">118         DatagramSocket sock = new DatagramSocket();</span>
119         DatagramSocket serversock = new DatagramSocket(0);
120         DatagramPacket p;
121         byte[] buf;
122         int port = serversock.getLocalPort ();
123         final int loop = 5;
124         Server s = new Server (serversock);
125         int i;
126 
127         print (&quot;Checking send to connected address ...&quot;);
128         sock.connect(addr, port);
129 
130         for (i = 0; i &lt; loop; i++) {
131             try {
132                 buf = (&quot;Hello, server&quot;+i).getBytes();
133                 if (i % 2 == 1)
134                     p = new DatagramPacket(buf, buf.length, addr, port);
135                 else
136                     p = new DatagramPacket(buf, buf.length);
137                 sock.send(p);
138             } catch (Exception ex) {
139                 print (&quot;Got unexpected exception: &quot; + ex);
140                 throw new Exception (&quot;Error sending data: &quot;);
141             }
142         }
143 
144         s.receive (loop, false);
145 
146         // check disconnect() works
147 
148         print (&quot;Checking send to non-connected address ...&quot;);
149         sock.disconnect ();
150         buf = (&quot;Hello, server&quot;+0).getBytes();
151         p = new DatagramPacket(buf, buf.length, addr, port);
152         sock.send (p);
153         s.receive (1, false);
154 
155         // check send() to invalid destination followed by a blocking receive
156         // returns an error
157 
158         print (&quot;Checking send to invalid address ...&quot;);
159         sock.connect(addr, port);
160         serversock.close ();
161         try {
162             sock.setSoTimeout (4000);
163         } catch (Exception e) {
164             print (&quot;could not set timeout&quot;);
165             throw e;
166         }
167 
168         boolean goterror = false;
169 
170         for (i = 0; i &lt; loop; i++) {
171             try {
172                 buf = (&quot;Hello, server&quot;+i).getBytes();
173                 p = new DatagramPacket(buf, buf.length, addr, port);
174                 sock.send(p);
175                 p = new DatagramPacket(buf, buf.length, addr, port);
176                 sock.receive (p);
177             } catch (InterruptedIOException ex) {
178                 print (&quot;socket timeout&quot;);
179             } catch (Exception ex) {
180                 print (&quot;Got expected exception: &quot; + ex);
181                 goterror = true;
182             }
183         }
184 
185         if (!goterror &amp;&amp; OSsupportsFeature ()) {
186             print (&quot;Didnt get expected exception: &quot;);
187             throw new Exception (&quot;send did not return expected error&quot;);
188         }
189     }
190 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>