<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/DatagramSocket/ReuseAddressTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="PortUnreachable.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Send12k.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/DatagramSocket/ReuseAddressTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,6 +1,6 @@</span>
<span class="udiff-line-modified-removed">- /* Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+ /* Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,13 @@</span>
  import java.net.SocketException;
  
  /*
   * @test
   * @bug 8153674
<span class="udiff-line-added">+  * @key intermittent</span>
<span class="udiff-line-added">+  * @summary This test might fail intermittently as it needs a UDP socket that</span>
<span class="udiff-line-added">+  *          binds to the wildcard address.</span>
   * @summary Expected SocketException not thrown when calling bind() with
   *   setReuseAddress(false)
   * @run main/othervm ReuseAddressTest
   */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,11 +117,11 @@</span>
          System.out.println(&quot; &gt;&gt; &quot; + testCaseID + &quot;: &quot; + &quot;public void setReuseAddress(boolean on) throws SocketException&quot;);
  
          MulticastSocket ms1 = null;
          MulticastSocket ms2 = null;
          try {
<span class="udiff-line-modified-removed">-             InetSocketAddress addr = createSocketAddress(5050);</span>
<span class="udiff-line-modified-added">+             InetSocketAddress addr = createSocketAddress(0);</span>
  
              ms1 = new MulticastSocket(null);
              ms1.setReuseAddress(true);
              if (!ms1.getReuseAddress()) {
                  System.out.println(&quot;Cannot check: &quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,10 +133,11 @@</span>
              } catch (SocketException e) {
                  throw new RuntimeException(&quot;cannot bind first socket to &quot; + addr
                          + &quot; unexpected &quot; + e);
              }
  
<span class="udiff-line-added">+             addr = createSocketAddress(ms1.getLocalPort());</span>
              ms2 = new MulticastSocket(null);
              ms2.setReuseAddress(true);
              if (!ms2.getReuseAddress()) {
                  System.out.println(&quot;Cannot check: &quot;
                          + &quot; safety for SO_REUSEADDR option is not guaranteed&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,20 +188,21 @@</span>
          System.out.println(&quot; &gt;&gt; &quot; + testCaseID + &quot;: &quot; + &quot;public void setReuseAddress(boolean on) throws SocketException&quot;);
  
          MulticastSocket ms1 = null;
          MulticastSocket ms2 = null;
          try {
<span class="udiff-line-modified-removed">-             InetSocketAddress addr = createSocketAddress(6060);</span>
<span class="udiff-line-modified-added">+             InetSocketAddress addr = createSocketAddress(0);</span>
  
              ms1 = new MulticastSocket(null);
              try {
                  ms1.bind(addr);
              } catch (SocketException e) {
                  throw new RuntimeException(&quot;cannot bind first socket to &quot; + addr
                          + &quot; unexpected &quot; + e);
              }
  
<span class="udiff-line-added">+             addr = createSocketAddress(ms1.getLocalPort());</span>
              ms2 = new MulticastSocket(null);
              ms2.setReuseAddress(false);  // method under test
  
              try {
                  ms2.bind(addr);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -241,28 +246,28 @@</span>
  
          DatagramSocket ds1 = null;
          DatagramSocket ds2 = null;
          try {
  
<span class="udiff-line-modified-removed">-             InetSocketAddress isa = createSocketAddress(7070);</span>
<span class="udiff-line-modified-removed">-             InetAddress addr = isa.getAddress();</span>
<span class="udiff-line-modified-added">+             InetSocketAddress isa1 = createSocketAddress(0);</span>
<span class="udiff-line-modified-added">+             InetAddress addr = isa1.getAddress();</span>
              InetAddress wildcard = InetAddress.getByName(&quot;0.0.0.0&quot;);
              if (addr.equals(wildcard) || addr.isLoopbackAddress()) {
                  System.out.println(&quot;Cannot check: addresses are equal&quot;);
              }
  
<span class="udiff-line-removed">-             InetSocketAddress isa1 = new InetSocketAddress(addr, isa.getPort());</span>
<span class="udiff-line-removed">-             InetSocketAddress isa2 = new InetSocketAddress(wildcard, isa.getPort());</span>
  
              ds1 = new DatagramSocket(null);
              ds1.setReuseAddress(true);    // method under test
              if (!ds1.getReuseAddress()) {
                  System.out.println(&quot;Cannot check: &quot;
                          + &quot; safety for SO_REUSEADDR option is not guaranteed&quot;);
              }
              ds1.bind(isa1);
  
<span class="udiff-line-added">+             InetSocketAddress isa2 = new InetSocketAddress(wildcard, ds1.getLocalPort());</span>
<span class="udiff-line-added">+ </span>
              ds2 = new DatagramSocket(null);
              ds2.setReuseAddress(true);    // method under test
              if (!ds2.getReuseAddress()) {
                  System.out.println(&quot;Cannot check: &quot;
                          + &quot; safety for SO_REUSEADDR option is not guaranteed&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,12 +278,12 @@</span>
              } catch (SocketException e) {
                  throw new RuntimeException(&quot;cannot bind second socket to &quot; + isa2
                          + &quot; unexpected &quot; + e);
              }
  
<span class="udiff-line-modified-removed">-             if (ds1.getLocalPort() != isa.getPort() || !ds1.isBound()</span>
<span class="udiff-line-modified-removed">-                     || ds2.getLocalPort() != isa.getPort() || !ds2.isBound()) {</span>
<span class="udiff-line-modified-added">+             if (ds1.getLocalPort() != ds2.getLocalPort() || !ds1.isBound()</span>
<span class="udiff-line-modified-added">+                     || !ds2.isBound()) {</span>
                  System.out.println(&quot;bind() fails with: &quot; + addr);
                  System.out.println(&quot;  ds1 [&quot; + getInfo(ds1) + &quot;]&quot;);
                  System.out.println(&quot;  ds2 [&quot; + getInfo(ds2) + &quot;]&quot;);
                  System.out.println(&quot;  getReuseAddress(): &quot; + ds2.getReuseAddress());
                  throw new RuntimeException(&quot;bind() fails with: &quot; + addr);
</pre>
<center><a href="PortUnreachable.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Send12k.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>