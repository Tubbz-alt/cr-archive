<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/ResponseCache/ResponseCacheTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @summary Unit test for java.net.ResponseCache
 26  * @bug 4837267
<a name="2" id="anc2"></a>
 27  * @author Yingxian Wang
 28  */
 29 
 30 import java.net.*;
 31 import java.util.*;
 32 import java.io.*;
 33 import javax.net.ssl.*;
<a name="3" id="anc3"></a>

 34 
 35 /**
 36  * Request should get serviced by the cache handler. Response get
 37  * saved through the cache handler.
 38  */
 39 public class ResponseCacheTest implements Runnable {
 40     ServerSocket ss;
 41     static URL url1;
 42     static URL url2;
 43     static String FNPrefix, OutFNPrefix;
 44     static List&lt;Closeable&gt; streams = new ArrayList&lt;&gt;();
 45     static List&lt;File&gt; files = new ArrayList&lt;&gt;();
 46 
 47     /*
 48      * Our &quot;http&quot; server to return a 404 */
 49     public void run() {
 50         Socket s = null;
 51         FileInputStream fis = null;
 52         try {
 53             s = ss.accept();
 54 
 55             InputStream is = s.getInputStream ();
 56             BufferedReader r = new BufferedReader(new InputStreamReader(is));
 57             String x;
 58             while ((x=r.readLine()) != null) {
 59                 if (x.length() ==0) {
 60                     break;
 61                 }
 62             }
 63             PrintStream out = new PrintStream(
 64                                  new BufferedOutputStream(
 65                                     s.getOutputStream() ));
 66 
 67             /* send file2.1 */
 68             File file2 = new File(FNPrefix+&quot;file2.1&quot;);
 69             out.print(&quot;HTTP/1.1 200 OK\r\n&quot;);
 70             out.print(&quot;Content-Type: text/html; charset=iso-8859-1\r\n&quot;);
 71             out.print(&quot;Content-Length: &quot;+file2.length()+&quot;\r\n&quot;);
 72             out.print(&quot;Connection: close\r\n&quot;);
 73             out.print(&quot;\r\n&quot;);
 74             fis = new FileInputStream(file2);
 75             byte[] buf = new byte[(int)file2.length()];
 76             int len;
 77             while ((len = fis.read(buf)) != -1) {
 78                 out.print(new String(buf));
 79             }
 80 
 81             out.flush();
 82 
 83             s.close();
 84             ss.close();
 85         } catch (Exception e) {
 86             e.printStackTrace();
 87         } finally {
 88             try { ss.close(); } catch (IOException unused) {}
 89             try { s.close(); } catch (IOException unused) {}
 90             try { fis.close(); } catch (IOException unused) {}
 91         }
 92     }
<a name="4" id="anc4"></a><span class="line-modified"> 93 static class NameVerifier implements HostnameVerifier {</span>
 94         public boolean verify(String hostname, SSLSession session) {
 95             return true;
 96         }
 97     }
 98     ResponseCacheTest() throws Exception {
 99         /* start the server */
<a name="5" id="anc5"></a><span class="line-modified">100         ss = new ServerSocket(0);</span>



101         (new Thread(this)).start();
102         /* establish http connection to server */
103         url1 = new URL(&quot;http://localhost/file1.cache&quot;);
104         HttpURLConnection http = (HttpURLConnection)url1.openConnection();
105         InputStream is = null;
106         System.out.println(&quot;request headers: &quot;+http.getRequestProperties());
107         System.out.println(&quot;responsecode is :&quot;+http.getResponseCode());
108         Map&lt;String,List&lt;String&gt;&gt; headers1 = http.getHeaderFields();
109         try {
110             is = http.getInputStream();
111         } catch (IOException ioex) {
112             throw new RuntimeException(ioex.getMessage());
113         }
114         BufferedReader r = new BufferedReader(new InputStreamReader(is));
115         String x;
116         File fileout = new File(OutFNPrefix+&quot;file1&quot;);
117         PrintStream out = new PrintStream(
118                                  new BufferedOutputStream(
119                                     new FileOutputStream(fileout)));
120         while ((x=r.readLine()) != null) {
121             out.print(x+&quot;\n&quot;);
122         }
123         out.flush();
124         out.close();
125 
126         http.disconnect();
127 
128         // testing ResponseCacheHandler.put()
<a name="6" id="anc6"></a><span class="line-modified">129         url2 = new URL(&quot;http://localhost:&quot; +</span>
<span class="line-modified">130                        Integer.toString(ss.getLocalPort())+&quot;/file2.1&quot;);</span>
<span class="line-modified">131         http = (HttpURLConnection)url2.openConnection();</span>




132         System.out.println(&quot;responsecode2 is :&quot;+http.getResponseCode());
133         Map&lt;String,List&lt;String&gt;&gt; headers2 = http.getHeaderFields();
134 
135         try {
136             is = http.getInputStream();
137         } catch (IOException ioex) {
138             throw new RuntimeException(ioex.getMessage());
139         }
140         r = new BufferedReader(new InputStreamReader(is));
141         fileout = new File(OutFNPrefix+&quot;file2.2&quot;);
142         out = new PrintStream(
143                                  new BufferedOutputStream(
144                                     new FileOutputStream(fileout)));
145         while ((x=r.readLine()) != null) {
146             out.print(x+&quot;\n&quot;);
147         }
148         out.flush();
149         out.close();
150 
151         // assert (headers1 == headers2 &amp;&amp; file1 == file2.2)
152         File file1 = new File(OutFNPrefix+&quot;file1&quot;);
153         File file2 = new File(OutFNPrefix+&quot;file2.2&quot;);
154         files.add(file1);
155         files.add(file2);
156         System.out.println(&quot;headers1&quot;+headers1+&quot;\nheaders2=&quot;+headers2);
157         if (!headers1.equals(headers2) || file1.length() != file2.length()) {
158             throw new RuntimeException(&quot;test failed&quot;);
159         }
160     }
161 
162     public static void main(String args[]) throws Exception {
163         try {
164             ResponseCache.setDefault(new MyResponseCache());
165             FNPrefix = System.getProperty(&quot;test.src&quot;, &quot;.&quot;)+&quot;/&quot;;
166             OutFNPrefix = System.getProperty(&quot;test.scratch&quot;, &quot;.&quot;)+&quot;/&quot;;
167             new ResponseCacheTest();
168         } finally{
169             ResponseCache.setDefault(null);
170             for (Closeable c: streams) {
171                 try { c.close(); } catch (IOException unused) {}
172             }
173             for (File f: files) {
174                 f.delete();
175             }
176         }
177     }
178 
179     static class MyResponseCache extends ResponseCache {
180         public CacheResponse get(URI uri, String rqstMethod,
181                                  Map&lt;String,List&lt;String&gt;&gt; rqstHeaders)
182             throws IOException
183         {
184             try {
185                 if (uri.equals(url1.toURI())) {
186                     return new MyCacheResponse(FNPrefix+&quot;file1.cache&quot;);
187                 }
188             } catch (URISyntaxException ex) {
189                 throw new RuntimeException (ex);
190             }
191             return null;
192         }
193 
194         public CacheRequest put(URI uri, URLConnection conn)  throws IOException {
195             // save cache to file2.cache
196             // 1. serialize headers into file2.cache
197             // 2. write data to file2.cache
198             return new MyCacheRequest(OutFNPrefix+&quot;file2.cache&quot;, conn.getHeaderFields());
199         }
200     }
201 
202     static class MyCacheResponse extends CacheResponse {
203         FileInputStream fis;
204         Map&lt;String,List&lt;String&gt;&gt; headers;
205         public MyCacheResponse(String filename) {
206             try {
207                 fis = new FileInputStream(new File(filename));
208                 streams.add(fis);
209                 ObjectInputStream ois = new ObjectInputStream(fis);
210                 headers = (Map&lt;String,List&lt;String&gt;&gt;)ois.readObject();
211             } catch (Exception ex) {
212                 // throw new RuntimeException(ex.getMessage());
213             }
214         }
215 
216         public InputStream getBody() throws IOException {
217             return fis;
218         }
219 
220         public Map&lt;String,List&lt;String&gt;&gt; getHeaders() throws IOException {
221             return headers;
222         }
223     }
224 
225     static class MyCacheRequest extends CacheRequest {
226         FileOutputStream fos;
227         public MyCacheRequest(String filename, Map&lt;String,List&lt;String&gt;&gt; rspHeaders) {
228             try {
229                 File file = new File(filename);
230                 fos = new FileOutputStream(file);
231                 streams.add(fos);
232                 files.add(file);
233                 ObjectOutputStream oos = new ObjectOutputStream(fos);
234                 oos.writeObject(rspHeaders);
235             } catch (Exception ex) {
236                 throw new RuntimeException(ex.getMessage());
237             }
238         }
239         public OutputStream getBody() throws IOException {
240             return fos;
241         }
242 
243         public void abort() {
244             // no op
245         }
246     }
247 
248 
249 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>