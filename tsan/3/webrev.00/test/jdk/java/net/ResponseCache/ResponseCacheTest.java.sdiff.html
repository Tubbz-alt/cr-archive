<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/ResponseCache/ResponseCacheTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="B6181108.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Test.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/ResponseCache/ResponseCacheTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @summary Unit test for java.net.ResponseCache
 26  * @bug 4837267

 27  * @author Yingxian Wang
 28  */
 29 
 30 import java.net.*;
 31 import java.util.*;
 32 import java.io.*;
 33 import javax.net.ssl.*;


 34 
 35 /**
 36  * Request should get serviced by the cache handler. Response get
 37  * saved through the cache handler.
 38  */
 39 public class ResponseCacheTest implements Runnable {
 40     ServerSocket ss;
 41     static URL url1;
 42     static URL url2;
 43     static String FNPrefix, OutFNPrefix;
 44     static List&lt;Closeable&gt; streams = new ArrayList&lt;&gt;();
 45     static List&lt;File&gt; files = new ArrayList&lt;&gt;();
 46 
 47     /*
 48      * Our &quot;http&quot; server to return a 404 */
 49     public void run() {
 50         Socket s = null;
 51         FileInputStream fis = null;
 52         try {
 53             s = ss.accept();
</pre>
<hr />
<pre>
 73             out.print(&quot;\r\n&quot;);
 74             fis = new FileInputStream(file2);
 75             byte[] buf = new byte[(int)file2.length()];
 76             int len;
 77             while ((len = fis.read(buf)) != -1) {
 78                 out.print(new String(buf));
 79             }
 80 
 81             out.flush();
 82 
 83             s.close();
 84             ss.close();
 85         } catch (Exception e) {
 86             e.printStackTrace();
 87         } finally {
 88             try { ss.close(); } catch (IOException unused) {}
 89             try { s.close(); } catch (IOException unused) {}
 90             try { fis.close(); } catch (IOException unused) {}
 91         }
 92     }
<span class="line-modified"> 93 static class NameVerifier implements HostnameVerifier {</span>
 94         public boolean verify(String hostname, SSLSession session) {
 95             return true;
 96         }
 97     }
 98     ResponseCacheTest() throws Exception {
 99         /* start the server */
<span class="line-modified">100         ss = new ServerSocket(0);</span>



101         (new Thread(this)).start();
102         /* establish http connection to server */
103         url1 = new URL(&quot;http://localhost/file1.cache&quot;);
104         HttpURLConnection http = (HttpURLConnection)url1.openConnection();
105         InputStream is = null;
106         System.out.println(&quot;request headers: &quot;+http.getRequestProperties());
107         System.out.println(&quot;responsecode is :&quot;+http.getResponseCode());
108         Map&lt;String,List&lt;String&gt;&gt; headers1 = http.getHeaderFields();
109         try {
110             is = http.getInputStream();
111         } catch (IOException ioex) {
112             throw new RuntimeException(ioex.getMessage());
113         }
114         BufferedReader r = new BufferedReader(new InputStreamReader(is));
115         String x;
116         File fileout = new File(OutFNPrefix+&quot;file1&quot;);
117         PrintStream out = new PrintStream(
118                                  new BufferedOutputStream(
119                                     new FileOutputStream(fileout)));
120         while ((x=r.readLine()) != null) {
121             out.print(x+&quot;\n&quot;);
122         }
123         out.flush();
124         out.close();
125 
126         http.disconnect();
127 
128         // testing ResponseCacheHandler.put()
<span class="line-modified">129         url2 = new URL(&quot;http://localhost:&quot; +</span>
<span class="line-modified">130                        Integer.toString(ss.getLocalPort())+&quot;/file2.1&quot;);</span>
<span class="line-modified">131         http = (HttpURLConnection)url2.openConnection();</span>




132         System.out.println(&quot;responsecode2 is :&quot;+http.getResponseCode());
133         Map&lt;String,List&lt;String&gt;&gt; headers2 = http.getHeaderFields();
134 
135         try {
136             is = http.getInputStream();
137         } catch (IOException ioex) {
138             throw new RuntimeException(ioex.getMessage());
139         }
140         r = new BufferedReader(new InputStreamReader(is));
141         fileout = new File(OutFNPrefix+&quot;file2.2&quot;);
142         out = new PrintStream(
143                                  new BufferedOutputStream(
144                                     new FileOutputStream(fileout)));
145         while ((x=r.readLine()) != null) {
146             out.print(x+&quot;\n&quot;);
147         }
148         out.flush();
149         out.close();
150 
151         // assert (headers1 == headers2 &amp;&amp; file1 == file2.2)
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /* @test
 25  * @summary Unit test for java.net.ResponseCache
 26  * @bug 4837267
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @author Yingxian Wang
 29  */
 30 
 31 import java.net.*;
 32 import java.util.*;
 33 import java.io.*;
 34 import javax.net.ssl.*;
<span class="line-added"> 35 import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added"> 36 import static java.net.Proxy.NO_PROXY;</span>
 37 
 38 /**
 39  * Request should get serviced by the cache handler. Response get
 40  * saved through the cache handler.
 41  */
 42 public class ResponseCacheTest implements Runnable {
 43     ServerSocket ss;
 44     static URL url1;
 45     static URL url2;
 46     static String FNPrefix, OutFNPrefix;
 47     static List&lt;Closeable&gt; streams = new ArrayList&lt;&gt;();
 48     static List&lt;File&gt; files = new ArrayList&lt;&gt;();
 49 
 50     /*
 51      * Our &quot;http&quot; server to return a 404 */
 52     public void run() {
 53         Socket s = null;
 54         FileInputStream fis = null;
 55         try {
 56             s = ss.accept();
</pre>
<hr />
<pre>
 76             out.print(&quot;\r\n&quot;);
 77             fis = new FileInputStream(file2);
 78             byte[] buf = new byte[(int)file2.length()];
 79             int len;
 80             while ((len = fis.read(buf)) != -1) {
 81                 out.print(new String(buf));
 82             }
 83 
 84             out.flush();
 85 
 86             s.close();
 87             ss.close();
 88         } catch (Exception e) {
 89             e.printStackTrace();
 90         } finally {
 91             try { ss.close(); } catch (IOException unused) {}
 92             try { s.close(); } catch (IOException unused) {}
 93             try { fis.close(); } catch (IOException unused) {}
 94         }
 95     }
<span class="line-modified"> 96     static class NameVerifier implements HostnameVerifier {</span>
 97         public boolean verify(String hostname, SSLSession session) {
 98             return true;
 99         }
100     }
101     ResponseCacheTest() throws Exception {
102         /* start the server */
<span class="line-modified">103         InetAddress loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-added">104         ss = new ServerSocket();</span>
<span class="line-added">105         ss.bind(new InetSocketAddress(loopback, 0));</span>
<span class="line-added">106 </span>
107         (new Thread(this)).start();
108         /* establish http connection to server */
109         url1 = new URL(&quot;http://localhost/file1.cache&quot;);
110         HttpURLConnection http = (HttpURLConnection)url1.openConnection();
111         InputStream is = null;
112         System.out.println(&quot;request headers: &quot;+http.getRequestProperties());
113         System.out.println(&quot;responsecode is :&quot;+http.getResponseCode());
114         Map&lt;String,List&lt;String&gt;&gt; headers1 = http.getHeaderFields();
115         try {
116             is = http.getInputStream();
117         } catch (IOException ioex) {
118             throw new RuntimeException(ioex.getMessage());
119         }
120         BufferedReader r = new BufferedReader(new InputStreamReader(is));
121         String x;
122         File fileout = new File(OutFNPrefix+&quot;file1&quot;);
123         PrintStream out = new PrintStream(
124                                  new BufferedOutputStream(
125                                     new FileOutputStream(fileout)));
126         while ((x=r.readLine()) != null) {
127             out.print(x+&quot;\n&quot;);
128         }
129         out.flush();
130         out.close();
131 
132         http.disconnect();
133 
134         // testing ResponseCacheHandler.put()
<span class="line-modified">135         url2 = URIBuilder.newBuilder()</span>
<span class="line-modified">136                    .scheme(&quot;http&quot;)</span>
<span class="line-modified">137                    .host(ss.getInetAddress())</span>
<span class="line-added">138                    .port(ss.getLocalPort())</span>
<span class="line-added">139                    .path(&quot;/file2.1&quot;)</span>
<span class="line-added">140                    .toURL();</span>
<span class="line-added">141         http = (HttpURLConnection)url2.openConnection(NO_PROXY);</span>
142         System.out.println(&quot;responsecode2 is :&quot;+http.getResponseCode());
143         Map&lt;String,List&lt;String&gt;&gt; headers2 = http.getHeaderFields();
144 
145         try {
146             is = http.getInputStream();
147         } catch (IOException ioex) {
148             throw new RuntimeException(ioex.getMessage());
149         }
150         r = new BufferedReader(new InputStreamReader(is));
151         fileout = new File(OutFNPrefix+&quot;file2.2&quot;);
152         out = new PrintStream(
153                                  new BufferedOutputStream(
154                                     new FileOutputStream(fileout)));
155         while ((x=r.readLine()) != null) {
156             out.print(x+&quot;\n&quot;);
157         }
158         out.flush();
159         out.close();
160 
161         // assert (headers1 == headers2 &amp;&amp; file1 == file2.2)
</pre>
</td>
</tr>
</table>
<center><a href="B6181108.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Test.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>