<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/MulticastSocket/MulticastAddresses.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="JoinLeave.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="NoLoopbackPackets.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/MulticastSocket/MulticastAddresses.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,106 +20,57 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  /*
<span class="udiff-line-modified-removed">-  *</span>
<span class="udiff-line-modified-added">+  * @test</span>
   * @bug 4488458
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @summary Test that MutlicastSocket.joinGroup is working for
   *          various multicast and non-multicast addresses.
   */
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import jdk.test.lib.NetworkConfiguration;</span>
<span class="udiff-line-added">+ </span>
  import java.net.*;
<span class="udiff-line-removed">- import java.util.Enumeration;</span>
  import java.io.IOException;
<span class="udiff-line-added">+ import java.util.stream.Collectors;</span>
  
  public class MulticastAddresses {
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     public static void main(String args[]) throws Exception {</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         boolean ipv6_available = false;</span>
<span class="udiff-line-removed">-         NetworkInterface ni = null;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         /*</span>
<span class="udiff-line-removed">-          * Examine the network interfaces and determine :-</span>
<span class="udiff-line-removed">-          *</span>
<span class="udiff-line-removed">-          * 1. If host has IPv6 support</span>
<span class="udiff-line-removed">-          * 2. Get reference to a non-loopback interface</span>
<span class="udiff-line-removed">-          */</span>
<span class="udiff-line-removed">-         Enumeration nifs = NetworkInterface.getNetworkInterfaces();</span>
<span class="udiff-line-removed">-         while (nifs.hasMoreElements()) {</span>
<span class="udiff-line-removed">-             NetworkInterface this_ni = (NetworkInterface)nifs.nextElement();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             Enumeration addrs = this_ni.getInetAddresses();</span>
<span class="udiff-line-removed">-             while (addrs.hasMoreElements()) {</span>
<span class="udiff-line-removed">-                 InetAddress addr = (InetAddress)addrs.nextElement();</span>
<span class="udiff-line-removed">-                 if (addr instanceof Inet6Address) {</span>
<span class="udiff-line-removed">-                     ipv6_available = true;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (!addr.isLoopbackAddress() &amp;&amp; ni == null) {</span>
<span class="udiff-line-removed">-                     ni = this_ni;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (ipv6_available) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     public static void runTest(NetworkInterface ni,</span>
<span class="udiff-line-modified-added">+                                String[] multicasts,</span>
<span class="udiff-line-modified-added">+                                String[] nonMulticasts) throws Exception {</span>
          int failures = 0;
  
<span class="udiff-line-removed">-         String multicasts[] = {</span>
<span class="udiff-line-removed">-                 &quot;224.80.80.80&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ff01::1&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ff02::1234&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ff05::a&quot;,</span>
<span class="udiff-line-removed">-                 &quot;ff0e::1234:a&quot; };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         String non_multicasts[] = {</span>
<span class="udiff-line-removed">-                 &quot;129.1.1.1&quot;,</span>
<span class="udiff-line-removed">-                 &quot;::1&quot;,</span>
<span class="udiff-line-removed">-                 &quot;::129.1.1.1&quot;,</span>
<span class="udiff-line-removed">-                 &quot;fe80::a00:20ff:fee5:bc02&quot; };</span>
<span class="udiff-line-removed">- </span>
          MulticastSocket s = new MulticastSocket();
  
          /* test valid multicast addresses */
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         for (int i=0; i&lt;multicasts.length; i++) {</span>
<span class="udiff-line-modified-added">+         for (int i = 0; i &lt; multicasts.length; i++) {</span>
              InetAddress ia = InetAddress.getByName(multicasts[i]);
<span class="udiff-line-removed">-             if (ia instanceof Inet6Address &amp;&amp; !ipv6_available) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             System.out.println(&quot;Test: &quot; + ia);</span>
  
<span class="udiff-line-added">+             System.out.println(&quot;Test: &quot; + ia + &quot; &quot; + &quot; ni: &quot; + ni);</span>
              try {
  
                  System.out.print(&quot;    joinGroup(InetAddress) &quot;);
                  s.joinGroup(ia);
                  s.leaveGroup(ia);
                  System.out.println(&quot;    Passed.&quot;);
  
                  System.out.print(&quot;    joinGroup(InetAddress,NetworkInterface) &quot;);
<span class="udiff-line-modified-removed">-                 s.joinGroup(new InetSocketAddress(ia,0), ni);</span>
<span class="udiff-line-modified-removed">-                 s.leaveGroup(new InetSocketAddress(ia,0), ni);</span>
<span class="udiff-line-modified-added">+                 s.joinGroup(new InetSocketAddress(ia, 0), ni);</span>
<span class="udiff-line-modified-added">+                 s.leaveGroup(new InetSocketAddress(ia, 0), ni);</span>
                  System.out.println(&quot;    Passed.&quot;);
              } catch (IOException e) {
                  failures++;
                  System.out.println(&quot;Failed: &quot; + e.getMessage());
              }
  
          }
  
          /* test non-multicast addresses */
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         for (int i=0; i&lt;non_multicasts.length; i++) {</span>
<span class="udiff-line-removed">-             InetAddress ia = InetAddress.getByName(non_multicasts[i]);</span>
<span class="udiff-line-removed">-             if (ia instanceof Inet6Address &amp;&amp; !ipv6_available) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+         for (int i = 0; i &lt; nonMulticasts.length; i++) {</span>
<span class="udiff-line-modified-added">+             InetAddress ia = InetAddress.getByName(nonMulticasts[i]);</span>
              boolean failed = false;
  
              System.out.println(&quot;Test: &quot; + ia + &quot; &quot;);
              try {
                  System.out.println(&quot;    joinGroup(InetAddress) &quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,22 +79,61 @@</span>
                  System.out.println(&quot;Failed!! -- incorrectly joined group&quot;);
                  failed = true;
              } catch (IOException e) {
                  System.out.println(&quot;    Passed: &quot; + e.getMessage());
              }
<span class="udiff-line-removed">- </span>
              if (failed) {
                  s.leaveGroup(ia);
                  failures++;
              }
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         /* done */</span>
<span class="udiff-line-removed">- </span>
          s.close();
<span class="udiff-line-removed">- </span>
          if (failures &gt; 0) {
              throw new Exception(failures + &quot; test(s) failed - see log file.&quot;);
          }
      }
  
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static void main(String args[]) throws Exception {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String[] multicastIPv4 = {</span>
<span class="udiff-line-added">+                 &quot;224.80.80.80&quot;,</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+         String[] multicastIPv6 = {</span>
<span class="udiff-line-added">+                 &quot;ff01::1&quot;,</span>
<span class="udiff-line-added">+                 &quot;ff02::1234&quot;,</span>
<span class="udiff-line-added">+                 &quot;ff05::a&quot;,</span>
<span class="udiff-line-added">+                 &quot;ff0e::1234:a&quot;};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String[] nonMulticastIPv4 = {</span>
<span class="udiff-line-added">+                 &quot;129.1.1.1&quot;</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String[] nonMulticastIPv6 = {</span>
<span class="udiff-line-added">+                 &quot;::1&quot;,</span>
<span class="udiff-line-added">+                 &quot;::129.1.1.1&quot;,</span>
<span class="udiff-line-added">+                 &quot;fe80::a00:20ff:fee5:bc02&quot;};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         /*</span>
<span class="udiff-line-added">+          * Examine the network interfaces and determine :-</span>
<span class="udiff-line-added">+          *</span>
<span class="udiff-line-added">+          * 1. If host has IPv6 support</span>
<span class="udiff-line-added">+          * 2. Get reference to a non-loopback interface</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         NetworkConfiguration nc = NetworkConfiguration.probe();</span>
<span class="udiff-line-added">+         var ipv6List = nc.ip6MulticastInterfaces(false)</span>
<span class="udiff-line-added">+                 .collect(Collectors.toList());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         var ipv4List = nc.ip4MulticastInterfaces(false)</span>
<span class="udiff-line-added">+                 .collect(Collectors.toList());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (ipv6List.retainAll(ipv4List)) {</span>
<span class="udiff-line-added">+             runTest(ipv6List.get(0), multicastIPv4, nonMulticastIPv4);</span>
<span class="udiff-line-added">+             runTest(ipv6List.get(0), multicastIPv6, nonMulticastIPv6);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             if (!ipv4List.isEmpty())</span>
<span class="udiff-line-added">+                 runTest(ipv4List.get(0), multicastIPv4, nonMulticastIPv4);</span>
<span class="udiff-line-added">+             if (!ipv6List.isEmpty())</span>
<span class="udiff-line-added">+                 runTest(ipv6List.get(0), multicastIPv6, nonMulticastIPv6);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="JoinLeave.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="NoLoopbackPackets.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>