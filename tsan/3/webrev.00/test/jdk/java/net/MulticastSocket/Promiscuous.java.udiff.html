<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/MulticastSocket/Promiscuous.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="NoLoopbackPackets.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Reuse.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/MulticastSocket/Promiscuous.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,35 +20,46 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   *
  
  /* @test
<span class="udiff-line-modified-removed">-  * @bug 8014499</span>
<span class="udiff-line-modified-added">+  * @bug 8014499 8219804</span>
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @summary Test for interference when two sockets are bound to the same
   *          port but joined to different multicast groups
   * @run main Promiscuous
   * @run main/othervm -Djava.net.preferIPv4Stack=true Promiscuous
   */
  
  import java.io.IOException;
  import static java.lang.System.out;
  import java.net.*;
<span class="udiff-line-added">+ import jdk.test.lib.net.IPSupport;</span>
  
  public class Promiscuous {
  
      static final int TIMEOUT =  5 * 1000; // 5 secs
      static int id = 1000;
  
      static void receive(MulticastSocket mc, boolean datagramExpected, int id)
          throws IOException
      {
          byte[] ba = new byte[100];
<span class="udiff-line-modified-removed">-         DatagramPacket p = new DatagramPacket(ba, ba.length);</span>
<span class="udiff-line-modified-added">+         DatagramPacket p;</span>
          try {
<span class="udiff-line-modified-removed">-             mc.receive(p);</span>
<span class="udiff-line-modified-removed">-             int recvId = Integer.parseInt(</span>
<span class="udiff-line-modified-removed">-                     new String(p.getData(), 0, p.getLength(), &quot;UTF-8&quot;));</span>
<span class="udiff-line-modified-added">+             String data = null;</span>
<span class="udiff-line-modified-added">+             while (true) {</span>
<span class="udiff-line-modified-added">+                 p = new DatagramPacket(ba, ba.length);</span>
<span class="udiff-line-added">+                 mc.receive(p);</span>
<span class="udiff-line-added">+                 data = new String(p.getData(), 0, p.getLength(), &quot;UTF-8&quot;);</span>
<span class="udiff-line-added">+                 if (data.length() &gt; UUID.length() &amp;&amp; data.startsWith(UUID)) {</span>
<span class="udiff-line-added">+                     data = data.substring(UUID.length());</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 logUnexpected(p);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int recvId = Integer.parseInt(data);</span>
              if (datagramExpected) {
                  if (recvId != id)
                      throw new RuntimeException(&quot;Unexpected id, got &quot; + recvId
                                                 + &quot;, expected: &quot; + id);
                  out.printf(&quot;Received message as expected, %s\n&quot;, p.getAddress());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,10 +74,24 @@</span>
              else
                  out.printf(&quot;Message not received, as expected\n&quot;);
          }
      }
  
<span class="udiff-line-added">+     static void logUnexpected(DatagramPacket p) {</span>
<span class="udiff-line-added">+         byte[] ba = p.getData();</span>
<span class="udiff-line-added">+         System.out.printf(&quot;Unexpected packet: length: %d. First three bytes: %d, %d, %d\n&quot;,</span>
<span class="udiff-line-added">+                           p.getLength(), ba[0], ba[1], ba[2]);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static final String UUID; // process-id : currentTimeMillis</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static {</span>
<span class="udiff-line-added">+         String s1 = Long.toString(ProcessHandle.current().pid());</span>
<span class="udiff-line-added">+         String s2 = Long.toString(System.currentTimeMillis());</span>
<span class="udiff-line-added">+         UUID = &quot;&lt;&quot; + s1 + s2 + &quot;&gt;&quot;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      static void test(InetAddress group1, InetAddress group2)
          throws IOException
      {
          try (MulticastSocket mc1 = new MulticastSocket();
               MulticastSocket mc2 = new MulticastSocket(mc1.getLocalPort());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,11 +100,11 @@</span>
              out.printf(&quot;Using port: %d\n&quot;, port);
  
              mc1.setSoTimeout(TIMEOUT);
              mc2.setSoTimeout(TIMEOUT);
              int nextId = id;
<span class="udiff-line-modified-removed">-             byte[] msg = Integer.toString(nextId).getBytes(&quot;UTF-8&quot;);</span>
<span class="udiff-line-modified-added">+             byte[] msg = (UUID + Integer.toString(nextId)).getBytes(&quot;UTF-8&quot;);</span>
              DatagramPacket p = new DatagramPacket(msg, msg.length);
              p.setAddress(group1);
              p.setPort(port);
  
              mc1.joinGroup(group1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,11 +118,11 @@</span>
              // the packet should be received by mc1 only
              receive(mc1, true, nextId);
              receive(mc2, false, 0);
  
              nextId = ++id;
<span class="udiff-line-modified-removed">-             msg = Integer.toString(nextId).getBytes(&quot;UTF-8&quot;);</span>
<span class="udiff-line-modified-added">+             msg = (UUID + Integer.toString(nextId)).getBytes(&quot;UTF-8&quot;);</span>
              p = new DatagramPacket(msg, msg.length);
              p.setAddress(group2);
              p.setPort(port);
  
              out.printf(&quot;Sending datagram to: %s/%d\n&quot;, group2, port);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,10 +136,11 @@</span>
              mc2.leaveGroup(group2);
          }
      }
  
      public static void main(String args[]) throws IOException {
<span class="udiff-line-added">+         IPSupport.throwSkippedExceptionIfNonOperational();</span>
          String os = System.getProperty(&quot;os.name&quot;);
  
          // Requires IP_MULTICAST_ALL on Linux (new since 2.6.31) so skip
          // on older kernels. Note that we skip on &lt;= version 3 to keep the
          // parsing simple
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -127,11 +153,11 @@</span>
                  return;
              }
          }
  
          // multicast groups used for the test
<span class="udiff-line-modified-removed">-         InetAddress ip4Group1 = InetAddress.getByName(&quot;224.7.8.9&quot;);</span>
<span class="udiff-line-modified-removed">-         InetAddress ip4Group2 = InetAddress.getByName(&quot;225.4.5.6&quot;);</span>
<span class="udiff-line-modified-added">+         InetAddress ip4Group1 = InetAddress.getByName(&quot;224.0.0.120&quot;);</span>
<span class="udiff-line-modified-added">+         InetAddress ip4Group2 = InetAddress.getByName(&quot;224.0.0.121&quot;);</span>
  
          test(ip4Group1, ip4Group2);
      }
  }
</pre>
<center><a href="NoLoopbackPackets.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Reuse.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>