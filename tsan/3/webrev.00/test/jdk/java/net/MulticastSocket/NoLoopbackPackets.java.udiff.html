<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/MulticastSocket/NoLoopbackPackets.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MulticastAddresses.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Promiscuous.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/MulticastSocket/NoLoopbackPackets.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2007, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,104 +22,131 @@</span>
   */
  
  /*
   * @test
   * @bug 4742177
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @summary Re-test IPv6 (and specifically MulticastSocket) with latest Linux &amp; USAGI code
   */
  import java.util.*;
  import java.net.*;
<span class="udiff-line-added">+ import jdk.test.lib.NetworkConfiguration;</span>
<span class="udiff-line-added">+ import jdk.test.lib.net.IPSupport;</span>
  
  public class NoLoopbackPackets {
      private static String osname;
  
      static boolean isWindows() {
          if (osname == null)
              osname = System.getProperty(&quot;os.name&quot;);
          return osname.contains(&quot;Windows&quot;);
      }
  
<span class="udiff-line-modified-removed">-     private static boolean hasIPv6() throws Exception {</span>
<span class="udiff-line-removed">-         List&lt;NetworkInterface&gt; nics = Collections.list(</span>
<span class="udiff-line-removed">-                                         NetworkInterface.getNetworkInterfaces());</span>
<span class="udiff-line-removed">-         for (NetworkInterface nic : nics) {</span>
<span class="udiff-line-removed">-             if (!nic.isLoopback()) {</span>
<span class="udiff-line-removed">-                 List&lt;InetAddress&gt; addrs = Collections.list(nic.getInetAddresses());</span>
<span class="udiff-line-removed">-                 for (InetAddress addr : addrs) {</span>
<span class="udiff-line-removed">-                     if (addr instanceof Inet6Address) {</span>
<span class="udiff-line-removed">-                         return true;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     private static final String MESSAGE = &quot;hello world (&quot; + System.nanoTime() + &quot;)&quot;;</span>
      public static void main(String[] args) throws Exception {
          if (isWindows()) {
              System.out.println(&quot;The test only run on non-Windows OS. Bye.&quot;);
              return;
          }
  
<span class="udiff-line-removed">-         if (!hasIPv6()) {</span>
<span class="udiff-line-removed">-             System.out.println(&quot;No IPv6 available. Bye.&quot;);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          MulticastSocket msock = null;
          List&lt;SocketAddress&gt; failedGroups = new ArrayList&lt;SocketAddress&gt;();
          Sender sender = null;
<span class="udiff-line-added">+         Thread senderThread = null;</span>
          try {
              msock = new MulticastSocket();
              int port = msock.getLocalPort();
  
              // we will send packets to three multicast groups :-
              // 224.1.1.1, ::ffff:224.1.1.2, and ff02::1:1
              //
              List&lt;SocketAddress&gt; groups = new ArrayList&lt;SocketAddress&gt;();
<span class="udiff-line-modified-removed">-             groups.add(new InetSocketAddress(InetAddress.getByName(&quot;224.1.1.1&quot;), port));</span>
<span class="udiff-line-modified-removed">-             groups.add(new InetSocketAddress(InetAddress.getByName(&quot;::ffff:224.1.1.2&quot;), port));</span>
<span class="udiff-line-modified-removed">-             groups.add(new InetSocketAddress(InetAddress.getByName(&quot;ff02::1:1&quot;), port));</span>
<span class="udiff-line-modified-added">+             if (IPSupport.hasIPv4()) {</span>
<span class="udiff-line-modified-added">+                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;224.1.1.1&quot;), port));</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             NetworkConfiguration nc = NetworkConfiguration.probe();</span>
<span class="udiff-line-added">+             if (IPSupport.hasIPv6() &amp;&amp; nc.hasTestableIPv6Address()) {</span>
<span class="udiff-line-added">+                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;::ffff:224.1.1.2&quot;), port));</span>
<span class="udiff-line-added">+                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;ff02::1:1&quot;), port));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (groups.isEmpty()) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;Nothing to test: there are no network interfaces&quot;);</span>
<span class="udiff-line-added">+             }</span>
  
              sender = new Sender(groups);
<span class="udiff-line-modified-removed">-             new Thread(sender).start();</span>
<span class="udiff-line-modified-added">+             senderThread = new Thread(sender);</span>
<span class="udiff-line-added">+             senderThread.start();</span>
  
              // Now try to receive multicast packets. we should not see any of them
              // since we disable loopback mode.
              //
              msock.setSoTimeout(5000);       // 5 seconds
  
              byte[] buf = new byte[1024];
<span class="udiff-line-added">+             for (int i = 0; i &lt; buf.length; i++) {</span>
<span class="udiff-line-added">+                 buf[i] = (byte) &#39;z&#39;;</span>
<span class="udiff-line-added">+             }</span>
              DatagramPacket packet = new DatagramPacket(buf, 0, buf.length);
<span class="udiff-line-added">+             byte[] expected = MESSAGE.getBytes();</span>
<span class="udiff-line-added">+             assert expected.length &lt;= buf.length;</span>
              for (SocketAddress group : groups) {
<span class="udiff-line-added">+                 System.out.println(&quot;joining group: &quot; + group);</span>
                  msock.joinGroup(group, null);
  
                  try {
<span class="udiff-line-modified-removed">-                     msock.receive(packet);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     // it is an error if we receive something</span>
<span class="udiff-line-modified-removed">-                     failedGroups.add(group);</span>
<span class="udiff-line-modified-added">+                     do {</span>
<span class="udiff-line-modified-added">+                         for (int i = 0; i &lt; buf.length; i++) {</span>
<span class="udiff-line-modified-added">+                             buf[i] = (byte) &#39;a&#39;;</span>
<span class="udiff-line-modified-added">+                         }</span>
<span class="udiff-line-added">+                         msock.receive(packet);</span>
<span class="udiff-line-added">+                         byte[] data = packet.getData();</span>
<span class="udiff-line-added">+                         int len = packet.getLength();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                         if (expected(data, len, expected)) {</span>
<span class="udiff-line-added">+                             failedGroups.add(group);</span>
<span class="udiff-line-added">+                             break;</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             System.err.println(&quot;WARNING: Unexpected packet received from &quot;</span>
<span class="udiff-line-added">+                                                + group + &quot;: &quot;</span>
<span class="udiff-line-added">+                                                + len + &quot; bytes&quot;);</span>
<span class="udiff-line-added">+                             System.err.println(&quot;\t as text: &quot; + new String(data, 0, len));</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } while (true);</span>
                  } catch (SocketTimeoutException e) {
                      // we expect this
<span class="udiff-line-added">+                     System.out.println(&quot;Received expected exception from &quot; + group + &quot;: &quot; + e);</span>
<span class="udiff-line-added">+                 } finally {</span>
<span class="udiff-line-added">+                     msock.leaveGroup(group, null);</span>
                  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 msock.leaveGroup(group, null);</span>
              }
          } finally {
              if (msock != null) try { msock.close(); } catch (Exception e) {}
              if (sender != null) {
                  sender.stop();
              }
          }
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             if (failedGroups.size() &gt; 0) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;We should not receive anything from following groups, but we did:&quot;);</span>
<span class="udiff-line-added">+                 for (SocketAddress group : failedGroups)</span>
<span class="udiff-line-added">+                     System.out.println(group);</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;test failed.&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             if (senderThread != null) {</span>
<span class="udiff-line-added">+                 senderThread.join();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         if (failedGroups.size() &gt; 0) {</span>
<span class="udiff-line-modified-removed">-             System.out.println(&quot;We should not receive anything from following groups, but we did:&quot;);</span>
<span class="udiff-line-modified-removed">-             for (SocketAddress group : failedGroups)</span>
<span class="udiff-line-modified-removed">-                 System.out.println(group);</span>
<span class="udiff-line-removed">-             throw new RuntimeException(&quot;test failed.&quot;);</span>
<span class="udiff-line-modified-added">+     static boolean expected(byte[] data, int len, byte[] expected) {</span>
<span class="udiff-line-modified-added">+         if (len != expected.length) return false;</span>
<span class="udiff-line-modified-added">+         for (int i = 0; i &lt; len; i++) {</span>
<span class="udiff-line-modified-added">+             if (data[i] != expected[i]) return false;</span>
          }
<span class="udiff-line-added">+         return true;</span>
      }
  
      static class Sender implements Runnable {
          private List&lt;SocketAddress&gt; sendToGroups;
          private volatile boolean stop;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -127,20 +154,19 @@</span>
          public Sender(List&lt;SocketAddress&gt; groups) {
              sendToGroups = groups;
          }
  
          public void run() {
<span class="udiff-line-modified-removed">-             byte[] buf = &quot;hello world&quot;.getBytes();</span>
<span class="udiff-line-modified-added">+             byte[] buf = MESSAGE.getBytes();</span>
              List&lt;DatagramPacket&gt; packets = new ArrayList&lt;DatagramPacket&gt;();
  
<span class="udiff-line-modified-removed">-             try {</span>
<span class="udiff-line-modified-added">+             try (MulticastSocket msock = new MulticastSocket()) {</span>
                  for (SocketAddress group : sendToGroups) {
                      DatagramPacket packet = new DatagramPacket(buf, buf.length, group);
                      packets.add(packet);
                  }
  
<span class="udiff-line-removed">-                 MulticastSocket msock = new MulticastSocket();</span>
                  msock.setLoopbackMode(true);    // disable loopback mode
                  while (!stop) {
                      for (DatagramPacket packet : packets) {
                          msock.send(packet);
                      }
</pre>
<center><a href="MulticastAddresses.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Promiscuous.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>