<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/MulticastSocket/NoLoopbackPackets.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4742177
<a name="2" id="anc2"></a><span class="line-added"> 27  * @library /test/lib</span>
 28  * @summary Re-test IPv6 (and specifically MulticastSocket) with latest Linux &amp; USAGI code
 29  */
 30 import java.util.*;
 31 import java.net.*;
<a name="3" id="anc3"></a><span class="line-added"> 32 import jdk.test.lib.NetworkConfiguration;</span>
<span class="line-added"> 33 import jdk.test.lib.net.IPSupport;</span>
 34 
 35 public class NoLoopbackPackets {
 36     private static String osname;
 37 
 38     static boolean isWindows() {
 39         if (osname == null)
 40             osname = System.getProperty(&quot;os.name&quot;);
 41         return osname.contains(&quot;Windows&quot;);
 42     }
 43 
<a name="4" id="anc4"></a><span class="line-modified"> 44     private static final String MESSAGE = &quot;hello world (&quot; + System.nanoTime() + &quot;)&quot;;</span>
















 45     public static void main(String[] args) throws Exception {
 46         if (isWindows()) {
 47             System.out.println(&quot;The test only run on non-Windows OS. Bye.&quot;);
 48             return;
 49         }
 50 
<a name="5" id="anc5"></a>




 51         MulticastSocket msock = null;
 52         List&lt;SocketAddress&gt; failedGroups = new ArrayList&lt;SocketAddress&gt;();
 53         Sender sender = null;
<a name="6" id="anc6"></a><span class="line-added"> 54         Thread senderThread = null;</span>
 55         try {
 56             msock = new MulticastSocket();
 57             int port = msock.getLocalPort();
 58 
 59             // we will send packets to three multicast groups :-
 60             // 224.1.1.1, ::ffff:224.1.1.2, and ff02::1:1
 61             //
 62             List&lt;SocketAddress&gt; groups = new ArrayList&lt;SocketAddress&gt;();
<a name="7" id="anc7"></a><span class="line-modified"> 63             if (IPSupport.hasIPv4()) {</span>
<span class="line-modified"> 64                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;224.1.1.1&quot;), port));</span>
<span class="line-modified"> 65             }</span>
<span class="line-added"> 66 </span>
<span class="line-added"> 67             NetworkConfiguration nc = NetworkConfiguration.probe();</span>
<span class="line-added"> 68             if (IPSupport.hasIPv6() &amp;&amp; nc.hasTestableIPv6Address()) {</span>
<span class="line-added"> 69                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;::ffff:224.1.1.2&quot;), port));</span>
<span class="line-added"> 70                 groups.add(new InetSocketAddress(InetAddress.getByName(&quot;ff02::1:1&quot;), port));</span>
<span class="line-added"> 71             }</span>
<span class="line-added"> 72             if (groups.isEmpty()) {</span>
<span class="line-added"> 73                 System.err.println(&quot;Nothing to test: there are no network interfaces&quot;);</span>
<span class="line-added"> 74             }</span>
 75 
 76             sender = new Sender(groups);
<a name="8" id="anc8"></a><span class="line-modified"> 77             senderThread = new Thread(sender);</span>
<span class="line-added"> 78             senderThread.start();</span>
 79 
 80             // Now try to receive multicast packets. we should not see any of them
 81             // since we disable loopback mode.
 82             //
 83             msock.setSoTimeout(5000);       // 5 seconds
 84 
 85             byte[] buf = new byte[1024];
<a name="9" id="anc9"></a><span class="line-added"> 86             for (int i = 0; i &lt; buf.length; i++) {</span>
<span class="line-added"> 87                 buf[i] = (byte) &#39;z&#39;;</span>
<span class="line-added"> 88             }</span>
 89             DatagramPacket packet = new DatagramPacket(buf, 0, buf.length);
<a name="10" id="anc10"></a><span class="line-added"> 90             byte[] expected = MESSAGE.getBytes();</span>
<span class="line-added"> 91             assert expected.length &lt;= buf.length;</span>
 92             for (SocketAddress group : groups) {
<a name="11" id="anc11"></a><span class="line-added"> 93                 System.out.println(&quot;joining group: &quot; + group);</span>
 94                 msock.joinGroup(group, null);
 95 
 96                 try {
<a name="12" id="anc12"></a><span class="line-modified"> 97                     do {</span>
<span class="line-modified"> 98                         for (int i = 0; i &lt; buf.length; i++) {</span>
<span class="line-modified"> 99                             buf[i] = (byte) &#39;a&#39;;</span>
<span class="line-modified">100                         }</span>
<span class="line-added">101                         msock.receive(packet);</span>
<span class="line-added">102                         byte[] data = packet.getData();</span>
<span class="line-added">103                         int len = packet.getLength();</span>
<span class="line-added">104 </span>
<span class="line-added">105                         if (expected(data, len, expected)) {</span>
<span class="line-added">106                             failedGroups.add(group);</span>
<span class="line-added">107                             break;</span>
<span class="line-added">108                         } else {</span>
<span class="line-added">109                             System.err.println(&quot;WARNING: Unexpected packet received from &quot;</span>
<span class="line-added">110                                                + group + &quot;: &quot;</span>
<span class="line-added">111                                                + len + &quot; bytes&quot;);</span>
<span class="line-added">112                             System.err.println(&quot;\t as text: &quot; + new String(data, 0, len));</span>
<span class="line-added">113                         }</span>
<span class="line-added">114                     } while (true);</span>
115                 } catch (SocketTimeoutException e) {
116                     // we expect this
<a name="13" id="anc13"></a><span class="line-added">117                     System.out.println(&quot;Received expected exception from &quot; + group + &quot;: &quot; + e);</span>
<span class="line-added">118                 } finally {</span>
<span class="line-added">119                     msock.leaveGroup(group, null);</span>
120                 }
<a name="14" id="anc14"></a>

121             }
122         } finally {
123             if (msock != null) try { msock.close(); } catch (Exception e) {}
124             if (sender != null) {
125                 sender.stop();
126             }
127         }
<a name="15" id="anc15"></a><span class="line-added">128         try {</span>
<span class="line-added">129             if (failedGroups.size() &gt; 0) {</span>
<span class="line-added">130                 System.out.println(&quot;We should not receive anything from following groups, but we did:&quot;);</span>
<span class="line-added">131                 for (SocketAddress group : failedGroups)</span>
<span class="line-added">132                     System.out.println(group);</span>
<span class="line-added">133                 throw new RuntimeException(&quot;test failed.&quot;);</span>
<span class="line-added">134             }</span>
<span class="line-added">135         } finally {</span>
<span class="line-added">136             if (senderThread != null) {</span>
<span class="line-added">137                 senderThread.join();</span>
<span class="line-added">138             }</span>
<span class="line-added">139         }</span>
<span class="line-added">140     }</span>
141 
<a name="16" id="anc16"></a><span class="line-modified">142     static boolean expected(byte[] data, int len, byte[] expected) {</span>
<span class="line-modified">143         if (len != expected.length) return false;</span>
<span class="line-modified">144         for (int i = 0; i &lt; len; i++) {</span>
<span class="line-modified">145             if (data[i] != expected[i]) return false;</span>

146         }
<a name="17" id="anc17"></a><span class="line-added">147         return true;</span>
148     }
149 
150     static class Sender implements Runnable {
151         private List&lt;SocketAddress&gt; sendToGroups;
152         private volatile boolean stop;
153 
154         public Sender(List&lt;SocketAddress&gt; groups) {
155             sendToGroups = groups;
156         }
157 
158         public void run() {
<a name="18" id="anc18"></a><span class="line-modified">159             byte[] buf = MESSAGE.getBytes();</span>
160             List&lt;DatagramPacket&gt; packets = new ArrayList&lt;DatagramPacket&gt;();
161 
<a name="19" id="anc19"></a><span class="line-modified">162             try (MulticastSocket msock = new MulticastSocket()) {</span>
163                 for (SocketAddress group : sendToGroups) {
164                     DatagramPacket packet = new DatagramPacket(buf, buf.length, group);
165                     packets.add(packet);
166                 }
167 
<a name="20" id="anc20"></a>
168                 msock.setLoopbackMode(true);    // disable loopback mode
169                 while (!stop) {
170                     for (DatagramPacket packet : packets) {
171                         msock.send(packet);
172                     }
173 
174                     Thread.sleep(1000);     // 1 second
175                 }
176             } catch (Exception e) {
177                 throw new RuntimeException(e);
178             }
179         }
180 
181         void stop() {
182             stop = true;
183         }
184     }
185 }
<a name="21" id="anc21"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="21" type="hidden" />
</body>
</html>