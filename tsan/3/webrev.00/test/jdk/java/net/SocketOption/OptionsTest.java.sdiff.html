<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/SocketOption/OptionsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MinimumRcvBufferSize.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SupportedOptionsSet.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/SocketOption/OptionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8036979 8072384 8044773</span>

 27  * @requires !vm.graal.enabled
 28  * @run main/othervm -Xcheck:jni OptionsTest

 29  * @run main/othervm -Xcheck:jni -Djava.net.preferIPv4Stack=true OptionsTest
 30  * @run main/othervm --limit-modules=java.base OptionsTest
 31  */
 32 
 33 import java.lang.reflect.Method;
 34 import java.net.*;
 35 import java.util.*;

 36 
 37 public class OptionsTest {
 38 
<span class="line-modified"> 39     static class Test {</span>
<span class="line-modified"> 40         Test(SocketOption&lt;?&gt; option, Object testValue) {</span>


 41             this.option = option;
<span class="line-modified"> 42             this.testValue = testValue;</span>
 43         }
<span class="line-modified"> 44         static Test create (SocketOption&lt;?&gt; option, Object testValue) {</span>
<span class="line-modified"> 45             return new Test(option, testValue);</span>
 46         }
<span class="line-modified"> 47         Object option;</span>
<span class="line-removed"> 48         Object testValue;</span>
 49     }
 50 
 51     // The tests set the option using the new API, read back the set value
<span class="line-modified"> 52     // which could be diferent, and then use the legacy get API to check</span>
 53     // these values are the same
 54 
<span class="line-modified"> 55     static Test[] socketTests = new Test[] {</span>
 56         Test.create(StandardSocketOptions.SO_KEEPALIVE, Boolean.TRUE),
 57         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 58         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 59         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 60         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),


 61         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(80)),
<span class="line-modified"> 62         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>


 63     };
 64 
<span class="line-modified"> 65     static Test[] serverSocketTests = new Test[] {</span>
 66         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 67         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 68         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="line-modified"> 69         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>


 70     };
 71 
<span class="line-modified"> 72     static Test[] dgSocketTests = new Test[] {</span>
 73         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 74         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 75         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 76         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="line-modified"> 77         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>




 78     };
 79 
<span class="line-modified"> 80     static Test[] mcSocketTests = new Test[] {</span>


 81         Test.create(StandardSocketOptions.IP_MULTICAST_IF, getNetworkInterface()),

 82         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(10)),

 83         Test.create(StandardSocketOptions.IP_MULTICAST_LOOP, Boolean.TRUE)
 84     };
 85 
 86     static NetworkInterface getNetworkInterface() {
 87         try {
 88             Enumeration&lt;NetworkInterface&gt; nifs = NetworkInterface.getNetworkInterfaces();
 89             while (nifs.hasMoreElements()) {
<span class="line-modified"> 90                 NetworkInterface ni = (NetworkInterface)nifs.nextElement();</span>
 91                 if (ni.supportsMulticast()) {
 92                     return ni;
 93                 }
 94             }
 95         } catch (Exception e) {
 96         }
 97         return null;
 98     }
 99 





























































100     static void doSocketTests() throws Exception {
<span class="line-modified">101         try (</span>
<span class="line-modified">102             ServerSocket srv = new ServerSocket(0);</span>
<span class="line-modified">103             Socket c = new Socket(InetAddress.getLoopbackAddress(), srv.getLocalPort());</span>
<span class="line-modified">104             Socket s = srv.accept();</span>
<span class="line-modified">105         ) {</span>
<span class="line-removed">106             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="line-removed">107             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-removed">108             for (int i=0; i&lt;socketTests.length; i++) {</span>
<span class="line-removed">109                 Test test = socketTests[i];</span>
<span class="line-removed">110                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="line-removed">111                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">112                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">113                     Object legacyget = legacyGetOption(Socket.class, c,test.option);</span>
<span class="line-removed">114                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">115                         Formatter f = new Formatter();</span>
<span class="line-removed">116                         f.format(&quot;S Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">117                         throw new RuntimeException(f.toString());</span>
<span class="line-removed">118                     }</span>
119                 }
120             }
121         }
<span class="line-removed">122     }</span>
123 
<span class="line-modified">124     static void doDgSocketTests() throws Exception {</span>
<span class="line-modified">125         try (</span>
<span class="line-modified">126             DatagramSocket c = new DatagramSocket(0);</span>
<span class="line-modified">127         ) {</span>
<span class="line-modified">128             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="line-modified">129             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-modified">130             for (int i=0; i&lt;dgSocketTests.length; i++) {</span>
<span class="line-modified">131                 Test test = dgSocketTests[i];</span>
<span class="line-modified">132                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="line-modified">133                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-modified">134                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">135                     Object legacyget = legacyGetOption(DatagramSocket.class, c,test.option);</span>
<span class="line-removed">136                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">137                         Formatter f = new Formatter();</span>
<span class="line-removed">138                         f.format(&quot;DG Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">139                         throw new RuntimeException(f.toString());</span>
140                     }
141                 }
142             }
143         }


144     }
145 
<span class="line-modified">146     static void doMcSocketTests() throws Exception {</span>
<span class="line-modified">147         try (</span>
<span class="line-modified">148             MulticastSocket c = new MulticastSocket(0);</span>
<span class="line-modified">149         ) {</span>
<span class="line-modified">150             for (int i=0; i&lt;mcSocketTests.length; i++) {</span>
<span class="line-modified">151                 Test test = mcSocketTests[i];</span>
<span class="line-modified">152                 c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">153                 Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">154                 Object legacyget = legacyGetOption(MulticastSocket.class, c,test.option);</span>
<span class="line-removed">155                 if (!getval.equals(legacyget)) {</span>
<span class="line-removed">156                     Formatter f = new Formatter();</span>
<span class="line-removed">157                     f.format(&quot;MC Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">158                     throw new RuntimeException(f.toString());</span>
159                 }
160             }
161         }
162     }
163 
<span class="line-modified">164     static void doServerSocketTests() throws Exception {</span>
<span class="line-modified">165         try (</span>
<span class="line-modified">166             ServerSocket c = new ServerSocket(0);</span>
<span class="line-removed">167         ) {</span>
<span class="line-removed">168             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
169             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
<span class="line-modified">170             for (int i=0; i&lt;serverSocketTests.length; i++) {</span>
<span class="line-removed">171                 Test test = serverSocketTests[i];</span>
172                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {
<span class="line-modified">173                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">174                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">175                     Object legacyget = legacyGetOption(</span>
<span class="line-removed">176                         ServerSocket.class, c, test.option</span>
<span class="line-removed">177                     );</span>
<span class="line-removed">178                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">179                         Formatter f = new Formatter();</span>
<span class="line-removed">180                         f.format(&quot;SS Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">181                         throw new RuntimeException(f.toString());</span>
<span class="line-removed">182                     }</span>
183                 }
184             }
185         }
186     }
187 
<span class="line-modified">188     static Object legacyGetOption(</span>
<span class="line-modified">189         Class&lt;?&gt; type, Object s, Object option)</span>





190 
<span class="line-modified">191         throws Exception</span>
<span class="line-removed">192     {</span>
193         if (type.equals(Socket.class)) {
194             Socket socket = (Socket)s;
195             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
196             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
197 
198             if (option.equals(StandardSocketOptions.SO_KEEPALIVE)) {
199                 return Boolean.valueOf(socket.getKeepAlive());
200             } else if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
201                 return Integer.valueOf(socket.getSendBufferSize());
202             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
203                 return Integer.valueOf(socket.getReceiveBufferSize());
204             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
205                 return Boolean.valueOf(socket.getReuseAddress());
206             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
207                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
208             } else if (option.equals(StandardSocketOptions.SO_LINGER)) {
209                 return Integer.valueOf(socket.getSoLinger());
210             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
211                 return Integer.valueOf(socket.getTrafficClass());
212             } else if (option.equals(StandardSocketOptions.TCP_NODELAY)) {
213                 return Boolean.valueOf(socket.getTcpNoDelay());
214             } else {
<span class="line-modified">215                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
216             }
217         } else if  (type.equals(ServerSocket.class)) {
218             ServerSocket socket = (ServerSocket)s;
219             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
220             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
221 
222             if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
223                 return Integer.valueOf(socket.getReceiveBufferSize());
224             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
225                 return Boolean.valueOf(socket.getReuseAddress());
226             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
227                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
228             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
229                 return getServerSocketTrafficClass(socket);
230             } else {
<span class="line-modified">231                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
232             }
233         } else if  (type.equals(DatagramSocket.class)) {
234             DatagramSocket socket = (DatagramSocket)s;
235             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
236             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
237 
238             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
239                 return Integer.valueOf(socket.getSendBufferSize());
240             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
241                 return Integer.valueOf(socket.getReceiveBufferSize());
242             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
243                 return Boolean.valueOf(socket.getReuseAddress());


244             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
245                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
246             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
247                 return Integer.valueOf(socket.getTrafficClass());
248             } else {
<span class="line-modified">249                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
250             }
251 
252         } else if  (type.equals(MulticastSocket.class)) {
253             MulticastSocket socket = (MulticastSocket)s;
254             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
255             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
256 
257             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
258                 return Integer.valueOf(socket.getSendBufferSize());
259             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
260                 return Integer.valueOf(socket.getReceiveBufferSize());
261             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
262                 return Boolean.valueOf(socket.getReuseAddress());


263             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
264                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
265             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
266                 return Integer.valueOf(socket.getTrafficClass());
267             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_IF)) {
268                 return socket.getNetworkInterface();
269             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_TTL)) {
270                 return Integer.valueOf(socket.getTimeToLive());
271             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_LOOP)) {
<span class="line-modified">272                 return Boolean.valueOf(socket.getLoopbackMode());</span>
273             } else {
<span class="line-modified">274                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
275             }
276         }
<span class="line-modified">277         throw new RuntimeException(&quot;unexecpted socket type&quot;);</span>
278     }
279 
280     public static void main(String args[]) throws Exception {

281         doSocketTests();
282         doServerSocketTests();
<span class="line-modified">283         doDgSocketTests();</span>
<span class="line-modified">284         doMcSocketTests();</span>
285     }
286 
287     // Reflectively access jdk.net.Sockets.getOption so that the test can run
288     // without the jdk.net module.
289     static Object getServerSocketTrafficClass(ServerSocket ss) throws Exception {
290         try {
291             Class&lt;?&gt; c = Class.forName(&quot;jdk.net.Sockets&quot;);
292             Method m = c.getDeclaredMethod(&quot;getOption&quot;, ServerSocket.class, SocketOption.class);
293             return m.invoke(null, ss, StandardSocketOptions.IP_TOS);
294         } catch (ClassNotFoundException e) {
295             // Ok, jdk.net module not present, just fall back
296             System.out.println(&quot;jdk.net module not present, falling back.&quot;);
297             return Integer.valueOf(ss.getOption(StandardSocketOptions.IP_TOS));
298         } catch (ReflectiveOperationException e) {
299             throw new AssertionError(e);
300         }
301     }
302 }
</pre>
</td>
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8036979 8072384 8044773 8225214 8233296 8234083</span>
<span class="line-added"> 27  * @library /test/lib</span>
 28  * @requires !vm.graal.enabled
 29  * @run main/othervm -Xcheck:jni OptionsTest
<span class="line-added"> 30  * @run main/othervm -Djdk.net.usePlainSocketImpl OptionsTest</span>
 31  * @run main/othervm -Xcheck:jni -Djava.net.preferIPv4Stack=true OptionsTest
 32  * @run main/othervm --limit-modules=java.base OptionsTest
 33  */
 34 
 35 import java.lang.reflect.Method;
 36 import java.net.*;
 37 import java.util.*;
<span class="line-added"> 38 import jdk.test.lib.net.IPSupport;</span>
 39 
 40 public class OptionsTest {
 41 
<span class="line-modified"> 42     static class Test&lt;T&gt; {</span>
<span class="line-modified"> 43         final SocketOption&lt;T&gt; option;</span>
<span class="line-added"> 44         final T value;</span>
<span class="line-added"> 45         Test(SocketOption&lt;T&gt; option, T value) {</span>
 46             this.option = option;
<span class="line-modified"> 47             this.value = value;</span>
 48         }
<span class="line-modified"> 49         static &lt;T&gt; Test&lt;T&gt; create(SocketOption&lt;T&gt; option, T value) {</span>
<span class="line-modified"> 50             return new Test&lt;T&gt;(option, value);</span>
 51         }
<span class="line-modified"> 52 </span>

 53     }
 54 
 55     // The tests set the option using the new API, read back the set value
<span class="line-modified"> 56     // which could be different, and then use the legacy get API to check</span>
 57     // these values are the same
 58 
<span class="line-modified"> 59     static Test&lt;?&gt;[] socketTests = new Test&lt;?&gt;[] {</span>
 60         Test.create(StandardSocketOptions.SO_KEEPALIVE, Boolean.TRUE),
 61         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 62         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 63         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 64         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="line-added"> 65         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(-1)),</span>
<span class="line-added"> 66         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(0)),</span>
 67         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(80)),
<span class="line-modified"> 68         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="line-added"> 69         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="line-added"> 70         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
 71     };
 72 
<span class="line-modified"> 73     static Test&lt;?&gt;[] serverSocketTests = new Test&lt;?&gt;[] {</span>
 74         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 75         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 76         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="line-modified"> 77         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="line-added"> 78         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="line-added"> 79         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
 80     };
 81 
<span class="line-modified"> 82     static Test&lt;?&gt;[] datagramSocketTests = new Test&lt;?&gt;[] {</span>
 83         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 84         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 85         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 86         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="line-modified"> 87         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.FALSE),</span>
<span class="line-added"> 88         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.TRUE),</span>
<span class="line-added"> 89         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="line-added"> 90         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="line-added"> 91         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
 92     };
 93 
<span class="line-modified"> 94     static Test&lt;?&gt;[] multicastSocketTests = new Test&lt;?&gt;[] {</span>
<span class="line-added"> 95         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.FALSE),</span>
<span class="line-added"> 96         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.TRUE),</span>
 97         Test.create(StandardSocketOptions.IP_MULTICAST_IF, getNetworkInterface()),
<span class="line-added"> 98         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(0)),   // lower-bound</span>
 99         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(10)),
<span class="line-added">100         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(255)), //upper-bound</span>
101         Test.create(StandardSocketOptions.IP_MULTICAST_LOOP, Boolean.TRUE)
102     };
103 
104     static NetworkInterface getNetworkInterface() {
105         try {
106             Enumeration&lt;NetworkInterface&gt; nifs = NetworkInterface.getNetworkInterfaces();
107             while (nifs.hasMoreElements()) {
<span class="line-modified">108                 NetworkInterface ni = nifs.nextElement();</span>
109                 if (ni.supportsMulticast()) {
110                     return ni;
111                 }
112             }
113         } catch (Exception e) {
114         }
115         return null;
116     }
117 
<span class="line-added">118     static boolean okayToTest(Socket s, SocketOption&lt;?&gt; option) {</span>
<span class="line-added">119         if (option == StandardSocketOptions.SO_REUSEPORT) {</span>
<span class="line-added">120             // skip SO_REUSEPORT if option is not supported</span>
<span class="line-added">121             return s.supportedOptions().contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-added">122         }</span>
<span class="line-added">123         if (option == StandardSocketOptions.IP_TOS &amp;&amp; s.isConnected()) {</span>
<span class="line-added">124             // skip IP_TOS if connected</span>
<span class="line-added">125             return false;</span>
<span class="line-added">126         }</span>
<span class="line-added">127         return true;</span>
<span class="line-added">128     }</span>
<span class="line-added">129 </span>
<span class="line-added">130     static &lt;T&gt; void testEqual(SocketOption&lt;T&gt; option, T value1, T value2) {</span>
<span class="line-added">131         if (!value1.equals(value2)) {</span>
<span class="line-added">132             throw new RuntimeException(&quot;Test of &quot; + option.name() + &quot; failed: &quot;</span>
<span class="line-added">133                     + value1 + &quot; != &quot; + value2);</span>
<span class="line-added">134         }</span>
<span class="line-added">135     }</span>
<span class="line-added">136 </span>
<span class="line-added">137     static &lt;T&gt; void test(Socket s, Test&lt;T&gt; test) throws Exception {</span>
<span class="line-added">138         SocketOption&lt;T&gt; option = test.option;</span>
<span class="line-added">139         s.setOption(option, test.value);</span>
<span class="line-added">140         T value1 = s.getOption(test.option);</span>
<span class="line-added">141         T value2 = (T) legacyGetOption(Socket.class, s, test.option);</span>
<span class="line-added">142         testEqual(option, value1, value2);</span>
<span class="line-added">143     }</span>
<span class="line-added">144 </span>
<span class="line-added">145     static &lt;T&gt; void test(ServerSocket ss, Test&lt;T&gt; test) throws Exception {</span>
<span class="line-added">146         SocketOption&lt;T&gt; option = test.option;</span>
<span class="line-added">147         ss.setOption(option, test.value);</span>
<span class="line-added">148         T value1 = ss.getOption(test.option);</span>
<span class="line-added">149         T value2 = (T) legacyGetOption(ServerSocket.class, ss, test.option);</span>
<span class="line-added">150         testEqual(option, value1, value2);</span>
<span class="line-added">151     }</span>
<span class="line-added">152 </span>
<span class="line-added">153     static &lt;T&gt; void test(DatagramSocket ds, Test&lt;T&gt; test) throws Exception {</span>
<span class="line-added">154         SocketOption&lt;T&gt; option = test.option;</span>
<span class="line-added">155         ds.setOption(option, test.value);</span>
<span class="line-added">156         T value1 = ds.getOption(test.option);</span>
<span class="line-added">157         T value2 = (T) legacyGetOption(ds.getClass(), ds, test.option);</span>
<span class="line-added">158         testEqual(option, value1, value2);</span>
<span class="line-added">159     }</span>
<span class="line-added">160 </span>
<span class="line-added">161     // Tests default and negative values of SO_LINGER. All negative values should</span>
<span class="line-added">162     // retrieve as -1.</span>
<span class="line-added">163     static void testSoLingerValues() throws Exception {</span>
<span class="line-added">164         try (Socket s = new Socket()) {</span>
<span class="line-added">165             // retrieve without set</span>
<span class="line-added">166             int defaultValue = s.getOption(StandardSocketOptions.SO_LINGER);</span>
<span class="line-added">167             testEqual(StandardSocketOptions.SO_LINGER, -1, defaultValue);</span>
<span class="line-added">168 </span>
<span class="line-added">169             for (int v : List.of(-1, -2, -100, -65534, -65535, -65536, -100000)) {</span>
<span class="line-added">170                 System.out.println(&quot;Testing SO_LINGER with:&quot; + v);</span>
<span class="line-added">171                 s.setOption(StandardSocketOptions.SO_LINGER, v);</span>
<span class="line-added">172                 int value = s.getOption(StandardSocketOptions.SO_LINGER);</span>
<span class="line-added">173                 testEqual(StandardSocketOptions.SO_LINGER, -1, value);</span>
<span class="line-added">174             }</span>
<span class="line-added">175         }</span>
<span class="line-added">176     }</span>
<span class="line-added">177 </span>
<span class="line-added">178     @SuppressWarnings(&quot;try&quot;)</span>
179     static void doSocketTests() throws Exception {
<span class="line-modified">180         // unconnected socket</span>
<span class="line-modified">181         try (Socket s = new Socket()) {</span>
<span class="line-modified">182             for (Test&lt;?&gt; test : socketTests) {</span>
<span class="line-modified">183                 if (okayToTest(s, test.option)) {</span>
<span class="line-modified">184                     test(s, test);</span>













185                 }
186             }
187         }

188 
<span class="line-modified">189         // connected socket</span>
<span class="line-modified">190         try (ServerSocket ss = new ServerSocket()) {</span>
<span class="line-modified">191             var loopback = InetAddress.getLoopbackAddress();</span>
<span class="line-modified">192             ss.bind(new InetSocketAddress(loopback, 0));</span>
<span class="line-modified">193             try (Socket s1 = new Socket()) {</span>
<span class="line-modified">194                 s1.connect(ss.getLocalSocketAddress());</span>
<span class="line-modified">195                 try (Socket s2 = ss.accept()) {</span>
<span class="line-modified">196                     for (Test&lt;?&gt; test : socketTests) {</span>
<span class="line-modified">197                         if (okayToTest(s1, test.option)) {</span>
<span class="line-modified">198                             test(s1, test);</span>
<span class="line-modified">199                         }</span>





200                     }
201                 }
202             }
203         }
<span class="line-added">204 </span>
<span class="line-added">205         testSoLingerValues();</span>
206     }
207 
<span class="line-modified">208     static void doServerSocketTests() throws Exception {</span>
<span class="line-modified">209         try (ServerSocket ss = new ServerSocket(0)) {</span>
<span class="line-modified">210             Set&lt;SocketOption&lt;?&gt;&gt; options = ss.supportedOptions();</span>
<span class="line-modified">211             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-modified">212             for (Test&lt;?&gt; test : serverSocketTests) {</span>
<span class="line-modified">213                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="line-modified">214                     test(ss, test);</span>






215                 }
216             }
217         }
218     }
219 
<span class="line-modified">220     static void doDatagramSocketTests() throws Exception {</span>
<span class="line-modified">221         try (DatagramSocket ds = new DatagramSocket(0)) {</span>
<span class="line-modified">222             Set&lt;SocketOption&lt;?&gt;&gt; options = ds.supportedOptions();</span>


223             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
<span class="line-modified">224             for (Test&lt;?&gt; test : datagramSocketTests) {</span>

225                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {
<span class="line-modified">226                     test(ds, test);</span>









227                 }
228             }
229         }
230     }
231 
<span class="line-modified">232     static void doMulticastSocketTests() throws Exception {</span>
<span class="line-modified">233         try (MulticastSocket ms = new MulticastSocket(0)) {</span>
<span class="line-added">234             for (Test&lt;?&gt; test : multicastSocketTests) {</span>
<span class="line-added">235                 test(ms, test);</span>
<span class="line-added">236             }</span>
<span class="line-added">237         }</span>
<span class="line-added">238     }</span>
239 
<span class="line-modified">240     static Object legacyGetOption(Class&lt;?&gt; type, Object s, Object option) throws Exception {</span>

241         if (type.equals(Socket.class)) {
242             Socket socket = (Socket)s;
243             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
244             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
245 
246             if (option.equals(StandardSocketOptions.SO_KEEPALIVE)) {
247                 return Boolean.valueOf(socket.getKeepAlive());
248             } else if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
249                 return Integer.valueOf(socket.getSendBufferSize());
250             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
251                 return Integer.valueOf(socket.getReceiveBufferSize());
252             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
253                 return Boolean.valueOf(socket.getReuseAddress());
254             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
255                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
256             } else if (option.equals(StandardSocketOptions.SO_LINGER)) {
257                 return Integer.valueOf(socket.getSoLinger());
258             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
259                 return Integer.valueOf(socket.getTrafficClass());
260             } else if (option.equals(StandardSocketOptions.TCP_NODELAY)) {
261                 return Boolean.valueOf(socket.getTcpNoDelay());
262             } else {
<span class="line-modified">263                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
264             }
265         } else if  (type.equals(ServerSocket.class)) {
266             ServerSocket socket = (ServerSocket)s;
267             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
268             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
269 
270             if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
271                 return Integer.valueOf(socket.getReceiveBufferSize());
272             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
273                 return Boolean.valueOf(socket.getReuseAddress());
274             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
275                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
276             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
277                 return getServerSocketTrafficClass(socket);
278             } else {
<span class="line-modified">279                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
280             }
281         } else if  (type.equals(DatagramSocket.class)) {
282             DatagramSocket socket = (DatagramSocket)s;
283             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
284             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
285 
286             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
287                 return Integer.valueOf(socket.getSendBufferSize());
288             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
289                 return Integer.valueOf(socket.getReceiveBufferSize());
290             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
291                 return Boolean.valueOf(socket.getReuseAddress());
<span class="line-added">292             } else if (option.equals(StandardSocketOptions.SO_BROADCAST)) {</span>
<span class="line-added">293                 return Boolean.valueOf(socket.getBroadcast());</span>
294             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
295                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
296             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
297                 return Integer.valueOf(socket.getTrafficClass());
298             } else {
<span class="line-modified">299                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
300             }
301 
302         } else if  (type.equals(MulticastSocket.class)) {
303             MulticastSocket socket = (MulticastSocket)s;
304             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
305             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
306 
307             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
308                 return Integer.valueOf(socket.getSendBufferSize());
309             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
310                 return Integer.valueOf(socket.getReceiveBufferSize());
311             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
312                 return Boolean.valueOf(socket.getReuseAddress());
<span class="line-added">313             } else if (option.equals(StandardSocketOptions.SO_BROADCAST)) {</span>
<span class="line-added">314                 return Boolean.valueOf(socket.getBroadcast());</span>
315             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
316                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
317             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
318                 return Integer.valueOf(socket.getTrafficClass());
319             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_IF)) {
320                 return socket.getNetworkInterface();
321             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_TTL)) {
322                 return Integer.valueOf(socket.getTimeToLive());
323             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_LOOP)) {
<span class="line-modified">324                 return !Boolean.valueOf(socket.getLoopbackMode());</span>
325             } else {
<span class="line-modified">326                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
327             }
328         }
<span class="line-modified">329         throw new RuntimeException(&quot;unexpected socket type&quot;);</span>
330     }
331 
332     public static void main(String args[]) throws Exception {
<span class="line-added">333         IPSupport.throwSkippedExceptionIfNonOperational();</span>
334         doSocketTests();
335         doServerSocketTests();
<span class="line-modified">336         doDatagramSocketTests();</span>
<span class="line-modified">337         doMulticastSocketTests();</span>
338     }
339 
340     // Reflectively access jdk.net.Sockets.getOption so that the test can run
341     // without the jdk.net module.
342     static Object getServerSocketTrafficClass(ServerSocket ss) throws Exception {
343         try {
344             Class&lt;?&gt; c = Class.forName(&quot;jdk.net.Sockets&quot;);
345             Method m = c.getDeclaredMethod(&quot;getOption&quot;, ServerSocket.class, SocketOption.class);
346             return m.invoke(null, ss, StandardSocketOptions.IP_TOS);
347         } catch (ClassNotFoundException e) {
348             // Ok, jdk.net module not present, just fall back
349             System.out.println(&quot;jdk.net module not present, falling back.&quot;);
350             return Integer.valueOf(ss.getOption(StandardSocketOptions.IP_TOS));
351         } catch (ReflectiveOperationException e) {
352             throw new AssertionError(e);
353         }
354     }
355 }
</pre>
</td>
</tr>
</table>
<center><a href="MinimumRcvBufferSize.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SupportedOptionsSet.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>