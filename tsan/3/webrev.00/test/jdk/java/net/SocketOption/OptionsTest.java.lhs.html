<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/SocketOption/OptionsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8036979 8072384 8044773</span>

 27  * @requires !vm.graal.enabled
 28  * @run main/othervm -Xcheck:jni OptionsTest
<a name="2" id="anc2"></a>
 29  * @run main/othervm -Xcheck:jni -Djava.net.preferIPv4Stack=true OptionsTest
 30  * @run main/othervm --limit-modules=java.base OptionsTest
 31  */
 32 
 33 import java.lang.reflect.Method;
 34 import java.net.*;
 35 import java.util.*;
<a name="3" id="anc3"></a>
 36 
 37 public class OptionsTest {
 38 
<a name="4" id="anc4"></a><span class="line-modified"> 39     static class Test {</span>
<span class="line-modified"> 40         Test(SocketOption&lt;?&gt; option, Object testValue) {</span>


 41             this.option = option;
<a name="5" id="anc5"></a><span class="line-modified"> 42             this.testValue = testValue;</span>
 43         }
<a name="6" id="anc6"></a><span class="line-modified"> 44         static Test create (SocketOption&lt;?&gt; option, Object testValue) {</span>
<span class="line-modified"> 45             return new Test(option, testValue);</span>
 46         }
<a name="7" id="anc7"></a><span class="line-modified"> 47         Object option;</span>
<span class="line-removed"> 48         Object testValue;</span>
 49     }
 50 
 51     // The tests set the option using the new API, read back the set value
<a name="8" id="anc8"></a><span class="line-modified"> 52     // which could be diferent, and then use the legacy get API to check</span>
 53     // these values are the same
 54 
<a name="9" id="anc9"></a><span class="line-modified"> 55     static Test[] socketTests = new Test[] {</span>
 56         Test.create(StandardSocketOptions.SO_KEEPALIVE, Boolean.TRUE),
 57         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 58         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 59         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 60         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<a name="10" id="anc10"></a>

 61         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(80)),
<a name="11" id="anc11"></a><span class="line-modified"> 62         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>


 63     };
 64 
<a name="12" id="anc12"></a><span class="line-modified"> 65     static Test[] serverSocketTests = new Test[] {</span>
 66         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 67         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 68         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<a name="13" id="anc13"></a><span class="line-modified"> 69         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>


 70     };
 71 
<a name="14" id="anc14"></a><span class="line-modified"> 72     static Test[] dgSocketTests = new Test[] {</span>
 73         Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
 74         Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
 75         Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
 76         Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<a name="15" id="anc15"></a><span class="line-modified"> 77         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>




 78     };
 79 
<a name="16" id="anc16"></a><span class="line-modified"> 80     static Test[] mcSocketTests = new Test[] {</span>


 81         Test.create(StandardSocketOptions.IP_MULTICAST_IF, getNetworkInterface()),
<a name="17" id="anc17"></a>
 82         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(10)),
<a name="18" id="anc18"></a>
 83         Test.create(StandardSocketOptions.IP_MULTICAST_LOOP, Boolean.TRUE)
 84     };
 85 
 86     static NetworkInterface getNetworkInterface() {
 87         try {
 88             Enumeration&lt;NetworkInterface&gt; nifs = NetworkInterface.getNetworkInterfaces();
 89             while (nifs.hasMoreElements()) {
<a name="19" id="anc19"></a><span class="line-modified"> 90                 NetworkInterface ni = (NetworkInterface)nifs.nextElement();</span>
 91                 if (ni.supportsMulticast()) {
 92                     return ni;
 93                 }
 94             }
 95         } catch (Exception e) {
 96         }
 97         return null;
 98     }
 99 
<a name="20" id="anc20"></a>




























































100     static void doSocketTests() throws Exception {
<a name="21" id="anc21"></a><span class="line-modified">101         try (</span>
<span class="line-modified">102             ServerSocket srv = new ServerSocket(0);</span>
<span class="line-modified">103             Socket c = new Socket(InetAddress.getLoopbackAddress(), srv.getLocalPort());</span>
<span class="line-modified">104             Socket s = srv.accept();</span>
<span class="line-modified">105         ) {</span>
<span class="line-removed">106             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="line-removed">107             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-removed">108             for (int i=0; i&lt;socketTests.length; i++) {</span>
<span class="line-removed">109                 Test test = socketTests[i];</span>
<span class="line-removed">110                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="line-removed">111                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">112                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">113                     Object legacyget = legacyGetOption(Socket.class, c,test.option);</span>
<span class="line-removed">114                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">115                         Formatter f = new Formatter();</span>
<span class="line-removed">116                         f.format(&quot;S Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">117                         throw new RuntimeException(f.toString());</span>
<span class="line-removed">118                     }</span>
119                 }
120             }
121         }
<a name="22" id="anc22"></a><span class="line-removed">122     }</span>
123 
<a name="23" id="anc23"></a><span class="line-modified">124     static void doDgSocketTests() throws Exception {</span>
<span class="line-modified">125         try (</span>
<span class="line-modified">126             DatagramSocket c = new DatagramSocket(0);</span>
<span class="line-modified">127         ) {</span>
<span class="line-modified">128             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="line-modified">129             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-modified">130             for (int i=0; i&lt;dgSocketTests.length; i++) {</span>
<span class="line-modified">131                 Test test = dgSocketTests[i];</span>
<span class="line-modified">132                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="line-modified">133                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-modified">134                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">135                     Object legacyget = legacyGetOption(DatagramSocket.class, c,test.option);</span>
<span class="line-removed">136                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">137                         Formatter f = new Formatter();</span>
<span class="line-removed">138                         f.format(&quot;DG Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">139                         throw new RuntimeException(f.toString());</span>
140                     }
141                 }
142             }
143         }
<a name="24" id="anc24"></a>

144     }
145 
<a name="25" id="anc25"></a><span class="line-modified">146     static void doMcSocketTests() throws Exception {</span>
<span class="line-modified">147         try (</span>
<span class="line-modified">148             MulticastSocket c = new MulticastSocket(0);</span>
<span class="line-modified">149         ) {</span>
<span class="line-modified">150             for (int i=0; i&lt;mcSocketTests.length; i++) {</span>
<span class="line-modified">151                 Test test = mcSocketTests[i];</span>
<span class="line-modified">152                 c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">153                 Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">154                 Object legacyget = legacyGetOption(MulticastSocket.class, c,test.option);</span>
<span class="line-removed">155                 if (!getval.equals(legacyget)) {</span>
<span class="line-removed">156                     Formatter f = new Formatter();</span>
<span class="line-removed">157                     f.format(&quot;MC Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">158                     throw new RuntimeException(f.toString());</span>
159                 }
160             }
161         }
162     }
163 
<a name="26" id="anc26"></a><span class="line-modified">164     static void doServerSocketTests() throws Exception {</span>
<span class="line-modified">165         try (</span>
<span class="line-modified">166             ServerSocket c = new ServerSocket(0);</span>
<span class="line-removed">167         ) {</span>
<span class="line-removed">168             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
169             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
<a name="27" id="anc27"></a><span class="line-modified">170             for (int i=0; i&lt;serverSocketTests.length; i++) {</span>
<span class="line-removed">171                 Test test = serverSocketTests[i];</span>
172                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {
<a name="28" id="anc28"></a><span class="line-modified">173                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="line-removed">174                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="line-removed">175                     Object legacyget = legacyGetOption(</span>
<span class="line-removed">176                         ServerSocket.class, c, test.option</span>
<span class="line-removed">177                     );</span>
<span class="line-removed">178                     if (!getval.equals(legacyget)) {</span>
<span class="line-removed">179                         Formatter f = new Formatter();</span>
<span class="line-removed">180                         f.format(&quot;SS Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="line-removed">181                         throw new RuntimeException(f.toString());</span>
<span class="line-removed">182                     }</span>
183                 }
184             }
185         }
186     }
187 
<a name="29" id="anc29"></a><span class="line-modified">188     static Object legacyGetOption(</span>
<span class="line-modified">189         Class&lt;?&gt; type, Object s, Object option)</span>





190 
<a name="30" id="anc30"></a><span class="line-modified">191         throws Exception</span>
<span class="line-removed">192     {</span>
193         if (type.equals(Socket.class)) {
194             Socket socket = (Socket)s;
195             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
196             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
197 
198             if (option.equals(StandardSocketOptions.SO_KEEPALIVE)) {
199                 return Boolean.valueOf(socket.getKeepAlive());
200             } else if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
201                 return Integer.valueOf(socket.getSendBufferSize());
202             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
203                 return Integer.valueOf(socket.getReceiveBufferSize());
204             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
205                 return Boolean.valueOf(socket.getReuseAddress());
206             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
207                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
208             } else if (option.equals(StandardSocketOptions.SO_LINGER)) {
209                 return Integer.valueOf(socket.getSoLinger());
210             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
211                 return Integer.valueOf(socket.getTrafficClass());
212             } else if (option.equals(StandardSocketOptions.TCP_NODELAY)) {
213                 return Boolean.valueOf(socket.getTcpNoDelay());
214             } else {
<a name="31" id="anc31"></a><span class="line-modified">215                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
216             }
217         } else if  (type.equals(ServerSocket.class)) {
218             ServerSocket socket = (ServerSocket)s;
219             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
220             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
221 
222             if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
223                 return Integer.valueOf(socket.getReceiveBufferSize());
224             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
225                 return Boolean.valueOf(socket.getReuseAddress());
226             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
227                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
228             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
229                 return getServerSocketTrafficClass(socket);
230             } else {
<a name="32" id="anc32"></a><span class="line-modified">231                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
232             }
233         } else if  (type.equals(DatagramSocket.class)) {
234             DatagramSocket socket = (DatagramSocket)s;
235             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
236             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
237 
238             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
239                 return Integer.valueOf(socket.getSendBufferSize());
240             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
241                 return Integer.valueOf(socket.getReceiveBufferSize());
242             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
243                 return Boolean.valueOf(socket.getReuseAddress());
<a name="33" id="anc33"></a>

244             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
245                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
246             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
247                 return Integer.valueOf(socket.getTrafficClass());
248             } else {
<a name="34" id="anc34"></a><span class="line-modified">249                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
250             }
251 
252         } else if  (type.equals(MulticastSocket.class)) {
253             MulticastSocket socket = (MulticastSocket)s;
254             Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
255             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
256 
257             if (option.equals(StandardSocketOptions.SO_SNDBUF)) {
258                 return Integer.valueOf(socket.getSendBufferSize());
259             } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
260                 return Integer.valueOf(socket.getReceiveBufferSize());
261             } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
262                 return Boolean.valueOf(socket.getReuseAddress());
<a name="35" id="anc35"></a>

263             } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
264                 return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
265             } else if (option.equals(StandardSocketOptions.IP_TOS)) {
266                 return Integer.valueOf(socket.getTrafficClass());
267             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_IF)) {
268                 return socket.getNetworkInterface();
269             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_TTL)) {
270                 return Integer.valueOf(socket.getTimeToLive());
271             } else if (option.equals(StandardSocketOptions.IP_MULTICAST_LOOP)) {
<a name="36" id="anc36"></a><span class="line-modified">272                 return Boolean.valueOf(socket.getLoopbackMode());</span>
273             } else {
<a name="37" id="anc37"></a><span class="line-modified">274                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
275             }
276         }
<a name="38" id="anc38"></a><span class="line-modified">277         throw new RuntimeException(&quot;unexecpted socket type&quot;);</span>
278     }
279 
280     public static void main(String args[]) throws Exception {
<a name="39" id="anc39"></a>
281         doSocketTests();
282         doServerSocketTests();
<a name="40" id="anc40"></a><span class="line-modified">283         doDgSocketTests();</span>
<span class="line-modified">284         doMcSocketTests();</span>
285     }
286 
287     // Reflectively access jdk.net.Sockets.getOption so that the test can run
288     // without the jdk.net module.
289     static Object getServerSocketTrafficClass(ServerSocket ss) throws Exception {
290         try {
291             Class&lt;?&gt; c = Class.forName(&quot;jdk.net.Sockets&quot;);
292             Method m = c.getDeclaredMethod(&quot;getOption&quot;, ServerSocket.class, SocketOption.class);
293             return m.invoke(null, ss, StandardSocketOptions.IP_TOS);
294         } catch (ClassNotFoundException e) {
295             // Ok, jdk.net module not present, just fall back
296             System.out.println(&quot;jdk.net module not present, falling back.&quot;);
297             return Integer.valueOf(ss.getOption(StandardSocketOptions.IP_TOS));
298         } catch (ReflectiveOperationException e) {
299             throw new AssertionError(e);
300         }
301     }
302 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>