<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/java/net/SocketOption/ImmutableOptions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24  /*
 25  * @test
 26  * @bug 8148609
 27  * @summary Assert that the set of socket options are immutable
 28  * @run testng/othervm ImmutableOptions
 29  * @run testng/othervm -Djava.net.preferIPv4Stack=true ImmutableOptions
 30  */
 31 import java.io.IOException;
 32 import java.io.InputStream;
 33 import java.io.OutputStream;
 34 import java.net.*;
 35 import java.util.Set;
 36 
 37 import org.testng.annotations.BeforeTest;
 38 import org.testng.annotations.Test;
 39 
 40 public class ImmutableOptions {
 41 
 42     @BeforeTest
 43     void setupServerSocketFactory() throws IOException {
 44         ServerSocket.setSocketFactory(new ServerSocketImplFactory());
 45     }
 46 
 47     @Test(expectedExceptions = UnsupportedOperationException.class)
 48     public void socketThrows() throws IOException {
 49         CustomSocketImpl impl = new CustomSocketImpl();
 50         Socket socket = new CustomSocket(impl);
 51         socket.supportedOptions().clear();
 52     }
 53 
 54     @Test(expectedExceptions = UnsupportedOperationException.class)
 55     public void socketImplThrows() throws IOException {
 56         CustomSocketImpl impl = new CustomSocketImpl();
 57         impl.supportedOptions().clear();
 58     }
 59 
 60     @Test(expectedExceptions = UnsupportedOperationException.class)
 61     public void serverSocketThrows() throws IOException {
 62         ServerSocket ss = new ServerSocket();
 63         ss.supportedOptions().clear();
 64     }
 65 
 66     @Test(expectedExceptions = UnsupportedOperationException.class)
 67     public void serverSocketImplThrows() throws IOException {
 68         ServerSocket ss = new ServerSocket();
 69         ServerSocketImplFactory.mostRecentlyCreated.supportedOptions().clear();
 70     }
 71 
 72     @Test(expectedExceptions = UnsupportedOperationException.class)
 73     public void datagramSocketThrows() throws IOException {
 74         CustomDatagramSocketImpl impl = new CustomDatagramSocketImpl();
 75         DatagramSocket socket = new CustomDatagramSocket(impl);
 76         socket.supportedOptions().clear();
 77     }
 78 
 79     @Test(expectedExceptions = UnsupportedOperationException.class)
 80     public void datagramSocketImplThrows() throws IOException {
 81         CustomDatagramSocketImpl impl = new CustomDatagramSocketImpl();
 82         impl.supportedOptions().clear();
 83     }
 84 
 85 
 86     // Socket descendants
 87     static class CustomSocket extends Socket {
 88         public CustomSocket(SocketImpl impl) throws IOException {
 89             super(impl);
 90         }
 91     }
 92 
 93     static class CustomDatagramSocket extends DatagramSocket {
 94         public CustomDatagramSocket(DatagramSocketImpl impl) {
 95             super(impl);
 96         }
 97     }
 98 
 99     static class ServerSocketImplFactory implements SocketImplFactory {
100         static volatile CustomSocketImpl mostRecentlyCreated;
101 
102         @Override public SocketImpl createSocketImpl() {
103             return mostRecentlyCreated = new CustomSocketImpl();
104         }
105     }
106 
107     // Custom impl&#39;s
108     static class CustomSocketImpl extends SocketImpl {
109         // The only method interesting to this test.
110         @Override public Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {
111             return super.supportedOptions();
112         }
113 
114         public void create(boolean stream) throws IOException { }
115 
116         public void connect(String host, int port) throws IOException { }
117 
118         public void connect(InetAddress addr, int port) throws IOException { }
119 
120         public void connect(SocketAddress addr, int timeout) throws IOException { }
121 
122         public void bind(InetAddress host, int port) throws IOException { }
123 
124         public void listen(int backlog) throws IOException { }
125 
126         public void accept(SocketImpl s) throws IOException { }
127 
128         public InputStream getInputStream() throws IOException { return null; }
129 
130         public OutputStream getOutputStream() throws IOException { return null; }
131 
132         public int available() throws IOException { return 0; }
133 
134         public void close() throws IOException { }
135 
136         public void sendUrgentData(int data) throws IOException { }
137 
138         public Object getOption(int i) throws SocketException { return null; }
139 
140         public void setOption(int i, Object o) throws SocketException { }
141     }
142 
143     static class CustomDatagramSocketImpl extends DatagramSocketImpl {
144         // The only method interesting to this test.
145         @Override public Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {
146             return super.supportedOptions();
147         }
148 
149         protected void create() throws SocketException { }
150 
151         protected void bind(int lport, InetAddress laddr) throws SocketException { }
152 
153         protected void send(DatagramPacket p) throws IOException { }
154 
155         protected int peek(InetAddress i) throws IOException { return 0; }
156 
157         protected int peekData(DatagramPacket p) throws IOException { return 0; }
158 
159         protected void receive(DatagramPacket p) throws IOException { }
160 
161         protected void setTTL(byte ttl) throws IOException { }
162 
163         protected byte getTTL() throws IOException { return 0; }
164 
165         protected void setTimeToLive(int ttl) throws IOException { }
166 
167         protected int getTimeToLive() throws IOException { return 0; }
168 
169         protected void join(InetAddress inetaddr) throws IOException { }
170 
171         protected void leave(InetAddress inetaddr) throws IOException { }
172 
173         protected void joinGroup(SocketAddress x, NetworkInterface y)
174             throws IOException { }
175 
176         protected void leaveGroup(SocketAddress x, NetworkInterface y)
177             throws IOException { }
178 
179         protected void close() { }
180 
181         public void setOption(int optID, Object value) throws SocketException { }
182 
183         public Object getOption(int optID) throws SocketException { return null; }
184     }
185 }
    </pre>
  </body>
</html>