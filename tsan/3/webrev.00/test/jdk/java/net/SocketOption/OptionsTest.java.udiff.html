<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/net/SocketOption/OptionsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MinimumRcvBufferSize.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SupportedOptionsSet.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/SocketOption/OptionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -21,177 +21,225 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8036979 8072384 8044773</span>
<span class="udiff-line-modified-added">+  * @bug 8036979 8072384 8044773 8225214 8233296 8234083</span>
<span class="udiff-line-added">+  * @library /test/lib</span>
   * @requires !vm.graal.enabled
   * @run main/othervm -Xcheck:jni OptionsTest
<span class="udiff-line-added">+  * @run main/othervm -Djdk.net.usePlainSocketImpl OptionsTest</span>
   * @run main/othervm -Xcheck:jni -Djava.net.preferIPv4Stack=true OptionsTest
   * @run main/othervm --limit-modules=java.base OptionsTest
   */
  
  import java.lang.reflect.Method;
  import java.net.*;
  import java.util.*;
<span class="udiff-line-added">+ import jdk.test.lib.net.IPSupport;</span>
  
  public class OptionsTest {
  
<span class="udiff-line-modified-removed">-     static class Test {</span>
<span class="udiff-line-modified-removed">-         Test(SocketOption&lt;?&gt; option, Object testValue) {</span>
<span class="udiff-line-modified-added">+     static class Test&lt;T&gt; {</span>
<span class="udiff-line-modified-added">+         final SocketOption&lt;T&gt; option;</span>
<span class="udiff-line-added">+         final T value;</span>
<span class="udiff-line-added">+         Test(SocketOption&lt;T&gt; option, T value) {</span>
              this.option = option;
<span class="udiff-line-modified-removed">-             this.testValue = testValue;</span>
<span class="udiff-line-modified-added">+             this.value = value;</span>
          }
<span class="udiff-line-modified-removed">-         static Test create (SocketOption&lt;?&gt; option, Object testValue) {</span>
<span class="udiff-line-modified-removed">-             return new Test(option, testValue);</span>
<span class="udiff-line-modified-added">+         static &lt;T&gt; Test&lt;T&gt; create(SocketOption&lt;T&gt; option, T value) {</span>
<span class="udiff-line-modified-added">+             return new Test&lt;T&gt;(option, value);</span>
          }
<span class="udiff-line-modified-removed">-         Object option;</span>
<span class="udiff-line-removed">-         Object testValue;</span>
<span class="udiff-line-modified-added">+ </span>
      }
  
      // The tests set the option using the new API, read back the set value
<span class="udiff-line-modified-removed">-     // which could be diferent, and then use the legacy get API to check</span>
<span class="udiff-line-modified-added">+     // which could be different, and then use the legacy get API to check</span>
      // these values are the same
  
<span class="udiff-line-modified-removed">-     static Test[] socketTests = new Test[] {</span>
<span class="udiff-line-modified-added">+     static Test&lt;?&gt;[] socketTests = new Test&lt;?&gt;[] {</span>
          Test.create(StandardSocketOptions.SO_KEEPALIVE, Boolean.TRUE),
          Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
          Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
          Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
          Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(-1)),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(0)),</span>
          Test.create(StandardSocketOptions.SO_LINGER, Integer.valueOf(80)),
<span class="udiff-line-modified-removed">-         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>
<span class="udiff-line-modified-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
      };
  
<span class="udiff-line-modified-removed">-     static Test[] serverSocketTests = new Test[] {</span>
<span class="udiff-line-modified-added">+     static Test&lt;?&gt;[] serverSocketTests = new Test&lt;?&gt;[] {</span>
          Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
          Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
          Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="udiff-line-modified-removed">-         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>
<span class="udiff-line-modified-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
      };
  
<span class="udiff-line-modified-removed">-     static Test[] dgSocketTests = new Test[] {</span>
<span class="udiff-line-modified-added">+     static Test&lt;?&gt;[] datagramSocketTests = new Test&lt;?&gt;[] {</span>
          Test.create(StandardSocketOptions.SO_SNDBUF, Integer.valueOf(10 * 100)),
          Test.create(StandardSocketOptions.SO_RCVBUF, Integer.valueOf(8 * 100)),
          Test.create(StandardSocketOptions.SO_REUSEADDR, Boolean.FALSE),
          Test.create(StandardSocketOptions.SO_REUSEPORT, Boolean.FALSE),
<span class="udiff-line-modified-removed">-         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100))</span>
<span class="udiff-line-modified-added">+         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.FALSE),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.TRUE),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(0)),  // lower-bound</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(100)),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_TOS, Integer.valueOf(255))  //upper-bound</span>
      };
  
<span class="udiff-line-modified-removed">-     static Test[] mcSocketTests = new Test[] {</span>
<span class="udiff-line-modified-added">+     static Test&lt;?&gt;[] multicastSocketTests = new Test&lt;?&gt;[] {</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.FALSE),</span>
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.SO_BROADCAST, Boolean.TRUE),</span>
          Test.create(StandardSocketOptions.IP_MULTICAST_IF, getNetworkInterface()),
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(0)),   // lower-bound</span>
          Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(10)),
<span class="udiff-line-added">+         Test.create(StandardSocketOptions.IP_MULTICAST_TTL, Integer.valueOf(255)), //upper-bound</span>
          Test.create(StandardSocketOptions.IP_MULTICAST_LOOP, Boolean.TRUE)
      };
  
      static NetworkInterface getNetworkInterface() {
          try {
              Enumeration&lt;NetworkInterface&gt; nifs = NetworkInterface.getNetworkInterfaces();
              while (nifs.hasMoreElements()) {
<span class="udiff-line-modified-removed">-                 NetworkInterface ni = (NetworkInterface)nifs.nextElement();</span>
<span class="udiff-line-modified-added">+                 NetworkInterface ni = nifs.nextElement();</span>
                  if (ni.supportsMulticast()) {
                      return ni;
                  }
              }
          } catch (Exception e) {
          }
          return null;
      }
  
<span class="udiff-line-added">+     static boolean okayToTest(Socket s, SocketOption&lt;?&gt; option) {</span>
<span class="udiff-line-added">+         if (option == StandardSocketOptions.SO_REUSEPORT) {</span>
<span class="udiff-line-added">+             // skip SO_REUSEPORT if option is not supported</span>
<span class="udiff-line-added">+             return s.supportedOptions().contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (option == StandardSocketOptions.IP_TOS &amp;&amp; s.isConnected()) {</span>
<span class="udiff-line-added">+             // skip IP_TOS if connected</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static &lt;T&gt; void testEqual(SocketOption&lt;T&gt; option, T value1, T value2) {</span>
<span class="udiff-line-added">+         if (!value1.equals(value2)) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Test of &quot; + option.name() + &quot; failed: &quot;</span>
<span class="udiff-line-added">+                     + value1 + &quot; != &quot; + value2);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static &lt;T&gt; void test(Socket s, Test&lt;T&gt; test) throws Exception {</span>
<span class="udiff-line-added">+         SocketOption&lt;T&gt; option = test.option;</span>
<span class="udiff-line-added">+         s.setOption(option, test.value);</span>
<span class="udiff-line-added">+         T value1 = s.getOption(test.option);</span>
<span class="udiff-line-added">+         T value2 = (T) legacyGetOption(Socket.class, s, test.option);</span>
<span class="udiff-line-added">+         testEqual(option, value1, value2);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static &lt;T&gt; void test(ServerSocket ss, Test&lt;T&gt; test) throws Exception {</span>
<span class="udiff-line-added">+         SocketOption&lt;T&gt; option = test.option;</span>
<span class="udiff-line-added">+         ss.setOption(option, test.value);</span>
<span class="udiff-line-added">+         T value1 = ss.getOption(test.option);</span>
<span class="udiff-line-added">+         T value2 = (T) legacyGetOption(ServerSocket.class, ss, test.option);</span>
<span class="udiff-line-added">+         testEqual(option, value1, value2);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static &lt;T&gt; void test(DatagramSocket ds, Test&lt;T&gt; test) throws Exception {</span>
<span class="udiff-line-added">+         SocketOption&lt;T&gt; option = test.option;</span>
<span class="udiff-line-added">+         ds.setOption(option, test.value);</span>
<span class="udiff-line-added">+         T value1 = ds.getOption(test.option);</span>
<span class="udiff-line-added">+         T value2 = (T) legacyGetOption(ds.getClass(), ds, test.option);</span>
<span class="udiff-line-added">+         testEqual(option, value1, value2);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Tests default and negative values of SO_LINGER. All negative values should</span>
<span class="udiff-line-added">+     // retrieve as -1.</span>
<span class="udiff-line-added">+     static void testSoLingerValues() throws Exception {</span>
<span class="udiff-line-added">+         try (Socket s = new Socket()) {</span>
<span class="udiff-line-added">+             // retrieve without set</span>
<span class="udiff-line-added">+             int defaultValue = s.getOption(StandardSocketOptions.SO_LINGER);</span>
<span class="udiff-line-added">+             testEqual(StandardSocketOptions.SO_LINGER, -1, defaultValue);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             for (int v : List.of(-1, -2, -100, -65534, -65535, -65536, -100000)) {</span>
<span class="udiff-line-added">+                 System.out.println(&quot;Testing SO_LINGER with:&quot; + v);</span>
<span class="udiff-line-added">+                 s.setOption(StandardSocketOptions.SO_LINGER, v);</span>
<span class="udiff-line-added">+                 int value = s.getOption(StandardSocketOptions.SO_LINGER);</span>
<span class="udiff-line-added">+                 testEqual(StandardSocketOptions.SO_LINGER, -1, value);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @SuppressWarnings(&quot;try&quot;)</span>
      static void doSocketTests() throws Exception {
<span class="udiff-line-modified-removed">-         try (</span>
<span class="udiff-line-modified-removed">-             ServerSocket srv = new ServerSocket(0);</span>
<span class="udiff-line-modified-removed">-             Socket c = new Socket(InetAddress.getLoopbackAddress(), srv.getLocalPort());</span>
<span class="udiff-line-modified-removed">-             Socket s = srv.accept();</span>
<span class="udiff-line-modified-removed">-         ) {</span>
<span class="udiff-line-removed">-             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="udiff-line-removed">-             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="udiff-line-removed">-             for (int i=0; i&lt;socketTests.length; i++) {</span>
<span class="udiff-line-removed">-                 Test test = socketTests[i];</span>
<span class="udiff-line-removed">-                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="udiff-line-removed">-                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="udiff-line-removed">-                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="udiff-line-removed">-                     Object legacyget = legacyGetOption(Socket.class, c,test.option);</span>
<span class="udiff-line-removed">-                     if (!getval.equals(legacyget)) {</span>
<span class="udiff-line-removed">-                         Formatter f = new Formatter();</span>
<span class="udiff-line-removed">-                         f.format(&quot;S Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="udiff-line-removed">-                         throw new RuntimeException(f.toString());</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+         // unconnected socket</span>
<span class="udiff-line-modified-added">+         try (Socket s = new Socket()) {</span>
<span class="udiff-line-modified-added">+             for (Test&lt;?&gt; test : socketTests) {</span>
<span class="udiff-line-modified-added">+                 if (okayToTest(s, test.option)) {</span>
<span class="udiff-line-modified-added">+                     test(s, test);</span>
                  }
              }
          }
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     static void doDgSocketTests() throws Exception {</span>
<span class="udiff-line-modified-removed">-         try (</span>
<span class="udiff-line-modified-removed">-             DatagramSocket c = new DatagramSocket(0);</span>
<span class="udiff-line-modified-removed">-         ) {</span>
<span class="udiff-line-modified-removed">-             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="udiff-line-modified-removed">-             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="udiff-line-modified-removed">-             for (int i=0; i&lt;dgSocketTests.length; i++) {</span>
<span class="udiff-line-modified-removed">-                 Test test = dgSocketTests[i];</span>
<span class="udiff-line-modified-removed">-                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="udiff-line-modified-removed">-                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="udiff-line-modified-removed">-                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="udiff-line-removed">-                     Object legacyget = legacyGetOption(DatagramSocket.class, c,test.option);</span>
<span class="udiff-line-removed">-                     if (!getval.equals(legacyget)) {</span>
<span class="udiff-line-removed">-                         Formatter f = new Formatter();</span>
<span class="udiff-line-removed">-                         f.format(&quot;DG Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="udiff-line-removed">-                         throw new RuntimeException(f.toString());</span>
<span class="udiff-line-modified-added">+         // connected socket</span>
<span class="udiff-line-modified-added">+         try (ServerSocket ss = new ServerSocket()) {</span>
<span class="udiff-line-modified-added">+             var loopback = InetAddress.getLoopbackAddress();</span>
<span class="udiff-line-modified-added">+             ss.bind(new InetSocketAddress(loopback, 0));</span>
<span class="udiff-line-modified-added">+             try (Socket s1 = new Socket()) {</span>
<span class="udiff-line-modified-added">+                 s1.connect(ss.getLocalSocketAddress());</span>
<span class="udiff-line-modified-added">+                 try (Socket s2 = ss.accept()) {</span>
<span class="udiff-line-modified-added">+                     for (Test&lt;?&gt; test : socketTests) {</span>
<span class="udiff-line-modified-added">+                         if (okayToTest(s1, test.option)) {</span>
<span class="udiff-line-modified-added">+                             test(s1, test);</span>
<span class="udiff-line-modified-added">+                         }</span>
                      }
                  }
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         testSoLingerValues();</span>
      }
  
<span class="udiff-line-modified-removed">-     static void doMcSocketTests() throws Exception {</span>
<span class="udiff-line-modified-removed">-         try (</span>
<span class="udiff-line-modified-removed">-             MulticastSocket c = new MulticastSocket(0);</span>
<span class="udiff-line-modified-removed">-         ) {</span>
<span class="udiff-line-modified-removed">-             for (int i=0; i&lt;mcSocketTests.length; i++) {</span>
<span class="udiff-line-modified-removed">-                 Test test = mcSocketTests[i];</span>
<span class="udiff-line-modified-removed">-                 c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="udiff-line-removed">-                 Object getval = c.getOption((SocketOption)test.option);</span>
<span class="udiff-line-removed">-                 Object legacyget = legacyGetOption(MulticastSocket.class, c,test.option);</span>
<span class="udiff-line-removed">-                 if (!getval.equals(legacyget)) {</span>
<span class="udiff-line-removed">-                     Formatter f = new Formatter();</span>
<span class="udiff-line-removed">-                     f.format(&quot;MC Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="udiff-line-removed">-                     throw new RuntimeException(f.toString());</span>
<span class="udiff-line-modified-added">+     static void doServerSocketTests() throws Exception {</span>
<span class="udiff-line-modified-added">+         try (ServerSocket ss = new ServerSocket(0)) {</span>
<span class="udiff-line-modified-added">+             Set&lt;SocketOption&lt;?&gt;&gt; options = ss.supportedOptions();</span>
<span class="udiff-line-modified-added">+             boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="udiff-line-modified-added">+             for (Test&lt;?&gt; test : serverSocketTests) {</span>
<span class="udiff-line-modified-added">+                 if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {</span>
<span class="udiff-line-modified-added">+                     test(ss, test);</span>
                  }
              }
          }
      }
  
<span class="udiff-line-modified-removed">-     static void doServerSocketTests() throws Exception {</span>
<span class="udiff-line-modified-removed">-         try (</span>
<span class="udiff-line-modified-removed">-             ServerSocket c = new ServerSocket(0);</span>
<span class="udiff-line-removed">-         ) {</span>
<span class="udiff-line-removed">-             Set&lt;SocketOption&lt;?&gt;&gt; options = c.supportedOptions();</span>
<span class="udiff-line-modified-added">+     static void doDatagramSocketTests() throws Exception {</span>
<span class="udiff-line-modified-added">+         try (DatagramSocket ds = new DatagramSocket(0)) {</span>
<span class="udiff-line-modified-added">+             Set&lt;SocketOption&lt;?&gt;&gt; options = ds.supportedOptions();</span>
              boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
<span class="udiff-line-modified-removed">-             for (int i=0; i&lt;serverSocketTests.length; i++) {</span>
<span class="udiff-line-removed">-                 Test test = serverSocketTests[i];</span>
<span class="udiff-line-modified-added">+             for (Test&lt;?&gt; test : datagramSocketTests) {</span>
                  if (!(test.option == StandardSocketOptions.SO_REUSEPORT &amp;&amp; !reuseport)) {
<span class="udiff-line-modified-removed">-                     c.setOption((SocketOption)test.option, test.testValue);</span>
<span class="udiff-line-removed">-                     Object getval = c.getOption((SocketOption)test.option);</span>
<span class="udiff-line-removed">-                     Object legacyget = legacyGetOption(</span>
<span class="udiff-line-removed">-                         ServerSocket.class, c, test.option</span>
<span class="udiff-line-removed">-                     );</span>
<span class="udiff-line-removed">-                     if (!getval.equals(legacyget)) {</span>
<span class="udiff-line-removed">-                         Formatter f = new Formatter();</span>
<span class="udiff-line-removed">-                         f.format(&quot;SS Err %d: %s/%s&quot;, i, getval, legacyget);</span>
<span class="udiff-line-removed">-                         throw new RuntimeException(f.toString());</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+                     test(ds, test);</span>
                  }
              }
          }
      }
  
<span class="udiff-line-modified-removed">-     static Object legacyGetOption(</span>
<span class="udiff-line-modified-removed">-         Class&lt;?&gt; type, Object s, Object option)</span>
<span class="udiff-line-modified-added">+     static void doMulticastSocketTests() throws Exception {</span>
<span class="udiff-line-modified-added">+         try (MulticastSocket ms = new MulticastSocket(0)) {</span>
<span class="udiff-line-added">+             for (Test&lt;?&gt; test : multicastSocketTests) {</span>
<span class="udiff-line-added">+                 test(ms, test);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         throws Exception</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-modified-added">+     static Object legacyGetOption(Class&lt;?&gt; type, Object s, Object option) throws Exception {</span>
          if (type.equals(Socket.class)) {
              Socket socket = (Socket)s;
              Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
              boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -210,11 +258,11 @@</span>
              } else if (option.equals(StandardSocketOptions.IP_TOS)) {
                  return Integer.valueOf(socket.getTrafficClass());
              } else if (option.equals(StandardSocketOptions.TCP_NODELAY)) {
                  return Boolean.valueOf(socket.getTcpNoDelay());
              } else {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
              }
          } else if  (type.equals(ServerSocket.class)) {
              ServerSocket socket = (ServerSocket)s;
              Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
              boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -226,11 +274,11 @@</span>
              } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
                  return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
              } else if (option.equals(StandardSocketOptions.IP_TOS)) {
                  return getServerSocketTrafficClass(socket);
              } else {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
              }
          } else if  (type.equals(DatagramSocket.class)) {
              DatagramSocket socket = (DatagramSocket)s;
              Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
              boolean reuseport = options.contains(StandardSocketOptions.SO_REUSEPORT);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -239,16 +287,18 @@</span>
                  return Integer.valueOf(socket.getSendBufferSize());
              } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
                  return Integer.valueOf(socket.getReceiveBufferSize());
              } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
                  return Boolean.valueOf(socket.getReuseAddress());
<span class="udiff-line-added">+             } else if (option.equals(StandardSocketOptions.SO_BROADCAST)) {</span>
<span class="udiff-line-added">+                 return Boolean.valueOf(socket.getBroadcast());</span>
              } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
                  return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
              } else if (option.equals(StandardSocketOptions.IP_TOS)) {
                  return Integer.valueOf(socket.getTrafficClass());
              } else {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
              }
  
          } else if  (type.equals(MulticastSocket.class)) {
              MulticastSocket socket = (MulticastSocket)s;
              Set&lt;SocketOption&lt;?&gt;&gt; options = socket.supportedOptions();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,32 +308,35 @@</span>
                  return Integer.valueOf(socket.getSendBufferSize());
              } else if (option.equals(StandardSocketOptions.SO_RCVBUF)) {
                  return Integer.valueOf(socket.getReceiveBufferSize());
              } else if (option.equals(StandardSocketOptions.SO_REUSEADDR)) {
                  return Boolean.valueOf(socket.getReuseAddress());
<span class="udiff-line-added">+             } else if (option.equals(StandardSocketOptions.SO_BROADCAST)) {</span>
<span class="udiff-line-added">+                 return Boolean.valueOf(socket.getBroadcast());</span>
              } else if (option.equals(StandardSocketOptions.SO_REUSEPORT) &amp;&amp; reuseport) {
                  return Boolean.valueOf(socket.getOption(StandardSocketOptions.SO_REUSEPORT));
              } else if (option.equals(StandardSocketOptions.IP_TOS)) {
                  return Integer.valueOf(socket.getTrafficClass());
              } else if (option.equals(StandardSocketOptions.IP_MULTICAST_IF)) {
                  return socket.getNetworkInterface();
              } else if (option.equals(StandardSocketOptions.IP_MULTICAST_TTL)) {
                  return Integer.valueOf(socket.getTimeToLive());
              } else if (option.equals(StandardSocketOptions.IP_MULTICAST_LOOP)) {
<span class="udiff-line-modified-removed">-                 return Boolean.valueOf(socket.getLoopbackMode());</span>
<span class="udiff-line-modified-added">+                 return !Boolean.valueOf(socket.getLoopbackMode());</span>
              } else {
<span class="udiff-line-modified-removed">-                 throw new RuntimeException(&quot;unexecpted socket option&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new RuntimeException(&quot;unexpected socket option&quot;);</span>
              }
          }
<span class="udiff-line-modified-removed">-         throw new RuntimeException(&quot;unexecpted socket type&quot;);</span>
<span class="udiff-line-modified-added">+         throw new RuntimeException(&quot;unexpected socket type&quot;);</span>
      }
  
      public static void main(String args[]) throws Exception {
<span class="udiff-line-added">+         IPSupport.throwSkippedExceptionIfNonOperational();</span>
          doSocketTests();
          doServerSocketTests();
<span class="udiff-line-modified-removed">-         doDgSocketTests();</span>
<span class="udiff-line-modified-removed">-         doMcSocketTests();</span>
<span class="udiff-line-modified-added">+         doDatagramSocketTests();</span>
<span class="udiff-line-modified-added">+         doMulticastSocketTests();</span>
      }
  
      // Reflectively access jdk.net.Sockets.getOption so that the test can run
      // without the jdk.net module.
      static Object getServerSocketTrafficClass(ServerSocket ss) throws Exception {
</pre>
<center><a href="MinimumRcvBufferSize.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="SupportedOptionsSet.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>