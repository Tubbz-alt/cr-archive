<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/net/URLConnection/ZeroContentLength.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4507412
 27  * @bug 4506998
 28  * @summary Check that a 304 &quot;Not-Modified&quot; response from a server
 29  *          doesn&#39;t cause http client to close a keep-alive
 30  *          connection.
 31  *          Check that a content-length of 0 results in an
 32  *          empty input stream.
<a name="2" id="anc2"></a>


 33  */
<a name="3" id="anc3"></a>
 34 import java.net.*;
 35 import java.io.*;
<a name="4" id="anc4"></a>
 36 
 37 public class ZeroContentLength {
 38 
 39     /*
 40      * Is debugging enabled - start with -d to enable.
 41      */
 42     static boolean debug = false;
 43 
 44     static void debug(String msg) {
 45         if (debug)
 46             System.out.println(msg);
 47     }
 48 
 49     /*
 50      * The response string and content-length that
 51      * the server should return;
 52      */
 53     static String response;
 54     static int contentLength;
 55 
 56     static synchronized void setResponse(String rsp, int cl) {
 57         response = rsp;
 58         contentLength = cl;
 59     }
 60 
 61     static synchronized String getResponse() {
 62         return response;
 63     }
 64 
 65     static synchronized int getContentLength() {
 66         return contentLength;
 67     }
 68 
 69     /*
 70      * Worker thread to service single connection - can service
 71      * multiple http requests on same connection.
 72      */
 73     class Worker extends Thread {
 74         Socket s;
 75         int id;
 76 
 77         Worker(Socket s, int id) {
 78             this.s = s;
 79             this.id = id;
 80         }
 81 
 82         final int CR = &#39;\r&#39;;
 83         final int LF = &#39;\n&#39;;
 84 
 85         public void run() {
 86             try {
 87 
 88                 s.setSoTimeout(2000);
 89                 int max = 20; // there should only be 20 connections
 90                 InputStream in = new BufferedInputStream(s.getInputStream());
 91 
 92                 for (;;) {
 93                     // read entire request from client, until CR LF CR LF
 94                     int c, total=0;
 95 
 96                     try {
 97                         while ((c = in.read()) &gt; 0) {
 98                             total++;
 99                             if (c == CR) {
100                                 if ((c = in.read()) &gt; 0) {
101                                     total++;
102                                     if (c == LF) {
103                                         if ((c = in.read()) &gt; 0) {
104                                             total++;
105                                             if (c == CR) {
106                                                 if ((c = in.read()) &gt; 0) {
107                                                     total++;
108                                                     if (c == LF) {
109                                                         break;
110                                                     }
111                                                 }
112                                             }
113                                         }
114                                     }
115                                 }
116                             }
117 
118                         }
119                     } catch (SocketTimeoutException e) {}
120 
121                     debug(&quot;worker &quot; + id +
122                         &quot;: Read request from client &quot; +
123                         &quot;(&quot; + total + &quot; bytes).&quot;);
124 
125                     if (total == 0) {
126                         debug(&quot;worker: &quot; + id + &quot;: Shutdown&quot;);
127                         return;
128                     }
129 
130                     // response to client
131                     PrintStream out = new PrintStream(
132                                         new BufferedOutputStream(
133                                                 s.getOutputStream() ));
134 
135                     out.print(&quot;HTTP/1.1 &quot; + getResponse() + &quot;\r\n&quot;);
136                     int clen = getContentLength();
137                     if (clen &gt;= 0) {
138                         out.print(&quot;Content-Length: &quot; + clen +
139                                     &quot;\r\n&quot;);
140                     }
141                     out.print(&quot;\r\n&quot;);
142                     for (int i=0; i&lt;clen; i++) {
143                         out.write( (byte)&#39;.&#39; );
144                     }
145                     out.flush();
146 
147                     debug(&quot;worked &quot; + id +
148                         &quot;: Sent response to client, length: &quot; + clen);
149 
150                     if (--max == 0) {
151                         s.close();
152                         return;
153                     }
154                 }
155 
156             } catch (Exception e) {
157                 e.printStackTrace();
158             } finally {
159                 try {
160                     s.close();
161                 } catch (Exception e) { }
162             }
163         }
164     }
165 
166     /*
167      * Server thread to accept connection and create worker threads
168      * to service each connection.
169      */
170     class Server extends Thread {
171         ServerSocket ss;
172         int connectionCount;
173         boolean shutdown = false;
174 
175         Server(ServerSocket ss) {
176             this.ss = ss;
177         }
178 
179         public synchronized int connectionCount() {
180             return connectionCount;
181         }
182 
183         public synchronized void shutdown() {
184             shutdown = true;
185         }
186 
187         public void run() {
188             try {
189                 ss.setSoTimeout(2000);
190 
191                 for (;;) {
192                     Socket s;
193                     try {
194                         debug(&quot;server: Waiting for connections&quot;);
195                         s = ss.accept();
196                     } catch (SocketTimeoutException te) {
197                         synchronized (this) {
198                             if (shutdown) {
199                                 debug(&quot;server: Shuting down.&quot;);
200                                 return;
201                             }
202                         }
203                         continue;
204                     }
205 
206                     int id;
207                     synchronized (this) {
208                         id = connectionCount++;
209                     }
210 
211                     Worker w = new Worker(s, id);
212                     w.start();
213                     debug(&quot;server: Started worker &quot; + id);
214                 }
215 
216             } catch (Exception e) {
217                 e.printStackTrace();
218             } finally {
219                 try {
220                     ss.close();
221                 } catch (Exception e) { }
222             }
223         }
224     }
225 
226     /*
227      * Make a single http request and return the content length
228      * received. Also do sanity check to ensure that the
229      * content-length header matches the total received on
230      * the input stream.
231      */
232     int doRequest(String uri) throws Exception {
233         URL url = new URL(uri);
<a name="5" id="anc5"></a><span class="line-modified">234         HttpURLConnection http = (HttpURLConnection)url.openConnection();</span>
235 
236         int cl = http.getContentLength();
237 
238         InputStream in = http.getInputStream();
239         byte b[] = new byte[100];
240         int total = 0;
241         int n;
242         do {
243             n = in.read(b);
244             if (n &gt; 0) total += n;
245         } while (n &gt; 0);
246         in.close();
247 
248         if (cl &gt;= 0 &amp;&amp; total != cl) {
249             System.err.println(&quot;content-length header indicated: &quot; + cl);
250             System.err.println(&quot;Actual received: &quot; + total);
251             throw new Exception(&quot;Content-length didn&#39;t match actual received&quot;);
252         }
253 
254         return total;
255     }
256 
257 
258     /*
259      * Send http requests to &quot;server&quot; and check that they all
260      * use the same network connection and that the content
261      * length corresponds to the content length expected.
262      * stream.
263      */
264     ZeroContentLength() throws Exception {
265 
266         /* start the server */
<a name="6" id="anc6"></a><span class="line-modified">267         ServerSocket ss = new ServerSocket(0);</span>

268         Server svr = new Server(ss);
269         svr.start();
270 
<a name="7" id="anc7"></a><span class="line-modified">271         String uri = &quot;http://localhost:&quot; +</span>
<span class="line-modified">272                      Integer.toString(ss.getLocalPort()) +</span>
<span class="line-modified">273                      &quot;/foo.html&quot;;</span>



274 
275         int expectedTotal = 0;
276         int actualTotal = 0;
277 
278         System.out.println(&quot;**********************************&quot;);
279         System.out.println(&quot;200 OK, content-length:1024 ...&quot;);
280         setResponse(&quot;200 OK&quot;, 1024);
281         for (int i=0; i&lt;5; i++) {
282             actualTotal += doRequest(uri);
283             expectedTotal += 1024;
284         }
285 
286         System.out.println(&quot;**********************************&quot;);
287         System.out.println(&quot;200 OK, content-length:0 ...&quot;);
288         setResponse(&quot;200 OK&quot;, 0);
289         for (int i=0; i&lt;5; i++) {
290             actualTotal += doRequest(uri);
291         }
292 
293         System.out.println(&quot;**********************************&quot;);
294         System.out.println(&quot;304 Not-Modified, (no content-length) ...&quot;);
295         setResponse(&quot;304 Not-Modifed&quot;, -1);
296         for (int i=0; i&lt;5; i++) {
297             actualTotal += doRequest(uri);
298         }
299 
300         System.out.println(&quot;**********************************&quot;);
301         System.out.println(&quot;204 No-Content, (no content-length) ...&quot;);
302         setResponse(&quot;204 No-Content&quot;, -1);
303         for (int i=0; i&lt;5; i++) {
304             actualTotal += doRequest(uri);
305         }
306 
307         // shutdown server - we&#39;re done.
308         svr.shutdown();
309 
310         System.out.println(&quot;**********************************&quot;);
311 
312         if (actualTotal == expectedTotal) {
313             System.out.println(&quot;Passed: Actual total equal to expected total&quot;);
314         } else {
315             throw new Exception(&quot;Actual total != Expected total!!!&quot;);
316         }
317 
318         int cnt = svr.connectionCount();
319         if (cnt == 1) {
320             System.out.println(&quot;Passed: Only 1 connection established&quot;);
321         } else {
322             throw new Exception(&quot;Test failed: Number of connections &quot; +
323                 &quot;established: &quot; + cnt + &quot; - see log for details.&quot;);
324         }
325     }
326 
327     public static void main(String args[]) throws Exception {
328 
329         if (args.length &gt; 0 &amp;&amp; args[0].equals(&quot;-d&quot;)) {
330             debug = true;
331         }
332 
333         new ZeroContentLength();
334     }
335 
336 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>