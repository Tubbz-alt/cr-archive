<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/URLConnection/ZeroContentLength.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="URLConnectionHeaders.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="contentHandler/UserContentHandler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLConnection/ZeroContentLength.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4507412
 27  * @bug 4506998
 28  * @summary Check that a 304 &quot;Not-Modified&quot; response from a server
 29  *          doesn&#39;t cause http client to close a keep-alive
 30  *          connection.
 31  *          Check that a content-length of 0 results in an
 32  *          empty input stream.



 33  */

 34 import java.net.*;
 35 import java.io.*;

 36 
 37 public class ZeroContentLength {
 38 
 39     /*
 40      * Is debugging enabled - start with -d to enable.
 41      */
 42     static boolean debug = false;
 43 
 44     static void debug(String msg) {
 45         if (debug)
 46             System.out.println(msg);
 47     }
 48 
 49     /*
 50      * The response string and content-length that
 51      * the server should return;
 52      */
 53     static String response;
 54     static int contentLength;
 55 
</pre>
<hr />
<pre>
214                 }
215 
216             } catch (Exception e) {
217                 e.printStackTrace();
218             } finally {
219                 try {
220                     ss.close();
221                 } catch (Exception e) { }
222             }
223         }
224     }
225 
226     /*
227      * Make a single http request and return the content length
228      * received. Also do sanity check to ensure that the
229      * content-length header matches the total received on
230      * the input stream.
231      */
232     int doRequest(String uri) throws Exception {
233         URL url = new URL(uri);
<span class="line-modified">234         HttpURLConnection http = (HttpURLConnection)url.openConnection();</span>
235 
236         int cl = http.getContentLength();
237 
238         InputStream in = http.getInputStream();
239         byte b[] = new byte[100];
240         int total = 0;
241         int n;
242         do {
243             n = in.read(b);
244             if (n &gt; 0) total += n;
245         } while (n &gt; 0);
246         in.close();
247 
248         if (cl &gt;= 0 &amp;&amp; total != cl) {
249             System.err.println(&quot;content-length header indicated: &quot; + cl);
250             System.err.println(&quot;Actual received: &quot; + total);
251             throw new Exception(&quot;Content-length didn&#39;t match actual received&quot;);
252         }
253 
254         return total;
255     }
256 
257 
258     /*
259      * Send http requests to &quot;server&quot; and check that they all
260      * use the same network connection and that the content
261      * length corresponds to the content length expected.
262      * stream.
263      */
264     ZeroContentLength() throws Exception {
265 
266         /* start the server */
<span class="line-modified">267         ServerSocket ss = new ServerSocket(0);</span>

268         Server svr = new Server(ss);
269         svr.start();
270 
<span class="line-modified">271         String uri = &quot;http://localhost:&quot; +</span>
<span class="line-modified">272                      Integer.toString(ss.getLocalPort()) +</span>
<span class="line-modified">273                      &quot;/foo.html&quot;;</span>



274 
275         int expectedTotal = 0;
276         int actualTotal = 0;
277 
278         System.out.println(&quot;**********************************&quot;);
279         System.out.println(&quot;200 OK, content-length:1024 ...&quot;);
280         setResponse(&quot;200 OK&quot;, 1024);
281         for (int i=0; i&lt;5; i++) {
282             actualTotal += doRequest(uri);
283             expectedTotal += 1024;
284         }
285 
286         System.out.println(&quot;**********************************&quot;);
287         System.out.println(&quot;200 OK, content-length:0 ...&quot;);
288         setResponse(&quot;200 OK&quot;, 0);
289         for (int i=0; i&lt;5; i++) {
290             actualTotal += doRequest(uri);
291         }
292 
293         System.out.println(&quot;**********************************&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4507412
 27  * @bug 4506998
 28  * @summary Check that a 304 &quot;Not-Modified&quot; response from a server
 29  *          doesn&#39;t cause http client to close a keep-alive
 30  *          connection.
 31  *          Check that a content-length of 0 results in an
 32  *          empty input stream.
<span class="line-added"> 33  * @library /test/lib</span>
<span class="line-added"> 34  * @run main ZeroContentLength</span>
<span class="line-added"> 35  * @run main/othervm -Djava.net.preferIPv6Addresses=true ZeroContentLength</span>
 36  */
<span class="line-added"> 37 </span>
 38 import java.net.*;
 39 import java.io.*;
<span class="line-added"> 40 import jdk.test.lib.net.URIBuilder;</span>
 41 
 42 public class ZeroContentLength {
 43 
 44     /*
 45      * Is debugging enabled - start with -d to enable.
 46      */
 47     static boolean debug = false;
 48 
 49     static void debug(String msg) {
 50         if (debug)
 51             System.out.println(msg);
 52     }
 53 
 54     /*
 55      * The response string and content-length that
 56      * the server should return;
 57      */
 58     static String response;
 59     static int contentLength;
 60 
</pre>
<hr />
<pre>
219                 }
220 
221             } catch (Exception e) {
222                 e.printStackTrace();
223             } finally {
224                 try {
225                     ss.close();
226                 } catch (Exception e) { }
227             }
228         }
229     }
230 
231     /*
232      * Make a single http request and return the content length
233      * received. Also do sanity check to ensure that the
234      * content-length header matches the total received on
235      * the input stream.
236      */
237     int doRequest(String uri) throws Exception {
238         URL url = new URL(uri);
<span class="line-modified">239         HttpURLConnection http = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);</span>
240 
241         int cl = http.getContentLength();
242 
243         InputStream in = http.getInputStream();
244         byte b[] = new byte[100];
245         int total = 0;
246         int n;
247         do {
248             n = in.read(b);
249             if (n &gt; 0) total += n;
250         } while (n &gt; 0);
251         in.close();
252 
253         if (cl &gt;= 0 &amp;&amp; total != cl) {
254             System.err.println(&quot;content-length header indicated: &quot; + cl);
255             System.err.println(&quot;Actual received: &quot; + total);
256             throw new Exception(&quot;Content-length didn&#39;t match actual received&quot;);
257         }
258 
259         return total;
260     }
261 
262 
263     /*
264      * Send http requests to &quot;server&quot; and check that they all
265      * use the same network connection and that the content
266      * length corresponds to the content length expected.
267      * stream.
268      */
269     ZeroContentLength() throws Exception {
270 
271         /* start the server */
<span class="line-modified">272         ServerSocket ss = new ServerSocket();</span>
<span class="line-added">273         ss.bind(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0));</span>
274         Server svr = new Server(ss);
275         svr.start();
276 
<span class="line-modified">277         String uri = URIBuilder.newBuilder()</span>
<span class="line-modified">278                      .scheme(&quot;http&quot;)</span>
<span class="line-modified">279                      .host(ss.getInetAddress())</span>
<span class="line-added">280                      .port(ss.getLocalPort())</span>
<span class="line-added">281                      .path(&quot;/foo.html&quot;)</span>
<span class="line-added">282                      .build().toString();</span>
283 
284         int expectedTotal = 0;
285         int actualTotal = 0;
286 
287         System.out.println(&quot;**********************************&quot;);
288         System.out.println(&quot;200 OK, content-length:1024 ...&quot;);
289         setResponse(&quot;200 OK&quot;, 1024);
290         for (int i=0; i&lt;5; i++) {
291             actualTotal += doRequest(uri);
292             expectedTotal += 1024;
293         }
294 
295         System.out.println(&quot;**********************************&quot;);
296         System.out.println(&quot;200 OK, content-length:0 ...&quot;);
297         setResponse(&quot;200 OK&quot;, 0);
298         for (int i=0; i&lt;5; i++) {
299             actualTotal += doRequest(uri);
300         }
301 
302         System.out.println(&quot;**********************************&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="URLConnectionHeaders.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="contentHandler/UserContentHandler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>