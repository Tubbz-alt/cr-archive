<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/URLConnection/ResendPostBody.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="RedirectLimit.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Responses.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLConnection/ResendPostBody.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2010, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,16 ***</span>
<span class="line-new-header">--- 23,19 ---</span>
  
  /**
   * @test
   * @bug 4361492
   * @summary HTTPUrlConnection does not receive binary data correctly
<span class="line-added">+  * @library /test/lib</span>
   * @run main/timeout=20 ResendPostBody
   */
  
  import java.io.*;
  import java.net.*;
  
<span class="line-added">+ import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added">+ </span>
  /*
   * This test does the following:
   * 1. client opens HTTP connection to server
   * 2. client sends POST with a body containing &quot;ZZZ&quot;
   * 3. server waits for POST and closes connection without replying
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,129 ***</span>
  
  public class ResendPostBody {
  
      static class Server extends Thread {
  
<span class="line-modified">!         InputStream     in;</span>
<span class="line-modified">!         OutputStream out;</span>
<span class="line-modified">!         Socket  sock;</span>
<span class="line-modified">!         StringBuffer response;</span>
<span class="line-modified">!         ServerSocket server;</span>
  
<span class="line-modified">!         Server (ServerSocket s) throws IOException</span>
<span class="line-removed">-         {</span>
              server = s;
          }
  
<span class="line-modified">!         void waitFor (String s) throws IOException</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             byte[] w = s.getBytes ();</span>
<span class="line-removed">-             for(int c=0; c&lt;w.length; c++ ) {</span>
                  byte expected = w[c];
                  int b = in.read();
                  if (b == -1) {
<span class="line-modified">!                     acceptConn ();</span>
                  }
<span class="line-modified">!                 if ((byte)b != expected) {</span>
                      c = 0;
                  }
              }
          }
  
<span class="line-modified">!         boolean done = false;</span>
  
<span class="line-modified">!         public synchronized boolean finished () {</span>
              return done;
          }
  
<span class="line-modified">!         public synchronized void setFinished (boolean b) {</span>
              done = b;
          }
  
<span class="line-modified">!         void acceptConn () throws IOException</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!             sock = server.accept ();</span>
<span class="line-modified">!             in = sock.getInputStream ();</span>
<span class="line-removed">-             out = sock.getOutputStream ();</span>
          }
  
<span class="line-modified">!         public void run () {</span>
              try {
<span class="line-modified">!                 response = new StringBuffer (1024);</span>
<span class="line-modified">!                 acceptConn ();</span>
<span class="line-modified">!                 waitFor (&quot;POST&quot;);</span>
<span class="line-modified">!                 waitFor (&quot;ZZZ&quot;);</span>
<span class="line-modified">!                 Thread.sleep (500);</span>
<span class="line-modified">!                 sock.close ();</span>
<span class="line-modified">!                 acceptConn ();</span>
<span class="line-modified">!                 waitFor (&quot;POST&quot;);</span>
<span class="line-modified">!                 waitFor (&quot;ZZZ&quot;);</span>
<span class="line-modified">!                 response.append (&quot;HTTP/1.1 200 OK\r\n&quot;);</span>
<span class="line-modified">!                 response.append (&quot;Server: Microsoft-IIS/5.0&quot;);</span>
<span class="line-modified">!                 response.append (&quot;Date: Wed, 26 Jul 2000 14:17:04 GMT\r\n\r\n&quot;);</span>
<span class="line-modified">!                 out.write (response.toString().getBytes());</span>
                  while (!finished()) {
<span class="line-modified">!                     Thread.sleep (1000);</span>
                  }
<span class="line-removed">-                 out.close();</span>
              } catch (Exception e) {
<span class="line-modified">!                 System.err.println (&quot;Server Exception: &quot; + e);</span>
              } finally {
<span class="line-modified">!                 try { server.close(); } catch (IOException unused) {}</span>
              }
          }
      }
  
<span class="line-modified">!     ServerSocket ss;</span>
<span class="line-modified">!     Server server;</span>
  
      public static void main(String[] args) throws Exception {
<span class="line-modified">!         try {</span>
<span class="line-modified">!             if (args.length == 1 &amp;&amp; args[0].equals (&quot;-i&quot;)) {</span>
<span class="line-modified">!                 System.out.println (&quot;Press return when ready&quot;);</span>
<span class="line-modified">!                 System.in.read ();</span>
<span class="line-removed">-                 System.out.println (&quot;Done&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             ResendPostBody t = new ResendPostBody ();</span>
<span class="line-removed">-             t. execute ();</span>
<span class="line-removed">-         } catch (IOException  e) {</span>
<span class="line-removed">-             System.out.println (&quot;IOException&quot;);</span>
          }
      }
  
<span class="line-modified">!     public void execute () throws Exception {</span>
<span class="line-removed">- </span>
          byte b[] = &quot;X=ABCDEFGHZZZ&quot;.getBytes();
  
<span class="line-modified">!         ss = new ServerSocket (0);</span>
<span class="line-modified">!         server = new Server (ss);</span>
<span class="line-modified">!         server.start ();</span>
<span class="line-removed">-         /* Get the URL */</span>
  
<span class="line-modified">!         String s = &quot;http://localhost:&quot;+ss.getLocalPort()+&quot;/test&quot;;</span>
<span class="line-modified">!         URL url = new URL(s);</span>
<span class="line-modified">!         HttpURLConnection conURL =  (HttpURLConnection)url.openConnection();</span>
  
          conURL.setDoOutput(true);
          conURL.setDoInput(true);
          conURL.setAllowUserInteraction(false);
          conURL.setUseCaches(false);
          conURL.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
<span class="line-modified">!         conURL.setRequestProperty(&quot;Content-Length&quot;, &quot;&quot;+b.length);</span>
          conURL.setRequestProperty(&quot;Connection&quot;, &quot;Close&quot;);
  
          /* POST some data */
<span class="line-removed">- </span>
          DataOutputStream OutStream = new DataOutputStream(conURL.getOutputStream());
<span class="line-modified">!                           OutStream.write(b, 0, b.length);</span>
          OutStream.flush();
          OutStream.close();
  
          /* Read the response */
  
<span class="line-modified">!         int resp = conURL.getResponseCode ();</span>
<span class="line-modified">!         server.setFinished (true);</span>
  
          if (resp != 200)
<span class="line-modified">!             throw new RuntimeException (&quot;Response code was not 200: &quot; + resp);</span>
<span class="line-modified">!   }</span>
  }
<span class="line-new-header">--- 49,141 ---</span>
  
  public class ResendPostBody {
  
      static class Server extends Thread {
  
<span class="line-modified">!         private InputStream in;</span>
<span class="line-modified">!         private OutputStream out;</span>
<span class="line-modified">!         private Socket sock;</span>
<span class="line-modified">!         private StringBuffer response;</span>
<span class="line-modified">!         private ServerSocket server;</span>
  
<span class="line-modified">!         Server(ServerSocket s) throws IOException {</span>
              server = s;
          }
  
<span class="line-modified">!         void waitFor(String s) throws IOException {</span>
<span class="line-modified">!             byte[] w = s.getBytes();</span>
<span class="line-modified">!             for (int c = 0; c &lt; w.length; c++) {</span>
                  byte expected = w[c];
                  int b = in.read();
                  if (b == -1) {
<span class="line-modified">!                     acceptConn();</span>
                  }
<span class="line-modified">!                 if ((byte) b != expected) {</span>
                      c = 0;
                  }
              }
          }
  
<span class="line-modified">!         private boolean done = false;</span>
  
<span class="line-modified">!         public synchronized boolean finished() {</span>
              return done;
          }
  
<span class="line-modified">!         public synchronized void setFinished(boolean b) throws IOException {</span>
              done = b;
<span class="line-added">+             this.closeConn();</span>
<span class="line-added">+             server.close();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         void acceptConn() throws IOException {</span>
<span class="line-added">+             sock = server.accept();</span>
<span class="line-added">+             in = sock.getInputStream();</span>
<span class="line-added">+             out = sock.getOutputStream();</span>
          }
  
<span class="line-modified">!         void closeConn() throws IOException {</span>
<span class="line-modified">!             in.close();</span>
<span class="line-modified">!             out.close();</span>
<span class="line-modified">!             sock.close();</span>
          }
  
<span class="line-modified">!         public void run() {</span>
              try {
<span class="line-modified">!                 response = new StringBuffer(1024);</span>
<span class="line-modified">!                 acceptConn();</span>
<span class="line-modified">!                 waitFor(&quot;POST&quot;);</span>
<span class="line-modified">!                 waitFor(&quot;ZZZ&quot;);</span>
<span class="line-modified">!                 Thread.sleep(500);</span>
<span class="line-modified">!                 sock.close();</span>
<span class="line-modified">!                 acceptConn();</span>
<span class="line-modified">!                 waitFor(&quot;POST&quot;);</span>
<span class="line-modified">!                 waitFor(&quot;ZZZ&quot;);</span>
<span class="line-modified">!                 response.append(&quot;HTTP/1.1 200 OK\r\n&quot;);</span>
<span class="line-modified">!                 response.append(&quot;Server: Microsoft-IIS/5.0&quot;);</span>
<span class="line-modified">!                 response.append(&quot;Date: Wed, 26 Jul 2000 14:17:04 GMT\r\n\r\n&quot;);</span>
<span class="line-modified">!                 out.write(response.toString().getBytes());</span>
<span class="line-added">+                 out.flush();</span>
                  while (!finished()) {
<span class="line-modified">!                     Thread.sleep(1000);</span>
                  }
              } catch (Exception e) {
<span class="line-modified">!                 if (!done) {</span>
<span class="line-added">+                     System.err.println(&quot;Server Exception: &quot; + e);</span>
<span class="line-added">+                 }</span>
              } finally {
<span class="line-modified">!                 try {</span>
<span class="line-added">+                     closeConn();</span>
<span class="line-added">+                 } catch (IOException ioe) {</span>
<span class="line-added">+                     if (!done) {</span>
<span class="line-added">+                         ioe.printStackTrace();</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
              }
          }
      }
  
<span class="line-modified">!     private ServerSocket ss;</span>
<span class="line-modified">!     private Server server;</span>
  
      public static void main(String[] args) throws Exception {
<span class="line-modified">!         if (args.length == 1 &amp;&amp; args[0].equals(&quot;-i&quot;)) {</span>
<span class="line-modified">!             System.out.println(&quot;Press return when ready&quot;);</span>
<span class="line-modified">!             System.in.read();</span>
<span class="line-modified">!             System.out.println(&quot;Done&quot;);</span>
          }
<span class="line-added">+         ResendPostBody t = new ResendPostBody();</span>
<span class="line-added">+         t.execute();</span>
      }
  
<span class="line-modified">!     public void execute() throws Exception {</span>
          byte b[] = &quot;X=ABCDEFGHZZZ&quot;.getBytes();
  
<span class="line-modified">!         ss = new ServerSocket(0, 0, InetAddress.getLoopbackAddress());</span>
<span class="line-modified">!         server = new Server(ss);</span>
<span class="line-modified">!         server.start();</span>
  
<span class="line-modified">!         /* Get the URL */</span>
<span class="line-modified">!         URL url = URIBuilder.newBuilder()</span>
<span class="line-modified">!                 .scheme(&quot;http&quot;)</span>
<span class="line-added">+                 .loopback()</span>
<span class="line-added">+                 .port(ss.getLocalPort())</span>
<span class="line-added">+                 .path(&quot;/test&quot;)</span>
<span class="line-added">+                 .toURL();</span>
<span class="line-added">+         HttpURLConnection conURL = (HttpURLConnection) url.openConnection(Proxy.NO_PROXY);</span>
  
          conURL.setDoOutput(true);
          conURL.setDoInput(true);
          conURL.setAllowUserInteraction(false);
          conURL.setUseCaches(false);
          conURL.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
<span class="line-modified">!         conURL.setRequestProperty(&quot;Content-Length&quot;, &quot;&quot; + b.length);</span>
          conURL.setRequestProperty(&quot;Connection&quot;, &quot;Close&quot;);
  
          /* POST some data */
          DataOutputStream OutStream = new DataOutputStream(conURL.getOutputStream());
<span class="line-modified">!         OutStream.write(b, 0, b.length);</span>
          OutStream.flush();
          OutStream.close();
  
          /* Read the response */
<span class="line-added">+         int resp = conURL.getResponseCode();</span>
  
<span class="line-modified">!         server.setFinished(true);    // Set finished and close ServerSocket</span>
<span class="line-modified">!         server.join();            // Join server thread</span>
  
          if (resp != 200)
<span class="line-modified">!             throw new RuntimeException(&quot;Response code was not 200: &quot; + resp);</span>
<span class="line-modified">!     }</span>
  }
</pre>
<center><a href="RedirectLimit.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="Responses.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>