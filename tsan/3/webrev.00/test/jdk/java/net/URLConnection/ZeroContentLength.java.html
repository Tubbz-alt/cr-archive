<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/URLConnection/ZeroContentLength.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4507412
 27  * @bug 4506998
 28  * @summary Check that a 304 &quot;Not-Modified&quot; response from a server
 29  *          doesn&#39;t cause http client to close a keep-alive
 30  *          connection.
 31  *          Check that a content-length of 0 results in an
 32  *          empty input stream.
 33  * @library /test/lib
 34  * @run main ZeroContentLength
 35  * @run main/othervm -Djava.net.preferIPv6Addresses=true ZeroContentLength
 36  */
 37 
 38 import java.net.*;
 39 import java.io.*;
 40 import jdk.test.lib.net.URIBuilder;
 41 
 42 public class ZeroContentLength {
 43 
 44     /*
 45      * Is debugging enabled - start with -d to enable.
 46      */
 47     static boolean debug = false;
 48 
 49     static void debug(String msg) {
 50         if (debug)
 51             System.out.println(msg);
 52     }
 53 
 54     /*
 55      * The response string and content-length that
 56      * the server should return;
 57      */
 58     static String response;
 59     static int contentLength;
 60 
 61     static synchronized void setResponse(String rsp, int cl) {
 62         response = rsp;
 63         contentLength = cl;
 64     }
 65 
 66     static synchronized String getResponse() {
 67         return response;
 68     }
 69 
 70     static synchronized int getContentLength() {
 71         return contentLength;
 72     }
 73 
 74     /*
 75      * Worker thread to service single connection - can service
 76      * multiple http requests on same connection.
 77      */
 78     class Worker extends Thread {
 79         Socket s;
 80         int id;
 81 
 82         Worker(Socket s, int id) {
 83             this.s = s;
 84             this.id = id;
 85         }
 86 
 87         final int CR = &#39;\r&#39;;
 88         final int LF = &#39;\n&#39;;
 89 
 90         public void run() {
 91             try {
 92 
 93                 s.setSoTimeout(2000);
 94                 int max = 20; // there should only be 20 connections
 95                 InputStream in = new BufferedInputStream(s.getInputStream());
 96 
 97                 for (;;) {
 98                     // read entire request from client, until CR LF CR LF
 99                     int c, total=0;
100 
101                     try {
102                         while ((c = in.read()) &gt; 0) {
103                             total++;
104                             if (c == CR) {
105                                 if ((c = in.read()) &gt; 0) {
106                                     total++;
107                                     if (c == LF) {
108                                         if ((c = in.read()) &gt; 0) {
109                                             total++;
110                                             if (c == CR) {
111                                                 if ((c = in.read()) &gt; 0) {
112                                                     total++;
113                                                     if (c == LF) {
114                                                         break;
115                                                     }
116                                                 }
117                                             }
118                                         }
119                                     }
120                                 }
121                             }
122 
123                         }
124                     } catch (SocketTimeoutException e) {}
125 
126                     debug(&quot;worker &quot; + id +
127                         &quot;: Read request from client &quot; +
128                         &quot;(&quot; + total + &quot; bytes).&quot;);
129 
130                     if (total == 0) {
131                         debug(&quot;worker: &quot; + id + &quot;: Shutdown&quot;);
132                         return;
133                     }
134 
135                     // response to client
136                     PrintStream out = new PrintStream(
137                                         new BufferedOutputStream(
138                                                 s.getOutputStream() ));
139 
140                     out.print(&quot;HTTP/1.1 &quot; + getResponse() + &quot;\r\n&quot;);
141                     int clen = getContentLength();
142                     if (clen &gt;= 0) {
143                         out.print(&quot;Content-Length: &quot; + clen +
144                                     &quot;\r\n&quot;);
145                     }
146                     out.print(&quot;\r\n&quot;);
147                     for (int i=0; i&lt;clen; i++) {
148                         out.write( (byte)&#39;.&#39; );
149                     }
150                     out.flush();
151 
152                     debug(&quot;worked &quot; + id +
153                         &quot;: Sent response to client, length: &quot; + clen);
154 
155                     if (--max == 0) {
156                         s.close();
157                         return;
158                     }
159                 }
160 
161             } catch (Exception e) {
162                 e.printStackTrace();
163             } finally {
164                 try {
165                     s.close();
166                 } catch (Exception e) { }
167             }
168         }
169     }
170 
171     /*
172      * Server thread to accept connection and create worker threads
173      * to service each connection.
174      */
175     class Server extends Thread {
176         ServerSocket ss;
177         int connectionCount;
178         boolean shutdown = false;
179 
180         Server(ServerSocket ss) {
181             this.ss = ss;
182         }
183 
184         public synchronized int connectionCount() {
185             return connectionCount;
186         }
187 
188         public synchronized void shutdown() {
189             shutdown = true;
190         }
191 
192         public void run() {
193             try {
194                 ss.setSoTimeout(2000);
195 
196                 for (;;) {
197                     Socket s;
198                     try {
199                         debug(&quot;server: Waiting for connections&quot;);
200                         s = ss.accept();
201                     } catch (SocketTimeoutException te) {
202                         synchronized (this) {
203                             if (shutdown) {
204                                 debug(&quot;server: Shuting down.&quot;);
205                                 return;
206                             }
207                         }
208                         continue;
209                     }
210 
211                     int id;
212                     synchronized (this) {
213                         id = connectionCount++;
214                     }
215 
216                     Worker w = new Worker(s, id);
217                     w.start();
218                     debug(&quot;server: Started worker &quot; + id);
219                 }
220 
221             } catch (Exception e) {
222                 e.printStackTrace();
223             } finally {
224                 try {
225                     ss.close();
226                 } catch (Exception e) { }
227             }
228         }
229     }
230 
231     /*
232      * Make a single http request and return the content length
233      * received. Also do sanity check to ensure that the
234      * content-length header matches the total received on
235      * the input stream.
236      */
237     int doRequest(String uri) throws Exception {
238         URL url = new URL(uri);
239         HttpURLConnection http = (HttpURLConnection)url.openConnection(Proxy.NO_PROXY);
240 
241         int cl = http.getContentLength();
242 
243         InputStream in = http.getInputStream();
244         byte b[] = new byte[100];
245         int total = 0;
246         int n;
247         do {
248             n = in.read(b);
249             if (n &gt; 0) total += n;
250         } while (n &gt; 0);
251         in.close();
252 
253         if (cl &gt;= 0 &amp;&amp; total != cl) {
254             System.err.println(&quot;content-length header indicated: &quot; + cl);
255             System.err.println(&quot;Actual received: &quot; + total);
256             throw new Exception(&quot;Content-length didn&#39;t match actual received&quot;);
257         }
258 
259         return total;
260     }
261 
262 
263     /*
264      * Send http requests to &quot;server&quot; and check that they all
265      * use the same network connection and that the content
266      * length corresponds to the content length expected.
267      * stream.
268      */
269     ZeroContentLength() throws Exception {
270 
271         /* start the server */
272         ServerSocket ss = new ServerSocket();
273         ss.bind(new InetSocketAddress(InetAddress.getLoopbackAddress(), 0));
274         Server svr = new Server(ss);
275         svr.start();
276 
277         String uri = URIBuilder.newBuilder()
278                      .scheme(&quot;http&quot;)
279                      .host(ss.getInetAddress())
280                      .port(ss.getLocalPort())
281                      .path(&quot;/foo.html&quot;)
282                      .build().toString();
283 
284         int expectedTotal = 0;
285         int actualTotal = 0;
286 
287         System.out.println(&quot;**********************************&quot;);
288         System.out.println(&quot;200 OK, content-length:1024 ...&quot;);
289         setResponse(&quot;200 OK&quot;, 1024);
290         for (int i=0; i&lt;5; i++) {
291             actualTotal += doRequest(uri);
292             expectedTotal += 1024;
293         }
294 
295         System.out.println(&quot;**********************************&quot;);
296         System.out.println(&quot;200 OK, content-length:0 ...&quot;);
297         setResponse(&quot;200 OK&quot;, 0);
298         for (int i=0; i&lt;5; i++) {
299             actualTotal += doRequest(uri);
300         }
301 
302         System.out.println(&quot;**********************************&quot;);
303         System.out.println(&quot;304 Not-Modified, (no content-length) ...&quot;);
304         setResponse(&quot;304 Not-Modifed&quot;, -1);
305         for (int i=0; i&lt;5; i++) {
306             actualTotal += doRequest(uri);
307         }
308 
309         System.out.println(&quot;**********************************&quot;);
310         System.out.println(&quot;204 No-Content, (no content-length) ...&quot;);
311         setResponse(&quot;204 No-Content&quot;, -1);
312         for (int i=0; i&lt;5; i++) {
313             actualTotal += doRequest(uri);
314         }
315 
316         // shutdown server - we&#39;re done.
317         svr.shutdown();
318 
319         System.out.println(&quot;**********************************&quot;);
320 
321         if (actualTotal == expectedTotal) {
322             System.out.println(&quot;Passed: Actual total equal to expected total&quot;);
323         } else {
324             throw new Exception(&quot;Actual total != Expected total!!!&quot;);
325         }
326 
327         int cnt = svr.connectionCount();
328         if (cnt == 1) {
329             System.out.println(&quot;Passed: Only 1 connection established&quot;);
330         } else {
331             throw new Exception(&quot;Test failed: Number of connections &quot; +
332                 &quot;established: &quot; + cnt + &quot; - see log for details.&quot;);
333         }
334     }
335 
336     public static void main(String args[]) throws Exception {
337 
338         if (args.length &gt; 0 &amp;&amp; args[0].equals(&quot;-d&quot;)) {
339             debug = true;
340         }
341 
342         new ZeroContentLength();
343     }
344 
345 }
    </pre>
  </body>
</html>