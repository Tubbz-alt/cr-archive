<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/net/URLConnection/RedirectLimit.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="Redirect307Test.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ResendPostBody.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLConnection/RedirectLimit.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2011, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,23 ***</span>
   */
  
  /**
   * @test
   * @bug 4458085 7095949
   * @summary  Redirects Limited to 5
   */
  
  /*
   * Simulate a server that redirects ( to a different URL) 9 times
   * and see if the client correctly follows the trail
   */
  
  import java.io.*;
  import java.net.*;
  
  class RedirLimitServer extends Thread {
<span class="line-modified">!     static final int TIMEOUT = 10 * 1000;</span>
      static final int NUM_REDIRECTS = 9;
  
      static final String reply1 = &quot;HTTP/1.1 307 Temporary Redirect\r\n&quot; +
          &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
          &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
<span class="line-new-header">--- 22,27 ---</span>
   */
  
  /**
   * @test
   * @bug 4458085 7095949
<span class="line-added">+  * @library /test/lib</span>
   * @summary  Redirects Limited to 5
   */
  
  /*
   * Simulate a server that redirects ( to a different URL) 9 times
   * and see if the client correctly follows the trail
   */
  
  import java.io.*;
  import java.net.*;
<span class="line-added">+ import java.util.concurrent.CountDownLatch;</span>
<span class="line-added">+ </span>
<span class="line-added">+ import jdk.test.lib.net.URIBuilder;</span>
  
  class RedirLimitServer extends Thread {
<span class="line-modified">!     static final int TIMEOUT = 20 * 1000;</span>
      static final int NUM_REDIRECTS = 9;
  
      static final String reply1 = &quot;HTTP/1.1 307 Temporary Redirect\r\n&quot; +
          &quot;Date: Mon, 15 Jan 2001 12:18:21 GMT\r\n&quot; +
          &quot;Server: Apache/1.3.14 (Unix)\r\n&quot; +
</pre>
<hr />
<pre>
<span class="line-old-header">*** 54,10 ***</span>
<span class="line-new-header">--- 58,11 ---</span>
          &quot;Content-Type: text/html; charset=iso-8859-1\r\n\r\n&quot; +
          &quot;World&quot;;
  
      final ServerSocket ss;
      final int port;
<span class="line-added">+     final CountDownLatch readyToStart = new CountDownLatch(1);</span>
  
      RedirLimitServer(ServerSocket ss) throws IOException {
          this.ss = ss;
          port = this.ss.getLocalPort();
          this.ss.setSoTimeout(TIMEOUT);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,61 ***</span>
      static final byte[] requestEnd = new byte[] {&#39;\r&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\n&#39; };
  
      // Read until the end of a HTTP request
      void readOneRequest(InputStream is) throws IOException {
          int requestEndCount = 0, r;
          while ((r = is.read()) != -1) {
              if (r == requestEnd[requestEndCount]) {
                  requestEndCount++;
                  if (requestEndCount == 4) {
                      break;
                  }
              } else {
                  requestEndCount = 0;
              }
          }
      }
  
      public void run() {
          try {
              for (int i=0; i&lt;NUM_REDIRECTS; i++) {
                  try (Socket s = ss.accept()) {
                      s.setSoTimeout(TIMEOUT);
                      readOneRequest(s.getInputStream());
                      String reply = reply1 + port + &quot;/redirect&quot; + i + reply2;
                      s.getOutputStream().write(reply.getBytes());
                  }
              }
              try (Socket s = ss.accept()) {
                  s.setSoTimeout(TIMEOUT);
                  readOneRequest(s.getInputStream());
                  s.getOutputStream().write(reply3.getBytes());
              }
          } catch (Exception e) {
              e.printStackTrace();
<span class="line-removed">-         } finally {</span>
<span class="line-removed">-             try { ss.close(); } catch (IOException unused) {}</span>
          }
      }
  };
  
  public class RedirectLimit {
      public static void main(String[] args) throws Exception {
<span class="line-modified">!         ServerSocket ss = new ServerSocket (0);</span>
<span class="line-modified">!         int port = ss.getLocalPort();</span>
<span class="line-modified">!         RedirLimitServer server = new RedirLimitServer(ss);</span>
<span class="line-modified">!         server.start();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         URL url = new URL(&quot;http://localhost:&quot; + port);</span>
<span class="line-modified">!         URLConnection conURL =  url.openConnection();</span>
  
<span class="line-modified">!         conURL.setDoInput(true);</span>
<span class="line-modified">!         conURL.setAllowUserInteraction(false);</span>
<span class="line-modified">!         conURL.setUseCaches(false);</span>
  
<span class="line-modified">!         try (InputStream in = conURL.getInputStream()) {</span>
<span class="line-modified">!             if ((in.read() != (int)&#39;W&#39;) || (in.read()!=(int)&#39;o&#39;)) {</span>
<span class="line-modified">!                 throw new RuntimeException(&quot;Unexpected string read&quot;);</span>
              }
          }
      }
  }
<span class="line-new-header">--- 71,72 ---</span>
      static final byte[] requestEnd = new byte[] {&#39;\r&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\n&#39; };
  
      // Read until the end of a HTTP request
      void readOneRequest(InputStream is) throws IOException {
          int requestEndCount = 0, r;
<span class="line-added">+         StringBuilder sb = new StringBuilder();</span>
          while ((r = is.read()) != -1) {
<span class="line-added">+             sb.append((char)r);</span>
              if (r == requestEnd[requestEndCount]) {
                  requestEndCount++;
                  if (requestEndCount == 4) {
                      break;
                  }
              } else {
                  requestEndCount = 0;
              }
          }
<span class="line-added">+         System.out.println(&quot;Server got request: &quot; + sb.toString());</span>
      }
  
      public void run() {
          try {
<span class="line-added">+             readyToStart.countDown();</span>
              for (int i=0; i&lt;NUM_REDIRECTS; i++) {
                  try (Socket s = ss.accept()) {
<span class="line-added">+                     System.out.println(&quot;Server accepted socket: &quot; + s);</span>
                      s.setSoTimeout(TIMEOUT);
                      readOneRequest(s.getInputStream());
<span class="line-added">+                     System.out.println(&quot;Redirecting to: /redirect&quot; + i);</span>
                      String reply = reply1 + port + &quot;/redirect&quot; + i + reply2;
                      s.getOutputStream().write(reply.getBytes());
                  }
              }
              try (Socket s = ss.accept()) {
<span class="line-added">+                 System.out.println(&quot;Server accepted socket: &quot; + s);</span>
                  s.setSoTimeout(TIMEOUT);
                  readOneRequest(s.getInputStream());
<span class="line-added">+                 System.out.println(&quot;Replying...&quot;);</span>
                  s.getOutputStream().write(reply3.getBytes());
              }
          } catch (Exception e) {
              e.printStackTrace();
          }
      }
  };
  
  public class RedirectLimit {
      public static void main(String[] args) throws Exception {
<span class="line-modified">!         try (ServerSocket ss = new ServerSocket(0, 0, InetAddress.getLoopbackAddress())) {</span>
<span class="line-modified">!             int port = ss.getLocalPort();</span>
<span class="line-modified">!             RedirLimitServer server = new RedirLimitServer(ss);</span>
<span class="line-modified">!             server.start();</span>
<span class="line-modified">!             server.readyToStart.await();</span>
<span class="line-modified">!             URL url = URIBuilder.newBuilder()</span>
<span class="line-modified">!                     .scheme(&quot;http&quot;)</span>
<span class="line-added">+                     .loopback()</span>
<span class="line-added">+                     .port(port)</span>
<span class="line-added">+                     .toURL();</span>
<span class="line-added">+             URLConnection conURL = url.openConnection(Proxy.NO_PROXY);</span>
  
<span class="line-modified">!             conURL.setDoInput(true);</span>
<span class="line-modified">!             conURL.setAllowUserInteraction(false);</span>
<span class="line-modified">!             conURL.setUseCaches(false);</span>
  
<span class="line-modified">!             try (InputStream in = conURL.getInputStream()) {</span>
<span class="line-modified">!                 if ((in.read() != (int) &#39;W&#39;) || (in.read() != (int) &#39;o&#39;)) {</span>
<span class="line-modified">!                     throw new RuntimeException(&quot;Unexpected string read&quot;);</span>
<span class="line-added">+                 }</span>
              }
          }
      }
  }
</pre>
<center><a href="Redirect307Test.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ResendPostBody.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>