<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/URLConnection/HandleContentTypeWithAttrs.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="GetResponseCode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="HttpContinueStackOverflow.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/URLConnection/HandleContentTypeWithAttrs.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2010, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4160200
<span class="line-modified"> 27  * @summary Make sure URLConnection.getContnentHandler</span>
 28  *     can handle MIME types with attributes

 29  * @modules java.base/sun.net.www java.base/sun.net.www.content.text
 30  */
 31 import java.net.*;
 32 import java.io.*;
 33 import sun.net.www.content.text.*;
 34 import sun.net.www.MessageHeader;
 35 import static java.net.Proxy.NO_PROXY;
 36 


 37 public class HandleContentTypeWithAttrs {
 38 
 39     URL url;
 40 
 41     public HandleContentTypeWithAttrs (int port) throws Exception {
 42 
 43         // Request echo.html from myHttpServer.
 44         // In the header of the response, we make
 45         // the content type have some attributes.
<span class="line-modified"> 46         url = new URL(&quot;http://localhost:&quot; + port + &quot;/echo.html&quot;);</span>





 47         URLConnection urlConn = url.openConnection(NO_PROXY);
 48 
 49         // the method getContent() calls the method
 50         // getContentHandler(). With the fix, the method
 51         // getContentHandler() gets the correct content
 52         // handler for our response -  it should be the
 53         // PlainText conten handler; without the fix,
 54         // it gets the UnknownContent handler.
 55         // So based on what the getContent()
 56         // returns, we know whether getContentHandler()
 57         // can handle content type with attributes or not.
 58         Object obj = urlConn.getContent();
 59 
 60         if (!(obj instanceof PlainTextInputStream))
 61             throw new Exception(&quot;Cannot get the correct content handler.&quot;);
 62     }
 63 
 64     public static void main(String [] argv) throws Exception {
 65         // Start myHttpServer
 66         myHttpServer testServer = new myHttpServer();
</pre>
<hr />
<pre>
118             try {
119                 clientOutput = new PrintStream(
120                     new BufferedOutputStream(clientSocket.getOutputStream()),
121                                              false);
122                 clientInput = new BufferedInputStream(
123                                              clientSocket.getInputStream());
124                 serviceRequest();
125 
126             } catch(Exception e) {
127                 // System.out.print(&quot;Service handler failure\n&quot;);
128                 // e.printStackTrace();
129             } finally {
130                 try { close(); }  catch(IOException unused) {}
131             }
132         }
133     }
134 
135     /** Start a server on port &lt;i&gt;port&lt;/i&gt;.  It will call serviceRequest()
136         for each new connection. */
137     final public void startServer(int port) throws IOException {
<span class="line-modified">138         serverSocket = new ServerSocket(port, 50);</span>

139         serverInstance = new Thread(this);
140         serverInstance.start();
141     }
142 
143     final public int getServerLocalPort() throws Exception {
144         if (serverSocket != null) {
145             return serverSocket.getLocalPort();
146         }
147         throw new Exception(&quot;serverSocket is null&quot;);
148     }
149 
150     MessageHeader mh;
151 
152     final public void serviceRequest() {
153         //totalConnections++;
154         try {
155             mh = new MessageHeader(clientInput);
156             String cmd = mh.findValue(null);
157             // if (cmd == null) {
158             //  error(&quot;Missing command &quot; + mh);
</pre>
<hr />
<pre>
202            }
203         } catch(Exception e) {
204             System.out.print(&quot;Failed on &quot;+u.getFile()+&quot;\n&quot;);
205             e.printStackTrace();
206         }
207     }
208      /**
209       * Clone this object;
210      */
211     public Object clone() {
212         try {
213             return super.clone();
214         } catch (CloneNotSupportedException e) {
215             // this shouldn&#39;t happen, since we are Cloneable
216             throw new InternalError();
217         }
218     }
219 
220     public myHttpServer () {
221         try {
<span class="line-modified">222             defaultContext</span>
<span class="line-modified">223             = new URL(&quot;http&quot;, InetAddress.getLocalHost().getHostName(), &quot;/&quot;);</span>



224         } catch(Exception e) {
<span class="line-modified">225             System.out.println(&quot;Failed to construct defauit URL context: &quot;</span>
226                                + e);
227             e.printStackTrace();
228         }
229     }
230 
231     // Make the content type have some attributes
232     protected void startHtml(String title) {
233         clientOutput.print(&quot;HTTP/1.0 200 Document follows\n&quot; +
234                            &quot;Server: Java/&quot; + getClass().getName() + &quot;\n&quot; +
235                            &quot;Content-type: text/plain; charset=Shift_JIS \n\n&quot;);
236     }
237 
238 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4160200
<span class="line-modified"> 27  * @summary Make sure URLConnection.getContentHandler</span>
 28  *     can handle MIME types with attributes
<span class="line-added"> 29  * @library /test/lib</span>
 30  * @modules java.base/sun.net.www java.base/sun.net.www.content.text
 31  */
 32 import java.net.*;
 33 import java.io.*;
 34 import sun.net.www.content.text.*;
 35 import sun.net.www.MessageHeader;
 36 import static java.net.Proxy.NO_PROXY;
 37 
<span class="line-added"> 38 import jdk.test.lib.net.URIBuilder;</span>
<span class="line-added"> 39 </span>
 40 public class HandleContentTypeWithAttrs {
 41 
 42     URL url;
 43 
 44     public HandleContentTypeWithAttrs (int port) throws Exception {
 45 
 46         // Request echo.html from myHttpServer.
 47         // In the header of the response, we make
 48         // the content type have some attributes.
<span class="line-modified"> 49         url = URIBuilder.newBuilder()</span>
<span class="line-added"> 50                 .scheme(&quot;http&quot;)</span>
<span class="line-added"> 51                 .loopback()</span>
<span class="line-added"> 52                 .port(port)</span>
<span class="line-added"> 53                 .path(&quot;/echo.html&quot;)</span>
<span class="line-added"> 54                 .toURL();</span>
 55         URLConnection urlConn = url.openConnection(NO_PROXY);
 56 
 57         // the method getContent() calls the method
 58         // getContentHandler(). With the fix, the method
 59         // getContentHandler() gets the correct content
 60         // handler for our response -  it should be the
 61         // PlainText conten handler; without the fix,
 62         // it gets the UnknownContent handler.
 63         // So based on what the getContent()
 64         // returns, we know whether getContentHandler()
 65         // can handle content type with attributes or not.
 66         Object obj = urlConn.getContent();
 67 
 68         if (!(obj instanceof PlainTextInputStream))
 69             throw new Exception(&quot;Cannot get the correct content handler.&quot;);
 70     }
 71 
 72     public static void main(String [] argv) throws Exception {
 73         // Start myHttpServer
 74         myHttpServer testServer = new myHttpServer();
</pre>
<hr />
<pre>
126             try {
127                 clientOutput = new PrintStream(
128                     new BufferedOutputStream(clientSocket.getOutputStream()),
129                                              false);
130                 clientInput = new BufferedInputStream(
131                                              clientSocket.getInputStream());
132                 serviceRequest();
133 
134             } catch(Exception e) {
135                 // System.out.print(&quot;Service handler failure\n&quot;);
136                 // e.printStackTrace();
137             } finally {
138                 try { close(); }  catch(IOException unused) {}
139             }
140         }
141     }
142 
143     /** Start a server on port &lt;i&gt;port&lt;/i&gt;.  It will call serviceRequest()
144         for each new connection. */
145     final public void startServer(int port) throws IOException {
<span class="line-modified">146         serverSocket = new ServerSocket(port, 50,</span>
<span class="line-added">147                 InetAddress.getLoopbackAddress());</span>
148         serverInstance = new Thread(this);
149         serverInstance.start();
150     }
151 
152     final public int getServerLocalPort() throws Exception {
153         if (serverSocket != null) {
154             return serverSocket.getLocalPort();
155         }
156         throw new Exception(&quot;serverSocket is null&quot;);
157     }
158 
159     MessageHeader mh;
160 
161     final public void serviceRequest() {
162         //totalConnections++;
163         try {
164             mh = new MessageHeader(clientInput);
165             String cmd = mh.findValue(null);
166             // if (cmd == null) {
167             //  error(&quot;Missing command &quot; + mh);
</pre>
<hr />
<pre>
211            }
212         } catch(Exception e) {
213             System.out.print(&quot;Failed on &quot;+u.getFile()+&quot;\n&quot;);
214             e.printStackTrace();
215         }
216     }
217      /**
218       * Clone this object;
219      */
220     public Object clone() {
221         try {
222             return super.clone();
223         } catch (CloneNotSupportedException e) {
224             // this shouldn&#39;t happen, since we are Cloneable
225             throw new InternalError();
226         }
227     }
228 
229     public myHttpServer () {
230         try {
<span class="line-modified">231             defaultContext = URIBuilder.newBuilder()</span>
<span class="line-modified">232                     .scheme(&quot;http&quot;)</span>
<span class="line-added">233                     .loopback()</span>
<span class="line-added">234                     .path(&quot;/&quot;)</span>
<span class="line-added">235                     .toURL();</span>
236         } catch(Exception e) {
<span class="line-modified">237             System.out.println(&quot;Failed to construct default URL context: &quot;</span>
238                                + e);
239             e.printStackTrace();
240         }
241     }
242 
243     // Make the content type have some attributes
244     protected void startHtml(String title) {
245         clientOutput.print(&quot;HTTP/1.0 200 Document follows\n&quot; +
246                            &quot;Server: Java/&quot; + getClass().getName() + &quot;\n&quot; +
247                            &quot;Content-type: text/plain; charset=Shift_JIS \n\n&quot;);
248     }
249 
250 }
</pre>
</td>
</tr>
</table>
<center><a href="GetResponseCode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="HttpContinueStackOverflow.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>