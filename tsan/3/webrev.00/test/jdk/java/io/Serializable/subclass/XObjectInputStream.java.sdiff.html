<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/io/Serializable/subclass/XObjectInputStream.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="SubclassTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="XObjectOutputStream.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/io/Serializable/subclass/XObjectInputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 30 
 31 class XObjectInputStream extends AbstractObjectInputStream {
 32 
 33     XObjectInputStream(InputStream in)
 34         throws IOException, StreamCorruptedException
 35         {
 36             super(in);
 37             dis = new DataInputStream(in);
 38         }
 39 
 40     public final void defaultReadObject()
 41         throws IOException, ClassNotFoundException, NotActiveException
 42     {
 43     }
 44 
 45     protected final Object readObjectOverride()
 46         throws OptionalDataException, ClassNotFoundException, IOException {
 47 
 48         Object readResult = null;
 49         Object prevObject = currentObject;
<span class="line-modified"> 50         Class  prevDesc   = currentClassDescriptor;</span>
 51 
 52         boolean NotImplemented = true;
 53         if (NotImplemented)
 54             throw new IOException(&quot;readObjectOverride not implemented&quot;);
 55 
 56         try {
 57             currentObject = null;
 58 
 59             //Read in class of object to currentDescriptor
 60             String className = dis.readUTF();
 61             currentClassDescriptor = Class.forName(className);
 62 
 63             try {
 64                 //currentObject = Allocate a new instance of the class
 65                 currentObject =
 66                     allocateNewObject(currentClassDescriptor,
 67                                    currentClassDescriptor);
 68             } catch (InstantiationException e) {
 69                 throw new InvalidClassException(currentClassDescriptor.getName(),
 70                                                 e.getMessage());
</pre>
<hr />
<pre>
226              throws IOException, IllegalArgumentException {
227              throw new Error(&quot;not implemented&quot;);
228          }
229 
230          public double get(String name, double defvalue)
231              throws IOException, IllegalArgumentException {
232              throw new Error(&quot;not implemented&quot;);
233          }
234 
235          public Object get(String name, Object defvalue)
236              throws IOException, IllegalArgumentException {
237              throw new Error(&quot;not implemented&quot;);
238          }
239 
240          public void read(ObjectInputStream in)
241              throws IOException, ClassNotFoundException {
242          }
243      }
244 
245     private Object currentObject;
<span class="line-modified">246     private Class currentClassDescriptor;</span>
247 
248 
249 
250     /****************************************************************/
251 
252     /* CODE LIFTED FROM ObjectStreamClass constuctor.
253      * ObjectStreamClass.readObjectMethod is private.
254      *
255      * Look for the readObject method
256      * Set the accessible flag on it here. ObjectOutputStream
257      * will call it as necessary.
258      */
<span class="line-modified">259     public static Method getReadObjectMethod(final Class cl) {</span>
260 
<span class="line-modified">261         Method readObjectMethod = (Method)</span>
262             java.security.AccessController.doPrivileged
<span class="line-modified">263             (new java.security.PrivilegedAction() {</span>
<span class="line-modified">264                 public Object run() {</span>
265                     Method m = null;
266                     try {
<span class="line-modified">267                         Class[] args = {ObjectInputStream.class};</span>
268                         m = cl.getDeclaredMethod(&quot;readObject&quot;, args);
269                         int mods = m.getModifiers();
270                         // Method must be private and non-static
271                         if (!Modifier.isPrivate(mods) ||
272                             Modifier.isStatic(mods)) {
273                             m = null;
274                         } else {
275                             m.setAccessible(true);
276                         }
277                     } catch (NoSuchMethodException e) {
278                         m = null;
279                     }
280                     return m;
281                 }
282             });
283         return readObjectMethod;
284     }
285 
286     /*************************************************************/
287 
288     /* taken verbatim from ObjectInputStream. */
289     private static void invokeMethod(final Object obj, final Method m,
290                                         final Object[] argList)
291         throws IOException
292     {
293         try {
294             java.security.AccessController.doPrivileged
<span class="line-modified">295                 (new java.security.PrivilegedExceptionAction() {</span>
<span class="line-modified">296                     public Object run() throws InvocationTargetException,</span>
297                                         java.lang.IllegalAccessException {
298                         m.invoke(obj, argList);
299                         return null;
300                     }
301                 });
302         } catch (java.security.PrivilegedActionException e) {
303             Exception ex = e.getException();
304             if (ex instanceof InvocationTargetException) {
305                 Throwable t =
306                         ((InvocationTargetException)ex).getTargetException();
307                 if (t instanceof IOException)
308                     throw (IOException)t;
309                 else if (t instanceof RuntimeException)
310                     throw (RuntimeException) t;
311                 else if (t instanceof Error)
312                     throw (Error) t;
313                 else
314                     throw new Error(&quot;interal error&quot;);
315             } else {
316                 // IllegalAccessException cannot happen
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 30 
 31 class XObjectInputStream extends AbstractObjectInputStream {
 32 
 33     XObjectInputStream(InputStream in)
 34         throws IOException, StreamCorruptedException
 35         {
 36             super(in);
 37             dis = new DataInputStream(in);
 38         }
 39 
 40     public final void defaultReadObject()
 41         throws IOException, ClassNotFoundException, NotActiveException
 42     {
 43     }
 44 
 45     protected final Object readObjectOverride()
 46         throws OptionalDataException, ClassNotFoundException, IOException {
 47 
 48         Object readResult = null;
 49         Object prevObject = currentObject;
<span class="line-modified"> 50         Class&lt;?&gt;  prevDesc   = currentClassDescriptor;</span>
 51 
 52         boolean NotImplemented = true;
 53         if (NotImplemented)
 54             throw new IOException(&quot;readObjectOverride not implemented&quot;);
 55 
 56         try {
 57             currentObject = null;
 58 
 59             //Read in class of object to currentDescriptor
 60             String className = dis.readUTF();
 61             currentClassDescriptor = Class.forName(className);
 62 
 63             try {
 64                 //currentObject = Allocate a new instance of the class
 65                 currentObject =
 66                     allocateNewObject(currentClassDescriptor,
 67                                    currentClassDescriptor);
 68             } catch (InstantiationException e) {
 69                 throw new InvalidClassException(currentClassDescriptor.getName(),
 70                                                 e.getMessage());
</pre>
<hr />
<pre>
226              throws IOException, IllegalArgumentException {
227              throw new Error(&quot;not implemented&quot;);
228          }
229 
230          public double get(String name, double defvalue)
231              throws IOException, IllegalArgumentException {
232              throw new Error(&quot;not implemented&quot;);
233          }
234 
235          public Object get(String name, Object defvalue)
236              throws IOException, IllegalArgumentException {
237              throw new Error(&quot;not implemented&quot;);
238          }
239 
240          public void read(ObjectInputStream in)
241              throws IOException, ClassNotFoundException {
242          }
243      }
244 
245     private Object currentObject;
<span class="line-modified">246     private Class&lt;?&gt; currentClassDescriptor;</span>
247 
248 
249 
250     /****************************************************************/
251 
252     /* CODE LIFTED FROM ObjectStreamClass constuctor.
253      * ObjectStreamClass.readObjectMethod is private.
254      *
255      * Look for the readObject method
256      * Set the accessible flag on it here. ObjectOutputStream
257      * will call it as necessary.
258      */
<span class="line-modified">259     public static Method getReadObjectMethod(final Class&lt;?&gt; cl) {</span>
260 
<span class="line-modified">261         Method readObjectMethod =</span>
262             java.security.AccessController.doPrivileged
<span class="line-modified">263             (new java.security.PrivilegedAction&lt;Method&gt;() {</span>
<span class="line-modified">264                 public Method run() {</span>
265                     Method m = null;
266                     try {
<span class="line-modified">267                         Class&lt;?&gt;[] args = {ObjectInputStream.class};</span>
268                         m = cl.getDeclaredMethod(&quot;readObject&quot;, args);
269                         int mods = m.getModifiers();
270                         // Method must be private and non-static
271                         if (!Modifier.isPrivate(mods) ||
272                             Modifier.isStatic(mods)) {
273                             m = null;
274                         } else {
275                             m.setAccessible(true);
276                         }
277                     } catch (NoSuchMethodException e) {
278                         m = null;
279                     }
280                     return m;
281                 }
282             });
283         return readObjectMethod;
284     }
285 
286     /*************************************************************/
287 
288     /* taken verbatim from ObjectInputStream. */
289     private static void invokeMethod(final Object obj, final Method m,
290                                         final Object[] argList)
291         throws IOException
292     {
293         try {
294             java.security.AccessController.doPrivileged
<span class="line-modified">295                 (new java.security.PrivilegedExceptionAction&lt;Void&gt;() {</span>
<span class="line-modified">296                     public Void run() throws InvocationTargetException,</span>
297                                         java.lang.IllegalAccessException {
298                         m.invoke(obj, argList);
299                         return null;
300                     }
301                 });
302         } catch (java.security.PrivilegedActionException e) {
303             Exception ex = e.getException();
304             if (ex instanceof InvocationTargetException) {
305                 Throwable t =
306                         ((InvocationTargetException)ex).getTargetException();
307                 if (t instanceof IOException)
308                     throw (IOException)t;
309                 else if (t instanceof RuntimeException)
310                     throw (RuntimeException) t;
311                 else if (t instanceof Error)
312                     throw (Error) t;
313                 else
314                     throw new Error(&quot;interal error&quot;);
315             } else {
316                 // IllegalAccessException cannot happen
</pre>
</td>
</tr>
</table>
<center><a href="SubclassTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="XObjectOutputStream.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>