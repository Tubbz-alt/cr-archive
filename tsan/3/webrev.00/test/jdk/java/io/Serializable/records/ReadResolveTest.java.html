<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/io/Serializable/records/ReadResolveTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Basic tests for readResolve
 27  * @compile --enable-preview -source ${jdk.version} ReadResolveTest.java
 28  * @run testng/othervm --enable-preview ReadResolveTest
 29  * @run testng/othervm/java.security.policy=empty_security.policy --enable-preview ReadResolveTest
 30  */
 31 
 32 import java.io.ByteArrayInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.IOException;
 35 import java.io.ObjectInputStream;
 36 import java.io.ObjectOutputStream;
 37 import java.io.Serial;
 38 import java.io.Serializable;
 39 import org.testng.annotations.DataProvider;
 40 import org.testng.annotations.Test;
 41 import static java.lang.String.format;
 42 import static java.lang.System.out;
 43 import static org.testng.Assert.assertEquals;
 44 
 45 /**
 46  * Tests records being used as a serial proxy.
 47  */
 48 public class ReadResolveTest {
 49 
 50     static class C1 implements Serializable {
 51         private final int x;
 52         private final int y;
 53         C1(int x, int y) { this.x = x; this.y = y; }
 54         private record SerProxy1(int x, int y) implements Serializable {
 55             @Serial
 56             private Object readResolve() { return new C1(x, y); }
 57         }
 58         @Serial
 59         private Object writeReplace() {
 60             return new SerProxy1(x, y);
 61         }
 62         @Override
 63         public boolean equals(Object obj) {
 64             return obj != null &amp;&amp; obj instanceof C1 &amp;&amp; ((C1)obj).x == this.x &amp;&amp; ((C1)obj).y == y;
 65         }
 66         @Override
 67         public String toString() { return format(&quot;C1[x=%x, y=%d]&quot;, x, y); }
 68     }
 69 
 70     static class C2 implements Serializable {
 71         private record SerProxy2() implements Serializable {
 72             @Serial
 73             private Object readResolve() { return new C2(); }
 74         }
 75         @Serial
 76         private Object writeReplace() {
 77             return new SerProxy2();
 78         }
 79         @Override
 80         public boolean equals(Object obj) {
 81             return obj != null &amp;&amp; obj instanceof C2;
 82         }
 83         @Override
 84         public String toString() { return &quot;C2[]&quot;; }
 85     }
 86 
 87     record R1 (int x, int y, String s) implements Serializable {
 88         private record SerProxy3(int a, int b, String c) implements Serializable {
 89             @Serial
 90             private Object readResolve() { return new R1(a, b, c); }
 91         }
 92         @Serial
 93         private Object writeReplace() {
 94             return new SerProxy3(x, y, s);
 95         }
 96     }
 97 
 98     @DataProvider(name = &quot;objectsToSerialize&quot;)
 99     public Object[][] objectsToSerialize() {
100         return new Object[][] {
101                 new Object[] { new C1(3,4)        },
102                 new Object[] { new C2()           },
103                 new Object[] { new R1(5, 6, &quot;c&quot;)  }
104         };
105     }
106 
107     @Test(dataProvider = &quot;objectsToSerialize&quot;)
108     public void testSerialize(Object objectToSerialize) throws Exception {
109         out.println(&quot;\n---&quot;);
110         out.println(&quot;serializing : &quot; + objectToSerialize);
111         Object deserializedObj = serializeDeserialize(objectToSerialize);
112         out.println(&quot;deserialized: &quot; + deserializedObj);
113         assertEquals(deserializedObj, objectToSerialize);
114     }
115 
116     // -- null replacement
117 
118     record R10 () implements Serializable {
119         @Serial
120         private Object readResolve() {
121             return null;
122         }
123     }
124 
125     @Test
126     public void testNull() throws Exception {
127         out.println(&quot;\n---&quot;);
128         Object objectToSerialize = new R10();
129         out.println(&quot;serializing : &quot; + objectToSerialize);
130         Object deserializedObj = serializeDeserialize(objectToSerialize);
131         out.println(&quot;deserialized: &quot; + deserializedObj);
132         assertEquals(deserializedObj, null);
133     }
134 
135     // --- infra
136 
137     static &lt;T&gt; byte[] serialize(T obj) throws IOException {
138         ByteArrayOutputStream baos = new ByteArrayOutputStream();
139         ObjectOutputStream oos = new ObjectOutputStream(baos);
140         oos.writeObject(obj);
141         oos.close();
142         return baos.toByteArray();
143     }
144 
145     @SuppressWarnings(&quot;unchecked&quot;)
146     static &lt;T&gt; T deserialize(byte[] streamBytes)
147         throws IOException, ClassNotFoundException
148     {
149         ByteArrayInputStream bais = new ByteArrayInputStream(streamBytes);
150         ObjectInputStream ois  = new ObjectInputStream(bais);
151         return (T) ois.readObject();
152     }
153 
154     static &lt;T&gt; T serializeDeserialize(T obj)
155         throws IOException, ClassNotFoundException
156     {
157         return deserialize(serialize(obj));
158     }
159 }
160 
    </pre>
  </body>
</html>