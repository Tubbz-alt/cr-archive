<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/io/Serializable/records/ConstructorPermissionTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Verifies that privileged operations performed in the record
 27  *          constructor throw, when run without the required permissions
 28  * @compile --enable-preview -source ${jdk.version} ConstructorPermissionTest.java
 29  * @run testng/othervm/java.security.policy=empty_security.policy --enable-preview ConstructorPermissionTest
 30  */
 31 
 32 import java.io.ByteArrayInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.IOException;
 35 import java.io.InvalidObjectException;
 36 import java.io.ObjectInputStream;
 37 import java.io.ObjectOutputStream;
 38 import java.io.Serializable;
 39 import java.net.Socket;
 40 import java.nio.file.Files;
 41 import java.nio.file.Path;
 42 import java.security.AccessControlException;
 43 import org.testng.annotations.DataProvider;
 44 import org.testng.annotations.Test;
 45 import static java.lang.System.out;
 46 import static org.testng.Assert.assertTrue;
 47 import static org.testng.Assert.expectThrows;
 48 
 49 /**
 50  * Ensures that the appropriate exception, invalid object exception, with a
 51  * suitable cause, is thrown when the record constructor performs a privileged
 52  * operation without permission.
 53  */
 54 public class ConstructorPermissionTest {
 55 
 56     /** &quot;big switch&quot; that can be used to allow/disallow record construction
 57      * set to true after the data provider has constructed all record objects */
 58     private static volatile boolean firstDataSetCreated;
 59 
 60     record R1 () implements Serializable {
 61         public R1 {
 62             if (firstDataSetCreated) {
 63                 try { Files.list(Path.of(&quot;.&quot;)); }
 64                 catch (IOException unexpected) { throw new AssertionError(unexpected); }
 65             }
 66         }
 67     }
 68 
 69     record R2 (int x) implements Serializable {
 70         public R2 {
 71             if (firstDataSetCreated) {
 72                 try { new Socket(&quot;localhost&quot;, 8080); }
 73                 catch (IOException unexpected) { throw new AssertionError(unexpected); }
 74             }
 75             this.x = x;
 76         }
 77     }
 78 
 79     record R3 (String... args) implements Serializable {
 80         public R3 {
 81             if (firstDataSetCreated)
 82                 ProcessHandle.current();
 83             this.args = args;
 84         }
 85     }
 86 
 87     static final Class&lt;InvalidObjectException&gt; IOE = InvalidObjectException.class;
 88 
 89     @DataProvider(name = &quot;exceptionInstances&quot;)
 90     public Object[][] exceptionInstances() {
 91         var objs = new Object[][] {
 92             new Object[] { new R1(),     AccessControlException.class, &quot;FilePermission&quot;   },
 93             new Object[] { new R2(1),    AccessControlException.class, &quot;SocketPermission&quot; },
 94             new Object[] { new R3(&quot;s&quot;),  AccessControlException.class, &quot;manageProcess&quot;    },
 95         };
 96         firstDataSetCreated = true;
 97         return objs;
 98     }
 99 
100     @Test(dataProvider = &quot;exceptionInstances&quot;)
101     public void testExceptions(Object objectToSerialize,
102                                Class&lt;? extends Throwable&gt; expectedExType,
103                                String expectedExMessage)
104         throws Exception
105     {
106         out.println(&quot;\n---&quot;);
107         out.println(&quot;serializing: &quot; + objectToSerialize);
108         byte[] bytes = serialize(objectToSerialize);
109         InvalidObjectException ioe = expectThrows(IOE, () -&gt; deserialize(bytes));
110         out.println(&quot;caught expected IOE: &quot; + ioe);
111         Throwable t = ioe.getCause();
112         assertTrue(t.getClass().equals(expectedExType),
113                    &quot;Expected:&quot; + expectedExType + &quot;, got:&quot; + t);
114         out.println(&quot;expected cause &quot; + expectedExType +&quot; : &quot; + t);
115         String msg = t.getMessage();
116         assertTrue(msg.contains(expectedExMessage),
117                    &quot;Expected message to contain [&quot; + expectedExMessage + &quot;], in &quot; + msg);
118     }
119 
120     // TODO: add positive tests with permissions granted.
121 
122     // --- infra
123 
124     static &lt;T&gt; byte[] serialize(T obj) throws IOException {
125         ByteArrayOutputStream baos = new ByteArrayOutputStream();
126         ObjectOutputStream oos = new ObjectOutputStream(baos);
127         oos.writeObject(obj);
128         oos.close();
129         return baos.toByteArray();
130     }
131 
132     @SuppressWarnings(&quot;unchecked&quot;)
133     static &lt;T&gt; T deserialize(byte[] streamBytes)
134         throws IOException, ClassNotFoundException
135     {
136         ByteArrayInputStream bais = new ByteArrayInputStream(streamBytes);
137         ObjectInputStream ois  = new ObjectInputStream(bais);
138         return (T) ois.readObject();
139     }
140 }
    </pre>
  </body>
</html>